{"pr_number": 14282, "pr_title": "Performance: +3.4% avoid expensive unescape when not needed", "pr_createdAt": "2020-08-19T18:24:44Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14282", "timeline": [{"oid": "b1ec945e5b1eb3551153f982a09eb5ae96e2044a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1ec945e5b1eb3551153f982a09eb5ae96e2044a", "message": "Optimied implementation to extract the resourceId.\n\nnew implementation avoid expensive StringUtils.Split", "committedDate": "2020-08-17T08:35:11Z", "type": "commit"}, {"oid": "44bb449e702474293567ad0e52cfdb242555bf95", "url": "https://github.com/Azure/azure-sdk-for-java/commit/44bb449e702474293567ad0e52cfdb242555bf95", "message": "Some more extra validation", "committedDate": "2020-08-17T08:55:35Z", "type": "commit"}, {"oid": "fcd3f2a485cb0681646d767e91ab1aee285adf13", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fcd3f2a485cb0681646d767e91ab1aee285adf13", "message": "Substring endindex bug fix", "committedDate": "2020-08-17T12:09:47Z", "type": "commit"}, {"oid": "d8e5f7904a2353fcb51bd2f1d358ada789a71910", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d8e5f7904a2353fcb51bd2f1d358ada789a71910", "message": "Merge branch 'master' into users/kirankk/dsr_extract_id_fromUri", "committedDate": "2020-08-19T02:30:09Z", "type": "commit"}, {"oid": "5e0c20f947d6c7d184a742ac0492b971e3a3529b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5e0c20f947d6c7d184a742ac0492b971e3a3529b", "message": "Remove some more dead code", "committedDate": "2020-08-19T03:23:27Z", "type": "commit"}, {"oid": "dcd70ee714edf66dbc5bf243785baf159ffc7bcc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dcd70ee714edf66dbc5bf243785baf159ffc7bcc", "message": "Some more escape optimizations", "committedDate": "2020-08-19T05:26:24Z", "type": "commit"}, {"oid": "8fe702116b7ba869fec94249d631421a2dea17cb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fe702116b7ba869fec94249d631421a2dea17cb", "message": "Merge branch 'master' into users/kirankk/users/kirankk/dsr_extract_id_fromUri_1", "committedDate": "2020-08-19T17:29:04Z", "type": "commit"}, {"oid": "1f0b45dd4b3ea790c0f5ad7d08487d6aba511c7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1f0b45dd4b3ea790c0f5ad7d08487d6aba511c7a", "message": "Reverting an unrelated change", "committedDate": "2020-08-19T17:44:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNzEyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14282#discussion_r473237120", "bodyText": "Any specific reason why are we not using primitive types here -> char ?", "author": "kushagraThapar", "createdAt": "2020-08-19T18:28:08Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Paths.java", "diffHunk": "@@ -8,6 +8,8 @@\n  */\n public class Paths {\n     static final String ROOT = \"/\";\n+    static final Character ROOT_CHAR = '/';\n+    static final Character ESCAPE_CHAR = '\\\\';", "originalCommit": "1f0b45dd4b3ea790c0f5ad7d08487d6aba511c7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNzY0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14282#discussion_r473237643", "bodyText": "Because using Character class here will result in auto-boxing later in your code below.", "author": "kushagraThapar", "createdAt": "2020-08-19T18:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNzEyMA=="}], "type": "inlineReview", "revised_code": {"commit": "9bd41053fd983f484364081ccca134009250454c", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Paths.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Paths.java\nindex f6fabe6025d..1a7e8cdb207 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Paths.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Paths.java\n\n@@ -8,8 +8,8 @@ package com.azure.cosmos.implementation;\n  */\n public class Paths {\n     static final String ROOT = \"/\";\n-    static final Character ROOT_CHAR = '/';\n-    static final Character ESCAPE_CHAR = '\\\\';\n+    static final char ROOT_CHAR = '/';\n+    static final char ESCAPE_CHAR = '\\\\';\n \n     public static final String DATABASES_PATH_SEGMENT = \"dbs\";\n     public static final String DATABASES_ROOT = ROOT + DATABASES_PATH_SEGMENT;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzODAzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14282#discussion_r473238034", "bodyText": "please also consider a unit test for unescapeJavaAndTrim() implementation when escaping or not escaping case.", "author": "moderakh", "createdAt": "2020-08-19T18:29:48Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java", "diffHunk": "@@ -441,24 +439,57 @@ public static PathInfo parseNameSegments(String resourceUrl, String[] segments)\n         if (segments.length % 2 == 0) {\n             // even number, assume it is individual resource\n             if (isResourceType(segments[segments.length - 2])) {\n-                return new PathInfo(false, segments[segments.length - 2],\n-                        StringEscapeUtils.unescapeJava(StringUtils.strip(resourceUrl, Paths.ROOT)), true);\n+                return new PathInfo(false,\n+                                    segments[segments.length - 2],\n+                                    unescapeJavaAndTrim(resourceUrl),\n+                         true);\n             }\n         } else {\n             // odd number, assume it is feed request\n             if (isResourceType(segments[segments.length - 1])) {\n-                return new PathInfo(true, segments[segments.length - 1],\n-                        StringEscapeUtils.unescapeJava(StringUtils.strip(\n-                                resourceUrl.substring(0,\n-                                        StringUtils.removeEnd(resourceUrl, Paths.ROOT).lastIndexOf(Paths.ROOT)),\n-                                Paths.ROOT)),\n-                        true);\n+                return new PathInfo(true,\n+                                    segments[segments.length - 1],\n+                                    unescapeJavaAndTrim(\n+                                        resourceUrl.substring(0,\n+                                                StringUtils.removeEnd(resourceUrl, Paths.ROOT).lastIndexOf(Paths.ROOT))),\n+                         true);\n             }\n         }\n \n         return null;\n     }\n \n+    private static String unescapeJavaAndTrim(String resourceUrl) {", "originalCommit": "1f0b45dd4b3ea790c0f5ad7d08487d6aba511c7a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f5b424740424625c8a82dd27951821baf4aaf801", "chunk": "diff --git a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java\nindex dbde0e860b2..3eafd3a6bdb 100644\n--- a/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java\n+++ b/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/PathsHelper.java\n\n@@ -459,7 +459,11 @@ public class PathsHelper {\n         return null;\n     }\n \n-    private static String unescapeJavaAndTrim(String resourceUrl) {\n+    public static String unescapeJavaAndTrim(String resourceUrl) {\n+        if (resourceUrl == null) {\n+            return null;\n+        }\n+\n         int startInclusiveIndex = 0;\n \n         while (startInclusiveIndex < resourceUrl.length() && resourceUrl.charAt(startInclusiveIndex) == Paths.ROOT_CHAR) {\n"}}, {"oid": "9bd41053fd983f484364081ccca134009250454c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9bd41053fd983f484364081ccca134009250454c", "message": "Move to primitive types", "committedDate": "2020-08-19T18:52:28Z", "type": "commit"}, {"oid": "807bf4cba64f4a943413f5119983a2b068610cd9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/807bf4cba64f4a943413f5119983a2b068610cd9", "message": "Merge branch 'master' into users/kirankk/path_helper_opt", "committedDate": "2020-08-20T16:45:39Z", "type": "commit"}, {"oid": "f5b424740424625c8a82dd27951821baf4aaf801", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5b424740424625c8a82dd27951821baf4aaf801", "message": "Adding unittests", "committedDate": "2020-08-25T11:44:13Z", "type": "commit"}]}