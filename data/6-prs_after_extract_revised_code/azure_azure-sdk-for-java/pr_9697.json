{"pr_number": 9697, "pr_title": "ServiceBusClientBuilder updates", "pr_createdAt": "2020-03-30T23:52:47Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9697", "timeline": [{"oid": "cf402e37eeec9d6e2947b0a133fc86826691e59e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cf402e37eeec9d6e2947b0a133fc86826691e59e", "message": "Implement AutoCloseable.", "committedDate": "2020-03-30T21:30:55Z", "type": "commit"}, {"oid": "8f8098f1b041cb9a2144dabad065da0753044b83", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8f8098f1b041cb9a2144dabad065da0753044b83", "message": "Throw exception when receiver is disposed.\nPass ability to share connection.", "committedDate": "2020-03-30T21:51:08Z", "type": "commit"}, {"oid": "a6fe735a9d2bff49f66369bb2558037c689cf8e1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6fe735a9d2bff49f66369bb2558037c689cf8e1", "message": "Fixing test cases.", "committedDate": "2020-03-30T22:52:28Z", "type": "commit"}, {"oid": "5a3db2f94d1169dcdc6099b3e91272fd1712d553", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5a3db2f94d1169dcdc6099b3e91272fd1712d553", "message": "Adding documentation.", "committedDate": "2020-03-30T23:09:28Z", "type": "commit"}, {"oid": "ea059638ffd88cf084f90260c0936d1c097d56e5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ea059638ffd88cf084f90260c0936d1c097d56e5", "message": "Adding queueName and topicName to sender builder.", "committedDate": "2020-03-30T23:15:28Z", "type": "commit"}, {"oid": "c5156cbe69d45ff091aa0cc57366319067a0bfed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5156cbe69d45ff091aa0cc57366319067a0bfed", "message": "Fix test", "committedDate": "2020-03-30T23:22:50Z", "type": "commit"}, {"oid": "5b73edfb99769ba4e98bb8a2c83c43a059cd2e4e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5b73edfb99769ba4e98bb8a2c83c43a059cd2e4e", "message": "Fixing tests.", "committedDate": "2020-03-30T23:37:56Z", "type": "commit"}, {"oid": "ec07f50252e3409bf0704109aeb6ca0eb7f72e77", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec07f50252e3409bf0704109aeb6ca0eb7f72e77", "message": "Renaming sender/receiver", "committedDate": "2020-03-30T23:51:12Z", "type": "commit"}, {"oid": "9920b593fb817c237795de45295d66508bd128f5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9920b593fb817c237795de45295d66508bd128f5", "message": "Fix readme", "committedDate": "2020-03-30T23:52:15Z", "type": "commit"}, {"oid": "abf74451909bfb187d69ae8d19138f80913b0d61", "url": "https://github.com/Azure/azure-sdk-for-java/commit/abf74451909bfb187d69ae8d19138f80913b0d61", "message": "Revert comment.", "committedDate": "2020-03-31T00:56:52Z", "type": "commit"}, {"oid": "afcb7ba68c92a953560e1da0686ed29eb707237b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/afcb7ba68c92a953560e1da0686ed29eb707237b", "message": "Adding documentation.", "committedDate": "2020-03-31T01:16:53Z", "type": "commit"}, {"oid": "d019945ec060078b7409387da7ee5071e3e8620d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d019945ec060078b7409387da7ee5071e3e8620d", "message": "Removing import", "committedDate": "2020-03-31T15:13:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAwODU1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401008550", "bodyText": "This should probably also clarify that this will be done for Async client only. And will not autorenew for sync client.", "author": "hemanttanwar", "createdAt": "2020-03-31T15:31:42Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -423,7 +504,9 @@ public ServiceBusReceiverClientBuilder isAutoComplete(boolean autoComplete) {\n         /**\n          * Sets if lock should be automatically renewed.\n          *\n-         * @param isLockAutoRenewed {@code true} if the lock should be automatically renewed; {@code false} otherwise.\n+         * @param isLockAutoRenewed {@code true} if the lock should be automatically renewed; {@code false}\n+         *     otherwise.", "originalCommit": "afcb7ba68c92a953560e1da0686ed29eb707237b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA1ODMxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401058319", "bodyText": "Fixed.", "author": "conniey", "createdAt": "2020-03-31T16:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAwODU1MA=="}], "type": "inlineReview", "revised_code": {"commit": "d56cccecb9b4c7d416df34f392908e1682099ce6", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\nindex b98e6031132..30745e3b6c1 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\n\n@@ -497,7 +497,7 @@ public final class ServiceBusClientBuilder {\n          * @return The modified {@link ServiceBusReceiverClientBuilder} object.\n          */\n         public ServiceBusReceiverClientBuilder isAutoComplete(boolean autoComplete) {\n-            this.autoComplete = autoComplete;\n+            this.isAutoComplete = autoComplete;\n             return this;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAxNzA3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401017077", "bodyText": "Line 660: IllegalArgumentException if the entity type is not a queue or a topic : You have already explained all the scenario above this. UNKNOWN , type is internal to us and if we can avoid using entity type , one less thing to learn for user .\nYou do throw this exception but this will only happen if user has not set both queue ,topic and connection string has entityName in it.\nOr it may say something like Queue or topic name are not set via queueNme() or topicName() respectively.", "author": "hemanttanwar", "createdAt": "2020-03-31T15:42:28Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -574,14 +644,20 @@ public ServiceBusReceiverAsyncClient buildAsyncClient() {\n \n             return new ServiceBusReceiverAsyncClient(connectionProcessor.getFullyQualifiedNamespace(), entityPath,\n                 entityType, false, receiveMessageOptions, connectionProcessor, tracerProvider,\n-                messageSerializer, messageLockContainer);\n+                messageSerializer, messageLockContainer, ServiceBusClientBuilder.this::onClientClose);\n         }\n \n         /**\n-         * Creates <b>synchronous</b> Service Bus receiver responsible for reading {@link ServiceBusMessage\n-         * messages} from a specific queue or topic.\n+         * Creates <b>synchronous</b> Service Bus receiver responsible for reading {@link ServiceBusMessage messages}\n+         * from a specific queue or topic.\n          *\n          * @return An new {@link ServiceBusReceiverClient} that receives messages from a queue or topic.\n+         * @throws IllegalStateException if {@link #queueName(String) queueName} or {@link #topicName(String)\n+         *     topicName} are not set or, both of these fields are set. It is also thrown if the Service Bus {@link\n+         *     #connectionString(String) connectionString} contains an {@code EntityPath} that does not match one set in\n+         *     {@link #queueName(String) queueName} or {@link #topicName(String) topicName}. Lastly, if a {@link\n+         *     #topicName(String) topicName} is set, but {@link #subscriptionName(String) subscriptionName} is not.\n+         * @throws IllegalArgumentException if the entity type is not a queue or a topic.", "originalCommit": "afcb7ba68c92a953560e1da0686ed29eb707237b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA2MDAwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401060002", "bodyText": "I added the IllegalArgumentException because checkstyles complained about missing javadocs for the exception.\nI updated the text.", "author": "conniey", "createdAt": "2020-03-31T16:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAxNzA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d56cccecb9b4c7d416df34f392908e1682099ce6", "chunk": "diff --git a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\nindex b98e6031132..30745e3b6c1 100644\n--- a/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\n+++ b/sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java\n\n@@ -630,16 +630,22 @@ public final class ServiceBusClientBuilder {\n             if (prefetchCount < 1) {\n                 throw logger.logExceptionAsError(new IllegalArgumentException(String.format(\n                     \"prefetchCount (%s) cannot be less than 1.\", prefetchCount)));\n-            } else if (maxAutoLockRenewalDuration != null\n-                && (maxAutoLockRenewalDuration.isZero() || maxAutoLockRenewalDuration.isNegative())) {\n-                throw logger.logExceptionAsError(new IllegalArgumentException(String.format(\n-                    \"maxAutoLockRenewalDuration (%s) cannot be less than or equal to a duration of zero.\",\n-                    maxAutoLockRenewalDuration)));\n+            }\n+\n+            if (isLockAutoRenewed) {\n+                if (maxAutoLockRenewalDuration == null) {\n+                    throw logger.logExceptionAsError(new IllegalStateException(\n+                        \"'maxAutoLockRenewalDuration' is required when 'isLockAutoRenewed' is enabled.\"));\n+                } else if (maxAutoLockRenewalDuration.isZero() || maxAutoLockRenewalDuration.isNegative()) {\n+                    throw logger.logExceptionAsError(new IllegalArgumentException(String.format(\n+                        \"maxAutoLockRenewalDuration (%s) cannot be less than or equal to a duration of zero.\",\n+                        maxAutoLockRenewalDuration)));\n+                }\n             }\n \n             final MessageLockContainer messageLockContainer = new MessageLockContainer();\n             final ServiceBusConnectionProcessor connectionProcessor = getOrCreateConnectionProcessor(messageSerializer);\n-            final ReceiveMessageOptions receiveMessageOptions = new ReceiveMessageOptions(autoComplete, receiveMode,\n+            final ReceiveMessageOptions receiveMessageOptions = new ReceiveMessageOptions(isAutoComplete, receiveMode,\n                 prefetchCount, isLockAutoRenewed, maxAutoLockRenewalDuration);\n \n             return new ServiceBusReceiverAsyncClient(connectionProcessor.getFullyQualifiedNamespace(), entityPath,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAyMjcyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401022720", "bodyText": "Probably not urgent, but should we also add Autocloseableon receiver/sender builder because some time a user might just want to close the connection from builder in order to stop everything ?  We could decide about it later.", "author": "hemanttanwar", "createdAt": "2020-03-31T15:49:53Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -208,13 +209,23 @@ public ServiceBusReceiverClientBuilder buildReceiverClientBuilder() {\n      */\n     void onClientClose() {", "originalCommit": "afcb7ba68c92a953560e1da0686ed29eb707237b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA2MTEzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9697#discussion_r401061132", "bodyText": "This is a design decision, you can create an issue for it.. but it seems weird for a builder to implement autocloseable.", "author": "conniey", "createdAt": "2020-03-31T16:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAyMjcyMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d56cccecb9b4c7d416df34f392908e1682099ce6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d56cccecb9b4c7d416df34f392908e1682099ce6", "message": "Adding tests and updating logic.", "committedDate": "2020-03-31T16:38:28Z", "type": "commit"}, {"oid": "f1cff126666c3dbabc0aa21803aa5a73b1301095", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f1cff126666c3dbabc0aa21803aa5a73b1301095", "message": "Update docs", "committedDate": "2020-03-31T16:44:28Z", "type": "commit"}]}