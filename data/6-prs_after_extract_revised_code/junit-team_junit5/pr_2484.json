{"pr_number": 2484, "pr_title": "Introduce utility method for processing all destroyed test instances", "pr_createdAt": "2020-11-28T15:38:52Z", "pr_url": "https://github.com/junit-team/junit5/pull/2484", "timeline": [{"oid": "235946a07dc376095d21121f5a2e01f92c4796a1", "url": "https://github.com/junit-team/junit5/commit/235946a07dc376095d21121f5a2e01f92c4796a1", "message": "Introduce utility method for processing all destroyed test instances\n\nThe new utility method helps to ensure all test instances are processed\nby a `TestInstancePreDestroyCallback` when used in conjunction with\n`@Nested` tests.\n\nResolves #2430.", "committedDate": "2020-11-28T15:51:19Z", "type": "forcePushed"}, {"oid": "a39c5212b8bd59a2909a8aa5f56e997b355ad0e1", "url": "https://github.com/junit-team/junit5/commit/a39c5212b8bd59a2909a8aa5f56e997b355ad0e1", "message": "Introduce utility method for processing all destroyed test instances\n\nThe new utility method helps to ensure all test instances are processed\nby a `TestInstancePreDestroyCallback` when used in conjunction with\n`@Nested` tests.\n\nResolves #2430.", "committedDate": "2020-11-28T16:01:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyNzMzMQ==", "url": "https://github.com/junit-team/junit5/pull/2484#discussion_r536027331", "bodyText": "Note to self: document in Javadoc", "author": "marcphilipp", "createdAt": "2020-12-04T11:19:54Z", "path": "junit-jupiter-api/src/main/java/org/junit/jupiter/api/extension/TestInstancePreDestroyCallback.java", "diffHunk": "@@ -48,12 +57,59 @@\n public interface TestInstancePreDestroyCallback extends Extension {\n \n \t/**\n-\t * Callback for processing a test instance before it is destroyed.\n+\t * Callback for processing test instances before they are destroyed.\n+\t *\n+\t * <p>Contrary to {@link TestInstancePostProcessor#postProcessTestInstance}\n+\t * this method is only called once for each {@link ExtensionContext} even if\n+\t * there are multiple test instances about to be destroyed in case of\n+\t * {@link Nested @Nested} tests. Please use the provided\n+\t * {@link #preDestroyTestInstances(ExtensionContext, Consumer)} utility\n+\t * method to ensure that all test instances are handled.\n \t *\n \t * @param context the current extension context; never {@code null}\n \t * @see ExtensionContext#getTestInstance()\n \t * @see ExtensionContext#getRequiredTestInstance()\n+\t * @see ExtensionContext#getTestInstances()\n+\t * @see ExtensionContext#getRequiredTestInstances()\n+\t * @see #preDestroyTestInstances(ExtensionContext, Consumer)\n \t */\n \tvoid preDestroyTestInstance(ExtensionContext context) throws Exception;\n \n+\t/**\n+\t * Utility method for processing <em>all</em> test instances of an\n+\t * {@link ExtensionContext} that are not present in any of its parent\n+\t * contexts (which would happen in case {@link Lifecycle#PER_CLASS} was\n+\t * used).\n+\t *\n+\t * <p>This method is intended to be called from an implementation of\n+\t * {@link #preDestroyTestInstance(ExtensionContext)} like this:\n+\t *\n+\t * <pre>{@code\n+\t * class MyExtension implements TestInstancePreDestroyCallback {\n+\t *     @Override\n+\t *     public void preDestroyTestInstance(ExtensionContext context) {\n+\t *         TestInstancePreDestroyCallback.preDestroyTestInstances(context, testInstance -> {\n+\t *             // custom logic\n+\t *         });\n+\t *     }\n+\t * }\n+\t * }</pre>\n+\t *\n+\t * @param context the current extension context; never {@code null}\n+\t * @param callback the callback to be invoked for every test instance of the\n+\t * current extension context that is about to be destroyed; never\n+\t * {@code null}\n+\t * @since 5.7.1\n+\t */\n+\t@API(status = EXPERIMENTAL, since = \"5.7.1\")\n+\tstatic void preDestroyTestInstances(ExtensionContext context, Consumer<Object> callback) {\n+\t\tList<Object> destroyedInstances = new ArrayList<>(context.getRequiredTestInstances().getAllInstances());\n+\t\tfor (Optional<ExtensionContext> current = context.getParent(); current.isPresent(); current = current.get().getParent()) {\n+\t\t\tcurrent.get().getTestInstances().map(TestInstances::getAllInstances).ifPresent(\n+\t\t\t\tdestroyedInstances::removeAll);\n+\t\t}\n+\t\tCollections.reverse(destroyedInstances);", "originalCommit": "a39c5212b8bd59a2909a8aa5f56e997b355ad0e1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "281c0ddb862a05428513e7f2fbfd46bebe5073c5", "chunk": "diff --git a/junit-jupiter-api/src/main/java/org/junit/jupiter/api/extension/TestInstancePreDestroyCallback.java b/junit-jupiter-api/src/main/java/org/junit/jupiter/api/extension/TestInstancePreDestroyCallback.java\nindex 4d418da287..815d89cedc 100644\n--- a/junit-jupiter-api/src/main/java/org/junit/jupiter/api/extension/TestInstancePreDestroyCallback.java\n+++ b/junit-jupiter-api/src/main/java/org/junit/jupiter/api/extension/TestInstancePreDestroyCallback.java\n\n@@ -78,8 +78,13 @@ public interface TestInstancePreDestroyCallback extends Extension {\n \t/**\n \t * Utility method for processing <em>all</em> test instances of an\n \t * {@link ExtensionContext} that are not present in any of its parent\n-\t * contexts (which would happen in case {@link Lifecycle#PER_CLASS} was\n-\t * used).\n+\t * contexts.\n+\t *\n+\t * <p>This method should be called in order to implement this interface\n+\t * correctly since it ensures that the right test instances are processed\n+\t * regardless of the used {@linkplain Lifecycle lifecycle}. The supplied\n+\t * callback is called once per test instance that is about to be destroyed\n+\t * starting with the innermost one.\n \t *\n \t * <p>This method is intended to be called from an implementation of\n \t * {@link #preDestroyTestInstance(ExtensionContext)} like this:\n"}}, {"oid": "281c0ddb862a05428513e7f2fbfd46bebe5073c5", "url": "https://github.com/junit-team/junit5/commit/281c0ddb862a05428513e7f2fbfd46bebe5073c5", "message": "Introduce utility method for processing all destroyed test instances\n\nThe new utility method helps to ensure all test instances are processed\nby a `TestInstancePreDestroyCallback` when used in conjunction with\n`@Nested` tests.\n\nResolves #2430.", "committedDate": "2020-12-12T17:17:02Z", "type": "commit"}, {"oid": "281c0ddb862a05428513e7f2fbfd46bebe5073c5", "url": "https://github.com/junit-team/junit5/commit/281c0ddb862a05428513e7f2fbfd46bebe5073c5", "message": "Introduce utility method for processing all destroyed test instances\n\nThe new utility method helps to ensure all test instances are processed\nby a `TestInstancePreDestroyCallback` when used in conjunction with\n`@Nested` tests.\n\nResolves #2430.", "committedDate": "2020-12-12T17:17:02Z", "type": "forcePushed"}]}