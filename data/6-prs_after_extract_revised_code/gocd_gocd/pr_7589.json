{"pr_number": 7589, "pr_title": "Adding GO_AGENT_RESOURCES as environment variable", "pr_createdAt": "2020-01-13T19:45:34Z", "pr_url": "https://github.com/gocd/gocd/pull/7589", "timeline": [{"oid": "a379a14e53224c1b1bd4c81e1a1ac3c3d69557e9", "url": "https://github.com/gocd/gocd/commit/a379a14e53224c1b1bd4c81e1a1ac3c3d69557e9", "message": "Adding GO_AGENT_RESOURCES as environment variable\n\nThe issue fixes upstream GoCD #7575 issue by serializing the agent resources to an environment variable.", "committedDate": "2020-01-13T19:40:32Z", "type": "commit"}, {"oid": "e4af20980e94c848c22df215824294e36da40b5a", "url": "https://github.com/gocd/gocd/commit/e4af20980e94c848c22df215824294e36da40b5a", "message": "Moved logic for GO_AGENT_RESOURCES in the BuildAssignmentService and enhanced the existing scaffolding tests around secrets/environment with the check for the agent resources environment variable;", "committedDate": "2020-01-15T20:24:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI0NjU0MA==", "url": "https://github.com/gocd/gocd/pull/7589#discussion_r367246540", "bodyText": "How about we don't set the property if the agent doesn't have any resources set on it.", "author": "kritika-singh3", "createdAt": "2020-01-16T06:13:16Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java", "diffHunk": "@@ -291,6 +292,10 @@ private Work createWork(final AgentInstance agent, final JobPlan job) {\n \n                     final EnvironmentVariableContext environmentVariableContext = buildEnvVarContext(job.getIdentifier().getPipelineName());\n \n+                    // Agent may have a NULL \"resources\" so we check and set an empty default here so that tests pass\n+                    String agentResourcesAsCsv = agent.getResourceConfigs() == null ? \"\" : agent.getResourceConfigs().getCommaSeparatedResourceNames();\n+                    environmentVariableContext.setProperty(GO_AGENT_RESOURCES, agentResourcesAsCsv, false);\n+", "originalCommit": "e4af20980e94c848c22df215824294e36da40b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI2MDk1OA==", "url": "https://github.com/gocd/gocd/pull/7589#discussion_r367260958", "bodyText": "It actually makes more sense to do that, true. I've guarded it with an if. Downstream to our Ansible use-case we can for check for its existence and default to \"None\". It leads towards much stronger code. Good call. Thanks!", "author": "Antauri", "createdAt": "2020-01-16T07:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI0NjU0MA=="}], "type": "inlineReview", "revised_code": {"commit": "b127493e105f1b345de0d328e05a840d02bfbd2a", "chunk": "diff --git a/server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java b/server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java\nindex 18667d7675..7f692b9173 100644\n--- a/server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java\n+++ b/server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java\n\n@@ -292,9 +292,11 @@ public class BuildAssignmentService implements ConfigChangedListener {\n \n                     final EnvironmentVariableContext environmentVariableContext = buildEnvVarContext(job.getIdentifier().getPipelineName());\n \n-                    // Agent may have a NULL \"resources\" so we check and set an empty default here so that tests pass\n-                    String agentResourcesAsCsv = agent.getResourceConfigs() == null ? \"\" : agent.getResourceConfigs().getCommaSeparatedResourceNames();\n-                    environmentVariableContext.setProperty(GO_AGENT_RESOURCES, agentResourcesAsCsv, false);\n+                    // Agent may have a NULL \"resources\"\n+                    if (agent.getResourceConfigs() != null) {\n+                        // Users relying on this env. var. can test for its existence rather than checking for an empty string\n+                        environmentVariableContext.setProperty(GO_AGENT_RESOURCES, agent.getResourceConfigs().getCommaSeparatedResourceNames(), false);\n+                    }\n \n                     final ArtifactStores requiredArtifactStores = goConfigService.artifactStores().getArtifactStores(getArtifactStoreIdsRequiredByArtifactPlans(job.getArtifactPlans()));\n                     BuildAssignment buildAssignment = BuildAssignment.create(job, pipeline.getBuildCause(), builders, pipeline.defaultWorkingFolder(), environmentVariableContext, requiredArtifactStores);\n"}}, {"oid": "b127493e105f1b345de0d328e05a840d02bfbd2a", "url": "https://github.com/gocd/gocd/commit/b127493e105f1b345de0d328e05a840d02bfbd2a", "message": "Don't add GO_AGENT_RESOURCES on null resources\n\nIt may happen (and we learned from running the fast-unit tests) that the ResourceConfigs on the agent are null. That means basically there are no defined resources on that agent. Instead of putting an \"empty string\" it's better if we only define this env. var. only if there's something to populate it. It actually would server users better as they can test for existence of certain variables instead of getting empty strings (and in case of non-existence they can default to a pre-set variable, like in Ansible's default () method).", "committedDate": "2020-01-16T07:07:47Z", "type": "commit"}]}