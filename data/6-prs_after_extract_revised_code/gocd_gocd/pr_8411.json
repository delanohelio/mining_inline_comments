{"pr_number": 8411, "pr_title": "Implement Permissions for Config Repository Material Test Connection", "pr_createdAt": "2020-08-03T08:19:14Z", "pr_url": "https://github.com/gocd/gocd/pull/8411", "timeline": [{"oid": "f0db1911e15f623fa409490b07045f7988066657", "url": "https://github.com/gocd/gocd/commit/f0db1911e15f623fa409490b07045f7988066657", "message": "Introduce config repo material test connection API\n\n* Introduce AbstractMaterialTestController which contains a controller\n  method to verify check connection.\n\n* Use the AbstractMaterialTestController in InternalMaterialTestControllerV1\n  and ConfigReposControllerV4.", "committedDate": "2020-08-03T06:56:47Z", "type": "commit"}, {"oid": "02e164633cb61d6cfe05d4a0bed285e79e39b8f2", "url": "https://github.com/gocd/gocd/commit/02e164633cb61d6cfe05d4a0bed285e79e39b8f2", "message": "Allow only admins and pipeline group admins to perform check connection on pipeline materials.\n\nContext:\n\n* Prior to GoCD release v20.6.0, GoCD had a common material check connection\n  API to perform material test for pipeline as well as config repo materials.\n\n* As part of GoCD release v20.2.0, GoCD added support for granular auth on\n  config repositories. Which in turn required users with granular auth on\n  config repositories to perform material test connection.\n\n* Due to implementation complexities to allow users with access to config\n  repos to perform material test on such config repo materials, was not possible,\n  hence, the material test connection API was made accessible for all\n  authenticated GoCD users (in GoCD release v20.2.0).\n\nChangeset:\n\n* This commit brings back the authorization check to allow only super admin\n  and group admin users to perform material check connection.", "committedDate": "2020-08-03T06:56:51Z", "type": "commit"}, {"oid": "cffbe4534d0a9a8b106eceb2272c2aaf599cc68f", "url": "https://github.com/gocd/gocd/commit/cffbe4534d0a9a8b106eceb2272c2aaf599cc68f", "message": "Use config repos material test connection API on SPA", "committedDate": "2020-08-03T08:56:48Z", "type": "commit"}, {"oid": "cffbe4534d0a9a8b106eceb2272c2aaf599cc68f", "url": "https://github.com/gocd/gocd/commit/cffbe4534d0a9a8b106eceb2272c2aaf599cc68f", "message": "Use config repos material test connection API on SPA", "committedDate": "2020-08-03T08:56:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1NDAwNw==", "url": "https://github.com/gocd/gocd/pull/8411#discussion_r464454007", "bodyText": "Are you planning to document the test connection endpoint? I remember there was a conversation earlier if we should document the test connection API or keep it internal. I think it was decided to keep it internal as the assumption was it will be used only on the SPA. If we are planning to keep it internal we should not add the endpoint in this controller.", "author": "maheshp", "createdAt": "2020-08-03T14:34:51Z", "path": "api/api-config-repos-v4/src/main/java/com/thoughtworks/go/apiv4/configrepos/ConfigReposControllerV4.java", "diffHunk": "@@ -57,16 +57,18 @@\n \n @ToggleRegisterLatest(controllerPath = Routes.ConfigRepos.BASE, apiVersion = ApiVersion.v4, as = \"branch_support\")\n @Component\n-public class ConfigReposControllerV4 extends ApiController implements SparkSpringController, CrudController<ConfigRepoConfig> {\n+public class ConfigReposControllerV4 extends AbstractMaterialTestController implements SparkSpringController, CrudController<ConfigRepoConfig> {", "originalCommit": "f0db1911e15f623fa409490b07045f7988066657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MTkwOQ==", "url": "https://github.com/gocd/gocd/pull/8411#discussion_r464781909", "bodyText": "@maheshp - Yes, this needs to be an internal API. I will move it to internal config repos api", "author": "GaneshSPatil", "createdAt": "2020-08-04T03:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1NDAwNw=="}], "type": "inlineReview", "revised_code": {"commit": "fed8a7769b7d3482ae829d8c39a6f97c2831219f", "chunk": "diff --git a/api/api-config-repos-v4/src/main/java/com/thoughtworks/go/apiv4/configrepos/ConfigReposControllerV4.java b/api/api-config-repos-v4/src/main/java/com/thoughtworks/go/apiv4/configrepos/ConfigReposControllerV4.java\nindex f086bf66f2..1ceb29edae 100644\n--- a/api/api-config-repos-v4/src/main/java/com/thoughtworks/go/apiv4/configrepos/ConfigReposControllerV4.java\n+++ b/api/api-config-repos-v4/src/main/java/com/thoughtworks/go/apiv4/configrepos/ConfigReposControllerV4.java\n\n@@ -57,7 +57,7 @@ import static spark.Spark.*;\n \n @ToggleRegisterLatest(controllerPath = Routes.ConfigRepos.BASE, apiVersion = ApiVersion.v4, as = \"branch_support\")\n @Component\n-public class ConfigReposControllerV4 extends AbstractMaterialTestController implements SparkSpringController, CrudController<ConfigRepoConfig> {\n+public class ConfigReposControllerV4 extends ApiController implements SparkSpringController, CrudController<ConfigRepoConfig> {\n     private final ApiAuthenticationHelper authHelper;\n     private final ConfigRepoService service;\n     private final EntityHashingService entityHashingService;\n"}}, {"oid": "fed8a7769b7d3482ae829d8c39a6f97c2831219f", "url": "https://github.com/gocd/gocd/commit/fed8a7769b7d3482ae829d8c39a6f97c2831219f", "message": "Move config repos check connection to internal config repos api", "committedDate": "2020-08-04T03:42:33Z", "type": "commit"}, {"oid": "eba330e3600cd184ce4aa43c7c0f3c368481215c", "url": "https://github.com/gocd/gocd/commit/eba330e3600cd184ce4aa43c7c0f3c368481215c", "message": "Use config repos internal test connection api on the spa", "committedDate": "2020-08-04T03:46:13Z", "type": "commit"}]}