{"pr_number": 7970, "pr_title": "Add an annotation that allows API routes to be conditionally mapped to `latest` version via feature-toggle", "pr_createdAt": "2020-04-07T08:26:03Z", "pr_url": "https://github.com/gocd/gocd/pull/7970", "timeline": [{"oid": "356356f43dfa8f9ce56f441c9177b4e17aa06c83", "url": "https://github.com/gocd/gocd/commit/356356f43dfa8f9ce56f441c9177b4e17aa06c83", "message": "Add an annotation that allows API routes to be conditionally mapped to `latest` version via feature-toggle\n\nUseful for developing new API versions that may not be yet finalized for release. Now you don't really have\nto revert your code only to undo the revert after release.", "committedDate": "2020-04-07T09:16:24Z", "type": "commit"}, {"oid": "356356f43dfa8f9ce56f441c9177b4e17aa06c83", "url": "https://github.com/gocd/gocd/commit/356356f43dfa8f9ce56f441c9177b4e17aa06c83", "message": "Add an annotation that allows API routes to be conditionally mapped to `latest` version via feature-toggle\n\nUseful for developing new API versions that may not be yet finalized for release. Now you don't really have\nto revert your code only to undo the revert after release.", "committedDate": "2020-04-07T09:16:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE1NjExMA==", "url": "https://github.com/gocd/gocd/pull/7970#discussion_r405156110", "bodyText": "It may not be obvious, but allToggles() is not really all toggles. It filters out toggles that are not known to available.toggles. Because we may have dynamically generated toggle keys for route toggles, we need to account for these in case users set them in <configDir>/go.feature.toggles.\nThus, we first search userToggles() alone before defaulting to allToggles().", "author": "marques-work", "createdAt": "2020-04-07T22:43:00Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/support/toggle/FeatureToggleService.java", "diffHunk": "@@ -42,25 +42,56 @@ public FeatureToggleService(FeatureToggleRepository repository, GoCache goCache)\n     }\n \n     public boolean isToggleOn(String key) {\n-        FeatureToggle toggle = allToggles().find(key);\n+        // handle any key, really.\n+        FeatureToggle toggle = userToggles().find(key);\n+        if (toggle != null) {\n+            return toggle.isOn();\n+        }\n+\n+        toggle = allToggles().find(key);", "originalCommit": "356356f43dfa8f9ce56f441c9177b4e17aa06c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMjE3OQ==", "url": "https://github.com/gocd/gocd/pull/7970#discussion_r406512179", "bodyText": "@marques-work I realized we cannot change the value for a dynamic toggle key. If you try to update the dynamic toggle key config_repo_v4 using the feature_toggles API it fails.\nThe reason for the failure is this check - \n  \n    \n      gocd/server/src/main/java/com/thoughtworks/go/server/service/support/toggle/FeatureToggleService.java\n    \n    \n         Line 102\n      in\n      3423ef9\n    \n    \n    \n    \n\n        \n          \n           throw new RecordNotFoundException(MessageFormat.format(\"Feature toggle: ''{0}'' is not valid.\", key));", "author": "maheshp", "createdAt": "2020-04-09T22:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE1NjExMA=="}], "type": "inlineReview", "revised_code": null}]}