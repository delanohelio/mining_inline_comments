{"pr_number": 683, "pr_title": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPat\u2026", "pr_createdAt": "2020-06-18T13:54:37Z", "pr_url": "https://github.com/vividus-framework/vividus/pull/683", "timeline": [{"oid": "88201061fbb2330448f2298fe1134bfaf2edfc7c", "url": "https://github.com/vividus-framework/vividus/commit/88201061fbb2330448f2298fe1134bfaf2edfc7c", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-06-18T14:08:55Z", "type": "forcePushed"}, {"oid": "d7d958b43621984386ab9df6263e06b8e7b4302d", "url": "https://github.com/vividus-framework/vividus/commit/d7d958b43621984386ab9df6263e06b8e7b4302d", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-06-18T14:19:22Z", "type": "forcePushed"}, {"oid": "eed621c2291e6ffc87d3aaf643604c30bbe44476", "url": "https://github.com/vividus-framework/vividus/commit/eed621c2291e6ffc87d3aaf643604c30bbe44476", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-06-18T14:41:13Z", "type": "forcePushed"}, {"oid": "4c696aefa88223738130d1b6c60131e0653b6741", "url": "https://github.com/vividus-framework/vividus/commit/4c696aefa88223738130d1b6c60131e0653b6741", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-06-18T14:50:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI5Nzc4Nw==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r442297787", "bodyText": "Please add integration test", "author": "ikalinin1", "createdAt": "2020-06-18T15:05:54Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -145,6 +148,62 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,", "originalCommit": "4c696aefa88223738130d1b6c60131e0653b6741", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2113192fbe2334fa3a2149b4da479aebbe6b36a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 28de5c4f..44805e7d 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -141,10 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI5ODY3MQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r442298671", "bodyText": "harEntry.getRequest() cache it please", "author": "ikalinin1", "createdAt": "2020-06-18T15:07:18Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -145,6 +148,62 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarPostData postData = harEntry.getRequest().getPostData();", "originalCommit": "4c696aefa88223738130d1b6c60131e0653b6741", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2113192fbe2334fa3a2149b4da479aebbe6b36a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 28de5c4f..44805e7d 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -141,10 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMwMTIyMQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r442301221", "bodyText": "don't you mind to refactor the method into something like this:\n            requestDataMap.put(\"queryMap\", queryMap(..));\n            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(..));\n            requestDataMap.put(\"requestBodyMap\", requestBodyMap(..));\n            requestDataMap.put(\"responseStatusMap\", responseStatusMap(..));", "author": "ikalinin1", "createdAt": "2020-06-18T15:11:04Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -145,6 +148,62 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)", "originalCommit": "4c696aefa88223738130d1b6c60131e0653b6741", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2113192fbe2334fa3a2149b4da479aebbe6b36a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 28de5c4f..44805e7d 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -141,10 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMwMjI3Mw==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r442302273", "bodyText": "use Assertions.assertAll(...)\nIn the current implementation, I have to debug and compare manually to understand what is not matching", "author": "ikalinin1", "createdAt": "2020-06-18T15:12:38Z", "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java", "diffHunk": "@@ -137,35 +144,96 @@ void checkHarEntryExistenceWithHttpMethodAndUrlPatternNoCalls() throws IOExcepti\n     @Test\n     void checkCaptureQueryStringFromHarEntry() throws IOException\n     {\n-        HttpMethod httpMethod = HttpMethod.POST;\n         ProxySteps spy = spy(proxySteps);\n         HarEntry harEntry = mock(HarEntry.class);\n-        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(httpMethod, URL_PATTERN,\n+        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(HTTP_METHOD, URL_PATTERN,\n                 ComparisonRule.EQUAL_TO, 1);\n         HarRequest harRequest = mock(HarRequest.class);\n         when(harEntry.getRequest()).thenReturn(harRequest);\n-        String key1 = \"key1\";\n-        String value1 = \"value1\";\n-        String key2 = \"key2\";\n-        String value2 = \"value2\";\n         HarQueryParam firstPair = new HarQueryParam();\n-        firstPair.setName(key1);\n-        firstPair.setValue(value1);\n+        firstPair.setName(KEY1);\n+        firstPair.setValue(VALUE1);\n         HarQueryParam secondPair = new HarQueryParam();\n-        secondPair.setName(key2);\n-        secondPair.setValue(value2);\n+        secondPair.setName(KEY2);\n+        secondPair.setValue(VALUE2);\n         when(harRequest.getQueryString())\n                 .thenReturn(List.of(firstPair, secondPair));\n         Set<VariableScope> variableScopes = Set.of(VariableScope.SCENARIO);\n-        spy.captureRequestAndSaveURLQuery(httpMethod, URL_PATTERN, variableScopes, VARIABLE_NAME);\n+        spy.captureRequestAndSaveURLQuery(HTTP_METHOD, URL_PATTERN, variableScopes, VARIABLE_NAME);\n         verify(bddVariableContext).putVariable(eq(variableScopes), eq(VARIABLE_NAME), argThat(value ->\n         {\n             Map<String, String> map = (Map<String, String>) value;\n             return map.size() == 2\n-                    && map.containsKey(key1)\n-                    && value1.equals(map.get(key1))\n-                    && map.containsKey(key2)\n-                    && value2.equals(map.get(key2));\n+                    && map.containsKey(KEY1)\n+                    && VALUE1.equals(map.get(KEY1))\n+                    && map.containsKey(KEY2)\n+                    && VALUE2.equals(map.get(KEY2));\n+        }));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    void checkCaptureRequestDataFromHarEntry() throws IOException\n+    {\n+        ProxySteps spy = spy(proxySteps);\n+        HarEntry harEntry = mock(HarEntry.class);\n+        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(HTTP_METHOD, URL_PATTERN,\n+                ComparisonRule.EQUAL_TO, 1);\n+        HarResponse harResponse = mock(HarResponse.class);\n+        when(harEntry.getResponse()).thenReturn(harResponse);\n+        HarRequest harRequest = mock(HarRequest.class);\n+        when(harEntry.getRequest()).thenReturn(harRequest);\n+        HarQueryParam firstPair = new HarQueryParam();\n+        firstPair.setName(KEY1);\n+        firstPair.setValue(VALUE1);\n+        HarQueryParam secondPair = new HarQueryParam();\n+        secondPair.setName(KEY2);\n+        secondPair.setValue(VALUE2);\n+        when(harRequest.getQueryString())\n+                .thenReturn(List.of(firstPair, secondPair));\n+        String mimeType = \"mimeType\";\n+        String text = \"text\";\n+        String comment = \"comment\";\n+        HarPostData postData = new HarPostData();\n+        postData.setMimeType(mimeType);\n+        postData.setText(text);\n+        postData.setComment(comment);\n+        HarPostDataParam postDataParam1 = new HarPostDataParam();\n+        HarPostDataParam postDataParam2 = new HarPostDataParam();\n+        postData.setParams(List.of(postDataParam1, postDataParam2));\n+        postDataParam1.setName(KEY1);\n+        postDataParam1.setValue(VALUE1);\n+        postDataParam2.setName(KEY2);\n+        postDataParam2.setValue(VALUE2);\n+        when(harRequest.getPostData()).thenReturn(postData);\n+        when(harResponse.getStatus()).thenReturn(200);\n+        Set<VariableScope> variableScopes = Set.of(VariableScope.SCENARIO);\n+        spy.captureRequestAndSaveRequestData(HTTP_METHOD, URL_PATTERN, variableScopes, VARIABLE_NAME);\n+        verify(bddVariableContext).putVariable(eq(variableScopes), eq(VARIABLE_NAME), argThat(value ->\n+        {\n+            Map<String, Map<String, String>> map = (Map<String, Map<String, String>>) value;\n+            Map<String, String> queryMap = map.get(\"queryMap\");\n+            Map<String, String> requestBodyMap = map.get(\"requestBodyMap\");\n+            Map<String, String> requestBodyParamsMap = map.get(\"requestBodyParamsMap\");\n+            Map<String, String> responseStatusMap = map.get(\"responseStatusMap\");\n+            String status = \"status\";\n+            return map.size() == 4", "originalCommit": "4c696aefa88223738130d1b6c60131e0653b6741", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2113192fbe2334fa3a2149b4da479aebbe6b36a", "chunk": "diff --git a/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java b/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\nindex fb46dd2e..9e9b27fb 100644\n--- a/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\n+++ b/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\n\n@@ -217,23 +218,16 @@ class ProxyStepsTests\n             Map<String, String> requestBodyParamsMap = map.get(\"requestBodyParamsMap\");\n             Map<String, String> responseStatusMap = map.get(\"responseStatusMap\");\n             String status = \"status\";\n-            return map.size() == 4\n-                    && queryMap.containsKey(KEY1)\n-                    && VALUE1.equals(queryMap.get(KEY1))\n-                    && queryMap.containsKey(KEY2)\n-                    && VALUE2.equals(queryMap.get(KEY2))\n-                    && requestBodyMap.containsKey(mimeType)\n-                    && mimeType.equals(requestBodyMap.get(mimeType))\n-                    && requestBodyMap.containsKey(text)\n-                    && text.equals(requestBodyMap.get(text))\n-                    && requestBodyMap.containsKey(comment)\n-                    && comment.equals(requestBodyMap.get(comment))\n-                    && requestBodyParamsMap.containsKey(KEY1)\n-                    && VALUE1.equals(requestBodyParamsMap.get(KEY1))\n-                    && requestBodyParamsMap.containsKey(KEY2)\n-                    && VALUE2.equals(requestBodyParamsMap.get(KEY2))\n-                    && responseStatusMap.containsKey(status)\n-                    && \"200\".equals(responseStatusMap.get(status));\n+            Assertions.assertAll(\n+                () -> Assertions.assertEquals(VALUE1, queryMap.get(KEY1)),\n+                () -> Assertions.assertEquals(VALUE2, queryMap.get(KEY2)),\n+                () -> Assertions.assertEquals(mimeType, requestBodyMap.get(mimeType)),\n+                () -> Assertions.assertEquals(text, requestBodyMap.get(text)),\n+                () -> Assertions.assertEquals(comment, requestBodyMap.get(comment)),\n+                () -> Assertions.assertEquals(VALUE1, requestBodyParamsMap.get(KEY1)),\n+                () -> Assertions.assertEquals(VALUE2, requestBodyParamsMap.get(KEY2)),\n+                () -> Assertions.assertEquals(\"200\", responseStatusMap.get(status)));\n+            return true;\n         }));\n     }\n \n"}}, {"oid": "a2113192fbe2334fa3a2149b4da479aebbe6b36a", "url": "https://github.com/vividus-framework/vividus/commit/a2113192fbe2334fa3a2149b4da479aebbe6b36a", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-06-18T18:25:16Z", "type": "forcePushed"}, {"oid": "1d62818d41482839b953b765626d51d4ec00214a", "url": "https://github.com/vividus-framework/vividus/commit/1d62818d41482839b953b765626d51d4ec00214a", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-07-01T11:23:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyNzE3MQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450727171", "bodyText": "construct Map using Map.of(...) method\ndo not use collection name as part of variable name", "author": "uarlouski", "createdAt": "2020-07-07T09:21:38Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyODA1Nw==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450728057", "bodyText": "queryMap - not clear, consider something like getQueryParameters, the same for all the methods below", "author": "uarlouski", "createdAt": "2020-07-07T09:23:04Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyODM2Mg==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450728362", "bodyText": "variable names for end users should be simplified and made clearer", "author": "uarlouski", "createdAt": "2020-07-07T09:23:35Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));\n+            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(postData));\n+            requestDataMap.put(\"requestBodyMap\", requestBodyMap(postData));\n+            requestDataMap.put(\"responseStatusMap\", responseStatusMap(harEntry));", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyODg4OA==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450728888", "bodyText": "why not to put status as plain value? we can not get more than one status so there is no reason to put it as a map", "author": "uarlouski", "createdAt": "2020-07-07T09:24:31Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));\n+            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(postData));\n+            requestDataMap.put(\"requestBodyMap\", requestBodyMap(postData));\n+            requestDataMap.put(\"responseStatusMap\", responseStatusMap(harEntry));\n+            bddVariableContext.putVariable(scopes, variableName, requestDataMap);\n+        }\n+    }\n+\n+    private Map<String, String> responseStatusMap(HarEntry harEntry)\n+    {\n+        int statusCode = harEntry.getResponse().getStatus();\n+        return Map.of(\"status\", String.valueOf(statusCode));", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0MzYyOQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450743629", "bodyText": "We use Map<String, Map<String, String>> to save all needed information to variable, so we can't put status as plain value into this object", "author": "ngrudnitsky", "createdAt": "2020-07-07T09:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyODg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NDQ5OA==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450774498", "bodyText": "Map<String, Object> ?", "author": "uarlouski", "createdAt": "2020-07-07T10:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyODg4OA=="}], "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyOTE5Mw==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450729193", "bodyText": "use map.of(...)", "author": "uarlouski", "createdAt": "2020-07-07T09:25:00Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));\n+            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(postData));\n+            requestDataMap.put(\"requestBodyMap\", requestBodyMap(postData));\n+            requestDataMap.put(\"responseStatusMap\", responseStatusMap(harEntry));\n+            bddVariableContext.putVariable(scopes, variableName, requestDataMap);\n+        }\n+    }\n+\n+    private Map<String, String> responseStatusMap(HarEntry harEntry)\n+    {\n+        int statusCode = harEntry.getResponse().getStatus();\n+        return Map.of(\"status\", String.valueOf(statusCode));\n+    }\n+\n+    private Map<String, String> requestBodyMap(HarPostData postData)\n+    {\n+        Map<String, String> requestBodyMap = new HashMap<>();", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyOTUxNA==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450729514", "bodyText": "not aligned", "author": "uarlouski", "createdAt": "2020-07-07T09:25:31Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));\n+            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(postData));\n+            requestDataMap.put(\"requestBodyMap\", requestBodyMap(postData));\n+            requestDataMap.put(\"responseStatusMap\", responseStatusMap(harEntry));\n+            bddVariableContext.putVariable(scopes, variableName, requestDataMap);\n+        }\n+    }\n+\n+    private Map<String, String> responseStatusMap(HarEntry harEntry)\n+    {\n+        int statusCode = harEntry.getResponse().getStatus();\n+        return Map.of(\"status\", String.valueOf(statusCode));\n+    }\n+\n+    private Map<String, String> requestBodyMap(HarPostData postData)\n+    {\n+        Map<String, String> requestBodyMap = new HashMap<>();\n+        requestBodyMap.put(\"mimeType\", postData.getMimeType());\n+        requestBodyMap.put(\"text\", postData.getText());\n+        requestBodyMap.put(\"comment\", postData.getComment());\n+        return requestBodyMap;\n+    }\n+\n+    private Map<String, String> requestBodyParamsMap(HarPostData postData)\n+    {\n+        return postData.getParams()\n+                        .stream()", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyOTYzNQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450729635", "bodyText": "not aligned", "author": "uarlouski", "createdAt": "2020-07-07T09:25:41Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -138,13 +142,84 @@ public void captureRequestAndSaveURLQuery(HttpMethod httpMethod, String urlPatte\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            Map<String, String> queryMap = harEntry.getRequest().getQueryString()\n-                    .stream()\n-                    .collect(Collectors.toMap(HarQueryParam::getName, HarQueryParam::getValue));\n-            bddVariableContext.putVariable(scopes, variableName, queryMap);\n+            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n         }\n     }\n \n+    /**\n+     * Saves the query string, body from request with given URL-pattern and response status from response\n+     * into the variable with specified name and scopes.\n+     * <p>\n+     * This step requires proxy to be turned on.\n+     * It can be done via setting properties or switching on <b>@proxy</b> metatag inside the story file.\n+     * Step gets proxies log, extract from contained requests URLs and match them with URL-pattern\n+     * If there is one entry, it saves the query string from request as Map of keys and values\n+     * into the variable with specified name and scopes.\n+     * If there weren't any calls or more than one matching requirements, HAR file with all\n+     * calls will be attached to report.\n+     * </p>\n+     * @param httpMethod HTTP method to filter by\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     * @param scopes The set (comma separated list of scopes e.g.: STORY, NEXT_BATCHES) of variable's scope<br>\n+     * <i>Available scopes:</i>\n+     * <ul>\n+     * <li><b>STEP</b> - the variable will be available only within the step,\n+     * <li><b>SCENARIO</b> - the variable will be available only within the scenario,\n+     * <li><b>STORY</b> - the variable will be available within the whole story,\n+     * <li><b>NEXT_BATCHES</b> - the variable will be available starting from next batch\n+     * </ul>\n+     * @param variableName A variable name\n+     * @throws IOException If any error happens during operation\n+     */\n+    @When(\"I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes \"\n+            + \"variable `$variableName`\")\n+    public void captureRequestAndSaveRequestData(HttpMethod httpMethod, String urlPattern, Set<VariableScope> scopes,\n+            String variableName) throws IOException\n+    {\n+        List<HarEntry> harEntries = checkNumberOfRequests(httpMethod, urlPattern, ComparisonRule.EQUAL_TO, 1);\n+        if (harEntries.size() == 1)\n+        {\n+            HarEntry harEntry = harEntries.get(0);\n+            HarRequest request = harEntry.getRequest();\n+            HarPostData postData = request.getPostData();\n+            Map<String, Map<String, String>> requestDataMap = new HashMap<>();\n+            requestDataMap.put(\"queryMap\", queryMap(request));\n+            requestDataMap.put(\"requestBodyParamsMap\", requestBodyParamsMap(postData));\n+            requestDataMap.put(\"requestBodyMap\", requestBodyMap(postData));\n+            requestDataMap.put(\"responseStatusMap\", responseStatusMap(harEntry));\n+            bddVariableContext.putVariable(scopes, variableName, requestDataMap);\n+        }\n+    }\n+\n+    private Map<String, String> responseStatusMap(HarEntry harEntry)\n+    {\n+        int statusCode = harEntry.getResponse().getStatus();\n+        return Map.of(\"status\", String.valueOf(statusCode));\n+    }\n+\n+    private Map<String, String> requestBodyMap(HarPostData postData)\n+    {\n+        Map<String, String> requestBodyMap = new HashMap<>();\n+        requestBodyMap.put(\"mimeType\", postData.getMimeType());\n+        requestBodyMap.put(\"text\", postData.getText());\n+        requestBodyMap.put(\"comment\", postData.getComment());\n+        return requestBodyMap;\n+    }\n+\n+    private Map<String, String> requestBodyParamsMap(HarPostData postData)\n+    {\n+        return postData.getParams()\n+                        .stream()\n+                        .collect(Collectors.toMap(HarPostDataParam::getName, HarPostDataParam::getValue));\n+    }\n+\n+    private Map<String, String> queryMap(HarRequest request)\n+    {\n+        return request.getQueryString()", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\nindex 44805e7d..fdc184d7 100644\n--- a/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n+++ b/vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java\n\n@@ -142,7 +142,7 @@ public class ProxySteps\n         if (harEntries.size() == 1)\n         {\n             HarEntry harEntry = harEntries.get(0);\n-            bddVariableContext.putVariable(scopes, variableName, queryMap(harEntry.getRequest()));\n+            bddVariableContext.putVariable(scopes, variableName, getQueryParameters(harEntry.getRequest()));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMDg1MQ==", "url": "https://github.com/vividus-framework/vividus/pull/683#discussion_r450730851", "bodyText": "constructions of HarPostDataParam, HarQueryParam objects can be moved into separate method, please reuse similar logic", "author": "uarlouski", "createdAt": "2020-07-07T09:27:37Z", "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java", "diffHunk": "@@ -137,35 +145,89 @@ void checkHarEntryExistenceWithHttpMethodAndUrlPatternNoCalls() throws IOExcepti\n     @Test\n     void checkCaptureQueryStringFromHarEntry() throws IOException\n     {\n-        HttpMethod httpMethod = HttpMethod.POST;\n         ProxySteps spy = spy(proxySteps);\n         HarEntry harEntry = mock(HarEntry.class);\n-        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(httpMethod, URL_PATTERN,\n+        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(HTTP_METHOD, URL_PATTERN,\n                 ComparisonRule.EQUAL_TO, 1);\n         HarRequest harRequest = mock(HarRequest.class);\n         when(harEntry.getRequest()).thenReturn(harRequest);\n-        String key1 = \"key1\";\n-        String value1 = \"value1\";\n-        String key2 = \"key2\";\n-        String value2 = \"value2\";\n         HarQueryParam firstPair = new HarQueryParam();\n-        firstPair.setName(key1);\n-        firstPair.setValue(value1);\n+        firstPair.setName(KEY1);\n+        firstPair.setValue(VALUE1);\n         HarQueryParam secondPair = new HarQueryParam();\n-        secondPair.setName(key2);\n-        secondPair.setValue(value2);\n+        secondPair.setName(KEY2);\n+        secondPair.setValue(VALUE2);\n         when(harRequest.getQueryString())\n                 .thenReturn(List.of(firstPair, secondPair));\n         Set<VariableScope> variableScopes = Set.of(VariableScope.SCENARIO);\n-        spy.captureRequestAndSaveURLQuery(httpMethod, URL_PATTERN, variableScopes, VARIABLE_NAME);\n+        spy.captureRequestAndSaveURLQuery(HTTP_METHOD, URL_PATTERN, variableScopes, VARIABLE_NAME);\n         verify(bddVariableContext).putVariable(eq(variableScopes), eq(VARIABLE_NAME), argThat(value ->\n         {\n             Map<String, String> map = (Map<String, String>) value;\n             return map.size() == 2\n-                    && map.containsKey(key1)\n-                    && value1.equals(map.get(key1))\n-                    && map.containsKey(key2)\n-                    && value2.equals(map.get(key2));\n+                    && map.containsKey(KEY1)\n+                    && VALUE1.equals(map.get(KEY1))\n+                    && map.containsKey(KEY2)\n+                    && VALUE2.equals(map.get(KEY2));\n+        }));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    void checkCaptureRequestDataFromHarEntry() throws IOException\n+    {\n+        ProxySteps spy = spy(proxySteps);\n+        HarEntry harEntry = mock(HarEntry.class);\n+        doReturn(List.of(harEntry)).when(spy).checkNumberOfRequests(HTTP_METHOD, URL_PATTERN,\n+                ComparisonRule.EQUAL_TO, 1);\n+        HarResponse harResponse = mock(HarResponse.class);\n+        when(harEntry.getResponse()).thenReturn(harResponse);\n+        HarRequest harRequest = mock(HarRequest.class);\n+        when(harEntry.getRequest()).thenReturn(harRequest);\n+        HarQueryParam firstPair = new HarQueryParam();\n+        firstPair.setName(KEY1);\n+        firstPair.setValue(VALUE1);\n+        HarQueryParam secondPair = new HarQueryParam();\n+        secondPair.setName(KEY2);\n+        secondPair.setValue(VALUE2);\n+        when(harRequest.getQueryString())\n+                .thenReturn(List.of(firstPair, secondPair));\n+        String mimeType = \"mimeType\";\n+        String text = \"text\";\n+        String comment = \"comment\";\n+        HarPostData postData = new HarPostData();\n+        postData.setMimeType(mimeType);\n+        postData.setText(text);\n+        postData.setComment(comment);\n+        HarPostDataParam postDataParam1 = new HarPostDataParam();", "originalCommit": "1d62818d41482839b953b765626d51d4ec00214a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cac671737008f59411ccb255e951e095b5ed86a", "chunk": "diff --git a/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java b/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\nindex 9e9b27fb..5f3005d9 100644\n--- a/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\n+++ b/vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java\n\n@@ -151,14 +154,11 @@ class ProxyStepsTests\n                 ComparisonRule.EQUAL_TO, 1);\n         HarRequest harRequest = mock(HarRequest.class);\n         when(harEntry.getRequest()).thenReturn(harRequest);\n-        HarQueryParam firstPair = new HarQueryParam();\n-        firstPair.setName(KEY1);\n-        firstPair.setValue(VALUE1);\n-        HarQueryParam secondPair = new HarQueryParam();\n-        secondPair.setName(KEY2);\n-        secondPair.setValue(VALUE2);\n         when(harRequest.getQueryString())\n-                .thenReturn(List.of(firstPair, secondPair));\n+                .thenReturn(List.of(\n+                        getHarQueryParam(KEY1, VALUE1),\n+                        getHarQueryParam(KEY2, VALUE2)\n+                ));\n         Set<VariableScope> variableScopes = Set.of(VariableScope.SCENARIO);\n         spy.captureRequestAndSaveURLQuery(HTTP_METHOD, URL_PATTERN, variableScopes, VARIABLE_NAME);\n         verify(bddVariableContext).putVariable(eq(variableScopes), eq(VARIABLE_NAME), argThat(value ->\n"}}, {"oid": "2cac671737008f59411ccb255e951e095b5ed86a", "url": "https://github.com/vividus-framework/vividus/commit/2cac671737008f59411ccb255e951e095b5ed86a", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-07-07T13:19:13Z", "type": "commit"}, {"oid": "2cac671737008f59411ccb255e951e095b5ed86a", "url": "https://github.com/vividus-framework/vividus/commit/2cac671737008f59411ccb255e951e095b5ed86a", "message": "Add When I capture HTTP $httpMethod request with URL pattern `$urlPattern` and save request data to $scopes variable `$variableName`", "committedDate": "2020-07-07T13:19:13Z", "type": "forcePushed"}]}