{"pr_number": 5333, "pr_title": "Fixes GatewayLivenessProbeIntegrationTest flaky test", "pr_createdAt": "2020-09-10T19:47:52Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5333", "timeline": [{"oid": "fc8dfcc3cf9b51a2221b7170d3e4c7fdc4674e86", "url": "https://github.com/camunda-cloud/zeebe/commit/fc8dfcc3cf9b51a2221b7170d3e4c7fdc4674e86", "message": "chore(qa): wait until all delayed indicators have been called", "committedDate": "2020-09-11T06:30:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyODEyMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5333#discussion_r487728122", "bodyText": "As discussed, please either add a timeout on the request or try once more if this assertion failed, because it could be that the request just took very long the first time and ends up with a non 200 value.", "author": "korthout", "createdAt": "2020-09-14T08:10:33Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java", "diffHunk": "@@ -63,17 +56,25 @@ public void shouldReportLivenessUpIfConnectedToBroker() {\n             .build();\n \n     // --- when + then ---------------------------------------\n-    given().spec(gatewayServerSpec).when().get(PATH_LIVENESS_PROBE).then().statusCode(200);\n+    // most of the liveness probes use a delayed health indicator which is scheduled at a fixed\n+    // rate of 5 seconds, so it may take up to that and a bit more in the worst case once the\n+    // gateway finds the broker\n+    Awaitility.await(\"wait until status turns UP\")\n+        .atMost(Duration.ofSeconds(10))\n+        .pollInterval(Duration.ofMillis(100))\n+        .untilAsserted(\n+            () ->\n+                given()\n+                    .spec(gatewayServerSpec)\n+                    .when()\n+                    .get(PATH_LIVENESS_PROBE)\n+                    .then()\n+                    .statusCode(200));", "originalCommit": "c72cc1cc481adc356191eebaf664d7cdd524301e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba1d2ecabf4ce956022548cf979d4b7d697997a7", "chunk": "diff --git a/qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java b/qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java\nindex e4301a5a8..661e04e20 100644\n--- a/qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java\n+++ b/qa/integration-tests/src/test/java/io/zeebe/broker/it/gateway/GatewayLivenessProbeIntegrationTest.java\n\n@@ -59,17 +60,23 @@ public class GatewayLivenessProbeIntegrationTest {\n     // most of the liveness probes use a delayed health indicator which is scheduled at a fixed\n     // rate of 5 seconds, so it may take up to that and a bit more in the worst case once the\n     // gateway finds the broker\n-    Awaitility.await(\"wait until status turns UP\")\n-        .atMost(Duration.ofSeconds(10))\n-        .pollInterval(Duration.ofMillis(100))\n-        .untilAsserted(\n-            () ->\n-                given()\n-                    .spec(gatewayServerSpec)\n-                    .when()\n-                    .get(PATH_LIVENESS_PROBE)\n-                    .then()\n-                    .statusCode(200));\n+    try {\n+      Awaitility.await(\"wait until status turns UP\")\n+          .atMost(Duration.ofSeconds(10))\n+          .pollInterval(Duration.ofMillis(100))\n+          .untilAsserted(\n+              () ->\n+                  given()\n+                      .spec(gatewayServerSpec)\n+                      .when()\n+                      .get(PATH_LIVENESS_PROBE)\n+                      .then()\n+                      .statusCode(200));\n+    } catch (final ConditionTimeoutException e) {\n+      // it can happen that a single request takes too long and causes awaitility to timeout,\n+      // in which case we want to try a second time to run the request without timeout\n+      given().spec(gatewayServerSpec).when().get(PATH_LIVENESS_PROBE).then().statusCode(200);\n+    }\n \n     // --- shutdown ------------------------------------------\n     Stream.of(gateway, broker).parallel().forEach(Startable::stop);\n"}}, {"oid": "ba1d2ecabf4ce956022548cf979d4b7d697997a7", "url": "https://github.com/camunda-cloud/zeebe/commit/ba1d2ecabf4ce956022548cf979d4b7d697997a7", "message": "chore(parent): ignore other slf4j binding", "committedDate": "2020-09-14T15:17:31Z", "type": "forcePushed"}, {"oid": "477835cc6868b7e4a6a2b684cc0bea35993ede59", "url": "https://github.com/camunda-cloud/zeebe/commit/477835cc6868b7e4a6a2b684cc0bea35993ede59", "message": "chore(qa): wait until all delayed indicators have been called", "committedDate": "2020-09-15T07:58:13Z", "type": "commit"}, {"oid": "41bccb0523ca98f0604237d13b4a5ef02f084025", "url": "https://github.com/camunda-cloud/zeebe/commit/41bccb0523ca98f0604237d13b4a5ef02f084025", "message": "chore(parent): ignore other slf4j binding", "committedDate": "2020-09-15T07:58:20Z", "type": "commit"}, {"oid": "41bccb0523ca98f0604237d13b4a5ef02f084025", "url": "https://github.com/camunda-cloud/zeebe/commit/41bccb0523ca98f0604237d13b4a5ef02f084025", "message": "chore(parent): ignore other slf4j binding", "committedDate": "2020-09-15T07:58:20Z", "type": "forcePushed"}]}