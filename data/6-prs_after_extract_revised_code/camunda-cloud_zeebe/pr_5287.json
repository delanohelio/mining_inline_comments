{"pr_number": 5287, "pr_title": "Improve atomix startup and snapshot replication logs", "pr_createdAt": "2020-09-03T07:11:17Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5287", "timeline": [{"oid": "b4919f2278a9d36ef9cdb9bc4b055745945f94a4", "url": "https://github.com/camunda-cloud/zeebe/commit/b4919f2278a9d36ef9cdb9bc4b055745945f94a4", "message": "chore(atomix): add more logs snapshot replication", "committedDate": "2020-09-02T13:56:11Z", "type": "commit"}, {"oid": "1537dbfa0a66957559355cc375486c575f4ad6c7", "url": "https://github.com/camunda-cloud/zeebe/commit/1537dbfa0a66957559355cc375486c575f4ad6c7", "message": "chore(atomix): improve raft startup logs", "committedDate": "2020-09-02T14:46:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NDc2MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5287#discussion_r482764761", "bodyText": "Since this case is not a failure, do we want to reduce the log level to DEBUG instead?\nOr, is it useful to see these log statements on WARN?", "author": "saig0", "createdAt": "2020-09-03T07:28:28Z", "path": "logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java", "diffHunk": "@@ -27,13 +28,17 @@ public void onWrite(final long address) {\n \n   @Override\n   public void onWriteError(final Throwable error) {\n-    LogStorageAppender.LOG.error(\n-        \"Failed to append block with last event position {}.\", highestPosition, error);\n-    if (error instanceof NoSuchElementException) {\n+    if (error instanceof NoSuchElementException || error instanceof NoLeader) {\n       // Not a failure. It is probably during transition to follower.\n+      LogStorageAppender.LOG.warn(\n+          \"Failed to append block with last event position {}. This can happen during a leader change.\",\n+          highestPosition,\n+          error);", "originalCommit": "8ffc3617cd318453e99354743b7d1b8e9a073c85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyOTI1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5287#discussion_r482829255", "bodyText": "Agree. DEBUG would be better. I changed it.", "author": "deepthidevaki", "createdAt": "2020-09-03T09:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NDc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4e031c0821fe3fe98bf6b2d61c61cec9966dba65", "chunk": "diff --git a/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java b/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\nindex c7262226bf..c09cb58b60 100644\n--- a/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\n+++ b/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\n\n@@ -30,7 +30,7 @@ public final class Listener implements AppendListener {\n   public void onWriteError(final Throwable error) {\n     if (error instanceof NoSuchElementException || error instanceof NoLeader) {\n       // Not a failure. It is probably during transition to follower.\n-      LogStorageAppender.LOG.warn(\n+      LogStorageAppender.LOG.debug(\n           \"Failed to append block with last event position {}. This can happen during a leader change.\",\n           highestPosition,\n           error);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2ODIzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5287#discussion_r482768235", "bodyText": "You changed the hashCode() and equals() implementation.\nWhy did you change it?\nDoes this change any behavior?", "author": "saig0", "createdAt": "2020-09-03T07:34:35Z", "path": "snapshot/src/main/java/io/zeebe/snapshots/broker/impl/FileBasedSnapshotMetadata.java", "diffHunk": "@@ -122,34 +122,37 @@ public String getSnapshotIdAsString() {\n \n   @Override\n   public int hashCode() {\n-    return Objects.hash(getIndex(), getTerm(), getTimestamp());\n+    return Objects.hash(index, term, processedPosition, exporterPosition);", "originalCommit": "8ffc3617cd318453e99354743b7d1b8e9a073c85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNjEwOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5287#discussion_r482826108", "bodyText": "This should have been updated when new fields were added to the class, but it was not.  It won't change any behavior, but it is expected to include processedPosition and exporterPosition when comaparing two snapshots. We did not find out this error, because we are using SnapshotId::compareTo to compare them.", "author": "deepthidevaki", "createdAt": "2020-09-03T09:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2ODIzNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ac228185b8ee65ca1cda3410a77c93fb7ef30c14", "url": "https://github.com/camunda-cloud/zeebe/commit/ac228185b8ee65ca1cda3410a77c93fb7ef30c14", "message": "chore(broker): improve error messages", "committedDate": "2020-09-03T09:05:46Z", "type": "forcePushed"}, {"oid": "4e031c0821fe3fe98bf6b2d61c61cec9966dba65", "url": "https://github.com/camunda-cloud/zeebe/commit/4e031c0821fe3fe98bf6b2d61c61cec9966dba65", "message": "chore(broker): improve appender error messages", "committedDate": "2020-09-03T09:28:16Z", "type": "commit"}, {"oid": "4e031c0821fe3fe98bf6b2d61c61cec9966dba65", "url": "https://github.com/camunda-cloud/zeebe/commit/4e031c0821fe3fe98bf6b2d61c61cec9966dba65", "message": "chore(broker): improve appender error messages", "committedDate": "2020-09-03T09:28:16Z", "type": "forcePushed"}]}