{"pr_number": 5713, "pr_title": "Add FNI metrics", "pr_createdAt": "2020-10-28T08:24:31Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5713", "timeline": [{"oid": "307589c50fc08a6e9305992881174ad3fd945f74", "url": "https://github.com/camunda-cloud/zeebe/commit/307589c50fc08a6e9305992881174ad3fd945f74", "message": "chore(monitor): add FNI metrics panel's", "committedDate": "2020-10-28T08:25:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MzEyOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513343128", "bodyText": "We count FNI completed not for the process itself. I guess that we want to do the same for FNI terminated.", "author": "saig0", "createdAt": "2020-10-28T10:42:47Z", "path": "broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java", "diffHunk": "@@ -82,11 +82,16 @@ private void handleWorkflowInstanceRecord(\n     if (currentIntent == WorkflowInstanceIntent.ELEMENT_ACTIVATING\n         && isWorkflowInstanceRecord(record)) {\n       storeWorkflowInstanceCreation(record.getTimestamp(), recordKey);\n-    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_COMPLETED\n-        && isWorkflowInstanceRecord(record)) {\n-      final var creationTime = workflowInstanceKeyToCreationTimeMap.remove(recordKey);\n-      executionLatencyMetrics.observeWorkflowInstanceExecutionTime(\n-          partitionId, creationTime, record.getTimestamp());\n+    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_COMPLETED) {\n+      if (isWorkflowInstanceRecord(record)) {\n+        final var creationTime = workflowInstanceKeyToCreationTimeMap.remove(recordKey);\n+        executionLatencyMetrics.observeWorkflowInstanceExecutionTime(\n+            partitionId, creationTime, record.getTimestamp());\n+      } else {\n+        FNIMetrics.addflowNodeInstanceCompleted(partitionId);\n+      }\n+    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_TERMINATED) {\n+      FNIMetrics.addflowNodeInstanceTerminated(partitionId);", "originalCommit": "307589c50fc08a6e9305992881174ad3fd945f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM4MTkzNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513381934", "bodyText": "Makes sense \ud83d\udc4d", "author": "Zelldon", "createdAt": "2020-10-28T11:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MzEyOA=="}], "type": "inlineReview", "revised_code": {"commit": "ed04e6baf964966cd409fdedde574ae2e4bf9251", "chunk": "diff --git a/broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java b/broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java\nindex 8eb1303af..315a200a4 100644\n--- a/broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java\n+++ b/broker/src/main/java/io/zeebe/broker/exporter/metrics/MetricsExporter.java\n\n@@ -88,10 +88,11 @@ public class MetricsExporter implements Exporter {\n         executionLatencyMetrics.observeWorkflowInstanceExecutionTime(\n             partitionId, creationTime, record.getTimestamp());\n       } else {\n-        FNIMetrics.addflowNodeInstanceCompleted(partitionId);\n+        FNIMetrics.addFlowNodeInstanceCompleted(partitionId);\n       }\n-    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_TERMINATED) {\n-      FNIMetrics.addflowNodeInstanceTerminated(partitionId);\n+    } else if (currentIntent == WorkflowInstanceIntent.ELEMENT_TERMINATED\n+        && !isWorkflowInstanceRecord(record)) {\n+      FNIMetrics.addFlowNodeInstanceTerminated(partitionId);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0OTU3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513349578", "bodyText": "Is there a difference between two counters and add a label for the type (completed|terminated)?\nLooking at the dashboard, I think it would make sense to merge the two views together into one.", "author": "saig0", "createdAt": "2020-10-28T10:53:36Z", "path": "broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.broker.exporter.metrics;\n+\n+import io.prometheus.client.Counter;\n+\n+public class FNIMetrics {\n+\n+  private static final Counter FLOW_NODE_INSTANCE_COMPLETED =\n+      Counter.build()\n+          .namespace(\"zeebe\")\n+          .name(\"flow_node_instance_completed\")\n+          .help(\"Number of flow node instances, which have been completed.\")\n+          .labelNames(\"partition\")\n+          .register();\n+\n+  private static final Counter FLOW_NODE_INSTANCE_TERMINATED =\n+      Counter.build()\n+          .namespace(\"zeebe\")\n+          .name(\"flow_node_instance_terminated\")\n+          .help(\"Number of flow node instances, which have been terminated.\")\n+          .labelNames(\"partition\")\n+          .register();", "originalCommit": "307589c50fc08a6e9305992881174ad3fd945f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM4MTc3OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5713#discussion_r513381779", "bodyText": "I think it makes sense to change that to labels. https://www.innoq.com/en/blog/prometheus-counters/", "author": "Zelldon", "createdAt": "2020-10-28T11:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0OTU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "ed04e6baf964966cd409fdedde574ae2e4bf9251", "chunk": "diff --git a/broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java b/broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java\nindex 837921300..6e68c2e45 100644\n--- a/broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java\n+++ b/broker/src/main/java/io/zeebe/broker/exporter/metrics/FNIMetrics.java\n\n@@ -11,27 +11,19 @@ import io.prometheus.client.Counter;\n \n public class FNIMetrics {\n \n-  private static final Counter FLOW_NODE_INSTANCE_COMPLETED =\n+  private static final Counter FLOW_NODE_INSTANCE_COUNTER =\n       Counter.build()\n           .namespace(\"zeebe\")\n-          .name(\"flow_node_instance_completed\")\n-          .help(\"Number of flow node instances, which have been completed.\")\n-          .labelNames(\"partition\")\n+          .name(\"flow_node_instance_counter\")\n+          .help(\"Count flow node instances, per partition and type (completed and terminated).\")\n+          .labelNames(\"partition\", \"type\")\n           .register();\n \n-  private static final Counter FLOW_NODE_INSTANCE_TERMINATED =\n-      Counter.build()\n-          .namespace(\"zeebe\")\n-          .name(\"flow_node_instance_terminated\")\n-          .help(\"Number of flow node instances, which have been terminated.\")\n-          .labelNames(\"partition\")\n-          .register();\n-\n-  public static void addflowNodeInstanceCompleted(final int partitionId) {\n-    FLOW_NODE_INSTANCE_COMPLETED.labels(Integer.toString(partitionId)).inc();\n+  public static void addFlowNodeInstanceCompleted(final int partitionId) {\n+    FLOW_NODE_INSTANCE_COUNTER.labels(Integer.toString(partitionId), \"completed\").inc();\n   }\n \n-  public static void addflowNodeInstanceTerminated(final int partitionId) {\n-    FLOW_NODE_INSTANCE_TERMINATED.labels(Integer.toString(partitionId)).inc();\n+  public static void addFlowNodeInstanceTerminated(final int partitionId) {\n+    FLOW_NODE_INSTANCE_COUNTER.labels(Integer.toString(partitionId), \"terminated\").inc();\n   }\n }\n"}}, {"oid": "ed04e6baf964966cd409fdedde574ae2e4bf9251", "url": "https://github.com/camunda-cloud/zeebe/commit/ed04e6baf964966cd409fdedde574ae2e4bf9251", "message": "chore(broker): add fni metrics\n\n Add flow node instance metrics to the build-in MetricExporter\n FNI's are counted for ELEMENT_COMPLETED and ELEMENT_TERMINATED.", "committedDate": "2020-10-28T13:54:02Z", "type": "commit"}, {"oid": "c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "url": "https://github.com/camunda-cloud/zeebe/commit/c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "message": "chore(monitor): add FNI metrics panel's", "committedDate": "2020-10-28T13:54:06Z", "type": "commit"}, {"oid": "c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "url": "https://github.com/camunda-cloud/zeebe/commit/c2764fe8b4d55134e6d4920d47f2c88e9018c59a", "message": "chore(monitor): add FNI metrics panel's", "committedDate": "2020-10-28T13:54:06Z", "type": "forcePushed"}]}