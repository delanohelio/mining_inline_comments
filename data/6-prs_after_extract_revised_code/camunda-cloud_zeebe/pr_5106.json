{"pr_number": 5106, "pr_title": "fix(broker): compact after exporters removed", "pr_createdAt": "2020-08-03T19:58:17Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5106", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464899869", "bodyText": "I think you can use clusteringRule.restartBroker(0); here.", "author": "korthout", "createdAt": "2020-08-04T08:50:21Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java", "diffHunk": "@@ -113,12 +114,42 @@ public void shouldNotCompactNotExportedEvents() {\n                     .isLessThan(segmentsBeforeSnapshot));\n   }\n \n-  private void fillSegments(final Broker broker, final int segmentCount) {\n+  @Test\n+  public void shouldCompactWhenExporterHasBeenRemoved() {\n+    // given\n+    final Broker broker = clusteringRule.getBroker(0);\n+    ControllableExporter.updatePosition(true);\n+    fillSegments(broker, SEGMENT_COUNT);\n+    clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n+    // create first snapshot with exporter positions\n+    final var firstSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n \n-    while (getSegmentsCount(broker) <= segmentCount) {\n-      writeToLog();\n-      writtenRecords.incrementAndGet();\n-    }\n+    // restart with no exporter\n+    final var brokerCfg = clusteringRule.getBrokerCfg(0);\n+    brokerCfg.setExporters(Map.of());\n+    clusteringRule.stopBroker(0);\n+    clusteringRule.startBroker(0);", "originalCommit": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMDU4MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464920580", "bodyText": "No I can't because It waits for a new leader, which is not possible on a single node. I tried it before with that :D", "author": "Zelldon", "createdAt": "2020-08-04T09:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMzY3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464923678", "bodyText": "Ah good point.", "author": "korthout", "createdAt": "2020-08-04T09:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5OTg2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "chunk": "diff --git a/qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java b/qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java\nindex 9ddf943b89..9f946993de 100644\n--- a/qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java\n+++ b/qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SingleBrokerDataDeletionTest.java\n\n@@ -136,7 +136,7 @@ public class SingleBrokerDataDeletionTest {\n     // when triggering new snapshot creation\n     final var segmentsCount = getSegmentsCount(broker);\n     clusteringRule.getClock().addTime(SNAPSHOT_PERIOD);\n-    final var secondSnapshot = clusteringRule.waitForSnapshotAtBroker(broker);\n+    final var secondSnapshot = clusteringRule.waitForNewSnapshotAtBroker(broker, firstSnapshot);\n \n     // then\n     assertThat(firstSnapshot).isNotEqualTo(secondSnapshot);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464911886", "bodyText": "could we close the actor sooner if we anyways know there are no exporters? or is the point of this change to do this after the state.setPosition above here at line 222?", "author": "korthout", "createdAt": "2020-08-04T09:11:10Z", "path": "broker/src/main/java/io/zeebe/broker/exporter/stream/ExporterDirector.java", "diffHunk": "@@ -227,7 +227,11 @@ private void onSnapshotRecovered() {\n \n     clearExporterState();\n \n-    actor.submit(this::readNextEvent);\n+    if (state.hasExporters()) {\n+      actor.submit(this::readNextEvent);\n+    } else {\n+      actor.close();", "originalCommit": "6bec3f7e27d77eb13f5528b14ccb1289ca13da86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyMTE0OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464921149", "bodyText": "The point is after cleaning up the state to close the actor yes. Before we haven't done it, which caused this issue. Its about line 228.", "author": "Zelldon", "createdAt": "2020-08-04T09:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNDA4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5106#discussion_r464924082", "bodyText": "Thanks for explaining", "author": "korthout", "createdAt": "2020-08-04T09:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkxMTg4Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "url": "https://github.com/camunda-cloud/zeebe/commit/6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "message": "fix(broker): compact after exporters removed", "committedDate": "2020-08-05T05:35:06Z", "type": "commit"}, {"oid": "6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "url": "https://github.com/camunda-cloud/zeebe/commit/6aeea6ae4bbe8b2c30928ea086e6b1d491220386", "message": "fix(broker): compact after exporters removed", "committedDate": "2020-08-05T05:35:06Z", "type": "forcePushed"}]}