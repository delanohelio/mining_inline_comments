{"pr_number": 4110, "pr_title": "feat(broker): add FEEL expression for job type", "pr_createdAt": "2020-03-23T11:59:54Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4110", "timeline": [{"oid": "f117b4ee8dd1cc1421a2129d9dce443e3071381b", "url": "https://github.com/camunda-cloud/zeebe/commit/f117b4ee8dd1cc1421a2129d9dce443e3071381b", "message": "chore(broker): relax criteria to identify static values", "committedDate": "2020-03-23T13:00:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNzYwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r396907601", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Expression correlationKeyExpression =\n          \n          \n            \n                    context.getExpressionLanguage().parseExpression(taskDefinition.getType());\n          \n          \n            \n            \n          \n          \n            \n                serviceTask.setType(correlationKeyExpression);\n          \n          \n            \n                final Expression jobTypeExpression =\n          \n          \n            \n                    context.getExpressionLanguage().parseExpression(taskDefinition.getType());\n          \n          \n            \n            \n          \n          \n            \n                serviceTask.setType(jobTypeExpression);", "author": "saig0", "createdAt": "2020-03-24T05:20:33Z", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/deployment/model/transformer/ServiceTaskTransformer.java", "diffHunk": "@@ -64,11 +65,16 @@ private void bindLifecycle(final ExecutableServiceTask serviceTask) {\n   }\n \n   private void transformTaskDefinition(\n-      final ServiceTask element, final ExecutableServiceTask serviceTask) {\n+      final ServiceTask element,\n+      final ExecutableServiceTask serviceTask,\n+      final TransformContext context) {\n     final ZeebeTaskDefinition taskDefinition =\n         element.getSingleExtensionElement(ZeebeTaskDefinition.class);\n \n-    serviceTask.setType(taskDefinition.getType());\n+    final Expression correlationKeyExpression =\n+        context.getExpressionLanguage().parseExpression(taskDefinition.getType());\n+\n+    serviceTask.setType(correlationKeyExpression);", "originalCommit": "f117b4ee8dd1cc1421a2129d9dce443e3071381b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/main/java/io/zeebe/engine/processor/workflow/deployment/model/transformer/ServiceTaskTransformer.java b/engine/src/main/java/io/zeebe/engine/processor/workflow/deployment/model/transformer/ServiceTaskTransformer.java\nindex 5870cdee0d..8084778872 100644\n--- a/engine/src/main/java/io/zeebe/engine/processor/workflow/deployment/model/transformer/ServiceTaskTransformer.java\n+++ b/engine/src/main/java/io/zeebe/engine/processor/workflow/deployment/model/transformer/ServiceTaskTransformer.java\n\n@@ -71,10 +71,10 @@ public final class ServiceTaskTransformer implements ModelElementTransformer<Ser\n     final ZeebeTaskDefinition taskDefinition =\n         element.getSingleExtensionElement(ZeebeTaskDefinition.class);\n \n-    final Expression correlationKeyExpression =\n+    final Expression jobTypeExpression =\n         context.getExpressionLanguage().parseExpression(taskDefinition.getType());\n \n-    serviceTask.setType(correlationKeyExpression);\n+    serviceTask.setType(jobTypeExpression);\n     serviceTask.setRetries(taskDefinition.getRetries());\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwODk5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r396908990", "bodyText": "I personally prefer ifPresent().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  final Optional<DirectBuffer> optJobType =\n          \n          \n            \n                      expressionProcessor.evaluateStringExpression(serviceTask.getType(), context);\n          \n          \n            \n            \n          \n          \n            \n                  if (optJobType.isPresent()) {\n          \n          \n            \n                    populateJobFromTask(context, value, optJobType.get(), serviceTask);\n          \n          \n            \n                    context.getCommandWriter().appendNewCommand(JobIntent.CREATE, jobCommand);\n          \n          \n            \n                  }\n          \n          \n            \n                  expressionProcessor\n          \n          \n            \n                    .evaluateStringExpression(serviceTask.getType(), context)\n          \n          \n            \n                    .ifPresent(jobType -> {\n          \n          \n            \n                      populateJobFromTask(context, value, jobType, serviceTask);\n          \n          \n            \n                      context.getCommandWriter().appendNewCommand(JobIntent.CREATE, jobCommand);\n          \n          \n            \n                    });", "author": "saig0", "createdAt": "2020-03-24T05:26:07Z", "path": "engine/src/main/java/io/zeebe/engine/processor/workflow/handlers/servicetask/ServiceTaskElementActivatedHandler.java", "diffHunk": "@@ -36,8 +41,13 @@ protected boolean handleState(final BpmnStepContext<T> context) {\n       final WorkflowInstanceRecord value = context.getValue();\n       final ExecutableServiceTask serviceTask = context.getElement();\n \n-      populateJobFromTask(context, value, serviceTask);\n-      context.getCommandWriter().appendNewCommand(JobIntent.CREATE, jobCommand);\n+      final Optional<DirectBuffer> optJobType =\n+          expressionProcessor.evaluateStringExpression(serviceTask.getType(), context);\n+\n+      if (optJobType.isPresent()) {\n+        populateJobFromTask(context, value, optJobType.get(), serviceTask);\n+        context.getCommandWriter().appendNewCommand(JobIntent.CREATE, jobCommand);\n+      }", "originalCommit": "f117b4ee8dd1cc1421a2129d9dce443e3071381b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwMDE2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397000163", "bodyText": "I see what you mean. But soon there will be two expressions 'jobType' and 'retries'. Which looks even worse. If you have a good idea how to chain two optionals, I am all ears.", "author": "pihme", "createdAt": "2020-03-24T09:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwODk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0NjM4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397046389", "bodyText": "Alright. I get your point \ud83d\udc4d", "author": "saig0", "createdAt": "2020-03-24T10:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwODk5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjEyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r396916121", "bodyText": "It might be good to check that the expression is not empty. This should be checked on validation but just to make sure...", "author": "saig0", "createdAt": "2020-03-24T05:54:05Z", "path": "expression-language/src/main/java/io/zeebe/el/impl/FeelExpressionLanguage.java", "diffHunk": "@@ -47,22 +46,12 @@ public Expression parseExpression(final String expression) {\n     ensureNotNull(\"expression\", expression);\n \n     final var expressionMatcher = EXPRESSION_PATTERN.matcher(expression);\n-    final var valueMather = STATIC_VALUE_PATTERN.matcher(expression);\n \n     if (expressionMatcher.matches()) {\n       final var unpackedExpression = expressionMatcher.group(1);\n       return parseFeelExpression(unpackedExpression);\n-\n-    } else if (valueMather.matches()) {\n-      final var value = valueMather.group();\n-      return new StaticExpression(value);\n-\n     } else {\n-      final var failureMessage =\n-          String.format(\n-              \"Expected FEEL expression (e.g. '=variableName') or static value (e.g. 'jobType') but found '%s'\",\n-              expression);\n-      return new InvalidExpression(expression, failureMessage);\n+      return new StaticExpression(expression);", "originalCommit": "f117b4ee8dd1cc1421a2129d9dce443e3071381b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwMDgwOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397000808", "bodyText": "What is wrong about an empty expression?", "author": "pihme", "createdAt": "2020-03-24T09:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0ODkzMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397048931", "bodyText": "Do you see a case where an empty expression would be valid?\nI think an empty expression indicates that the user forgot to fill something in. For example, how to deal with an empty job type.", "author": "saig0", "createdAt": "2020-03-24T10:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NTkyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397085923", "bodyText": "I don't see a case where an empty expression would be valid. I can imagine cases where maybe a value is optional and so an empty expression is benign.\nMy overall instinct is not to make any assumptions here. I think the validators are the perfect place to assess whether an empty expression can be valid. This place here could be called from anywhere.\nSpeaking of validators, right now the ZeebeExpressionValidator will accept null and empty values:\n  private void validateExpression(\n      final String expression, final ValidationResultCollector resultCollector) {\n\n    if (expression == null || expression.isEmpty()) {\n      return;\n    }\n\nIf you say, this should always be considered an invalid user input, we could change that.\nI also wonder whether long term we could have a connection between ZeebeTaskDefinitionImpl#registerType and ZeebeRuntimeValidators. I.e. maybe the runtime validators could be derived from the model constraints.\nLike I noticed in the retries issue that when I pass an empty expression, it falls back to the default value. So those two things seem somewhat related to me.", "author": "pihme", "createdAt": "2020-03-24T11:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyMDYzNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397120636", "bodyText": "Agree. The check for the empty expression was just about having a safeguard if the validation is removed for some reason. But it is not necessary.\nRegarding ZeebeExpressionValidator, I saw this too and changed it in my PR (https://github.com/zeebe-io/zeebe/pull/4079/files#diff-a00c815cabc9efbdbb0400dfc103be1aR64). It should verify that the expression is not null or empty - if there is no default value (as it is for the job retries).\nI'm open to ideas about how to improve the validation. But better in a follow-up issue.", "author": "saig0", "createdAt": "2020-03-24T12:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkxNjEyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNDczOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397124739", "bodyText": "Let's hide the expression prefix = behind the model API, as we did for the other attributes. I suggest having two methods zeebeJobTypeExpression(expression) and zeebeJobType(staticValue) - one for an expression and one for a static value.\nAdditionally, we could rename zeebeTaskType() to zeebeJobType() because it is called \"job type\" everywhere else.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .withXmlResource(workflow(t -> t.zeebeTaskType(\"=\\\"test\\\"\").zeebeTaskRetries(5)))\n          \n          \n            \n                    .withXmlResource(workflow(t -> t.zeebeJobTypeExpression(\"\\\"test\\\"\")))", "author": "saig0", "createdAt": "2020-03-24T12:46:43Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java", "diffHunk": "@@ -47,6 +47,33 @@ private static BpmnModelInstance workflow(final Consumer<ServiceTaskBuilder> con\n     return builder.endEvent().done();\n   }\n \n+  @Test\n+  public void shouldCreateJobFromServiceTaskWithJobTypeExpression() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(workflow(t -> t.zeebeTaskType(\"=\\\"test\\\"\").zeebeTaskRetries(5)))", "originalCommit": "7827c613d182650605dca5a0c5f754f787b4f485", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\nindex 7cee51c4cb..5e9217e83d 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\n\n@@ -52,20 +52,13 @@ public final class ServiceTaskTest {\n     // given\n     ENGINE\n         .deployment()\n-        .withXmlResource(workflow(t -> t.zeebeTaskType(\"=\\\"test\\\"\").zeebeTaskRetries(5)))\n+        .withXmlResource(workflow(t -> t.zeebeJobTypeExpression(\"\\\"test\\\"\").zeebeTaskRetries(5)))\n         .deploy();\n \n     // when\n     final long workflowInstanceKey = ENGINE.workflowInstance().ofBpmnProcessId(PROCESS_ID).create();\n \n     // then\n-    final Record<WorkflowInstanceRecordValue> taskActivated =\n-        RecordingExporter.workflowInstanceRecords()\n-            .withWorkflowInstanceKey(workflowInstanceKey)\n-            .withIntent(WorkflowInstanceIntent.ELEMENT_ACTIVATED)\n-            .withElementType(BpmnElementType.SERVICE_TASK)\n-            .getFirst();\n-\n     final Record<JobRecordValue> job =\n         RecordingExporter.jobRecords(JobIntent.CREATE)\n             .withWorkflowInstanceKey(workflowInstanceKey)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNTA4OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397125088", "bodyText": "Remove unused code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Record<WorkflowInstanceRecordValue> taskActivated =\n          \n          \n            \n                    RecordingExporter.workflowInstanceRecords()\n          \n          \n            \n                        .withWorkflowInstanceKey(workflowInstanceKey)\n          \n          \n            \n                        .withIntent(WorkflowInstanceIntent.ELEMENT_ACTIVATED)\n          \n          \n            \n                        .withElementType(BpmnElementType.SERVICE_TASK)\n          \n          \n            \n                        .getFirst();\n          \n          \n            \n                final Record<WorkflowInstanceRecordValue> taskActivated =\n          \n          \n            \n                    RecordingExporter.workflowInstanceRecords()\n          \n          \n            \n                        .withWorkflowInstanceKey(workflowInstanceKey)\n          \n          \n            \n                        .withIntent(WorkflowInstanceIntent.ELEMENT_ACTIVATED)\n          \n          \n            \n                        .withElementType(BpmnElementType.SERVICE_TASK)\n          \n          \n            \n                        .getFirst();", "author": "saig0", "createdAt": "2020-03-24T12:47:24Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java", "diffHunk": "@@ -47,6 +47,33 @@ private static BpmnModelInstance workflow(final Consumer<ServiceTaskBuilder> con\n     return builder.endEvent().done();\n   }\n \n+  @Test\n+  public void shouldCreateJobFromServiceTaskWithJobTypeExpression() {\n+    // given\n+    ENGINE\n+        .deployment()\n+        .withXmlResource(workflow(t -> t.zeebeTaskType(\"=\\\"test\\\"\").zeebeTaskRetries(5)))\n+        .deploy();\n+\n+    // when\n+    final long workflowInstanceKey = ENGINE.workflowInstance().ofBpmnProcessId(PROCESS_ID).create();\n+\n+    // then\n+    final Record<WorkflowInstanceRecordValue> taskActivated =\n+        RecordingExporter.workflowInstanceRecords()\n+            .withWorkflowInstanceKey(workflowInstanceKey)\n+            .withIntent(WorkflowInstanceIntent.ELEMENT_ACTIVATED)\n+            .withElementType(BpmnElementType.SERVICE_TASK)\n+            .getFirst();\n+", "originalCommit": "7827c613d182650605dca5a0c5f754f787b4f485", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\nindex 7cee51c4cb..5e9217e83d 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/activity/ServiceTaskTest.java\n\n@@ -52,20 +52,13 @@ public final class ServiceTaskTest {\n     // given\n     ENGINE\n         .deployment()\n-        .withXmlResource(workflow(t -> t.zeebeTaskType(\"=\\\"test\\\"\").zeebeTaskRetries(5)))\n+        .withXmlResource(workflow(t -> t.zeebeJobTypeExpression(\"\\\"test\\\"\").zeebeTaskRetries(5)))\n         .deploy();\n \n     // when\n     final long workflowInstanceKey = ENGINE.workflowInstance().ofBpmnProcessId(PROCESS_ID).create();\n \n     // then\n-    final Record<WorkflowInstanceRecordValue> taskActivated =\n-        RecordingExporter.workflowInstanceRecords()\n-            .withWorkflowInstanceKey(workflowInstanceKey)\n-            .withIntent(WorkflowInstanceIntent.ELEMENT_ACTIVATED)\n-            .withElementType(BpmnElementType.SERVICE_TASK)\n-            .getFirst();\n-\n     final Record<JobRecordValue> job =\n         RecordingExporter.jobRecords(JobIntent.CREATE)\n             .withWorkflowInstanceKey(workflowInstanceKey)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNjE4OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397126188", "bodyText": "It seems that you removed the test case for ZeebeLoopCharacteristics.", "author": "saig0", "createdAt": "2020-03-24T12:49:16Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "diffHunk": "@@ -149,16 +150,9 @@\n         // output element expression is not supported\n         Bpmn.createExecutableProcess(\"process\")\n             .startEvent()\n-            .serviceTask(\n-                \"task\",\n-                t ->\n-                    t.multiInstance(\n-                        m ->\n-                            m.zeebeInputCollection(\"foo\")\n-                                .zeebeOutputCollection(\"bar\")\n-                                .zeebeOutputElement(INVALID_PATH_QUERY)))\n+            .serviceTask(\"task\", t -> t.zeebeTaskType(INVALID_EXPRESSION))\n             .done(),\n-        Arrays.asList(expect(ZeebeLoopCharacteristics.class, INVALID_PATH_QUERY_MESSAGE))\n+        Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))", "originalCommit": "7827c613d182650605dca5a0c5f754f787b4f485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE0ODY4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397148682", "bodyText": "Oops", "author": "pihme", "createdAt": "2020-03-24T13:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNjE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\nindex f0f45d5d57..963453abcf 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n\n@@ -147,13 +147,28 @@ public final class ZeebeRuntimeValidationTest {\n         Arrays.asList(expect(ZeebeLoopCharacteristics.class, INVALID_PATH_QUERY_MESSAGE))\n       },\n       {\n-        // output element expression is not supported\n+        // invalid job type expression\n         Bpmn.createExecutableProcess(\"process\")\n             .startEvent()\n-            .serviceTask(\"task\", t -> t.zeebeTaskType(INVALID_EXPRESSION))\n+            .serviceTask(\"task\", t -> t.zeebeJobTypeExpression(INVALID_EXPRESSION))\n             .done(),\n         Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))\n       },\n+      {\n+        // output element expression is not supported\n+        Bpmn.createExecutableProcess(\"process\")\n+            .startEvent()\n+            .serviceTask(\n+                \"task\",\n+                t ->\n+                    t.multiInstance(\n+                        m ->\n+                            m.zeebeInputCollection(\"foo\")\n+                                .zeebeOutputCollection(\"bar\")\n+                                .zeebeOutputElement(INVALID_PATH_QUERY)))\n+            .done(),\n+        Arrays.asList(expect(ZeebeLoopCharacteristics.class, INVALID_PATH_QUERY_MESSAGE))\n+      },\n       {\n         // process id expression is not supported\n         Bpmn.createExecutableProcess(\"process\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTYzNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397129636", "bodyText": "The other incident tests verify that an incident is created and can be resolved. Incidents are created at runtime when the workflow instance is executed. In case of the job type, an incident would be created if the expression fails (e.g. no variable found), or if it evaluates not to a string.\nThis test case verifies that the validation works. This is already tested in ZeebeRuntimeValidationTest.", "author": "saig0", "createdAt": "2020-03-24T12:55:04Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/incident/ServiceTaskIncidentTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.engine.processor.workflow.incident;\n+\n+import io.zeebe.engine.util.EngineRule;\n+import io.zeebe.engine.util.client.DeploymentClient;\n+import io.zeebe.model.bpmn.Bpmn;\n+import io.zeebe.model.bpmn.BpmnModelInstance;\n+import io.zeebe.model.bpmn.builder.ServiceTaskBuilder;\n+import io.zeebe.protocol.record.Assertions;\n+import io.zeebe.protocol.record.Record;\n+import io.zeebe.protocol.record.RecordType;\n+import io.zeebe.protocol.record.RejectionType;\n+import io.zeebe.protocol.record.intent.DeploymentIntent;\n+import io.zeebe.protocol.record.value.DeploymentRecordValue;\n+import io.zeebe.test.util.record.RecordingExporter;\n+import io.zeebe.test.util.record.RecordingExporterTestWatcher;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+public class ServiceTaskIncidentTest {\n+\n+  @ClassRule public static final EngineRule ENGINE = EngineRule.singlePartition();\n+\n+  private static final String PROCESS_ID = \"process\";\n+\n+  @Rule\n+  public final RecordingExporterTestWatcher recordingExporterTestWatcher =\n+      new RecordingExporterTestWatcher();\n+\n+  private static BpmnModelInstance workflow(final Consumer<ServiceTaskBuilder> consumer) {\n+    final var builder = Bpmn.createExecutableProcess(PROCESS_ID).startEvent().serviceTask(\"task\");\n+\n+    consumer.accept(builder);\n+\n+    return builder.endEvent().done();\n+  }\n+\n+  @Test\n+  public void shouldRejectDeploymentfJobTypeExpressionCanNotBeEvaluated() {", "originalCommit": "7827c613d182650605dca5a0c5f754f787b4f485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1ODIxNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397258215", "bodyText": "done, please check again", "author": "pihme", "createdAt": "2020-03-24T15:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTYzNg=="}], "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/incident/ServiceTaskIncidentTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/incident/ServiceTaskIncidentTest.java\nindex e1a7f01ca7..16a3524606 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/incident/ServiceTaskIncidentTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/incident/ServiceTaskIncidentTest.java\n\n@@ -7,20 +7,25 @@\n  */\n package io.zeebe.engine.processor.workflow.incident;\n \n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.entry;\n+\n import io.zeebe.engine.util.EngineRule;\n-import io.zeebe.engine.util.client.DeploymentClient;\n import io.zeebe.model.bpmn.Bpmn;\n import io.zeebe.model.bpmn.BpmnModelInstance;\n import io.zeebe.model.bpmn.builder.ServiceTaskBuilder;\n import io.zeebe.protocol.record.Assertions;\n import io.zeebe.protocol.record.Record;\n-import io.zeebe.protocol.record.RecordType;\n-import io.zeebe.protocol.record.RejectionType;\n-import io.zeebe.protocol.record.intent.DeploymentIntent;\n-import io.zeebe.protocol.record.value.DeploymentRecordValue;\n+import io.zeebe.protocol.record.intent.IncidentIntent;\n+import io.zeebe.protocol.record.intent.JobIntent;\n+import io.zeebe.protocol.record.intent.WorkflowInstanceIntent;\n+import io.zeebe.protocol.record.value.BpmnElementType;\n+import io.zeebe.protocol.record.value.ErrorType;\n+import io.zeebe.protocol.record.value.IncidentRecordValue;\n+import io.zeebe.protocol.record.value.WorkflowInstanceRecordValue;\n+import io.zeebe.test.util.collection.Maps;\n import io.zeebe.test.util.record.RecordingExporter;\n import io.zeebe.test.util.record.RecordingExporterTestWatcher;\n-import java.util.Optional;\n import java.util.function.Consumer;\n import org.junit.ClassRule;\n import org.junit.Rule;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYxODE5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397618194", "bodyText": "Using the job type expression builder instead of the static one.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // output element expression is not supported\n          \n          \n            \n                    Bpmn.createExecutableProcess(\"process\")\n          \n          \n            \n                        .startEvent()\n          \n          \n            \n                        .serviceTask(\"task\", t -> t.zeebeJobType(INVALID_EXPRESSION))\n          \n          \n            \n                        .done(),\n          \n          \n            \n                    Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))\n          \n          \n            \n                    // invalid job type expression\n          \n          \n            \n                    Bpmn.createExecutableProcess(\"process\")\n          \n          \n            \n                        .startEvent()\n          \n          \n            \n                        .serviceTask(\"task\", t -> t.zeebeJobTypeExpression(INVALID_EXPRESSION))\n          \n          \n            \n                        .done(),\n          \n          \n            \n                    Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))", "author": "saig0", "createdAt": "2020-03-25T05:34:38Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "diffHunk": "@@ -145,6 +146,14 @@\n             .done(),\n         Arrays.asList(expect(ZeebeLoopCharacteristics.class, INVALID_PATH_QUERY_MESSAGE))\n       },\n+      {\n+        // output element expression is not supported\n+        Bpmn.createExecutableProcess(\"process\")\n+            .startEvent()\n+            .serviceTask(\"task\", t -> t.zeebeJobType(INVALID_EXPRESSION))\n+            .done(),\n+        Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))", "originalCommit": "e50971c5e851c59c9d5dcaf455f7aca8bdf2ae93", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\nindex 8f5ec18442..963453abcf 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n\n@@ -147,10 +147,10 @@ public final class ZeebeRuntimeValidationTest {\n         Arrays.asList(expect(ZeebeLoopCharacteristics.class, INVALID_PATH_QUERY_MESSAGE))\n       },\n       {\n-        // output element expression is not supported\n+        // invalid job type expression\n         Bpmn.createExecutableProcess(\"process\")\n             .startEvent()\n-            .serviceTask(\"task\", t -> t.zeebeJobType(INVALID_EXPRESSION))\n+            .serviceTask(\"task\", t -> t.zeebeJobTypeExpression(INVALID_EXPRESSION))\n             .done(),\n         Arrays.asList(expect(ZeebeTaskDefinition.class, INVALID_EXPRESSION_MESSAGE))\n       },\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYxODM0MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4110#discussion_r397618340", "bodyText": "The expression prefix is set by the model API builder.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String INVALID_EXPRESSION = \"=?!\";\n          \n          \n            \n              private static final String INVALID_EXPRESSION = \"?!\";", "author": "saig0", "createdAt": "2020-03-25T05:35:22Z", "path": "engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java", "diffHunk": "@@ -45,7 +46,7 @@\n   private static final String INVALID_PATH_QUERY_MESSAGE =\n       \"JSON path query is invalid: Unexpected json-path token ROOT_OBJECT\";\n \n-  private static final String INVALID_EXPRESSION = \"?!\";\n+  private static final String INVALID_EXPRESSION = \"=?!\";", "originalCommit": "e50971c5e851c59c9d5dcaf455f7aca8bdf2ae93", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62bb96a7e952228f55a506cffc36463268262e21", "chunk": "diff --git a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\nindex 8f5ec18442..963453abcf 100644\n--- a/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n+++ b/engine/src/test/java/io/zeebe/engine/processor/workflow/deployment/model/validation/ZeebeRuntimeValidationTest.java\n\n@@ -46,7 +46,7 @@ public final class ZeebeRuntimeValidationTest {\n   private static final String INVALID_PATH_QUERY_MESSAGE =\n       \"JSON path query is invalid: Unexpected json-path token ROOT_OBJECT\";\n \n-  private static final String INVALID_EXPRESSION = \"=?!\";\n+  private static final String INVALID_EXPRESSION = \"?!\";\n \n   private static final String INVALID_EXPRESSION_MESSAGE =\n       \"failed to parse expression '?!': [1.2] failure: end of input expected\\n\"\n"}}, {"oid": "62bb96a7e952228f55a506cffc36463268262e21", "url": "https://github.com/camunda-cloud/zeebe/commit/62bb96a7e952228f55a506cffc36463268262e21", "message": "feat(broker): add FEEL expression for job type", "committedDate": "2020-03-25T07:37:46Z", "type": "commit"}, {"oid": "c3b13e4ea36ffa0375e10a397aca1b3913c621eb", "url": "https://github.com/camunda-cloud/zeebe/commit/c3b13e4ea36ffa0375e10a397aca1b3913c621eb", "message": "chore(broker): rename 'zeebeTaskType' to 'zeebeJobType'", "committedDate": "2020-03-25T07:38:46Z", "type": "commit"}, {"oid": "c3b13e4ea36ffa0375e10a397aca1b3913c621eb", "url": "https://github.com/camunda-cloud/zeebe/commit/c3b13e4ea36ffa0375e10a397aca1b3913c621eb", "message": "chore(broker): rename 'zeebeTaskType' to 'zeebeJobType'", "committedDate": "2020-03-25T07:38:46Z", "type": "forcePushed"}]}