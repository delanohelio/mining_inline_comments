{"pr_number": 4660, "pr_title": "chore(gateway): add flag to enable/disable long polling", "pr_createdAt": "2020-06-03T14:16:20Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4660", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkxNDIzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4660#discussion_r437914235", "bodyText": "Please remove this todo.", "author": "deepthidevaki", "createdAt": "2020-06-10T07:28:29Z", "path": "gateway/src/main/java/io/zeebe/gateway/impl/job/ActivateJobsHandlerImpl.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.impl.job;\n+\n+import io.grpc.Status.Code;\n+import io.grpc.StatusRuntimeException;\n+import io.grpc.stub.StreamObserver;\n+import io.zeebe.gateway.EndpointManager;\n+import io.zeebe.gateway.Loggers;\n+import io.zeebe.gateway.RequestMapper;\n+import io.zeebe.gateway.ResponseMapper;\n+import io.zeebe.gateway.impl.broker.BrokerClient;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterState;\n+import io.zeebe.gateway.impl.broker.request.BrokerActivateJobsRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.ActivateJobsRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.ActivateJobsResponse;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+// todo(@korthout): improve name", "originalCommit": "ce291433c1d819424eebc7154209147663209c07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkxNTIzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4660#discussion_r437915235", "bodyText": "Suggested name RoundRobinActivateJobsHandler. Also can you add a short description for this class?", "author": "deepthidevaki", "createdAt": "2020-06-10T07:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkxNDIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "fb34419191698dd918db34d3eed714296f2b235b", "chunk": "diff --git a/gateway/src/main/java/io/zeebe/gateway/impl/job/ActivateJobsHandlerImpl.java b/gateway/src/main/java/io/zeebe/gateway/impl/job/RoundRobinActivateJobsHandler.java\nsimilarity index 63%\nrename from gateway/src/main/java/io/zeebe/gateway/impl/job/ActivateJobsHandlerImpl.java\nrename to gateway/src/main/java/io/zeebe/gateway/impl/job/RoundRobinActivateJobsHandler.java\nindex 690f050f66..befcb7fecc 100644\n--- a/gateway/src/main/java/io/zeebe/gateway/impl/job/ActivateJobsHandlerImpl.java\n+++ b/gateway/src/main/java/io/zeebe/gateway/impl/job/RoundRobinActivateJobsHandler.java\n\n@@ -15,22 +15,32 @@ import io.zeebe.gateway.Loggers;\n import io.zeebe.gateway.RequestMapper;\n import io.zeebe.gateway.ResponseMapper;\n import io.zeebe.gateway.impl.broker.BrokerClient;\n+import io.zeebe.gateway.impl.broker.PartitionIdIterator;\n+import io.zeebe.gateway.impl.broker.RequestDispatchStrategy;\n+import io.zeebe.gateway.impl.broker.RoundRobinDispatchStrategy;\n import io.zeebe.gateway.impl.broker.cluster.BrokerClusterState;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerTopologyManager;\n import io.zeebe.gateway.impl.broker.request.BrokerActivateJobsRequest;\n import io.zeebe.gateway.protocol.GatewayOuterClass.ActivateJobsRequest;\n import io.zeebe.gateway.protocol.GatewayOuterClass.ActivateJobsResponse;\n-import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n import java.util.function.Consumer;\n \n-// todo(@korthout): improve name\n-public final class ActivateJobsHandlerImpl implements ActivateJobsHandler {\n+/**\n+ * Iterates in round-robin fashion over partitions to activate jobs. Uses a map from job type to\n+ * partition-IDs to determine the next partition to use.\n+ */\n+public final class RoundRobinActivateJobsHandler implements ActivateJobsHandler {\n \n-  private final Map<String, Integer> jobTypeToNextPartitionId = new HashMap<>();\n+  private final Map<String, RequestDispatchStrategy> jobTypeToNextPartitionId =\n+      new ConcurrentHashMap<>();\n   private final BrokerClient brokerClient;\n+  private final BrokerTopologyManager topologyManager;\n \n-  public ActivateJobsHandlerImpl(final BrokerClient brokerClient) {\n+  public RoundRobinActivateJobsHandler(final BrokerClient brokerClient) {\n     this.brokerClient = brokerClient;\n+    this.topologyManager = brokerClient.getTopologyManager();\n   }\n \n   @Override\n"}}, {"oid": "fb34419191698dd918db34d3eed714296f2b235b", "url": "https://github.com/camunda-cloud/zeebe/commit/fb34419191698dd918db34d3eed714296f2b235b", "message": "chore(gateway): add flag to enable/disable long polling\n\nThis is a combination of 7 commits (incl the 1 above):\n\nchore(gateway): enable long polling by default\n\nchore(gateway): improve longpolling flag name\n\nchore(gateway): test activate jobs with/without long polling\n\nchore(gateway): clarify naming and add documentation\n\nchore(gateway): add defaults to config templates\n\ntest(gateway): add IT to test job activation without long polling\n\nIn order to test for this, we need to set\nzeebe.broker.gateway.longPolling.enabled to false. This configuration\ncan only be changed at start-up of the broker and so this could not be\ntested in the same class as ActivateJobsTest, which was testing\nactivatejobs behavior for the default long polling enabled.\n\nSince a LongPollingDisabledActivateJobsTest seemed like a strange test,\nI've renamed ActivateJobsTest to LongPollingActivateJobsTest and created\na new ActivateJobsTest that tests it with long polling explicitly\ndisabled.", "committedDate": "2020-06-15T11:36:01Z", "type": "commit"}, {"oid": "fb34419191698dd918db34d3eed714296f2b235b", "url": "https://github.com/camunda-cloud/zeebe/commit/fb34419191698dd918db34d3eed714296f2b235b", "message": "chore(gateway): add flag to enable/disable long polling\n\nThis is a combination of 7 commits (incl the 1 above):\n\nchore(gateway): enable long polling by default\n\nchore(gateway): improve longpolling flag name\n\nchore(gateway): test activate jobs with/without long polling\n\nchore(gateway): clarify naming and add documentation\n\nchore(gateway): add defaults to config templates\n\ntest(gateway): add IT to test job activation without long polling\n\nIn order to test for this, we need to set\nzeebe.broker.gateway.longPolling.enabled to false. This configuration\ncan only be changed at start-up of the broker and so this could not be\ntested in the same class as ActivateJobsTest, which was testing\nactivatejobs behavior for the default long polling enabled.\n\nSince a LongPollingDisabledActivateJobsTest seemed like a strange test,\nI've renamed ActivateJobsTest to LongPollingActivateJobsTest and created\na new ActivateJobsTest that tests it with long polling explicitly\ndisabled.", "committedDate": "2020-06-15T11:36:01Z", "type": "forcePushed"}]}