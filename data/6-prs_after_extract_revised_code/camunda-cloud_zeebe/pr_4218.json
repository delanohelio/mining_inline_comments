{"pr_number": 4218, "pr_title": "chore(atomix): reset readers when writer truncates", "pr_createdAt": "2020-04-02T15:20:46Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4218", "timeline": [{"oid": "bc586164913416758cd3137f784a7e3a32313968", "url": "https://github.com/camunda-cloud/zeebe/commit/bc586164913416758cd3137f784a7e3a32313968", "message": "chore(atomix): reset readers when writer truncates", "committedDate": "2020-04-02T15:15:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzNzY3Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4218#discussion_r402837672", "bodyText": "this could be really problematic", "author": "Zelldon", "createdAt": "2020-04-03T08:36:59Z", "path": "atomix/storage/src/main/java/io/atomix/storage/journal/SegmentedJournal.java", "diffHunk": "@@ -602,6 +602,9 @@ void resetTail(final long index) {\n     for (final SegmentedJournalReader reader : readers) {\n       if (reader.getNextIndex() >= index) {\n         reader.reset(index);\n+      } else {\n+        // This is not thread safe https://github.com/zeebe-io/zeebe/issues/4198\n+        reader.reset(reader.getNextIndex());", "originalCommit": "bc586164913416758cd3137f784a7e3a32313968", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzODIyMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4218#discussion_r402838220", "bodyText": "When we call this? Truncate? this is called only be followers right? then it might be more okaisch", "author": "Zelldon", "createdAt": "2020-04-03T08:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzNzY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzOTQ2OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4218#discussion_r402839468", "bodyText": "Yes. Truncate is only called by followers. In another PR, we already moved ZeebeRaftStateMachine to use raft context because of this thread-safe issue.", "author": "deepthidevaki", "createdAt": "2020-04-03T08:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzNzY3Mg=="}], "type": "inlineReview", "revised_code": null}]}