{"pr_number": 5260, "pr_title": "Add flag to disable disk usage watermarks", "pr_createdAt": "2020-08-28T14:42:23Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5260", "timeline": [{"oid": "660008d34b37b3a87634acb0126f83741a02ce42", "url": "https://github.com/camunda-cloud/zeebe/commit/660008d34b37b3a87634acb0126f83741a02ce42", "message": "chore(broker): add flag to disable disk usage watermarks\n\nOn disabling watermarks for disk usage the watermarks are set to 1,\nmeaning the whole diskspace can be used.", "committedDate": "2020-08-31T07:15:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4NzY2MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5260#discussion_r480087661", "bodyText": "I recommend to name it diskUsageMonitoringEnabled.", "author": "deepthidevaki", "createdAt": "2020-08-31T12:11:12Z", "path": "broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java", "diffHunk": "@@ -34,13 +42,21 @@\n   private int logIndexDensity = 100;\n \n   private boolean useMmap = false;\n+  private boolean diskUsageWatermarkEnabled = DEFAULT_DISK_USAGE_WATERMARK_ENABLED;", "originalCommit": "660008d34b37b3a87634acb0126f83741a02ce42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eec1338fd59d8e2c5b688e27954d50905cd27558", "chunk": "diff --git a/broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java b/broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java\nindex d1341d8b9..2901d77fd 100644\n--- a/broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java\n+++ b/broker/src/main/java/io/zeebe/broker/system/configuration/DataCfg.java\n\n@@ -42,7 +42,7 @@ public final class DataCfg implements ConfigurationEntry {\n   private int logIndexDensity = 100;\n \n   private boolean useMmap = false;\n-  private boolean diskUsageWatermarkEnabled = DEFAULT_DISK_USAGE_WATERMARK_ENABLED;\n+  private boolean diskUsageMonitoringEnabled = DEFAULT_DISK_USAGE_MONITOR_ENABLED;\n   private double diskUsageReplicationWatermark = DEFAULT_DISK_USAGE_REPLICATION_WATERMARK;\n   private double diskUsageCommandWatermark = DEFAULT_DISK_USAGE_COMMAND_WATERMARK;\n   private Duration diskUsageMonitoringInterval = DEFAULT_DISK_USAGE_MONITORING_DELAY;\n"}}, {"oid": "eec1338fd59d8e2c5b688e27954d50905cd27558", "url": "https://github.com/camunda-cloud/zeebe/commit/eec1338fd59d8e2c5b688e27954d50905cd27558", "message": "chore(broker): skip scheduling of disk space monitor actor", "committedDate": "2020-08-31T15:24:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkyMzkxMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5260#discussion_r480923910", "bodyText": "We can also skip this step when monitoring is disabled.", "author": "deepthidevaki", "createdAt": "2020-09-01T07:35:44Z", "path": "broker/src/main/java/io/zeebe/broker/Broker.java", "diffHunk": "@@ -292,9 +292,14 @@ private AutoCloseable monitoringServerStep(final BrokerInfo localBroker) {\n \n   private AutoCloseable diskSpaceMonitorStep(final DataCfg data) {\n     diskSpaceUsageMonitor = new DiskSpaceUsageMonitor(data);\n-    scheduleActor(diskSpaceUsageMonitor);\n+    final boolean diskUsageMonitoringEnabled = data.isDiskUsageMonitoringEnabled();\n+    if (diskUsageMonitoringEnabled) {\n+      scheduleActor(diskSpaceUsageMonitor);\n+    } else {\n+      LOG.info(\"Skipping start of disk space usage monitor, as it is disabled by configuration\");\n+    }\n     diskSpaceUsageListeners.forEach(l -> diskSpaceUsageMonitor.addDiskUsageListener(l));", "originalCommit": "eec1338fd59d8e2c5b688e27954d50905cd27558", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d556eaac656ba53bdd8984097047217966a1ab1", "chunk": "diff --git a/broker/src/main/java/io/zeebe/broker/Broker.java b/broker/src/main/java/io/zeebe/broker/Broker.java\nindex 0ada31385..69a2a16fa 100644\n--- a/broker/src/main/java/io/zeebe/broker/Broker.java\n+++ b/broker/src/main/java/io/zeebe/broker/Broker.java\n\n@@ -292,14 +292,9 @@ public final class Broker implements AutoCloseable {\n \n   private AutoCloseable diskSpaceMonitorStep(final DataCfg data) {\n     diskSpaceUsageMonitor = new DiskSpaceUsageMonitor(data);\n-    final boolean diskUsageMonitoringEnabled = data.isDiskUsageMonitoringEnabled();\n-    if (diskUsageMonitoringEnabled) {\n-      scheduleActor(diskSpaceUsageMonitor);\n-    } else {\n-      LOG.info(\"Skipping start of disk space usage monitor, as it is disabled by configuration\");\n-    }\n+    scheduleActor(diskSpaceUsageMonitor);\n     diskSpaceUsageListeners.forEach(l -> diskSpaceUsageMonitor.addDiskUsageListener(l));\n-    return diskUsageMonitoringEnabled ? () -> diskSpaceUsageMonitor.close() : () -> {};\n+    return () -> diskSpaceUsageMonitor.close();\n   }\n \n   private AutoCloseable managementRequestStep(final BrokerInfo localBroker) {\n"}}, {"oid": "6d556eaac656ba53bdd8984097047217966a1ab1", "url": "https://github.com/camunda-cloud/zeebe/commit/6d556eaac656ba53bdd8984097047217966a1ab1", "message": "chore(broker): add flag to disable disk usage watermarks\n\nOn disabling watermarks for disk usage the watermarks are set to 1,\nmeaning the whole diskspace can be used.", "committedDate": "2020-09-01T08:39:58Z", "type": "commit"}, {"oid": "e6b5dbca4e38a0513c17f713c3d63df0f64f2889", "url": "https://github.com/camunda-cloud/zeebe/commit/e6b5dbca4e38a0513c17f713c3d63df0f64f2889", "message": "chore(broker): skip scheduling of disk space monitor actor", "committedDate": "2020-09-01T08:46:24Z", "type": "commit"}, {"oid": "53ecbb0e0246d788633e4327514d34ffa805199f", "url": "https://github.com/camunda-cloud/zeebe/commit/53ecbb0e0246d788633e4327514d34ffa805199f", "message": "chore(dist): update config files", "committedDate": "2020-09-01T08:46:39Z", "type": "commit"}, {"oid": "53ecbb0e0246d788633e4327514d34ffa805199f", "url": "https://github.com/camunda-cloud/zeebe/commit/53ecbb0e0246d788633e4327514d34ffa805199f", "message": "chore(dist): update config files", "committedDate": "2020-09-01T08:46:39Z", "type": "forcePushed"}, {"oid": "7be5c8efe616bbed7a627256d9354f6202e8f461", "url": "https://github.com/camunda-cloud/zeebe/commit/7be5c8efe616bbed7a627256d9354f6202e8f461", "message": "docs(operations): add diskUsageMonitoringEnabled flag to documentation", "committedDate": "2020-09-01T08:56:17Z", "type": "commit"}]}