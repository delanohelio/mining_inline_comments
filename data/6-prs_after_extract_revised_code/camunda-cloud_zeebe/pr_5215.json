{"pr_number": 5215, "pr_title": "[Backport 0.23] Replicate snapshot faster", "pr_createdAt": "2020-08-20T13:47:21Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5215", "timeline": [{"oid": "553c70ff76d7f442737cde805d54b127cf09426e", "url": "https://github.com/camunda-cloud/zeebe/commit/553c70ff76d7f442737cde805d54b127cf09426e", "message": "fix(atomix): donot build snapshot reader for each install request", "committedDate": "2020-08-20T09:42:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNzczMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5215#discussion_r474007731", "bodyText": "I removed this synchronized. I think it is not required. What do you think? @Zelldon", "author": "deepthidevaki", "createdAt": "2020-08-20T14:02:50Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/roles/AbstractAppender.java", "diffHunk": "@@ -447,45 +449,63 @@ protected void handleConfigureResponseError(\n     // This prevents infinite loops when cluster configurations fail.\n   }\n \n-  /** Builds an install request for the given member. */\n-  protected InstallRequest buildInstallRequest(\n+  /**\n+   * Builds an install request for the given member.\n+   *\n+   * @return\n+   */\n+  protected Optional<InstallRequest> buildInstallRequest(\n       final RaftMemberContext member, final Snapshot snapshot) {\n     if (member.getNextSnapshotIndex() != snapshot.index()) {\n+      try {\n+        final SnapshotChunkReader snapshotChunkReader = snapshot.newChunkReader();\n+        member.setSnapshotChunkReader(snapshotChunkReader);\n+      } catch (final UncheckedIOException e) {\n+        log.warn(\n+            \"Expected to send Snapshot {} to {}. But could not open SnapshotChunkReader. Will retry.\",\n+            snapshot.getPath(),\n+            e);\n+        return Optional.empty();\n+      }\n       member.setNextSnapshotIndex(snapshot.index());\n       member.setNextSnapshotChunk(null);\n     }\n \n     final InstallRequest request;\n-    synchronized (snapshot) {", "originalCommit": "553c70ff76d7f442737cde805d54b127cf09426e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwODE4Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5215#discussion_r474008183", "bodyText": "I think the same, since we having only one thread.", "author": "Zelldon", "createdAt": "2020-08-20T14:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNzczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwODUxMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5215#discussion_r474008510", "bodyText": "\ud83d\udc4d", "author": "deepthidevaki", "createdAt": "2020-08-20T14:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNzczMQ=="}], "type": "inlineReview", "revised_code": null}]}