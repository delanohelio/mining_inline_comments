{"pr_number": 5096, "pr_title": "Remove ZeebeRaftStateMachine", "pr_createdAt": "2020-08-03T07:51:07Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5096", "timeline": [{"oid": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "url": "https://github.com/camunda-cloud/zeebe/commit/de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "message": "chore(logstreams): rename", "committedDate": "2020-08-03T07:52:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0OTA3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464849077", "bodyText": "lastApplied the last applied index and the last applied term\nNot really right? \ud83d\ude05\n\nThis method is only for the joining right? After it is ready it is successful joined?", "author": "Zelldon", "createdAt": "2020-08-04T07:18:52Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java", "diffHunk": "@@ -758,12 +733,16 @@ public long getLastApplied() {\n   }\n \n   /**\n-   * Returns the term of the last applied entry.\n+   * Sets the last applied index.\n    *\n-   * @return the last applied index\n+   * @param lastApplied the last applied index and the last applied term", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0OTQ2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464849465", "bodyText": "Could we just move this to the commit method? and remove this property?", "author": "Zelldon", "createdAt": "2020-08-04T07:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0OTA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\nindex f0b9c76452..8c30e1e625 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n\n@@ -733,16 +758,12 @@ public class RaftContext implements AutoCloseable {\n   }\n \n   /**\n-   * Sets the last applied index.\n+   * Returns the term of the last applied entry.\n    *\n-   * @param lastApplied the last applied index and the last applied term\n+   * @return the last applied index\n    */\n-  private void setLastApplied(final long lastApplied) {\n-    this.lastApplied = Math.max(this.lastApplied, lastApplied);\n-    if (state == State.ACTIVE && lastApplied >= firstCommitIndex) {\n-      state = State.READY;\n-      stateChangeListeners.forEach(l -> l.accept(state));\n-    }\n+  public long getLastAppliedTerm() {\n+    return lastAppliedTerm;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2MDQyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464860423", "bodyText": "Will this break compatibility? Because I think this configs are serialized?", "author": "Zelldon", "createdAt": "2020-08-04T07:41:24Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java", "diffHunk": "@@ -39,39 +37,10 @@\n   private Duration electionTimeout = DEFAULT_ELECTION_TIMEOUT;\n   private Duration heartbeatInterval = DEFAULT_HEARTBEAT_INTERVAL;\n   private RaftStorageConfig storageConfig = new RaftStorageConfig();\n-  private RaftCompactionConfig compactionConfig = new RaftCompactionConfig();", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMTA3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465511078", "bodyText": "As far as I know this was used by the PartitionManagementGroupService, which sends the configurations to other nodes. But we removed it. So now I don't find any place where this config is persisted or used for communication with other nodes. Also our upgradability test and rolling update tests passed. Do you have any other suggestions on how to test that this does not break compatability?", "author": "deepthidevaki", "createdAt": "2020-08-05T06:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2MDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzODQ2Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466838467", "bodyText": "Ok thanks. Was not sure where this is done to be honest.", "author": "Zelldon", "createdAt": "2020-08-07T06:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2MDQyMw=="}], "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java b/atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java\nindex a715c67554..2977728e40 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java\n\n@@ -37,10 +39,39 @@ public class RaftPartitionGroupConfig extends PartitionGroupConfig<RaftPartition\n   private Duration electionTimeout = DEFAULT_ELECTION_TIMEOUT;\n   private Duration heartbeatInterval = DEFAULT_HEARTBEAT_INTERVAL;\n   private RaftStorageConfig storageConfig = new RaftStorageConfig();\n+  private RaftCompactionConfig compactionConfig = new RaftCompactionConfig();\n \n   @Optional(\"EntryValidator\")\n   private EntryValidator entryValidator = new NoopEntryValidator();\n \n+  // IMPORTANT: do not remove the Optional annotation, as the config is serialized through Kryo and\n+  // definitely does NOT know how to serialize random interfaces; a serialized configuration is used\n+  // by a node when bootstrapping itself if it receives a partition group from a remote node that it\n+  // was not aware of. The annotation tells Kryo to ignore this field unless a specific serializer\n+  // is configured for the given key\n+  @Optional(\"RaftStateMachineFactory\")\n+  private RaftStateMachineFactory stateMachineFactory = ZeebeRaftStateMachine::new;\n+\n+  /**\n+   * Returns the compaction configuration.\n+   *\n+   * @return the compaction configuration\n+   */\n+  public RaftCompactionConfig getCompactionConfig() {\n+    return compactionConfig;\n+  }\n+\n+  /**\n+   * Sets the compaction configuration.\n+   *\n+   * @param compactionConfig the compaction configuration\n+   * @return the Raft partition group configuration\n+   */\n+  public RaftPartitionGroupConfig setCompactionConfig(final RaftCompactionConfig compactionConfig) {\n+    this.compactionConfig = compactionConfig;\n+    return this;\n+  }\n+\n   @Override\n   protected int getDefaultPartitions() {\n     return DEFAULT_PARTITIONS;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2NjU0MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464866541", "bodyText": "Something we should do here? The last applied is now the last commit index right?", "author": "Zelldon", "createdAt": "2020-08-04T07:52:40Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java", "diffHunk": "@@ -145,6 +145,7 @@ private void addSnapshotListener() {\n     // If the index has already been applied, we have enough state to populate the state machine up\n     // to this index.\n     // Skip the snapshot and response successfully.\n+    // TODO: Does the following condition make sense?", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java b/atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java\nindex 2418d0ac9b..accce14c94 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/roles/PassiveRole.java\n\n@@ -145,7 +145,6 @@ public class PassiveRole extends InactiveRole {\n     // If the index has already been applied, we have enough state to populate the state machine up\n     // to this index.\n     // Skip the snapshot and response successfully.\n-    // TODO: Does the following condition make sense?\n     if (raft.getLastApplied() > request.index()) {\n       return CompletableFuture.completedFuture(\n           logResponse(InstallResponse.builder().withStatus(RaftResponse.Status.OK).build()));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2ODkyMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464868922", "bodyText": "where is this moved?", "author": "Zelldon", "createdAt": "2020-08-04T07:56:42Z", "path": "broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java", "diffHunk": "@@ -654,21 +646,6 @@ private void stepByStepClosing(\n             });\n   }\n \n-  @Override\n-  public <T extends RaftLogEntry> void onCommit(final Indexed<T> indexed) {", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI4OTg0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466289842", "bodyText": "This is removed. This was used only to set the logstream commit position. It is now done by the LogStorageAppender. Downside of this approach is that followers cannot update commit position, which is not required now.", "author": "deepthidevaki", "createdAt": "2020-08-06T09:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2ODkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java b/broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java\nindex 88ff594062..fcb57d85c3 100644\n--- a/broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java\n+++ b/broker/src/main/java/io/zeebe/broker/system/partitions/ZeebePartition.java\n\n@@ -615,37 +595,6 @@ public final class ZeebePartition extends Actor\n     return CompletableActorFuture.completed(null);\n   }\n \n-  private void stepByStepClosing(\n-      final CompletableActorFuture<Void> closingFuture, final List<ClosingStep> actorsToClose) {\n-    if (actorsToClose.isEmpty()) {\n-      closingFuture.complete(null);\n-      return;\n-    }\n-\n-    final ClosingStep closingStep = actorsToClose.remove(0);\n-    LOG.debug(\"Closing Zeebe-Partition-{}: {}\", partitionId, closingStep.getName());\n-    closingStep\n-        .getClosable()\n-        .closeAsync()\n-        .onComplete(\n-            (v, t) -> {\n-              if (t == null) {\n-                LOG.debug(\n-                    \"Closing Zeebe-Partition-{}: {} closed successfully\",\n-                    partitionId,\n-                    closingStep.getName());\n-                stepByStepClosing(closingFuture, actorsToClose);\n-              } else {\n-                LOG.error(\n-                    \"Closing Zeebe-Partition-{}: {} failed to close\",\n-                    partitionId,\n-                    closingStep.getName(),\n-                    t);\n-                closingFuture.completeExceptionally(t);\n-              }\n-            });\n-  }\n-\n   @Override\n   public String getName() {\n     return actorName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2OTYyNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r464869627", "bodyText": "Could you move this please to the onCommit, since it is unrelated to releaseBackpressure", "author": "Zelldon", "createdAt": "2020-08-04T07:57:54Z", "path": "logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java", "diffHunk": "@@ -50,5 +50,6 @@ public void onCommitError(final long address, final Throwable error) {\n \n   private void releaseBackPressure() {\n     appender.releaseBackPressure(highestPosition);\n+    appender.notifyCommitPosition(highestPosition);", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java b/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\nindex a45d259199..a060d8d67d 100644\n--- a/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\n+++ b/logstreams/src/main/java/io/zeebe/logstreams/impl/log/Listener.java\n\n@@ -50,6 +51,5 @@ public final class Listener implements AppendListener {\n \n   private void releaseBackPressure() {\n     appender.releaseBackPressure(highestPosition);\n-    appender.notifyCommitPosition(highestPosition);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNjEyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465006126", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param latestEntry latest committed entry\n          \n          \n            \n               * @param lastCommitIndex index of the most recently committed entry", "author": "MiguelPires", "createdAt": "2020-08-04T12:15:36Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java", "diffHunk": "@@ -338,8 +331,8 @@ public void removeCommitListener(final RaftCommitListener commitListener) {\n    *\n    * @param latestEntry latest committed entry", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\nindex f0b9c76452..8c30e1e625 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n\n@@ -331,8 +338,8 @@ public class RaftContext implements AutoCloseable {\n    *\n    * @param latestEntry latest committed entry\n    */\n-  public void notifyCommitListeners(final long lastCommitIndex) {\n-    commitListeners.forEach(listener -> listener.onCommit(lastCommitIndex));\n+  public <T extends RaftLogEntry> void notifyCommitListeners(final Indexed<T> latestEntry) {\n+    commitListeners.forEach(listener -> listener.onCommit(latestEntry));\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNjQ4MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465006480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @return The server state machine.\n          \n          \n            \n               * @return The log compactor.", "author": "MiguelPires", "createdAt": "2020-08-04T12:16:20Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java", "diffHunk": "@@ -886,8 +865,8 @@ public RaftRoleMetrics getRaftRoleMetrics() {\n    *\n    * @return The server state machine.", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\nindex f0b9c76452..8c30e1e625 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n\n@@ -865,8 +886,8 @@ public class RaftContext implements AutoCloseable {\n    *\n    * @return The server state machine.\n    */\n-  public LogCompactor getLogCompactor() {\n-    return logCompactor;\n+  public RaftStateMachine getServiceManager() {\n+    return stateMachine;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAxMDY2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465010664", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                logger.debug(\"Closing state machine {}\", raft.getName());\n          \n          \n            \n                logger.debug(\"Closing the log compactor {}\", raft.getName());", "author": "MiguelPires", "createdAt": "2020-08-04T12:24:16Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.atomix.raft.impl.zeebe;\n+\n+import io.atomix.raft.impl.RaftContext;\n+import io.atomix.raft.metrics.RaftServiceMetrics;\n+import io.atomix.raft.storage.log.RaftLogReader;\n+import io.atomix.utils.concurrent.ThreadContext;\n+import io.atomix.utils.logging.ContextualLoggerFactory;\n+import io.atomix.utils.logging.LoggerContext;\n+import java.util.concurrent.CompletableFuture;\n+import org.slf4j.Logger;\n+\n+public final class LogCompactor {\n+  private final RaftContext raft;\n+\n+  // hard coupled state\n+  private final RaftLogReader reader;\n+  private final Logger logger;\n+  private final RaftServiceMetrics metrics;\n+\n+  // used when performing compaction; may be updated from a different thread\n+  private volatile long compactableIndex;\n+\n+  public LogCompactor(final RaftContext raft) {\n+    this.raft = raft;\n+    this.reader = raft.getLog().openReader(1, RaftLogReader.Mode.COMMITS);\n+\n+    this.logger =\n+        ContextualLoggerFactory.getLogger(\n+            getClass(), LoggerContext.builder(getClass()).addValue(raft.getName()).build());\n+    this.metrics = new RaftServiceMetrics(raft.getName());\n+  }\n+\n+  public ThreadContext executor() {\n+    return raft.getThreadContext();\n+  }\n+\n+  /**\n+   * Assumes our snapshots are being taken asynchronously and we regularly update the compactable\n+   * index. Compaction is performed asynchronously.\n+   *\n+   * @return a future which is completed when the log has been compacted\n+   */\n+  public CompletableFuture<Void> compact() {\n+    raft.checkThread();\n+\n+    final var log = raft.getLog();\n+    if (log.isCompactable(compactableIndex)) {\n+      final var index = log.getCompactableIndex(compactableIndex);\n+      final var future = new CompletableFuture<Void>();\n+      logger.debug(\"Compacting log up from {} up to {}\", reader.getFirstIndex(), index);\n+      compact(index, future);\n+      return future;\n+    } else {\n+      logger.debug(\n+          \"Skipping compaction of non-compactable index {} (first log index: {})\",\n+          compactableIndex,\n+          reader.getFirstIndex());\n+    }\n+\n+    return CompletableFuture.completedFuture(null);\n+  }\n+\n+  public void close() {\n+    raft.checkThread();\n+    logger.debug(\"Closing state machine {}\", raft.getName());", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java\ndeleted file mode 100644\nindex 35adf8cb78..0000000000\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java\n+++ /dev/null\n\n@@ -1,95 +0,0 @@\n-/*\n- * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n- * one or more contributor license agreements. See the NOTICE file distributed\n- * with this work for additional information regarding copyright ownership.\n- * Licensed under the Zeebe Community License 1.0. You may not use this file\n- * except in compliance with the Zeebe Community License 1.0.\n- */\n-package io.atomix.raft.impl.zeebe;\n-\n-import io.atomix.raft.impl.RaftContext;\n-import io.atomix.raft.metrics.RaftServiceMetrics;\n-import io.atomix.raft.storage.log.RaftLogReader;\n-import io.atomix.utils.concurrent.ThreadContext;\n-import io.atomix.utils.logging.ContextualLoggerFactory;\n-import io.atomix.utils.logging.LoggerContext;\n-import java.util.concurrent.CompletableFuture;\n-import org.slf4j.Logger;\n-\n-public final class LogCompactor {\n-  private final RaftContext raft;\n-\n-  // hard coupled state\n-  private final RaftLogReader reader;\n-  private final Logger logger;\n-  private final RaftServiceMetrics metrics;\n-\n-  // used when performing compaction; may be updated from a different thread\n-  private volatile long compactableIndex;\n-\n-  public LogCompactor(final RaftContext raft) {\n-    this.raft = raft;\n-    this.reader = raft.getLog().openReader(1, RaftLogReader.Mode.COMMITS);\n-\n-    this.logger =\n-        ContextualLoggerFactory.getLogger(\n-            getClass(), LoggerContext.builder(getClass()).addValue(raft.getName()).build());\n-    this.metrics = new RaftServiceMetrics(raft.getName());\n-  }\n-\n-  public ThreadContext executor() {\n-    return raft.getThreadContext();\n-  }\n-\n-  /**\n-   * Assumes our snapshots are being taken asynchronously and we regularly update the compactable\n-   * index. Compaction is performed asynchronously.\n-   *\n-   * @return a future which is completed when the log has been compacted\n-   */\n-  public CompletableFuture<Void> compact() {\n-    raft.checkThread();\n-\n-    final var log = raft.getLog();\n-    if (log.isCompactable(compactableIndex)) {\n-      final var index = log.getCompactableIndex(compactableIndex);\n-      final var future = new CompletableFuture<Void>();\n-      logger.debug(\"Compacting log up from {} up to {}\", reader.getFirstIndex(), index);\n-      compact(index, future);\n-      return future;\n-    } else {\n-      logger.debug(\n-          \"Skipping compaction of non-compactable index {} (first log index: {})\",\n-          compactableIndex,\n-          reader.getFirstIndex());\n-    }\n-\n-    return CompletableFuture.completedFuture(null);\n-  }\n-\n-  public void close() {\n-    raft.checkThread();\n-    logger.debug(\"Closing state machine {}\", raft.getName());\n-    reader.close();\n-  }\n-\n-  public long getCompactableIndex() {\n-    return compactableIndex;\n-  }\n-\n-  public void setCompactableIndex(final long index) {\n-    this.compactableIndex = index;\n-  }\n-\n-  private void compact(final long index, final CompletableFuture<Void> future) {\n-    try {\n-      final var startTime = System.currentTimeMillis();\n-      raft.getLog().compact(index);\n-      metrics.compactionTime(System.currentTimeMillis() - startTime);\n-      future.complete(null);\n-    } catch (final Exception e) {\n-      logger.error(\"Failed to compact up to index {}\", index, e);\n-      future.completeExceptionally(e);\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAxMTY5OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465011698", "bodyText": "I think this is never used", "author": "MiguelPires", "createdAt": "2020-08-04T12:26:02Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.atomix.raft.impl.zeebe;\n+\n+import io.atomix.raft.impl.RaftContext;\n+import io.atomix.raft.metrics.RaftServiceMetrics;\n+import io.atomix.raft.storage.log.RaftLogReader;\n+import io.atomix.utils.concurrent.ThreadContext;\n+import io.atomix.utils.logging.ContextualLoggerFactory;\n+import io.atomix.utils.logging.LoggerContext;\n+import java.util.concurrent.CompletableFuture;\n+import org.slf4j.Logger;\n+\n+public final class LogCompactor {\n+  private final RaftContext raft;\n+\n+  // hard coupled state\n+  private final RaftLogReader reader;\n+  private final Logger logger;\n+  private final RaftServiceMetrics metrics;\n+\n+  // used when performing compaction; may be updated from a different thread\n+  private volatile long compactableIndex;\n+\n+  public LogCompactor(final RaftContext raft) {\n+    this.raft = raft;\n+    this.reader = raft.getLog().openReader(1, RaftLogReader.Mode.COMMITS);\n+\n+    this.logger =\n+        ContextualLoggerFactory.getLogger(\n+            getClass(), LoggerContext.builder(getClass()).addValue(raft.getName()).build());\n+    this.metrics = new RaftServiceMetrics(raft.getName());\n+  }\n+\n+  public ThreadContext executor() {\n+    return raft.getThreadContext();\n+  }\n+\n+  /**\n+   * Assumes our snapshots are being taken asynchronously and we regularly update the compactable\n+   * index. Compaction is performed asynchronously.\n+   *\n+   * @return a future which is completed when the log has been compacted\n+   */\n+  public CompletableFuture<Void> compact() {\n+    raft.checkThread();\n+\n+    final var log = raft.getLog();\n+    if (log.isCompactable(compactableIndex)) {\n+      final var index = log.getCompactableIndex(compactableIndex);\n+      final var future = new CompletableFuture<Void>();\n+      logger.debug(\"Compacting log up from {} up to {}\", reader.getFirstIndex(), index);\n+      compact(index, future);\n+      return future;\n+    } else {\n+      logger.debug(\n+          \"Skipping compaction of non-compactable index {} (first log index: {})\",\n+          compactableIndex,\n+          reader.getFirstIndex());\n+    }\n+\n+    return CompletableFuture.completedFuture(null);\n+  }\n+\n+  public void close() {\n+    raft.checkThread();\n+    logger.debug(\"Closing state machine {}\", raft.getName());\n+    reader.close();\n+  }\n+\n+  public long getCompactableIndex() {", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java\ndeleted file mode 100644\nindex 35adf8cb78..0000000000\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/zeebe/LogCompactor.java\n+++ /dev/null\n\n@@ -1,95 +0,0 @@\n-/*\n- * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n- * one or more contributor license agreements. See the NOTICE file distributed\n- * with this work for additional information regarding copyright ownership.\n- * Licensed under the Zeebe Community License 1.0. You may not use this file\n- * except in compliance with the Zeebe Community License 1.0.\n- */\n-package io.atomix.raft.impl.zeebe;\n-\n-import io.atomix.raft.impl.RaftContext;\n-import io.atomix.raft.metrics.RaftServiceMetrics;\n-import io.atomix.raft.storage.log.RaftLogReader;\n-import io.atomix.utils.concurrent.ThreadContext;\n-import io.atomix.utils.logging.ContextualLoggerFactory;\n-import io.atomix.utils.logging.LoggerContext;\n-import java.util.concurrent.CompletableFuture;\n-import org.slf4j.Logger;\n-\n-public final class LogCompactor {\n-  private final RaftContext raft;\n-\n-  // hard coupled state\n-  private final RaftLogReader reader;\n-  private final Logger logger;\n-  private final RaftServiceMetrics metrics;\n-\n-  // used when performing compaction; may be updated from a different thread\n-  private volatile long compactableIndex;\n-\n-  public LogCompactor(final RaftContext raft) {\n-    this.raft = raft;\n-    this.reader = raft.getLog().openReader(1, RaftLogReader.Mode.COMMITS);\n-\n-    this.logger =\n-        ContextualLoggerFactory.getLogger(\n-            getClass(), LoggerContext.builder(getClass()).addValue(raft.getName()).build());\n-    this.metrics = new RaftServiceMetrics(raft.getName());\n-  }\n-\n-  public ThreadContext executor() {\n-    return raft.getThreadContext();\n-  }\n-\n-  /**\n-   * Assumes our snapshots are being taken asynchronously and we regularly update the compactable\n-   * index. Compaction is performed asynchronously.\n-   *\n-   * @return a future which is completed when the log has been compacted\n-   */\n-  public CompletableFuture<Void> compact() {\n-    raft.checkThread();\n-\n-    final var log = raft.getLog();\n-    if (log.isCompactable(compactableIndex)) {\n-      final var index = log.getCompactableIndex(compactableIndex);\n-      final var future = new CompletableFuture<Void>();\n-      logger.debug(\"Compacting log up from {} up to {}\", reader.getFirstIndex(), index);\n-      compact(index, future);\n-      return future;\n-    } else {\n-      logger.debug(\n-          \"Skipping compaction of non-compactable index {} (first log index: {})\",\n-          compactableIndex,\n-          reader.getFirstIndex());\n-    }\n-\n-    return CompletableFuture.completedFuture(null);\n-  }\n-\n-  public void close() {\n-    raft.checkThread();\n-    logger.debug(\"Closing state machine {}\", raft.getName());\n-    reader.close();\n-  }\n-\n-  public long getCompactableIndex() {\n-    return compactableIndex;\n-  }\n-\n-  public void setCompactableIndex(final long index) {\n-    this.compactableIndex = index;\n-  }\n-\n-  private void compact(final long index, final CompletableFuture<Void> future) {\n-    try {\n-      final var startTime = System.currentTimeMillis();\n-      raft.getLog().compact(index);\n-      metrics.compactionTime(System.currentTimeMillis() - startTime);\n-      future.complete(null);\n-    } catch (final Exception e) {\n-      logger.error(\"Failed to compact up to index {}\", index, e);\n-      future.completeExceptionally(e);\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3ODM4MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465078380", "bodyText": "Just a small nit: these changes that only move methods around are not ideal in my opinion. If they contain actual functional changes, those are obfuscated because the whole chunk becomes part of the diff, and they also make the PR unnecessarily bigger. Our code style says \"while we don't enforce an ordering for instance methods, it's recommended to group them together based on functionality.\" which I guess is not the goal here. I guess this happens because of automatic method reordering in Intellij but it has some drawbacks for the reviewer", "author": "MiguelPires", "createdAt": "2020-08-04T14:09:42Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/roles/LeaderRole.java", "diffHunk": "@@ -93,27 +92,6 @@ public LeaderRole(final RaftContext context) {\n     return super.start().thenRun(this::startTimers).thenApply(v -> this);\n   }\n \n-  private ZeebeEntry findLastZeebeEntry() {", "originalCommit": "de2ed1fa2bf8260ddf86dddc104289375a04e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE5MzA2NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465193065", "bodyText": "Agree with miguel here. I already pointed this out in other PR's I might due that atomix is not completely formatted? Or does it happen also in other modules?", "author": "Zelldon", "createdAt": "2020-08-04T16:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3ODM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUwNzIzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r465507235", "bodyText": "Our codestyle says \"Overridden methods must be grouped together\". I believe that is what this auto-formatting did. What do you suggest here? Should I revert these formatting?", "author": "deepthidevaki", "createdAt": "2020-08-05T06:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3ODM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4NzYwNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466887607", "bodyText": "No, that probably makes sense then \ud83d\udc4d", "author": "MiguelPires", "createdAt": "2020-08-07T08:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3ODM4MA=="}], "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/roles/LeaderRole.java b/atomix/cluster/src/main/java/io/atomix/raft/roles/LeaderRole.java\nindex 6fbc0c3525..f54b96ea55 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/roles/LeaderRole.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/roles/LeaderRole.java\n\n@@ -92,6 +93,27 @@ public final class LeaderRole extends ActiveRole implements ZeebeLogAppender {\n     return super.start().thenRun(this::startTimers).thenApply(v -> this);\n   }\n \n+  private ZeebeEntry findLastZeebeEntry() {\n+    long index = raft.getLogWriter().getLastIndex();\n+    while (index > 0) {\n+      raft.getLogReader().reset(index);\n+      final Indexed<RaftLogEntry> lastEntry = raft.getLogReader().next();\n+\n+      if (lastEntry != null && lastEntry.type() == ZeebeEntry.class) {\n+        return ((ZeebeEntry) lastEntry.entry());\n+      }\n+\n+      --index;\n+    }\n+\n+    return null;\n+  }\n+\n+  @Override\n+  protected PersistedSnapshotListener createSnapshotListener() {\n+    return null;\n+  }\n+\n   @Override\n   public synchronized CompletableFuture<Void> stop() {\n     return super.stop()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzOTU4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466839589", "bodyText": "Do you think we need the max ? So max of current and previous commit? Idk why this was done before. I had hoped that we have the guarantee that this is increasing \ud83d\ude05", "author": "Zelldon", "createdAt": "2020-08-07T06:07:24Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java", "diffHunk": "@@ -723,28 +727,6 @@ public void setEntryValidator(final EntryValidator validator) {\n     this.entryValidator = validator;\n   }\n \n-  /**\n-   * Returns the last applied index.\n-   *\n-   * @return the last applied index\n-   */\n-  public long getLastApplied() {\n-    return lastApplied;\n-  }\n-\n-  /**\n-   * Sets the last applied index.\n-   *\n-   * @param lastApplied the last applied index and the last applied term\n-   */\n-  private void setLastApplied(final long lastApplied) {\n-    this.lastApplied = Math.max(this.lastApplied, lastApplied);", "originalCommit": "2a5a970ec48e97f54aee475ae32757c240dcd03e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0NTE5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466845190", "bodyText": "This is removed code :)", "author": "deepthidevaki", "createdAt": "2020-08-07T06:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzOTU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0NTU0MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466845541", "bodyText": "Yeah I know but was not sure whether we need this in the new code? \ud83d\ude05", "author": "Zelldon", "createdAt": "2020-08-07T06:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzOTU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0NzAzOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466847038", "bodyText": "Ah.. Sorry. I misread it \ud83d\ude04 It is already checked in setCommitIndex https://github.com/zeebe-io/zeebe/blob/2a5a970ec48e97f54aee475ae32757c240dcd03e/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java#L346", "author": "deepthidevaki", "createdAt": "2020-08-07T06:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzOTU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0OTQ4Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5096#discussion_r466849487", "bodyText": "Ah ok this is still a bit different but ok thanks", "author": "Zelldon", "createdAt": "2020-08-07T06:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzOTU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "chunk": "diff --git a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\nindex d198d39dfc..8c30e1e625 100644\n--- a/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n+++ b/atomix/cluster/src/main/java/io/atomix/raft/impl/RaftContext.java\n\n@@ -727,6 +748,24 @@ public class RaftContext implements AutoCloseable {\n     this.entryValidator = validator;\n   }\n \n+  /**\n+   * Returns the last applied index.\n+   *\n+   * @return the last applied index\n+   */\n+  public long getLastApplied() {\n+    return lastApplied;\n+  }\n+\n+  /**\n+   * Returns the term of the last applied entry.\n+   *\n+   * @return the last applied index\n+   */\n+  public long getLastAppliedTerm() {\n+    return lastAppliedTerm;\n+  }\n+\n   /**\n    * Returns the state last voted for candidate.\n    *\n"}}, {"oid": "3dec413534b8b7422ccc644dd231769ab4b0ff10", "url": "https://github.com/camunda-cloud/zeebe/commit/3dec413534b8b7422ccc644dd231769ab4b0ff10", "message": "chore(logstreams): use LogStorageAppender commit listener to update commit position", "committedDate": "2020-08-07T11:50:32Z", "type": "commit"}, {"oid": "473cc21052fee518ef659d64c6d405b986c482ab", "url": "https://github.com/camunda-cloud/zeebe/commit/473cc21052fee518ef659d64c6d405b986c482ab", "message": "chore(atomix): refactor raft commit listener and remove state machine\n* commit listener only notifies the index instead of the entry. So it does not have to re-read the entries to notify listeners.\n* Rename ZeebeRaftStateMachine to LogCompactor", "committedDate": "2020-08-07T11:50:32Z", "type": "commit"}, {"oid": "d36385686dad03919396c355f4f29f0b8965e348", "url": "https://github.com/camunda-cloud/zeebe/commit/d36385686dad03919396c355f4f29f0b8965e348", "message": "chore(atomix): remove unused RaftCompactionConfig", "committedDate": "2020-08-07T11:50:32Z", "type": "commit"}, {"oid": "d36385686dad03919396c355f4f29f0b8965e348", "url": "https://github.com/camunda-cloud/zeebe/commit/d36385686dad03919396c355f4f29f0b8965e348", "message": "chore(atomix): remove unused RaftCompactionConfig", "committedDate": "2020-08-07T11:50:32Z", "type": "forcePushed"}]}