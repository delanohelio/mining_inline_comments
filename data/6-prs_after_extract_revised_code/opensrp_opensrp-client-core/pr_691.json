{"pr_number": 691, "pr_title": "Task data model changes", "pr_createdAt": "2020-11-16T06:31:54Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/691", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE0OTgyNg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r524149826", "bodyText": "Fix this to restriction_end", "author": "ekigamba", "createdAt": "2020-11-16T11:24:16Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -69,10 +72,13 @@\n     private static final String REASON_REFERENCE = \"reason_reference\";\n     private static final String LOCATION = \"location\";\n     private static final String REQUESTER = \"requester\";\n+    private static final String RESTRICTION_REPEAT = \"restriction_repeat\";\n+    private static final String RESTRICTION_START = \"restriction_start\";\n+    private static final String RESTRICTION_END = \"restriction_start\";", "originalCommit": "2df464ea50fe50d5ac38780d8879130698da130c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 3795cd7e..6f458c75 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -72,13 +69,10 @@ public class TaskRepository extends BaseRepository {\n     private static final String REASON_REFERENCE = \"reason_reference\";\n     private static final String LOCATION = \"location\";\n     private static final String REQUESTER = \"requester\";\n-    private static final String RESTRICTION_REPEAT = \"restriction_repeat\";\n-    private static final String RESTRICTION_START = \"restriction_start\";\n-    private static final String RESTRICTION_END = \"restriction_start\";\n \n-    private final TaskNotesRepository taskNotesRepository;\n+    private TaskNotesRepository taskNotesRepository;\n \n-    protected static final String[] COLUMNS = {ROWID, ID, PLAN_ID, GROUP_ID, STATUS, BUSINESS_STATUS, PRIORITY, CODE, DESCRIPTION, FOCUS, FOR, START, END, AUTHORED_ON, LAST_MODIFIED, OWNER, SYNC_STATUS, SERVER_VERSION, STRUCTURE_ID, REASON_REFERENCE, LOCATION, REQUESTER, RESTRICTION_REPEAT, RESTRICTION_START, RESTRICTION_END};\n+    protected static final String[] COLUMNS = {ID, PLAN_ID, GROUP_ID, STATUS, BUSINESS_STATUS, PRIORITY, CODE, DESCRIPTION, FOCUS, FOR, START, END, AUTHORED_ON, LAST_MODIFIED, OWNER, SYNC_STATUS, SERVER_VERSION, STRUCTURE_ID, REASON_REFERENCE, LOCATION, REQUESTER};\n \n     protected static final String TASK_TABLE = \"task\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NDMxMQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r524154311", "bodyText": "I think  this query is wrong\nHave you tested this out and line 132?", "author": "ekigamba", "createdAt": "2020-11-16T11:28:07Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -112,6 +121,17 @@ public static void createTable(SQLiteDatabase database) {\n         database.execSQL(CREATE_TASK_PLAN_GROUP_INDEX);\n     }\n \n+    /**\n+     * Migrate the older database by add restriction columns and changing of priority to enum\n+     * @param database the database being upgraded\n+     */\n+    public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n+        DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n+        database.execSQL(String.format(\"UPDATE %s SET %s=? WHERE %s =? \", TASK_TABLE, PRIORITY, PRIORITY), new Object[]{\"3\", \"3\"});", "originalCommit": "2df464ea50fe50d5ac38780d8879130698da130c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMTg0MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527631841", "bodyText": "Yes tested and now it works", "author": "githengi", "createdAt": "2020-11-20T11:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NDMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 3795cd7e..6f458c75 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -121,23 +112,12 @@ public class TaskRepository extends BaseRepository {\n         database.execSQL(CREATE_TASK_PLAN_GROUP_INDEX);\n     }\n \n-    /**\n-     * Migrate the older database by add restriction columns and changing of priority to enum\n-     * @param database the database being upgraded\n-     */\n-    public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n-        DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n-        database.execSQL(String.format(\"UPDATE %s SET %s=? WHERE %s =? \", TASK_TABLE, PRIORITY, PRIORITY), new Object[]{\"3\", \"3\"});\n-    }\n \n     public void addOrUpdate(Task task) {\n         addOrUpdate(task, false);\n     }\n \n-    public void addOrUpdate(Task task, boolean updateOnly) {\n+    public Task addOrUpdate(Task task, boolean updateOnly) {\n         if (StringUtils.isBlank(task.getIdentifier())) {\n             throw new IllegalArgumentException(\"identifier must be specified\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1OTY0Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r524159642", "bodyText": "Is the task.restriction supposed to be saved here also?", "author": "ekigamba", "createdAt": "2020-11-16T11:33:03Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -139,13 +159,15 @@ public void addOrUpdate(Task task, boolean updateOnly) {\n             contentValues.put(STATUS, task.getStatus().name());\n         }\n         contentValues.put(BUSINESS_STATUS, task.getBusinessStatus());\n-        contentValues.put(PRIORITY, task.getPriority());\n+        contentValues.put(PRIORITY, task.getPriority().name());", "originalCommit": "2df464ea50fe50d5ac38780d8879130698da130c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2OTAwOA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r526969008", "bodyText": "yes, added saving logic from line 168", "author": "githengi", "createdAt": "2020-11-19T15:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1OTY0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 3795cd7e..6f458c75 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -159,15 +139,13 @@ public class TaskRepository extends BaseRepository {\n             contentValues.put(STATUS, task.getStatus().name());\n         }\n         contentValues.put(BUSINESS_STATUS, task.getBusinessStatus());\n-        contentValues.put(PRIORITY, task.getPriority().name());\n+        contentValues.put(PRIORITY, task.getPriority());\n         contentValues.put(CODE, task.getCode());\n         contentValues.put(DESCRIPTION, task.getDescription());\n         contentValues.put(FOCUS, task.getFocus());\n         contentValues.put(FOR, task.getForEntity());\n-        if (task.getExecutionPeriod() != null) {\n-            contentValues.put(START, DateUtil.getMillis(task.getExecutionPeriod().getStart()));\n-            contentValues.put(END, DateUtil.getMillis(task.getExecutionPeriod().getEnd()));\n-        }\n+        contentValues.put(START, DateUtil.getMillis(task.getExecutionStartDate()));\n+        contentValues.put(END, DateUtil.getMillis(task.getExecutionEndDate()));\n         contentValues.put(AUTHORED_ON, DateUtil.getMillis(task.getAuthoredOn()));\n         contentValues.put(LAST_MODIFIED, DateUtil.getMillis(task.getLastModified()));\n         contentValues.put(OWNER, task.getOwner());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE2MzA3NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r524163074", "bodyText": "should be columns and not table here", "author": "ekigamba", "createdAt": "2020-11-16T11:36:18Z", "path": "opensrp-app/src/main/java/org/smartregister/util/DatabaseMigrationUtils.java", "diffHunk": "@@ -156,6 +156,32 @@ public static void recreateSyncTableWithExistingColumnsOnly(SQLiteDatabase datab\n     }\n \n \n+    public static void recreateSyncTableWithExistingColumnsOnly(SQLiteDatabase database, String table ,String[] columns, String createTableDDL) {\n+        database.beginTransaction();\n+        //rename original table\n+        database.execSQL(\"ALTER TABLE \" + table + \" RENAME TO \" + TABLE_PREFIX + table);\n+        //recreate table\n+        database.execSQL(createTableDDL);\n+        //\n+        String insertQuery = \"INSERT INTO \"\n+                + table\n+                + \" (\" + StringUtils.join(table, \", \") + \")\"", "originalCommit": "2df464ea50fe50d5ac38780d8879130698da130c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3NzU2NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r526977565", "bodyText": "nice catch, updated", "author": "githengi", "createdAt": "2020-11-19T15:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE2MzA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/util/DatabaseMigrationUtils.java b/opensrp-app/src/main/java/org/smartregister/util/DatabaseMigrationUtils.java\nindex bd9127e8..87f787e0 100644\n--- a/opensrp-app/src/main/java/org/smartregister/util/DatabaseMigrationUtils.java\n+++ b/opensrp-app/src/main/java/org/smartregister/util/DatabaseMigrationUtils.java\n\n@@ -156,32 +156,6 @@ public class DatabaseMigrationUtils {\n     }\n \n \n-    public static void recreateSyncTableWithExistingColumnsOnly(SQLiteDatabase database, String table ,String[] columns, String createTableDDL) {\n-        database.beginTransaction();\n-        //rename original table\n-        database.execSQL(\"ALTER TABLE \" + table + \" RENAME TO \" + TABLE_PREFIX + table);\n-        //recreate table\n-        database.execSQL(createTableDDL);\n-        //\n-        String insertQuery = \"INSERT INTO \"\n-                + table\n-                + \" (\" + StringUtils.join(table, \", \") + \")\"\n-                + \" SELECT \" + StringUtils.join(columns, \", \") + \" FROM \"\n-                + TABLE_PREFIX + table;\n-\n-        Log.d(TAG, \"Insert query is\\n---------------------------\\n\" + insertQuery);\n-\n-        database.execSQL(insertQuery);\n-\n-        database.execSQL(\"DROP TABLE \" + TABLE_PREFIX + table);\n-\n-        database.setTransactionSuccessful();\n-\n-        database.endTransaction();\n-\n-    }\n-\n-\n     private static boolean tableExists(SQLiteDatabase database, String tableName) {\n         Cursor cursor = database.rawQuery(\"SELECT name FROM sqlite_master WHERE type='table' AND name= ?\", new String[]{tableName});\n         boolean exists = false;\n"}}, {"oid": "0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "url": "https://github.com/opensrp/opensrp-client-core/commit/0eddfaadd1673a82de403d7ab0d1ffb0465e4c01", "message": "Upgrade plan evaluator", "committedDate": "2020-11-19T14:26:31Z", "type": "commit"}, {"oid": "8d66bce73298b6b6f4fada7b0eaa3a80ae4187c0", "url": "https://github.com/opensrp/opensrp-client-core/commit/8d66bce73298b6b6f4fada7b0eaa3a80ae4187c0", "message": "Update task repository", "committedDate": "2020-11-19T14:26:32Z", "type": "commit"}, {"oid": "5154544e832fa10ca86af0baa01557937a42e582", "url": "https://github.com/opensrp/opensrp-client-core/commit/5154544e832fa10ca86af0baa01557937a42e582", "message": "support adding of restriction columns as well as changing priority", "committedDate": "2020-11-19T14:26:32Z", "type": "commit"}, {"oid": "b949a6a766d47e02efc7baac02d4f42963ea18d9", "url": "https://github.com/opensrp/opensrp-client-core/commit/b949a6a766d47e02efc7baac02d4f42963ea18d9", "message": "add method to upgrade the current task table", "committedDate": "2020-11-19T14:26:32Z", "type": "commit"}, {"oid": "c4e023e2c6716381c3d1ad046207670331102ea4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c4e023e2c6716381c3d1ad046207670331102ea4", "message": "Use Task V2 API", "committedDate": "2020-11-19T14:26:32Z", "type": "commit"}, {"oid": "c4e023e2c6716381c3d1ad046207670331102ea4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c4e023e2c6716381c3d1ad046207670331102ea4", "message": "Use Task V2 API", "committedDate": "2020-11-19T14:26:32Z", "type": "forcePushed"}, {"oid": "287144d9e5914fa008df1093b973551faa3d3fea", "url": "https://github.com/opensrp/opensrp-client-core/commit/287144d9e5914fa008df1093b973551faa3d3fea", "message": "save restriction and populate when populating entity from database", "committedDate": "2020-11-19T14:36:37Z", "type": "commit"}, {"oid": "99fedfa8bad9af52c4aa603fd476122ec7e2a2b4", "url": "https://github.com/opensrp/opensrp-client-core/commit/99fedfa8bad9af52c4aa603fd476122ec7e2a2b4", "message": "Bump up version", "committedDate": "2020-11-19T14:37:02Z", "type": "commit"}, {"oid": "c267745fa316726696f008c3f1862f6f26a610f4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c267745fa316726696f008c3f1862f6f26a610f4", "message": "Update campaign classes", "committedDate": "2020-11-19T14:47:09Z", "type": "commit"}, {"oid": "e91486a2aba888f99c8f7dc62230991acdb3958d", "url": "https://github.com/opensrp/opensrp-client-core/commit/e91486a2aba888f99c8f7dc62230991acdb3958d", "message": "update unit tests", "committedDate": "2020-11-19T15:14:38Z", "type": "commit"}, {"oid": "2bf6530fbafc79bc8e5f5996b4757d01104669c1", "url": "https://github.com/opensrp/opensrp-client-core/commit/2bf6530fbafc79bc8e5f5996b4757d01104669c1", "message": "Update all tasks to routine", "committedDate": "2020-11-19T15:28:40Z", "type": "commit"}, {"oid": "99c37cf12fae4c3b1070e2c1cfe7c39c7a66827b", "url": "https://github.com/opensrp/opensrp-client-core/commit/99c37cf12fae4c3b1070e2c1cfe7c39c7a66827b", "message": "Correct query syntax", "committedDate": "2020-11-19T15:28:58Z", "type": "commit"}, {"oid": "b90e55c8646e1bf4429b7a56c7e39b65b10a1265", "url": "https://github.com/opensrp/opensrp-client-core/commit/b90e55c8646e1bf4429b7a56c7e39b65b10a1265", "message": "replace priority with enum name", "committedDate": "2020-11-19T15:38:17Z", "type": "commit"}, {"oid": "529973ca191c1dc11f23496221bef214286e20d4", "url": "https://github.com/opensrp/opensrp-client-core/commit/529973ca191c1dc11f23496221bef214286e20d4", "message": "strip date format for unit tests", "committedDate": "2020-11-19T15:42:02Z", "type": "commit"}, {"oid": "5971fb081ec56bc01c856f42b1d44267ddd3b293", "url": "https://github.com/opensrp/opensrp-client-core/commit/5971fb081ec56bc01c856f42b1d44267ddd3b293", "message": "correct broken unit tests", "committedDate": "2020-11-19T16:11:17Z", "type": "commit"}, {"oid": "756e1343cef37ca14d5de6878a6ab9807ad1cc66", "url": "https://github.com/opensrp/opensrp-client-core/commit/756e1343cef37ca14d5de6878a6ab9807ad1cc66", "message": "set restriction only if period or repititions are set", "committedDate": "2020-11-19T16:20:41Z", "type": "commit"}, {"oid": "5402974633978c0310bebcd1368b0b9822aa9223", "url": "https://github.com/opensrp/opensrp-client-core/commit/5402974633978c0310bebcd1368b0b9822aa9223", "message": "Update broken unit tests", "committedDate": "2020-11-19T16:30:34Z", "type": "commit"}, {"oid": "cdc3772d0f03b41c28067bf962a7456e271e3c11", "url": "https://github.com/opensrp/opensrp-client-core/commit/cdc3772d0f03b41c28067bf962a7456e271e3c11", "message": "clear mock repository after tests", "committedDate": "2020-11-19T16:58:42Z", "type": "commit"}, {"oid": "941bf9c0e4241dd8a758f66346317ae0ef1855e4", "url": "https://github.com/opensrp/opensrp-client-core/commit/941bf9c0e4241dd8a758f66346317ae0ef1855e4", "message": "Reinit core Library and context singleton after each test", "committedDate": "2020-11-20T07:30:10Z", "type": "forcePushed"}, {"oid": "6ddfdd4874f397a1b7cca3f901bcdfc26de18857", "url": "https://github.com/opensrp/opensrp-client-core/commit/6ddfdd4874f397a1b7cca3f901bcdfc26de18857", "message": "Reinit core Library and context singleton after each test", "committedDate": "2020-11-20T07:50:03Z", "type": "forcePushed"}, {"oid": "cdc3772d0f03b41c28067bf962a7456e271e3c11", "url": "https://github.com/opensrp/opensrp-client-core/commit/cdc3772d0f03b41c28067bf962a7456e271e3c11", "message": "clear mock repository after tests", "committedDate": "2020-11-19T16:58:42Z", "type": "forcePushed"}, {"oid": "84511f736bb4dcaeb2c9742e4ce3945410200f46", "url": "https://github.com/opensrp/opensrp-client-core/commit/84511f736bb4dcaeb2c9742e4ce3945410200f46", "message": "Use oracle JDK", "committedDate": "2020-11-20T09:21:53Z", "type": "forcePushed"}, {"oid": "b8650c3aa546792e72104503b2698770dbcc64f5", "url": "https://github.com/opensrp/opensrp-client-core/commit/b8650c3aa546792e72104503b2698770dbcc64f5", "message": "init core library before tests", "committedDate": "2020-11-20T09:28:56Z", "type": "commit"}, {"oid": "b8650c3aa546792e72104503b2698770dbcc64f5", "url": "https://github.com/opensrp/opensrp-client-core/commit/b8650c3aa546792e72104503b2698770dbcc64f5", "message": "init core library before tests", "committedDate": "2020-11-20T09:28:56Z", "type": "forcePushed"}, {"oid": "847211b851c9f489fe77b45b608dbaca6bab7ff6", "url": "https://github.com/opensrp/opensrp-client-core/commit/847211b851c9f489fe77b45b608dbaca6bab7ff6", "message": "fix Broken unit tests", "committedDate": "2020-11-20T10:20:39Z", "type": "forcePushed"}, {"oid": "2afe25b9870432453b4af46af901dab0f5d65f5c", "url": "https://github.com/opensrp/opensrp-client-core/commit/2afe25b9870432453b4af46af901dab0f5d65f5c", "message": "fix Broken unit tests", "committedDate": "2020-11-20T10:35:14Z", "type": "commit"}, {"oid": "2afe25b9870432453b4af46af901dab0f5d65f5c", "url": "https://github.com/opensrp/opensrp-client-core/commit/2afe25b9870432453b4af46af901dab0f5d65f5c", "message": "fix Broken unit tests", "committedDate": "2020-11-20T10:35:14Z", "type": "forcePushed"}, {"oid": "3a0d42fb5fe1d7498cdd9e0408ee2836860dc434", "url": "https://github.com/opensrp/opensrp-client-core/commit/3a0d42fb5fe1d7498cdd9e0408ee2836860dc434", "message": "Migrate test to roboelectric", "committedDate": "2020-11-20T10:37:02Z", "type": "commit"}, {"oid": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "url": "https://github.com/opensrp/opensrp-client-core/commit/35144dd34a5110f0b137bab68389febbf3b5b6ec", "message": "optimize imports code cleanup", "committedDate": "2020-11-20T10:55:53Z", "type": "commit"}, {"oid": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "url": "https://github.com/opensrp/opensrp-client-core/commit/35144dd34a5110f0b137bab68389febbf3b5b6ec", "message": "optimize imports code cleanup", "committedDate": "2020-11-20T10:55:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyMTkzNA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527621934", "bodyText": "Isn't this an Integer field as declared on line 108?", "author": "Rkareko", "createdAt": "2020-11-20T11:13:27Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -112,6 +121,18 @@ public static void createTable(SQLiteDatabase database) {\n         database.execSQL(CREATE_TASK_PLAN_GROUP_INDEX);\n     }\n \n+    /**\n+     * Migrate the older database by add restriction columns and changing of priority to enum\n+     *\n+     * @param database the database being upgraded\n+     */\n+    public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);", "originalCommit": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMDczOQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527630739", "bodyText": "Corrected", "author": "githengi", "createdAt": "2020-11-20T11:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyMTkzNA=="}], "type": "inlineReview", "revised_code": {"commit": "66e6f5ad2936e799c9092383e116b403433523c3", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 8d0982c3..1040b11c 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -127,9 +127,9 @@ public class TaskRepository extends BaseRepository {\n      * @param database the database being upgraded\n      */\n     public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, INTEGER);\n         DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n         database.execSQL(String.format(\"UPDATE %s SET %s=?\", TASK_TABLE, PRIORITY), new Object[]{Task.TaskPriority.ROUTINE.name()});\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDA4Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527624082", "bodyText": "on line 92 Priority has been changed from an integer field to a varchar. Do we need a migration for that?", "author": "Rkareko", "createdAt": "2020-11-20T11:17:37Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -112,6 +121,18 @@ public static void createTable(SQLiteDatabase database) {\n         database.execSQL(CREATE_TASK_PLAN_GROUP_INDEX);\n     }\n \n+    /**\n+     * Migrate the older database by add restriction columns and changing of priority to enum\n+     *\n+     * @param database the database being upgraded\n+     */\n+    public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n+        DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n+        database.execSQL(String.format(\"UPDATE %s SET %s=?\", TASK_TABLE, PRIORITY), new Object[]{Task.TaskPriority.ROUTINE.name()});", "originalCommit": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyODQxOA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527628418", "bodyText": "The table is being recreated using DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly above, this is because sqlite does not support alter column data types or dropping columns, the table must be recreated", "author": "githengi", "createdAt": "2020-11-20T11:26:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDA4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "66e6f5ad2936e799c9092383e116b403433523c3", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 8d0982c3..1040b11c 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -127,9 +127,9 @@ public class TaskRepository extends BaseRepository {\n      * @param database the database being upgraded\n      */\n     public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, INTEGER);\n         DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n         database.execSQL(String.format(\"UPDATE %s SET %s=?\", TASK_TABLE, PRIORITY), new Object[]{Task.TaskPriority.ROUTINE.name()});\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDg0Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527624847", "bodyText": "Drop priority column and readd it as varchar column type", "author": "ekigamba", "createdAt": "2020-11-20T11:19:18Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -112,6 +121,18 @@ public static void createTable(SQLiteDatabase database) {\n         database.execSQL(CREATE_TASK_PLAN_GROUP_INDEX);\n     }\n \n+    /**\n+     * Migrate the older database by add restriction columns and changing of priority to enum\n+     *\n+     * @param database the database being upgraded\n+     */\n+    public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);", "originalCommit": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMTI4OQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527631289", "bodyText": "I have updated this to Integer", "author": "githengi", "createdAt": "2020-11-20T11:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0OTc2Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527649763", "bodyText": "Migration of priority column since on running apps its an integer", "author": "ekigamba", "createdAt": "2020-11-20T12:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MDc4Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527650782", "bodyText": "That is is being done as explained #691 (comment)", "author": "githengi", "createdAt": "2020-11-20T12:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDg0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "66e6f5ad2936e799c9092383e116b403433523c3", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 8d0982c3..1040b11c 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -127,9 +127,9 @@ public class TaskRepository extends BaseRepository {\n      * @param database the database being upgraded\n      */\n     public static void updatePriorityToEnumAndAddRestrictions(@NonNull SQLiteDatabase database) {\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, VARCHAR);\n-        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, VARCHAR);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_REPEAT, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_START, INTEGER);\n+        DatabaseMigrationUtils.addColumnIfNotExists(database, TASK_TABLE, RESTRICTION_END, INTEGER);\n         DatabaseMigrationUtils.recreateSyncTableWithExistingColumnsOnly(database, TASK_TABLE, COLUMNS, CREATE_TASK_TABLE);\n         database.execSQL(String.format(\"UPDATE %s SET %s=?\", TASK_TABLE, PRIORITY), new Object[]{Task.TaskPriority.ROUTINE.name()});\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNjM2NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527626365", "bodyText": "Change this type to INTEGER and the restriction_end type also. This is queried as long on line 313. Similar changes on line 131 for migration scripts. Also when saving in the ContentValue", "author": "ekigamba", "createdAt": "2020-11-20T11:22:16Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java", "diffHunk": "@@ -98,7 +104,10 @@\n                     STRUCTURE_ID + \" VARCHAR, \" +\n                     REASON_REFERENCE + \" VARCHAR, \" +\n                     LOCATION + \" VARCHAR, \" +\n-                    REQUESTER + \" VARCHAR  )\";\n+                    REQUESTER + \" VARCHAR,  \" +\n+                    RESTRICTION_REPEAT + \" INTEGER,  \" +\n+                    RESTRICTION_START + \" VARCHAR,  \" +", "originalCommit": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMTE0MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527631141", "bodyText": "Changed", "author": "githengi", "createdAt": "2020-11-20T11:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNjM2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "66e6f5ad2936e799c9092383e116b403433523c3", "chunk": "diff --git a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\nindex 8d0982c3..1040b11c 100644\n--- a/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n+++ b/opensrp-app/src/main/java/org/smartregister/repository/TaskRepository.java\n\n@@ -106,8 +106,8 @@ public class TaskRepository extends BaseRepository {\n                     LOCATION + \" VARCHAR, \" +\n                     REQUESTER + \" VARCHAR,  \" +\n                     RESTRICTION_REPEAT + \" INTEGER,  \" +\n-                    RESTRICTION_START + \" VARCHAR,  \" +\n-                    RESTRICTION_END + \" VARCHAR )\";\n+                    RESTRICTION_START + \" INTEGER,  \" +\n+                    RESTRICTION_END + \" INTEGER )\";\n \n     private static final String CREATE_TASK_PLAN_GROUP_INDEX = \"CREATE INDEX \"\n             + TASK_TABLE + \"_plan_group_ind  ON \" + TASK_TABLE + \"(\" + PLAN_ID + \",\" + GROUP_ID + \",\" + SYNC_STATUS + \")\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyOTEzMw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527629133", "bodyText": "Not sure how this works with 2019-03-31T0000. Could you confirm? Is the T0000 part essential and/or ignored during conversion?\nFound the format in CampaignTest", "author": "ekigamba", "createdAt": "2020-11-20T11:27:37Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/PlanIntentServiceHelper.java", "diffHunk": "@@ -38,7 +40,10 @@\n \n     private final PlanDefinitionRepository planDefinitionRepository;\n     private final AllSharedPreferences allSharedPreferences;\n-    protected static final Gson gson = new GsonBuilder().registerTypeAdapter(LocalDate.class, new DateTypeConverter()).create();\n+    protected static Gson gson = new GsonBuilder().registerTypeAdapter(DateTime.class, new DateTimeTypeConverter(\"yyyy-MM-dd\"))", "originalCommit": "35144dd34a5110f0b137bab68389febbf3b5b6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMjgzNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527632835", "bodyText": "This for plans serialization, and deserialization, plans use Dates and thus dont need the time part. Since the execution period was changed from Localdate to DateTime, this is necessary to avoid side effects", "author": "githengi", "createdAt": "2020-11-20T11:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyOTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0NjM2Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/691#discussion_r527646363", "bodyText": "Cool", "author": "ekigamba", "createdAt": "2020-11-20T12:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyOTEzMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "66e6f5ad2936e799c9092383e116b403433523c3", "url": "https://github.com/opensrp/opensrp-client-core/commit/66e6f5ad2936e799c9092383e116b403433523c3", "message": "Change datatype to integer", "committedDate": "2020-11-20T11:36:21Z", "type": "commit"}, {"oid": "66e6f5ad2936e799c9092383e116b403433523c3", "url": "https://github.com/opensrp/opensrp-client-core/commit/66e6f5ad2936e799c9092383e116b403433523c3", "message": "Change datatype to integer", "committedDate": "2020-11-20T11:36:21Z", "type": "forcePushed"}]}