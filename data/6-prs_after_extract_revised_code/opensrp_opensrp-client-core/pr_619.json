{"pr_number": 619, "pr_title": "Login package unit tests", "pr_createdAt": "2020-08-04T08:41:18Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/619", "timeline": [{"oid": "ec2f1c0ddaf2d8cf511983feddbce4f030b14ba0", "url": "https://github.com/opensrp/opensrp-client-core/commit/ec2f1c0ddaf2d8cf511983feddbce4f030b14ba0", "message": "LoginHelper tests", "committedDate": "2020-08-04T07:50:38Z", "type": "commit"}, {"oid": "e61004bbfd535d3184bd8bfc27e2637569037ea3", "url": "https://github.com/opensrp/opensrp-client-core/commit/e61004bbfd535d3184bd8bfc27e2637569037ea3", "message": "unit test login interactor unit test", "committedDate": "2020-08-04T08:40:31Z", "type": "commit"}, {"oid": "57a5799dd599477304d2a6e047010f78644866ec", "url": "https://github.com/opensrp/opensrp-client-core/commit/57a5799dd599477304d2a6e047010f78644866ec", "message": "Merge branch 'master' into sg-login-tests", "committedDate": "2020-08-04T08:41:37Z", "type": "commit"}, {"oid": "642816ea0aa999bf81eb0fd47b232557466f4d15", "url": "https://github.com/opensrp/opensrp-client-core/commit/642816ea0aa999bf81eb0fd47b232557466f4d15", "message": "Unit test generic excpetion. Move error messages to strings", "committedDate": "2020-08-04T08:50:21Z", "type": "commit"}, {"oid": "642816ea0aa999bf81eb0fd47b232557466f4d15", "url": "https://github.com/opensrp/opensrp-client-core/commit/642816ea0aa999bf81eb0fd47b232557466f4d15", "message": "Unit test generic excpetion. Move error messages to strings", "committedDate": "2020-08-04T08:50:21Z", "type": "forcePushed"}, {"oid": "da800f7c7bf867212829060ca8d022bf38dc5f7b", "url": "https://github.com/opensrp/opensrp-client-core/commit/da800f7c7bf867212829060ca8d022bf38dc5f7b", "message": "Unit tests all failures during remote login", "committedDate": "2020-08-04T09:15:54Z", "type": "commit"}, {"oid": "f3e227f4b2eecb222166083a9d67b47be0777173", "url": "https://github.com/opensrp/opensrp-client-core/commit/f3e227f4b2eecb222166083a9d67b47be0777173", "message": "unit test login if time if wrong", "committedDate": "2020-08-04T09:41:44Z", "type": "commit"}, {"oid": "dada83d341c0c2805f8d9ca384d4294fea471fa9", "url": "https://github.com/opensrp/opensrp-client-core/commit/dada83d341c0c2805f8d9ca384d4294fea471fa9", "message": "Unit test remote login when timezone if wrong", "committedDate": "2020-08-04T09:49:52Z", "type": "commit"}, {"oid": "95c299fd946c3dd1b825a7a0f66d3aa869ff3cbd", "url": "https://github.com/opensrp/opensrp-client-core/commit/95c299fd946c3dd1b825a7a0f66d3aa869ff3cbd", "message": "Merge branch 'master' into sg-login-tests", "committedDate": "2020-08-05T08:55:25Z", "type": "commit"}, {"oid": "a05469d6c97a6a877838792402b3f6f4e3d2349b", "url": "https://github.com/opensrp/opensrp-client-core/commit/a05469d6c97a6a877838792402b3f6f4e3d2349b", "message": "Merge branch 'master' into sg-login-tests", "committedDate": "2020-08-11T07:05:30Z", "type": "commit"}, {"oid": "3dd7eba23e947d996115825fd8a6710f1f036469", "url": "https://github.com/opensrp/opensrp-client-core/commit/3dd7eba23e947d996115825fd8a6710f1f036469", "message": "Context user service revert to actual userservice after tests are run", "committedDate": "2020-08-11T07:18:58Z", "type": "commit"}, {"oid": "3285ab217e24c68a24d66719d045efdeb455de12", "url": "https://github.com/opensrp/opensrp-client-core/commit/3285ab217e24c68a24d66719d045efdeb455de12", "message": "Verify successful login invokes userservice remote login and navigates to home", "committedDate": "2020-08-11T07:42:11Z", "type": "commit"}, {"oid": "7f54c5af62ae3280bb30ad51678a3d58564577b8", "url": "https://github.com/opensrp/opensrp-client-core/commit/7f54c5af62ae3280bb30ad51678a3d58564577b8", "message": "Unit test reset of app for new teams", "committedDate": "2020-08-11T08:08:36Z", "type": "commit"}, {"oid": "90d8000c58f6947f8d78d32dfe52f3547dd54112", "url": "https://github.com/opensrp/opensrp-client-core/commit/90d8000c58f6947f8d78d32dfe52f3547dd54112", "message": "unit test login should fail for different team", "committedDate": "2020-08-11T08:15:16Z", "type": "commit"}, {"oid": "9ad1fd7e0546b12ceffc893c31e6ac1a8b7a2e3f", "url": "https://github.com/opensrp/opensrp-client-core/commit/9ad1fd7e0546b12ceffc893c31e6ac1a8b7a2e3f", "message": "Test error dispayed from enum", "committedDate": "2020-08-11T08:23:11Z", "type": "commit"}, {"oid": "f979551e7cfa02cf3c8d2e44bd3a54fb4b154ddc", "url": "https://github.com/opensrp/opensrp-client-core/commit/f979551e7cfa02cf3c8d2e44bd3a54fb4b154ddc", "message": "Unit local login navigates to home and releases unique ids", "committedDate": "2020-08-11T08:34:06Z", "type": "commit"}, {"oid": "6347f741c68a363f946729219c2aa4c59ff7a959", "url": "https://github.com/opensrp/opensrp-client-core/commit/6347f741c68a363f946729219c2aa4c59ff7a959", "message": "Unit test local login should trigger remote loggin when timecheck is off", "committedDate": "2020-08-11T08:42:34Z", "type": "commit"}, {"oid": "795f27746e6da2cc6f6daac179f4d1e96877167c", "url": "https://github.com/opensrp/opensrp-client-core/commit/795f27746e6da2cc6f6daac179f4d1e96877167c", "message": "Unit test get flex", "committedDate": "2020-08-11T08:48:25Z", "type": "commit"}, {"oid": "f1d4f08a42aef0dae5d100fb85c1bc37e5230fed", "url": "https://github.com/opensrp/opensrp-client-core/commit/f1d4f08a42aef0dae5d100fb85c1bc37e5230fed", "message": "unit test settings get saved", "committedDate": "2020-08-11T09:08:17Z", "type": "commit"}, {"oid": "f89e778267f4931c028dec3adb6f3fd2dd317110", "url": "https://github.com/opensrp/opensrp-client-core/commit/f89e778267f4931c028dec3adb6f3fd2dd317110", "message": "Set all settings to real object after unit test", "committedDate": "2020-08-11T09:29:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE0NjExNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/619#discussion_r469146115", "bodyText": "Is this supposed to test the exception block in the BaseLoginInteractor#localLogin(WeakReference<BaseLoginContract.View> view, String userName, String password)?", "author": "ekigamba", "createdAt": "2020-08-12T09:57:54Z", "path": "opensrp-app/src/test/java/org/smartregister/login/interactor/BaseLoginInteractorTest.java", "diffHunk": "@@ -0,0 +1,403 @@\n+package org.smartregister.login.interactor;\n+\n+import android.content.DialogInterface;\n+import android.support.v7.app.AppCompatActivity;\n+\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.powermock.reflect.Whitebox;\n+import org.robolectric.Robolectric;\n+import org.robolectric.annotation.Config;\n+import org.smartregister.AllConstants;\n+import org.smartregister.BaseRobolectricUnitTest;\n+import org.smartregister.Context;\n+import org.smartregister.CoreLibrary;\n+import org.smartregister.R;\n+import org.smartregister.SyncConfiguration;\n+import org.smartregister.domain.LoginResponse;\n+import org.smartregister.domain.Setting;\n+import org.smartregister.domain.TimeStatus;\n+import org.smartregister.domain.jsonmapping.LoginResponseData;\n+import org.smartregister.domain.jsonmapping.Time;\n+import org.smartregister.domain.jsonmapping.User;\n+import org.smartregister.listener.OnCompleteClearDataCallback;\n+import org.smartregister.multitenant.ResetAppHelper;\n+import org.smartregister.repository.AllSettings;\n+import org.smartregister.repository.AllSharedPreferences;\n+import org.smartregister.repository.UniqueIdRepository;\n+import org.smartregister.service.UserService;\n+import org.smartregister.shadows.LoginInteractorShadow;\n+import org.smartregister.shadows.ShadowNetworkUtils;\n+import org.smartregister.view.contract.BaseLoginContract;\n+\n+import java.lang.ref.WeakReference;\n+import java.util.Date;\n+import java.util.TimeZone;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyBoolean;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.timeout;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Created by samuelgithengi on 8/4/20.\n+ */\n+\n+public class BaseLoginInteractorTest extends BaseRobolectricUnitTest {\n+\n+    @InjectMocks\n+    private LoginInteractorShadow interactor;\n+\n+    @Mock\n+    private BaseLoginContract.Presenter presenter;\n+\n+    @Mock\n+    private BaseLoginContract.View view;\n+\n+    @Mock\n+    private Context context;\n+\n+    @Mock\n+    private UserService userService;\n+\n+    @Mock\n+    private AllSharedPreferences allSharedPreferences;\n+\n+    @Mock\n+    private SyncConfiguration syncConfiguration;\n+\n+    @Captor\n+    private ArgumentCaptor<DialogInterface.OnClickListener> dialogCaptor;\n+\n+    @Mock\n+    private DialogInterface dialogInterface;\n+\n+    @Mock\n+    private ResetAppHelper resetAppHelper;\n+\n+    @Captor\n+    private ArgumentCaptor<OnCompleteClearDataCallback> onCompleteClearDataCaptor;\n+\n+    @Mock\n+    private UniqueIdRepository uniqueIdRepository;\n+\n+    @Mock\n+    private AllSettings allSettings;\n+\n+    @Captor\n+    private ArgumentCaptor<Setting> settingCaptor;\n+\n+    private AppCompatActivity activity;\n+\n+    private LoginResponseData loginResponseData;\n+\n+    private String user = \"johndoe\";\n+    private String password = \"qwerty\";\n+\n+    private UserService contextUserService;\n+\n+    @Before\n+    public void setUp() {\n+        contextUserService = CoreLibrary.getInstance().context().userService();\n+        when(presenter.getOpenSRPContext()).thenReturn(context);\n+        when(context.allSharedPreferences()).thenReturn(allSharedPreferences);\n+        when(context.userService()).thenReturn(userService);\n+        when(presenter.getLoginView()).thenReturn(view);\n+        activity = Robolectric.buildActivity(AppCompatActivity.class).create().get();\n+        when(view.getActivityContext()).thenReturn(activity);\n+        loginResponseData = new LoginResponseData();\n+        loginResponseData.user = new User().withUsername(user);\n+        loginResponseData.time = new Time(new Date(), TimeZone.getTimeZone(\"Africa/Nairobi\"));\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        Whitebox.setInternalState(CoreLibrary.getInstance().context(), \"userService\", contextUserService);\n+    }\n+\n+    @Test\n+    public void testOnDestroyShouldSetPresenterNull() {\n+        assertNotNull(Whitebox.getInternalState(interactor, \"mLoginPresenter\"));\n+        interactor.onDestroy(false);\n+        assertNull(Whitebox.getInternalState(interactor, \"mLoginPresenter\"));\n+    }\n+\n+    @Test\n+    public void testLoginAttemptsRemoteLoginAndErrorsWithBaseURLIsMissing() {\n+        when(allSharedPreferences.fetchBaseURL(\"\")).thenReturn(\"\");\n+        interactor.login(new WeakReference<>(view), \"johndoe\", \"password\");\n+        verify(view).hideKeyboard();\n+        verify(view).enableLoginButton(false);\n+        verify(allSharedPreferences).savePreference(\"DRISHTI_BASE_URL\", activity.getString(R.string.opensrp_url));\n+        verify(view).enableLoginButton(true);\n+        verify(view).showErrorDialog(activity.getString(R.string.remote_login_base_url_missing_error));\n+        verify(view, never()).goToHome(anyBoolean());\n+    }\n+\n+    @Test\n+    public void testLoginAttemptsRemoteLoginAndErrorsWithGenericError() {", "originalCommit": "f89e778267f4931c028dec3adb6f3fd2dd317110", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcyOTIxNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/619#discussion_r469729215", "bodyText": "Its testing an exception block in org.smartregister.login.interactor.BaseLoginInteractor#remoteLogin this is because getSharedPreferences().fetchBaseURL(\"\").isEmpty()  will throw an NPE since getSharedPreferences is mock", "author": "githengi", "createdAt": "2020-08-13T06:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE0NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1OTMyNA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/619#discussion_r469759324", "bodyText": "Cool", "author": "ekigamba", "createdAt": "2020-08-13T07:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE0NjExNQ=="}], "type": "inlineReview", "revised_code": null}]}