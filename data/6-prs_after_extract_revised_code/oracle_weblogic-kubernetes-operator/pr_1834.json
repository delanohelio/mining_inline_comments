{"pr_number": 1834, "pr_title": "Use kubectl exec to fix a test hanging issue", "pr_createdAt": "2020-07-24T18:18:02Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834", "timeline": [{"oid": "c9eacd638af856b81375a0b4a2ddba874ff6c3f9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c9eacd638af856b81375a0b4a2ddba874ff6c3f9", "message": "use kubectl exec", "committedDate": "2020-07-23T12:13:40Z", "type": "commit"}, {"oid": "100cc852657871e6b0f7dcbf673b02b22e522445", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/100cc852657871e6b0f7dcbf673b02b22e522445", "message": "Merge remote-tracking branch 'origin/develop' into use-kubectl-exec", "committedDate": "2020-07-24T15:35:37Z", "type": "commit"}, {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1ee4961affc415bda1d87595eb39cfa1f5680644", "message": "cleanup", "committedDate": "2020-07-24T17:28:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzU2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460233565", "bodyText": "The podName can differ from the service name.  Should the second 'podName' be converted to DNS 1123?  Alternatively, it could  be changed to \"$SERVICE_NAME\" as I assume the bash command will have access to the pod's env vars...", "author": "tbarnes-us", "createdAt": "2020-07-24T18:58:17Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Application.java", "diffHunk": "@@ -78,6 +80,42 @@ public static boolean appAccessibleInPod(\n       getLogger().warning(String.format(\"Failed to find pod %s to check the app\", podName));\n       return false;\n     }\n-  } \n+  }\n+\n+  /**\n+   * Check if an application is accessible inside a WebLogic server pod.\n+   *\n+   * @param namespace Kubernetes namespace where the WebLogic server pod is running\n+   * @param podName name of the WebLogic server pod\n+   * @param port internal port of the managed server running in the pod\n+   * @param appPath path to access the application\n+   * @param expectedResponse expected response from the app\n+   * @return true if the command succeeds\n+   */\n+  public static boolean appAccessibleInPodKubectl(\n+      String namespace,\n+      String podName,\n+      String port,\n+      String appPath,\n+      String expectedResponse\n+  ) {\n+\n+    // calling \"kubectl exec\" command to access the app inside a pod\n+    String cmd = String.format(\n+        \"kubectl -n %s exec -it %s -- /bin/bash -c 'curl http://%s:%s/%s'\",\n+        namespace,\n+        podName,\n+        podName,", "originalCommit": "1ee4961affc415bda1d87595eb39cfa1f5680644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzc2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460233769", "bodyText": "(DNS 1123 == podName all lower case with \"_\" converted to \"-\")", "author": "tbarnes-us", "createdAt": "2020-07-24T18:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3Mzc5MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460273790", "bodyText": "I totally agree that the code should convert the podName to a legal DNS1123 name. But this pattern is used everywhere in the integration test cases; the assumption is that the test code will not use any non-legal-1123 name as the domainUID, clusterName, managedServerPrefix and etc.  I know this assumption may not be true once more engineers start to write integration test cases.\nDo you want to have a task to do a global fix?  We need to get this change in to fix the hanging issue that impacts everyone that run Jenkins jobs to verify their changes.", "author": "doxiao", "createdAt": "2020-07-24T20:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyMzIwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460323201", "bodyText": "Didn't know that.", "author": "tbarnes-us", "createdAt": "2020-07-24T23:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzU2NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNTk3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460235979", "bodyText": "For other tests, we've needed to have multiple retries for initial curl attempts as tests can sometimes try access an app before it or the service is fully deployed; in addition, it's been helpful to tune the curl command's connection and overall timeouts.", "author": "tbarnes-us", "createdAt": "2020-07-24T19:03:39Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Application.java", "diffHunk": "@@ -78,6 +80,42 @@ public static boolean appAccessibleInPod(\n       getLogger().warning(String.format(\"Failed to find pod %s to check the app\", podName));\n       return false;\n     }\n-  } \n+  }\n+\n+  /**\n+   * Check if an application is accessible inside a WebLogic server pod.\n+   *\n+   * @param namespace Kubernetes namespace where the WebLogic server pod is running\n+   * @param podName name of the WebLogic server pod\n+   * @param port internal port of the managed server running in the pod\n+   * @param appPath path to access the application\n+   * @param expectedResponse expected response from the app\n+   * @return true if the command succeeds\n+   */\n+  public static boolean appAccessibleInPodKubectl(\n+      String namespace,\n+      String podName,\n+      String port,\n+      String appPath,\n+      String expectedResponse\n+  ) {\n+\n+    // calling \"kubectl exec\" command to access the app inside a pod\n+    String cmd = String.format(\n+        \"kubectl -n %s exec -it %s -- /bin/bash -c 'curl http://%s:%s/%s'\",\n+        namespace,\n+        podName,\n+        podName,\n+        port,\n+        appPath);\n+\n+    CommandParams params = Command\n+        .defaultCommandParams()\n+        .command(cmd)\n+        .saveResults(true)\n+        .redirect(false)\n+        .verbose(false);\n+    return Command.withParams(params).executeAndVerify(expectedResponse);", "originalCommit": "1ee4961affc415bda1d87595eb39cfa1f5680644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MzU2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460243565", "bodyText": "For MII sample testing, we use \"--connect-timeout 5 --max-time 20\" and loop the curl command up to 15 times on a failure (5 seconds between each try).", "author": "tbarnes-us", "createdAt": "2020-07-24T19:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2MDkxNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460260917", "bodyText": "The test that uses this assertion has a retry logic at the higher level; this is the pattern used in the Juni5 integration tests.", "author": "doxiao", "createdAt": "2020-07-24T19:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNTk3OQ=="}], "type": "inlineReview", "revised_code": null}]}