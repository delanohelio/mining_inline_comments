{"pr_number": 1574, "pr_title": "Always use the latest release of WDT and Image Tool", "pr_createdAt": "2020-04-17T15:02:46Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574", "timeline": [{"oid": "bf2168cb96911f9894ed0e23d6357891d1ce9dd5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bf2168cb96911f9894ed0e23d6357891d1ce9dd5", "message": "Initial changes for getting the latest version", "committedDate": "2020-04-16T16:56:14Z", "type": "commit"}, {"oid": "6e8350f9afbe5695fc1e56d5e5087f633e7836d0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6e8350f9afbe5695fc1e56d5e5087f633e7836d0", "message": "Get the version number of the latest release of the tools", "committedDate": "2020-04-17T01:57:01Z", "type": "commit"}, {"oid": "9ba62738a4cc570402e061846875c3721e2eb787", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9ba62738a4cc570402e061846875c3721e2eb787", "message": "Merge remote-tracking branch 'origin/develop' into use-latest-tools", "committedDate": "2020-04-17T01:58:57Z", "type": "commit"}, {"oid": "5e4b76c2bcb09efb28e9e171085657d59b005b05", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5e4b76c2bcb09efb28e9e171085657d59b005b05", "message": "Minor updates", "committedDate": "2020-04-17T14:26:56Z", "type": "commit"}, {"oid": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1c02cc41b844df77aca1e323945e5e03f5823ecf", "message": "Minor change in error handling", "committedDate": "2020-04-17T14:59:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNjk4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410506984", "bodyText": "Dongbo, can you give details of when WIT returned a 0 exit code even though image creation failed?  Our tests should not work around bugs in the product.", "author": "rjeberhard", "createdAt": "2020-04-17T22:58:56Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Command.java", "diffHunk": "@@ -46,12 +46,24 @@ public boolean execute() {\n           params.command(), \n           params.redirect(),\n           params.env());\n-      if (result.exitValue() != 0) {\n-        logger.warning(\"The command execution failed with the result: {0}\", result);\n+      if (params.saveStdOut()) {\n+        params.stdOut(result.stdout());\n+      }\n+\n+      // check both exitValue and stderr since sometimes the exitValue was 0 even when\n+      // the test execution failed.", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1MTM3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411051372", "bodyText": "This is not only applicable to the WIT commands This method is used for all command execution such as running a curl command to download the tool, or creating a zip file. I tested a couple of error conditions such as wrong download url, and somehow the exitValue was zero. So I added the additional checks to make sure the code catches the error condition. I myself found this behavior strange/unexpected. Let me test those error conditions one more time tomorrow and see if I did something wrong last week when I did the testing.", "author": "doxiao", "createdAt": "2020-04-20T02:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNjk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM2MzU3MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411363570", "bodyText": "Jus to be clear - I have not seen that a WIT command returned zero exitValue when there was a problem in command execution.", "author": "doxiao", "createdAt": "2020-04-20T13:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNjk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0MjA0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411442048", "bodyText": "I did more testing. In the most of the cases, the exitValue does reflect the execution status. Only in the new getRealVersionIfNeeded method, there were cases that the exitValue is still zero when there was a problem in one of the commands that pipelined together. In those cases, the later check in Installer.java line#99 will catch it and log a severe message. I'll change the code back to only check exitValue.", "author": "doxiao", "createdAt": "2020-04-20T14:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNjk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "a1caee0ac01d28d7b0530a38592ef499597993ae", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Command.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Command.java\nindex 066254ed8d..58fa7b0258 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Command.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Command.java\n\n@@ -50,17 +50,11 @@ public class Command {\n         params.stdOut(result.stdout());\n       }\n \n-      // check both exitValue and stderr since sometimes the exitValue was 0 even when\n-      // the test execution failed.\n-      if (params.redirect()\n-          && (result.exitValue() != 0 \n-              || result.stderr() != null \n-                  && result.stderr().length() != 0)\n-                  && !result.stderr().contains(\"INFO\")\n-                  && result.stderr().contains(\"error\")) {\n-        logger.warning(\"The command execution might have failed because it returned something in the stderr: {0}.\",\n-            result);\n-      }\n+      // check exitValue to determine if the command execution has failed.\n+      if (result.exitValue() != 0) {\n+        logger.severe(\"The command execution failed because it returned non-zero exit value: {0}.\", result);\n+      } \n+\n       return result.exitValue() == 0;\n     } catch (IOException | InterruptedException ie) {\n       logger.severe(\"The command execution failed\", ie);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzUyNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410507526", "bodyText": "I don't understand what this check is ensuring.", "author": "rjeberhard", "createdAt": "2020-04-17T23:01:11Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java", "diffHunk": "@@ -80,13 +85,23 @@ private Installer params(InstallParams params) {\n    * @return true if the command succeeds \n    */\n   public boolean download() {\n+ \n     boolean downloadSucceeded = true;\n     boolean unzipSucceeded = true;\n     if (params.verify()\n         && new File(DOWNLOAD_DIR, params.fileName()).exists()) {\n       logger.info(\"File {0} already exists.\", params.fileName());\n     } else {\n+      // check and make sure DOWNLOAD_DIR exists; will create it if it is missing\n       checkDirectory(DOWNLOAD_DIR);\n+      \n+      // we check if we get the version of the tool correctly first\n+      if (params.version() == null \n+          || params.version().length() == 0\n+          || params.version().equalsIgnoreCase(\"latest\")) {\n+        logger.severe(\"Failed to get the latest version of {0}\", params.type());", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1MzcxNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411053716", "bodyText": "When the params.version() method is called the first time,  it (unexpectedly, as you indicated below) performs some additional operations to find out the release number of the \"latest\" by calling getRealVersionIfNeeded(). Method getRealVersionIfNeeded may return null. This checks ensure that we did get the real version, and the code returns false to indicate a failure if finding the real version somehow failed.", "author": "doxiao", "createdAt": "2020-04-20T02:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzUyNg=="}], "type": "inlineReview", "revised_code": {"commit": "a1caee0ac01d28d7b0530a38592ef499597993ae", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\nindex 6c7dc82ccf..09fd965137 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n\n@@ -81,7 +81,7 @@ public class Installer {\n   }\n \n   /**\n-   * Download and install the tool using the params\n+   * Download and install the tool using the params.\n    * @return true if the command succeeds \n    */\n   public boolean download() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzc3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410507772", "bodyText": "This looks like a simple fluent getter but is doing a lot more.  Let's make the method more descriptive of what is going on.", "author": "rjeberhard", "createdAt": "2020-04-17T23:02:27Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/InstallParams.java", "diffHunk": "@@ -49,6 +49,7 @@ public InstallParams version(String version) {\n   }\n \n   public String version() {\n+    version = Installer.getActualVersionIfNeeded(location, type, version);", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1Mzk4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411053984", "bodyText": "Okay", "author": "doxiao", "createdAt": "2020-04-20T02:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzc3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6b7af19ec9e0b365801eec60d0ef6889c0d5f8d5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/InstallParams.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/InstallParams.java\nindex bd4ae779d3..35b5ea07b1 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/InstallParams.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/InstallParams.java\n\n@@ -49,7 +49,6 @@ public class InstallParams {\n   }\n \n   public String version() {\n-    version = Installer.getActualVersionIfNeeded(location, type, version);\n     return version;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzgyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410507828", "bodyText": "javadoc", "author": "rjeberhard", "createdAt": "2020-04-17T23:02:42Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java", "diffHunk": "@@ -122,4 +137,45 @@ private String buildDownloadCommand() {\n         params.fileName());\n     return command;\n   }\n+\n+  // Figure out the actual release number of the latest", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a1caee0ac01d28d7b0530a38592ef499597993ae", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\nindex 6c7dc82ccf..09fd965137 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n\n@@ -138,7 +138,12 @@ public class Installer {\n     return command;\n   }\n \n-  // Figure out the actual release number of the latest\n+  /**\n+   * Figure out the actual version number of the latest release of WDT or WIT if the version\n+   * parameter is not specified or is specified as \"latest\". The passed in version value is\n+   * return otherwise.\n+   * @return the version number that is requested\n+   */\n   static String getActualVersionIfNeeded(\n       String location,\n       String type,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODIxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410508214", "bodyText": "What does it mean to return null here?  If the command fails isn't that a bigger issue?", "author": "rjeberhard", "createdAt": "2020-04-17T23:04:14Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java", "diffHunk": "@@ -122,4 +137,45 @@ private String buildDownloadCommand() {\n         params.fileName());\n     return command;\n   }\n+\n+  // Figure out the actual release number of the latest\n+  static String getActualVersionIfNeeded(\n+      String location,\n+      String type,\n+      String version\n+  ) {\n+    if (version == null || version.equalsIgnoreCase(\"latest\")) {\n+      String command = String.format(\n+          \"curl -fL %s/releases/latest -o %s/%s-%s\", \n+          location,\n+          DOWNLOAD_DIR,\n+          type,\n+          TMP_FILE_NAME);\n+      \n+      if (!Command.withParams(defaultCommandParams().command(command)).execute()) {\n+        return null;", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1NTEyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411055125", "bodyText": "As I mentioned in the earlier responses, returning null is a way to tell the caller that this failed and I don't have a real version to give you. The caller will log a severe message, and return false to indicate a failure condition (see Installer.java line #99). The failure usually does not accompanied by an exception. We could manufacture an exception and throw here, but I am not sure what exception to throw other than a RuntimeException.", "author": "doxiao", "createdAt": "2020-04-20T02:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0MzYxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411443610", "bodyText": "Keep in mind we are trying to make it clear for the \"next\" person.  If I understand this correctly, I think throwing an exception is clearer that \"things are not working as expected\".  Create a new exception class if it helps make things more clear.", "author": "ddsharpe", "createdAt": "2020-04-20T14:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyNjEwNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r411526107", "bodyText": "Agreed. working on a change.", "author": "doxiao", "createdAt": "2020-04-20T16:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODIxNA=="}], "type": "inlineReview", "revised_code": {"commit": "a1caee0ac01d28d7b0530a38592ef499597993ae", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\nindex 6c7dc82ccf..09fd965137 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n\n@@ -138,7 +138,12 @@ public class Installer {\n     return command;\n   }\n \n-  // Figure out the actual release number of the latest\n+  /**\n+   * Figure out the actual version number of the latest release of WDT or WIT if the version\n+   * parameter is not specified or is specified as \"latest\". The passed in version value is\n+   * return otherwise.\n+   * @return the version number that is requested\n+   */\n   static String getActualVersionIfNeeded(\n       String location,\n       String type,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODI4MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r410508281", "bodyText": "Same comment", "author": "rjeberhard", "createdAt": "2020-04-17T23:04:30Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java", "diffHunk": "@@ -122,4 +137,45 @@ private String buildDownloadCommand() {\n         params.fileName());\n     return command;\n   }\n+\n+  // Figure out the actual release number of the latest\n+  static String getActualVersionIfNeeded(\n+      String location,\n+      String type,\n+      String version\n+  ) {\n+    if (version == null || version.equalsIgnoreCase(\"latest\")) {\n+      String command = String.format(\n+          \"curl -fL %s/releases/latest -o %s/%s-%s\", \n+          location,\n+          DOWNLOAD_DIR,\n+          type,\n+          TMP_FILE_NAME);\n+      \n+      if (!Command.withParams(defaultCommandParams().command(command)).execute()) {\n+        return null;\n+      }\n+\n+      command = String.format(\n+          \"cat %s/%s-%s | grep 'releases/download' | awk '{ split($0,a,/href=\\\"/);%s | %s\", \n+          DOWNLOAD_DIR, \n+          type, \n+          TMP_FILE_NAME, \n+          \" print a[2] }'\", \n+          \" cut -d/ -f 6\"); \n+    \n+      CommandParams params = \n+          defaultCommandParams()\n+          .command(command)\n+          .saveStdOut(true)\n+          .redirect(true);\n+\n+      if (Command.withParams(params).execute()) {\n+        return params.stdOut();\n+      } else {\n+        return null;", "originalCommit": "1c02cc41b844df77aca1e323945e5e03f5823ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI3OTMzMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1574#discussion_r412279331", "bodyText": "fixed with a severe log message and throwing a RuntimeException. The caller catches the exception and returns false to fail the test case.", "author": "doxiao", "createdAt": "2020-04-21T15:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODI4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a1caee0ac01d28d7b0530a38592ef499597993ae", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\nindex 6c7dc82ccf..09fd965137 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Installer.java\n\n@@ -138,7 +138,12 @@ public class Installer {\n     return command;\n   }\n \n-  // Figure out the actual release number of the latest\n+  /**\n+   * Figure out the actual version number of the latest release of WDT or WIT if the version\n+   * parameter is not specified or is specified as \"latest\". The passed in version value is\n+   * return otherwise.\n+   * @return the version number that is requested\n+   */\n   static String getActualVersionIfNeeded(\n       String location,\n       String type,\n"}}, {"oid": "a1caee0ac01d28d7b0530a38592ef499597993ae", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a1caee0ac01d28d7b0530a38592ef499597993ae", "message": "Remove additional checks of the stderr on command execution result and add javadoc to the new method", "committedDate": "2020-04-20T14:53:18Z", "type": "commit"}, {"oid": "6b7af19ec9e0b365801eec60d0ef6889c0d5f8d5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6b7af19ec9e0b365801eec60d0ef6889c0d5f8d5", "message": "Change return null to throw runtime exception", "committedDate": "2020-04-20T17:51:30Z", "type": "commit"}, {"oid": "002eceee4069ab5d26259feeb38c98fdb5417ee4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/002eceee4069ab5d26259feeb38c98fdb5417ee4", "message": "Cleanup", "committedDate": "2020-04-20T17:57:41Z", "type": "commit"}, {"oid": "d47316f3c9178966c0ddd463345f428a4f6fb485", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d47316f3c9178966c0ddd463345f428a4f6fb485", "message": "Merge remote-tracking branch 'origin/develop' into use-latest-tools", "committedDate": "2020-04-20T18:07:10Z", "type": "commit"}]}