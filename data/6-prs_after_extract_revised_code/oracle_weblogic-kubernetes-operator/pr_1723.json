{"pr_number": 1723, "pr_title": "changes for OWLS-82320 - Recieve API error and operator restarts when namespaces is removed", "pr_createdAt": "2020-06-10T21:25:59Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723", "timeline": [{"oid": "8a5f4c57e33d422f60efc25eec0b1ef0a7a25b89", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8a5f4c57e33d422f60efc25eec0b1ef0a7a25b89", "message": "changes for OWLS-82320 - Recieve API error and operator restarts when namespaces is removed", "committedDate": "2020-06-10T19:42:14Z", "type": "commit"}, {"oid": "7144add48458d0cf2b7521c02056ae73d318eaa5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7144add48458d0cf2b7521c02056ae73d318eaa5", "message": "change to execute start namespaces step in async call failure case", "committedDate": "2020-06-10T21:06:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNjc5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r438826795", "bodyText": "If I understand the change correctly, domain CRD creation and  start namespaces logic are associated with readExistingNamespaces(), which is skipped in the dedicated mode. Does that mean in dedicated mode, CRD and domains will not be created? I may have missed something. Have you tested dedicated mode use cases?", "author": "doxiao", "createdAt": "2020-06-11T14:26:22Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Main.java", "diffHunk": "@@ -191,11 +192,9 @@ private static void begin() {\n \n       Step strategy = Step.chain(\n           new InitializeNamespacesSecurityStep(targetNamespaces),\n-          new NamespaceRulesReviewStep(),\n-          CrdHelper.createDomainCrdStep(version,\n-              new StartNamespacesStep(targetNamespaces, false)));\n+          new NamespaceRulesReviewStep());\n       if (!isDedicated()) {\n-        strategy = Step.chain(strategy, readExistingNamespaces());\n+        strategy = Step.chain(strategy, readExistingNamespaces(targetNamespaces));", "originalCommit": "7144add48458d0cf2b7521c02056ae73d318eaa5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0MDY3NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r438840675", "bodyText": "Thanks Dongbo. I'm trying to run integration tests in external jenkins with my changes and seeing some failures. I'm not sure if failures are related to my change or intermittent env issue. I'm also trying to run tests in my machine but seeing a different issue regarding JAVA_HOME.  Do you know if there are any integration test for dedicated mode?", "author": "ankedia", "createdAt": "2020-06-11T14:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNjc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxMjE4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r438912189", "bodyText": "Hi Dongbo, I have adjusted the change for dedicated mode as we discussed. Please let me know if you see something missing. I'll also try running tests for dedicated mode use-case. Thanks again for your comment and catching this.", "author": "ankedia", "createdAt": "2020-06-11T16:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNjc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwODAyNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439008026", "bodyText": "The modified code here looks good.", "author": "doxiao", "createdAt": "2020-06-11T19:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNjc5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "e6e63b68245e07a8e0fd431363aad619c1e579cc", "chunk": "diff --git a/operator/src/main/java/oracle/kubernetes/operator/Main.java b/operator/src/main/java/oracle/kubernetes/operator/Main.java\nindex 5ba48729f8..b70d5a0644 100644\n--- a/operator/src/main/java/oracle/kubernetes/operator/Main.java\n+++ b/operator/src/main/java/oracle/kubernetes/operator/Main.java\n\n@@ -195,6 +195,9 @@ public class Main {\n           new NamespaceRulesReviewStep());\n       if (!isDedicated()) {\n         strategy = Step.chain(strategy, readExistingNamespaces(targetNamespaces));\n+      } else {\n+        strategy = Step.chain(strategy, CrdHelper.createDomainCrdStep(version,\n+                new StartNamespacesStep(targetNamespaces, false)));\n       }\n       runSteps(\n           strategy,\n"}}, {"oid": "e6e63b68245e07a8e0fd431363aad619c1e579cc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e6e63b68245e07a8e0fd431363aad619c1e579cc", "message": "changes for dedicated mode", "committedDate": "2020-06-11T16:15:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzcyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439007728", "bodyText": "recheckDomains method also has similar filtering logic. Can yon double check and see if the logic there takes care of non-existent namespaces correctly as well?", "author": "doxiao", "createdAt": "2020-06-11T19:05:09Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Main.java", "diffHunk": "@@ -858,24 +866,63 @@ public NextAction onFailure(Packet packet, CallResponse<V1NamespaceList> callRes\n     @Override\n     protected NextAction onFailureNoRetry(Packet packet, CallResponse<V1NamespaceList> callResponse) {\n       return isNotAuthorizedOrForbidden(callResponse)\n-          ? doNext(packet) : super.onFailureNoRetry(packet, callResponse);\n+          ? doNext(createDomainCrdAndStartNamespaces(targetNamespaces), packet) : \n+            super.onFailureNoRetry(packet, callResponse);\n     }\n \n     @Override\n     public NextAction onSuccess(Packet packet, CallResponse<V1NamespaceList> callResponse) {\n       V1NamespaceList result = callResponse.getResult();\n       // don't bother processing pre-existing events\n-\n-      if (namespaceWatcher == null) {\n-        namespaceWatcher = createNamespaceWatcher(getInitialResourceVersion(result));\n+      String intialResourceVersion = getInitialResourceVersion(result);\n+      List<String> nsList = getExistingNamespaces(result);\n+      \n+      Set<String> namespacesToStart = new TreeSet<>(targetNamespaces);\n+      for (String ns : targetNamespaces) {\n+        if (!nsList.contains(ns)) {\n+          namespacesToStart.remove(ns);\n+        }", "originalCommit": "e6e63b68245e07a8e0fd431363aad619c1e579cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQwNjU4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439406589", "bodyText": "My understanding is that recheckDomains runs periodically and it takes care of non-existing namespaces except in full recheck case. It also checks for namespaces that are removed from operator's targetNamespaces list or that are deleted from k8s cluster and stops those namespaces. In case of full recheck (which happens every 2 min), it'll attempt to start all namespaces in targetNamespaces (including non-existing ns). However, I believe that doesn't cause liveness probe failure since it's executed in a thread separate from main thread.", "author": "ankedia", "createdAt": "2020-06-12T13:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3ODE4Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439478187", "bodyText": "Shall we add a log (warning?) message when we detect that a namespace that is in the target namespace but does not exist?\nWe may also want to add test cases for different lifecycle sequences of namespaces w.r.t targetNamesapces. For example, a namespace that is in the targetNamespaces but does not exist initially, but is added while the operator is running or not running (and later starts to run). There are multiple permutations to be tested.  If we agree that those test cases are needed, we need to create a task to track it.", "author": "doxiao", "createdAt": "2020-06-12T15:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NTg0OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439555849", "bodyText": "Yes, I have added a warning message when we detect that a namespace that is in target namespace but doesn't exist. Adding test cases for different lifecycle sequences of namespaces is a good idea. I'll check on that. Thanks.", "author": "ankedia", "createdAt": "2020-06-12T17:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNzcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "b937cf262bf2cbc21a480aed900b240417eacb2f", "chunk": "diff --git a/operator/src/main/java/oracle/kubernetes/operator/Main.java b/operator/src/main/java/oracle/kubernetes/operator/Main.java\nindex b70d5a0644..fd78a49e73 100644\n--- a/operator/src/main/java/oracle/kubernetes/operator/Main.java\n+++ b/operator/src/main/java/oracle/kubernetes/operator/Main.java\n\n@@ -883,8 +883,13 @@ public class Main {\n           namespacesToStart.remove(ns);\n         }\n       }\n-      Step strategy = Step.chain(createDomainCrdAndStartNamespaces(namespacesToStart),\n+      Step strategy = null;\n+      if (!namespacesToStart.isEmpty()) {\n+        strategy = Step.chain(createDomainCrdAndStartNamespaces(namespacesToStart),\n               new CreateNamespaceWatcherStep(intialResourceVersion));\n+      } else {\n+        strategy = new CreateNamespaceWatcherStep(intialResourceVersion);\n+      }\n       return doNext(strategy, packet);\n     }\n     \n"}}, {"oid": "b937cf262bf2cbc21a480aed900b240417eacb2f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b937cf262bf2cbc21a480aed900b240417eacb2f", "message": "Handle empty list for namespaces to start", "committedDate": "2020-06-12T00:25:31Z", "type": "commit"}, {"oid": "aeb38ccc753c5ddaef2d3d0c7d05f6eba2cfb874", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/aeb38ccc753c5ddaef2d3d0c7d05f6eba2cfb874", "message": "changes to log a warning when namespace is target namespace and doesn't exist and a minor fix.", "committedDate": "2020-06-12T17:32:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NTE2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439575160", "bodyText": "Sorry, I did not notice this earlier.\nI am not sure what this change is for. It tries to create domain CRD and start the namespaces if isNotAuthorizedOrForbidden() returns true. Not sure this is correct. in addition, this change does not seem to relate to non-existing namespaces.", "author": "doxiao", "createdAt": "2020-06-12T18:18:53Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Main.java", "diffHunk": "@@ -858,24 +866,70 @@ public NextAction onFailure(Packet packet, CallResponse<V1NamespaceList> callRes\n     @Override\n     protected NextAction onFailureNoRetry(Packet packet, CallResponse<V1NamespaceList> callResponse) {\n       return isNotAuthorizedOrForbidden(callResponse)\n-          ? doNext(packet) : super.onFailureNoRetry(packet, callResponse);\n+          ? doNext(createDomainCrdAndStartNamespaces(targetNamespaces), packet) : ", "originalCommit": "aeb38ccc753c5ddaef2d3d0c7d05f6eba2cfb874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MTA2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439581060", "bodyText": "Previously create domain CRD and start namespaces steps were called before the async call to read existing namespaces (unconditionally). I made this change to cover the case where  async call fails and comes to \"onFailureNoRetry\" after multiple retries. We still execute create domain CRD and start namespaces steps before executing next step. If failure is due to some reason other than 401 or 403, it calls \"super.onFailureNoRetry\". I'm not sure if calling create domain CRD and start namespaces steps will be useful here. The async call is just to read  existing namespaces and if it fails and goes to onFailureNoRetry after multiple retries, there's some fundamental problem with cluster.\n@rjeberhard and @doxiao  - Please let me know if this looks incorrect or if you have any suggestions. Thanks.", "author": "ankedia", "createdAt": "2020-06-12T18:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NTE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0MTQ2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439641462", "bodyText": "Just had a discussion with Ryan about this change and it looks fine. Namespace is global k8s resource and some customers don't want operator to have permission on global resources. So we still want to go ahead and create CRD and start namespaces when API call to list namespaces fails due to authorization error. In other failure cases, operator pod liveness probe will fail and pod will be restarted by kubernetes. So create domain CRD and start namespace will be executed when pod restarts.", "author": "ankedia", "createdAt": "2020-06-12T21:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NTE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NDM1NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1723#discussion_r439644354", "bodyText": "Okay. It sounds fine. thanks.", "author": "doxiao", "createdAt": "2020-06-12T21:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NTE2MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1acd7e8c6a3747df0871f39edb9ab794c644e5ff", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1acd7e8c6a3747df0871f39edb9ab794c644e5ff", "message": "Merge remote-tracking branch 'origin/develop' into OWLS-82320", "committedDate": "2020-06-16T19:31:39Z", "type": "commit"}]}