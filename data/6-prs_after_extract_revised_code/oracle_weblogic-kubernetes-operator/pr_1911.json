{"pr_number": 1911, "pr_title": "OWLS-80038 and OWLS-80090: fix mountPath validation and token substitution", "pr_createdAt": "2020-09-11T20:30:46Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911", "timeline": [{"oid": "6708b72048961cf7f57e4606c5b69acce229a6e6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6708b72048961cf7f57e4606c5b69acce229a6e6", "message": "Skip volume mount path validation if it contains valid tokens", "committedDate": "2020-09-04T17:33:06Z", "type": "commit"}, {"oid": "30a984372a0d782422e704fe4ea6f1f05faa75bd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/30a984372a0d782422e704fe4ea6f1f05faa75bd", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath", "committedDate": "2020-09-04T19:21:05Z", "type": "commit"}, {"oid": "b6c637399bb557364fe3dada56f4b5e642754c73", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b6c637399bb557364fe3dada56f4b5e642754c73", "message": "Check admin serverPod's additional volume mount paths too in domain validation", "committedDate": "2020-09-08T17:28:57Z", "type": "commit"}, {"oid": "e2e203248838313c260d9d04fc4dd826d7858f97", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e2e203248838313c260d9d04fc4dd826d7858f97", "message": "Check cluster serverPod's additional mount paths too in domain validation", "committedDate": "2020-09-08T19:40:21Z", "type": "commit"}, {"oid": "e0c64e624e5bf26a20dc522f79d7367b064ee4ae", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e0c64e624e5bf26a20dc522f79d7367b064ee4ae", "message": "check mountpath validation after token substitution is performed", "committedDate": "2020-09-10T17:32:01Z", "type": "commit"}, {"oid": "2f5244e23d10f0f12acc64cda2fb47f41214a832", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2f5244e23d10f0f12acc64cda2fb47f41214a832", "message": "cleanup", "committedDate": "2020-09-10T20:07:28Z", "type": "commit"}, {"oid": "80ac79d6a2959427c9533165ae3ecdd3da6b254b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/80ac79d6a2959427c9533165ae3ecdd3da6b254b", "message": "fine tuning", "committedDate": "2020-09-10T20:51:23Z", "type": "commit"}, {"oid": "3f1f8ce088f13ada9b132424e4c57619006ef0e3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3f1f8ce088f13ada9b132424e4c57619006ef0e3", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath", "committedDate": "2020-09-10T20:53:13Z", "type": "commit"}, {"oid": "1127e4778dc73b142472051d200416484c5da5da", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1127e4778dc73b142472051d200416484c5da5da", "message": "minor cleanup", "committedDate": "2020-09-10T21:00:42Z", "type": "commit"}, {"oid": "568ff48197becbcf77dfdafe45f3942ace5f79e9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/568ff48197becbcf77dfdafe45f3942ace5f79e9", "message": "In progress", "committedDate": "2020-09-11T14:25:29Z", "type": "commit"}, {"oid": "1831620d4bbad374fd15113838859b2251ae24b9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1831620d4bbad374fd15113838859b2251ae24b9", "message": "WIP", "committedDate": "2020-09-11T16:43:34Z", "type": "commit"}, {"oid": "cc9df985719f7a1969e30051bc472ca309e453cf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cc9df985719f7a1969e30051bc472ca309e453cf", "message": "minor change", "committedDate": "2020-09-11T20:06:51Z", "type": "commit"}, {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/877de6f1ee9e08e9361a0f1f8909a5bbd042afdd", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath", "committedDate": "2020-09-14T14:10:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNzAxOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#discussion_r488927018", "bodyText": "Should this test be named ..._jobNotCreated rather than ..._reportValidationError?", "author": "alai8", "createdAt": "2020-09-15T19:40:24Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java", "diffHunk": "@@ -441,6 +444,55 @@ public void introspectorPodStartupWithNullAdminUsernamePasswordEnvVarValues() {\n         getConfiguredDomainSpec(domainConfigurator).getEnv(), hasEnvVar(\"item1\", RAW_VALUE_1));\n   }\n \n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithReservedVariables_createIntrospectorPodWithSubstitutions() {\n+    configureDomain()\n+        .withAdditionalVolumeMount(\"volume2\", \"/source-$(DOMAIN_UID)\");\n+    runCreateJob();\n+    assertThat(\n+        job.getSpec().getTemplate().getSpec().getContainers().get(0).getVolumeMounts(),\n+        hasVolumeMount(\"volume2\", \"/source-\" + UID));\n+  }\n+\n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithCustomVariables_createIntrospectorPodWithSubstitutions() {\n+    resourceLookup.defineResource(SECRET_NAME, KubernetesResourceType.Secret, NS);\n+    resourceLookup.defineResource(OVERRIDES_CM_NAME_MODEL, KubernetesResourceType.ConfigMap, NS);\n+    resourceLookup.defineResource(OVERRIDES_CM_NAME_IMAGE, KubernetesResourceType.ConfigMap, NS);\n+\n+    configureDomain()\n+        .withEnvironmentVariable(ENV_NAME1, GOOD_MY_ENV_VALUE)\n+        .withWebLogicCredentialsSecret(SECRET_NAME, null)\n+        .withAdditionalVolume(\"volume1\", VOLUME_PATH_1)\n+        .withAdditionalVolumeMount(\"volume1\", VOLUME_MOUNT_PATH_1);\n+\n+    runCreateJob();\n+\n+    assertThat(job.getSpec().getTemplate().getSpec().getContainers().get(0).getVolumeMounts(),\n+            hasVolumeMount(\"volume1\", END_VOLUME_MOUNT_PATH_1));\n+  }\n+\n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithCustomVariablesInvalidValue_reportValidationError() {", "originalCommit": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MTE3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#discussion_r488951178", "bodyText": "sure. thanks!", "author": "doxiao", "createdAt": "2020-09-15T20:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNzAxOA=="}], "type": "inlineReview", "revised_code": {"commit": "d5d2455e173486eecfba30397dc8649a339b8b64", "chunk": "diff --git a/operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java b/operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java\nindex 361ce3c383..14268eac0f 100644\n--- a/operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java\n+++ b/operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java\n\n@@ -473,7 +473,7 @@ public class JobHelperTest extends DomainValidationBaseTest {\n   }\n \n   @Test\n-  public void whenDomainHasAdditionalVolumesWithCustomVariablesInvalidValue_reportValidationError() {\n+  public void whenDomainHasAdditionalVolumesWithCustomVariablesInvalidValue_jobNotCreated() {\n     resourceLookup.defineResource(SECRET_NAME, KubernetesResourceType.Secret, NS);\n     resourceLookup.defineResource(OVERRIDES_CM_NAME_MODEL, KubernetesResourceType.ConfigMap, NS);\n     resourceLookup.defineResource(OVERRIDES_CM_NAME_IMAGE, KubernetesResourceType.ConfigMap, NS);\n"}}, {"oid": "d5d2455e173486eecfba30397dc8649a339b8b64", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d5d2455e173486eecfba30397dc8649a339b8b64", "message": "Modify a test name", "committedDate": "2020-09-15T20:21:38Z", "type": "commit"}]}