{"pr_number": 1914, "pr_title": "Pod shutdown tests porting", "pr_createdAt": "2020-09-12T04:39:24Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914", "timeline": [{"oid": "4858bc156ebe8847792cba3dd0061559375a815d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4858bc156ebe8847792cba3dd0061559375a815d", "message": "Fix the shutdown options", "committedDate": "2020-09-03T18:24:07Z", "type": "commit"}, {"oid": "e66f8b6f6f8ec56e8560df60b1765aa79ee69a77", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e66f8b6f6f8ec56e8560df60b1765aa79ee69a77", "message": "Merge branch 'develop' into podshutdown-tests", "committedDate": "2020-09-08T17:01:42Z", "type": "commit"}, {"oid": "98f27adfee3b8ccced4b09cec60c4269acd3d9cd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/98f27adfee3b8ccced4b09cec60c4269acd3d9cd", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podshutdown-tests", "committedDate": "2020-09-09T18:29:32Z", "type": "commit"}, {"oid": "c5d8eeee9bd0dc48e4b989510b33d95286b9c838", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c5d8eeee9bd0dc48e4b989510b33d95286b9c838", "message": "Adding shutdown option tests", "committedDate": "2020-09-09T21:33:08Z", "type": "commit"}, {"oid": "8dd9e95cd4675c2fdbea76ab0d30c3e5295609dc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8dd9e95cd4675c2fdbea76ab0d30c3e5295609dc", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podshutdown-tests", "committedDate": "2020-09-11T16:15:57Z", "type": "commit"}, {"oid": "a545a81738e43747e07224577490adf5d579f17d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a545a81738e43747e07224577490adf5d579f17d", "message": "Fix log location", "committedDate": "2020-09-11T17:09:57Z", "type": "commit"}, {"oid": "e12e57a3aa3d37e01cf394b34569e8bc4572fd35", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e12e57a3aa3d37e01cf394b34569e8bc4572fd35", "message": "fix shutdown object assignment", "committedDate": "2020-09-11T17:41:41Z", "type": "commit"}, {"oid": "984ddd3c18ebb20f494c8f6aa9608156681d8707", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/984ddd3c18ebb20f494c8f6aa9608156681d8707", "message": "Add ind ms", "committedDate": "2020-09-11T19:09:40Z", "type": "commit"}, {"oid": "f4a518a5329d3a96f99f348c314b9d778a812cce", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f4a518a5329d3a96f99f348c314b9d778a812cce", "message": "fix start policy", "committedDate": "2020-09-11T19:20:02Z", "type": "commit"}, {"oid": "e044ecfe687d7cbe075098d8197c3a601f8374e5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e044ecfe687d7cbe075098d8197c3a601f8374e5", "message": "wip", "committedDate": "2020-09-11T20:31:36Z", "type": "commit"}, {"oid": "05fe83612093549eced1b6111c33eef4d5e84c64", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/05fe83612093549eced1b6111c33eef4d5e84c64", "message": "wip", "committedDate": "2020-09-11T20:32:41Z", "type": "commit"}, {"oid": "aa9bc3e07fc6995d8bfc90607956820a24a7c000", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/aa9bc3e07fc6995d8bfc90607956820a24a7c000", "message": "wip", "committedDate": "2020-09-11T20:42:48Z", "type": "commit"}, {"oid": "042d1aff4144899607c0e09ef5d4023d19259f17", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/042d1aff4144899607c0e09ef5d4023d19259f17", "message": "wip", "committedDate": "2020-09-11T20:48:56Z", "type": "commit"}, {"oid": "994b805f97be9d88bb482124640531bff194426d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/994b805f97be9d88bb482124640531bff194426d", "message": "wip", "committedDate": "2020-09-11T21:23:53Z", "type": "commit"}, {"oid": "bcdcf4b29b53f98e75d3b1fb2e21a720fd13ebfe", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bcdcf4b29b53f98e75d3b1fb2e21a720fd13ebfe", "message": "Add tests without env override", "committedDate": "2020-09-11T22:17:40Z", "type": "commit"}, {"oid": "bfa8fb72ffa0976263e1693a2288e5f620debc67", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bfa8fb72ffa0976263e1693a2288e5f620debc67", "message": "add debug messages", "committedDate": "2020-09-11T22:36:35Z", "type": "commit"}, {"oid": "60d4ac21912f4082e492ea0897fd6c94ff93634f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/60d4ac21912f4082e492ea0897fd6c94ff93634f", "message": "refactor code", "committedDate": "2020-09-11T23:25:12Z", "type": "commit"}, {"oid": "73c88d3dea4e35e4b5c620185a3768c2794aafb2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/73c88d3dea4e35e4b5c620185a3768c2794aafb2", "message": "check for in ms 2", "committedDate": "2020-09-11T23:32:04Z", "type": "commit"}, {"oid": "c82d9ef2869197317c1430e99f5b88d2c11b92a7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c82d9ef2869197317c1430e99f5b88d2c11b92a7", "message": "Fix pod name", "committedDate": "2020-09-11T23:54:45Z", "type": "commit"}, {"oid": "6569128cb0ce6355f60eb804b55267be943e88b7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6569128cb0ce6355f60eb804b55267be943e88b7", "message": "fix pod name", "committedDate": "2020-09-12T02:12:41Z", "type": "commit"}, {"oid": "8ebfc2a7f2a1d10b95d02cf45e3ca3ea9d56035a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8ebfc2a7f2a1d10b95d02cf45e3ca3ea9d56035a", "message": "Cleaned up comments and updated javadocs", "committedDate": "2020-09-12T04:29:54Z", "type": "commit"}, {"oid": "c6339ad6dc1d3257eeeb5474c181b3ff50d25c14", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c6339ad6dc1d3257eeeb5474c181b3ff50d25c14", "message": "Removed JUnit4 test class", "committedDate": "2020-09-12T04:31:33Z", "type": "commit"}, {"oid": "70969ce951ff8da59b24a26d0e2e83e37fba6254", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/70969ce951ff8da59b24a26d0e2e83e37fba6254", "message": "Restore updatedomainconfig it class", "committedDate": "2020-09-12T04:45:04Z", "type": "commit"}, {"oid": "8d53ae69a460818da1f11455f07d8c5e824bf1d2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8d53ae69a460818da1f11455f07d8c5e824bf1d2", "message": "fix the yaml formatting", "committedDate": "2020-09-12T05:02:06Z", "type": "commit"}, {"oid": "561fa6cf890adf0462e6c86907afbaf371e177ea", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/561fa6cf890adf0462e6c86907afbaf371e177ea", "message": "Remove left over files", "committedDate": "2020-09-12T05:10:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwOTM0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488209348", "bodyText": "Shutdown Object is a the name of the java Object. Can we explain the usecase in term of shutdown option that reflects the public document.  NodeManger is internal tools in WKO.  We should not expose in our usecase. Anyhow what is the nodemanager env we are looking here ?", "author": "anpanigr", "createdAt": "2020-09-14T20:45:22Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -156,15 +118,127 @@ private static void createAndVerifyMiiDomain() {\n \n     // create secret for admin credentials\n     logger.info(\"Creating secret for admin credentials\");\n-    String adminSecretName = \"weblogic-credentials\";\n+    adminSecretName = \"weblogic-credentials\";\n     createSecretWithUsernamePassword(adminSecretName, domainNamespace, \"weblogic\", \"welcome1\");\n \n     // create encryption secret\n     logger.info(\"Creating encryption secret\");\n-    String encryptionSecretName = \"encryptionsecret\";\n+    encryptionSecretName = \"encryptionsecret\";\n     createSecretWithUsernamePassword(encryptionSecretName, domainNamespace, \"weblogicenc\", \"weblogicenc\");\n \n-    // create the domain CR\n+    String yamlString = \"topology:\\n\"\n+        + \"  Server:\\n\"\n+        + \"    'ms-1':\\n\"\n+        + \"      ListenPort: '10001'\\n\"\n+        + \"    'ms-2':\\n\"\n+        + \"      ListenPort: '9001'\\n\";\n+\n+    createModelConfigMap(cmName, yamlString);\n+\n+  }\n+\n+  /**\n+   * Delete the domain created by each test for the next test to start over.\n+   */\n+  @AfterEach\n+  public void afterEach() {\n+    logger.info(\"Deleting the domain resource\");\n+    TestActions.deleteDomainCustomResource(domainUid, domainNamespace);\n+    checkPodDoesNotExist(adminServerPodName, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 2, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName2, domainUid, domainNamespace);\n+  }\n+\n+  /**\n+   * Add shutdown properties at all levels and verify.\n+   * 1. Creates shutdown object for admin server, cluster and managed servers.\n+   * 2. Creates domain resource with the above shutdown objects.\n+   * 3. After all the pods are started, verifies the server.out for each server to see whether the nodemanager env", "originalCommit": "561fa6cf890adf0462e6c86907afbaf371e177ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzIxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953212", "bodyText": "Fixed the javadoc", "author": "sankarpn", "createdAt": "2020-09-15T20:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwOTM0OA=="}], "type": "inlineReview", "revised_code": {"commit": "af77a0d3736a4e5e7eccedb8ebb9a767573e5838", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex 5578b7a702..ce8dfd00af 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -152,11 +152,25 @@ class ItPodsShutdownOption {\n   }\n \n   /**\n-   * Add shutdown properties at all levels and verify.\n-   * 1. Creates shutdown object for admin server, cluster and managed servers.\n-   * 2. Creates domain resource with the above shutdown objects.\n-   * 3. After all the pods are started, verifies the server.out for each server to see whether the nodemanager env\n-   * is set with those property values according to the precedence levels.\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels.\n+   * Verify individual specific level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>Since the shutdown options are provided at all levels the domain level shutdown options has no effect on the\n+   * admin server, cluster, or managed server options. All of those entities use their own shutdown options.\n+   *\n+   *<p>When server pods starts up the server.out log will show the options applied to the servers. The test verifies\n+   * the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them at server level.\n    * @throws ApiException when getting log fails\n    */\n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyNDA0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488224048", "bodyText": "Remove TODO comments", "author": "anpanigr", "createdAt": "2020-09-14T21:14:38Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -188,103 +262,112 @@ private static void createAndVerifyMiiDomain() {\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[0])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n         adminServerPodName, domainNamespace);\n     checkPodReady(adminServerPodName, domainUid, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check for managed server pods existence in the domain namespace\n     for (int i = 1; i <= replicaCount; i++) {\n-      String managedServerPodName = managedServerPrefix + i;\n+      String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server pod exists in the domain namespace\n-      logger.info(\"Checking that managed server pod {0} exists in namespace {1}\",\n+      // check that the managed server service exists in the domain namespace\n+      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkPodExists(managedServerPodName, domainUid, domainNamespace);\n+      checkServiceExists(managedServerPodName, domainNamespace);\n \n       // check that the managed server pod is ready\n       logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n           managedServerPodName, domainNamespace);\n       checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+    }\n \n+    // check for independent managed server pods existence in the domain namespace\n+    //TODO - only one of the independent managed server is coming up, bug???", "originalCommit": "561fa6cf890adf0462e6c86907afbaf371e177ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzI2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953265", "bodyText": "Fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyNDA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "af77a0d3736a4e5e7eccedb8ebb9a767573e5838", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex 5578b7a702..ce8dfd00af 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -257,6 +288,7 @@ class ItPodsShutdownOption {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n"}}, {"oid": "af77a0d3736a4e5e7eccedb8ebb9a767573e5838", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/af77a0d3736a4e5e7eccedb8ebb9a767573e5838", "message": "update comments", "committedDate": "2020-09-15T16:20:16Z", "type": "commit"}, {"oid": "02dfc9eeedaa85b34691a40dd8351bb4e148d3bf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/02dfc9eeedaa85b34691a40dd8351bb4e148d3bf", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podshutdown-tests", "committedDate": "2020-09-15T16:20:54Z", "type": "commit"}, {"oid": "ce549322a202a677f378a047f53f223b61b41e2d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ce549322a202a677f378a047f53f223b61b41e2d", "message": "fix array size", "committedDate": "2020-09-15T16:31:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDgyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488864828", "bodyText": "shutdown", "author": "vanajamukkara", "createdAt": "2020-09-15T18:06:17Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -156,15 +118,158 @@ private static void createAndVerifyMiiDomain() {\n \n     // create secret for admin credentials\n     logger.info(\"Creating secret for admin credentials\");\n-    String adminSecretName = \"weblogic-credentials\";\n+    adminSecretName = \"weblogic-credentials\";\n     createSecretWithUsernamePassword(adminSecretName, domainNamespace, \"weblogic\", \"welcome1\");\n \n     // create encryption secret\n     logger.info(\"Creating encryption secret\");\n-    String encryptionSecretName = \"encryptionsecret\";\n+    encryptionSecretName = \"encryptionsecret\";\n     createSecretWithUsernamePassword(encryptionSecretName, domainNamespace, \"weblogicenc\", \"weblogicenc\");\n \n-    // create the domain CR\n+    String yamlString = \"topology:\\n\"\n+        + \"  Server:\\n\"\n+        + \"    'ms-1':\\n\"\n+        + \"      ListenPort: '10001'\\n\"\n+        + \"    'ms-2':\\n\"\n+        + \"      ListenPort: '9001'\\n\";\n+\n+    createModelConfigMap(cmName, yamlString);\n+\n+  }\n+\n+  /**\n+   * Delete the domain created by each test for the next test to start over.\n+   */\n+  @AfterEach\n+  public void afterEach() {\n+    logger.info(\"Deleting the domain resource\");\n+    TestActions.deleteDomainCustomResource(domainUid, domainNamespace);\n+    checkPodDoesNotExist(adminServerPodName, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 2, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName2, domainUid, domainNamespace);\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels.\n+   * Verify individual specific level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>Since the shutdown options are provided at all levels the domain level shutdown options has no effect on the\n+   * admin server, cluster, or managed server options. All of those entities use their own shutdown options.\n+   *\n+   *<p>When server pods starts up the server.out log will show the options applied to the servers. The test verifies\n+   * the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them at server level.\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsAllLevels() throws ApiException {\n+\n+\n+    // create Shitdown objects for each server and cluster", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzMzMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953333", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDgyOA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -109,9 +107,6 @@ class ItPodsShutdownOption {\n     // get the pre-built image created by IntegrationTestWatcher\n     miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n-    // docker login and push image to docker registry if necessary\n-    dockerLoginAndPushImageToRegistry(miiImage);\n-\n     // create docker registry secret to pull the image from registry\n     logger.info(\"Creating docker registry secret in namespace {0}\", domainNamespace);\n     createDockerRegistrySecret(domainNamespace);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2OTkxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488869914", "bodyText": "this image is already pushed to OCIR in ImageBuilders.java, why are we pushing again? may be some old code?", "author": "vanajamukkara", "createdAt": "2020-09-15T18:15:35Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -94,58 +106,8 @@ public static void initAll(@Namespaces(2) List<String> namespaces) {\n     // install and verify operator\n     installAndVerifyOperator(opNamespace, domainNamespace);\n \n-    // create a basic model in image domain\n-    createAndVerifyMiiDomain();\n-  }\n-\n-  /**\n-   * This test is to verify different shutdown options specified at different scopes in Domain Resource Definition.\n-   * Refer to section \"Shutdown options\" of Documentation link:\n-   * https://oracle.github.io/weblogic-kubernetes-operator/userguide/managing-domains/domain-lifecycle/startup/\n-   * step 1: Startup a WebLogic domain with one cluster that initially has one running managed server. The shutdown  \n-   * option is configured as follows:\n-   * domain: SHUTDOWN_TYPE -> Graceful.\n-   * adminServer: SHUTDOWN_TYPE -> Forced.\n-   *              SHUTDOWN_IGNORE_SESSIONS -> true.\n-   *              SHUTDOWN_TIMEOUT -> 40.\n-   * cluster: SHUTDOWN_IGNORE_SESSIONS -> true.\n-   *          SHUTDOWN_TIMEOUT -> 80.\n-   * managedServer1: SHUTDOWN_TIMEOUT -> 100.\n-   * step2: Scale cluster with two managed servers.\n-   * step 3: Verify shutdown properties of admin server, managedServer1 and newly scaled up managedServer2.\n-   * Domain level \"Graceful\" SHUTDOWN_TYPE overrides server level setting and is used for all servers.\n-   * So adminServer has \"Graceful\" SHUTDOWN_TYPE, default \"false\" SHUTDOWN_IGNORE_SESSIONS and\n-   * configured \"40\" SHUTDOWN_TIMEOUT.\n-   * Managed level setting overrides cluster level setting so managedServer1 has configured \"100\"\n-   * SHUTDOWN_TIMEOUT, cluster level \"true\" SHUTDOWN_IGNORE_SESSIONS  \"true\" and \"Graceful\" SHUTDOWN_TYPE.\n-   * Newly scaled up managedServer2 takes setting from combination of domain level and cluster level\n-   * with \"Graceful\" SHUTDOWN_TYPE, \"true\" SHUTDOWN_IGNORE_SESSIONS and default \"30\" SHUTDOWN_TIMEOUT\n-   */\n-  @Test\n-  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n-  public void testShutdownProps() throws ApiException {\n-\n-    //scale the cluster to 2 managed servers\n-    assertThat(assertDoesNotThrow(() -> scaleCluster(domainUid, domainNamespace, clusterName, 2)))\n-        .as(\"Verify scaling cluster {0} of domain {1} in namespace {2} succeeds\",\n-              clusterName, domainUid, domainNamespace)\n-        .withFailMessage(\"Scaling cluster {0} of domain {1} in namespace {2} failed\",\n-              clusterName, domainUid, domainNamespace)\n-        .isTrue();\n-    assertDoesNotThrow(() -> TimeUnit.SECONDS.sleep(30));\n-\n-    assertTrue(verifyServerShutdownProp(adminServerPodName, domainNamespace, \"Graceful\", \"40\", \"false\"));\n-    assertTrue(verifyServerShutdownProp(managedServerPrefix + 1, domainNamespace, \"Graceful\", \"100\", \"true\"));\n-    assertTrue(verifyServerShutdownProp(managedServerPrefix + 2, domainNamespace, \"Graceful\", \"30\", \"true\"));\n-  }\n-\n-  /**\n-   * Create a model in image domain and verify the server pods are ready.\n-   */\n-  private static void createAndVerifyMiiDomain() {\n-\n     // get the pre-built image created by IntegrationTestWatcher\n-    String miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n     // docker login and push image to docker registry if necessary\n     dockerLoginAndPushImageToRegistry(miiImage);", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzQwNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953406", "bodyText": "removed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2OTkxNA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -109,9 +107,6 @@ class ItPodsShutdownOption {\n     // get the pre-built image created by IntegrationTestWatcher\n     miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n-    // docker login and push image to docker registry if necessary\n-    dockerLoginAndPushImageToRegistry(miiImage);\n-\n     // create docker registry secret to pull the image from registry\n     logger.info(\"Creating docker registry secret in namespace {0}\", domainNamespace);\n     createDockerRegistrySecret(domainNamespace);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3MzQwMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488873400", "bodyText": "configured-cluster.yaml? you are adding independent managed servers, is this correct?", "author": "vanajamukkara", "createdAt": "2020-09-15T18:22:18Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -183,108 +288,117 @@ private static void createAndVerifyMiiDomain() {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[4]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n         adminServerPodName, domainNamespace);\n     checkPodReady(adminServerPodName, domainUid, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check for managed server pods existence in the domain namespace\n     for (int i = 1; i <= replicaCount; i++) {\n-      String managedServerPodName = managedServerPrefix + i;\n+      String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server pod exists in the domain namespace\n-      logger.info(\"Checking that managed server pod {0} exists in namespace {1}\",\n+      // check that the managed server service exists in the domain namespace\n+      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkPodExists(managedServerPodName, domainUid, domainNamespace);\n+      checkServiceExists(managedServerPodName, domainNamespace);\n \n       // check that the managed server pod is ready\n       logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n           managedServerPodName, domainNamespace);\n       checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+    }\n \n+    // check for independent managed server pods existence in the domain namespace\n+    for (String podName : new String[]{indManagedServerPodName2}) {\n       // check that the managed server service exists in the domain namespace\n       logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n+          podName, domainNamespace);\n+      checkServiceExists(podName, domainNamespace);\n+\n+      // check that the managed server pod is ready\n+      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+          podName, domainNamespace);\n+      checkPodReady(podName, domainUid, domainNamespace);\n     }\n+\n   }\n \n-  /**\n-   * Verify the server pod Shutdown properties.\n-   * @param podName the name of the server pod\n-   * @param domainNS the namespace where the server pod exist\n-   * @param props the shutdown properties\n-   */\n-  private static boolean verifyServerShutdownProp(\n-      String podName,\n-      String domainNS,\n-      String... props) throws io.kubernetes.client.openapi.ApiException {\n-\n-    V1Pod serverPod = Kubernetes.getPod(domainNS, null, podName);\n-    assertNotNull(serverPod,\"The server pod does not exist in namespace \" + domainNS);\n-    List<V1EnvVar> envVars = Objects.requireNonNull(serverPod.getSpec()).getContainers().get(0).getEnv();\n-\n-    boolean found = false;\n-    HashMap<String, Boolean> propFound = new HashMap<String, Boolean>();\n-    for (String prop : props) {\n-      for (var envVar : envVars) {\n-        if (envVar.getName().contains(\"SHUTDOWN\")) {\n-          if (envVar.getValue() != null && envVar.getValue().contains(prop)) {\n-            logger.info(\"For pod {0} SHUTDOWN option {1} has value {2} \",\n-                podName, envVar.getName(),  envVar.getValue());\n-            logger.info(\"Property with value \" + prop + \" has found\");\n-            propFound.put(prop, true);\n-          }\n-        }\n-      }\n-    }\n-    if (props.length == propFound.size()) {\n-      found = true;\n+\n+  // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n+    String podLog = TestActions.getPodLog(podName, namespace);\n+    for (String envVar : envVars) {\n+      logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n+      assertTrue(podLog.contains(envVar));\n+      logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n-    return found;\n+  }\n+\n+  // Crate a ConfigMap with a model to add a 2 independent managed servers\n+  private static void createModelConfigMap(String configMapName, String model) {\n+    Map<String, String> labels = new HashMap<>();\n+    labels.put(\"weblogic.domainUid\", domainUid);\n+    Map<String, String> data = new HashMap<>();\n+    data.put(\"configured-cluster.yaml\", model);", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzQ1Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953456", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3MzQwMA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -332,52 +327,37 @@ class ItPodsShutdownOption {\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check that admin server pod is ready\n-    logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n+    // check that admin service/pod exists in the domain namespace\n+    logger.info(\"Checking that admin service/pod {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+    checkPodReadyAndServiceExists(adminServerPodName, domainUid, domainNamespace);\n \n     for (int i = 1; i <= replicaCount; i++) {\n       String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that clustered ms service/pod {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(managedServerPodName, domainUid, domainNamespace);\n     }\n \n     // check for independent managed server pods existence in the domain namespace\n     for (String podName : new String[]{indManagedServerPodName2}) {\n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          podName, domainNamespace);\n-      checkServiceExists(podName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that independent ms service/pod {0} exists in namespace {1}\",\n           podName, domainNamespace);\n-      checkPodReady(podName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(podName, domainUid, domainNamespace);\n     }\n \n   }\n \n \n   // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n-  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n-    String podLog = TestActions.getPodLog(podName, namespace);\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) {\n+    String podLog = assertDoesNotThrow(() -> TestActions.getPodLog(podName, namespace));\n     for (String envVar : envVars) {\n       logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n-      assertTrue(podLog.contains(envVar));\n+      assertTrue(podLog.contains(envVar), \"Server log doesn't contain the \" + envVar);\n       logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NzcyMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488877720", "bodyText": "add a message in assert when it fails", "author": "vanajamukkara", "createdAt": "2020-09-15T18:29:53Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -183,108 +288,117 @@ private static void createAndVerifyMiiDomain() {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[4]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n         adminServerPodName, domainNamespace);\n     checkPodReady(adminServerPodName, domainUid, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check for managed server pods existence in the domain namespace\n     for (int i = 1; i <= replicaCount; i++) {\n-      String managedServerPodName = managedServerPrefix + i;\n+      String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server pod exists in the domain namespace\n-      logger.info(\"Checking that managed server pod {0} exists in namespace {1}\",\n+      // check that the managed server service exists in the domain namespace\n+      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkPodExists(managedServerPodName, domainUid, domainNamespace);\n+      checkServiceExists(managedServerPodName, domainNamespace);\n \n       // check that the managed server pod is ready\n       logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n           managedServerPodName, domainNamespace);\n       checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+    }\n \n+    // check for independent managed server pods existence in the domain namespace\n+    for (String podName : new String[]{indManagedServerPodName2}) {\n       // check that the managed server service exists in the domain namespace\n       logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n+          podName, domainNamespace);\n+      checkServiceExists(podName, domainNamespace);\n+\n+      // check that the managed server pod is ready\n+      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+          podName, domainNamespace);\n+      checkPodReady(podName, domainUid, domainNamespace);\n     }\n+\n   }\n \n-  /**\n-   * Verify the server pod Shutdown properties.\n-   * @param podName the name of the server pod\n-   * @param domainNS the namespace where the server pod exist\n-   * @param props the shutdown properties\n-   */\n-  private static boolean verifyServerShutdownProp(\n-      String podName,\n-      String domainNS,\n-      String... props) throws io.kubernetes.client.openapi.ApiException {\n-\n-    V1Pod serverPod = Kubernetes.getPod(domainNS, null, podName);\n-    assertNotNull(serverPod,\"The server pod does not exist in namespace \" + domainNS);\n-    List<V1EnvVar> envVars = Objects.requireNonNull(serverPod.getSpec()).getContainers().get(0).getEnv();\n-\n-    boolean found = false;\n-    HashMap<String, Boolean> propFound = new HashMap<String, Boolean>();\n-    for (String prop : props) {\n-      for (var envVar : envVars) {\n-        if (envVar.getName().contains(\"SHUTDOWN\")) {\n-          if (envVar.getValue() != null && envVar.getValue().contains(prop)) {\n-            logger.info(\"For pod {0} SHUTDOWN option {1} has value {2} \",\n-                podName, envVar.getName(),  envVar.getValue());\n-            logger.info(\"Property with value \" + prop + \" has found\");\n-            propFound.put(prop, true);\n-          }\n-        }\n-      }\n-    }\n-    if (props.length == propFound.size()) {\n-      found = true;\n+\n+  // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n+    String podLog = TestActions.getPodLog(podName, namespace);\n+    for (String envVar : envVars) {\n+      logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n+      assertTrue(podLog.contains(envVar));", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzQ4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953489", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NzcyMA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -332,52 +327,37 @@ class ItPodsShutdownOption {\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check that admin server pod is ready\n-    logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n+    // check that admin service/pod exists in the domain namespace\n+    logger.info(\"Checking that admin service/pod {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+    checkPodReadyAndServiceExists(adminServerPodName, domainUid, domainNamespace);\n \n     for (int i = 1; i <= replicaCount; i++) {\n       String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that clustered ms service/pod {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(managedServerPodName, domainUid, domainNamespace);\n     }\n \n     // check for independent managed server pods existence in the domain namespace\n     for (String podName : new String[]{indManagedServerPodName2}) {\n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          podName, domainNamespace);\n-      checkServiceExists(podName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that independent ms service/pod {0} exists in namespace {1}\",\n           podName, domainNamespace);\n-      checkPodReady(podName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(podName, domainUid, domainNamespace);\n     }\n \n   }\n \n \n   // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n-  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n-    String podLog = TestActions.getPodLog(podName, namespace);\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) {\n+    String podLog = assertDoesNotThrow(() -> TestActions.getPodLog(podName, namespace));\n     for (String envVar : envVars) {\n       logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n-      assertTrue(podLog.contains(envVar));\n+      assertTrue(podLog.contains(envVar), \"Server log doesn't contain the \" + envVar);\n       logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NjQxMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488896411", "bodyText": "any reason for not adding the assertion for exception instead of throws in the test method? we usually add assertions in the test..", "author": "vanajamukkara", "createdAt": "2020-09-15T18:57:28Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -156,15 +118,158 @@ private static void createAndVerifyMiiDomain() {\n \n     // create secret for admin credentials\n     logger.info(\"Creating secret for admin credentials\");\n-    String adminSecretName = \"weblogic-credentials\";\n+    adminSecretName = \"weblogic-credentials\";\n     createSecretWithUsernamePassword(adminSecretName, domainNamespace, \"weblogic\", \"welcome1\");\n \n     // create encryption secret\n     logger.info(\"Creating encryption secret\");\n-    String encryptionSecretName = \"encryptionsecret\";\n+    encryptionSecretName = \"encryptionsecret\";\n     createSecretWithUsernamePassword(encryptionSecretName, domainNamespace, \"weblogicenc\", \"weblogicenc\");\n \n-    // create the domain CR\n+    String yamlString = \"topology:\\n\"\n+        + \"  Server:\\n\"\n+        + \"    'ms-1':\\n\"\n+        + \"      ListenPort: '10001'\\n\"\n+        + \"    'ms-2':\\n\"\n+        + \"      ListenPort: '9001'\\n\";\n+\n+    createModelConfigMap(cmName, yamlString);\n+\n+  }\n+\n+  /**\n+   * Delete the domain created by each test for the next test to start over.\n+   */\n+  @AfterEach\n+  public void afterEach() {\n+    logger.info(\"Deleting the domain resource\");\n+    TestActions.deleteDomainCustomResource(domainUid, domainNamespace);\n+    checkPodDoesNotExist(adminServerPodName, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 2, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName2, domainUid, domainNamespace);\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels.\n+   * Verify individual specific level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>Since the shutdown options are provided at all levels the domain level shutdown options has no effect on the\n+   * admin server, cluster, or managed server options. All of those entities use their own shutdown options.\n+   *\n+   *<p>When server pods starts up the server.out log will show the options applied to the servers. The test verifies\n+   * the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them at server level.\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsAllLevels() throws ApiException {", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzU0MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953540", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk2OTMyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488969328", "bodyText": "I don't see any change for this?", "author": "vanajamukkara", "createdAt": "2020-09-15T20:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3MTE2OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488971168", "bodyText": "you missed deleting throws from test method..", "author": "vanajamukkara", "createdAt": "2020-09-15T21:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NTU2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488975560", "bodyText": "yeah, fixed it.", "author": "sankarpn", "createdAt": "2020-09-15T21:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5NjQxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -109,9 +107,6 @@ class ItPodsShutdownOption {\n     // get the pre-built image created by IntegrationTestWatcher\n     miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n-    // docker login and push image to docker registry if necessary\n-    dockerLoginAndPushImageToRegistry(miiImage);\n-\n     // create docker registry secret to pull the image from registry\n     logger.info(\"Creating docker registry secret in namespace {0}\", domainNamespace);\n     createDockerRegistrySecret(domainNamespace);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5ODY3MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488898670", "bodyText": "shutdown", "author": "vanajamukkara", "createdAt": "2020-09-15T19:00:12Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -156,15 +118,158 @@ private static void createAndVerifyMiiDomain() {\n \n     // create secret for admin credentials\n     logger.info(\"Creating secret for admin credentials\");\n-    String adminSecretName = \"weblogic-credentials\";\n+    adminSecretName = \"weblogic-credentials\";\n     createSecretWithUsernamePassword(adminSecretName, domainNamespace, \"weblogic\", \"welcome1\");\n \n     // create encryption secret\n     logger.info(\"Creating encryption secret\");\n-    String encryptionSecretName = \"encryptionsecret\";\n+    encryptionSecretName = \"encryptionsecret\";\n     createSecretWithUsernamePassword(encryptionSecretName, domainNamespace, \"weblogicenc\", \"weblogicenc\");\n \n-    // create the domain CR\n+    String yamlString = \"topology:\\n\"\n+        + \"  Server:\\n\"\n+        + \"    'ms-1':\\n\"\n+        + \"      ListenPort: '10001'\\n\"\n+        + \"    'ms-2':\\n\"\n+        + \"      ListenPort: '9001'\\n\";\n+\n+    createModelConfigMap(cmName, yamlString);\n+\n+  }\n+\n+  /**\n+   * Delete the domain created by each test for the next test to start over.\n+   */\n+  @AfterEach\n+  public void afterEach() {\n+    logger.info(\"Deleting the domain resource\");\n+    TestActions.deleteDomainCustomResource(domainUid, domainNamespace);\n+    checkPodDoesNotExist(adminServerPodName, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 2, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName2, domainUid, domainNamespace);\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels.\n+   * Verify individual specific level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>Since the shutdown options are provided at all levels the domain level shutdown options has no effect on the\n+   * admin server, cluster, or managed server options. All of those entities use their own shutdown options.\n+   *\n+   *<p>When server pods starts up the server.out log will show the options applied to the servers. The test verifies\n+   * the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them at server level.\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsAllLevels() throws ApiException {\n+\n+\n+    // create Shitdown objects for each server and cluster\n+    Shutdown[] shutDownObjects = new Shutdown[5];\n+    Shutdown dom = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(30L);\n+    Shutdown admin = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(40L);\n+    Shutdown cluster = new Shutdown().ignoreSessions(Boolean.FALSE).shutdownType(\"Graceful\").timeoutSeconds(60L);\n+    Shutdown ms1 = new Shutdown().ignoreSessions(Boolean.FALSE).shutdownType(\"Graceful\").timeoutSeconds(120L);\n+    Shutdown ms2 = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(45L);\n+    shutDownObjects[0] = dom;\n+    shutDownObjects[1] = admin;\n+    shutDownObjects[2] = cluster;\n+    shutDownObjects[3] = ms1;\n+    shutDownObjects[4] = ms2;\n+    // create domain custom resource and verify all the pods came up\n+    Domain domain = buildDomainResource(shutDownObjects);\n+    createVerifyDomain(domain);\n+\n+    // get pod logs each server which contains server.out file logs and verify values set above are present in the log\n+    verifyServerLog(domainNamespace, adminServerPodName,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=true\", \"SHUTDOWN_TYPE=Forced\", \"SHUTDOWN_TIMEOUT=40\"});\n+    verifyServerLog(domainNamespace, managedServerPodNamePrefix + 1,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=false\", \"SHUTDOWN_TYPE=Graceful\", \"SHUTDOWN_TIMEOUT=60\"});\n+    verifyServerLog(domainNamespace, managedServerPodNamePrefix + 2,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=false\", \"SHUTDOWN_TYPE=Graceful\", \"SHUTDOWN_TIMEOUT=60\"});\n+    verifyServerLog(domainNamespace, indManagedServerPodName2,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=true\", \"SHUTDOWN_TYPE=Forced\", \"SHUTDOWN_TIMEOUT=45\"});\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels\n+   * and override all those options with a domain level ENV variables. Verify the domain level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>After creating the above options override the shutdownType for all servers using a ENV level value - Forced\n+   * Now shutdownType for all servers are overridden with Forced as the shutdown option but rest of the properties\n+   * are applied as set in the individual server levels.\n+   *\n+   *<p>When server pods starts up the server.out log will show the shutdown options applied to the servers.\n+   * The test verifies the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them using ENV variable.\n+   *\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsEnvOverride() throws ApiException {\n+\n+\n+    // create Shitdown objects for each server and cluster", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzU3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953577", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T20:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5ODY3MA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -109,9 +107,6 @@ class ItPodsShutdownOption {\n     // get the pre-built image created by IntegrationTestWatcher\n     miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n-    // docker login and push image to docker registry if necessary\n-    dockerLoginAndPushImageToRegistry(miiImage);\n-\n     // create docker registry secret to pull the image from registry\n     logger.info(\"Creating docker registry secret in namespace {0}\", domainNamespace);\n     createDockerRegistrySecret(domainNamespace);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMDc2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488900769", "bodyText": "you can call checkPodReadyAndServiceExists(String podName, String domainUid, String namespace) method", "author": "vanajamukkara", "createdAt": "2020-09-15T19:04:00Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -183,108 +288,117 @@ private static void createAndVerifyMiiDomain() {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[4]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzY0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953647", "bodyText": "modified", "author": "sankarpn", "createdAt": "2020-09-15T20:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMDc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -332,52 +327,37 @@ class ItPodsShutdownOption {\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check that admin server pod is ready\n-    logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n+    // check that admin service/pod exists in the domain namespace\n+    logger.info(\"Checking that admin service/pod {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+    checkPodReadyAndServiceExists(adminServerPodName, domainUid, domainNamespace);\n \n     for (int i = 1; i <= replicaCount; i++) {\n       String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that clustered ms service/pod {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(managedServerPodName, domainUid, domainNamespace);\n     }\n \n     // check for independent managed server pods existence in the domain namespace\n     for (String podName : new String[]{indManagedServerPodName2}) {\n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          podName, domainNamespace);\n-      checkServiceExists(podName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that independent ms service/pod {0} exists in namespace {1}\",\n           podName, domainNamespace);\n-      checkPodReady(podName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(podName, domainUid, domainNamespace);\n     }\n \n   }\n \n \n   // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n-  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n-    String podLog = TestActions.getPodLog(podName, namespace);\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) {\n+    String podLog = assertDoesNotThrow(() -> TestActions.getPodLog(podName, namespace));\n     for (String envVar : envVars) {\n       logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n-      assertTrue(podLog.contains(envVar));\n+      assertTrue(podLog.contains(envVar), \"Server log doesn't contain the \" + envVar);\n       logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMDkzNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488900937", "bodyText": "you can call checkPodReadyAndServiceExists(String podName, String domainUid, String namespace) method", "author": "vanajamukkara", "createdAt": "2020-09-15T19:04:18Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -183,108 +288,117 @@ private static void createAndVerifyMiiDomain() {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[4]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n         adminServerPodName, domainNamespace);\n     checkPodReady(adminServerPodName, domainUid, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check for managed server pods existence in the domain namespace\n     for (int i = 1; i <= replicaCount; i++) {\n-      String managedServerPodName = managedServerPrefix + i;\n+      String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server pod exists in the domain namespace\n-      logger.info(\"Checking that managed server pod {0} exists in namespace {1}\",\n+      // check that the managed server service exists in the domain namespace\n+      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkPodExists(managedServerPodName, domainUid, domainNamespace);\n+      checkServiceExists(managedServerPodName, domainNamespace);", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1MzcxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953713", "bodyText": "modified", "author": "sankarpn", "createdAt": "2020-09-15T20:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMDkzNw=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -332,52 +327,37 @@ class ItPodsShutdownOption {\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check that admin server pod is ready\n-    logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n+    // check that admin service/pod exists in the domain namespace\n+    logger.info(\"Checking that admin service/pod {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+    checkPodReadyAndServiceExists(adminServerPodName, domainUid, domainNamespace);\n \n     for (int i = 1; i <= replicaCount; i++) {\n       String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that clustered ms service/pod {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(managedServerPodName, domainUid, domainNamespace);\n     }\n \n     // check for independent managed server pods existence in the domain namespace\n     for (String podName : new String[]{indManagedServerPodName2}) {\n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          podName, domainNamespace);\n-      checkServiceExists(podName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that independent ms service/pod {0} exists in namespace {1}\",\n           podName, domainNamespace);\n-      checkPodReady(podName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(podName, domainUid, domainNamespace);\n     }\n \n   }\n \n \n   // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n-  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n-    String podLog = TestActions.getPodLog(podName, namespace);\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) {\n+    String podLog = assertDoesNotThrow(() -> TestActions.getPodLog(podName, namespace));\n     for (String envVar : envVars) {\n       logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n-      assertTrue(podLog.contains(envVar));\n+      assertTrue(podLog.contains(envVar), \"Server log doesn't contain the \" + envVar);\n       logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTA0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488901048", "bodyText": "you can call checkPodReadyAndServiceExists(String podName, String domainUid, String namespace) method", "author": "vanajamukkara", "createdAt": "2020-09-15T19:04:28Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -183,108 +288,117 @@ private static void createAndVerifyMiiDomain() {\n             .includeServerOutInPodLog(true)\n             .serverStartPolicy(\"IF_NEEDED\")\n             .serverPod(new ServerPod()\n+                .shutdown(shutDownObject[0])\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"JAVA_OPTIONS\")\n                     .value(\"-Dweblogic.StdoutDebugEnabled=false\"))\n                 .addEnvItem(new V1EnvVar()\n                     .name(\"USER_MEM_ARGS\")\n-                    .value(\"-Djava.security.egd=file:/dev/./urandom \"))\n-                .addEnvItem(new V1EnvVar()\n-                    .name(\"SHUTDOWN_TYPE\")\n-                    .value(\"Graceful\")))\n+                    .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().shutdownType(\"Forced\")))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(40L))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[1])))\n             .addClustersItem(new Cluster()\n                 .clusterName(clusterName)\n                 .replicas(replicaCount)\n                 .serverStartState(\"RUNNING\")\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(80L)))\n-                .serverPod(new ServerPod().shutdown(new Shutdown().ignoreSessions(true))))\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[2])))\n             .configuration(new Configuration()\n                 .model(new Model()\n+                    .configMap(cmName)\n                     .domainType(WLS_DOMAIN_TYPE)\n                     .runtimeEncryptionSecret(encryptionSecretName)))\n             .addManagedServersItem(new ManagedServer()\n-                .serverName(managedServer1Name)\n-                .serverPod(new ServerPod().shutdown(new Shutdown().timeoutSeconds(100L)))));\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName1)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[3])))\n+            .addManagedServersItem(new ManagedServer()\n+                .serverStartState(\"RUNNING\")\n+                .serverStartPolicy(\"ALWAYS\")\n+                .serverName(indManagedServerName2)\n+                .serverPod(new ServerPod()\n+                    .shutdown(shutDownObject[4]))));\n+    return domain;\n+  }\n \n+  // create domain resource and verify all the server pods are ready\n+  private void createVerifyDomain(Domain domain) {\n     // create model in image domain\n     logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin server pod exists in the domain namespace\n-    logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n+    // check that admin service exists in the domain namespace\n+    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodExists(adminServerPodName, domainUid, domainNamespace);\n+    checkServiceExists(adminServerPodName, domainNamespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n         adminServerPodName, domainNamespace);\n     checkPodReady(adminServerPodName, domainUid, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check for managed server pods existence in the domain namespace\n     for (int i = 1; i <= replicaCount; i++) {\n-      String managedServerPodName = managedServerPrefix + i;\n+      String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server pod exists in the domain namespace\n-      logger.info(\"Checking that managed server pod {0} exists in namespace {1}\",\n+      // check that the managed server service exists in the domain namespace\n+      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkPodExists(managedServerPodName, domainUid, domainNamespace);\n+      checkServiceExists(managedServerPodName, domainNamespace);\n \n       // check that the managed server pod is ready\n       logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n           managedServerPodName, domainNamespace);\n       checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+    }\n \n+    // check for independent managed server pods existence in the domain namespace\n+    for (String podName : new String[]{indManagedServerPodName2}) {\n       // check that the managed server service exists in the domain namespace\n       logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n+          podName, domainNamespace);\n+      checkServiceExists(podName, domainNamespace);", "originalCommit": "ce549322a202a677f378a047f53f223b61b41e2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk1Mzc2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488953769", "bodyText": "modified", "author": "sankarpn", "createdAt": "2020-09-15T20:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex a7b26b8ee4..81cbafa936 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -332,52 +327,37 @@ class ItPodsShutdownOption {\n         domainUid, domainNamespace, miiImage);\n     createDomainAndVerify(domain, domainNamespace);\n \n-    // check that admin service exists in the domain namespace\n-    logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domainNamespace);\n-    checkServiceExists(adminServerPodName, domainNamespace);\n-\n-    // check that admin server pod is ready\n-    logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n+    // check that admin service/pod exists in the domain namespace\n+    logger.info(\"Checking that admin service/pod {0} exists in namespace {1}\",\n         adminServerPodName, domainNamespace);\n-    checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+    checkPodReadyAndServiceExists(adminServerPodName, domainUid, domainNamespace);\n \n     for (int i = 1; i <= replicaCount; i++) {\n       String managedServerPodName = managedServerPodNamePrefix + i;\n \n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that clustered ms service/pod {0} exists in namespace {1}\",\n           managedServerPodName, domainNamespace);\n-      checkServiceExists(managedServerPodName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n-          managedServerPodName, domainNamespace);\n-      checkPodReady(managedServerPodName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(managedServerPodName, domainUid, domainNamespace);\n     }\n \n     // check for independent managed server pods existence in the domain namespace\n     for (String podName : new String[]{indManagedServerPodName2}) {\n-      // check that the managed server service exists in the domain namespace\n-      logger.info(\"Checking that managed server service {0} exists in namespace {1}\",\n-          podName, domainNamespace);\n-      checkServiceExists(podName, domainNamespace);\n-\n-      // check that the managed server pod is ready\n-      logger.info(\"Checking that managed server pod {0} is ready in namespace {1}\",\n+      // check that ms service/pod exists in the domain namespace\n+      logger.info(\"Checking that independent ms service/pod {0} exists in namespace {1}\",\n           podName, domainNamespace);\n-      checkPodReady(podName, domainUid, domainNamespace);\n+      checkPodReadyAndServiceExists(podName, domainUid, domainNamespace);\n     }\n \n   }\n \n \n   // get pod log which includes the server.out logs and verify the messages contain the set shutdown properties\n-  private void verifyServerLog(String namespace, String podName, String[] envVars) throws ApiException {\n-    String podLog = TestActions.getPodLog(podName, namespace);\n+  private void verifyServerLog(String namespace, String podName, String[] envVars) {\n+    String podLog = assertDoesNotThrow(() -> TestActions.getPodLog(podName, namespace));\n     for (String envVar : envVars) {\n       logger.info(\"Checking Pod {0} for server startup property {1}\", podName, envVar);\n-      assertTrue(podLog.contains(envVar));\n+      assertTrue(podLog.contains(envVar), \"Server log doesn't contain the \" + envVar);\n       logger.info(\"Pod {0} contains the property {1} in server startup env\", podName, envVar);\n     }\n   }\n"}}, {"oid": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "message": "address review comments from Vanaja", "committedDate": "2020-09-15T19:41:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3MjIxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488972213", "bodyText": "remove throws ApiException", "author": "vanajamukkara", "createdAt": "2020-09-15T21:04:34Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java", "diffHunk": "@@ -94,77 +104,167 @@ public static void initAll(@Namespaces(2) List<String> namespaces) {\n     // install and verify operator\n     installAndVerifyOperator(opNamespace, domainNamespace);\n \n-    // create a basic model in image domain\n-    createAndVerifyMiiDomain();\n-  }\n-\n-  /**\n-   * This test is to verify different shutdown options specified at different scopes in Domain Resource Definition.\n-   * Refer to section \"Shutdown options\" of Documentation link:\n-   * https://oracle.github.io/weblogic-kubernetes-operator/userguide/managing-domains/domain-lifecycle/startup/\n-   * step 1: Startup a WebLogic domain with one cluster that initially has one running managed server. The shutdown  \n-   * option is configured as follows:\n-   * domain: SHUTDOWN_TYPE -> Graceful.\n-   * adminServer: SHUTDOWN_TYPE -> Forced.\n-   *              SHUTDOWN_IGNORE_SESSIONS -> true.\n-   *              SHUTDOWN_TIMEOUT -> 40.\n-   * cluster: SHUTDOWN_IGNORE_SESSIONS -> true.\n-   *          SHUTDOWN_TIMEOUT -> 80.\n-   * managedServer1: SHUTDOWN_TIMEOUT -> 100.\n-   * step2: Scale cluster with two managed servers.\n-   * step 3: Verify shutdown properties of admin server, managedServer1 and newly scaled up managedServer2.\n-   * Domain level \"Graceful\" SHUTDOWN_TYPE overrides server level setting and is used for all servers.\n-   * So adminServer has \"Graceful\" SHUTDOWN_TYPE, default \"false\" SHUTDOWN_IGNORE_SESSIONS and\n-   * configured \"40\" SHUTDOWN_TIMEOUT.\n-   * Managed level setting overrides cluster level setting so managedServer1 has configured \"100\"\n-   * SHUTDOWN_TIMEOUT, cluster level \"true\" SHUTDOWN_IGNORE_SESSIONS  \"true\" and \"Graceful\" SHUTDOWN_TYPE.\n-   * Newly scaled up managedServer2 takes setting from combination of domain level and cluster level\n-   * with \"Graceful\" SHUTDOWN_TYPE, \"true\" SHUTDOWN_IGNORE_SESSIONS and default \"30\" SHUTDOWN_TIMEOUT\n-   */\n-  @Test\n-  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n-  public void testShutdownProps() throws ApiException {\n-\n-    //scale the cluster to 2 managed servers\n-    assertThat(assertDoesNotThrow(() -> scaleCluster(domainUid, domainNamespace, clusterName, 2)))\n-        .as(\"Verify scaling cluster {0} of domain {1} in namespace {2} succeeds\",\n-              clusterName, domainUid, domainNamespace)\n-        .withFailMessage(\"Scaling cluster {0} of domain {1} in namespace {2} failed\",\n-              clusterName, domainUid, domainNamespace)\n-        .isTrue();\n-    assertDoesNotThrow(() -> TimeUnit.SECONDS.sleep(30));\n-\n-    assertTrue(verifyServerShutdownProp(adminServerPodName, domainNamespace, \"Graceful\", \"40\", \"false\"));\n-    assertTrue(verifyServerShutdownProp(managedServerPrefix + 1, domainNamespace, \"Graceful\", \"100\", \"true\"));\n-    assertTrue(verifyServerShutdownProp(managedServerPrefix + 2, domainNamespace, \"Graceful\", \"30\", \"true\"));\n-  }\n-\n-  /**\n-   * Create a model in image domain and verify the server pods are ready.\n-   */\n-  private static void createAndVerifyMiiDomain() {\n-\n     // get the pre-built image created by IntegrationTestWatcher\n-    String miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n-\n-    // docker login and push image to docker registry if necessary\n-    dockerLoginAndPushImageToRegistry(miiImage);\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n \n     // create docker registry secret to pull the image from registry\n     logger.info(\"Creating docker registry secret in namespace {0}\", domainNamespace);\n     createDockerRegistrySecret(domainNamespace);\n \n     // create secret for admin credentials\n     logger.info(\"Creating secret for admin credentials\");\n-    String adminSecretName = \"weblogic-credentials\";\n+    adminSecretName = \"weblogic-credentials\";\n     createSecretWithUsernamePassword(adminSecretName, domainNamespace, \"weblogic\", \"welcome1\");\n \n     // create encryption secret\n     logger.info(\"Creating encryption secret\");\n-    String encryptionSecretName = \"encryptionsecret\";\n+    encryptionSecretName = \"encryptionsecret\";\n     createSecretWithUsernamePassword(encryptionSecretName, domainNamespace, \"weblogicenc\", \"weblogicenc\");\n \n-    // create the domain CR\n+    String yamlString = \"topology:\\n\"\n+        + \"  Server:\\n\"\n+        + \"    'ms-1':\\n\"\n+        + \"      ListenPort: '10001'\\n\"\n+        + \"    'ms-2':\\n\"\n+        + \"      ListenPort: '9001'\\n\";\n+\n+    createModelConfigMap(cmName, yamlString);\n+\n+  }\n+\n+  /**\n+   * Delete the domain created by each test for the next test to start over.\n+   */\n+  @AfterEach\n+  public void afterEach() {\n+    logger.info(\"Deleting the domain resource\");\n+    TestActions.deleteDomainCustomResource(domainUid, domainNamespace);\n+    checkPodDoesNotExist(adminServerPodName, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(managedServerPodNamePrefix + 2, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName1, domainUid, domainNamespace);\n+    checkPodDoesNotExist(indManagedServerPodName2, domainUid, domainNamespace);\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels.\n+   * Verify individual specific level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>Since the shutdown options are provided at all levels the domain level shutdown options has no effect on the\n+   * admin server, cluster, or managed server options. All of those entities use their own shutdown options.\n+   *\n+   *<p>When server pods starts up the server.out log will show the options applied to the servers. The test verifies\n+   * the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them at server level.\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsAllLevels() throws ApiException {\n+\n+\n+    // create Shutdown objects for each server and cluster\n+    Shutdown[] shutDownObjects = new Shutdown[5];\n+    Shutdown dom = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(30L);\n+    Shutdown admin = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(40L);\n+    Shutdown cluster = new Shutdown().ignoreSessions(Boolean.FALSE).shutdownType(\"Graceful\").timeoutSeconds(60L);\n+    Shutdown ms1 = new Shutdown().ignoreSessions(Boolean.FALSE).shutdownType(\"Graceful\").timeoutSeconds(120L);\n+    Shutdown ms2 = new Shutdown().ignoreSessions(Boolean.TRUE).shutdownType(\"Forced\").timeoutSeconds(45L);\n+    shutDownObjects[0] = dom;\n+    shutDownObjects[1] = admin;\n+    shutDownObjects[2] = cluster;\n+    shutDownObjects[3] = ms1;\n+    shutDownObjects[4] = ms2;\n+    // create domain custom resource and verify all the pods came up\n+    Domain domain = buildDomainResource(shutDownObjects);\n+    createVerifyDomain(domain);\n+\n+    // get pod logs each server which contains server.out file logs and verify values set above are present in the log\n+    verifyServerLog(domainNamespace, adminServerPodName,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=true\", \"SHUTDOWN_TYPE=Forced\", \"SHUTDOWN_TIMEOUT=40\"});\n+    verifyServerLog(domainNamespace, managedServerPodNamePrefix + 1,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=false\", \"SHUTDOWN_TYPE=Graceful\", \"SHUTDOWN_TIMEOUT=60\"});\n+    verifyServerLog(domainNamespace, managedServerPodNamePrefix + 2,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=false\", \"SHUTDOWN_TYPE=Graceful\", \"SHUTDOWN_TIMEOUT=60\"});\n+    verifyServerLog(domainNamespace, indManagedServerPodName2,\n+        new String[]{\"SHUTDOWN_IGNORE_SESSIONS=true\", \"SHUTDOWN_TYPE=Forced\", \"SHUTDOWN_TIMEOUT=45\"});\n+  }\n+\n+  /**\n+   * Add shutdown options for servers at all levels: domain, admin server, cluster and managed server levels\n+   * and override all those options with a domain level ENV variables. Verify the domain level options takes precedence.\n+   *\n+   *<p>Domain level shutdown option which is applicable for all servers in the domain\n+   *      shutdownType - Forced , timeoutSeconds - 30 secs, ignoreSessions - true\n+   * Admin server level shutdown option applicable only to the admin server\n+   *      shutdownType - Forced , timeoutSeconds - 40 secs, ignoreSessions - true\n+   * Cluster level shutdown option applicable only to the clustered instances\n+   *      shutdownType - Graceful , timeoutSeconds - 60 secs, ignoreSessions - false\n+   * Managed server server level shutdown option applicable only to the independent managed servers\n+   *      shutdownType - Forced , timeoutSeconds - 45 secs, ignoreSessions - true\n+   *\n+   *<p>After creating the above options override the shutdownType for all servers using a ENV level value - Forced\n+   * Now shutdownType for all servers are overridden with Forced as the shutdown option but rest of the properties\n+   * are applied as set in the individual server levels.\n+   *\n+   *<p>When server pods starts up the server.out log will show the shutdown options applied to the servers.\n+   * The test verifies the logs and determine the outcome of the test.\n+   *\n+   *<p>This use case shows how to add shutdown options at domain and how to override them using ENV variable.\n+   *\n+   * @throws ApiException when getting log fails\n+   */\n+  @Test\n+  @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n+  public void testShutdownPropsEnvOverride() throws ApiException {", "originalCommit": "7e2ee71ba819b3eeaaea51142bd27e92220cf7a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3NTY1MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1914#discussion_r488975651", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-09-15T21:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3MjIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "10f9a36e90a5d79535147163ee6790a5a5fad86d", "chunk": "diff --git a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\nindex 81cbafa936..807aa3c272 100644\n--- a/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n+++ b/new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodsShutdownOption.java\n\n@@ -170,7 +170,7 @@ class ItPodsShutdownOption {\n    */\n   @Test\n   @DisplayName(\"Verify shutdown rules when shutdown properties are defined at different levels \")\n-  public void testShutdownPropsAllLevels() throws ApiException {\n+  public void testShutdownPropsAllLevels() {\n \n \n     // create Shutdown objects for each server and cluster\n"}}, {"oid": "10f9a36e90a5d79535147163ee6790a5a5fad86d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/10f9a36e90a5d79535147163ee6790a5a5fad86d", "message": "remove throws clause", "committedDate": "2020-09-15T21:10:21Z", "type": "commit"}, {"oid": "936ed070b35531c53e951fe5b86d7d2f53154b0c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/936ed070b35531c53e951fe5b86d7d2f53154b0c", "message": "fix javadoc", "committedDate": "2020-09-15T21:12:24Z", "type": "commit"}]}