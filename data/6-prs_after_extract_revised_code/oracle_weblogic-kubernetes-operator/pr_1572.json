{"pr_number": 1572, "pr_title": "Modified test infra to run integration test in helm3 ", "pr_createdAt": "2020-04-17T01:26:26Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572", "timeline": [{"oid": "d04a27c7c9585ba861260d8adc63b41598397a49", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d04a27c7c9585ba861260d8adc63b41598397a49", "message": "Skipping tiller installation for Helm 3.x", "committedDate": "2020-04-08T03:04:28Z", "type": "commit"}, {"oid": "b8e0737195989a3ecafe144e4b627062bddbed96", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b8e0737195989a3ecafe144e4b627062bddbed96", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-13T17:57:39Z", "type": "commit"}, {"oid": "c77bdce4406ae84101a7cf14037fc2ad2188ca0a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c77bdce4406ae84101a7cf14037fc2ad2188ca0a", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-13T22:50:09Z", "type": "commit"}, {"oid": "af44b229a98fd3580bd4d58f54f52989b920fc6a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/af44b229a98fd3580bd4d58f54f52989b920fc6a", "message": "Added debug flag to setup.sh", "committedDate": "2020-04-13T23:27:19Z", "type": "commit"}, {"oid": "14fb2428fcdbe7d9e15fd16dcb2eadba696fc8f2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/14fb2428fcdbe7d9e15fd16dcb2eadba696fc8f2", "message": "Add provision to describe the lb pod when fails to start", "committedDate": "2020-04-14T01:32:10Z", "type": "commit"}, {"oid": "9376c9b1dfeceffeadba0d13c120cb06fa4a3b8f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9376c9b1dfeceffeadba0d13c120cb06fa4a3b8f", "message": "More dubug on setup.sh", "committedDate": "2020-04-14T01:54:15Z", "type": "commit"}, {"oid": "4ec1e752b0b60ce0f823ddfe77f58942f475c50f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4ec1e752b0b60ce0f823ddfe77f58942f475c50f", "message": "Added more debug for setup.sh", "committedDate": "2020-04-14T02:59:35Z", "type": "commit"}, {"oid": "6042c5ce16b6d3a8f18ecd11d5bb23b0c901d5e5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6042c5ce16b6d3a8f18ecd11d5bb23b0c901d5e5", "message": "Modified the helm3 logic in LoadBalancer.java", "committedDate": "2020-04-14T16:53:08Z", "type": "commit"}, {"oid": "a5854a8e32072e0fddd5357e4918768a6bd48f3c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a5854a8e32072e0fddd5357e4918768a6bd48f3c", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-15T13:46:13Z", "type": "commit"}, {"oid": "60d6abb77c0fa723252e3a6fd59b04f42dbe6d72", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/60d6abb77c0fa723252e3a6fd59b04f42dbe6d72", "message": "modified ItUsabilityOperatorHelmChart.java", "committedDate": "2020-04-15T20:47:17Z", "type": "commit"}, {"oid": "cdf17e5ba06f4d3a17d2709b05f6de5f4010f812", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cdf17e5ba06f4d3a17d2709b05f6de5f4010f812", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-15T20:47:21Z", "type": "commit"}, {"oid": "4115b85a049273a80855ad3bb93289f2d7624ee3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4115b85a049273a80855ad3bb93289f2d7624ee3", "message": "Modified load balance setup.sh script", "committedDate": "2020-04-16T00:15:02Z", "type": "commit"}, {"oid": "1fe164734a0e7db05101ba6db7b0b1697e950657", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1fe164734a0e7db05101ba6db7b0b1697e950657", "message": "Added debug option to helm upgrade", "committedDate": "2020-04-16T00:57:50Z", "type": "commit"}, {"oid": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6d2416d3c6cb992df4df806043adc4ea1cce14cc", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-16T21:52:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODQ1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410498452", "bodyText": "I don't understand this and it seems brittle.  If the Helm install is supposed to fail, I would expect a non-zero exit code from invoking the helm binary and that the list of installed Helm charts does not include the release we just tried to install.", "author": "rjeberhard", "createdAt": "2020-04-17T22:25:34Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java", "diffHunk": "@@ -151,50 +160,32 @@ public void testCreateSecondOperatorUsingSameOperatorNsNegativeInstall() throws\n     Operator secondoperator = new Operator(operatorMap, false, true, true, RestCertType.SELF_SIGNED);\n     String oprelease = (String)(secondoperator.getOperatorMap()).get(\"releaseName\");\n     String opnamespace = (String)(secondoperator.getOperatorMap()).get(\"namespace\");\n+    boolean installFailed = true;\n+    boolean gotExpectedInfo = true;\n     try {\n       secondoperator.callHelmInstall();\n-      throw new RuntimeException(\n-          \"FAILURE: Helm installs second operator with same namespace as the first one\");\n-\n+      installFailed = false;\n     } catch (Exception ex) {\n       if (!ex.getMessage()\n-          .contains(\n-              \"Error: release \"\n-                  + oprelease\n-                  + \" failed: secrets \\\"weblogic-operator-secrets\\\" already exists\")) {\n-        throw new RuntimeException(\n-            \"FAILURE: Helm installs second operator with same namespace as the first one \"\n-                + \"does not report expected message \"\n-                + ex.getMessage());\n-      }\n-      String cmdLb = \"\";\n-      if (BaseTest.HELM_VERSION.equals(\"V2\")) {\n-        cmdLb = \"helm list --failed \" + \"  | grep \" + oprelease;\n-      }\n-      if (BaseTest.HELM_VERSION.equals(\"V3\")) {\n-        cmdLb = \"helm list --failed --namespace \" + opnamespace + \"  | grep \" + oprelease;\n-      }\n-      LoggerHelper.getLocal().log(Level.INFO, \"Executing cmd \" + cmdLb);\n-      ExecResult result = ExecCommand.exec(cmdLb);\n-      if (result.exitValue() != 0) {\n-        throw new RuntimeException(\n-            \"FAILURE: Helm installs second operator with same namespace as the first one \");\n+          .contains(\"weblogic-operator-secrets\")) {", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ4NTE0MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r411485141", "bodyText": "Here the callHelmInstall() expects to fail with a proper exception with the following message\nError: rendered manifests contain a resource that already exists. Unable to continue with install: existing resource conflict: kind: Secret, namespace: ons, name: weblogic-operator-secrets", "author": "anpanigr", "createdAt": "2020-04-20T15:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "10c93d654a307d8bc7c142fdd9db5fbcad44d527", "chunk": "diff --git a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\nindex e490bdc4ef..3e27e97122 100644\n--- a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n+++ b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n\n@@ -182,7 +182,7 @@ public class ItUsabilityOperatorHelmChart extends BaseTest {\n   }\n \n   /**\n-   * Install the operator with non-existing operator namespace.\n+   * Install the operator with non pre-existing operator namespace.\n    * The helm install command should fail.\n    *\n    * @throws Exception when helm install does not fail\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODc2OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410498768", "bodyText": "pre-existing", "author": "rjeberhard", "createdAt": "2020-04-17T22:26:45Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java", "diffHunk": "@@ -215,7 +206,7 @@ public void testNotPreCreatedOpNsCreateOperatorNegativeInstall() throws Exceptio\n     TestUtils.exec(command);\n     try {\n       operator.callHelmInstall();\n-      throw new RuntimeException(\"FAILURE: Helm install operator with not preexisted namespace \");\n+      throw new Exception(\"FAILURE: Helm install operator with not preexisted namespace \");", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU1MDQwNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410550405", "bodyText": "done", "author": "anpanigr", "createdAt": "2020-04-18T01:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODc2OA=="}], "type": "inlineReview", "revised_code": {"commit": "10c93d654a307d8bc7c142fdd9db5fbcad44d527", "chunk": "diff --git a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\nindex e490bdc4ef..3e27e97122 100644\n--- a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n+++ b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n\n@@ -206,7 +206,7 @@ public class ItUsabilityOperatorHelmChart extends BaseTest {\n     TestUtils.exec(command);\n     try {\n       operator.callHelmInstall();\n-      throw new Exception(\"FAILURE: Helm install operator with not preexisted namespace \");\n+      throw new Exception(\"FAILURE: Helm install operator with not pre-existing namespace \");\n \n     } catch (Exception ex) {\n       LoggerHelper.getLocal().log(Level.INFO, \"Helm install operator with not preexisted ns failed as expected\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODkxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410498914", "bodyText": "\"not existing\" or \"non pre-existing\"", "author": "rjeberhard", "createdAt": "2020-04-17T22:27:15Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java", "diffHunk": "@@ -224,10 +215,12 @@ public void testNotPreCreatedOpNsCreateOperatorNegativeInstall() throws Exceptio\n   }\n \n   /**\n-   * Negative test : Helm will install the operator with not preexisted operator service account,\n-   * deployment will not start until service account will be created.\n+   * Install the operator with non existing operator service account.", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU1MDk3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410550979", "bodyText": "done", "author": "anpanigr", "createdAt": "2020-04-18T01:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODkxNA=="}], "type": "inlineReview", "revised_code": {"commit": "4a5ceaaac5ba0c8badef9fc419b08a9f312ee46a", "chunk": "diff --git a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\nindex e490bdc4ef..35ff62b8d1 100644\n--- a/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n+++ b/integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java\n\n@@ -206,11 +212,11 @@ public class ItUsabilityOperatorHelmChart extends BaseTest {\n     TestUtils.exec(command);\n     try {\n       operator.callHelmInstall();\n-      throw new Exception(\"FAILURE: Helm install operator with not preexisted namespace \");\n-\n+      gotException = false;\n     } catch (Exception ex) {\n-      LoggerHelper.getLocal().log(Level.INFO, \"Helm install operator with not preexisted ns failed as expected\");\n+      LoggerHelper.getLocal().log(Level.INFO, \"Helm install operator with non existing namespace failed as expected\");\n     }\n+    Assertions.assertTrue(gotException, \"Helm install operator with non existing namespace should fail\");\n     LoggerHelper.getLocal().log(Level.INFO, \"SUCCESS - \" + testMethodName);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5OTM4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410499385", "bodyText": "Same comment... I'm less concerned with the fact that Helm failed with a certain message than that the Helm install failed and that the release was not installed.", "author": "rjeberhard", "createdAt": "2020-04-17T22:28:53Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItUsabilityOperatorHelmChart.java", "diffHunk": "@@ -292,10 +285,15 @@ public void testNotPreexistedOpServiceAccountCreateOperatorNegativeInstall() thr\n   }\n \n   /**\n-   * Negative test : Helm will install the second operator with same target domain namespace as the\n-   * first operator.\n+   * Install operator usab-1 with target DomainNameSpace [usab-domainns-1].\n+   * Install operator usab-2 with same target DomainNamesapce [usab-domainns-1].\n+   * Second operator should fail to install with following exception ", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU1MjcxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410552712", "bodyText": "I removed the Helm version check", "author": "anpanigr", "createdAt": "2020-04-18T02:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5OTM4NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5OTkzNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410499934", "bodyText": "Remove support for Helm 2.x", "author": "rjeberhard", "createdAt": "2020-04-17T22:30:53Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java", "diffHunk": "@@ -37,7 +37,7 @@ public LoadBalancer(Map lbMap) throws Exception {\n \n     if (lbMap.get(\"loadBalancer\").equals(\"TRAEFIK\")) {\n       String cmdLb = \"\";\n-      if (! BaseTest.HELM_VERSION.equals(\"V2\")) {\n+      if (BaseTest.HELM_VERSION.equals(\"V2\")) {", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU1MTM5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410551395", "bodyText": "done", "author": "anpanigr", "createdAt": "2020-04-18T01:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5OTkzNA=="}], "type": "inlineReview", "revised_code": {"commit": "10c93d654a307d8bc7c142fdd9db5fbcad44d527", "chunk": "diff --git a/integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java b/integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java\nindex 562da49024..cf5ed1b24e 100644\n--- a/integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java\n+++ b/integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java\n\n@@ -37,11 +37,7 @@ public class LoadBalancer {\n \n     if (lbMap.get(\"loadBalancer\").equals(\"TRAEFIK\")) {\n       String cmdLb = \"\";\n-      if (BaseTest.HELM_VERSION.equals(\"V2\")) {\n-        cmdLb = \"helm list traefik-operator | grep DEPLOYED\";\n-      } else {\n-        cmdLb = \"helm list --namespace traefik | grep traefik-operator | grep -i DEPLOYED\";\n-      }\n+      cmdLb = \"helm list --namespace traefik | grep traefik-operator | grep -i DEPLOYED\";\n       LoggerHelper.getLocal().log(Level.INFO, \"Executing cmd \" + cmdLb);\n       ExecResult result = ExecCommand.exec(cmdLb);\n       if (result.exitValue() != 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDExMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410500113", "bodyText": "Why are you adding the \"--debug\" flag here?  Is it because we are going to assert on debug output?", "author": "rjeberhard", "createdAt": "2020-04-17T22:31:41Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java", "diffHunk": "@@ -146,6 +146,7 @@ private void upgradeTraefikNamespace() throws Exception {\n     StringBuffer cmd = new StringBuffer(\"helm upgrade \");\n     cmd.append(\" traefik-operator\")\n        .append(\" stable/traefik \")\n+       .append(\" --debug \")", "originalCommit": "6d2416d3c6cb992df4df806043adc4ea1cce14cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDc0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1572#discussion_r410500747", "bodyText": "I want to know the reason if the helm command fails so that it will be easier to debug when the test fails", "author": "anpanigr", "createdAt": "2020-04-17T22:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMDExMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4b026a0d5985c0d206e04c05271eca8ed7655a90", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4b026a0d5985c0d206e04c05271eca8ed7655a90", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-18T00:40:00Z", "type": "commit"}, {"oid": "10c93d654a307d8bc7c142fdd9db5fbcad44d527", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/10c93d654a307d8bc7c142fdd9db5fbcad44d527", "message": "Remove support for Helm 2 based on review comments", "committedDate": "2020-04-18T02:05:46Z", "type": "commit"}, {"oid": "99d33f65d89ace1274287279b246ca4e1f9e8847", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/99d33f65d89ace1274287279b246ca4e1f9e8847", "message": "remove helm v2 support from setupenv.sh", "committedDate": "2020-04-19T23:38:55Z", "type": "commit"}, {"oid": "19ca51b8611af44f6b125396634aaa49f0e00cb0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/19ca51b8611af44f6b125396634aaa49f0e00cb0", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-20T18:00:51Z", "type": "commit"}, {"oid": "4a5ceaaac5ba0c8badef9fc419b08a9f312ee46a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4a5ceaaac5ba0c8badef9fc419b08a9f312ee46a", "message": "sync up develop branch, few changes to ItUsabilityOperatorHelmChart class", "committedDate": "2020-04-20T18:02:00Z", "type": "commit"}, {"oid": "694ecbe8babdd8ee540523b35543942520bfb49b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/694ecbe8babdd8ee540523b35543942520bfb49b", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into helm3-setup", "committedDate": "2020-04-21T15:34:22Z", "type": "commit"}, {"oid": "09e2f3ceb9858c48e3839077aa6c2a6249b4b6b7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/09e2f3ceb9858c48e3839077aa6c2a6249b4b6b7", "message": "Update product names", "committedDate": "2020-04-21T21:49:48Z", "type": "commit"}, {"oid": "92c22e4c5aa85883b26b1943978b6b77f2055032", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/92c22e4c5aa85883b26b1943978b6b77f2055032", "message": "Fix a few more", "committedDate": "2020-04-21T21:51:41Z", "type": "commit"}]}