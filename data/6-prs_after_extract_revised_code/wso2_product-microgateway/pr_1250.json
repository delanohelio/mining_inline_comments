{"pr_number": 1250, "pr_title": "Avoid overriding backend auth responses", "pr_createdAt": "2020-05-26T13:17:15Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1250", "timeline": [{"oid": "f13bfec92eff853645658f64a00df5c05b89ca75", "url": "https://github.com/wso2/product-microgateway/commit/f13bfec92eff853645658f64a00df5c05b89ca75", "message": "core: Pass backend error responses to client\n\nissue: #1233\n\nIf backend endpoint reponded with authentication error responses\nsuch as 401 and 403, mgw was responding to client with its own\nauth error response messages. This shouldn't be the case and mgw\nshould pass the backend error message to the client.", "committedDate": "2020-05-26T11:22:31Z", "type": "commit"}, {"oid": "837ffd50cf1a5c5df689098b3e94186c48c70372", "url": "https://github.com/wso2/product-microgateway/commit/837ffd50cf1a5c5df689098b3e94186c48c70372", "message": "core: Pass interceptor response to client\n\nWhen interceptor responds with 401, 403 like error responses,\ngateway should avoid sending it's own response to the client.\nThis fix is an improvement to the fix done in 35a07d7 where\nthat fix fails to identify responses coming from an interceptor.\nWhen an interceptor responds to the client, the developer should\nset RESPOND_DONE property to the invocationContext before calling\nrespond(). Otherwise mgw will not be able to recognize the\nresponse as a response coming from an interceptor.", "committedDate": "2020-05-26T11:22:31Z", "type": "commit"}, {"oid": "d9bd4766610ca7d50d3e0916cea12fbbcc37d646", "url": "https://github.com/wso2/product-microgateway/commit/d9bd4766610ca7d50d3e0916cea12fbbcc37d646", "message": "Add test case for #1233", "committedDate": "2020-05-26T13:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5ODQxNA==", "url": "https://github.com/wso2/product-microgateway/pull/1250#discussion_r432398414", "bodyText": "Lets change the description properly", "author": "Rajith90", "createdAt": "2020-05-29T10:32:48Z", "path": "tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java", "diffHunk": "@@ -52,6 +52,31 @@ public void testPerAPISecureEndpoint() throws Exception {\n         Assert.assertEquals(response.getResponseCode(), 200, \"Response code mismatched\");\n     }\n \n+    @Test(description = \"Test Invoking the resource which endpoint defined at API level using references\")", "originalCommit": "d9bd4766610ca7d50d3e0916cea12fbbcc37d646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyODU3Nw==", "url": "https://github.com/wso2/product-microgateway/pull/1250#discussion_r432428577", "bodyText": "done", "author": "praminda", "createdAt": "2020-05-29T11:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5ODQxNA=="}], "type": "inlineReview", "revised_code": {"commit": "18074ac2814efe2125ca244854a0c296f8940af7", "chunk": "diff --git a/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java b/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\nindex 36a93002b..f76aa49ec 100644\n--- a/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\n+++ b/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\n\n@@ -52,7 +52,7 @@ public class EndpointWithSecurityTestCase extends MultipleEndpointsTestCase {\n         Assert.assertEquals(response.getResponseCode(), 200, \"Response code mismatched\");\n     }\n \n-    @Test(description = \"Test Invoking the resource which endpoint defined at API level using references\")\n+    @Test(description = \"Test invoking a resource with authentication failure.\")\n     public void testSecureEndpointWithAuthnFailure() throws Exception {\n         Map<String, String> headers = new HashMap<>();\n         //test endpoint with token\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5ODUyOQ==", "url": "https://github.com/wso2/product-microgateway/pull/1250#discussion_r432398529", "bodyText": "Lets change the description properly", "author": "Rajith90", "createdAt": "2020-05-29T10:33:02Z", "path": "tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java", "diffHunk": "@@ -52,6 +52,31 @@ public void testPerAPISecureEndpoint() throws Exception {\n         Assert.assertEquals(response.getResponseCode(), 200, \"Response code mismatched\");\n     }\n \n+    @Test(description = \"Test Invoking the resource which endpoint defined at API level using references\")\n+    public void testSecureEndpointWithAuthnFailure() throws Exception {\n+        Map<String, String> headers = new HashMap<>();\n+        //test endpoint with token\n+        headers.put(HttpHeaderNames.AUTHORIZATION.toString(), \"Bearer \" + jwtTokenProd);\n+        org.wso2.micro.gateway.tests.util.HttpResponse response = HttpClientRequest\n+                .doGet(getServiceURLHttp(\"petstore/v5/store/order/1\"), headers);\n+        Assert.assertNotNull(response);\n+        Assert.assertEquals(response.getData(), ResponseConstants.AUTHENTICATION_FAILURE_RESPONSE);\n+        Assert.assertEquals(response.getResponseCode(), 401, \"Response code mismatched\");\n+    }\n+\n+\n+    @Test(description = \"Test Invoking the resource which endpoint defined at API level using references\")", "originalCommit": "d9bd4766610ca7d50d3e0916cea12fbbcc37d646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyODYwMQ==", "url": "https://github.com/wso2/product-microgateway/pull/1250#discussion_r432428601", "bodyText": "done", "author": "praminda", "createdAt": "2020-05-29T11:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5ODUyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "18074ac2814efe2125ca244854a0c296f8940af7", "chunk": "diff --git a/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java b/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\nindex 36a93002b..f76aa49ec 100644\n--- a/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\n+++ b/tests/src/test/java/org/wso2/micro/gateway/tests/endpoints/EndpointWithSecurityTestCase.java\n\n@@ -52,7 +52,7 @@ public class EndpointWithSecurityTestCase extends MultipleEndpointsTestCase {\n         Assert.assertEquals(response.getResponseCode(), 200, \"Response code mismatched\");\n     }\n \n-    @Test(description = \"Test Invoking the resource which endpoint defined at API level using references\")\n+    @Test(description = \"Test invoking a resource with authentication failure.\")\n     public void testSecureEndpointWithAuthnFailure() throws Exception {\n         Map<String, String> headers = new HashMap<>();\n         //test endpoint with token\n"}}, {"oid": "18074ac2814efe2125ca244854a0c296f8940af7", "url": "https://github.com/wso2/product-microgateway/commit/18074ac2814efe2125ca244854a0c296f8940af7", "message": "test: Update test description", "committedDate": "2020-05-29T11:36:22Z", "type": "commit"}]}