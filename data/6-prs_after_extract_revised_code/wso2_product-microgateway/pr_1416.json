{"pr_number": 1416, "pr_title": "Add changes for validating a JWT token.", "pr_createdAt": "2020-09-19T11:30:03Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1416", "timeline": [{"oid": "58c2738c4857c23db4e21789af2ccc2fc99571c4", "url": "https://github.com/wso2/product-microgateway/commit/58c2738c4857c23db4e21789af2ccc2fc99571c4", "message": "Add changes for validating a JWT Token", "committedDate": "2020-09-19T11:20:48Z", "type": "commit"}, {"oid": "39ee12ca9c13f3a4723c6e0ba8a1842cb831aca6", "url": "https://github.com/wso2/product-microgateway/commit/39ee12ca9c13f3a4723c6e0ba8a1842cb831aca6", "message": "Correct formatting change", "committedDate": "2020-09-19T11:24:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ1Nzc3NA==", "url": "https://github.com/wso2/product-microgateway/pull/1416#discussion_r491457774", "bodyText": "Need to add a proper logging library", "author": "Rajith90", "createdAt": "2020-09-19T14:35:21Z", "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.mgw.filterchain.JWTValidator;\n+\n+import com.nimbusds.jose.JWSAlgorithm;\n+import com.nimbusds.jose.JWSVerifier;\n+import com.nimbusds.jose.crypto.RSASSAVerifier;\n+import java.io.BufferedReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.security.KeyFactory;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.interfaces.RSAPublicKey;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.X509EncodedKeySpec;\n+import java.text.ParseException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Map;\n+import com.nimbusds.jose.JOSEException;\n+import com.nimbusds.jose.JWSHeader;\n+import com.nimbusds.jwt.JWTClaimsSet;\n+import com.nimbusds.jwt.JWTParser;\n+import com.nimbusds.jwt.SignedJWT;\n+\n+public class JWTValidator{\n+    //validate JWT token\n+    public static boolean validateToken () {\n+        boolean valid = false;\n+        HashMap<String, String> request = new HashMap<String, String>();\n+        request.put(JWTConstants.AUTHORIZATION, JWTConstants.JWT_TOKEN);\n+        for (Map.Entry mapElement : request.entrySet()) {\n+            String key = (String) mapElement.getKey();\n+            if (key == JWTConstants.AUTHORIZATION) {\n+                valid = HandleJWT(request);\n+                break;\n+            }\n+        }\n+        return valid;\n+    }\n+    //handle JWT token\n+    public static boolean HandleJWT(HashMap<String, String> requestAttributes){\n+        String accessToken = requestAttributes.get(JWTConstants.AUTHORIZATION);\n+        String[] tokenContent = accessToken.split(\"\\\\.\");\n+\n+        if(tokenContent.length != 3){\n+            System.out.println(\"Invalid JWT token received, token must have 3 parts\");", "originalCommit": "39ee12ca9c13f3a4723c6e0ba8a1842cb831aca6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d1c16d1ec37d0769b29beb64b4ed486b9553b3e", "chunk": "diff --git a/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java b/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\nindex 97b8e8317..e85d9d48d 100644\n--- a/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\n+++ b/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\n\n@@ -40,6 +40,7 @@ import com.nimbusds.jwt.JWTParser;\n import com.nimbusds.jwt.SignedJWT;\n \n public class JWTValidator{\n+    private static RSAPublicKey publicKey = readPublicKey();\n     //validate JWT token\n     public static boolean validateToken () {\n         boolean valid = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ1ODAwMA==", "url": "https://github.com/wso2/product-microgateway/pull/1416#discussion_r491458000", "bodyText": "Lets do this once, not at every request", "author": "Rajith90", "createdAt": "2020-09-19T14:36:00Z", "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.mgw.filterchain.JWTValidator;\n+\n+import com.nimbusds.jose.JWSAlgorithm;\n+import com.nimbusds.jose.JWSVerifier;\n+import com.nimbusds.jose.crypto.RSASSAVerifier;\n+import java.io.BufferedReader;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.security.KeyFactory;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.interfaces.RSAPublicKey;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.X509EncodedKeySpec;\n+import java.text.ParseException;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Map;\n+import com.nimbusds.jose.JOSEException;\n+import com.nimbusds.jose.JWSHeader;\n+import com.nimbusds.jwt.JWTClaimsSet;\n+import com.nimbusds.jwt.JWTParser;\n+import com.nimbusds.jwt.SignedJWT;\n+\n+public class JWTValidator{\n+    //validate JWT token\n+    public static boolean validateToken () {\n+        boolean valid = false;\n+        HashMap<String, String> request = new HashMap<String, String>();\n+        request.put(JWTConstants.AUTHORIZATION, JWTConstants.JWT_TOKEN);\n+        for (Map.Entry mapElement : request.entrySet()) {\n+            String key = (String) mapElement.getKey();\n+            if (key == JWTConstants.AUTHORIZATION) {\n+                valid = HandleJWT(request);\n+                break;\n+            }\n+        }\n+        return valid;\n+    }\n+    //handle JWT token\n+    public static boolean HandleJWT(HashMap<String, String> requestAttributes){\n+        String accessToken = requestAttributes.get(JWTConstants.AUTHORIZATION);\n+        String[] tokenContent = accessToken.split(\"\\\\.\");\n+\n+        if(tokenContent.length != 3){\n+            System.out.println(\"Invalid JWT token received, token must have 3 parts\");\n+        }\n+        String signedContent = tokenContent[0] + \".\" + tokenContent[1];\n+        //System.out.println(signedContent);\n+        boolean isVerified = validateSignature(accessToken, tokenContent[2]);\n+        if(isVerified){\n+            System.out.println(\"JWT Token is valid\");\n+        } else {\n+            System.out.println(\"JWT Token is not valid\");\n+        }\n+        return isVerified;\n+    }\n+\n+    // validate the signature\n+    public static boolean validateSignature(String jwtToken, String signature){\n+        System.out.println(\"Inside validateSignature\");\n+        JWSHeader header;\n+        JWTClaimsSet payload = null;\n+        SignedJWT parsedJWTToken;\n+        boolean isVerified = false;\n+        try{\n+            parsedJWTToken = (SignedJWT) JWTParser.parse(jwtToken);\n+            isVerified = verifyTokenSignature(parsedJWTToken);\n+        }catch (ParseException e) {\n+            System.out.println(\"Invalid JWT token. Failed to decode the token.\");\n+        }\n+        return isVerified;\n+    }\n+\n+    public static boolean verifyTokenSignature(SignedJWT parsedJWTToken) {\n+        RSAPublicKey publicKey = readPublicKey();", "originalCommit": "39ee12ca9c13f3a4723c6e0ba8a1842cb831aca6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d1c16d1ec37d0769b29beb64b4ed486b9553b3e", "chunk": "diff --git a/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java b/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\nindex 97b8e8317..e85d9d48d 100644\n--- a/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\n+++ b/java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java\n\n@@ -40,6 +40,7 @@ import com.nimbusds.jwt.JWTParser;\n import com.nimbusds.jwt.SignedJWT;\n \n public class JWTValidator{\n+    private static RSAPublicKey publicKey = readPublicKey();\n     //validate JWT token\n     public static boolean validateToken () {\n         boolean valid = false;\n"}}, {"oid": "9d1c16d1ec37d0769b29beb64b4ed486b9553b3e", "url": "https://github.com/wso2/product-microgateway/commit/9d1c16d1ec37d0769b29beb64b4ed486b9553b3e", "message": "Add changes to read public key only once", "committedDate": "2020-09-20T06:46:34Z", "type": "commit"}]}