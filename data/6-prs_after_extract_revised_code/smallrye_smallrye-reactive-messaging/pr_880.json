{"pr_number": 880, "pr_title": "Copy header from the origin header in dead letter queue", "pr_createdAt": "2020-11-30T16:27:48Z", "pr_url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/880", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2ODE4MQ==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/880#discussion_r532768181", "bodyText": "We can introduce huge string creation and even invalid strings\nCan you switch to:\nrecord.getHeaders().forEach(header -> dead.addHeader(KafkaHeader.header(header.key(), Buffer.buffer(header.value()))));", "author": "cescoffier", "createdAt": "2020-11-30T17:24:03Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/fault/KafkaDeadLetterQueue.java", "diffHunk": "@@ -102,6 +102,7 @@ private String getThrowableMessage(Throwable throwable) {\n         dead.addHeader(DEAD_LETTER_TOPIC, record.getTopic());\n         dead.addHeader(DEAD_LETTER_PARTITION, Integer.toString(record.getPartition()));\n         dead.addHeader(DEAD_LETTER_OFFSET, Long.toString(record.getOffset()));\n+        record.getHeaders().forEach(header -> dead.addHeader(header.key(), new String(header.value())));", "originalCommit": "673d74edb09b773137b80371f6bd19aa9aad557c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE5NjA4Ng==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/880#discussion_r533196086", "bodyText": "done", "author": "loicmathieu", "createdAt": "2020-12-01T09:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2ODE4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7eb47cdeaf8eb7a3ce13e0d2f103451c02abdd45", "chunk": "diff --git a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/fault/KafkaDeadLetterQueue.java b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/fault/KafkaDeadLetterQueue.java\nindex 0aefa2948..8dcf131c2 100644\n--- a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/fault/KafkaDeadLetterQueue.java\n+++ b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/fault/KafkaDeadLetterQueue.java\n\n@@ -102,7 +103,7 @@ public class KafkaDeadLetterQueue implements KafkaFailureHandler {\n         dead.addHeader(DEAD_LETTER_TOPIC, record.getTopic());\n         dead.addHeader(DEAD_LETTER_PARTITION, Integer.toString(record.getPartition()));\n         dead.addHeader(DEAD_LETTER_OFFSET, Long.toString(record.getOffset()));\n-        record.getHeaders().forEach(header -> dead.addHeader(header.key(), new String(header.value())));\n+        record.getHeaders().forEach(header -> dead.addHeader(header.key(), Buffer.buffer(header.value())));\n         log.messageNackedDeadLetter(channel, topic);\n         return producer.send(dead)\n                 .onFailure().invoke(t -> source.reportFailure((Throwable) t, true))\n"}}, {"oid": "7eb47cdeaf8eb7a3ce13e0d2f103451c02abdd45", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/7eb47cdeaf8eb7a3ce13e0d2f103451c02abdd45", "message": "Copy header from the origin header in dead letter queue", "committedDate": "2020-12-01T09:05:44Z", "type": "forcePushed"}, {"oid": "1ee413c677a2dbd26e00fcea9505e540d69c6853", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1ee413c677a2dbd26e00fcea9505e540d69c6853", "message": "Copy header from the origin header in dead letter queue", "committedDate": "2020-12-01T09:09:23Z", "type": "commit"}, {"oid": "1ee413c677a2dbd26e00fcea9505e540d69c6853", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1ee413c677a2dbd26e00fcea9505e540d69c6853", "message": "Copy header from the origin header in dead letter queue", "committedDate": "2020-12-01T09:09:23Z", "type": "forcePushed"}, {"oid": "bc60f7a882e5152f2057a605d0c681fcf0131cfb", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/bc60f7a882e5152f2057a605d0c681fcf0131cfb", "message": "Copy header from the origin header in dead letter queue", "committedDate": "2020-12-01T09:09:01Z", "type": "forcePushed"}]}