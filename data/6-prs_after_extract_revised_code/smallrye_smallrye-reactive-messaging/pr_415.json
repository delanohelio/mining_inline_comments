{"pr_number": 415, "pr_title": "Change default for retry-attempts to infinite retries", "pr_createdAt": "2020-02-11T19:55:32Z", "pr_url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEwNTY0MA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r381105640", "bodyText": "Minor - I generally use -1 for infinite, but null is ok.", "author": "cescoffier", "createdAt": "2020-02-19T06:55:24Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java", "diffHunk": "@@ -65,11 +65,17 @@ public KafkaSource(Vertx vertx, Config config, String servers) {\n                 .doOnError(t -> LOGGER.error(\"Unable to read a record from Kafka topic '{}'\", topic, t));\n \n         if (config.getOptionalValue(\"retry\", Boolean.class).orElse(true)) {\n-            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(5);\n-            flowable = flowable\n+            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(null);", "originalCommit": "291fdb9d910ba7e2d71310da8ed552ad94350c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwMjAxNg==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r382202016", "bodyText": "Noted! Will change it to -1", "author": "thescouser89", "createdAt": "2020-02-20T19:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEwNTY0MA=="}], "type": "inlineReview", "revised_code": {"commit": "c0da59e68b955346dbe06c86c2cfc2dcc086fcd9", "chunk": "diff --git a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\nindex d3fc4afbe..29be00b7e 100644\n--- a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n+++ b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n\n@@ -65,16 +65,29 @@ public class KafkaSource<K, V> {\n                 .doOnError(t -> LOGGER.error(\"Unable to read a record from Kafka topic '{}'\", topic, t));\n \n         if (config.getOptionalValue(\"retry\", Boolean.class).orElse(true)) {\n-            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(null);\n+            int max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(-1);\n+            int retryMaxWait = config.getOptionalValue(\"retry-max-wait\", Integer.class).orElse(30);\n \n-            if (max == null) {\n+            if (max == -1) {\n                 // always retry\n-                flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> Flowable.timer(10, TimeUnit.SECONDS)));\n+                final int[] CURRENT_WAIT_SECOND = { 1 };\n+\n+                flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> {\n+\n+                    if ((CURRENT_WAIT_SECOND[0] << 1) < retryMaxWait) {\n+                        // exponential backoff\n+                        CURRENT_WAIT_SECOND[0] = CURRENT_WAIT_SECOND[0] << 1;\n+                    } else {\n+                        // if next wait time is greater than maxWaitAttemptSeconds, reset it to maxWaitAttemptSeconds\n+                        CURRENT_WAIT_SECOND[0] = retryMaxWait;\n+                    }\n+                    return Flowable.timer(CURRENT_WAIT_SECOND[0], TimeUnit.SECONDS);\n+                }));\n             } else {\n                 flowable = flowable\n-                    .retryWhen(attempts -> attempts\n-                        .zipWith(Flowable.range(1, max), (n, i) -> i)\n-                        .flatMap(i -> Flowable.timer(i, TimeUnit.SECONDS)));\n+                        .retryWhen(attempts -> attempts\n+                                .zipWith(Flowable.range(1, max), (n, i) -> i)\n+                                .flatMap(i -> Flowable.timer(i, TimeUnit.SECONDS)));\n             }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEwNTgwOQ==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r381105809", "bodyText": "Wondering if we should implement some kind of exponential backoff. WDYT?", "author": "cescoffier", "createdAt": "2020-02-19T06:55:54Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java", "diffHunk": "@@ -65,11 +65,17 @@ public KafkaSource(Vertx vertx, Config config, String servers) {\n                 .doOnError(t -> LOGGER.error(\"Unable to read a record from Kafka topic '{}'\", topic, t));\n \n         if (config.getOptionalValue(\"retry\", Boolean.class).orElse(true)) {\n-            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(5);\n-            flowable = flowable\n+            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(null);\n+\n+            if (max == null) {\n+                // always retry\n+                flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> Flowable.timer(10, TimeUnit.SECONDS)));", "originalCommit": "291fdb9d910ba7e2d71310da8ed552ad94350c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwMTkxMQ==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r382201911", "bodyText": "Exponential backoff sounds good! Do you think it makes sense to backing off up to a max level?", "author": "thescouser89", "createdAt": "2020-02-20T19:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEwNTgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExMjIxNg==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r383112216", "bodyText": "Yes, something like 30 seconds max between attempt.", "author": "cescoffier", "createdAt": "2020-02-24T07:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEwNTgwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c0da59e68b955346dbe06c86c2cfc2dcc086fcd9", "chunk": "diff --git a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\nindex d3fc4afbe..29be00b7e 100644\n--- a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n+++ b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n\n@@ -65,16 +65,29 @@ public class KafkaSource<K, V> {\n                 .doOnError(t -> LOGGER.error(\"Unable to read a record from Kafka topic '{}'\", topic, t));\n \n         if (config.getOptionalValue(\"retry\", Boolean.class).orElse(true)) {\n-            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(null);\n+            int max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(-1);\n+            int retryMaxWait = config.getOptionalValue(\"retry-max-wait\", Integer.class).orElse(30);\n \n-            if (max == null) {\n+            if (max == -1) {\n                 // always retry\n-                flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> Flowable.timer(10, TimeUnit.SECONDS)));\n+                final int[] CURRENT_WAIT_SECOND = { 1 };\n+\n+                flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> {\n+\n+                    if ((CURRENT_WAIT_SECOND[0] << 1) < retryMaxWait) {\n+                        // exponential backoff\n+                        CURRENT_WAIT_SECOND[0] = CURRENT_WAIT_SECOND[0] << 1;\n+                    } else {\n+                        // if next wait time is greater than maxWaitAttemptSeconds, reset it to maxWaitAttemptSeconds\n+                        CURRENT_WAIT_SECOND[0] = retryMaxWait;\n+                    }\n+                    return Flowable.timer(CURRENT_WAIT_SECOND[0], TimeUnit.SECONDS);\n+                }));\n             } else {\n                 flowable = flowable\n-                    .retryWhen(attempts -> attempts\n-                        .zipWith(Flowable.range(1, max), (n, i) -> i)\n-                        .flatMap(i -> Flowable.timer(i, TimeUnit.SECONDS)));\n+                        .retryWhen(attempts -> attempts\n+                                .zipWith(Flowable.range(1, max), (n, i) -> i)\n+                                .flatMap(i -> Flowable.timer(i, TimeUnit.SECONDS)));\n             }\n         }\n \n"}}, {"oid": "c0da59e68b955346dbe06c86c2cfc2dcc086fcd9", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/c0da59e68b955346dbe06c86c2cfc2dcc086fcd9", "message": "Change default for retry-attempts to infinite retries\n\nIf not specified by the user, the default retry behaviour is to always\nretry, with an exponential backoff wait time, up to the retry max wait\ntime (30 seconds by default).\n\nIf the user specify a retry-attempts, then the nubmer of retries will be\nlimited to that number.\n\nA new env var is also introduced, 'retry-max-wait'. It is used to set\nthe max wait time in seconds between retries, with a default of 30\nseconds.", "committedDate": "2020-02-25T20:40:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxMzk0OA==", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/415#discussion_r384313948", "bodyText": "Should be an AtomicInteger.", "author": "cescoffier", "createdAt": "2020-02-26T07:32:15Z", "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java", "diffHunk": "@@ -65,11 +65,30 @@ public KafkaSource(Vertx vertx, Config config, String servers) {\n                 .doOnError(t -> LOGGER.error(\"Unable to read a record from Kafka topic '{}'\", topic, t));\n \n         if (config.getOptionalValue(\"retry\", Boolean.class).orElse(true)) {\n-            Integer max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(5);\n-            flowable = flowable\n-                    .retryWhen(attempts -> attempts\n-                            .zipWith(Flowable.range(1, max), (n, i) -> i)\n-                            .flatMap(i -> Flowable.timer(i, TimeUnit.SECONDS)));\n+            int max = config.getOptionalValue(\"retry-attempts\", Integer.class).orElse(-1);\n+            int retryMaxWait = config.getOptionalValue(\"retry-max-wait\", Integer.class).orElse(30);\n+\n+            if (max == -1) {\n+                // always retry\n+                final int[] CURRENT_WAIT_SECOND = { 1 };", "originalCommit": "c0da59e68b955346dbe06c86c2cfc2dcc086fcd9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a14cc705a77fab6d08d8da737641c1c012c0e4f", "chunk": "diff --git a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\nindex 29be00b7e..07c373bd6 100644\n--- a/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n+++ b/smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java\n\n@@ -70,18 +71,14 @@ public class KafkaSource<K, V> {\n \n             if (max == -1) {\n                 // always retry\n-                final int[] CURRENT_WAIT_SECOND = { 1 };\n+                final AtomicInteger CURRENT_WAIT_SECOND = new AtomicInteger(1) ;\n \n                 flowable = flowable.retryWhen(attempts -> attempts.flatMap(i -> {\n \n-                    if ((CURRENT_WAIT_SECOND[0] << 1) < retryMaxWait) {\n-                        // exponential backoff\n-                        CURRENT_WAIT_SECOND[0] = CURRENT_WAIT_SECOND[0] << 1;\n-                    } else {\n-                        // if next wait time is greater than maxWaitAttemptSeconds, reset it to maxWaitAttemptSeconds\n-                        CURRENT_WAIT_SECOND[0] = retryMaxWait;\n-                    }\n-                    return Flowable.timer(CURRENT_WAIT_SECOND[0], TimeUnit.SECONDS);\n+                    // exponential backoff\n+                    // if next wait time is greater than maxWaitAttemptSeconds, reset it to maxWaitAttemptSeconds\n+                    CURRENT_WAIT_SECOND.set(Math.min((CURRENT_WAIT_SECOND.get() << 1), retryMaxWait));\n+                    return Flowable.timer(CURRENT_WAIT_SECOND.get(), TimeUnit.SECONDS);\n                 }));\n             } else {\n                 flowable = flowable\n"}}, {"oid": "6a14cc705a77fab6d08d8da737641c1c012c0e4f", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/6a14cc705a77fab6d08d8da737641c1c012c0e4f", "message": "Change default for retry-attempts to infinite retries\n\nIf not specified by the user, the default retry behaviour is to always\nretry, with an exponential backoff wait time, up to the retry max wait\ntime (30 seconds by default).\n\nIf the user specify a retry-attempts, then the nubmer of retries will be\nlimited to that number.\n\nA new env var is also introduced, 'retry-max-wait'. It is used to set\nthe max wait time in seconds between retries, with a default of 30\nseconds.", "committedDate": "2020-02-26T20:18:25Z", "type": "forcePushed"}, {"oid": "eb76ab8c09e171ca562f93281076494ec4131a3a", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/eb76ab8c09e171ca562f93281076494ec4131a3a", "message": "Change default for retry-attempts to infinite retries\n\nIf not specified by the user, the default retry behaviour is to always\nretry, with an exponential backoff wait time, up to the retry max wait\ntime (30 seconds by default).\n\nIf the user specify a retry-attempts, then the nubmer of retries will be\nlimited to that number.\n\nA new env var is also introduced, 'retry-max-wait'. It is used to set\nthe max wait time in seconds between retries, with a default of 30\nseconds.", "committedDate": "2020-02-26T20:21:28Z", "type": "commit"}, {"oid": "eb76ab8c09e171ca562f93281076494ec4131a3a", "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/eb76ab8c09e171ca562f93281076494ec4131a3a", "message": "Change default for retry-attempts to infinite retries\n\nIf not specified by the user, the default retry behaviour is to always\nretry, with an exponential backoff wait time, up to the retry max wait\ntime (30 seconds by default).\n\nIf the user specify a retry-attempts, then the nubmer of retries will be\nlimited to that number.\n\nA new env var is also introduced, 'retry-max-wait'. It is used to set\nthe max wait time in seconds between retries, with a default of 30\nseconds.", "committedDate": "2020-02-26T20:21:28Z", "type": "forcePushed"}]}