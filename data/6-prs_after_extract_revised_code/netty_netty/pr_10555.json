{"pr_number": 10555, "pr_title": "Allow to specify a callback that is executed once submit was called and", "pr_createdAt": "2020-09-09T07:44:23Z", "pr_url": "https://github.com/netty/netty/pull/10555", "timeline": [{"oid": "0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "url": "https://github.com/netty/netty/commit/0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "message": "Allow to specify a callback that is executed once submit was called and\nuse it for clearing the IovArrays\n\nMotivation:\n\nIOUringSubmissionQueue may call submit() internally when there is no\nspace left in the buffer. Once this is done we can reuse for example\nIovArrays etc. Because of this its useful to be able to specify a\ncallback that is executed after submission\n\nModifications:\n\n- Allow to specify a Runnable that is called once submission was\ncomplete\n- Use this callback to clear the IovArrays\n\nResult:\n\nIovArrays are automatically cleared on each submit call.", "committedDate": "2020-09-09T07:51:59Z", "type": "commit"}, {"oid": "0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "url": "https://github.com/netty/netty/commit/0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "message": "Allow to specify a callback that is executed once submit was called and\nuse it for clearing the IovArrays\n\nMotivation:\n\nIOUringSubmissionQueue may call submit() internally when there is no\nspace left in the buffer. Once this is done we can reuse for example\nIovArrays etc. Because of this its useful to be able to specify a\ncallback that is executed after submission\n\nModifications:\n\n- Allow to specify a Runnable that is called once submission was\ncomplete\n- Use this callback to clear the IovArrays\n\nResult:\n\nIovArrays are automatically cleared on each submit call.", "committedDate": "2020-09-09T07:51:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNjIzMQ==", "url": "https://github.com/netty/netty/pull/10555#discussion_r485636231", "bodyText": "I increasingly want the IovArray[8] to be encapsulated in its own component, which we could then ask for a clear-callback. Then we could also test it independently.", "author": "chrisvest", "createdAt": "2020-09-09T14:01:53Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,7 +65,14 @@\n         for (int i = 0; i < iovArrays.length; i++) {\n             iovArrays[i] = new IovArray();\n         }\n-        ringBuffer = Native.createRingBuffer();\n+        ringBuffer = Native.createRingBuffer(new Runnable() {\n+            @Override\n+            public void run() {\n+                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n+                clearUsedIovArrays();\n+            }\n+        });", "originalCommit": "0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NDMzNw==", "url": "https://github.com/netty/netty/pull/10555#discussion_r485644337", "bodyText": "I can do this... But lets do this as a followup..", "author": "normanmaurer", "createdAt": "2020-09-09T14:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNjIzMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNzYyMg==", "url": "https://github.com/netty/netty/pull/10555#discussion_r485637622", "bodyText": "Could we perhaps wire this up after construction, so we don't need to pass the callback through so many layers?", "author": "chrisvest", "createdAt": "2020-09-09T14:03:45Z", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringSubmissionQueue.java", "diffHunk": "@@ -86,7 +87,7 @@\n         this.ringSize = ringSize;\n         this.ringAddress = ringAddress;\n         this.ringFd = ringFd;\n-\n+        this.submissionCallback = submissionCallback;", "originalCommit": "0a04d7cf3f0a33f9d268c752a3d68bea4c4c9bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0MzYwMA==", "url": "https://github.com/netty/netty/pull/10555#discussion_r485643600", "bodyText": "@chrisvest I would like to keep it as it is ... wiring up things after construction is more error-prone and this one is easy to pass through.", "author": "normanmaurer", "createdAt": "2020-09-09T14:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNzYyMg=="}], "type": "inlineReview", "revised_code": null}]}