{"pr_number": 10253, "pr_title": "Use `io.netty.recycler.ratio` directly", "pr_createdAt": "2020-05-07T06:15:36Z", "pr_url": "https://github.com/netty/netty/pull/10253", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2MzY3OQ==", "url": "https://github.com/netty/netty/pull/10253#discussion_r421263679", "bodyText": "as the ratio is used with bitmask operations we need to have it either be 0 or have it be a power of two. So this change and the one below is not correct", "author": "normanmaurer", "createdAt": "2020-05-07T06:18:06Z", "path": "common/src/main/java/io/netty/util/Recycler.java", "diffHunk": "@@ -85,7 +85,7 @@ public void recycle(Object object) {\n         // By default we allow one push to a Recycler for each 8th try on handles that were never recycled before.\n         // This should help to slowly increase the capacity of the recycler while not be too sensitive to allocation\n         // bursts.\n-        RATIO = safeFindNextPositivePowerOfTwo(SystemPropertyUtil.getInt(\"io.netty.recycler.ratio\", 8));\n+        RATIO = max(0, SystemPropertyUtil.getInt(\"io.netty.recycler.ratio\", 8));", "originalCommit": "b91559d4458b09a5b927c7c6ec6e8d2fb6e93e8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjM0NQ==", "url": "https://github.com/netty/netty/pull/10253#discussion_r421266345", "bodyText": "This commit 17bffce remove the use of ratioMask. So it doesn't need to power of two now?", "author": "louxiu", "createdAt": "2020-05-07T06:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2MzY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NzEzNQ==", "url": "https://github.com/netty/netty/pull/10253#discussion_r421267135", "bodyText": "ah sorry... I looked at the old code. You are right.", "author": "normanmaurer", "createdAt": "2020-05-07T06:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2MzY3OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1ed0f213945625d861a31488ad62ecca9e6e5129", "url": "https://github.com/netty/netty/commit/1ed0f213945625d861a31488ad62ecca9e6e5129", "message": "Use `io.netty.recycler.ratio` directly\n\nMotivation\n\n1. It's inable to collect all object because RATIO is always >=1 after\n`safeFindNextPositivePowerOfTwo`\n\n2. Enable drop object in `WeakOrderQueue`(commit:\n71860e5b94dbc665fdb8d279d3780d6fe1c618ea) enlarge the drop ratio. We\ncan subtly control the overall drop ratio by using `io.netty.recycler.ratio` directly,\n\nModification\n\n- Remove `safeFindNextPositivePowerOfTwo` before set the ratio\n\nResults\n\nAble to disable drop when recycle object", "committedDate": "2020-05-07T06:52:42Z", "type": "commit"}, {"oid": "1ed0f213945625d861a31488ad62ecca9e6e5129", "url": "https://github.com/netty/netty/commit/1ed0f213945625d861a31488ad62ecca9e6e5129", "message": "Use `io.netty.recycler.ratio` directly\n\nMotivation\n\n1. It's inable to collect all object because RATIO is always >=1 after\n`safeFindNextPositivePowerOfTwo`\n\n2. Enable drop object in `WeakOrderQueue`(commit:\n71860e5b94dbc665fdb8d279d3780d6fe1c618ea) enlarge the drop ratio. We\ncan subtly control the overall drop ratio by using `io.netty.recycler.ratio` directly,\n\nModification\n\n- Remove `safeFindNextPositivePowerOfTwo` before set the ratio\n\nResults\n\nAble to disable drop when recycle object", "committedDate": "2020-05-07T06:52:42Z", "type": "forcePushed"}]}