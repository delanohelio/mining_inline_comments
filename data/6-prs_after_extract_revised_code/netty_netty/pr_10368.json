{"pr_number": 10368, "pr_title": "Improve predictability of writeUtf8/writeAscii performance", "pr_createdAt": "2020-06-23T07:55:19Z", "pr_url": "https://github.com/netty/netty/pull/10368", "timeline": [{"oid": "9f3d7917dbaacdf738c400c72575dbdc8aad5a3c", "url": "https://github.com/netty/netty/commit/9f3d7917dbaacdf738c400c72575dbdc8aad5a3c", "message": "Makes xxxWriteUtf8 methods not inlineable to prevent futher nested calls to NOT being inlined", "committedDate": "2020-06-23T15:19:48Z", "type": "forcePushed"}, {"oid": "e3ccbc4b2b01b20badb2933c452ea7cebc5d9430", "url": "https://github.com/netty/netty/commit/e3ccbc4b2b01b20badb2933c452ea7cebc5d9430", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-06-27T07:26:10Z", "type": "forcePushed"}, {"oid": "6bad80acab2b529a5c90485546a638be0724ee85", "url": "https://github.com/netty/netty/commit/6bad80acab2b529a5c90485546a638be0724ee85", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-06-27T14:39:19Z", "type": "forcePushed"}, {"oid": "552a6e13299e2dd55a9bf8c39b9ee1a242948469", "url": "https://github.com/netty/netty/commit/552a6e13299e2dd55a9bf8c39b9ee1a242948469", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-06-29T09:47:19Z", "type": "forcePushed"}, {"oid": "0d1deeda57f7e33c2094d0aa7fefcf5b7db5f0ff", "url": "https://github.com/netty/netty/commit/0d1deeda57f7e33c2094d0aa7fefcf5b7db5f0ff", "message": "Adding fast-path writeAscii method specialized for AsciiString", "committedDate": "2020-07-21T10:39:54Z", "type": "forcePushed"}, {"oid": "032d2075ff3d7fc1dff2c016b8a1ed84c7a41a55", "url": "https://github.com/netty/netty/commit/032d2075ff3d7fc1dff2c016b8a1ed84c7a41a55", "message": "Adding fast-path writeAscii method specialized for AsciiString", "committedDate": "2020-07-21T11:23:02Z", "type": "forcePushed"}, {"oid": "49345b2bcdfecebe6a11bb72e1ac2c13f89f1d50", "url": "https://github.com/netty/netty/commit/49345b2bcdfecebe6a11bb72e1ac2c13f89f1d50", "message": "Adding fast-path writeAscii method specialized for AsciiString", "committedDate": "2020-07-21T11:24:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNjcxOQ==", "url": "https://github.com/netty/netty/pull/10368#discussion_r458426719", "bodyText": "nit: I know it was there before, but could get rid of written here and just use len directly in it's place", "author": "njhill", "createdAt": "2020-07-21T22:31:22Z", "path": "buffer/src/main/java/io/netty/buffer/ByteBufUtil.java", "diffHunk": "@@ -723,32 +807,32 @@ public static ByteBuf writeAscii(ByteBufAllocator alloc, CharSequence seq) {\n      */\n     public static int writeAscii(ByteBuf buf, CharSequence seq) {\n         // ASCII uses 1 byte per char\n-        final int len = seq.length();\n-        if (seq instanceof AsciiString) {\n-            AsciiString asciiString = (AsciiString) seq;\n-            buf.writeBytes(asciiString.array(), asciiString.arrayOffset(), len);\n-        } else {\n-            for (;;) {\n-                if (buf instanceof WrappedCompositeByteBuf) {\n-                    // WrappedCompositeByteBuf is a sub-class of AbstractByteBuf so it needs special handling.\n-                    buf = buf.unwrap();\n-                } else if (buf instanceof AbstractByteBuf) {\n-                    AbstractByteBuf byteBuf = (AbstractByteBuf) buf;\n-                    byteBuf.ensureWritable0(len);\n-                    int written = writeAscii(byteBuf, byteBuf.writerIndex, seq, len);\n-                    byteBuf.writerIndex += written;\n-                    return written;\n-                } else if (buf instanceof WrappedByteBuf) {\n-                    // Unwrap as the wrapped buffer may be an AbstractByteBuf and so we can use fast-path.\n-                    buf = buf.unwrap();\n+        for (;;) {\n+            if (buf instanceof WrappedCompositeByteBuf) {\n+                // WrappedCompositeByteBuf is a sub-class of AbstractByteBuf so it needs special handling.\n+                buf = buf.unwrap();\n+            } else if (buf instanceof AbstractByteBuf) {\n+                final int len = seq.length();\n+                AbstractByteBuf byteBuf = (AbstractByteBuf) buf;\n+                byteBuf.ensureWritable0(len);\n+                int written;", "originalCommit": "49345b2bcdfecebe6a11bb72e1ac2c13f89f1d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dd285ad982b925a450487cdb069516da1a570358", "chunk": "diff --git a/buffer/src/main/java/io/netty/buffer/ByteBufUtil.java b/buffer/src/main/java/io/netty/buffer/ByteBufUtil.java\nindex cbebff4234..b2b0d04fe2 100644\n--- a/buffer/src/main/java/io/netty/buffer/ByteBufUtil.java\n+++ b/buffer/src/main/java/io/netty/buffer/ByteBufUtil.java\n\n@@ -815,15 +816,14 @@ public final class ByteBufUtil {\n                 final int len = seq.length();\n                 AbstractByteBuf byteBuf = (AbstractByteBuf) buf;\n                 byteBuf.ensureWritable0(len);\n-                int written;\n                 if (seq instanceof AsciiString) {\n-                    written = len;\n                     writeAsciiString(byteBuf, byteBuf.writerIndex, (AsciiString) seq, 0, len);\n                 } else {\n-                    written = writeAscii(byteBuf, byteBuf.writerIndex, seq, len);\n+                    final int written = writeAscii(byteBuf, byteBuf.writerIndex, seq, len);\n+                    assert written == len;\n                 }\n-                byteBuf.writerIndex += written;\n-                return written;\n+                byteBuf.writerIndex += len;\n+                return len;\n             } else if (buf instanceof WrappedByteBuf) {\n                 // Unwrap as the wrapped buffer may be an AbstractByteBuf and so we can use fast-path.\n                 buf = buf.unwrap();\n"}}, {"oid": "dd285ad982b925a450487cdb069516da1a570358", "url": "https://github.com/netty/netty/commit/dd285ad982b925a450487cdb069516da1a570358", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-07-22T08:43:25Z", "type": "forcePushed"}, {"oid": "5e5875460dad4dd7fbcaa7d756085b7097741cc3", "url": "https://github.com/netty/netty/commit/5e5875460dad4dd7fbcaa7d756085b7097741cc3", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-07-22T14:13:10Z", "type": "forcePushed"}, {"oid": "7ee4a10535756e38e773260ecbd62e6c894949f9", "url": "https://github.com/netty/netty/commit/7ee4a10535756e38e773260ecbd62e6c894949f9", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-27T07:59:29Z", "type": "forcePushed"}, {"oid": "2dd2807c1b1fab1c5e8544529cd778eca99e4282", "url": "https://github.com/netty/netty/commit/2dd2807c1b1fab1c5e8544529cd778eca99e4282", "message": "Improve predictability of writeUtf8 performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-27T09:24:38Z", "type": "forcePushed"}, {"oid": "dd03fe35bc18a52067be9f1b363d9b6c3b45b9dd", "url": "https://github.com/netty/netty/commit/dd03fe35bc18a52067be9f1b363d9b6c3b45b9dd", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-27T09:27:22Z", "type": "forcePushed"}, {"oid": "97347199b564596e04492e975671cbee32a26637", "url": "https://github.com/netty/netty/commit/97347199b564596e04492e975671cbee32a26637", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-27T12:03:04Z", "type": "forcePushed"}, {"oid": "c6df6c8b3235307e56a2b86080dbfd2a1585ab88", "url": "https://github.com/netty/netty/commit/c6df6c8b3235307e56a2b86080dbfd2a1585ab88", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-27T12:14:18Z", "type": "forcePushed"}, {"oid": "50349a0c998048db5c447b070570c7f47c50f8dc", "url": "https://github.com/netty/netty/commit/50349a0c998048db5c447b070570c7f47c50f8dc", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-08-28T08:57:20Z", "type": "forcePushed"}, {"oid": "1332f116098fdcccdf47049553db2a1c2374ef38", "url": "https://github.com/netty/netty/commit/1332f116098fdcccdf47049553db2a1c2374ef38", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-09-09T07:59:05Z", "type": "commit"}, {"oid": "1332f116098fdcccdf47049553db2a1c2374ef38", "url": "https://github.com/netty/netty/commit/1332f116098fdcccdf47049553db2a1c2374ef38", "message": "Improve predictability of writeUtf8/writeAscii performance\n\nMotivation:\n\nwriteUtf8 can suffer from inlining issues and/or megamorphic call-sites on the hot path due to ByteBuf hierarchy\n\nModifications:\n\nDuplicate and specialize the code paths to reduce the need of polymorphic calls\n\nResult:\n\nPerformance are more stable in user code", "committedDate": "2020-09-09T07:59:05Z", "type": "forcePushed"}]}