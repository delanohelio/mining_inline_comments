{"pr_number": 9967, "pr_title": "#9944 Merge WebSocketCloseFrameHandler into WebSocketProtocolHandler \u2026", "pr_createdAt": "2020-01-25T23:06:37Z", "pr_url": "https://github.com/netty/netty/pull/9967", "timeline": [{"oid": "1c8530670572c883d62221c04d8c2e10c54d28ef", "url": "https://github.com/netty/netty/commit/1c8530670572c883d62221c04d8c2e10c54d28ef", "message": "#9944 Merge WebSocketCloseFrameHandler into WebSocketProtocolHandler in order to minimize pipeline", "committedDate": "2020-01-25T22:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2MDE3Mw==", "url": "https://github.com/netty/netty/pull/9967#discussion_r371060173", "bodyText": "@doom369 as this is package-private we can just remove the class imho.", "author": "normanmaurer", "createdAt": "2020-01-27T04:14:31Z", "path": "codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseFrameHandler.java", "diffHunk": "@@ -29,7 +29,9 @@\n \n /**\n  * Send {@link CloseWebSocketFrame} message on channel close, if close frame was not sent before.\n+ * @deprecated this class was merged into {@link WebSocketProtocolHandler} so should no longer be used\n  */\n+@Deprecated\n final class WebSocketCloseFrameHandler extends ChannelOutboundHandlerAdapter {", "originalCommit": "1c8530670572c883d62221c04d8c2e10c54d28ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwNjE2OA==", "url": "https://github.com/netty/netty/pull/9967#discussion_r371106168", "bodyText": "Removed", "author": "doom369", "createdAt": "2020-01-27T08:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2MDE3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d8ad5bad231b8a28c6aa967fd47c41857036f724", "chunk": "diff --git a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseFrameHandler.java b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseFrameHandler.java\ndeleted file mode 100644\nindex 11b615edfc..0000000000\n--- a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseFrameHandler.java\n+++ /dev/null\n\n@@ -1,99 +0,0 @@\n-/*\n- * Copyright 2019 The Netty Project\n- *\n- * The Netty Project licenses this file to you under the Apache License,\n- * version 2.0 (the \"License\"); you may not use this file except in compliance\n- * with the License. You may obtain a copy of the License at:\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n- * License for the specific language governing permissions and limitations\n- * under the License.\n- */\n-package io.netty.handler.codec.http.websocketx;\n-\n-import io.netty.channel.ChannelFuture;\n-import io.netty.channel.ChannelFutureListener;\n-import io.netty.channel.ChannelHandlerContext;\n-import io.netty.channel.ChannelOutboundHandlerAdapter;\n-import io.netty.channel.ChannelPromise;\n-import io.netty.util.ReferenceCountUtil;\n-import io.netty.util.concurrent.ScheduledFuture;\n-import io.netty.util.internal.ObjectUtil;\n-\n-import java.nio.channels.ClosedChannelException;\n-import java.util.concurrent.TimeUnit;\n-\n-/**\n- * Send {@link CloseWebSocketFrame} message on channel close, if close frame was not sent before.\n- * @deprecated this class was merged into {@link WebSocketProtocolHandler} so should no longer be used\n- */\n-@Deprecated\n-final class WebSocketCloseFrameHandler extends ChannelOutboundHandlerAdapter {\n-    private final WebSocketCloseStatus closeStatus;\n-    private final long forceCloseTimeoutMillis;\n-    private ChannelPromise closeSent;\n-\n-    WebSocketCloseFrameHandler(WebSocketCloseStatus closeStatus, long forceCloseTimeoutMillis) {\n-        this.closeStatus = ObjectUtil.checkNotNull(closeStatus, \"closeStatus\");\n-        this.forceCloseTimeoutMillis = forceCloseTimeoutMillis;\n-    }\n-\n-    @Override\n-    public void close(final ChannelHandlerContext ctx, final ChannelPromise promise) throws Exception {\n-        if (!ctx.channel().isActive()) {\n-            ctx.close(promise);\n-            return;\n-        }\n-        if (closeSent == null) {\n-            write(ctx, new CloseWebSocketFrame(closeStatus), ctx.newPromise());\n-        }\n-        flush(ctx);\n-        applyCloseSentTimeout(ctx);\n-        closeSent.addListener(new ChannelFutureListener() {\n-            @Override\n-            public void operationComplete(ChannelFuture future) {\n-                ctx.close(promise);\n-            }\n-        });\n-    }\n-\n-    @Override\n-    public void write(final ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n-        if (closeSent != null) {\n-            ReferenceCountUtil.release(msg);\n-            promise.setFailure(new ClosedChannelException());\n-            return;\n-        }\n-        if (msg instanceof CloseWebSocketFrame) {\n-            promise = promise.unvoid();\n-            closeSent = promise;\n-        }\n-        super.write(ctx, msg, promise);\n-    }\n-\n-    private void applyCloseSentTimeout(ChannelHandlerContext ctx) {\n-        if (closeSent.isDone() || forceCloseTimeoutMillis < 0) {\n-            return;\n-        }\n-\n-        final ScheduledFuture<?> timeoutTask = ctx.executor().schedule(new Runnable() {\n-            @Override\n-            public void run() {\n-                if (!closeSent.isDone()) {\n-                    closeSent.tryFailure(new WebSocketHandshakeException(\"send close frame timed out\"));\n-                }\n-            }\n-        }, forceCloseTimeoutMillis, TimeUnit.MILLISECONDS);\n-\n-        closeSent.addListener(new ChannelFutureListener() {\n-            @Override\n-            public void operationComplete(ChannelFuture future) {\n-                timeoutTask.cancel(false);\n-            }\n-        });\n-    }\n-}\n"}}, {"oid": "d8ad5bad231b8a28c6aa967fd47c41857036f724", "url": "https://github.com/netty/netty/commit/d8ad5bad231b8a28c6aa967fd47c41857036f724", "message": "#9944 remove WebSocketCloseFrameHandler", "committedDate": "2020-01-27T08:19:14Z", "type": "commit"}]}