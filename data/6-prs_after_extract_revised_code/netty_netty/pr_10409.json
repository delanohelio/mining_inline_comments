{"pr_number": 10409, "pr_title": "Make the TLSv1.3 check more robust and not depend on the Java version\u2026", "pr_createdAt": "2020-07-16T08:47:50Z", "pr_url": "https://github.com/netty/netty/pull/10409", "timeline": [{"oid": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "url": "https://github.com/netty/netty/commit/32f0fb9131252c2854ad1438cc69ab0b6b12986b", "message": "Make the TLSv1.3 check more robust and not depend on the Java version to detect if its supported or not\n\nMotivation:\n\nTLSv1.3 is not strictly limited to Java11+ anymore as different vendors backported TLSv1.3 to Java8 as well. We should ensure we make the detection of if TLSv1.3 is supported not depend on the Java version that is used.\n\nModifications:\n\n- Add SslProvider.isTlsv13Supported(...) and use it in tests to detect if we should run tests against TLSv1.3 as well\n- Adjust testcase to work on latest JDK 8 release as well\n\nResult:\n\nCorrect detection of TLSv1.3 support even if Java version < 11.", "committedDate": "2020-07-16T09:10:16Z", "type": "commit"}, {"oid": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "url": "https://github.com/netty/netty/commit/32f0fb9131252c2854ad1438cc69ab0b6b12986b", "message": "Make the TLSv1.3 check more robust and not depend on the Java version to detect if its supported or not\n\nMotivation:\n\nTLSv1.3 is not strictly limited to Java11+ anymore as different vendors backported TLSv1.3 to Java8 as well. We should ensure we make the detection of if TLSv1.3 is supported not depend on the Java version that is used.\n\nModifications:\n\n- Add SslProvider.isTlsv13Supported(...) and use it in tests to detect if we should run tests against TLSv1.3 as well\n- Adjust testcase to work on latest JDK 8 release as well\n\nResult:\n\nCorrect detection of TLSv1.3 support even if Java version < 11.", "committedDate": "2020-07-16T09:10:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3MzM2NQ==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455773365", "bodyText": "This line can also use the extracted hs variable.", "author": "chrisvest", "createdAt": "2020-07-16T13:10:35Z", "path": "handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java", "diffHunk": "@@ -2332,13 +2332,11 @@ public void testCloseNotifySequence() throws Exception {\n             encryptedClientToServer.flip();\n \n             assertEquals(SSLEngineResult.Status.CLOSED, result.getStatus());\n+            SSLEngineResult.HandshakeStatus hs = result.getHandshakeStatus();\n             // Need an UNWRAP to read the response of the close_notify\n-            if ((PlatformDependent.javaVersion() >= 12 && sslClientProvider() == SslProvider.JDK)\n-                    || Conscrypt.isEngineSupported(client)) {\n-                // This is a workaround for a possible JDK12+ bug.\n-                //\n-                // See http://mail.openjdk.java.net/pipermail/security-dev/2019-February/019406.html.\n-                assertEquals(SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING, result.getHandshakeStatus());\n+            if (sslClientProvider() == SslProvider.JDK || Conscrypt.isEngineSupported(client)) {\n+                assertTrue(hs == SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING\n+                        || hs == SSLEngineResult.HandshakeStatus.NEED_UNWRAP);\n             } else {\n                 assertEquals(SSLEngineResult.HandshakeStatus.NEED_UNWRAP, result.getHandshakeStatus());", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b48794609d08f0322554fbef5eea819e658793", "chunk": "diff --git a/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java b/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\nindex 099793e700..15865bc733 100644\n--- a/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\n+++ b/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\n\n@@ -2338,7 +2338,7 @@ public abstract class SSLEngineTest {\n                 assertTrue(hs == SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING\n                         || hs == SSLEngineResult.HandshakeStatus.NEED_UNWRAP);\n             } else {\n-                assertEquals(SSLEngineResult.HandshakeStatus.NEED_UNWRAP, result.getHandshakeStatus());\n+                assertEquals(SSLEngineResult.HandshakeStatus.NEED_UNWRAP, hs);\n             }\n \n             int produced = result.bytesProduced();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3NDY2MQ==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455774661", "bodyText": "Was the issue you reported for JDK12 fixed, so the test now need to consider either outcome in order to pass on all environments?", "author": "chrisvest", "createdAt": "2020-07-16T13:12:38Z", "path": "handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java", "diffHunk": "@@ -2332,13 +2332,11 @@ public void testCloseNotifySequence() throws Exception {\n             encryptedClientToServer.flip();\n \n             assertEquals(SSLEngineResult.Status.CLOSED, result.getStatus());\n+            SSLEngineResult.HandshakeStatus hs = result.getHandshakeStatus();\n             // Need an UNWRAP to read the response of the close_notify\n-            if ((PlatformDependent.javaVersion() >= 12 && sslClientProvider() == SslProvider.JDK)\n-                    || Conscrypt.isEngineSupported(client)) {\n-                // This is a workaround for a possible JDK12+ bug.\n-                //\n-                // See http://mail.openjdk.java.net/pipermail/security-dev/2019-February/019406.html.\n-                assertEquals(SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING, result.getHandshakeStatus());\n+            if (sslClientProvider() == SslProvider.JDK || Conscrypt.isEngineSupported(client)) {\n+                assertTrue(hs == SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING\n+                        || hs == SSLEngineResult.HandshakeStatus.NEED_UNWRAP);", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NTA5Mw==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455955093", "bodyText": "yes... both are \"valid\"", "author": "normanmaurer", "createdAt": "2020-07-16T17:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3NDY2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "80b48794609d08f0322554fbef5eea819e658793", "chunk": "diff --git a/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java b/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\nindex 099793e700..15865bc733 100644\n--- a/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\n+++ b/handler/src/test/java/io/netty/handler/ssl/SSLEngineTest.java\n\n@@ -2338,7 +2338,7 @@ public abstract class SSLEngineTest {\n                 assertTrue(hs == SSLEngineResult.HandshakeStatus.NOT_HANDSHAKING\n                         || hs == SSLEngineResult.HandshakeStatus.NEED_UNWRAP);\n             } else {\n-                assertEquals(SSLEngineResult.HandshakeStatus.NEED_UNWRAP, result.getHandshakeStatus());\n+                assertEquals(SSLEngineResult.HandshakeStatus.NEED_UNWRAP, hs);\n             }\n \n             int produced = result.bytesProduced();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc4NTA5Ng==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455785096", "bodyText": "You introduced this parameter, but the value passed is always SslProvider.OPENSSL. Are you planning on adding some SslProvider.JDK tests as well?", "author": "chrisvest", "createdAt": "2020-07-16T13:27:45Z", "path": "handler/src/test/java/io/netty/handler/ssl/SslHandlerTest.java", "diffHunk": "@@ -1116,37 +1116,37 @@ protected void initChannel(Channel ch) {\n \n     @Test(timeout = 5000L)\n     public void testSessionTicketsWithTLSv12() throws Throwable {\n-        testSessionTickets(SslUtils.PROTOCOL_TLS_V1_2, true);\n+        testSessionTickets(SslProvider.OPENSSL, SslUtils.PROTOCOL_TLS_V1_2, true);\n     }\n \n     @Test(timeout = 5000L)\n     public void testSessionTicketsWithTLSv13() throws Throwable {\n-        assumeTrue(OpenSsl.isTlsv13Supported());\n-        testSessionTickets(SslUtils.PROTOCOL_TLS_V1_3, true);\n+        assumeTrue(SslProvider.isTlsv13Supported(SslProvider.OPENSSL));\n+        testSessionTickets(SslProvider.OPENSSL, SslUtils.PROTOCOL_TLS_V1_3, true);\n     }\n \n     @Test(timeout = 5000L)\n     public void testSessionTicketsWithTLSv12AndNoKey() throws Throwable {\n-        testSessionTickets(SslUtils.PROTOCOL_TLS_V1_2, false);\n+        testSessionTickets(SslProvider.OPENSSL, SslUtils.PROTOCOL_TLS_V1_2, false);\n     }\n \n     @Test(timeout = 5000L)\n     public void testSessionTicketsWithTLSv13AndNoKey() throws Throwable {\n         assumeTrue(OpenSsl.isTlsv13Supported());\n-        testSessionTickets(SslUtils.PROTOCOL_TLS_V1_3, false);\n+        testSessionTickets(SslProvider.OPENSSL, SslUtils.PROTOCOL_TLS_V1_3, false);\n     }\n \n-    private static void testSessionTickets(String protocol, boolean withKey) throws Throwable {\n+    private static void testSessionTickets(SslProvider provider, String protocol, boolean withKey) throws Throwable {", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NTQ1Nw==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455955457", "bodyText": "nope... This test only works with OpenSsl, I just thought it makes more sense to pass it as we also test for tlsv13 first with it", "author": "normanmaurer", "createdAt": "2020-07-16T17:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc4NTA5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzMzEwNg==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455833106", "bodyText": "Why get SunJSSE explicitly? I'd understand if we got SunJSSE explicitly elsewhere, but it doesn't seem we do. If we're going to use the default implementation of \"TLS\" it seems we should check that one here. Otherwise there's lots of similar-but-not-quite-the-same checks we could do, like Security.getProviders(\"SSLContext.TLSv1.3\") != null to see if any provider supports TLSv1.3.", "author": "ejona86", "createdAt": "2020-07-16T14:32:42Z", "path": "handler/src/main/java/io/netty/handler/ssl/SslUtils.java", "diffHunk": "@@ -101,8 +106,26 @@\n     static final String[] DEFAULT_TLSV13_CIPHER_SUITES;\n     static final String[] TLSV13_CIPHER_SUITES = { \"TLS_AES_128_GCM_SHA256\", \"TLS_AES_256_GCM_SHA384\" };\n \n+    private static final boolean TLSV1_3_SUPPORTED;\n+\n     static {\n-        if (PlatformDependent.javaVersion() >= 11) {\n+        boolean tlsv13Supported = false;\n+        try {\n+            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODcyMw==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455888723", "bodyText": "Somewhat agree here.   If a user has bouncy castle as their provider this may not match.", "author": "carl-mastrangelo", "createdAt": "2020-07-16T15:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzMzEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NTcwMA==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455955700", "bodyText": "good point... let me fix this", "author": "normanmaurer", "createdAt": "2020-07-16T17:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgzMzEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "80b48794609d08f0322554fbef5eea819e658793", "chunk": "diff --git a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\nindex 81399f0560..cb25f6c038 100644\n--- a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n+++ b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n\n@@ -110,18 +110,23 @@ final class SslUtils {\n \n     static {\n         boolean tlsv13Supported = false;\n+        Throwable cause = null;\n         try {\n-            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");\n-            context.init(null, new TrustManager[] {  }, null);\n+            SSLContext context = SSLContext.getInstance(\"TLS\");\n+            context.init(null, new TrustManager[0], null);\n             for (String supported: context.getSupportedSSLParameters().getProtocols()) {\n                 if (PROTOCOL_TLS_V1_3.equals(supported)) {\n                     tlsv13Supported = true;\n                     break;\n                 }\n             }\n-            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n         } catch (Throwable error) {\n-            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", error);\n+            cause = error;\n+        }\n+        if (cause == null) {\n+            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n+        } else {\n+            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", cause);\n         }\n         TLSV1_3_SUPPORTED = tlsv13Supported;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NzAxNg==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455887016", "bodyText": "I think this should be moved out of the try block", "author": "carl-mastrangelo", "createdAt": "2020-07-16T15:46:15Z", "path": "handler/src/main/java/io/netty/handler/ssl/SslUtils.java", "diffHunk": "@@ -101,8 +106,26 @@\n     static final String[] DEFAULT_TLSV13_CIPHER_SUITES;\n     static final String[] TLSV13_CIPHER_SUITES = { \"TLS_AES_128_GCM_SHA256\", \"TLS_AES_256_GCM_SHA384\" };\n \n+    private static final boolean TLSV1_3_SUPPORTED;\n+\n     static {\n-        if (PlatformDependent.javaVersion() >= 11) {\n+        boolean tlsv13Supported = false;\n+        try {\n+            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");\n+            context.init(null, new TrustManager[] {  }, null);\n+            for (String supported: context.getSupportedSSLParameters().getProtocols()) {\n+                if (PROTOCOL_TLS_V1_3.equals(supported)) {\n+                    tlsv13Supported = true;\n+                    break;\n+                }\n+            }\n+            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b48794609d08f0322554fbef5eea819e658793", "chunk": "diff --git a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\nindex 81399f0560..cb25f6c038 100644\n--- a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n+++ b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n\n@@ -110,18 +110,23 @@ final class SslUtils {\n \n     static {\n         boolean tlsv13Supported = false;\n+        Throwable cause = null;\n         try {\n-            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");\n-            context.init(null, new TrustManager[] {  }, null);\n+            SSLContext context = SSLContext.getInstance(\"TLS\");\n+            context.init(null, new TrustManager[0], null);\n             for (String supported: context.getSupportedSSLParameters().getProtocols()) {\n                 if (PROTOCOL_TLS_V1_3.equals(supported)) {\n                     tlsv13Supported = true;\n                     break;\n                 }\n             }\n-            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n         } catch (Throwable error) {\n-            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", error);\n+            cause = error;\n+        }\n+        if (cause == null) {\n+            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n+        } else {\n+            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", cause);\n         }\n         TLSV1_3_SUPPORTED = tlsv13Supported;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NzIyNw==", "url": "https://github.com/netty/netty/pull/10409#discussion_r455887227", "bodyText": "new TrustManager[0]  ?", "author": "carl-mastrangelo", "createdAt": "2020-07-16T15:46:33Z", "path": "handler/src/main/java/io/netty/handler/ssl/SslUtils.java", "diffHunk": "@@ -101,8 +106,26 @@\n     static final String[] DEFAULT_TLSV13_CIPHER_SUITES;\n     static final String[] TLSV13_CIPHER_SUITES = { \"TLS_AES_128_GCM_SHA256\", \"TLS_AES_256_GCM_SHA384\" };\n \n+    private static final boolean TLSV1_3_SUPPORTED;\n+\n     static {\n-        if (PlatformDependent.javaVersion() >= 11) {\n+        boolean tlsv13Supported = false;\n+        try {\n+            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");\n+            context.init(null, new TrustManager[] {  }, null);", "originalCommit": "32f0fb9131252c2854ad1438cc69ab0b6b12986b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80b48794609d08f0322554fbef5eea819e658793", "chunk": "diff --git a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\nindex 81399f0560..cb25f6c038 100644\n--- a/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n+++ b/handler/src/main/java/io/netty/handler/ssl/SslUtils.java\n\n@@ -110,18 +110,23 @@ final class SslUtils {\n \n     static {\n         boolean tlsv13Supported = false;\n+        Throwable cause = null;\n         try {\n-            SSLContext context = SSLContext.getInstance(\"TLS\", \"SunJSSE\");\n-            context.init(null, new TrustManager[] {  }, null);\n+            SSLContext context = SSLContext.getInstance(\"TLS\");\n+            context.init(null, new TrustManager[0], null);\n             for (String supported: context.getSupportedSSLParameters().getProtocols()) {\n                 if (PROTOCOL_TLS_V1_3.equals(supported)) {\n                     tlsv13Supported = true;\n                     break;\n                 }\n             }\n-            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n         } catch (Throwable error) {\n-            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", error);\n+            cause = error;\n+        }\n+        if (cause == null) {\n+            logger.debug(\"JDK SSLEngine supports TLSv1.3: {}\", tlsv13Supported);\n+        } else {\n+            logger.debug(\"Unable to detect if JDK SSLEngine supports TLSv1.3, assuming no\", cause);\n         }\n         TLSV1_3_SUPPORTED = tlsv13Supported;\n \n"}}, {"oid": "80b48794609d08f0322554fbef5eea819e658793", "url": "https://github.com/netty/netty/commit/80b48794609d08f0322554fbef5eea819e658793", "message": "Address comments", "committedDate": "2020-07-16T17:39:56Z", "type": "commit"}]}