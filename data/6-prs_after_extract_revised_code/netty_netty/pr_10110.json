{"pr_number": 10110, "pr_title": "Close SocketChannel upon exceptions to avoid leaking", "pr_createdAt": "2020-03-15T09:00:38Z", "pr_url": "https://github.com/netty/netty/pull/10110", "timeline": [{"oid": "8033e6a1db5015f8812175608a13fb9935c05494", "url": "https://github.com/netty/netty/commit/8033e6a1db5015f8812175608a13fb9935c05494", "message": "Close SocketChannel upon exceptions to avoid leaking\n\nThis fixes https://github.com/netty/netty/issues/10109\nby correctly closing the channel upon exceptions.", "committedDate": "2020-03-15T09:00:58Z", "type": "commit"}, {"oid": "8033e6a1db5015f8812175608a13fb9935c05494", "url": "https://github.com/netty/netty/commit/8033e6a1db5015f8812175608a13fb9935c05494", "message": "Close SocketChannel upon exceptions to avoid leaking\n\nThis fixes https://github.com/netty/netty/issues/10109\nby correctly closing the channel upon exceptions.", "committedDate": "2020-03-15T09:00:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NDUyMg==", "url": "https://github.com/netty/netty/pull/10110#discussion_r392854522", "bodyText": "@blindpirate I think this should be changed to:\ntry {\n    ...\n} catch (Throwable cause) {\n    channel.close();\n    promise.setFailure(e);\n    return;\n}", "author": "normanmaurer", "createdAt": "2020-03-16T08:35:11Z", "path": "transport/src/main/java/io/netty/bootstrap/Bootstrap.java", "diffHunk": "@@ -189,7 +189,13 @@ private ChannelFuture doResolveAndConnect0(final Channel channel, SocketAddress\n                                                final SocketAddress localAddress, final ChannelPromise promise) {\n         try {\n             final EventLoop eventLoop = channel.eventLoop();\n-            final AddressResolver<SocketAddress> resolver = this.resolver.getResolver(eventLoop);\n+            AddressResolver<SocketAddress> resolver;\n+            try {\n+                resolver = this.resolver.getResolver(eventLoop);\n+            } catch (Throwable e) {\n+                channel.close();", "originalCommit": "8033e6a1db5015f8812175608a13fb9935c05494", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NjMzNg==", "url": "https://github.com/netty/netty/pull/10110#discussion_r392856336", "bodyText": "Also would be nice if you could write a unit test for it and include it in BootstrapTest.", "author": "normanmaurer", "createdAt": "2020-03-16T08:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NDUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NjkzMg==", "url": "https://github.com/netty/netty/pull/10110#discussion_r392856932", "bodyText": "OK, will try.", "author": "blindpirate", "createdAt": "2020-03-16T08:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NDUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg5NTQyMQ==", "url": "https://github.com/netty/netty/pull/10110#discussion_r392895421", "bodyText": "@blindpirate please ping me once done ...", "author": "normanmaurer", "createdAt": "2020-03-16T09:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NDUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzMjM0OA==", "url": "https://github.com/netty/netty/pull/10110#discussion_r392932348", "bodyText": "actually let me just take care and add me as an co-author then.", "author": "normanmaurer", "createdAt": "2020-03-16T10:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1NDUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "4d9f86e9bddbba3370c8b5f07443adb082632611", "chunk": "diff --git a/transport/src/main/java/io/netty/bootstrap/Bootstrap.java b/transport/src/main/java/io/netty/bootstrap/Bootstrap.java\nindex 1f41d2743e..78590429ca 100644\n--- a/transport/src/main/java/io/netty/bootstrap/Bootstrap.java\n+++ b/transport/src/main/java/io/netty/bootstrap/Bootstrap.java\n\n@@ -192,9 +192,9 @@ public class Bootstrap extends AbstractBootstrap<Bootstrap, Channel> {\n             AddressResolver<SocketAddress> resolver;\n             try {\n                 resolver = this.resolver.getResolver(eventLoop);\n-            } catch (Throwable e) {\n+            } catch (Throwable cause) {\n                 channel.close();\n-                throw e;\n+                return promise.setFailure(cause);\n             }\n \n             if (!resolver.isSupported(remoteAddress) || resolver.isResolved(remoteAddress)) {\n"}}, {"oid": "4d9f86e9bddbba3370c8b5f07443adb082632611", "url": "https://github.com/netty/netty/commit/4d9f86e9bddbba3370c8b5f07443adb082632611", "message": "Add testcase and cleanup", "committedDate": "2020-03-16T11:03:25Z", "type": "commit"}, {"oid": "1d38688d842717fec695b7183c60cb55a45299aa", "url": "https://github.com/netty/netty/commit/1d38688d842717fec695b7183c60cb55a45299aa", "message": "cleanup", "committedDate": "2020-03-16T11:05:22Z", "type": "commit"}]}