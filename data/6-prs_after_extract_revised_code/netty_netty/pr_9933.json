{"pr_number": 9933, "pr_title": "Fix event loop hang in SniHandler", "pr_createdAt": "2020-01-09T23:01:58Z", "pr_url": "https://github.com/netty/netty/pull/9933", "timeline": [{"oid": "d56d49ca8d2f11ae2e3658b2db99f2283855161f", "url": "https://github.com/netty/netty/commit/d56d49ca8d2f11ae2e3658b2db99f2283855161f", "message": "Fix event loop hang in SniHandler\n\nMotivation\n\nA bug was introduced in #9806 which looks likely to be the cause of\n#9919. SniHandler will enter an infinite loop if an SSL record is\nreceived with SSL major version byte != 3 (i.e. something other than TLS\nor SSL3.0)\n\nModifications\n\n- Follow default path as intended  for majorVersion != 3 in\nAbstractSniHandler#decode(...)\n- Add unit test to reproduce the hang\n\nResult\n\nFixes #9919", "committedDate": "2020-01-09T22:58:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2NTgwMQ==", "url": "https://github.com/netty/netty/pull/9933#discussion_r365065801", "bodyText": "add fail(); above", "author": "normanmaurer", "createdAt": "2020-01-10T04:08:48Z", "path": "handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java", "diffHunk": "@@ -344,6 +344,42 @@ public void testFallbackToDefaultContext() throws Exception {\n         }\n     }\n \n+    @Test(timeout = 10000)\n+    public void testMajorVersionNot3() throws Exception {\n+        SslContext nettyContext = makeSslContext(provider, false);\n+\n+        try {\n+            DomainNameMapping<SslContext> mapping = new DomainNameMappingBuilder<SslContext>(nettyContext).build();\n+\n+            SniHandler handler = new SniHandler(mapping);\n+            EmbeddedChannel ch = new EmbeddedChannel(handler);\n+\n+            // invalid\n+            byte[] message = {22, 2, 0, 0, 0};\n+            try {\n+                // Push the handshake message.\n+                ch.writeInbound(Unpooled.wrappedBuffer(message));\n+            } catch (Exception e) {", "originalCommit": "d56d49ca8d2f11ae2e3658b2db99f2283855161f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2OTc3Mg==", "url": "https://github.com/netty/netty/pull/9933#discussion_r365069772", "bodyText": "@normanmaurer done, I actually just copied the existing testFallbackToDefaultContext() as a starting point, which had this fail() commented out for some reason. So I've uncommented it there too since an exception does also get thrown in that case.", "author": "njhill", "createdAt": "2020-01-10T04:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2NTgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExMTAyOQ==", "url": "https://github.com/netty/netty/pull/9933#discussion_r365111029", "bodyText": "@njhill after some more digging this actually depends on if jdkCompatibilityMode is true of not. Let me do a follow up to fix it and then investigate later on.", "author": "normanmaurer", "createdAt": "2020-01-10T08:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2NTgwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "42bd712030fdbc1f6f0bcb86bfb3f4bc1dc877f2", "chunk": "diff --git a/handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java b/handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java\nindex 0de210fc85..3f468db0dd 100644\n--- a/handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java\n+++ b/handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java\n\n@@ -359,6 +359,7 @@ public class SniHandlerTest {\n             try {\n                 // Push the handshake message.\n                 ch.writeInbound(Unpooled.wrappedBuffer(message));\n+                fail();\n             } catch (Exception e) {\n                 // expected\n             }\n"}}, {"oid": "42bd712030fdbc1f6f0bcb86bfb3f4bc1dc877f2", "url": "https://github.com/netty/netty/commit/42bd712030fdbc1f6f0bcb86bfb3f4bc1dc877f2", "message": "Fix to unit test", "committedDate": "2020-01-10T04:33:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDEyMg==", "url": "https://github.com/netty/netty/pull/9933#discussion_r365070122", "bodyText": "@njhill thanks... Lets see if this works for all JDK versions that we use on the CI :) If so we can close the issue as well.", "author": "normanmaurer", "createdAt": "2020-01-10T04:39:47Z", "path": "handler/src/test/java/io/netty/handler/ssl/SniHandlerTest.java", "diffHunk": "@@ -320,7 +320,7 @@ public void testFallbackToDefaultContext() throws Exception {\n                 ch.writeInbound(Unpooled.wrappedBuffer(message));\n                 // TODO(scott): This should fail because the engine should reject zero length records during handshake.\n                 // See https://github.com/netty/netty/issues/6348.\n-                // fail();\n+                fail();", "originalCommit": "42bd712030fdbc1f6f0bcb86bfb3f4bc1dc877f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}