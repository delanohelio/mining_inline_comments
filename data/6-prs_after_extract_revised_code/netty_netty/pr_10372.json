{"pr_number": 10372, "pr_title": "Ensure we preserve the original cause of the SSLException in all case\u2026", "pr_createdAt": "2020-06-24T09:41:16Z", "pr_url": "https://github.com/netty/netty/pull/10372", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5ODQzMA==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445198430", "bodyText": "IIUC, bytesProduced will be > 0 only if there is an error from flush", "author": "NiteshKant", "createdAt": "2020-06-24T22:06:16Z", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {", "originalCommit": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjUzMg==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386532", "bodyText": "no it will be > 0 if there was something pending in the buffer.", "author": "normanmaurer", "createdAt": "2020-06-25T08:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5ODQzMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5OTAzMA==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445199030", "bodyText": "Can this throw? Worth to handle such that we add the pendingException as the cause?", "author": "NiteshKant", "createdAt": "2020-06-24T22:07:57Z", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {\n+                    return newResultMayFinishHandshake(status, bytesConsumed, bytesProduced);\n+                }\n+                // There was a pending exception that we just delayed because there was something to produce left.\n+                // Throw it now and shutdown the engine.\n+                if (pendingException != null) {\n+                    Throwable error = pendingException;\n+                    pendingException = null;\n+                    shutdown();", "originalCommit": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjMyNw==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386327", "bodyText": "nope it can't.", "author": "normanmaurer", "createdAt": "2020-06-25T08:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5OTAzMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwMDY3Mg==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445200672", "bodyText": "I hardly know the control flow here but since this is not just handshakeException now, do we need to also handle a case when pendingException != null?", "author": "NiteshKant", "createdAt": "2020-06-24T22:12:30Z", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -1260,10 +1277,12 @@ private SSLEngineResult sslReadErrorResult(int error, int stackError, int bytesC\n         // This is needed so we ensure close_notify etc is correctly send to the remote peer.\n         // See https://github.com/netty/netty/issues/3900\n         if (SSL.bioLengthNonApplication(networkBIO) > 0) {\n-            if (handshakeException == null && handshakeState != HandshakeState.FINISHED) {\n+            if (pendingException == null) {", "originalCommit": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjY2NA==", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386664", "bodyText": "it should never... let me add an assert tho You are right... let me ensure we handle this", "author": "normanmaurer", "createdAt": "2020-06-25T08:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwMDY3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "15d495ea54dd9de39584144cf943a6b7553d98ae", "chunk": "diff --git a/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java b/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java\nindex edf10e75b5..d7d02e0235 100644\n--- a/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java\n+++ b/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java\n\n@@ -1277,12 +1278,15 @@ public class ReferenceCountedOpenSslEngine extends SSLEngine implements Referenc\n         // This is needed so we ensure close_notify etc is correctly send to the remote peer.\n         // See https://github.com/netty/netty/issues/3900\n         if (SSL.bioLengthNonApplication(networkBIO) > 0) {\n+            // we seems to have data left that needs to be transferred and so the user needs\n+            // call wrap(...). Store the error so we can pick it up later.\n+            String message = SSL.getErrorString(stackError);\n+            SSLException exception = handshakeState == HandshakeState.FINISHED ?\n+                    new SSLException(message) : new SSLHandshakeException(message);\n             if (pendingException == null) {\n-                // we seems to have data left that needs to be transferred and so the user needs\n-                // call wrap(...). Store the error so we can pick it up later.\n-                String message = SSL.getErrorString(stackError);\n-                pendingException = handshakeState == HandshakeState.FINISHED ?\n-                        new SSLException(message) : new SSLHandshakeException(message);\n+               pendingException = exception;\n+            } else {\n+                ThrowableUtil.addSuppressed(pendingException, exception);\n             }\n             // We need to clear all errors so we not pick up anything that was left on the stack on the next\n             // operation. Note that shutdownWithError(...) will cleanup the stack as well so its only needed here.\n"}}, {"oid": "15d495ea54dd9de39584144cf943a6b7553d98ae", "url": "https://github.com/netty/netty/commit/15d495ea54dd9de39584144cf943a6b7553d98ae", "message": "Address comment of nitesh", "committedDate": "2020-06-25T09:19:47Z", "type": "forcePushed"}, {"oid": "9ab389f7d6a78ad79fdd23869614129ba8bcb569", "url": "https://github.com/netty/netty/commit/9ab389f7d6a78ad79fdd23869614129ba8bcb569", "message": "Ensure we preserve the original cause of the SSLException in all cases when the native SSLEngine is used\n\nMotivation:\n\nWe did not correctly preserve the original cause of the SSLException when all the following are true:\n\n * SSL_read failed\n * handshake was finished\n * some outbound data was produced durigin SSL_read (for example ssl alert) that needs to be picked up by wrap(...)\n\nModifications:\n\nEnsure we correctly preserve the original cause of the SSLException and rethrow it once we produced all data via wrap(...)\n\nResult:\n\nBe able to understand why we see an error in all cases", "committedDate": "2020-06-25T13:00:39Z", "type": "commit"}, {"oid": "0e4c157cd8dbc5ffd5336c44edc8b7f6fa4487cc", "url": "https://github.com/netty/netty/commit/0e4c157cd8dbc5ffd5336c44edc8b7f6fa4487cc", "message": "Address comment of nitesh", "committedDate": "2020-06-25T13:00:39Z", "type": "commit"}, {"oid": "0e4c157cd8dbc5ffd5336c44edc8b7f6fa4487cc", "url": "https://github.com/netty/netty/commit/0e4c157cd8dbc5ffd5336c44edc8b7f6fa4487cc", "message": "Address comment of nitesh", "committedDate": "2020-06-25T13:00:39Z", "type": "forcePushed"}]}