{"pr_number": 6825, "pr_title": "fix: Use encryption for SMS confidential parameters [DHIS2-10076]", "pr_createdAt": "2020-12-03T20:32:18Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6825", "timeline": [{"oid": "28c265e69da02f18bb644ce264de09ca3dae0bfc", "url": "https://github.com/dhis2/dhis2-core/commit/28c265e69da02f18bb644ce264de09ca3dae0bfc", "message": "fix: Add encryption while saving confidential parameters", "committedDate": "2020-12-03T19:40:45Z", "type": "commit"}, {"oid": "8ad3f5d027aab6a327d68c69311c5ec12711a4d4", "url": "https://github.com/dhis2/dhis2-core/commit/8ad3f5d027aab6a327d68c69311c5ec12711a4d4", "message": "fix unit tests", "committedDate": "2020-12-03T20:20:04Z", "type": "commit"}, {"oid": "5c8e81d89d389be8ef091e373829023ad56e256e", "url": "https://github.com/dhis2/dhis2-core/commit/5c8e81d89d389be8ef091e373829023ad56e256e", "message": "fix unit tests", "committedDate": "2020-12-03T20:29:08Z", "type": "commit"}, {"oid": "8914f9671ad81eab91d716ac5376155e94e2afde", "url": "https://github.com/dhis2/dhis2-core/commit/8914f9671ad81eab91d716ac5376155e94e2afde", "message": "fix issues after server reboot", "committedDate": "2020-12-04T11:06:10Z", "type": "commit"}, {"oid": "608a789d71d910c6edef4e81e3f60a99431c417b", "url": "https://github.com/dhis2/dhis2-core/commit/608a789d71d910c6edef4e81e3f60a99431c417b", "message": "sonar code analysis fix", "committedDate": "2020-12-07T10:38:51Z", "type": "commit"}, {"oid": "95405531908f3d349b66590e9bde6fb087ea7b32", "url": "https://github.com/dhis2/dhis2-core/commit/95405531908f3d349b66590e9bde6fb087ea7b32", "message": "fix compilation issue", "committedDate": "2020-12-07T10:49:07Z", "type": "commit"}, {"oid": "630fdc29a09ca84e64ed60eace2a2203a1919361", "url": "https://github.com/dhis2/dhis2-core/commit/630fdc29a09ca84e64ed60eace2a2203a1919361", "message": "fix unit tests", "committedDate": "2020-12-07T11:04:53Z", "type": "commit"}, {"oid": "b766e220e856238e8c23334bc329eef28bfea070", "url": "https://github.com/dhis2/dhis2-core/commit/b766e220e856238e8c23334bc329eef28bfea070", "message": "Incase values are equal then no need to updated", "committedDate": "2020-12-08T08:55:37Z", "type": "commit"}, {"oid": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "url": "https://github.com/dhis2/dhis2-core/commit/ed2e401ff04b539a4a321754fda923c5ef4cfb62", "message": "Add unit tests", "committedDate": "2020-12-08T11:20:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTA4NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539115084", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        pbeStringEncryptor.decrypt( bulkSmsGatewayConfig.getPassword().trim());\n          \n          \n            \n                        pbeStringEncryptor.decrypt( bulkSmsGatewayConfig.getPassword().trim() );", "author": "stian-sandvold", "createdAt": "2020-12-09T08:46:24Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java", "diffHunk": "@@ -87,7 +96,8 @@ public OutboundMessageResponse send( String subject, String text, Set<String> re\n \n     private HttpHeaders getRequestHeaderParameters( BulkSmsGatewayConfig bulkSmsGatewayConfig )\n     {\n-        String credentials = bulkSmsGatewayConfig.getUsername().trim() + \":\" + bulkSmsGatewayConfig.getPassword().trim();\n+        String credentials = bulkSmsGatewayConfig.getUsername().trim() + \":\" +\n+            pbeStringEncryptor.decrypt( bulkSmsGatewayConfig.getPassword().trim());", "originalCommit": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "842881e2f0baf51853bd58458e36a4fa58e665fe", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\nindex c02b2bffe7..cf050495fc 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\n\n@@ -97,7 +95,7 @@ public class BulkSmsHttpGateway\n     private HttpHeaders getRequestHeaderParameters( BulkSmsGatewayConfig bulkSmsGatewayConfig )\n     {\n         String credentials = bulkSmsGatewayConfig.getUsername().trim() + \":\" +\n-            pbeStringEncryptor.decrypt( bulkSmsGatewayConfig.getPassword().trim());\n+            pbeStringEncryptor.decrypt( bulkSmsGatewayConfig.getPassword().trim() );\n         String encodedCredentials = Base64.getEncoder().encodeToString( credentials.getBytes() );\n \n         HttpHeaders headers = new HttpHeaders();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTc2MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539115761", "bodyText": "closing bracket on wrong line :)", "author": "stian-sandvold", "createdAt": "2020-12-09T08:47:23Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/SimplisticHttpGetGateWay.java", "diffHunk": "@@ -184,8 +193,8 @@ public OutboundMessageResponse send( String subject, String text, Set<String> re\n         {\n             if ( !parameter.isHeader() )\n             {\n-                valueStore.put( parameter.getKey(), parameter.getValue() );\n-            }\n+                valueStore.put( parameter.getKey(), parameter.isConfidential() ?\n+                    pbeStringEncryptor.decrypt( parameter.getValue() ) : parameter.getValue() );            }", "originalCommit": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2Mjk0NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539862945", "bodyText": "resolved", "author": "zubaira", "createdAt": "2020-12-10T05:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "842881e2f0baf51853bd58458e36a4fa58e665fe", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/SimplisticHttpGetGateWay.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/SimplisticHttpGetGateWay.java\nindex 9465cab068..66f3cc71d3 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/SimplisticHttpGetGateWay.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/SimplisticHttpGetGateWay.java\n\n@@ -194,7 +194,8 @@ public class SimplisticHttpGetGateWay\n             if ( !parameter.isHeader() )\n             {\n                 valueStore.put( parameter.getKey(), parameter.isConfidential() ?\n-                    pbeStringEncryptor.decrypt( parameter.getValue() ) : parameter.getValue() );            }\n+                    pbeStringEncryptor.decrypt( parameter.getValue() ) : parameter.getValue() );\n+            }\n         }\n \n         valueStore.put( KEY_TEXT, text );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1OTQzMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539459431", "bodyText": "Can't we just annotate this class with:\n@EqualsAndHashCode(of = {\"key\",\"value\", \"confidential\", \"encode\", \"header\"})\n?", "author": "gnespolino", "createdAt": "2020-12-09T16:34:23Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/sms/config/GenericGatewayParameter.java", "diffHunk": "@@ -106,4 +107,30 @@ public void setEncode( boolean encode )\n     {\n         this.encode = encode;\n     }\n+\n+    @Override\n+    public boolean equals( Object o )", "originalCommit": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2MzExMA==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539863110", "bodyText": "resolved", "author": "zubaira", "createdAt": "2020-12-10T05:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1OTQzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "842881e2f0baf51853bd58458e36a4fa58e665fe", "chunk": "diff --git a/dhis-2/dhis-api/src/main/java/org/hisp/dhis/sms/config/GenericGatewayParameter.java b/dhis-2/dhis-api/src/main/java/org/hisp/dhis/sms/config/GenericGatewayParameter.java\nindex 94e3ed9ed7..da8a149542 100644\n--- a/dhis-2/dhis-api/src/main/java/org/hisp/dhis/sms/config/GenericGatewayParameter.java\n+++ b/dhis-2/dhis-api/src/main/java/org/hisp/dhis/sms/config/GenericGatewayParameter.java\n\n@@ -107,30 +108,4 @@ public class GenericGatewayParameter\n     {\n         this.encode = encode;\n     }\n-\n-    @Override\n-    public boolean equals( Object o )\n-    {\n-        if ( this == o )\n-        {\n-            return true;\n-        }\n-        if (o == null || getClass() != o.getClass() )\n-        {\n-            return false;\n-        }\n-\n-        GenericGatewayParameter parameter = (GenericGatewayParameter) o;\n-        return header == parameter.header &&\n-                encode == parameter.encode &&\n-                confidential == parameter.confidential &&\n-                Objects.equals( key, parameter.key ) &&\n-                Objects.equals( value, parameter.value );\n-    }\n-\n-    @Override\n-    public int hashCode() {\n-\n-        return Objects.hash( key, value, header, encode, confidential );\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2MTcyNw==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539461727", "bodyText": "@RequiredArgsConstructor\nwith\n@Qualifier( \"tripleDesStringEncryptor\" )\nprivate final PBEStringEncryptor pbeStringEncryptor;", "author": "gnespolino", "createdAt": "2020-12-09T16:37:06Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java", "diffHunk": "@@ -50,6 +52,13 @@\n public class BulkSmsHttpGateway", "originalCommit": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2MzE1MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539863150", "bodyText": "resolved", "author": "zubaira", "createdAt": "2020-12-10T05:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2MTcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "842881e2f0baf51853bd58458e36a4fa58e665fe", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\nindex c02b2bffe7..cf050495fc 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/BulkSmsHttpGateway.java\n\n@@ -49,16 +50,13 @@ import java.util.stream.Collectors;\n  * @author Zubair <rajazubair.asghar@gmail.com>\n  */\n @Component( \"org.hisp.dhis.sms.config.BulkSmsGateway\" )\n+@RequiredArgsConstructor\n public class BulkSmsHttpGateway\n     extends SmsGateway\n {\n+    @Qualifier( \"tripleDesStringEncryptor\" )\n     private final PBEStringEncryptor pbeStringEncryptor;\n \n-    public BulkSmsHttpGateway( @Qualifier( \"tripleDesStringEncryptor\" ) PBEStringEncryptor pbeStringEncryptor )\n-    {\n-        this.pbeStringEncryptor = pbeStringEncryptor;\n-    }\n-\n     // -------------------------------------------------------------------------\n     // Implementation\n     // -------------------------------------------------------------------------\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2MjEwNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6825#discussion_r539462105", "bodyText": "same as BulkSmsHttpGateway", "author": "gnespolino", "createdAt": "2020-12-09T16:37:31Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/ClickatellHttpGateway.java", "diffHunk": "@@ -50,6 +52,13 @@\n public class ClickatellHttpGateway", "originalCommit": "ed2e401ff04b539a4a321754fda923c5ef4cfb62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "842881e2f0baf51853bd58458e36a4fa58e665fe", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/ClickatellHttpGateway.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/ClickatellHttpGateway.java\nindex 26c657a48b..df204da6d6 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/ClickatellHttpGateway.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/config/ClickatellHttpGateway.java\n\n@@ -49,16 +50,13 @@ import java.util.stream.Collectors;\n  * @author Zubair <rajazubair.asghar@gmail.com>\n  */\n @Component( \"org.hisp.dhis.sms.config.ClickatellGateway\" )\n+@RequiredArgsConstructor\n public class ClickatellHttpGateway\n     extends SmsGateway\n {\n+    @Qualifier( \"tripleDesStringEncryptor\" )\n     private final PBEStringEncryptor pbeStringEncryptor;\n \n-    public ClickatellHttpGateway( @Qualifier( \"tripleDesStringEncryptor\" ) PBEStringEncryptor pbeStringEncryptor )\n-    {\n-        this.pbeStringEncryptor = pbeStringEncryptor;\n-    }\n-\n     // -------------------------------------------------------------------------\n     // Implementation\n     // -------------------------------------------------------------------------\n"}}, {"oid": "dd7691115c8f2ea55409a7f3a9f6fe68cbab4b31", "url": "https://github.com/dhis2/dhis2-core/commit/dd7691115c8f2ea55409a7f3a9f6fe68cbab4b31", "message": "Merge branch 'master' into DHIS2-10076", "committedDate": "2020-12-10T05:41:11Z", "type": "commit"}, {"oid": "842881e2f0baf51853bd58458e36a4fa58e665fe", "url": "https://github.com/dhis2/dhis2-core/commit/842881e2f0baf51853bd58458e36a4fa58e665fe", "message": "resolve review comments", "committedDate": "2020-12-10T05:48:53Z", "type": "commit"}]}