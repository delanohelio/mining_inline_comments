{"pr_number": 6357, "pr_title": "fix: Reorganizing transaction logic in calls to rule engine [DHIS2-9630]", "pr_createdAt": "2020-10-08T10:09:26Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6357", "timeline": [{"oid": "ff155fea02f0bc1fa4c8abf7c87b50fa5058f562", "url": "https://github.com/dhis2/dhis2-core/commit/ff155fea02f0bc1fa4c8abf7c87b50fa5058f562", "message": "Improve rule-engine calls", "committedDate": "2020-10-07T14:42:45Z", "type": "commit"}, {"oid": "56eb48ef498f73e7cc632d4b1f18a4eb74934a7b", "url": "https://github.com/dhis2/dhis2-core/commit/56eb48ef498f73e7cc632d4b1f18a4eb74934a7b", "message": "add method to fetch psi by programinstance-id", "committedDate": "2020-10-07T16:09:59Z", "type": "commit"}, {"oid": "38ea688e91ce1959d0be9531097e08f6f901a5fa", "url": "https://github.com/dhis2/dhis2-core/commit/38ea688e91ce1959d0be9531097e08f6f901a5fa", "message": "fix constuctor", "committedDate": "2020-10-07T16:24:52Z", "type": "commit"}, {"oid": "7fa22c8d1a9e48c47de5d978d4d85b8cf5091123", "url": "https://github.com/dhis2/dhis2-core/commit/7fa22c8d1a9e48c47de5d978d4d85b8cf5091123", "message": "fetch required entities at dao level", "committedDate": "2020-10-07T18:15:54Z", "type": "commit"}, {"oid": "dafb82ec74ecc1a9be057acf37319bc9179a765a", "url": "https://github.com/dhis2/dhis2-core/commit/dafb82ec74ecc1a9be057acf37319bc9179a765a", "message": "use inner class for rule exec", "committedDate": "2020-10-08T07:02:27Z", "type": "commit"}, {"oid": "00975c0aaf2908866a5b9b382914c04679b8cd63", "url": "https://github.com/dhis2/dhis2-core/commit/00975c0aaf2908866a5b9b382914c04679b8cd63", "message": "minor refactoring", "committedDate": "2020-10-08T07:20:40Z", "type": "commit"}, {"oid": "7ba3aaccced72bfe6299fe3e02d1e79068fa721e", "url": "https://github.com/dhis2/dhis2-core/commit/7ba3aaccced72bfe6299fe3e02d1e79068fa721e", "message": "minor refactoring", "committedDate": "2020-10-08T08:29:01Z", "type": "commit"}, {"oid": "2544733a58c76d41e7dcbc6fd7742b5d433b6781", "url": "https://github.com/dhis2/dhis2-core/commit/2544733a58c76d41e7dcbc6fd7742b5d433b6781", "message": "Using TrackerEntityAttributeValueService to retrieve attribute values in rule engine mapper", "committedDate": "2020-10-08T09:19:32Z", "type": "commit"}, {"oid": "c6ce3ce99707ac49d40119ae015e7c1eba325030", "url": "https://github.com/dhis2/dhis2-core/commit/c6ce3ce99707ac49d40119ae015e7c1eba325030", "message": "Remove Transactional annotation from rule engine mapper", "committedDate": "2020-10-08T10:02:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0NTc3OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6357#discussion_r501645779", "bodyText": "Code style, space after ( and before ).", "author": "larshelge", "createdAt": "2020-10-08T11:26:58Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStageInstanceStore.java", "diffHunk": "@@ -115,6 +119,22 @@ public ProgramStageInstance get( ProgramInstance programInstance, ProgramStage p\n             .addPredicate( root -> builder.equal( root.join( \"programInstance\" ).get( \"entityInstance\" ), entityInstance ) ) );\n     }\n \n+    @Override\n+    public List<ProgramStageInstance> getProgramStageInstancesByProgramInstance( Long id )\n+    {\n+        CriteriaBuilder builder = getCriteriaBuilder();\n+        CriteriaQuery<ProgramStageInstance> q = builder.createQuery(ProgramStageInstance.class);\n+        Root<ProgramStageInstance> o = q.from(ProgramStageInstance.class);\n+        o.fetch(\"organisationUnit\", JoinType.LEFT);", "originalCommit": "c6ce3ce99707ac49d40119ae015e7c1eba325030", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDcxOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6357#discussion_r501694719", "bodyText": "fixed", "author": "luciano-fiandesio", "createdAt": "2020-10-08T12:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0NTc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cef9ab1817a161f8911d8ceb8037eb988d15b6ac", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStageInstanceStore.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStageInstanceStore.java\nindex 9e6b9384e3..327e3e554d 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStageInstanceStore.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStageInstanceStore.java\n\n@@ -123,11 +123,13 @@ public class HibernateProgramStageInstanceStore\n     public List<ProgramStageInstance> getProgramStageInstancesByProgramInstance( Long id )\n     {\n         CriteriaBuilder builder = getCriteriaBuilder();\n-        CriteriaQuery<ProgramStageInstance> q = builder.createQuery(ProgramStageInstance.class);\n-        Root<ProgramStageInstance> o = q.from(ProgramStageInstance.class);\n-        o.fetch(\"organisationUnit\", JoinType.LEFT);\n-        o.fetch(\"programStage\", JoinType.LEFT);\n-        q.where(builder.equal(o.get(\"programInstance\"), id));\n+        CriteriaQuery<ProgramStageInstance> q = builder.createQuery( ProgramStageInstance.class );\n+        Root<ProgramStageInstance> o = q.from( ProgramStageInstance.class );\n+        // using LEFT because the org unit may be null, and we still want to get the PSI\n+        o.fetch( \"organisationUnit\", JoinType.LEFT );\n+        // using INNER because a PSI must always have a Program Stage\n+        o.fetch( \"programStage\", JoinType.INNER );\n+        q.where( builder.equal( o.get( \"programInstance\" ), id ) );\n \n         TypedQuery<ProgramStageInstance> typedQuery = getSession().createQuery( q )\n             .setCacheable( cacheable ).setHint( QueryHints.CACHEABLE, cacheable );\n"}}, {"oid": "cef9ab1817a161f8911d8ceb8037eb988d15b6ac", "url": "https://github.com/dhis2/dhis2-core/commit/cef9ab1817a161f8911d8ceb8037eb988d15b6ac", "message": "test: add test for psi without OrgUnit", "committedDate": "2020-10-08T12:51:02Z", "type": "commit"}]}