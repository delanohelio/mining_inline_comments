{"pr_number": 5198, "pr_title": "fix: add support for timestamp in ParseDateStdDeserializer", "pr_createdAt": "2020-03-30T08:40:00Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5198", "timeline": [{"oid": "b46c86cd577004f8a5ab28baf0c53396e6ab7852", "url": "https://github.com/dhis2/dhis2-core/commit/b46c86cd577004f8a5ab28baf0c53396e6ab7852", "message": "fix: adds support for timestamp in ParseDateStdDeserializer", "committedDate": "2020-03-30T08:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwOTE1Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5198#discussion_r400909157", "bodyText": "It seems DateUtils.parseDate can also return null if parsing went wrong, do we need to handle that?", "author": "larshelge", "createdAt": "2020-03-31T13:23:08Z", "path": "dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/jackson/ParseDateStdDeserializer.java", "diffHunk": "@@ -44,6 +44,14 @@\n     @Override\n     public Date deserialize( JsonParser parser, DeserializationContext context ) throws IOException\n     {\n-        return DateUtils.parseDate( parser.getValueAsString() );\n+        try\n+        {\n+            return DateUtils.parseDate( parser.getValueAsString() );", "originalCommit": "b46c86cd577004f8a5ab28baf0c53396e6ab7852", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkxMjgyMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5198#discussion_r400912821", "bodyText": "I'm adding a few extra error handlers now, will commit soon", "author": "mortenoh", "createdAt": "2020-03-31T13:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwOTE1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "477bc0311d204eeeb96ad311cf45a05dd106fbd3", "chunk": "diff --git a/dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/jackson/ParseDateStdDeserializer.java b/dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/jackson/ParseDateStdDeserializer.java\nindex 47e9575bd7..212b81372b 100644\n--- a/dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/jackson/ParseDateStdDeserializer.java\n+++ b/dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/jackson/ParseDateStdDeserializer.java\n\n@@ -44,14 +44,27 @@ public class ParseDateStdDeserializer extends JsonDeserializer<Date>\n     @Override\n     public Date deserialize( JsonParser parser, DeserializationContext context ) throws IOException\n     {\n+        Date date = null;\n+\n         try\n         {\n-            return DateUtils.parseDate( parser.getValueAsString() );\n+            date = DateUtils.parseDate( parser.getValueAsString() );\n+\n+            if ( date == null )\n+            {\n+                date = new Date( parser.getValueAsLong() );\n+            }\n         }\n         catch ( Exception ignored )\n         {\n         }\n \n-        return new Date( parser.getValueAsLong() );\n+        if ( date == null )\n+        {\n+            throw new IOException( String.format(\n+                \"Invalid date format '%s', only ISO format or UNIX Epoch timestamp is supported.\", parser.getValueAsString() ) );\n+        }\n+\n+        return date;\n     }\n }\n"}}, {"oid": "477bc0311d204eeeb96ad311cf45a05dd106fbd3", "url": "https://github.com/dhis2/dhis2-core/commit/477bc0311d204eeeb96ad311cf45a05dd106fbd3", "message": "fix: check for error in both parseDate and new Date() and return a common error string", "committedDate": "2020-03-31T13:32:33Z", "type": "commit"}, {"oid": "93b99d172daf216931ec55ec03639e48c05fac44", "url": "https://github.com/dhis2/dhis2-core/commit/93b99d172daf216931ec55ec03639e48c05fac44", "message": "Merge remote-tracking branch 'origin/master' into support-timestamp-date-deserializer", "committedDate": "2020-03-31T13:32:38Z", "type": "commit"}, {"oid": "b3d1566a3b38fc686c7c314a0e29370b19fa7ae5", "url": "https://github.com/dhis2/dhis2-core/commit/b3d1566a3b38fc686c7c314a0e29370b19fa7ae5", "message": "test: adds date parsing tests for global (json) ObjectMapper", "committedDate": "2020-03-31T14:14:33Z", "type": "commit"}]}