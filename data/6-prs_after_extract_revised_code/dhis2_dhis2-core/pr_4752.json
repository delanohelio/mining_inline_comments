{"pr_number": 4752, "pr_title": "fix: Use conjunction for dataValueAudit query", "pr_createdAt": "2020-01-23T07:22:53Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4752", "timeline": [{"oid": "771bc6e0668a6d02ddec9084d38050b571dc30d8", "url": "https://github.com/dhis2/dhis2-core/commit/771bc6e0668a6d02ddec9084d38050b571dc30d8", "message": "fix: use conjunction for dataValueAudit query", "committedDate": "2020-01-23T07:18:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAyMDE0Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/4752#discussion_r374020146", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .count( root -> builder.countDistinct( root.get( \"id\" ) ) )).intValue();\n          \n          \n            \n                            .count( root -> builder.countDistinct( root.get( \"id\" ) ) ) ).intValue();", "author": "stian-sandvold", "createdAt": "2020-02-03T10:17:26Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java", "diffHunk": "@@ -144,11 +167,33 @@ public int countDataValueAudits( List<DataElement> dataElements, List<Period> pe\n     {\r\n         CriteriaBuilder builder = getSession().getCriteriaBuilder();\r\n \r\n-        return getCount( builder, newJpaParameters()\r\n-            .addPredicates( getDataValueAuditPredicates( builder, dataElements, periods, organisationUnits, categoryOptionCombo, attributeOptionCombo, auditType ) )\r\n-            .count( root -> builder.countDistinct( root.get( \"id\" ) ) )).intValue();\r\n+        List<Function<Root<DataValueAudit>, Predicate>> predicates = getDataValueAuditPredicates( builder, dataElements, periods, organisationUnits, categoryOptionCombo, attributeOptionCombo, auditType );\r\n+\r\n+        if ( !predicates.isEmpty() )\r\n+        {\r\n+            return getCount( builder, newJpaParameters()\r\n+                .addPredicate( root -> builder.and( predicates.stream().map( p -> p.apply( root ) ).collect(\r\n+                    Collectors.toList() ).toArray( new Predicate[ predicates.size() ] ) ) )\r\n+                .count( root -> builder.countDistinct( root.get( \"id\" ) ) )).intValue();\r", "originalCommit": "771bc6e0668a6d02ddec9084d38050b571dc30d8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4d3bd1f00472850b89c953f0d475b3fdd9b0071e", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java\nindex d59a5062e7..67e802e2a3 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java\n\n@@ -174,7 +174,8 @@ public class HibernateDataValueAuditStore extends HibernateGenericStore<DataValu\n             return getCount( builder, newJpaParameters()\n                 .addPredicate( root -> builder.and( predicates.stream().map( p -> p.apply( root ) ).collect(\n                     Collectors.toList() ).toArray( new Predicate[ predicates.size() ] ) ) )\n-                .count( root -> builder.countDistinct( root.get( \"id\" ) ) )).intValue();\n+                .count( root -> builder.countDistinct( root.get( \"id\" ) ) ) ).intValue();\n+\n         }\n         else\n         {\n"}}, {"oid": "4d3bd1f00472850b89c953f0d475b3fdd9b0071e", "url": "https://github.com/dhis2/dhis2-core/commit/4d3bd1f00472850b89c953f0d475b3fdd9b0071e", "message": "Update dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/datavalue/hibernate/HibernateDataValueAuditStore.java", "committedDate": "2020-02-03T10:18:39Z", "type": "commit"}]}