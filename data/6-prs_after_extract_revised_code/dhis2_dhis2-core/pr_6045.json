{"pr_number": 6045, "pr_title": "feat: support collections for UserPropertyTransformer", "pr_createdAt": "2020-09-01T09:37:07Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6045", "timeline": [{"oid": "fa1af75d070fb6460c3c834cfecacd1170c48d81", "url": "https://github.com/dhis2/dhis2-core/commit/fa1af75d070fb6460c3c834cfecacd1170c48d81", "message": "fix: re-enable property transformer for getMembers", "committedDate": "2020-09-01T09:36:34Z", "type": "commit"}, {"oid": "a0288243f024478a503f537cc99d0397151b502d", "url": "https://github.com/dhis2/dhis2-core/commit/a0288243f024478a503f537cc99d0397151b502d", "message": "minor", "committedDate": "2020-09-01T10:17:41Z", "type": "commit"}, {"oid": "3c33abedaec9efa9bb5c224ce4aa97fb8c249720", "url": "https://github.com/dhis2/dhis2-core/commit/3c33abedaec9efa9bb5c224ce4aa97fb8c249720", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer", "committedDate": "2020-09-01T10:17:45Z", "type": "commit"}, {"oid": "3bcdf14ceb60923c4d831a3ddf707ec4c7919807", "url": "https://github.com/dhis2/dhis2-core/commit/3bcdf14ceb60923c4d831a3ddf707ec4c7919807", "message": "fix: minor code fixes, npe checks", "committedDate": "2020-09-01T11:41:30Z", "type": "commit"}, {"oid": "048d03236516e056ef45e298b7b8c9e49ea9b754", "url": "https://github.com/dhis2/dhis2-core/commit/048d03236516e056ef45e298b7b8c9e49ea9b754", "message": "fix: re-fetch schema for transformed properties", "committedDate": "2020-09-01T12:05:54Z", "type": "commit"}, {"oid": "96b538392adcf7e835b228919d151ba04eb43e7c", "url": "https://github.com/dhis2/dhis2-core/commit/96b538392adcf7e835b228919d151ba04eb43e7c", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer", "committedDate": "2020-09-02T06:49:36Z", "type": "commit"}, {"oid": "3c52f7c5436652c1f9e4c56e7a271e5534149088", "url": "https://github.com/dhis2/dhis2-core/commit/3c52f7c5436652c1f9e4c56e7a271e5534149088", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer", "committedDate": "2020-09-02T08:49:52Z", "type": "commit"}, {"oid": "9c2a6fec4433b46490cb19ea3e60bee558ec4e13", "url": "https://github.com/dhis2/dhis2-core/commit/9c2a6fec4433b46490cb19ea3e60bee558ec4e13", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer", "committedDate": "2020-09-02T09:38:30Z", "type": "commit"}, {"oid": "390390c4e6f3aa58f710a2ce00160abec926d388", "url": "https://github.com/dhis2/dhis2-core/commit/390390c4e6f3aa58f710a2ce00160abec926d388", "message": "minor fixes", "committedDate": "2020-09-02T10:45:10Z", "type": "commit"}, {"oid": "484e148a80d196f19936ff9f75da5dbd68d708ee", "url": "https://github.com/dhis2/dhis2-core/commit/484e148a80d196f19936ff9f75da5dbd68d708ee", "message": "fix: support field expansion for property transformers", "committedDate": "2020-09-02T11:14:46Z", "type": "commit"}, {"oid": "89e2751850d2a36efa15ca999e8d1a6327a4b883", "url": "https://github.com/dhis2/dhis2-core/commit/89e2751850d2a36efa15ca999e8d1a6327a4b883", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer", "committedDate": "2020-09-02T11:27:39Z", "type": "commit"}, {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "url": "https://github.com/dhis2/dhis2-core/commit/e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "message": "fix: npe check", "committedDate": "2020-09-02T11:48:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyODkyMw==", "url": "https://github.com/dhis2/dhis2-core/pull/6045#discussion_r482728923", "bodyText": "Maybe add a little message to this possible require non null, I guess this is not supposed to happen, but if... a small explanation what is possibly wrong could be nice, will also work as a sort of documentation possibly.", "author": "netroms", "createdAt": "2020-09-03T06:19:06Z", "path": "dhis-2/dhis-services/dhis-service-node/src/main/java/org/hisp/dhis/fieldfilter/DefaultFieldFilterService.java", "diffHunk": "@@ -429,11 +424,22 @@ else if ( property.isIdentifiableObject() && isProperIdObject( propertyClass ) )\n                     child = new CollectionNode( property.getCollectionName() );\n                     child.setNamespace( property.getNamespace() );\n \n-                    for ( Object collectionObject : (Collection<?>) returnValue )\n+                    for ( Object collectionObject : (Collection<?>) Objects.requireNonNull( returnValue ) )\n                     {", "originalCommit": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjczMDcwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6045#discussion_r482730702", "bodyText": "Yeah, it was basically to get rid of a IDE warning.. it has been working for the last 6 years :) there is no reason it would ever be null.", "author": "mortenoh", "createdAt": "2020-09-03T06:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyODkyMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyOTAxNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6045#discussion_r482729016", "bodyText": "Same as comment above", "author": "netroms", "createdAt": "2020-09-03T06:19:21Z", "path": "dhis-2/dhis-services/dhis-service-node/src/main/java/org/hisp/dhis/fieldfilter/DefaultFieldFilterService.java", "diffHunk": "@@ -429,11 +424,22 @@ else if ( property.isIdentifiableObject() && isProperIdObject( propertyClass ) )\n                     child = new CollectionNode( property.getCollectionName() );\n                     child.setNamespace( property.getNamespace() );\n \n-                    for ( Object collectionObject : (Collection<?>) returnValue )\n+                    for ( Object collectionObject : (Collection<?>) Objects.requireNonNull( returnValue ) )\n                     {\n-                        Node node = buildNode( fieldValue, property.getItemKlass(), collectionObject, user, property.getName(), defaults );\n+                        Node node;\n+\n+                        if ( property.hasPropertyTransformer() )\n+                        {\n+                            // if it has a transformer, re-get the schema (the item klass has probably changed)\n+                            Schema sch = schemaService.getDynamicSchema( collectionObject.getClass() );\n+                            node = buildNode( fieldValue, sch.getKlass(), collectionObject, user, property.getName(), defaults );\n+                        }\n+                        else\n+                        {\n+                            node = buildNode( fieldValue, property.getItemKlass(), collectionObject, user, property.getName(), defaults );\n+                        }\n \n-                        if ( !node.getChildren().isEmpty() )\n+                        if ( !Objects.requireNonNull( node ).getChildren().isEmpty() )\n                         {", "originalCommit": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}