{"pr_number": 6412, "pr_title": "fix: Make db pool connection test enabled to avoid deadlocks", "pr_createdAt": "2020-10-14T15:06:55Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6412", "timeline": [{"oid": "26a323f794ee0a3748c353b808898a5d6c01093b", "url": "https://github.com/dhis2/dhis2-core/commit/26a323f794ee0a3748c353b808898a5d6c01093b", "message": "fix: broken Hibernate5module usage (#6300) (#6317)\n\n* Remove all usage of Hibernate5Module\nCurrent Hibernate5module configuration breaks the JSON deserialization. The Hibernate5module is meant to be used in context when there is no open session in view, like background tasks and asynchronous tasks.\nIn DHIS2 this used for scheduled background tasks and the audit system.\nAnother PR to reconfigure Hibernate5Module will come later.\n\nIssue: [DHIS2-9451]\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>\n(cherry picked from commit 2a6af5fe3c745123be67bd3a84127d32f04761f4)", "committedDate": "2020-10-13T11:16:56Z", "type": "commit"}, {"oid": "804e41f0bcac6aca13f82d772223163b75eab0d1", "url": "https://github.com/dhis2/dhis2-core/commit/804e41f0bcac6aca13f82d772223163b75eab0d1", "message": "fix: Change db pool timeout settings to avoid deadlocks\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>", "committedDate": "2020-10-14T15:05:35Z", "type": "commit"}, {"oid": "5a6ec9ef8c0e19bd65508825958c2a4889e96f9c", "url": "https://github.com/dhis2/dhis2-core/commit/5a6ec9ef8c0e19bd65508825958c2a4889e96f9c", "message": "fix: Change db pool timeout settings to avoid deadlocks\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>", "committedDate": "2020-10-15T07:28:24Z", "type": "commit"}, {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f", "url": "https://github.com/dhis2/dhis2-core/commit/ce7e1852b6045c447c03641255d7f0c0f9a9537f", "message": "Merge branch 'patch/2.35.0' of github.com:dhis2/dhis2-core into adjust_db_pool_timeout", "committedDate": "2020-10-15T07:33:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwMjQxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505302411", "bodyText": "Code style, space after \"(\" and \",\". This and next line.", "author": "larshelge", "createdAt": "2020-10-15T08:00:24Z", "path": "dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java", "diffHunk": "@@ -52,6 +52,14 @@\n     CONNECTION_PASSWORD( \"connection.password\", \"\", true ),\n     CONNECTION_SCHEMA( \"connection.schema\", \"\", false ),\n     CONNECTION_POOL_MAX_SIZE( \"connection.pool.max_size\", \"80\", false ),\n+    CONNECTION_POOL_MIN_SIZE( \"connection.pool.min_size\", \"5\", false ),\n+    CONNECTION_POOL_INITIAL_SIZE( \"connection.pool.initial_size\", \"5\", false ),\n+    CONNECTION_POOL_ACQUIRE_INCR( \"connection.pool.acquire_incr\", \"5\", false ),\n+    CONNECTION_POOL_MAX_IDLE_TIME( \"connection.pool.max_idle_time\", \"7200\", false ),\n+    CONNECTION_POOL_MAX_IDLE_TIME_EXCESS_CON( \"connection.pool.max_idle_time_excess_con\", \"0\", false ),\n+    CONNECTION_POOL_IDLE_CON_TEST_PERIOD( \"connection.pool.idle.con.test.period\", \"0\", false ),\n+    CONNECTION_POOL_TEST_ON_CHECKOUT(\"connection.pool.test.on.checkout\",\"false\",false),", "originalCommit": "ce7e1852b6045c447c03641255d7f0c0f9a9537f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2a852523facb3c3b0f58fa7c57096cedff61e8b", "chunk": "diff --git a/dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java b/dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java\nindex a9c159685c..41a85e3222 100644\n--- a/dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java\n+++ b/dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java\n\n@@ -58,8 +58,8 @@ public enum ConfigurationKey\n     CONNECTION_POOL_MAX_IDLE_TIME( \"connection.pool.max_idle_time\", \"7200\", false ),\n     CONNECTION_POOL_MAX_IDLE_TIME_EXCESS_CON( \"connection.pool.max_idle_time_excess_con\", \"0\", false ),\n     CONNECTION_POOL_IDLE_CON_TEST_PERIOD( \"connection.pool.idle.con.test.period\", \"0\", false ),\n-    CONNECTION_POOL_TEST_ON_CHECKOUT(\"connection.pool.test.on.checkout\",\"false\",false),\n-    CONNECTION_POOL_TEST_ON_CHECKIN(\"connection.pool.test.on.checkin\",\"true\",false),\n+    CONNECTION_POOL_TEST_ON_CHECKOUT( \"connection.pool.test.on.checkout\", \"false\", false ),\n+    CONNECTION_POOL_TEST_ON_CHECKIN( \"connection.pool.test.on.checkin\", \"true\", false ),\n     LDAP_URL( \"ldap.url\", \"ldaps://0:1\", false ),\n     LDAP_MANAGER_DN( \"ldap.manager.dn\", \"\", false ),\n     LDAP_MANAGER_PASSWORD( \"ldap.manager.password\", \"\", true ),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwODc2MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505308760", "bodyText": "Here we need to use the Hibernate Environment equivalent @netroms as the second argument . E.g. use Environment.C3P0_MAX_SIZE. This because we are eventually passing these properties to Hibernate. Hibernate needs its own config properties (or the C3P0 specific properties), not the DHIS 2 specific properties.", "author": "larshelge", "createdAt": "2020-10-15T08:05:10Z", "path": "dhis-2/dhis-support/dhis-support-hibernate/src/main/java/org/hisp/dhis/hibernate/DefaultHibernateConfigurationProvider.java", "diffHunk": "@@ -232,6 +232,22 @@ private Properties getHibernateProperties()\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_USERNAME ), Environment.USER, props );\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_PASSWORD ), Environment.PASS, props );\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_POOL_MAX_SIZE ), Environment.C3P0_MAX_SIZE, props );\n+        putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_POOL_MIN_SIZE ),\n+            ConfigurationKey.CONNECTION_POOL_MIN_SIZE.getKey(), props );", "originalCommit": "ce7e1852b6045c447c03641255d7f0c0f9a9537f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMxMzQ0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505313441", "bodyText": "Or with the Java config change in HibernateConfig, maybe this is no longer needed, and we could refactor and not use the Hibernate property names at all?", "author": "larshelge", "createdAt": "2020-10-15T08:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwODc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMyMTcxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505321711", "bodyText": "Hi, yes I have tested it, the properties are propagated as normal properties through the Configuration object", "author": "netroms", "createdAt": "2020-10-15T08:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwODc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4ODQ0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505388447", "bodyText": "That's good. I think it's time for a refactor of the config stuff but that can certainly wait.", "author": "larshelge", "createdAt": "2020-10-15T09:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwODc2MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f2a852523facb3c3b0f58fa7c57096cedff61e8b", "url": "https://github.com/dhis2/dhis2-core/commit/f2a852523facb3c3b0f58fa7c57096cedff61e8b", "message": "fix: Make db pool connection test enabled to avoid deadlocks\n\n* Formatting fix", "committedDate": "2020-10-15T09:49:43Z", "type": "commit"}]}