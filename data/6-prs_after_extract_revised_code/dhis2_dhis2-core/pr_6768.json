{"pr_number": 6768, "pr_title": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes", "pr_createdAt": "2020-11-26T17:17:55Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6768", "timeline": [{"oid": "1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "url": "https://github.com/dhis2/dhis2-core/commit/1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "message": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes", "committedDate": "2020-11-26T17:17:16Z", "type": "commit"}, {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "url": "https://github.com/dhis2/dhis2-core/commit/fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "message": "fix: DHIS2-10001 mandatory attributes in existing tests is set to false to fix tests", "committedDate": "2020-11-27T12:45:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533428618", "bodyText": "This TEI passed to validation cannot be null, so we could simply get the attributes without the optional", "author": "enricocolasante", "createdAt": "2020-12-01T14:01:39Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )", "originalCommit": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzAyMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097021", "bodyText": "you're right, thank you", "author": "gnespolino", "createdAt": "2020-12-02T11:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA=="}], "type": "inlineReview", "revised_code": {"commit": "2c30dad98da1bb63160b2cfb98d195bf6633371d", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\nindex 007620cbaa..d49b0d92d8 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\n\n@@ -114,36 +111,19 @@ public class TrackedEntityAttributeValidationHook extends AttributeValidationHoo\n \n         if ( trackedEntityType != null )\n         {\n-            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n-                .map( TrackedEntity::getAttributes )\n-                .orElse( Collections.emptyList() )\n+            Set<String> trackedEntityAttributes = trackedEntity.getAttributes()\n                 .stream()\n                 .map( Attribute::getAttribute )\n                 .collect( Collectors.toSet() );\n \n             trackedEntityType.getTrackedEntityTypeAttributes()\n                 .stream()\n-                .filter( this::isMandatory )\n+                .filter( trackedEntityTypeAttribute -> Boolean.TRUE.equals( trackedEntityTypeAttribute.isMandatory() ) )\n                 .map( BaseIdentifiableObject::getUid )\n+                .filter( mandatoryAttributeUid -> !trackedEntityAttributes.contains( mandatoryAttributeUid ) )\n                 .forEach(\n-                    attribute -> addErrorIfMissing( reporter, attribute, trackedEntityAttributes, trackedEntity,\n-                        trackedEntityType ) );\n-        }\n-    }\n-\n-    private boolean isMandatory( TrackedEntityTypeAttribute trackedEntityTypeAttribute )\n-    {\n-        return Optional.of( trackedEntityTypeAttribute )\n-            .map( TrackedEntityTypeAttribute::isMandatory )\n-            .orElse( false );\n-    }\n-\n-    private void addErrorIfMissing( ValidationErrorReporter reporter, String attribute,\n-        Set<String> trackedEntityAttributes, TrackedEntity trackedEntity, TrackedEntityType trackedEntityType )\n-    {\n-        if ( !trackedEntityAttributes.contains( attribute ) )\n-        {\n-            addError( reporter, E1090, attribute, trackedEntityType.getUid(), trackedEntity.getTrackedEntity() );\n+                    attribute -> addError( reporter, E1090, attribute, trackedEntityType.getUid(),\n+                        trackedEntity.getTrackedEntity() ) );\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533435447", "bodyText": "I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()\nI would go with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .filter( this::isMandatory )\n          \n          \n            \n                           .filter(Obects::isNotNull)\n          \n          \n            \n                           .filter(TrackedEntityTypeAttribute::isMandatory)\n          \n      \n    \n    \n  \n\nbut of course this is purely personal style", "author": "enricocolasante", "createdAt": "2020-12-01T14:11:10Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n+                .map( TrackedEntity::getAttributes )\n+                .orElse( Collections.emptyList() )\n+                .stream()\n+                .map( Attribute::getAttribute )\n+                .collect( Collectors.toSet() );\n+\n+            trackedEntityType.getTrackedEntityTypeAttributes()\n+                .stream()\n+                .filter( this::isMandatory )", "originalCommit": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzI1Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097257", "bodyText": "yes, your version is much easier, I'll change it", "author": "gnespolino", "createdAt": "2020-12-02T11:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2c30dad98da1bb63160b2cfb98d195bf6633371d", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\nindex 007620cbaa..d49b0d92d8 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java\n\n@@ -114,36 +111,19 @@ public class TrackedEntityAttributeValidationHook extends AttributeValidationHoo\n \n         if ( trackedEntityType != null )\n         {\n-            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n-                .map( TrackedEntity::getAttributes )\n-                .orElse( Collections.emptyList() )\n+            Set<String> trackedEntityAttributes = trackedEntity.getAttributes()\n                 .stream()\n                 .map( Attribute::getAttribute )\n                 .collect( Collectors.toSet() );\n \n             trackedEntityType.getTrackedEntityTypeAttributes()\n                 .stream()\n-                .filter( this::isMandatory )\n+                .filter( trackedEntityTypeAttribute -> Boolean.TRUE.equals( trackedEntityTypeAttribute.isMandatory() ) )\n                 .map( BaseIdentifiableObject::getUid )\n+                .filter( mandatoryAttributeUid -> !trackedEntityAttributes.contains( mandatoryAttributeUid ) )\n                 .forEach(\n-                    attribute -> addErrorIfMissing( reporter, attribute, trackedEntityAttributes, trackedEntity,\n-                        trackedEntityType ) );\n-        }\n-    }\n-\n-    private boolean isMandatory( TrackedEntityTypeAttribute trackedEntityTypeAttribute )\n-    {\n-        return Optional.of( trackedEntityTypeAttribute )\n-            .map( TrackedEntityTypeAttribute::isMandatory )\n-            .orElse( false );\n-    }\n-\n-    private void addErrorIfMissing( ValidationErrorReporter reporter, String attribute,\n-        Set<String> trackedEntityAttributes, TrackedEntity trackedEntity, TrackedEntityType trackedEntityType )\n-    {\n-        if ( !trackedEntityAttributes.contains( attribute ) )\n-        {\n-            addError( reporter, E1090, attribute, trackedEntityType.getUid(), trackedEntity.getTrackedEntity() );\n+                    attribute -> addError( reporter, E1090, attribute, trackedEntityType.getUid(),\n+                        trackedEntity.getTrackedEntity() ) );\n         }\n     }\n \n"}}, {"oid": "2c30dad98da1bb63160b2cfb98d195bf6633371d", "url": "https://github.com/dhis2/dhis2-core/commit/2c30dad98da1bb63160b2cfb98d195bf6633371d", "message": "feat: DHIS2-10001 mandatory attribute check implementation", "committedDate": "2020-12-02T15:14:04Z", "type": "commit"}]}