{"pr_number": 5833, "pr_title": "test: Add integration tests for tracker side effects", "pr_createdAt": "2020-07-08T17:46:39Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5833", "timeline": [{"oid": "cb72713bb695179ad2c7bc1193bbd8211af9e1ce", "url": "https://github.com/dhis2/dhis2-core/commit/cb72713bb695179ad2c7bc1193bbd8211af9e1ce", "message": "test side effect handler services", "committedDate": "2020-05-30T14:13:02Z", "type": "commit"}, {"oid": "b042810aadf05dcddb2547bada08e10ded2374e9", "url": "https://github.com/dhis2/dhis2-core/commit/b042810aadf05dcddb2547bada08e10ded2374e9", "message": "add sample Tracker events payload", "committedDate": "2020-05-31T12:30:38Z", "type": "commit"}, {"oid": "76f928c1720b25aaaf5ee11699158b8456f695bb", "url": "https://github.com/dhis2/dhis2-core/commit/76f928c1720b25aaaf5ee11699158b8456f695bb", "message": "Merge branch 'master' into tracker-side-effect", "committedDate": "2020-06-16T05:58:24Z", "type": "commit"}, {"oid": "8e4b516a3b884e9a882b4ee2dcabf1a86c395712", "url": "https://github.com/dhis2/dhis2-core/commit/8e4b516a3b884e9a882b4ee2dcabf1a86c395712", "message": "Merge branch 'master' into tracker-side-effect", "committedDate": "2020-07-02T14:28:44Z", "type": "commit"}, {"oid": "1653406266c3fac74a8378a1cf3a7facc3b263b2", "url": "https://github.com/dhis2/dhis2-core/commit/1653406266c3fac74a8378a1cf3a7facc3b263b2", "message": "Use IntegrationTestBase to run tests against Postgress", "committedDate": "2020-07-02T15:12:56Z", "type": "commit"}, {"oid": "2bd346f0c48703d794bb3ab8cb2f60d93163be88", "url": "https://github.com/dhis2/dhis2-core/commit/2bd346f0c48703d794bb3ab8cb2f60d93163be88", "message": "remove unused dependency", "committedDate": "2020-07-02T16:54:29Z", "type": "commit"}, {"oid": "631ff3b700f138e3a7fddca60bf0cfe23ecb21fe", "url": "https://github.com/dhis2/dhis2-core/commit/631ff3b700f138e3a7fddca60bf0cfe23ecb21fe", "message": "Add tracker side effect converter service", "committedDate": "2020-07-06T15:39:59Z", "type": "commit"}, {"oid": "bacc296631ba0347b00a963793a56180d6bc5596", "url": "https://github.com/dhis2/dhis2-core/commit/bacc296631ba0347b00a963793a56180d6bc5596", "message": "Add tracker domain objects for rule-engine", "committedDate": "2020-07-06T15:40:23Z", "type": "commit"}, {"oid": "7aa73779f484207a7def21bd6204825698e047a7", "url": "https://github.com/dhis2/dhis2-core/commit/7aa73779f484207a7def21bd6204825698e047a7", "message": "MWT", "committedDate": "2020-07-06T15:42:39Z", "type": "commit"}, {"oid": "aaef4c848de560ed97868fb6bc589a11c8bfd5b7", "url": "https://github.com/dhis2/dhis2-core/commit/aaef4c848de560ed97868fb6bc589a11c8bfd5b7", "message": "add json annotations", "committedDate": "2020-07-06T17:07:16Z", "type": "commit"}, {"oid": "ea315cac6cca85fe06d66b305e4d7a0c5d298bd9", "url": "https://github.com/dhis2/dhis2-core/commit/ea315cac6cca85fe06d66b305e4d7a0c5d298bd9", "message": "code refactor", "committedDate": "2020-07-07T17:56:59Z", "type": "commit"}, {"oid": "c52f8c7ef02a1d189eba3a9ac4ee935b14eb2e76", "url": "https://github.com/dhis2/dhis2-core/commit/c52f8c7ef02a1d189eba3a9ac4ee935b14eb2e76", "message": "fix valid date", "committedDate": "2020-07-07T22:40:11Z", "type": "commit"}, {"oid": "7ae5436778e9e86e899c73ff00e84dfa28f9a4b7", "url": "https://github.com/dhis2/dhis2-core/commit/7ae5436778e9e86e899c73ff00e84dfa28f9a4b7", "message": "Use awaitility to test side effect thread execution", "committedDate": "2020-07-08T16:48:34Z", "type": "commit"}, {"oid": "c6e29e98f6bc7782bb7735fc1aecad4a5851f245", "url": "https://github.com/dhis2/dhis2-core/commit/c6e29e98f6bc7782bb7735fc1aecad4a5851f245", "message": "rename resource file", "committedDate": "2020-07-08T16:53:57Z", "type": "commit"}, {"oid": "b2dc61992d93d18a1a7908791589961d810a6c7c", "url": "https://github.com/dhis2/dhis2-core/commit/b2dc61992d93d18a1a7908791589961d810a6c7c", "message": "minor code refactor", "committedDate": "2020-07-08T17:42:49Z", "type": "commit"}, {"oid": "85299d182397b2c1a4646c49d611b9b2f377eece", "url": "https://github.com/dhis2/dhis2-core/commit/85299d182397b2c1a4646c49d611b9b2f377eece", "message": "Merge branch 'master' into tracker-side-effect", "committedDate": "2020-07-09T07:21:49Z", "type": "commit"}, {"oid": "2a5e115cd77cfe8a9f97be6101a976dcc0a8ea11", "url": "https://github.com/dhis2/dhis2-core/commit/2a5e115cd77cfe8a9f97be6101a976dcc0a8ea11", "message": "change rule-engine version", "committedDate": "2020-07-09T07:27:14Z", "type": "commit"}, {"oid": "89d02443457db4b76b6e0a31a1271b92659afdbe", "url": "https://github.com/dhis2/dhis2-core/commit/89d02443457db4b76b6e0a31a1271b92659afdbe", "message": "text fixes", "committedDate": "2020-07-09T08:57:40Z", "type": "commit"}, {"oid": "a4b2d82bf2528d44a2f7f37d2c175ac88171430f", "url": "https://github.com/dhis2/dhis2-core/commit/a4b2d82bf2528d44a2f7f37d2c175ac88171430f", "message": "fix conflicts", "committedDate": "2020-07-11T10:00:53Z", "type": "commit"}, {"oid": "51a34f76fa94aeca41c366950862b97e87d989b1", "url": "https://github.com/dhis2/dhis2-core/commit/51a34f76fa94aeca41c366950862b97e87d989b1", "message": "ignore unit tests for now", "committedDate": "2020-07-11T10:02:24Z", "type": "commit"}, {"oid": "dbe627784cbc751cb4b0fcaec02159a2ef9efd63", "url": "https://github.com/dhis2/dhis2-core/commit/dbe627784cbc751cb4b0fcaec02159a2ef9efd63", "message": "fix sonar code smells", "committedDate": "2020-07-11T10:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNDg0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r454224841", "bodyText": "Might it be better to cast a np here and use checkNotNull, since a silent fail will mask a potential bug?", "author": "netroms", "createdAt": "2020-07-14T09:26:31Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java", "diffHunk": "@@ -120,18 +124,21 @@ protected ProgramNotificationInstance createNotificationInstance( ProgramNotific\n         return notificationInstance;\n     }\n \n-    protected boolean validate( RuleEffect ruleEffect, ProgramInstance programInstance )\n+    @Transactional\n+    public boolean validate( RuleEffect ruleEffect, ProgramInstance programInstance )\n     {\n-        if ( ruleEffect == null )\n+        if ( ruleEffect == null || programInstance == null )", "originalCommit": "dbe627784cbc751cb4b0fcaec02159a2ef9efd63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0ODA4MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465048080", "bodyText": "fixed", "author": "zubaira", "createdAt": "2020-08-04T13:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxMDQ5MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465610491", "bodyText": "Is it fixed in the branch and pushed?", "author": "larshelge", "createdAt": "2020-08-05T09:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNDg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxMTE5NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465611195", "bodyText": "fixed in the branch but have not pushed it yet.", "author": "zubaira", "createdAt": "2020-08-05T09:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNDg0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ba5ff961fc07a0fc5acf04347e61162447946115", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\nindex 21d333f60a..fd93aea531 100644\n--- a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\n+++ b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\n\n@@ -124,15 +126,10 @@ abstract class NotificationRuleActionImplementer implements RuleActionImplemente\n         return notificationInstance;\n     }\n \n-    @Transactional\n     public boolean validate( RuleEffect ruleEffect, ProgramInstance programInstance )\n     {\n-        if ( ruleEffect == null || programInstance == null )\n-        {\n-            log.warn( \"RuleEffect and ProgramInstance cannot be null\" );\n-\n-            return false;\n-        }\n+        checkNotNull( ruleEffect );\n+        checkNotNull( programInstance );\n \n         ProgramNotificationTemplate template = getNotificationTemplate( ruleEffect.ruleAction() );\n \n"}}, {"oid": "c87c2a73d1273ac60b0d6b1ebae83b8f6bfa6a4e", "url": "https://github.com/dhis2/dhis2-core/commit/c87c2a73d1273ac60b0d6b1ebae83b8f6bfa6a4e", "message": "Fix conflict and merge with master", "committedDate": "2020-07-29T12:20:55Z", "type": "commit"}, {"oid": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "url": "https://github.com/dhis2/dhis2-core/commit/9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "message": "fix code smells", "committedDate": "2020-07-29T23:17:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDQ5NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464214494", "bodyText": "What is the reason to move the @Transactional boundary \"down\" to the DAO class? Normally, we transactionally annotate services rather than a repository. I would suggest adding a short comment to explain the deviation from the norm.", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:20:25Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/notification/DefaultProgramNotificationTemplateStore.java", "diffHunk": "@@ -39,11 +39,13 @@\n import org.springframework.context.ApplicationEventPublisher;\n import org.springframework.jdbc.core.JdbcTemplate;\n import org.springframework.stereotype.Repository;\n+import org.springframework.transaction.annotation.Transactional;\n \n /**\n  * Created by zubair@dhis2.org on 16.11.17.\n  */\n @Repository( \"org.hisp.dhis.program.notification.ProgramNotificationTemplateStore\" )\n+@Transactional", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5MjE3MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465692171", "bodyText": "fixed by creating a service layer class", "author": "zubaira", "createdAt": "2020-08-05T12:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "f8f50b8cd8e500fde04ff4378e429501f149700b", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/notification/DefaultProgramNotificationTemplateStore.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/notification/DefaultProgramNotificationTemplateStore.java\nindex 0328bee4f9..5e63ff2f97 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/notification/DefaultProgramNotificationTemplateStore.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/notification/DefaultProgramNotificationTemplateStore.java\n\n@@ -44,8 +44,7 @@ import org.springframework.transaction.annotation.Transactional;\n /**\n  * Created by zubair@dhis2.org on 16.11.17.\n  */\n-@Repository( \"org.hisp.dhis.program.notification.ProgramNotificationTemplateStore\" )\n-@Transactional\n+@Repository( \"org.hisp.dhis.program.ProgramNotificationTemplateStore\" )\n public class DefaultProgramNotificationTemplateStore extends HibernateIdentifiableObjectStore<ProgramNotificationTemplate>\n     implements ProgramNotificationTemplateStore\n {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTIxNg==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464215216", "bodyText": "This class doesn't seem to be Spring-managed and the constructor is not used. Is it used in some other way?", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:22:40Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/ProgramNotificationInstanceDeletionHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.hisp.dhis.program;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import org.hisp.dhis.program.notification.ProgramNotificationInstance;\n+import org.hisp.dhis.program.notification.ProgramNotificationInstanceStore;\n+import org.hisp.dhis.system.deletion.DeletionHandler;\n+\n+import java.util.List;\n+\n+/**\n+ * @author Zubair Asghar\n+ */\n+public class ProgramNotificationInstanceDeletionHandler", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYwOTk5Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465609993", "bodyText": "Agree, this needs to be a component to have any effect.", "author": "larshelge", "createdAt": "2020-08-05T09:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxMDU2MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465610560", "bodyText": "PR is coming", "author": "zubaira", "createdAt": "2020-08-05T09:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1NDg1Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r469754852", "bodyText": "Thanks Zubair. Is this fixed in the PR?", "author": "larshelge", "createdAt": "2020-08-13T07:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1NjA2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r469756063", "bodyText": "yes. It is fixed in this PR. Just waiting for this PR to be merged.", "author": "zubaira", "createdAt": "2020-08-13T07:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "ba5ff961fc07a0fc5acf04347e61162447946115", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/ProgramNotificationInstanceDeletionHandler.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/ProgramNotificationInstanceDeletionHandler.java\nindex 64f971f460..cc8e4f0e67 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/ProgramNotificationInstanceDeletionHandler.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/ProgramNotificationInstanceDeletionHandler.java\n\n@@ -31,12 +31,15 @@ package org.hisp.dhis.program;\n import org.hisp.dhis.program.notification.ProgramNotificationInstance;\n import org.hisp.dhis.program.notification.ProgramNotificationInstanceStore;\n import org.hisp.dhis.system.deletion.DeletionHandler;\n+import org.springframework.stereotype.Component;\n \n import java.util.List;\n \n /**\n  * @author Zubair Asghar\n  */\n+\n+@Component( \"org.hisp.dhis.program.ProgramNotificationInstanceDeletionHandler\" )\n public class ProgramNotificationInstanceDeletionHandler\n     extends DeletionHandler\n {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjMxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464216311", "bodyText": "Consider removing this annotation. The method doesn't accces the DB directly, but only through another method (getNotificationTemplate) which is already annotated with @Transactional", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:26:05Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java", "diffHunk": "@@ -86,7 +89,8 @@ protected ExternalNotificationLogEntry createLogEntry(String key, String templat\n         return entry;\n     }\n \n-    protected ProgramNotificationTemplate getNotificationTemplate( RuleAction action )\n+    @Transactional", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NTI4Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465695282", "bodyText": "fixed", "author": "zubaira", "createdAt": "2020-08-05T12:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "8c64293b493c648bcda9d0f2c84d8380e016de00", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\nindex 21d333f60a..c9bcc8a100 100644\n--- a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\n+++ b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/NotificationRuleActionImplementer.java\n\n@@ -89,7 +91,7 @@ abstract class NotificationRuleActionImplementer implements RuleActionImplemente\n         return entry;\n     }\n \n-    @Transactional\n+    @Transactional( readOnly = true )\n     public ProgramNotificationTemplate getNotificationTemplate( RuleAction action )\n     {\n         String uid = \"\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjQ4OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464216489", "bodyText": "invalid tag, use @author", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:26:40Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java", "diffHunk": "@@ -44,12 +44,14 @@\n import org.springframework.stereotype.Component;\n \n import lombok.extern.slf4j.Slf4j;\n+import org.springframework.transaction.annotation.Transactional;\n \n /**\n  * @Author Zubair Asghar.", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba5ff961fc07a0fc5acf04347e61162447946115", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\nindex e6cb3600fa..bbc9014ec5 100644\n--- a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\n+++ b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\n\n@@ -47,11 +47,10 @@ import lombok.extern.slf4j.Slf4j;\n import org.springframework.transaction.annotation.Transactional;\n \n /**\n- * @Author Zubair Asghar.\n+ * @author Zubair Asghar.\n  */\n @Slf4j\n @Component( \"org.hisp.dhis.programrule.engine.RuleActionAssignValueImplementer\" )\n-@Transactional\n public class RuleActionAssignValueImplementer implements RuleActionImplementer\n {\n     private static final String REGEX = \"[a-zA-Z0-9]+(?:[\\\\w -._]*[a-zA-Z0-9]+)*\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNzQxNg==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464217416", "bodyText": "We standardized the usage of @Trasactional: it should be used on methods rather that at class level. I have the impression that this method does not really need this annotation, since all the methods are\n\nread-only\ncalling other methods on different classes that are already annotated.\n\nPlease review the remaining methods and move the @transactional annotation only to methods where it is needed.", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:29:31Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java", "diffHunk": "@@ -44,12 +44,14 @@\n import org.springframework.stereotype.Component;\n \n import lombok.extern.slf4j.Slf4j;\n+import org.springframework.transaction.annotation.Transactional;\n \n /**\n  * @Author Zubair Asghar.\n  */\n @Slf4j\n @Component( \"org.hisp.dhis.programrule.engine.RuleActionAssignValueImplementer\" )\n+@Transactional", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NTQwOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465695408", "bodyText": "fixed", "author": "zubaira", "createdAt": "2020-08-05T12:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNzQxNg=="}], "type": "inlineReview", "revised_code": {"commit": "ba5ff961fc07a0fc5acf04347e61162447946115", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\nindex e6cb3600fa..bbc9014ec5 100644\n--- a/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\n+++ b/dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/RuleActionAssignValueImplementer.java\n\n@@ -47,11 +47,10 @@ import lombok.extern.slf4j.Slf4j;\n import org.springframework.transaction.annotation.Transactional;\n \n /**\n- * @Author Zubair Asghar.\n+ * @author Zubair Asghar.\n  */\n @Slf4j\n @Component( \"org.hisp.dhis.programrule.engine.RuleActionAssignValueImplementer\" )\n-@Transactional\n public class RuleActionAssignValueImplementer implements RuleActionImplementer\n {\n     private static final String REGEX = \"[a-zA-Z0-9]+(?:[\\\\w -._]*[a-zA-Z0-9]+)*\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxODc5MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464218790", "bodyText": "This seems unused", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:33:42Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/bundle/DefaultTrackerBundleService.java", "diffHunk": "@@ -147,6 +153,7 @@ public DefaultTrackerBundleService( TrackerPreheatService trackerPreheatService,\n         this.dbmsManager = dbmsManager;\n         this.trackerProgramRuleService = trackerProgramRuleService;", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f13e4f5acef189498f5a5645bf049630a6d42583", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/bundle/DefaultTrackerBundleService.java b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/bundle/DefaultTrackerBundleService.java\nindex ea05f92462..3baffa8af8 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/bundle/DefaultTrackerBundleService.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/bundle/DefaultTrackerBundleService.java\n\n@@ -151,7 +145,6 @@ public class DefaultTrackerBundleService\n         this.sessionFactory = sessionFactory;\n         this.cacheManager = cacheManager;\n         this.dbmsManager = dbmsManager;\n-        this.trackerProgramRuleService = trackerProgramRuleService;\n         this.reservedValueService = reservedValueService;\n         this.sideEffectConverterService = sideEffectConverterService;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMDYxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464220611", "bodyText": "Some Javadoc would be good", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:39:22Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/sideeffect/TrackerAssignValueSideEffect.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.hisp.dhis.tracker.sideeffect;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+/**\n+ * @author Zubair Asghar\n+ */\n+\n+@Data\n+@Builder( builderClassName = \"TrackerAssignValueSideEffectBuilder\" )\n+@JsonDeserialize( builder = TrackerAssignValueSideEffect.TrackerAssignValueSideEffectBuilder.class )\n+public class TrackerAssignValueSideEffect implements TrackerSideEffect", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MzgyNg==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465063826", "bodyText": "fixed", "author": "zubaira", "createdAt": "2020-08-04T13:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMDYxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1a19ed19cdc06f5af7771004bea00ba9d2d4a96f", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/sideeffect/TrackerAssignValueSideEffect.java b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/sideeffect/TrackerAssignValueSideEffect.java\nindex 53f39c2ec8..c812c50dd3 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/sideeffect/TrackerAssignValueSideEffect.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/sideeffect/TrackerAssignValueSideEffect.java\n\n@@ -41,7 +41,7 @@ import lombok.Data;\n @Data\n @Builder( builderClassName = \"TrackerAssignValueSideEffectBuilder\" )\n @JsonDeserialize( builder = TrackerAssignValueSideEffect.TrackerAssignValueSideEffectBuilder.class )\n-public class TrackerAssignValueSideEffect implements TrackerSideEffect\n+public class TrackerAssignValueSideEffect implements TrackerRuleEngineSideEffect\n {\n     @JsonProperty\n     private String data;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMTI1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r464221251", "bodyText": "10 seconds is a bit too long for a test? Have you considered lowering to 1 or 2 secs?", "author": "luciano-fiandesio", "createdAt": "2020-08-03T06:41:13Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/bundle/TrackerSideEffectHandlerServiceTest.java", "diffHunk": "@@ -129,6 +140,20 @@ public void testRuleEngineSideEffectHandlerService()\n \n         TrackerBundleReport report = trackerBundleService.commit( trackerBundles.get( 0 ) );\n \n+        List<TrackerSideEffectDataBundle> sideEffectDataBundles = ListUtils.union(\n+            report.getTypeReportMap().get( TrackerType.ENROLLMENT ).getSideEffectDataBundles(),\n+            report.getTypeReportMap().get( TrackerType.EVENT ).getSideEffectDataBundles() );\n+\n+        trackerBundleService.handleTrackerSideEffects( sideEffectDataBundles );\n+\n         assertEquals( report.getStatus(), TrackerStatus.OK );\n+\n+        await().atMost( 10, TimeUnit.SECONDS ).until( () -> manager.getAll( ProgramNotificationInstance.class ).size() > 0 );", "originalCommit": "9d5336e61cdd08cc580c3dafb9a94fb514f126cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NTUyNw==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r465695527", "bodyText": "set it to 2", "author": "zubaira", "createdAt": "2020-08-05T12:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMTI1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2MzAwNw==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r469763007", "bodyText": "2 also sounds a bit high :-) Do we need this? I.e. is there a way to mock or handle it differently?", "author": "larshelge", "createdAt": "2020-08-13T07:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMTI1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc3MDgyNw==", "url": "https://github.com/dhis2/dhis2-core/pull/5833#discussion_r469770827", "bodyText": "Side effects are handled asynchronously. So this is one of the ways to test thread functionality.", "author": "zubaira", "createdAt": "2020-08-13T08:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyMTI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c54a71ba542c7308c0f1d4575f21ecae0001a049", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/bundle/TrackerSideEffectHandlerServiceTest.java b/dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/bundle/TrackerSideEffectHandlerServiceTest.java\nindex 2c39029613..0453cedd2b 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/bundle/TrackerSideEffectHandlerServiceTest.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/bundle/TrackerSideEffectHandlerServiceTest.java\n\n@@ -148,7 +148,7 @@ public class TrackerSideEffectHandlerServiceTest extends DhisSpringTest\n \n         assertEquals( report.getStatus(), TrackerStatus.OK );\n \n-        await().atMost( 10, TimeUnit.SECONDS ).until( () -> manager.getAll( ProgramNotificationInstance.class ).size() > 0 );\n+        await().atMost( 2, TimeUnit.SECONDS ).until( () -> manager.getAll( ProgramNotificationInstance.class ).size() > 0 );\n \n         List<ProgramNotificationInstance> instances = manager.getAll( ProgramNotificationInstance.class );\n \n"}}, {"oid": "f13e4f5acef189498f5a5645bf049630a6d42583", "url": "https://github.com/dhis2/dhis2-core/commit/f13e4f5acef189498f5a5645bf049630a6d42583", "message": "fix conflict with master branch", "committedDate": "2020-08-04T13:08:35Z", "type": "commit"}, {"oid": "ba5ff961fc07a0fc5acf04347e61162447946115", "url": "https://github.com/dhis2/dhis2-core/commit/ba5ff961fc07a0fc5acf04347e61162447946115", "message": "use Transactional annotation at class level", "committedDate": "2020-08-04T13:37:03Z", "type": "commit"}, {"oid": "1a19ed19cdc06f5af7771004bea00ba9d2d4a96f", "url": "https://github.com/dhis2/dhis2-core/commit/1a19ed19cdc06f5af7771004bea00ba9d2d4a96f", "message": "rename TrackerSideEffect class", "committedDate": "2020-08-04T13:40:49Z", "type": "commit"}, {"oid": "c54a71ba542c7308c0f1d4575f21ecae0001a049", "url": "https://github.com/dhis2/dhis2-core/commit/c54a71ba542c7308c0f1d4575f21ecae0001a049", "message": "reduce waiting time to 2 seconds", "committedDate": "2020-08-04T13:41:31Z", "type": "commit"}, {"oid": "b6fd1250a0400ba8563f4e9320e0c660f55e4b1c", "url": "https://github.com/dhis2/dhis2-core/commit/b6fd1250a0400ba8563f4e9320e0c660f55e4b1c", "message": "add java doc for TrackerRuleEngineSideEffect", "committedDate": "2020-08-04T13:49:30Z", "type": "commit"}, {"oid": "c60aa9857452517dc019455ce2df1889d46a85a8", "url": "https://github.com/dhis2/dhis2-core/commit/c60aa9857452517dc019455ce2df1889d46a85a8", "message": "add ProgramNotificationInstanceService", "committedDate": "2020-08-04T14:18:03Z", "type": "commit"}, {"oid": "89ef99facfa73dfc1cbeafe5189076ed22d6d242", "url": "https://github.com/dhis2/dhis2-core/commit/89ef99facfa73dfc1cbeafe5189076ed22d6d242", "message": "code style changes", "committedDate": "2020-08-05T07:50:51Z", "type": "commit"}, {"oid": "e7534a78e97b8f7fd5a46b3dd6bf01f030e3de13", "url": "https://github.com/dhis2/dhis2-core/commit/e7534a78e97b8f7fd5a46b3dd6bf01f030e3de13", "message": "Add mocked currentUserService", "committedDate": "2020-08-05T12:12:26Z", "type": "commit"}, {"oid": "f8f50b8cd8e500fde04ff4378e429501f149700b", "url": "https://github.com/dhis2/dhis2-core/commit/f8f50b8cd8e500fde04ff4378e429501f149700b", "message": "Add service layer class for ProgramNotificationTemplate", "committedDate": "2020-08-05T12:37:29Z", "type": "commit"}, {"oid": "7019cc895829b216a8494caaddd451a4dde98c62", "url": "https://github.com/dhis2/dhis2-core/commit/7019cc895829b216a8494caaddd451a4dde98c62", "message": "update notification implementation test", "committedDate": "2020-08-05T16:34:45Z", "type": "commit"}, {"oid": "8c64293b493c648bcda9d0f2c84d8380e016de00", "url": "https://github.com/dhis2/dhis2-core/commit/8c64293b493c648bcda9d0f2c84d8380e016de00", "message": "fix sonar code smells", "committedDate": "2020-08-05T22:10:42Z", "type": "commit"}, {"oid": "2777d21e2bc77c7300e78bf7055ff936df267f89", "url": "https://github.com/dhis2/dhis2-core/commit/2777d21e2bc77c7300e78bf7055ff936df267f89", "message": "fix conflict with master branch", "committedDate": "2020-08-06T07:55:58Z", "type": "commit"}, {"oid": "5521056db4d3f4a3e6a07bf4ed9238ce8bce311a", "url": "https://github.com/dhis2/dhis2-core/commit/5521056db4d3f4a3e6a07bf4ed9238ce8bce311a", "message": "fix: Resolve code conflicts", "committedDate": "2020-08-14T07:53:16Z", "type": "commit"}, {"oid": "3668e5ab9ec114f0eac07178ecc1e8cca372aa8e", "url": "https://github.com/dhis2/dhis2-core/commit/3668e5ab9ec114f0eac07178ecc1e8cca372aa8e", "message": "changes for new rule engine set up in tracker importer", "committedDate": "2020-08-15T13:45:01Z", "type": "commit"}, {"oid": "e418cd2c94f424b34cdfeaa566833d6a4b9d3c3f", "url": "https://github.com/dhis2/dhis2-core/commit/e418cd2c94f424b34cdfeaa566833d6a4b9d3c3f", "message": "fix conflict after merging master", "committedDate": "2020-09-25T07:56:52Z", "type": "commit"}, {"oid": "d776b622d4866fc9374c5ec88f9048a5fdf4e642", "url": "https://github.com/dhis2/dhis2-core/commit/d776b622d4866fc9374c5ec88f9048a5fdf4e642", "message": "Revert \"fix conflict after merging master\"\n\nThis reverts commit e418cd2c94f424b34cdfeaa566833d6a4b9d3c3f.", "committedDate": "2020-09-25T08:03:04Z", "type": "commit"}, {"oid": "8fdd7c7aafe7cf653f6bc6961bff46579e1de178", "url": "https://github.com/dhis2/dhis2-core/commit/8fdd7c7aafe7cf653f6bc6961bff46579e1de178", "message": "fix conflicts after merging master", "committedDate": "2020-09-25T09:15:20Z", "type": "commit"}, {"oid": "b33eb8a67d0c32dfc89a6f5979d3b47cb9608b4f", "url": "https://github.com/dhis2/dhis2-core/commit/b33eb8a67d0c32dfc89a6f5979d3b47cb9608b4f", "message": "fix unit tests", "committedDate": "2020-09-25T10:29:10Z", "type": "commit"}, {"oid": "788742a71362d78cb90ff917b046c5e011e8b1e8", "url": "https://github.com/dhis2/dhis2-core/commit/788742a71362d78cb90ff917b046c5e011e8b1e8", "message": "fix integration test", "committedDate": "2020-09-27T19:16:59Z", "type": "commit"}, {"oid": "605151fa3d1a172af5ad147d959bfe2e09a9ca64", "url": "https://github.com/dhis2/dhis2-core/commit/605151fa3d1a172af5ad147d959bfe2e09a9ca64", "message": "set waiting time to 2 seconds", "committedDate": "2020-09-28T04:54:21Z", "type": "commit"}]}