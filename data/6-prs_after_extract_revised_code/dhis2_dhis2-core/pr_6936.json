{"pr_number": 6936, "pr_title": "fix: made the Audit queue buffer bounded", "pr_createdAt": "2020-12-17T15:29:16Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6936", "timeline": [{"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "url": "https://github.com/dhis2/dhis2-core/commit/ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "message": "fix: made the Audit queue buffer bounded\n\nThe Audit system may use a queue (disabled by default) to buffer Audit messages before these are de-queued to\nthe Artemis broker.\nThis PR makes the queue bound to 200 items and lowers the de-queue delay to 5 seconds, to avoid excessive memory pressure\nduring large imports.", "committedDate": "2020-12-17T15:26:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDEzNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650136", "bodyText": "merge? else if", "author": "netroms", "createdAt": "2020-12-21T11:18:06Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -63,15 +75,23 @@ public void addAuditItem( final Audit auditItem )\n         {\n             log.debug( String.format( \"add Audit object with content %s to delayed queue\", auditItem.toLog() ) );\n         }\n-        final QueuedAudit postponed = new QueuedAudit( auditItem, delay );\n \n-        if ( !delayed.contains( postponed ) )\n+        final QueuedAudit postponed = new QueuedAudit( auditItem, DELAY );\n+\n+        if ( delayed.size() >= MAX_SIZE )\n+        {\n+            auditProducerSupplier.publish( auditItem );\n+        }\n+        else", "originalCommit": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDM0MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650340", "bodyText": "Make variables configurable?", "author": "netroms", "createdAt": "2020-12-21T11:18:36Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -40,13 +39,26 @@\n import lombok.extern.slf4j.Slf4j;\n \n /**\n+ * Buffers Audit messages prior to sending them to the Audit queue. This\n+ * scheduler is disabled by default (config key: audit.inmemory-queue.enabled)\n+ * and should be used only in very high-traffic environments. Note that upon a\n+ * JVM crash, the Audit messages in this queue will be lost.\n+ * \n+ * The buffer is based on a {@link DelayQueue} where messages are buffered for 5\n+ * seconds, before being de-queued to the Artemis broker.\n+ * \n+ * To avoid excessive memory pressure, max 200 messages can stay in the queue:\n+ * in-excess messages are processed immediately.\n+ *\n  * @author Luciano Fiandesio\n  */\n @Slf4j\n @Component\n public class AuditScheduler\n {\n-    private final long delay = 20_000; // 20 seconds\n+    private final static long DELAY = 5_000; // 5 seconds", "originalCommit": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}