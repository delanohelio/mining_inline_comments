{"pr_number": 6736, "pr_title": "fix: add validation for tei type on relationship constraint", "pr_createdAt": "2020-11-20T14:15:19Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6736", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNDM3OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6736#discussion_r527724379", "bodyText": "is this .map(Optional::of) needed?", "author": "enricocolasante", "createdAt": "2020-11-20T14:22:50Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java", "diffHunk": "@@ -189,6 +209,26 @@ else if ( constraint.getRelationshipEntity().equals( PROGRAM_STAGE_INSTANCE ) )\n         return result;\n     }\n \n+    private Optional<String> getRelationshipTypeUidFromTrackedEntity( TrackerImportValidationContext ctx, String uid )\n+    {\n+        return getTrackedEntityTypeFromTrackedEntity( ctx, uid ).map( Optional::of )", "originalCommit": "39f5f7224a982076973f4dee1458d72416df9bc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM4MDM5Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6736#discussion_r529380393", "bodyText": "Yes, without it the code would not compile. See image", "author": "luciano-fiandesio", "createdAt": "2020-11-24T09:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNDM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a38b89cac4add18acebbb61ee5eaab59d8bbcdf6", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java\nindex d20c7824e2..658553cd48 100644\n--- a/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java\n+++ b/dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java\n\n@@ -201,14 +215,28 @@ public class RelationshipsValidationHook\n             if ( item.getEvent() == null )\n             {\n                 result.add(\n-                    newReport( TrackerErrorCode.E4010 ).addArg( relSide ).addArg( TrackerType.EVENT.getName() )\n-                        .addArg( relationshipItemValueType( item ).getName() ) );\n+                        newReport( TrackerErrorCode.E4010 ).addArg( relSide ).addArg( TrackerType.EVENT.getName() )\n+                                .addArg( relationshipItemValueType( item ).getName() ) );\n             }\n         }\n \n         return result;\n     }\n \n+    private String onlyValues( RelationshipItem item )\n+    {\n+        return item != null ? item.getTrackedEntity() + \"-\" + item.getEnrollment() + \"-\" + item.getEvent() : \"null-null-null\";\n+    }\n+\n+    private void validateReferences( ValidationErrorReporter reporter, RelationshipItem item, String relationship )\n+    {\n+        TrackerType trackerType = relationshipItemValueType( item );\n+        Optional<String> itemUid = getUidFromRelationshipItem( item );\n+\n+        itemUid.ifPresent( s -> addErrorIf( () -> reporter.isInvalid( trackerType, s ), reporter, E4011, relationship,\n+                trackerType.getName(), s ) );\n+    }\n+    \n     private Optional<String> getRelationshipTypeUidFromTrackedEntity( TrackerImportValidationContext ctx, String uid )\n     {\n         return getTrackedEntityTypeFromTrackedEntity( ctx, uid ).map( Optional::of )\n"}}, {"oid": "a38b89cac4add18acebbb61ee5eaab59d8bbcdf6", "url": "https://github.com/dhis2/dhis2-core/commit/a38b89cac4add18acebbb61ee5eaab59d8bbcdf6", "message": "fix: add validation for tei type on relationship constraint", "committedDate": "2020-11-24T09:38:50Z", "type": "commit"}, {"oid": "3ae6144e99ce49c93df4ac094319b949b42e12b8", "url": "https://github.com/dhis2/dhis2-core/commit/3ae6144e99ce49c93df4ac094319b949b42e12b8", "message": "chore: fix test after conflict resolution", "committedDate": "2020-11-24T09:50:50Z", "type": "commit"}, {"oid": "3ae6144e99ce49c93df4ac094319b949b42e12b8", "url": "https://github.com/dhis2/dhis2-core/commit/3ae6144e99ce49c93df4ac094319b949b42e12b8", "message": "chore: fix test after conflict resolution", "committedDate": "2020-11-24T09:50:50Z", "type": "forcePushed"}]}