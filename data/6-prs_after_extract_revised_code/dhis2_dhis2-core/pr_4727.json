{"pr_number": 4727, "pr_title": "feature: (2.34) Add translations support for SystemSettings", "pr_createdAt": "2020-01-17T09:27:05Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4727", "timeline": [{"oid": "5cd81d000335fee0b3ea4679eed74d3ee4acb83a", "url": "https://github.com/dhis2/dhis2-core/commit/5cd81d000335fee0b3ea4679eed74d3ee4acb83a", "message": "feature: (2.34) Add translations support for SystemSettings\n\nDHIS2-5527", "committedDate": "2020-01-17T09:17:27Z", "type": "commit"}, {"oid": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "url": "https://github.com/dhis2/dhis2-core/commit/7d8c5a06bb19341d3854f008e0d96e98060c764e", "message": "chore: (2.34) Improve naming of constants and formatting\n\nDHIS2-5527", "committedDate": "2020-01-17T09:25:24Z", "type": "commit"}, {"oid": "4e42fd0b5461b0b7c8afaf5eb1a52fcd764bfa79", "url": "https://github.com/dhis2/dhis2-core/commit/4e42fd0b5461b0b7c8afaf5eb1a52fcd764bfa79", "message": "chore: (2.34) Remove debug message\n\nDHIS2-5527", "committedDate": "2020-01-17T09:44:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NjgwNg==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367846806", "bodyText": "(minor) I'm not a big fan of returning an empty string to signal that the method completed succesfully. I'd rather make the method void and  throw a custom Runtime exception that you catch in the caller, and do the exception handler there. This also in light of the fact that the method saveSystemSetting on the same class is void.", "author": "luciano-fiandesio", "createdAt": "2020-01-17T09:43:18Z", "path": "dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java", "diffHunk": "@@ -155,6 +155,32 @@ public void saveSystemSetting( SettingKey key, Serializable value )\n         }\r\n     }\r\n \r\n+    @Override\r\n+    @Transactional\r\n+    public String saveSystemSettingTranslation( SettingKey key, String locale, String translation )\r\n+    {\r\n+        SystemSetting setting = systemSettingStore.getByName( key.getName() );\r\n+\r\n+        if ( setting == null )\r\n+        {\r\n+            return \"No entry found for key: \" + key;\r\n+        }\r\n+\r\n+        if ( translation.isEmpty() )\r\n+        {\r\n+            setting.getTranslations().remove( locale );\r\n+        }\r\n+        else\r\n+        {\r\n+            setting.getTranslations().put( locale, translation );\r\n+        }\r\n+\r\n+        settingCache.invalidate( key.getName() );\r\n+        systemSettingStore.update( setting );\r\n+\r\n+        return \"\";\r", "originalCommit": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNDg0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367904842", "bodyText": "Agree. I am not a fan myself. Somehow went under my radar, or was distracted by other details. Fixed.", "author": "huzvak", "createdAt": "2020-01-17T12:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NjgwNg=="}], "type": "inlineReview", "revised_code": {"commit": "7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java b/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\nindex 230243359c..f5e2834560 100644\n--- a/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\n+++ b/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\n\n@@ -157,28 +157,28 @@ public class DefaultSystemSettingManager\n \n     @Override\n     @Transactional\n-    public String saveSystemSettingTranslation( SettingKey key, String locale, String translation )\n+    public void saveSystemSettingTranslation( SettingKey key, String locale, String translation )\n     {\n         SystemSetting setting = systemSettingStore.getByName( key.getName() );\n \n-        if ( setting == null )\n-        {\n-            return \"No entry found for key: \" + key;\n-        }\n-\n-        if ( translation.isEmpty() )\n+        if ( setting == null && !translation.isEmpty() )\n         {\n-            setting.getTranslations().remove( locale );\n+            throw new IllegalStateException( \"No entry found for key: \" + key );\n         }\n-        else\n+        else if ( setting != null )\n         {\n-            setting.getTranslations().put( locale, translation );\n-        }\n-\n-        settingCache.invalidate( key.getName() );\n-        systemSettingStore.update( setting );\n+            if ( translation.isEmpty() )\n+            {\n+                setting.getTranslations().remove( locale );\n+            }\n+            else\n+            {\n+                setting.getTranslations().put( locale, translation );\n+            }\n \n-        return \"\";\n+            settingCache.invalidate( key.getName() );\n+            systemSettingStore.update( setting );\n+        }\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0ODQ1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367848459", "bodyText": "I would use Optional<String>: this is exactly the case for which Optional was introduced", "author": "luciano-fiandesio", "createdAt": "2020-01-17T09:46:52Z", "path": "dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java", "diffHunk": "@@ -229,6 +255,18 @@ public Serializable getSystemSetting( SettingKey key, Serializable defaultValue\n         }\r\n     }\r\n \r\n+    @Override\r\n+    public String getSystemSettingTranslation( SettingKey key, String locale )\r\n+    {\r\n+        SystemSetting setting = transactionTemplate.execute( status -> systemSettingStore.getByName( key.getName() ) );\r\n+        if ( setting != null )\r\n+        {\r\n+            return setting.getTranslation( locale );\r\n+        }\r\n+\r\n+        return \"\";\r", "originalCommit": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNDkwOA==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367904908", "bodyText": "Agree. Fixed.", "author": "huzvak", "createdAt": "2020-01-17T12:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0ODQ1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java b/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\nindex 230243359c..f5e2834560 100644\n--- a/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\n+++ b/dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/DefaultSystemSettingManager.java\n\n@@ -256,7 +256,7 @@ public class DefaultSystemSettingManager\n     }\n \n     @Override\n-    public String getSystemSettingTranslation( SettingKey key, String locale )\n+    public Optional<String> getSystemSettingTranslation( SettingKey key, String locale )\n     {\n         SystemSetting setting = transactionTemplate.execute( status -> systemSettingStore.getByName( key.getName() ) );\n         if ( setting != null )\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0OTE0Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367849146", "bodyText": "This is just a tip: since we introduced Lombok, this would be a great use case for using it :) You can remove all getter and setters and hashCode and toString", "author": "luciano-fiandesio", "createdAt": "2020-01-17T09:48:17Z", "path": "dhis-2/dhis-services/dhis-service-setting/src/main/java/org/hisp/dhis/setting/SystemSetting.java", "diffHunk": "@@ -40,9 +42,8 @@\n import com.fasterxml.jackson.databind.ObjectMapper;\r\n import com.fasterxml.jackson.databind.exc.MismatchedInputException;\r\n \r\n+\r\n /**\r\n- * TODO make IdentifiableObject\r\n- * \r\n  * @author Stian Strandli\r\n  */\r\n public class SystemSetting\r", "originalCommit": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNTI1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367905251", "bodyText": "Will leave it as it is. There are some specific get's, also from the documentation I understand that all attributes will be used in toString, equals, hashCode. So most probably also the ObjectMapper will be used. Etc. So leaving it as it is.", "author": "huzvak", "createdAt": "2020-01-17T12:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0OTE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwODQ1Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367908453", "bodyText": "ok", "author": "luciano-fiandesio", "createdAt": "2020-01-17T12:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0OTE0Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1Mzg2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367853864", "bodyText": "I think you can avoid nesting ifs:\nresponse.setHeader( ContextUtils.HEADER_CACHE_CONTROL, CacheControl.noCache().cachePrivate().getHeaderValue() );\n        \n        Optional<SettingKey> settingKey = SettingKey.getByName( key );\n        String localeToFetch = getLocaleToFetch( locale, key );\n        if ( !systemSettingManager.isConfidential( key ) && settingKey.isPresent()\n            && StringUtils.isNotEmpty( localeToFetch ) )\n        {\n            {\n                String translation = systemSettingManager.getSystemSettingTranslation( settingKey.get(),\n                    localeToFetch );\n\n                if ( !translation.isEmpty() )\n                {\n                    return translation;\n                }\n            }\n\n            Serializable setting = systemSettingManager.getSystemSetting( settingKey.get() );\n            return setting != null ? String.valueOf( setting ) : StringUtils.EMPTY;\n        }\n\n        return StringUtils.EMPTY;", "author": "luciano-fiandesio", "createdAt": "2020-01-17T09:58:15Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java", "diffHunk": "@@ -134,45 +179,66 @@ public void setSystemSettingV29( @RequestBody Map<String, Object> settings, Http\n     }\n \n     @RequestMapping( value = \"/{key}\", method = RequestMethod.GET, produces = ContextUtils.CONTENT_TYPE_TEXT )\n-    public @ResponseBody String getSystemSettingAsText( @PathVariable( \"key\" ) String key, HttpServletResponse response )\n+    public @ResponseBody String getSystemSettingOrTranslation( @PathVariable( \"key\" ) String key,\n+        @RequestParam( value = \"locale\", required = false ) String locale, HttpServletResponse response )\n     {\n         response.setHeader( ContextUtils.HEADER_CACHE_CONTROL, CacheControl.noCache().cachePrivate().getHeaderValue() );\n \n-        if ( systemSettingManager.isConfidential( key ) )\n-        {\n-            return StringUtils.EMPTY;\n-        }\n-        else\n+        if ( !systemSettingManager.isConfidential( key ) )\n         {\n             Optional<SettingKey> settingKey = SettingKey.getByName( key );\n \n-            Serializable setting;\n-\n             if ( settingKey.isPresent() )\n             {\n-                setting = systemSettingManager.getSystemSetting( settingKey.get() );", "originalCommit": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNTg0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367905842", "bodyText": "Here it is a trade-off between nested IF statements and fetching data that are not necessary. Where fetching the data can be heavy. But I changed the code and eliminated nested if statements. If we will see that it is too heavy, we can introduce them back.", "author": "huzvak", "createdAt": "2020-01-17T12:09:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1Mzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwODgwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367908802", "bodyText": "I see your point and agree", "author": "luciano-fiandesio", "createdAt": "2020-01-17T12:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1Mzg2NA=="}], "type": "inlineReview", "revised_code": {"commit": "7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "chunk": "diff --git a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\nindex be62525bf0..cb71bdf6a2 100644\n--- a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\n+++ b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\n\n@@ -184,27 +187,21 @@ public class SystemSettingController\n     {\n         response.setHeader( ContextUtils.HEADER_CACHE_CONTROL, CacheControl.noCache().cachePrivate().getHeaderValue() );\n \n-        if ( !systemSettingManager.isConfidential( key ) )\n+        Optional<SettingKey> settingKey = SettingKey.getByName( key );\n+        String localeToFetch = getLocaleToFetch( locale, key );\n+\n+        if ( !systemSettingManager.isConfidential( key ) && settingKey.isPresent()\n+            && StringUtils.isNotEmpty( localeToFetch ) )\n         {\n-            Optional<SettingKey> settingKey = SettingKey.getByName( key );\n+            Optional<String> translation = systemSettingManager.getSystemSettingTranslation( settingKey.get(), localeToFetch );\n \n-            if ( settingKey.isPresent() )\n+            if ( translation.isPresent() )\n             {\n-                String localeToFetch = getLocaleToFetch( locale, key );\n-\n-                if ( StringUtils.isNotEmpty( localeToFetch ) )\n-                {\n-                    String translation = systemSettingManager.getSystemSettingTranslation( settingKey.get(), localeToFetch );\n-\n-                    if ( !translation.isEmpty() )\n-                    {\n-                        return translation;\n-                    }\n-                }\n-\n-                Serializable setting = systemSettingManager.getSystemSetting( settingKey.get() );\n-                return setting != null ? String.valueOf( setting ) : StringUtils.EMPTY;\n+                return translation.get();\n             }\n+\n+            Serializable setting = systemSettingManager.getSystemSetting( settingKey.get() );\n+            return setting != null ? String.valueOf( setting ) : StringUtils.EMPTY;\n         }\n \n         return StringUtils.EMPTY;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NDk0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367854942", "bodyText": "if you want, you can shorten it even more:\nsettingKeys = keys.stream().map( SettingKey::getByName ).filter( Optional::isPresent ).map( Optional::get )\n                .collect( Collectors.toSet() );", "author": "luciano-fiandesio", "createdAt": "2020-01-17T10:00:40Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java", "diffHunk": "@@ -184,39 +250,42 @@ public void getSystemSettingsJsonP( @RequestParam( value = \"key\", required = fal\n         @RequestParam( defaultValue = \"callback\" ) String callback, HttpServletResponse response )\n         throws IOException\n     {\n-        Set<SettingKey> settingKeys = null;\n-\n-        if ( keys != null )\n-        {\n-            keys.removeIf( systemSettingManager::isConfidential );\n-            settingKeys = keys.stream().map( key -> SettingKey.getByName( key ) ).filter( settingKeyOpt -> settingKeyOpt.isPresent() )\n-                .map( settingKeyOpt -> settingKeyOpt.get() ).collect( Collectors.toSet() );\n-        }\n+        Set<SettingKey> settingKeys = getSettingKeysToFetch( keys );\n \n         response.setContentType( MediaType.APPLICATION_JSON_VALUE );\n         response.setHeader( ContextUtils.HEADER_CACHE_CONTROL, CacheControl.noCache().cachePrivate().getHeaderValue() );\n         renderService.toJsonP( response.getOutputStream(), getSystemSettings( settingKeys ), callback );\n     }\n \n-    private Map<String, Serializable> getSystemSettings( Set<SettingKey> keys )\n+    private Set<SettingKey> getSettingKeysToFetch( Set<String> keys )\n     {\n-        Map<String, Serializable> value;\n-        if ( keys != null && !keys.isEmpty() )\n+        Set<SettingKey> settingKeys;\n+\n+        if ( keys != null )\n         {\n-            value = systemSettingManager.getSystemSettings( keys );\n+            keys.removeIf( systemSettingManager::isConfidential );\n+            settingKeys = keys.stream().map( key -> SettingKey.getByName( key ) ).filter( settingKeyOpt -> settingKeyOpt.isPresent() )\n+                .map( settingKeyOpt -> settingKeyOpt.get() ).collect( Collectors.toSet() );", "originalCommit": "7d8c5a06bb19341d3854f008e0d96e98060c764e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwNjAxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/4727#discussion_r367906017", "bodyText": "I somehow missed complaint from Intellij and only copy-pasted the code. Fixed now.", "author": "huzvak", "createdAt": "2020-01-17T12:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NDk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "chunk": "diff --git a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\nindex be62525bf0..cb71bdf6a2 100644\n--- a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\n+++ b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/SystemSettingController.java\n\n@@ -264,8 +261,11 @@ public class SystemSettingController\n         if ( keys != null )\n         {\n             keys.removeIf( systemSettingManager::isConfidential );\n-            settingKeys = keys.stream().map( key -> SettingKey.getByName( key ) ).filter( settingKeyOpt -> settingKeyOpt.isPresent() )\n-                .map( settingKeyOpt -> settingKeyOpt.get() ).collect( Collectors.toSet() );\n+            settingKeys = keys.stream()\n+                .map( SettingKey::getByName )\n+                .filter( Optional::isPresent )\n+                .map( Optional::get )\n+                .collect( Collectors.toSet() );\n         }\n         else\n         {\n"}}, {"oid": "7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "url": "https://github.com/dhis2/dhis2-core/commit/7dcfcf2a8e8b3e68e30fd90b7339972286e274fc", "message": "chore: (2.34) Improve structure of the code\n\n- Use Optional where applicable\n- Minimize nested if statements where possible\n\nDHIS2-5527", "committedDate": "2020-01-17T12:05:28Z", "type": "commit"}]}