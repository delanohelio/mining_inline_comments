{"pr_number": 5736, "pr_title": "fix: [DHIS2-8946] prefetch usergroups when querying users with usergroup filters (2.35)", "pr_createdAt": "2020-06-13T10:03:48Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5736", "timeline": [{"oid": "cb742400ff30b1b73e9e215cecd1b13962aba6b3", "url": "https://github.com/dhis2/dhis2-core/commit/cb742400ff30b1b73e9e215cecd1b13962aba6b3", "message": "fix: [DHIS2-8946] prefetch usergroups when querying users with usergroup filters (2.35)", "committedDate": "2020-06-13T10:02:48Z", "type": "commit"}, {"oid": "07a7e3436a592cb0bb6da4eb80f826df06c403bf", "url": "https://github.com/dhis2/dhis2-core/commit/07a7e3436a592cb0bb6da4eb80f826df06c403bf", "message": "Minor", "committedDate": "2020-06-13T18:18:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc5NjkwOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5736#discussion_r439796909", "bodyText": "Perhaps simplify with this?\nparams.setPrefetchUserGroups( filters.stream()\n    .anyMatch( f -> f.startsWith( \"userGroups.\" ) ) );", "author": "larshelge", "createdAt": "2020-06-14T06:30:43Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java", "diffHunk": "@@ -153,6 +153,18 @@\n             params.setCanManage( true );\n             params.setAuthSubset( true );\n         }\n+        \n+        if ( !filters.isEmpty() )", "originalCommit": "07a7e3436a592cb0bb6da4eb80f826df06c403bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc5NzA4Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5736#discussion_r439797083", "bodyText": "Or even make a utility method somewhere in the web api called hasFilter( List<String> filters )?\nMaybe put in DefaultContextService or in some util class. I think we are doing this type of checking multiple places and it would be nice to encapsulate, centralize, test and document it.", "author": "larshelge", "createdAt": "2020-06-14T06:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc5NjkwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a8af8fbf9d4a8e981af39674e21ddeda9baca57a", "chunk": "diff --git a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java\nindex 0b1340571e..6516dda363 100644\n--- a/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java\n+++ b/dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java\n\n@@ -154,17 +154,7 @@ public class UserController\n             params.setAuthSubset( true );\n         }\n         \n-        if ( !filters.isEmpty() )\n-        {\n-            for ( String filter : filters )\n-            {\n-                if ( filter.startsWith( \"userGroups.\" ) )\n-                {\n-                    params.setPrefetchUserGroups( true );\n-                    break;\n-                }\n-            }\n-        }\n+        params.setPrefetchUserGroups( filters.stream().anyMatch( f -> f.startsWith( \"userGroups.\" ) ) );\n \n         int count = userService.getUserCount( params );\n \n"}}, {"oid": "a8af8fbf9d4a8e981af39674e21ddeda9baca57a", "url": "https://github.com/dhis2/dhis2-core/commit/a8af8fbf9d4a8e981af39674e21ddeda9baca57a", "message": "review comment change to modify for loop to stream processing", "committedDate": "2020-06-16T08:57:45Z", "type": "commit"}, {"oid": "82c42a0bb51119e402151b5af9aaeda9def71d04", "url": "https://github.com/dhis2/dhis2-core/commit/82c42a0bb51119e402151b5af9aaeda9def71d04", "message": "Merge branch 'master' into DHIS2-8946-master", "committedDate": "2020-06-16T09:05:16Z", "type": "commit"}, {"oid": "50ceedb3a70632375a79a7d1f2706c7dfdeedf10", "url": "https://github.com/dhis2/dhis2-core/commit/50ceedb3a70632375a79a7d1f2706c7dfdeedf10", "message": "Merge branch 'master' into DHIS2-8946-master", "committedDate": "2020-06-16T10:53:43Z", "type": "commit"}]}