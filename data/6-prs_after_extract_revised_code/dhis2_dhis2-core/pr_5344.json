{"pr_number": 5344, "pr_title": "fix: Expire user's active sessions when password is changed", "pr_createdAt": "2020-04-09T12:09:05Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5344", "timeline": [{"oid": "125d11343e2260672aa5b7992e1efe211fe6f95e", "url": "https://github.com/dhis2/dhis2-core/commit/125d11343e2260672aa5b7992e1efe211fe6f95e", "message": "fix: Expire user's active sessions when password is changed\n\nWhen an admin changes a user's password the user's active sessions should\nbe expired and the user forced to login again with the new password.\n\nIssue: [DHIS2-8570]\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>", "committedDate": "2020-04-09T12:06:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE1OTEyMA==", "url": "https://github.com/dhis2/dhis2-core/pull/5344#discussion_r406159120", "bodyText": "If anyone have any suggestions or comments that would be nice, I would very much like this to not be allowed i.e. currentUser == NULL > cast exception", "author": "netroms", "createdAt": "2020-04-09T12:10:47Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java", "diffHunk": "@@ -445,66 +450,39 @@ public void disableUser( @PathVariable(\"uid\") String uid )\n     @RequestMapping( value = \"/{uid}\", method = RequestMethod.PUT, consumes = { \"application/xml\", \"text/xml\" } )\n     public void putXmlObject( @PathVariable( \"uid\" ) String pvUid, HttpServletRequest request, HttpServletResponse response ) throws Exception\n     {\n-        List<User> users = getEntity( pvUid, NO_WEB_OPTIONS );\n-\n-        if ( users.isEmpty() )\n-        {\n-            throw new WebMessageException( WebMessageUtils.conflict( getEntityName() + \" does not exist: \" + pvUid ) );\n-        }\n-\n-        User currentUser = currentUserService.getCurrentUser();\n-\n-        if ( !aclService.canUpdate( currentUser, users.get( 0 ) ) )\n-        {\n-            throw new UpdateAccessDeniedException( \"You don't have the proper permissions to update this user.\" );\n-        }\n-\n-        // force initialization of all authorities of current user in order to prevent cases where user must be reloaded later\n-        // (in case it gets detached)\n-        if ( currentUser != null )\n-        {\n-            currentUser.getUserCredentials().getAllAuthorities();\n-        }\n-\n         User parsed = renderService.fromXml( request.getInputStream(), getEntityClass() );\n-        parsed.setUid( pvUid );\n-\n-        parsed = mergeLastLoginAttribute( users.get( 0 ), parsed );\n \n-        if ( !userService.canAddOrUpdateUser( IdentifiableObjectUtils.getUids( parsed.getGroups() ), currentUser )\n-            || !currentUser.getUserCredentials().canModifyUser( users.get( 0 ).getUserCredentials() ) )\n-        {\n-            throw new WebMessageException( WebMessageUtils.conflict( \"You must have permissions to create user, or ability to manage at least one user group for the user.\" ) );\n-        }\n-\n-\n-        MetadataImportParams params = importService.getParamsFromMap( contextService.getParameterValuesMap() );\n-        params.setImportReportMode( ImportReportMode.FULL );\n-        params.setImportStrategy( ImportStrategy.UPDATE );\n-        params.addObject( parsed );\n-\n-        ImportReport importReport = importService.importMetadata( params );\n-\n-        updateUserGroups( importReport, pvUid, parsed, currentUser );\n+        ImportReport importReport = updateUser( pvUid, parsed );\n \n         response.setContentType( \"application/xml\" );\n-\n         renderService.toXml( response.getOutputStream(), importReport );\n     }\n \n     @Override\n     @RequestMapping( value = \"/{uid}\", method = RequestMethod.PUT, consumes = \"application/json\" )\n     public void putJsonObject( @PathVariable( \"uid\" ) String pvUid, HttpServletRequest request, HttpServletResponse response ) throws Exception\n     {\n-        List<User> users = getEntity( pvUid, NO_WEB_OPTIONS );\n+        User parsed = renderService.fromJson( request.getInputStream(), getEntityClass() );\n+\n+        ImportReport importReport = updateUser( pvUid, parsed );\n+\n+        response.setContentType( \"application/json\" );\n+        renderService.toJson( response.getOutputStream(), importReport );\n+    }\n+\n+    protected ImportReport updateUser( String userUid, User parsedUserObject )\n+        throws WebMessageException\n+    {\n+        List<User> users = getEntity( userUid, NO_WEB_OPTIONS );\n \n         if ( users.isEmpty() )\n         {\n-            throw new WebMessageException( WebMessageUtils.conflict( getEntityName() + \" does not exist: \" + pvUid ) );\n+            throw new WebMessageException(\n+                WebMessageUtils.conflict( getEntityName() + \" does not exist: \" + userUid ) );\n         }\n \n         User currentUser = currentUserService.getCurrentUser();\n-\n+        // TODO: Can we disallow currentUser == NULL ?", "originalCommit": "125d11343e2260672aa5b7992e1efe211fe6f95e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1ODg2MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5344#discussion_r408158861", "bodyText": "As long as the thread has a bound security context (as it always should have, unless using mocking mvc test I guess), it should never be null.. so feel free to throw an exception if it actually is null", "author": "mortenoh", "createdAt": "2020-04-14T13:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE1OTEyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2MDc1Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5344#discussion_r406160752", "bodyText": "Here again related to currentUser == null. But here with a twist currentUser == input.user then reset current user, can someone please explain how this will help?", "author": "netroms", "createdAt": "2020-04-09T12:13:47Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/user/UserController.java", "diffHunk": "@@ -517,45 +495,57 @@ public void putJsonObject( @PathVariable( \"uid\" ) String pvUid, HttpServletReque\n             currentUser.getUserCredentials().getAllAuthorities();\n         }\n \n-        User parsed = renderService.fromJson( request.getInputStream(), getEntityClass() );\n-        parsed.setUid( pvUid );\n+        parsedUserObject.setUid( userUid );\n+        parsedUserObject = mergeLastLoginAttribute( users.get( 0 ), parsedUserObject );\n+\n+        boolean isPasswordChangeAttempt =\n+            parsedUserObject.getUserCredentials() != null &&\n+                parsedUserObject.getUserCredentials().getPassword() != null;\n \n-        parsed = mergeLastLoginAttribute( users.get( 0 ), parsed );\n+        List<String> groupsUids = IdentifiableObjectUtils.getUids( parsedUserObject.getGroups() );\n \n-        if ( !userService.canAddOrUpdateUser( IdentifiableObjectUtils.getUids( parsed.getGroups() ), currentUser )\n+        if ( !userService.canAddOrUpdateUser( groupsUids, currentUser )\n             || !currentUser.getUserCredentials().canModifyUser( users.get( 0 ).getUserCredentials() ) )\n         {\n-            throw new WebMessageException( WebMessageUtils.conflict( \"You must have permissions to create user, or ability to manage at least one user group for the user.\" ) );\n+            throw new WebMessageException( WebMessageUtils.conflict(\n+                \"You must have permissions to create user, \" +\n+                    \"or ability to manage at least one user group for the user.\" ) );\n         }\n \n         MetadataImportParams params = importService.getParamsFromMap( contextService.getParameterValuesMap() );\n         params.setImportReportMode( ImportReportMode.FULL );\n         params.setImportStrategy( ImportStrategy.UPDATE );\n-        params.addObject( parsed );\n+        params.addObject( parsedUserObject );\n \n         ImportReport importReport = importService.importMetadata( params );\n \n-        updateUserGroups( importReport, pvUid, parsed, currentUser );\n-\n-        response.setContentType( \"application/json\" );\n-\n-        renderService.toJson( response.getOutputStream(), importReport );\n-    }\n-\n-    protected void updateUserGroups( ImportReport importReport, String pvUid, User parsed, User currentUser )\n-    {\n         if ( importReport.getStatus() == Status.OK && importReport.getStats().getUpdated() == 1 )\n         {\n-            User user = userService.getUser( pvUid );\n+            updateUserGroups( userUid, parsedUserObject, currentUser );\n \n-            // current user may have been changed and detached and must become managed again\n-            if ( currentUser != null && currentUser.getId() == user.getId() )\n+            // If it was a pw change attempt (input.pw != null) and update was success we assume password has changed...\n+            // We chose to expire the special case if password is set to the same. i.e. no before & after equals pw check\n+            if ( isPasswordChangeAttempt )\n             {\n-                currentUser = currentUserService.getCurrentUser();\n+                userService.expireActiveSessions( parsedUserObject.getUserCredentials() );\n             }\n+        }\n \n-            userGroupService.updateUserGroups( user, IdentifiableObjectUtils.getUids( parsed.getGroups() ), currentUser );\n+        return importReport;\n+    }\n+\n+    protected void updateUserGroups( String pvUid, User parsed, User currentUser )\n+    {\n+        User user = userService.getUser( pvUid );\n+\n+        // current user may have been changed and detached and must become managed again\n+        // TODO: what is this doing? I don't understand how this is possible.\n+        if ( currentUser != null && currentUser.getId() == user.getId() )", "originalCommit": "125d11343e2260672aa5b7992e1efe211fe6f95e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}