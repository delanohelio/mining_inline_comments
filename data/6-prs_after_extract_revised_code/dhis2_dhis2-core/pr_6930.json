{"pr_number": 6930, "pr_title": "perf: replace expensive \"Program has OrgUnit\" call with faster SQL", "pr_createdAt": "2020-12-17T09:52:40Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6930", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDU0Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545104543", "bodyText": "Maybe slightly safer to do !query.getResultList().isEmpty().", "author": "larshelge", "createdAt": "2020-12-17T13:51:13Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java", "diffHunk": "@@ -105,4 +106,14 @@ public HibernateProgramStore( SessionFactory sessionFactory, JdbcTemplate jdbcTe\n \n         return getQuery( hql ).setParameter( \"dataEntryForm\", dataEntryForm ).list();\n     }\n+\n+    public boolean hasOrgUnit( Program program, OrganisationUnit organisationUnit )\n+    {\n+        NativeQuery<Long> query = getSession().createNativeQuery(\n+            \"select programid from program_organisationunits where programid = :pid and organisationunitid = :ouid\" );\n+        query.setParameter( \"pid\", program.getId() );\n+        query.setParameter( \"ouid\", organisationUnit.getId() );\n+\n+        return query.getResultList().size() == 1;", "originalCommit": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4Mzk2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545183965", "bodyText": "Changed.", "author": "luciano-fiandesio", "createdAt": "2020-12-17T15:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDU0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java\nindex 0d1fbdb74c..fa74063747 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java\n\n@@ -114,6 +114,6 @@ public class HibernateProgramStore\n         query.setParameter( \"pid\", program.getId() );\n         query.setParameter( \"ouid\", organisationUnit.getId() );\n \n-        return query.getResultList().size() == 1;\n+        return !query.getResultList().isEmpty();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDkxNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545104915", "bodyText": "Remove commented code.", "author": "larshelge", "createdAt": "2020-12-17T13:51:45Z", "path": "dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java", "diffHunk": "@@ -184,4 +184,18 @@ public void testGetProgramByUid()\n         assertEquals( programA, programService.getProgram( \"UID-A\" ) );\n         assertEquals( programB, programService.getProgram( \"UID-B\" ) );\n     }\n+\n+    @Test\n+    public void testProgramHasOrgUnit()\n+    {\n+        programService.addProgram( programA );\n+\n+        Program p = programService.getProgram( programA.getUid() );\n+        OrganisationUnit ou = organisationUnitService.getOrganisationUnit( organisationUnitA.getUid() );\n+\n+        //sessionFactory.getCurrentSession().flush();", "originalCommit": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4NDA0NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545184045", "bodyText": "Removed", "author": "luciano-fiandesio", "createdAt": "2020-12-17T15:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDkxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java b/dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java\nindex 556d8a3650..e0679dd4b0 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java\n\n@@ -193,9 +193,6 @@ public class ProgramServiceTest\n         Program p = programService.getProgram( programA.getUid() );\n         OrganisationUnit ou = organisationUnitService.getOrganisationUnit( organisationUnitA.getUid() );\n \n-        //sessionFactory.getCurrentSession().flush();\n-\n         assertTrue( programService.hasOrgUnit( p, ou ) );\n-\n     }\n }\n"}}, {"oid": "1c871e9435a6a188de96b640ef335b6a74b3163a", "url": "https://github.com/dhis2/dhis2-core/commit/1c871e9435a6a188de96b640ef335b6a74b3163a", "message": "perf: replace expensive \"Program has OrgUnit\" call with faster SQL\n\nDeprecated the method `Program.hasOrganisationUnit()` and replaced with SQL method on the `ProgramService`.\n\nAll calls to `Program.hasOrganisationUnit()` have been replaced with a call to `ProgramService.hasOrgUnit`, which uses a fast JDBC-based query against the `program_organisationunits` table.\n\nAdditionally, added a check to disable the `LOAD` Hibernate listener, if ON_LOAD auditing is disabled by the user.\n\n(cherry picked from commit 18a1dead646233bbb969767bb1cd8351be4ae289)\n\nAdditional changes in this PR related to the new Tracker:\n\n- Removed OrgUnits from Program during object mapping\n- Removed OrgUnits list from the Error Code `E1041` output\n- Introduce new Preheat class to efficiently preload Program and associated Org Units\n- Introduced validation check for Events so that if an Event's OU doesn't belong to the Event's Program OUs, error with code E1029 is raised", "committedDate": "2020-12-22T19:43:40Z", "type": "commit"}, {"oid": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "url": "https://github.com/dhis2/dhis2-core/commit/b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "message": "chore: address PR review comments", "committedDate": "2020-12-22T19:43:43Z", "type": "commit"}, {"oid": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "url": "https://github.com/dhis2/dhis2-core/commit/b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "message": "chore: address PR review comments", "committedDate": "2020-12-22T19:43:43Z", "type": "forcePushed"}, {"oid": "01dd598391c6ece27988a7980da4149092093f44", "url": "https://github.com/dhis2/dhis2-core/commit/01dd598391c6ece27988a7980da4149092093f44", "message": "chore: fix json test file after rebase", "committedDate": "2020-12-22T20:03:39Z", "type": "commit"}, {"oid": "171defba4ef3c973ebf083c8a8bb16f81bd13c2b", "url": "https://github.com/dhis2/dhis2-core/commit/171defba4ef3c973ebf083c8a8bb16f81bd13c2b", "message": "Merge remote-tracking branch 'origin/master' into PROGRAM_HAS_ORGUNIT_PERF_FIX", "committedDate": "2021-01-05T13:08:05Z", "type": "commit"}]}