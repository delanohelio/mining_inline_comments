{"pr_number": 5347, "pr_title": "fix: Combined SMS fixes", "pr_createdAt": "2020-04-11T02:56:12Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5347", "timeline": [{"oid": "b04bd43b7c7849911d98204743f4ffb81c9140eb", "url": "https://github.com/dhis2/dhis2-core/commit/b04bd43b7c7849911d98204743f4ffb81c9140eb", "message": "fix: Use TrackedEntityAttributeValueService to update values in SMS submissions\n\nFix will make sure that values updated through SMS are also reflected on the web.", "committedDate": "2020-04-11T02:49:15Z", "type": "commit"}, {"oid": "81b9871dfd6f364919e2daa2c5cc5887aeef1b4d", "url": "https://github.com/dhis2/dhis2-core/commit/81b9871dfd6f364919e2daa2c5cc5887aeef1b4d", "message": "refactor: reduce metadata calls for SMS", "committedDate": "2020-04-11T02:50:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzMxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5347#discussion_r408457311", "bodyText": "I hate to harp on this, but we use Uid instead of UID in DHIS 2. Using camel case even for acronyms is a standard Java convention. Would you mind changing it to getUid() ?", "author": "larshelge", "createdAt": "2020-04-14T21:50:26Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/listener/AggregateDataSetSMSListener.java", "diffHunk": "@@ -110,10 +110,10 @@ protected SMSResponse postProcess( IncomingSms sms, SMSSubmission submission )\n         String per = subm.getPeriod();\n         UID aocid = subm.getAttributeOptionCombo();\n \n-        OrganisationUnit orgUnit = organisationUnitService.getOrganisationUnit( ouid.uid );\n-        User user = userService.getUser( subm.getUserID().uid );\n+        OrganisationUnit orgUnit = organisationUnitService.getOrganisationUnit( ouid.getUID() );\n+        User user = userService.getUser( subm.getUserID().getUID() );", "originalCommit": "81b9871dfd6f364919e2daa2c5cc5887aeef1b4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDc4Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5347#discussion_r409260783", "bodyText": "@larshelge - hmmm, the Java API is anything but consistent on this... :)\nBut I can see it's certainly a convention in DHIS2 core code. I've gone and changed all acronyms in the SMS compression library now.\nI've got 3 PRs open at the moment, for 2.33, 2.34 and master. Is it worth updating all with this? Or maybe I can just add the change to master?", "author": "JasperTimm", "createdAt": "2020-04-16T03:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2Mzc1OA==", "url": "https://github.com/dhis2/dhis2-core/pull/5347#discussion_r409263758", "bodyText": "Also I've just noticed a lot of the existing SMS listener code already used SMS in its class names. I suppose we should be consistent and update all these too?", "author": "JasperTimm", "createdAt": "2020-04-16T03:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4ODgyMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5347#discussion_r411988821", "bodyText": "Okay great, thanks @JasperTimm. To avoid a growing task let's leave it at Uids for now.\nIt would be great if you could update the 2.33 and 2.34 PRs as well, for consistency and for easier future backports.", "author": "larshelge", "createdAt": "2020-04-21T08:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc1NTE0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5347#discussion_r412755142", "bodyText": "@larshelge - case of acronym PR here: #5422", "author": "JasperTimm", "createdAt": "2020-04-22T07:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3dd00692abcbec24f33c3a055e5be5028c8f56a4", "chunk": "diff --git a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/listener/AggregateDataSetSMSListener.java b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/listener/AggregateDataSetSMSListener.java\nindex 921ad05bed..108bd22ffb 100644\n--- a/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/listener/AggregateDataSetSMSListener.java\n+++ b/dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/sms/listener/AggregateDataSetSMSListener.java\n\n@@ -100,45 +100,47 @@ public class AggregateDataSetSMSListener\n     }\n \n     @Override\n-    protected SMSResponse postProcess( IncomingSms sms, SMSSubmission submission )\n+    protected SmsResponse postProcess( IncomingSms sms, SmsSubmission submission )\n         throws SMSProcessingException\n     {\n-        AggregateDatasetSMSSubmission subm = (AggregateDatasetSMSSubmission) submission;\n+        AggregateDatasetSmsSubmission subm = (AggregateDatasetSmsSubmission) submission;\n \n-        UID ouid = subm.getOrgUnit();\n-        UID dsid = subm.getDataSet();\n+        Uid ouid = subm.getOrgUnit();\n+        Uid dsid = subm.getDataSet();\n         String per = subm.getPeriod();\n-        UID aocid = subm.getAttributeOptionCombo();\n+        Uid aocid = subm.getAttributeOptionCombo();\n \n-        OrganisationUnit orgUnit = organisationUnitService.getOrganisationUnit( ouid.getUID() );\n-        User user = userService.getUser( subm.getUserID().getUID() );\n+        OrganisationUnit orgUnit = organisationUnitService.getOrganisationUnit( ouid.getUid() );\n+        User user = userService.getUser( subm.getUserId().getUid() );\n \n-        DataSet dataSet = dataSetService.getDataSet( dsid.getUID() );\n+        DataSet dataSet = dataSetService.getDataSet( dsid.getUid() );\n+        \n         if ( dataSet == null )\n         {\n-            throw new SMSProcessingException( SMSResponse.INVALID_DATASET.set( dsid ) );\n+            throw new SMSProcessingException( SmsResponse.INVALID_DATASET.set( dsid ) );\n         }\n \n         Period period = PeriodType.getPeriodFromIsoString( per );\n         if ( period == null )\n         {\n-            throw new SMSProcessingException( SMSResponse.INVALID_PERIOD.set( per ) );\n+            throw new SMSProcessingException( SmsResponse.INVALID_PERIOD.set( per ) );\n         }\n \n-        CategoryOptionCombo aoc = categoryService.getCategoryOptionCombo( aocid.getUID() );\n+        CategoryOptionCombo aoc = categoryService.getCategoryOptionCombo( aocid.getUid() );\n+        \n         if ( aoc == null )\n         {\n-            throw new SMSProcessingException( SMSResponse.INVALID_AOC.set( aocid ) );\n+            throw new SMSProcessingException( SmsResponse.INVALID_AOC.set( aocid ) );\n         }\n \n         if ( !dataSet.hasOrganisationUnit( orgUnit ) )\n         {\n-            throw new SMSProcessingException( SMSResponse.OU_NOTIN_DATASET.set( ouid, dsid ) );\n+            throw new SMSProcessingException( SmsResponse.OU_NOTIN_DATASET.set( ouid, dsid ) );\n         }\n \n         if ( dataSetService.isLocked( null, dataSet, period, orgUnit, aoc, null ) )\n         {\n-            throw new SMSProcessingException( SMSResponse.DATASET_LOCKED.set( dsid, per ) );\n+            throw new SMSProcessingException( SmsResponse.DATASET_LOCKED.set( dsid, per ) );\n         }\n \n         List<Object> errorElems = submitDataValues( subm.getValues(), period, orgUnit, aoc, user );\n"}}, {"oid": "3dd00692abcbec24f33c3a055e5be5028c8f56a4", "url": "https://github.com/dhis2/dhis2-core/commit/3dd00692abcbec24f33c3a055e5be5028c8f56a4", "message": "Merge branch '2.34' into 2.34-sms-fixes", "committedDate": "2020-06-06T05:13:17Z", "type": "commit"}, {"oid": "8ae3b1b67eb21e2fcceabc4f52311d737873d54d", "url": "https://github.com/dhis2/dhis2-core/commit/8ae3b1b67eb21e2fcceabc4f52311d737873d54d", "message": "update pom.xml\n\nchanged sms-compression library version", "committedDate": "2020-06-06T05:14:19Z", "type": "commit"}, {"oid": "97ba7ba3c6cb890cbea97ebf2bdee804ae3273cf", "url": "https://github.com/dhis2/dhis2-core/commit/97ba7ba3c6cb890cbea97ebf2bdee804ae3273cf", "message": "fix compilation errors", "committedDate": "2020-06-06T05:47:00Z", "type": "commit"}, {"oid": "eba3debab9c62b9268a627a85bdb7c47e2634b2c", "url": "https://github.com/dhis2/dhis2-core/commit/eba3debab9c62b9268a627a85bdb7c47e2634b2c", "message": "code refactor", "committedDate": "2020-06-24T08:49:32Z", "type": "commit"}]}