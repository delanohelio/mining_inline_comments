{"pr_number": 4450, "pr_title": "Fix mysql return bug", "pr_createdAt": "2020-08-25T13:03:45Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4450", "timeline": [{"oid": "cde69daad1601091f18078ca07b37b723d8a77e5", "url": "https://github.com/apache/incubator-doris/commit/cde69daad1601091f18078ca07b37b723d8a77e5", "message": "fix mysql return bug", "committedDate": "2020-08-25T12:58:09Z", "type": "commit"}, {"oid": "e1a7d9652940776a8020e39025a0c44d36f521ee", "url": "https://github.com/apache/incubator-doris/commit/e1a7d9652940776a8020e39025a0c44d36f521ee", "message": "fix bug", "committedDate": "2020-08-25T12:58:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ3MTczOA==", "url": "https://github.com/apache/incubator-doris/pull/4450#discussion_r476471738", "bodyText": "So the reason is that the fields has been sent but no data is sent following?", "author": "morningman", "createdAt": "2020-08-25T14:00:47Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java", "diffHunk": "@@ -622,13 +622,15 @@ private void handleQueryStmt() throws Exception {\n         RowBatch batch;\n         MysqlChannel channel = context.getMysqlChannel();\n         boolean isOutfileQuery = queryStmt.hasOutFileClause();\n-        if (!isOutfileQuery) {\n-            sendFields(queryStmt.getColLabels(), queryStmt.getResultExprs());\n-        }\n+        boolean isSendFields = false;", "originalCommit": "e1a7d9652940776a8020e39025a0c44d36f521ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk3ODI0MA==", "url": "https://github.com/apache/incubator-doris/pull/4450#discussion_r476978240", "bodyText": "Yes, fields has been sent, but query may fail because of timeout. In this case, client will get a fields packet, and error packet, but some language mysql driver cannot recognize the error, and returns a success and no rows result.", "author": "gengjun-git", "createdAt": "2020-08-26T02:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ3MTczOA=="}], "type": "inlineReview", "revised_code": {"commit": "9c326d5aefd849632bb12da8ade1ed28367d78ba", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java b/fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java\nindex cbd8c15b6..be7405c2d 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java\n\n@@ -627,6 +624,8 @@ public class StmtExecutor {\n             batch = coord.getNext();\n             // for outfile query, there will be only one empty batch send back with eos flag\n             if (batch.getBatch() != null && !isOutfileQuery) {\n+                // For some language driver, getting error packet after fields packet will be recognized as a success result\n+                // so We need to send fields after first batch arrived\n                 if (!isSendFields) {\n                     sendFields(queryStmt.getColLabels(), queryStmt.getResultExprs());\n                     isSendFields = true;\n"}}, {"oid": "9c326d5aefd849632bb12da8ade1ed28367d78ba", "url": "https://github.com/apache/incubator-doris/commit/9c326d5aefd849632bb12da8ade1ed28367d78ba", "message": "add comment", "committedDate": "2020-08-26T02:27:06Z", "type": "commit"}]}