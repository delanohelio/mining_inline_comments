{"pr_number": 4343, "pr_title": "Forbidden aggregated partition key column on mv", "pr_createdAt": "2020-08-12T10:59:13Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4343", "timeline": [{"oid": "e62e8e1f1a6374b2a66c616cd09f227aa00b2ef4", "url": "https://github.com/apache/incubator-doris/commit/e62e8e1f1a6374b2a66c616cd09f227aa00b2ef4", "message": "Forbidden aggregated partition key column on mv\n\nThe partition column of table also must be the key in materialized view.\nIf not, when user wants to add partition of table, the be will core.\nThe materialized view could not create partition correctly when partition column has been aggregated.\n\nFixed #4342\nChange-Id: Idee42a49c61034368c018d33c522dfced673f3bd", "committedDate": "2020-08-12T10:25:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwNjU2Nw==", "url": "https://github.com/apache/incubator-doris/pull/4343#discussion_r469206567", "bodyText": "can partitionColumnNames be upperCase \uff1f", "author": "wutiangan", "createdAt": "2020-08-12T12:03:00Z", "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -563,10 +563,36 @@ public PartitionInfo getPartitionInfo() {\n         return partitionInfo;\n     }\n \n+    public List<String> getPartitionColumnNames() {\n+        List<String> partitionColumnNames = Lists.newArrayList();\n+        if (partitionInfo instanceof SinglePartitionInfo) {\n+            return partitionColumnNames;", "originalCommit": "e62e8e1f1a6374b2a66c616cd09f227aa00b2ef4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNjUyOA==", "url": "https://github.com/apache/incubator-doris/pull/4343#discussion_r469916528", "bodyText": "It can but we need to check it ignore case", "author": "EmmyMiao87", "createdAt": "2020-08-13T12:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwNjU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5f297d7a78f6387ceb29c88e8c0b7d55b1b1676b", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java b/fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java\nindex 409105033..9da5a6b22 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java\n\n@@ -563,8 +563,8 @@ public class OlapTable extends Table {\n         return partitionInfo;\n     }\n \n-    public List<String> getPartitionColumnNames() {\n-        List<String> partitionColumnNames = Lists.newArrayList();\n+    public Set<String> getPartitionColumnNames() {\n+        Set<String> partitionColumnNames = Sets.newHashSet();\n         if (partitionInfo instanceof SinglePartitionInfo) {\n             return partitionColumnNames;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMDU3MQ==", "url": "https://github.com/apache/incubator-doris/pull/4343#discussion_r469300571", "bodyText": "A Set may be better", "author": "morningman", "createdAt": "2020-08-12T14:26:53Z", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -458,7 +458,14 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                 newMVColumns.add(mvColumnItem.toMVColumn(olapTable));\n             }\n         } else {\n+            List<String> partitionOrDistributedColumnName = olapTable.getPartitionColumnNames();", "originalCommit": "e62e8e1f1a6374b2a66c616cd09f227aa00b2ef4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkyMTU1NA==", "url": "https://github.com/apache/incubator-doris/pull/4343#discussion_r469921554", "bodyText": "Fixed", "author": "EmmyMiao87", "createdAt": "2020-08-13T12:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMDU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5f297d7a78f6387ceb29c88e8c0b7d55b1b1676b", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java b/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\nindex f11101998..a5f039178 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\n\n@@ -458,7 +458,7 @@ public class MaterializedViewHandler extends AlterHandler {\n                 newMVColumns.add(mvColumnItem.toMVColumn(olapTable));\n             }\n         } else {\n-            List<String> partitionOrDistributedColumnName = olapTable.getPartitionColumnNames();\n+            Set<String> partitionOrDistributedColumnName = olapTable.getPartitionColumnNames();\n             partitionOrDistributedColumnName.addAll(olapTable.getDistributionColumnNames());\n             for (MVColumnItem mvColumnItem : mvColumnItemList) {\n                 if (partitionOrDistributedColumnName.contains(mvColumnItem.getBaseColumnName().toLowerCase())\n"}}, {"oid": "5f297d7a78f6387ceb29c88e8c0b7d55b1b1676b", "url": "https://github.com/apache/incubator-doris/commit/5f297d7a78f6387ceb29c88e8c0b7d55b1b1676b", "message": "Fix ut\n\nChange-Id: I3b8e25a92385134d94b589b067eb067250e1934f", "committedDate": "2020-08-13T12:41:34Z", "type": "commit"}]}