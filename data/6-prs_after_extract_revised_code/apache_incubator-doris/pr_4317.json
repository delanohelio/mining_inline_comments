{"pr_number": 4317, "pr_title": "Forbidden no grouping mv on aggregation table", "pr_createdAt": "2020-08-10T12:44:44Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4317", "timeline": [{"oid": "5e33cda4ee69076d60993ced55aa0b4d21654632", "url": "https://github.com/apache/incubator-doris/commit/5e33cda4ee69076d60993ced55aa0b4d21654632", "message": "Forbidden no grouping mv on aggregation table\n\nIf user wants to create a no grouping mv on aggregation table, the doris will thrown exception.\nThe correct approach is that explicit declare the grouping column.\nFor example:\nAgg table: k1, k2, sum(k3)\nCreate materialized view stmt: select k1, k2 from agg_table group by k1, k2.\n\nFixed #4316\n\nChange-Id: I0851ffd5450ad0655741dfb20ead891e9aaf6015", "committedDate": "2020-08-10T12:43:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzMjM2NQ==", "url": "https://github.com/apache/incubator-doris/pull/4317#discussion_r467932365", "bodyText": "Do we allowed to create mv on unique key table?\nif yes, how to create it?", "author": "morningman", "createdAt": "2020-08-10T14:13:00Z", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -432,6 +432,9 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n         List<Column> newMVColumns = Lists.newArrayList();\n         int numOfKeys = 0;\n         if (olapTable.getKeysType().isAggregationFamily()) {\n+            if (addMVClause.getMVKeysType() != KeysType.AGG_KEYS) {", "originalCommit": "5e33cda4ee69076d60993ced55aa0b4d21654632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NDE0Mg==", "url": "https://github.com/apache/incubator-doris/pull/4317#discussion_r468364142", "bodyText": "We allowed to create mv on unique key if and only if materialized view of full key column.", "author": "EmmyMiao87", "createdAt": "2020-08-11T06:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzMjM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA3ODI4MQ==", "url": "https://github.com/apache/incubator-doris/pull/4317#discussion_r530078281", "bodyText": "the unique key table has unique feature , we need mv to aggregate  such as  bitmap_union(to_bitmap(user_id)),but  it's wrong \u3002\nexample:\nCREATE TABLE t\n(\nevent_day DATE,\nuser_id INT ,\nevent_name VARCHAR(100),\naccess_timestamp BIGINT\n)\nUNIQUE KEY(event_day,user_id, event_name,access_timestamp)\nPARTITION BY RANGE(event_day) ()\nDISTRIBUTED BY HASH(user_id)\nPROPERTIES\n(\n\"dynamic_partition.enable\" = \"true\",\n\"dynamic_partition.time_unit\" = \"DAY\",\n\"dynamic_partition.end\" = \"3\",\n\"dynamic_partition.prefix\" = \"p\",\n\"dynamic_partition.buckets\" = \"8\",\n\"storage_type\"=\"column\"\n);\ncreate materialized view mv as\nselect  event_day,bitmap_union(to_bitmap(user_id))  from t group by event_day ;", "author": "liuzhizu", "createdAt": "2020-11-25T03:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzMjM2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b39c3824f03b38b156a32cb2e6ba0f4400e20395", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java b/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\nindex 6cef9ee25..8fe60be73 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java\n\n@@ -432,8 +432,8 @@ public class MaterializedViewHandler extends AlterHandler {\n         List<Column> newMVColumns = Lists.newArrayList();\n         int numOfKeys = 0;\n         if (olapTable.getKeysType().isAggregationFamily()) {\n-            if (addMVClause.getMVKeysType() != KeysType.AGG_KEYS) {\n-                throw new DdlException(\"The materialized view of aggregation table must has grouping columns\");\n+            if (olapTable.getKeysType() != addMVClause.getMVKeysType()) {\n+                throw new DdlException(\"The materialized view of aggregation or unique table must has grouping columns\");\n             }\n             for (MVColumnItem mvColumnItem : mvColumnItemList) {\n                 String mvColumnName = mvColumnItem.getName();\n"}}, {"oid": "b39c3824f03b38b156a32cb2e6ba0f4400e20395", "url": "https://github.com/apache/incubator-doris/commit/b39c3824f03b38b156a32cb2e6ba0f4400e20395", "message": "Fix\n\nChange-Id: I49855589507d9eaac1c792850bc7d4b6610f2a97", "committedDate": "2020-08-11T06:51:51Z", "type": "commit"}, {"oid": "f29d0fe0ab8647752aea6da69a5820a07dd21f22", "url": "https://github.com/apache/incubator-doris/commit/f29d0fe0ab8647752aea6da69a5820a07dd21f22", "message": "Fix\n\nChange-Id: I55fbd06efa6a994844187d43d6802ced3a34b9b5", "committedDate": "2020-08-11T08:23:19Z", "type": "commit"}]}