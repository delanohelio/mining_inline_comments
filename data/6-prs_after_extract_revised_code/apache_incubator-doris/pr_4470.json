{"pr_number": 4470, "pr_title": "[Spark Load] Redirect the spark launcher's log to a separated log file", "pr_createdAt": "2020-08-27T11:41:13Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4470", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyMjkxOA==", "url": "https://github.com/apache/incubator-doris/pull/4470#discussion_r478522918", "bodyText": "why not just output to the outputStream? So that we don't need to buffer a log of content in memory?", "author": "morningman", "createdAt": "2020-08-27T15:52:07Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLauncherMonitor.java", "diffHunk": "@@ -103,7 +114,7 @@ public void run() {\n             try {\n                 outReader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n                 while (!isStop && (line = outReader.readLine()) != null) {\n-                    LOG.info(\"monitor log: \" + line);\n+                    outputBuffer.append(line + '\\n');", "originalCommit": "0442ff88f7e3b168ae2d8f88afd90c29de4c03f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTM5OA==", "url": "https://github.com/apache/incubator-doris/pull/4470#discussion_r478811398", "bodyText": "ok. I changed it", "author": "xy720", "createdAt": "2020-08-28T03:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyMjkxOA=="}], "type": "inlineReview", "revised_code": {"commit": "9f750f2de39491a2ffd1b8ebbc93bdf17c912313", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLauncherMonitor.java b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLauncherMonitor.java\nindex eebf1645d..72c70f801 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLauncherMonitor.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLauncherMonitor.java\n\n@@ -114,7 +112,9 @@ public class SparkLauncherMonitor {\n             try {\n                 outReader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n                 while (!isStop && (line = outReader.readLine()) != null) {\n-                    outputBuffer.append(line + '\\n');\n+                    if (outputStream != null) {\n+                        outputStream.write(line.getBytes());\n+                    }\n                     SparkLoadAppHandle.State oldState = handle.getState();\n                     SparkLoadAppHandle.State newState = oldState;\n                     // parse state and appId\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNDYxMg==", "url": "https://github.com/apache/incubator-doris/pull/4470#discussion_r478524612", "bodyText": "Are you sure the sparkLoadAppHandle is not null here?", "author": "morningman", "createdAt": "2020-08-27T15:54:38Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadJob.java", "diffHunk": "@@ -701,6 +702,20 @@ protected long getEtlStartTimestamp() {\n         return etlStartTimestamp;\n     }\n \n+    public SparkLoadAppHandle getHandle() {\n+        return sparkLoadAppHandle;\n+    }\n+\n+    public void clearSparkLauncherLog() {\n+        String logPath = sparkLoadAppHandle.getLogPath();", "originalCommit": "0442ff88f7e3b168ae2d8f88afd90c29de4c03f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMTUwOQ==", "url": "https://github.com/apache/incubator-doris/pull/4470#discussion_r478811509", "bodyText": "Not sure. So I made a new check here.", "author": "xy720", "createdAt": "2020-08-28T03:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNDYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "cf2de86e8129c3f690ba0dec010455eecbb8f0c5", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadJob.java b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadJob.java\nindex c50cb5847..d18416d5b 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadJob.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadJob.java\n\n@@ -702,20 +713,6 @@ public class SparkLoadJob extends BulkLoadJob {\n         return etlStartTimestamp;\n     }\n \n-    public SparkLoadAppHandle getHandle() {\n-        return sparkLoadAppHandle;\n-    }\n-\n-    public void clearSparkLauncherLog() {\n-        String logPath = sparkLoadAppHandle.getLogPath();\n-        if (!Strings.isNullOrEmpty(logPath)) {\n-            File file = new File(logPath);\n-            if (file.exists()) {\n-                file.delete();\n-            }\n-        }\n-    }\n-\n     @Override\n     public void write(DataOutput out) throws IOException {\n         super.write(out);\n"}}, {"oid": "cf2de86e8129c3f690ba0dec010455eecbb8f0c5", "url": "https://github.com/apache/incubator-doris/commit/cf2de86e8129c3f690ba0dec010455eecbb8f0c5", "message": "print log", "committedDate": "2020-08-28T04:38:56Z", "type": "commit"}, {"oid": "5e7bd51efe0f4515f6df65b8bf05ec5135729c9c", "url": "https://github.com/apache/incubator-doris/commit/5e7bd51efe0f4515f6df65b8bf05ec5135729c9c", "message": "clear log", "committedDate": "2020-08-28T04:38:56Z", "type": "commit"}, {"oid": "6fb5f313a2a632bf2ad0f01215cdf776294f46d6", "url": "https://github.com/apache/incubator-doris/commit/6fb5f313a2a632bf2ad0f01215cdf776294f46d6", "message": "remove unrelevant", "committedDate": "2020-08-28T04:38:56Z", "type": "commit"}, {"oid": "9f750f2de39491a2ffd1b8ebbc93bdf17c912313", "url": "https://github.com/apache/incubator-doris/commit/9f750f2de39491a2ffd1b8ebbc93bdf17c912313", "message": "fix null", "committedDate": "2020-08-28T04:38:56Z", "type": "commit"}, {"oid": "449a0545e80ffe97465c4b85e0137c02c6b71bc1", "url": "https://github.com/apache/incubator-doris/commit/449a0545e80ffe97465c4b85e0137c02c6b71bc1", "message": "\\n", "committedDate": "2020-08-28T04:38:56Z", "type": "commit"}, {"oid": "449a0545e80ffe97465c4b85e0137c02c6b71bc1", "url": "https://github.com/apache/incubator-doris/commit/449a0545e80ffe97465c4b85e0137c02c6b71bc1", "message": "\\n", "committedDate": "2020-08-28T04:38:56Z", "type": "forcePushed"}]}