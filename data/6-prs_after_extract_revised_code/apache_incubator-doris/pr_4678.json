{"pr_number": 4678, "pr_title": "[Bug] Fix hard cardinality check which makes queries fail", "pr_createdAt": "2020-09-27T07:53:14Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4678", "timeline": [{"oid": "6f3984fc755de32412c12a7f06e2e72d68f471bf", "url": "https://github.com/apache/incubator-doris/commit/6f3984fc755de32412c12a7f06e2e72d68f471bf", "message": "fix hard cardinality check which makes the queries fail", "committedDate": "2020-09-27T05:10:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5ODUwMA==", "url": "https://github.com/apache/incubator-doris/pull/4678#discussion_r499198500", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.info(\"stats Select: cardinality={}\", this.cardinality);\n          \n          \n            \n                    LOG.debug(\"stats Select: cardinality={}\", this.cardinality);", "author": "morningman", "createdAt": "2020-10-04T02:21:14Z", "path": "fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java", "diffHunk": "@@ -63,13 +62,14 @@ public void init(Analyzer analyzer) throws UserException {\n     @Override\n     public void computeStats(Analyzer analyzer) {\n         super.computeStats(analyzer);\n-        if (getChild(0).cardinality == -1) {\n-            cardinality = -1;\n+        long cardinality = getChild(0).cardinality;\n+        double selectivity = computeSelectivity();\n+        if (cardinality < 0 || selectivity < 0) {\n+            this.cardinality = -1;\n         } else {\n-            cardinality = Math.round(((double) getChild(0).cardinality) * computeSelectivity());\n-            Preconditions.checkState(cardinality >= 0);\n+            this.cardinality = Math.round(cardinality * selectivity);\n         }\n-        LOG.info(\"stats Select: cardinality=\" + Long.toString(cardinality));\n+        LOG.info(\"stats Select: cardinality={}\", this.cardinality);", "originalCommit": "6f3984fc755de32412c12a7f06e2e72d68f471bf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "821b5a654c7a2f0f6a04a4c593109927c82e1a07", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java b/fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java\nindex 35011a707..83219af9a 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java\n\n@@ -69,7 +69,7 @@ public class SelectNode extends PlanNode {\n         } else {\n             this.cardinality = Math.round(cardinality * selectivity);\n         }\n-        LOG.info(\"stats Select: cardinality={}\", this.cardinality);\n+        LOG.debug(\"stats Select: cardinality={}\", this.cardinality);\n     }\n \n     @Override\n"}}, {"oid": "821b5a654c7a2f0f6a04a4c593109927c82e1a07", "url": "https://github.com/apache/incubator-doris/commit/821b5a654c7a2f0f6a04a4c593109927c82e1a07", "message": "Update fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>", "committedDate": "2020-10-09T03:09:11Z", "type": "commit"}]}