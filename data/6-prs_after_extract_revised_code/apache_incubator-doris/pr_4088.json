{"pr_number": 4088, "pr_title": "[Bug][Alter] Cancel the alter job if database has been dropped", "pr_createdAt": "2020-07-13T13:34:55Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4088", "timeline": [{"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0", "url": "https://github.com/apache/incubator-doris/commit/2aac2b9623544241e060034ce8fdc157f9a411e0", "message": "[Bug][Alter] Cancel the alter job if database has been dropped\n\nCancel the alter job in WAITING_TXN state if database has been dropped", "committedDate": "2020-07-13T13:29:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0MzY1Mg==", "url": "https://github.com/apache/incubator-doris/pull/4088#discussion_r453743652", "bodyText": "SchedExcepition looks so stranger...", "author": "wuyunfeng", "createdAt": "2020-07-13T15:40:12Z", "path": "fe/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -879,9 +880,14 @@ private void deleteReplicaInternal(TabletSchedCtx tabletCtx, Replica replica, St\n             throw new SchedException(Status.SCHEDULE_FAILED, \"set watermark txn \" + nextTxnId);\n         } else if (replica.getState() == ReplicaState.DECOMMISSION && replica.getWatermarkTxnId() != -1) {\n             long watermarkTxnId = replica.getWatermarkTxnId();\n-            if (!Catalog.getCurrentGlobalTransactionMgr().isPreviousTransactionsFinished(watermarkTxnId,\n-                    tabletCtx.getDbId(), Lists.newArrayList(tabletCtx.getTblId()))) {\n-                throw new SchedException(Status.SCHEDULE_FAILED, \"wait txn before \" + watermarkTxnId + \" to be finished\");\n+            try {\n+                if (!Catalog.getCurrentGlobalTransactionMgr().isPreviousTransactionsFinished(watermarkTxnId,\n+                        tabletCtx.getDbId(), Lists.newArrayList(tabletCtx.getTblId()))) {\n+                    throw new SchedException(Status.SCHEDULE_FAILED,", "originalCommit": "2aac2b9623544241e060034ce8fdc157f9a411e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2NDYzNQ==", "url": "https://github.com/apache/incubator-doris/pull/4088#discussion_r455464635", "bodyText": "bear it! LOL", "author": "morningman", "createdAt": "2020-07-16T01:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0MzY1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NzA1Nw==", "url": "https://github.com/apache/incubator-doris/pull/4088#discussion_r453747057", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * check if there exists a load job before the endTransactionId have all\n          \n          \n            \n                 * Check whether a load job already exists before checking all `TransactionId` related with this load job have finished.", "author": "wuyunfeng", "createdAt": "2020-07-13T15:44:32Z", "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -238,17 +238,25 @@ public void finishTransaction(long dbId, long transactionId, Set<Long> errorRepl\n     }\n \n     /**\n-     * check if there exists a load job before the endTransactionId have all finished\n+     * check if there exists a load job before the endTransactionId have all", "originalCommit": "2aac2b9623544241e060034ce8fdc157f9a411e0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9f3bd2c6d032c96f83102026076bb2d9fb33f99c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java b/fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java\nindex 1c67bdfe5..9cb72543f 100644\n--- a/fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java\n+++ b/fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java\n\n@@ -238,7 +238,7 @@ public class GlobalTransactionMgr implements Writable {\n     }\n \n     /**\n-     * check if there exists a load job before the endTransactionId have all\n+     * Check whether a load job already exists before checking all `TransactionId` related with this load job have finished.\n      * finished\n      * \n      * @throws AnalysisException is database does not exist anymore\n"}}, {"oid": "9f3bd2c6d032c96f83102026076bb2d9fb33f99c", "url": "https://github.com/apache/incubator-doris/commit/9f3bd2c6d032c96f83102026076bb2d9fb33f99c", "message": "Update fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java\n\nCo-authored-by: Yunfeng,Wu <wyfsky888@126.com>", "committedDate": "2020-07-16T01:57:46Z", "type": "commit"}]}