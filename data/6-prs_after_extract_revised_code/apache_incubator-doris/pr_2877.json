{"pr_number": 2877, "pr_title": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "pr_createdAt": "2020-02-11T03:20:04Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2877", "timeline": [{"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b", "url": "https://github.com/apache/incubator-doris/commit/fcd96a25c1740a0acd48af352d94519beb76a86b", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-11T05:15:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzMjI5Mg==", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377632292", "bodyText": "Plz add comment to this function", "author": "morningman", "createdAt": "2020-02-11T13:27:41Z", "path": "fe/src/main/java/org/apache/doris/analysis/GroupByClause.java", "diffHunk": "@@ -202,12 +202,7 @@ public void analyze(Analyzer analyzer) throws AnalysisException {\n     }\n \n     public boolean isGroupByExtension() {\n-        if (groupingType == GroupingType.GROUP_BY ||\n-                groupingType == GroupingType.GROUPING_SETS && (groupingSetList == null || groupingSetList.size() < 2)) {\n-            return false;\n-        } else {\n-            return true;\n-        }\n+        return groupingType != GroupingType.GROUP_BY;", "originalCommit": "fcd96a25c1740a0acd48af352d94519beb76a86b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24272993c81b309ec4828b21d075ab72ada25010", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/GroupByClause.java b/fe/src/main/java/org/apache/doris/analysis/GroupByClause.java\nindex 798dad3fd..c0a5a0906 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/GroupByClause.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/GroupByClause.java\n\n@@ -201,6 +201,7 @@ public class GroupByClause implements ParseNode {\n         analyzed_ = true;\n     }\n \n+    // check if group by clause is contain grouping set/rollup/cube\n     public boolean isGroupByExtension() {\n         return groupingType != GroupingType.GROUP_BY;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzMzg3Mw==", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377633873", "bodyText": "Would add some examples for all these cases?", "author": "morningman", "createdAt": "2020-02-11T13:30:36Z", "path": "fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java", "diffHunk": "@@ -85,12 +86,11 @@ public VirtualSlotRef addGroupingSlots(List<Expr> realSlots, Analyzer analyzer)\n     // generate the bitmap that repeated node will repeat rows according to\n     public void buildRepeat(ArrayList<Expr> groupingExprs, List<ArrayList<Expr>> groupingSetList) {\n         groupingIdList = new ArrayList<>();\n-        BitSet bitSetAll = new BitSet();\n+        bitSetAll = new BitSet();\n         bitSetAll.set(0, groupingExprs.size(), true);\n-        groupingIdList.add(bitSetAll);\n         switch (groupingType) {\n             case CUBE:\n-                for (int i = 0; i < (1 << groupingExprs.size()) - 1; i++) {\n+                for (int i = 0; i < (1 << groupingExprs.size()); i++) {", "originalCommit": "fcd96a25c1740a0acd48af352d94519beb76a86b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24272993c81b309ec4828b21d075ab72ada25010", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java b/fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java\nindex 1f6552988..25b98c493 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java\n\n@@ -90,6 +90,9 @@ public class GroupingInfo {\n         bitSetAll.set(0, groupingExprs.size(), true);\n         switch (groupingType) {\n             case CUBE:\n+                // it will generate the full permutation bitmap of cube item\n+                // e.g. cube (k1,k2,k3) the result is [\"{}\", \"{1}\", \"{0}\", \"{0, 1}\", \"{2}\", \"{1, 2}\", \"{0, 1, 2}\",\n+                // \"{0, 2}\"]\n                 for (int i = 0; i < (1 << groupingExprs.size()); i++) {\n                     BitSet bitSet = new BitSet();\n                     for (int j = 0; j < groupingExprs.size(); j++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzNDYzNg==", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377634636", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"cannot use GROUPING functions without [grouping sets|rollup|cube] a\"\n          \n          \n            \n                                        \"cannot use GROUPING functions without [grouping sets|rollup|cube] \"", "author": "morningman", "createdAt": "2020-02-11T13:31:55Z", "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -351,6 +351,14 @@ public void analyze(Analyzer analyzer) throws AnalysisException, UserException {\n         if (groupByClause != null && groupByClause.isGroupByExtension()) {\n             groupingInfo = new GroupingInfo(analyzer, groupByClause.getGroupingType());\n             groupingInfo.substituteGroupingFn(resultExprs, analyzer);\n+        } else {\n+            for (Expr expr : resultExprs) {\n+                if (checkGroupingFn(expr)) {\n+                    throw new AnalysisException(\n+                            \"cannot use GROUPING functions without [grouping sets|rollup|cube] a\"", "originalCommit": "fcd96a25c1740a0acd48af352d94519beb76a86b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24272993c81b309ec4828b21d075ab72ada25010", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\nindex 1c67d5d1a..a4a92f91e 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n\n@@ -355,7 +355,7 @@ public class SelectStmt extends QueryStmt {\n             for (Expr expr : resultExprs) {\n                 if (checkGroupingFn(expr)) {\n                     throw new AnalysisException(\n-                            \"cannot use GROUPING functions without [grouping sets|rollup|cube] a\"\n+                            \"cannot use GROUPING functions without [grouping sets|rollup|cube] \"\n                                     + \"clause or grouping sets only have one element.\");\n                 }\n             }\n"}}, {"oid": "24272993c81b309ec4828b21d075ab72ada25010", "url": "https://github.com/apache/incubator-doris/commit/24272993c81b309ec4828b21d075ab72ada25010", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-11T14:04:29Z", "type": "forcePushed"}, {"oid": "821f23fa57f83b78c2367ad1d3020506d8527608", "url": "https://github.com/apache/incubator-doris/commit/821f23fa57f83b78c2367ad1d3020506d8527608", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-11T15:30:30Z", "type": "forcePushed"}, {"oid": "8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "url": "https://github.com/apache/incubator-doris/commit/8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-12T02:57:44Z", "type": "forcePushed"}, {"oid": "adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "url": "https://github.com/apache/incubator-doris/commit/adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-12T03:00:02Z", "type": "forcePushed"}, {"oid": "3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "url": "https://github.com/apache/incubator-doris/commit/3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-12T11:08:06Z", "type": "commit"}, {"oid": "3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "url": "https://github.com/apache/incubator-doris/commit/3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "committedDate": "2020-02-12T11:08:06Z", "type": "forcePushed"}]}