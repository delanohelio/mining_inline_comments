{"pr_number": 4158, "pr_title": "[RoutineLoad] Support modify routine load job", "pr_createdAt": "2020-07-23T07:55:09Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4158", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NDcxNA==", "url": "https://github.com/apache/incubator-doris/pull/4158#discussion_r459284714", "bodyText": "\u2018spciefied\u2019 Wrong characters", "author": "wutiangan", "createdAt": "2020-07-23T08:16:14Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadManager.java", "diffHunk": "@@ -602,6 +573,24 @@ public void replayChangeRoutineLoadJob(RoutineLoadOperation operation) {\n                  .add(\"msg\", \"replay change routine load job\")\n                  .build());\n     }\n+    \n+    /**\n+     * Enter of altering a routine load job\n+     */\n+    public void alterRoutineLoadJob(AlterRoutineLoadStmt stmt) throws UserException {\n+        RoutineLoadJob job = checkPrivAndGetJob(stmt.getDbName(), stmt.getLabel());\n+        if (stmt.hasDataSourceProperty()\n+                && !stmt.getDataSourceProperties().getType().equalsIgnoreCase(job.dataSourceType.name())) {\n+            throw new DdlException(\"The spciefied job type is not: \" + stmt.getDataSourceProperties().getType());", "originalCommit": "d3d465b3b5a9a5d5be729a554429b543e250e8fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQzMjc5NQ==", "url": "https://github.com/apache/incubator-doris/pull/4158#discussion_r459432795", "bodyText": "done", "author": "morningman", "createdAt": "2020-07-23T13:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NDcxNA=="}], "type": "inlineReview", "revised_code": {"commit": "a38c4283ed244099b0eced399ad9e6d517bae2b1", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadManager.java b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadManager.java\nindex 93ecd7502..925e31ef5 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadManager.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadManager.java\n\n@@ -573,24 +602,6 @@ public class RoutineLoadManager implements Writable {\n                  .add(\"msg\", \"replay change routine load job\")\n                  .build());\n     }\n-    \n-    /**\n-     * Enter of altering a routine load job\n-     */\n-    public void alterRoutineLoadJob(AlterRoutineLoadStmt stmt) throws UserException {\n-        RoutineLoadJob job = checkPrivAndGetJob(stmt.getDbName(), stmt.getLabel());\n-        if (stmt.hasDataSourceProperty()\n-                && !stmt.getDataSourceProperties().getType().equalsIgnoreCase(job.dataSourceType.name())) {\n-            throw new DdlException(\"The spciefied job type is not: \" + stmt.getDataSourceProperties().getType());\n-        }\n-        job.modifyProperties(stmt);\n-    }\n-\n-    public void replayAlterRoutineLoadJob(AlterRoutineLoadJobOperationLog log) {\n-        RoutineLoadJob job = getJob(log.getJobId());\n-        Preconditions.checkNotNull(job, log.getJobId());\n-        job.replayModifyProperties(log);\n-    }\n \n     @Override\n     public void write(DataOutput out) throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4NzU2MA==", "url": "https://github.com/apache/incubator-doris/pull/4158#discussion_r464287560", "bodyText": "The job properties maybe could be modified in here instead of the subclass  KafkaRoutineLoad.", "author": "EmmyMiao87", "createdAt": "2020-08-03T09:06:46Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java", "diffHunk": "@@ -1397,4 +1401,36 @@ public void readFields(DataInput in) throws IOException {\n             throw new IOException(\"error happens when parsing create routine load stmt: \" + origStmt, e);\n         }\n     }\n+\n+    abstract public void modifyProperties(AlterRoutineLoadStmt stmt) throws DdlException;", "originalCommit": "a94cb007c5b602795150d58478f07ce48117abb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzg0Mw==", "url": "https://github.com/apache/incubator-doris/pull/4158#discussion_r464313843", "bodyText": "Maybe we could do this when we got second derived class from RoutineLoadJob", "author": "morningman", "createdAt": "2020-08-03T09:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4NzU2MA=="}], "type": "inlineReview", "revised_code": {"commit": "a38c4283ed244099b0eced399ad9e6d517bae2b1", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\nindex aaf07ec3e..feaf50f17 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n\n@@ -1401,36 +1410,4 @@ public abstract class RoutineLoadJob extends AbstractTxnStateChangeCallback impl\n             throw new IOException(\"error happens when parsing create routine load stmt: \" + origStmt, e);\n         }\n     }\n-\n-    abstract public void modifyProperties(AlterRoutineLoadStmt stmt) throws DdlException;\n-\n-    abstract public void replayModifyProperties(AlterRoutineLoadJobOperationLog log);\n-\n-    // for ALTER ROUTINE LOAD\n-    protected void modifyCommonJobProperties(Map<String, String> jobProperties) {\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.DESIRED_CONCURRENT_NUMBER_PROPERTY)) {\n-            this.desireTaskConcurrentNum = Integer.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.DESIRED_CONCURRENT_NUMBER_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_ERROR_NUMBER_PROPERTY)) {\n-            this.maxErrorNum = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_ERROR_NUMBER_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_INTERVAL_SEC_PROPERTY)) {\n-            this.maxBatchIntervalS = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_INTERVAL_SEC_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_ROWS_PROPERTY)) {\n-            this.maxBatchRows = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_ROWS_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_SIZE_PROPERTY)) {\n-            this.maxBatchSizeBytes = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_SIZE_PROPERTY));\n-        }\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4NzY5MA==", "url": "https://github.com/apache/incubator-doris/pull/4158#discussion_r464287690", "bodyText": "Same as above.", "author": "EmmyMiao87", "createdAt": "2020-08-03T09:07:01Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java", "diffHunk": "@@ -1397,4 +1401,36 @@ public void readFields(DataInput in) throws IOException {\n             throw new IOException(\"error happens when parsing create routine load stmt: \" + origStmt, e);\n         }\n     }\n+\n+    abstract public void modifyProperties(AlterRoutineLoadStmt stmt) throws DdlException;\n+\n+    abstract public void replayModifyProperties(AlterRoutineLoadJobOperationLog log);", "originalCommit": "a94cb007c5b602795150d58478f07ce48117abb7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a38c4283ed244099b0eced399ad9e6d517bae2b1", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\nindex aaf07ec3e..feaf50f17 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n\n@@ -1401,36 +1410,4 @@ public abstract class RoutineLoadJob extends AbstractTxnStateChangeCallback impl\n             throw new IOException(\"error happens when parsing create routine load stmt: \" + origStmt, e);\n         }\n     }\n-\n-    abstract public void modifyProperties(AlterRoutineLoadStmt stmt) throws DdlException;\n-\n-    abstract public void replayModifyProperties(AlterRoutineLoadJobOperationLog log);\n-\n-    // for ALTER ROUTINE LOAD\n-    protected void modifyCommonJobProperties(Map<String, String> jobProperties) {\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.DESIRED_CONCURRENT_NUMBER_PROPERTY)) {\n-            this.desireTaskConcurrentNum = Integer.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.DESIRED_CONCURRENT_NUMBER_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_ERROR_NUMBER_PROPERTY)) {\n-            this.maxErrorNum = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_ERROR_NUMBER_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_INTERVAL_SEC_PROPERTY)) {\n-            this.maxBatchIntervalS = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_INTERVAL_SEC_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_ROWS_PROPERTY)) {\n-            this.maxBatchRows = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_ROWS_PROPERTY));\n-        }\n-\n-        if (jobProperties.containsKey(CreateRoutineLoadStmt.MAX_BATCH_SIZE_PROPERTY)) {\n-            this.maxBatchSizeBytes = Long.valueOf(\n-                    jobProperties.remove(CreateRoutineLoadStmt.MAX_BATCH_SIZE_PROPERTY));\n-        }\n-    }\n }\n"}}, {"oid": "a38c4283ed244099b0eced399ad9e6d517bae2b1", "url": "https://github.com/apache/incubator-doris/commit/a38c4283ed244099b0eced399ad9e6d517bae2b1", "message": "first", "committedDate": "2020-08-03T10:48:32Z", "type": "commit"}, {"oid": "d6169592726294c054527bcf9a90880919eed47b", "url": "https://github.com/apache/incubator-doris/commit/d6169592726294c054527bcf9a90880919eed47b", "message": "second", "committedDate": "2020-08-03T10:48:32Z", "type": "commit"}, {"oid": "a0c5123918bfbeea5fe46dc4aea5866a1b5be88b", "url": "https://github.com/apache/incubator-doris/commit/a0c5123918bfbeea5fe46dc4aea5866a1b5be88b", "message": "add doc", "committedDate": "2020-08-03T10:48:32Z", "type": "commit"}, {"oid": "252314edd599ea9a39047aa218eadd2266dba6b5", "url": "https://github.com/apache/incubator-doris/commit/252314edd599ea9a39047aa218eadd2266dba6b5", "message": "second", "committedDate": "2020-08-03T10:48:32Z", "type": "commit"}, {"oid": "5ae88682fc871a06065b294be2ffb7afe48641c7", "url": "https://github.com/apache/incubator-doris/commit/5ae88682fc871a06065b294be2ffb7afe48641c7", "message": "rebase", "committedDate": "2020-08-03T10:48:33Z", "type": "commit"}, {"oid": "e9f7515a71bf7d8114ce967985235d3cd867a323", "url": "https://github.com/apache/incubator-doris/commit/e9f7515a71bf7d8114ce967985235d3cd867a323", "message": "rebase modify 2", "committedDate": "2020-08-03T10:49:15Z", "type": "commit"}, {"oid": "d28617e640373319e9ce8c15511608bc3649b3a2", "url": "https://github.com/apache/incubator-doris/commit/d28617e640373319e9ce8c15511608bc3649b3a2", "message": "fix bug1", "committedDate": "2020-08-03T10:49:15Z", "type": "commit"}, {"oid": "1007434d84086a0f8620e64365d82fd15febee2d", "url": "https://github.com/apache/incubator-doris/commit/1007434d84086a0f8620e64365d82fd15febee2d", "message": "final", "committedDate": "2020-08-03T10:49:15Z", "type": "commit"}, {"oid": "2aab7ae654e75fb9792f9f573e5fe6e201e42e45", "url": "https://github.com/apache/incubator-doris/commit/2aab7ae654e75fb9792f9f573e5fe6e201e42e45", "message": "fix typo", "committedDate": "2020-08-03T10:49:15Z", "type": "commit"}, {"oid": "4b42b7d9507542d864853be6ef04f07e88900e95", "url": "https://github.com/apache/incubator-doris/commit/4b42b7d9507542d864853be6ef04f07e88900e95", "message": "fix by review", "committedDate": "2020-08-03T10:49:15Z", "type": "commit"}, {"oid": "4b42b7d9507542d864853be6ef04f07e88900e95", "url": "https://github.com/apache/incubator-doris/commit/4b42b7d9507542d864853be6ef04f07e88900e95", "message": "fix by review", "committedDate": "2020-08-03T10:49:15Z", "type": "forcePushed"}, {"oid": "c917d3069f87bdf9acd17acb75b500b87ad02822", "url": "https://github.com/apache/incubator-doris/commit/c917d3069f87bdf9acd17acb75b500b87ad02822", "message": "add json root", "committedDate": "2020-08-03T10:56:35Z", "type": "commit"}, {"oid": "a2358f36e1090483ba710626dc7ceae5c469107f", "url": "https://github.com/apache/incubator-doris/commit/a2358f36e1090483ba710626dc7ceae5c469107f", "message": "fix ut", "committedDate": "2020-08-05T15:22:01Z", "type": "commit"}]}