{"pr_number": 5093, "pr_title": "[Bug] Fix bug that routine load may lost some data", "pr_createdAt": "2020-12-16T08:49:03Z", "pr_url": "https://github.com/apache/incubator-doris/pull/5093", "timeline": [{"oid": "2db868988f9a9fa15b7ff29d64cfd0f4b78f6ee7", "url": "https://github.com/apache/incubator-doris/commit/2db868988f9a9fa15b7ff29d64cfd0f4b78f6ee7", "message": "[Bug] Fix bug that routine load may lost some data\n\nIn the previous implementation, whether a subtask is in commit or abort state,\nwe will try to update the job progress, such as the consumed offset of kafka.\nUnder normal circumstances, the aborted transaction does not consume any data,\nand all progress is 0, so even we update the progress, the progress will remain\nunchanged.\nHowever, in the case of high cluster load, the subtask may fail half of the execution on the BE side.\nAt this time, although the task is aborted, part of the progress is updated.\nCause the next subtask to skip these data for consumption, resulting in data loss.\n\nAlso modify some log level and config", "committedDate": "2020-12-16T08:47:04Z", "type": "commit"}, {"oid": "5fc7b9006d2c0f1f8a06b9fcd455f8770a672f3e", "url": "https://github.com/apache/incubator-doris/commit/5fc7b9006d2c0f1f8a06b9fcd455f8770a672f3e", "message": "fix bug", "committedDate": "2020-12-16T13:40:30Z", "type": "commit"}, {"oid": "6df889aa838fce6ff94e55c6ef58f46aca23279d", "url": "https://github.com/apache/incubator-doris/commit/6df889aa838fce6ff94e55c6ef58f46aca23279d", "message": "fix bug", "committedDate": "2020-12-17T07:07:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg2NjM4Ng==", "url": "https://github.com/apache/incubator-doris/pull/5093#discussion_r544866386", "bodyText": "error commit...", "author": "EmmyMiao87", "createdAt": "2020-12-17T07:27:14Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java", "diffHunk": "@@ -1049,8 +1053,9 @@ private void executeTaskOnTxnStatusChanged(RoutineLoadTaskInfo routineLoadTaskIn\n                                           + \" maybe task was aborted by master when timeout\")\n                                   .build());\n             }\n-        } else if (checkCommitInfo(rlTaskTxnCommitAttachment, txnState.getTransactionStatus())) {\n+        } else if (checkCommitInfo(rlTaskTxnCommitAttachment, txnState)) {\n             // step2: update job progress\n+            // only committed task need to update progress", "originalCommit": "6df889aa838fce6ff94e55c6ef58f46aca23279d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ef538470bb361bf714c4dd36cb3ed061d1a3dac8", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\nindex b9ac2b7f6..81f8015e9 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java\n\n@@ -1055,7 +1055,6 @@ public abstract class RoutineLoadJob extends AbstractTxnStateChangeCallback impl\n             }\n         } else if (checkCommitInfo(rlTaskTxnCommitAttachment, txnState)) {\n             // step2: update job progress\n-            // only committed task need to update progress\n             updateProgress(rlTaskTxnCommitAttachment);\n         }\n \n"}}, {"oid": "ef538470bb361bf714c4dd36cb3ed061d1a3dac8", "url": "https://github.com/apache/incubator-doris/commit/ef538470bb361bf714c4dd36cb3ed061d1a3dac8", "message": "review", "committedDate": "2020-12-17T07:32:29Z", "type": "commit"}, {"oid": "350d304f73f47dec8f2ed8e99983142edf8c5cec", "url": "https://github.com/apache/incubator-doris/commit/350d304f73f47dec8f2ed8e99983142edf8c5cec", "message": "fix ut", "committedDate": "2020-12-19T04:44:53Z", "type": "commit"}, {"oid": "4205e9fb601a40f8cb427d12de2fdb920bb6bdfa", "url": "https://github.com/apache/incubator-doris/commit/4205e9fb601a40f8cb427d12de2fdb920bb6bdfa", "message": "fix codestyle", "committedDate": "2020-12-19T08:21:15Z", "type": "commit"}, {"oid": "d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "url": "https://github.com/apache/incubator-doris/commit/d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "message": "fix bug", "committedDate": "2020-12-19T12:07:32Z", "type": "commit"}, {"oid": "d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "url": "https://github.com/apache/incubator-doris/commit/d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "message": "fix bug", "committedDate": "2020-12-19T12:07:32Z", "type": "forcePushed"}, {"oid": "66379508d9bde9f1862b132508a346ac15fe125f", "url": "https://github.com/apache/incubator-doris/commit/66379508d9bde9f1862b132508a346ac15fe125f", "message": "fix bug", "committedDate": "2020-12-19T12:56:31Z", "type": "commit"}, {"oid": "143b3939d842bcbb0c268a713d0d180107f4313f", "url": "https://github.com/apache/incubator-doris/commit/143b3939d842bcbb0c268a713d0d180107f4313f", "message": "5", "committedDate": "2020-12-21T10:27:36Z", "type": "commit"}, {"oid": "f53a4fe3896f02b241589734200f808035ec0866", "url": "https://github.com/apache/incubator-doris/commit/f53a4fe3896f02b241589734200f808035ec0866", "message": "6", "committedDate": "2020-12-21T10:53:37Z", "type": "commit"}]}