{"pr_number": 3799, "pr_title": "[Dynamic Partition] Use ZonedDateTime to support set timezone", "pr_createdAt": "2020-06-08T10:12:46Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3799", "timeline": [{"oid": "b01e7ec55eb943601fcfe5650019a235cd7a2642", "url": "https://github.com/apache/incubator-doris/commit/b01e7ec55eb943601fcfe5650019a235cd7a2642", "message": "[Dynamic Partition] Use ZonedDateTime to support set timezone\n\nThis CL mainly support timezone in dynamic partition:\n1. use new Java Time API to replace Calender.\n2. support set time zone in dynamic partition parameters.", "committedDate": "2020-06-08T06:54:50Z", "type": "commit"}, {"oid": "efe98e4129384755a443bc93b9be9018389506da", "url": "https://github.com/apache/incubator-doris/commit/efe98e4129384755a443bc93b9be9018389506da", "message": "remove file", "committedDate": "2020-06-08T07:01:11Z", "type": "commit"}, {"oid": "95f88e6d90bd69f4e5748a004e6debc018d33d09", "url": "https://github.com/apache/incubator-doris/commit/95f88e6d90bd69f4e5748a004e6debc018d33d09", "message": "support set timezone", "committedDate": "2020-06-08T10:00:04Z", "type": "commit"}, {"oid": "36349b2948aa7c92f0e6895b7ec2b6b1d5405c2e", "url": "https://github.com/apache/incubator-doris/commit/36349b2948aa7c92f0e6895b7ec2b6b1d5405c2e", "message": "fix", "committedDate": "2020-06-08T10:21:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MzI2Mg==", "url": "https://github.com/apache/incubator-doris/pull/3799#discussion_r437463262", "bodyText": "Better move the time related functions to TimeUtils class", "author": "morningman", "createdAt": "2020-06-09T14:23:41Z", "path": "fe/src/main/java/org/apache/doris/catalog/DynamicPartitionProperty.java", "diffHunk": "@@ -46,15 +48,14 @@\n     private int buckets;\n     private StartOfDate startOfWeek;\n     private StartOfDate startOfMonth;\n-    // TODO: support setting timezone.\n     private TimeZone tz = TimeUtils.getDefaultTimeZone();\n \n-\n     public DynamicPartitionProperty(Map<String, String> properties) {\n         if (properties != null && !properties.isEmpty()) {\n             this.exist = true;\n             this.enable = Boolean.parseBoolean(properties.get(ENABLE));\n             this.timeUnit = properties.get(TIME_UNIT);\n+            this.tz = TimeZone.getTimeZone(properties.getOrDefault(TIME_ZONE, ZoneId.systemDefault().toString()));", "originalCommit": "36349b2948aa7c92f0e6895b7ec2b6b1d5405c2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUxNTkxNw==", "url": "https://github.com/apache/incubator-doris/pull/3799#discussion_r437515917", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-06-09T15:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MzI2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "034cbc321aa365a2088aad707440a38b558779b1", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/DynamicPartitionProperty.java b/fe/src/main/java/org/apache/doris/catalog/DynamicPartitionProperty.java\nindex c13b003fd..a7cbb51d5 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/DynamicPartitionProperty.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/DynamicPartitionProperty.java\n\n@@ -55,7 +55,7 @@ public class DynamicPartitionProperty {\n             this.exist = true;\n             this.enable = Boolean.parseBoolean(properties.get(ENABLE));\n             this.timeUnit = properties.get(TIME_UNIT);\n-            this.tz = TimeZone.getTimeZone(properties.getOrDefault(TIME_ZONE, ZoneId.systemDefault().toString()));\n+            this.tz = TimeUtils.getOrSystemTimeZone(properties.get(TIME_ZONE));\n             // In order to compatible dynamic add partition version\n             this.start = Integer.parseInt(properties.getOrDefault(START, String.valueOf(MIN_START_OFFSET)));\n             this.end = Integer.parseInt(properties.get(END));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MzMxNw==", "url": "https://github.com/apache/incubator-doris/pull/3799#discussion_r437463317", "bodyText": "Why not using TimeUtils.checkTimeZoneValidAndStandardize()?", "author": "morningman", "createdAt": "2020-06-09T14:23:45Z", "path": "fe/src/main/java/org/apache/doris/common/util/DynamicPartitionUtil.java", "diffHunk": "@@ -148,11 +151,25 @@ private static void checkStartDayOfWeek(String val) throws DdlException {\n         }\n     }\n \n+    private static void checkTimeZone(String val) throws DdlException {", "originalCommit": "36349b2948aa7c92f0e6895b7ec2b6b1d5405c2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUwMzYwNA==", "url": "https://github.com/apache/incubator-doris/pull/3799#discussion_r437503604", "bodyText": "In fact, i don't konw the function...", "author": "WingsGo", "createdAt": "2020-06-09T15:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MzMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "034cbc321aa365a2088aad707440a38b558779b1", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/common/util/DynamicPartitionUtil.java b/fe/src/main/java/org/apache/doris/common/util/DynamicPartitionUtil.java\nindex 924db86f8..0ba654477 100644\n--- a/fe/src/main/java/org/apache/doris/common/util/DynamicPartitionUtil.java\n+++ b/fe/src/main/java/org/apache/doris/common/util/DynamicPartitionUtil.java\n\n@@ -151,19 +151,6 @@ public class DynamicPartitionUtil {\n         }\n     }\n \n-    private static void checkTimeZone(String val) throws DdlException {\n-        boolean validId = false;\n-        for (String availableId : TimeZone.getAvailableIDs()) {\n-            if (availableId != null && availableId.equals(val)) {\n-                validId = true;\n-                break;\n-            }\n-        }\n-        if (!validId) {\n-            throw new DdlException(\"Invalid properties: \" + DynamicPartitionProperty.TIME_ZONE);\n-        }\n-    }\n-\n     public static boolean checkDynamicPartitionPropertiesExist(Map<String, String> properties) {\n         if (properties == null) {\n             return false;\n"}}, {"oid": "034cbc321aa365a2088aad707440a38b558779b1", "url": "https://github.com/apache/incubator-doris/commit/034cbc321aa365a2088aad707440a38b558779b1", "message": "fix by review", "committedDate": "2020-06-09T15:21:48Z", "type": "commit"}, {"oid": "87d0b4f2dbf71e08e139ffa116cdea294cbb3bbf", "url": "https://github.com/apache/incubator-doris/commit/87d0b4f2dbf71e08e139ffa116cdea294cbb3bbf", "message": "fix unused import", "committedDate": "2020-06-10T02:05:52Z", "type": "commit"}, {"oid": "c07afac37c6e4919b9e1cd2508014c12d2b89626", "url": "https://github.com/apache/incubator-doris/commit/c07afac37c6e4919b9e1cd2508014c12d2b89626", "message": "fix ut", "committedDate": "2020-06-10T02:43:35Z", "type": "commit"}]}