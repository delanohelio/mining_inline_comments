{"pr_number": 5133, "pr_title": "[Enhancement] Optimize the algorithm of selecting host for a bucket scan task when a backend not alive", "pr_createdAt": "2020-12-23T08:15:22Z", "pr_url": "https://github.com/apache/incubator-doris/pull/5133", "timeline": [{"oid": "1a15f533098eec6708121004ef835d111dc374f3", "url": "https://github.com/apache/incubator-doris/commit/1a15f533098eec6708121004ef835d111dc374f3", "message": "udf: replace function", "committedDate": "2020-08-13T14:09:31Z", "type": "commit"}, {"oid": "7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "url": "https://github.com/apache/incubator-doris/commit/7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-14T01:37:05Z", "type": "commit"}, {"oid": "391158f52190755b5fc621c31bf703835c0a7b3b", "url": "https://github.com/apache/incubator-doris/commit/391158f52190755b5fc621c31bf703835c0a7b3b", "message": "udf: replace function", "committedDate": "2020-08-14T02:11:25Z", "type": "commit"}, {"oid": "5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "url": "https://github.com/apache/incubator-doris/commit/5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "message": "udf: replace function", "committedDate": "2020-08-14T03:58:30Z", "type": "commit"}, {"oid": "a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "url": "https://github.com/apache/incubator-doris/commit/a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-18T02:31:52Z", "type": "commit"}, {"oid": "86f841f29fa4ee19773d6c5922465194a2887cf6", "url": "https://github.com/apache/incubator-doris/commit/86f841f29fa4ee19773d6c5922465194a2887cf6", "message": "udf: replace function", "committedDate": "2020-08-18T03:56:14Z", "type": "commit"}, {"oid": "ade1afa75c94a178a6801ba1324acf25ad8b16fe", "url": "https://github.com/apache/incubator-doris/commit/ade1afa75c94a178a6801ba1324acf25ad8b16fe", "message": "udf: replace function", "committedDate": "2020-08-18T03:59:59Z", "type": "commit"}, {"oid": "1d95a491115064c9753694ad4d45c2f72b8d2645", "url": "https://github.com/apache/incubator-doris/commit/1d95a491115064c9753694ad4d45c2f72b8d2645", "message": "udf: replace function", "committedDate": "2020-08-18T08:01:45Z", "type": "commit"}, {"oid": "433eb87f02cfa6740e80b0e4157d916ab5aca400", "url": "https://github.com/apache/incubator-doris/commit/433eb87f02cfa6740e80b0e4157d916ab5aca400", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-24T02:03:34Z", "type": "commit"}, {"oid": "c62d239792b174fbc56ab311f0bc5337de971d96", "url": "https://github.com/apache/incubator-doris/commit/c62d239792b174fbc56ab311f0bc5337de971d96", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T03:17:32Z", "type": "commit"}, {"oid": "0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "url": "https://github.com/apache/incubator-doris/commit/0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T08:21:34Z", "type": "commit"}, {"oid": "02d3f863c8556463c8dea903abdc4d21bf1eb19b", "url": "https://github.com/apache/incubator-doris/commit/02d3f863c8556463c8dea903abdc4d21bf1eb19b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-01T01:25:42Z", "type": "commit"}, {"oid": "41da0ba0109414c47239f3fb926da48540059018", "url": "https://github.com/apache/incubator-doris/commit/41da0ba0109414c47239f3fb926da48540059018", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-08T08:25:12Z", "type": "commit"}, {"oid": "de4e523b505f0d628a16199b88d4bb5a0419fef6", "url": "https://github.com/apache/incubator-doris/commit/de4e523b505f0d628a16199b88d4bb5a0419fef6", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-11T02:42:20Z", "type": "commit"}, {"oid": "a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "url": "https://github.com/apache/incubator-doris/commit/a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-17T09:37:21Z", "type": "commit"}, {"oid": "024c422b74829efe4c4b715a014517c7eee1a80a", "url": "https://github.com/apache/incubator-doris/commit/024c422b74829efe4c4b715a014517c7eee1a80a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-22T09:15:31Z", "type": "commit"}, {"oid": "e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "url": "https://github.com/apache/incubator-doris/commit/e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-23T11:48:49Z", "type": "commit"}, {"oid": "837e037057936e933fd79cbbdb432047be2bba5e", "url": "https://github.com/apache/incubator-doris/commit/837e037057936e933fd79cbbdb432047be2bba5e", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-27T06:37:32Z", "type": "commit"}, {"oid": "a36d3e78136a3fefb62f2513d20773479904cb6b", "url": "https://github.com/apache/incubator-doris/commit/a36d3e78136a3fefb62f2513d20773479904cb6b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-17T10:32:25Z", "type": "commit"}, {"oid": "43cfa2b2ca752118c43a0212cf074f09cb311a7a", "url": "https://github.com/apache/incubator-doris/commit/43cfa2b2ca752118c43a0212cf074f09cb311a7a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-23T14:34:47Z", "type": "commit"}, {"oid": "641efb587d2e9ac9a9e9771e7648a299a66f3992", "url": "https://github.com/apache/incubator-doris/commit/641efb587d2e9ac9a9e9771e7648a299a66f3992", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-24T12:49:28Z", "type": "commit"}, {"oid": "5066131b9017910473554dfa298b16224c1977da", "url": "https://github.com/apache/incubator-doris/commit/5066131b9017910473554dfa298b16224c1977da", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-26T11:49:19Z", "type": "commit"}, {"oid": "dde044ba251c85b7f0a8a388af71331553208a05", "url": "https://github.com/apache/incubator-doris/commit/dde044ba251c85b7f0a8a388af71331553208a05", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-27T08:38:35Z", "type": "commit"}, {"oid": "8f8c8234c052720bc65e316a305a3297318bd481", "url": "https://github.com/apache/incubator-doris/commit/8f8c8234c052720bc65e316a305a3297318bd481", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-28T07:25:25Z", "type": "commit"}, {"oid": "f7704ba989ab5b903e407f7b02c5a9b6c03b4588", "url": "https://github.com/apache/incubator-doris/commit/f7704ba989ab5b903e407f7b02c5a9b6c03b4588", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-01T13:04:30Z", "type": "commit"}, {"oid": "8726e7aefed64e62b1bbf6f56278274f11c8b0fa", "url": "https://github.com/apache/incubator-doris/commit/8726e7aefed64e62b1bbf6f56278274f11c8b0fa", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-04T09:31:42Z", "type": "commit"}, {"oid": "4dfc785c8a97549fb9c38b6dd8ea938d1bb50db4", "url": "https://github.com/apache/incubator-doris/commit/4dfc785c8a97549fb9c38b6dd8ea938d1bb50db4", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-06T07:45:49Z", "type": "commit"}, {"oid": "d4bd91c17af4b4954b2715c5fd93cf86b7351085", "url": "https://github.com/apache/incubator-doris/commit/d4bd91c17af4b4954b2715c5fd93cf86b7351085", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-11T02:13:02Z", "type": "commit"}, {"oid": "2eb8ddf66fb0ffbeaab0e882a5d33483180da351", "url": "https://github.com/apache/incubator-doris/commit/2eb8ddf66fb0ffbeaab0e882a5d33483180da351", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-12T02:49:53Z", "type": "commit"}, {"oid": "5aa7afc57d6cbeb2013a6e8957f214f7abc93e7f", "url": "https://github.com/apache/incubator-doris/commit/5aa7afc57d6cbeb2013a6e8957f214f7abc93e7f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-14T11:19:03Z", "type": "commit"}, {"oid": "ce251b26af3feb6aa49e5e31bee887b0441e8584", "url": "https://github.com/apache/incubator-doris/commit/ce251b26af3feb6aa49e5e31bee887b0441e8584", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-17T03:43:59Z", "type": "commit"}, {"oid": "04c58994a066d51dcaf84657d04a2d6281bf8371", "url": "https://github.com/apache/incubator-doris/commit/04c58994a066d51dcaf84657d04a2d6281bf8371", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-18T10:41:11Z", "type": "commit"}, {"oid": "2e614cf89862a62ccadf96bcc9f94034ebc3a214", "url": "https://github.com/apache/incubator-doris/commit/2e614cf89862a62ccadf96bcc9f94034ebc3a214", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-24T08:52:28Z", "type": "commit"}, {"oid": "ede2e000c0fe30022d1dd417f08deb2a4e1c95da", "url": "https://github.com/apache/incubator-doris/commit/ede2e000c0fe30022d1dd417f08deb2a4e1c95da", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-25T03:23:03Z", "type": "commit"}, {"oid": "0aed91fed8b786d2e9860fc5ca0fad95b6810d75", "url": "https://github.com/apache/incubator-doris/commit/0aed91fed8b786d2e9860fc5ca0fad95b6810d75", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-26T09:50:24Z", "type": "commit"}, {"oid": "bd28b736375ece74d76527fa8319c4264356427c", "url": "https://github.com/apache/incubator-doris/commit/bd28b736375ece74d76527fa8319c4264356427c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-30T02:30:06Z", "type": "commit"}, {"oid": "e56e17d3bdd29fdb4018444609740efd2d01e6bc", "url": "https://github.com/apache/incubator-doris/commit/e56e17d3bdd29fdb4018444609740efd2d01e6bc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-12-10T02:00:09Z", "type": "commit"}, {"oid": "7d5d011ec036f63ba570e4645176820ca36e6fa8", "url": "https://github.com/apache/incubator-doris/commit/7d5d011ec036f63ba570e4645176820ca36e6fa8", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-12-17T02:30:07Z", "type": "commit"}, {"oid": "b23a76343603edb4533450dbb40404710b6c5b41", "url": "https://github.com/apache/incubator-doris/commit/b23a76343603edb4533450dbb40404710b6c5b41", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-12-23T02:19:12Z", "type": "commit"}, {"oid": "a812808973853d14516eca79a8ffb45eaf1e8c1b", "url": "https://github.com/apache/incubator-doris/commit/a812808973853d14516eca79a8ffb45eaf1e8c1b", "message": "optimize bucket hosts select strategy", "committedDate": "2020-12-23T07:39:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgwNDEyNw==", "url": "https://github.com/apache/incubator-doris/pull/5133#discussion_r548804127", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef())+1);\n          \n          \n            \n                                buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef()) + 1);", "author": "caiconghui", "createdAt": "2020-12-25T05:18:31Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1560,14 +1560,20 @@ private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLoc\n                     break;\n                 }\n             }\n-\n-            buckendIdToBucketCountMap.put(buckendId, buckendIdToBucketCountMap.get(buckendId) + 1);\n             Reference<Long> backendIdRef = new Reference<Long>();\n             TNetworkAddress execHostPort = SimpleScheduler.getHost(buckendId, seqLocation.locations, idToBackend, backendIdRef);\n             if (execHostPort == null) {\n                 throw new UserException(\"there is no scanNode Backend\");\n             }\n-\n+            if (backendIdRef.getRef() != buckendId) {\n+                if (!buckendIdToBucketCountMap.containsKey(backendIdRef.getRef())) {\n+                    buckendIdToBucketCountMap.put(backendIdRef.getRef(), 1);\n+                } else {\n+                    buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef())+1);", "originalCommit": "a812808973853d14516eca79a8ffb45eaf1e8c1b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1950f9f9ba62084c82c39de2542c2cf9da5bd69e", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java b/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\nindex 5e6a23971..23bff83ea 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\n\n@@ -1569,7 +1569,7 @@ public class Coordinator {\n                 if (!buckendIdToBucketCountMap.containsKey(backendIdRef.getRef())) {\n                     buckendIdToBucketCountMap.put(backendIdRef.getRef(), 1);\n                 } else {\n-                    buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef())+1);\n+                    buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef()) + 1);\n                 }\n             } else {\n                 buckendIdToBucketCountMap.put(buckendId, buckendIdToBucketCountMap.get(buckendId) + 1);\n"}}, {"oid": "1950f9f9ba62084c82c39de2542c2cf9da5bd69e", "url": "https://github.com/apache/incubator-doris/commit/1950f9f9ba62084c82c39de2542c2cf9da5bd69e", "message": "format code", "committedDate": "2020-12-25T07:11:03Z", "type": "commit"}, {"oid": "b752a168f946469abcea20840a1dc509b3d5c443", "url": "https://github.com/apache/incubator-doris/commit/b752a168f946469abcea20840a1dc509b3d5c443", "message": "fix conflict file", "committedDate": "2020-12-31T02:26:40Z", "type": "commit"}, {"oid": "233aee75d37572ccb13a910512a0ad2ffeada5d3", "url": "https://github.com/apache/incubator-doris/commit/233aee75d37572ccb13a910512a0ad2ffeada5d3", "message": "fix conflict file", "committedDate": "2020-12-31T02:35:53Z", "type": "forcePushed"}, {"oid": "409a35930eceb4f48b80b49da6f6592aaf8265af", "url": "https://github.com/apache/incubator-doris/commit/409a35930eceb4f48b80b49da6f6592aaf8265af", "message": "fix conflict file", "committedDate": "2020-12-31T02:41:23Z", "type": "forcePushed"}, {"oid": "95c3421186966ef0335c6cbf835cc83f72370cea", "url": "https://github.com/apache/incubator-doris/commit/95c3421186966ef0335c6cbf835cc83f72370cea", "message": "fix conflict file", "committedDate": "2020-12-31T02:43:47Z", "type": "commit"}, {"oid": "95c3421186966ef0335c6cbf835cc83f72370cea", "url": "https://github.com/apache/incubator-doris/commit/95c3421186966ef0335c6cbf835cc83f72370cea", "message": "fix conflict file", "committedDate": "2020-12-31T02:43:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5MzE5MQ==", "url": "https://github.com/apache/incubator-doris/pull/5133#discussion_r551293191", "bodyText": "This logic isn't very simple. would better add comments here for each if-else branch meaning", "author": "kangkaisen", "createdAt": "2021-01-04T12:38:50Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1560,14 +1560,20 @@ private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLoc\n                     break;\n                 }\n             }\n-\n-            buckendIdToBucketCountMap.put(buckendId, buckendIdToBucketCountMap.get(buckendId) + 1);\n             Reference<Long> backendIdRef = new Reference<Long>();\n             TNetworkAddress execHostPort = SimpleScheduler.getHost(buckendId, seqLocation.locations, idToBackend, backendIdRef);\n             if (execHostPort == null) {\n                 throw new UserException(\"there is no scanNode Backend\");\n             }\n-\n+            if (backendIdRef.getRef() != buckendId) {", "originalCommit": "95c3421186966ef0335c6cbf835cc83f72370cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTczNjIyOA==", "url": "https://github.com/apache/incubator-doris/pull/5133#discussion_r551736228", "bodyText": "Thanks for your code review. The comments has been added.", "author": "xinghuayu007", "createdAt": "2021-01-05T06:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5MzE5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec5c64b879469cf10a6d671c8d4f6d5a2c4c5ad1", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java b/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\nindex b66692798..f5dd31017 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java\n\n@@ -1565,13 +1565,15 @@ public class Coordinator {\n             if (execHostPort == null) {\n                 throw new UserException(\"there is no scanNode Backend\");\n             }\n+            //the backend with buckendId is not alive, chose another new backend\n             if (backendIdRef.getRef() != buckendId) {\n+                //buckendIdToBucketCountMap does not contain the new backend, insert into it\n                 if (!buckendIdToBucketCountMap.containsKey(backendIdRef.getRef())) {\n                     buckendIdToBucketCountMap.put(backendIdRef.getRef(), 1);\n-                } else {\n+                } else { //buckendIdToBucketCountMap contains the new backend, update it \n                     buckendIdToBucketCountMap.put(backendIdRef.getRef(), buckendIdToBucketCountMap.get(backendIdRef.getRef()) + 1);\n                 }\n-            } else {\n+            } else { //the backend with buckendId is alive, update buckendIdToBucketCountMap directly\n                 buckendIdToBucketCountMap.put(buckendId, buckendIdToBucketCountMap.get(buckendId) + 1);\n             }\n             addressToBackendID.put(execHostPort, backendIdRef.getRef());\n"}}, {"oid": "ec5c64b879469cf10a6d671c8d4f6d5a2c4c5ad1", "url": "https://github.com/apache/incubator-doris/commit/ec5c64b879469cf10a6d671c8d4f6d5a2c4c5ad1", "message": "update", "committedDate": "2021-01-05T06:12:10Z", "type": "commit"}]}