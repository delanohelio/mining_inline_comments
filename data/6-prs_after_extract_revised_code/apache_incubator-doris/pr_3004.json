{"pr_number": 3004, "pr_title": "Support Amazon S3 data source in Broker Load ", "pr_createdAt": "2020-02-26T14:35:53Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3004", "timeline": [{"oid": "aacad348a234af44ea24747af3d648f1829584e5", "url": "https://github.com/apache/incubator-doris/commit/aacad348a234af44ea24747af3d648f1829584e5", "message": "BrokerLoad support AmazonS3 data source", "committedDate": "2020-02-26T14:27:44Z", "type": "commit"}, {"oid": "305deab5ebd67b0ff2abadeeab5b8cd09b146342", "url": "https://github.com/apache/incubator-doris/commit/305deab5ebd67b0ff2abadeeab5b8cd09b146342", "message": "Merge branch 'master' into amazons3", "committedDate": "2020-02-26T14:30:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjA4OA==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384552088", "bodyText": "Why catch all exception", "author": "HangyuanLiu", "createdAt": "2020-02-26T15:06:59Z", "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -511,7 +598,7 @@ public void pwrite(TBrokerFD fd, long offset, byte[] data) {\n             long currentStreamOffset;\n             try {\n                 currentStreamOffset = fsDataOutputStream.getPos();\n-            } catch (IOException e) {\n+            } catch (Exception e) {", "originalCommit": "305deab5ebd67b0ff2abadeeab5b8cd09b146342", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyMzYzNQ==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384923635", "bodyText": "should be 'IOException'", "author": "frwrdt", "createdAt": "2020-02-27T05:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjA4OA=="}], "type": "inlineReview", "revised_code": {"commit": "1d24602f1f6ee024528319c0bf5b4760efdfaa22", "chunk": "diff --git a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\nindex 049af6abd..9c5241d68 100644\n--- a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n+++ b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n\n@@ -598,7 +598,7 @@ public class FileSystemManager {\n             long currentStreamOffset;\n             try {\n                 currentStreamOffset = fsDataOutputStream.getPos();\n-            } catch (Exception e) {\n+            } catch (IOException e) {\n                 logger.error(\"errors while get file pos from output stream\", e);\n                 throw new BrokerException(TBrokerOperationStatusCode.TARGET_STORAGE_SERVICE_ERROR,\n                         \"errors while get file pos from output stream\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1NDExNw==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384554117", "bodyText": "properties.getOrDefault ?", "author": "HangyuanLiu", "createdAt": "2020-02-26T15:10:04Z", "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -307,7 +343,58 @@ public BrokerFileSystem getFileSystem(String path, Map<String, String> propertie\n             fileSystem.getLock().unlock();\n         }\n     }\n-    \n+\n+    /**\n+     * visible for test\n+     *\n+     * file system handle is cached, the identity is host + accessKey_secretKey\n+     * @param path\n+     * @param properties\n+     * @return\n+     * @throws URISyntaxException\n+     * @throws Exception\n+     */\n+    public BrokerFileSystem getS3AFileSystem(String path, Map<String, String> properties) {\n+        WildcardURI pathUri = new WildcardURI(path);\n+        String accessKey = properties.containsKey(FS_S3A_ACCESS_KEY) ? properties.get(FS_S3A_ACCESS_KEY) : \"\";", "originalCommit": "305deab5ebd67b0ff2abadeeab5b8cd09b146342", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyMzQ4OA==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384923488", "bodyText": "ok", "author": "frwrdt", "createdAt": "2020-02-27T05:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1NDExNw=="}], "type": "inlineReview", "revised_code": {"commit": "1d24602f1f6ee024528319c0bf5b4760efdfaa22", "chunk": "diff --git a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\nindex 049af6abd..9c5241d68 100644\n--- a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n+++ b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n\n@@ -356,9 +356,9 @@ public class FileSystemManager {\n      */\n     public BrokerFileSystem getS3AFileSystem(String path, Map<String, String> properties) {\n         WildcardURI pathUri = new WildcardURI(path);\n-        String accessKey = properties.containsKey(FS_S3A_ACCESS_KEY) ? properties.get(FS_S3A_ACCESS_KEY) : \"\";\n-        String secretKey = properties.containsKey(FS_S3A_SECRET_KEY) ? properties.get(FS_S3A_SECRET_KEY) : \"\";\n-        String endpoint = properties.containsKey(FS_S3A_ENDPOINT) ? properties.get(FS_S3A_ENDPOINT) : \"\";\n+        String accessKey = properties.getOrDefault(FS_S3A_ACCESS_KEY, \"\");\n+        String secretKey = properties.getOrDefault(FS_S3A_SECRET_KEY, \"\");\n+        String endpoint = properties.getOrDefault(FS_S3A_ENDPOINT, \"\");\n         String host = S3A_SCHEME + \"://\" + endpoint;\n         String s3aUgi = accessKey + \",\" + secretKey;\n         FileSystemIdentity fileSystemIdentity = new FileSystemIdentity(host, s3aUgi);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1NjIwMQ==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384556201", "bodyText": "Please keep indentation", "author": "HangyuanLiu", "createdAt": "2020-02-26T15:13:11Z", "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -146,12 +182,12 @@ public BrokerFileSystem getFileSystem(String path, Map<String, String> propertie\n         String password = properties.getOrDefault(PASSWORD_KEY, \"\");\n         String dfsNameServices = properties.getOrDefault(DFS_NAMESERVICES_KEY, \"\");\n         String authentication = properties.getOrDefault(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,\n-            AUTHENTICATION_SIMPLE);\n+                AUTHENTICATION_SIMPLE);", "originalCommit": "305deab5ebd67b0ff2abadeeab5b8cd09b146342", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyMzQyMQ==", "url": "https://github.com/apache/incubator-doris/pull/3004#discussion_r384923421", "bodyText": "ok", "author": "frwrdt", "createdAt": "2020-02-27T05:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1NjIwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d24602f1f6ee024528319c0bf5b4760efdfaa22", "chunk": "diff --git a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\nindex 049af6abd..9c5241d68 100644\n--- a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n+++ b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n\n@@ -182,12 +182,12 @@ public class FileSystemManager {\n         String password = properties.getOrDefault(PASSWORD_KEY, \"\");\n         String dfsNameServices = properties.getOrDefault(DFS_NAMESERVICES_KEY, \"\");\n         String authentication = properties.getOrDefault(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,\n-                AUTHENTICATION_SIMPLE);\n+            AUTHENTICATION_SIMPLE);\n         if (Strings.isNullOrEmpty(authentication) || (!authentication.equals(AUTHENTICATION_SIMPLE)\n-                && !authentication.equals(AUTHENTICATION_KERBEROS))) {\n+            && !authentication.equals(AUTHENTICATION_KERBEROS))) {\n             logger.warn(\"invalid authentication:\" + authentication);\n             throw new BrokerException(TBrokerOperationStatusCode.INVALID_ARGUMENT,\n-                    \"invalid authentication:\" + authentication);\n+                \"invalid authentication:\" + authentication);\n         }\n         String hdfsUgi = username + \",\" + password;\n         FileSystemIdentity fileSystemIdentity = null;\n"}}, {"oid": "1d24602f1f6ee024528319c0bf5b4760efdfaa22", "url": "https://github.com/apache/incubator-doris/commit/1d24602f1f6ee024528319c0bf5b4760efdfaa22", "message": "BrokerLoad support AmazonS3 data source", "committedDate": "2020-02-27T05:40:30Z", "type": "commit"}, {"oid": "f49dd48d76bc1e244a077d8e80afdf29da1b1832", "url": "https://github.com/apache/incubator-doris/commit/f49dd48d76bc1e244a077d8e80afdf29da1b1832", "message": "BrokerLoad support AmazonS3 data source", "committedDate": "2020-02-27T06:43:04Z", "type": "commit"}]}