{"pr_number": 4808, "pr_title": "[optimize] optimize default value for thriftserver's config key \"thrift_client_timeout_ms\"", "pr_createdAt": "2020-10-27T13:54:55Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4808", "timeline": [{"oid": "c6404c1b3754b59f814a53b1fd012ecebe7d12af", "url": "https://github.com/apache/incubator-doris/commit/c6404c1b3754b59f814a53b1fd012ecebe7d12af", "message": "Merge pull request #1 from apache/master\n\nPull from Apache", "committedDate": "2020-07-02T03:51:31Z", "type": "commit"}, {"oid": "e90a7832f01fd351fe8996b596030bb6332f25ac", "url": "https://github.com/apache/incubator-doris/commit/e90a7832f01fd351fe8996b596030bb6332f25ac", "message": "Merge pull request #2 from apache/master\n\nfrom master", "committedDate": "2020-08-16T02:10:57Z", "type": "commit"}, {"oid": "6e104ef50fb6c26f2b8c792c45629e1d8ba44384", "url": "https://github.com/apache/incubator-doris/commit/6e104ef50fb6c26f2b8c792c45629e1d8ba44384", "message": "Merge pull request #3 from apache/master\n\nmerge from apache", "committedDate": "2020-09-30T15:20:27Z", "type": "commit"}, {"oid": "dd2ed06b0f18e1b94f26817d9c01fb185b9b2354", "url": "https://github.com/apache/incubator-doris/commit/dd2ed06b0f18e1b94f26817d9c01fb185b9b2354", "message": "Merge pull request #4 from apache/master\n\n[Bug] Fix Windows function lag()/lead() function throw AnalysisExcept\u2026", "committedDate": "2020-10-06T08:12:38Z", "type": "commit"}, {"oid": "7740c473724b3b6fe51ae1627a863dbcb90ae950", "url": "https://github.com/apache/incubator-doris/commit/7740c473724b3b6fe51ae1627a863dbcb90ae950", "message": "Merge pull request #5 from apache/master\n\nmerge from master", "committedDate": "2020-10-14T03:14:59Z", "type": "commit"}, {"oid": "95c2bd1150da4374d8e828fdaa23b2bebd4bc5f2", "url": "https://github.com/apache/incubator-doris/commit/95c2bd1150da4374d8e828fdaa23b2bebd4bc5f2", "message": "Merge pull request #7 from apache/master\n\nmerge from master", "committedDate": "2020-10-27T13:46:36Z", "type": "commit"}, {"oid": "e8330afaaebdbc4b5d3e623ac3215b27bdb4c800", "url": "https://github.com/apache/incubator-doris/commit/e8330afaaebdbc4b5d3e623ac3215b27bdb4c800", "message": "optimize  default value for thrift server's config key \"thrift_client_timeout_ms\"", "committedDate": "2020-10-27T13:53:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzM3MA==", "url": "https://github.com/apache/incubator-doris/pull/4808#discussion_r513143370", "bodyText": "when will fe close the socket frequently?", "author": "chaoyli", "createdAt": "2020-10-28T02:32:52Z", "path": "fe/fe-core/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -318,8 +318,10 @@\n      * The connection timeout and socket timeout config for thrift server\n      * The value for thrift_client_timeout_ms is set to be larger than zero to prevent\n      * some hang up problems in java.net.SocketInputStream.socketRead0\n+     * \n+     * make it one hour to avoid fe close the socket so frequently, that be will retry to cost more time\n      */\n-    @ConfField public static int thrift_client_timeout_ms = 30000;", "originalCommit": "e8330afaaebdbc4b5d3e623ac3215b27bdb4c800", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU4MzY2MQ==", "url": "https://github.com/apache/incubator-doris/pull/4808#discussion_r513583661", "bodyText": "in our case, query information_schema.tables.  i find fe would send a TCP RST command(try tcpdump 9020 in fe) to be to close the socket becasuse of thrift_client_timeout_ms is meet, the be log comes \"no more data to read\", the be would retry in 1s(default).", "author": "francisoliverlee", "createdAt": "2020-10-28T16:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzM3MA=="}], "type": "inlineReview", "revised_code": {"commit": "f7537fbfe6e238eedddbfcaa3ea9ac8263b1a9f8", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/common/Config.java b/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\nindex 8dbddc640..01a71aa81 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\n\n@@ -315,13 +315,14 @@ public class Config extends ConfigBase {\n     @ConfField public static int mysql_nio_backlog_num = 1024;\n \n     /**\n-     * The connection timeout and socket timeout config for thrift server\n-     * The value for thrift_client_timeout_ms is set to be larger than zero to prevent\n-     * some hang up problems in java.net.SocketInputStream.socketRead0\n-     * \n-     * make it one hour to avoid fe close the socket so frequently, that be will retry to cost more time\n+     * The connection timeout and socket timeout config between thrift server and client.\n+     * 0 for keep-alive always;\n+     * larger than 0 means the socket connection will keep for thrift_client_timeout_ms millisecond.\n+     *\n+     * if socket connection timeout, FE would send TCP RST command to BE,\n+     * BE will retry to connect FE, retry delay can be config in BE's config key thrift_client_retry_interval_ms(default 1000ms).\n      */\n-    @ConfField public static int thrift_client_timeout_ms = 3600000;\n+    @ConfField public static int thrift_client_timeout_ms = 0;\n \n     /**\n      * The backlog_num for thrift server\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyNzg5Mg==", "url": "https://github.com/apache/incubator-doris/pull/4808#discussion_r514927892", "bodyText": "The connection timeout and socket timeout config for thrift server\nThe default value for thrift_client_timeout_ms is set to be zero to prevent readtimeout\n\n@ConfField public static int thrift_client_timeout_ms = 0;", "author": "caiconghui", "createdAt": "2020-10-30T08:06:36Z", "path": "fe/fe-core/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -318,8 +318,10 @@\n      * The connection timeout and socket timeout config for thrift server\n      * The value for thrift_client_timeout_ms is set to be larger than zero to prevent\n      * some hang up problems in java.net.SocketInputStream.socketRead0\n+     * ", "originalCommit": "e8330afaaebdbc4b5d3e623ac3215b27bdb4c800", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7537fbfe6e238eedddbfcaa3ea9ac8263b1a9f8", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/common/Config.java b/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\nindex 8dbddc640..01a71aa81 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/common/Config.java\n\n@@ -315,13 +315,14 @@ public class Config extends ConfigBase {\n     @ConfField public static int mysql_nio_backlog_num = 1024;\n \n     /**\n-     * The connection timeout and socket timeout config for thrift server\n-     * The value for thrift_client_timeout_ms is set to be larger than zero to prevent\n-     * some hang up problems in java.net.SocketInputStream.socketRead0\n-     * \n-     * make it one hour to avoid fe close the socket so frequently, that be will retry to cost more time\n+     * The connection timeout and socket timeout config between thrift server and client.\n+     * 0 for keep-alive always;\n+     * larger than 0 means the socket connection will keep for thrift_client_timeout_ms millisecond.\n+     *\n+     * if socket connection timeout, FE would send TCP RST command to BE,\n+     * BE will retry to connect FE, retry delay can be config in BE's config key thrift_client_retry_interval_ms(default 1000ms).\n      */\n-    @ConfField public static int thrift_client_timeout_ms = 3600000;\n+    @ConfField public static int thrift_client_timeout_ms = 0;\n \n     /**\n      * The backlog_num for thrift server\n"}}, {"oid": "f7537fbfe6e238eedddbfcaa3ea9ac8263b1a9f8", "url": "https://github.com/apache/incubator-doris/commit/f7537fbfe6e238eedddbfcaa3ea9ac8263b1a9f8", "message": "update default value for thrift_client_timeout_ms", "committedDate": "2020-10-30T08:52:07Z", "type": "commit"}, {"oid": "146a73befd601dcb64d1bd3f4d69d53103c9e999", "url": "https://github.com/apache/incubator-doris/commit/146a73befd601dcb64d1bd3f4d69d53103c9e999", "message": "update default value for thrift_client_timeout_ms", "committedDate": "2020-10-30T08:56:21Z", "type": "commit"}]}