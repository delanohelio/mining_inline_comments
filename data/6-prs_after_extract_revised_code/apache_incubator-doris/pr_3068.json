{"pr_number": 3068, "pr_title": "Support delete materialized view", "pr_createdAt": "2020-03-10T08:48:35Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3068", "timeline": [{"oid": "7c57f0dcc0c6b63ba6028dc51fec21841e987bbb", "url": "https://github.com/apache/incubator-doris/commit/7c57f0dcc0c6b63ba6028dc51fec21841e987bbb", "message": "Support delete materialized view\n\nDROP MATERIALIZE VIEW [ IF EXISTS ] <mv_name> ON [db_name].<table_name>\nParameters\n  IF EXISTS: Do not throw an error if the materialized view does not exist. A notice is issued in this case.\n  mv_name: The name of the materialized view to remove.\n  db_name: The name of db to which materialized view belongs.\n  table_name: The name of table to which materialized view belongs.\n\nAdd the check of keystype in create mv stmt test", "committedDate": "2020-03-10T08:47:25Z", "type": "commit"}, {"oid": "edf08516cc1540cdb32c627a3081388d47c8a2fe", "url": "https://github.com/apache/incubator-doris/commit/edf08516cc1540cdb32c627a3081388d47c8a2fe", "message": "Add unit test", "committedDate": "2020-03-10T09:09:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxNTUzMQ==", "url": "https://github.com/apache/incubator-doris/pull/3068#discussion_r390315531", "bodyText": "No need to check table's stable when dropping mv.", "author": "morningman", "createdAt": "2020-03-10T13:35:07Z", "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -107,24 +114,38 @@ public void processCreateMaterializedView(CreateMaterializedViewStmt stmt) throw\n                 throw new DdlException(\"Do not support alter non-OLAP table[\" + tableName + \"]\");\n             }\n             OlapTable olapTable = (OlapTable) table;\n+            olapTable.checkStableAndNormal(db.getClusterName());\n \n-            if (olapTable.getState() != OlapTableState.NORMAL) {\n-                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n-                                               + \"Do not allow doing materialized view\");\n+            ((MaterializedViewHandler)materializedViewHandler).processCreateMaterializedView(stmt, db, olapTable);\n+        } finally {\n+            db.writeUnlock();\n+        }\n+    }\n+\n+    public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws DdlException, MetaNotFoundException {\n+        // check db\n+        String dbName = stmt.getTableName().getDb();\n+        Database db = Catalog.getInstance().getDb(dbName);\n+        if (db == null) {\n+            ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n+        }\n+\n+        db.writeLock();\n+        try {\n+            String tableName = stmt.getTableName().getTbl();\n+            Table table = db.getTable(tableName);\n+            if (table == null) {\n+                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n             }\n-            // check if all tablets are healthy, and no tablet is in tablet scheduler\n-            boolean isStable = olapTable.isStable(Catalog.getCurrentSystemInfo(),\n-                                                  Catalog.getCurrentCatalog().getTabletScheduler(),\n-                                                  db.getClusterName());\n-            if (!isStable) {\n-                throw new DdlException(\"table [\" + olapTable.getName() + \"] is not stable.\"\n-                                               + \" Some tablets of this table may not be healthy or are being \"\n-                                               + \"scheduled.\"\n-                                               + \" You need to repair the table first\"\n-                                               + \" or stop cluster balance. See 'help admin;'.\");\n+\n+            if (table.getType() != TableType.OLAP) {\n+                throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n             }\n \n-            ((MaterializedViewHandler)materializedViewHandler).processCreateMaterializedView(stmt, db, olapTable);\n+            OlapTable olapTable = (OlapTable) table;\n+            olapTable.checkStableAndNormal(db.getClusterName());", "originalCommit": "edf08516cc1540cdb32c627a3081388d47c8a2fe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3b2918ee9d04305a6825c68725d3740b8f27ca21", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/alter/Alter.java b/fe/src/main/java/org/apache/doris/alter/Alter.java\nindex 14c384946..4edbbe177 100644\n--- a/fe/src/main/java/org/apache/doris/alter/Alter.java\n+++ b/fe/src/main/java/org/apache/doris/alter/Alter.java\n\n@@ -134,16 +134,22 @@ public class Alter {\n         try {\n             String tableName = stmt.getTableName().getTbl();\n             Table table = db.getTable(tableName);\n+            // if table exists\n             if (table == null) {\n                 ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n             }\n-\n+            // check table type\n             if (table.getType() != TableType.OLAP) {\n                 throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n             }\n-\n+            // check table state\n             OlapTable olapTable = (OlapTable) table;\n-            olapTable.checkStableAndNormal(db.getClusterName());\n+            if (olapTable.getState() != OlapTableState.NORMAL) {\n+                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n+                        + \"Do not allow doing DROP ops\");\n+            }\n+\n+            // drop materialized view\n             ((MaterializedViewHandler)materializedViewHandler).processDropMaterializedView(stmt, db, olapTable);\n \n         } finally {\n"}}, {"oid": "3b2918ee9d04305a6825c68725d3740b8f27ca21", "url": "https://github.com/apache/incubator-doris/commit/3b2918ee9d04305a6825c68725d3740b8f27ca21", "message": "Remove check tablet stable", "committedDate": "2020-03-11T02:48:28Z", "type": "commit"}, {"oid": "0f71d2c3eb23d8dc0f2ed98a4349bf8b6ae1a347", "url": "https://github.com/apache/incubator-doris/commit/0f71d2c3eb23d8dc0f2ed98a4349bf8b6ae1a347", "message": "Forbidden then same column with different aggregation function", "committedDate": "2020-03-11T03:04:08Z", "type": "commit"}, {"oid": "54bf241f412a07c69d59dc9c35c78f7d8a9c28cf", "url": "https://github.com/apache/incubator-doris/commit/54bf241f412a07c69d59dc9c35c78f7d8a9c28cf", "message": "Remove unused import", "committedDate": "2020-03-11T04:42:03Z", "type": "commit"}, {"oid": "61b87b1776498639b0f3c2834d4a9768377f7c14", "url": "https://github.com/apache/incubator-doris/commit/61b87b1776498639b0f3c2834d4a9768377f7c14", "message": "Fix unit test", "committedDate": "2020-03-11T06:09:40Z", "type": "commit"}]}