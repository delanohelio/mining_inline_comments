{"pr_number": 3106, "pr_title": "[Alter] Alter job got stuck because of table is untable", "pr_createdAt": "2020-03-13T10:15:37Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3106", "timeline": [{"oid": "1269529ebe1f43879758360408db9e7bbbbcd4a5", "url": "https://github.com/apache/incubator-doris/commit/1269529ebe1f43879758360408db9e7bbbbcd4a5", "message": "1", "committedDate": "2020-03-13T08:27:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1OTkyMQ==", "url": "https://github.com/apache/incubator-doris/pull/3106#discussion_r392159921", "bodyText": "Could we reduce the write lock scope? because the tbl.isStable and CreateReplicaTask both need to iterate every replica.", "author": "kangkaisen", "createdAt": "2020-03-13T10:58:43Z", "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "diffHunk": "@@ -162,7 +162,7 @@ protected void runPendingJob() throws AlterCancelException {\n             }\n         }\n         MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<Long, Long>(totalReplicaNum);\n-        db.readLock();\n+        db.writeLock();", "originalCommit": "1269529ebe1f43879758360408db9e7bbbbcd4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwODQzOA==", "url": "https://github.com/apache/incubator-doris/pull/3106#discussion_r392208438", "bodyText": "OK, I will modify this.", "author": "morningman", "createdAt": "2020-03-13T12:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1OTkyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/alter/RollupJobV2.java b/fe/src/main/java/org/apache/doris/alter/RollupJobV2.java\nindex 0fc91a564..daddd9a47 100644\n--- a/fe/src/main/java/org/apache/doris/alter/RollupJobV2.java\n+++ b/fe/src/main/java/org/apache/doris/alter/RollupJobV2.java\n\n@@ -169,19 +173,6 @@ public class RollupJobV2 extends AlterJobV2 {\n                 throw new AlterCancelException(\"Table \" + tableId + \" does not exist\");\n             }\n \n-            boolean isStable = tbl.isStable(Catalog.getCurrentSystemInfo(),\n-                    Catalog.getCurrentCatalog().getTabletScheduler(),\n-                    db.getClusterName());\n-            if (!isStable) {\n-                errMsg = \"table is unstable\";\n-                LOG.warn(\"doing rollup job: \" + jobId + \" while table is not stable.\");\n-                tbl.setState(OlapTableState.WAITING_STABLE);\n-                return;\n-            } else {\n-                // table is stable, set is to ROLLUP and begin altering.\n-                tbl.setState(OlapTableState.ROLLUP);\n-            }\n-\n             Preconditions.checkState(tbl.getState() == OlapTableState.ROLLUP);\n             for (Map.Entry<Long, MaterializedIndex> entry : this.partitionIdToRollupIndex.entrySet()) {\n                 long partitionId = entry.getKey();\n"}}, {"oid": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "url": "https://github.com/apache/incubator-doris/commit/96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "message": "fix by review", "committedDate": "2020-03-13T13:39:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI5NDgxNQ==", "url": "https://github.com/apache/incubator-doris/pull/3106#discussion_r392294815", "bodyText": "Should still use db.readLock.", "author": "kangkaisen", "createdAt": "2020-03-13T15:21:04Z", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -185,22 +189,13 @@ protected void runPendingJob() throws AlterCancelException {\n             }\n         }\n         MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<>(totalReplicaNum);\n-        db.readLock();\n+        db.writeLock();", "originalCommit": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "360ede6cf3a378bc99a5759e360597cf59d7e2c2", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java b/fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java\nindex 5dcfd88a6..2d35b5ceb 100644\n--- a/fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java\n+++ b/fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java\n\n@@ -189,7 +189,7 @@ public class SchemaChangeJobV2 extends AlterJobV2 {\n             }\n         }\n         MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<>(totalReplicaNum);\n-        db.writeLock();\n+        db.readLock();\n         try {\n             OlapTable tbl = (OlapTable) db.getTable(tableId);\n             if (tbl == null) {\n"}}, {"oid": "360ede6cf3a378bc99a5759e360597cf59d7e2c2", "url": "https://github.com/apache/incubator-doris/commit/360ede6cf3a378bc99a5759e360597cf59d7e2c2", "message": "fix log", "committedDate": "2020-03-14T13:01:35Z", "type": "commit"}]}