{"pr_number": 3444, "pr_title": "[Bug][AuditPlugin] Fix bug that length of query stmt in audit should less than limit.", "pr_createdAt": "2020-04-30T08:42:52Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3444", "timeline": [{"oid": "80827aa19dc1166cbc0bb838775aae09eeefbb6d", "url": "https://github.com/apache/incubator-doris/commit/80827aa19dc1166cbc0bb838775aae09eeefbb6d", "message": "fix bug", "committedDate": "2020-04-30T08:40:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg3MjIxMw==", "url": "https://github.com/apache/incubator-doris/pull/3444#discussion_r417872213", "bodyText": "Could you replace 2000 with a configuration or a static final variable?", "author": "imay", "createdAt": "2020-04-30T09:18:39Z", "path": "fe_plugins/auditloader/src/main/java/org/apache/doris/plugin/audit/AuditLoaderPlugin.java", "diffHunk": "@@ -143,8 +143,9 @@ private void assembleAudit(AuditEvent event) {\n         auditBuffer.append(event.isQuery ? 1 : 0).append(\"\\t\");\n         auditBuffer.append(event.feIp).append(\"\\t\");\n         // trim the query to avoid too long\n-        int maxLen = Math.min(2048, event.stmt.length());\n-        String stmt = event.stmt.substring(0, maxLen).replace(\"\\t\", \" \");\n+        // use `getBytes().length` to get real byte length\n+        int maxLen = Math.min(2000, event.stmt.getBytes().length);", "originalCommit": "80827aa19dc1166cbc0bb838775aae09eeefbb6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MDczMA==", "url": "https://github.com/apache/incubator-doris/pull/3444#discussion_r418080730", "bodyText": "done", "author": "morningman", "createdAt": "2020-04-30T15:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg3MjIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "83cbbab9911d54c2d34cdd79e04b046fa01f70db", "chunk": "diff --git a/fe_plugins/auditloader/src/main/java/org/apache/doris/plugin/audit/AuditLoaderPlugin.java b/fe_plugins/auditloader/src/main/java/org/apache/doris/plugin/audit/AuditLoaderPlugin.java\nindex 1beed42a2..69df3fa6c 100755\n--- a/fe_plugins/auditloader/src/main/java/org/apache/doris/plugin/audit/AuditLoaderPlugin.java\n+++ b/fe_plugins/auditloader/src/main/java/org/apache/doris/plugin/audit/AuditLoaderPlugin.java\n\n@@ -144,7 +147,7 @@ public class AuditLoaderPlugin extends Plugin implements AuditPlugin {\n         auditBuffer.append(event.feIp).append(\"\\t\");\n         // trim the query to avoid too long\n         // use `getBytes().length` to get real byte length\n-        int maxLen = Math.min(2000, event.stmt.getBytes().length);\n+        int maxLen = Math.min(MAX_STMT_LENGTH, event.stmt.getBytes().length);\n         String stmt = new String(event.stmt.getBytes(), 0, maxLen).replace(\"\\t\", \" \");\n         LOG.debug(\"receive audit event with stmt: {}\", stmt);\n         auditBuffer.append(stmt).append(\"\\n\");\n"}}, {"oid": "83cbbab9911d54c2d34cdd79e04b046fa01f70db", "url": "https://github.com/apache/incubator-doris/commit/83cbbab9911d54c2d34cdd79e04b046fa01f70db", "message": "fix by review", "committedDate": "2020-04-30T15:04:34Z", "type": "commit"}, {"oid": "bfb2d05921dbce632e754a79a27982c3b626e4e6", "url": "https://github.com/apache/incubator-doris/commit/bfb2d05921dbce632e754a79a27982c3b626e4e6", "message": "fix ut", "committedDate": "2020-04-30T15:27:10Z", "type": "commit"}]}