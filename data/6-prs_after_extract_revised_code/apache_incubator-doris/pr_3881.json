{"pr_number": 3881, "pr_title": "[BUG]Fix broker read buffer size from input stream", "pr_createdAt": "2020-06-16T02:41:00Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3881", "timeline": [{"oid": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279", "url": "https://github.com/apache/incubator-doris/commit/fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279", "message": "fix broker read buffer size", "committedDate": "2020-06-16T02:21:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2MDkwNw==", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r440560907", "bodyText": "Maybe too many logs here.", "author": "yiguolei", "createdAt": "2020-06-16T03:12:14Z", "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -550,19 +550,20 @@ public ByteBuffer pread(TBrokerFD fd, long offset, long length) {\n                             currentStreamOffset, offset);\n                 }\n             }\n-            byte[] buf;\n+            ByteBuffer buf;\n             if (length > readBufferSize) {\n-                buf = new byte[readBufferSize];\n+                buf = ByteBuffer.allocate(readBufferSize);\n             } else {\n-                buf = new byte[(int) length];\n+                buf = ByteBuffer.allocate((int) length);\n             }\n             try {\n-                int readLength = fsDataInputStream.read(buf);\n+                int readLength = readByteBufferFully(fsDataInputStream, buf);\n                 if (readLength < 0) {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                return ByteBuffer.wrap(buf, 0, readLength);\n+                logger.info(\"read length:\" + length + \", readBufferSize:\" + readBufferSize + \", return length:\" + readLength);", "originalCommit": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDczNjE3MQ==", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r440736171", "bodyText": "Turn log level to debug.", "author": "xy720", "createdAt": "2020-06-16T10:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2MDkwNw=="}], "type": "inlineReview", "revised_code": {"commit": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "chunk": "diff --git a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\nindex 17c59706b..6e6a8d7f2 100644\n--- a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n+++ b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n\n@@ -562,7 +562,7 @@ public class FileSystemManager {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                logger.info(\"read length:\" + length + \", readBufferSize:\" + readBufferSize + \", return length:\" + readLength);\n+                logger.debug(\"read buffer from input stream, buffer size:\" + buf.capacity() + \", read length:\" + readLength);\n                 return buf;\n             } catch (IOException e) {\n                 logger.error(\"errors while read data from stream\", e);\n"}}, {"oid": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "url": "https://github.com/apache/incubator-doris/commit/5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "message": "add debug log", "committedDate": "2020-06-16T10:00:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0MzE2Nw==", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r440943167", "bodyText": "if (logger.isDebugEnable()) {\nlogger.debug(\"read buffer from input stream, buffer size: {}, read length: {}\", buf.capacity(), readLength);\n}", "author": "morningman", "createdAt": "2020-06-16T15:29:34Z", "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -550,19 +550,20 @@ public ByteBuffer pread(TBrokerFD fd, long offset, long length) {\n                             currentStreamOffset, offset);\n                 }\n             }\n-            byte[] buf;\n+            ByteBuffer buf;\n             if (length > readBufferSize) {\n-                buf = new byte[readBufferSize];\n+                buf = ByteBuffer.allocate(readBufferSize);\n             } else {\n-                buf = new byte[(int) length];\n+                buf = ByteBuffer.allocate((int) length);\n             }\n             try {\n-                int readLength = fsDataInputStream.read(buf);\n+                int readLength = readByteBufferFully(fsDataInputStream, buf);\n                 if (readLength < 0) {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                return ByteBuffer.wrap(buf, 0, readLength);\n+                logger.debug(\"read buffer from input stream, buffer size:\" + buf.capacity() + \", read length:\" + readLength);", "originalCommit": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1MDU5NQ==", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r441250595", "bodyText": "done", "author": "xy720", "createdAt": "2020-06-17T02:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0MzE2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "800f6666e64421ddc7689c5959bf129de4609749", "chunk": "diff --git a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\nindex 6e6a8d7f2..b286f4d6f 100644\n--- a/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n+++ b/fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java\n\n@@ -562,7 +562,9 @@ public class FileSystemManager {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                logger.debug(\"read buffer from input stream, buffer size:\" + buf.capacity() + \", read length:\" + readLength);\n+\t\t\t\tif (logger.isDebugEnable()) {\n+                    logger.debug(\"read buffer from input stream, buffer size:\" + buf.capacity() + \", read length:\" + readLength);\n+\t\t\t\t}\n                 return buf;\n             } catch (IOException e) {\n                 logger.error(\"errors while read data from stream\", e);\n"}}, {"oid": "800f6666e64421ddc7689c5959bf129de4609749", "url": "https://github.com/apache/incubator-doris/commit/800f6666e64421ddc7689c5959bf129de4609749", "message": "fix debug log", "committedDate": "2020-06-17T02:48:14Z", "type": "commit"}, {"oid": "6e158f31bde522dc3d4b6b7fb7966e285b332c23", "url": "https://github.com/apache/incubator-doris/commit/6e158f31bde522dc3d4b6b7fb7966e285b332c23", "message": "fix tab", "committedDate": "2020-06-18T08:23:19Z", "type": "commit"}]}