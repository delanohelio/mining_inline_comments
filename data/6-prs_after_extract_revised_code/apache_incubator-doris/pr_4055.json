{"pr_number": 4055, "pr_title": "[Doris On ES] Add docvalue limitation for doc_values scan and enable doc_values scan default", "pr_createdAt": "2020-07-09T03:29:50Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4055", "timeline": [{"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "url": "https://github.com/apache/incubator-doris/commit/8241ab66adb777cf15e8cf0ab408844ae725a53a", "message": "[Doris On ES] Add docvalue limitation for doc_values scan", "committedDate": "2020-07-09T03:24:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzI3MA==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983270", "bodyText": "why set 30, not set DEFAULT_MAX_DOCVALUE_FIELDS.", "author": "wutiangan", "createdAt": "2020-07-09T06:05:58Z", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "originalCommit": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzgzMg==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983832", "bodyText": "Oh\uff0cI forget this...", "author": "wuyunfeng", "createdAt": "2020-07-09T06:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzI3MA=="}], "type": "inlineReview", "revised_code": {"commit": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/EsTable.java b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\nindex 63a9786a2..19fa6f1b6 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n\n@@ -335,7 +335,7 @@ public class EsTable extends Table {\n                 try {\n                     maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n                 } catch (Exception e) {\n-                    maxDocValueFields = 30;\n+                    maxDocValueFields = DEFAULT_MAX_DOCVALUE_FIELDS;\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzUwOA==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983508", "bodyText": "\u662f\u4e0d\u662f\u76f4\u63a5\u62a5\u9519\u5f97\u4e86\uff1f\u6211\u4eec\u4e0d\u5141\u8bb8\u8fd9\u7c7b\u4f4e\u7ea7\u9519\u8bef\u3002\u6bd4\u5982\u8bbe\u7f6e\u4e3a0\u6216\u8005-1. \u53ef\u80fd\u7528\u6237\u60f3\u5173\u95eddocvalue\u67e5\u8be2\uff1f", "author": "blackfox1983", "createdAt": "2020-07-09T06:06:34Z", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -194,6 +219,17 @@ private void validate(Map<String, String> properties) throws DdlException {\n                         + \" but value is \" + transport);\n             }\n         }\n+\n+        if (properties.containsKey(MAX_DOCVALUE_FIELDS)) {\n+            try {\n+                maxDocValueFields = Integer.parseInt(properties.get(MAX_DOCVALUE_FIELDS).trim());\n+                if (maxDocValueFields < 1) {\n+                    maxDocValueFields = 1;", "originalCommit": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk5MTQwMA==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451991400", "bodyText": "\u53ef\u4ee5\u8bbe\u7f6e\u4e3a0\uff0c\u4e0d\u8fc7\u63a7\u5236\u5f00\u5173\u7684\u8bdd\u8fd8\u662f\u7528\u4e0a\u9762\u90a3\u4e2a\uff1f", "author": "wuyunfeng", "createdAt": "2020-07-09T06:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzUwOA=="}], "type": "inlineReview", "revised_code": {"commit": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/EsTable.java b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\nindex 63a9786a2..19fa6f1b6 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n\n@@ -223,8 +223,8 @@ public class EsTable extends Table {\n         if (properties.containsKey(MAX_DOCVALUE_FIELDS)) {\n             try {\n                 maxDocValueFields = Integer.parseInt(properties.get(MAX_DOCVALUE_FIELDS).trim());\n-                if (maxDocValueFields < 1) {\n-                    maxDocValueFields = 1;\n+                if (maxDocValueFields < 0) {\n+                    maxDocValueFields = 0;\n                 }\n             } catch (Exception e) {\n                 maxDocValueFields = DEFAULT_MAX_DOCVALUE_FIELDS;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzY0NA==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983644", "bodyText": "if the tableContext don't contain \"maxDocValueFields\", the maxDocValueFields should set Default_max_docvaues_fields or set MaxInt.", "author": "wutiangan", "createdAt": "2020-07-09T06:07:01Z", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;\n+                }\n+            }", "originalCommit": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/EsTable.java b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\nindex 63a9786a2..19fa6f1b6 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n\n@@ -335,7 +335,7 @@ public class EsTable extends Table {\n                 try {\n                     maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n                 } catch (Exception e) {\n-                    maxDocValueFields = 30;\n+                    maxDocValueFields = DEFAULT_MAX_DOCVALUE_FIELDS;\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzc0OQ==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983749", "bodyText": "\u8fd9\u4e2a\u5730\u65b9\u662f\u4e0d\u662f\u53ef\u4ee5\u4f7f\u7528\u5b9a\u4e49\u7684\u503c\uff1fDEFAULT_MAX_DOC_VALUS_FILEDS", "author": "blackfox1983", "createdAt": "2020-07-09T06:07:23Z", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "originalCommit": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzk5NQ==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983995", "bodyText": "\u662f\u7684\uff0c\u6211\u5fd8\u4e86", "author": "wuyunfeng", "createdAt": "2020-07-09T06:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzc0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/EsTable.java b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\nindex 63a9786a2..19fa6f1b6 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/EsTable.java\n\n@@ -335,7 +335,7 @@ public class EsTable extends Table {\n                 try {\n                     maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n                 } catch (Exception e) {\n-                    maxDocValueFields = 30;\n+                    maxDocValueFields = DEFAULT_MAX_DOCVALUE_FIELDS;\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDM2Mw==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984363", "bodyText": "\u6211\u4e0d\u592a\u786e\u5b9a fe\u901a\u8fc7thrift\u4f20\u9012\u7ed9be\u7684\u53c2\u6570\u662f\u5426\u652f\u6301bool\u3002\u8fd9\u4e2a\u5730\u65b9\u8bfb\u8d77\u6765bool\u66f4\u76f4\u89c2\u3002\n\u5426\u5219\u6211\u5f97\u5e26\u7740c++\u7684\u601d\u7ef4\u53bb\u7406\u89e3\u3002\uff081\u662ftrue\uff0c0\u662ffalse\uff09", "author": "blackfox1983", "createdAt": "2020-07-09T06:09:21Z", "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -109,6 +110,34 @@ public void finalize(Analyzer analyzer) throws UserException {\n         isFinalized = true;\n     }\n \n+    /**\n+     * return whether can use the doc_values scan\n+     * 0 and 1 are returned to facilitate Doris BE processing", "originalCommit": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDY4NA==", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984684", "bodyText": "\u8fd9\u548c\u4f20\u9012\u6ca1\u6709\u5173\u7cfb\uff0c\u56e0\u4e3a\u6709\u4e00\u4e2amap\u7ed3\u6784\u5f53\u65f6\u7559\u7740\u5c31\u662f\u4e3a\u4e86\u5728\u4e0d\u6539thrift\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\u5bb9\u6613\u6269\u5c55", "author": "wuyunfeng", "createdAt": "2020-07-09T06:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDM2Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "url": "https://github.com/apache/incubator-doris/commit/06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "message": "[Doris On ES] Add docvalue limitation for doc_values scan", "committedDate": "2020-07-09T06:30:22Z", "type": "commit"}, {"oid": "c5b2f17fc984609e0b938d32af1f0b1bac4d898c", "url": "https://github.com/apache/incubator-doris/commit/c5b2f17fc984609e0b938d32af1f0b1bac4d898c", "message": "[Doris On ES] Add docvalue limitation for doc_values scan", "committedDate": "2020-07-09T06:47:48Z", "type": "commit"}]}