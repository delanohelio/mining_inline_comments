{"pr_number": 4796, "pr_title": "[BUG] Catch retry submit exception", "pr_createdAt": "2020-10-26T13:52:08Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4796", "timeline": [{"oid": "1a15f533098eec6708121004ef835d111dc374f3", "url": "https://github.com/apache/incubator-doris/commit/1a15f533098eec6708121004ef835d111dc374f3", "message": "udf: replace function", "committedDate": "2020-08-13T14:09:31Z", "type": "commit"}, {"oid": "7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "url": "https://github.com/apache/incubator-doris/commit/7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-14T01:37:05Z", "type": "commit"}, {"oid": "391158f52190755b5fc621c31bf703835c0a7b3b", "url": "https://github.com/apache/incubator-doris/commit/391158f52190755b5fc621c31bf703835c0a7b3b", "message": "udf: replace function", "committedDate": "2020-08-14T02:11:25Z", "type": "commit"}, {"oid": "5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "url": "https://github.com/apache/incubator-doris/commit/5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "message": "udf: replace function", "committedDate": "2020-08-14T03:58:30Z", "type": "commit"}, {"oid": "a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "url": "https://github.com/apache/incubator-doris/commit/a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-18T02:31:52Z", "type": "commit"}, {"oid": "86f841f29fa4ee19773d6c5922465194a2887cf6", "url": "https://github.com/apache/incubator-doris/commit/86f841f29fa4ee19773d6c5922465194a2887cf6", "message": "udf: replace function", "committedDate": "2020-08-18T03:56:14Z", "type": "commit"}, {"oid": "ade1afa75c94a178a6801ba1324acf25ad8b16fe", "url": "https://github.com/apache/incubator-doris/commit/ade1afa75c94a178a6801ba1324acf25ad8b16fe", "message": "udf: replace function", "committedDate": "2020-08-18T03:59:59Z", "type": "commit"}, {"oid": "1d95a491115064c9753694ad4d45c2f72b8d2645", "url": "https://github.com/apache/incubator-doris/commit/1d95a491115064c9753694ad4d45c2f72b8d2645", "message": "udf: replace function", "committedDate": "2020-08-18T08:01:45Z", "type": "commit"}, {"oid": "433eb87f02cfa6740e80b0e4157d916ab5aca400", "url": "https://github.com/apache/incubator-doris/commit/433eb87f02cfa6740e80b0e4157d916ab5aca400", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-24T02:03:34Z", "type": "commit"}, {"oid": "c62d239792b174fbc56ab311f0bc5337de971d96", "url": "https://github.com/apache/incubator-doris/commit/c62d239792b174fbc56ab311f0bc5337de971d96", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T03:17:32Z", "type": "commit"}, {"oid": "0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "url": "https://github.com/apache/incubator-doris/commit/0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T08:21:34Z", "type": "commit"}, {"oid": "02d3f863c8556463c8dea903abdc4d21bf1eb19b", "url": "https://github.com/apache/incubator-doris/commit/02d3f863c8556463c8dea903abdc4d21bf1eb19b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-01T01:25:42Z", "type": "commit"}, {"oid": "41da0ba0109414c47239f3fb926da48540059018", "url": "https://github.com/apache/incubator-doris/commit/41da0ba0109414c47239f3fb926da48540059018", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-08T08:25:12Z", "type": "commit"}, {"oid": "de4e523b505f0d628a16199b88d4bb5a0419fef6", "url": "https://github.com/apache/incubator-doris/commit/de4e523b505f0d628a16199b88d4bb5a0419fef6", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-11T02:42:20Z", "type": "commit"}, {"oid": "a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "url": "https://github.com/apache/incubator-doris/commit/a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-17T09:37:21Z", "type": "commit"}, {"oid": "024c422b74829efe4c4b715a014517c7eee1a80a", "url": "https://github.com/apache/incubator-doris/commit/024c422b74829efe4c4b715a014517c7eee1a80a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-22T09:15:31Z", "type": "commit"}, {"oid": "e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "url": "https://github.com/apache/incubator-doris/commit/e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-23T11:48:49Z", "type": "commit"}, {"oid": "837e037057936e933fd79cbbdb432047be2bba5e", "url": "https://github.com/apache/incubator-doris/commit/837e037057936e933fd79cbbdb432047be2bba5e", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-27T06:37:32Z", "type": "commit"}, {"oid": "a36d3e78136a3fefb62f2513d20773479904cb6b", "url": "https://github.com/apache/incubator-doris/commit/a36d3e78136a3fefb62f2513d20773479904cb6b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-17T10:32:25Z", "type": "commit"}, {"oid": "43cfa2b2ca752118c43a0212cf074f09cb311a7a", "url": "https://github.com/apache/incubator-doris/commit/43cfa2b2ca752118c43a0212cf074f09cb311a7a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-23T14:34:47Z", "type": "commit"}, {"oid": "641efb587d2e9ac9a9e9771e7648a299a66f3992", "url": "https://github.com/apache/incubator-doris/commit/641efb587d2e9ac9a9e9771e7648a299a66f3992", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-24T12:49:28Z", "type": "commit"}, {"oid": "5066131b9017910473554dfa298b16224c1977da", "url": "https://github.com/apache/incubator-doris/commit/5066131b9017910473554dfa298b16224c1977da", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-26T11:49:19Z", "type": "commit"}, {"oid": "c1e58d5db9e462a0c0a0310feef7bbae81f75eaf", "url": "https://github.com/apache/incubator-doris/commit/c1e58d5db9e462a0c0a0310feef7bbae81f75eaf", "message": "unused importe", "committedDate": "2020-10-26T12:19:52Z", "type": "commit"}, {"oid": "e4405e4c777fda98c47bca926cb384bc85f2365c", "url": "https://github.com/apache/incubator-doris/commit/e4405e4c777fda98c47bca926cb384bc85f2365c", "message": "cat exception", "committedDate": "2020-10-26T13:08:39Z", "type": "commit"}, {"oid": "9145509113efa219a9495aee8d564cb2420604a6", "url": "https://github.com/apache/incubator-doris/commit/9145509113efa219a9495aee8d564cb2420604a6", "message": "update", "committedDate": "2020-10-26T13:25:08Z", "type": "commit"}, {"oid": "42c7c6d6e0cff8e4fe52f3e2b935de51795a76fc", "url": "https://github.com/apache/incubator-doris/commit/42c7c6d6e0cff8e4fe52f3e2b935de51795a76fc", "message": "update", "committedDate": "2020-10-26T13:28:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MzQxNQ==", "url": "https://github.com/apache/incubator-doris/pull/4796#discussion_r512373415", "bodyText": "The code is redundant:\n                        idToTasks.remove(loadTask.getSignature());\n                        if (loadTask instanceof LoadLoadingTask) {\n                            loadStatistic.removeLoad(((LoadLoadingTask) loadTask).getLoadId());\n                        }\n                        loadTask.updateRetryInfo();\n                        idToTasks.put(loadTask.getSignature(), loadTask);", "author": "kangkaisen", "createdAt": "2020-10-27T02:07:54Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/BulkLoadJob.java", "diffHunk": "@@ -233,7 +233,32 @@ public void onTaskFailed(long taskId, FailMsg failMsg) {\n                 loadTask.updateRetryInfo();\n                 idToTasks.put(loadTask.getSignature(), loadTask);\n                 // load id will be added to loadStatistic when executing this task\n-                Catalog.getCurrentCatalog().getLoadTaskScheduler().submit(loadTask);\n+                boolean retrySuccessFlag = false;\n+                while (loadTask.getRetryTime() > 0) {\n+                    try {\n+                        Catalog.getCurrentCatalog().getLoadTaskScheduler().submit(loadTask);\n+                        retrySuccessFlag = true;\n+                        break;\n+                    } catch (Exception e) {\n+                        try {\n+                            Thread.sleep(100);\n+                        } catch (InterruptedException ex) {\n+                            LOG.warn(\"retry sublit task sleep failed. task_id:{}\", id);\n+                        }\n+                        // retry task", "originalCommit": "42c7c6d6e0cff8e4fe52f3e2b935de51795a76fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyMDgyMQ==", "url": "https://github.com/apache/incubator-doris/pull/4796#discussion_r512420821", "bodyText": "\uff2f\uff2b\uff0c\uff29modified it.", "author": "xinghuayu007", "createdAt": "2020-10-27T05:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MzQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NDI2OQ==", "url": "https://github.com/apache/incubator-doris/pull/4796#discussion_r513164269", "bodyText": "The code is redundant:\n                        idToTasks.remove(loadTask.getSignature());\n                        if (loadTask instanceof LoadLoadingTask) {\n                            loadStatistic.removeLoad(((LoadLoadingTask) loadTask).getLoadId());\n                        }\n                        loadTask.updateRetryInfo();\n                        idToTasks.put(loadTask.getSignature(), loadTask);\n\n\nMaybe, it is better to catch the exception in fe-core/src/main/java/org/apache/doris/task/MasterTaskExecutor.java#submit and return false. But currently, too many calls refer this function, may need too much modfication.", "author": "xinghuayu007", "createdAt": "2020-10-28T03:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MzQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a1a94cc2e097728e0bd62c6a141491b975b8e361", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/BulkLoadJob.java b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/BulkLoadJob.java\nindex 9632281df..d938e04c3 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/BulkLoadJob.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/load/loadv2/BulkLoadJob.java\n\n@@ -243,15 +243,9 @@ public abstract class BulkLoadJob extends LoadJob {\n                         try {\n                             Thread.sleep(100);\n                         } catch (InterruptedException ex) {\n-                            LOG.warn(\"retry sublit task sleep failed. task_id:{}\", id);\n-                        }\n-                        // retry task\n-                        idToTasks.remove(loadTask.getSignature());\n-                        if (loadTask instanceof LoadLoadingTask) {\n-                            loadStatistic.removeLoad(((LoadLoadingTask) loadTask).getLoadId());\n+                            LOG.warn(\"retry submit task sleep failed. task_id:{}\", id);\n                         }\n                         loadTask.updateRetryInfo();\n-                        idToTasks.put(loadTask.getSignature(), loadTask);\n                         continue;\n                     }\n                 }\n"}}, {"oid": "f19894922e26eafd7f7b345858a2d0c746e9906f", "url": "https://github.com/apache/incubator-doris/commit/f19894922e26eafd7f7b345858a2d0c746e9906f", "message": "Merge remote-tracking branch 'upstream/master' into catch_retry_submit_error", "committedDate": "2020-10-27T05:07:43Z", "type": "commit"}, {"oid": "a1a94cc2e097728e0bd62c6a141491b975b8e361", "url": "https://github.com/apache/incubator-doris/commit/a1a94cc2e097728e0bd62c6a141491b975b8e361", "message": "update", "committedDate": "2020-10-27T05:10:11Z", "type": "commit"}, {"oid": "6f8e4074bb761d632d6ac7eb69b87b39fc307ca0", "url": "https://github.com/apache/incubator-doris/commit/6f8e4074bb761d632d6ac7eb69b87b39fc307ca0", "message": "update", "committedDate": "2020-11-05T10:01:49Z", "type": "commit"}, {"oid": "6fbf63cdce0ef326dff397e01f1ed2ceb5611f10", "url": "https://github.com/apache/incubator-doris/commit/6fbf63cdce0ef326dff397e01f1ed2ceb5611f10", "message": "update", "committedDate": "2020-11-05T10:03:30Z", "type": "commit"}]}