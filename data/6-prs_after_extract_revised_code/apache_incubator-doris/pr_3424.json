{"pr_number": 3424, "pr_title": "allow delete duplicated non-key column using delete from ", "pr_createdAt": "2020-04-29T07:02:45Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3424", "timeline": [{"oid": "adacf8007b8b9345bea2210e50e1c482618e2035", "url": "https://github.com/apache/incubator-doris/commit/adacf8007b8b9345bea2210e50e1c482618e2035", "message": "add unit test", "committedDate": "2020-04-29T11:28:26Z", "type": "forcePushed"}, {"oid": "06896596fa4389ab53cb67841b30ac78f57c4811", "url": "https://github.com/apache/incubator-doris/commit/06896596fa4389ab53cb67841b30ac78f57c4811", "message": "fix typo", "committedDate": "2020-04-30T03:38:30Z", "type": "forcePushed"}, {"oid": "ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "url": "https://github.com/apache/incubator-doris/commit/ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "message": "fix bug", "committedDate": "2020-05-06T07:59:15Z", "type": "forcePushed"}, {"oid": "2cbfd62af8df1ba740326259b6708b876ba2fece", "url": "https://github.com/apache/incubator-doris/commit/2cbfd62af8df1ba740326259b6708b876ba2fece", "message": "allow delete duplicated non-key column", "committedDate": "2020-05-07T05:05:52Z", "type": "forcePushed"}, {"oid": "ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "url": "https://github.com/apache/incubator-doris/commit/ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "message": "fix bug", "committedDate": "2020-05-06T07:59:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjQ4Mw==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421616483", "bodyText": "Do not change this in this PR, better to submit another new PR to change it.", "author": "morningman", "createdAt": "2020-05-07T15:59:07Z", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1053,7 +1053,7 @@\n      * control materialized view\n      */\n     @ConfField(mutable = true, masterOnly = true)\n-    public static boolean enable_materialized_view = false;\n+    public static boolean enable_materialized_view = true;", "originalCommit": "2081aba768f1dc3944b3c083aece8b4ca96ef991", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ca39f68ed72666123e688c0594127e212895bbfa", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/common/Config.java b/fe/src/main/java/org/apache/doris/common/Config.java\nindex b8d98059a..4ff1648e7 100644\n--- a/fe/src/main/java/org/apache/doris/common/Config.java\n+++ b/fe/src/main/java/org/apache/doris/common/Config.java\n\n@@ -1053,7 +1053,7 @@ public class Config extends ConfigBase {\n      * control materialized view\n      */\n     @ConfField(mutable = true, masterOnly = true)\n-    public static boolean enable_materialized_view = true;\n+    public static boolean enable_materialized_view = false;\n \n     /**\n      * it can't auto-resume routine load job as long as one of the backends is down\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTAyOQ==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619029", "bodyText": "if index is DUPLICATED, but column type is float or double, we should also forbid the delete operation.", "author": "morningman", "createdAt": "2020-05-07T16:02:51Z", "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -509,8 +510,8 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                 if (column == null) {\n                     ErrorReport.reportDdlException(ErrorCode.ERR_BAD_FIELD_ERROR, columnName, indexName);\n                 }\n-\n-                if (table.getKeysType() == KeysType.DUP_KEYS && !column.isKey()) {\n+                MaterializedIndexMeta indexMeta = table.getIndexIdToMeta().get(index.getId());\n+                if (indexMeta.getKeysType() != KeysType.DUP_KEYS && !column.isKey()) {", "originalCommit": "2081aba768f1dc3944b3c083aece8b4ca96ef991", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5de3b9f34af5749656205267a449bcf422df7f2", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/load/DeleteHandler.java b/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\nindex 5748be2e7..b75b4ac63 100644\n--- a/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\n+++ b/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\n\n@@ -508,7 +520,8 @@ public class DeleteHandler implements Writable {\n                 }\n                 Column column = indexColNameToColumn.get(columnName);\n                 if (column == null) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_BAD_FIELD_ERROR, columnName, indexName);\n+                    ErrorReport.reportDdlException(ErrorCode.ERR_BAD_FIELD_ERROR, columnName,\n+                            table.getBaseIndexId() == index.getId()? indexName : \"index[\" + indexName +\"]\");\n                 }\n                 MaterializedIndexMeta indexMeta = table.getIndexIdToMeta().get(index.getId());\n                 if (indexMeta.getKeysType() != KeysType.DUP_KEYS && !column.isKey()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTQwNg==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619406", "bodyText": "No need to modify here, this method is deprecated.", "author": "morningman", "createdAt": "2020-05-07T16:03:26Z", "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3123,7 +3123,7 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS) {", "originalCommit": "2081aba768f1dc3944b3c083aece8b4ca96ef991", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6e23d744573845c7300c1311467c659206f0b31b", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/load/Load.java b/fe/src/main/java/org/apache/doris/load/Load.java\nindex f12f5b275..bccf25000 100644\n--- a/fe/src/main/java/org/apache/doris/load/Load.java\n+++ b/fe/src/main/java/org/apache/doris/load/Load.java\n\n@@ -3123,7 +3123,7 @@ public class Load {\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS) {\n+            if (!column.isKey()) {\n                 // ErrorReport.reportDdlException(ErrorCode.ERR_NOT_KEY_COLUMN, columnName);\n                 throw new DdlException(\"Column[\" + columnName + \"] is not key column\");\n             }\n"}}, {"oid": "4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "url": "https://github.com/apache/incubator-doris/commit/4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "message": "allow delete duplicated non-key column\n\nadd some comment\n\nadd unit test\n\nfix double unregister\n\nfix typo\n\nfix typo\n\nfix schema\n\nfix typo\n\nfix bug\n\nUpdate be/src/olap/delete_handler.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>", "committedDate": "2020-05-08T11:25:38Z", "type": "commit"}, {"oid": "4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "url": "https://github.com/apache/incubator-doris/commit/4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "message": "allow delete duplicated non-key column\n\nadd some comment\n\nadd unit test\n\nfix double unregister\n\nfix typo\n\nfix typo\n\nfix schema\n\nfix typo\n\nfix bug\n\nUpdate be/src/olap/delete_handler.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>", "committedDate": "2020-05-08T11:25:38Z", "type": "forcePushed"}, {"oid": "ca39f68ed72666123e688c0594127e212895bbfa", "url": "https://github.com/apache/incubator-doris/commit/ca39f68ed72666123e688c0594127e212895bbfa", "message": "revert config", "committedDate": "2020-05-08T11:41:11Z", "type": "commit"}, {"oid": "6e23d744573845c7300c1311467c659206f0b31b", "url": "https://github.com/apache/incubator-doris/commit/6e23d744573845c7300c1311467c659206f0b31b", "message": "revert config", "committedDate": "2020-05-08T12:06:59Z", "type": "commit"}, {"oid": "060be5c4363048c37b4dd6be733d81f7700a14e8", "url": "https://github.com/apache/incubator-doris/commit/060be5c4363048c37b4dd6be733d81f7700a14e8", "message": "disable float", "committedDate": "2020-05-09T02:27:39Z", "type": "commit"}, {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2", "url": "https://github.com/apache/incubator-doris/commit/b5de3b9f34af5749656205267a449bcf422df7f2", "message": "disable float", "committedDate": "2020-05-09T03:46:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTg5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422451896", "bodyText": "should add some comment to explain why float and double type delete predicate can not be supported.", "author": "kangpinghuang", "createdAt": "2020-05-09T04:33:28Z", "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -478,9 +479,11 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS", "originalCommit": "b5de3b9f34af5749656205267a449bcf422df7f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fe46dde9008f56703bd1567b4101b6fbe48c0863", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/load/DeleteHandler.java b/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\nindex b75b4ac63..5930adfd3 100644\n--- a/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\n+++ b/fe/src/main/java/org/apache/doris/load/DeleteHandler.java\n\n@@ -479,6 +479,9 @@ public class DeleteHandler implements Writable {\n             }\n \n             Column column = nameToColumn.get(columnName);\n+            // Due to rounding errors, most floating-point numbers end up being slightly imprecise,\n+            // it also means that numbers expected to be equal often differ slightly, so we do not allow compare with\n+            // floating-point numbers, floating-point number not allowed in where clause\n             if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS\n                     || column.getDataType().isFloatingPointType()) {\n                 // ErrorReport.reportDdlException(ErrorCode.ERR_NOT_KEY_COLUMN, columnName);\n"}}, {"oid": "fe46dde9008f56703bd1567b4101b6fbe48c0863", "url": "https://github.com/apache/incubator-doris/commit/fe46dde9008f56703bd1567b4101b6fbe48c0863", "message": "revert change", "committedDate": "2020-05-11T02:13:33Z", "type": "commit"}, {"oid": "fe46dde9008f56703bd1567b4101b6fbe48c0863", "url": "https://github.com/apache/incubator-doris/commit/fe46dde9008f56703bd1567b4101b6fbe48c0863", "message": "revert change", "committedDate": "2020-05-11T02:13:33Z", "type": "forcePushed"}, {"oid": "f8ed40cea68590890f80fe3cdc106e28b4c76d23", "url": "https://github.com/apache/incubator-doris/commit/f8ed40cea68590890f80fe3cdc106e28b4c76d23", "message": "revert change", "committedDate": "2020-05-11T02:15:15Z", "type": "commit"}, {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8", "url": "https://github.com/apache/incubator-doris/commit/aa0034f7fb199a2e42942127a3bfad188d4e73d8", "message": "Merge branch 'master' into delete_value_column", "committedDate": "2020-05-11T03:24:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyOTIxMQ==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424429211", "bodyText": "What is about?", "author": "morningman", "createdAt": "2020-05-13T13:18:01Z", "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -549,7 +548,10 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                     }\n                     keyStorageLayoutBytes += baseColumn.getType().getStorageLayoutBytes();\n                     Column rollupColumn = new Column(baseColumn);\n-                    if ((i + 1) <= FeConstants.shortkey_max_column_count\n+                    if(changeStorageFormat) {\n+                        rollupColumn.setIsKey(baseColumn.isKey());\n+                        rollupColumn.setAggregationType(baseColumn.getAggregationType(), true);", "originalCommit": "aa0034f7fb199a2e42942127a3bfad188d4e73d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMzUyOA==", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424833528", "bodyText": "when create a segmentv2 rollup on duplicate table, the previous code did not handle this specific sutiation, it will create a all key rollup, all value columns will convert to key column", "author": "yangzhg", "createdAt": "2020-05-14T02:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyOTIxMQ=="}], "type": "inlineReview", "revised_code": null}]}