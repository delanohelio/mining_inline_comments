{"pr_number": 2991, "pr_title": "Output null for hll and bitmap column when select *", "pr_createdAt": "2020-02-25T13:53:51Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2991", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1MjU5OA==", "url": "https://github.com/apache/incubator-doris/pull/2991#discussion_r384252598", "bodyText": "I don't think this change is very suitable.\n\nI think the behavior of select * and select a specific column should be consistent.\nThe current modification method may have problems when inserting into select *, or when sub-queries, such as select hll_union (hll_col) from (select *);\n\nI think we can do it in backend. When encountering HLL type or Bitmap type, ResultSink can send null directly.", "author": "imay", "createdAt": "2020-02-26T03:06:38Z", "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -786,15 +785,14 @@ private void expandStar(Analyzer analyzer, TableName tblName) throws AnalysisExc\n      * Expand \"*\" for a particular tuple descriptor by appending\n      * refs for each column to selectListExprs.\n      */\n-    private void expandStar(TableName tblName, TupleDescriptor desc) throws AnalysisException {\n+    private void expandStar(TableName tblName, TupleDescriptor desc) {\n         for (Column col : desc.getTable().getBaseSchema()) {\n-            if (col.getDataType() == PrimitiveType.HLL && !fromInsert) {\n-                throw new AnalysisException(Type.OnlyMetricTypeErrorMsg);\n-            }\n-            if (col.getAggregationType() == AggregateType.BITMAP_UNION && !fromInsert) {\n-                throw new AnalysisException(Type.OnlyMetricTypeErrorMsg);\n+            PrimitiveType type = col.getDataType();", "originalCommit": "73527ba22ac536995529c172d69461019f33717f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwMDkxMg==", "url": "https://github.com/apache/incubator-doris/pull/2991#discussion_r384300912", "bodyText": "If we handle in backend:\n\nthere is a performance issue, we still need to scan  the HLL or Bitmap column\nwe need to support return binary content for HLL or Bitmap, so we shouldn't send null directly in ResultSink, we must pass a config from FE to BE.", "author": "kangkaisen", "createdAt": "2020-02-26T06:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1MjU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxNjc2MA==", "url": "https://github.com/apache/incubator-doris/pull/2991#discussion_r384316760", "bodyText": "there is a performance issue, we still need to scan  the HLL or Bitmap column\n\n\nI think performance may not be very important in this case\n\n\nwe need to support return binary content for HLL or Bitmap, so we shouldn't send null directly in ResultSink, we must pass a config from FE to BE.\n\n\nMaybe we can support this feature later, and wait until the situation is really needed? Or the user can get the encoded readable content through the hex or base64 function", "author": "imay", "createdAt": "2020-02-26T07:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1MjU5OA=="}], "type": "inlineReview", "revised_code": {"commit": "8d559b806287fac3339cddfc7dc9756f97afb4d2", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\nindex 2e57b547b..fbc53d5e3 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n\n@@ -787,12 +794,7 @@ public class SelectStmt extends QueryStmt {\n      */\n     private void expandStar(TableName tblName, TupleDescriptor desc) {\n         for (Column col : desc.getTable().getBaseSchema()) {\n-            PrimitiveType type = col.getDataType();\n-            if (!fromInsert && (type == PrimitiveType.HLL || type == PrimitiveType.BITMAP)) {\n-                resultExprs.add(new NullLiteral());\n-            } else {\n-                resultExprs.add(new SlotRef(tblName, col.getName()));\n-            }\n+            resultExprs.add(new SlotRef(tblName, col.getName()));\n             colLabels.add(col.getName());\n         }\n     }\n"}}, {"oid": "8d559b806287fac3339cddfc7dc9756f97afb4d2", "url": "https://github.com/apache/incubator-doris/commit/8d559b806287fac3339cddfc7dc9756f97afb4d2", "message": "Output null for hll and bitmap column when select *", "committedDate": "2020-03-12T13:50:48Z", "type": "forcePushed"}, {"oid": "882862f267c7928076f554ba8dbf45f8ab4c058d", "url": "https://github.com/apache/incubator-doris/commit/882862f267c7928076f554ba8dbf45f8ab4c058d", "message": "Output null for hll and bitmap column when select *", "committedDate": "2020-03-12T14:07:02Z", "type": "forcePushed"}, {"oid": "9c6aa2228670848af28c5f335041abd2ded4e2dd", "url": "https://github.com/apache/incubator-doris/commit/9c6aa2228670848af28c5f335041abd2ded4e2dd", "message": "Output null for hll and bitmap column when select *", "committedDate": "2020-03-13T03:46:20Z", "type": "commit"}, {"oid": "9c6aa2228670848af28c5f335041abd2ded4e2dd", "url": "https://github.com/apache/incubator-doris/commit/9c6aa2228670848af28c5f335041abd2ded4e2dd", "message": "Output null for hll and bitmap column when select *", "committedDate": "2020-03-13T03:46:20Z", "type": "forcePushed"}]}