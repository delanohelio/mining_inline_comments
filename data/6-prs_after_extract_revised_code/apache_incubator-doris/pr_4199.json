{"pr_number": 4199, "pr_title": "Change type of sum, min, max function column in mv", "pr_createdAt": "2020-07-28T03:44:49Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4199", "timeline": [{"oid": "4d94f36748c47a529b6a3c9e21f0df2e125d22ab", "url": "https://github.com/apache/incubator-doris/commit/4d94f36748c47a529b6a3c9e21f0df2e125d22ab", "message": "Change type of sum, min, max function column in mv\n\nIf the agg function is sum, the type of mv column will be bigint.\nThe only exception is that if the base column is largeint, the type of mv column will be largeint.\n\nIf the agg function is min or max, the type of mv column will be same as the type of base column.\nFor example, the type of mv column is smallint when the agg function is min.\n\nChange-Id: I1b541fd03342ceba093c4aabd8a29793c52781dc", "committedDate": "2020-07-28T03:23:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MjI4Mw==", "url": "https://github.com/apache/incubator-doris/pull/4199#discussion_r461342283", "bodyText": "plz import the jar package according following sequence\uff1a\n4=javax\n3=java\n2=org\n1=com\n0=org.apache.doris", "author": "wutiangan", "createdAt": "2020-07-28T06:15:26Z", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java", "diffHunk": "@@ -30,11 +34,6 @@\n import org.apache.doris.common.FeNameFormat;\n import org.apache.doris.common.UserException;\n ", "originalCommit": "4d94f36748c47a529b6a3c9e21f0df2e125d22ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1MzM4OQ==", "url": "https://github.com/apache/incubator-doris/pull/4199#discussion_r461353389", "bodyText": "Hi, you could update the checkstyle.xml.", "author": "kangkaisen", "createdAt": "2020-07-28T06:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MjI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MjM4Mg==", "url": "https://github.com/apache/incubator-doris/pull/4199#discussion_r461472382", "bodyText": "Changed", "author": "EmmyMiao87", "createdAt": "2020-07-28T10:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0MjI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "9a7ab502e005d87b476f6cc7c369993f1745cd6a", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java b/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\nindex 5fc867ed3..065955fc7 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\n\n@@ -34,11 +40,6 @@ import org.apache.doris.common.FeConstants;\n import org.apache.doris.common.FeNameFormat;\n import org.apache.doris.common.UserException;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Set;\n-\n /**\n  * Materialized view is performed to materialize the results of query.\n  * This clause is used to create a new materialized view for a specified table\n"}}, {"oid": "caebfc742e5bebed36929329af6dbe4f5552664a", "url": "https://github.com/apache/incubator-doris/commit/caebfc742e5bebed36929329af6dbe4f5552664a", "message": "Add unit test\n\nChange-Id: Id451b0f7b334e265e1b495ee0aa47a686fffc1ee", "committedDate": "2020-07-28T10:03:51Z", "type": "commit"}, {"oid": "9a7ab502e005d87b476f6cc7c369993f1745cd6a", "url": "https://github.com/apache/incubator-doris/commit/9a7ab502e005d87b476f6cc7c369993f1745cd6a", "message": "Change import sequence\n\nChange-Id: Iffb7d3d7cbac6e98f4f358dd7c98a7d0dea2d4fc", "committedDate": "2020-07-28T10:12:40Z", "type": "commit"}, {"oid": "f107770f4a4e7f5c1205cbbc43bb843cd78b4cf1", "url": "https://github.com/apache/incubator-doris/commit/f107770f4a4e7f5c1205cbbc43bb843cd78b4cf1", "message": "If the type of base column is tinyint, smallint or int, the type of mv column will be bigint.\nOtherwise, the type of mv column is same as the type of base column.\n\nChange-Id: I39b869c18a24b2e8506bfbea22be781488132d69", "committedDate": "2020-07-28T12:14:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU0NTUxNg==", "url": "https://github.com/apache/incubator-doris/pull/4199#discussion_r461545516", "bodyText": "Sum float result type should be double.", "author": "kangkaisen", "createdAt": "2020-07-28T12:37:13Z", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java", "diffHunk": "@@ -353,11 +353,21 @@ public MVColumnItem buildMVColumnItem(FunctionCallExpr functionCallExpr) throws\n         Type type;\n         switch (functionName.toLowerCase()) {\n             case \"sum\":\n+                mvColumnName = baseColumnName;\n+                mvAggregateType = AggregateType.valueOf(functionName.toUpperCase());\n+                PrimitiveType baseColumnType = baseColumnRef.getType().getPrimitiveType();\n+                if (baseColumnType == PrimitiveType.TINYINT || baseColumnType == PrimitiveType.SMALLINT\n+                        || baseColumnType == PrimitiveType.INT) {\n+                    type = Type.BIGINT;\n+                } else {\n+                    type = Type.fromPrimitiveType(baseColumnRef.getType().getPrimitiveType());", "originalCommit": "f107770f4a4e7f5c1205cbbc43bb843cd78b4cf1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ea5b2d39731f9e1c5f3ef4634fe7c5b201cae559", "chunk": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java b/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\nindex a9b79f1ff..3a13709f6 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java\n\n@@ -359,6 +359,8 @@ public class CreateMaterializedViewStmt extends DdlStmt {\n                 if (baseColumnType == PrimitiveType.TINYINT || baseColumnType == PrimitiveType.SMALLINT\n                         || baseColumnType == PrimitiveType.INT) {\n                     type = Type.BIGINT;\n+                } else if (baseColumnType == PrimitiveType.FLOAT) {\n+                    type = Type.DOUBLE;\n                 } else {\n                     type = Type.fromPrimitiveType(baseColumnRef.getType().getPrimitiveType());\n                 }\n"}}, {"oid": "ea5b2d39731f9e1c5f3ef4634fe7c5b201cae559", "url": "https://github.com/apache/incubator-doris/commit/ea5b2d39731f9e1c5f3ef4634fe7c5b201cae559", "message": "float -> double\n\nChange-Id: I14387f5b1a3654e8c9fe9d8f46f78d51a8ab7ce1", "committedDate": "2020-07-29T02:07:31Z", "type": "commit"}, {"oid": "58849a326a7f838fffc10f0c52be1531b5285437", "url": "https://github.com/apache/incubator-doris/commit/58849a326a7f838fffc10f0c52be1531b5285437", "message": "Import\n\nChange-Id: I0cf85a09417bfd7be2ec48c42edaf67a8bcef686", "committedDate": "2020-07-30T02:22:12Z", "type": "commit"}, {"oid": "7427628d49cc4fbb8e20b3623036d8da27c5dfa3", "url": "https://github.com/apache/incubator-doris/commit/7427628d49cc4fbb8e20b3623036d8da27c5dfa3", "message": "Import\n\nChange-Id: I94e76f5b9f5258e81f807c7c5c8b36a451229aaf", "committedDate": "2020-07-30T02:52:32Z", "type": "commit"}]}