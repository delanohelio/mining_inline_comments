{"pr_number": 3766, "pr_title": "[Bug] Clear Txn when load been cancelled", "pr_createdAt": "2020-06-03T13:25:33Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3766", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk2MzIwMw==", "url": "https://github.com/apache/incubator-doris/pull/3766#discussion_r434963203", "bodyText": "Use ClusterNamespace.getFullName() for safety", "author": "morningman", "createdAt": "2020-06-04T02:52:51Z", "path": "fe/src/main/java/org/apache/doris/service/FrontendServiceImpl.java", "diffHunk": "@@ -808,7 +808,8 @@ private void loadTxnRollbackImpl(TLoadTxnRollbackRequest request) throws UserExc\n             checkPasswordAndPrivs(cluster, request.getUser(), request.getPasswd(), request.getDb(),\n                     request.getTbl(), request.getUser_ip(), PrivPredicate.LOAD);\n         }\n-        Database db = Catalog.getInstance().getDb(request.getDb());\n+        String dbName = cluster + \":\" + request.getDb();", "originalCommit": "270d544f6ab1738a4380c8bea9043045e698daa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk4NTEwNg==", "url": "https://github.com/apache/incubator-doris/pull/3766#discussion_r434985106", "bodyText": "OK, I fixed it", "author": "chaoyli", "createdAt": "2020-06-04T04:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk2MzIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "0681fe89246b7e81d2379c71153d7110d9ca5170", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/service/FrontendServiceImpl.java b/fe/src/main/java/org/apache/doris/service/FrontendServiceImpl.java\nindex 16f598fe5..057d3cdb9 100644\n--- a/fe/src/main/java/org/apache/doris/service/FrontendServiceImpl.java\n+++ b/fe/src/main/java/org/apache/doris/service/FrontendServiceImpl.java\n\n@@ -808,7 +808,7 @@ public class FrontendServiceImpl implements FrontendService.Iface {\n             checkPasswordAndPrivs(cluster, request.getUser(), request.getPasswd(), request.getDb(),\n                     request.getTbl(), request.getUser_ip(), PrivPredicate.LOAD);\n         }\n-        String dbName = cluster + \":\" + request.getDb();\n+        String dbName = ClusterNamespace.getFullName(cluster, request.getDb());\n         Database db = Catalog.getInstance().getDb(dbName);\n         if (db == null) {\n             throw new MetaNotFoundException(\"db \" + request.getDb() + \" does not exist\");\n"}}, {"oid": "0681fe89246b7e81d2379c71153d7110d9ca5170", "url": "https://github.com/apache/incubator-doris/commit/0681fe89246b7e81d2379c71153d7110d9ca5170", "message": "[Bug] Clear Txn when load been cancelled\nIf you a load task encoutering error, it will be cancelled.\nAt this time, FE will clear the Txn according to the DbName.\nIn FE, DbName should be added by cluter name.\nIf missing cluster name, it will encounter NullPointer.\nAs a result, the Txn will still exists until timeout.", "committedDate": "2020-06-04T03:34:40Z", "type": "commit"}]}