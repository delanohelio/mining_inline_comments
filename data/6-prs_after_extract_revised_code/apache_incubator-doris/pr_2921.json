{"pr_number": 2921, "pr_title": "diable column both in select list and aggregate functions when using GROUPING SETS/CUBE/ROLLUP", "pr_createdAt": "2020-02-17T05:25:32Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2921", "timeline": [{"oid": "ccf1f4bea673db844baa3c71afb42311ec1a4088", "url": "https://github.com/apache/incubator-doris/commit/ccf1f4bea673db844baa3c71afb42311ec1a4088", "message": "diable column both in select list and aggregate functions when using GROUPING SETS/CUBE/ROLLUP", "committedDate": "2020-02-17T05:26:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NTIyMw==", "url": "https://github.com/apache/incubator-doris/pull/2921#discussion_r379995223", "bodyText": "Please Add a UT. Currently we have a FE UT frame, which could handle SQL analyze bug. you could refer to DemoTest.", "author": "kangkaisen", "createdAt": "2020-02-17T05:50:45Z", "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -349,6 +350,19 @@ public void analyze(Analyzer analyzer) throws AnalysisException, UserException {\n             }\n         }\n         if (groupByClause != null && groupByClause.isGroupByExtension()) {\n+            for (SelectListItem item : selectList.getItems()) {", "originalCommit": "ccf1f4bea673db844baa3c71afb42311ec1a4088", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "19b4350d417237a1bb4a4203202d1a0876cdcf63", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\nindex 4122644be..05de06c5c 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/SelectStmt.java\n\n@@ -352,13 +352,11 @@ public class SelectStmt extends QueryStmt {\n         if (groupByClause != null && groupByClause.isGroupByExtension()) {\n             for (SelectListItem item : selectList.getItems()) {\n                 if (item.getExpr() instanceof FunctionCallExpr && item.getExpr().fn instanceof AggregateFunction) {\n-                    for (Expr expr : item.getExpr().getChildren()) {\n-                        for (SelectListItem i : selectList.getItems()) {\n-                            if (expr.equals(i.getExpr())) {\n-                                throw new AnalysisException(\"column: \" +i.toSql()+ \" cannot both in select list and \"\n-                                        + \"aggregate functions when using GROUPING SETS/CUBE/ROLLUP, please use union\"\n-                                        + \" instead.\");\n-                            }\n+                    for (Expr expr: groupByClause.getGroupingExprs()) {\n+                        if (item.getExpr().contains(expr)) {\n+                            throw new AnalysisException(\"column: \" + expr.toSql() + \" cannot both in select list and \"\n+                                    + \"aggregate functions when using GROUPING SETS/CUBE/ROLLUP, please use union\"\n+                                    + \" instead.\");\n                         }\n                     }\n                 }\n"}}, {"oid": "d15aeabe435890d7bd7d6b3a700760db754ed28b", "url": "https://github.com/apache/incubator-doris/commit/d15aeabe435890d7bd7d6b3a700760db754ed28b", "message": "add unittest", "committedDate": "2020-02-17T07:08:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTk5NA==", "url": "https://github.com/apache/incubator-doris/pull/2921#discussion_r380139994", "bodyText": "We could move this method to UtFrameUtils ?", "author": "kangkaisen", "createdAt": "2020-02-17T11:55:58Z", "path": "fe/src/test/java/org/apache/doris/utframe/AnotherDemoTest.java", "diffHunk": "@@ -111,19 +114,25 @@ public static void beforeClass() throws EnvVarNotSetException, IOException,\n         Thread.sleep(5000);\n     }\n \n-    // generate all port from between 20000 ~ 30000\n-    private static void getRandomPort() {\n-        Random r = new Random(System.currentTimeMillis());\n-        int basePort = 20000 + r.nextInt(9000);\n-        fe_http_port = basePort + 1;\n-        fe_rpc_port = basePort + 2;\n-        fe_query_port = basePort + 3;\n-        fe_edit_log_port = basePort + 4;\n-\n-        be_heartbeat_port = basePort + 5;\n-        be_thrift_port = basePort + 6;\n-        be_brpc_port = basePort + 7;\n-        be_http_port = basePort + 8;\n+    @AfterClass\n+    public static void TearDown() {\n+        try {\n+            FileUtils.deleteDirectory(new File(runningDirBase));\n+        } catch (IOException e) {\n+        }\n+    }\n+\n+    // generate all port from valid ports\n+    private static void getPorts() {", "originalCommit": "d15aeabe435890d7bd7d6b3a700760db754ed28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQzNzIyMA==", "url": "https://github.com/apache/incubator-doris/pull/2921#discussion_r380437220", "bodyText": "those ports are class member of DemoTest, and getValidport method already in UtFrameUtils", "author": "yangzhg", "createdAt": "2020-02-18T03:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTk5NA=="}], "type": "inlineReview", "revised_code": {"commit": "b4c3ab81ee550a0eb2b5bd340235987621969c85", "chunk": "diff --git a/fe/src/test/java/org/apache/doris/utframe/AnotherDemoTest.java b/fe/src/test/java/org/apache/doris/utframe/AnotherDemoTest.java\nindex 6a8d3d713..61a65679b 100644\n--- a/fe/src/test/java/org/apache/doris/utframe/AnotherDemoTest.java\n+++ b/fe/src/test/java/org/apache/doris/utframe/AnotherDemoTest.java\n\n@@ -114,25 +111,19 @@ public class AnotherDemoTest {\n         Thread.sleep(5000);\n     }\n \n-    @AfterClass\n-    public static void TearDown() {\n-        try {\n-            FileUtils.deleteDirectory(new File(runningDirBase));\n-        } catch (IOException e) {\n-        }\n-    }\n-\n-    // generate all port from valid ports\n-    private static void getPorts() {\n-        fe_http_port = UtFrameUtils.findValidPort();\n-        fe_rpc_port = UtFrameUtils.findValidPort();\n-        fe_query_port = UtFrameUtils.findValidPort();\n-        fe_edit_log_port = UtFrameUtils.findValidPort();\n-\n-        be_heartbeat_port = UtFrameUtils.findValidPort();\n-        be_thrift_port = UtFrameUtils.findValidPort();\n-        be_brpc_port = UtFrameUtils.findValidPort();\n-        be_http_port = UtFrameUtils.findValidPort();\n+    // generate all port from between 20000 ~ 30000\n+    private static void getRandomPort() {\n+        Random r = new Random(System.currentTimeMillis());\n+        int basePort = 20000 + r.nextInt(9000);\n+        fe_http_port = basePort + 1;\n+        fe_rpc_port = basePort + 2;\n+        fe_query_port = basePort + 3;\n+        fe_edit_log_port = basePort + 4;\n+\n+        be_heartbeat_port = basePort + 5;\n+        be_thrift_port = basePort + 6;\n+        be_brpc_port = basePort + 7;\n+        be_http_port = basePort + 8;\n     }\n \n     @Test\n"}}, {"oid": "b4c3ab81ee550a0eb2b5bd340235987621969c85", "url": "https://github.com/apache/incubator-doris/commit/b4c3ab81ee550a0eb2b5bd340235987621969c85", "message": "diable column both in select list and aggregate functions when using GROUPING SETS/CUBE/ROLLUP", "committedDate": "2020-02-18T03:13:23Z", "type": "commit"}, {"oid": "19b4350d417237a1bb4a4203202d1a0876cdcf63", "url": "https://github.com/apache/incubator-doris/commit/19b4350d417237a1bb4a4203202d1a0876cdcf63", "message": "add unittest\n\nadd unittest", "committedDate": "2020-02-18T03:17:03Z", "type": "commit"}, {"oid": "19b4350d417237a1bb4a4203202d1a0876cdcf63", "url": "https://github.com/apache/incubator-doris/commit/19b4350d417237a1bb4a4203202d1a0876cdcf63", "message": "add unittest\n\nadd unittest", "committedDate": "2020-02-18T03:17:03Z", "type": "forcePushed"}]}