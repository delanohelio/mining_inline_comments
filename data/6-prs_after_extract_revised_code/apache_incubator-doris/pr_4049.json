{"pr_number": 4049, "pr_title": "[Thread Resource Leak] Fix thread resource leak after checkpoint catalog destroyed", "pr_createdAt": "2020-07-07T16:19:30Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4049", "timeline": [{"oid": "9ee0de82d882e3ad3987c816c27289b5e96f4bee", "url": "https://github.com/apache/incubator-doris/commit/9ee0de82d882e3ad3987c816c27289b5e96f4bee", "message": "[Thread Resource Leak]Fix thread resource leak after checkpoint catalog destroyed", "committedDate": "2020-07-07T13:59:23Z", "type": "commit"}, {"oid": "90028eee951efceabd603e1c7e0b6737cc71506b", "url": "https://github.com/apache/incubator-doris/commit/90028eee951efceabd603e1c7e0b6737cc71506b", "message": "refactor MasterTaskExecutor.java", "committedDate": "2020-07-07T16:14:54Z", "type": "commit"}, {"oid": "4c5fa0ee14f11ddc31e06c2b70c142122cb05edd", "url": "https://github.com/apache/incubator-doris/commit/4c5fa0ee14f11ddc31e06c2b70c142122cb05edd", "message": "fix typo", "committedDate": "2020-07-07T16:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMjQyNQ==", "url": "https://github.com/apache/incubator-doris/pull/4049#discussion_r451232425", "bodyText": "Looks like this class is not used now.\nMaybe we can mark it as @deprecated now, or even remove it?", "author": "morningman", "createdAt": "2020-07-08T01:34:16Z", "path": "fe/src/main/java/org/apache/doris/common/publish/FixedTimePublisher.java", "diffHunk": "@@ -28,7 +28,7 @@\n public class FixedTimePublisher {", "originalCommit": "4c5fa0ee14f11ddc31e06c2b70c142122cb05edd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MDY2NA==", "url": "https://github.com/apache/incubator-doris/pull/4049#discussion_r451250664", "bodyText": "ok, I will remove it.", "author": "caiconghui", "createdAt": "2020-07-08T02:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMjQyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3cdc6347276c7412d4645e8928c98aa22055a234", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/common/publish/FixedTimePublisher.java b/fe/src/main/java/org/apache/doris/common/publish/FixedTimePublisher.java\ndeleted file mode 100644\nindex c63131753..000000000\n--- a/fe/src/main/java/org/apache/doris/common/publish/FixedTimePublisher.java\n+++ /dev/null\n\n@@ -1,72 +0,0 @@\n-// Licensed to the Apache Software Foundation (ASF) under one\n-// or more contributor license agreements.  See the NOTICE file\n-// distributed with this work for additional information\n-// regarding copyright ownership.  The ASF licenses this file\n-// to you under the Apache License, Version 2.0 (the\n-// \"License\"); you may not use this file except in compliance\n-// with the License.  You may obtain a copy of the License at\n-//\n-//   http://www.apache.org/licenses/LICENSE-2.0\n-//\n-// Unless required by applicable law or agreed to in writing,\n-// software distributed under the License is distributed on an\n-// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-// KIND, either express or implied.  See the License for the\n-// specific language governing permissions and limitations\n-// under the License.\n-\n-package org.apache.doris.common.publish;\n-\n-import org.apache.doris.common.Config;\n-import org.apache.doris.common.ThreadPoolManager;\n-\n-import java.util.concurrent.ScheduledThreadPoolExecutor;\n-import java.util.concurrent.TimeUnit;\n-\n-// Fixed time scheduled publisher.\n-// You can register your routine publish here.\n-public class FixedTimePublisher {\n-    private static FixedTimePublisher INSTANCE;\n-\n-    private ScheduledThreadPoolExecutor scheduler = ThreadPoolManager.newDaemonScheduledThreadPool(1, \"Fixed-Time-Publisher\");\n-    private ClusterStatePublisher publisher;\n-\n-    public FixedTimePublisher(ClusterStatePublisher publisher) {\n-        this.publisher = publisher;\n-    }\n-\n-    public static FixedTimePublisher getInstance() {\n-        if (INSTANCE == null) {\n-            INSTANCE = new FixedTimePublisher(ClusterStatePublisher.getInstance());\n-        }\n-        return INSTANCE;\n-    }\n-\n-    public void register(Callback callback, long intervalMs) {\n-        scheduler.scheduleAtFixedRate(new Worker(callback), 0, intervalMs, TimeUnit.MILLISECONDS);\n-    }\n-\n-    private class Worker implements Runnable {\n-        private Callback callback;\n-\n-        public Worker(Callback callback) {\n-            this.callback = callback;\n-        }\n-\n-        @Override\n-        public void run() {\n-            ClusterStateUpdate.Builder builder = ClusterStateUpdate.builder();\n-            builder.addUpdate(callback.getTopicUpdate());\n-            ClusterStateUpdate state = builder.build();\n-            Listener listener = Listeners.nullToNoOpListener(callback.getListener());\n-\n-            publisher.publish(state, listener, Config.meta_publish_timeout_ms);\n-        }\n-    }\n-\n-    public static interface Callback {\n-        public TopicUpdate getTopicUpdate();\n-\n-        public Listener getListener();\n-    }\n-}\n"}}, {"oid": "3cdc6347276c7412d4645e8928c98aa22055a234", "url": "https://github.com/apache/incubator-doris/commit/3cdc6347276c7412d4645e8928c98aa22055a234", "message": "Remove unused file FixedTimePublisher.java", "committedDate": "2020-07-08T02:45:27Z", "type": "commit"}, {"oid": "57e2bda4c3b1db78a7732ef98ae943dd545e8153", "url": "https://github.com/apache/incubator-doris/commit/57e2bda4c3b1db78a7732ef98ae943dd545e8153", "message": "fix comment", "committedDate": "2020-07-08T03:07:16Z", "type": "commit"}, {"oid": "f0fbdc5710b5d2583c5d80a03f74b3cc3b1b698b", "url": "https://github.com/apache/incubator-doris/commit/f0fbdc5710b5d2583c5d80a03f74b3cc3b1b698b", "message": "Fix that thread pool in checkpoint catalog doesn't need register metric", "committedDate": "2020-07-08T05:41:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwODQ2Mg==", "url": "https://github.com/apache/incubator-doris/pull/4049#discussion_r451308462", "bodyText": "maybe we should add some comment to this arg, such as: if isCheckpointCatalog is false means we need to do some thread metrics collect.", "author": "WingsGo", "createdAt": "2020-07-08T06:21:07Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -458,10 +459,10 @@ public DynamicPartitionScheduler getDynamicPartitionScheduler() {\n     }\n \n     private static class SingletonHolder {\n-        private static final Catalog INSTANCE = new Catalog();\n+        private static final Catalog INSTANCE = new Catalog(false);\n     }\n \n-    private Catalog() {\n+    private Catalog(boolean isCheckpointCatalog) {", "originalCommit": "f0fbdc5710b5d2583c5d80a03f74b3cc3b1b698b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxODk2Ng==", "url": "https://github.com/apache/incubator-doris/pull/4049#discussion_r451318966", "bodyText": "ok", "author": "caiconghui", "createdAt": "2020-07-08T06:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwODQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7d19205a1de65cd598e1af4cce7555711aebb246", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/Catalog.java b/fe/src/main/java/org/apache/doris/catalog/Catalog.java\nindex e0a838c72..727dbe4d2 100755\n--- a/fe/src/main/java/org/apache/doris/catalog/Catalog.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/Catalog.java\n\n@@ -462,6 +462,7 @@ public class Catalog {\n         private static final Catalog INSTANCE = new Catalog(false);\n     }\n \n+    // if isCheckpointCatalog is true, it means that we should not collect thread pool metric\n     private Catalog(boolean isCheckpointCatalog) {\n         this.idToDb = new ConcurrentHashMap<>();\n         this.fullNameToDb = new ConcurrentHashMap<>();\n"}}, {"oid": "7d19205a1de65cd598e1af4cce7555711aebb246", "url": "https://github.com/apache/incubator-doris/commit/7d19205a1de65cd598e1af4cce7555711aebb246", "message": "add comment about isCheckpointCatalog parameter in Catalog constructor", "committedDate": "2020-07-08T06:56:38Z", "type": "commit"}, {"oid": "45267aafda32f06f109b1c17294b5540880f8b6b", "url": "https://github.com/apache/incubator-doris/commit/45267aafda32f06f109b1c17294b5540880f8b6b", "message": "Add shutdown scheduledThreadPool when close MasterTaskExecutor", "committedDate": "2020-07-15T02:28:05Z", "type": "commit"}, {"oid": "a24c7c4c3ec4c79bbb4c632918048cccd06a1f8c", "url": "https://github.com/apache/incubator-doris/commit/a24c7c4c3ec4c79bbb4c632918048cccd06a1f8c", "message": "fix unit test failed", "committedDate": "2020-07-15T16:25:42Z", "type": "commit"}]}