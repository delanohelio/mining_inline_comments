{"pr_number": 3768, "pr_title": "Disable Bitmap or Hll type in keys or in values with incorrect agg-type", "pr_createdAt": "2020-06-03T14:14:38Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3768", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyNTQ1Nw==", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435125457", "bodyText": "Why remove the primitiveTypeList.clear();.\nNow, the BITMAP_UNION is compatible with both BITMAP and HLL?", "author": "morningman", "createdAt": "2020-06-04T09:41:20Z", "path": "fe/src/main/java/org/apache/doris/catalog/AggregateType.java", "diffHunk": "@@ -85,20 +85,22 @@\n         compatibilityMap.put(MAX, EnumSet.copyOf(primitiveTypeList));\n \n         primitiveTypeList.clear();\n-        compatibilityMap.put(REPLACE, EnumSet.allOf(PrimitiveType.class));\n+        // all types except bitmap and hll.\n+        EnumSet<PrimitiveType> exc_bitmap_hll = EnumSet.allOf(PrimitiveType.class);\n+        exc_bitmap_hll.remove(PrimitiveType.BITMAP);\n+        exc_bitmap_hll.remove(PrimitiveType.HLL);\n+        compatibilityMap.put(REPLACE, EnumSet.copyOf(exc_bitmap_hll));\n+\n+        compatibilityMap.put(REPLACE_IF_NOT_NULL, EnumSet.copyOf(exc_bitmap_hll));\n \n-        primitiveTypeList.clear();\n-        compatibilityMap.put(REPLACE_IF_NOT_NULL, EnumSet.allOf(PrimitiveType.class));\n-       \n-        primitiveTypeList.clear();\n         primitiveTypeList.add(PrimitiveType.HLL);\n         compatibilityMap.put(HLL_UNION, EnumSet.copyOf(primitiveTypeList));\n \n-        primitiveTypeList.clear();\n+\n         primitiveTypeList.add(PrimitiveType.BITMAP);", "originalCommit": "2035bce6696d8770b98ff8921ae8e78c4ae40cc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzNTgyNA==", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435135824", "bodyText": "By mistake.\nThanks for reminding.", "author": "spaces-X", "createdAt": "2020-06-04T09:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyNTQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "8f172e92481890a99176d726a786ab27c78ccec3", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/catalog/AggregateType.java b/fe/src/main/java/org/apache/doris/catalog/AggregateType.java\nindex 6292d0603..bce3c14b9 100644\n--- a/fe/src/main/java/org/apache/doris/catalog/AggregateType.java\n+++ b/fe/src/main/java/org/apache/doris/catalog/AggregateType.java\n\n@@ -93,10 +93,11 @@ public enum AggregateType {\n \n         compatibilityMap.put(REPLACE_IF_NOT_NULL, EnumSet.copyOf(exc_bitmap_hll));\n \n+        primitiveTypeList.clear();\n         primitiveTypeList.add(PrimitiveType.HLL);\n         compatibilityMap.put(HLL_UNION, EnumSet.copyOf(primitiveTypeList));\n \n-\n+        primitiveTypeList.clear();\n         primitiveTypeList.add(PrimitiveType.BITMAP);\n         compatibilityMap.put(BITMAP_UNION, EnumSet.copyOf(primitiveTypeList));\n \n"}}, {"oid": "8f172e92481890a99176d726a786ab27c78ccec3", "url": "https://github.com/apache/incubator-doris/commit/8f172e92481890a99176d726a786ab27c78ccec3", "message": "Disable Bitmap or Hll type in keys or in values with incorrect agg-type", "committedDate": "2020-06-04T09:50:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY1NjQzNg==", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435656436", "bodyText": "Should keep code style with original code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ( type.isBitmapType() || type.isHllType() ){\n          \n          \n            \n                    if (type.isBitmapType() || type.isHllType()) {", "author": "imay", "createdAt": "2020-06-05T02:27:16Z", "path": "fe/src/main/java/org/apache/doris/analysis/ColumnDef.java", "diffHunk": "@@ -131,6 +131,16 @@ public void analyze(boolean isOlap) throws AnalysisException {\n \n         Type type = typeDef.getType();\n \n+        // disable Bitmap Hll type in keys, values without aggregate function.\n+        if ( type.isBitmapType() || type.isHllType() ){", "originalCommit": "8f172e92481890a99176d726a786ab27c78ccec3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java b/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\nindex 1f88128fb..d51e6edfe 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\n\n@@ -132,8 +132,8 @@ public class ColumnDef {\n         Type type = typeDef.getType();\n \n         // disable Bitmap Hll type in keys, values without aggregate function.\n-        if ( type.isBitmapType() || type.isHllType() ){\n-            if (isKey){\n+        if (type.isBitmapType() || type.isHllType()) {\n+            if (isKey) {\n                 throw new AnalysisException(\"Key column can not set bitmap or hll type:\" + name);\n             }\n             if (aggregateType == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY1NjQ3Mg==", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435656472", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (isKey){\n          \n          \n            \n                        if (isKey) {", "author": "imay", "createdAt": "2020-06-05T02:27:25Z", "path": "fe/src/main/java/org/apache/doris/analysis/ColumnDef.java", "diffHunk": "@@ -131,6 +131,16 @@ public void analyze(boolean isOlap) throws AnalysisException {\n \n         Type type = typeDef.getType();\n \n+        // disable Bitmap Hll type in keys, values without aggregate function.\n+        if ( type.isBitmapType() || type.isHllType() ){\n+            if (isKey){", "originalCommit": "8f172e92481890a99176d726a786ab27c78ccec3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "chunk": "diff --git a/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java b/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\nindex 1f88128fb..d51e6edfe 100644\n--- a/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\n+++ b/fe/src/main/java/org/apache/doris/analysis/ColumnDef.java\n\n@@ -132,8 +132,8 @@ public class ColumnDef {\n         Type type = typeDef.getType();\n \n         // disable Bitmap Hll type in keys, values without aggregate function.\n-        if ( type.isBitmapType() || type.isHllType() ){\n-            if (isKey){\n+        if (type.isBitmapType() || type.isHllType()) {\n+            if (isKey) {\n                 throw new AnalysisException(\"Key column can not set bitmap or hll type:\" + name);\n             }\n             if (aggregateType == null) {\n"}}, {"oid": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "url": "https://github.com/apache/incubator-doris/commit/cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "message": "Apply suggestions from code review\r\n\r\nkeep code style\n\nCo-authored-by: Zhao Chun <buaa.zhaoc@gmail.com>", "committedDate": "2020-06-05T02:40:46Z", "type": "commit"}]}