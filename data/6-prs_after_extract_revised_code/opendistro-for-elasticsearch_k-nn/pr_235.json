{"pr_number": 235, "pr_title": "Fix script statistics flaky test case", "pr_createdAt": "2020-09-22T02:58:01Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235", "timeline": [{"oid": "cb41a1baf330c219f8147ce09de40a362c060043", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/cb41a1baf330c219f8147ce09de40a362c060043", "message": "change space -> space_type", "committedDate": "2020-09-21T20:51:42Z", "type": "commit"}, {"oid": "2290135f32eb270e3da76b36677992897e67a993", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2290135f32eb270e3da76b36677992897e67a993", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/k-NN", "committedDate": "2020-09-22T02:43:55Z", "type": "commit"}, {"oid": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b052c70e82ffe8dad1bf143874d1fa03050f4bb7", "message": "fix flaky test", "committedDate": "2020-09-22T02:55:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1MDMzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492450339", "bodyText": "Why we need OR condition why not just\n(int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1)", "author": "vamshin", "createdAt": "2020-09-22T03:01:31Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java", "diffHunk": "@@ -205,7 +207,8 @@ public void testScriptStats_singleShard() throws Exception {\n                 StatNames.SCRIPT_QUERY_REQUESTS.getName())\n         );\n         nodeStats = parseNodeStatsResponse(EntityUtils.toString(response.getEntity()));\n-        assertEquals(1, (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())));\n+        assertTrue((int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == 1 ||\n+                (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1);", "originalCommit": "b052c70e82ffe8dad1bf143874d1fa03050f4bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg2NzcyNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492867724", "bodyText": "Yes, this was an attempted workaround. SCRIPT_COMPILATIONS will only be incremented if the script has yet to be compiled.\nA better solution would be to clear the script cache before running the tests so that it is guaranteed that the script gets recompiled and SCRIPT_COMPILATIONS gets incremented by 1. I will update the PR.", "author": "jmazanec15", "createdAt": "2020-09-22T16:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1MDMzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "03b1f9802146d8c9faa401cf12f8fe75365a97a9", "chunk": "diff --git a/src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java b/src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java\nindex b4a385b..80c9163 100644\n--- a/src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java\n+++ b/src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/action/RestKNNStatsHandlerIT.java\n\n@@ -207,8 +209,7 @@ public class RestKNNStatsHandlerIT extends KNNRestTestCase {\n                 StatNames.SCRIPT_QUERY_REQUESTS.getName())\n         );\n         nodeStats = parseNodeStatsResponse(EntityUtils.toString(response.getEntity()));\n-        assertTrue((int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == 1 ||\n-                (int)(nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())) == initialScriptCompilations + 1);\n+        assertEquals((int) (nodeStats.get(0).get(StatNames.SCRIPT_COMPILATIONS.getName())), initialScriptCompilations + 1);\n         assertEquals(initialScriptQueryRequests + 1,\n                 (int)(nodeStats.get(0).get(StatNames.SCRIPT_QUERY_REQUESTS.getName())));\n \n"}}, {"oid": "03b1f9802146d8c9faa401cf12f8fe75365a97a9", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/03b1f9802146d8c9faa401cf12f8fe75365a97a9", "message": "add cache clear", "committedDate": "2020-09-22T16:24:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492909567", "bodyText": "Is this line required?", "author": "vamshin", "createdAt": "2020-09-22T17:25:25Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -543,6 +543,16 @@ protected void clearCache() throws Exception {\n         updateClusterSettings(KNNSettings.KNN_CACHE_ITEM_EXPIRY_TIME_MINUTES, null);\n     }\n \n+    /**\n+     * Clear script cache\n+     *\n+     * Remove k-NN script from script cache so that it has to be recompiled\n+     */\n+    protected void clearScriptCache() throws Exception {\n+        updateClusterSettings(\"script.context.score.cache_expire\", \"0\");", "originalCommit": "03b1f9802146d8c9faa401cf12f8fe75365a97a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0OTUwNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492949504", "bodyText": "Yes, this is what causes cache to evict the script. Here is documentation: https://www.elastic.co/guide/en/elasticsearch/reference/7.x/modules-scripting-using.html#modules-scripting-using-caching", "author": "jmazanec15", "createdAt": "2020-09-22T18:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1NTM2NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/235#discussion_r492955364", "bodyText": "Got it. Thanks", "author": "vamshin", "createdAt": "2020-09-22T18:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwOTU2Nw=="}], "type": "inlineReview", "revised_code": null}]}