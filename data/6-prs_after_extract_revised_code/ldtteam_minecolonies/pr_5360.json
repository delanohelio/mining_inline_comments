{"pr_number": 5360, "pr_title": "Fix crafter", "pr_createdAt": "2020-07-08T16:12:26Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5360", "timeline": [{"oid": "909a8ca762c639c97bbe880be17684963854f0d3", "url": "https://github.com/ldtteam/minecolonies/commit/909a8ca762c639c97bbe880be17684963854f0d3", "message": "try mark dirty here", "committedDate": "2020-07-06T14:52:34Z", "type": "commit"}, {"oid": "4bbfb1e0a2078c0727a6b35f953f2da44b3e327f", "url": "https://github.com/ldtteam/minecolonies/commit/4bbfb1e0a2078c0727a6b35f953f2da44b3e327f", "message": "Some crafting fixes", "committedDate": "2020-07-06T16:28:34Z", "type": "commit"}, {"oid": "dcc33b4058c818d0c905d57a347d14a93ee1bf7f", "url": "https://github.com/ldtteam/minecolonies/commit/dcc33b4058c818d0c905d57a347d14a93ee1bf7f", "message": "improve performance", "committedDate": "2020-07-07T08:20:17Z", "type": "commit"}, {"oid": "d61fbd27ad43342c8abebac98a95af0090e930b8", "url": "https://github.com/ldtteam/minecolonies/commit/d61fbd27ad43342c8abebac98a95af0090e930b8", "message": "Merge remote-tracking branch 'origin/version/1.15' into dman-imp", "committedDate": "2020-07-07T08:20:33Z", "type": "commit"}, {"oid": "fc213d7b16db21ee5d5cb5cccd11a1e193a4745f", "url": "https://github.com/ldtteam/minecolonies/commit/fc213d7b16db21ee5d5cb5cccd11a1e193a4745f", "message": "fix this", "committedDate": "2020-07-07T08:45:56Z", "type": "commit"}, {"oid": "e9c8bc780932d5b82378b0070754ffb4867642bb", "url": "https://github.com/ldtteam/minecolonies/commit/e9c8bc780932d5b82378b0070754ffb4867642bb", "message": "oopsy", "committedDate": "2020-07-07T13:22:56Z", "type": "commit"}, {"oid": "17765d99da0b4ad3d4e37696817a911742944904", "url": "https://github.com/ldtteam/minecolonies/commit/17765d99da0b4ad3d4e37696817a911742944904", "message": "fix this", "committedDate": "2020-07-07T13:36:15Z", "type": "commit"}, {"oid": "4505b7c8c96e1d63b29e131ff1edf6d07248bc4c", "url": "https://github.com/ldtteam/minecolonies/commit/4505b7c8c96e1d63b29e131ff1edf6d07248bc4c", "message": "fix memory leak", "committedDate": "2020-07-08T15:12:13Z", "type": "commit"}, {"oid": "a4cf0dfd5a52602fcc67235a3833c06dc8cceb5b", "url": "https://github.com/ldtteam/minecolonies/commit/a4cf0dfd5a52602fcc67235a3833c06dc8cceb5b", "message": "fix crafter issues", "committedDate": "2020-07-08T16:05:12Z", "type": "commit"}, {"oid": "08387f11cac0e169e772560ac85dd00d19a5580a", "url": "https://github.com/ldtteam/minecolonies/commit/08387f11cac0e169e772560ac85dd00d19a5580a", "message": "Merge remote-tracking branch 'origin/version/1.15' into dman-imp", "committedDate": "2020-07-08T16:05:15Z", "type": "commit"}, {"oid": "00efa1a3d73546d7f6edce801036053fbe804814", "url": "https://github.com/ldtteam/minecolonies/commit/00efa1a3d73546d7f6edce801036053fbe804814", "message": "wrong sign", "committedDate": "2020-07-08T16:06:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY2NzgyMA==", "url": "https://github.com/ldtteam/minecolonies/pull/5360#discussion_r451667820", "bodyText": "getCompletedRequestsByCitizen().computeIfAbsent(citizenThatRequested, ArrayList::new).add(request.getId());", "author": "MatthiasMann", "createdAt": "2020-07-08T16:20:00Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -1507,11 +1507,14 @@ public void onRequestedRequestComplete(@NotNull final IRequestManager manager, @\n             getOpenRequestsByRequestableType().remove(TypeToken.of(request.getRequest().getClass()));\n         }\n \n-        if (!getCompletedRequestsByCitizen().containsKey(citizenThatRequested))\n+        if (citizenThatRequested != 0)\n         {\n-            getCompletedRequestsByCitizen().put(citizenThatRequested, new ArrayList<>());\n+            if (!getCompletedRequestsByCitizen().containsKey(citizenThatRequested))\n+            {\n+                getCompletedRequestsByCitizen().put(citizenThatRequested, new ArrayList<>());\n+            }\n+            getCompletedRequestsByCitizen().get(citizenThatRequested).add(request.getId());", "originalCommit": "4505b7c8c96e1d63b29e131ff1edf6d07248bc4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY3MTgyNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5360#discussion_r451671825", "bodyText": "Good point, old code, but good point =D", "author": "Raycoms", "createdAt": "2020-07-08T16:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY2NzgyMA=="}], "type": "inlineReview", "revised_code": {"commit": "1b429f5512d5fe5f2b45284add0f9bc2a5c0cea6", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java b/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java\nindex e5768581fc..d6511dcc64 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java\n\n@@ -1507,7 +1507,7 @@ public abstract class AbstractBuilding extends AbstractBuildingContainer impleme\n             getOpenRequestsByRequestableType().remove(TypeToken.of(request.getRequest().getClass()));\n         }\n \n-        if (citizenThatRequested != 0)\n+        if (citizenThatRequested >= 0)\n         {\n             if (!getCompletedRequestsByCitizen().containsKey(citizenThatRequested))\n             {\n"}}, {"oid": "1b429f5512d5fe5f2b45284add0f9bc2a5c0cea6", "url": "https://github.com/ldtteam/minecolonies/commit/1b429f5512d5fe5f2b45284add0f9bc2a5c0cea6", "message": "fix #5322", "committedDate": "2020-07-08T16:25:50Z", "type": "commit"}, {"oid": "e58139e0172e4837d2229160e15d743dd5356336", "url": "https://github.com/ldtteam/minecolonies/commit/e58139e0172e4837d2229160e15d743dd5356336", "message": "adjust to review", "committedDate": "2020-07-08T16:31:27Z", "type": "commit"}, {"oid": "460c5662c9f43fb860ea2a5dbe8bf74dd089a009", "url": "https://github.com/ldtteam/minecolonies/commit/460c5662c9f43fb860ea2a5dbe8bf74dd089a009", "message": "same for fuel", "committedDate": "2020-07-08T16:42:22Z", "type": "commit"}, {"oid": "3f82a21f120e96a2e750fb6c9a8ab449d1499035", "url": "https://github.com/ldtteam/minecolonies/commit/3f82a21f120e96a2e750fb6c9a8ab449d1499035", "message": "fix buckets and pickup", "committedDate": "2020-07-08T18:09:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc0MDI5OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5360#discussion_r451740299", "bodyText": "think this should only reduce if the addItemStackToItemHandler is successfull", "author": "someaddons", "createdAt": "2020-07-08T18:20:47Z", "path": "src/api/java/com/minecolonies/api/util/InventoryUtils.java", "diffHunk": "@@ -1776,21 +1776,16 @@ public static int transferXOfFirstSlotInItemHandlerWithIntoNextFreeSlotInItemHan\n                 break;\n             }\n \n-\n             final ItemStack returnStack = sourceHandler.extractItem(desiredItemSlot, currentAmount, false);\n \n             if (!ItemStackUtils.isEmpty(returnStack))\n             {\n                 if (!InventoryUtils.addItemStackToItemHandler(targetHandler, returnStack))\n                 {\n-                    sourceHandler.insertItem(desiredItemSlot, returnStack, false);\n                     break;\n                 }\n                 // Only reduce if successfully inserted.\n-                else\n-                {\n-                    currentAmount -= returnStack.getCount();\n-                }\n+                currentAmount -= returnStack.getCount();", "originalCommit": "3f82a21f120e96a2e750fb6c9a8ab449d1499035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4ODY5NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5360#discussion_r451788694", "bodyText": "If not, it breaks the loop.", "author": "Raycoms", "createdAt": "2020-07-08T19:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc0MDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc5MDgyNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5360#discussion_r451790827", "bodyText": "if !transfer\nbreak\nThat's why.", "author": "Raycoms", "createdAt": "2020-07-08T19:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc0MDI5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d507e2c2fe3086eaeae3431417a3c1dc581b9571", "chunk": "diff --git a/src/api/java/com/minecolonies/api/util/InventoryUtils.java b/src/api/java/com/minecolonies/api/util/InventoryUtils.java\nindex 9cddbc23ec..cd15f5c2d3 100755\n--- a/src/api/java/com/minecolonies/api/util/InventoryUtils.java\n+++ b/src/api/java/com/minecolonies/api/util/InventoryUtils.java\n\n@@ -1756,24 +1767,18 @@ public class InventoryUtils\n     public static int transferXOfFirstSlotInItemHandlerWithIntoNextFreeSlotInItemHandlerWithResult(\n       @NotNull final IItemHandler sourceHandler,\n       @NotNull final Predicate<ItemStack> itemStackSelectionPredicate,\n-      @NotNull final int amount, @NotNull final IItemHandler targetHandler)\n+      final int amount, @NotNull final IItemHandler targetHandler)\n     {\n         int currentAmount = amount;\n-        int tries = 0;\n-        while (currentAmount > 0)\n+        int slot = 0;\n+        while (currentAmount > 0 && slot < sourceHandler.getSlots())\n         {\n-            tries++;\n-            if (tries > sourceHandler.getSlots())\n-            {\n-                break;\n-            }\n-\n             final int desiredItemSlot = InventoryUtils.findFirstSlotInItemHandlerNotEmptyWith(sourceHandler,\n               itemStackSelectionPredicate::test);\n \n             if (desiredItemSlot == -1)\n             {\n-                break;\n+                return currentAmount;\n             }\n \n             final ItemStack returnStack = sourceHandler.extractItem(desiredItemSlot, currentAmount, false);\n"}}, {"oid": "d507e2c2fe3086eaeae3431417a3c1dc581b9571", "url": "https://github.com/ldtteam/minecolonies/commit/d507e2c2fe3086eaeae3431417a3c1dc581b9571", "message": "Try this", "committedDate": "2020-07-08T21:09:25Z", "type": "commit"}]}