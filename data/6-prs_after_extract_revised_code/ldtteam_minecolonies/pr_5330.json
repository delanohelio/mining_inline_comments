{"pr_number": 5330, "pr_title": "fix duplicate requests", "pr_createdAt": "2020-07-03T09:36:48Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5330", "timeline": [{"oid": "900d5f6fed0f22da52c852e7188c9e32c85e68e7", "url": "https://github.com/ldtteam/minecolonies/commit/900d5f6fed0f22da52c852e7188c9e32c85e68e7", "message": "fix duplicate requests", "committedDate": "2020-07-03T09:36:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ4ODMwMA==", "url": "https://github.com/ldtteam/minecolonies/pull/5330#discussion_r449488300", "bodyText": "You sure that this can not produce an NPE?", "author": "OrionDevelopment", "createdAt": "2020-07-03T09:42:35Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingStructureBuilder.java", "diffHunk": "@@ -650,8 +650,11 @@ public void checkOrRequestBucket(@Nullable final BuilderBucket requiredResources\n             boolean hasOpenRequest = false;\n             int count = InventoryUtils.getItemCountInItemHandler(getCapability(CapabilityItemHandler.ITEM_HANDLER_CAPABILITY).orElseGet(null),\n               stack -> stack.isItemEqual(itemStack.getItemStack()));\n-            int workerInvCount = workerInv ? InventoryUtils.getItemCountInItemHandler(worker.getInventory(), stack -> stack.isItemEqual(itemStack.getItemStack())) : 0;\n-            if ((count + workerInvCount) < entry.getValue())\n+\n+            int totalAmount = neededResources.get(entry.getKey()).getAmount();", "originalCommit": "900d5f6fed0f22da52c852e7188c9e32c85e68e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ5MDE2OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5330#discussion_r449490168", "bodyText": "Should not be possible to happen, but I'll build a safeguard in", "author": "Raycoms", "createdAt": "2020-07-03T09:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ4ODMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "36c692c78d1fb341f3a8d1ea36c681d8661e4fc5", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingStructureBuilder.java b/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingStructureBuilder.java\nindex 161f82df5..64c6a0510 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingStructureBuilder.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingStructureBuilder.java\n\n@@ -651,7 +651,7 @@ public abstract class AbstractBuildingStructureBuilder extends AbstractBuildingW\n             int count = InventoryUtils.getItemCountInItemHandler(getCapability(CapabilityItemHandler.ITEM_HANDLER_CAPABILITY).orElseGet(null),\n               stack -> stack.isItemEqual(itemStack.getItemStack()));\n \n-            int totalAmount = neededResources.get(entry.getKey()).getAmount();\n+            int totalAmount = neededResources.containsKey(entry.getKey()) ? neededResources.get(entry.getKey()).getAmount() : 0;\n             int workerInvCount = InventoryUtils.getItemCountInItemHandler(worker.getInventory(), stack -> stack.isItemEqual(itemStack.getItemStack()));\n             if ((workerInv && (count + workerInvCount) < entry.getValue())\n                   || (count < entry.getValue() && (count + workerInvCount) < totalAmount))\n"}}, {"oid": "36c692c78d1fb341f3a8d1ea36c681d8661e4fc5", "url": "https://github.com/ldtteam/minecolonies/commit/36c692c78d1fb341f3a8d1ea36c681d8661e4fc5", "message": "safeguard", "committedDate": "2020-07-03T09:46:27Z", "type": "commit"}, {"oid": "a5b4a6d0a9bfbbcc59b00cff29260bc619299b40", "url": "https://github.com/ldtteam/minecolonies/commit/a5b4a6d0a9bfbbcc59b00cff29260bc619299b40", "message": "this should be true", "committedDate": "2020-07-03T09:57:56Z", "type": "commit"}]}