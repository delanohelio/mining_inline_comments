{"pr_number": 5469, "pr_title": "Fix/lag", "pr_createdAt": "2020-07-28T18:12:34Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5469", "timeline": [{"oid": "38afa9df821185d55c82637581163634453512be", "url": "https://github.com/ldtteam/minecolonies/commit/38afa9df821185d55c82637581163634453512be", "message": "bunp str", "committedDate": "2020-07-25T17:39:39Z", "type": "commit"}, {"oid": "c53f639266ce98d59d8b73262af7291db849e539", "url": "https://github.com/ldtteam/minecolonies/commit/c53f639266ce98d59d8b73262af7291db849e539", "message": "bump forge", "committedDate": "2020-07-25T18:43:39Z", "type": "commit"}, {"oid": "c0e08ef03916944019e59ffc034ce3edd410f82f", "url": "https://github.com/ldtteam/minecolonies/commit/c0e08ef03916944019e59ffc034ce3edd410f82f", "message": "Fix warehouse request fulfillment of big stacks", "committedDate": "2020-07-26T08:43:22Z", "type": "commit"}, {"oid": "0792f5ecf4851b7cbfeb4bf4202ac53f312fa787", "url": "https://github.com/ldtteam/minecolonies/commit/0792f5ecf4851b7cbfeb4bf4202ac53f312fa787", "message": "Fix entity placement", "committedDate": "2020-07-26T11:53:10Z", "type": "commit"}, {"oid": "162b859f1af15195ac9ad76a7f3683262c6f77ea", "url": "https://github.com/ldtteam/minecolonies/commit/162b859f1af15195ac9ad76a7f3683262c6f77ea", "message": "Cleanup dman not picking up\n\nFixes #5430", "committedDate": "2020-07-26T13:50:42Z", "type": "commit"}, {"oid": "899681188148395aad6181ab9a8d450652ba51d9", "url": "https://github.com/ldtteam/minecolonies/commit/899681188148395aad6181ab9a8d450652ba51d9", "message": "Merge remote-tracking branch 'origin/version/1.15' into fix/dman", "committedDate": "2020-07-26T13:50:49Z", "type": "commit"}, {"oid": "d6012aa49f790c5a034d12ce41808883f0c29d0d", "url": "https://github.com/ldtteam/minecolonies/commit/d6012aa49f790c5a034d12ce41808883f0c29d0d", "message": "fix #5404", "committedDate": "2020-07-26T15:05:03Z", "type": "commit"}, {"oid": "964618bdba3a11f2b8fced56e59b95efa4374eee", "url": "https://github.com/ldtteam/minecolonies/commit/964618bdba3a11f2b8fced56e59b95efa4374eee", "message": "better", "committedDate": "2020-07-26T15:10:36Z", "type": "commit"}, {"oid": "c054e26149f1dff261af978fc9276934608d6ef1", "url": "https://github.com/ldtteam/minecolonies/commit/c054e26149f1dff261af978fc9276934608d6ef1", "message": "fix", "committedDate": "2020-07-26T15:10:49Z", "type": "commit"}, {"oid": "5158d12c4b01323b482116acf2a3f3d6f9f88c88", "url": "https://github.com/ldtteam/minecolonies/commit/5158d12c4b01323b482116acf2a3f3d6f9f88c88", "message": "only mark dirty if this", "committedDate": "2020-07-27T11:46:26Z", "type": "commit"}, {"oid": "4bf480839eba5e45e116cd3b8bc4991e116c4013", "url": "https://github.com/ldtteam/minecolonies/commit/4bf480839eba5e45e116cd3b8bc4991e116c4013", "message": "allow non solid blocks over bed\n\nAlso fix chickenherder, also fix world loaded checks", "committedDate": "2020-07-27T16:34:44Z", "type": "commit"}, {"oid": "8a1b01748a7e0768f8b11034db9f31274884c104", "url": "https://github.com/ldtteam/minecolonies/commit/8a1b01748a7e0768f8b11034db9f31274884c104", "message": "avoid lag", "committedDate": "2020-07-27T17:28:39Z", "type": "commit"}, {"oid": "f1c42854499807dfb87ea0ba7ae7210cd373eba8", "url": "https://github.com/ldtteam/minecolonies/commit/f1c42854499807dfb87ea0ba7ae7210cd373eba8", "message": "adjust to reivew", "committedDate": "2020-07-27T21:12:30Z", "type": "commit"}, {"oid": "41e5c799416666edaf4d74f6ae78849591792aac", "url": "https://github.com/ldtteam/minecolonies/commit/41e5c799416666edaf4d74f6ae78849591792aac", "message": "improve code", "committedDate": "2020-07-28T07:54:33Z", "type": "commit"}, {"oid": "297e801b411f179e572f5f4112c787bcb6a29e97", "url": "https://github.com/ldtteam/minecolonies/commit/297e801b411f179e572f5f4112c787bcb6a29e97", "message": "Merge branch 'fix/dman' into fix/lag", "committedDate": "2020-07-28T07:54:42Z", "type": "commit"}, {"oid": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "url": "https://github.com/ldtteam/minecolonies/commit/048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "message": "Merge branch 'version/1.15' into fix/lag", "committedDate": "2020-07-28T18:24:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NDYxNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461784617", "bodyText": "I also changed isAir to isSolid", "author": "Raycoms", "createdAt": "2020-07-28T18:25:48Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java", "diffHunk": "@@ -196,18 +197,21 @@ private void findBedAndTryToSleep()\n                 {\n                     for (final BlockPos pos : ((BuildingHome) hut).getBedList())\n                     {\n-                        final World world = citizen.world;\n-                        BlockState state = world.getBlockState(pos);\n-                        state = state.getBlock().getExtendedState(state, world, pos);\n-                        if (state.getBlock().isIn(BlockTags.BEDS)\n-                              && !state.get(BedBlock.OCCUPIED)\n-                              && state.get(BedBlock.PART).equals(BedPart.HEAD)\n-                              && !isBedOccupied((BuildingHome) hut, pos)\n-                              && world.isAirBlock(pos.up()))\n+                        if (WorldUtil.isBlockLoaded(citizen.world, pos))\n                         {\n-                            usedBed = pos;\n-                            setBedOccupied((BuildingHome) hut, true);\n-                            return;\n+                            final World world = citizen.world;\n+                            BlockState state = world.getBlockState(pos);\n+                            state = state.getBlock().getExtendedState(state, world, pos);\n+                            if (state.getBlock().isIn(BlockTags.BEDS)\n+                                  && !state.get(BedBlock.OCCUPIED)\n+                                  && state.get(BedBlock.PART).equals(BedPart.HEAD)\n+                                  && !isBedOccupied((BuildingHome) hut, pos)\n+                                  && !world.getBlockState(pos.up()).getMaterial().isSolid())", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java b/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\nindex a8cd35aaf8..f228c93307 100755\n--- a/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\n+++ b/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\n\n@@ -197,7 +197,7 @@ public class EntityAISleep extends Goal\n                 {\n                     for (final BlockPos pos : ((BuildingHome) hut).getBedList())\n                     {\n-                        if (WorldUtil.isBlockLoaded(citizen.world, pos))\n+                        if (WorldUtil.isEntityBlockLoaded(citizen.world, pos))\n                         {\n                             final World world = citizen.world;\n                             BlockState state = world.getBlockState(pos);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNDgwMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461904801", "bodyText": "think this should be an entity block loaded check, as its for an existing citizen in a possibly not loaded chunk, we want to check if its a chunk which ticks entities", "author": "someaddons", "createdAt": "2020-07-28T21:51:27Z", "path": "src/main/java/com/minecolonies/coremod/colony/managers/CitizenManager.java", "diffHunk": "@@ -127,7 +128,7 @@ public void registerCivilian(final AbstractCivilianEntity entity)\n             return;\n         }\n \n-        if (!existingCitizen.get().isAlive() || !existingCitizen.get().world.isBlockPresent(existingCitizen.get().getPosition()))\n+        if (!existingCitizen.get().isAlive() || !WorldUtil.isBlockLoaded(existingCitizen.get().world, existingCitizen.get().getPosition()))", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/managers/CitizenManager.java b/src/main/java/com/minecolonies/coremod/colony/managers/CitizenManager.java\nindex b625063c72..aa3c32814a 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/managers/CitizenManager.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/managers/CitizenManager.java\n\n@@ -128,7 +128,7 @@ public class CitizenManager implements ICitizenManager\n             return;\n         }\n \n-        if (!existingCitizen.get().isAlive() || !WorldUtil.isBlockLoaded(existingCitizen.get().world, existingCitizen.get().getPosition()))\n+        if (!existingCitizen.get().isAlive() || !WorldUtil.isEntityBlockLoaded(existingCitizen.get().world, existingCitizen.get().getPosition()))\n         {\n             existingCitizen.get().remove();\n             data.setEntity(entity);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNTM1NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461905354", "bodyText": "entity block loaded checks in this class, we're spawning entities", "author": "someaddons", "createdAt": "2020-07-28T21:52:12Z", "path": "src/main/java/com/minecolonies/coremod/colony/managers/RaidManager.java", "diffHunk": "@@ -285,7 +286,7 @@ public BlockPos calculateSpawnLocation()\n \n         for (final IBuilding building : colony.getBuildingManager().getBuildings().values())\n         {\n-            if (colony.getWorld().isBlockPresent(building.getPosition()))\n+            if (WorldUtil.isBlockLoaded(colony.getWorld(), building.getPosition()))", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/managers/RaidManager.java b/src/main/java/com/minecolonies/coremod/colony/managers/RaidManager.java\nindex 84dc904614..14f890e53c 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/managers/RaidManager.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/managers/RaidManager.java\n\n@@ -286,7 +286,7 @@ public class RaidManager implements IRaiderManager\n \n         for (final IBuilding building : colony.getBuildingManager().getBuildings().values())\n         {\n-            if (WorldUtil.isBlockLoaded(colony.getWorld(), building.getPosition()))\n+            if (WorldUtil.isEntityBlockLoaded(colony.getWorld(), building.getPosition()))\n             {\n                 loadedBuildings.add(building);\n                 amount++;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNTg4NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461905885", "bodyText": "entity loaded check", "author": "someaddons", "createdAt": "2020-07-28T21:52:53Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/florist/EntityAIWorkFlorist.java", "diffHunk": "@@ -294,7 +295,7 @@ private BlockPos getFirstNotCompostedLand()\n     {\n         for (final BlockPos pos : getOwnBuilding().getPlantGround())\n         {\n-            if (world.isBlockPresent(pos))\n+            if (WorldUtil.isBlockLoaded(world, pos))", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/entity/ai/citizen/florist/EntityAIWorkFlorist.java b/src/main/java/com/minecolonies/coremod/entity/ai/citizen/florist/EntityAIWorkFlorist.java\nindex d597ab391f..4d7736a7a9 100755\n--- a/src/main/java/com/minecolonies/coremod/entity/ai/citizen/florist/EntityAIWorkFlorist.java\n+++ b/src/main/java/com/minecolonies/coremod/entity/ai/citizen/florist/EntityAIWorkFlorist.java\n\n@@ -295,7 +295,7 @@ public class EntityAIWorkFlorist extends AbstractEntityAIInteract<JobFlorist, Bu\n     {\n         for (final BlockPos pos : getOwnBuilding().getPlantGround())\n         {\n-            if (WorldUtil.isBlockLoaded(world, pos))\n+            if (WorldUtil.isEntityBlockLoaded(world, pos))\n             {\n                 final TileEntity entity = world.getTileEntity(pos);\n                 if (entity instanceof TileEntityCompostedDirt)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNjIwNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461906207", "bodyText": "oops :D", "author": "someaddons", "createdAt": "2020-07-28T21:53:17Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/herders/EntityAIWorkChickenHerder.java", "diffHunk": "@@ -74,6 +74,6 @@ protected IAIState breedAnimals()\n     protected IAIState butcherAnimals()\n     {\n         worker.getCitizenData().setVisibleStatus(FIND_CHICKEN);\n-        return super.breedAnimals();\n+        return super.butcherAnimals();", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNjgwNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461906807", "bodyText": "entity loaded check", "author": "someaddons", "createdAt": "2020-07-28T21:54:03Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java", "diffHunk": "@@ -196,18 +197,21 @@ private void findBedAndTryToSleep()\n                 {\n                     for (final BlockPos pos : ((BuildingHome) hut).getBedList())\n                     {\n-                        final World world = citizen.world;\n-                        BlockState state = world.getBlockState(pos);\n-                        state = state.getBlock().getExtendedState(state, world, pos);\n-                        if (state.getBlock().isIn(BlockTags.BEDS)\n-                              && !state.get(BedBlock.OCCUPIED)\n-                              && state.get(BedBlock.PART).equals(BedPart.HEAD)\n-                              && !isBedOccupied((BuildingHome) hut, pos)\n-                              && world.isAirBlock(pos.up()))\n+                        if (WorldUtil.isBlockLoaded(citizen.world, pos))", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java b/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\nindex a8cd35aaf8..f228c93307 100755\n--- a/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\n+++ b/src/main/java/com/minecolonies/coremod/entity/ai/minimal/EntityAISleep.java\n\n@@ -197,7 +197,7 @@ public class EntityAISleep extends Goal\n                 {\n                     for (final BlockPos pos : ((BuildingHome) hut).getBedList())\n                     {\n-                        if (WorldUtil.isBlockLoaded(citizen.world, pos))\n+                        if (WorldUtil.isEntityBlockLoaded(citizen.world, pos))\n                         {\n                             final World world = citizen.world;\n                             BlockState state = world.getBlockState(pos);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwOTMzOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r461909339", "bodyText": "entity loaded", "author": "someaddons", "createdAt": "2020-07-28T21:57:02Z", "path": "src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenSleepHandler.java", "diffHunk": "@@ -103,7 +104,7 @@ public float getBedOrientationInDegrees()\n     @Override\n     public boolean trySleep(final BlockPos bedLocation)\n     {\n-        final BlockState state = citizen.world.isBlockPresent(bedLocation) ? citizen.world.getBlockState(bedLocation) : null;\n+        final BlockState state = WorldUtil.isBlockLoaded(citizen.world, bedLocation) ? citizen.world.getBlockState(bedLocation) : null;", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenSleepHandler.java b/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenSleepHandler.java\nindex 7c59957574..86fa59b8b8 100755\n--- a/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenSleepHandler.java\n+++ b/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenSleepHandler.java\n\n@@ -104,7 +104,7 @@ public class CitizenSleepHandler implements ICitizenSleepHandler\n     @Override\n     public boolean trySleep(final BlockPos bedLocation)\n     {\n-        final BlockState state = WorldUtil.isBlockLoaded(citizen.world, bedLocation) ? citizen.world.getBlockState(bedLocation) : null;\n+        final BlockState state = WorldUtil.isEntityBlockLoaded(citizen.world, bedLocation) ? citizen.world.getBlockState(bedLocation) : null;\n         final boolean isBed = state != null && state.getBlock().isBed(state, citizen.world, bedLocation, citizen);\n \n         if (!isBed)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwNzg0OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5469#discussion_r462107849", "bodyText": "typo", "author": "Asherslab", "createdAt": "2020-07-29T07:53:04Z", "path": "src/api/java/com/minecolonies/api/util/constant/CitizenConstants.java", "diffHunk": "@@ -115,6 +115,12 @@\n      * 20 ticks or also: once a second.\n      */\n     public static final int    TICKS_20                   = 20;\n+\n+    /**\n+     * 20 0ticks or also: once every 10 seconds.", "originalCommit": "048ab0bceb7873d6a6f9aa05c1177d8b803b8095", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51bbe04717cbc4f3cbde03f80edde415c943d406", "chunk": "diff --git a/src/api/java/com/minecolonies/api/util/constant/CitizenConstants.java b/src/api/java/com/minecolonies/api/util/constant/CitizenConstants.java\nindex ec4bbcd1ab..3ee32fcec9 100755\n--- a/src/api/java/com/minecolonies/api/util/constant/CitizenConstants.java\n+++ b/src/api/java/com/minecolonies/api/util/constant/CitizenConstants.java\n\n@@ -117,7 +117,7 @@ public final class CitizenConstants\n     public static final int    TICKS_20                   = 20;\n \n     /**\n-     * 20 0ticks or also: once every 10 seconds.\n+     * 200 ticks or also: once every 10 seconds.\n      */\n     public static final int TICKS_200 = 200;\n \n"}}, {"oid": "51bbe04717cbc4f3cbde03f80edde415c943d406", "url": "https://github.com/ldtteam/minecolonies/commit/51bbe04717cbc4f3cbde03f80edde415c943d406", "message": "fix review", "committedDate": "2020-07-29T07:56:37Z", "type": "commit"}, {"oid": "257dde895a2860ecc3069ee45173e4ba471f7f3c", "url": "https://github.com/ldtteam/minecolonies/commit/257dde895a2860ecc3069ee45173e4ba471f7f3c", "message": "Merge remote-tracking branch 'origin/fix/lag' into fix/lag", "committedDate": "2020-07-29T07:56:44Z", "type": "commit"}]}