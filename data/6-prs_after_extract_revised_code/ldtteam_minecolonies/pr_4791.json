{"pr_number": 4791, "pr_title": "Fix dimension change", "pr_createdAt": "2020-04-28T11:54:03Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/4791", "timeline": [{"oid": "f825ad35b571d688a6b1f19951cf6eaa80e2374b", "url": "https://github.com/ldtteam/minecolonies/commit/f825ad35b571d688a6b1f19951cf6eaa80e2374b", "message": "Fix dim change subscribers not registering correctly", "committedDate": "2020-04-28T10:32:37Z", "type": "commit"}, {"oid": "e33136bfcd856ed8f4a65386de3a65f1f54b6ce3", "url": "https://github.com/ldtteam/minecolonies/commit/e33136bfcd856ed8f4a65386de3a65f1f54b6ce3", "message": "Fix dim change subscribers not registering correctly", "committedDate": "2020-04-28T10:49:01Z", "type": "commit"}, {"oid": "132a6df1d1e467dca16344345ebabdc3cf2f711a", "url": "https://github.com/ldtteam/minecolonies/commit/132a6df1d1e467dca16344345ebabdc3cf2f711a", "message": "change loaded check for range message", "committedDate": "2020-04-28T14:27:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NzcyNA==", "url": "https://github.com/ldtteam/minecolonies/pull/4791#discussion_r417077724", "bodyText": "Null check please! Since you are explicitly returning null for the orElse(...) and it is possible that the capability does not exist for some reason or another, a null check is required here.", "author": "OrionDevelopment", "createdAt": "2020-04-29T05:40:37Z", "path": "src/main/java/com/minecolonies/coremod/event/EventHandler.java", "diffHunk": "@@ -210,6 +210,57 @@ public static void onChunkUnLoad(final ChunkEvent.Unload event)\n         }\n     }\n \n+    /**\n+     * Called right before dimension change event, used to remove the player from an existing colony\n+     *\n+     * @param event dim travel event.\n+     */\n+    @SubscribeEvent(priority = LOWEST)\n+    public static void onEntityTravelToDimensionEvent(final EntityTravelToDimensionEvent event)\n+    {\n+        if (event.getEntity() instanceof ServerPlayerEntity && !event.isCanceled())\n+        {\n+            final ServerPlayerEntity player = (ServerPlayerEntity) event.getEntity();\n+            final Chunk oldChunk = player.world.getChunk(player.chunkCoordX, player.chunkCoordZ);\n+            final IColonyTagCapability oldCloseColonies = oldChunk.getCapability(CLOSE_COLONY_CAP, null).orElse(null);\n+            // Remove visiting/subscriber from old colony\n+            if (oldCloseColonies.getOwningColony() != 0)", "originalCommit": "132a6df1d1e467dca16344345ebabdc3cf2f711a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4ec4d546d141230a22f0e6d29841dd33cc009bbf", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/event/EventHandler.java b/src/main/java/com/minecolonies/coremod/event/EventHandler.java\nindex 7d62da7e20..37bd1de7b1 100644\n--- a/src/main/java/com/minecolonies/coremod/event/EventHandler.java\n+++ b/src/main/java/com/minecolonies/coremod/event/EventHandler.java\n\n@@ -223,14 +223,18 @@ public class EventHandler\n             final ServerPlayerEntity player = (ServerPlayerEntity) event.getEntity();\n             final Chunk oldChunk = player.world.getChunk(player.chunkCoordX, player.chunkCoordZ);\n             final IColonyTagCapability oldCloseColonies = oldChunk.getCapability(CLOSE_COLONY_CAP, null).orElse(null);\n-            // Remove visiting/subscriber from old colony\n-            if (oldCloseColonies.getOwningColony() != 0)\n+\n+            if (oldCloseColonies != null)\n             {\n-                final IColony oldColony = IColonyManager.getInstance().getColonyByWorld(oldCloseColonies.getOwningColony(), player.world);\n-                if (oldColony != null)\n+                // Remove visiting/subscriber from old colony\n+                if (oldCloseColonies.getOwningColony() != 0)\n                 {\n-                    oldColony.removeVisitingPlayer(player);\n-                    oldColony.getPackageManager().removeCloseSubscriber(player);\n+                    final IColony oldColony = IColonyManager.getInstance().getColonyByWorld(oldCloseColonies.getOwningColony(), player.world);\n+                    if (oldColony != null)\n+                    {\n+                        oldColony.removeVisitingPlayer(player);\n+                        oldColony.getPackageManager().removeCloseSubscriber(player);\n+                    }\n                 }\n             }\n         }\n"}}, {"oid": "4ec4d546d141230a22f0e6d29841dd33cc009bbf", "url": "https://github.com/ldtteam/minecolonies/commit/4ec4d546d141230a22f0e6d29841dd33cc009bbf", "message": "Add null check", "committedDate": "2020-04-29T07:22:26Z", "type": "commit"}]}