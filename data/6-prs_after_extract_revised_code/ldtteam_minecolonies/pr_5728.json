{"pr_number": 5728, "pr_title": "Improve tool usage in the cook and other crafters", "pr_createdAt": "2020-09-06T22:43:42Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5728", "timeline": [{"oid": "43d0dd9f32936f89e4470a12522ac4d234f76a39", "url": "https://github.com/ldtteam/minecolonies/commit/43d0dd9f32936f89e4470a12522ac4d234f76a39", "message": "Improve tool handling during crafting", "committedDate": "2020-09-06T22:37:26Z", "type": "commit"}, {"oid": "0917a80931fb84d9d6db7ef10f9c9c32c38c681c", "url": "https://github.com/ldtteam/minecolonies/commit/0917a80931fb84d9d6db7ef10f9c9c32c38c681c", "message": "reduce the item count needed for compost", "committedDate": "2020-09-06T22:37:44Z", "type": "commit"}, {"oid": "001aac64c76453624124d43ead0ffd96e32f50cc", "url": "https://github.com/ldtteam/minecolonies/commit/001aac64c76453624124d43ead0ffd96e32f50cc", "message": "Bit of cleanup", "committedDate": "2020-09-06T22:38:08Z", "type": "commit"}, {"oid": "5b7934432cad125c91ff2e2b37b1398de40f5c82", "url": "https://github.com/ldtteam/minecolonies/commit/5b7934432cad125c91ff2e2b37b1398de40f5c82", "message": "decompress hay", "committedDate": "2020-09-06T22:38:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEyNTczNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5728#discussion_r484125735", "bodyText": "I think you want to copy this stack before modifying it? else the \"recipe\" objects output stack might get changed for further uses", "author": "someaddons", "createdAt": "2020-09-06T23:18:40Z", "path": "src/main/java/com/minecolonies/coremod/util/FurnaceRecipes.java", "diffHunk": "@@ -55,16 +54,13 @@ private void loadRecipes(final MinecraftServer server)\n             final NonNullList<Ingredient> list = recipe.getIngredients();\n             if (list.size() == 1)\n             {\n-                for (final ItemStack stack : list.get(0).getMatchingStacks())\n-                {\n-                    final RecipeStorage storage = new RecipeStorage(new StandardToken(), Collections.singletonList(stack), 1, recipe.getRecipeOutput(), Blocks.FURNACE);\n+                final RecipeStorage storage = new RecipeStorage(new StandardToken(), Arrays.asList(list.get(0).getMatchingStacks()), 1, recipe.getRecipeOutput(), Blocks.FURNACE);\n \n-                    recipes.put(new ItemStorage(stack), storage);\n+                recipes.put(storage.getCleanedInput().get(0), storage);\n \n-                    final ItemStack output = recipe.getRecipeOutput();\n-                    output.setCount(1);\n-                    reverseRecipes.put(new ItemStorage(output), storage);\n-                }\n+                final ItemStack output = recipe.getRecipeOutput();\n+                output.setCount(1);", "originalCommit": "5b7934432cad125c91ff2e2b37b1398de40f5c82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7a6c21cdb0ef4738d915d64a296b1938e96a53e", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/util/FurnaceRecipes.java b/src/main/java/com/minecolonies/coremod/util/FurnaceRecipes.java\nindex 2694c64f36..08e45f45dc 100755\n--- a/src/main/java/com/minecolonies/coremod/util/FurnaceRecipes.java\n+++ b/src/main/java/com/minecolonies/coremod/util/FurnaceRecipes.java\n\n@@ -58,7 +58,7 @@ public class FurnaceRecipes implements IFurnaceRecipes\n \n                 recipes.put(storage.getCleanedInput().get(0), storage);\n \n-                final ItemStack output = recipe.getRecipeOutput();\n+                final ItemStack output = recipe.getRecipeOutput().copy();\n                 output.setCount(1);\n                 reverseRecipes.put(new ItemStorage(output), storage);\n             }\n"}}, {"oid": "f7a6c21cdb0ef4738d915d64a296b1938e96a53e", "url": "https://github.com/ldtteam/minecolonies/commit/f7a6c21cdb0ef4738d915d64a296b1938e96a53e", "message": "PR feedback", "committedDate": "2020-09-07T03:12:38Z", "type": "commit"}, {"oid": "817fbc71a1ee8e6aa6c037e3321c2f4ffecc87df", "url": "https://github.com/ldtteam/minecolonies/commit/817fbc71a1ee8e6aa6c037e3321c2f4ffecc87df", "message": "Fix resolution, and clean up", "committedDate": "2020-09-07T04:23:34Z", "type": "commit"}, {"oid": "bbaedcae6bc82089d9bfccd2b7a22d3e79bf7b68", "url": "https://github.com/ldtteam/minecolonies/commit/bbaedcae6bc82089d9bfccd2b7a22d3e79bf7b68", "message": "Merge branch 'version/1.15' into improve/misc", "committedDate": "2020-09-07T16:25:42Z", "type": "commit"}, {"oid": "79dd1645c8606ba50d4d4a36704c85581a92bedb", "url": "https://github.com/ldtteam/minecolonies/commit/79dd1645c8606ba50d4d4a36704c85581a92bedb", "message": "Cleanup for clarity", "committedDate": "2020-09-07T17:03:20Z", "type": "commit"}, {"oid": "f84e51892d6bffe82436a54dee8384a8bb2fc659", "url": "https://github.com/ldtteam/minecolonies/commit/f84e51892d6bffe82436a54dee8384a8bb2fc659", "message": "Fix ingredient resolution of coocables", "committedDate": "2020-09-07T17:03:48Z", "type": "commit"}, {"oid": "025baab7f8a56e9fe0a1f94f59b9c1fc7c8d8735", "url": "https://github.com/ldtteam/minecolonies/commit/025baab7f8a56e9fe0a1f94f59b9c1fc7c8d8735", "message": "Merge branch 'version/1.15' into improve/misc", "committedDate": "2020-09-08T13:40:35Z", "type": "commit"}, {"oid": "967499df38092bd77e5cd7a649d729a61190a0fe", "url": "https://github.com/ldtteam/minecolonies/commit/967499df38092bd77e5cd7a649d729a61190a0fe", "message": "Remove unnecessary check", "committedDate": "2020-09-08T13:45:48Z", "type": "commit"}, {"oid": "4f2a9f6dcf7aeabb87d8ef57d3dece85fa33a5a9", "url": "https://github.com/ldtteam/minecolonies/commit/4f2a9f6dcf7aeabb87d8ef57d3dece85fa33a5a9", "message": "cleanup", "committedDate": "2020-09-08T14:19:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwNTE4OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5728#discussion_r485005188", "bodyText": "Will the cook keep all container items for forever? 20 buckets of milk or water too?", "author": "Raycoms", "createdAt": "2020-09-08T15:21:37Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingCook.java", "diffHunk": "@@ -103,6 +104,7 @@ public BuildingCook(final IColony c, final BlockPos l)\n         keepX.put(ItemStackUtils.ISFOOD, new Tuple<>(STACKSIZE, true));\n         keepX.put(ItemStackUtils.ISCOOKABLE, new Tuple<>(STACKSIZE, true));\n         keepX.put(stack -> isAllowedFuel(stack), new Tuple<>(STACKSIZE, true));\n+        keepX.put(stack -> !ItemStackUtils.isEmpty(stack.getContainerItem()), new Tuple<>(STACKSIZE, false));\n     }", "originalCommit": "4f2a9f6dcf7aeabb87d8ef57d3dece85fa33a5a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxMjg0MA==", "url": "https://github.com/ldtteam/minecolonies/pull/5728#discussion_r485012840", "bodyText": "I should probably exclude milk and water. Probably by excluding buckets. I want to replace this with the custom data load you and I talked about eventually, but realized that this was pretty close to what was needed for now.", "author": "Mekle001", "createdAt": "2020-09-08T15:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwNTE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "d46961018531bc85ff004876ad1a001e929ef6db", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingCook.java b/src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingCook.java\nindex a20cf6e4e3..02a74ceb15 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingCook.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/buildings/workerbuildings/BuildingCook.java\n\n@@ -104,7 +105,7 @@ public class BuildingCook extends AbstractBuildingSmelterCrafter\n         keepX.put(ItemStackUtils.ISFOOD, new Tuple<>(STACKSIZE, true));\n         keepX.put(ItemStackUtils.ISCOOKABLE, new Tuple<>(STACKSIZE, true));\n         keepX.put(stack -> isAllowedFuel(stack), new Tuple<>(STACKSIZE, true));\n-        keepX.put(stack -> !ItemStackUtils.isEmpty(stack.getContainerItem()), new Tuple<>(STACKSIZE, false));\n+        keepX.put(stack -> !ItemStackUtils.isEmpty(stack.getContainerItem()) && !stack.getContainerItem().getItem().equals(Items.BUCKET), new Tuple<>(STACKSIZE, false));\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwNjAxNw==", "url": "https://github.com/ldtteam/minecolonies/pull/5728#discussion_r485006017", "bodyText": "\"i\" might be bad, better stack", "author": "Raycoms", "createdAt": "2020-09-08T15:22:50Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/cook/EntityAIWorkCook.java", "diffHunk": "@@ -271,16 +271,16 @@ protected IAIState checkForImportantJobs()\n             citizenToServe.addAll(citizenList);\n             playerToServe.addAll(playerList);\n \n-            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), ItemStackUtils.CAN_EAT))\n+            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), i -> ItemStackUtils.CAN_EAT.test(i) && !getOwnBuilding().isItemStackInRequest(i)))", "originalCommit": "4f2a9f6dcf7aeabb87d8ef57d3dece85fa33a5a9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d46961018531bc85ff004876ad1a001e929ef6db", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/entity/ai/citizen/cook/EntityAIWorkCook.java b/src/main/java/com/minecolonies/coremod/entity/ai/citizen/cook/EntityAIWorkCook.java\nindex 020570e25c..ae2916c859 100755\n--- a/src/main/java/com/minecolonies/coremod/entity/ai/citizen/cook/EntityAIWorkCook.java\n+++ b/src/main/java/com/minecolonies/coremod/entity/ai/citizen/cook/EntityAIWorkCook.java\n\n@@ -271,16 +271,16 @@ public class EntityAIWorkCook extends AbstractEntityAIUsesFurnace<JobCook, Build\n             citizenToServe.addAll(citizenList);\n             playerToServe.addAll(playerList);\n \n-            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), i -> ItemStackUtils.CAN_EAT.test(i) && !getOwnBuilding().isItemStackInRequest(i)))\n+            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), stack -> ItemStackUtils.CAN_EAT.test(stack) && !getOwnBuilding().isItemStackInRequest(stack)))\n             {\n                 return COOK_SERVE_FOOD_TO_CITIZEN;\n             }\n-            else if (!InventoryUtils.hasItemInProvider(getOwnBuilding(), i -> ItemStackUtils.CAN_EAT.test(i) && !getOwnBuilding().isItemStackInRequest(i)))\n+            else if (!InventoryUtils.hasItemInProvider(getOwnBuilding(), stack -> ItemStackUtils.CAN_EAT.test(stack) && !getOwnBuilding().isItemStackInRequest(stack)))\n             {\n                 return START_WORKING;\n             }\n \n-            needsCurrently = new Tuple<>(i -> ItemStackUtils.CAN_EAT.test(i) && !getOwnBuilding().isItemStackInRequest(i), STACKSIZE);\n+            needsCurrently = new Tuple<>(stack -> ItemStackUtils.CAN_EAT.test(stack) && !getOwnBuilding().isItemStackInRequest(stack), STACKSIZE);\n             return GATHERING_REQUIRED_MATERIALS;\n         }\n \n"}}, {"oid": "d46961018531bc85ff004876ad1a001e929ef6db", "url": "https://github.com/ldtteam/minecolonies/commit/d46961018531bc85ff004876ad1a001e929ef6db", "message": "PR feedback", "committedDate": "2020-09-08T15:37:56Z", "type": "commit"}, {"oid": "c0cfea64824ab84b9b34038fc4a40cd75f0641aa", "url": "https://github.com/ldtteam/minecolonies/commit/c0cfea64824ab84b9b34038fc4a40cd75f0641aa", "message": "Stabilize Charcoal burning", "committedDate": "2020-09-08T17:06:29Z", "type": "commit"}]}