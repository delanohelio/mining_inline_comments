{"pr_number": 6305, "pr_title": "Improves Ship Raid Events, respells Babarian.", "pr_createdAt": "2020-12-27T21:22:43Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6305", "timeline": [{"oid": "c2b0e8de44b65f04cea7f52bf0b254fb163434de", "url": "https://github.com/ldtteam/minecolonies/commit/c2b0e8de44b65f04cea7f52bf0b254fb163434de", "message": "Fixes to Ship Raid Spawns, Barbarian Spelling\n\nEventStructureManager was saving to paths including the full ResourceName of a dimension (ie schematicsstructbackup1 [minecraft : overworld]BlockPos{x=42, y=59, z=-208}.blueprint), which is not a valid file name on FAT32 and most Windows NTFS situations, as colons are a restricted character outside of POSIX emulation mode.  Changed structure to instead use ResourceName.namespace + ResourceName.path (ie schematicsstructbackup1minecraftoverworldBlockPos{x=42, y=59, z=-208}.blueprint.\n\nThis will cause some ships to not properly despawn on the few machines that were seeing them before.  Probably not the biggest problem.\n\nFixes babarian->barbarian.\n\nFixes norsemen ships checking for biomes when spawned by command.  They will  still check for water/ice regardless; if there's not a valid ship spawning location they'll do their ground variant instead.  Norsemen ship natural spawns will still check for biomes.", "committedDate": "2020-12-27T21:20:18Z", "type": "commit"}, {"oid": "e41c3adbc067e02d2c818564ed7d6fa567ecdb10", "url": "https://github.com/ldtteam/minecolonies/commit/e41c3adbc067e02d2c818564ed7d6fa567ecdb10", "message": "Further Fixes to Commands and Temporary Ship Structures\n\nExcludes norsemen_ship_raid and pirate_ground_raid from the events list, since neither group's ship variant can be guaranteed.  Added ground pirates to the ColonyEventTypeRegistry as a separate group instead of bumming off normal pirates.\n\nChanges files again, to use path as subdirectories instead of single long names.  Adds a compat layer to load old file formats from those OS that supported them.", "committedDate": "2020-12-28T00:26:48Z", "type": "commit"}, {"oid": "cd957c6c66321994fa8b0b5815e5b9c28d769aaa", "url": "https://github.com/ldtteam/minecolonies/commit/cd957c6c66321994fa8b0b5815e5b9c28d769aaa", "message": "Merge branch 'version/1.16.3' into version/1.16.3-command-and-gui", "committedDate": "2020-12-28T16:05:16Z", "type": "commit"}, {"oid": "d07f0f452602a204388c669c4177a84cd3393d00", "url": "https://github.com/ldtteam/minecolonies/commit/d07f0f452602a204388c669c4177a84cd3393d00", "message": "Merge branch 'version/1.16.3' into version/1.16.3-command-and-gui", "committedDate": "2020-12-29T03:51:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYyMjQ2OA==", "url": "https://github.com/ldtteam/minecolonies/pull/6305#discussion_r549622468", "bodyText": "should be the other way around, first new backup path, if not exist try old", "author": "Raycoms", "createdAt": "2020-12-29T08:53:39Z", "path": "src/main/java/com/minecolonies/coremod/colony/managers/EventStructureManager.java", "diffHunk": "@@ -156,8 +157,16 @@ public void loadBackupForEvent(final int eventID)\n \n             if (entry.getValue() == eventID)\n             {\n-                final String backupPath = String.valueOf(colony.getID()) + colony.getDimension() + entry.getKey();\n-                final String fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + STRUCTURE_BACKUP_FOLDER).toString() + backupPath;\n+                //TODO: remove compat for colony.getDimension()-based file names after sufficient time has passed from PR#6305\n+                final String oldBackupPath = String.valueOf(colony.getID()) + colony.getDimension() + entry.getKey();\n+                String fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + STRUCTURE_BACKUP_FOLDER).toString() + oldBackupPath;\n+\n+                File blueprintFile = new File(fileName);\n+                if(!blueprintFile.exists())", "originalCommit": "d07f0f452602a204388c669c4177a84cd3393d00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc1MjU1Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6305#discussion_r549752553", "bodyText": "Ok.  Swapped to that approach, and also had it use the Structurize handlers for the check.", "author": "gattsuru", "createdAt": "2020-12-29T15:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYyMjQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "c90358733cc1474df2818256830eaba38b53e731", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/managers/EventStructureManager.java b/src/main/java/com/minecolonies/coremod/colony/managers/EventStructureManager.java\nindex 151f3ebc4a..e7c0b46d86 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/managers/EventStructureManager.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/managers/EventStructureManager.java\n\n@@ -157,24 +157,27 @@ public class EventStructureManager implements IEventStructureManager\n \n             if (entry.getValue() == eventID)\n             {\n-                //TODO: remove compat for colony.getDimension()-based file names after sufficient time has passed from PR#6305\n                 final String oldBackupPath = String.valueOf(colony.getID()) + colony.getDimension() + entry.getKey();\n-                String fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + STRUCTURE_BACKUP_FOLDER).toString() + oldBackupPath;\n-\n-                File blueprintFile = new File(fileName);\n-                if(!blueprintFile.exists())\n+                String fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + \"/\" + STRUCTURE_BACKUP_FOLDER).toString() + \"/\" +\n+                        String.valueOf(colony.getID()) + \"/\" + colony.getDimension().getLocation().getNamespace() + colony.getDimension().getLocation().getPath() + \"/\" + entry.getKey();\n+\n+                // TODO: remove compat for colony.getDimension()-based file names after sufficient time has passed from PR#6305\n+                if(CreativeBuildingStructureHandler.loadAndPlaceStructureWithRotation(colony.getWorld(),\n+                    fileName,\n+                    entry.getKey(),\n+                    Rotation.NONE,\n+                    Mirror.NONE,\n+                    true, null) == null)\n                 {\n-                    fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + \"/\" + STRUCTURE_BACKUP_FOLDER).toString() + \"/\" +\n-                                 String.valueOf(colony.getID()) + \"/\" + colony.getDimension().getLocation().getNamespace() + colony.getDimension().getLocation().getPath() + \"/\" + entry.getKey();\n+                    fileName = new StructureName(\"cache\", \"backup\", Structures.SCHEMATICS_PREFIX + STRUCTURE_BACKUP_FOLDER).toString() + oldBackupPath;\n+                    CreativeBuildingStructureHandler.loadAndPlaceStructureWithRotation(colony.getWorld(),\n+                            fileName,\n+                            entry.getKey(),\n+                            Rotation.NONE,\n+                            Mirror.NONE,\n+                            true, null);\n                 }\n \n-                CreativeBuildingStructureHandler.loadAndPlaceStructureWithRotation(colony.getWorld(),\n-                  fileName,\n-                  entry.getKey(),\n-                  Rotation.NONE,\n-                  Mirror.NONE,\n-                  true, null);\n-\n                 try\n                 {\n                     Structurize.proxy.getSchematicsFolder().toPath().resolve(fileName + SCHEMATIC_EXTENSION_NEW).toFile().delete();\n"}}, {"oid": "c90358733cc1474df2818256830eaba38b53e731", "url": "https://github.com/ldtteam/minecolonies/commit/c90358733cc1474df2818256830eaba38b53e731", "message": "Changes compat layer for old name format of temporary structure files, prioritizing the current version first.  Also uses Structurize's builtins instead of File checks for better compatibility.", "committedDate": "2020-12-29T15:45:44Z", "type": "commit"}, {"oid": "d21f8037168f4b0084788fb55b927e9de6c783bc", "url": "https://github.com/ldtteam/minecolonies/commit/d21f8037168f4b0084788fb55b927e9de6c783bc", "message": "Merge branch 'version/1.16.3' into version/1.16.3-command-and-gui", "committedDate": "2020-12-30T13:51:23Z", "type": "commit"}]}