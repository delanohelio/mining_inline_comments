{"pr_number": 5862, "pr_title": "Fix/multiples", "pr_createdAt": "2020-10-03T08:15:51Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5862", "timeline": [{"oid": "bcfd061b59679f81175ca0d07f6cede080ad4b76", "url": "https://github.com/ldtteam/minecolonies/commit/bcfd061b59679f81175ca0d07f6cede080ad4b76", "message": "Several Fixes\n\nBetter stat inheritance\nIncreased pupil leveling\nWarehouse resolving to closest\nRemove recall all at townhall\nAdd recall to citizen hut\nFix team display on client side", "committedDate": "2020-10-02T18:16:38Z", "type": "commit"}, {"oid": "092f84f82d0f8902c79042df55246229705b2c93", "url": "https://github.com/ldtteam/minecolonies/commit/092f84f82d0f8902c79042df55246229705b2c93", "message": "fix #5840", "committedDate": "2020-10-03T08:11:41Z", "type": "commit"}, {"oid": "084ef1888319d2449ce813f7d826b7ab37d1f26a", "url": "https://github.com/ldtteam/minecolonies/commit/084ef1888319d2449ce813f7d826b7ab37d1f26a", "message": "Setup resolvers better", "committedDate": "2020-10-03T10:35:42Z", "type": "commit"}, {"oid": "1faa103459afd8238fbec0e3c5aea798cbe51da7", "url": "https://github.com/ldtteam/minecolonies/commit/1faa103459afd8238fbec0e3c5aea798cbe51da7", "message": "remove unnecessary sort", "committedDate": "2020-10-03T10:44:18Z", "type": "commit"}, {"oid": "32789e9e4062edc2a267ebf8e666e592e40cdcab", "url": "https://github.com/ldtteam/minecolonies/commit/32789e9e4062edc2a267ebf8e666e592e40cdcab", "message": "simplify", "committedDate": "2020-10-03T10:51:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MTI3OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5862#discussion_r499141278", "bodyText": "if you only need the closest just keep the closest saved, no need to re-sort the entire list", "author": "someaddons", "createdAt": "2020-10-03T11:48:39Z", "path": "src/main/java/com/minecolonies/coremod/colony/managers/BuildingManager.java", "diffHunk": "@@ -257,6 +257,34 @@ public IBuilding getBuilding(final BlockPos buildingId)\n         return null;\n     }\n \n+    @Nullable\n+    @Override\n+    public IWareHouse getClosestWarehouseInColony(final BlockPos pos)\n+    {\n+        final List<IWareHouse> wareHouses = new ArrayList<>();\n+        for (final IBuilding building : colony.getBuildingManager().getBuildings().values())\n+        {\n+            if (building instanceof BuildingWareHouse && building.getTileEntity() != null)\n+            {\n+                wareHouses.add((IWareHouse) building);\n+            }\n+        }\n+\n+        wareHouses.removeIf(Objects::isNull);\n+        wareHouses.sort((w1, w2) ->\n+        {\n+            final double dist1 = w1.getPosition().distanceSq(pos);\n+            final double dist2 = w2.getPosition().distanceSq(pos);\n+            return Double.compare(dist1, dist2);\n+        });", "originalCommit": "32789e9e4062edc2a267ebf8e666e592e40cdcab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d784b86b8f577fe7feebe832044383e5a294887", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/managers/BuildingManager.java b/src/main/java/com/minecolonies/coremod/colony/managers/BuildingManager.java\nindex 04ca5f883..d4c33304e 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/managers/BuildingManager.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/managers/BuildingManager.java\n\n@@ -261,28 +261,22 @@ public class BuildingManager implements IBuildingManager\n     @Override\n     public IWareHouse getClosestWarehouseInColony(final BlockPos pos)\n     {\n-        final List<IWareHouse> wareHouses = new ArrayList<>();\n+        IWareHouse wareHouse = null;\n+        double dist = 0;\n         for (final IBuilding building : colony.getBuildingManager().getBuildings().values())\n         {\n             if (building instanceof BuildingWareHouse && building.getTileEntity() != null)\n             {\n-                wareHouses.add((IWareHouse) building);\n+                final double tempDist = building.getPosition().distanceSq(pos);\n+                if (wareHouse == null || tempDist < dist)\n+                {\n+                    dist = tempDist;\n+                    wareHouse= (IWareHouse) building;\n+                }\n             }\n         }\n \n-        wareHouses.removeIf(Objects::isNull);\n-        wareHouses.sort((w1, w2) ->\n-        {\n-            final double dist1 = w1.getPosition().distanceSq(pos);\n-            final double dist2 = w2.getPosition().distanceSq(pos);\n-            return Double.compare(dist1, dist2);\n-        });\n-\n-        if (wareHouses.isEmpty())\n-        {\n-            return null;\n-        }\n-        return wareHouses.get(0);\n+        return wareHouse;\n     }\n \n     @Override\n"}}, {"oid": "1d784b86b8f577fe7feebe832044383e5a294887", "url": "https://github.com/ldtteam/minecolonies/commit/1d784b86b8f577fe7feebe832044383e5a294887", "message": "make this more performant", "committedDate": "2020-10-03T11:54:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MTc4OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5862#discussion_r499141788", "bodyText": "unneeded null check, we only add notnull objects", "author": "someaddons", "createdAt": "2020-10-03T11:56:57Z", "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/core/AbstractWarehouseRequestResolver.java", "diffHunk": "@@ -264,6 +262,14 @@ public void onAssignedRequestCancelled(@NotNull final IRequestManager manager, @\n             }\n         }\n \n+        wareHouses.removeIf(Objects::isNull);", "originalCommit": "32789e9e4062edc2a267ebf8e666e592e40cdcab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "639e2d040f5368aa207f1792bfc3c46e7e0d18ba", "chunk": "diff --git a/src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/core/AbstractWarehouseRequestResolver.java b/src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/core/AbstractWarehouseRequestResolver.java\nindex eb6ed269f..767efe84d 100755\n--- a/src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/core/AbstractWarehouseRequestResolver.java\n+++ b/src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/core/AbstractWarehouseRequestResolver.java\n\n@@ -262,7 +262,6 @@ public abstract class AbstractWarehouseRequestResolver extends AbstractRequestRe\n             }\n         }\n \n-        wareHouses.removeIf(Objects::isNull);\n         wareHouses.sort((w1, w2) ->\n         {\n             final double dist1 = w1.getPosition().distanceSq(requesterPosition);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0MjI1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5862#discussion_r499142255", "bodyText": "could we here instead do data.setLastpos(buildingpos) -> existing entity remove(or null) -> data.updateEntityIfNecessary() ?\nThen we're making sure to cleanup the references and get a valid entity in any case. E.g. when the data somehow has a no longer valid entities but still keeps that", "author": "someaddons", "createdAt": "2020-10-03T12:04:52Z", "path": "src/main/java/com/minecolonies/coremod/network/messages/server/colony/building/RecallCitizenHutMessage.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.minecolonies.coremod.network.messages.server.colony.building;\n+\n+import com.ldtteam.structurize.util.LanguageHandler;\n+import com.minecolonies.api.colony.ICitizenData;\n+import com.minecolonies.api.colony.IColony;\n+import com.minecolonies.api.colony.buildings.IBuilding;\n+import com.minecolonies.api.entity.citizen.AbstractEntityCitizen;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.coremod.colony.buildings.views.AbstractBuildingView;\n+import com.minecolonies.coremod.network.messages.server.AbstractBuildingServerMessage;\n+import com.minecolonies.coremod.util.TeleportHelper;\n+import net.minecraft.entity.player.PlayerEntity;\n+import net.minecraft.network.PacketBuffer;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.World;\n+import net.minecraftforge.fml.network.NetworkEvent;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Used to handle citizen recalls to their hut.\n+ */\n+public class RecallCitizenHutMessage extends AbstractBuildingServerMessage<IBuilding>\n+{\n+    /**\n+     * Empty public constructor.\n+     */\n+    public RecallCitizenHutMessage()\n+    {\n+        super();\n+    }\n+\n+    /**\n+     * Creates a message to recall all citizens to their hut.\n+     *\n+     * @param building {@link AbstractBuildingView}\n+     */\n+    public RecallCitizenHutMessage(@NotNull final AbstractBuildingView building)\n+    {\n+        super(building);\n+    }\n+\n+    @Override\n+    protected void onExecute(@NotNull final NetworkEvent.Context ctxIn, final boolean isLogicalServer, @NotNull final IColony colony, @NotNull final IBuilding building)\n+    {\n+        final BlockPos location = building.getPosition();\n+        final World world = colony.getWorld();\n+        for (final ICitizenData citizenData : building.getAssignedCitizen())\n+        {\n+            Optional<AbstractEntityCitizen> optionalEntityCitizen = citizenData.getEntity();", "originalCommit": "32789e9e4062edc2a267ebf8e666e592e40cdcab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "639e2d040f5368aa207f1792bfc3c46e7e0d18ba", "url": "https://github.com/ldtteam/minecolonies/commit/639e2d040f5368aa207f1792bfc3c46e7e0d18ba", "message": "remove this", "committedDate": "2020-10-03T14:00:47Z", "type": "commit"}, {"oid": "737e9a178ed3982f7aef1f8eeb39244a4452fb31", "url": "https://github.com/ldtteam/minecolonies/commit/737e9a178ed3982f7aef1f8eeb39244a4452fb31", "message": "Merge branch 'version/1.15' into fix/multiples", "committedDate": "2020-10-03T14:08:10Z", "type": "commit"}, {"oid": "0d344e3100f114377994f6a5c1035077e97bef7d", "url": "https://github.com/ldtteam/minecolonies/commit/0d344e3100f114377994f6a5c1035077e97bef7d", "message": "Additional info for dman", "committedDate": "2020-10-03T19:18:38Z", "type": "commit"}]}