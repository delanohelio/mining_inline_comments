{"pr_number": 8943, "pr_title": "custom tab implementation instead of internal browser", "pr_createdAt": "2020-09-03T20:03:01Z", "pr_url": "https://github.com/cgeo/cgeo/pull/8943", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNDQ2Nw==", "url": "https://github.com/cgeo/cgeo/pull/8943#discussion_r483224467", "bodyText": "Codacy found an issue: Avoid unused private methods such as 'addOpenMenuItem(Context,CustomTabsIntent.Builder,Geocache)'.", "author": "cgeo-ci-bot", "createdAt": "2020-09-03T20:06:21Z", "path": "main/src/cgeo/geocaching/utils/ShareUtils.java", "diffHunk": "@@ -63,4 +74,75 @@ private static void shareInternal(final Context context, @NonNull final String m\n \n     }\n \n+\n+    //  -------- CustomTabs implementation --------  //\n+    public static void openTab(final Context context, final Geocache geocache) {\n+        final String url = geocache.getLongUrl();\n+        final CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();\n+\n+        builder.enableUrlBarHiding();\n+        builder.setShowTitle(true);\n+        setShareActionButton(context, builder, url);\n+        builder.addDefaultShareMenuItem();\n+        //addOpenMenuItem(context, builder, geocache);\n+\n+        final CustomTabsIntent customTabsIntent = builder.build();\n+        customTabsIntent.intent.setPackage(\"com.android.chrome\");\n+        customTabsIntent.launchUrl(context, Uri.parse(url));\n+    }\n+\n+    /* Sets share action button that is displayed in the Toolbar */\n+    private static void setShareActionButton(final Context context, final CustomTabsIntent.Builder builder, final String url) {\n+        final Bitmap icon = BitmapFactory.decodeResource(context.getResources(), android.R.drawable.ic_menu_share);\n+\n+        final Intent shareIntent = new Intent(Intent.ACTION_SEND);\n+        shareIntent.putExtra(Intent.EXTRA_TEXT, url);\n+        shareIntent.setType(\"text/plain\");\n+\n+        final PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, shareIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+        builder.setActionButton(icon, context.getString(R.string.cache_share_field), pendingIntent);\n+    }\n+\n+    /* Adds open with other app option to the menu - not working currently, therefore disabled it in openTab() for now */\n+    private static void addOpenMenuItem(final Context context, final CustomTabsIntent.Builder builder, final Geocache geocache) {", "originalCommit": "0a7008c6f03e6838f8f297f0e7b337a72ea30793", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d27ea1f7fe94ecac515f7cc05f7b9213d1443e85", "chunk": "diff --git a/main/src/cgeo/geocaching/utils/ShareUtils.java b/main/src/cgeo/geocaching/utils/ShareUtils.java\nindex f88dac65a..f45b84017 100644\n--- a/main/src/cgeo/geocaching/utils/ShareUtils.java\n+++ b/main/src/cgeo/geocaching/utils/ShareUtils.java\n\n@@ -69,80 +81,111 @@ public class ShareUtils {\n                 intent.putExtra(Intent.EXTRA_STREAM, uri);\n                 intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);\n             }\n-            context.startActivity(Intent.createChooser(intent, context.getString(titleResourceId)));\n+            return intent;\n         }\n \n+        return null;\n     }\n \n+    public static void sharePlainText(final Context context, final String text) {\n+        shareInternal(context, TYPE_TEXT, null, text, null, R.string.context_share_as_text);\n+    }\n \n-    //  -------- CustomTabs implementation --------  //\n-    public static void openTab(final Context context, final Geocache geocache) {\n-        final String url = geocache.getLongUrl();\n-        final CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();\n-\n-        builder.enableUrlBarHiding();\n-        builder.setShowTitle(true);\n-        setShareActionButton(context, builder, url);\n-        builder.addDefaultShareMenuItem();\n-        //addOpenMenuItem(context, builder, geocache);\n-\n-        final CustomTabsIntent customTabsIntent = builder.build();\n-        customTabsIntent.intent.setPackage(\"com.android.chrome\");\n-        customTabsIntent.launchUrl(context, Uri.parse(url));\n+    public static void shareLink(final Context context, final String subject, final String url) {\n+        shareInternal(context, getShareLinkIntent(subject, url), R.string.context_share_as_link);\n     }\n \n-    /* Sets share action button that is displayed in the Toolbar */\n-    private static void setShareActionButton(final Context context, final CustomTabsIntent.Builder builder, final String url) {\n-        final Bitmap icon = BitmapFactory.decodeResource(context.getResources(), android.R.drawable.ic_menu_share);\n+    public static Intent getShareLinkIntent(final String subject, final String url) {\n+        return createShareIntentInternal(null, TYPE_TEXT, subject, StringUtils.defaultString(url), null);\n+    }\n \n-        final Intent shareIntent = new Intent(Intent.ACTION_SEND);\n-        shareIntent.putExtra(Intent.EXTRA_TEXT, url);\n-        shareIntent.setType(\"text/plain\");\n+    public static void openUrl(final Context context, final String url) {\n+        openUrl(context, url, false);\n \n-        final PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, shareIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        builder.setActionButton(icon, context.getString(R.string.cache_share_field), pendingIntent);\n     }\n \n-    /* Adds open with other app option to the menu - not working currently, therefore disabled it in openTab() for now */\n-    private static void addOpenMenuItem(final Context context, final CustomTabsIntent.Builder builder, final Geocache geocache) {\n-        final Intent intent = generateIntent(context, geocache);\n-        final PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);\n-        builder.addMenuItem(context.getString(R.string.cache_menu_open_with), pendingIntent);\n-    }\n+    public static void openUrl(final Context context, final String url, final boolean showApplicationChooserWithCgeoExcluded) {\n+        if (StringUtils.isBlank(url)) {\n+            return;\n+        }\n \n-    public static void startApplicationIntent(final Context context, final Geocache geocache) {\n-        context.startActivity(generateIntent(context, geocache));\n-    }\n+        try {\n+            final Intent viewIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));\n \n-    private static Intent generateIntent(final Context context, final Geocache geocache) {\n-        final Intent viewIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(geocache.getLongUrl()));\n+            // Shows an application chooser with all possible targets except c:geo\n+            if (showApplicationChooserWithCgeoExcluded) {\n \n-        // Check if cgeo is the default, show the chooser to let the user choose a browser\n-        if (viewIntent.resolveActivity(context.getPackageManager()).getPackageName().equals(context.getPackageName())) {\n+                final PackageManager pm = context.getPackageManager();\n+                final List<ResolveInfo> activities;\n+                if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {\n+                    activities = pm.queryIntentActivities(viewIntent, PackageManager.MATCH_ALL);\n+                } else {\n+                    activities = pm.queryIntentActivities(viewIntent, 0);\n+                }\n+                final List<Intent> targetIntents = new ArrayList<Intent>();\n+                final List<String> packageNames = new ArrayList<String>();\n+\n+                for (ResolveInfo currentInfo : activities) {\n+                    final String packageName = currentInfo.activityInfo.packageName;\n+                    if (!context.getPackageName().equals(packageName)) {\n+                        final Intent targetIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));\n+                        targetIntent.setPackage(packageName);\n+                        targetIntents.add(targetIntent);\n+                        packageNames.add(packageName);\n+                    }\n+                }\n \n-            final PackageManager pm = context.getPackageManager();\n-            final List<ResolveInfo> activities = pm.queryIntentActivities(viewIntent, 0);\n-            final List<Intent> targetPDFIntents = new ArrayList<Intent>();\n+                // With some API versions / specific devices queryIntentActivities() does not seem to return any browsers if c:geo is set as default application. Therefore we have following lines as workaround.\n+                final List<ResolveInfo> browserActivities = pm.queryIntentActivities(new Intent(Intent.ACTION_VIEW, Uri.parse(\"https://example.com/\")), 0);\n+                for (ResolveInfo currentInfo : browserActivities) {\n+                    final String packageName = currentInfo.activityInfo.packageName;\n+                    if (!packageNames.contains(packageName)) {\n+                        final Intent targetIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));\n+                        targetIntent.setPackage(packageName);\n+                        targetIntents.add(targetIntent);\n+                        packageNames.add(packageName);\n+                    }\n+                }\n \n-            for (ResolveInfo currentInfo : activities) {\n-                final String packageName = currentInfo.activityInfo.packageName;\n-                if (!context.getPackageName().equals(packageName)) {\n-                    final Intent targetPdfIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(geocache.getLongUrl()));\n-                    targetPdfIntent.setPackage(packageName);\n-                    targetPDFIntents.add(targetPdfIntent);\n+                if (targetIntents.size() > 0) {\n+                    final Intent chooserIntent = Intent.createChooser(targetIntents.remove(0), context.getString(R.string.cache_menu_browser));\n+                    chooserIntent.putExtra(Intent.EXTRA_INITIAL_INTENTS, targetIntents.toArray(new Parcelable[] {}));\n+                    chooserIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);\n+                    context.startActivity(chooserIntent);\n+                } else {\n+                    throw new ActivityNotFoundException();\n                 }\n-            }\n \n-            if (targetPDFIntents.size() > 0) {\n-                final Intent chooserIntent = Intent.createChooser(targetPDFIntents.remove(0), context.getString(R.string.cache_menu_browser));\n-                chooserIntent.putExtra(Intent.EXTRA_INITIAL_INTENTS, targetPDFIntents.toArray(new Parcelable[] {}));\n-                return chooserIntent;\n             } else {\n-                Toast.makeText(context, context.getString(R.string.err_no_browser), Toast.LENGTH_SHORT).show();\n+                context.startActivity(viewIntent);\n             }\n \n+        } catch (final ActivityNotFoundException e) {\n+            Log.e(\"Cannot find suitable activity for URL '\" + url + \"'\", e);\n+            ActivityMixin.showToast(context, R.string.err_application_no);\n         }\n-        return viewIntent;\n     }\n \n+    public static void openCustomTab(final Context context, final String url) {\n+        if (ProcessUtils.isLaunchable(\"com.android.chrome\")) {\n+\n+            final CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();\n+\n+            builder.enableUrlBarHiding();\n+            builder.setShowTitle(true);\n+            builder.addDefaultShareMenuItem();\n+\n+            final Intent actionIntent = new Intent(context, ShareBroadcastReceiver.class);\n+            final PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, actionIntent, PendingIntent.FLAG_UPDATE_CURRENT);\n+            builder.addMenuItem(context.getString(R.string.cache_menu_open_with), pendingIntent);\n+\n+            final CustomTabsIntent customTabsIntent = builder.build();\n+            // custom tabs API was restricted to chrome as other browsers like firefox may loop back to c:geo (as of September 2020)\n+            customTabsIntent.intent.setPackage(\"com.android.chrome\");\n+            customTabsIntent.launchUrl(context, Uri.parse(url));\n+\n+        } else {\n+            openUrl(context, url, true);\n+        }\n+    }\n }\n"}}, {"oid": "d27ea1f7fe94ecac515f7cc05f7b9213d1443e85", "url": "https://github.com/cgeo/cgeo/commit/d27ea1f7fe94ecac515f7cc05f7b9213d1443e85", "message": "custom tab implementation instead of internal browser", "committedDate": "2020-11-18T22:19:23Z", "type": "forcePushed"}, {"oid": "1dce876556ad30e5fd0f845196935ae4ad543773", "url": "https://github.com/cgeo/cgeo/commit/1dce876556ad30e5fd0f845196935ae4ad543773", "message": "custom tab implementation instead of internal browser", "committedDate": "2020-11-19T08:14:02Z", "type": "commit"}, {"oid": "1dce876556ad30e5fd0f845196935ae4ad543773", "url": "https://github.com/cgeo/cgeo/commit/1dce876556ad30e5fd0f845196935ae4ad543773", "message": "custom tab implementation instead of internal browser", "committedDate": "2020-11-19T08:14:02Z", "type": "forcePushed"}]}