{"pr_number": 2978, "pr_title": "Tenant qualify config store API", "pr_createdAt": "2020-06-19T12:02:34Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2978", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443300731", "bodyText": "Is this needed. Isn't the expectation of the dao is to read tenant from PrivilegedCarbonContext.\nIn that case, we can have a tenant flow initiated from the service layer right", "author": "malithie", "createdAt": "2020-06-22T03:27:56Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -652,9 +652,15 @@ public void addResource(Resource resource) throws ConfigurationManagementExcepti\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            preparedStatement.setInt(++initialParameterIndex,\n-                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId());\n+                            int tenantId;\n+                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                            if (StringUtils.isBlank(tenantDomain)) {\n+                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                        .getTenantId();\n+                            } else {\n+                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                            }\n+                            preparedStatement.setInt(++initialParameterIndex, tenantId);", "originalCommit": "755d01bf09b510da4a52066fbb0267ff4e2d525c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxOTUwNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443419507", "bodyText": "It seems that correct tenant domain is retrieved from PrivilegedCarbonContext even though we don't have a tenant flow initiated from the service layer. So shall I keep the old code as it is?", "author": "emswbandara", "createdAt": "2020-06-22T09:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5NzUxMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443497510", "bodyText": "+1", "author": "malithie", "createdAt": "2020-06-22T11:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ=="}], "type": "inlineReview", "revised_code": {"commit": "8e9bb50b9481490795e594732f480d261eefc0bc", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\nindex 638aa39ef45..57a9eaeec11 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\n\n@@ -652,15 +652,9 @@ public class ConfigurationDAOImpl implements ConfigurationDAO {\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            int tenantId;\n-                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n-                            if (StringUtils.isBlank(tenantDomain)) {\n-                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                        .getTenantId();\n-                            } else {\n-                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-                            }\n-                            preparedStatement.setInt(++initialParameterIndex, tenantId);\n+                            preparedStatement.setInt(++initialParameterIndex,\n+                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                            .getTenantId());\n                             preparedStatement.setString(++initialParameterIndex, resource.getResourceName());\n                             if (useCreatedTimeField()) {\n                                 preparedStatement.setTimestamp(++initialParameterIndex, currentTime, calendar);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTM1MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335351", "bodyText": "Can't we call getTenantDomain() method here?", "author": "mefarazath", "createdAt": "2020-06-22T06:10:57Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -441,12 +482,25 @@ private void validateResourcesRetrieveRequest(String resourceTypeName)\n \n     private int getTenantId() {\n \n-        return PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId();\n+        int tenantId;\n+        String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();", "originalCommit": "755d01bf09b510da4a52066fbb0267ff4e2d525c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e9bb50b9481490795e594732f480d261eefc0bc", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java\nindex 59f4389d1f7..a05979f239f 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java\n\n@@ -482,25 +482,12 @@ public class ConfigurationManagerImpl implements ConfigurationManager {\n \n     private int getTenantId() {\n \n-        int tenantId;\n-        String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n-        if (StringUtils.isBlank(tenantDomain)) {\n-            tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                    .getTenantId();\n-        } else {\n-            tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-        }\n-        return tenantId;\n+        return PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId();\n     }\n \n     private String getTenantDomain() {\n \n-        String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n-        if (StringUtils.isBlank(tenantDomain)) {\n-            tenantDomain = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                    .getTenantDomain();\n-        }\n-        return tenantDomain;\n+        return PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantDomain();\n     }\n \n     private void validateResourceDeleteRequest(String resourceTypeName, String resourceName)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTY0OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335649", "bodyText": "This logic seems to repeat. Can we move this logic to a common function / utility and re-use?", "author": "mefarazath", "createdAt": "2020-06-22T06:11:56Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -987,8 +999,15 @@ private void updateMetadataForH2(Resource resource, String resourceTypeId, boole\n                     template.executeInsert(UPDATE_RESOURCE_H2,\n                             preparedStatement -> {\n                                 int initialParameterIndex = 1;\n-                                preparedStatement.setInt(initialParameterIndex,\n-                                        PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId());\n+                                int tenantId;\n+                                String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                                if (StringUtils.isBlank(tenantDomain)) {\n+                                    tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                            .getTenantId();\n+                                } else {\n+                                    tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                                }", "originalCommit": "755d01bf09b510da4a52066fbb0267ff4e2d525c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e9bb50b9481490795e594732f480d261eefc0bc", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\nindex 638aa39ef45..57a9eaeec11 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java\n\n@@ -999,15 +987,8 @@ public class ConfigurationDAOImpl implements ConfigurationDAO {\n                     template.executeInsert(UPDATE_RESOURCE_H2,\n                             preparedStatement -> {\n                                 int initialParameterIndex = 1;\n-                                int tenantId;\n-                                String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n-                                if (StringUtils.isBlank(tenantDomain)) {\n-                                    tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId();\n-                                } else {\n-                                    tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-                                }\n-                                preparedStatement.setInt(initialParameterIndex, tenantId);\n+                                preparedStatement.setInt(initialParameterIndex,\n+                                        PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId());\n                                 preparedStatement.setString(++initialParameterIndex, resource.getResourceName());\n                                 preparedStatement.setTimestamp(++initialParameterIndex, currentTime, calendar);\n                                 /*\n"}}, {"oid": "8e9bb50b9481490795e594732f480d261eefc0bc", "url": "https://github.com/wso2/carbon-identity-framework/commit/8e9bb50b9481490795e594732f480d261eefc0bc", "message": "Tenant qualify config store API", "committedDate": "2020-06-22T14:52:46Z", "type": "commit"}, {"oid": "29225c991017fa6dda45cb84cae0e1fe27cf40d4", "url": "https://github.com/wso2/carbon-identity-framework/commit/29225c991017fa6dda45cb84cae0e1fe27cf40d4", "message": "Add unit tests", "committedDate": "2020-06-22T14:53:01Z", "type": "commit"}, {"oid": "684a879df2e64ec845c75489018b9144a974055b", "url": "https://github.com/wso2/carbon-identity-framework/commit/684a879df2e64ec845c75489018b9144a974055b", "message": "Add configs", "committedDate": "2020-06-22T15:00:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NzA4OA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448197088", "bodyText": "shall we deprecate this?", "author": "tharindu-bandara", "createdAt": "2020-07-01T08:19:18Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -43,6 +43,17 @@\n      */\n     Resources getTenantResources(Condition searchCondition) throws ConfigurationManagementException;", "originalCommit": "684a879df2e64ec845c75489018b9144a974055b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0MDExMw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448240113", "bodyText": "fixed", "author": "emswbandara", "createdAt": "2020-07-01T09:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NzA4OA=="}], "type": "inlineReview", "revised_code": {"commit": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java\nindex d06dabd166c..8bba4eae3d6 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java\n\n@@ -40,7 +41,9 @@ public interface ConfigurationManager {\n      * @param searchCondition {@link Condition} representing a search filter for resources.\n      * @return {@link Resources} object with a collection of resources matching to the given {@link Condition}.\n      * @throws ConfigurationManagementException Configuration Management Exception.\n+     * @deprecated use {@link ConfigurationManager#getTenantResources(String, Condition)} method.\n      */\n+    @Deprecated\n     Resources getTenantResources(Condition searchCondition) throws ConfigurationManagementException;\n \n     /**\n"}}, {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "url": "https://github.com/wso2/carbon-identity-framework/commit/4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "message": "Address comments", "committedDate": "2020-07-01T09:32:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjI4MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448526281", "bodyText": "If tenant qualified URL is not enabled will this have an impact?\nIIRC, the thread-local gets populated on tenant qualified mode only, whereas this API is implemented to be accessible from a tenant in the path in the legacy way", "author": "malithie", "createdAt": "2020-07-01T17:54:19Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.endpoint/src/main/java/org/wso2/carbon/identity/configuration/mgt/endpoint/impl/SearchApiServiceImpl.java", "diffHunk": "@@ -42,14 +44,20 @@\n public class SearchApiServiceImpl extends SearchApiService {\n \n     private static final Log LOG = LogFactory.getLog(SearchApiServiceImpl.class);\n+    private boolean allowCrossTenantSearch = Boolean.parseBoolean(IdentityUtil.getProperty(\"ConfigurationStore\" +\n+            \".AllowCrossTenantSearch\"));\n \n     @Override\n     public Response searchGet(SearchContext searchContext) {\n \n         try {\n-            Resources resources = getConfigurationManager().getTenantResources(\n-                    getSearchCondition(searchContext)\n-            );\n+            Resources resources;\n+            if (allowCrossTenantSearch) {\n+                resources = getConfigurationManager().getTenantResources(getSearchCondition(searchContext));\n+            } else {\n+                resources = getConfigurationManager().getTenantResources(IdentityTenantUtil\n+                                .getTenantDomainFromContext(), getSearchCondition(searchContext));", "originalCommit": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczNjI1Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448736256", "bodyText": "This worked as expected even when tenant qualified URL mode is disabled.", "author": "emswbandara", "createdAt": "2020-07-02T04:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjI4MQ=="}], "type": "inlineReview", "revised_code": null}]}