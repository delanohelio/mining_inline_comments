{"pr_number": 2938, "pr_title": "Implement an OSGi service for handling cors at the tenant level", "pr_createdAt": "2020-05-17T03:53:01Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2938", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk1NA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426215954", "bodyText": "Shall we fix formatting errors here?", "author": "somindatommy", "createdAt": "2020-05-17T04:28:06Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors;\n+\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+\n+import java.util.List;\n+\n+/**\n+ * Service for managing the CORS URLs of a tenant.\n+ */\n+public interface CORSService {\n+\n+    /**\n+     * Get all the CORS URLs belonging to a tenant.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n+     * @throws CORSServiceException\n+     */\n+    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;\n+\n+    /**\n+     * Set the CORS URLs for a tenant. This method replaces any existing URLs.", "originalCommit": "4365f46da58f181afd49467ae6f9daad15b6d07b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk2Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426215967", "bodyText": "And shall we fix it in other places?", "author": "somindatommy", "createdAt": "2020-05-17T04:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxODU4OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426218589", "bodyText": "\ud83d\udc4d", "author": "ivantha", "createdAt": "2020-05-17T05:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk1NA=="}], "type": "inlineReview", "revised_code": {"commit": "4145fa0fcf380f501b32270c1aea6ba814a8dd5b", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java\nindex b2f610ea379..74e79ff682d 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java\n\n@@ -62,5 +62,4 @@ public interface CORSService {\n      * @throws CORSServiceException\n      */\n     void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426215990", "bodyText": "Shall we add the wso2 license?", "author": "somindatommy", "createdAt": "2020-05-17T04:29:02Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.exception;", "originalCommit": "4365f46da58f181afd49467ae6f9daad15b6d07b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk5OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426215999", "bodyText": "Shall we add a class comment as well?", "author": "somindatommy", "createdAt": "2020-05-17T04:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxODA5OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426218099", "bodyText": "\ud83d\udc4d", "author": "ivantha", "createdAt": "2020-05-17T05:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNTk5MA=="}], "type": "inlineReview", "revised_code": {"commit": "4145fa0fcf380f501b32270c1aea6ba814a8dd5b", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java\nindex b61e0de99c4..e86daa8a94e 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java\n\n@@ -1,5 +1,26 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n package org.wso2.carbon.identity.configuration.mgt.server.cors.exception;\n \n+/**\n+ * Base exception class for the CORSService\n+ */\n public class CORSServiceException extends Exception {\n \n     public CORSServiceException(String message) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjA1Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426216056", "bodyText": "Shall we remove the extra white space here?", "author": "somindatommy", "createdAt": "2020-05-17T04:30:17Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/CORSServiceComponent.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl.CORSServiceImpl;\n+\n+/**\n+ * Service component class for CORS-Service.\n+ */\n+@Component(\n+        name = \"identity.configuration.management.server.cors.component\",\n+        immediate = true\n+)\n+public class CORSServiceComponent {\n+\n+    private static final Log log = LogFactory.getLog(CORSServiceComponent.class);\n+\n+    @Activate\n+    protected void activate(ComponentContext context) {\n+\n+        context.getBundleContext()\n+                .registerService(CORSService.class, new CORSServiceImpl(), null);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"CORSServiceComponent is activated.\");\n+        }\n+    }\n+\n+    @Deactivate\n+    protected void deactivate(ComponentContext context) {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"CORSServiceComponent is deactivated.\");\n+        }\n+    }\n+\n+    @Reference(\n+            name = \"resource.configuration.manager\",\n+            service = ConfigurationManager.class,\n+            cardinality = ReferenceCardinality.MANDATORY,\n+            policy = ReferencePolicy.DYNAMIC,\n+            unbind = \"unsetConfigurationManager\"\n+    )\n+    protected void setConfigurationManager(ConfigurationManager configurationManager) {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Setting the ConfigurationManager.\");\n+        }\n+        CORSServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    protected void unsetConfigurationManager(ConfigurationManager configurationManager) {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Unsetting the ConfigurationManager.\");\n+        }\n+        CORSServiceHolder.getInstance().setConfigurationManager(null);\n+    }\n+", "originalCommit": "4365f46da58f181afd49467ae6f9daad15b6d07b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjExMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426216110", "bodyText": "And shall we fix it other relevant places?", "author": "somindatommy", "createdAt": "2020-05-17T04:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxODA4NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426218085", "bodyText": "\ud83d\udc4d", "author": "ivantha", "createdAt": "2020-05-17T05:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "4145fa0fcf380f501b32270c1aea6ba814a8dd5b", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/CORSServiceComponent.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/CORSServiceComponent.java\nindex 9addd8cc511..c5b6196f4ed 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/CORSServiceComponent.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/CORSServiceComponent.java\n\n@@ -42,6 +42,11 @@ public class CORSServiceComponent {\n \n     private static final Log log = LogFactory.getLog(CORSServiceComponent.class);\n \n+    /**\n+     * Activate the CORSServiceComponent.\n+     *\n+     * @param context\n+     */\n     @Activate\n     protected void activate(ComponentContext context) {\n \n"}}, {"oid": "4145fa0fcf380f501b32270c1aea6ba814a8dd5b", "url": "https://github.com/wso2/carbon-identity-framework/commit/4145fa0fcf380f501b32270c1aea6ba814a8dd5b", "message": "Implement CORS OSGi service", "committedDate": "2020-05-17T08:12:48Z", "type": "forcePushed"}, {"oid": "42fc33aa567bcf83cba6e85a98663524bcb1e851", "url": "https://github.com/wso2/carbon-identity-framework/commit/42fc33aa567bcf83cba6e85a98663524bcb1e851", "message": "Implement CORS OSGi service", "committedDate": "2020-05-17T09:03:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI1NjkzNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426256934", "bodyText": "Shall we add a . at the end of the comment? Also, shall we fix this in other respective files as well?", "author": "somindatommy", "createdAt": "2020-05-17T12:40:54Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/test/java/org/wso2/carbon/identity/configuration/mgt/server/cors/util/TestUtils.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.util;\n+\n+import org.apache.commons.dbcp.BasicDataSource;\n+import org.apache.commons.lang.StringUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.spy;\n+\n+/**\n+ * Utility class for CORSServiceTest", "originalCommit": "42fc33aa567bcf83cba6e85a98663524bcb1e851", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f80132208471bf80538ae832483e970ca791c7e8", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/test/java/org/wso2/carbon/identity/configuration/mgt/server/cors/util/TestUtils.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/test/java/org/wso2/carbon/identity/configuration/mgt/server/cors/util/TestUtils.java\nindex 3c868469781..144e21c8281 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/test/java/org/wso2/carbon/identity/configuration/mgt/server/cors/util/TestUtils.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/test/java/org/wso2/carbon/identity/configuration/mgt/server/cors/util/TestUtils.java\n\n@@ -31,7 +31,7 @@ import static org.mockito.Mockito.doNothing;\n import static org.mockito.Mockito.spy;\n \n /**\n- * Utility class for CORSServiceTest\n+ * Utility class for CORSServiceTest.\n  */\n public class TestUtils {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI1NzA4Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426257083", "bodyText": "Shall we remove the extra line?", "author": "somindatommy", "createdAt": "2020-05-17T12:42:33Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSServiceImpl implements CORSService {\n+\n+    private static final Log log = LogFactory.getLog(CORSService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while getting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n+            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while updating CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while adding CORS URL.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (!tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while deleting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return void\n+     */\n+    private void startTenantFlow(String tenantDomain) {\n+\n+        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * End the tenant flow started in startTenantFlow.\n+     *\n+     * @return void\n+     */\n+    private void endTenantFlow() {\n+\n+        PrivilegedCarbonContext.endTenantFlow();\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Tenant flow ended.\");\n+        }\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS URL type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_URL_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSUrlResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_URL_RESOURCE_TYPE);\n+        resourceTypeAdd.setDescription(\"CORS URLs\");\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Returns true if the CORS URL type is already in the ConfigurationManager.\n+     *\n+     * @return boolean true if the CORS URL resource type is already in the ConfigurationManager, false otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSUrlResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_URL_RESOURCE_TYPE);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Add the CORS URL resource type to the ConfigurationManager if not already present.\n+     *\n+     * @return void\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSUrlResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSUrlResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSUrlResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS URL.\n+     *\n+     * @param url The URL to be checked against the existing URLs.\n+     * @return boolean true if the tenant already have the particular CORS URL, false otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSUrl(String url) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<String> currentUrls = new ResourceToCORSUrl().apply(resource);\n+\n+            return currentUrls.contains(url);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Check if the format of the URL is valid.\n+     *\n+     * @param url URL to be checked for validity.\n+     * @return boolean true if the url is valid, false otherwise.\n+     */\n+    private boolean isInvalidUrl(String url) {\n+\n+        try {\n+            new URL(url).toURI();\n+        } catch (MalformedURLException | URISyntaxException e) {\n+            return true;\n+        }\n+", "originalCommit": "42fc33aa567bcf83cba6e85a98663524bcb1e851", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f80132208471bf80538ae832483e970ca791c7e8", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\nindex 223335de327..7f170a44596 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n\n@@ -165,7 +165,6 @@ public class CORSServiceImpl implements CORSService {\n      * Setting the tenant for the scenarios where the tenant is unavailable in context.\n      *\n      * @param tenantDomain The tenant domain.\n-     * @return void\n      */\n     private void startTenantFlow(String tenantDomain) {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI1NzE3MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426257171", "bodyText": "Shall we remove the extra line?", "author": "somindatommy", "createdAt": "2020-05-17T12:43:21Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSServiceImpl implements CORSService {\n+\n+    private static final Log log = LogFactory.getLog(CORSService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while getting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n+            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while updating CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while adding CORS URL.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (!tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while deleting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return void\n+     */\n+    private void startTenantFlow(String tenantDomain) {\n+\n+        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * End the tenant flow started in startTenantFlow.\n+     *\n+     * @return void\n+     */\n+    private void endTenantFlow() {\n+\n+        PrivilegedCarbonContext.endTenantFlow();\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Tenant flow ended.\");\n+        }\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS URL type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_URL_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSUrlResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_URL_RESOURCE_TYPE);\n+        resourceTypeAdd.setDescription(\"CORS URLs\");\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Returns true if the CORS URL type is already in the ConfigurationManager.\n+     *\n+     * @return boolean true if the CORS URL resource type is already in the ConfigurationManager, false otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSUrlResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_URL_RESOURCE_TYPE);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Add the CORS URL resource type to the ConfigurationManager if not already present.\n+     *\n+     * @return void\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSUrlResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSUrlResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSUrlResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS URL.\n+     *\n+     * @param url The URL to be checked against the existing URLs.\n+     * @return boolean true if the tenant already have the particular CORS URL, false otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSUrl(String url) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<String> currentUrls = new ResourceToCORSUrl().apply(resource);\n+", "originalCommit": "42fc33aa567bcf83cba6e85a98663524bcb1e851", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f80132208471bf80538ae832483e970ca791c7e8", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\nindex 223335de327..7f170a44596 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n\n@@ -165,7 +165,6 @@ public class CORSServiceImpl implements CORSService {\n      * Setting the tenant for the scenarios where the tenant is unavailable in context.\n      *\n      * @param tenantDomain The tenant domain.\n-     * @return void\n      */\n     private void startTenantFlow(String tenantDomain) {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI1NzUwOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426257508", "bodyText": "For void methods, we do not have to specify the return type. Shall we remove it and fix other related places?", "author": "somindatommy", "createdAt": "2020-05-17T12:46:45Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSServiceImpl implements CORSService {\n+\n+    private static final Log log = LogFactory.getLog(CORSService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while getting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n+            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while updating CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while adding CORS URL.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (!tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while deleting CORS URLs.\", e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return void\n+     */\n+    private void startTenantFlow(String tenantDomain) {\n+\n+        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * End the tenant flow started in startTenantFlow.\n+     *\n+     * @return void", "originalCommit": "42fc33aa567bcf83cba6e85a98663524bcb1e851", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f80132208471bf80538ae832483e970ca791c7e8", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\nindex 223335de327..7f170a44596 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n\n@@ -165,7 +165,6 @@ public class CORSServiceImpl implements CORSService {\n      * Setting the tenant for the scenarios where the tenant is unavailable in context.\n      *\n      * @param tenantDomain The tenant domain.\n-     * @return void\n      */\n     private void startTenantFlow(String tenantDomain) {\n \n"}}, {"oid": "f80132208471bf80538ae832483e970ca791c7e8", "url": "https://github.com/wso2/carbon-identity-framework/commit/f80132208471bf80538ae832483e970ca791c7e8", "message": "Implement CORS OSGi service", "committedDate": "2020-05-17T13:10:10Z", "type": "forcePushed"}, {"oid": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "url": "https://github.com/wso2/carbon-identity-framework/commit/b13145b85a4a08792f8299cf8d2c34232abaefcf", "message": "Implement CORS OSGi service", "committedDate": "2020-05-17T17:13:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3MjEyMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426372120", "bodyText": "Shall we add the tenant domain to the exception message?", "author": "dewniMW", "createdAt": "2020-05-18T05:07:48Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSServiceImpl implements CORSService {\n+\n+    private static final Log log = LogFactory.getLog(CORSService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(\"Error while getting CORS URLs.\", e);", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\nsimilarity index 93%\nrename from components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\nrename to components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\nindex 7f170a44596..50faa7ee96d 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSServiceImpl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\n\n@@ -28,9 +28,9 @@ import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3Mjc2Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426372763", "bodyText": "End with a full stop. Do this in all applicable places.", "author": "dewniMW", "createdAt": "2020-05-18T05:10:42Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors;\n+\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+\n+import java.util.List;\n+\n+/**\n+ * Service for managing the CORS URLs of a tenant.\n+ */\n+public interface CORSService {\n+\n+    /**\n+     * Get all the CORS URLs belonging to a tenant.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n+     * @throws CORSServiceException\n+     */\n+    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;\n+\n+    /**\n+     * Set the CORS URLs for a tenant. This method replaces any existing URLs.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @param urls A list of CORS URLs", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\nsimilarity index 92%\nrename from components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java\nrename to components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\nindex 74e79ff682d..87338b80f29 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSService.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\n\n@@ -25,7 +25,7 @@ import java.util.List;\n /**\n  * Service for managing the CORS URLs of a tenant.\n  */\n-public interface CORSService {\n+public interface CORSManagementService {\n \n     /**\n      * Get all the CORS URLs belonging to a tenant.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NzQwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426377409", "bodyText": "Remove unnecessary new lines.", "author": "ashensw", "createdAt": "2020-05-18T05:31:23Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToAttribute.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function;\n+\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+\n+import java.util.function.Function;\n+\n+/**\n+ * Converts a string url to a ConfigurationManagement Resource attribute.\n+ */\n+public class CORSUrlToAttribute implements Function<String, Attribute> {\n+\n+    @Override\n+    public Attribute apply(String url) {\n+\n+        Attribute attribute = new Attribute(String.valueOf(url.hashCode()), url);\n+", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToAttribute.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToAttribute.java\nindex d2107937f6c..e371efb2d75 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToAttribute.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToAttribute.java\n\n@@ -31,7 +31,6 @@ public class CORSUrlToAttribute implements Function<String, Attribute> {\n     public Attribute apply(String url) {\n \n         Attribute attribute = new Attribute(String.valueOf(url.hashCode()), url);\n-\n         return attribute;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NzQzNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426377436", "bodyText": "Remove unnecessary new lines.", "author": "ashensw", "createdAt": "2020-05-18T05:31:29Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToResourceAdd.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function;\n+\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+\n+/**\n+ * Converts a list of string urls to a ConfigurationManagement ResourceAdd object.\n+ */\n+public class CORSUrlToResourceAdd implements Function<List<String>, ResourceAdd> {\n+\n+    @Override\n+    public ResourceAdd apply(List<String> urls) {\n+\n+        ResourceAdd resourceAdd = new ResourceAdd();\n+        resourceAdd.setName(CORS_URL_RESOURCE_NAME);\n+\n+        List<Attribute> attributes = new ArrayList<>();\n+        for (String url : urls) {\n+            addAttribute(attributes, String.valueOf(url.hashCode()), url);\n+        }\n+        resourceAdd.setAttributes(attributes);\n+", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToResourceAdd.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToResourceAdd.java\nindex cdd4509787e..a42224f895e 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToResourceAdd.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/CORSUrlToResourceAdd.java\n\n@@ -43,7 +43,6 @@ public class CORSUrlToResourceAdd implements Function<List<String>, ResourceAdd>\n             addAttribute(attributes, String.valueOf(url.hashCode()), url);\n         }\n         resourceAdd.setAttributes(attributes);\n-\n         return resourceAdd;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NzQ4Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426377486", "bodyText": "Remove unnecessary new lines.", "author": "ashensw", "createdAt": "2020-05-18T05:31:45Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function;\n+\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+/**\n+ * Converts a ConfigurationManagement Resource to a list of string urls.\n+ */\n+public class ResourceToCORSUrl implements Function<Resource, List<String>> {\n+\n+    @Override\n+    public List<String> apply(Resource resource) {\n+\n+        ArrayList<String> urls = new ArrayList<>();\n+\n+        if (resource.isHasAttribute()) {\n+            List<Attribute> attributes = resource.getAttributes();\n+\n+            for (Attribute attribute : attributes) {\n+                urls.add(attribute.getValue());\n+            }\n+        }\n+", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\nindex d0e36c3e4f5..fd5beba7567 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\n\n@@ -34,15 +34,12 @@ public class ResourceToCORSUrl implements Function<Resource, List<String>> {\n     public List<String> apply(Resource resource) {\n \n         ArrayList<String> urls = new ArrayList<>();\n-\n         if (resource.isHasAttribute()) {\n             List<Attribute> attributes = resource.getAttributes();\n-\n             for (Attribute attribute : attributes) {\n                 urls.add(attribute.getValue());\n             }\n         }\n-\n         return urls;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NzQ5Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426377497", "bodyText": "Remove unnecessary new lines.", "author": "ashensw", "createdAt": "2020-05-18T05:31:49Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function;\n+\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+/**\n+ * Converts a ConfigurationManagement Resource to a list of string urls.\n+ */\n+public class ResourceToCORSUrl implements Function<Resource, List<String>> {\n+\n+    @Override\n+    public List<String> apply(Resource resource) {\n+\n+        ArrayList<String> urls = new ArrayList<>();\n+", "originalCommit": "b13145b85a4a08792f8299cf8d2c34232abaefcf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\nindex d0e36c3e4f5..fd5beba7567 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/function/ResourceToCORSUrl.java\n\n@@ -34,15 +34,12 @@ public class ResourceToCORSUrl implements Function<Resource, List<String>> {\n     public List<String> apply(Resource resource) {\n \n         ArrayList<String> urls = new ArrayList<>();\n-\n         if (resource.isHasAttribute()) {\n             List<Attribute> attributes = resource.getAttributes();\n-\n             for (Attribute attribute : attributes) {\n                 urls.add(attribute.getValue());\n             }\n         }\n-\n         return urls;\n     }\n }\n"}}, {"oid": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "url": "https://github.com/wso2/carbon-identity-framework/commit/89f104b4ec15b942e3982827e7934eab7ec39ad7", "message": "Implement CORS OSGi service", "committedDate": "2020-05-18T05:49:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5NzkzMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426397932", "bodyText": "Add usually denotes and append.\nIt's fine to pass the list, but we should have another method to add just one origin. WDYT?", "author": "malithie", "createdAt": "2020-05-18T06:38:46Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors;\n+\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+\n+import java.util.List;\n+\n+/**\n+ * Service for managing the CORS URLs of a tenant.\n+ */\n+public interface CORSManagementService {\n+\n+    /**\n+     * Get all the CORS URLs belonging to a tenant.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n+     * @throws CORSServiceException\n+     */\n+    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;\n+\n+    /**\n+     * Set the CORS URLs for a tenant. This method replaces any existing URLs.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @param urls A list of CORS URLs.\n+     * @throws CORSServiceException\n+     */\n+    void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n+\n+    /**\n+     * Add the CORS URL(s) to the existing URL list of the tenant.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @param urls A list of CORS URLs.\n+     * @throws CORSServiceException\n+     */\n+    void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5ODcwOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426398708", "bodyText": "I had that and removed it since extra method seemed redundant when the method to add multiple origins can be used to add one origin as well.", "author": "ivantha", "createdAt": "2020-05-18T06:40:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5NzkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5OTM4NA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426399384", "bodyText": "This method appends the list of new origins rather than replacing existing ones.", "author": "ivantha", "createdAt": "2020-05-18T06:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5NzkzMg=="}], "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\ndeleted file mode 100644\nindex 87338b80f29..00000000000\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\n+++ /dev/null\n\n@@ -1,65 +0,0 @@\n-/*\n- * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n- *\n- * WSO2 Inc. licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.wso2.carbon.identity.configuration.mgt.server.cors;\n-\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-\n-import java.util.List;\n-\n-/**\n- * Service for managing the CORS URLs of a tenant.\n- */\n-public interface CORSManagementService {\n-\n-    /**\n-     * Get all the CORS URLs belonging to a tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n-     * @throws CORSServiceException\n-     */\n-    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;\n-\n-    /**\n-     * Set the CORS URLs for a tenant. This method replaces any existing URLs.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-\n-    /**\n-     * Add the CORS URL(s) to the existing URL list of the tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-\n-    /**\n-     * Delete the CORS URL(s) from the existing URL list of the tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5ODIyOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426398228", "bodyText": "What if we say CORS origins than saying urls ?", "author": "malithie", "createdAt": "2020-05-18T06:39:42Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors;\n+\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+\n+import java.util.List;\n+\n+/**\n+ * Service for managing the CORS URLs of a tenant.\n+ */\n+public interface CORSManagementService {\n+\n+    /**\n+     * Get all the CORS URLs belonging to a tenant.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n+     * @throws CORSServiceException\n+     */\n+    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\ndeleted file mode 100644\nindex 87338b80f29..00000000000\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/CORSManagementService.java\n+++ /dev/null\n\n@@ -1,65 +0,0 @@\n-/*\n- * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n- *\n- * WSO2 Inc. licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.wso2.carbon.identity.configuration.mgt.server.cors;\n-\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-\n-import java.util.List;\n-\n-/**\n- * Service for managing the CORS URLs of a tenant.\n- */\n-public interface CORSManagementService {\n-\n-    /**\n-     * Get all the CORS URLs belonging to a tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @return List<String> Returns a list of CORS URLs configured by the tenant as strings.\n-     * @throws CORSServiceException\n-     */\n-    List<String> getCORSUrls(String tenantDomain) throws CORSServiceException;\n-\n-    /**\n-     * Set the CORS URLs for a tenant. This method replaces any existing URLs.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-\n-    /**\n-     * Add the CORS URL(s) to the existing URL list of the tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-\n-    /**\n-     * Delete the CORS URL(s) from the existing URL list of the tenant.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     * @param urls A list of CORS URLs.\n-     * @throws CORSServiceException\n-     */\n-    void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException;\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwNDMzOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426404338", "bodyText": "Don't we need to separate out client and server exception types. Shall we use extended exception types from here", "author": "malithie", "createdAt": "2020-05-18T06:55:09Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.exception;\n+\n+/**\n+ * Base exception class for the CORSService.\n+ */\n+public class CORSServiceException extends Exception {", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceException.java\nsimilarity index 75%\nrename from components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java\nrename to components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceException.java\nindex df43bee8428..e60899bd0b4 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/exception/CORSServiceException.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceException.java\n\n@@ -16,19 +16,19 @@\n  * under the License.\n  */\n \n-package org.wso2.carbon.identity.configuration.mgt.server.cors.exception;\n+package org.wso2.carbon.identity.cors.mgt.core.exception;\n \n /**\n  * Base exception class for the CORSService.\n  */\n-public class CORSServiceException extends Exception {\n+public class CORSManagementServiceException extends Exception {\n \n-    public CORSServiceException(String message) {\n+    public CORSManagementServiceException(String message) {\n \n         super(message);\n     }\n \n-    public CORSServiceException(String message, Throwable cause) {\n+    public CORSManagementServiceException(String message, Throwable cause) {\n \n         super(message, cause);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwODAwNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426408006", "bodyText": "Does configuration manager supports caching", "author": "malithie", "createdAt": "2020-05-18T07:03:34Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA2MDA1Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r427060056", "bodyText": "Not yet. It has plans to support caching in the future. But it is not a priority at the moment.\n(@tharindu-bandara)\n@malithie The CORS Service should definitely have to support caching somewhere. Should we implement it here?", "author": "ivantha", "createdAt": "2020-05-19T06:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwODAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQyMTc3NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r441421775", "bodyText": "Note: Cache will be added at the CORS valve.", "author": "ivantha", "createdAt": "2020-06-17T09:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwODAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\ndeleted file mode 100644\nindex 50faa7ee96d..00000000000\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\n+++ /dev/null\n\n@@ -1,283 +0,0 @@\n-/*\n- * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n- *\n- * WSO2 Inc. licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n-import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n-import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n-\n-import java.net.MalformedURLException;\n-import java.net.URISyntaxException;\n-import java.net.URL;\n-import java.util.List;\n-\n-import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n-\n-/**\n- * Implementation of the CORSService.\n- */\n-public class CORSManagementServiceImpl implements CORSManagementService {\n-\n-    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n-\n-    @Override\n-    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-            if (resource == null) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-                }\n-                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-            }\n-            List<String> urls = new ResourceToCORSUrl().apply(resource);\n-\n-            return urls;\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while getting the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n-            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while updating the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while adding the CORS URLs to %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isErrorEnabled()) {\n-                        log.error(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (!tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n-                        attribute.getKey());\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while deleting the CORS URLs from %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    /**\n-     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     */\n-    private void startTenantFlow(String tenantDomain) {\n-\n-        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-\n-        PrivilegedCarbonContext.startTenantFlow();\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n-        }\n-    }\n-\n-    /**\n-     * End the tenant flow started in startTenantFlow.\n-     */\n-    private void endTenantFlow() {\n-\n-        PrivilegedCarbonContext.endTenantFlow();\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Tenant flow ended.\");\n-        }\n-    }\n-\n-    /**\n-     * Create a ResourceTypeAdd for CORS URL type.\n-     *\n-     * @return ResourceTypeAdd A resource type with CORS_URL_RESOURCE_TYPE set as the name.\n-     */\n-    private ResourceTypeAdd createCORSUrlResourceTypeToAdd() {\n-\n-        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n-        resourceTypeAdd.setName(CORS_URL_RESOURCE_TYPE);\n-        resourceTypeAdd.setDescription(\"CORS URLs\");\n-        return resourceTypeAdd;\n-    }\n-\n-    /**\n-     * Returns true if the CORS URL type is already in the ConfigurationManager.\n-     *\n-     * @return boolean true if the CORS URL resource type is already in the ConfigurationManager, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean isCORSUrlResourceTypeNotExists() throws ConfigurationManagementException {\n-\n-        try {\n-            getConfigurationManager().getResourceType(CORS_URL_RESOURCE_TYPE);\n-        } catch (ConfigurationManagementClientException e) {\n-            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n-                return true;\n-            }\n-            throw e;\n-        }\n-        return false;\n-    }\n-\n-    /**\n-     * Add the CORS URL resource type to the ConfigurationManager if not already present.\n-     *\n-     * @throws ConfigurationManagementException\n-     */\n-    private void addCORSUrlResourceTypeIfNotExists() throws ConfigurationManagementException {\n-\n-        if (isCORSUrlResourceTypeNotExists()) {\n-            ResourceTypeAdd resourceTypeAdd = createCORSUrlResourceTypeToAdd();\n-            getConfigurationManager().addResourceType(resourceTypeAdd);\n-        }\n-    }\n-\n-    /**\n-     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n-     *\n-     * @return ConfigurationManager The ConfigurationManager instance.\n-     */\n-    private ConfigurationManager getConfigurationManager() {\n-\n-        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n-    }\n-\n-    /**\n-     * Returns true if the tenant already has a particular CORS URL.\n-     *\n-     * @param url The URL to be checked against the existing URLs.\n-     * @return boolean true if the tenant already have the particular CORS URL, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean tenantHasCORSUrl(String url) throws ConfigurationManagementException {\n-\n-        Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-        if (resource != null) {\n-            List<String> currentUrls = new ResourceToCORSUrl().apply(resource);\n-\n-            return currentUrls.contains(url);\n-        } else {\n-            return false;\n-        }\n-    }\n-\n-    /**\n-     * Check if the format of the URL is valid.\n-     *\n-     * @param url URL to be checked for validity.\n-     * @return boolean true if the url is valid, false otherwise.\n-     */\n-    private boolean isInvalidUrl(String url) {\n-\n-        try {\n-            new URL(url).toURI();\n-        } catch (MalformedURLException | URISyntaxException e) {\n-            return true;\n-        }\n-        return false;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwODQzNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426408437", "bodyText": "These exceptions should be some client type", "author": "malithie", "createdAt": "2020-05-18T07:04:41Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while getting the CORS URLs of %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n+            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while updating the CORS URLs of %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while adding the CORS URLs to %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\ndeleted file mode 100644\nindex 50faa7ee96d..00000000000\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\n+++ /dev/null\n\n@@ -1,283 +0,0 @@\n-/*\n- * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n- *\n- * WSO2 Inc. licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n-import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n-import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n-\n-import java.net.MalformedURLException;\n-import java.net.URISyntaxException;\n-import java.net.URL;\n-import java.util.List;\n-\n-import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n-\n-/**\n- * Implementation of the CORSService.\n- */\n-public class CORSManagementServiceImpl implements CORSManagementService {\n-\n-    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n-\n-    @Override\n-    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-            if (resource == null) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-                }\n-                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-            }\n-            List<String> urls = new ResourceToCORSUrl().apply(resource);\n-\n-            return urls;\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while getting the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n-            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while updating the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while adding the CORS URLs to %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isErrorEnabled()) {\n-                        log.error(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (!tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n-                        attribute.getKey());\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while deleting the CORS URLs from %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    /**\n-     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     */\n-    private void startTenantFlow(String tenantDomain) {\n-\n-        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-\n-        PrivilegedCarbonContext.startTenantFlow();\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n-        }\n-    }\n-\n-    /**\n-     * End the tenant flow started in startTenantFlow.\n-     */\n-    private void endTenantFlow() {\n-\n-        PrivilegedCarbonContext.endTenantFlow();\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Tenant flow ended.\");\n-        }\n-    }\n-\n-    /**\n-     * Create a ResourceTypeAdd for CORS URL type.\n-     *\n-     * @return ResourceTypeAdd A resource type with CORS_URL_RESOURCE_TYPE set as the name.\n-     */\n-    private ResourceTypeAdd createCORSUrlResourceTypeToAdd() {\n-\n-        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n-        resourceTypeAdd.setName(CORS_URL_RESOURCE_TYPE);\n-        resourceTypeAdd.setDescription(\"CORS URLs\");\n-        return resourceTypeAdd;\n-    }\n-\n-    /**\n-     * Returns true if the CORS URL type is already in the ConfigurationManager.\n-     *\n-     * @return boolean true if the CORS URL resource type is already in the ConfigurationManager, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean isCORSUrlResourceTypeNotExists() throws ConfigurationManagementException {\n-\n-        try {\n-            getConfigurationManager().getResourceType(CORS_URL_RESOURCE_TYPE);\n-        } catch (ConfigurationManagementClientException e) {\n-            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n-                return true;\n-            }\n-            throw e;\n-        }\n-        return false;\n-    }\n-\n-    /**\n-     * Add the CORS URL resource type to the ConfigurationManager if not already present.\n-     *\n-     * @throws ConfigurationManagementException\n-     */\n-    private void addCORSUrlResourceTypeIfNotExists() throws ConfigurationManagementException {\n-\n-        if (isCORSUrlResourceTypeNotExists()) {\n-            ResourceTypeAdd resourceTypeAdd = createCORSUrlResourceTypeToAdd();\n-            getConfigurationManager().addResourceType(resourceTypeAdd);\n-        }\n-    }\n-\n-    /**\n-     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n-     *\n-     * @return ConfigurationManager The ConfigurationManager instance.\n-     */\n-    private ConfigurationManager getConfigurationManager() {\n-\n-        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n-    }\n-\n-    /**\n-     * Returns true if the tenant already has a particular CORS URL.\n-     *\n-     * @param url The URL to be checked against the existing URLs.\n-     * @return boolean true if the tenant already have the particular CORS URL, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean tenantHasCORSUrl(String url) throws ConfigurationManagementException {\n-\n-        Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-        if (resource != null) {\n-            List<String> currentUrls = new ResourceToCORSUrl().apply(resource);\n-\n-            return currentUrls.contains(url);\n-        } else {\n-            return false;\n-        }\n-    }\n-\n-    /**\n-     * Check if the format of the URL is valid.\n-     *\n-     * @param url URL to be checked for validity.\n-     * @return boolean true if the url is valid, false otherwise.\n-     */\n-    private boolean isInvalidUrl(String url) {\n-\n-        try {\n-            new URL(url).toURI();\n-        } catch (MalformedURLException | URISyntaxException e) {\n-            return true;\n-        }\n-        return false;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwODc3NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r426408775", "bodyText": "Can we log tenant domain for which tenant flow ended", "author": "malithie", "createdAt": "2020-05-18T07:05:29Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+                }\n+                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n+            }\n+            List<String> urls = new ResourceToCORSUrl().apply(resource);\n+\n+            return urls;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while getting the CORS URLs of %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n+            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while updating the CORS URLs of %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSUrlResourceTypeIfNotExists();\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while adding the CORS URLs to %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (String url : urls) {\n+                if (isInvalidUrl(url)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid URL.\", url));\n+                    }\n+                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n+                }\n+                if (!tenantHasCORSUrl(url)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                                tenantDomain, url)));\n+                    }\n+                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n+                            tenantDomain, url));\n+                }\n+            }\n+\n+            for (String url : urls) {\n+                Attribute attribute = new CORSUrlToAttribute().apply(url);\n+                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSServiceException(String.format(\"Error while deleting the CORS URLs from %s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     */\n+    private void startTenantFlow(String tenantDomain) {\n+\n+        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * End the tenant flow started in startTenantFlow.\n+     */\n+    private void endTenantFlow() {\n+\n+        PrivilegedCarbonContext.endTenantFlow();\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Tenant flow ended.\");", "originalCommit": "89f104b4ec15b942e3982827e7934eab7ec39ad7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\ndeleted file mode 100644\nindex 50faa7ee96d..00000000000\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.server/src/main/java/org/wso2/carbon/identity/configuration/mgt/server/cors/internal/impl/CORSManagementServiceImpl.java\n+++ /dev/null\n\n@@ -1,283 +0,0 @@\n-/*\n- * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n- *\n- * WSO2 Inc. licenses this file to you under the Apache License,\n- * Version 2.0 (the \"License\"); you may not use this file except\n- * in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.wso2.carbon.identity.configuration.mgt.server.cors.internal.impl;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n-import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.CORSManagementService;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.exception.CORSServiceException;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.CORSManagementServiceHolder;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToAttribute;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.CORSUrlToResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.server.cors.internal.function.ResourceToCORSUrl;\n-import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n-\n-import java.net.MalformedURLException;\n-import java.net.URISyntaxException;\n-import java.net.URL;\n-import java.util.List;\n-\n-import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_NAME;\n-import static org.wso2.carbon.identity.configuration.mgt.server.cors.internal.Constants.CORS_URL_RESOURCE_TYPE;\n-\n-/**\n- * Implementation of the CORSService.\n- */\n-public class CORSManagementServiceImpl implements CORSManagementService {\n-\n-    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n-\n-    @Override\n-    public List<String> getCORSUrls(String tenantDomain) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-            if (resource == null) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-                }\n-                throw new CORSServiceException(String.format(\"Tenant %s does not have any CORS URLs.\", tenantDomain));\n-            }\n-            List<String> urls = new ResourceToCORSUrl().apply(resource);\n-\n-            return urls;\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while getting the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void setCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            ResourceAdd resourceAdd = new CORSUrlToResourceAdd().apply(urls);\n-            getConfigurationManager().replaceResource(CORS_URL_RESOURCE_TYPE, resourceAdd);\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while updating the CORS URLs of %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void addCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-            addCORSUrlResourceTypeIfNotExists();\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s already has %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().addAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME, attribute);\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while adding the CORS URLs to %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    @Override\n-    public void deleteCORSUrls(String tenantDomain, List<String> urls) throws CORSServiceException {\n-\n-        try {\n-            startTenantFlow(tenantDomain);\n-\n-            for (String url : urls) {\n-                if (isInvalidUrl(url)) {\n-                    if (log.isErrorEnabled()) {\n-                        log.error(String.format(\"%s is an invalid URL.\", url));\n-                    }\n-                    throw new CORSServiceException(String.format(\"%s is an invalid URL.\", url));\n-                }\n-                if (!tenantHasCORSUrl(url)) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                                tenantDomain, url)));\n-                    }\n-                    throw new CORSServiceException(String.format(\"Tenant %s doesn't have %s as a CORS URL.\",\n-                            tenantDomain, url));\n-                }\n-            }\n-\n-            for (String url : urls) {\n-                Attribute attribute = new CORSUrlToAttribute().apply(url);\n-                getConfigurationManager().deleteAttribute(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME,\n-                        attribute.getKey());\n-            }\n-        } catch (ConfigurationManagementException e) {\n-            throw new CORSServiceException(String.format(\"Error while deleting the CORS URLs from %s.\", tenantDomain), e);\n-        } finally {\n-            endTenantFlow();\n-        }\n-    }\n-\n-    /**\n-     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n-     *\n-     * @param tenantDomain The tenant domain.\n-     */\n-    private void startTenantFlow(String tenantDomain) {\n-\n-        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n-\n-        PrivilegedCarbonContext.startTenantFlow();\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n-        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n-        }\n-    }\n-\n-    /**\n-     * End the tenant flow started in startTenantFlow.\n-     */\n-    private void endTenantFlow() {\n-\n-        PrivilegedCarbonContext.endTenantFlow();\n-\n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Tenant flow ended.\");\n-        }\n-    }\n-\n-    /**\n-     * Create a ResourceTypeAdd for CORS URL type.\n-     *\n-     * @return ResourceTypeAdd A resource type with CORS_URL_RESOURCE_TYPE set as the name.\n-     */\n-    private ResourceTypeAdd createCORSUrlResourceTypeToAdd() {\n-\n-        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n-        resourceTypeAdd.setName(CORS_URL_RESOURCE_TYPE);\n-        resourceTypeAdd.setDescription(\"CORS URLs\");\n-        return resourceTypeAdd;\n-    }\n-\n-    /**\n-     * Returns true if the CORS URL type is already in the ConfigurationManager.\n-     *\n-     * @return boolean true if the CORS URL resource type is already in the ConfigurationManager, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean isCORSUrlResourceTypeNotExists() throws ConfigurationManagementException {\n-\n-        try {\n-            getConfigurationManager().getResourceType(CORS_URL_RESOURCE_TYPE);\n-        } catch (ConfigurationManagementClientException e) {\n-            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n-                return true;\n-            }\n-            throw e;\n-        }\n-        return false;\n-    }\n-\n-    /**\n-     * Add the CORS URL resource type to the ConfigurationManager if not already present.\n-     *\n-     * @throws ConfigurationManagementException\n-     */\n-    private void addCORSUrlResourceTypeIfNotExists() throws ConfigurationManagementException {\n-\n-        if (isCORSUrlResourceTypeNotExists()) {\n-            ResourceTypeAdd resourceTypeAdd = createCORSUrlResourceTypeToAdd();\n-            getConfigurationManager().addResourceType(resourceTypeAdd);\n-        }\n-    }\n-\n-    /**\n-     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n-     *\n-     * @return ConfigurationManager The ConfigurationManager instance.\n-     */\n-    private ConfigurationManager getConfigurationManager() {\n-\n-        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n-    }\n-\n-    /**\n-     * Returns true if the tenant already has a particular CORS URL.\n-     *\n-     * @param url The URL to be checked against the existing URLs.\n-     * @return boolean true if the tenant already have the particular CORS URL, false otherwise.\n-     * @throws ConfigurationManagementException\n-     */\n-    private boolean tenantHasCORSUrl(String url) throws ConfigurationManagementException {\n-\n-        Resource resource = getConfigurationManager().getResource(CORS_URL_RESOURCE_TYPE, CORS_URL_RESOURCE_NAME);\n-        if (resource != null) {\n-            List<String> currentUrls = new ResourceToCORSUrl().apply(resource);\n-\n-            return currentUrls.contains(url);\n-        } else {\n-            return false;\n-        }\n-    }\n-\n-    /**\n-     * Check if the format of the URL is valid.\n-     *\n-     * @param url URL to be checked for validity.\n-     * @return boolean true if the url is valid, false otherwise.\n-     */\n-    private boolean isInvalidUrl(String url) {\n-\n-        try {\n-            new URL(url).toURI();\n-        } catch (MalformedURLException | URISyntaxException e) {\n-            return true;\n-        }\n-        return false;\n-    }\n-}\n"}}, {"oid": "d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "url": "https://github.com/wso2/carbon-identity-framework/commit/d4c4d9f5afaaabc209ad81c830d20685ec8ae31c", "message": "Implement CORS OSGi service", "committedDate": "2020-05-19T03:49:50Z", "type": "forcePushed"}, {"oid": "631feba2b4e1fea61588e1b7fe48f78afb6e791c", "url": "https://github.com/wso2/carbon-identity-framework/commit/631feba2b4e1fea61588e1b7fe48f78afb6e791c", "message": "Implement CORS OSGi service", "committedDate": "2020-05-19T08:16:14Z", "type": "forcePushed"}, {"oid": "e244f5e98d01a47d0b44be9b0a50d175355c4bb2", "url": "https://github.com/wso2/carbon-identity-framework/commit/e244f5e98d01a47d0b44be9b0a50d175355c4bb2", "message": "Implement CORS OSGi service", "committedDate": "2020-05-19T16:04:13Z", "type": "forcePushed"}, {"oid": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "url": "https://github.com/wso2/carbon-identity-framework/commit/d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "message": "Implement CORS OSGi service", "committedDate": "2020-05-20T03:17:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0OTAwMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440949002", "bodyText": "let's define the constructor with error code and define internal errror codes (client & server) for CORS related exceptions", "author": "emswbandara", "createdAt": "2020-06-16T15:37:22Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceClientException.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.exception;\n+\n+/**\n+ * Client exception class for the CORSService.\n+ */\n+public class CORSManagementServiceClientException extends CORSManagementServiceException {", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1OTE2Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440959163", "bodyText": "use https://github.com/wso2/carbon-identity-framework/blob/master/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/constant/ConfigurationConstants.java#L73 for reference", "author": "emswbandara", "createdAt": "2020-06-16T15:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0OTAwMg=="}], "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceClientException.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceClientException.java\nindex 2e9e18d8570..b9d95f292dd 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceClientException.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/exception/CORSManagementServiceClientException.java\n\n@@ -23,13 +23,22 @@ package org.wso2.carbon.identity.cors.mgt.core.exception;\n  */\n public class CORSManagementServiceClientException extends CORSManagementServiceException {\n \n-    public CORSManagementServiceClientException(String message) {\n+    public CORSManagementServiceClientException() {\n \n-        super(message);\n     }\n \n-    public CORSManagementServiceClientException(String message, Throwable cause) {\n+    public CORSManagementServiceClientException(String message, String errorCode) {\n \n-        super(message, cause);\n+        super(message, errorCode);\n+    }\n+\n+    public CORSManagementServiceClientException(String message, String errorCode, Throwable cause) {\n+\n+        super(message, errorCode, cause);\n+    }\n+\n+    public CORSManagementServiceClientException(Throwable cause) {\n+\n+        super(cause);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MzI0NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440953245", "bodyText": "change to CORSManagementServiceImpl.class", "author": "emswbandara", "createdAt": "2020-06-16T15:43:07Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NDk1MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440954950", "bodyText": "why are we throwing an exception if CORS origins are not available for a tenant? IMO we should return empty list.", "author": "emswbandara", "createdAt": "2020-06-16T15:45:28Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS Origins.\", tenantDomain));\n+                }\n+                throw new CORSManagementServiceClientException(String.format(\"Tenant %s does not have any CORS \" +", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NTg4Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440955882", "bodyText": "AFAIR there was an identity util method to start/end tenant flow.. its better if we can re-use that.", "author": "emswbandara", "createdAt": "2020-06-16T15:46:48Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NjY4Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440956682", "bodyText": "can corsOrigins be null here? if so, handle null check", "author": "emswbandara", "createdAt": "2020-06-16T15:47:50Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS Origins.\", tenantDomain));\n+                }\n+                throw new CORSManagementServiceClientException(String.format(\"Tenant %s does not have any CORS \" +\n+                        \"Origins.\", tenantDomain));\n+            }\n+            List<CORSOrigin> corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while getting the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while updating the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NzUyMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440957522", "bodyText": "debug log should be 'tenant already has CORS origin' right?", "author": "emswbandara", "createdAt": "2020-06-16T15:48:56Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS Origins.\", tenantDomain));\n+                }\n+                throw new CORSManagementServiceClientException(String.format(\"Tenant %s does not have any CORS \" +\n+                        \"Origins.\", tenantDomain));\n+            }\n+            List<CORSOrigin> corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while getting the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while updating the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (isInvalidOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid Origin.\", corsOrigin));\n+                    }\n+                    throw new CORSManagementServiceClientException(String.format(\"%s is an invalid Origin.\",\n+                            corsOrigin));\n+                }\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS Origin.\",", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2MDE1NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440960155", "bodyText": "define a constant for \"CORS Origins\"", "author": "emswbandara", "createdAt": "2020-06-16T15:52:32Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,300 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementService.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            if (resource == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(\"Tenant %s does not have any CORS Origins.\", tenantDomain));\n+                }\n+                throw new CORSManagementServiceClientException(String.format(\"Tenant %s does not have any CORS \" +\n+                        \"Origins.\", tenantDomain));\n+            }\n+            List<CORSOrigin> corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while getting the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while updating the CORS Origins of \" +\n+                    \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (isInvalidOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"%s is an invalid Origin.\", corsOrigin));\n+                    }\n+                    throw new CORSManagementServiceClientException(String.format(\"%s is an invalid Origin.\",\n+                            corsOrigin));\n+                }\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS Origin.\",\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw new CORSManagementServiceClientException(String.format(\"Tenant %s already has %s as a \" +\n+                                    \"CORS Origin.\",\n+                            tenantDomain, corsOrigin));\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE, CORS_ORIGIN_RESOURCE_NAME, attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while adding the CORS Origins to %s.\",\n+                    tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            startTenantFlow(tenantDomain);\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (isInvalidOrigin(corsOrigin)) {\n+                    if (log.isErrorEnabled()) {\n+                        log.error(String.format(\"%s is an invalid Origin.\", corsOrigin));\n+                    }\n+                    throw new CORSManagementServiceClientException(String.format(\"%s is an invalid Origin.\",\n+                            corsOrigin));\n+                }\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(\"Tenant %s doesn't have %s as a CORS Origin.\",\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw new CORSManagementServiceClientException(String.format(\"Tenant %s doesn't have %s as a \" +\n+                                    \"CORS Origin.\",\n+                            tenantDomain, corsOrigin));\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw new CORSManagementServiceServerException(String.format(\"Error while deleting the CORS Origins from \" +\n+                            \"%s.\", tenantDomain), e);\n+        } finally {\n+            endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Setting the tenant for the scenarios where the tenant is unavailable in context.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     */\n+    private void startTenantFlow(String tenantDomain) {\n+\n+        int tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantDomain(tenantDomain);\n+        PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow started for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * End the tenant flow started in startTenantFlow.\n+     */\n+    private void endTenantFlow() {\n+        String tenantDomain = PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantDomain();\n+        PrivilegedCarbonContext.endTenantFlow();\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(String.format(\"Tenant flow ended for %s.\", tenantDomain));\n+        }\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE);\n+        resourceTypeAdd.setDescription(\"CORS Origins\");", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex 723a2ae7061..ad8e897e163 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -20,7 +20,7 @@ package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n-import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2MjYxNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440962616", "bodyText": "remove printStackTrace", "author": "emswbandara", "createdAt": "2020-06-16T15:55:55Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core;\n+\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.testng.PowerMockTestCase;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.base.CarbonBaseConstants;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.impl.ConfigurationDAOImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.internal.ConfigurationManagerComponentDataHolder;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ConfigurationManagerConfigurationHolder;\n+import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.impl.CORSManagementServiceImpl;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.util.TestUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import javax.sql.DataSource;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.powermock.api.mockito.PowerMockito.mockStatic;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_DOMAIN_NAME;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_ID;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_1;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_2;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceTypeAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockCarbonContextForTenant;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockIdentityTenantUtility;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.closeH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.initiateH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.spyConnection;\n+\n+/**\n+ * Unit test cases for CORSService.\n+ */\n+@PrepareForTest({PrivilegedCarbonContext.class, IdentityDatabaseUtil.class, IdentityUtil.class,\n+        IdentityTenantUtil.class})\n+public class CORSManagementServiceTest extends PowerMockTestCase {\n+\n+    private ConfigurationManager configurationManager;\n+    private Connection connection;\n+\n+    private CORSManagementService corsManagementService;\n+\n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+\n+        initiateH2Base();\n+        String carbonHome = Paths.get(System.getProperty(\"user.dir\"), \"target\", \"test-classes\").toString();\n+        System.setProperty(CarbonBaseConstants.CARBON_HOME, carbonHome);\n+        System.setProperty(CarbonBaseConstants.CARBON_CONFIG_DIR_PATH, Paths.get(carbonHome, \"conf\").toString());\n+\n+        DataSource dataSource = mock(DataSource.class);\n+        mockStatic(IdentityDatabaseUtil.class);\n+        when(IdentityDatabaseUtil.getDataSource()).thenReturn(dataSource);\n+\n+        connection = TestUtils.getConnection();\n+        Connection spyConnection = spyConnection(connection);\n+        when(dataSource.getConnection()).thenReturn(spyConnection);\n+\n+        ConfigurationManagerComponentDataHolder.setUseCreatedTime(true);\n+        ConfigurationManagerConfigurationHolder configurationHolder = new ConfigurationManagerConfigurationHolder();\n+        ConfigurationDAO configurationDAO = new ConfigurationDAOImpl();\n+        configurationHolder.setConfigurationDAOS(Collections.singletonList(configurationDAO));\n+        mockCarbonContextForTenant(SUPER_TENANT_ID, SUPER_TENANT_DOMAIN_NAME);\n+        mockIdentityTenantUtility();\n+        configurationManager = new ConfigurationManagerImpl(configurationHolder);\n+\n+        ConfigurationManagerComponentDataHolder.getInstance().setConfigurationManagementEnabled(true);\n+\n+        corsManagementService = new CORSManagementServiceImpl();\n+        CORSManagementServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+\n+        connection.close();\n+        closeH2Base();\n+    }\n+\n+    @Test\n+    public void testGetCORSOrigins() {\n+\n+        try {\n+            configurationManager.addResourceType(getSampleResourceTypeAdd());\n+            configurationManager.addResource(CORS_ORIGIN_RESOURCE_TYPE, getSampleResourceAdd(SAMPLE_ORIGIN_LIST_1));\n+            List<CORSOrigin> corsOrigins = corsManagementService.getCORSOrigins(SUPER_TENANT_DOMAIN_NAME);\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2MzM1Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440963357", "bodyText": "add 'throws Exception' to method signature", "author": "emswbandara", "createdAt": "2020-06-16T15:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2MjYxNg=="}], "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\nindex 2370c1249bc..eb5b3c5b667 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n\n@@ -25,6 +25,8 @@ import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n import org.wso2.carbon.base.CarbonBaseConstants;\n import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.internal.FrameworkServiceDataHolder;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2Mjg0Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440962842", "bodyText": "remove printStackTrace", "author": "emswbandara", "createdAt": "2020-06-16T15:56:16Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core;\n+\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.testng.PowerMockTestCase;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.base.CarbonBaseConstants;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.impl.ConfigurationDAOImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.internal.ConfigurationManagerComponentDataHolder;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ConfigurationManagerConfigurationHolder;\n+import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.impl.CORSManagementServiceImpl;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.util.TestUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import javax.sql.DataSource;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.powermock.api.mockito.PowerMockito.mockStatic;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_DOMAIN_NAME;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_ID;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_1;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_2;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceTypeAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockCarbonContextForTenant;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockIdentityTenantUtility;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.closeH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.initiateH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.spyConnection;\n+\n+/**\n+ * Unit test cases for CORSService.\n+ */\n+@PrepareForTest({PrivilegedCarbonContext.class, IdentityDatabaseUtil.class, IdentityUtil.class,\n+        IdentityTenantUtil.class})\n+public class CORSManagementServiceTest extends PowerMockTestCase {\n+\n+    private ConfigurationManager configurationManager;\n+    private Connection connection;\n+\n+    private CORSManagementService corsManagementService;\n+\n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+\n+        initiateH2Base();\n+        String carbonHome = Paths.get(System.getProperty(\"user.dir\"), \"target\", \"test-classes\").toString();\n+        System.setProperty(CarbonBaseConstants.CARBON_HOME, carbonHome);\n+        System.setProperty(CarbonBaseConstants.CARBON_CONFIG_DIR_PATH, Paths.get(carbonHome, \"conf\").toString());\n+\n+        DataSource dataSource = mock(DataSource.class);\n+        mockStatic(IdentityDatabaseUtil.class);\n+        when(IdentityDatabaseUtil.getDataSource()).thenReturn(dataSource);\n+\n+        connection = TestUtils.getConnection();\n+        Connection spyConnection = spyConnection(connection);\n+        when(dataSource.getConnection()).thenReturn(spyConnection);\n+\n+        ConfigurationManagerComponentDataHolder.setUseCreatedTime(true);\n+        ConfigurationManagerConfigurationHolder configurationHolder = new ConfigurationManagerConfigurationHolder();\n+        ConfigurationDAO configurationDAO = new ConfigurationDAOImpl();\n+        configurationHolder.setConfigurationDAOS(Collections.singletonList(configurationDAO));\n+        mockCarbonContextForTenant(SUPER_TENANT_ID, SUPER_TENANT_DOMAIN_NAME);\n+        mockIdentityTenantUtility();\n+        configurationManager = new ConfigurationManagerImpl(configurationHolder);\n+\n+        ConfigurationManagerComponentDataHolder.getInstance().setConfigurationManagementEnabled(true);\n+\n+        corsManagementService = new CORSManagementServiceImpl();\n+        CORSManagementServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+\n+        connection.close();\n+        closeH2Base();\n+    }\n+\n+    @Test\n+    public void testGetCORSOrigins() {\n+\n+        try {\n+            configurationManager.addResourceType(getSampleResourceTypeAdd());\n+            configurationManager.addResource(CORS_ORIGIN_RESOURCE_TYPE, getSampleResourceAdd(SAMPLE_ORIGIN_LIST_1));\n+            List<CORSOrigin> corsOrigins = corsManagementService.getCORSOrigins(SUPER_TENANT_DOMAIN_NAME);\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testSetCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\nindex 2370c1249bc..eb5b3c5b667 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n\n@@ -25,6 +25,8 @@ import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n import org.wso2.carbon.base.CarbonBaseConstants;\n import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.internal.FrameworkServiceDataHolder;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2Mjk3Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440962972", "bodyText": "remove printStackTrace", "author": "emswbandara", "createdAt": "2020-06-16T15:56:27Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core;\n+\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.testng.PowerMockTestCase;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.base.CarbonBaseConstants;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.impl.ConfigurationDAOImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.internal.ConfigurationManagerComponentDataHolder;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ConfigurationManagerConfigurationHolder;\n+import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.impl.CORSManagementServiceImpl;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.util.TestUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import javax.sql.DataSource;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.powermock.api.mockito.PowerMockito.mockStatic;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_DOMAIN_NAME;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_ID;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_1;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_2;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceTypeAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockCarbonContextForTenant;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockIdentityTenantUtility;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.closeH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.initiateH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.spyConnection;\n+\n+/**\n+ * Unit test cases for CORSService.\n+ */\n+@PrepareForTest({PrivilegedCarbonContext.class, IdentityDatabaseUtil.class, IdentityUtil.class,\n+        IdentityTenantUtil.class})\n+public class CORSManagementServiceTest extends PowerMockTestCase {\n+\n+    private ConfigurationManager configurationManager;\n+    private Connection connection;\n+\n+    private CORSManagementService corsManagementService;\n+\n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+\n+        initiateH2Base();\n+        String carbonHome = Paths.get(System.getProperty(\"user.dir\"), \"target\", \"test-classes\").toString();\n+        System.setProperty(CarbonBaseConstants.CARBON_HOME, carbonHome);\n+        System.setProperty(CarbonBaseConstants.CARBON_CONFIG_DIR_PATH, Paths.get(carbonHome, \"conf\").toString());\n+\n+        DataSource dataSource = mock(DataSource.class);\n+        mockStatic(IdentityDatabaseUtil.class);\n+        when(IdentityDatabaseUtil.getDataSource()).thenReturn(dataSource);\n+\n+        connection = TestUtils.getConnection();\n+        Connection spyConnection = spyConnection(connection);\n+        when(dataSource.getConnection()).thenReturn(spyConnection);\n+\n+        ConfigurationManagerComponentDataHolder.setUseCreatedTime(true);\n+        ConfigurationManagerConfigurationHolder configurationHolder = new ConfigurationManagerConfigurationHolder();\n+        ConfigurationDAO configurationDAO = new ConfigurationDAOImpl();\n+        configurationHolder.setConfigurationDAOS(Collections.singletonList(configurationDAO));\n+        mockCarbonContextForTenant(SUPER_TENANT_ID, SUPER_TENANT_DOMAIN_NAME);\n+        mockIdentityTenantUtility();\n+        configurationManager = new ConfigurationManagerImpl(configurationHolder);\n+\n+        ConfigurationManagerComponentDataHolder.getInstance().setConfigurationManagementEnabled(true);\n+\n+        corsManagementService = new CORSManagementServiceImpl();\n+        CORSManagementServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+\n+        connection.close();\n+        closeH2Base();\n+    }\n+\n+    @Test\n+    public void testGetCORSOrigins() {\n+\n+        try {\n+            configurationManager.addResourceType(getSampleResourceTypeAdd());\n+            configurationManager.addResource(CORS_ORIGIN_RESOURCE_TYPE, getSampleResourceAdd(SAMPLE_ORIGIN_LIST_1));\n+            List<CORSOrigin> corsOrigins = corsManagementService.getCORSOrigins(SUPER_TENANT_DOMAIN_NAME);\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testSetCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testAddCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            corsManagementService.addCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_2);\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(Stream.concat(SAMPLE_ORIGIN_LIST_1.stream(),\n+                    SAMPLE_ORIGIN_LIST_2.stream()).collect(Collectors.toList()), corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\nindex 2370c1249bc..eb5b3c5b667 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n\n@@ -25,6 +25,8 @@ import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n import org.wso2.carbon.base.CarbonBaseConstants;\n import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.internal.FrameworkServiceDataHolder;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2MzA3Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440963076", "bodyText": "remove printStackTrace", "author": "emswbandara", "createdAt": "2020-06-16T15:56:37Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core;\n+\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.testng.PowerMockTestCase;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.base.CarbonBaseConstants;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.impl.ConfigurationDAOImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.internal.ConfigurationManagerComponentDataHolder;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ConfigurationManagerConfigurationHolder;\n+import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.impl.CORSManagementServiceImpl;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.util.TestUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import javax.sql.DataSource;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.powermock.api.mockito.PowerMockito.mockStatic;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_DOMAIN_NAME;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_ID;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_1;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_2;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceTypeAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockCarbonContextForTenant;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockIdentityTenantUtility;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.closeH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.initiateH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.spyConnection;\n+\n+/**\n+ * Unit test cases for CORSService.\n+ */\n+@PrepareForTest({PrivilegedCarbonContext.class, IdentityDatabaseUtil.class, IdentityUtil.class,\n+        IdentityTenantUtil.class})\n+public class CORSManagementServiceTest extends PowerMockTestCase {\n+\n+    private ConfigurationManager configurationManager;\n+    private Connection connection;\n+\n+    private CORSManagementService corsManagementService;\n+\n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+\n+        initiateH2Base();\n+        String carbonHome = Paths.get(System.getProperty(\"user.dir\"), \"target\", \"test-classes\").toString();\n+        System.setProperty(CarbonBaseConstants.CARBON_HOME, carbonHome);\n+        System.setProperty(CarbonBaseConstants.CARBON_CONFIG_DIR_PATH, Paths.get(carbonHome, \"conf\").toString());\n+\n+        DataSource dataSource = mock(DataSource.class);\n+        mockStatic(IdentityDatabaseUtil.class);\n+        when(IdentityDatabaseUtil.getDataSource()).thenReturn(dataSource);\n+\n+        connection = TestUtils.getConnection();\n+        Connection spyConnection = spyConnection(connection);\n+        when(dataSource.getConnection()).thenReturn(spyConnection);\n+\n+        ConfigurationManagerComponentDataHolder.setUseCreatedTime(true);\n+        ConfigurationManagerConfigurationHolder configurationHolder = new ConfigurationManagerConfigurationHolder();\n+        ConfigurationDAO configurationDAO = new ConfigurationDAOImpl();\n+        configurationHolder.setConfigurationDAOS(Collections.singletonList(configurationDAO));\n+        mockCarbonContextForTenant(SUPER_TENANT_ID, SUPER_TENANT_DOMAIN_NAME);\n+        mockIdentityTenantUtility();\n+        configurationManager = new ConfigurationManagerImpl(configurationHolder);\n+\n+        ConfigurationManagerComponentDataHolder.getInstance().setConfigurationManagementEnabled(true);\n+\n+        corsManagementService = new CORSManagementServiceImpl();\n+        CORSManagementServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+\n+        connection.close();\n+        closeH2Base();\n+    }\n+\n+    @Test\n+    public void testGetCORSOrigins() {\n+\n+        try {\n+            configurationManager.addResourceType(getSampleResourceTypeAdd());\n+            configurationManager.addResource(CORS_ORIGIN_RESOURCE_TYPE, getSampleResourceAdd(SAMPLE_ORIGIN_LIST_1));\n+            List<CORSOrigin> corsOrigins = corsManagementService.getCORSOrigins(SUPER_TENANT_DOMAIN_NAME);\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testSetCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1, corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testAddCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            corsManagementService.addCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_2);\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(Stream.concat(SAMPLE_ORIGIN_LIST_1.stream(),\n+                    SAMPLE_ORIGIN_LIST_2.stream()).collect(Collectors.toList()), corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    @Test\n+    public void testDeleteCORSOrigins() {\n+\n+        try {\n+            corsManagementService.setCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1);\n+            corsManagementService.deleteCORSOrigins(SUPER_TENANT_DOMAIN_NAME, SAMPLE_ORIGIN_LIST_1.subList(0, 2));\n+            List<CORSOrigin> corsOrigins = configurationManager.getResource(CORS_ORIGIN_RESOURCE_TYPE,\n+                    CORS_ORIGIN_RESOURCE_NAME)\n+                    .getAttributes()\n+                    .stream()\n+                    .map(CORSServiceTestHelper::attributeToCORSOrigin)\n+                    .collect(Collectors.toList());\n+\n+            assertEquals(SAMPLE_ORIGIN_LIST_1.subList(2, SAMPLE_ORIGIN_LIST_1.size()), corsOrigins);\n+        } catch (CORSManagementServiceException | ConfigurationManagementException throwables) {\n+            throwables.printStackTrace();", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\nindex 2370c1249bc..eb5b3c5b667 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n\n@@ -25,6 +25,8 @@ import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n import org.wso2.carbon.base.CarbonBaseConstants;\n import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.internal.FrameworkServiceDataHolder;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDIzNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r440964236", "bodyText": "let's add a data provider to verify tenant case in addition to super tenant case", "author": "emswbandara", "createdAt": "2020-06-16T15:58:06Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core;\n+\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.testng.PowerMockTestCase;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.base.CarbonBaseConstants;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n+import org.wso2.carbon.identity.configuration.mgt.core.dao.impl.ConfigurationDAOImpl;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.internal.ConfigurationManagerComponentDataHolder;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ConfigurationManagerConfigurationHolder;\n+import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.impl.CORSManagementServiceImpl;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.util.TestUtils;\n+\n+import java.nio.file.Paths;\n+import java.sql.Connection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import javax.sql.DataSource;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.powermock.api.mockito.PowerMockito.mockStatic;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_DOMAIN_NAME;\n+import static org.wso2.carbon.base.MultitenantConstants.SUPER_TENANT_ID;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_1;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.TestConstants.SAMPLE_ORIGIN_LIST_2;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.getSampleResourceTypeAdd;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockCarbonContextForTenant;\n+import static org.wso2.carbon.identity.cors.mgt.core.helper.CORSServiceTestHelper.mockIdentityTenantUtility;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.closeH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.initiateH2Base;\n+import static org.wso2.carbon.identity.cors.mgt.core.util.TestUtils.spyConnection;\n+\n+/**\n+ * Unit test cases for CORSService.\n+ */\n+@PrepareForTest({PrivilegedCarbonContext.class, IdentityDatabaseUtil.class, IdentityUtil.class,\n+        IdentityTenantUtil.class})\n+public class CORSManagementServiceTest extends PowerMockTestCase {\n+\n+    private ConfigurationManager configurationManager;\n+    private Connection connection;\n+\n+    private CORSManagementService corsManagementService;\n+\n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+\n+        initiateH2Base();\n+        String carbonHome = Paths.get(System.getProperty(\"user.dir\"), \"target\", \"test-classes\").toString();\n+        System.setProperty(CarbonBaseConstants.CARBON_HOME, carbonHome);\n+        System.setProperty(CarbonBaseConstants.CARBON_CONFIG_DIR_PATH, Paths.get(carbonHome, \"conf\").toString());\n+\n+        DataSource dataSource = mock(DataSource.class);\n+        mockStatic(IdentityDatabaseUtil.class);\n+        when(IdentityDatabaseUtil.getDataSource()).thenReturn(dataSource);\n+\n+        connection = TestUtils.getConnection();\n+        Connection spyConnection = spyConnection(connection);\n+        when(dataSource.getConnection()).thenReturn(spyConnection);\n+\n+        ConfigurationManagerComponentDataHolder.setUseCreatedTime(true);\n+        ConfigurationManagerConfigurationHolder configurationHolder = new ConfigurationManagerConfigurationHolder();\n+        ConfigurationDAO configurationDAO = new ConfigurationDAOImpl();\n+        configurationHolder.setConfigurationDAOS(Collections.singletonList(configurationDAO));\n+        mockCarbonContextForTenant(SUPER_TENANT_ID, SUPER_TENANT_DOMAIN_NAME);\n+        mockIdentityTenantUtility();\n+        configurationManager = new ConfigurationManagerImpl(configurationHolder);\n+\n+        ConfigurationManagerComponentDataHolder.getInstance().setConfigurationManagementEnabled(true);\n+\n+        corsManagementService = new CORSManagementServiceImpl();\n+        CORSManagementServiceHolder.getInstance().setConfigurationManager(configurationManager);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+\n+        connection.close();\n+        closeH2Base();\n+    }\n+\n+    @Test\n+    public void testGetCORSOrigins() {\n+\n+        try {\n+            configurationManager.addResourceType(getSampleResourceTypeAdd());\n+            configurationManager.addResource(CORS_ORIGIN_RESOURCE_TYPE, getSampleResourceAdd(SAMPLE_ORIGIN_LIST_1));\n+            List<CORSOrigin> corsOrigins = corsManagementService.getCORSOrigins(SUPER_TENANT_DOMAIN_NAME);", "originalCommit": "d3d32894aaf4d9297ddf1ad7a11093c5b57871af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\nindex 2370c1249bc..eb5b3c5b667 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/test/java/org/wso2/carbon/identity/cors/mgt/core/CORSManagementServiceTest.java\n\n@@ -25,6 +25,8 @@ import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n import org.wso2.carbon.base.CarbonBaseConstants;\n import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.identity.application.authentication.framework.internal.FrameworkServiceDataHolder;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManagerImpl;\n import org.wso2.carbon.identity.configuration.mgt.core.dao.ConfigurationDAO;\n"}}, {"oid": "07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "url": "https://github.com/wso2/carbon-identity-framework/commit/07739c3a21ae9a2d86cb58d4f6dce5453d3eaa2b", "message": "Implement CORS OSGi service", "committedDate": "2020-06-17T15:49:44Z", "type": "forcePushed"}, {"oid": "db5636645e25335562f3b998da145efdf6f25859", "url": "https://github.com/wso2/carbon-identity-framework/commit/db5636645e25335562f3b998da145efdf6f25859", "message": "Implement CORS OSGi service", "committedDate": "2020-06-17T16:51:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5NDg4OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r441694889", "bodyText": "we have a standard for internal error codes..  please refer \"[Architecture] WSO2 Identity Server REST API Error Response Standardization\"\nClient errors in server APIs\nFor client errors in server APIs, we have allocated the range starting from 600.\nEg: USR-600xx\n\nServer Errors in server APIs\nFor server errors in server APIs, we have allocated the range starting from 650.\nEg: USR-650xx", "author": "emswbandara", "createdAt": "2020-06-17T17:02:49Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.constant;\n+\n+/**\n+ * ErrorMessages enum holds the error codes and messages.\n+ */\n+public enum ErrorMessages {\n+\n+    ERROR_CODE_CORS_CRUD(\"CORS_00001\", \"Error in %s while %s the CORS Origins.\"),", "originalCommit": "db5636645e25335562f3b998da145efdf6f25859", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdee9dd18655e64452a1126774f6a760df8f767c", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\nindex a5e1d6ab7ad..c21818e5970 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n\n@@ -23,11 +23,12 @@ package org.wso2.carbon.identity.cors.mgt.core.constant;\n  */\n public enum ErrorMessages {\n \n-    ERROR_CODE_CORS_CRUD(\"CORS_00001\", \"Error in %s while %s the CORS Origins.\"),\n-    ERROR_CODE_EMPTY_LIST(\"CORS_00002\", \"Input CORS origin list cannot be empty.\"),\n-    ERROR_CODE_INVALID_ORIGIN(\"CORS_00003\", \"%s is an invalid origin.\"),\n-    ERROR_CODE_ORIGIN_PRESENT(\"CORS_00004\", \"Tenant %s already have %s as a CORS Origin.\"),\n-    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CORS_00005\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n+    ERROR_CODE_CORS_CRUD(\"CORS_60001\", \"Error in %s while %s the CORS Origins.\"),\n+\n+    ERROR_CODE_EMPTY_LIST(\"CORS_65001\", \"Input CORS origin list cannot be empty.\"),\n+    ERROR_CODE_INVALID_ORIGIN(\"CORS_65002\", \"%s is an invalid origin.\"),\n+    ERROR_CODE_ORIGIN_PRESENT(\"CORS_65003\", \"Tenant %s already have %s as a CORS Origin.\"),\n+    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CORS_65004\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n \n     private final String code;\n     private final String message;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5OTA1MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r441699050", "bodyText": "add new line after method declaration", "author": "emswbandara", "createdAt": "2020-06-17T17:09:54Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.model;\n+\n+/**\n+ * CORSOrigin model class.\n+ */\n+public class CORSOrigin {\n+\n+    private String url;\n+\n+    public CORSOrigin() {\n+\n+    }\n+\n+    public CORSOrigin(String url) {", "originalCommit": "db5636645e25335562f3b998da145efdf6f25859", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "224582cb6f81f3794951f37a718460edc07d81ce", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\nindex e6130b612c2..790f86e4214 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\n\n@@ -30,6 +30,7 @@ public class CORSOrigin {\n     }\n \n     public CORSOrigin(String url) {\n+\n         this.url = url;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwMDg0NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r441700845", "bodyText": "what will happen if an invalid tenant domain is provided? is it getting handled internally?", "author": "emswbandara", "createdAt": "2020-06-17T17:13:05Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,313 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);", "originalCommit": "db5636645e25335562f3b998da145efdf6f25859", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3NjkwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r441776909", "bodyText": "An exception will be thrown.", "author": "ivantha", "createdAt": "2020-06-17T19:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwMDg0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMDY4NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442100685", "bodyText": "in that case, IMO we need to explicitly catch that exception and throw a CORS client exception..", "author": "emswbandara", "createdAt": "2020-06-18T09:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwMDg0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex f0f735ac6a3..d6a3060da05 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -18,6 +18,7 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n"}}, {"oid": "224582cb6f81f3794951f37a718460edc07d81ce", "url": "https://github.com/wso2/carbon-identity-framework/commit/224582cb6f81f3794951f37a718460edc07d81ce", "message": "Implement CORS OSGi service", "committedDate": "2020-06-17T19:31:54Z", "type": "forcePushed"}, {"oid": "bdee9dd18655e64452a1126774f6a760df8f767c", "url": "https://github.com/wso2/carbon-identity-framework/commit/bdee9dd18655e64452a1126774f6a760df8f767c", "message": "Implement CORS OSGi service", "committedDate": "2020-06-18T04:26:39Z", "type": "forcePushed"}, {"oid": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "url": "https://github.com/wso2/carbon-identity-framework/commit/72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "message": "Implement CORS OSGi service", "committedDate": "2020-06-18T05:36:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMjAzMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442102032", "bodyText": "add new line after method declaration", "author": "emswbandara", "createdAt": "2020-06-18T09:42:08Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,313 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                CORS_ORIGIN_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<CORSOrigin> currentCORSOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return currentCORSOrigins.contains(origin);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validate the CORSOrigin list.\n+     *\n+     * @param corsOrigins List of CORSOrigin instances.\n+     * @throws CORSManagementServiceClientException\n+     */\n+    private void validateOrigins(List<CORSOrigin> corsOrigins) throws CORSManagementServiceClientException {\n+        if (corsOrigins == null) {", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex f0f735ac6a3..d6a3060da05 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -18,6 +18,7 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMjM4MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442102381", "bodyText": "let's add a debug log to log the exception", "author": "emswbandara", "createdAt": "2020-06-18T09:42:44Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,313 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                CORS_ORIGIN_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<CORSOrigin> currentCORSOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return currentCORSOrigins.contains(origin);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validate the CORSOrigin list.\n+     *\n+     * @param corsOrigins List of CORSOrigin instances.\n+     * @throws CORSManagementServiceClientException\n+     */\n+    private void validateOrigins(List<CORSOrigin> corsOrigins) throws CORSManagementServiceClientException {\n+        if (corsOrigins == null) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(ERROR_CODE_EMPTY_LIST.getMessage());\n+            }\n+            throw handleClientException(ERROR_CODE_EMPTY_LIST);\n+        }\n+\n+        for (CORSOrigin corsOrigin : corsOrigins) {\n+            if (isInvalidOrigin(corsOrigin)) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(ERROR_CODE_INVALID_ORIGIN.getMessage(), corsOrigin.getUrl()));\n+                }\n+                throw handleClientException(ERROR_CODE_INVALID_ORIGIN, corsOrigin.getUrl());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Check if the format of the Origin is valid.\n+     *\n+     * @param origin Origin to be checked for validity.\n+     * @return {@code true} if the origin is valid, {@code false} otherwise.\n+     */\n+    private boolean isInvalidOrigin(CORSOrigin origin) {\n+\n+        try {\n+            new URL(origin.getUrl()).toURI();\n+        } catch (MalformedURLException | URISyntaxException e) {", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEyMDE4NQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442120185", "bodyText": "This is logged in the higher-level function where isInvalidOrigin is called.", "author": "ivantha", "createdAt": "2020-06-18T10:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMjM4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex f0f735ac6a3..d6a3060da05 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -18,6 +18,7 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEzMTExNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442131114", "bodyText": "use - instead of _  in error codes e.g. CMA-60001", "author": "emswbandara", "createdAt": "2020-06-18T10:34:58Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.constant;\n+\n+/**\n+ * ErrorMessages enum holds the error codes and messages.\n+ */\n+public enum ErrorMessages {\n+\n+    ERROR_CODE_CORS_CRUD(\"CMA_60001\", \"Error in %s while %s the CORS Origins.\"),", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\nindex 060e04e2e49..a366b8d7c8a 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n\n@@ -23,12 +23,13 @@ package org.wso2.carbon.identity.cors.mgt.core.constant;\n  */\n public enum ErrorMessages {\n \n-    ERROR_CODE_CORS_CRUD(\"CMA_60001\", \"Error in %s while %s the CORS Origins.\"),\n+    ERROR_CODE_CORS_CRUD(\"CMA-60001\", \"Error in %s while %s the CORS Origins.\"),\n \n-    ERROR_CODE_EMPTY_LIST(\"CMA_65001\", \"Input CORS origin list cannot be empty.\"),\n-    ERROR_CODE_INVALID_ORIGIN(\"CMA_65002\", \"%s is an invalid origin.\"),\n-    ERROR_CODE_ORIGIN_PRESENT(\"CMA_65003\", \"Tenant %s already have %s as a CORS Origin.\"),\n-    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMA_65004\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n+    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMA-65001\", \"%s is not a valid tenant domain.\"),\n+    ERROR_CODE_EMPTY_LIST(\"CMA-65002\", \"Input CORS origin list cannot be empty.\"),\n+    ERROR_CODE_INVALID_ORIGIN(\"CMA-65003\", \"%s is an invalid origin.\"),\n+    ERROR_CODE_ORIGIN_PRESENT(\"CMA-65004\", \"Tenant %s already have %s as a CORS Origin.\"),\n+    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMA-65005\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n \n     private final String code;\n     private final String message;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEyODg3OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442128879", "bodyText": "Complete the method comments.", "author": "ashensw", "createdAt": "2020-06-18T10:30:25Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,313 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                CORS_ORIGIN_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<CORSOrigin> currentCORSOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return currentCORSOrigins.contains(origin);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validate the CORSOrigin list.\n+     *\n+     * @param corsOrigins List of CORSOrigin instances.\n+     * @throws CORSManagementServiceClientException\n+     */\n+    private void validateOrigins(List<CORSOrigin> corsOrigins) throws CORSManagementServiceClientException {\n+        if (corsOrigins == null) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(ERROR_CODE_EMPTY_LIST.getMessage());\n+            }\n+            throw handleClientException(ERROR_CODE_EMPTY_LIST);\n+        }\n+\n+        for (CORSOrigin corsOrigin : corsOrigins) {\n+            if (isInvalidOrigin(corsOrigin)) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(ERROR_CODE_INVALID_ORIGIN.getMessage(), corsOrigin.getUrl()));\n+                }\n+                throw handleClientException(ERROR_CODE_INVALID_ORIGIN, corsOrigin.getUrl());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Check if the format of the Origin is valid.\n+     *\n+     * @param origin Origin to be checked for validity.\n+     * @return {@code true} if the origin is valid, {@code false} otherwise.\n+     */\n+    private boolean isInvalidOrigin(CORSOrigin origin) {\n+\n+        try {\n+            new URL(origin.getUrl()).toURI();\n+        } catch (MalformedURLException | URISyntaxException e) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Handle server exceptions.\n+     *\n+     * @param error The ErrorMessage.\n+     * @param e Original error.\n+     * @param data Additional data that should be added to the error message. This is a String var-arg.\n+     * @return", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex f0f735ac6a3..d6a3060da05 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -18,6 +18,7 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEyODk0Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442128943", "bodyText": "Complete the method comments.", "author": "ashensw", "createdAt": "2020-06-18T10:30:33Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,313 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+            validateOrigins(corsOrigins);\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                CORS_ORIGIN_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<CORSOrigin> currentCORSOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return currentCORSOrigins.contains(origin);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validate the CORSOrigin list.\n+     *\n+     * @param corsOrigins List of CORSOrigin instances.\n+     * @throws CORSManagementServiceClientException\n+     */\n+    private void validateOrigins(List<CORSOrigin> corsOrigins) throws CORSManagementServiceClientException {\n+        if (corsOrigins == null) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(ERROR_CODE_EMPTY_LIST.getMessage());\n+            }\n+            throw handleClientException(ERROR_CODE_EMPTY_LIST);\n+        }\n+\n+        for (CORSOrigin corsOrigin : corsOrigins) {\n+            if (isInvalidOrigin(corsOrigin)) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(String.format(ERROR_CODE_INVALID_ORIGIN.getMessage(), corsOrigin.getUrl()));\n+                }\n+                throw handleClientException(ERROR_CODE_INVALID_ORIGIN, corsOrigin.getUrl());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Check if the format of the Origin is valid.\n+     *\n+     * @param origin Origin to be checked for validity.\n+     * @return {@code true} if the origin is valid, {@code false} otherwise.\n+     */\n+    private boolean isInvalidOrigin(CORSOrigin origin) {\n+\n+        try {\n+            new URL(origin.getUrl()).toURI();\n+        } catch (MalformedURLException | URISyntaxException e) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Handle server exceptions.\n+     *\n+     * @param error The ErrorMessage.\n+     * @param e Original error.\n+     * @param data Additional data that should be added to the error message. This is a String var-arg.\n+     * @return\n+     */\n+    private CORSManagementServiceServerException handleServerException(ErrorMessages error, Throwable e,\n+                                                                       String ...data) {\n+\n+        return new CORSManagementServiceServerException(error.getCode(), String.format(error.getMessage(), data), e);\n+    }\n+\n+    /**\n+     * Handle client exceptions.\n+     *\n+     * @param error The ErrorMessage.\n+     * @param data Additional data that should be added to the error message. This is a String var-arg.\n+     * @return", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex f0f735ac6a3..d6a3060da05 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -18,6 +18,7 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEzMDAzNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442130036", "bodyText": "Add method comments to all public methods.", "author": "ashensw", "createdAt": "2020-06-18T10:32:46Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.model;\n+\n+/**\n+ * CORSOrigin model class.\n+ */\n+public class CORSOrigin {\n+\n+    private String url;\n+\n+    public CORSOrigin() {\n+\n+    }\n+\n+    public CORSOrigin(String url) {\n+\n+        this.url = url;\n+    }\n+\n+    /**\n+     * Overrides {@code Object.hashCode}.\n+     *\n+     * @return The object hash code.\n+     */\n+    @Override\n+    public int hashCode() {\n+\n+        return url.hashCode();\n+    }\n+\n+    /**\n+     * Overrides {@code Object.equals()}.\n+     *\n+     * @param object The object to compare to.\n+     * @return {@code true} if the objects are both origins with the same value, else {@code false}.\n+     */\n+    @Override\n+    public boolean equals(Object object) {\n+\n+        return object instanceof CORSOrigin && this.toString().equals(object.toString());\n+    }\n+", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\nindex 790f86e4214..7c47f9fc391 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/model/CORSOrigin.java\n\n@@ -23,12 +23,23 @@ package org.wso2.carbon.identity.cors.mgt.core.model;\n  */\n public class CORSOrigin {\n \n+    /**\n+     * A {@code String} to hold the URL.\n+     */\n     private String url;\n \n+    /**\n+     * Default constructor.\n+     */\n     public CORSOrigin() {\n \n     }\n \n+    /**\n+     * Constructor with the {@code url} parameter.\n+     *\n+     * @param url The value to be set as the {@code url}.\n+     */\n     public CORSOrigin(String url) {\n \n         this.url = url;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEzODk3Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442138976", "bodyText": "Why don't we throw the exception from here?", "author": "ashensw", "createdAt": "2020-06-18T10:50:19Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/function/CORSOriginToAttribute.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.function;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.util.function.Function;\n+\n+/**\n+ * Converts a CORSOrigin to a ConfigurationManagement Resource attribute.\n+ */\n+public class CORSOriginToAttribute implements Function<CORSOrigin, Attribute> {\n+\n+    private static final Log log = LogFactory.getLog(CORSOriginToAttribute.class);\n+\n+    @Override\n+    public Attribute apply(CORSOrigin corsOrigin) {\n+\n+        ObjectMapper mapper = new ObjectMapper();\n+\n+        Attribute attribute = new Attribute();\n+        attribute.setKey(String.valueOf(corsOrigin.hashCode()));\n+        try {\n+            String corsOriginString = mapper.writeValueAsString(corsOrigin);\n+            attribute.setValue(corsOriginString);\n+        } catch (IOException e) {\n+            if (log.isDebugEnabled()) {", "originalCommit": "72ac52ceab5e58cd65ce8471bb765bb12d0736f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/function/CORSOriginToAttribute.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/function/CORSOriginToAttribute.java\nindex 8f0775fa573..00ee11eaead 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/function/CORSOriginToAttribute.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/function/CORSOriginToAttribute.java\n\n@@ -18,37 +18,29 @@\n \n package org.wso2.carbon.identity.cors.mgt.core.internal.function;\n \n+import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n \n-import java.io.IOException;\n-import java.util.function.Function;\n-\n /**\n  * Converts a CORSOrigin to a ConfigurationManagement Resource attribute.\n  */\n-public class CORSOriginToAttribute implements Function<CORSOrigin, Attribute> {\n+public class CORSOriginToAttribute implements CheckedFunction<CORSOrigin, Attribute> {\n \n     private static final Log log = LogFactory.getLog(CORSOriginToAttribute.class);\n \n     @Override\n-    public Attribute apply(CORSOrigin corsOrigin) {\n+    public Attribute apply(CORSOrigin corsOrigin) throws JsonProcessingException {\n \n         ObjectMapper mapper = new ObjectMapper();\n \n         Attribute attribute = new Attribute();\n         attribute.setKey(String.valueOf(corsOrigin.hashCode()));\n-        try {\n-            String corsOriginString = mapper.writeValueAsString(corsOrigin);\n-            attribute.setValue(corsOriginString);\n-        } catch (IOException e) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Error while converting a CORS Origin to a String.\", e);\n-            }\n-        }\n+        String corsOriginString = mapper.writeValueAsString(corsOrigin);\n+        attribute.setValue(corsOriginString);\n         return attribute;\n     }\n }\n"}}, {"oid": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "url": "https://github.com/wso2/carbon-identity-framework/commit/48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "message": "Implement CORS OSGi service", "committedDate": "2020-06-19T07:02:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY3NjI2OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r442676269", "bodyText": "client errors should start from 600xx and server erros 650xx..", "author": "emswbandara", "createdAt": "2020-06-19T07:24:43Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.constant;\n+\n+/**\n+ * ErrorMessages enum holds the error codes and messages.\n+ */\n+public enum ErrorMessages {\n+\n+    ERROR_CODE_CORS_CRUD(\"CMA-60001\", \"Error in %s while %s the CORS Origins.\"),\n+\n+    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMA-65001\", \"%s is not a valid tenant domain.\"),", "originalCommit": "48d6e40cbe3a30a3f36c2236bfd2d51f730cfed9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\nindex a366b8d7c8a..1738c6222f6 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n\n@@ -23,13 +23,13 @@ package org.wso2.carbon.identity.cors.mgt.core.constant;\n  */\n public enum ErrorMessages {\n \n-    ERROR_CODE_CORS_CRUD(\"CMA-60001\", \"Error in %s while %s the CORS Origins.\"),\n+    ERROR_CODE_CORS_CRUD(\"CMA-65001\", \"Error in %s while %s the CORS Origins.\"),\n \n-    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMA-65001\", \"%s is not a valid tenant domain.\"),\n-    ERROR_CODE_EMPTY_LIST(\"CMA-65002\", \"Input CORS origin list cannot be empty.\"),\n-    ERROR_CODE_INVALID_ORIGIN(\"CMA-65003\", \"%s is an invalid origin.\"),\n-    ERROR_CODE_ORIGIN_PRESENT(\"CMA-65004\", \"Tenant %s already have %s as a CORS Origin.\"),\n-    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMA-65005\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n+    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMA-60001\", \"%s is not a valid tenant domain.\"),\n+    ERROR_CODE_EMPTY_LIST(\"CMA-60002\", \"Input CORS origin list cannot be empty.\"),\n+    ERROR_CODE_INVALID_ORIGIN(\"CMA-60003\", \"%s is an invalid origin.\"),\n+    ERROR_CODE_ORIGIN_PRESENT(\"CMA-60004\", \"Tenant %s already have %s as a CORS Origin.\"),\n+    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMA-60005\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n \n     private final String code;\n     private final String message;\n"}}, {"oid": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "url": "https://github.com/wso2/carbon-identity-framework/commit/e41e681369afa41ef2327d8e3e9ead8f062dbed5", "message": "Implement CORS OSGi service", "committedDate": "2020-06-19T07:28:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NTA2Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443285067", "bodyText": "Shall we chage the code to CMS - CORS Management Service.\nThat's how you have named the OSGI service right", "author": "malithie", "createdAt": "2020-06-22T02:01:22Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.constant;\n+\n+/**\n+ * ErrorMessages enum holds the error codes and messages.\n+ */\n+public enum ErrorMessages {\n+\n+    ERROR_CODE_CORS_CRUD(\"CMA-65001\", \"Error in %s while %s the CORS Origins.\"),", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\nindex 1738c6222f6..aee2b06c9a2 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/constant/ErrorMessages.java\n\n@@ -20,24 +20,47 @@ package org.wso2.carbon.identity.cors.mgt.core.constant;\n \n /**\n  * ErrorMessages enum holds the error codes and messages.\n+ * CMS stands for Cors Management Service.\n  */\n public enum ErrorMessages {\n \n-    ERROR_CODE_CORS_CRUD(\"CMA-65001\", \"Error in %s while %s the CORS Origins.\"),\n-\n-    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMA-60001\", \"%s is not a valid tenant domain.\"),\n-    ERROR_CODE_EMPTY_LIST(\"CMA-60002\", \"Input CORS origin list cannot be empty.\"),\n-    ERROR_CODE_INVALID_ORIGIN(\"CMA-60003\", \"%s is an invalid origin.\"),\n-    ERROR_CODE_ORIGIN_PRESENT(\"CMA-60004\", \"Tenant %s already have %s as a CORS Origin.\"),\n-    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMA-60005\", \"Tenant %s doesn't have %s as a CORS Origin.\");\n+    ERROR_CODE_CORS_RETRIEVE(\"CMS-65001\",\n+            \"Unable to retrieve CORS Origins.\",\n+            \"Server encountered an error while retrieving the CORS Origins of %s.\"),\n+    ERROR_CODE_CORS_SET(\"CMS-65002\",\n+            \"Unable to set CORS Origins.\",\n+            \"Server encountered an error while setting the CORS Origins of %s.\"),\n+    ERROR_CODE_CORS_ADD(\"CMS-65003\",\n+            \"Unable to add CORS Origins.\",\n+            \"Server encountered an error while adding the CORS Origins to %s.\"),\n+    ERROR_CODE_CORS_DELETE(\"CMS-65004\",\n+            \"Unable to delete CORS Origins.\",\n+            \"Server encountered an error while deleting the CORS Origins of %s.\"),\n+    ERROR_CODE_INVALID_TENANT_DOMAIN(\"CMS-60001\",\n+            \"Invalid input.\",\n+            \"%s is not a valid tenant domain.\"),\n+    ERROR_CODE_EMPTY_LIST(\"CMS-60002\",\n+            \"Invalid input.\",\n+            \"Input CORS origin list cannot be empty.\"),\n+    ERROR_CODE_INVALID_ORIGIN(\"CMS-60003\",\n+            \"Invalid input.\",\n+            \"%s is an invalid origin.\"),\n+    ERROR_CODE_ORIGIN_PRESENT(\"CMS-60004\",\n+            \"Redundant addition of existing CORS Origin.\",\n+            \"Tenant %s already have %s as a CORS Origin.\"),\n+    ERROR_CODE_ORIGIN_NOT_PRESENT(\"CMS-60005\",\n+            \"Non existing CORS Origin deletion.\",\n+            \"Tenant %s doesn't have %s as a CORS Origin.\");\n \n     private final String code;\n     private final String message;\n+    private final String description;\n \n-    ErrorMessages(String code, String message) {\n+    ErrorMessages(String code, String message, String description) {\n \n         this.code = code;\n         this.message = message;\n+        this.description = description;\n     }\n \n     public String getCode() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NzUyNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443287524", "bodyText": "I think -1 magic number here has a constant in multi tenant utils", "author": "malithie", "createdAt": "2020-06-22T02:15:32Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException | JsonProcessingException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException, IOException {\n+\n+        Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                CORS_ORIGIN_RESOURCE_NAME);\n+        if (resource != null) {\n+            List<CORSOrigin> currentCORSOrigins = new ResourceToCORSOrigin().apply(resource);\n+\n+            return currentCORSOrigins.contains(origin);\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validate the tenant domain.\n+     *\n+     * @param tenantDomain The tenant domain.\n+     * @throws CORSManagementServiceClientException\n+     */\n+    public void validateTenantDomain(String tenantDomain) throws CORSManagementServiceClientException {\n+\n+        if (IdentityTenantUtil.getTenantId(tenantDomain) == -1) {", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443288778", "bodyText": "Configuration manager should be ideally throwing a not found exception, rather than the cosumers checking for an error code. Shall we fix this. @mefarazath , @emswbandara , @ashensw thoughts ?", "author": "malithie", "createdAt": "2020-06-22T02:22:14Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException | JsonProcessingException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxMzc5MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443313790", "bodyText": "for other similar OSGi services we followed the same approach. We defined a specific client error code and added a mapping to send 404 not found to the clients.\ne.g.\nhttps://github.com/wso2/identity-rest-dispatcher/blob/master/components/org.wso2.carbon.identity.api.dispatcher/src/main/resources/ErrorMappings.properties#L29", "author": "emswbandara", "createdAt": "2020-06-22T04:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxODUzNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443318537", "bodyText": "Is that the correct thing to do?\nIMO, exception type should denote this other than further string processing", "author": "malithie", "createdAt": "2020-06-22T05:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNTc2Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443325766", "bodyText": "Yes. IMO we should fix this behaviour.\nCurrent behaviour makes it very hard to check for the existence of something in the ConfigurationManager as it requires the callee to handle exceptions and check error codes just to see if something exists.", "author": "mefarazath", "createdAt": "2020-06-22T05:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNDAyMA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443934020", "bodyText": "@ivantha please create an issue for this and point here.\nWe can look into that separately", "author": "malithie", "createdAt": "2020-06-23T02:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxMjQyMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r444312422", "bodyText": "wso2/product-is#8555", "author": "ivantha", "createdAt": "2020-06-23T15:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4ODc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4OTYwNQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443289605", "bodyText": "Ideally this service should be returning an unmodifiable list right", "author": "malithie", "createdAt": "2020-06-22T02:26:53Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkyMDUzMw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443920533", "bodyText": "What is the purpose of returning an unmodifiable list rather than a plain ArrayList?", "author": "ivantha", "createdAt": "2020-06-23T02:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4OTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzNDM0MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443934341", "bodyText": "So that the consumers cannot manipulate.", "author": "malithie", "createdAt": "2020-06-23T03:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4OTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk0NTQ2MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443945460", "bodyText": "Changed to return Collections.unmodifiableList(corsOrigins);.", "author": "ivantha", "createdAt": "2020-06-23T03:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4OTYwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4OTkyNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443289924", "bodyText": "It's not good to pass text information that should be in the message as arguments. It breaks readability.", "author": "malithie", "createdAt": "2020-06-22T02:28:30Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MjcxNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443292714", "bodyText": "check my comment above", "author": "malithie", "createdAt": "2020-06-22T02:44:00Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException | JsonProcessingException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MzMzMg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443293332", "bodyText": "check my comment above", "author": "malithie", "createdAt": "2020-06-22T02:47:08Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException | JsonProcessingException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5NDA4MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443294081", "bodyText": "Can we rename this method? Something like 'isPreConfiguredCORSOrigin' or 'isDefinedCORSOrigin' or 'isCORSOriginAlreadyDefined'", "author": "malithie", "createdAt": "2020-06-22T02:50:43Z", "path": "components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java", "diffHunk": "@@ -0,0 +1,333 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.cors.mgt.core.internal.impl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n+import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n+import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n+import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n+import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n+import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceClientException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceException;\n+import org.wso2.carbon.identity.cors.mgt.core.exception.CORSManagementServiceServerException;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.CORSManagementServiceHolder;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToAttribute;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.CORSOriginToResourceAdd;\n+import org.wso2.carbon.identity.cors.mgt.core.internal.function.ResourceToCORSOrigin;\n+import org.wso2.carbon.identity.cors.mgt.core.model.CORSOrigin;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.wso2.carbon.identity.configuration.mgt.core.constant.ConfigurationConstants.ErrorMessages.ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_CORS_CRUD;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_EMPTY_LIST;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_INVALID_ORIGIN;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_NOT_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages.ERROR_CODE_ORIGIN_PRESENT;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_NAME;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION;\n+import static org.wso2.carbon.identity.cors.mgt.core.internal.Constants.CORS_ORIGIN_RESOURCE_TYPE_NAME;\n+\n+/**\n+ * Implementation of the CORSService.\n+ */\n+public class CORSManagementServiceImpl implements CORSManagementService {\n+\n+    private static final Log log = LogFactory.getLog(CORSManagementServiceImpl.class);\n+\n+    @Override\n+    public List<CORSOrigin> getCORSOrigins(String tenantDomain) throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            Resource resource = getConfigurationManager().getResource(CORS_ORIGIN_RESOURCE_TYPE_NAME,\n+                    CORS_ORIGIN_RESOURCE_NAME);\n+            List<CORSOrigin> corsOrigins;\n+            if (resource == null) {\n+                corsOrigins = new ArrayList<>();\n+            } else {\n+                corsOrigins = new ResourceToCORSOrigin().apply(resource);\n+            }\n+\n+            return corsOrigins;\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"retrieving\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void setCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            ResourceAdd resourceAdd = new CORSOriginToResourceAdd().apply(corsOrigins);\n+            getConfigurationManager().replaceResource(CORS_ORIGIN_RESOURCE_TYPE_NAME, resourceAdd);\n+        } catch (ConfigurationManagementException | JsonProcessingException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"updating\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void addCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().addAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute);\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, \"adding\", tenantDomain);\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    @Override\n+    public void deleteCORSOrigins(String tenantDomain, List<CORSOrigin> corsOrigins)\n+            throws CORSManagementServiceException {\n+\n+        validateTenantDomain(tenantDomain);\n+        validateOrigins(corsOrigins);\n+        try {\n+            FrameworkUtils.startTenantFlow(tenantDomain);\n+            addCORSOriginResourceTypeIfNotExists();\n+\n+            // Check if origins are not present\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                if (!tenantHasCORSOrigin(corsOrigin)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(String.format(ERROR_CODE_ORIGIN_NOT_PRESENT.getMessage(),\n+                                tenantDomain, corsOrigin)));\n+                    }\n+                    throw handleClientException(ERROR_CODE_ORIGIN_NOT_PRESENT, tenantDomain, corsOrigin.getUrl());\n+                }\n+            }\n+\n+            for (CORSOrigin corsOrigin : corsOrigins) {\n+                Attribute attribute = new CORSOriginToAttribute().apply(corsOrigin);\n+                getConfigurationManager().deleteAttribute(CORS_ORIGIN_RESOURCE_TYPE_NAME, CORS_ORIGIN_RESOURCE_NAME,\n+                        attribute.getKey());\n+            }\n+        } catch (ConfigurationManagementException | IOException e) {\n+            throw handleServerException(ERROR_CODE_CORS_CRUD, e, tenantDomain, \"deleting\");\n+        } finally {\n+            FrameworkUtils.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Add the CORS Origin resource type to the ConfigurationManager if not already present.\n+     *\n+     * @throws ConfigurationManagementException\n+     */\n+    private void addCORSOriginResourceTypeIfNotExists() throws ConfigurationManagementException {\n+\n+        if (isCORSOriginResourceTypeNotExists()) {\n+            ResourceTypeAdd resourceTypeAdd = createCORSOriginResourceTypeToAdd();\n+            getConfigurationManager().addResourceType(resourceTypeAdd);\n+        }\n+    }\n+\n+    /**\n+     * Returns true if the CORS Origin type is already in the ConfigurationManager.\n+     *\n+     * @return {@code true} if the CORS Origin resource type is already in the ConfigurationManager,\n+     * {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean isCORSOriginResourceTypeNotExists() throws ConfigurationManagementException {\n+\n+        try {\n+            getConfigurationManager().getResourceType(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        } catch (ConfigurationManagementClientException e) {\n+            if (ERROR_CODE_RESOURCE_TYPE_DOES_NOT_EXISTS.getCode().equals(e.getErrorCode())) {\n+                return true;\n+            }\n+            throw e;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Create a ResourceTypeAdd for CORS Origin type.\n+     *\n+     * @return ResourceTypeAdd A resource type with CORS_ORIGIN_RESOURCE_TYPE set as the name.\n+     */\n+    private ResourceTypeAdd createCORSOriginResourceTypeToAdd() {\n+\n+        ResourceTypeAdd resourceTypeAdd = new ResourceTypeAdd();\n+        resourceTypeAdd.setName(CORS_ORIGIN_RESOURCE_TYPE_NAME);\n+        resourceTypeAdd.setDescription(CORS_ORIGIN_RESOURCE_TYPE_DESCRIPTION);\n+        return resourceTypeAdd;\n+    }\n+\n+    /**\n+     * Retrieve the ConfigurationManager instance from the CORSServiceHolder.\n+     *\n+     * @return ConfigurationManager The ConfigurationManager instance.\n+     */\n+    private ConfigurationManager getConfigurationManager() {\n+\n+        return CORSManagementServiceHolder.getInstance().getConfigurationManager();\n+    }\n+\n+    /**\n+     * Returns true if the tenant already has a particular CORS Origin.\n+     *\n+     * @param origin The Origin to be checked against the existing Origins.\n+     * @return {@code true} if the tenant already have the particular CORS Origin, {@code false} otherwise.\n+     * @throws ConfigurationManagementException\n+     */\n+    private boolean tenantHasCORSOrigin(CORSOrigin origin) throws ConfigurationManagementException, IOException {", "originalCommit": "e41e681369afa41ef2327d8e3e9ead8f062dbed5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkxODE2OA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2938#discussion_r443918168", "bodyText": "Changed to isDefinedCORSOriginResource.", "author": "ivantha", "createdAt": "2020-06-23T01:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5NDA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "chunk": "diff --git a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\nindex d6a3060da05..f864965590f 100644\n--- a/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n+++ b/components/cors-mgt/org.wso2.carbon.identity.cors.mgt.core/src/main/java/org/wso2/carbon/identity/cors/mgt/core/internal/impl/CORSManagementServiceImpl.java\n\n@@ -23,12 +23,10 @@ import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkUtils;\n import org.wso2.carbon.identity.configuration.mgt.core.ConfigurationManager;\n-import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementClientException;\n import org.wso2.carbon.identity.configuration.mgt.core.exception.ConfigurationManagementException;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Attribute;\n import org.wso2.carbon.identity.configuration.mgt.core.model.Resource;\n import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceAdd;\n-import org.wso2.carbon.identity.configuration.mgt.core.model.ResourceTypeAdd;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.cors.mgt.core.CORSManagementService;\n import org.wso2.carbon.identity.cors.mgt.core.constant.ErrorMessages;\n"}}, {"oid": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "url": "https://github.com/wso2/carbon-identity-framework/commit/8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "message": "Implement CORS OSGi service", "committedDate": "2020-06-23T14:13:22Z", "type": "commit"}, {"oid": "8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "url": "https://github.com/wso2/carbon-identity-framework/commit/8df9f16921f1ad3b0223285094a1c5c8b3c2e791", "message": "Implement CORS OSGi service", "committedDate": "2020-06-23T14:13:22Z", "type": "forcePushed"}]}