{"pr_number": 2854, "pr_title": "Add Config to get allowed userstore types", "pr_createdAt": "2020-04-03T10:34:38Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2854", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNTc5Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2854#discussion_r402915793", "bodyText": "getAllowedUserstors - Typo", "author": "thanujalk", "createdAt": "2020-04-03T10:39:06Z", "path": "components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/UserStoreConfigServiceImpl.java", "diffHunk": "@@ -249,7 +249,18 @@ public UserStoreDTO getUserStore(String domain) throws IdentityUserStoreMgtExcep\n     @Override\n     public Set<String> getAvailableUserStoreClasses() throws IdentityUserStoreMgtException {\n \n-        return UserStoreManagerRegistry.getUserStoreManagerClasses();\n+        return getAllowedUserstoreClasses(UserStoreManagerRegistry.getUserStoreManagerClasses());\n+    }\n+\n+    private Set<String> getAllowedUserstoreClasses(Set<String> userstores) {\n+\n+        Set<String> allowedUserstores = UserStoreConfigListenersHolder.getInstance().getAllowedUserstors();", "originalCommit": "cc22d4f4514a685fc0ba36de7245b3d534499d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d15751eb43e54af38d2317f726fc1290234626e", "chunk": "diff --git a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/UserStoreConfigServiceImpl.java b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/UserStoreConfigServiceImpl.java\nindex cc838218ee1..cdd289202d3 100644\n--- a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/UserStoreConfigServiceImpl.java\n+++ b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/UserStoreConfigServiceImpl.java\n\n@@ -254,7 +254,7 @@ public class UserStoreConfigServiceImpl implements UserStoreConfigService {\n \n     private Set<String> getAllowedUserstoreClasses(Set<String> userstores) {\n \n-        Set<String> allowedUserstores = UserStoreConfigListenersHolder.getInstance().getAllowedUserstors();\n+        Set<String> allowedUserstores = UserStoreConfigListenersHolder.getInstance().getAllowedUserstores();\n         // Preserving the old behavior, if the 'AllowedUserstores' config is not set.\n         if (allowedUserstores == null) {\n             return userstores;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNjU0MA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2854#discussion_r402916540", "bodyText": "Shall we introduce a constant for \"AllowedUserstores\"", "author": "thanujalk", "createdAt": "2020-04-03T10:40:39Z", "path": "components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java", "diffHunk": "@@ -219,4 +227,36 @@ protected void unsetUserStoreConfigListenerService(UserStoreConfigListener userS\n \n         UserStoreConfigListenersHolder.getInstance().unsetUserStoreConfigListenerService(userStoreConfigListener);\n     }\n+\n+    private void readAllowedUserstoreConfiguration() {\n+\n+        IdentityConfigParser configParser = IdentityConfigParser.getInstance();\n+        // Read allowed userstore configurations.\n+        OMElement userstoresConfig = configParser.getConfigElement(\"AllowedUserstores\");", "originalCommit": "cc22d4f4514a685fc0ba36de7245b3d534499d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d15751eb43e54af38d2317f726fc1290234626e", "chunk": "diff --git a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\nindex 9d29665a94b..5f8ed473826 100644\n--- a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\n+++ b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\n\n@@ -231,16 +232,17 @@ public class UserStoreConfigComponent {\n     private void readAllowedUserstoreConfiguration() {\n \n         IdentityConfigParser configParser = IdentityConfigParser.getInstance();\n-        // Read allowed userstore configurations.\n-        OMElement userstoresConfig = configParser.getConfigElement(\"AllowedUserstores\");\n+        // Read allowed userstore configurations in identity.xml.\n+        OMElement userstoresConfig = configParser.getConfigElement(UserStoreConfigurationConstant.ALLOWED_USERSTORES);\n         if (userstoresConfig == null) {\n             if (log.isDebugEnabled()) {\n-                log.debug(\"'AllowedUserstores' config not found.\");\n+                log.debug(\"'\" + UserStoreConfigurationConstant.ALLOWED_USERSTORES + \"' config not found.\");\n             }\n             return;\n         }\n         Set<String> allowedUserstores = new HashSet<>();\n-        Iterator userstoreItr = userstoresConfig.getChildrenWithLocalName(\"AllowedUserstore\");\n+        Iterator userstoreItr = userstoresConfig.getChildrenWithLocalName(UserStoreConfigurationConstant\n+                .ALLOWED_USERSTORE);\n         int allowedUserstoreCount = 0;\n         if (userstoreItr != null) {\n             while (userstoreItr.hasNext()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNjg5OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2854#discussion_r402916899", "bodyText": "can use ==", "author": "thanujalk", "createdAt": "2020-04-03T10:41:23Z", "path": "components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java", "diffHunk": "@@ -219,4 +227,36 @@ protected void unsetUserStoreConfigListenerService(UserStoreConfigListener userS\n \n         UserStoreConfigListenersHolder.getInstance().unsetUserStoreConfigListenerService(userStoreConfigListener);\n     }\n+\n+    private void readAllowedUserstoreConfiguration() {\n+\n+        IdentityConfigParser configParser = IdentityConfigParser.getInstance();\n+        // Read allowed userstore configurations.\n+        OMElement userstoresConfig = configParser.getConfigElement(\"AllowedUserstores\");\n+        if (userstoresConfig == null) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"'AllowedUserstores' config not found.\");\n+            }\n+            return;\n+        }\n+        Set<String> allowedUserstores = new HashSet<>();\n+        Iterator userstoreItr = userstoresConfig.getChildrenWithLocalName(\"AllowedUserstore\");\n+        int allowedUserstoreCount = 0;\n+        if (userstoreItr != null) {\n+            while (userstoreItr.hasNext()) {\n+                OMElement userstoreConfig = (OMElement) userstoreItr.next();\n+                String allowedUserstore = userstoreConfig.getText();\n+                if (StringUtils.isNotBlank(allowedUserstore)) {\n+                    allowedUserstores.add(allowedUserstore);\n+                    allowedUserstoreCount++;\n+                }\n+            }\n+        }\n+        if (!(allowedUserstoreCount > 0)) {", "originalCommit": "cc22d4f4514a685fc0ba36de7245b3d534499d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d15751eb43e54af38d2317f726fc1290234626e", "chunk": "diff --git a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\nindex 9d29665a94b..5f8ed473826 100644\n--- a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\n+++ b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigComponent.java\n\n@@ -231,16 +232,17 @@ public class UserStoreConfigComponent {\n     private void readAllowedUserstoreConfiguration() {\n \n         IdentityConfigParser configParser = IdentityConfigParser.getInstance();\n-        // Read allowed userstore configurations.\n-        OMElement userstoresConfig = configParser.getConfigElement(\"AllowedUserstores\");\n+        // Read allowed userstore configurations in identity.xml.\n+        OMElement userstoresConfig = configParser.getConfigElement(UserStoreConfigurationConstant.ALLOWED_USERSTORES);\n         if (userstoresConfig == null) {\n             if (log.isDebugEnabled()) {\n-                log.debug(\"'AllowedUserstores' config not found.\");\n+                log.debug(\"'\" + UserStoreConfigurationConstant.ALLOWED_USERSTORES + \"' config not found.\");\n             }\n             return;\n         }\n         Set<String> allowedUserstores = new HashSet<>();\n-        Iterator userstoreItr = userstoresConfig.getChildrenWithLocalName(\"AllowedUserstore\");\n+        Iterator userstoreItr = userstoresConfig.getChildrenWithLocalName(UserStoreConfigurationConstant\n+                .ALLOWED_USERSTORE);\n         int allowedUserstoreCount = 0;\n         if (userstoreItr != null) {\n             while (userstoreItr.hasNext()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNzU4Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2854#discussion_r402917582", "bodyText": "Typo", "author": "thanujalk", "createdAt": "2020-04-03T10:42:52Z", "path": "components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigListenersHolder.java", "diffHunk": "@@ -69,4 +71,14 @@ public UserStoreConfigService getUserStoreConfigService() {\n         return userStoreConfigService;\n     }\n \n+    public Set<String> getAllowedUserstors() {", "originalCommit": "cc22d4f4514a685fc0ba36de7245b3d534499d7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d15751eb43e54af38d2317f726fc1290234626e", "chunk": "diff --git a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigListenersHolder.java b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigListenersHolder.java\nindex c27f63a0fbd..39e1792965e 100644\n--- a/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigListenersHolder.java\n+++ b/components/user-store/org.wso2.carbon.identity.user.store.configuration/src/main/java/org/wso2/carbon/identity/user/store/configuration/internal/UserStoreConfigListenersHolder.java\n\n@@ -71,14 +71,14 @@ public class UserStoreConfigListenersHolder {\n         return userStoreConfigService;\n     }\n \n-    public Set<String> getAllowedUserstors() {\n+    public Set<String> getAllowedUserstores() {\n \n-        return allowedUserstors;\n+        return allowedUserstores;\n     }\n \n-    public void setAllowedUserstors(Set<String> allowedUserstors) {\n+    public void setAllowedUserstores(Set<String> allowedUserstores) {\n \n-        this.allowedUserstors = allowedUserstors;\n+        this.allowedUserstores = allowedUserstores;\n     }\n \n }\n"}}, {"oid": "5d15751eb43e54af38d2317f726fc1290234626e", "url": "https://github.com/wso2/carbon-identity-framework/commit/5d15751eb43e54af38d2317f726fc1290234626e", "message": "Add Config to get allowed userstore types", "committedDate": "2020-04-03T11:24:26Z", "type": "commit"}, {"oid": "f5be867e602bc9912f2d3010a595ba5a7a5ff5f6", "url": "https://github.com/wso2/carbon-identity-framework/commit/f5be867e602bc9912f2d3010a595ba5a7a5ff5f6", "message": "Template config for allowed userstores", "committedDate": "2020-04-06T04:10:14Z", "type": "commit"}]}