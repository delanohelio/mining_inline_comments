{"pr_number": 2778, "pr_title": "Fix issue of deleting claim dialect", "pr_createdAt": "2020-02-22T18:13:43Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2778", "timeline": [{"oid": "2e6a60ab2b25a0349d0dd3be1658f5f583a2a393", "url": "https://github.com/wso2/carbon-identity-framework/commit/2e6a60ab2b25a0349d0dd3be1658f5f583a2a393", "message": "Fix issue of deleting claim dialect", "committedDate": "2020-02-22T18:05:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NDExMQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2778#discussion_r383084111", "bodyText": "This needs to fixed at the caching level. Need to check why the cache is not cleared properly", "author": "IsuraD", "createdAt": "2020-02-24T04:42:28Z", "path": "components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java", "diffHunk": "@@ -132,11 +132,31 @@ public void removeClaimDialect(ClaimDialect claimDialect, String tenantDomain) t\n         // Add listener\n \n         this.claimDialectDAO.removeClaimDialect(claimDialect, tenantId);\n+        postRemoveClaimDialect(claimDialect.getClaimDialectURI(), tenantId);", "originalCommit": "2e6a60ab2b25a0349d0dd3be1658f5f583a2a393", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxMTQ2MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2778#discussion_r383211461", "bodyText": "Add method to remove external claim cache when deleting the claim dialect in \"CacheBackedExternalClaimDAO\" class. e1c21e4", "author": "GANGANI", "createdAt": "2020-02-24T11:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4NDExMQ=="}], "type": "inlineReview", "revised_code": {"commit": "e1c21e4270cadf8606625640c51d27da21416696", "chunk": "diff --git a/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java b/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java\nindex 01c8ebf54c1..e992ca53eea 100644\n--- a/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java\n+++ b/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java\n\n@@ -132,31 +132,13 @@ public class ClaimMetadataManagementServiceImpl implements ClaimMetadataManageme\n         // Add listener\n \n         this.claimDialectDAO.removeClaimDialect(claimDialect, tenantId);\n-        postRemoveClaimDialect(claimDialect.getClaimDialectURI(), tenantId);\n-\n+        // When deleting a claim dialect the relevant external claim deletion is handled by the DB through\n+        // ON DELETE CASCADE. Here we are removing the relevant cache entry.\n+        externalClaimDAO.removeExternalClaimCache(claimDialect.getClaimDialectURI(), tenantId);\n         // Add listener\n \n     }\n \n-    /**\n-     * Remove mapped external claims at post removing claim dialect.\n-     *\n-     * @param externalClaimDialectURI External claim dialect uri\n-     * @param tenantId                Tenant Id\n-     * @throws ClaimMetadataException If an error occurred while removing external claims.\n-     */\n-    private void postRemoveClaimDialect(String externalClaimDialectURI, int tenantId)\n-            throws ClaimMetadataException {\n-\n-        String tenantDomain = IdentityTenantUtil.getTenantDomain(tenantId);\n-        ClaimMetadataManagementServiceImpl claimMetadataService = new ClaimMetadataManagementServiceImpl();\n-        List<ExternalClaim> externalClaims = claimMetadataService.\n-                getExternalClaims(externalClaimDialectURI, tenantDomain);\n-        for (ExternalClaim externalClaim : externalClaims) {\n-            externalClaimDAO.removeExternalClaim(externalClaimDialectURI, externalClaim.getClaimURI(), tenantId);\n-        }\n-    }\n-\n     @Override\n     public List<LocalClaim> getLocalClaims(String tenantDomain) throws ClaimMetadataException {\n \n"}}, {"oid": "e1c21e4270cadf8606625640c51d27da21416696", "url": "https://github.com/wso2/carbon-identity-framework/commit/e1c21e4270cadf8606625640c51d27da21416696", "message": "Add method to remove external claim cache when deleting claim dialect.", "committedDate": "2020-02-24T11:17:22Z", "type": "commit"}]}