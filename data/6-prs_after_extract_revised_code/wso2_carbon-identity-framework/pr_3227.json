{"pr_number": 3227, "pr_title": "Clear configuration management service cache after replace operation", "pr_createdAt": "2020-11-08T18:12:06Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3227", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2ODk1OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3227#discussion_r519468959", "bodyText": "Isn't this log entry incorrect? We are clearing the cache here.", "author": "JKAUSHALYA", "createdAt": "2020-11-08T19:50:02Z", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/CachedBackedConfigurationDAO.java", "diffHunk": "@@ -403,4 +404,44 @@ private void addResourceToCache(Resource resource) throws ConfigurationManagemen\n             PrivilegedCarbonContext.endTenantFlow();\n         }\n     }\n+\n+    private void deleteResourceFromCache(Resource resource) throws ConfigurationManagementException {\n+\n+        if (resource == null) {\n+            return;\n+        }\n+\n+        int tenantId;\n+        try {\n+            tenantId = ConfigurationManagerComponentDataHolder.getInstance().getRealmService()\n+                    .getTenantManager().getTenantId(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+        } catch (UserStoreException e) {\n+            throw new ConfigurationManagementException(\"Error when setting tenant domain. \",\n+                    ConfigurationConstants.ErrorMessages.ERROR_CODE_UNEXPECTED.getCode(), e);\n+        }\n+\n+        try {\n+            PrivilegedCarbonContext.startTenantFlow();\n+            PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                    .setTenantDomain(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+            PrivilegedCarbonContext.getThreadLocalCarbonContext().setTenantId(tenantId);\n+\n+            ResourceByIdCacheKey resourceByIdCacheKey = new ResourceByIdCacheKey(resource.getResourceId(),\n+                    resource.getTenantDomain());\n+            ResourceByNameCacheKey resourceByNameCacheKey = new ResourceByNameCacheKey(resource.getResourceName(),\n+                    resource.getTenantDomain());\n+\n+            if (log.isDebugEnabled()) {\n+                String message = String.format(\"Following two cache entries created. 1. Resource by name cache %s, 2.\" +", "originalCommit": "c70031c5e8cb2626ceb434418d0c098e17c0213e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzMxNw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3227#discussion_r519477317", "bodyText": "@JKAUSHALYA Sorry. Fixed.", "author": "ivantha", "createdAt": "2020-11-08T21:08:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ2ODk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "594170c762fccc79217d5e7070a94b599f72fab0", "chunk": "diff --git a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/CachedBackedConfigurationDAO.java b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/CachedBackedConfigurationDAO.java\nindex 5f063514dfb..0654260ce5d 100644\n--- a/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/CachedBackedConfigurationDAO.java\n+++ b/components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/CachedBackedConfigurationDAO.java\n\n@@ -432,7 +432,7 @@ public class CachedBackedConfigurationDAO implements ConfigurationDAO {\n                     resource.getTenantDomain());\n \n             if (log.isDebugEnabled()) {\n-                String message = String.format(\"Following two cache entries created. 1. Resource by name cache %s, 2.\" +\n+                String message = String.format(\"Following two cache entries deleted. 1. Resource by name cache %s, 2.\" +\n                                 \" Resource by id cache %s. Tenant domain for all caches: %s\", resource.getResourceName(),\n                         resource.getResourceId(), resource.getTenantDomain());\n                 log.debug(message);\n"}}, {"oid": "594170c762fccc79217d5e7070a94b599f72fab0", "url": "https://github.com/wso2/carbon-identity-framework/commit/594170c762fccc79217d5e7070a94b599f72fab0", "message": "Configuration manager clear caching on replace operation", "committedDate": "2020-11-08T21:07:34Z", "type": "commit"}, {"oid": "594170c762fccc79217d5e7070a94b599f72fab0", "url": "https://github.com/wso2/carbon-identity-framework/commit/594170c762fccc79217d5e7070a94b599f72fab0", "message": "Configuration manager clear caching on replace operation", "committedDate": "2020-11-08T21:07:34Z", "type": "forcePushed"}]}