{"pr_number": 2735, "pr_title": "Fix expired session data cleanup", "pr_createdAt": "2020-02-10T12:59:06Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2735", "timeline": [{"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8", "url": "https://github.com/wso2/carbon-identity-framework/commit/238d308f8dbbb24e9a156e842915d3d24420c8f8", "message": "Fix expired session data cleanup\n\n- Commit session data chunk deletion per each chunk", "committedDate": "2020-02-10T12:55:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NTc2Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377065762", "bodyText": "Formatting issue", "author": "madurangasiriwardena", "createdAt": "2020-02-10T13:37:28Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java", "diffHunk": "@@ -445,26 +443,26 @@ private void removeExpiredSessionData(String sqlQuery) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                statement = connection.prepareStatement(sqlQuery);\n-                statement.setLong(1, currentTime);\n-\n-                int noOfDeletedRecords = statement.executeUpdate();\n-                deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n-                totalDeletedEntries += noOfDeletedRecords;\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Removed %d expired session records.\",\n-                            noOfDeletedRecords));\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){", "originalCommit": "238d308f8dbbb24e9a156e842915d3d24420c8f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MjM2Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377072366", "bodyText": "Fixed in a5f2647.", "author": "tharindu-bandara", "createdAt": "2020-02-10T13:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NTc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a5f2647666a6f6cd722efacc141af549d9a14496", "chunk": "diff --git a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\nindex 2af8439800c..27970ed98c5 100644\n--- a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\n+++ b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\n\n@@ -426,24 +426,15 @@ public class SessionDataStore {\n      */\n     private void removeExpiredSessionData(String sqlQuery) {\n \n-        Connection connection = null;\n-        try {\n-            connection = IdentityDatabaseUtil.getDBConnection(true);\n-        } catch (IdentityRuntimeException e) {\n-            log.error(e.getMessage(), e);\n-            return;\n-        }\n-\n         if (log.isDebugEnabled()) {\n             log.debug(\"DB query for removing expired data: \" + sqlQuery);\n         }\n-\n         long currentTime = FrameworkUtils.getCurrentStandardNano();\n-        try {\n+        try (Connection connection = IdentityDatabaseUtil.getDBConnection(true)) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)) {\n                     statement.setLong(1, currentTime);\n                     int noOfDeletedRecords = statement.executeUpdate();\n                     deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NjYxMw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377066613", "bodyText": "Let's remove the finally block and enclose the connection in a try with resource block.", "author": "madurangasiriwardena", "createdAt": "2020-02-10T13:38:59Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java", "diffHunk": "@@ -445,26 +443,26 @@ private void removeExpiredSessionData(String sqlQuery) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                statement = connection.prepareStatement(sqlQuery);\n-                statement.setLong(1, currentTime);\n-\n-                int noOfDeletedRecords = statement.executeUpdate();\n-                deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n-                totalDeletedEntries += noOfDeletedRecords;\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Removed %d expired session records.\",\n-                            noOfDeletedRecords));\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){\n+                    statement.setLong(1, currentTime);\n+                    int noOfDeletedRecords = statement.executeUpdate();\n+                    deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n+                    totalDeletedEntries += noOfDeletedRecords;\n+                    // Commit the chunk deletion.\n+                    IdentityDatabaseUtil.commitTransaction(connection);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"Removed %d expired session records.\", noOfDeletedRecords));\n+                    }\n                 }\n-                IdentityDatabaseUtil.rollbackTransaction(connection);\n             }\n             if (log.isDebugEnabled()) {\n-                log.debug(String.format(\"Deleted total of %d entries \", totalDeletedEntries));\n+                log.debug(String.format(\"Deleted total of %d entries\", totalDeletedEntries));\n             }\n         } catch (SQLException e) {\n             IdentityDatabaseUtil.rollbackTransaction(connection);\n-            log.error(\"Error while removing session data from the database for nano time \" + currentTime, e);\n+            log.error(\"Error while removing session data from the database for nano time: \" + currentTime, e);\n         } finally {\n-            IdentityDatabaseUtil.closeAllConnections(connection, null, statement);\n+            IdentityDatabaseUtil.closeAllConnections(connection, null, null);", "originalCommit": "238d308f8dbbb24e9a156e842915d3d24420c8f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MjUwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377072509", "bodyText": "Fixed in a5f2647.", "author": "tharindu-bandara", "createdAt": "2020-02-10T13:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NjYxMw=="}], "type": "inlineReview", "revised_code": {"commit": "a5f2647666a6f6cd722efacc141af549d9a14496", "chunk": "diff --git a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\nindex 2af8439800c..27970ed98c5 100644\n--- a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\n+++ b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java\n\n@@ -426,24 +426,15 @@ public class SessionDataStore {\n      */\n     private void removeExpiredSessionData(String sqlQuery) {\n \n-        Connection connection = null;\n-        try {\n-            connection = IdentityDatabaseUtil.getDBConnection(true);\n-        } catch (IdentityRuntimeException e) {\n-            log.error(e.getMessage(), e);\n-            return;\n-        }\n-\n         if (log.isDebugEnabled()) {\n             log.debug(\"DB query for removing expired data: \" + sqlQuery);\n         }\n-\n         long currentTime = FrameworkUtils.getCurrentStandardNano();\n-        try {\n+        try (Connection connection = IdentityDatabaseUtil.getDBConnection(true)) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)) {\n                     statement.setLong(1, currentTime);\n                     int noOfDeletedRecords = statement.executeUpdate();\n                     deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n"}}, {"oid": "a5f2647666a6f6cd722efacc141af549d9a14496", "url": "https://github.com/wso2/carbon-identity-framework/commit/a5f2647666a6f6cd722efacc141af549d9a14496", "message": "Use try-with-resources for database connection", "committedDate": "2020-02-10T13:46:46Z", "type": "commit"}]}