{"pr_number": 3188, "pr_title": "Redundant tenant flow initiation removed when setting permission in the scim2/Roles endpoint", "pr_createdAt": "2020-10-27T05:37:42Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3188", "timeline": [{"oid": "ebfda5c82724bb8c63d96054597beaeb819174cb", "url": "https://github.com/wso2/carbon-identity-framework/commit/ebfda5c82724bb8c63d96054597beaeb819174cb", "message": "Context user maintained for subsequent tenant flow in the scim2/Roles endpoint.", "committedDate": "2020-10-27T05:31:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Mzg3OA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3188#discussion_r512953878", "bodyText": "is the new tenant domain different from the previous one? if so we may not need to start the tenant flow here at all", "author": "pulasthi7", "createdAt": "2020-10-27T19:03:49Z", "path": "components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/dao/RoleDAOImpl.java", "diffHunk": "@@ -1081,9 +1081,11 @@ public RoleBasicInfo setPermissionsForRole(String roleID, List<String> permissio\n             return new RoleBasicInfo(roleID, roleName);\n         }\n         try {\n+            String loggedInUser = CarbonContext.getThreadLocalCarbonContext().getUsername();\n             PrivilegedCarbonContext.startTenantFlow();\n             PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n             carbonContext.setTenantDomain(tenantDomain, true);\n+            carbonContext.setUsername(loggedInUser);", "originalCommit": "ebfda5c82724bb8c63d96054597beaeb819174cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3NzUwOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3188#discussion_r513177508", "bodyText": "It could be different due to deviations of certain flows. This flow needs to be started for the required tenant to make sure these operations are carried out for the intended tenant.", "author": "ashendes", "createdAt": "2020-10-28T04:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Mzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzMDIxMw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3188#discussion_r513230213", "bodyText": "No deviations of the flow was discovered. Hence the tenant flow initiation was removed in 29de1b6", "author": "ashendes", "createdAt": "2020-10-28T07:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Mzg3OA=="}], "type": "inlineReview", "revised_code": {"commit": "29de1b6baa48638a10cab8b287ff872932450233", "chunk": "diff --git a/components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/dao/RoleDAOImpl.java b/components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/dao/RoleDAOImpl.java\nindex 6757746d62e..2cdeccdf69b 100644\n--- a/components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/dao/RoleDAOImpl.java\n+++ b/components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/dao/RoleDAOImpl.java\n\n@@ -1081,18 +1081,11 @@ public class RoleDAOImpl implements RoleDAO {\n             return new RoleBasicInfo(roleID, roleName);\n         }\n         try {\n-            String loggedInUser = CarbonContext.getThreadLocalCarbonContext().getUsername();\n-            PrivilegedCarbonContext.startTenantFlow();\n-            PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n-            carbonContext.setTenantDomain(tenantDomain, true);\n-            carbonContext.setUsername(loggedInUser);\n             getUserAdminProxy().setRoleUIPermission(roleName, permissions.toArray(new String[0]));\n             return new RoleBasicInfo(roleID, roleName);\n         } catch (UserAdminException e) {\n             throw new IdentityRoleManagementServerException(UNEXPECTED_SERVER_ERROR.getCode(),\n                     \"An error occurred when setting permissions for the role: \" + roleName, e);\n-        } finally {\n-            PrivilegedCarbonContext.endTenantFlow();\n         }\n     }\n \n"}}, {"oid": "4ba4ffd6a2ef1b19fa66c5abd37e072d31c0837e", "url": "https://github.com/wso2/carbon-identity-framework/commit/4ba4ffd6a2ef1b19fa66c5abd37e072d31c0837e", "message": "Full permission tree check added when setting all permissions by an a non super-admin user.", "committedDate": "2020-10-28T05:26:57Z", "type": "commit"}, {"oid": "29de1b6baa48638a10cab8b287ff872932450233", "url": "https://github.com/wso2/carbon-identity-framework/commit/29de1b6baa48638a10cab8b287ff872932450233", "message": "Redundant tenant flow initiation removed.", "committedDate": "2020-10-28T06:58:42Z", "type": "commit"}]}