{"pr_number": 2869, "pr_title": "Improve URL resolving logic in ConfigurationFacade", "pr_createdAt": "2020-04-11T19:11:27Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/2869", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNDg2Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r407134862", "bodyText": "There's a small concern here.\nWe should read from file only when it's not tenant url supported mode right.\nIf it's tenant url supported, context is always a path, that will be resolved to an absolute URL from the URL builder.\nIf tenant url not supported only we will have to worry about, the context read from the file is absolute or not.", "author": "malithie", "createdAt": "2020-04-12T02:17:13Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java", "diffHunk": "@@ -263,28 +266,60 @@ public int getMaxLoginAttemptCount() {\n \n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n-        String url;\n-        if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n-            url = buildTenantQualifiedUrl(defaultContext);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Building url for context: \" + defaultContext);\n+        }\n+\n+        String context = defaultContext;\n+\n+        String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n+        if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n+            // If the file based config is set, then we have to build the URL based on that.\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"URL from file based config: \" + urlFromFileBasedConfig);\n+            }\n+            context = urlFromFileBasedConfig;\n+        }\n+\n+        if (isUrlAbsolute(context)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"URL: \" + context + \" is absolute. Returning it as the resolved URL.\");\n+            }\n+            return context;", "originalCommit": "15324511c9d1afb2713abf4f41933fb9ec0b665c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAyMTkzNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r408021934", "bodyText": "Even in the tenant qualified mode, we might have a situation where a user has defined a custom path. For example: instead of authenthenticationendpoint/login.do someone could define authenthenticationendpoint/custom_login.do\nSo when the facade returns in the tenant qualified mode, we can simply return\n\\t\\<tenant_name>\\authenthenticationendpoint\\custom_login.do", "author": "mefarazath", "createdAt": "2020-04-14T10:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNDg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MjUwOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r408352508", "bodyText": "I was actually thinking that should be resolved local to the tenant.\nBut, unlike other endpoints which are defined for the server, there's a case with related to authentication endpoint web app. That is, it allows to be externalized, which can mean server wide there can be an endpoint URL configured, where your above comment applies. Mode of the offering needs to be finalized then", "author": "malithie", "createdAt": "2020-04-14T18:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNDg2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0d3677615acfd59fe8fe7aa2c655b0bc7c5dc30e", "chunk": "diff --git a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\nindex 597059f9ed7..71c29a957ef 100644\n--- a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n+++ b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n\n@@ -266,32 +266,21 @@ public class ConfigurationFacade {\n \n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n-        if (log.isDebugEnabled()) {\n-            log.debug(\"Building url for context: \" + defaultContext);\n-        }\n-\n-        String context = defaultContext;\n-\n-        String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n-        if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n-            // If the file based config is set, then we have to build the URL based on that.\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"URL from file based config: \" + urlFromFileBasedConfig);\n+        if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n+            return buildTenantQualifiedAbsoluteUrl(defaultContext);\n+        } else {\n+            String url = defaultContext;\n+            String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n+            if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n+                // If the file based config is set, then we have to build the URL based on that.\n+                url = urlFromFileBasedConfig;\n             }\n-            context = urlFromFileBasedConfig;\n-        }\n \n-        if (isUrlAbsolute(context)) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"URL: \" + context + \" is absolute. Returning it as the resolved URL.\");\n-            }\n-            return context;\n-        } else {\n-            String absoluteUrl = buildAbsoluteUrl(context);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Returning resolved absolute URL: \" + absoluteUrl);\n+            if (isUrlAbsolute(url)) {\n+                return url;\n+            } else {\n+                return IdentityUtil.getServerURL(url, false, false);\n             }\n-            return absoluteUrl;\n         }\n     }\n \n"}}, {"oid": "0d3677615acfd59fe8fe7aa2c655b0bc7c5dc30e", "url": "https://github.com/wso2/carbon-identity-framework/commit/0d3677615acfd59fe8fe7aa2c655b0bc7c5dc30e", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-15T11:19:29Z", "type": "forcePushed"}, {"oid": "0d599dc5f0f711a40f5dde89a9c0d2ceb717eb1b", "url": "https://github.com/wso2/carbon-identity-framework/commit/0d599dc5f0f711a40f5dde89a9c0d2ceb717eb1b", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-15T14:30:18Z", "type": "forcePushed"}, {"oid": "8010b0d493cc127e6d9081b906d9c8192b5b5e8b", "url": "https://github.com/wso2/carbon-identity-framework/commit/8010b0d493cc127e6d9081b906d9c8192b5b5e8b", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-20T08:17:02Z", "type": "forcePushed"}, {"oid": "6695c51811fd00989cd520b6b4195561406b17ff", "url": "https://github.com/wso2/carbon-identity-framework/commit/6695c51811fd00989cd520b6b4195561406b17ff", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-20T08:20:57Z", "type": "forcePushed"}, {"oid": "4d3aa75f857ac129e829bab94d6ab433e2114a05", "url": "https://github.com/wso2/carbon-identity-framework/commit/4d3aa75f857ac129e829bab94d6ab433e2114a05", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-20T08:29:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIzMjAwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r411232009", "bodyText": "Should we return the default context here.\nShouldn't that be a absolute public ?", "author": "malithie", "createdAt": "2020-04-20T09:30:43Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java", "diffHunk": "@@ -263,28 +263,25 @@ public int getMaxLoginAttemptCount() {\n \n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n-        String url;\n         if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n-            url = buildTenantQualifiedUrl(defaultContext);\n+            return buildAbsoluteUrl(defaultContext);\n         } else {\n-            String authenticationEndpointURLInFile = getValueFromFileBasedConfig.get();\n-            if (StringUtils.isNotBlank(authenticationEndpointURLInFile)) {\n-                // Use the value configured in the file.\n-                url = authenticationEndpointURLInFile;\n+            String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n+            if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n+                // If the file based URL is set, then we have to return the file based URL.\n+                return urlFromFileBasedConfig;\n             } else {\n-                // Use the default context.\n-                url = defaultContext;\n+                return defaultContext;", "originalCommit": "4d3aa75f857ac129e829bab94d6ab433e2114a05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2Mzc1OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r411263759", "bodyText": "Though of building the absolute public at the consumer level to avoid behaviour change for code that consumes this API in the legacy mode", "author": "mefarazath", "createdAt": "2020-04-20T10:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIzMjAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "chunk": "diff --git a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\nindex e020a88bb59..4a873aff3cb 100644\n--- a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n+++ b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n\n@@ -264,7 +264,12 @@ public class ConfigurationFacade {\n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n         if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n-            return buildAbsoluteUrl(defaultContext);\n+            try {\n+                return ServiceURLBuilder.create().addPath(defaultContext).build().getAbsolutePublicURL();\n+            } catch (URLBuilderException e) {\n+                throw new IdentityRuntimeException(\n+                        \"Error while building tenant qualified url for context: \" + defaultContext, e);\n+            }\n         } else {\n             String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n             if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIzMzEzNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/2869#discussion_r411233134", "bodyText": "I would prefer if this exception can be thrown and handled at the public API layer", "author": "malithie", "createdAt": "2020-04-20T09:32:26Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java", "diffHunk": "@@ -263,28 +263,25 @@ public int getMaxLoginAttemptCount() {\n \n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n-        String url;\n         if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n-            url = buildTenantQualifiedUrl(defaultContext);\n+            return buildAbsoluteUrl(defaultContext);\n         } else {\n-            String authenticationEndpointURLInFile = getValueFromFileBasedConfig.get();\n-            if (StringUtils.isNotBlank(authenticationEndpointURLInFile)) {\n-                // Use the value configured in the file.\n-                url = authenticationEndpointURLInFile;\n+            String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n+            if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n+                // If the file based URL is set, then we have to return the file based URL.\n+                return urlFromFileBasedConfig;\n             } else {\n-                // Use the default context.\n-                url = defaultContext;\n+                return defaultContext;\n             }\n         }\n-        return url;\n     }\n \n-    private String buildTenantQualifiedUrl(String context) {\n+    private String buildAbsoluteUrl(String context) {\n \n         try {\n             return ServiceURLBuilder.create().addPath(context).build().getAbsolutePublicURL();\n         } catch (URLBuilderException e) {\n-            throw new IdentityRuntimeException(\"Error while building url for context: \" + context);\n+            throw new IdentityRuntimeException(\"Error while building tenant qualified url for context: \" + context);", "originalCommit": "4d3aa75f857ac129e829bab94d6ab433e2114a05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "chunk": "diff --git a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\nindex e020a88bb59..4a873aff3cb 100644\n--- a/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n+++ b/components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/config/ConfigurationFacade.java\n\n@@ -264,7 +264,12 @@ public class ConfigurationFacade {\n     private String buildUrl(String defaultContext, Supplier<String> getValueFromFileBasedConfig) {\n \n         if (IdentityTenantUtil.isTenantQualifiedUrlsEnabled()) {\n-            return buildAbsoluteUrl(defaultContext);\n+            try {\n+                return ServiceURLBuilder.create().addPath(defaultContext).build().getAbsolutePublicURL();\n+            } catch (URLBuilderException e) {\n+                throw new IdentityRuntimeException(\n+                        \"Error while building tenant qualified url for context: \" + defaultContext, e);\n+            }\n         } else {\n             String urlFromFileBasedConfig = getValueFromFileBasedConfig.get();\n             if (StringUtils.isNotBlank(urlFromFileBasedConfig)) {\n"}}, {"oid": "09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "url": "https://github.com/wso2/carbon-identity-framework/commit/09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-20T17:37:15Z", "type": "commit"}, {"oid": "09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "url": "https://github.com/wso2/carbon-identity-framework/commit/09a831b7c267be6ef2cd28c6a0ce12b8568345e7", "message": "Improve ConfigurationFacade url resolving logic", "committedDate": "2020-04-20T17:37:15Z", "type": "forcePushed"}]}