{"pr_number": 1837, "pr_title": "[automation] Pass script context to script engines", "pr_createdAt": "2020-11-19T08:05:31Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1837", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1MDc2MA==", "url": "https://github.com/openhab/openhab-core/pull/1837#discussion_r527050760", "bodyText": "Is it safe to set that here? Couldn't the script engine have already set up some initial context?\nI'm especially concerned about the DSLScriptEngine, where I recently had a lot of trouble getting the handling of the context stable... Would be good if you could test that there's no issue by this on DSL rules.", "author": "kaikreuzer", "createdAt": "2020-11-19T17:04:01Z", "path": "bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/ScriptEngineManagerImpl.java", "diffHunk": "@@ -129,6 +134,11 @@ private boolean isCustomFactory(ScriptEngineFactory engineFactory) {\n                     loadedScriptEngineInstances.put(engineIdentifier, result);\n                     logger.debug(\"Added ScriptEngine for language '{}' with identifier: {}\", scriptType,\n                             engineIdentifier);\n+\n+                    SimpleScriptContext scriptContext = new SimpleScriptContext();\n+                    scriptContext.setAttribute(CONTEXT_KEY_ENGINE_IDENTIFIER, engineIdentifier, ScriptContext.ENGINE_SCOPE);\n+                    engine.setContext(scriptContext);", "originalCommit": "fed910adca46326344629e3ee2c0150a5ffb5c40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIzOTMyMA==", "url": "https://github.com/openhab/openhab-core/pull/1837#discussion_r527239320", "bodyText": "@kaikreuzer Good point; I was primarily thinking about the newer script engines which I don't believe set things up here. TBH my main goal here is passing context to script engine factories upon creation of script engines to allow them to be tailored.\nThe cleanest way to do this would be to modify the engineFactory.createScriptEngine(scriptTypes.get(0)); call eariler in the method to add a custom ScriptEngineContext object as a second argument. However I chose not to do this because it would be a breaking change for existing implementors of the interface declaring this method (of course I could also introduce a 2nd interface and collect implementations of both, but that seems overkill). Or do you think this would be a better option? If not, I'll update the code to add context to whatever is there already (and create if not present) before testing on the DSLScriptEngine.", "author": "jpg0", "createdAt": "2020-11-19T22:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1MDc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI0Nzc2Ng==", "url": "https://github.com/openhab/openhab-core/pull/1837#discussion_r527247766", "bodyText": "(Updated code to only set context if it's not already been set)", "author": "jpg0", "createdAt": "2020-11-19T22:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1MDc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIyMjQ5OA==", "url": "https://github.com/openhab/openhab-core/pull/1837#discussion_r528222498", "bodyText": "I think the current solution is fine, thanks.", "author": "kaikreuzer", "createdAt": "2020-11-21T17:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1MDc2MA=="}], "type": "inlineReview", "revised_code": {"commit": "fd261bb1410563189d8f18247a1dd513acbb8195", "chunk": "diff --git a/bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/ScriptEngineManagerImpl.java b/bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/ScriptEngineManagerImpl.java\nindex 0ab9a127b..9af1b0d3b 100644\n--- a/bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/ScriptEngineManagerImpl.java\n+++ b/bundles/org.openhab.core.automation.module.script/src/main/java/org/openhab/core/automation/module/script/internal/ScriptEngineManagerImpl.java\n\n@@ -135,10 +135,14 @@ public class ScriptEngineManagerImpl implements ScriptEngineManager {\n                     logger.debug(\"Added ScriptEngine for language '{}' with identifier: {}\", scriptType,\n                             engineIdentifier);\n \n-                    SimpleScriptContext scriptContext = new SimpleScriptContext();\n-                    scriptContext.setAttribute(CONTEXT_KEY_ENGINE_IDENTIFIER, engineIdentifier, ScriptContext.ENGINE_SCOPE);\n-                    engine.setContext(scriptContext);\n+                    ScriptContext scriptContext = engine.getContext();\n \n+                    if(scriptContext == null) {\n+                        scriptContext = new SimpleScriptContext();\n+                        engine.setContext(scriptContext);\n+                    }\n+                    \n+                    scriptContext.setAttribute(CONTEXT_KEY_ENGINE_IDENTIFIER, engineIdentifier, ScriptContext.ENGINE_SCOPE);\n                 } else {\n                     logger.error(\"ScriptEngine for language '{}' could not be created for identifier: {}\", scriptType,\n                             engineIdentifier);\n"}}, {"oid": "fd261bb1410563189d8f18247a1dd513acbb8195", "url": "https://github.com/openhab/openhab-core/commit/fd261bb1410563189d8f18247a1dd513acbb8195", "message": "Pass script context to script engines\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-11-19T22:29:37Z", "type": "forcePushed"}, {"oid": "82a286f108fda7677f320573eb7a8858b06b2bdc", "url": "https://github.com/openhab/openhab-core/commit/82a286f108fda7677f320573eb7a8858b06b2bdc", "message": "Pass script context to script engines\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-11-21T22:39:22Z", "type": "commit"}, {"oid": "82a286f108fda7677f320573eb7a8858b06b2bdc", "url": "https://github.com/openhab/openhab-core/commit/82a286f108fda7677f320573eb7a8858b06b2bdc", "message": "Pass script context to script engines\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-11-21T22:39:22Z", "type": "forcePushed"}]}