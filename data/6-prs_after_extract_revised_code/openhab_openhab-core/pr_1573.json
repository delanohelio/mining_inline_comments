{"pr_number": 1573, "pr_title": "[discovery] Added warning if 'representationProperty' is missing in keys of 'properties' map for 'DiscoveryResult'", "pr_createdAt": "2020-07-29T13:16:12Z", "pr_url": "https://github.com/openhab/openhab-core/pull/1573", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1ODA4Ng==", "url": "https://github.com/openhab/openhab-core/pull/1573#discussion_r471758086", "bodyText": "This message sounds as if the user should do something about it, but in fact you want to tell him that he just found a bug that needs to be reported, right? I think this should clearly be stated here, best by also including the stacktrace.", "author": "kaikreuzer", "createdAt": "2020-08-17T20:30:39Z", "path": "bundles/org.openhab.core.config.discovery/src/main/java/org/openhab/core/config/discovery/DiscoveryResultBuilder.java", "diffHunk": "@@ -143,6 +146,11 @@ public DiscoveryResultBuilder withTTL(long ttl) {\n      */\n     @SuppressWarnings(\"deprecation\")\n     public DiscoveryResult build() {\n+        if (representationProperty != null && !properties.containsKey(representationProperty)) {\n+            logger.warn(\n+                    \"Representation property '{}' of discovery result for thing '{}' is missing in properties map. It should be added.\",", "originalCommit": "81af1cb0be6e27fcb87ce6af267ba91b80507c2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc2NzkyMw==", "url": "https://github.com/openhab/openhab-core/pull/1573#discussion_r479767923", "bodyText": "It now looks like this:\n[main] WARN org.openhab.core.config.discovery.DiscoveryResultBuilder - Representation property 'test' of discovery result for thing 'test:test:test' is missing in properties map. It has to be fixed by the bindings developer.\n\tat java.base/java.lang.Thread.getStackTrace(Thread.java:1607)\n\tat org.openhab.core.config.discovery.DiscoveryResultBuilder$1.run(DiscoveryResultBuilder.java:166)\n\tat org.openhab.core.config.discovery.DiscoveryResultBuilder$1.run(DiscoveryResultBuilder.java:1)\n\tat java.base/java.security.AccessController.doPrivileged(Native Method)\n\tat org.openhab.core.config.discovery.DiscoveryResultBuilder.getStackTrace(DiscoveryResultBuilder.java:163)\n\tat org.openhab.core.config.discovery.DiscoveryResultBuilder.build(DiscoveryResultBuilder.java:156)\n\tat org.openhab.core.config.discovery.DiscoveryResultBuilderTest.testDiscoveryResultBuilder(DiscoveryResultBuilderTest.java:48)", "author": "cweitkamp", "createdAt": "2020-08-30T13:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1ODA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4OTc0Mw==", "url": "https://github.com/openhab/openhab-core/pull/1573#discussion_r479789743", "bodyText": "Looks good to me. \ud83d\udc4d", "author": "kaikreuzer", "createdAt": "2020-08-30T16:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1ODA4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "af3cc6d62ac2b37affb130b017c8f4d443da4dc1", "chunk": "diff --git a/bundles/org.openhab.core.config.discovery/src/main/java/org/openhab/core/config/discovery/DiscoveryResultBuilder.java b/bundles/org.openhab.core.config.discovery/src/main/java/org/openhab/core/config/discovery/DiscoveryResultBuilder.java\nindex 4f18ee31f..ac522272e 100644\n--- a/bundles/org.openhab.core.config.discovery/src/main/java/org/openhab/core/config/discovery/DiscoveryResultBuilder.java\n+++ b/bundles/org.openhab.core.config.discovery/src/main/java/org/openhab/core/config/discovery/DiscoveryResultBuilder.java\n\n@@ -148,10 +152,20 @@ public class DiscoveryResultBuilder {\n     public DiscoveryResult build() {\n         if (representationProperty != null && !properties.containsKey(representationProperty)) {\n             logger.warn(\n-                    \"Representation property '{}' of discovery result for thing '{}' is missing in properties map. It should be added.\",\n-                    representationProperty, thingUID);\n+                    \"Representation property '{}' of discovery result for thing '{}' is missing in properties map. It has to be fixed by the bindings developer.\\n{}\",\n+                    representationProperty, thingUID, getStackTrace(Thread.currentThread()));\n         }\n         return new DiscoveryResultImpl(thingTypeUID, thingUID, bridgeUID, properties, representationProperty, label,\n                 ttl);\n     }\n+\n+    private String getStackTrace(final Thread thread) {\n+        StackTraceElement[] elements = AccessController.doPrivileged(new PrivilegedAction<StackTraceElement[]>() {\n+            @Override\n+            public StackTraceElement[] run() {\n+                return thread.getStackTrace();\n+            }\n+        });\n+        return Arrays.stream(elements).map(element -> \"\\tat \" + element.toString()).collect(Collectors.joining(\"\\n\"));\n+    }\n }\n"}}, {"oid": "af3cc6d62ac2b37affb130b017c8f4d443da4dc1", "url": "https://github.com/openhab/openhab-core/commit/af3cc6d62ac2b37affb130b017c8f4d443da4dc1", "message": "Added unit test for 'DiscoveryResultBuilder'\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-08-30T13:12:32Z", "type": "forcePushed"}, {"oid": "7d2786f6925b075ee119d4862449786b79b18297", "url": "https://github.com/openhab/openhab-core/commit/7d2786f6925b075ee119d4862449786b79b18297", "message": "Added warning if representationProperty is missing in properties map\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:12:47Z", "type": "commit"}, {"oid": "a3748c966c8a4fb7e14b2b26221f5d9449d8afa8", "url": "https://github.com/openhab/openhab-core/commit/a3748c966c8a4fb7e14b2b26221f5d9449d8afa8", "message": "Changed warning and added stacktrace\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:15:46Z", "type": "commit"}, {"oid": "9c273eaad736598ae3d22dba582cd1a3faba7560", "url": "https://github.com/openhab/openhab-core/commit/9c273eaad736598ae3d22dba582cd1a3faba7560", "message": "Added unit test for 'DiscoveryResultBuilder'\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:16:44Z", "type": "commit"}, {"oid": "f122e4880025bed90883de83749e8b6a0b38a66e", "url": "https://github.com/openhab/openhab-core/commit/f122e4880025bed90883de83749e8b6a0b38a66e", "message": "Migrated tests to JUnit 5\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:40:42Z", "type": "commit"}, {"oid": "42819732ce8ab48646f03b80394a206015177d65", "url": "https://github.com/openhab/openhab-core/commit/42819732ce8ab48646f03b80394a206015177d65", "message": "Removed shell script\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:40:59Z", "type": "commit"}, {"oid": "42819732ce8ab48646f03b80394a206015177d65", "url": "https://github.com/openhab/openhab-core/commit/42819732ce8ab48646f03b80394a206015177d65", "message": "Removed shell script\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-09-03T19:40:59Z", "type": "forcePushed"}]}