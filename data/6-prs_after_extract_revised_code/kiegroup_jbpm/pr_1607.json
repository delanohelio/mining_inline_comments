{"pr_number": 1607, "pr_title": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality", "pr_createdAt": "2020-03-11T09:01:17Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1607", "timeline": [{"oid": "e11acf8c86f623ebbc9c6f7fc4c110d8cd203620", "url": "https://github.com/kiegroup/jbpm/commit/e11acf8c86f623ebbc9c6f7fc4c110d8cd203620", "message": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality\n\nremove select for CorrelationKeyInfo and adding unique index", "committedDate": "2020-03-12T08:51:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r391517287", "bodyText": "Would be probably good to correct (and retain) such a test.", "author": "MarianMacik", "createdAt": "2020-03-12T10:10:03Z", "path": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/ActivityTest.java", "diffHunk": "@@ -2148,27 +2148,24 @@ public void testBusinessRuleTaskException() throws Exception {\n     @RequirePersistence\n     @Test\n     public void testCallActivityChain() throws Exception {\n-        try {\n-            System.setProperty(\"org.jbpm.correlationkey.length\", \"70\");\n-            KieBase kbase = createKnowledgeBase(\"correlationkey/Process1.bpmn2\",\n-                    \"correlationkey/Process2.bpmn2\",\n-                    \"correlationkey/Process3.bpmn2\",\n-                    \"correlationkey/Process4.bpmn2\",\n-                    \"correlationkey/Process5.bpmn2\");\n-            ksession = createKnowledgeSession(kbase);\n-            Map<String, Object> params = new HashMap<String, Object>();        \n-            ProcessInstance processInstance = ksession.startProcess(\n-                    \"src.Process1\", params);\n-            assertProcessInstanceCompleted(processInstance);\n-            \n-            ProcessInstanceLog log = logService.findProcessInstances(\"src.Process5\").get(0);\n-            assertNotNull(log);\n-            assertNotNull(log.getCorrelationKey());\n-            assertTrue(log.getCorrelationKey().startsWith(processInstance.getId() + \":src.Process2:\"));\n-            assertTrue(log.getCorrelationKey().contains(\":src.Process4\"));\n-        } finally {\n-            System.clearProperty(\"org.jbpm.correlationkey.length\");\n-        }", "originalCommit": "e11acf8c86f623ebbc9c6f7fc4c110d8cd203620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyMzgzMQ==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r391523831", "bodyText": "it is a faulty test in my opinion due to the way of constructing the correlation key is creating keys bigger than 70.", "author": "elguardian", "createdAt": "2020-03-12T10:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MzgwNw==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r391573807", "bodyText": "Well, that is the point of the test - or should be - to check if it is trimmed in case a system property is defined.", "author": "MarianMacik", "createdAt": "2020-03-12T12:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg3OTE3MA==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r392879170", "bodyText": "it is a faulty test.\npersist correlation info: null\nProcess1\npersist correlation info: 1:src.Process2:1584350223097\nProcess2\npersist correlation info: 1:src.Process2:1584350223097:src.Process3:1584350223109\nProcess3\n2020-03-16 10:17:03,119 [main] WARN  CorrelationKey content was trimmed as it was too long (more than 70 characters)\npersist correlation info: 1:src.Process2:1584350223097:src.Process3:1584350223109:src.Process4:1\n2020-03-16 10:17:03,124 [main] WARN  CorrelationKey content was trimmed as it was too long (more than 70 characters)\nProcess4\n2020-03-16 10:17:03,130 [main] WARN  CorrelationKey content was trimmed as it was too long (more than 70 characters)\n2020-03-16 10:17:03,130 [main] WARN  CorrelationKey content was trimmed as it was too long (more than 70 characters)\npersist correlation info: 1:src.Process2:1584350223097:src.Process3:1584350223109:src.Process4:1\n2020-03-16 10:17:03,132 [main] WARN  SQL Error: 23505, SQLState: 23505\nThe trim is correct, the problem is that process 4 (already excceds the 70 positions) and process 5 generates the same as process 4 correlation key that is the reason it is  failing now when you haven an index in database.", "author": "elguardian", "createdAt": "2020-03-16T09:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg5ODU5NA==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r392898594", "bodyText": "than I guess we can limit it to for example to 100 and it should be fine, wdyt?", "author": "MarianMacik", "createdAt": "2020-03-16T09:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkwNDcwMg==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r392904702", "bodyText": "yeah I fixed the test. just to give you the bits. The test was working because another bug in\nhttps://github.com/kiegroup/jbpm/blob/master/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/JpaProcessPersistenceContext.java#L118\nthis uses this function:\nhttps://github.com/kiegroup/jbpm/blob/master/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/JpaProcessPersistenceContext.java#L142\nif you see it uses the externalForm of the correlation Key... the problem is that the external form is not being trimmed like the name\n\n  \n    \n      jbpm/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/correlation/CorrelationKeyInfo.java\n    \n    \n         Line 153\n      in\n      d7a0195\n    \n    \n    \n    \n\n        \n          \n           return CorrelationKeyXmlAdapter.marshalCorrelationKey(this); \n        \n    \n  \n\n\nso it can happen that while the name is trimmed you are looking for a key not trimmed not finding the right the right one. That is the reason is a faulty test.\nI did follow you recomendation and added the check", "author": "elguardian", "createdAt": "2020-03-16T10:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyMTY0Nw==", "url": "https://github.com/kiegroup/jbpm/pull/1607#discussion_r392921647", "bodyText": "I see... Well, the original issue was that only process instance log were affected for the reporter of the issue, so in fact CorrelationKeyInfo class change wasn't even needed in the end and was done just for consistency (which in fact wasn't consistent as you found out :) ) Good catch!", "author": "MarianMacik", "createdAt": "2020-03-16T10:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "33b927e1bdbaebaade26f4e533c7da6555789eb1", "chunk": "diff --git a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/ActivityTest.java b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/ActivityTest.java\nindex 5dbf9193f..d550811d5 100644\n--- a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/ActivityTest.java\n+++ b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/ActivityTest.java\n\n@@ -2149,22 +2149,28 @@ public class ActivityTest extends JbpmBpmn2TestCase {\n     @Test\n     public void testCallActivityChain() throws Exception {\n \n-        KieBase kbase = createKnowledgeBase(\"correlationkey/Process1.bpmn2\",\n-                                            \"correlationkey/Process2.bpmn2\",\n-                                            \"correlationkey/Process3.bpmn2\",\n-                                            \"correlationkey/Process4.bpmn2\",\n-                                            \"correlationkey/Process5.bpmn2\");\n-        ksession = createKnowledgeSession(kbase);\n-        Map<String, Object> params = new HashMap<String, Object>();\n-        ProcessInstance processInstance = ksession.startProcess(\n-                                                                \"src.Process1\", params);\n-        assertProcessInstanceCompleted(processInstance);\n-\n-        ProcessInstanceLog log = logService.findProcessInstances(\"src.Process5\").get(0);\n-        assertNotNull(log);\n-        assertNotNull(log.getCorrelationKey());\n-        assertTrue(log.getCorrelationKey().startsWith(processInstance.getId() + \":src.Process2:\"));\n-        assertTrue(log.getCorrelationKey().contains(\":src.Process4\"));\n+        try {\n+            System.setProperty(\"org.jbpm.correlationkey.length\", \"90\");\n+            KieBase kbase = createKnowledgeBase(\"correlationkey/Process1.bpmn2\",\n+                                                \"correlationkey/Process2.bpmn2\",\n+                                                \"correlationkey/Process3.bpmn2\",\n+                                                \"correlationkey/Process4.bpmn2\",\n+                                                \"correlationkey/Process5.bpmn2\");\n+            ksession = createKnowledgeSession(kbase);\n+            Map<String, Object> params = new HashMap<String, Object>();\n+            ProcessInstance processInstance = ksession.startProcess(\n+                                                                    \"src.Process1\", params);\n+            assertProcessInstanceCompleted(processInstance);\n+\n+            ProcessInstanceLog log = logService.findProcessInstances(\"src.Process5\").get(0);\n+            assertNotNull(log);\n+            assertNotNull(log.getCorrelationKey());\n+            assertTrue(log.getCorrelationKey().startsWith(processInstance.getId() + \":src.Process2:\"));\n+            assertTrue(log.getCorrelationKey().contains(\":src.Process4\"));\n+            assertTrue(log.getCorrelationKey().length() <= 90);\n+        } finally {\n+            System.clearProperty(\"org.jbpm.correlationkey.length\");\n+        }\n \n     }\n     \n"}}, {"oid": "33b927e1bdbaebaade26f4e533c7da6555789eb1", "url": "https://github.com/kiegroup/jbpm/commit/33b927e1bdbaebaade26f4e533c7da6555789eb1", "message": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality\n\nremove select for CorrelationKeyInfo and adding unique index", "committedDate": "2020-03-16T10:04:50Z", "type": "forcePushed"}, {"oid": "cd07d6605716bce3a8adc02bc87a3d1a60610106", "url": "https://github.com/kiegroup/jbpm/commit/cd07d6605716bce3a8adc02bc87a3d1a60610106", "message": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality\n\nremove select for CorrelationKeyInfo and adding unique index", "committedDate": "2020-03-16T10:09:20Z", "type": "forcePushed"}, {"oid": "4a8fc1412d8fbb416af9152ffc6bb47ccd07c1fb", "url": "https://github.com/kiegroup/jbpm/commit/4a8fc1412d8fbb416af9152ffc6bb47ccd07c1fb", "message": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality\n\nremove select for CorrelationKeyInfo and adding unique index", "committedDate": "2020-03-16T14:18:27Z", "type": "commit"}, {"oid": "4a8fc1412d8fbb416af9152ffc6bb47ccd07c1fb", "url": "https://github.com/kiegroup/jbpm/commit/4a8fc1412d8fbb416af9152ffc6bb47ccd07c1fb", "message": "[RHPAM-2789] CorrelationKeyInfo table is used even without using correlation key functionality\n\nremove select for CorrelationKeyInfo and adding unique index", "committedDate": "2020-03-16T14:18:27Z", "type": "forcePushed"}]}