{"pr_number": 1589, "pr_title": "[JBPM-9002] no catching timer for parallel task or subprocess", "pr_createdAt": "2020-02-03T14:14:45Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1589", "timeline": [{"oid": "ca6bd004065ce37a55a2c83a88164a1bd3c0ce1a", "url": "https://github.com/kiegroup/jbpm/commit/ca6bd004065ce37a55a2c83a88164a1bd3c0ce1a", "message": "[JBPM-9002] no catching timer for parallel task or subprocess", "committedDate": "2021-03-29T13:06:15Z", "type": "forcePushed"}, {"oid": "c21f24b822f36ec50a61a95ecff5a7f9a8a1691e", "url": "https://github.com/kiegroup/jbpm/commit/c21f24b822f36ec50a61a95ecff5a7f9a8a1691e", "message": "[JBPM-9002] no catching timer for parallel task or subprocess", "committedDate": "2021-03-30T07:19:43Z", "type": "forcePushed"}, {"oid": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "url": "https://github.com/kiegroup/jbpm/commit/db9d11845a3c7052d7f972ddb8e6339daca54c58", "message": "[JBPM-9002] no catching timer for parallel task or subprocess", "committedDate": "2021-03-30T14:18:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc1NDQxOA==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604754418", "bodyText": "This method is not used in the test. Perhaps you could also check in the test that there are 3 aborted items after boundary timer is triggered.", "author": "gmunozfe", "createdAt": "2021-03-31T09:48:07Z", "path": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/objects/TestWorkItemHandler.java", "diffHunk": "@@ -45,8 +49,14 @@ public WorkItem getWorkItem() {\n         }\n     }\n \n+    public List<WorkItem> getAbortedWorkItems() {", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM5MTM0OQ==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608391349", "bodyText": "added", "author": "elguardian", "createdAt": "2021-04-07T07:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc1NDQxOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc1NTM5MQ==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604755391", "bodyText": "You could also include that getAbortedWorkItems size is 3:\nassertThat(handler.getAbortedWorkItems().size()).isEqualTo(3);", "author": "gmunozfe", "createdAt": "2021-03-31T09:49:28Z", "path": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java", "diffHunk": "@@ -2148,6 +2148,29 @@ public void testTimerMultipleInstances() throws Exception {\n         assertProcessInstanceFinished(processInstance, ksession);\n     }\n \n+    @Test\n+    public void testBoundaryTimerMultipleHumanTaskInstances() throws Exception {\n+        NodeLeftCountDownProcessEventListener countDownListener = new NodeLeftCountDownProcessEventListener(\"end1\", 1);\n+        KieBase kbase = createKnowledgeBaseWithoutDumper(\"BPMN2-MultiInstanceLoopHumanTaskWithBoundaryTimer.bpmn2\");\n+\n+        ksession = createKnowledgeSession(kbase);\n+        ksession.addEventListener(countDownListener);\n+        TestWorkItemHandler handler = new TestWorkItemHandler();\n+\n+        ksession.getWorkItemManager().registerWorkItemHandler(\"Human Task\", handler);\n+        ProcessInstance processInstance = ksession.startProcess(\"simple.parallel\");\n+        processInstance.getId();\n+        assertProcessInstanceActive(processInstance);\n+\n+        countDownListener.waitTillCompleted(5000L);\n+\n+        List<WorkItem> workItems = handler.getWorkItems();\n+        assertThat(workItems).isNotNull();\n+        assertThat(workItems.size()).isEqualTo(3);", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM5MTI0NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608391245", "bodyText": "done", "author": "elguardian", "createdAt": "2021-04-07T07:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc1NTM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc0dff68f67a991aa2cce0c12c2290d016a49c53", "chunk": "diff --git a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\nindex 0f8fc8e3f..ca8204f3e 100644\n--- a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\n+++ b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\n\n@@ -2159,7 +2159,6 @@ public class IntermediateEventTest extends JbpmBpmn2TestCase {\n \n         ksession.getWorkItemManager().registerWorkItemHandler(\"Human Task\", handler);\n         ProcessInstance processInstance = ksession.startProcess(\"simple.parallel\");\n-        processInstance.getId();\n         assertProcessInstanceActive(processInstance);\n \n         countDownListener.waitTillCompleted(5000L);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc3NzAzMg==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604777032", "bodyText": "It could also be added the invocation to abort the workitem:\nmanager.abortWorkItem(workItem.getId());", "author": "gmunozfe", "createdAt": "2021-03-31T10:22:38Z", "path": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/objects/TestWorkItemHandler.java", "diffHunk": "@@ -19,17 +19,21 @@\n import java.util.ArrayList;\n import java.util.List;\n \n-import org.kie.api.runtime.process.*;\n+import org.kie.api.runtime.process.WorkItem;\n+import org.kie.api.runtime.process.WorkItemHandler;\n+import org.kie.api.runtime.process.WorkItemManager;\n \n public class TestWorkItemHandler implements WorkItemHandler {\n \n-    private List<WorkItem> workItems = new ArrayList<WorkItem>();\n+    private List<WorkItem> workItems = new ArrayList<>();\n+    private List<WorkItem> abortedWorkItems = new ArrayList<>();\n \n     public void executeWorkItem(WorkItem workItem, WorkItemManager manager) {\n         workItems.add(workItem);\n     }\n \n     public void abortWorkItem(WorkItem workItem, WorkItemManager manager) {\n+        abortedWorkItems.add(workItem);", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDgwNzA1MA==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604807050", "bodyText": "If all instances are really aborted, then the workItem node is finished and the flow continues also executing by this branch (in fact, there are 2 flows: boundary and workitem output)", "author": "gmunozfe", "createdAt": "2021-03-31T11:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc3NzAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM5MTAxNw==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608391017", "bodyText": "if you do this you won't interrupt that flow but keep it. it means abort and complete work item has the same effect to go on with the flow. it works like that.", "author": "elguardian", "createdAt": "2021-04-07T07:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc3NzAzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4NjkwNw==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604786907", "bodyText": "this line seems useless, it can be removed", "author": "gmunozfe", "createdAt": "2021-03-31T10:39:07Z", "path": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java", "diffHunk": "@@ -2148,6 +2148,29 @@ public void testTimerMultipleInstances() throws Exception {\n         assertProcessInstanceFinished(processInstance, ksession);\n     }\n \n+    @Test\n+    public void testBoundaryTimerMultipleHumanTaskInstances() throws Exception {\n+        NodeLeftCountDownProcessEventListener countDownListener = new NodeLeftCountDownProcessEventListener(\"end1\", 1);\n+        KieBase kbase = createKnowledgeBaseWithoutDumper(\"BPMN2-MultiInstanceLoopHumanTaskWithBoundaryTimer.bpmn2\");\n+\n+        ksession = createKnowledgeSession(kbase);\n+        ksession.addEventListener(countDownListener);\n+        TestWorkItemHandler handler = new TestWorkItemHandler();\n+\n+        ksession.getWorkItemManager().registerWorkItemHandler(\"Human Task\", handler);\n+        ProcessInstance processInstance = ksession.startProcess(\"simple.parallel\");\n+        processInstance.getId();", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM4MzA0NA==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608383044", "bodyText": "removed", "author": "elguardian", "createdAt": "2021-04-07T06:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4NjkwNw=="}], "type": "inlineReview", "revised_code": {"commit": "dc0dff68f67a991aa2cce0c12c2290d016a49c53", "chunk": "diff --git a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\nindex 0f8fc8e3f..ca8204f3e 100644\n--- a/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\n+++ b/jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/IntermediateEventTest.java\n\n@@ -2159,7 +2159,6 @@ public class IntermediateEventTest extends JbpmBpmn2TestCase {\n \n         ksession.getWorkItemManager().registerWorkItemHandler(\"Human Task\", handler);\n         ProcessInstance processInstance = ksession.startProcess(\"simple.parallel\");\n-        processInstance.getId();\n         assertProcessInstanceActive(processInstance);\n \n         countDownListener.waitTillCompleted(5000L);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4ODU2MA==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604788560", "bodyText": "this method is not used at all, though it can be useful for future use, you can keep it", "author": "gmunozfe", "createdAt": "2021-03-31T10:41:57Z", "path": "jbpm-test-util/src/main/java/org/jbpm/test/listener/process/DefaultCountDownProcessEventListener.java", "diffHunk": "@@ -51,6 +51,9 @@ public void waitTillCompleted() {\n         }\n     }\n \n+    public long count() {", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM4Mjk1MQ==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608382951", "bodyText": "sure", "author": "elguardian", "createdAt": "2021-04-07T06:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4ODU2MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4OTA5OQ==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r604789099", "bodyText": "remove this blank line and add it at the end of the method (nitpicking)", "author": "gmunozfe", "createdAt": "2021-03-31T10:42:54Z", "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/ForEachNodeInstance.java", "diffHunk": "@@ -94,6 +94,16 @@ public ContextContainer getContextContainer() {\n         return getForEachNode().getCompositeNode();\n     }\n \n+    @Override\n+    public void triggerCompleted() {\n+", "originalCommit": "db9d11845a3c7052d7f972ddb8e6339daca54c58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM4NDkzOA==", "url": "https://github.com/kiegroup/jbpm/pull/1589#discussion_r608384938", "bodyText": "removed the change.", "author": "elguardian", "createdAt": "2021-04-07T06:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4OTA5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc0dff68f67a991aa2cce0c12c2290d016a49c53", "chunk": "diff --git a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/ForEachNodeInstance.java b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/ForEachNodeInstance.java\nindex 61a221511..572cdf5f2 100644\n--- a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/ForEachNodeInstance.java\n+++ b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/ForEachNodeInstance.java\n\n@@ -94,16 +94,6 @@ public class ForEachNodeInstance extends CompositeContextNodeInstance {\n         return getForEachNode().getCompositeNode();\n     }\n \n-    @Override\n-    public void triggerCompleted() {\n-\n-        super.triggerCompleted();\n-    }\n-    @Override\n-    public void cancel(CancelType cancelType) {\n-        super.cancel(cancelType);\n-    }\n-\n     private Collection<?> evaluateCollectionExpression(String collectionExpression) {\n         Object collection;\n         VariableScopeInstance variableScopeInstance = (VariableScopeInstance)\n"}}, {"oid": "dc0dff68f67a991aa2cce0c12c2290d016a49c53", "url": "https://github.com/kiegroup/jbpm/commit/dc0dff68f67a991aa2cce0c12c2290d016a49c53", "message": "[JBPM-9002] no catching timer for parallel task or subprocess", "committedDate": "2021-04-07T07:05:55Z", "type": "commit"}, {"oid": "dc0dff68f67a991aa2cce0c12c2290d016a49c53", "url": "https://github.com/kiegroup/jbpm/commit/dc0dff68f67a991aa2cce0c12c2290d016a49c53", "message": "[JBPM-9002] no catching timer for parallel task or subprocess", "committedDate": "2021-04-07T07:05:55Z", "type": "forcePushed"}]}