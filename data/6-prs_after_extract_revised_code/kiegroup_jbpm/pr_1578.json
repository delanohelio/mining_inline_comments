{"pr_number": 1578, "pr_title": "[JBPM-8896] NPE during Process Migration when Boundary Timer is fired but UserTask not completed", "pr_createdAt": "2020-01-08T08:37:19Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1578", "timeline": [{"oid": "4e3295bd1e814894cc3f8ca73b0320c5629ec29d", "url": "https://github.com/kiegroup/jbpm/commit/4e3295bd1e814894cc3f8ca73b0320c5629ec29d", "message": "[JBPM-8896] NPE during Process Migration when Boundary Timer is fired but UserTask not completed", "committedDate": "2020-01-09T08:52:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw==", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r364852117", "bodyText": "Is the casting to DefaultTimerJobInstance needed? For example, replacing defaultTimerInstance in the next line by\n((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance()\nyou wouldn't need this variable.", "author": "gmunozfe", "createdAt": "2020-01-09T16:55:09Z", "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java", "diffHunk": "@@ -345,9 +347,20 @@ private void triggerTimer(TimerInstance timerInstance) {\n         for (Map.Entry<Timer, DroolsAction> entry : getEventBasedNode().getTimers().entrySet()) {\n             if (entry.getKey().getId() == timerInstance.getTimerId()) {\n                 executeAction((Action) entry.getValue().getMetaData(\"Action\"));\n+\n+                // self remove timer instance from this node as it will remove itself \n+                // from timer service once is triggered and there is no next\n+                if (!(timerInstance.getJobHandle() instanceof DefaultJobHandle)) {\n+                    return;\n+                }\n+                DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();", "originalCommit": "4e3295bd1e814894cc3f8ca73b0320c5629ec29d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwNzEyMQ==", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r365107121", "bodyText": "yes it is needed JobHandle does not have method getTimerJobInstance", "author": "elguardian", "createdAt": "2020-01-10T07:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc1NjIyMw==", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r365756223", "bodyText": "I mean TimerJobInstance interface already has getTrigger method, so there's no need to cast to DefaultTimerJobInstance, if you don't create an intermediate object (but it's not important, just nitpicking)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();\n          \n          \n            \n                            if (((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance().getTrigger().hasNextFireTime() == null) {", "author": "gmunozfe", "createdAt": "2020-01-13T11:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw=="}], "type": "inlineReview", "revised_code": {"commit": "72cd10d3f40e1b9a7bf3fac49a7a806afdd222c6", "chunk": "diff --git a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java\nindex 739ce43dd..0e76a25f5 100644\n--- a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java\n+++ b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java\n\n@@ -353,7 +353,7 @@ public abstract class StateBasedNodeInstance extends ExtendedNodeInstanceImpl im\n                 if (!(timerInstance.getJobHandle() instanceof DefaultJobHandle)) {\n                     return;\n                 }\n-                DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();\n+                TimerJobInstance defaultTimerInstance = ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();\n                 if (defaultTimerInstance.getTrigger().hasNextFireTime() == null) {\n                     timerInstances.remove(timerInstance.getId());\n                 }\n"}}, {"oid": "72cd10d3f40e1b9a7bf3fac49a7a806afdd222c6", "url": "https://github.com/kiegroup/jbpm/commit/72cd10d3f40e1b9a7bf3fac49a7a806afdd222c6", "message": "[JBPM-8896] NPE during Process Migration when Boundary Timer is fired but UserTask not completed", "committedDate": "2020-01-13T13:16:43Z", "type": "forcePushed"}, {"oid": "2dd4b6dcee241060cc737c83a3fd753ce3ce9cbc", "url": "https://github.com/kiegroup/jbpm/commit/2dd4b6dcee241060cc737c83a3fd753ce3ce9cbc", "message": "[JBPM-8896] Add tests", "committedDate": "2020-01-16T07:21:52Z", "type": "commit"}, {"oid": "5e197eab83e3c586b0e1a05fcfa0dcf7a4103ca4", "url": "https://github.com/kiegroup/jbpm/commit/5e197eab83e3c586b0e1a05fcfa0dcf7a4103ca4", "message": "[JBPM-8896] NPE during Process Migration when Boundary Timer is fired but UserTask not completed", "committedDate": "2020-01-16T07:21:53Z", "type": "commit"}, {"oid": "db77d475bff152cce6e6ce7fb9427d3ea20d5525", "url": "https://github.com/kiegroup/jbpm/commit/db77d475bff152cce6e6ce7fb9427d3ea20d5525", "message": "[JBPM-8896] fixing quartz job handle not being registered when scheduled", "committedDate": "2020-01-16T10:06:05Z", "type": "commit"}, {"oid": "db77d475bff152cce6e6ce7fb9427d3ea20d5525", "url": "https://github.com/kiegroup/jbpm/commit/db77d475bff152cce6e6ce7fb9427d3ea20d5525", "message": "[JBPM-8896] fixing quartz job handle not being registered when scheduled", "committedDate": "2020-01-16T10:06:05Z", "type": "forcePushed"}]}