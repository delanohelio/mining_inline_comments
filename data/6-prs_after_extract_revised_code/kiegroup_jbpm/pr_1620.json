{"pr_number": 1620, "pr_title": "[RHPAM-2839] Event Sub-process with timer start node fire if an intermediate timer from process is triggered", "pr_createdAt": "2020-03-27T07:27:18Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1620", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyNjM4Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1620#discussion_r400326386", "bodyText": "May getTimerInstances return null and this line throws a NPE?", "author": "gmunozfe", "createdAt": "2020-03-30T16:26:39Z", "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/EventSubProcessNodeInstance.java", "diffHunk": "@@ -54,14 +56,22 @@ public void signalEvent(String type, Object event) {\n             // start it only if it was not already started - meaning there are node instances\n             if (this.getNodeInstances().isEmpty()) {\n                 StartNode startNode = getCompositeNode().findStartNode();\n-                if (resolveVariables(((EventSubProcessNode) getEventBasedNode()).getEvents()).contains(type) || type.equals(\"timerTriggered\")) {\n+                if (resolveVariables(((EventSubProcessNode) getEventBasedNode()).getEvents()).contains(type) || containsTimerEvent(type, event)) {\n                     NodeInstance nodeInstance = getNodeInstance(startNode);\n                     ((StartNodeInstance) nodeInstance).signalEvent(type, event);\n                 }\n             }\n         }\n         super.signalEvent(type, event);\n     }\n+\n+    private boolean containsTimerEvent(String type, Object event) {\n+        if (!type.equals(\"timerTriggered\") || !(event instanceof TimerInstance)) {\n+            return false;\n+        }\n+        TimerInstance timerInstance = (TimerInstance) event;\n+        return getTimerInstances().contains(timerInstance.getId());", "originalCommit": "d5169d531ebf684c8d52035716be5986c8d39100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4NjE3Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1620#discussion_r401386176", "bodyText": "u r right. good catch", "author": "elguardian", "createdAt": "2020-04-01T06:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyNjM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6f30b24b99c5f1507aa82d014addd6664c889b61", "chunk": "diff --git a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/EventSubProcessNodeInstance.java b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/EventSubProcessNodeInstance.java\nindex 83cd1594b..0aa1be658 100644\n--- a/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/EventSubProcessNodeInstance.java\n+++ b/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/EventSubProcessNodeInstance.java\n\n@@ -70,7 +70,8 @@ public class EventSubProcessNodeInstance extends CompositeContextNodeInstance {\n             return false;\n         }\n         TimerInstance timerInstance = (TimerInstance) event;\n-        return getTimerInstances().contains(timerInstance.getId());\n+        List<Long> timersRegisteredInNodeInstance = getTimerInstances();\n+        return (timersRegisteredInNodeInstance != null) ? timersRegisteredInNodeInstance.contains(timerInstance.getId()) : false;\n     }\n     \n     @Override\n"}}, {"oid": "6f30b24b99c5f1507aa82d014addd6664c889b61", "url": "https://github.com/kiegroup/jbpm/commit/6f30b24b99c5f1507aa82d014addd6664c889b61", "message": "[RHPAM-2839] Event Sub-process with timer start node fire if an intermediate timer from process is triggered\n\ndiscrimate wheter the timer is triggered for subprocess or not", "committedDate": "2020-04-01T06:36:11Z", "type": "forcePushed"}, {"oid": "f658a1ccfb13161c24b9056b36abcccceb036412", "url": "https://github.com/kiegroup/jbpm/commit/f658a1ccfb13161c24b9056b36abcccceb036412", "message": "[RHPAM-2839] Event Sub-process with timer start node fire if an intermediate timer from process is triggered\n\ndiscrimate wheter the timer is triggered for subprocess or not", "committedDate": "2020-04-02T06:23:48Z", "type": "commit"}, {"oid": "f658a1ccfb13161c24b9056b36abcccceb036412", "url": "https://github.com/kiegroup/jbpm/commit/f658a1ccfb13161c24b9056b36abcccceb036412", "message": "[RHPAM-2839] Event Sub-process with timer start node fire if an intermediate timer from process is triggered\n\ndiscrimate wheter the timer is triggered for subprocess or not", "committedDate": "2020-04-02T06:23:48Z", "type": "forcePushed"}]}