{"pr_number": 1705, "pr_title": "ProcessInstanceInfo set start date when constructed", "pr_createdAt": "2020-07-22T04:44:44Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1705", "timeline": [{"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5", "url": "https://github.com/kiegroup/jbpm/commit/5971786f7797b13509cb9d4a92050acfb23d59f5", "message": "ProcessInstanceInfo set start date when constructed\n\nIn the `PrometheusProcessEventListener`, the field `startDate` from a `processInstance` is used to time the process instance duration metric.\nhttps://github.com/kiegroup/droolsjbpm-integration/blob/4fb9e4c239dfc21ea99ea5b701877cafeafcbe1d/kie-server-parent/kie-server-services/kie-server-services-prometheus/src/main/java/org/kie/server/services/prometheus/PrometheusProcessEventListener.java#L96\n\nHowever, the start date was always null because it is being set when `getProcessInstance` is first called.\nSince `getProcessInstance` is not called before we trigger the event listener, the start date was never set.\nThe `ProcessInstance` start date should be set when the `ProcessInstanceInfo` object is first created.", "committedDate": "2020-07-22T04:40:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2ODA5MQ==", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461168091", "bodyText": "Remove this unused import", "author": "gmunozfe", "createdAt": "2020-07-27T21:02:45Z", "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -55,6 +55,7 @@\n import org.jbpm.marshalling.impl.ProtobufRuleFlowProcessInstanceMarshaller;\n import org.jbpm.persistence.api.PersistentProcessInstance;\n import org.jbpm.process.instance.impl.ProcessInstanceImpl;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;", "originalCommit": "5971786f7797b13509cb9d4a92050acfb23d59f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI2NjQ0NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461266445", "bodyText": "I found that import org.drools.persistence.api.Transformable; was unused as well and removed it", "author": "hmatt1", "createdAt": "2020-07-28T01:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2ODA5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "2d6d719fde19a5564100d72a948274785e34b152", "chunk": "diff --git a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\nindex b246dcadc..c7d0e02a0 100644\n--- a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n+++ b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n\n@@ -48,14 +48,12 @@ import org.drools.core.marshalling.impl.MarshallerWriteContext;\n import org.drools.core.marshalling.impl.PersisterHelper;\n import org.drools.core.marshalling.impl.ProcessMarshallerWriteContext;\n import org.drools.core.marshalling.impl.ProtobufMarshaller;\n-import org.drools.persistence.api.Transformable;\n import org.jbpm.marshalling.impl.JBPMMessages;\n import org.jbpm.marshalling.impl.ProcessInstanceMarshaller;\n import org.jbpm.marshalling.impl.ProcessMarshallerRegistry;\n import org.jbpm.marshalling.impl.ProtobufRuleFlowProcessInstanceMarshaller;\n import org.jbpm.persistence.api.PersistentProcessInstance;\n import org.jbpm.process.instance.impl.ProcessInstanceImpl;\n-import org.jbpm.workflow.instance.WorkflowProcessInstance;\n import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n import org.kie.api.runtime.Environment;\n import org.kie.api.runtime.process.ProcessInstance;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5OTkyNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461199925", "bodyText": "You can remove this check, as it will always be true (notice that a null pointer exception will be thrown 2 lines above if processInstance were null)", "author": "gmunozfe", "createdAt": "2020-07-27T22:11:31Z", "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -103,6 +104,16 @@ public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n         startDate = new Date();\n+\n+        // If we are creating a second Process Instance Info for the same process instance,\n+        // it should not generate a new start date\n+        if (this.processInstance != null) {", "originalCommit": "5971786f7797b13509cb9d4a92050acfb23d59f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2d6d719fde19a5564100d72a948274785e34b152", "chunk": "diff --git a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\nindex b246dcadc..c7d0e02a0 100644\n--- a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n+++ b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n\n@@ -103,16 +101,12 @@ public class ProcessInstanceInfo implements PersistentProcessInstance {\n     public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n-        startDate = new Date();\n \n-        // If we are creating a second Process Instance Info for the same process instance,\n-        // it should not generate a new start date\n-        if (this.processInstance != null) {\n-            if (((WorkflowProcessInstanceImpl) this.processInstance).getStartDate() == null) {\n-                ((WorkflowProcessInstanceImpl) processInstance).internalSetStartDate(this.startDate);\n-            } else {\n-                startDate = ((WorkflowProcessInstanceImpl) this.processInstance).getStartDate();\n-            }\n+        if (((WorkflowProcessInstanceImpl) this.processInstance).getStartDate() == null) {\n+            startDate = new Date();\n+            ((WorkflowProcessInstanceImpl) processInstance).internalSetStartDate(this.startDate);\n+        } else {\n+            startDate = ((WorkflowProcessInstanceImpl) this.processInstance).getStartDate();\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjcxNQ==", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461206715", "bodyText": "You can move this line inside the first condition, for clarity and not overwriting when getStartDate is not null", "author": "gmunozfe", "createdAt": "2020-07-27T22:29:09Z", "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -103,6 +104,16 @@ public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n         startDate = new Date();", "originalCommit": "5971786f7797b13509cb9d4a92050acfb23d59f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2d6d719fde19a5564100d72a948274785e34b152", "chunk": "diff --git a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\nindex b246dcadc..c7d0e02a0 100644\n--- a/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n+++ b/jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java\n\n@@ -103,16 +101,12 @@ public class ProcessInstanceInfo implements PersistentProcessInstance {\n     public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n-        startDate = new Date();\n \n-        // If we are creating a second Process Instance Info for the same process instance,\n-        // it should not generate a new start date\n-        if (this.processInstance != null) {\n-            if (((WorkflowProcessInstanceImpl) this.processInstance).getStartDate() == null) {\n-                ((WorkflowProcessInstanceImpl) processInstance).internalSetStartDate(this.startDate);\n-            } else {\n-                startDate = ((WorkflowProcessInstanceImpl) this.processInstance).getStartDate();\n-            }\n+        if (((WorkflowProcessInstanceImpl) this.processInstance).getStartDate() == null) {\n+            startDate = new Date();\n+            ((WorkflowProcessInstanceImpl) processInstance).internalSetStartDate(this.startDate);\n+        } else {\n+            startDate = ((WorkflowProcessInstanceImpl) this.processInstance).getStartDate();\n         }\n     }\n \n"}}, {"oid": "2d6d719fde19a5564100d72a948274785e34b152", "url": "https://github.com/kiegroup/jbpm/commit/2d6d719fde19a5564100d72a948274785e34b152", "message": "twoProcessInstanceInfoSameStartDateTest\n\nThe twoProcessInstanceInfoSameStartDateTest was added along with other\nminor changes based on review comments", "committedDate": "2020-07-28T01:30:37Z", "type": "commit"}, {"oid": "fcd66559913a4d133a900e8369d64e91d6f4e258", "url": "https://github.com/kiegroup/jbpm/commit/fcd66559913a4d133a900e8369d64e91d6f4e258", "message": "Using this.startDate consistently", "committedDate": "2020-07-28T01:36:40Z", "type": "commit"}, {"oid": "fdcc0d9d06341b98df7ab90a92dbb5f4df2526fa", "url": "https://github.com/kiegroup/jbpm/commit/fdcc0d9d06341b98df7ab90a92dbb5f4df2526fa", "message": "Revert \"Using this.startDate consistently\"\n\nThis reverts commit fcd66559913a4d133a900e8369d64e91d6f4e258.", "committedDate": "2020-07-31T04:50:03Z", "type": "commit"}, {"oid": "e100dbb9366a62da6e06f48900611e18bdddbe64", "url": "https://github.com/kiegroup/jbpm/commit/e100dbb9366a62da6e06f48900611e18bdddbe64", "message": "Revert \"twoProcessInstanceInfoSameStartDateTest\"\n\nThis reverts commit 2d6d719fde19a5564100d72a948274785e34b152.", "committedDate": "2020-07-31T04:50:10Z", "type": "commit"}, {"oid": "b12f8880d975bf366a0dd020c7eb36295a090572", "url": "https://github.com/kiegroup/jbpm/commit/b12f8880d975bf366a0dd020c7eb36295a090572", "message": "Revert \"ProcessInstanceInfo set start date when constructed\"\n\nThis reverts commit 5971786f7797b13509cb9d4a92050acfb23d59f5.", "committedDate": "2020-07-31T04:50:25Z", "type": "commit"}, {"oid": "dccf21bb85757512972ff5ae637ac984a49e268f", "url": "https://github.com/kiegroup/jbpm/commit/dccf21bb85757512972ff5ae637ac984a49e268f", "message": "Set startDate in WorkflowProcessInstanceImpl\n\nSet the start date when `start()` is called", "committedDate": "2020-07-31T05:06:22Z", "type": "commit"}]}