{"pr_number": 705, "pr_title": "JENA-1854: Fuseki to consume the whole request body when errors occur.", "pr_createdAt": "2020-03-09T14:53:10Z", "pr_url": "https://github.com/apache/jena/pull/705", "timeline": [{"oid": "bba50c8f9127a89712a5665666805ba3daee08b7", "url": "https://github.com/apache/jena/commit/bba50c8f9127a89712a5665666805ba3daee08b7", "message": "Minor fixes and comments", "committedDate": "2020-03-06T16:35:47Z", "type": "commit"}, {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60", "url": "https://github.com/apache/jena/commit/f9a4909e0fde4c90dc5307063f3632ed05cfda60", "message": "JENA-1854: Ensure body is read completely when Content-Length is set", "committedDate": "2020-03-09T13:38:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzI3NQ==", "url": "https://github.com/apache/jena/pull/705#discussion_r389933275", "bodyText": "The buffer here appears to start null/uninitialized. Then on the first call to this method it is created, then populated with whatever we have in the stream. But it's never used again I think.\nCouldn't we define it as a local variable in the skipToEnd method, and just leave it to be collected when the method is done, or = null it?", "author": "kinow", "createdAt": "2020-03-09T20:10:09Z", "path": "jena-base/src/main/java/org/apache/jena/atlas/io/IO.java", "diffHunk": "@@ -437,4 +437,22 @@ public FileVisitResult postVisitDirectory(Path dir, IOException e) throws IOExce\n         }\n         catch (IOException ex) { IO.exception(ex); return; }\n     }\n+\n+    // Do nothing buffer.  Never read from this, it may be corrupt because it is shared.\n+    private static int SKIP_BUFFER_LEN = 64*1024;\n+    private static byte[] SKIP_BUFFER = null;\n+    /** Skip to the end of the InputStream, discarding input. */\n+    public static void skipToEnd(InputStream input) {\n+        if ( SKIP_BUFFER == null )\n+            // No harm in concurrent assignment.\n+            SKIP_BUFFER = new byte[SKIP_BUFFER_LEN];", "originalCommit": "f9a4909e0fde4c90dc5307063f3632ed05cfda60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxNzQxMQ==", "url": "https://github.com/apache/jena/pull/705#discussion_r390317411", "bodyText": "I think @afs's goal here is to minimise extra memory usage by having a shared buffer that we can just dump the unread data out into potentially by many threads at once.  We're never going to read the data back out so it doesn't matter if many threads are dumping unusable data into it at once.\nIf you had a local variable then you'd have a buffer by thread and a potential DoS vector because a malicious client could send a load of malformed request bodies in order to get Fuseki to run up its memory usage and OOM.", "author": "rvesse", "createdAt": "2020-03-10T13:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyMzI3OA==", "url": "https://github.com/apache/jena/pull/705#discussion_r390323278", "bodyText": "Yes, as @rvesse says, the buffer is a \"/dev/null\".\nI copied the pattern from CommonsIO:IOUtils.skip with a bigger buffer. This also explains why InputStream.skip can't be used.\nWe could allocate a local and null it. Allocation does initialize each time. May be a bit of over engineering!", "author": "afs", "createdAt": "2020-03-10T13:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzI3NQ=="}], "type": "inlineReview", "revised_code": null}]}