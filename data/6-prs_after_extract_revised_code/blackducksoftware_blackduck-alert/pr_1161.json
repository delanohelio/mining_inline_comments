{"pr_number": 1161, "pr_title": "Fixing NPE issue when trying to create work items while the Azure global config is missing.", "pr_createdAt": "2020-09-08T21:08:01Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161", "timeline": [{"oid": "b30ab0ad4afa5797bf1dcfba09db365555ea12d1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/b30ab0ad4afa5797bf1dcfba09db365555ea12d1", "message": "Fix: Validate the Azure properties before attempting to create an issue in order to avoid a NPE when the global configuration is missing.", "committedDate": "2020-09-08T21:05:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485197371", "bodyText": "Im not sure if this covers the TODO on line 72 for validating the configuration. Was there more to be validated once the connection is established?", "author": "jamesrichard91", "createdAt": "2020-09-08T21:09:04Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsRequestDelegator.java", "diffHunk": "@@ -63,6 +63,7 @@ public AzureBoardsRequestDelegator(Gson gson, ProxyManager proxyManager, AzureBo\n     public IssueTrackerResponse sendRequests(List<IssueTrackerRequest> requests) throws IntegrationException {\n         IssueConfig azureIssueConfig = context.getIssueConfig();\n         AzureBoardsProperties azureBoardsProperties = context.getIssueTrackerConfig();\n+        azureBoardsProperties.validateProperties();", "originalCommit": "b30ab0ad4afa5797bf1dcfba09db365555ea12d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1OTAxNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485559015", "bodyText": "I think your code handles the TODO. The only other problem I foresee is having the wrong scopes.", "author": "gkillough", "createdAt": "2020-09-09T12:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2MDA1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485560055", "bodyText": "I guess we might probably want to validate the connection by performing a HEAD request to some endpoint like projects.", "author": "gkillough", "createdAt": "2020-09-09T12:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2NjgwNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485566807", "bodyText": "Your code handles the TODO.  Yes if the application is configured with different scopes than we expect then that will cause a failure.", "author": "psantos1113", "createdAt": "2020-09-09T12:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzODQ3OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485638478", "bodyText": "Ya I am only validating the user provided configuration, I am not testing the connection to Azure. Is that something we want to add? If it is I will adjust the TODO statement accordingly", "author": "jamesrichard91", "createdAt": "2020-09-09T14:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0MDkzOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485640938", "bodyText": "I think if we start running into issues with scopes not matching up then we will need to make it configurable in the future.  I think for now we can remove the TODO since you handle the user provided fields.", "author": "psantos1113", "createdAt": "2020-09-09T14:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzM3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3717fa235a839de0f556c4bacc291542c7dc85bc", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsRequestDelegator.java b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsRequestDelegator.java\nindex 3c009009e..a69cb3858 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsRequestDelegator.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsRequestDelegator.java\n\n@@ -69,8 +69,6 @@ public class AzureBoardsRequestDelegator {\n         Credential oAuthCredential = retrieveOAuthCredential(azureBoardsProperties, httpTransport);\n         AzureHttpService azureHttpService = AzureHttpServiceFactory.withCredential(httpTransport, oAuthCredential, gson);\n \n-        // TODO validate configuration\n-\n         AzureProjectService azureProjectService = new AzureProjectService(azureHttpService);\n         AzureProcessService azureProcessService = new AzureProcessService(azureHttpService);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMDExOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485200118", "bodyText": "The oauthUserId doesn't get populated until the authentication with Azure occurs, right?", "author": "jamesrichard91", "createdAt": "2020-09-08T21:15:07Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsProperties.java", "diffHunk": "@@ -108,6 +110,15 @@ public String getOauthUserId() {\n         return scopes;\n     }\n \n+    public void validateProperties() throws AlertConfigurationException {\n+        if (StringUtils.isBlank(organizationName) || StringUtils.isBlank(clientId) || StringUtils.isBlank(clientSecret)) {\n+            throw new AlertConfigurationException(\"The global configuration for Azure is missing required information.\");\n+        }\n+        if (StringUtils.isBlank(oauthUserId)) {", "originalCommit": "b30ab0ad4afa5797bf1dcfba09db365555ea12d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2NjAzNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485566036", "bodyText": "The oauthUserId get's populated when fromFieldAccessor is called.  We don't know the user when performing the handshake so we are always using the value of DEFAULT_AZURE_OAUTH_USER_ID constant.  Are you seeing it have a value other than the default?", "author": "psantos1113", "createdAt": "2020-09-09T12:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMDExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYzNzQ1Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485637452", "bodyText": "Ok. I didn't realize that we were setting a default value for that field. I thought it would only get populated if the User has pressed the \"Authenticate\" button in  the Azure configuration. I assumed it would be blank if the User filled in the fields and only pressed save not authenticate.\nIf this field is always going to have a value then should I remove this part of the validation?", "author": "jamesrichard91", "createdAt": "2020-09-09T14:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMDExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0MzUwNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1161#discussion_r485643507", "bodyText": "yes I would remove it.  The documentation has an example where the email address is passed in via the state query parameter.  We don't capture the user email in the global configuration from the UI to be able to include it in the state query parameter.  Since we have only one configuration for Azure boards our default key is sufficient for now.  If we started having multiple Azure boards tokens then we would need unique keys.", "author": "psantos1113", "createdAt": "2020-09-09T14:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMDExOA=="}], "type": "inlineReview", "revised_code": {"commit": "0ef7851b7966b1b5ee6e4d026d6b0561cc9a0e29", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsProperties.java b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsProperties.java\nindex 4ca774ec9..5e3978fe5 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsProperties.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/service/AzureBoardsProperties.java\n\n@@ -114,9 +114,6 @@ public class AzureBoardsProperties implements IssueTrackerServiceConfig {\n         if (StringUtils.isBlank(organizationName) || StringUtils.isBlank(clientId) || StringUtils.isBlank(clientSecret)) {\n             throw new AlertConfigurationException(\"The global configuration for Azure is missing required information.\");\n         }\n-        if (StringUtils.isBlank(oauthUserId)) {\n-            throw new AlertConfigurationException(\"The Azure connection was not authenticated properly. Please go to the Azure global configuration to authenticate the connection.\");\n-        }\n     }\n \n     public AzureHttpService createAzureHttpService(ProxyInfo proxy, Gson gson, String authorizationCode) throws AlertException {\n"}}, {"oid": "3717fa235a839de0f556c4bacc291542c7dc85bc", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3717fa235a839de0f556c4bacc291542c7dc85bc", "message": "Removing the TODO", "committedDate": "2020-09-09T14:12:32Z", "type": "commit"}, {"oid": "0ef7851b7966b1b5ee6e4d026d6b0561cc9a0e29", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/0ef7851b7966b1b5ee6e4d026d6b0561cc9a0e29", "message": "Removing the oauthUserId check from the validation.", "committedDate": "2020-09-09T14:13:44Z", "type": "commit"}]}