{"pr_number": 1200, "pr_title": "Jr auth manager", "pr_createdAt": "2020-09-30T16:43:25Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1200", "timeline": [{"oid": "7a8391c4a924d2708e60ac72a55b1ad5b960523c", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7a8391c4a924d2708e60ac72a55b1ad5b960523c", "message": "Refactor: Updating the AuthorizationManager with more pass through methods for the RoleAccessor to reduce the number of dependencies in classes that use the AuthorizationManager", "committedDate": "2020-09-30T16:04:56Z", "type": "commit"}, {"oid": "30e99cf54b09699883d383a3d29849dbc926c802", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/30e99cf54b09699883d383a3d29849dbc926c802", "message": "Merge branch 'master' into jr_auth_manager", "committedDate": "2020-09-30T16:37:07Z", "type": "commit"}, {"oid": "6ee4f6e637267a698eb1954d8c21ac9d19e474c1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6ee4f6e637267a698eb1954d8c21ac9d19e474c1", "message": "Fixing compile issues in tests", "committedDate": "2020-09-30T16:41:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1NDY5MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1200#discussion_r497654690", "bodyText": "Now that the roles are being updated using methods in this class and the cache is being updated in those methods, is it alright to check the cache for the role name? Or should we still using the RoleAccessor to check the database?", "author": "jamesrichard91", "createdAt": "2020-09-30T16:45:05Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/security/authorization/AuthorizationManager.java", "diffHunk": "@@ -139,6 +139,23 @@ public final boolean hasAllPermissions(String context, String descriptorName, Ac\n                    .anyMatch(name -> permissionCache.containsKey(name) && permissionCache.get(name).hasPermissions(permissionKey, operations));\n     }\n \n+    public Set<UserRoleModel> getRoles() {\n+        return roleAccessor.getRoles();\n+    }\n+\n+    public Set<UserRoleModel> getRoles(Collection<Long> roleIds) {\n+        return roleAccessor.getRoles(roleIds);\n+    }\n+\n+    public boolean doesRoleNameExist(String name) {\n+        return permissionCache.containsKey(name);", "originalCommit": "6ee4f6e637267a698eb1954d8c21ac9d19e474c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1915c028949c2a3453366799b1103ee5c0fc94da", "chunk": "diff --git a/alert-common/src/main/java/com/synopsys/integration/alert/common/security/authorization/AuthorizationManager.java b/alert-common/src/main/java/com/synopsys/integration/alert/common/security/authorization/AuthorizationManager.java\nindex 490fc7aae..92b462e3e 100644\n--- a/alert-common/src/main/java/com/synopsys/integration/alert/common/security/authorization/AuthorizationManager.java\n+++ b/alert-common/src/main/java/com/synopsys/integration/alert/common/security/authorization/AuthorizationManager.java\n\n@@ -139,18 +139,6 @@ public class AuthorizationManager {\n                    .anyMatch(name -> permissionCache.containsKey(name) && permissionCache.get(name).hasPermissions(permissionKey, operations));\n     }\n \n-    public Set<UserRoleModel> getRoles() {\n-        return roleAccessor.getRoles();\n-    }\n-\n-    public Set<UserRoleModel> getRoles(Collection<Long> roleIds) {\n-        return roleAccessor.getRoles(roleIds);\n-    }\n-\n-    public boolean doesRoleNameExist(String name) {\n-        return permissionCache.containsKey(name);\n-    }\n-\n     public void updateRoleName(Long roleId, String roleName) throws AlertDatabaseConstraintException {\n         roleAccessor.updateRoleName(roleId, roleName);\n         loadPermissionsIntoCache();\n"}}, {"oid": "d141aebdfbdd7cd1a25894cf234d7facbbf2605b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/d141aebdfbdd7cd1a25894cf234d7facbbf2605b", "message": "Merge branch 'master' into jr_auth_manager", "committedDate": "2020-09-30T17:51:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcwODE1MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1200#discussion_r497708150", "bodyText": "I'm not sure delegating Role retrieval to the AuthorizationManager is the right move. Yes, AuthorizationManager has a RoleAccessor, and yes, the RoleActions would otherwise need both, but I do not believe this is correctly separating concerns. RoleAccessor is the thing that should be depended on to read/write roles to and from the database and AuthorizationManager is the utility that cross-references roles with users.\nI'm not entirely sure why AuthorizationManager was even being used in this class before.", "author": "gkillough", "createdAt": "2020-09-30T18:13:59Z", "path": "src/main/java/com/synopsys/integration/alert/web/api/role/RoleActions.java", "diffHunk": "@@ -56,19 +55,17 @@\n @Component\n public class RoleActions {\n     private static final String FIELD_KEY_ROLE_NAME = \"roleName\";\n-    private final RoleAccessor roleAccessor;\n     private final AuthorizationManager authorizationManager;", "originalCommit": "d141aebdfbdd7cd1a25894cf234d7facbbf2605b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNTI3Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1200#discussion_r497715276", "bodyText": "The AuthorizationManager is being used to make sure the cache is kept up to date.\nI was not sure about adding the get's to AuthorizationManager. I would be fine with rejecting this PR, if the team thinks it would be better to keep the role retrieval in RoleAccessor.", "author": "jamesrichard91", "createdAt": "2020-09-30T18:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcwODE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxODI5NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1200#discussion_r497718294", "bodyText": "That's my preference, but I'm also second guessing the permissions cache. I can't remember the motivation for it. It seems to me that, if anything, there should be an object representing just the cache that gets used only when needed; then Authorization Manager could be a non-component utility.", "author": "gkillough", "createdAt": "2020-09-30T18:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcwODE1MA=="}], "type": "inlineReview", "revised_code": {"commit": "1915c028949c2a3453366799b1103ee5c0fc94da", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/web/api/role/RoleActions.java b/src/main/java/com/synopsys/integration/alert/web/api/role/RoleActions.java\nindex 5452e1d18..650738e09 100644\n--- a/src/main/java/com/synopsys/integration/alert/web/api/role/RoleActions.java\n+++ b/src/main/java/com/synopsys/integration/alert/web/api/role/RoleActions.java\n\n@@ -55,17 +56,19 @@ import com.synopsys.integration.alert.common.util.BitwiseUtil;\n @Component\n public class RoleActions {\n     private static final String FIELD_KEY_ROLE_NAME = \"roleName\";\n+    private final RoleAccessor roleAccessor;\n     private final AuthorizationManager authorizationManager;\n     private final DescriptorMap descriptorMap;\n \n     @Autowired\n-    public RoleActions(AuthorizationManager authorizationManager, DescriptorMap descriptorMap, List<DescriptorKey> descriptorKeys) {\n+    public RoleActions(RoleAccessor roleAccessor, AuthorizationManager authorizationManager, DescriptorMap descriptorMap, List<DescriptorKey> descriptorKeys) {\n+        this.roleAccessor = roleAccessor;\n         this.authorizationManager = authorizationManager;\n         this.descriptorMap = descriptorMap;\n     }\n \n     public List<RolePermissionModel> getRoles() {\n-        return authorizationManager.getRoles().stream()\n+        return roleAccessor.getRoles().stream()\n                    .map(this::convertUserRoleModel)\n                    .collect(Collectors.toList());\n     }\n"}}, {"oid": "253e5cec5eeb571fbff3b1cd11aecc43c8dbd6c8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/253e5cec5eeb571fbff3b1cd11aecc43c8dbd6c8", "message": "Merge branch 'master' into jr_auth_manager", "committedDate": "2020-09-30T19:54:24Z", "type": "commit"}, {"oid": "1915c028949c2a3453366799b1103ee5c0fc94da", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1915c028949c2a3453366799b1103ee5c0fc94da", "message": "Reverting some of the changes to keep using the RoleAccessor to retrieve the roles from the database", "committedDate": "2020-09-30T20:00:23Z", "type": "commit"}]}