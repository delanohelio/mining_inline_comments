{"pr_number": 1138, "pr_title": "Add project version into the subject line of the emails", "pr_createdAt": "2020-08-27T15:37:45Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138", "timeline": [{"oid": "15f98e52c72d291b7dc368dede456298b4ba2cc5", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/15f98e52c72d291b7dc368dede456298b4ba2cc5", "message": "refactor: Update EmailChannel to include project version in email subject line", "committedDate": "2020-08-26T18:14:34Z", "type": "commit"}, {"oid": "fea6f8753c06ef066d2f6317c4f55c048c94a360", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/fea6f8753c06ef066d2f6317c4f55c048c94a360", "message": "Merge branch 'master' into mc_project_version_subjectline", "committedDate": "2020-08-26T20:34:07Z", "type": "commit"}, {"oid": "9fef348a4df2f50175f61d9b91d14953f7d333a9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9fef348a4df2f50175f61d9b91d14953f7d333a9", "message": "refactor: Handle test case where SubTopic is null", "committedDate": "2020-08-27T15:36:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNTU0NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478515544", "bodyText": "I don't think we need to check this. We know that the sub-topic is the project-version for Black Duck and if there is ever another provider, it will be likely that we need to include this for feature parity.", "author": "gkillough", "createdAt": "2020-08-27T15:41:01Z", "path": "src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java", "diffHunk": "@@ -98,8 +100,16 @@ public void distributeMessage(DistributionEvent event) throws IntegrationExcepti\n \n     public void sendMessage(EmailProperties emailProperties, Set<String> emailAddresses, String subjectLine, String formatType, EmailAttachmentFormat attachmentFormat, MessageContentGroup messageContent) throws IntegrationException {\n         String topicValue = null;\n+        Optional<String> subTopicValue = Optional.empty();\n         if (!messageContent.isEmpty()) {\n             topicValue = messageContent.getCommonTopic().getValue();\n+            subTopicValue = messageContent.getSubContent()\n+                                .stream()\n+                                .map(ProviderMessageContent::getSubTopic)\n+                                .flatMap(Optional::stream)\n+                                .filter(linkableItem -> MessageBuilderConstants.LABEL_PROJECT_VERSION_NAME.equals(linkableItem.getName()))", "originalCommit": "9fef348a4df2f50175f61d9b91d14953f7d333a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNTU2NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478525564", "bodyText": "A license limit notification won't include a version unless I'm mistaken. The API of ProviderMessageContent doesn't make it clear that the sub topic is the version so given that API I suggested filtering to be sure you have the project version sub topic.  The initial code just had find first.  But with your suggestion to join the sub topics the filtering may not make sense anymore.  If we remove the filter portion of the stream then I would like to see a comment above that states we're assuming the sub-topic is the version.   Just in case we get a bug later on that the subject isn't correct we have a comment to refresh our memory on the assumption in case it comes into play.", "author": "psantos1113", "createdAt": "2020-08-27T15:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNTU0NA=="}], "type": "inlineReview", "revised_code": {"commit": "39b0427ec699af8df9c459580d1644a4975d6c8a", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\nindex 7256fe30b..8dee69864 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n\n@@ -100,16 +100,16 @@ public class EmailChannel extends NamedDistributionChannel {\n \n     public void sendMessage(EmailProperties emailProperties, Set<String> emailAddresses, String subjectLine, String formatType, EmailAttachmentFormat attachmentFormat, MessageContentGroup messageContent) throws IntegrationException {\n         String topicValue = null;\n-        Optional<String> subTopicValue = Optional.empty();\n+        String subTopicValue = null;\n         if (!messageContent.isEmpty()) {\n             topicValue = messageContent.getCommonTopic().getValue();\n+            //subTopic is assumed to be a BlackDuck project version\n             subTopicValue = messageContent.getSubContent()\n                                 .stream()\n                                 .map(ProviderMessageContent::getSubTopic)\n                                 .flatMap(Optional::stream)\n-                                .filter(linkableItem -> MessageBuilderConstants.LABEL_PROJECT_VERSION_NAME.equals(linkableItem.getName()))\n                                 .map(LinkableItem::getValue)\n-                                .findFirst();\n+                                .collect(Collectors.joining(\", \"));\n         }\n \n         String alertServerUrl = alertProperties.getServerUrl().orElse(null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNjU3OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478516579", "bodyText": "Because there can be multiple project-versions, we should return a joined list of them.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            .findFirst();\n          \n          \n            \n                                            .collect(Collectors.joining(\", \"));", "author": "gkillough", "createdAt": "2020-08-27T15:42:36Z", "path": "src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java", "diffHunk": "@@ -98,8 +100,16 @@ public void distributeMessage(DistributionEvent event) throws IntegrationExcepti\n \n     public void sendMessage(EmailProperties emailProperties, Set<String> emailAddresses, String subjectLine, String formatType, EmailAttachmentFormat attachmentFormat, MessageContentGroup messageContent) throws IntegrationException {\n         String topicValue = null;\n+        Optional<String> subTopicValue = Optional.empty();\n         if (!messageContent.isEmpty()) {\n             topicValue = messageContent.getCommonTopic().getValue();\n+            subTopicValue = messageContent.getSubContent()\n+                                .stream()\n+                                .map(ProviderMessageContent::getSubTopic)\n+                                .flatMap(Optional::stream)\n+                                .filter(linkableItem -> MessageBuilderConstants.LABEL_PROJECT_VERSION_NAME.equals(linkableItem.getName()))\n+                                .map(LinkableItem::getValue)\n+                                .findFirst();", "originalCommit": "9fef348a4df2f50175f61d9b91d14953f7d333a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyMjMzNA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478522334", "bodyText": "In my testing of this feature I saw that for multiple versions we have multiple emails for each. So \"projectA version1\" and \"projectA version2\" would come in as 2 separate emails with those titles. Is there a case where they would be combined?", "author": "ChomickiM", "createdAt": "2020-08-27T15:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNDE5MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478524191", "bodyText": "I believe they are supposed to be combined if they get processed in the same batch of notifications.", "author": "gkillough", "createdAt": "2020-08-27T15:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNDUwMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478524502", "bodyText": "Either way, this will work.", "author": "gkillough", "createdAt": "2020-08-27T15:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxNjU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "39b0427ec699af8df9c459580d1644a4975d6c8a", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\nindex 7256fe30b..8dee69864 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n\n@@ -100,16 +100,16 @@ public class EmailChannel extends NamedDistributionChannel {\n \n     public void sendMessage(EmailProperties emailProperties, Set<String> emailAddresses, String subjectLine, String formatType, EmailAttachmentFormat attachmentFormat, MessageContentGroup messageContent) throws IntegrationException {\n         String topicValue = null;\n-        Optional<String> subTopicValue = Optional.empty();\n+        String subTopicValue = null;\n         if (!messageContent.isEmpty()) {\n             topicValue = messageContent.getCommonTopic().getValue();\n+            //subTopic is assumed to be a BlackDuck project version\n             subTopicValue = messageContent.getSubContent()\n                                 .stream()\n                                 .map(ProviderMessageContent::getSubTopic)\n                                 .flatMap(Optional::stream)\n-                                .filter(linkableItem -> MessageBuilderConstants.LABEL_PROJECT_VERSION_NAME.equals(linkableItem.getName()))\n                                 .map(LinkableItem::getValue)\n-                                .findFirst();\n+                                .collect(Collectors.joining(\", \"));\n         }\n \n         String alertServerUrl = alertProperties.getServerUrl().orElse(null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxOTQ0NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478519445", "bodyText": "We might want to consider truncating this if it exceeds a certain number of characters.\n78 is the suggested number of RCF 2822 https://tools.ietf.org/html/rfc2822#section-2.1.1", "author": "gkillough", "createdAt": "2020-08-27T15:46:49Z", "path": "src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java", "diffHunk": "@@ -146,9 +156,13 @@ public void sendMessage(EmailProperties emailProperties, Set<String> emailAddres\n         return optionalAttachmentFile;\n     }\n \n-    private String createEnhancedSubjectLine(String originalSubjectLine, String providerProjectName) {\n+    private String createEnhancedSubjectLine(String originalSubjectLine, String providerProjectName, Optional<String> providerProjectVersionName) {\n         if (StringUtils.isNotBlank(providerProjectName)) {\n-            return String.format(\"%s | For: %s\", originalSubjectLine, providerProjectName);\n+            String subjectLine = String.format(\"%s | For: %s\", originalSubjectLine, providerProjectName);\n+            if (providerProjectVersionName.isPresent()) {\n+                subjectLine += String.format(\" %s\", providerProjectVersionName.get());\n+            }\n+            return subjectLine;", "originalCommit": "9fef348a4df2f50175f61d9b91d14953f7d333a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyNjE2NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1138#discussion_r478526165", "bodyText": "StringUtils should have the abbreviate method if I remember correctly to do that.", "author": "psantos1113", "createdAt": "2020-08-27T15:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxOTQ0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "39b0427ec699af8df9c459580d1644a4975d6c8a", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\nindex 7256fe30b..8dee69864 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/email/EmailChannel.java\n\n@@ -156,13 +156,14 @@ public class EmailChannel extends NamedDistributionChannel {\n         return optionalAttachmentFile;\n     }\n \n-    private String createEnhancedSubjectLine(String originalSubjectLine, String providerProjectName, Optional<String> providerProjectVersionName) {\n+    private String createEnhancedSubjectLine(String originalSubjectLine, String providerProjectName, String providerProjectVersionName) {\n         if (StringUtils.isNotBlank(providerProjectName)) {\n             String subjectLine = String.format(\"%s | For: %s\", originalSubjectLine, providerProjectName);\n-            if (providerProjectVersionName.isPresent()) {\n-                subjectLine += String.format(\" %s\", providerProjectVersionName.get());\n+            if (StringUtils.isNotBlank(providerProjectVersionName)) {\n+                subjectLine += String.format(\" %s\", providerProjectVersionName);\n             }\n-            return subjectLine;\n+            //78 characters is the suggested length for the message: https://tools.ietf.org/html/rfc2822#section-2.1.1\n+            return StringUtils.abbreviate(subjectLine, 78);\n         }\n         return originalSubjectLine;\n     }\n"}}, {"oid": "39b0427ec699af8df9c459580d1644a4975d6c8a", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/39b0427ec699af8df9c459580d1644a4975d6c8a", "message": "refactor: Modify subTopic stream to collect into a string and handle in createEnhancedSubjectLine", "committedDate": "2020-08-27T18:19:36Z", "type": "commit"}]}