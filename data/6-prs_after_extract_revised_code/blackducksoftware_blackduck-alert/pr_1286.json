{"pr_number": 1286, "pr_title": "Update NotificationProcessor and DistributionEvents to use new Accessor", "pr_createdAt": "2020-12-04T17:03:12Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286", "timeline": [{"oid": "5e90c4fbe5882acf015b04f4970ce5738c64961c", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5e90c4fbe5882acf015b04f4970ce5738c64961c", "message": "Feat: Begin refactoring NotificationProcessor and its dependencies to use DistributionJobModel", "committedDate": "2020-12-03T21:13:53Z", "type": "commit"}, {"oid": "efcdd9e7d3f332e4d0017e327f333f49e97973aa", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/efcdd9e7d3f332e4d0017e327f333f49e97973aa", "message": "Feat(TestAction): Continue refactoring dependencies of NotificationProcessor", "committedDate": "2020-12-04T13:58:32Z", "type": "commit"}, {"oid": "a9e30c1641e513a04270039bdb6cf31ea533a317", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a9e30c1641e513a04270039bdb6cf31ea533a317", "message": "Feat(Channel): Update channels to use DistributionJobModel rather than FieldUtility", "committedDate": "2020-12-04T14:10:27Z", "type": "commit"}, {"oid": "99cba6b0819c54cb1dc4ae2941e1d6ae70f94653", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/99cba6b0819c54cb1dc4ae2941e1d6ae70f94653", "message": "Fix(DescriptorProcessor): Add temporary distinction of distribution channel test actions from other TestActions", "committedDate": "2020-12-04T14:35:32Z", "type": "commit"}, {"oid": "8be2d56dc607c83d4df8b96d2cee109d2310de35", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8be2d56dc607c83d4df8b96d2cee109d2310de35", "message": "Fix(Test): Fix test compile errors and bugs discovered by unit tests", "committedDate": "2020-12-04T17:00:09Z", "type": "commit"}, {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7cfac286e5ab424db9ad5047e04af2879607566c", "message": "Merge branch 'master' into gk_update_notification_processor", "committedDate": "2020-12-04T17:00:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0NTYyOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536245628", "bodyText": "Moved to ChannelDistributionTestEventCreationUtils", "author": "gkillough", "createdAt": "2020-12-04T17:04:44Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/TestAction.java", "diffHunk": "@@ -39,25 +34,4 @@\n \n     public abstract MessageResult testConfig(String configId, FieldModel fieldModel, FieldUtility registeredFieldValues) throws IntegrationException;\n \n-    public ProviderMessageContent createTestNotificationContent(FieldUtility fieldUtility, ItemOperation operation, String messageId) throws AlertException {", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0NTkyMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536245922", "bodyText": "A Jira issue was created against 6.5.0 for this.", "author": "gkillough", "createdAt": "2020-12-04T17:05:22Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/ConfigurationAction.java", "diffHunk": "@@ -24,14 +24,20 @@\n \n import java.util.EnumMap;\n import java.util.Map;\n+import java.util.Optional;\n \n+import com.synopsys.integration.alert.common.channel.ChannelDistributionTestAction;\n import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n import com.synopsys.integration.alert.descriptor.api.model.DescriptorKey;\n \n public abstract class ConfigurationAction {\n     private final DescriptorKey descriptorKey;\n-    private final Map<ConfigContextEnum, ApiAction> apiActionMap = new EnumMap(ConfigContextEnum.class);\n-    private final Map<ConfigContextEnum, TestAction> testActionMap = new EnumMap(ConfigContextEnum.class);\n+    private final Map<ConfigContextEnum, ApiAction> apiActionMap = new EnumMap<>(ConfigContextEnum.class);\n+    private final Map<ConfigContextEnum, TestAction> testActionMap = new EnumMap<>(ConfigContextEnum.class);\n+\n+    // FIXME there needs to be a better distinction between a global TestAction and a distribution TestAction\n+    //  for 6.4.0, this will have to suffice to avoid additional scope-creep of re-architecting TestActions\n+    private ChannelDistributionTestAction channelDistributionTestAction;", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTM0NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536251344", "bodyText": "I would love to know if this is required, or if we can remove it.", "author": "gkillough", "createdAt": "2020-12-04T17:16:09Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/event/DistributionEvent.java", "diffHunk": "@@ -24,30 +24,43 @@\n \n import java.util.Map;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n+import org.jetbrains.annotations.Nullable;\n+\n import com.synopsys.integration.alert.common.message.model.MessageContentGroup;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n \n public class DistributionEvent extends ContentEvent {\n-    private static final long serialVersionUID = -2067819359358348281L;\n-    private final FieldUtility fieldUtility;\n-    private final String configId;\n+    private static final long serialVersionUID = -7858733753649257748L;", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM4NDA0Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538384043", "bodyText": "A DistributionEvent implements serializable because of AlertEvent which is serializable.  Each sub-class must define the Serial Version ID otherwise you get compiler warnings and SonarCloud issues.\nWe perform our own serialization of the events into a JSON string in the EventManager and MessageReciever classes.  So AlertEvent should still work extending only Stringable since we manually serialize the even objects in Alert.", "author": "psantos1113", "createdAt": "2020-12-08T13:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyMDY2OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538420668", "bodyText": "Are they compiler warnings or IDE warnings? I could have sworn we determined that we should no longer be generating serialVersionUID on Serializable classes.", "author": "gkillough", "createdAt": "2020-12-08T14:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTM0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536305028", "bodyText": "Why do we have the 2 exceptions here, rather than just the AlertRuntimeException?", "author": "jamesrichard91", "createdAt": "2020-12-04T18:46:34Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/server/JiraServerChannel.java", "diffHunk": "@@ -55,8 +57,9 @@ public JiraServerChannel(Gson gson, JiraServerChannelKey descriptorKey, AuditAcc\n \n     @Override\n     protected IssueTrackerContext getIssueTrackerContext(DistributionEvent event) {\n-        FieldUtility fieldUtility = event.getFieldUtility();\n-        return jiraServerContextBuilder.build(fieldUtility);\n+        ConfigurationModel globalConfig = event.getChannelGlobalConfig()\n+                                              .orElseThrow(() -> new AlertRuntimeException(new AlertConfigurationException(\"Missing Jira Server global configuration\")));", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwOTgwOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536309808", "bodyText": "I didn't want to modify the method signature, but a missing global configuration is an AlertConfigurationException. It will be wrapped, but will make it more clear what the problem is.", "author": "gkillough", "createdAt": "2020-12-04T18:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDUyNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537870526", "bodyText": "Perhaps we can introduce a new exception in a separate PR?", "author": "bamandel", "createdAt": "2020-12-07T22:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3MTYyMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538371622", "bodyText": "Since we do this in a few places, we should try to figure out why this exception can be thrown in a place that does not allow checked exceptions before we assume that a new exception is needed.", "author": "gkillough", "createdAt": "2020-12-08T13:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3NDY2NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538374665", "bodyText": "Jira issue created.", "author": "gkillough", "createdAt": "2020-12-08T13:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQwNTQyMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538405422", "bodyText": "We change the method signature in the future to throw an AlertConfigurationException since that appears to be the correct action.  That should be done in a smaller PR.", "author": "psantos1113", "createdAt": "2020-12-08T14:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMDE0Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536300142", "bodyText": "Do we prefer a constructor for this over a static method?", "author": "JakeMathews", "createdAt": "2020-12-04T18:37:51Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/common/JiraTestIssueRequestCreator.java", "diffHunk": "@@ -51,20 +52,29 @@\n \n public class JiraTestIssueRequestCreator implements TestIssueRequestCreator {\n     private final Logger logger = LoggerFactory.getLogger(JiraTestIssueRequestCreator.class);\n-    private final FieldUtility fieldUtility;\n+\n+    private final String customTopic;\n+    private final String customMessage;\n     private final JiraMessageParser jiraMessageParser;\n \n     public JiraTestIssueRequestCreator(FieldUtility fieldUtility, JiraMessageParser jiraMessageParser) {", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwOTEwMw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536309103", "bodyText": "No. This is definitely an area that needs improvement, but changing this existing constructor would have only added to the already-excessive scope-creep.", "author": "gkillough", "createdAt": "2020-12-04T18:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMDE0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMTYzNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536301635", "bodyText": "Is including the properties from FieldUtlity for temporary compatibility, or are there fields the context needs that aren't in the JiraCloudJobDetailsModel?", "author": "JakeMathews", "createdAt": "2020-12-04T18:40:38Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudContextBuilder.java", "diffHunk": "@@ -78,4 +83,23 @@ public JiraCloudContext build(FieldUtility fieldUtility) {\n         return new JiraCloudContext(jiraCloudPropertiesFactory.createJiraProperties(fieldUtility), createIssueConfig(fieldUtility));\n     }\n \n+    @Override\n+    public JiraCloudContext build(ConfigurationModel globalConfig, DistributionJobModel jobModel) {\n+        FieldUtility globalFieldUtility = new FieldUtility(globalConfig.getCopyOfKeyToFieldMap());\n+        JiraCloudProperties jiraProperties = jiraCloudPropertiesFactory.createJiraProperties(globalFieldUtility);", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwODE1MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536308150", "bodyText": "The former. The Jira channels share several common interfaces and I was trying to simplify for compatibility.", "author": "gkillough", "createdAt": "2020-12-04T18:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMTYzNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMzQ3NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536313474", "bodyText": "It looks like you are missing the Mockito.when for the oldJobAccessor.", "author": "JakeMathews", "createdAt": "2020-12-04T19:01:11Z", "path": "src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java", "diffHunk": "@@ -152,20 +157,26 @@ public void testPagedRequest() throws AlertDatabaseConstraintException {\n \n         NotificationContentRepository notificationRepository = Mockito.mock(NotificationContentRepository.class);\n         AuditNotificationRepository auditNotificationRepository = Mockito.mock(AuditNotificationRepository.class);\n-        JobAccessor jobAccessor = Mockito.mock(JobAccessor.class);\n+        JobAccessor oldJobAccessor = Mockito.mock(JobAccessor.class);\n+        JobAccessorV2 jobAccessor = Mockito.mock(JobAccessorV2.class);\n+        Mockito.when(jobAccessor.getJobById(Mockito.any())).thenReturn(null);", "originalCommit": "7cfac286e5ab424db9ad5047e04af2879607566c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxNDk1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536314955", "bodyText": "I see you do this further down. So is line 162 still necessary?\nMockito.doReturn(Optional.of(configuration)).when(oldJobAccessor).getJobById(Mockito.any());\n        Mockito.doReturn(Optional.of(distributionJob)).when(jobAccessor).getJobById(Mockito.any());", "author": "JakeMathews", "createdAt": "2020-12-04T19:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMzQ3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwOTg2NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537509864", "bodyText": "I updated AuditEntryActions because it used NotificationProcessor, but I did not need to update DefaultAuditAccessor for this PR.", "author": "gkillough", "createdAt": "2020-12-07T13:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMzQ3NA=="}], "type": "inlineReview", "revised_code": {"commit": "4b35875ce36afe030474263481158dc2d30d7786", "chunk": "diff --git a/src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java b/src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java\nindex 1e52c0dac..7659220f8 100644\n--- a/src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java\n+++ b/src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java\n\n@@ -157,7 +155,6 @@ public class AuditEntryActionsTest {\n \n         NotificationContentRepository notificationRepository = Mockito.mock(NotificationContentRepository.class);\n         AuditNotificationRepository auditNotificationRepository = Mockito.mock(AuditNotificationRepository.class);\n-        JobAccessor oldJobAccessor = Mockito.mock(JobAccessor.class);\n         JobAccessorV2 jobAccessor = Mockito.mock(JobAccessorV2.class);\n         Mockito.when(jobAccessor.getJobById(Mockito.any())).thenReturn(null);\n         ConfigurationAccessor configurationAccessor = Mockito.mock(ConfigurationAccessor.class);\n"}}, {"oid": "a2c3d6c0e455f78ba673b3427fb436cdc0558a9f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a2c3d6c0e455f78ba673b3427fb436cdc0558a9f", "message": "Fix(EmailAddressHandler): Re-add EmailAddressHandler to email distribution test action and continue fixing tests", "committedDate": "2020-12-04T20:57:48Z", "type": "commit"}, {"oid": "79828621c2a192fca4614f531ae166d9c15f7555", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/79828621c2a192fca4614f531ae166d9c15f7555", "message": "Fix(Test): Pass the correct field models for distribution validation", "committedDate": "2020-12-07T14:44:01Z", "type": "commit"}, {"oid": "415e8246df11dabea5c189a7fee32d1fde37f64b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/415e8246df11dabea5c189a7fee32d1fde37f64b", "message": "Fix(Test): Add missing email image directory property", "committedDate": "2020-12-07T15:15:48Z", "type": "commit"}, {"oid": "af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba", "message": "Fix(Test): Update test properties and resource loading to get project owner email test working", "committedDate": "2020-12-07T19:06:13Z", "type": "commit"}, {"oid": "70b2f15f023aa1cec2dcadc4dab39b7d8fa945c4", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/70b2f15f023aa1cec2dcadc4dab39b7d8fa945c4", "message": "Fix(Email): Update test action to just use \"additional email addresses\"", "committedDate": "2020-12-07T19:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc2NDI1MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537764250", "bodyText": "This does not seem correct, why are we only using the additional email addresses? Part of the email distribution test is to verify the email recipients. So we should be using the configuration as specified in the test.", "author": "jamesrichard91", "createdAt": "2020-12-07T19:19:04Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java", "diffHunk": "@@ -62,10 +62,12 @@ public MessageResult testConfig(\n     private DistributionJobModel creatUpdatedJobModelWithEmailAddresses(DistributionJobModel originalJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> updateEmailAddresses = emailActionHelper.createUpdatedEmailAddresses(originalJobModel, destination);\n         EmailJobDetailsModel originalEmailJobDetails = originalJobModel.getDistributionJobDetails().getAsEmailJobDetails();\n+\n+        // For testing configuration, just use additional email addresses field", "originalCommit": "af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc3NjA5Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537776092", "bodyText": "EmailTestActionHelper will get all of the correct recipients for a Job.\nWhen testing configuration, the event is not tied to a real notification, so when the event gets to the channel, the EmailAddressHandler will not be able to look up the \"Project Owner\" or \"project members\" correctly. Before my changes, we would shove an extra field into FieldUtility with the results of EmailTestActionHelper; now that there is no FieldUtility we append the results of EmailTestActionHelper as additional email addresses instead and only use those emails for testing.", "author": "gkillough", "createdAt": "2020-12-07T19:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc2NDI1MA=="}], "type": "inlineReview", "revised_code": {"commit": "384de74d887e5ada76f7caefe1de9b3092cb61b0", "chunk": "diff --git a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java\nindex 03e822a34..dbe6779fe 100644\n--- a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java\n+++ b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java\n\n@@ -60,16 +61,21 @@ public class EmailDistributionTestAction extends ChannelDistributionTestAction {\n     }\n \n     private DistributionJobModel creatUpdatedJobModelWithEmailAddresses(DistributionJobModel originalJobModel, @Nullable String destination) throws IntegrationException {\n-        Set<String> updateEmailAddresses = emailActionHelper.createUpdatedEmailAddresses(originalJobModel, destination);\n+        Set<String> updateEmailAddresses = emailTestActionHelper.createUpdatedEmailAddresses(originalJobModel, destination);\n         EmailJobDetailsModel originalEmailJobDetails = originalJobModel.getDistributionJobDetails().getAsEmailJobDetails();\n \n         // For testing configuration, just use additional email addresses field\n+        List<String> originalAdditionalEmailAddresses = originalEmailJobDetails.getAdditionalEmailAddresses();\n+        List<String> additionalEmailAddressesToUse = new ArrayList<>(updateEmailAddresses.size() + originalAdditionalEmailAddresses.size());\n+        additionalEmailAddressesToUse.addAll(originalAdditionalEmailAddresses);\n+        additionalEmailAddressesToUse.addAll(updateEmailAddresses);\n+\n         EmailJobDetailsModel updatedEmailJobDetails = new EmailJobDetailsModel(\n             originalEmailJobDetails.getSubjectLine(),\n             false,\n             true,\n             originalEmailJobDetails.getAttachmentFileType(),\n-            List.copyOf(updateEmailAddresses)\n+            additionalEmailAddressesToUse\n         );\n         return DistributionJobModel.builder()\n                    .enabled(originalJobModel.isEnabled())\n"}}, {"oid": "384de74d887e5ada76f7caefe1de9b3092cb61b0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/384de74d887e5ada76f7caefe1de9b3092cb61b0", "message": "Fix(Test): Autowire DescriptorMap for event converter test", "committedDate": "2020-12-07T19:24:52Z", "type": "commit"}, {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/57dd1b17667a4b95b0f8fa56e16678428ef8da42", "message": "Fix(Job): Add null check for provider projects before streaming", "committedDate": "2020-12-07T20:53:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzMzI1MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537833250", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (null != providerProjects && !providerProjects.isEmpty()) {\n          \n          \n            \n                        if (CollectionUtils.isNotEmpty(providerProjects)) {", "author": "JakeMathews", "createdAt": "2020-12-07T21:07:23Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java", "diffHunk": "@@ -24,72 +24,68 @@\n \n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n \n import com.synopsys.integration.alert.channel.email.EmailAddressHandler;\n-import com.synopsys.integration.alert.channel.email.descriptor.EmailDescriptor;\n-import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n import com.synopsys.integration.alert.common.exception.AlertFieldException;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n import com.synopsys.integration.alert.common.persistence.accessor.ProviderDataAccessor;\n-import com.synopsys.integration.alert.common.persistence.model.ConfigurationFieldModel;\n import com.synopsys.integration.alert.common.persistence.model.ProviderProject;\n+import com.synopsys.integration.alert.common.persistence.model.job.BlackDuckProjectDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.DistributionJobDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.EmailJobDetailsModel;\n import com.synopsys.integration.exception.IntegrationException;\n \n @Component\n-public class EmailActionHelper {\n+public class EmailTestActionHelper {\n     private final EmailAddressHandler emailAddressHandler;\n     private final ProviderDataAccessor providerDataAccessor;\n \n-    public EmailActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n+    public EmailTestActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n         this.emailAddressHandler = emailAddressHandler;\n         this.providerDataAccessor = providerDataAccessor;\n     }\n \n-    public FieldUtility createUpdatedFieldAccessor(FieldUtility fieldUtility, String destination) throws IntegrationException {\n+    public Set<String> createUpdatedEmailAddresses(DistributionJobModel distributionJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> emailAddresses = new HashSet<>();\n         if (StringUtils.isNotBlank(destination)) {\n             emailAddresses.add(destination);\n         }\n \n-        boolean filterByProject = fieldUtility.getBooleanOrFalse(ProviderDistributionUIConfig.KEY_FILTER_BY_PROJECT);\n-        Long providerConfigId = fieldUtility.getLong(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID).orElse(null);\n-        boolean onlyAdditionalEmails = fieldUtility.getBooleanOrFalse(EmailDescriptor.KEY_EMAIL_ADDITIONAL_ADDRESSES_ONLY);\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        EmailJobDetailsModel emailJobDetails = distributionJobDetails.getAsEmailJobDetails();\n+\n+        Long providerConfigId = distributionJobModel.getBlackDuckGlobalConfigId();\n+        boolean onlyAdditionalEmails = emailJobDetails.isAdditionalEmailAddressesOnly();\n \n         if (null != providerConfigId && !onlyAdditionalEmails) {\n-            Set<ProviderProject> providerProjects = retrieveProviderProjects(fieldUtility, filterByProject, providerConfigId);\n-            if (null != providerProjects) {\n-                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, fieldUtility);\n+            Set<ProviderProject> providerProjects = retrieveProviderProjects(distributionJobModel, providerConfigId);\n+            if (null != providerProjects && !providerProjects.isEmpty()) {", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\nindex 321a506f8..c499a55bb 100644\n--- a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\n+++ b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\n\n@@ -27,6 +27,7 @@ import java.util.List;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDExMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537834110", "bodyText": "Why would the optional be null?", "author": "JakeMathews", "createdAt": "2020-12-07T21:08:57Z", "path": "src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java", "diffHunk": "@@ -53,43 +63,54 @@\n     protected DistributionEvent channelEvent;\n \n     protected ContentConverter contentConverter;\n-    protected TestProperties properties;\n+    protected TestProperties testProperties;\n \n+    @Autowired\n+    protected ProviderKey providerKey;\n+    @Autowired\n+    protected JobAccessorV2 jobAccessor;\n     @Autowired\n     protected DefaultConfigurationAccessor configurationAccessor;\n     @Autowired\n     protected DefaultDescriptorAccessor descriptorAccessor;\n     @Autowired\n+    protected DescriptorProcessor descriptorProcessor;\n+    @Autowired\n     protected RegisteredDescriptorRepository registeredDescriptorRepository;\n \n-    protected ConfigurationModel provider_global;\n-    protected Optional<ConfigurationModel> global_config;\n-    protected ConfigurationModel distribution_config;\n-    protected String destinationName;\n+    protected ConfigurationModel providerGlobalConfig;\n+    protected Optional<ConfigurationModel> optionalChannelGlobalConfig;\n+    protected DistributionJobModel distributionJobModel;\n+    protected String eventDestinationName;\n \n     @BeforeEach\n     public void init() throws Exception {\n         gson = new Gson();\n         contentConverter = new ContentConverter(gson, new DefaultConversionService());\n-        properties = new TestProperties();\n-        global_config = saveGlobalConfiguration();\n-        distribution_config = saveDistributionConfiguration();\n+        testProperties = new TestProperties();\n+        providerGlobalConfig = saveProviderGlobalConfig();\n+        optionalChannelGlobalConfig = saveGlobalConfiguration();\n+        eventDestinationName = getEventDestinationName();\n         channelEvent = createChannelEvent();\n-        destinationName = getDestinationName();\n+        distributionJobModel = saveDistributionJob();\n     }\n \n     @AfterEach\n     public void cleanupTest() {\n-        if (null != global_config && global_config.isPresent()) {\n-            configurationAccessor.deleteConfiguration(global_config.get());\n+        if (null != optionalChannelGlobalConfig && optionalChannelGlobalConfig.isPresent()) {", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3ODg2NA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538378864", "bodyText": "I believe this code was here before and I just renamed the variable. I'll clean this up though.", "author": "gkillough", "createdAt": "2020-12-08T13:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDExMA=="}], "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java b/src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java\nindex df6c88d3b..df2049987 100644\n--- a/src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java\n+++ b/src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java\n\n@@ -97,9 +97,7 @@ public abstract class ChannelDescriptorTestIT extends AlertIntegrationTest {\n \n     @AfterEach\n     public void cleanupTest() {\n-        if (null != optionalChannelGlobalConfig && optionalChannelGlobalConfig.isPresent()) {\n-            configurationAccessor.deleteConfiguration(optionalChannelGlobalConfig.get());\n-        }\n+        optionalChannelGlobalConfig.ifPresent(configurationAccessor::deleteConfiguration);\n \n         if (distributionJobModel != null) {\n             try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MDM4OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537860388", "bodyText": "Isn't this an example of a way to not use an optional? Instead of being passed a null list, we should be passing an empty list which we then check for content and modify/use as needed.", "author": "bamandel", "createdAt": "2020-12-07T21:53:16Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java", "diffHunk": "@@ -66,10 +81,12 @@ public static DistributionJobModel convertToDistributionJobModel(UUID jobId, Map\n                                                   .policyFilterPolicyNames(extractFieldValues(\"blackduck.policy.notification.filter\", configuredFieldsMap))\n                                                   .vulnerabilityFilterSeverityNames(extractFieldValues(\"blackduck.vulnerability.notification.filter\", configuredFieldsMap));\n \n-        List<BlackDuckProjectDetailsModel> blackDuckProjectDetails = extractFieldValues(\"channel.common.configured.project\", configuredFieldsMap)\n-                                                                         .stream()\n-                                                                         .map(projectName -> new BlackDuckProjectDetailsModel(projectName, projectName))\n-                                                                         .collect(Collectors.toList());\n+        List<BlackDuckProjectDetailsModel> blackDuckProjectDetails = Optional.ofNullable(projectFilterDetails)", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM5NDc3Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538394773", "bodyText": "This maintains the same functionality that existed previously from what I can see.  I think this can be improved to how you suggest but it is probably a bit beyond the scope of this PR and should be done separately.", "author": "psantos1113", "createdAt": "2020-12-08T13:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MDM4OA=="}], "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java b/alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java\nindex a791bb630..3fc1edab0 100644\n--- a/alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java\n+++ b/alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java\n\n@@ -79,15 +78,8 @@ public class JobConfigurationModelFieldExtractorUtils {\n                                                   .projectNamePattern(extractFieldValue(\"channel.common.project.name.pattern\", configuredFieldsMap).orElse(null))\n                                                   .notificationTypes(extractFieldValues(\"provider.distribution.notification.types\", configuredFieldsMap))\n                                                   .policyFilterPolicyNames(extractFieldValues(\"blackduck.policy.notification.filter\", configuredFieldsMap))\n-                                                  .vulnerabilityFilterSeverityNames(extractFieldValues(\"blackduck.vulnerability.notification.filter\", configuredFieldsMap));\n-\n-        List<BlackDuckProjectDetailsModel> blackDuckProjectDetails = Optional.ofNullable(projectFilterDetails)\n-                                                                         .orElseGet(() -> extractFieldValues(\"channel.common.configured.project\", configuredFieldsMap)\n-                                                                                              .stream()\n-                                                                                              .map(projectName -> new BlackDuckProjectDetailsModel(projectName, projectName))\n-                                                                                              .collect(Collectors.toList())\n-                                                                         );\n-        builder.projectFilterDetails(blackDuckProjectDetails);\n+                                                  .vulnerabilityFilterSeverityNames(extractFieldValues(\"blackduck.vulnerability.notification.filter\", configuredFieldsMap))\n+                                                  .projectFilterDetails(projectFilterDetails);\n \n         DistributionJobDetailsModel jobDetails = null;\n         if (\"channel_azure_boards\".equals(channelDescriptorName)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2NzU3Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537867576", "bodyText": "Instead of nesting exceptions, we should make a runtime configuration exception.", "author": "bamandel", "createdAt": "2020-12-07T22:04:47Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudChannel.java", "diffHunk": "@@ -55,8 +57,9 @@ public JiraCloudChannel(JiraCloudChannelKey jiraChannelKey, Gson gson, AuditAcce\n \n     @Override\n     protected IssueTrackerContext getIssueTrackerContext(DistributionEvent event) {\n-        FieldUtility fieldUtility = event.getFieldUtility();\n-        return jiraCloudContextBuilder.build(fieldUtility);\n+        ConfigurationModel globalConfig = event.getChannelGlobalConfig()\n+                                              .orElseThrow(() -> new AlertRuntimeException(new AlertConfigurationException(\"Missing Jira Cloud global configuration\")));", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQwMzU0OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538403549", "bodyText": "Why not just throw the AlertRuntimeException with the error message?  The nested exception doesn't buy you anything.", "author": "psantos1113", "createdAt": "2020-12-08T14:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyNzc3MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538427770", "bodyText": "I created a Jira issue to resolve this. One reason for wrapping it is because the AlertConfigurationException is the correct exception to throw, so when someone comes to resolve this, they will have the correct alternative available.", "author": "gkillough", "createdAt": "2020-12-08T14:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2NzU3Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MzczNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537873736", "bodyText": "We shouldn't be creating this inline optional object to act as our if statement. I believe an if statement here would be much clearer", "author": "bamandel", "createdAt": "2020-12-07T22:15:01Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/msteams/MsTeamsChannel.java", "diffHunk": "@@ -59,8 +63,11 @@ public MsTeamsChannel(MsTeamsKey msTeamsKey, Gson gson, AuditAccessor auditAcces\n \n     @Override\n     public void distributeMessage(DistributionEvent event) throws IntegrationException {\n-        FieldUtility fields = event.getFieldUtility();\n-        String webhook = fields.getString(MsTeamsDescriptor.KEY_WEBHOOK)\n+        DistributionJobModel distributionJobModel = event.getDistributionJobModel();\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        MSTeamsJobDetailsModel asMSTeamsJobDetails = distributionJobDetails.getAsMSTeamsJobDetails();\n+        String webhook = Optional.ofNullable(asMSTeamsJobDetails.getWebhook())", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM4MjQyNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538382427", "bodyText": "I thought we as a team decided this was the preferred way to handle these cases?", "author": "gkillough", "createdAt": "2020-12-08T13:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MzczNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NDY1Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537874656", "bodyText": "This optional should be a ternary operator or an if statement.", "author": "bamandel", "createdAt": "2020-12-07T22:16:40Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/slack/parser/SlackChannelEventParser.java", "diffHunk": "@@ -76,7 +81,9 @@ public SlackChannelEventParser(SlackChannelMessageParser slackChannelMessagePars\n             throw new AlertFieldException(fieldErrors);\n         }\n \n-        String channelUsername = fields.getString(SlackDescriptor.KEY_CHANNEL_USERNAME).orElse(SLACK_DEFAULT_USERNAME);\n+        String channelUsername = Optional.ofNullable(slackJobDetails.getChannelUsername())\n+                                     .filter(StringUtils::isNotBlank)\n+                                     .orElse(SLACK_DEFAULT_USERNAME);", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzEzNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537877136", "bodyText": "This should be an if statement", "author": "bamandel", "createdAt": "2020-12-07T22:21:24Z", "path": "web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java", "diffHunk": "@@ -324,33 +325,56 @@ protected ValidationActionResponse validateWithoutChecks(JobFieldModel resource)\n     @Override\n     protected ValidationActionResponse testWithoutChecks(JobFieldModel resource) {\n         ValidationResponseModel responseModel;\n-        String id = resource.getJobId();\n+        String jobIdString = resource.getJobId();\n+        UUID jobId = Optional.ofNullable(jobIdString)\n+                         .filter(StringUtils::isNotBlank)\n+                         .map(UUID::fromString)\n+                         .orElse(null);", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java b/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\nindex b681a68fb..2641c3457 100644\n--- a/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\n+++ b/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\n\n@@ -362,7 +362,8 @@ public class JobConfigActions extends AbstractJobResourceActions {\n                                                                          .findFirst()\n                                                                          .orElse(null);\n \n-                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects()).orElse(List.of())\n+                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects())\n+                                                                                  .orElse(List.of())\n                                                                                   .stream()\n                                                                                   .map(jobProject -> new BlackDuckProjectDetailsModel(jobProject.getName(), jobProject.getHref()))\n                                                                                   .collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4MDU1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537880555", "bodyText": "Resource should return an empty list instead of null so we can process without checking for anything.", "author": "bamandel", "createdAt": "2020-12-07T22:26:58Z", "path": "web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java", "diffHunk": "@@ -324,33 +325,56 @@ protected ValidationActionResponse validateWithoutChecks(JobFieldModel resource)\n     @Override\n     protected ValidationActionResponse testWithoutChecks(JobFieldModel resource) {\n         ValidationResponseModel responseModel;\n-        String id = resource.getJobId();\n+        String jobIdString = resource.getJobId();\n+        UUID jobId = Optional.ofNullable(jobIdString)\n+                         .filter(StringUtils::isNotBlank)\n+                         .map(UUID::fromString)\n+                         .orElse(null);\n+\n         try {\n \n             Collection<FieldModel> otherJobModels = new LinkedList<>();\n             FieldModel channelFieldModel = getChannelFieldModelAndPopulateOtherJobModels(resource, otherJobModels);\n \n             if (null != channelFieldModel) {\n-                Optional<TestAction> testActionOptional = descriptorProcessor.retrieveTestAction(channelFieldModel);\n-                if (testActionOptional.isPresent()) {\n+                Optional<ChannelDistributionTestAction> optionalChannelDistributionTestAction = descriptorProcessor.retrieveChannelDistributionTestAction(channelFieldModel.getDescriptorName());\n+                if (optionalChannelDistributionTestAction.isPresent()) {\n+                    ChannelDistributionTestAction channelDistributionTestAction = optionalChannelDistributionTestAction.get();\n                     Map<String, ConfigurationFieldModel> fields = createFieldsMap(channelFieldModel, otherJobModels);\n                     // The custom message fields are not written to the database or defined fields in the database.  Need to manually add them.\n                     // TODO Create a mechanism to create the field accessor with a combination of fields in the database and fields that are not.\n                     Optional<ConfigurationFieldModel> topicField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_CUSTOM_TOPIC);\n                     Optional<ConfigurationFieldModel> messageField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_CUSTOM_MESSAGE);\n+                    Optional<ConfigurationFieldModel> destinationField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_DESTINATION_NAME);\n                     topicField.ifPresent(model -> fields.put(TestAction.KEY_CUSTOM_TOPIC, model));\n                     messageField.ifPresent(model -> fields.put(TestAction.KEY_CUSTOM_MESSAGE, model));\n-                    TestAction testAction = testActionOptional.get();\n-                    FieldUtility fieldUtility = new FieldUtility(fields);\n-                    String jobId = channelFieldModel.getId();\n+                    destinationField.ifPresent(model -> fields.put(TestAction.KEY_DESTINATION_NAME, model));\n \n-                    MessageResult providerTestResult = testProviderConfig(fieldUtility, jobId, channelFieldModel);\n+                    MessageResult providerTestResult = testProviderConfig(new FieldUtility(fields), jobIdString, channelFieldModel);\n                     if (providerTestResult.hasErrors()) {\n                         responseModel = ValidationResponseModel.fromStatusCollection(providerTestResult.getStatusMessage(), providerTestResult.getFieldStatuses());\n                         return new ValidationActionResponse(HttpStatus.OK, responseModel);\n                     }\n \n-                    MessageResult testActionResult = testAction.testConfig(jobId, channelFieldModel, fieldUtility);\n+                    // Not all channels have a global config\n+                    ConfigurationModel nullableChannelGlobalConfig = configurationAccessor.getConfigurationsByDescriptorNameAndContext(channelFieldModel.getDescriptorName(), ConfigContextEnum.GLOBAL)\n+                                                                         .stream()\n+                                                                         .findFirst()\n+                                                                         .orElse(null);\n+\n+                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects()).orElse(List.of())", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM4MzgzMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538383830", "bodyText": "resource is a REST API request-body, so this can absolutely be null.", "author": "gkillough", "createdAt": "2020-12-08T13:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4MDU1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java b/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\nindex b681a68fb..2641c3457 100644\n--- a/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\n+++ b/web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java\n\n@@ -362,7 +362,8 @@ public class JobConfigActions extends AbstractJobResourceActions {\n                                                                          .findFirst()\n                                                                          .orElse(null);\n \n-                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects()).orElse(List.of())\n+                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects())\n+                                                                                  .orElse(List.of())\n                                                                                   .stream()\n                                                                                   .map(jobProject -> new BlackDuckProjectDetailsModel(jobProject.getName(), jobProject.getHref()))\n                                                                                   .collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTAwMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537895002", "bodyText": "Im not sure what this comment means, I found an issue with 6.3.0 where the test discovers a certificate error but it does not make it to the UI because this is changing the response to an OK status. Please refer to #1289 to see the changes I would like to make in this area.", "author": "jamesrichard91", "createdAt": "2020-12-07T22:53:59Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java", "diffHunk": "@@ -194,6 +194,8 @@ public final ValidationActionResponse test(JobFieldModel resource) {\n             return ValidationActionResponse.createOKResponseWithContent(validationResponse);\n         }\n         ValidationActionResponse response = testWithoutChecks(resource);\n+        // FIXME this should only return OK if validation COMPLETED successfully (even\n+        //  if there are field errors), not if there were other types of errors unrelated to validation", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM4NDc5Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538384796", "bodyText": "I created a 6.5.0 Jira issue for this as well. I'll take a look at your PR.", "author": "gkillough", "createdAt": "2020-12-08T13:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM5MzczNg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538393736", "bodyText": "Your issue is different. This is addressing the fact that field-errors produce a 2xx response (which they should because the validation completed successfully), but errors during validation also result in a 2xx which they should not.", "author": "gkillough", "createdAt": "2020-12-08T13:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTAwMg=="}], "type": "inlineReview", "revised_code": {"commit": "c7c031e0efe7211261fb3ea2d80ca9bcf1be8e53", "chunk": "diff --git a/alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java b/alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java\nindex dddf8645a..215f1b54d 100644\n--- a/alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java\n+++ b/alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java\n\n@@ -193,10 +193,7 @@ public abstract class AbstractJobResourceActions {\n         if (validationResponse.isError()) {\n             return ValidationActionResponse.createOKResponseWithContent(validationResponse);\n         }\n-        ValidationActionResponse response = testWithoutChecks(resource);\n-        // FIXME this should only return OK if validation COMPLETED successfully (even\n-        //  if there are field errors), not if there were other types of errors unrelated to validation\n-        return ValidationActionResponse.createOKResponseWithContent(response);\n+        return testWithoutChecks(resource);\n     }\n \n     public final ValidationActionResponse validate(JobFieldModel resource) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTgwMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537895800", "bodyText": "Is this going to be done in this PR? or is there a Jira ticket to track this?", "author": "jamesrichard91", "createdAt": "2020-12-07T22:55:32Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/persistence/model/job/DistributionJobModelBuilder.java", "diffHunk": "@@ -53,6 +53,7 @@\n     private DistributionJobDetailsModel distributionJobDetails;\n \n     public DistributionJobModel build() {\n+        // TODO validate required fields are present", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQwMDI1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r538400255", "bodyText": "It will not be done in this PR because this is meant to have parity with the previous model which had no checks for completeness. I will create a Jira issue.", "author": "gkillough", "createdAt": "2020-12-08T13:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTgwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTE5OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537899198", "bodyText": "I don't think the ProviderProject's are database entities anymore, this should be updated to reflect that.", "author": "jamesrichard91", "createdAt": "2020-12-07T23:02:34Z", "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java", "diffHunk": "@@ -24,72 +24,68 @@\n \n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n \n import com.synopsys.integration.alert.channel.email.EmailAddressHandler;\n-import com.synopsys.integration.alert.channel.email.descriptor.EmailDescriptor;\n-import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n import com.synopsys.integration.alert.common.exception.AlertFieldException;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n import com.synopsys.integration.alert.common.persistence.accessor.ProviderDataAccessor;\n-import com.synopsys.integration.alert.common.persistence.model.ConfigurationFieldModel;\n import com.synopsys.integration.alert.common.persistence.model.ProviderProject;\n+import com.synopsys.integration.alert.common.persistence.model.job.BlackDuckProjectDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.DistributionJobDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.EmailJobDetailsModel;\n import com.synopsys.integration.exception.IntegrationException;\n \n @Component\n-public class EmailActionHelper {\n+public class EmailTestActionHelper {\n     private final EmailAddressHandler emailAddressHandler;\n     private final ProviderDataAccessor providerDataAccessor;\n \n-    public EmailActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n+    public EmailTestActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n         this.emailAddressHandler = emailAddressHandler;\n         this.providerDataAccessor = providerDataAccessor;\n     }\n \n-    public FieldUtility createUpdatedFieldAccessor(FieldUtility fieldUtility, String destination) throws IntegrationException {\n+    public Set<String> createUpdatedEmailAddresses(DistributionJobModel distributionJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> emailAddresses = new HashSet<>();\n         if (StringUtils.isNotBlank(destination)) {\n             emailAddresses.add(destination);\n         }\n \n-        boolean filterByProject = fieldUtility.getBooleanOrFalse(ProviderDistributionUIConfig.KEY_FILTER_BY_PROJECT);\n-        Long providerConfigId = fieldUtility.getLong(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID).orElse(null);\n-        boolean onlyAdditionalEmails = fieldUtility.getBooleanOrFalse(EmailDescriptor.KEY_EMAIL_ADDITIONAL_ADDRESSES_ONLY);\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        EmailJobDetailsModel emailJobDetails = distributionJobDetails.getAsEmailJobDetails();\n+\n+        Long providerConfigId = distributionJobModel.getBlackDuckGlobalConfigId();\n+        boolean onlyAdditionalEmails = emailJobDetails.isAdditionalEmailAddressesOnly();\n \n         if (null != providerConfigId && !onlyAdditionalEmails) {\n-            Set<ProviderProject> providerProjects = retrieveProviderProjects(fieldUtility, filterByProject, providerConfigId);\n-            if (null != providerProjects) {\n-                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, fieldUtility);\n+            Set<ProviderProject> providerProjects = retrieveProviderProjects(distributionJobModel, providerConfigId);\n+            if (null != providerProjects && !providerProjects.isEmpty()) {\n+                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, distributionJobModel, emailJobDetails);\n                 emailAddresses.addAll(providerEmailAddresses);\n             }\n         }\n-\n-        ConfigurationFieldModel configurationFieldModel = ConfigurationFieldModel.create(EmailDescriptor.KEY_EMAIL_ADDRESSES);\n-        configurationFieldModel.setFieldValues(emailAddresses);\n-\n-        Map<String, ConfigurationFieldModel> fields = fieldUtility.getFields();\n-        fields.put(EmailDescriptor.KEY_EMAIL_ADDRESSES, configurationFieldModel);\n-\n-        return new FieldUtility(fields);\n+        return emailAddresses;\n     }\n \n     private boolean doesProjectMatchConfiguration(String currentProjectName, String projectNamePattern, Set<String> configuredProjectNames) {\n         return currentProjectName.matches(projectNamePattern) || configuredProjectNames.contains(currentProjectName);\n     }\n \n-    private Set<ProviderProject> retrieveProviderProjects(FieldUtility fieldUtility, boolean filterByProject, Long providerConfigId) {\n+    private Set<ProviderProject> retrieveProviderProjects(DistributionJobModel distributionJobModel, Long providerConfigId) {\n         List<ProviderProject> providerProjects = providerDataAccessor.getProjectsByProviderConfigId(providerConfigId);\n-        if (filterByProject) {\n-            Optional<ConfigurationFieldModel> projectField = fieldUtility.getField(ProviderDistributionUIConfig.KEY_CONFIGURED_PROJECT);\n-            Set<String> configuredProjects = new HashSet<>(projectField.map(ConfigurationFieldModel::getFieldValues).orElse(Set.of()));\n-            String projectNamePattern = fieldUtility.getStringOrEmpty(ProviderDistributionUIConfig.KEY_PROJECT_NAME_PATTERN);\n+        if (distributionJobModel.isFilterByProject()) {\n+            Set<String> configuredProjects = distributionJobModel.getProjectFilterDetails()\n+                                                 .stream()\n+                                                 .map(BlackDuckProjectDetailsModel::getName)\n+                                                 .collect(Collectors.toSet());\n+            String projectNamePattern = distributionJobModel.getProjectNamePattern().orElse(\"\");\n             return providerProjects\n                        .stream()\n                        .filter(databaseEntity -> doesProjectMatchConfiguration(databaseEntity.getName(), projectNamePattern, configuredProjects))", "originalCommit": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b180418e25f4d95d095be8509e86a0c1afb79df", "chunk": "diff --git a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\nindex 321a506f8..c499a55bb 100644\n--- a/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\n+++ b/channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java\n\n@@ -27,6 +27,7 @@ import java.util.List;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n"}}, {"oid": "5b180418e25f4d95d095be8509e86a0c1afb79df", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5b180418e25f4d95d095be8509e86a0c1afb79df", "message": "Fix: Clean up null-checks", "committedDate": "2020-12-08T13:59:49Z", "type": "commit"}, {"oid": "4b35875ce36afe030474263481158dc2d30d7786", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/4b35875ce36afe030474263481158dc2d30d7786", "message": "Merge branch 'master' into gk_update_notification_processor", "committedDate": "2020-12-08T15:41:41Z", "type": "commit"}, {"oid": "c7c031e0efe7211261fb3ea2d80ca9bcf1be8e53", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/c7c031e0efe7211261fb3ea2d80ca9bcf1be8e53", "message": "Merge branch 'master' into gk_update_notification_processor", "committedDate": "2020-12-08T18:40:35Z", "type": "commit"}, {"oid": "8cb85ef04ee6407486187a64fbf0236436c39f1e", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8cb85ef04ee6407486187a64fbf0236436c39f1e", "message": "Merge branch 'master' into gk_update_notification_processor", "committedDate": "2020-12-08T18:41:03Z", "type": "commit"}, {"oid": "e51184652c66632aef69e1f144f43adce1c615f5", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/e51184652c66632aef69e1f144f43adce1c615f5", "message": "Merge branch 'master' into gk_update_notification_processor", "committedDate": "2020-12-08T20:03:18Z", "type": "commit"}]}