{"pr_number": 1002, "pr_title": "Add repository flush call to save method.", "pr_createdAt": "2020-06-03T13:56:13Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1002", "timeline": [{"oid": "fe95d6563fb728d1932ff7e7f7cde707bc547b78", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/fe95d6563fb728d1932ff7e7f7cde707bc547b78", "message": "fix: Add repository flush call to save method.", "committedDate": "2020-06-03T11:52:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU4OTQ3NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1002#discussion_r434589475", "bodyText": "Can we also add a TODO to move the event sending out of the database api?", "author": "gkillough", "createdAt": "2020-06-03T14:00:23Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -89,6 +89,7 @@ public DefaultNotificationManager(NotificationContentRepository notificationCont\n                                                        .stream()\n                                                        .map(this::toModel)\n                                                        .collect(Collectors.toList());\n+        notificationContentRepository.flush();", "originalCommit": "fe95d6563fb728d1932ff7e7f7cde707bc547b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU5MjQ0OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1002#discussion_r434592449", "bodyText": "I agree with Gavin, EventManager should be pulled out of the the NotificationManager. That would allow the transaction to save the notifications to complete before sending the events and would remove the need for the flush. But that can be done as a future improvement.", "author": "jamesrichard91", "createdAt": "2020-06-03T14:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU4OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NDYyOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1002#discussion_r434664628", "bodyText": "I added the TODO.  This morning I tried refactoring the NotificationManager to refactor the transaction boundaries.  But that wasn't working so I opted for the simple approach for now.  This should be refactored in the future.", "author": "psantos1113", "createdAt": "2020-06-03T15:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU4OTQ3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "7582e63d58077bc6058886f6c458307f2d4b5a8f", "chunk": "diff --git a/alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java b/alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java\nindex 1ccaf5be3..c9dcf6b4a 100644\n--- a/alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java\n+++ b/alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java\n\n@@ -90,7 +90,7 @@ public class DefaultNotificationManager implements NotificationManager {\n                                                        .map(this::toModel)\n                                                        .collect(Collectors.toList());\n         notificationContentRepository.flush();\n-\n+        // TODO move this sendEvent call out of this class.  We can then remove the flush call since the save will be in a transaction.\n         if (!savedModels.isEmpty()) {\n             List<Long> notificationIds = savedModels.stream()\n                                              .map(AlertNotificationModel::getId)\n"}}, {"oid": "7582e63d58077bc6058886f6c458307f2d4b5a8f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7582e63d58077bc6058886f6c458307f2d4b5a8f", "message": "chore: Add a todo comment to refactor in the future.", "committedDate": "2020-06-03T14:10:44Z", "type": "commit"}]}