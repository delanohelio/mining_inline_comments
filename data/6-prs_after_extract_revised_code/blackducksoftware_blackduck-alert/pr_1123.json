{"pr_number": 1123, "pr_title": "Add validator for OAuth ", "pr_createdAt": "2020-08-20T16:27:04Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123", "timeline": [{"oid": "096db4b18ed6ccdf4c646ee0d14f1e05d83df18c", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/096db4b18ed6ccdf4c646ee0d14f1e05d83df18c", "message": "feat: Add validator for OAuth but need the common response objects to contain field status.", "committedDate": "2020-08-20T16:21:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIyNzI2Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474227266", "bodyText": "Incomplete sentence?", "author": "bamandel", "createdAt": "2020-08-20T19:38:38Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/AzureRedirectUtil.java", "diffHunk": "@@ -38,6 +38,10 @@ public AzureRedirectUtil(AlertProperties alertProperties) {\n         this.alertProperties = alertProperties;\n     }\n \n+    /**\n+     * The OAuth callback controller will redirect back to the Alert UI and is the only place where this method.", "originalCommit": "096db4b18ed6ccdf4c646ee0d14f1e05d83df18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0MDc4Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474240786", "bodyText": "Thanks I will add that in.", "author": "psantos1113", "createdAt": "2020-08-20T20:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIyNzI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "21178530880d3abcc751afd429caa915e522a231", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/AzureRedirectUtil.java b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/AzureRedirectUtil.java\nindex 45c780fa2..715fccdcd 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/AzureRedirectUtil.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/AzureRedirectUtil.java\n\n@@ -39,8 +39,11 @@ public class AzureRedirectUtil {\n     }\n \n     /**\n-     * The OAuth callback controller will redirect back to the Alert UI and is the only place where this method.\n+     * The OAuth callback controller will redirect back to the Alert UI.\n+     * Only the callback controller should use this method.  All other requests for redirect URIs should use the\n+     * createOAuthRedirectUri method.\n      * @return The url location to redirect to the UI.\n+     * @see #createOAuthRedirectUri()\n      */\n     public String createUIRedirectLocation() {\n         StringBuilder locationBuilder = new StringBuilder(200);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzMjY3Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474232672", "bodyText": "is/will this method be used? I'm not really sure what the point of it is.", "author": "bamandel", "createdAt": "2020-08-20T19:46:00Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.azure.boards.oauth;\n+\n+import java.net.Proxy;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.channel.azure.boards.AzureRedirectUtil;\n+import com.synopsys.integration.alert.channel.azure.boards.oauth.storage.AzureBoardsCredentialDataStoreFactory;\n+import com.synopsys.integration.alert.channel.azure.boards.service.AzureBoardsProperties;\n+import com.synopsys.integration.alert.common.descriptor.config.field.validators.ConfigValidationFunction;\n+import com.synopsys.integration.alert.common.descriptor.config.field.validators.ValidationResult;\n+import com.synopsys.integration.alert.common.persistence.accessor.FieldAccessor;\n+import com.synopsys.integration.alert.common.persistence.util.ConfigurationFieldModelConverter;\n+import com.synopsys.integration.alert.common.rest.ProxyManager;\n+import com.synopsys.integration.alert.common.rest.model.FieldModel;\n+import com.synopsys.integration.alert.common.rest.model.FieldValueModel;\n+\n+@Component\n+public class AzureOAuthTokenValidator implements ConfigValidationFunction {\n+    private final AzureRedirectUtil azureRedirectUtil;\n+    private final AzureBoardsCredentialDataStoreFactory azureBoardsCredentialDataStoreFactory;\n+    private final ConfigurationFieldModelConverter configurationFieldModelConverter;\n+    private final ProxyManager proxyManager;\n+\n+    @Autowired\n+    public AzureOAuthTokenValidator(AzureRedirectUtil azureRedirectUtil, AzureBoardsCredentialDataStoreFactory azureBoardsCredentialDataStoreFactory,\n+        ConfigurationFieldModelConverter configurationFieldModelConverter, ProxyManager proxyManager) {\n+        this.azureRedirectUtil = azureRedirectUtil;\n+        this.azureBoardsCredentialDataStoreFactory = azureBoardsCredentialDataStoreFactory;\n+        this.configurationFieldModelConverter = configurationFieldModelConverter;\n+        this.proxyManager = proxyManager;\n+    }\n+\n+    public ValidationResult validate(FieldValueModel fieldValueModel, FieldModel fieldModel) {", "originalCommit": "096db4b18ed6ccdf4c646ee0d14f1e05d83df18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0MDQ0OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474240448", "bodyText": "I can remove it now that I've figured out the circular dependency issue.", "author": "psantos1113", "createdAt": "2020-08-20T20:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzMjY3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "21178530880d3abcc751afd429caa915e522a231", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\nindex e66ac5947..47ac384d0 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\n\n@@ -54,10 +54,6 @@ public class AzureOAuthTokenValidator implements ConfigValidationFunction {\n         this.proxyManager = proxyManager;\n     }\n \n-    public ValidationResult validate(FieldValueModel fieldValueModel, FieldModel fieldModel) {\n-        return this.apply(fieldValueModel, fieldModel);\n-    }\n-\n     @Override\n     public ValidationResult apply(FieldValueModel fieldValueModel, FieldModel fieldModel) {\n         ValidationResult result = ValidationResult.success();\n"}}, {"oid": "21178530880d3abcc751afd429caa915e522a231", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/21178530880d3abcc751afd429caa915e522a231", "message": "refactor: Implemented PR feedback.", "committedDate": "2020-08-21T11:44:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY1MjM1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474652355", "bodyText": "What are your thoughts on automatically saving whatever is in the config fields before redirecting to the Microsoft OAuth Login? When the button is pressed, if the current config is valid and no OAuth config already exists, we save.", "author": "gkillough", "createdAt": "2020-08-21T12:00:05Z", "path": "src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.channel.azure.boards.oauth;\n+\n+import java.net.Proxy;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.channel.azure.boards.AzureRedirectUtil;\n+import com.synopsys.integration.alert.channel.azure.boards.oauth.storage.AzureBoardsCredentialDataStoreFactory;\n+import com.synopsys.integration.alert.channel.azure.boards.service.AzureBoardsProperties;\n+import com.synopsys.integration.alert.common.descriptor.config.field.validators.ConfigValidationFunction;\n+import com.synopsys.integration.alert.common.descriptor.config.field.validators.ValidationResult;\n+import com.synopsys.integration.alert.common.persistence.accessor.FieldAccessor;\n+import com.synopsys.integration.alert.common.persistence.util.ConfigurationFieldModelConverter;\n+import com.synopsys.integration.alert.common.rest.ProxyManager;\n+import com.synopsys.integration.alert.common.rest.model.FieldModel;\n+import com.synopsys.integration.alert.common.rest.model.FieldValueModel;\n+\n+@Component\n+public class AzureOAuthTokenValidator implements ConfigValidationFunction {\n+    private final AzureRedirectUtil azureRedirectUtil;\n+    private final AzureBoardsCredentialDataStoreFactory azureBoardsCredentialDataStoreFactory;\n+    private final ConfigurationFieldModelConverter configurationFieldModelConverter;\n+    private final ProxyManager proxyManager;\n+\n+    @Autowired\n+    public AzureOAuthTokenValidator(AzureRedirectUtil azureRedirectUtil, AzureBoardsCredentialDataStoreFactory azureBoardsCredentialDataStoreFactory,\n+        ConfigurationFieldModelConverter configurationFieldModelConverter, ProxyManager proxyManager) {\n+        this.azureRedirectUtil = azureRedirectUtil;\n+        this.azureBoardsCredentialDataStoreFactory = azureBoardsCredentialDataStoreFactory;\n+        this.configurationFieldModelConverter = configurationFieldModelConverter;\n+        this.proxyManager = proxyManager;\n+    }\n+\n+    @Override\n+    public ValidationResult apply(FieldValueModel fieldValueModel, FieldModel fieldModel) {\n+        ValidationResult result = ValidationResult.success();\n+        try {\n+            Proxy proxy = proxyManager.createProxy();\n+            FieldAccessor fieldAccessor = configurationFieldModelConverter.convertToFieldAccessor(fieldModel);\n+            String oAuthRedirectUri = azureRedirectUtil.createOAuthRedirectUri();\n+            AzureBoardsProperties properties = AzureBoardsProperties.fromFieldAccessor(azureBoardsCredentialDataStoreFactory, oAuthRedirectUri, fieldAccessor);\n+            if (!properties.hasOAuthCredentials(proxy)) {\n+                result = ValidationResult.warnings(\"OAuth token credentials missing. Please save then authenticate.\");", "originalCommit": "21178530880d3abcc751afd429caa915e522a231", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMTc5OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1123#discussion_r474821798", "bodyText": "I'll add this to the 6.2.0 branch to save when authenticate is pushed.", "author": "psantos1113", "createdAt": "2020-08-21T17:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY1MjM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a6ba5b28c68e8b89b5f9363d4045fd7bc0050e8b", "chunk": "diff --git a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\nindex 47ac384d0..e708579a9 100644\n--- a/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\n+++ b/src/main/java/com/synopsys/integration/alert/channel/azure/boards/oauth/AzureOAuthTokenValidator.java\n\n@@ -22,8 +22,6 @@\n  */\n package com.synopsys.integration.alert.channel.azure.boards.oauth;\n \n-import java.net.Proxy;\n-\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n"}}, {"oid": "a6ba5b28c68e8b89b5f9363d4045fd7bc0050e8b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a6ba5b28c68e8b89b5f9363d4045fd7bc0050e8b", "message": "Merge remote-tracking branch 'origin/master' into ps_oauth_authenticator", "committedDate": "2020-08-24T12:16:35Z", "type": "commit"}]}