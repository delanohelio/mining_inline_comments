{"pr_number": 3486, "pr_title": "[KOGITO-2515] DMN Editor decision service wrong layout", "pr_createdAt": "2020-11-16T18:04:49Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3486", "timeline": [{"oid": "00f99e85edf819fc187763060e7ab5051e2386bb", "url": "https://github.com/kiegroup/kie-wb-common/commit/00f99e85edf819fc187763060e7ab5051e2386bb", "message": "Add integration test (prevent KOGITO-2515 regression)", "committedDate": "2020-11-17T12:25:30Z", "type": "forcePushed"}, {"oid": "8eb5e54e21f71db20a463ee3e5660c96153b037b", "url": "https://github.com/kiegroup/kie-wb-common/commit/8eb5e54e21f71db20a463ee3e5660c96153b037b", "message": "Add integration test (prevent KOGITO-2515 regression)", "committedDate": "2020-11-18T12:24:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMDU0NA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528720544", "bodyText": "I think this import is not used.", "author": "jomarko", "createdAt": "2020-11-23T13:57:25Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java", "diffHunk": "@@ -17,6 +17,7 @@\n package org.kie.workbench.common.dmn.client.marshaller.unmarshall.nodes;\n \n import java.util.ArrayList;\n+import java.util.Comparator;", "originalCommit": "8eb5e54e21f71db20a463ee3e5660c96153b037b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9fa90df963286b5c19b4dc13309932ae253ac4f8", "chunk": "diff --git a/kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java b/kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java\nindex 4e4170e47b..a22a18b08c 100644\n--- a/kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java\n+++ b/kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java\n\n@@ -17,7 +17,6 @@\n package org.kie.workbench.common.dmn.client.marshaller.unmarshall.nodes;\n \n import java.util.ArrayList;\n-import java.util.Comparator;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTc1OQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528721759", "bodyText": "shouldn't we return 1 just in case !JSITDecisionService.instanceOf(n1.getDmnElement()) && JSITDecisionService.instanceOf(n2.getDmnElement()) ?", "author": "jomarko", "createdAt": "2020-11-23T13:59:24Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-client/src/main/java/org/kie/workbench/common/dmn/client/marshaller/unmarshall/nodes/NodeEntriesFactory.java", "diffHunk": "@@ -76,6 +78,18 @@ public NodeEntriesFactory(final StunnerConverter nodeFactory,\n                 .withComponentWidthsConsumer(componentWidthsConsumer)\n                 .buildEntries();\n \n+        // We need to put all the Decision Services at the begin of the list otherwise the nodes inside\n+        // those Decision Services will not be correctly positioned since its parents (the Decision Services nodes)\n+        // needs to be positioned first.\n+        nodeEntries.sort((n1, n2) -> {\n+            if (JSITDecisionService.instanceOf(n1.getDmnElement())) {\n+                return -1;\n+            } else if (JSITDecisionService.instanceOf(n2.getDmnElement())){\n+                return 1;", "originalCommit": "8eb5e54e21f71db20a463ee3e5660c96153b037b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg1NTQxMQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528855411", "bodyText": "Isn't this the case? the first condition \"eats\" all the cases except of !JSITDecisionService.instanceOf(n1.getDmnElement()) and then the else if condition then serves as logical AND. So in effect we return 1 in just exactly the case you mention. Or am I missing sth?", "author": "jstastny-cz", "createdAt": "2020-11-23T16:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3MjMyNg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528972326", "bodyText": "Hi, @jomarko ! Very good to see you back again! \\o/\nThere's an else if so the 1 is only returned if the n1.getDmnElement() is not an instance of JSITDecisionService and n2.getDmnElement() is an instance of JSITDecisionService.\nIt looks right for me.", "author": "danielzhe", "createdAt": "2020-11-23T20:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTc1OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMzg3Mg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528723872", "bodyText": "shouldn't these resources contain more DecisionService nodes so we check NodeEntriesFactory changes more complexly ?", "author": "jomarko", "createdAt": "2020-11-23T14:02:47Z", "path": "kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-runtime/src/test/java/org/kie/workbench/common/dmn/showcase/client/selenium/DMNDesignerKogitoSeleniumIT.java", "diffHunk": "@@ -1745,6 +1745,25 @@ public void testDMNModelWithoutDMNDI_KOGITO3696() throws Exception {\n                 .areIdentical();\n     }\n \n+    @Test\n+    public void testDecisionServiceWrongLayout_KOGITO2515() throws Exception {\n+        final String expected = loadResource(\"KOGITO-2515 (DMN model with decision services - expected).xml\");\n+        final String fixture = loadResource(\"KOGITO-2515 (DMN model with decision services - fixture).xml\");", "originalCommit": "8eb5e54e21f71db20a463ee3e5660c96153b037b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3MjkxOQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3486#discussion_r528972919", "bodyText": "In my opinion the tests are good, because the issue is only the order of the DecisionService in the XML node. Doesn't really matter if the DecisionService is too complex or not.", "author": "danielzhe", "createdAt": "2020-11-23T20:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMzg3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "ca598542452c884c04182035e0905636d7098043", "chunk": "diff --git a/kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-runtime/src/test/java/org/kie/workbench/common/dmn/showcase/client/selenium/DMNDesignerKogitoSeleniumIT.java b/kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-runtime/src/test/java/org/kie/workbench/common/dmn/showcase/client/selenium/DMNDesignerKogitoSeleniumIT.java\nindex eabfc05422..0a0826dea6 100644\n--- a/kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-runtime/src/test/java/org/kie/workbench/common/dmn/showcase/client/selenium/DMNDesignerKogitoSeleniumIT.java\n+++ b/kie-wb-common-dmn/kie-wb-common-dmn-webapp-kogito-runtime/src/test/java/org/kie/workbench/common/dmn/showcase/client/selenium/DMNDesignerKogitoSeleniumIT.java\n\n@@ -1745,25 +1745,6 @@ public class DMNDesignerKogitoSeleniumIT extends DMNDesignerBaseIT {\n                 .areIdentical();\n     }\n \n-    @Test\n-    public void testDecisionServiceWrongLayout_KOGITO2515() throws Exception {\n-        final String expected = loadResource(\"KOGITO-2515 (DMN model with decision services - expected).xml\");\n-        final String fixture = loadResource(\"KOGITO-2515 (DMN model with decision services - fixture).xml\");\n-        final List<String> ignoredAttributes = asList(\"id\", \"dmnElementRef\", \"href\");\n-\n-        setContent(fixture);\n-\n-        final String actual = getContent();\n-        assertThat(actual).isNotBlank();\n-\n-        XmlAssert.assertThat(actual)\n-                .and(expected)\n-                .ignoreComments()\n-                .ignoreWhitespace()\n-                .withAttributeFilter(attr -> !ignoredAttributes.contains(attr.getName()))\n-                .areIdentical();\n-    }\n-\n     @Test\n     public void testDecisionTableInputClauseConstraints_KOGITO369() throws Exception {\n         final String expected = loadResource(\"KOGITO-369 (Decision Table Input Clause constraints).xml\");\n"}}, {"oid": "9fa90df963286b5c19b4dc13309932ae253ac4f8", "url": "https://github.com/kiegroup/kie-wb-common/commit/9fa90df963286b5c19b4dc13309932ae253ac4f8", "message": "code style", "committedDate": "2020-11-23T20:23:46Z", "type": "forcePushed"}, {"oid": "e3211fbb8599cbc198720aa680bc35c522ead443", "url": "https://github.com/kiegroup/kie-wb-common/commit/e3211fbb8599cbc198720aa680bc35c522ead443", "message": "code style", "committedDate": "2020-11-24T11:20:44Z", "type": "forcePushed"}, {"oid": "ca598542452c884c04182035e0905636d7098043", "url": "https://github.com/kiegroup/kie-wb-common/commit/ca598542452c884c04182035e0905636d7098043", "message": "KOGITO-2515: DMN Editor decision service wrong layout", "committedDate": "2020-11-25T13:29:11Z", "type": "commit"}, {"oid": "46e4168c250507772f6f155af7f62404cf624664", "url": "https://github.com/kiegroup/kie-wb-common/commit/46e4168c250507772f6f155af7f62404cf624664", "message": "Add integration test (prevent KOGITO-2515 regression)", "committedDate": "2020-11-25T13:29:11Z", "type": "commit"}, {"oid": "60cfd4fd8e401992fa45ca430ba5fe81984a63e6", "url": "https://github.com/kiegroup/kie-wb-common/commit/60cfd4fd8e401992fa45ca430ba5fe81984a63e6", "message": "code style", "committedDate": "2020-11-25T13:29:11Z", "type": "commit"}, {"oid": "e43a75a61e8038fa27715a5356babbb1558158b5", "url": "https://github.com/kiegroup/kie-wb-common/commit/e43a75a61e8038fa27715a5356babbb1558158b5", "message": "Models updated to the new Decision Service nodes order.", "committedDate": "2020-11-25T20:44:49Z", "type": "commit"}, {"oid": "e43a75a61e8038fa27715a5356babbb1558158b5", "url": "https://github.com/kiegroup/kie-wb-common/commit/e43a75a61e8038fa27715a5356babbb1558158b5", "message": "Models updated to the new Decision Service nodes order.", "committedDate": "2020-11-25T20:44:49Z", "type": "forcePushed"}]}