{"pr_number": 467, "pr_title": "Support RSA-PSS Signature scheme", "pr_createdAt": "2020-04-02T15:05:22Z", "pr_url": "https://github.com/dogtagpki/jss/pull/467", "timeline": [{"oid": "b1191fc011dde08bcc9093743669a8404a7cc2e7", "url": "https://github.com/dogtagpki/jss/commit/b1191fc011dde08bcc9093743669a8404a7cc2e7", "message": "Refactor JCASigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-02T15:29:28Z", "type": "forcePushed"}, {"oid": "8eda7bd9324cd02fea1d32b5182972b4f9db1657", "url": "https://github.com/dogtagpki/jss/commit/8eda7bd9324cd02fea1d32b5182972b4f9db1657", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-02T16:33:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MjQ5NA==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402452494", "bodyText": "@jmagne While this is still fresh, do you have better descriptions here? I'm not sure I've fully grasped this DER decoding business here and its relevance.\nThis applies to lines 148 also.", "author": "cipherboy", "createdAt": "2020-04-02T16:37:03Z", "path": "org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.jss.provider.java.security;\n+\n+import java.security.*;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.security.spec.PSSParameterSpec;\n+import java.security.spec.MGF1ParameterSpec;\n+import java.io.IOException;\n+import org.mozilla.jss.util.Assert;\n+import org.mozilla.jss.netscape.security.util.BigInt;\n+import org.mozilla.jss.netscape.security.x509.AlgorithmId;\n+import org.mozilla.jss.netscape.security.util.DerOutputStream;\n+import org.mozilla.jss.netscape.security.util.DerInputStream;\n+import org.mozilla.jss.netscape.security.util.DerValue;\n+import org.mozilla.jss.netscape.security.util.ObjectIdentifier;\n+import org.mozilla.jss.asn1.ASN1Template;\n+import org.mozilla.jss.asn1.ASN1Value;\n+import org.mozilla.jss.asn1.INTEGER;\n+import org.mozilla.jss.asn1.InvalidBERException;\n+import org.mozilla.jss.asn1.OBJECT_IDENTIFIER;\n+import org.mozilla.jss.asn1.OCTET_STRING;\n+import org.mozilla.jss.asn1.SEQUENCE;\n+import org.mozilla.jss.asn1.Tag;\n+\n+/**\n+ * A RSAPSSAlgorithmParameter implements the trandcoding between a\n+ * PSSAlgorithmSpec instance and the DER-encoded form.\n+ *\n+ * RSASSA-PSS-params ::= SEQUENCE {\n+ *  hashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\n+ * maskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\n+ * saltLength         [2] INTEGER  DEFAULT 20,\n+ *  trailerField       [3] INTEGER  DEFAULT 1\n+ * }\n+ *\n+ * where\n+ *\n+ *  OAEP-PSSDigestAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-sha1 PARAMETERS NULL   }|\n+ *    { OID id-sha224 PARAMETERS NULL   }|\n+ *    { OID id-sha256 PARAMETERS NULL }|\n+ *    { OID id-sha384 PARAMETERS NULL }|\n+ *    { OID id-sha512 PARAMETERS NULL },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ *\n+ *  PKCS1MGFAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-mgf1 PARAMETERS OAEP-PSSDigestAlgorithms },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ */\n+public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n+    public final static AlgorithmId defaultHashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+    public final static AlgorithmId defaultMaskGenFunc  = new AlgorithmId(AlgorithmId.MGF1_oid);\n+    public final static BigInt          defaultSaltLen = new BigInt(20);\n+    public final static BigInt          defaultTrailerField = new BigInt(1);\n+\n+    private PSSParameterSpec spec = PSSParameterSpec.DEFAULT;\n+    private AlgorithmId hashAlg = defaultHashAlg;\n+    private AlgorithmId maskGenFunc = defaultMaskGenFunc;\n+    private BigInt saltLen = defaultSaltLen;\n+    private BigInt trailerField = defaultTrailerField;\n+\n+    public RSAPSSAlgorithmParameters() {}\n+\n+    @Override\n+    protected void engineInit(AlgorithmParameterSpec paramSpec)\n+            throws InvalidParameterSpecException {\n+        spec = (PSSParameterSpec) paramSpec;\n+        populateFromSpec();\n+    }\n+\n+    @Override\n+    protected <T extends AlgorithmParameterSpec> T engineGetParameterSpec(Class<T> paramSpec)\n+            throws InvalidParameterSpecException  {\n+        if (paramSpec.isAssignableFrom(PSSParameterSpec.class)) {\n+            return paramSpec.cast(spec);\n+        }\n+\n+        throw new InvalidParameterSpecException(\"Unknown parameter spec passed to PSS parameters object: \" + paramSpec.getName());\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params) throws IOException {\n+        decode(new DerInputStream(params), params);\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params, String format) throws IOException {\n+        // Assume Der for now.\n+        Assert.notReached(\"engineInit(byte[],String) not supported\");\n+        throw new IOException(\"engineInit(byte[],String) not supported\");\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded() throws IOException {\n+        DerOutputStream out = new DerOutputStream();\n+        encode(out);\n+        return out.toByteArray();\n+\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded(String format) throws IOException {\n+        //Assume Der for now.\n+        Assert.notReached(\"engineGetEncoded(String format)) not supported\");\n+        throw new IOException(\"engineGetEncoded(String format)) not supported\");\n+    }\n+\n+    @Override\n+    protected String engineToString() {\n+        String str = new String(\"Mozilla-JSS PSSAlgorithmParameters \" +  getClass().getName() + \" HashAlg: \" + spec.getDigestAlgorithm() + \" MaskGenAlg: \" + spec.getMGFAlgorithm() );\n+        return str;\n+    }\n+\n+    private void decode(DerInputStream in , byte[] encoded) throws IOException {\n+        if (in == null) {\n+            throw new IOException(\"Invalid input: got null DerInputStream\");\n+        }\n+\n+        // Sequence has 3 members, trailer field ignored\n+        DerValue seq[] = in.getSequence(3);\n+        if (seq.length != 3) {\n+            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        }\n+\n+        if (seq[0].isContextSpecific((byte)0)) {\n+            seq[0] = seq[0].data.getDerValue();\n+        } else {\n+             throw new IOException(\"Invalid encoded data!\");", "originalCommit": "8eda7bd9324cd02fea1d32b5182972b4f9db1657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NDc0OA==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402684748", "bodyText": "OK this context stuff has to do with the sequence of this thing, here is the blob again:\nRSASSA-PSS-params ::= SEQUENCE {\nhashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\nmaskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\nsaltLength         [2] INTEGER  DEFAULT 20,\ntrailerField       [3] INTEGER  DEFAULT 1\nSee, the 0,1,2, and 3 ?? This stuff goes into the encoding and is read out when decoding.. It took me many failures of constructing a legal blob before I looked into the context tags like here...", "author": "jmagne", "createdAt": "2020-04-03T01:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MjQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "chunk": "diff --git a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\nindex 0184c661..ff089534 100644\n--- a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n+++ b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n\n@@ -124,14 +124,14 @@ public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n \n         // Sequence has 3 members, trailer field ignored\n         DerValue seq[] = in.getSequence(3);\n-        if (seq.length != 3) {\n-            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        if (seq.length < 3 || seq.length > 4) {\n+            throw new IOException(\"Invalid data! Expected a sequence with either 3 or 4 members; got \" + seq.length);\n         }\n \n         if (seq[0].isContextSpecific((byte)0)) {\n             seq[0] = seq[0].data.getDerValue();\n         } else {\n-             throw new IOException(\"Invalid encoded data!\");\n+             throw new IOException(\"Invalid encoded data! Expecting OAEP-PSSDigestAlgorithms (hashAlgorithm).\");\n         }\n \n         AlgorithmId algid = AlgorithmId.parse(seq[0]);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MjYwOQ==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402452609", "bodyText": "of exactly 3 members.", "author": "cipherboy", "createdAt": "2020-04-02T16:37:14Z", "path": "org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.jss.provider.java.security;\n+\n+import java.security.*;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.security.spec.PSSParameterSpec;\n+import java.security.spec.MGF1ParameterSpec;\n+import java.io.IOException;\n+import org.mozilla.jss.util.Assert;\n+import org.mozilla.jss.netscape.security.util.BigInt;\n+import org.mozilla.jss.netscape.security.x509.AlgorithmId;\n+import org.mozilla.jss.netscape.security.util.DerOutputStream;\n+import org.mozilla.jss.netscape.security.util.DerInputStream;\n+import org.mozilla.jss.netscape.security.util.DerValue;\n+import org.mozilla.jss.netscape.security.util.ObjectIdentifier;\n+import org.mozilla.jss.asn1.ASN1Template;\n+import org.mozilla.jss.asn1.ASN1Value;\n+import org.mozilla.jss.asn1.INTEGER;\n+import org.mozilla.jss.asn1.InvalidBERException;\n+import org.mozilla.jss.asn1.OBJECT_IDENTIFIER;\n+import org.mozilla.jss.asn1.OCTET_STRING;\n+import org.mozilla.jss.asn1.SEQUENCE;\n+import org.mozilla.jss.asn1.Tag;\n+\n+/**\n+ * A RSAPSSAlgorithmParameter implements the trandcoding between a\n+ * PSSAlgorithmSpec instance and the DER-encoded form.\n+ *\n+ * RSASSA-PSS-params ::= SEQUENCE {\n+ *  hashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\n+ * maskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\n+ * saltLength         [2] INTEGER  DEFAULT 20,\n+ *  trailerField       [3] INTEGER  DEFAULT 1\n+ * }\n+ *\n+ * where\n+ *\n+ *  OAEP-PSSDigestAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-sha1 PARAMETERS NULL   }|\n+ *    { OID id-sha224 PARAMETERS NULL   }|\n+ *    { OID id-sha256 PARAMETERS NULL }|\n+ *    { OID id-sha384 PARAMETERS NULL }|\n+ *    { OID id-sha512 PARAMETERS NULL },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ *\n+ *  PKCS1MGFAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-mgf1 PARAMETERS OAEP-PSSDigestAlgorithms },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ */\n+public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n+    public final static AlgorithmId defaultHashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+    public final static AlgorithmId defaultMaskGenFunc  = new AlgorithmId(AlgorithmId.MGF1_oid);\n+    public final static BigInt          defaultSaltLen = new BigInt(20);\n+    public final static BigInt          defaultTrailerField = new BigInt(1);\n+\n+    private PSSParameterSpec spec = PSSParameterSpec.DEFAULT;\n+    private AlgorithmId hashAlg = defaultHashAlg;\n+    private AlgorithmId maskGenFunc = defaultMaskGenFunc;\n+    private BigInt saltLen = defaultSaltLen;\n+    private BigInt trailerField = defaultTrailerField;\n+\n+    public RSAPSSAlgorithmParameters() {}\n+\n+    @Override\n+    protected void engineInit(AlgorithmParameterSpec paramSpec)\n+            throws InvalidParameterSpecException {\n+        spec = (PSSParameterSpec) paramSpec;\n+        populateFromSpec();\n+    }\n+\n+    @Override\n+    protected <T extends AlgorithmParameterSpec> T engineGetParameterSpec(Class<T> paramSpec)\n+            throws InvalidParameterSpecException  {\n+        if (paramSpec.isAssignableFrom(PSSParameterSpec.class)) {\n+            return paramSpec.cast(spec);\n+        }\n+\n+        throw new InvalidParameterSpecException(\"Unknown parameter spec passed to PSS parameters object: \" + paramSpec.getName());\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params) throws IOException {\n+        decode(new DerInputStream(params), params);\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params, String format) throws IOException {\n+        // Assume Der for now.\n+        Assert.notReached(\"engineInit(byte[],String) not supported\");\n+        throw new IOException(\"engineInit(byte[],String) not supported\");\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded() throws IOException {\n+        DerOutputStream out = new DerOutputStream();\n+        encode(out);\n+        return out.toByteArray();\n+\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded(String format) throws IOException {\n+        //Assume Der for now.\n+        Assert.notReached(\"engineGetEncoded(String format)) not supported\");\n+        throw new IOException(\"engineGetEncoded(String format)) not supported\");\n+    }\n+\n+    @Override\n+    protected String engineToString() {\n+        String str = new String(\"Mozilla-JSS PSSAlgorithmParameters \" +  getClass().getName() + \" HashAlg: \" + spec.getDigestAlgorithm() + \" MaskGenAlg: \" + spec.getMGFAlgorithm() );\n+        return str;\n+    }\n+\n+    private void decode(DerInputStream in , byte[] encoded) throws IOException {\n+        if (in == null) {\n+            throw new IOException(\"Invalid input: got null DerInputStream\");\n+        }\n+\n+        // Sequence has 3 members, trailer field ignored\n+        DerValue seq[] = in.getSequence(3);\n+        if (seq.length != 3) {\n+            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");", "originalCommit": "8eda7bd9324cd02fea1d32b5182972b4f9db1657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzQ5MQ==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r403143491", "bodyText": "Pending resolution of above.", "author": "cipherboy", "createdAt": "2020-04-03T16:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MjYwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "chunk": "diff --git a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\nindex 0184c661..ff089534 100644\n--- a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n+++ b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n\n@@ -124,14 +124,14 @@ public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n \n         // Sequence has 3 members, trailer field ignored\n         DerValue seq[] = in.getSequence(3);\n-        if (seq.length != 3) {\n-            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        if (seq.length < 3 || seq.length > 4) {\n+            throw new IOException(\"Invalid data! Expected a sequence with either 3 or 4 members; got \" + seq.length);\n         }\n \n         if (seq[0].isContextSpecific((byte)0)) {\n             seq[0] = seq[0].data.getDerValue();\n         } else {\n-             throw new IOException(\"Invalid encoded data!\");\n+             throw new IOException(\"Invalid encoded data! Expecting OAEP-PSSDigestAlgorithms (hashAlgorithm).\");\n         }\n \n         AlgorithmId algid = AlgorithmId.parse(seq[0]);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MzAzMQ==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402453031", "bodyText": "@jmagne Why do we fallback to SHA1 here? Is there a relevant portion of the spec somewhere?", "author": "cipherboy", "createdAt": "2020-04-02T16:37:49Z", "path": "org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.jss.provider.java.security;\n+\n+import java.security.*;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.security.spec.PSSParameterSpec;\n+import java.security.spec.MGF1ParameterSpec;\n+import java.io.IOException;\n+import org.mozilla.jss.util.Assert;\n+import org.mozilla.jss.netscape.security.util.BigInt;\n+import org.mozilla.jss.netscape.security.x509.AlgorithmId;\n+import org.mozilla.jss.netscape.security.util.DerOutputStream;\n+import org.mozilla.jss.netscape.security.util.DerInputStream;\n+import org.mozilla.jss.netscape.security.util.DerValue;\n+import org.mozilla.jss.netscape.security.util.ObjectIdentifier;\n+import org.mozilla.jss.asn1.ASN1Template;\n+import org.mozilla.jss.asn1.ASN1Value;\n+import org.mozilla.jss.asn1.INTEGER;\n+import org.mozilla.jss.asn1.InvalidBERException;\n+import org.mozilla.jss.asn1.OBJECT_IDENTIFIER;\n+import org.mozilla.jss.asn1.OCTET_STRING;\n+import org.mozilla.jss.asn1.SEQUENCE;\n+import org.mozilla.jss.asn1.Tag;\n+\n+/**\n+ * A RSAPSSAlgorithmParameter implements the trandcoding between a\n+ * PSSAlgorithmSpec instance and the DER-encoded form.\n+ *\n+ * RSASSA-PSS-params ::= SEQUENCE {\n+ *  hashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\n+ * maskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\n+ * saltLength         [2] INTEGER  DEFAULT 20,\n+ *  trailerField       [3] INTEGER  DEFAULT 1\n+ * }\n+ *\n+ * where\n+ *\n+ *  OAEP-PSSDigestAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-sha1 PARAMETERS NULL   }|\n+ *    { OID id-sha224 PARAMETERS NULL   }|\n+ *    { OID id-sha256 PARAMETERS NULL }|\n+ *    { OID id-sha384 PARAMETERS NULL }|\n+ *    { OID id-sha512 PARAMETERS NULL },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ *\n+ *  PKCS1MGFAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-mgf1 PARAMETERS OAEP-PSSDigestAlgorithms },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ */\n+public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n+    public final static AlgorithmId defaultHashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+    public final static AlgorithmId defaultMaskGenFunc  = new AlgorithmId(AlgorithmId.MGF1_oid);\n+    public final static BigInt          defaultSaltLen = new BigInt(20);\n+    public final static BigInt          defaultTrailerField = new BigInt(1);\n+\n+    private PSSParameterSpec spec = PSSParameterSpec.DEFAULT;\n+    private AlgorithmId hashAlg = defaultHashAlg;\n+    private AlgorithmId maskGenFunc = defaultMaskGenFunc;\n+    private BigInt saltLen = defaultSaltLen;\n+    private BigInt trailerField = defaultTrailerField;\n+\n+    public RSAPSSAlgorithmParameters() {}\n+\n+    @Override\n+    protected void engineInit(AlgorithmParameterSpec paramSpec)\n+            throws InvalidParameterSpecException {\n+        spec = (PSSParameterSpec) paramSpec;\n+        populateFromSpec();\n+    }\n+\n+    @Override\n+    protected <T extends AlgorithmParameterSpec> T engineGetParameterSpec(Class<T> paramSpec)\n+            throws InvalidParameterSpecException  {\n+        if (paramSpec.isAssignableFrom(PSSParameterSpec.class)) {\n+            return paramSpec.cast(spec);\n+        }\n+\n+        throw new InvalidParameterSpecException(\"Unknown parameter spec passed to PSS parameters object: \" + paramSpec.getName());\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params) throws IOException {\n+        decode(new DerInputStream(params), params);\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params, String format) throws IOException {\n+        // Assume Der for now.\n+        Assert.notReached(\"engineInit(byte[],String) not supported\");\n+        throw new IOException(\"engineInit(byte[],String) not supported\");\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded() throws IOException {\n+        DerOutputStream out = new DerOutputStream();\n+        encode(out);\n+        return out.toByteArray();\n+\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded(String format) throws IOException {\n+        //Assume Der for now.\n+        Assert.notReached(\"engineGetEncoded(String format)) not supported\");\n+        throw new IOException(\"engineGetEncoded(String format)) not supported\");\n+    }\n+\n+    @Override\n+    protected String engineToString() {\n+        String str = new String(\"Mozilla-JSS PSSAlgorithmParameters \" +  getClass().getName() + \" HashAlg: \" + spec.getDigestAlgorithm() + \" MaskGenAlg: \" + spec.getMGFAlgorithm() );\n+        return str;\n+    }\n+\n+    private void decode(DerInputStream in , byte[] encoded) throws IOException {\n+        if (in == null) {\n+            throw new IOException(\"Invalid input: got null DerInputStream\");\n+        }\n+\n+        // Sequence has 3 members, trailer field ignored\n+        DerValue seq[] = in.getSequence(3);\n+        if (seq.length != 3) {\n+            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        }\n+\n+        if (seq[0].isContextSpecific((byte)0)) {\n+            seq[0] = seq[0].data.getDerValue();\n+        } else {\n+             throw new IOException(\"Invalid encoded data!\");\n+        }\n+\n+        AlgorithmId algid = AlgorithmId.parse(seq[0]);\n+\n+        String specAlgName = getSpecAlgName(algid.getName());\n+\n+        String specMGF1Name = \"\";\n+        // Now the MFG1 parameter hash fun is the same as the main hash func.\n+        MGF1ParameterSpec specMFG1ParamSpec = new MGF1ParameterSpec(specAlgName);\n+\n+        if (seq[1].isContextSpecific((byte)1)) {\n+            seq[1] = seq[1].data.getDerValue();\n+        } else {\n+            throw new IOException(\"Invalid encoded data.\");\n+        }\n+\n+        DerInputStream mgf1Str = new DerInputStream(seq[1].toByteArray());\n+        DerValue[] seqMgf1 = mgf1Str.getSequence(2);\n+\n+        ObjectIdentifier mgf1OID = seqMgf1[0].getOID();\n+\n+        if (!mgf1OID.equals(AlgorithmId.MGF1_oid)) {\n+           throw new IOException(\"Invalid encoded data: expected MGF1 OID but got: \" + mgf1OID.toString());\n+        } else {\n+           specMGF1Name = \"MGF1\";\n+        }\n+\n+        if (seq[2].isContextSpecific((byte)2)) {\n+            seq[2]  = seq[2].data.getDerValue();\n+        } else {\n+            throw new IOException(\"Invalid encoded data.\");\n+        }\n+\n+        BigInt sLength = seq[2].getInteger();\n+\n+        this.spec = new PSSParameterSpec(specAlgName, specMGF1Name, specMFG1ParamSpec,\n+                                         sLength.toInt(), 1 /* always default trailer */);\n+\n+        populateFromSpec();\n+    }\n+\n+    private void encode(DerOutputStream out) throws IOException {\n+        try (\n+            DerOutputStream tmp = new DerOutputStream();\n+            DerOutputStream mgf = new DerOutputStream();\n+            DerOutputStream seq1 = new DerOutputStream();\n+            DerOutputStream intStream = new DerOutputStream();\n+        ) {\n+            // Hash algorithm\n+            hashAlg.derEncodeWithContext(tmp,0);\n+\n+            // Mask Gen Function Sequence\n+            mgf.putOID(maskGenFunc.getOID());\n+\n+            // MGF hash alg is the same as the hash Alg at this point.\n+            hashAlg.encode(mgf);\n+            seq1.write(DerValue.tag_Sequence,mgf);\n+            tmp.write(DerValue.createTag(DerValue.TAG_CONTEXT,\n+                                             true, (byte) 1), seq1);\n+\n+            // Salt Length\n+            intStream.putInteger(saltLen);\n+\n+            tmp.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, (byte) 2),\n+                    intStream);\n+\n+            // Ignore trailer field, it never changes over all sequence tags\n+            out.write(DerValue.tag_Sequence, tmp);\n+\n+            byte[] data = out.toByteArray();\n+        }\n+    }\n+\n+    private void populateFromSpec() {\n+        if (spec == null || hashAlg == null) {\n+            return;\n+        }\n+\n+        String hashAlgName = spec.getDigestAlgorithm();\n+        String maskGenName = spec.getMGFAlgorithm();\n+\n+        int saltLen = spec.getSaltLength();\n+        this.saltLen = new BigInt(saltLen);\n+        int trailer = spec.getTrailerField();\n+\n+        // Create the hash alg and mask gen func objects\n+        if (hashAlgName.equals(\"SHA-256\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA256_oid);\n+        }  else if(hashAlgName.equals(\"SHA-512\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA512_oid);\n+        }  else if(hashAlgName.equals(\"SHA-384\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA384_oid);\n+        } else {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA_oid);", "originalCommit": "8eda7bd9324cd02fea1d32b5182972b4f9db1657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTIzMQ==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402685231", "bodyText": "I just put that there cause other implementations of this thing I observed that being the default value. I can see throwing an exception could be appropriate here..", "author": "jmagne", "createdAt": "2020-04-03T01:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MzAzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "chunk": "diff --git a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\nindex 0184c661..ff089534 100644\n--- a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n+++ b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n\n@@ -124,14 +124,14 @@ public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n \n         // Sequence has 3 members, trailer field ignored\n         DerValue seq[] = in.getSequence(3);\n-        if (seq.length != 3) {\n-            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        if (seq.length < 3 || seq.length > 4) {\n+            throw new IOException(\"Invalid data! Expected a sequence with either 3 or 4 members; got \" + seq.length);\n         }\n \n         if (seq[0].isContextSpecific((byte)0)) {\n             seq[0] = seq[0].data.getDerValue();\n         } else {\n-             throw new IOException(\"Invalid encoded data!\");\n+             throw new IOException(\"Invalid encoded data! Expecting OAEP-PSSDigestAlgorithms (hashAlgorithm).\");\n         }\n \n         AlgorithmId algid = AlgorithmId.parse(seq[0]);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MzIzNA==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402453234", "bodyText": "@jmagne Same here?", "author": "cipherboy", "createdAt": "2020-04-02T16:38:10Z", "path": "org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.jss.provider.java.security;\n+\n+import java.security.*;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.security.spec.PSSParameterSpec;\n+import java.security.spec.MGF1ParameterSpec;\n+import java.io.IOException;\n+import org.mozilla.jss.util.Assert;\n+import org.mozilla.jss.netscape.security.util.BigInt;\n+import org.mozilla.jss.netscape.security.x509.AlgorithmId;\n+import org.mozilla.jss.netscape.security.util.DerOutputStream;\n+import org.mozilla.jss.netscape.security.util.DerInputStream;\n+import org.mozilla.jss.netscape.security.util.DerValue;\n+import org.mozilla.jss.netscape.security.util.ObjectIdentifier;\n+import org.mozilla.jss.asn1.ASN1Template;\n+import org.mozilla.jss.asn1.ASN1Value;\n+import org.mozilla.jss.asn1.INTEGER;\n+import org.mozilla.jss.asn1.InvalidBERException;\n+import org.mozilla.jss.asn1.OBJECT_IDENTIFIER;\n+import org.mozilla.jss.asn1.OCTET_STRING;\n+import org.mozilla.jss.asn1.SEQUENCE;\n+import org.mozilla.jss.asn1.Tag;\n+\n+/**\n+ * A RSAPSSAlgorithmParameter implements the trandcoding between a\n+ * PSSAlgorithmSpec instance and the DER-encoded form.\n+ *\n+ * RSASSA-PSS-params ::= SEQUENCE {\n+ *  hashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\n+ * maskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\n+ * saltLength         [2] INTEGER  DEFAULT 20,\n+ *  trailerField       [3] INTEGER  DEFAULT 1\n+ * }\n+ *\n+ * where\n+ *\n+ *  OAEP-PSSDigestAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-sha1 PARAMETERS NULL   }|\n+ *    { OID id-sha224 PARAMETERS NULL   }|\n+ *    { OID id-sha256 PARAMETERS NULL }|\n+ *    { OID id-sha384 PARAMETERS NULL }|\n+ *    { OID id-sha512 PARAMETERS NULL },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ *\n+ *  PKCS1MGFAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-mgf1 PARAMETERS OAEP-PSSDigestAlgorithms },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ */\n+public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n+    public final static AlgorithmId defaultHashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+    public final static AlgorithmId defaultMaskGenFunc  = new AlgorithmId(AlgorithmId.MGF1_oid);\n+    public final static BigInt          defaultSaltLen = new BigInt(20);\n+    public final static BigInt          defaultTrailerField = new BigInt(1);\n+\n+    private PSSParameterSpec spec = PSSParameterSpec.DEFAULT;\n+    private AlgorithmId hashAlg = defaultHashAlg;\n+    private AlgorithmId maskGenFunc = defaultMaskGenFunc;\n+    private BigInt saltLen = defaultSaltLen;\n+    private BigInt trailerField = defaultTrailerField;\n+\n+    public RSAPSSAlgorithmParameters() {}\n+\n+    @Override\n+    protected void engineInit(AlgorithmParameterSpec paramSpec)\n+            throws InvalidParameterSpecException {\n+        spec = (PSSParameterSpec) paramSpec;\n+        populateFromSpec();\n+    }\n+\n+    @Override\n+    protected <T extends AlgorithmParameterSpec> T engineGetParameterSpec(Class<T> paramSpec)\n+            throws InvalidParameterSpecException  {\n+        if (paramSpec.isAssignableFrom(PSSParameterSpec.class)) {\n+            return paramSpec.cast(spec);\n+        }\n+\n+        throw new InvalidParameterSpecException(\"Unknown parameter spec passed to PSS parameters object: \" + paramSpec.getName());\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params) throws IOException {\n+        decode(new DerInputStream(params), params);\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params, String format) throws IOException {\n+        // Assume Der for now.\n+        Assert.notReached(\"engineInit(byte[],String) not supported\");\n+        throw new IOException(\"engineInit(byte[],String) not supported\");\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded() throws IOException {\n+        DerOutputStream out = new DerOutputStream();\n+        encode(out);\n+        return out.toByteArray();\n+\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded(String format) throws IOException {\n+        //Assume Der for now.\n+        Assert.notReached(\"engineGetEncoded(String format)) not supported\");\n+        throw new IOException(\"engineGetEncoded(String format)) not supported\");\n+    }\n+\n+    @Override\n+    protected String engineToString() {\n+        String str = new String(\"Mozilla-JSS PSSAlgorithmParameters \" +  getClass().getName() + \" HashAlg: \" + spec.getDigestAlgorithm() + \" MaskGenAlg: \" + spec.getMGFAlgorithm() );\n+        return str;\n+    }\n+\n+    private void decode(DerInputStream in , byte[] encoded) throws IOException {\n+        if (in == null) {\n+            throw new IOException(\"Invalid input: got null DerInputStream\");\n+        }\n+\n+        // Sequence has 3 members, trailer field ignored\n+        DerValue seq[] = in.getSequence(3);\n+        if (seq.length != 3) {\n+            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        }\n+\n+        if (seq[0].isContextSpecific((byte)0)) {\n+            seq[0] = seq[0].data.getDerValue();\n+        } else {\n+             throw new IOException(\"Invalid encoded data!\");\n+        }\n+\n+        AlgorithmId algid = AlgorithmId.parse(seq[0]);\n+\n+        String specAlgName = getSpecAlgName(algid.getName());\n+\n+        String specMGF1Name = \"\";\n+        // Now the MFG1 parameter hash fun is the same as the main hash func.\n+        MGF1ParameterSpec specMFG1ParamSpec = new MGF1ParameterSpec(specAlgName);\n+\n+        if (seq[1].isContextSpecific((byte)1)) {\n+            seq[1] = seq[1].data.getDerValue();\n+        } else {\n+            throw new IOException(\"Invalid encoded data.\");\n+        }\n+\n+        DerInputStream mgf1Str = new DerInputStream(seq[1].toByteArray());\n+        DerValue[] seqMgf1 = mgf1Str.getSequence(2);\n+\n+        ObjectIdentifier mgf1OID = seqMgf1[0].getOID();\n+\n+        if (!mgf1OID.equals(AlgorithmId.MGF1_oid)) {\n+           throw new IOException(\"Invalid encoded data: expected MGF1 OID but got: \" + mgf1OID.toString());\n+        } else {\n+           specMGF1Name = \"MGF1\";\n+        }\n+\n+        if (seq[2].isContextSpecific((byte)2)) {\n+            seq[2]  = seq[2].data.getDerValue();\n+        } else {\n+            throw new IOException(\"Invalid encoded data.\");\n+        }\n+\n+        BigInt sLength = seq[2].getInteger();\n+\n+        this.spec = new PSSParameterSpec(specAlgName, specMGF1Name, specMFG1ParamSpec,\n+                                         sLength.toInt(), 1 /* always default trailer */);\n+\n+        populateFromSpec();\n+    }\n+\n+    private void encode(DerOutputStream out) throws IOException {\n+        try (\n+            DerOutputStream tmp = new DerOutputStream();\n+            DerOutputStream mgf = new DerOutputStream();\n+            DerOutputStream seq1 = new DerOutputStream();\n+            DerOutputStream intStream = new DerOutputStream();\n+        ) {\n+            // Hash algorithm\n+            hashAlg.derEncodeWithContext(tmp,0);\n+\n+            // Mask Gen Function Sequence\n+            mgf.putOID(maskGenFunc.getOID());\n+\n+            // MGF hash alg is the same as the hash Alg at this point.\n+            hashAlg.encode(mgf);\n+            seq1.write(DerValue.tag_Sequence,mgf);\n+            tmp.write(DerValue.createTag(DerValue.TAG_CONTEXT,\n+                                             true, (byte) 1), seq1);\n+\n+            // Salt Length\n+            intStream.putInteger(saltLen);\n+\n+            tmp.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, (byte) 2),\n+                    intStream);\n+\n+            // Ignore trailer field, it never changes over all sequence tags\n+            out.write(DerValue.tag_Sequence, tmp);\n+\n+            byte[] data = out.toByteArray();\n+        }\n+    }\n+\n+    private void populateFromSpec() {\n+        if (spec == null || hashAlg == null) {\n+            return;\n+        }\n+\n+        String hashAlgName = spec.getDigestAlgorithm();\n+        String maskGenName = spec.getMGFAlgorithm();\n+\n+        int saltLen = spec.getSaltLength();\n+        this.saltLen = new BigInt(saltLen);\n+        int trailer = spec.getTrailerField();\n+\n+        // Create the hash alg and mask gen func objects\n+        if (hashAlgName.equals(\"SHA-256\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA256_oid);\n+        }  else if(hashAlgName.equals(\"SHA-512\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA512_oid);\n+        }  else if(hashAlgName.equals(\"SHA-384\")) {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA384_oid);\n+        } else {\n+           hashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+        }\n+    }\n+\n+    private String getSpecAlgName(String algName) {\n+        if (\"SHA256\".equals(algName)) {\n+            return \"SHA-256\";\n+        } else if(\"SHA384\".equals(algName)) {\n+            return \"SHA-384\";\n+        } else if(\"SHA512\".equals(algName)) {\n+            return \"SHA-512\";\n+        } else {\n+            // Default to SHA-1\n+            return \"SHA-1\";", "originalCommit": "8eda7bd9324cd02fea1d32b5182972b4f9db1657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NTMwMA==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r402685300", "bodyText": "Same as above, but of course this should never happen. but ...", "author": "jmagne", "createdAt": "2020-04-03T01:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1MzIzNA=="}], "type": "inlineReview", "revised_code": {"commit": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "chunk": "diff --git a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\nindex 0184c661..ff089534 100644\n--- a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n+++ b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n\n@@ -124,14 +124,14 @@ public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n \n         // Sequence has 3 members, trailer field ignored\n         DerValue seq[] = in.getSequence(3);\n-        if (seq.length != 3) {\n-            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        if (seq.length < 3 || seq.length > 4) {\n+            throw new IOException(\"Invalid data! Expected a sequence with either 3 or 4 members; got \" + seq.length);\n         }\n \n         if (seq[0].isContextSpecific((byte)0)) {\n             seq[0] = seq[0].data.getDerValue();\n         } else {\n-             throw new IOException(\"Invalid encoded data!\");\n+             throw new IOException(\"Invalid encoded data! Expecting OAEP-PSSDigestAlgorithms (hashAlgorithm).\");\n         }\n \n         AlgorithmId algid = AlgorithmId.parse(seq[0]);\n"}}, {"oid": "bee0f862f2ca892ebce0f752570dcb3551bf9396", "url": "https://github.com/dogtagpki/jss/commit/bee0f862f2ca892ebce0f752570dcb3551bf9396", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-02T16:42:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzMyMA==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r403143320", "bodyText": "@jmagne So I'm confused here. The comment above says \"trailer field ignored\". I'm not entirely clear on how getSequence works, but if there was a trailer field, wouldn't it return an array of 4 DerValue elements?\nIn particular readVector(...) uses startLen as the initialize size of the vector, but it'll grow if there are four fields.\nShouldn't this read if (seq.length < 3 || seq.length > 4)?", "author": "cipherboy", "createdAt": "2020-04-03T16:54:21Z", "path": "org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java", "diffHunk": "@@ -0,0 +1,244 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.jss.provider.java.security;\n+\n+import java.security.*;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.security.spec.PSSParameterSpec;\n+import java.security.spec.MGF1ParameterSpec;\n+import java.io.IOException;\n+import org.mozilla.jss.util.Assert;\n+import org.mozilla.jss.netscape.security.util.BigInt;\n+import org.mozilla.jss.netscape.security.x509.AlgorithmId;\n+import org.mozilla.jss.netscape.security.util.DerOutputStream;\n+import org.mozilla.jss.netscape.security.util.DerInputStream;\n+import org.mozilla.jss.netscape.security.util.DerValue;\n+import org.mozilla.jss.netscape.security.util.ObjectIdentifier;\n+import org.mozilla.jss.asn1.ASN1Template;\n+import org.mozilla.jss.asn1.ASN1Value;\n+import org.mozilla.jss.asn1.INTEGER;\n+import org.mozilla.jss.asn1.InvalidBERException;\n+import org.mozilla.jss.asn1.OBJECT_IDENTIFIER;\n+import org.mozilla.jss.asn1.OCTET_STRING;\n+import org.mozilla.jss.asn1.SEQUENCE;\n+import org.mozilla.jss.asn1.Tag;\n+\n+/**\n+ * A RSAPSSAlgorithmParameter implements the trandcoding between a\n+ * PSSAlgorithmSpec instance and the DER-encoded form.\n+ *\n+ * RSASSA-PSS-params ::= SEQUENCE {\n+ *  hashAlgorithm      [0] OAEP-PSSDigestAlgorithms  DEFAULT sha1,\n+ * maskGenAlgorithm   [1] PKCS1MGFAlgorithms  DEFAULT mgf1SHA1,\n+ * saltLength         [2] INTEGER  DEFAULT 20,\n+ *  trailerField       [3] INTEGER  DEFAULT 1\n+ * }\n+ *\n+ * where\n+ *\n+ *  OAEP-PSSDigestAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-sha1 PARAMETERS NULL   }|\n+ *    { OID id-sha224 PARAMETERS NULL   }|\n+ *    { OID id-sha256 PARAMETERS NULL }|\n+ *    { OID id-sha384 PARAMETERS NULL }|\n+ *    { OID id-sha512 PARAMETERS NULL },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ *\n+ *  PKCS1MGFAlgorithms    ALGORITHM-IDENTIFIER ::= {\n+ *    { OID id-mgf1 PARAMETERS OAEP-PSSDigestAlgorithms },\n+ *    ...  -- Allows for future expansion --\n+ *  }\n+ */\n+public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n+    public final static AlgorithmId defaultHashAlg = new AlgorithmId(AlgorithmId.SHA_oid);\n+    public final static AlgorithmId defaultMaskGenFunc  = new AlgorithmId(AlgorithmId.MGF1_oid);\n+    public final static BigInt          defaultSaltLen = new BigInt(20);\n+    public final static BigInt          defaultTrailerField = new BigInt(1);\n+\n+    private PSSParameterSpec spec = PSSParameterSpec.DEFAULT;\n+    private AlgorithmId hashAlg = defaultHashAlg;\n+    private AlgorithmId maskGenFunc = defaultMaskGenFunc;\n+    private BigInt saltLen = defaultSaltLen;\n+    private BigInt trailerField = defaultTrailerField;\n+\n+    public RSAPSSAlgorithmParameters() {}\n+\n+    @Override\n+    protected void engineInit(AlgorithmParameterSpec paramSpec)\n+            throws InvalidParameterSpecException {\n+        spec = (PSSParameterSpec) paramSpec;\n+        populateFromSpec();\n+    }\n+\n+    @Override\n+    protected <T extends AlgorithmParameterSpec> T engineGetParameterSpec(Class<T> paramSpec)\n+            throws InvalidParameterSpecException  {\n+        if (paramSpec.isAssignableFrom(PSSParameterSpec.class)) {\n+            return paramSpec.cast(spec);\n+        }\n+\n+        throw new InvalidParameterSpecException(\"Unknown parameter spec passed to PSS parameters object: \" + paramSpec.getName());\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params) throws IOException {\n+        decode(new DerInputStream(params), params);\n+    }\n+\n+    @Override\n+    protected void engineInit(byte[] params, String format) throws IOException {\n+        // Assume Der for now.\n+        Assert.notReached(\"engineInit(byte[],String) not supported\");\n+        throw new IOException(\"engineInit(byte[],String) not supported\");\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded() throws IOException {\n+        DerOutputStream out = new DerOutputStream();\n+        encode(out);\n+        return out.toByteArray();\n+\n+    }\n+\n+    @Override\n+    protected byte[] engineGetEncoded(String format) throws IOException {\n+        //Assume Der for now.\n+        Assert.notReached(\"engineGetEncoded(String format)) not supported\");\n+        throw new IOException(\"engineGetEncoded(String format)) not supported\");\n+    }\n+\n+    @Override\n+    protected String engineToString() {\n+        String str = new String(\"Mozilla-JSS PSSAlgorithmParameters \" +  getClass().getName() + \" HashAlg: \" + spec.getDigestAlgorithm() + \" MaskGenAlg: \" + spec.getMGFAlgorithm() );\n+        return str;\n+    }\n+\n+    private void decode(DerInputStream in , byte[] encoded) throws IOException {\n+        if (in == null) {\n+            throw new IOException(\"Invalid input: got null DerInputStream\");\n+        }\n+\n+        // Sequence has 3 members, trailer field ignored\n+        DerValue seq[] = in.getSequence(3);\n+        if (seq.length != 3) {", "originalCommit": "bee0f862f2ca892ebce0f752570dcb3551bf9396", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIyNDI2Ng==", "url": "https://github.com/dogtagpki/jss/pull/467#discussion_r403224266", "bodyText": "OK, I did this because the default of 1 is the only supported value, and I think at the time it was apparent that due to this , that no one ever put the trailer field in the stream..  But I think this is a good catch, and for safety I believe this should be changed as you stated to allow just in case someone puts that in there...", "author": "jmagne", "createdAt": "2020-04-03T18:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "chunk": "diff --git a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\nindex 0184c661..ff089534 100644\n--- a/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n+++ b/org/mozilla/jss/provider/java/security/RSAPSSAlgorithmParameters.java\n\n@@ -124,14 +124,14 @@ public class RSAPSSAlgorithmParameters extends AlgorithmParametersSpi {\n \n         // Sequence has 3 members, trailer field ignored\n         DerValue seq[] = in.getSequence(3);\n-        if (seq.length != 3) {\n-            throw new IOException(\"Invalid data! Expected a sequence of at least 3 members.\");\n+        if (seq.length < 3 || seq.length > 4) {\n+            throw new IOException(\"Invalid data! Expected a sequence with either 3 or 4 members; got \" + seq.length);\n         }\n \n         if (seq[0].isContextSpecific((byte)0)) {\n             seq[0] = seq[0].data.getDerValue();\n         } else {\n-             throw new IOException(\"Invalid encoded data!\");\n+             throw new IOException(\"Invalid encoded data! Expecting OAEP-PSSDigestAlgorithms (hashAlgorithm).\");\n         }\n \n         AlgorithmId algid = AlgorithmId.parse(seq[0]);\n"}}, {"oid": "a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "url": "https://github.com/dogtagpki/jss/commit/a6703f7ec99aab0a2905f2a5cd47b1e242e025f4", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-03T19:57:18Z", "type": "forcePushed"}, {"oid": "d886356ab57ab8dc5a5f3032e2af37dce3151889", "url": "https://github.com/dogtagpki/jss/commit/d886356ab57ab8dc5a5f3032e2af37dce3151889", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-03T20:18:02Z", "type": "forcePushed"}, {"oid": "ad6f762860b3e0ec6db70398783276b74630d799", "url": "https://github.com/dogtagpki/jss/commit/ad6f762860b3e0ec6db70398783276b74630d799", "message": "Support RSA-PSS Signature scheme\n\nProvide support for the various SHAxxxwithRSAPSS algorithms, including\nSHA-256, SHA-384, and SHA-512 variants.\n\nAuthored by Jack Magne; revised patch forwarded ported from v4.4.x by\nAlexander Scheel.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T12:51:09Z", "type": "commit"}, {"oid": "0e3542894d9951ccb910341544cb6e3f54ab3e62", "url": "https://github.com/dogtagpki/jss/commit/0e3542894d9951ccb910341544cb6e3f54ab3e62", "message": "Refactor JCASigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T12:51:09Z", "type": "commit"}, {"oid": "7d0ca73848a8e997e7d1306c82772cc520cdeb9b", "url": "https://github.com/dogtagpki/jss/commit/7d0ca73848a8e997e7d1306c82772cc520cdeb9b", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T12:51:10Z", "type": "commit"}, {"oid": "7d0ca73848a8e997e7d1306c82772cc520cdeb9b", "url": "https://github.com/dogtagpki/jss/commit/7d0ca73848a8e997e7d1306c82772cc520cdeb9b", "message": "Refactor SigTest\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T12:51:10Z", "type": "forcePushed"}]}