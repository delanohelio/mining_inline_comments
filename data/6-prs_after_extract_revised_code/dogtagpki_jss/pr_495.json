{"pr_number": 495, "pr_title": "Simplify PR.Close() logic", "pr_createdAt": "2020-04-20T18:29:05Z", "pr_url": "https://github.com/dogtagpki/jss/pull/495", "timeline": [{"oid": "8e437161783cc989df7859ebb3f06da6dd85d3ff", "url": "https://github.com/dogtagpki/jss/commit/8e437161783cc989df7859ebb3f06da6dd85d3ff", "message": "Simplify PR.Close() logic\n\nFrom earlier discussions on memory management, we should isolate the\nconcerns of the NSPR layer from having to deal with SSL FD specific\nstuff as much as possible. Move what used to be in the SSLFD-specific\nNSPR close layer to SSLEngine itself.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-20T18:37:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc0NjA4Mg==", "url": "https://github.com/dogtagpki/jss/pull/495#discussion_r411746082", "bodyText": "This probably can be simplified into:\nreturn Close(fd, false);", "author": "edewata", "createdAt": "2020-04-20T22:56:02Z", "path": "org/mozilla/jss/nss/PR.java", "diffHunk": "@@ -88,18 +92,14 @@ public static int Close(PRFDProxy fd) {\n      *           org.mozilla.jss.nss.SSLFDProxy.releaseNativeResources\n      */\n     public synchronized static int Close(SSLFDProxy fd) throws Exception {\n-        if (fd.isNull()) {\n+        if (fd == null || fd.isNull()) {\n             return SUCCESS;\n         }\n \n-        SSL.RemoveCallbacks(fd);\n-\n         // Because a SSLFDProxy instance needs to free other native resources,\n         // we can't release the pointer here. Instead, let NativeProxy.close()\n         // handle clearing the PRFileDesc pointer.\n-        int ret = PR.Close((PRFDProxy) fd, false);\n-        fd.close();\n-        return ret;\n+        return PR.Close((PRFDProxy) fd, false);", "originalCommit": "8e437161783cc989df7859ebb3f06da6dd85d3ff", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "chunk": "diff --git a/org/mozilla/jss/nss/PR.java b/org/mozilla/jss/nss/PR.java\nindex bac78ac1..90e770e8 100644\n--- a/org/mozilla/jss/nss/PR.java\n+++ b/org/mozilla/jss/nss/PR.java\n\n@@ -99,7 +99,7 @@ public class PR {\n         // Because a SSLFDProxy instance needs to free other native resources,\n         // we can't release the pointer here. Instead, let NativeProxy.close()\n         // handle clearing the PRFileDesc pointer.\n-        return PR.Close((PRFDProxy) fd, false);\n+        return Close((PRFDProxy) fd, false);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc0NzM2Ng==", "url": "https://github.com/dogtagpki/jss/pull/495#discussion_r411747366", "bodyText": "The PR class still has a reference on SSLFDProxy. I think ideally NSPR classes should not deal with SSL.", "author": "edewata", "createdAt": "2020-04-20T22:59:02Z", "path": "org/mozilla/jss/nss/PR.java", "diffHunk": "@@ -88,18 +92,14 @@ public static int Close(PRFDProxy fd) {\n      *           org.mozilla.jss.nss.SSLFDProxy.releaseNativeResources\n      */\n     public synchronized static int Close(SSLFDProxy fd) throws Exception {", "originalCommit": "8e437161783cc989df7859ebb3f06da6dd85d3ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc1MjA0MQ==", "url": "https://github.com/dogtagpki/jss/pull/495#discussion_r411752041", "bodyText": "I think that's fine -- its a simplification over Close(PRFDProxy, boolean) -- otherwise, callers would have to know that SSLFDProxy has to be closed via Close(fd, false) and keep that in mind at every call site.", "author": "cipherboy", "createdAt": "2020-04-20T23:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc0NzM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyNzMxMg==", "url": "https://github.com/dogtagpki/jss/pull/495#discussion_r412527312", "bodyText": "If this is a purely object-oriented design, such details should have been handled in PRFDProxy.close() and SSLFDProxy.close(), but let's not worry about this internal API.", "author": "edewata", "createdAt": "2020-04-21T22:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc0NzM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "chunk": "diff --git a/org/mozilla/jss/nss/PR.java b/org/mozilla/jss/nss/PR.java\nindex bac78ac1..90e770e8 100644\n--- a/org/mozilla/jss/nss/PR.java\n+++ b/org/mozilla/jss/nss/PR.java\n\n@@ -99,7 +99,7 @@ public class PR {\n         // Because a SSLFDProxy instance needs to free other native resources,\n         // we can't release the pointer here. Instead, let NativeProxy.close()\n         // handle clearing the PRFileDesc pointer.\n-        return PR.Close((PRFDProxy) fd, false);\n+        return Close((PRFDProxy) fd, false);\n     }\n \n     /**\n"}}, {"oid": "a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "url": "https://github.com/dogtagpki/jss/commit/a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "message": "Simplify PR.Close() logic\n\nFrom earlier discussions on memory management, we should isolate the\nconcerns of the NSPR layer from having to deal with SSL FD specific\nstuff as much as possible. Move what used to be in the SSLFD-specific\nNSPR close layer to SSLEngine itself.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-21T13:33:17Z", "type": "commit"}, {"oid": "a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "url": "https://github.com/dogtagpki/jss/commit/a72f6c7b001b6984a75f9340ee8ca4f500d71a98", "message": "Simplify PR.Close() logic\n\nFrom earlier discussions on memory management, we should isolate the\nconcerns of the NSPR layer from having to deal with SSL FD specific\nstuff as much as possible. Move what used to be in the SSLFD-specific\nNSPR close layer to SSLEngine itself.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-21T13:33:17Z", "type": "forcePushed"}]}