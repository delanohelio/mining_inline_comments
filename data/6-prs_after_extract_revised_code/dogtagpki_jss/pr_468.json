{"pr_number": 468, "pr_title": "Enable Shutdown of NSS and CryptoManager", "pr_createdAt": "2020-04-03T19:44:51Z", "pr_url": "https://github.com/dogtagpki/jss/pull/468", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI4MDE3Mg==", "url": "https://github.com/dogtagpki/jss/pull/468#discussion_r403280172", "bodyText": "Needs a comment about what we're doing here.", "author": "cipherboy", "createdAt": "2020-04-03T19:49:53Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -205,4 +205,32 @@ public synchronized static void assertRegistryEmpty() {\n             logger.debug(\"NativeProxy registry is empty\");\n         }\n     }\n+\n+    /**\n+     * Unsafe: Purges all NativeProxies from memory.\n+     *\n+     * In the rare instances where we wish to shutdown an existing\n+     * CryptoManager, all native proxies need to be cleared and freed.\n+     * This will result in any lingering references to stop working, but\n+     * should ensure that an application can recover from this scenario.\n+     */\n+    public synchronized static void unsafePurgeRegistry() throws Exception {\n+        Exception first = null;\n+        HashSet<NativeProxy> registryClone = new HashSet<NativeProxy>(registry.size());\n+        registryClone.addAll(registry);\n+\n+        for (NativeProxy proxy : registryClone) {\n+            try {\n+                proxy.close();\n+            } catch (Exception e) {\n+                if (first == null) {", "originalCommit": "2ffeaa50e9d6f20d5acb791664a5349e9498c99a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80e93bb21759257db6299310ac02cc40391de0a8", "chunk": "diff --git a/org/mozilla/jss/util/NativeProxy.java b/org/mozilla/jss/util/NativeProxy.java\nindex 6c767035..1a6cb4f0 100644\n--- a/org/mozilla/jss/util/NativeProxy.java\n+++ b/org/mozilla/jss/util/NativeProxy.java\n\n@@ -214,7 +214,7 @@ public abstract class NativeProxy implements AutoCloseable\n      * This will result in any lingering references to stop working, but\n      * should ensure that an application can recover from this scenario.\n      */\n-    public synchronized static void unsafePurgeRegistry() throws Exception {\n+    public synchronized static void purgeAllInRegistry() throws Exception {\n         Exception first = null;\n         HashSet<NativeProxy> registryClone = new HashSet<NativeProxy>(registry.size());\n         registryClone.addAll(registry);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5MDMwOQ==", "url": "https://github.com/dogtagpki/jss/pull/468#discussion_r404290309", "bodyText": "Instead of \"unsafe\" should we call it forceClose() or something like that?", "author": "edewata", "createdAt": "2020-04-06T18:10:43Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -205,4 +205,32 @@ public synchronized static void assertRegistryEmpty() {\n             logger.debug(\"NativeProxy registry is empty\");\n         }\n     }\n+\n+    /**\n+     * Unsafe: Purges all NativeProxies from memory.\n+     *\n+     * In the rare instances where we wish to shutdown an existing\n+     * CryptoManager, all native proxies need to be cleared and freed.\n+     * This will result in any lingering references to stop working, but\n+     * should ensure that an application can recover from this scenario.\n+     */\n+    public synchronized static void unsafePurgeRegistry() throws Exception {", "originalCommit": "2ffeaa50e9d6f20d5acb791664a5349e9498c99a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5MTA0Nw==", "url": "https://github.com/dogtagpki/jss/pull/468#discussion_r404291047", "bodyText": "How about freeAllInRegistry()?", "author": "cipherboy", "createdAt": "2020-04-06T18:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5MDMwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MDE1NA==", "url": "https://github.com/dogtagpki/jss/pull/468#discussion_r404440154", "bodyText": "I've changed this to purgeAllInRegistry.", "author": "cipherboy", "createdAt": "2020-04-06T23:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5MDMwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "80e93bb21759257db6299310ac02cc40391de0a8", "chunk": "diff --git a/org/mozilla/jss/util/NativeProxy.java b/org/mozilla/jss/util/NativeProxy.java\nindex 6c767035..1a6cb4f0 100644\n--- a/org/mozilla/jss/util/NativeProxy.java\n+++ b/org/mozilla/jss/util/NativeProxy.java\n\n@@ -214,7 +214,7 @@ public abstract class NativeProxy implements AutoCloseable\n      * This will result in any lingering references to stop working, but\n      * should ensure that an application can recover from this scenario.\n      */\n-    public synchronized static void unsafePurgeRegistry() throws Exception {\n+    public synchronized static void purgeAllInRegistry() throws Exception {\n         Exception first = null;\n         HashSet<NativeProxy> registryClone = new HashSet<NativeProxy>(registry.size());\n         registryClone.addAll(registry);\n"}}, {"oid": "80e93bb21759257db6299310ac02cc40391de0a8", "url": "https://github.com/dogtagpki/jss/commit/80e93bb21759257db6299310ac02cc40391de0a8", "message": "Enable CryptoManager Shutdown\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:03:00Z", "type": "forcePushed"}, {"oid": "c760f55b776dc9faf87cd0b8c73b4da71ad8f886", "url": "https://github.com/dogtagpki/jss/commit/c760f55b776dc9faf87cd0b8c73b4da71ad8f886", "message": "Enable CryptoManager Shutdown\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:03:30Z", "type": "forcePushed"}, {"oid": "754df7b54cf5b133f308c0c7c93531eb3bfb450e", "url": "https://github.com/dogtagpki/jss/commit/754df7b54cf5b133f308c0c7c93531eb3bfb450e", "message": "Extend default valgrind leak checking\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:37:28Z", "type": "commit"}, {"oid": "002079b8c4f9509e83e5a647c8ce9074b8e814c8", "url": "https://github.com/dogtagpki/jss/commit/002079b8c4f9509e83e5a647c8ce9074b8e814c8", "message": "Enable CryptoManager Shutdown\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:37:28Z", "type": "commit"}, {"oid": "9873b68591978d32b726962c128e45e2894e68b8", "url": "https://github.com/dogtagpki/jss/commit/9873b68591978d32b726962c128e45e2894e68b8", "message": "Add test for CryptoManager.shutdown()\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:37:28Z", "type": "commit"}, {"oid": "9873b68591978d32b726962c128e45e2894e68b8", "url": "https://github.com/dogtagpki/jss/commit/9873b68591978d32b726962c128e45e2894e68b8", "message": "Add test for CryptoManager.shutdown()\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T23:37:28Z", "type": "forcePushed"}]}