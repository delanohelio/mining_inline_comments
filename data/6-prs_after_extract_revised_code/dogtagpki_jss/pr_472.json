{"pr_number": 472, "pr_title": "Add test for GlobalRefProxy", "pr_createdAt": "2020-04-06T21:32:04Z", "pr_url": "https://github.com/dogtagpki/jss/pull/472", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNjc2OQ==", "url": "https://github.com/dogtagpki/jss/pull/472#discussion_r404426769", "bodyText": "Could you add a note describing what's being tested and the expected behavior? E.g. test calling GlobalRefProxy.close() multiple times, it should complete successfully.", "author": "edewata", "createdAt": "2020-04-06T22:28:46Z", "path": "org/mozilla/jss/tests/TestGlobalReference.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.mozilla.jss.tests;\n+\n+import org.mozilla.jss.util.*;\n+\n+public class TestGlobalReference {\n+    public static void main(String[] args) throws Exception {\n+        String arg = \"Something\";\n+\n+        for (int i = 0; i < 100; i++) {\n+            GlobalRefProxy proxy = new GlobalRefProxy(arg);\n+            proxy.close();\n+            proxy.close();\n+            proxy.clear();", "originalCommit": "e92a53d8d697bdcb159dfcd6e61c811417a495cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzMDQyNA==", "url": "https://github.com/dogtagpki/jss/pull/472#discussion_r404430424", "bodyText": "Added.", "author": "cipherboy", "createdAt": "2020-04-06T22:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNjc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf2967702f1a5dbd612d36dbafeb31961cb51551", "chunk": "diff --git a/org/mozilla/jss/tests/TestGlobalReference.java b/org/mozilla/jss/tests/TestGlobalReference.java\nindex ed80c2ba..82aad10a 100644\n--- a/org/mozilla/jss/tests/TestGlobalReference.java\n+++ b/org/mozilla/jss/tests/TestGlobalReference.java\n\n@@ -8,16 +8,28 @@ public class TestGlobalReference {\n \n         for (int i = 0; i < 100; i++) {\n             GlobalRefProxy proxy = new GlobalRefProxy(arg);\n+            // This should free the global reference.\n             proxy.close();\n+            // This call makes sure the NativeProxy was removed from the\n+            // reference tracker; otherwise, the JVM would crash due to a\n+            // double free.\n             proxy.close();\n+            // This call makes sure clear behaves correctly after a call to\n+            // close was also made.\n             proxy.clear();\n         }\n \n         for (int i = 1; i <= 4; i++) {\n+            // This attempts to provoke the GC into running, hopefully\n+            // executing GlobalRefProxy.finalize(...) on the above objects.\n+            // This will be another attempt to trigger a double free, but\n+            // we shouldn't crash.\n             System.gc();\n             Thread.sleep(i * 500);\n         }\n \n+        // Since we didn't initialize JSS and we freed all our GlobalRefProxy\n+        // instances we created, we expect the registry to be empty.\n         NativeProxy.assertRegistryEmpty();\n     }\n }\n"}}, {"oid": "bf2967702f1a5dbd612d36dbafeb31961cb51551", "url": "https://github.com/dogtagpki/jss/commit/bf2967702f1a5dbd612d36dbafeb31961cb51551", "message": "Add test for GlobalRefProxy\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T22:38:13Z", "type": "commit"}, {"oid": "bf2967702f1a5dbd612d36dbafeb31961cb51551", "url": "https://github.com/dogtagpki/jss/commit/bf2967702f1a5dbd612d36dbafeb31961cb51551", "message": "Add test for GlobalRefProxy\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T22:38:13Z", "type": "forcePushed"}]}