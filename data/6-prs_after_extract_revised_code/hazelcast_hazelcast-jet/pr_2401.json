{"pr_number": 2401, "pr_title": "[005] Add CDC example", "pr_createdAt": "2020-07-13T10:42:39Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2401", "timeline": [{"oid": "a86ed04ebb77782cfbf738f63c9d1c195abb15d5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a86ed04ebb77782cfbf738f63c9d1c195abb15d5", "message": "Add CDC example", "committedDate": "2020-07-13T10:37:18Z", "type": "commit"}, {"oid": "4b250fd5e31db8d8a0cc7f9d10329adbfda99e8e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4b250fd5e31db8d8a0cc7f9d10329adbfda99e8e", "message": "Add missing copyright notice", "committedDate": "2020-07-13T10:54:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkxMzkzNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2401#discussion_r454913936", "bodyText": "should there a be a .join() call here?", "author": "cangencer", "createdAt": "2020-07-15T09:22:01Z", "path": "examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.cdc;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.cdc.CdcSinks;\n+import com.hazelcast.jet.cdc.ChangeRecord;\n+import com.hazelcast.jet.cdc.mysql.MySqlCdcSources;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+\n+/**\n+ * Demonstrates a simple cache which uses change data capture to monitor a\n+ * MySQL database and maintain an up-to-date cache of its content in memory.\n+ * <p>\n+ * To have a database to experiment with start one using following command:\n+ * <pre>\n+ *  docker run -it --rm --name mysql -p 3306:3306 \\\n+ *     -e MYSQL_ROOT_PASSWORD=debezium -e MYSQL_USER=mysqluser \\\n+ *     -e MYSQL_PASSWORD=mysqlpw debezium/example-mysql:1.2\n+ * </pre>\n+ * <p>\n+ * To have a command line client to generate some database events manually use:\n+ * <pre>\n+ *     docker run -it --rm --name mysqlterm --link mysql --rm mysql:5.7 sh \\\n+ *     -c 'exec mysql -h\"$MYSQL_PORT_3306_TCP_ADDR\" -P\"$MYSQL_PORT_3306_TCP_PORT\" \\\n+ *     -uroot -p\"$MYSQL_ENV_MYSQL_ROOT_PASSWORD\"'\n+ * </pre>\n+ * <p>\n+ * The map written into by this pipeline's sink can be read from other Jet jobs\n+ * or IMDG clients as any other {@code IMap}.\n+ */\n+public class Cache {\n+\n+    public static void main(String[] args) {\n+        StreamSource<ChangeRecord> source = MySqlCdcSources.mysql(\"source\")\n+                .setDatabaseAddress(\"127.0.0.1\")\n+                .setDatabasePort(3306)\n+                .setDatabaseUser(\"debezium\")\n+                .setDatabasePassword(\"dbz\")\n+                .setClusterName(\"dbserver1\")\n+                .setDatabaseWhitelist(\"inventory\")\n+                .setTableWhitelist(\"inventory.customers\")\n+                .build();\n+\n+        Pipeline pipeline = Pipeline.create();\n+        pipeline.readFrom(source)\n+                .withoutTimestamps()\n+                .peek()\n+                .writeTo(CdcSinks.map(\"customers\",\n+                        r -> r.key().toMap().get(\"id\"),\n+                        r -> r.value().toObject(Customer.class).toString()));\n+\n+        JobConfig cfg = new JobConfig().setName(\"mysql-monitor\");\n+        Jet.bootstrappedInstance().newJob(pipeline, cfg);", "originalCommit": "4b250fd5e31db8d8a0cc7f9d10329adbfda99e8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyMTkwMA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2401#discussion_r454921900", "bodyText": "Hmm... I guess if you run it stand-alone, then yes, you want to stick around, not like when you submit it to the cluster... So I guess, yes, safer to add the join. Will do.", "author": "jbartok", "createdAt": "2020-07-15T09:35:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkxMzkzNg=="}], "type": "inlineReview", "revised_code": {"commit": "f244da6eba90897c66ac20fa0d44dc6067d4e091", "chunk": "diff --git a/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java b/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\nindex f65c3c3ae..7afbe4673 100644\n--- a/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\n+++ b/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\n\n@@ -17,6 +17,7 @@\n package com.hazelcast.jet.examples.cdc;\n \n import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n import com.hazelcast.jet.cdc.CdcSinks;\n import com.hazelcast.jet.cdc.ChangeRecord;\n import com.hazelcast.jet.cdc.mysql.MySqlCdcSources;\n"}}, {"oid": "f244da6eba90897c66ac20fa0d44dc6067d4e091", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f244da6eba90897c66ac20fa0d44dc6067d4e091", "message": "Join job", "committedDate": "2020-07-15T09:38:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMyNDU5OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2401#discussion_r456324598", "bodyText": "very minor but the ); should be on next line", "author": "cangencer", "createdAt": "2020-07-17T09:18:53Z", "path": "examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.cdc;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.cdc.CdcSinks;\n+import com.hazelcast.jet.cdc.ChangeRecord;\n+import com.hazelcast.jet.cdc.mysql.MySqlCdcSources;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+\n+/**\n+ * Demonstrates a simple cache which uses change data capture to monitor a\n+ * MySQL database and maintain an up-to-date cache of its content in memory.\n+ * <p>\n+ * To have a database to experiment with start one using following command:\n+ * <pre>\n+ *  docker run -it --rm --name mysql -p 3306:3306 \\\n+ *     -e MYSQL_ROOT_PASSWORD=debezium -e MYSQL_USER=mysqluser \\\n+ *     -e MYSQL_PASSWORD=mysqlpw debezium/example-mysql:1.2\n+ * </pre>\n+ * <p>\n+ * To have a command line client to generate some database events manually use:\n+ * <pre>\n+ *     docker run -it --rm --name mysqlterm --link mysql --rm mysql:5.7 sh \\\n+ *     -c 'exec mysql -h\"$MYSQL_PORT_3306_TCP_ADDR\" -P\"$MYSQL_PORT_3306_TCP_PORT\" \\\n+ *     -uroot -p\"$MYSQL_ENV_MYSQL_ROOT_PASSWORD\"'\n+ * </pre>\n+ * <p>\n+ * The map written into by this pipeline's sink can be read from other Jet jobs\n+ * or IMDG clients as any other {@code IMap}.\n+ */\n+public class Cache {\n+\n+    public static void main(String[] args) {\n+        StreamSource<ChangeRecord> source = MySqlCdcSources.mysql(\"source\")\n+                .setDatabaseAddress(\"127.0.0.1\")\n+                .setDatabasePort(3306)\n+                .setDatabaseUser(\"debezium\")\n+                .setDatabasePassword(\"dbz\")\n+                .setClusterName(\"dbserver1\")\n+                .setDatabaseWhitelist(\"inventory\")\n+                .setTableWhitelist(\"inventory.customers\")\n+                .build();\n+\n+        Pipeline pipeline = Pipeline.create();\n+        pipeline.readFrom(source)\n+                .withoutTimestamps()\n+                .peek()\n+                .writeTo(CdcSinks.map(\"customers\",\n+                        r -> r.key().toMap().get(\"id\"),\n+                        r -> r.value().toObject(Customer.class).toString()));", "originalCommit": "f244da6eba90897c66ac20fa0d44dc6067d4e091", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b43531b6fdd5aabc4fde48914c746a725cc05be6", "chunk": "diff --git a/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java b/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\nindex 7afbe4673..67e16a77f 100644\n--- a/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\n+++ b/examples/cdc/src/main/java/com/hazelcast/jet/examples/cdc/Cache.java\n\n@@ -65,7 +65,8 @@ public class Cache {\n                 .peek()\n                 .writeTo(CdcSinks.map(\"customers\",\n                         r -> r.key().toMap().get(\"id\"),\n-                        r -> r.value().toObject(Customer.class).toString()));\n+                        r -> r.value().toObject(Customer.class).toString())\n+                );\n \n         JobConfig cfg = new JobConfig().setName(\"mysql-monitor\");\n         JetInstance jet = Jet.bootstrappedInstance();\n"}}, {"oid": "b43531b6fdd5aabc4fde48914c746a725cc05be6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b43531b6fdd5aabc4fde48914c746a725cc05be6", "message": "Address review concerns", "committedDate": "2020-07-20T05:56:33Z", "type": "commit"}]}