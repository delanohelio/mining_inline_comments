{"pr_number": 2043, "pr_title": "Support job-level serializers", "pr_createdAt": "2020-03-06T09:50:06Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2043", "timeline": [{"oid": "c29b9e5fc0746e33110cad3466424db5c6caf197", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c29b9e5fc0746e33110cad3466424db5c6caf197", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-26T15:36:14Z", "type": "commit"}, {"oid": "6e6976eb21e40110c538fbc388b99faec472f52f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6e6976eb21e40110c538fbc388b99faec472f52f", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T07:53:24Z", "type": "commit"}, {"oid": "a177ca2125ef4aafc188c03886a88482e79fcd4a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a177ca2125ef4aafc188c03886a88482e79fcd4a", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T08:22:43Z", "type": "commit"}, {"oid": "454306a55534826bd1147d9723604c3de060c41b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/454306a55534826bd1147d9723604c3de060c41b", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T08:47:40Z", "type": "commit"}, {"oid": "34ffe5bf20b5a3158e222b36970094aa38f5d74b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/34ffe5bf20b5a3158e222b36970094aa38f5d74b", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:01:33Z", "type": "commit"}, {"oid": "e6ab4bbac5dd2d1ba8484331afd6a8bc0385c3de", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e6ab4bbac5dd2d1ba8484331afd6a8bc0385c3de", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:07:51Z", "type": "commit"}, {"oid": "001bcabe6a38134b8487c0cf8ceabd93efb8c909", "url": "https://github.com/hazelcast/hazelcast-jet/commit/001bcabe6a38134b8487c0cf8ceabd93efb8c909", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:33:18Z", "type": "commit"}, {"oid": "7b3b4022e83d0d59f56dfdce20c69348905dfcec", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7b3b4022e83d0d59f56dfdce20c69348905dfcec", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T10:32:36Z", "type": "commit"}, {"oid": "b64f1f3709cc9fd93d4740164f76dd79cba76fdf", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b64f1f3709cc9fd93d4740164f76dd79cba76fdf", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T10:42:50Z", "type": "commit"}, {"oid": "95edf20891d1ebab490072fcac899e85c8d0ef82", "url": "https://github.com/hazelcast/hazelcast-jet/commit/95edf20891d1ebab490072fcac899e85c8d0ef82", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T11:06:42Z", "type": "commit"}, {"oid": "d3a3ac276c46b6cf8fd246df9e873e3cbc90c7da", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d3a3ac276c46b6cf8fd246df9e873e3cbc90c7da", "message": "Merge branch 'master' into serializness_networking\n\n# Conflicts:\n#\tpom.xml", "committedDate": "2020-02-27T11:46:41Z", "type": "commit"}, {"oid": "01aa369f5e6065ee52c6ea47d3b6bc3721701806", "url": "https://github.com/hazelcast/hazelcast-jet/commit/01aa369f5e6065ee52c6ea47d3b6bc3721701806", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T11:54:45Z", "type": "commit"}, {"oid": "254fd66d3b3c3c4495471869ff308b604d3a82ca", "url": "https://github.com/hazelcast/hazelcast-jet/commit/254fd66d3b3c3c4495471869ff308b604d3a82ca", "message": "Merge branch 'master' into serializness_networking", "committedDate": "2020-02-27T12:34:25Z", "type": "commit"}, {"oid": "dec4d9c82eea8c86729364b40a042ff7c008f990", "url": "https://github.com/hazelcast/hazelcast-jet/commit/dec4d9c82eea8c86729364b40a042ff7c008f990", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T14:06:07Z", "type": "commit"}, {"oid": "79bfadc3587c57b14263987eff2e50ae721c7191", "url": "https://github.com/hazelcast/hazelcast-jet/commit/79bfadc3587c57b14263987eff2e50ae721c7191", "message": "Fix tests", "committedDate": "2020-02-27T14:41:10Z", "type": "commit"}, {"oid": "c971f987750eae45e0ef6d77f271f79369f83846", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c971f987750eae45e0ef6d77f271f79369f83846", "message": "Configure SenderTasklet with custom SerializationService", "committedDate": "2020-02-28T08:31:35Z", "type": "commit"}, {"oid": "4bb2d4263aef1903a55396ad897991aceee3701b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4bb2d4263aef1903a55396ad897991aceee3701b", "message": "Simplify bytes writing & reading", "committedDate": "2020-02-28T10:25:07Z", "type": "commit"}, {"oid": "91cb86e9aae490b3b282428fc9c94ad062c9849e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/91cb86e9aae490b3b282428fc9c94ad062c9849e", "message": "Extract MemoryWriter & MemoryReader", "committedDate": "2020-02-28T11:54:36Z", "type": "commit"}, {"oid": "9648218d35d89c854f559975c6689ee11e95cb0f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9648218d35d89c854f559975c6689ee11e95cb0f", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-02-28T12:07:49Z", "type": "commit"}, {"oid": "6f730dc3e06639647269cb6f6fbf786e4dbca95a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f730dc3e06639647269cb6f6fbf786e4dbca95a", "message": "Add PR link to @Deprecated comment", "committedDate": "2020-03-02T08:13:27Z", "type": "commit"}, {"oid": "523e4e0c2146f62c114841de83b2238d0a25c1f5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/523e4e0c2146f62c114841de83b2238d0a25c1f5", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:20:05Z", "type": "commit"}, {"oid": "3c2f0290cf0877a8d4ad2ea7c59cec0e94ef9945", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3c2f0290cf0877a8d4ad2ea7c59cec0e94ef9945", "message": "Replace MemoryDataInput with MemoryReader to avoid allocation", "committedDate": "2020-03-02T08:50:27Z", "type": "commit"}, {"oid": "0220710637b6aceb8b9bedf4282b4cc132bcc5b7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0220710637b6aceb8b9bedf4282b4cc132bcc5b7", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:51:17Z", "type": "commit"}, {"oid": "5d09475761c52ecd34d222df9c28da3a68b04694", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5d09475761c52ecd34d222df9c28da3a68b04694", "message": "Replace MemoryDataInput with MemoryReader to avoid allocation", "committedDate": "2020-03-02T08:54:35Z", "type": "commit"}, {"oid": "b57b4855be49fc945a54980303afeadfec2f3a11", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b57b4855be49fc945a54980303afeadfec2f3a11", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:54:55Z", "type": "commit"}, {"oid": "25a7b7f9a56fe74eec7d965e741adafebee0fb2d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/25a7b7f9a56fe74eec7d965e741adafebee0fb2d", "message": "Configure Processors with custom SerializationService", "committedDate": "2020-03-02T13:08:34Z", "type": "commit"}, {"oid": "39c115d087ed8b62e78f92e1ef3521a6dd1b636a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/39c115d087ed8b62e78f92e1ef3521a6dd1b636a", "message": "Configure Processors with custom SerializationService", "committedDate": "2020-03-02T13:28:16Z", "type": "commit"}, {"oid": "c23774f7b17727e6186b0af8d19e8b45665648b9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c23774f7b17727e6186b0af8d19e8b45665648b9", "message": "Support job level serializers", "committedDate": "2020-03-03T10:13:21Z", "type": "commit"}, {"oid": "1789785b1db1cb8997fc1342f4e775ceef659f58", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1789785b1db1cb8997fc1342f4e775ceef659f58", "message": "Merge branch 'master' into sender_serializer\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/Networking.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/ImdgUtil.java", "committedDate": "2020-03-03T10:20:53Z", "type": "commit"}, {"oid": "804620da117638cdcc0797999913ad12a5848017", "url": "https://github.com/hazelcast/hazelcast-jet/commit/804620da117638cdcc0797999913ad12a5848017", "message": "Merge branch 'sender_serializer' into processor_serializer", "committedDate": "2020-03-03T10:37:10Z", "type": "commit"}, {"oid": "56c37523b54395ef7a12252a8218dea33c1621d3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/56c37523b54395ef7a12252a8218dea33c1621d3", "message": "Merge branch 'processor_serializer' into jet_serializer", "committedDate": "2020-03-03T10:37:39Z", "type": "commit"}, {"oid": "557a7c3d348a448098d35d1799513a5391c71b99", "url": "https://github.com/hazelcast/hazelcast-jet/commit/557a7c3d348a448098d35d1799513a5391c71b99", "message": "Add ResourceConfig test", "committedDate": "2020-03-03T11:03:52Z", "type": "commit"}, {"oid": "52e51ea5b095a607fae14c7d6d6beb70de1dd479", "url": "https://github.com/hazelcast/hazelcast-jet/commit/52e51ea5b095a607fae14c7d6d6beb70de1dd479", "message": "Merge branch 'master' into sender_serializer\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/Networking.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/ImdgUtil.java", "committedDate": "2020-03-03T12:33:45Z", "type": "commit"}, {"oid": "51e2b2033ccdac77179e286687e54b989728aa98", "url": "https://github.com/hazelcast/hazelcast-jet/commit/51e2b2033ccdac77179e286687e54b989728aa98", "message": "Merge branch 'sender_serializer' into processor_serializer", "committedDate": "2020-03-03T12:34:26Z", "type": "commit"}, {"oid": "7428bf8c775895f42da9701a86d42999594744a3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7428bf8c775895f42da9701a86d42999594744a3", "message": "Merge branch 'processor_serializer' into jet_serializer", "committedDate": "2020-03-03T12:35:23Z", "type": "commit"}, {"oid": "05b560ad1b4084d322ca83199993b73d60d6874a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/05b560ad1b4084d322ca83199993b73d60d6874a", "message": "Add job-level serializer deployment test", "committedDate": "2020-03-03T12:52:18Z", "type": "commit"}, {"oid": "622fa7f961ada28a5aba5da6dfc83c457a4fae3c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/622fa7f961ada28a5aba5da6dfc83c457a4fae3c", "message": "Add ReflectionUtils test", "committedDate": "2020-03-03T13:15:51Z", "type": "commit"}, {"oid": "4f7d60d97976873bd0e0545d6b6dc2d188fba58c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4f7d60d97976873bd0e0545d6b6dc2d188fba58c", "message": "Formatting", "committedDate": "2020-03-04T08:44:40Z", "type": "commit"}, {"oid": "7306a93fff07026e04de753cdb8e2cfd129a0d47", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7306a93fff07026e04de753cdb8e2cfd129a0d47", "message": "Merge branch 'master' into jet_serializer\n\n# Conflicts:\n#\textensions/hadoop/src/main/java/com/hazelcast/jet/hadoop/impl/ReadHadoopNewApiP.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/internal/serialization/impl/CustomInputOutputFactory.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/ExplodeSnapshotP.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/ExecutionPlan.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/processor/ProcessorSupplierWithService.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/AsyncSnapshotWriterImpl.java\n#\thazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/util/AsyncSnapshotWriterImplTest.java", "committedDate": "2020-03-06T07:36:08Z", "type": "commit"}, {"oid": "5ef7f7304e707e8f2acf6dad65e0dc8bf49e8733", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5ef7f7304e707e8f2acf6dad65e0dc8bf49e8733", "message": "Merge branch 'master' into jet_serializer", "committedDate": "2020-03-06T07:42:02Z", "type": "commit"}, {"oid": "4bf6932fb78424094e7c9961049910aae8d1269d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4bf6932fb78424094e7c9961049910aae8d1269d", "message": "Merge branch 'master' into jet_serializer", "committedDate": "2020-03-06T07:47:33Z", "type": "commit"}, {"oid": "9b8afa3af8a06b5751fb9a65098f1063e6634180", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9b8afa3af8a06b5751fb9a65098f1063e6634180", "message": "Merge branch 'master' into jet_serializer", "committedDate": "2020-03-06T08:16:04Z", "type": "commit"}, {"oid": "6739e82d1b8359e389842c05c5090fbeb55562dd", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6739e82d1b8359e389842c05c5090fbeb55562dd", "message": "Fix spotbugs warnings", "committedDate": "2020-03-06T08:19:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyNTQ1NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389025454", "bodyText": "should we not offer a more convenient interface here? like Serializer or similar?", "author": "cangencer", "createdAt": "2020-03-06T17:00:26Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "diffHunk": "@@ -927,6 +923,44 @@ private static File urlToFile(@Nonnull URL url) {\n         return resourceConfigs;\n     }\n \n+    /**\n+     * Registers given serializer for a given class for the scope of the job.\n+     * Both will be accessible to all the code attached to the underlying\n+     * pipeline or DAG, but not to any other code. (An important example is\n+     * the {@code IMap} data source, which can instantiate only the classes\n+     * from the Jet instance's classpath.)\n+     *\n+     * Serializer must have no-arg constructor.\n+     *\n+     * @implNote Backing storage for this method is an {@link IMap} with a\n+     * default backup count of 1. When adding big files as a resource, size\n+     * the cluster accordingly in terms of memory, since each file will have 2\n+     * copies inside the cluster(primary + backup replica).\n+     *\n+     * @return {@code this} instance for fluent API\n+     */\n+    @Nonnull\n+    public <T, S extends StreamSerializer<?>> JobConfig addSerializer(Class<T> clazz, Class<S> serializerClass) {", "originalCommit": "6739e82d1b8359e389842c05c5090fbeb55562dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc3NzQ1OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389777458", "bodyText": "agreed with @vbekiaris that StreamSerializer should be enough, ByteArraySerializer is more of a private thingy", "author": "gierlachg", "createdAt": "2020-03-09T15:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyNTQ1NA=="}], "type": "inlineReview", "revised_code": {"commit": "fbe31f90fba4cab4f634006d9c82f1efd3e301cb", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\nindex 2da3c0913a..9f4030aceb 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n\n@@ -940,7 +940,7 @@ public class JobConfig implements IdentifiedDataSerializable {\n      * @return {@code this} instance for fluent API\n      */\n     @Nonnull\n-    public <T, S extends StreamSerializer<?>> JobConfig addSerializer(Class<T> clazz, Class<S> serializerClass) {\n+    public <T, S extends Serializer> JobConfig addSerializer(Class<T> clazz, Class<S> serializerClass) {\n         addClass(clazz);\n         addClass(serializerClass);\n         serializerConfigs.put(clazz.getName(), serializerClass.getName());\n"}}, {"oid": "fbe31f90fba4cab4f634006d9c82f1efd3e301cb", "url": "https://github.com/hazelcast/hazelcast-jet/commit/fbe31f90fba4cab4f634006d9c82f1efd3e301cb", "message": "Use Serializer interface", "committedDate": "2020-03-09T07:26:16Z", "type": "commit"}, {"oid": "4dcafff002df2307dc46248803ad6ca3593bc3f2", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4dcafff002df2307dc46248803ad6ca3593bc3f2", "message": "Use Serializer interface", "committedDate": "2020-03-09T11:48:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMjQ4OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389712488", "bodyText": "Maybe we can avoid this if there are no serializers configured.", "author": "viliam-durina", "createdAt": "2020-03-09T14:11:19Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ExecutionContext.java", "diffHunk": "@@ -129,13 +137,19 @@ public ExecutionContext initialize(ExecutionPlan plan) {\n         snapshotContext = new SnapshotContext(nodeEngine.getLogger(SnapshotContext.class), jobNameAndExecutionId(),\n                 plan.lastSnapshotId(), jobConfig.getProcessingGuarantee());\n \n+        serializationService = new JetSerializationService(", "originalCommit": "4dcafff002df2307dc46248803ad6ca3593bc3f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MzYyMg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r390153622", "bodyText": "We need to call destroy() at job completion, that would require another if in completeExecution.", "author": "gierlachg", "createdAt": "2020-03-10T08:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMjQ4OA=="}], "type": "inlineReview", "revised_code": {"commit": "e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ExecutionContext.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ExecutionContext.java\nindex 5fba29b948..9e1c35b312 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ExecutionContext.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ExecutionContext.java\n\n@@ -137,10 +137,7 @@ public class ExecutionContext implements DynamicMetricsProvider {\n         snapshotContext = new SnapshotContext(nodeEngine.getLogger(SnapshotContext.class), jobNameAndExecutionId(),\n                 plan.lastSnapshotId(), jobConfig.getProcessingGuarantee());\n \n-        serializationService = new JetSerializationService(\n-                instantiateSerializers(currentThread().getContextClassLoader(), jobConfig.getSerializerConfigs()),\n-                (AbstractSerializationService) nodeEngine.getSerializationService()\n-        );\n+        serializationService = serializationService(nodeEngine, jobConfig);\n \n         metricsEnabled = jobConfig.isMetricsEnabled() && nodeEngine.getConfig().getMetricsConfig().isEnabled();\n         plan.initialize(nodeEngine, jobId, executionId, snapshotContext, tempDirectories, serializationService);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMzUxNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389713517", "bodyText": "We should not add classes. We should just register the serializer and the user is responsible for having the classes on classpath. There are other ways to make the class available at runtime, this is the least common one.", "author": "viliam-durina", "createdAt": "2020-03-09T14:12:16Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "diffHunk": "@@ -927,6 +923,44 @@ private static File urlToFile(@Nonnull URL url) {\n         return resourceConfigs;\n     }\n \n+    /**\n+     * Registers given serializer for a given class for the scope of the job.\n+     * Both will be accessible to all the code attached to the underlying\n+     * pipeline or DAG, but not to any other code. (An important example is\n+     * the {@code IMap} data source, which can instantiate only the classes\n+     * from the Jet instance's classpath.)\n+     *\n+     * Serializer must have no-arg constructor.\n+     *\n+     * @implNote Backing storage for this method is an {@link IMap} with a\n+     * default backup count of 1. When adding big files as a resource, size\n+     * the cluster accordingly in terms of memory, since each file will have 2\n+     * copies inside the cluster(primary + backup replica).\n+     *\n+     * @return {@code this} instance for fluent API\n+     */\n+    @Nonnull\n+    public <T, S extends Serializer> JobConfig addSerializer(Class<T> clazz, Class<S> serializerClass) {\n+        addClass(clazz);", "originalCommit": "4dcafff002df2307dc46248803ad6ca3593bc3f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\nindex 9f4030aceb..15e1ce60e7 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n\n@@ -924,19 +924,14 @@ public class JobConfig implements IdentifiedDataSerializable {\n     }\n \n     /**\n-     * Registers given serializer for a given class for the scope of the job.\n-     * Both will be accessible to all the code attached to the underlying\n-     * pipeline or DAG, but not to any other code. (An important example is\n-     * the {@code IMap} data source, which can instantiate only the classes\n-     * from the Jet instance's classpath.)\n-     *\n+     * Registers the given serializer for the given class for the scope of the\n+     * job. Both will be accessible to all the code attached to the underlying\n+     * pipeline or DAG, but not to any other code. (An important example is the\n+     * {@code IMap} data source, which can instantiate only the classes from\n+     * the Jet instance's classpath.)\n+     * <p>\n      * Serializer must have no-arg constructor.\n      *\n-     * @implNote Backing storage for this method is an {@link IMap} with a\n-     * default backup count of 1. When adding big files as a resource, size\n-     * the cluster accordingly in terms of memory, since each file will have 2\n-     * copies inside the cluster(primary + backup replica).\n-     *\n      * @return {@code this} instance for fluent API\n      */\n     @Nonnull\n"}}, {"oid": "a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "message": "Tweaks", "committedDate": "2020-03-09T14:13:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMDc2MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389720761", "bodyText": "This should be in JobConfigTest", "author": "viliam-durina", "createdAt": "2020-03-09T14:22:02Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/config/ResourceConfigTest.java", "diffHunk": "@@ -1064,6 +1070,48 @@ public void when_attachAll() throws Exception {\n         assertEquals(dir.toURI().toURL(), dirConfig.getUrl());\n     }\n \n+    @Test\n+    public void when_addSerializer() {", "originalCommit": "a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "chunk": "diff --git a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/config/ResourceConfigTest.java b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/config/ResourceConfigTest.java\nindex f8d614996f..98691cd225 100644\n--- a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/config/ResourceConfigTest.java\n+++ b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/config/ResourceConfigTest.java\n\n@@ -1070,48 +1070,6 @@ public class ResourceConfigTest extends JetTestSupport {\n         assertEquals(dir.toURI().toURL(), dirConfig.getUrl());\n     }\n \n-    @Test\n-    public void when_addSerializer() {\n-        // When\n-        Object object = new Object() {\n-        };\n-\n-        StreamSerializer<Object> serializer = new StreamSerializer<Object>() {\n-\n-            @Override\n-            public int getTypeId() {\n-                return 0;\n-            }\n-\n-            @Override\n-            public void write(ObjectDataOutput out, Object object) {\n-            }\n-\n-            @Override\n-            public Object read(ObjectDataInput in) {\n-                return null;\n-            }\n-\n-            @Override\n-            public void destroy() {\n-            }\n-        };\n-        config.addSerializer(object.getClass(), serializer.getClass());\n-\n-        // Then\n-        Collection<ResourceConfig> resourceConfigs = config.getResourceConfigs().values();\n-        assertThat(resourceConfigs, hasSize(2));\n-        assertThat(resourceConfigs, contains(\n-                new ResourceConfig(object.getClass()),\n-                new ResourceConfig(serializer.getClass())\n-        ));\n-\n-        Map<String, String> serializerConfigs = config.getSerializerConfigs();\n-        assertThat(serializerConfigs.entrySet(), hasSize(1));\n-        assertThat(serializerConfigs.keySet(), contains(object.getClass().getName()));\n-        assertThat(serializerConfigs.values(), contains(serializer.getClass().getName()));\n-    }\n-\n     private File createFile(String path) throws IOException {\n         File file = new File(baseDir, path);\n         assertTrue(\"Failed to create parent path for \" + file, file.getParentFile().mkdirs());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMjE3Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389722173", "bodyText": "Remove the try-catch and just declare the exception.", "author": "viliam-durina", "createdAt": "2020-03-09T14:24:03Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/JobLevelSerializerIsAvailable.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.impl.deployment;\n+\n+import com.hazelcast.jet.core.AbstractProcessor;\n+import com.hazelcast.jet.impl.execution.init.Contexts.ProcCtx;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.fail;\n+\n+public class JobLevelSerializerIsAvailable extends AbstractProcessor {\n+\n+    static final String VALUE_CLASS_NAME = \"com.sample.serializer.Value\";\n+    static final String SERIALIZER_CLASS_NAME = \"com.sample.serializer.ValueSerializer\";\n+\n+    @Override\n+    protected void init(@Nonnull Context context) {\n+        ClassLoader cl = Thread.currentThread().getContextClassLoader();\n+        try {\n+            Class<?> clazz = cl.loadClass(VALUE_CLASS_NAME);\n+            Object value = clazz.getDeclaredConstructor().newInstance();\n+            // We serialize an object so the job level serializer is invoked.\n+            byte[] bytes = ((ProcCtx) context).serializationService().toBytes(value);\n+            assertArrayEquals(bytes, new byte[]{0, 0, 0, 0, 0, 0, 0, 42});\n+        } catch (Exception e) {", "originalCommit": "a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "chunk": "diff --git a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/JobLevelSerializerIsAvailable.java b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/JobLevelSerializerIsAvailable.java\nindex 2a493e252e..08d65fc8c5 100644\n--- a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/JobLevelSerializerIsAvailable.java\n+++ b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/JobLevelSerializerIsAvailable.java\n\n@@ -22,7 +22,6 @@ import com.hazelcast.jet.impl.execution.init.Contexts.ProcCtx;\n import javax.annotation.Nonnull;\n \n import static org.junit.Assert.assertArrayEquals;\n-import static org.junit.Assert.fail;\n \n public class JobLevelSerializerIsAvailable extends AbstractProcessor {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNjE3NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389726174", "bodyText": "We should not test the addClass functionality, but that the Jet can actually use the serializer. The test could have 2 vertices connected by a distributed edge. The source will generate a non-serializable object for which a custom serializer is used. The cluster must have at least 2 members, otherwise serialization isn't used.", "author": "viliam-durina", "createdAt": "2020-03-09T14:29:50Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/AbstractDeploymentTest.java", "diffHunk": "@@ -323,6 +328,23 @@ public void testDeployment_whenFileAddedAsResource_thenAvailableOnClassLoader()\n         executeAndPeel(getJetInstance().newJob(dag, jobConfig));\n     }\n \n+    @Test\n+    @SuppressWarnings(\"unchecked\")\n+    public void testDeployment_whenAddSerializer_thenAvailableOnJobContext() throws Throwable {", "originalCommit": "a0ef9769855ef7810e23cfbbe27ce938e8f5d298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0OTI1OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r389849258", "bodyText": "I'd just remove this test. It only tests job class loading in a confusing way.", "author": "viliam-durina", "createdAt": "2020-03-09T17:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNjE3NA=="}], "type": "inlineReview", "revised_code": {"commit": "e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "chunk": "diff --git a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/AbstractDeploymentTest.java b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/AbstractDeploymentTest.java\nindex 859e16bde8..9745aa930c 100644\n--- a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/AbstractDeploymentTest.java\n+++ b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/deployment/AbstractDeploymentTest.java\n\n@@ -340,7 +340,10 @@ public abstract class AbstractDeploymentTest extends SimpleTestInClusterSupport\n         DAG dag = new DAG();\n         dag.newVertex(\"calls job level serializer\", JobLevelSerializerIsAvailable::new);\n \n-        JobConfig jobConfig = new JobConfig().addSerializer(valueClass, serializerClass);\n+        JobConfig jobConfig = new JobConfig()\n+                .addClass(valueClass)\n+                .addClass(serializerClass)\n+                .registerStreamSerializer(serializerClass, valueClass);\n \n         executeAndPeel(getJetInstance().newJob(dag, jobConfig));\n     }\n"}}, {"oid": "facd60b138cb368cb4d386544e64f967b9e343f8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/facd60b138cb368cb4d386544e64f967b9e343f8", "message": "More tweaks", "committedDate": "2020-03-09T14:38:37Z", "type": "commit"}, {"oid": "e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e05ce79cf1c4f74dd96fdd7ce99359544c51641e", "message": "Address review comments", "committedDate": "2020-03-09T16:04:26Z", "type": "commit"}, {"oid": "633e29063d7b9df84f5d012ada29d4d417125357", "url": "https://github.com/hazelcast/hazelcast-jet/commit/633e29063d7b9df84f5d012ada29d4d417125357", "message": "Merge remote-tracking branch 'origin/jet_serializer' into jet_serializer\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "committedDate": "2020-03-09T16:05:40Z", "type": "commit"}, {"oid": "b3755c3462170fc3a3954b5bd019ab5c5b290143", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b3755c3462170fc3a3954b5bd019ab5c5b290143", "message": "Fix checkstyle", "committedDate": "2020-03-09T16:09:35Z", "type": "commit"}, {"oid": "a847c0d74fe8b460516dac72e160b34e28436bde", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a847c0d74fe8b460516dac72e160b34e28436bde", "message": "Add serializer distributed DAG test", "committedDate": "2020-03-10T08:24:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE4NTcyOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r390185728", "bodyText": "can we rename method to registerSerializerFor and have the parameters reversed. JobConfig.registerSerializerFor(Value.class, ValueSerializer.class)", "author": "cangencer", "createdAt": "2020-03-10T09:28:11Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "diffHunk": "@@ -927,6 +924,40 @@ private static File urlToFile(@Nonnull URL url) {\n         return resourceConfigs;\n     }\n \n+    /**\n+     * Registers the given serializer for the given class for the scope of the\n+     * job. It will be accessible to all the code attached to the underlying\n+     * pipeline or DAG, but not to any other code. (An important example is the\n+     * {@code IMap} data source, which can instantiate only the classes from\n+     * the Jet instance's classpath.)\n+     * <p>\n+     * Serializer must have no-arg constructor.\n+     *\n+     * @return {@code this} instance for fluent API\n+     */\n+    @Nonnull\n+    @EvolvingApi\n+    public <T, S extends StreamSerializer<?>> JobConfig registerStreamSerializer(@Nonnull Class<S> serializerClass,", "originalCommit": "a847c0d74fe8b460516dac72e160b34e28436bde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88b2fa6efe05f157da634bc1bd7246d87caed86d", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\nindex 965b90207a..0c8ed8557a 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n\n@@ -931,14 +931,17 @@ public class JobConfig implements IdentifiedDataSerializable {\n      * {@code IMap} data source, which can instantiate only the classes from\n      * the Jet instance's classpath.)\n      * <p>\n+     * Serializers registered on a job level have precedence over any serializer\n+     * registered on a cluster level.\n+     * <p>\n      * Serializer must have no-arg constructor.\n      *\n      * @return {@code this} instance for fluent API\n      */\n     @Nonnull\n     @EvolvingApi\n-    public <T, S extends StreamSerializer<?>> JobConfig registerStreamSerializer(@Nonnull Class<S> serializerClass,\n-                                                                                 @Nonnull Class<T> clazz) {\n+    public <T, S extends StreamSerializer<?>> JobConfig registerSerializerFor(@Nonnull Class<T> clazz,\n+                                                                              @Nonnull Class<S> serializerClass) {\n         serializerConfigs.put(clazz.getName(), serializerClass.getName());\n         return this;\n     }\n"}}, {"oid": "88b2fa6efe05f157da634bc1bd7246d87caed86d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/88b2fa6efe05f157da634bc1bd7246d87caed86d", "message": "Change serializer registration API", "committedDate": "2020-03-10T10:07:12Z", "type": "commit"}, {"oid": "02f8ff538dabc6b9ff3ab6f71be45a1890d83f4f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/02f8ff538dabc6b9ff3ab6f71be45a1890d83f4f", "message": "Fail on duplicate serializer registration", "committedDate": "2020-03-10T11:59:40Z", "type": "commit"}, {"oid": "86dba6b547af168541ef2d428b6716df629b2379", "url": "https://github.com/hazelcast/hazelcast-jet/commit/86dba6b547af168541ef2d428b6716df629b2379", "message": "Make sure serializers have unique typeIds", "committedDate": "2020-03-10T12:36:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3MTc3Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r390871772", "bodyText": "Do we need to preserve the iteration order? HashMap is cheaper. For resourceConfigs it's probably important because two added JARs can have duplicate classes, and the first one should be used, but here we don't allow duplicates.", "author": "viliam-durina", "createdAt": "2020-03-11T10:22:42Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "diffHunk": "@@ -65,6 +67,7 @@\n     private boolean storeMetricsAfterJobCompletion;\n \n     private Map<String, ResourceConfig> resourceConfigs = new LinkedHashMap<>();\n+    private Map<String, String> serializerConfigs = new LinkedHashMap<>();", "originalCommit": "86dba6b547af168541ef2d428b6716df629b2379", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "766796d1dfb3edb01c7e92971eb338b1899f9494", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\nindex 21b5307308..9d39a60f12 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n\n@@ -67,7 +68,7 @@ public class JobConfig implements IdentifiedDataSerializable {\n     private boolean storeMetricsAfterJobCompletion;\n \n     private Map<String, ResourceConfig> resourceConfigs = new LinkedHashMap<>();\n-    private Map<String, String> serializerConfigs = new LinkedHashMap<>();\n+    private Map<String, String> serializerConfigs = new HashMap<>();\n     private JobClassLoaderFactory classLoaderFactory;\n     private String initialSnapshotName;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg4MTM5Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2043#discussion_r390881392", "bodyText": "My opinion: can be named just registerSerializer. The \"for\" isn't needed.", "author": "viliam-durina", "createdAt": "2020-03-11T10:39:46Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java", "diffHunk": "@@ -927,6 +924,45 @@ private static File urlToFile(@Nonnull URL url) {\n         return resourceConfigs;\n     }\n \n+    /**\n+     * Registers the given serializer for the given class for the scope of the\n+     * job. It will be accessible to all the code attached to the underlying\n+     * pipeline or DAG, but not to any other code. (An important example is the\n+     * {@code IMap} data source, which can instantiate only the classes from\n+     * the Jet instance's classpath.)\n+     * <p>\n+     * Serializers registered on a job level have precedence over any serializer\n+     * registered on a cluster level.\n+     * <p>\n+     * Serializer must have no-arg constructor.\n+     *\n+     * @return {@code this} instance for fluent API\n+     */\n+    @Nonnull\n+    @EvolvingApi\n+    public <T, S extends StreamSerializer<?>> JobConfig registerSerializerFor(@Nonnull Class<T> clazz,", "originalCommit": "86dba6b547af168541ef2d428b6716df629b2379", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "766796d1dfb3edb01c7e92971eb338b1899f9494", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\nindex 21b5307308..9d39a60f12 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/config/JobConfig.java\n\n@@ -940,8 +941,8 @@ public class JobConfig implements IdentifiedDataSerializable {\n      */\n     @Nonnull\n     @EvolvingApi\n-    public <T, S extends StreamSerializer<?>> JobConfig registerSerializerFor(@Nonnull Class<T> clazz,\n-                                                                              @Nonnull Class<S> serializerClass) {\n+    public <T, S extends StreamSerializer<?>> JobConfig registerSerializer(@Nonnull Class<T> clazz,\n+                                                                           @Nonnull Class<S> serializerClass) {\n         Preconditions.checkFalse(serializerConfigs.containsKey(clazz.getName()),\n                 \"Serializer for \" + clazz + \" already registered\");\n         serializerConfigs.put(clazz.getName(), serializerClass.getName());\n"}}, {"oid": "766796d1dfb3edb01c7e92971eb338b1899f9494", "url": "https://github.com/hazelcast/hazelcast-jet/commit/766796d1dfb3edb01c7e92971eb338b1899f9494", "message": "Replace LinkedHashMap with HashMap & naming", "committedDate": "2020-03-11T10:46:29Z", "type": "commit"}, {"oid": "a24e32428ba59d7fad7fdac9efddeb1a0f206ed2", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a24e32428ba59d7fad7fdac9efddeb1a0f206ed2", "message": "Replace LinkedHashMap with HashMap & naming", "committedDate": "2020-03-11T10:54:17Z", "type": "commit"}, {"oid": "46f5ab78ece4cbe204fc8c0e47f5d4b202a6bd22", "url": "https://github.com/hazelcast/hazelcast-jet/commit/46f5ab78ece4cbe204fc8c0e47f5d4b202a6bd22", "message": "Replace LinkedHashMap with HashMap & naming", "committedDate": "2020-03-11T11:28:06Z", "type": "commit"}]}