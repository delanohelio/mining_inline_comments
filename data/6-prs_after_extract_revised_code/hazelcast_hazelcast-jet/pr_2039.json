{"pr_number": 2039, "pr_title": " Support job-level serializers in Processors", "pr_createdAt": "2020-03-04T10:40:25Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2039", "timeline": [{"oid": "c29b9e5fc0746e33110cad3466424db5c6caf197", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c29b9e5fc0746e33110cad3466424db5c6caf197", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-26T15:36:14Z", "type": "commit"}, {"oid": "6e6976eb21e40110c538fbc388b99faec472f52f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6e6976eb21e40110c538fbc388b99faec472f52f", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T07:53:24Z", "type": "commit"}, {"oid": "a177ca2125ef4aafc188c03886a88482e79fcd4a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a177ca2125ef4aafc188c03886a88482e79fcd4a", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T08:22:43Z", "type": "commit"}, {"oid": "454306a55534826bd1147d9723604c3de060c41b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/454306a55534826bd1147d9723604c3de060c41b", "message": "Add DataInput/DataOutput.", "committedDate": "2020-02-27T08:47:40Z", "type": "commit"}, {"oid": "34ffe5bf20b5a3158e222b36970094aa38f5d74b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/34ffe5bf20b5a3158e222b36970094aa38f5d74b", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:01:33Z", "type": "commit"}, {"oid": "e6ab4bbac5dd2d1ba8484331afd6a8bc0385c3de", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e6ab4bbac5dd2d1ba8484331afd6a8bc0385c3de", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:07:51Z", "type": "commit"}, {"oid": "001bcabe6a38134b8487c0cf8ceabd93efb8c909", "url": "https://github.com/hazelcast/hazelcast-jet/commit/001bcabe6a38134b8487c0cf8ceabd93efb8c909", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T09:33:18Z", "type": "commit"}, {"oid": "7b3b4022e83d0d59f56dfdce20c69348905dfcec", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7b3b4022e83d0d59f56dfdce20c69348905dfcec", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T10:32:36Z", "type": "commit"}, {"oid": "b64f1f3709cc9fd93d4740164f76dd79cba76fdf", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b64f1f3709cc9fd93d4740164f76dd79cba76fdf", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T10:42:50Z", "type": "commit"}, {"oid": "95edf20891d1ebab490072fcac899e85c8d0ef82", "url": "https://github.com/hazelcast/hazelcast-jet/commit/95edf20891d1ebab490072fcac899e85c8d0ef82", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T11:06:42Z", "type": "commit"}, {"oid": "d3a3ac276c46b6cf8fd246df9e873e3cbc90c7da", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d3a3ac276c46b6cf8fd246df9e873e3cbc90c7da", "message": "Merge branch 'master' into serializness_networking\n\n# Conflicts:\n#\tpom.xml", "committedDate": "2020-02-27T11:46:41Z", "type": "commit"}, {"oid": "01aa369f5e6065ee52c6ea47d3b6bc3721701806", "url": "https://github.com/hazelcast/hazelcast-jet/commit/01aa369f5e6065ee52c6ea47d3b6bc3721701806", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T11:54:45Z", "type": "commit"}, {"oid": "254fd66d3b3c3c4495471869ff308b604d3a82ca", "url": "https://github.com/hazelcast/hazelcast-jet/commit/254fd66d3b3c3c4495471869ff308b604d3a82ca", "message": "Merge branch 'master' into serializness_networking", "committedDate": "2020-02-27T12:34:25Z", "type": "commit"}, {"oid": "dec4d9c82eea8c86729364b40a042ff7c008f990", "url": "https://github.com/hazelcast/hazelcast-jet/commit/dec4d9c82eea8c86729364b40a042ff7c008f990", "message": "Add DataInput/DataOutput", "committedDate": "2020-02-27T14:06:07Z", "type": "commit"}, {"oid": "79bfadc3587c57b14263987eff2e50ae721c7191", "url": "https://github.com/hazelcast/hazelcast-jet/commit/79bfadc3587c57b14263987eff2e50ae721c7191", "message": "Fix tests", "committedDate": "2020-02-27T14:41:10Z", "type": "commit"}, {"oid": "c971f987750eae45e0ef6d77f271f79369f83846", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c971f987750eae45e0ef6d77f271f79369f83846", "message": "Configure SenderTasklet with custom SerializationService", "committedDate": "2020-02-28T08:31:35Z", "type": "commit"}, {"oid": "4bb2d4263aef1903a55396ad897991aceee3701b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4bb2d4263aef1903a55396ad897991aceee3701b", "message": "Simplify bytes writing & reading", "committedDate": "2020-02-28T10:25:07Z", "type": "commit"}, {"oid": "91cb86e9aae490b3b282428fc9c94ad062c9849e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/91cb86e9aae490b3b282428fc9c94ad062c9849e", "message": "Extract MemoryWriter & MemoryReader", "committedDate": "2020-02-28T11:54:36Z", "type": "commit"}, {"oid": "9648218d35d89c854f559975c6689ee11e95cb0f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9648218d35d89c854f559975c6689ee11e95cb0f", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-02-28T12:07:49Z", "type": "commit"}, {"oid": "6f730dc3e06639647269cb6f6fbf786e4dbca95a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f730dc3e06639647269cb6f6fbf786e4dbca95a", "message": "Add PR link to @Deprecated comment", "committedDate": "2020-03-02T08:13:27Z", "type": "commit"}, {"oid": "523e4e0c2146f62c114841de83b2238d0a25c1f5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/523e4e0c2146f62c114841de83b2238d0a25c1f5", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:20:05Z", "type": "commit"}, {"oid": "3c2f0290cf0877a8d4ad2ea7c59cec0e94ef9945", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3c2f0290cf0877a8d4ad2ea7c59cec0e94ef9945", "message": "Replace MemoryDataInput with MemoryReader to avoid allocation", "committedDate": "2020-03-02T08:50:27Z", "type": "commit"}, {"oid": "0220710637b6aceb8b9bedf4282b4cc132bcc5b7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0220710637b6aceb8b9bedf4282b4cc132bcc5b7", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:51:17Z", "type": "commit"}, {"oid": "5d09475761c52ecd34d222df9c28da3a68b04694", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5d09475761c52ecd34d222df9c28da3a68b04694", "message": "Replace MemoryDataInput with MemoryReader to avoid allocation", "committedDate": "2020-03-02T08:54:35Z", "type": "commit"}, {"oid": "b57b4855be49fc945a54980303afeadfec2f3a11", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b57b4855be49fc945a54980303afeadfec2f3a11", "message": "Merge branch 'serializness_networking' into sender_serializer", "committedDate": "2020-03-02T08:54:55Z", "type": "commit"}, {"oid": "25a7b7f9a56fe74eec7d965e741adafebee0fb2d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/25a7b7f9a56fe74eec7d965e741adafebee0fb2d", "message": "Configure Processors with custom SerializationService", "committedDate": "2020-03-02T13:08:34Z", "type": "commit"}, {"oid": "39c115d087ed8b62e78f92e1ef3521a6dd1b636a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/39c115d087ed8b62e78f92e1ef3521a6dd1b636a", "message": "Configure Processors with custom SerializationService", "committedDate": "2020-03-02T13:28:16Z", "type": "commit"}, {"oid": "1789785b1db1cb8997fc1342f4e775ceef659f58", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1789785b1db1cb8997fc1342f4e775ceef659f58", "message": "Merge branch 'master' into sender_serializer\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/Networking.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/ImdgUtil.java", "committedDate": "2020-03-03T10:20:53Z", "type": "commit"}, {"oid": "804620da117638cdcc0797999913ad12a5848017", "url": "https://github.com/hazelcast/hazelcast-jet/commit/804620da117638cdcc0797999913ad12a5848017", "message": "Merge branch 'sender_serializer' into processor_serializer", "committedDate": "2020-03-03T10:37:10Z", "type": "commit"}, {"oid": "52e51ea5b095a607fae14c7d6d6beb70de1dd479", "url": "https://github.com/hazelcast/hazelcast-jet/commit/52e51ea5b095a607fae14c7d6d6beb70de1dd479", "message": "Merge branch 'master' into sender_serializer\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/Networking.java\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/ImdgUtil.java", "committedDate": "2020-03-03T12:33:45Z", "type": "commit"}, {"oid": "51e2b2033ccdac77179e286687e54b989728aa98", "url": "https://github.com/hazelcast/hazelcast-jet/commit/51e2b2033ccdac77179e286687e54b989728aa98", "message": "Merge branch 'sender_serializer' into processor_serializer", "committedDate": "2020-03-03T12:34:26Z", "type": "commit"}, {"oid": "aa34a4f326b21597379bd2da65f61120401bba58", "url": "https://github.com/hazelcast/hazelcast-jet/commit/aa34a4f326b21597379bd2da65f61120401bba58", "message": "Merge branch 'master' into processor_serializer", "committedDate": "2020-03-04T10:17:18Z", "type": "commit"}, {"oid": "efa36aa04d432fd3b0a82fe2b5b34dfbde422018", "url": "https://github.com/hazelcast/hazelcast-jet/commit/efa36aa04d432fd3b0a82fe2b5b34dfbde422018", "message": "Formatting", "committedDate": "2020-03-04T10:22:23Z", "type": "commit"}, {"oid": "679f334edf283edd6a9cd56a5bd2742e53b7ba2b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/679f334edf283edd6a9cd56a5bd2742e53b7ba2b", "message": "Remove unused import", "committedDate": "2020-03-04T10:46:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5Mzc4MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387593781", "bodyText": "This is a public API method and InternalSerializationService is an internal interface. We should not expose it to the user.", "author": "viliam-durina", "createdAt": "2020-03-04T11:00:38Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java", "diffHunk": "@@ -131,5 +132,11 @@ static ProcessorSupplier of(@Nonnull SupplierEx<? extends Processor> processorSu\n          */\n         @Nonnull\n         File attachedFile(@Nonnull String id);\n+\n+        /**\n+         * Returns serialization service associated with this job.\n+         */\n+        @Nonnull\n+        InternalSerializationService serializationService();", "originalCommit": "679f334edf283edd6a9cd56a5bd2742e53b7ba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b68212389b6d08a05e3c2e0c3f53dc8171b6d069", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java\nindex 3fc40a476..c8e765c75 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java\n\n@@ -134,9 +134,9 @@ public interface ProcessorSupplier extends Serializable {\n         File attachedFile(@Nonnull String id);\n \n         /**\n-         * Returns serialization service associated with this job.\n+         * Returns {@link ManagedContext} associated with this job.\n          */\n         @Nonnull\n-        InternalSerializationService serializationService();\n+        ManagedContext managedContext();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MjA0MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387662040", "bodyText": "We should get the MangedContext from context.jetInstance().hazelcastInstance() downcasted to HazelcastInstanceImpl", "author": "viliam-durina", "createdAt": "2020-03-04T13:22:45Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java", "diffHunk": "@@ -109,6 +105,7 @@ public boolean isCooperative() {\n     @Override\n     protected void init(@Nonnull Context context) {\n         // createFn is allowed to return null, we'll call `destroyFn` even for null `ctx`\n+        ManagedContext managedContext = context.serializationService().getManagedContext();", "originalCommit": "679f334edf283edd6a9cd56a5bd2742e53b7ba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b68212389b6d08a05e3c2e0c3f53dc8171b6d069", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java\nindex 1af669091..a686d712b 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/ConvenientSourceP.java\n\n@@ -105,7 +105,7 @@ public class ConvenientSourceP<C, T, S> extends AbstractProcessor {\n     @Override\n     protected void init(@Nonnull Context context) {\n         // createFn is allowed to return null, we'll call `destroyFn` even for null `ctx`\n-        ManagedContext managedContext = context.serializationService().getManagedContext();\n+        ManagedContext managedContext = context.managedContext();\n         ctx = (C) managedContext.initialize(createFn.apply(context));\n         snapshotKey = broadcastKey(context.globalProcessorIndex());\n         initialized = true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MjMzOQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387662339", "bodyText": "Same here", "author": "viliam-durina", "createdAt": "2020-03-04T13:23:14Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java", "diffHunk": "@@ -64,6 +61,7 @@ public void init(@Nonnull Outbox outbox, @Nonnull Context context) {\n         if (localBuff == null) {\n             throw new JetException(\"Null buffer created\");\n         }\n+        ManagedContext managedContext = context.serializationService().getManagedContext();", "originalCommit": "679f334edf283edd6a9cd56a5bd2742e53b7ba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b68212389b6d08a05e3c2e0c3f53dc8171b6d069", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java\nindex 0929d20a8..535e019cb 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteBufferedP.java\n\n@@ -61,7 +61,7 @@ public final class WriteBufferedP<B, T> implements Processor {\n         if (localBuff == null) {\n             throw new JetException(\"Null buffer created\");\n         }\n-        ManagedContext managedContext = context.serializationService().getManagedContext();\n+        ManagedContext managedContext = context.managedContext();\n         buffer = (B) managedContext.initialize(localBuff);\n     }\n \n"}}, {"oid": "b68212389b6d08a05e3c2e0c3f53dc8171b6d069", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b68212389b6d08a05e3c2e0c3f53dc8171b6d069", "message": "Hide InternalSerializationService & expose ManagedContext", "committedDate": "2020-03-04T15:37:19Z", "type": "commit"}, {"oid": "15caea71b28e6feff19a98b34ece5ffddc94adfb", "url": "https://github.com/hazelcast/hazelcast-jet/commit/15caea71b28e6feff19a98b34ece5ffddc94adfb", "message": "Formatting", "committedDate": "2020-03-04T15:41:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc3ODQxMg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387778412", "bodyText": "ManagedContext is available also on ProcessorMetaSupplier level I think", "author": "viliam-durina", "createdAt": "2020-03-04T16:21:32Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/ProcessorSupplier.java", "diffHunk": "@@ -131,5 +132,11 @@ static ProcessorSupplier of(@Nonnull SupplierEx<? extends Processor> processorSu\n          */\n         @Nonnull\n         File attachedFile(@Nonnull String id);\n+\n+        /**\n+         * Returns {@link ManagedContext} associated with this job.\n+         */\n+        @Nonnull\n+        ManagedContext managedContext();", "originalCommit": "15caea71b28e6feff19a98b34ece5ffddc94adfb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc3OTc4MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387779780", "bodyText": "SerializationAware isn't public API. Public classes shouldn't implement non-public interfaces.", "author": "viliam-durina", "createdAt": "2020-03-04T16:23:24Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java", "diffHunk": "@@ -34,10 +38,20 @@\n  */\n public class TestProcessorSupplierContext\n         extends TestProcessorMetaSupplierContext\n-        implements ProcessorSupplier.Context {\n+        implements ProcessorSupplier.Context, SerializationAware {", "originalCommit": "15caea71b28e6feff19a98b34ece5ffddc94adfb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3471b2135dc9324485b8c20cfb2d9f0db06f6a7d", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java\nindex 44fc061ed..1dda773b9 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestProcessorSupplierContext.java\n\n@@ -38,20 +35,11 @@ import java.util.Map;\n  */\n public class TestProcessorSupplierContext\n         extends TestProcessorMetaSupplierContext\n-        implements ProcessorSupplier.Context, SerializationAware {\n+        implements ProcessorSupplier.Context {\n \n     private int memberIndex;\n-    private final Map<String, File> attached;\n-    private final InternalSerializationService serializationService;\n-\n-    public TestProcessorSupplierContext() {\n-        this(new DefaultSerializationServiceBuilder().setManagedContext(object -> object).build());\n-    }\n-\n-    TestProcessorSupplierContext(InternalSerializationService serializationService) {\n-        this.attached = new HashMap<>();\n-        this.serializationService = serializationService;\n-    }\n+    private ManagedContext managedContext = object -> object;\n+    private final Map<String, File> attached = new HashMap<>();\n \n     @Nonnull @Override\n     public TestProcessorSupplierContext setLogger(@Nonnull ILogger logger) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4MDc0OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387780749", "bodyText": "We can use the no-arg constructor", "author": "viliam-durina", "createdAt": "2020-03-04T16:24:53Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestSupport.java", "diffHunk": "@@ -791,21 +791,22 @@ private void doCall(String methodName, boolean isCooperative, Runnable r) {\n     }\n \n     private void initProcessor(Processor processor, TestOutbox outbox) {\n-        TestProcessorContext context = new TestProcessorContext()\n+        InternalSerializationService serializationService;\n+        if (jetInstance != null && jetInstance.getHazelcastInstance() instanceof SerializationServiceSupport) {\n+            SerializationServiceSupport impl = (SerializationServiceSupport) jetInstance.getHazelcastInstance();\n+            serializationService = (InternalSerializationService) impl.getSerializationService();\n+        } else {\n+            serializationService = new DefaultSerializationServiceBuilder()\n+                    .setManagedContext(e -> e)\n+                    .build();\n+        }\n+\n+        TestProcessorContext context = new TestProcessorContext(serializationService)", "originalCommit": "15caea71b28e6feff19a98b34ece5ffddc94adfb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3471b2135dc9324485b8c20cfb2d9f0db06f6a7d", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestSupport.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestSupport.java\nindex 53ffb593c..24d3e95cc 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestSupport.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/test/TestSupport.java\n\n@@ -791,18 +791,19 @@ public final class TestSupport {\n     }\n \n     private void initProcessor(Processor processor, TestOutbox outbox) {\n-        InternalSerializationService serializationService;\n-        if (jetInstance != null && jetInstance.getHazelcastInstance() instanceof SerializationServiceSupport) {\n+        SerializationService serializationService;\n+        if (jetInstance != null) {\n             SerializationServiceSupport impl = (SerializationServiceSupport) jetInstance.getHazelcastInstance();\n-            serializationService = (InternalSerializationService) impl.getSerializationService();\n+            serializationService = impl.getSerializationService();\n         } else {\n             serializationService = new DefaultSerializationServiceBuilder()\n                     .setManagedContext(e -> e)\n                     .build();\n         }\n \n-        TestProcessorContext context = new TestProcessorContext(serializationService)\n-                .setLogger(getLogger(processor.getClass().getName()));\n+        TestProcessorContext context = new TestProcessorContext()\n+                .setLogger(getLogger(processor.getClass().getName()))\n+                .setManagedContext(serializationService.getManagedContext());\n         if (jetInstance != null) {\n             context.setJetInstance(jetInstance);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4NTExNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2039#discussion_r387785116", "bodyText": "It would be safer and easier to get the managed context from the jetInstance(). Theoretically the serializationService could have different managedContext. It's not the member's serialization service. IMO, the managedContext shouldn't be published by it. Maybe we can even use SerializationService instead of InternalSerializationService, do we use any other method than toObject and toData?", "author": "viliam-durina", "createdAt": "2020-03-04T16:31:02Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java", "diffHunk": "@@ -225,6 +231,16 @@ private static String tempDirPrefix(String jetInstanceName, String jobId, String\n                     + \"-\" + jobId\n                     + \"-\" + resourceId.substring(0, min(32, resourceId.length())).replaceAll(\"[^\\\\w.\\\\-$]\", \"_\");\n         }\n+\n+        @Nonnull @Override\n+        public ManagedContext managedContext() {\n+            return serializationService.getManagedContext();", "originalCommit": "15caea71b28e6feff19a98b34ece5ffddc94adfb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3471b2135dc9324485b8c20cfb2d9f0db06f6a7d", "chunk": "diff --git a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java\nindex 25e7313c0..b8039b42f 100644\n--- a/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java\n+++ b/hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/Contexts.java\n\n@@ -237,7 +236,7 @@ public final class Contexts {\n             return serializationService.getManagedContext();\n         }\n \n-        @Nonnull @Override\n+        @Nonnull\n         public InternalSerializationService serializationService() {\n             return serializationService;\n         }\n"}}, {"oid": "3471b2135dc9324485b8c20cfb2d9f0db06f6a7d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3471b2135dc9324485b8c20cfb2d9f0db06f6a7d", "message": "Remove SerializationAware", "committedDate": "2020-03-05T08:04:59Z", "type": "commit"}, {"oid": "495200c265678c4c8a339ce9fecd787324f9cfe4", "url": "https://github.com/hazelcast/hazelcast-jet/commit/495200c265678c4c8a339ce9fecd787324f9cfe4", "message": "Fix test", "committedDate": "2020-03-05T08:07:21Z", "type": "commit"}, {"oid": "9a84fd96590e3590f78bc64fff04baf371552c9b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9a84fd96590e3590f78bc64fff04baf371552c9b", "message": "Tweaks", "committedDate": "2020-03-05T10:32:09Z", "type": "commit"}]}