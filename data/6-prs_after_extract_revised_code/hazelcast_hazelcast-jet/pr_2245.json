{"pr_number": 2245, "pr_title": "Improve gRPC module", "pr_createdAt": "2020-05-11T07:30:53Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2245", "timeline": [{"oid": "f9b52c6c4cf8aa977a775e4baadef913c3443043", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f9b52c6c4cf8aa977a775e4baadef913c3443043", "message": "Create channel per processor, add timeout settings", "committedDate": "2020-05-05T11:35:31Z", "type": "commit"}, {"oid": "7225ac893596c367719854b8680da1eb649ea1e6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7225ac893596c367719854b8680da1eb649ea1e6", "message": "Use common ForkJoinPool as channel executor", "committedDate": "2020-05-05T11:43:54Z", "type": "commit"}, {"oid": "9bc94b697a065367dd2955a730bccdb8ab4018ac", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9bc94b697a065367dd2955a730bccdb8ab4018ac", "message": "Fix javadoc", "committedDate": "2020-05-05T11:43:59Z", "type": "commit"}, {"oid": "6ba29ad5ce8a9337cf478164490ee68eca973c6d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6ba29ad5ce8a9337cf478164490ee68eca973c6d", "message": "Fix checkstyle", "committedDate": "2020-05-11T06:51:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM4MTY3OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r424381679", "bodyText": "missing @since, you can include here and drop the rest on the same file.", "author": "cangencer", "createdAt": "2020-05-13T12:01:01Z", "path": "extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.grpc.impl;\n+\n+import com.hazelcast.spi.properties.HazelcastProperty;\n+import io.grpc.stub.StreamObserver;\n+\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+/**\n+ * Properties of the grpc module\n+ */\n+public final class GrpcProperties {", "originalCommit": "6ba29ad5ce8a9337cf478164490ee68eca973c6d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "chunk": "diff --git a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\nsimilarity index 83%\nrename from extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java\nrename to extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\nindex c3bae8db5..09247059b 100644\n--- a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java\n+++ b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\n\n@@ -14,8 +14,9 @@\n  * limitations under the License.\n  */\n \n-package com.hazelcast.jet.grpc.impl;\n+package com.hazelcast.jet.grpc;\n \n+import com.hazelcast.jet.grpc.impl.BidirectionalStreamingService;\n import com.hazelcast.spi.properties.HazelcastProperty;\n import io.grpc.stub.StreamObserver;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Mzc4NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r427243784", "bodyText": "Better add seconds to the name. That way when you see the system property somewhere, you'll know the time unit.", "author": "mtopolnik", "createdAt": "2020-05-19T11:56:02Z", "path": "extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.grpc.impl;\n+\n+import com.hazelcast.spi.properties.HazelcastProperty;\n+import io.grpc.stub.StreamObserver;\n+\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+/**\n+ * Properties of the grpc module\n+ */\n+public final class GrpcProperties {\n+\n+    /**\n+     * Time to wait for {@link StreamObserver#onCompleted()} confirmation when destroying a\n+     * {@link BidirectionalStreamingService}\n+     * You may want to increase this value when your gRPC calls take longer than 1 s to cleanly shutdown the service.\n+     * <p>\n+     * The default value is 1 s\n+     *\n+     * @since 4.2\n+     */\n+    public static final HazelcastProperty DESTROY_TIMEOUT\n+            = new HazelcastProperty(\"jet.grpc.destroy.timeout\", 1, SECONDS);", "originalCommit": "6ba29ad5ce8a9337cf478164490ee68eca973c6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI3NjgwMw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r427276803", "bodyText": "Added.", "author": "frant-hartm", "createdAt": "2020-05-19T12:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Mzc4NA=="}], "type": "inlineReview", "revised_code": {"commit": "c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "chunk": "diff --git a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\nsimilarity index 83%\nrename from extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java\nrename to extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\nindex c3bae8db5..09247059b 100644\n--- a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcProperties.java\n+++ b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/GrpcProperties.java\n\n@@ -14,8 +14,9 @@\n  * limitations under the License.\n  */\n \n-package com.hazelcast.jet.grpc.impl;\n+package com.hazelcast.jet.grpc;\n \n+import com.hazelcast.jet.grpc.impl.BidirectionalStreamingService;\n import com.hazelcast.spi.properties.HazelcastProperty;\n import io.grpc.stub.StreamObserver;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0NTM4OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r427245388", "bodyText": "Add the timeout to the log statement, as well as instruction on how to set it (system property name).", "author": "mtopolnik", "createdAt": "2020-05-19T11:59:00Z", "path": "extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java", "diffHunk": "@@ -52,8 +52,8 @@ public static Throwable translateGrpcException(Throwable exception) {\n      * Tries orderly shutdown first {@link ManagedChannel#shutdown()}, then forceful shutdown\n      * {@link ManagedChannel#shutdownNow()}.\n      */\n-    public static void shutdownChannel(ManagedChannel channel, ILogger logger) throws InterruptedException {\n-        if (!channel.shutdown().awaitTermination(1, SECONDS)) {\n+    public static void shutdownChannel(ManagedChannel channel, ILogger logger, long timeout) throws InterruptedException {\n+        if (!channel.shutdown().awaitTermination(timeout, SECONDS)) {", "originalCommit": "6ba29ad5ce8a9337cf478164490ee68eca973c6d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "chunk": "diff --git a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\nindex bb03fdac7..298c7bad7 100644\n--- a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\n+++ b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\n\n@@ -47,14 +47,15 @@ public final class GrpcUtil {\n     }\n \n     /**\n-     * Shutdowns {@link ManagedChannel}\n+     * Shuts down a {@link ManagedChannel}\n      * <p>\n      * Tries orderly shutdown first {@link ManagedChannel#shutdown()}, then forceful shutdown\n      * {@link ManagedChannel#shutdownNow()}.\n      */\n     public static void shutdownChannel(ManagedChannel channel, ILogger logger, long timeout) throws InterruptedException {\n         if (!channel.shutdown().awaitTermination(timeout, SECONDS)) {\n-            logger.info(\"gRPC client has not shut down on time\");\n+            logger.info(\"gRPC client has not shut down within \" + timeout + \" seconds, you can override the timeout \" +\n+                    \"by setting the `jet.grpc.shutdown.timeout.seconds` system property\");\n \n             if (!channel.shutdownNow().awaitTermination(1, SECONDS)) {\n                 logger.info(\"gRPC client has not shut down on time, even after forceful shutdown\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Njk0NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r427246945", "bodyText": "Javadoc has a grammar error: \"Shutdowns\". Should be Shuts down {@link ManagedChannel}.", "author": "mtopolnik", "createdAt": "2020-05-19T12:01:57Z", "path": "extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java", "diffHunk": "@@ -52,8 +52,8 @@ public static Throwable translateGrpcException(Throwable exception) {\n      * Tries orderly shutdown first {@link ManagedChannel#shutdown()}, then forceful shutdown\n      * {@link ManagedChannel#shutdownNow()}.\n      */\n-    public static void shutdownChannel(ManagedChannel channel, ILogger logger) throws InterruptedException {\n-        if (!channel.shutdown().awaitTermination(1, SECONDS)) {\n+    public static void shutdownChannel(ManagedChannel channel, ILogger logger, long timeout) throws InterruptedException {", "originalCommit": "6ba29ad5ce8a9337cf478164490ee68eca973c6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI1ODI2MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2245#discussion_r427258261", "bodyText": "Most of the internet agrees with you, I bet both will be correct in 20 years! :-)", "author": "frant-hartm", "createdAt": "2020-05-19T12:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0Njk0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "chunk": "diff --git a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\nindex bb03fdac7..298c7bad7 100644\n--- a/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\n+++ b/extensions/grpc/src/main/java/com/hazelcast/jet/grpc/impl/GrpcUtil.java\n\n@@ -47,14 +47,15 @@ public final class GrpcUtil {\n     }\n \n     /**\n-     * Shutdowns {@link ManagedChannel}\n+     * Shuts down a {@link ManagedChannel}\n      * <p>\n      * Tries orderly shutdown first {@link ManagedChannel#shutdown()}, then forceful shutdown\n      * {@link ManagedChannel#shutdownNow()}.\n      */\n     public static void shutdownChannel(ManagedChannel channel, ILogger logger, long timeout) throws InterruptedException {\n         if (!channel.shutdown().awaitTermination(timeout, SECONDS)) {\n-            logger.info(\"gRPC client has not shut down on time\");\n+            logger.info(\"gRPC client has not shut down within \" + timeout + \" seconds, you can override the timeout \" +\n+                    \"by setting the `jet.grpc.shutdown.timeout.seconds` system property\");\n \n             if (!channel.shutdownNow().awaitTermination(1, SECONDS)) {\n                 logger.info(\"gRPC client has not shut down on time, even after forceful shutdown\");\n"}}, {"oid": "c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c06db67e9159c16fcd78d56ea7a35d2b4288f7e8", "message": "Address review comments", "committedDate": "2020-05-19T13:07:33Z", "type": "commit"}]}