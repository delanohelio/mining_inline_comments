{"pr_number": 2746, "pr_title": "Fix Hadoop tests on Windows", "pr_createdAt": "2020-12-09T15:22:06Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2746", "timeline": [{"oid": "a951cfd6b1dd8d3c9a654a41dafd7edcfae98aad", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a951cfd6b1dd8d3c9a654a41dafd7edcfae98aad", "message": "Fix Hadoop tests on Windows\n\n- we must check `hasHadoopPrefix` first before\nPaths.get(path).isAbsolute, because path such as `hdfs://something`\nfails on windows due to the `:`\n\n- there should be only one `assumeThatNoWindowsOS` to comment out if we\nwant to test on windows\n\n- update hadoop to 3.3.0 due to\nhttps://issues.apache.org/jira/browse/HDFS-14890 found in 3.2.1", "committedDate": "2020-12-09T15:21:20Z", "type": "commit"}, {"oid": "9444a0eeb87c3a3bc14e4a37440dfa874ec63487", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9444a0eeb87c3a3bc14e4a37440dfa874ec63487", "message": "Fix test failures", "committedDate": "2020-12-09T15:54:08Z", "type": "commit"}, {"oid": "4f03f3ac9cd75632a5f577b116273ff180e96c1f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4f03f3ac9cd75632a5f577b116273ff180e96c1f", "message": "Go back to hadoop 3.2.1", "committedDate": "2020-12-09T16:44:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzNzA0MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2746#discussion_r540937041", "bodyText": "Why shouldn't this test run on windows? I understand why shouldReadFileWithEscapedGlob doesn't run because of * in filename is not allowed on windows, but here the * is in the path, matching any directory.", "author": "frant-hartm", "createdAt": "2020-12-11T13:12:33Z", "path": "extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/PathAndGlobFileSourceTest.java", "diffHunk": "@@ -51,6 +51,7 @@ public void shouldReadFilesMatchingGlobInTheMiddle() {\n \n     @Test\n     public void shouldReadFilesMatchingGlobInPath() {\n+        assumeThatNoWindowsOS(); // * is not allowed in filename", "originalCommit": "4f03f3ac9cd75632a5f577b116273ff180e96c1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc5NzIzMg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2746#discussion_r542797232", "bodyText": "I don't know, maybe hadoop supports glob chars, but it fails on this line in Paths.get. Paths doesn't support glob characters. If this is the case, we have to check that the directory is absolute in some other way. Also, if I'm not mistaken, globs are matched differently on windows and linux, and java's FileSystem.getPathMatcher() specifies its own syntax (maybe it's that of linux, i don't know).\nSecondly, I don't know what should the * mean. The test is disabled for local file system - because in local file system we read only a single directory - will hadoop read multiple directories? Also, this behavior isn't specified:\n     * The path must point to a directory. All files in the directory are\n     * processed. The directory is not processed recursively.\n\nIMO we should disallow this behavior...", "author": "viliam-durina", "createdAt": "2020-12-14T21:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzNzA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5MjI1MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2746#discussion_r543392251", "bodyText": "Ok, it seems quite a mess. I have some bugs reported for the file connector, so will send it with those fixes.", "author": "frant-hartm", "createdAt": "2020-12-15T14:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzNzA0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0MDA5OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2746#discussion_r540940098", "bodyText": "This is what I had originally, but didn't pass on Windows due to different line endings. I think it depends on git config core.autocrlf value. Isn't setting this config to true a standard practice on windows? It results in the file having the following content:\nText contents of\\r\\nthe file.\\r\\n", "author": "frant-hartm", "createdAt": "2020-12-11T13:17:49Z", "path": "extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/TextFileFormatTest.java", "diffHunk": "@@ -35,10 +35,7 @@ public void readTextFileAsSingleItem() {\n                                                       .glob(\"file.txt\")\n                                                       .format(FileFormat.text());\n \n-        assertItemsInSource(source,\n-                \"Text contents of\" + System.lineSeparator() +\n-                        \"the file.\" + System.lineSeparator()\n-        );\n+        assertItemsInSource(source, \"Text contents of\\nthe file.\\n\");", "originalCommit": "4f03f3ac9cd75632a5f577b116273ff180e96c1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgxNzUxNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2746#discussion_r542817516", "bodyText": "I don't know, but we shouldn't depend on some git setting. It's typically better to not do any conversion. Today even Windows Notepad can open files with linux file endings. I have that option off.\nI changed the text to load the file using Files.readAllBytes so that it can work regardless of that setting.", "author": "viliam-durina", "createdAt": "2020-12-14T21:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0MDA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "7b19c0a07fa5c99a20c61e7a6f09eb3ccb4c6f2b", "chunk": "diff --git a/extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/TextFileFormatTest.java b/extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/TextFileFormatTest.java\nindex c16c21624c..6b18f84cbe 100644\n--- a/extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/TextFileFormatTest.java\n+++ b/extensions/hadoop/src/test/java/com/hazelcast/jet/hadoop/file/TextFileFormatTest.java\n\n@@ -30,12 +33,16 @@ import static org.assertj.core.api.Assumptions.assumeThat;\n public class TextFileFormatTest extends BaseFileFormatTest {\n \n     @Test\n-    public void readTextFileAsSingleItem() {\n+    public void readTextFileAsSingleItem() throws Exception {\n         FileSourceBuilder<String> source = FileSources.files(currentDir + \"/src/test/resources\")\n                                                       .glob(\"file.txt\")\n                                                       .format(FileFormat.text());\n \n-        assertItemsInSource(source, \"Text contents of\\nthe file.\\n\");\n+        String expected = new String(\n+                Files.readAllBytes(Paths.get(currentDir, \"/src/test/resources\", \"file.txt\")),\n+                StandardCharsets.UTF_8);\n+\n+        assertItemsInSource(source, expected);\n     }\n \n     @Test\n"}}, {"oid": "eb84e93b7e37aaf0391fc97d5bea3956e4167e38", "url": "https://github.com/hazelcast/hazelcast-jet/commit/eb84e93b7e37aaf0391fc97d5bea3956e4167e38", "message": "Merge remote-tracking branch 'remotes/hazelcast/master' into hadoop-tests", "committedDate": "2020-12-14T20:22:37Z", "type": "commit"}, {"oid": "7b19c0a07fa5c99a20c61e7a6f09eb3ccb4c6f2b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7b19c0a07fa5c99a20c61e7a6f09eb3ccb4c6f2b", "message": "Address review comments", "committedDate": "2020-12-14T21:35:42Z", "type": "commit"}, {"oid": "46a32359348727c4b7241009c3cb6ffd4dcb0be4", "url": "https://github.com/hazelcast/hazelcast-jet/commit/46a32359348727c4b7241009c3cb6ffd4dcb0be4", "message": "Fix javadoc", "committedDate": "2020-12-14T22:17:33Z", "type": "commit"}, {"oid": "c29c2dea8c6a39edfe56f06a5021f4c7051d2764", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c29c2dea8c6a39edfe56f06a5021f4c7051d2764", "message": "Fix compilation", "committedDate": "2020-12-15T07:18:11Z", "type": "commit"}]}