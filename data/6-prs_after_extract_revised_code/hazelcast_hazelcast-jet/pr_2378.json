{"pr_number": 2378, "pr_title": "[005] Make Postgres dataloss on snapshot-stream sync less severe", "pr_createdAt": "2020-06-29T14:52:43Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2378", "timeline": [{"oid": "594795b29a06436d448d2e17a4669415468bd538", "url": "https://github.com/hazelcast/hazelcast-jet/commit/594795b29a06436d448d2e17a4669415468bd538", "message": "Add test for data loss, set snapshot mode to `exported`", "committedDate": "2020-06-29T07:47:25Z", "type": "commit"}, {"oid": "d47f4c1b5906048605f5225ce9ce583242cf79ad", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d47f4c1b5906048605f5225ce9ce583242cf79ad", "message": "Document data loss problem", "committedDate": "2020-06-30T09:11:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTYzMQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2378#discussion_r447639631", "bodyText": "The Debezium PostgreSQL Connector this source is based on has data loss issues when ... - this should be rewritten, seem like there are some left words after rewritting", "author": "olukas", "createdAt": "2020-06-30T12:21:42Z", "path": "extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java", "diffHunk": "@@ -46,12 +46,20 @@ private PostgresCdcSources() {\n      * Creates a CDC source that streams change data from a PostgreSQL database\n      * to Hazelcast Jet.\n      * <p>\n-     * If Jet can't reach the database when it attempts to start the source or\n-     * if it looses the connection to the database from an already running\n-     * source, it throws an exception and terminate the execution of the job.\n-     * This behaviour is not ideal, would be much better to try to reconnect,\n-     * at least for a certain amount of time. Future versions will address the\n-     * problem.\n+     * <b>KNOWN ISSUE 1:</b> If Jet can't reach the database when it attempts to\n+     * start the source or if it looses the connection to the database from an\n+     * already running source, it throws an exception and terminate the\n+     * execution of the job. This behaviour is not ideal, would be much better\n+     * to try to reconnect, at least for a certain amount of time. Future\n+     * versions will address the problem.\n+     * <p>\n+     * <b>KNOWN ISSUE 2:</b> The Debezium PostgreSQL Connector this source is", "originalCommit": "d47f4c1b5906048605f5225ce9ce583242cf79ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxMTA3NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2378#discussion_r447711074", "bodyText": "No, it's actually correct, barring some comas missing, but I'll rephrase it to a simpler form, because that will make it clearer.", "author": "jbartok", "createdAt": "2020-06-30T14:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTYzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "146895b793a87e561c25f0f831611afa16c5a025", "chunk": "diff --git a/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java b/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\nindex 76eabe462..260b806f8 100644\n--- a/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\n+++ b/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\n\n@@ -53,13 +53,14 @@ public final class PostgresCdcSources {\n      * to try to reconnect, at least for a certain amount of time. Future\n      * versions will address the problem.\n      * <p>\n-     * <b>KNOWN ISSUE 2:</b> The Debezium PostgreSQL Connector this source is\n-     * based on has data loss issues when synchronizing snapshots with event\n-     * streams based on the Postgres WAL (Write-Ahead Log). For details see\n-     * <a href=\"https://issues.redhat.com/browse/DBZ-2288\">DBZ-2288</a>.\n+     * <b>KNOWN ISSUE 2:</b> This source is based on the Debezium PostgreSQL\n+     * Connector, which has some data loss issues when synchronizing snapshots\n+     * with the stream of events coming from the Postgres WAL (Write-Ahead Log).\n+     * For details see <a href=\"https://issues.redhat.com/browse/DBZ-2288\">DBZ-2288</a>.\n      * Currently the first streaming event that should come in right after the\n-     * snapshot ends is lost. The issue is actively being looked into and we\n-     * will release a fix immediately as it's available.\n+     * snapshot ends is lost. Sometimes even more events can be lost. The issue\n+     * is actively being looked into and we will release a fix immediately as\n+     * it's available.\n      *\n      * @param name name of this source, needs to be unique, will be passed to\n      *             the underlying Kafka Connect source\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY0MDM5NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2378#discussion_r447640394", "bodyText": "It seems that more items still can be missed after some circumstances. It also not right for events which came a longer time after snapshot (i.e. if there is not update of DB during snapshotting)", "author": "olukas", "createdAt": "2020-06-30T12:23:10Z", "path": "extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java", "diffHunk": "@@ -46,12 +46,20 @@ private PostgresCdcSources() {\n      * Creates a CDC source that streams change data from a PostgreSQL database\n      * to Hazelcast Jet.\n      * <p>\n-     * If Jet can't reach the database when it attempts to start the source or\n-     * if it looses the connection to the database from an already running\n-     * source, it throws an exception and terminate the execution of the job.\n-     * This behaviour is not ideal, would be much better to try to reconnect,\n-     * at least for a certain amount of time. Future versions will address the\n-     * problem.\n+     * <b>KNOWN ISSUE 1:</b> If Jet can't reach the database when it attempts to\n+     * start the source or if it looses the connection to the database from an\n+     * already running source, it throws an exception and terminate the\n+     * execution of the job. This behaviour is not ideal, would be much better\n+     * to try to reconnect, at least for a certain amount of time. Future\n+     * versions will address the problem.\n+     * <p>\n+     * <b>KNOWN ISSUE 2:</b> The Debezium PostgreSQL Connector this source is\n+     * based on has data loss issues when synchronizing snapshots with event\n+     * streams based on the Postgres WAL (Write-Ahead Log). For details see\n+     * <a href=\"https://issues.redhat.com/browse/DBZ-2288\">DBZ-2288</a>.\n+     * Currently the first streaming event that should come in right after the", "originalCommit": "d47f4c1b5906048605f5225ce9ce583242cf79ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "146895b793a87e561c25f0f831611afa16c5a025", "chunk": "diff --git a/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java b/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\nindex 76eabe462..260b806f8 100644\n--- a/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\n+++ b/extensions/cdc-postgres/src/main/java/com/hazelcast/jet/cdc/postgres/PostgresCdcSources.java\n\n@@ -53,13 +53,14 @@ public final class PostgresCdcSources {\n      * to try to reconnect, at least for a certain amount of time. Future\n      * versions will address the problem.\n      * <p>\n-     * <b>KNOWN ISSUE 2:</b> The Debezium PostgreSQL Connector this source is\n-     * based on has data loss issues when synchronizing snapshots with event\n-     * streams based on the Postgres WAL (Write-Ahead Log). For details see\n-     * <a href=\"https://issues.redhat.com/browse/DBZ-2288\">DBZ-2288</a>.\n+     * <b>KNOWN ISSUE 2:</b> This source is based on the Debezium PostgreSQL\n+     * Connector, which has some data loss issues when synchronizing snapshots\n+     * with the stream of events coming from the Postgres WAL (Write-Ahead Log).\n+     * For details see <a href=\"https://issues.redhat.com/browse/DBZ-2288\">DBZ-2288</a>.\n      * Currently the first streaming event that should come in right after the\n-     * snapshot ends is lost. The issue is actively being looked into and we\n-     * will release a fix immediately as it's available.\n+     * snapshot ends is lost. Sometimes even more events can be lost. The issue\n+     * is actively being looked into and we will release a fix immediately as\n+     * it's available.\n      *\n      * @param name name of this source, needs to be unique, will be passed to\n      *             the underlying Kafka Connect source\n"}}, {"oid": "146895b793a87e561c25f0f831611afa16c5a025", "url": "https://github.com/hazelcast/hazelcast-jet/commit/146895b793a87e561c25f0f831611afa16c5a025", "message": "Improve javadoc", "committedDate": "2020-06-30T14:11:09Z", "type": "commit"}]}