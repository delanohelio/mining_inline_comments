{"pr_number": 2537, "pr_title": "Fix MySql related intermittent network test failures (issue #2534)", "pr_createdAt": "2020-09-21T10:45:33Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2537", "timeline": [{"oid": "0319c6fd0e2c2fbb8e17e3afb901766ce2af7199", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0319c6fd0e2c2fbb8e17e3afb901766ce2af7199", "message": "Disable using Ryuk resource reaper", "committedDate": "2020-09-21T10:38:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzNzc4Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2537#discussion_r493237786", "bodyText": "Could you add a comment explaining this? I have no idea why it is needed.", "author": "frant-hartm", "createdAt": "2020-09-23T06:52:36Z", "path": "extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java", "diffHunk": "@@ -93,6 +99,12 @@\n         });\n     }\n \n+    @Before\n+    public void before() {", "originalCommit": "0319c6fd0e2c2fbb8e17e3afb901766ce2af7199", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0628bb6301001b5fc7230db8e363700eb78f3a81", "chunk": "diff --git a/extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java b/extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java\nindex 301db2c31..be01d131f 100644\n--- a/extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java\n+++ b/extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java\n\n@@ -101,6 +101,10 @@ public class MySqlCdcNetworkIntegrationTest extends AbstractCdcIntegrationTest {\n \n     @Before\n     public void before() {\n+        //disable Testcontainer's automatic resource manager\n+        //containers are cleaned up explicitly\n+        //automatic resource manager is just an extra thing that can break\n+        //(have had problems with it not being cleaned up properly itself)\n         environmentVariables.set(\"TESTCONTAINERS_RYUK_DISABLED\", \"true\");\n         assertEquals(\"true\", System.getenv(\"TESTCONTAINERS_RYUK_DISABLED\"));\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzOTk4NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2537#discussion_r493239985", "bodyText": "Not related to this PR, but could it be made more deterministic by having a CountDownLatch, call await here and CountDownLatch#countDown in a first step of the pipeline (peek/map)?", "author": "frant-hartm", "createdAt": "2020-09-23T06:56:43Z", "path": "extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java", "diffHunk": "@@ -139,31 +151,34 @@ public void when_networkDisconnectDuringSnapshotting_then_jetSourceIsStuckUntilR\n                 ToxiproxyContainer toxiproxy = initToxiproxy(network);\n         ) {\n             MySQLContainer<?> mysql = initMySql(network, null);\n-            ToxiproxyContainer.ContainerProxy proxy = initProxy(toxiproxy, mysql);\n-            Pipeline pipeline = initPipeline(proxy.getContainerIpAddress(), proxy.getProxyPort());\n-            // when job starts\n-            JetInstance jet = createJetMembers(2)[0];\n-            Job job = jet.newJob(pipeline);\n-            assertJobStatusEventually(job, RUNNING);\n+            try {\n+                ToxiproxyContainer.ContainerProxy proxy = initProxy(toxiproxy, mysql);\n+                Pipeline pipeline = initPipeline(proxy.getContainerIpAddress(), proxy.getProxyPort());\n+                // when job starts\n+                JetInstance jet = createJetMembers(2)[0];\n+                Job job = jet.newJob(pipeline);\n+                assertJobStatusEventually(job, RUNNING);\n \n-            // and snapshotting is ongoing (we have no exact way of identifying\n-            // the moment, but random sleep will catch it at least some of the time)\n-            TimeUnit.MILLISECONDS.sleep(ThreadLocalRandom.current().nextInt(0, 500));\n+                // and snapshotting is ongoing (we have no exact way of identifying\n+                // the moment, but random sleep will catch it at least some of the time)\n+                TimeUnit.MILLISECONDS.sleep(ThreadLocalRandom.current().nextInt(0, 500));", "originalCommit": "0319c6fd0e2c2fbb8e17e3afb901766ce2af7199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1NDMxMw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2537#discussion_r493254313", "bodyText": "In this test I'm trying to see what happens if the connection to the DB drops while snapshotting is going on. Snapshotting is a process with 9 stages. I'm interested to see what happens in all the stages, on connection drop. If I would make the test more deterministic (for example the way you suggest), then it would probably always trigger around the same stage, towards the end or after snapshotting. I don't want that. With such a random sleep there will eventually always be runs for all possible scenarios. Yes, it's not deterministic, will be hard to debug, but if there is a problem we will likely find out about it. Eventually. This was my thinking.", "author": "jbartok", "createdAt": "2020-09-23T07:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzOTk4NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0628bb6301001b5fc7230db8e363700eb78f3a81", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0628bb6301001b5fc7230db8e363700eb78f3a81", "message": "Add comment to clarify intention", "committedDate": "2020-09-23T07:25:26Z", "type": "commit"}, {"oid": "52a9d4993a25bd026f6617b6c95541d3873363c0", "url": "https://github.com/hazelcast/hazelcast-jet/commit/52a9d4993a25bd026f6617b6c95541d3873363c0", "message": "Merge branch 'master' into issue-2534", "committedDate": "2020-09-23T08:19:28Z", "type": "commit"}, {"oid": "e1ee0451e8c676df7dd059a942d8177a22cfd33c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e1ee0451e8c676df7dd059a942d8177a22cfd33c", "message": "Add missing explanation to before method", "committedDate": "2020-09-23T08:20:51Z", "type": "commit"}, {"oid": "6f5752386c723b26692253850f9405daa298cd5c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f5752386c723b26692253850f9405daa298cd5c", "message": "Exclude junit-dep from newly added dependency", "committedDate": "2020-09-23T09:00:27Z", "type": "commit"}]}