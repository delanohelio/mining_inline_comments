{"pr_number": 2538, "pr_title": "Add test for not emit windows too early with sparse events", "pr_createdAt": "2020-09-21T12:54:22Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2538", "timeline": [{"oid": "83b3c855dceff82cc8b652a8c0da08777d8295c9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/83b3c855dceff82cc8b652a8c0da08777d8295c9", "message": "Add test for not emit windows too early with sparse events", "committedDate": "2020-09-21T12:51:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0NDY1MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2538#discussion_r492144650", "bodyText": "This is time-sensitive. If it takes 5 secs to submit the job, this assert can fail.\nWe can instead start measuring before submitting the job and we can safely check that more than 15 seconds passed before the first event appeared.\nlong start = System.nanoTime();\nnewJob(p);\nassertTrueEventually( /* one item in sinkList */);\nassertTrue(System.nanoTime() - start > 15 seconds);", "author": "viliam-durina", "createdAt": "2020-09-21T15:22:12Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/StreamSourceStageTest.java", "diffHunk": "@@ -165,6 +167,29 @@ public void when_sparseItemsWithIngestionTimestamps_then_noExtraLatency() {\n         job.cancel();\n     }\n \n+    @Test\n+    @Category(NightlyTest.class)\n+    public void when_sparseItemsWithIngestionTimestamps_then_windowIsNotEmittedTooEarly() {\n+        IList<WindowResult<Long>> sinkList = instance.getList(randomMapName());\n+        IMap<Integer, Integer> map = instance.getMap(randomMapName());\n+\n+        Pipeline p = Pipeline.create();\n+        p.readFrom(Sources.mapJournal(map, START_FROM_OLDEST))\n+         .withIngestionTimestamps()\n+         .window(WindowDefinition.session(15_000))\n+         .aggregate(AggregateOperations.counting())\n+         .writeTo(Sinks.list(sinkList));\n+\n+        Job job = instance.newJob(p);\n+        assertEquals(0, sinkList.size());\n+        map.put(5, 5);\n+\n+        assertTrueAllTheTime(() -> assertEquals(0, sinkList.size()), 10);", "originalCommit": "83b3c855dceff82cc8b652a8c0da08777d8295c9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "393a2e55ef09f4fa333910d96e8ec04a371f763b", "chunk": "diff --git a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/StreamSourceStageTest.java b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/StreamSourceStageTest.java\nindex 9b4add8fba..b99b321c9c 100644\n--- a/hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/StreamSourceStageTest.java\n+++ b/hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/StreamSourceStageTest.java\n\n@@ -180,13 +182,12 @@ public class StreamSourceStageTest extends StreamSourceStageTestBase {\n          .aggregate(AggregateOperations.counting())\n          .writeTo(Sinks.list(sinkList));\n \n+        long start = System.nanoTime();\n         Job job = instance.newJob(p);\n         assertEquals(0, sinkList.size());\n         map.put(5, 5);\n-\n-        assertTrueAllTheTime(() -> assertEquals(0, sinkList.size()), 10);\n         assertTrueEventually(() -> assertEquals(1, sinkList.size()), 30);\n-\n+        assertTrue(System.nanoTime() - start > SECONDS.toNanos(15));\n         job.cancel();\n     }\n \n"}}, {"oid": "393a2e55ef09f4fa333910d96e8ec04a371f763b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/393a2e55ef09f4fa333910d96e8ec04a371f763b", "message": "Improve test robustness", "committedDate": "2020-09-22T14:12:18Z", "type": "commit"}, {"oid": "393a2e55ef09f4fa333910d96e8ec04a371f763b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/393a2e55ef09f4fa333910d96e8ec04a371f763b", "message": "Improve test robustness", "committedDate": "2020-09-22T14:12:18Z", "type": "forcePushed"}]}