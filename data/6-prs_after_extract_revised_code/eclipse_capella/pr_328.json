{"pr_number": 328, "pr_title": "[566264] Some operations might create unwanted Entities as a side effect", "pr_createdAt": "2020-08-21T12:49:18Z", "pr_url": "https://github.com/eclipse/capella/pull/328", "timeline": [{"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302", "url": "https://github.com/eclipse/capella/commit/605561b88349aacdd379d1fdf30d45e5b6fa8302", "message": "[566264] Some operations might create unwanted Entities as a side effect\n\nThe problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture,\nboolean: TRUE) method in functions called at the Operational Level.\n\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\n\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>", "committedDate": "2020-08-24T11:40:42Z", "type": "commit"}, {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302", "url": "https://github.com/eclipse/capella/commit/605561b88349aacdd379d1fdf30d45e5b6fa8302", "message": "[566264] Some operations might create unwanted Entities as a side effect\n\nThe problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture,\nboolean: TRUE) method in functions called at the Operational Level.\n\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\n\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>", "committedDate": "2020-08-24T11:40:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDg4OA==", "url": "https://github.com/eclipse/capella/pull/328#discussion_r475540888", "bodyText": "the getOrCreateSystem can still be dangerous on oa, as it will create always a new entity.\nmaybe we can replace oa.getSystem call by a getFirstEntity?\n\nDone.", "author": "sandupostaru", "createdAt": "2020-08-24T11:43:52Z", "path": "core/plugins/org.polarsys.capella.core.model.helpers/src/org/polarsys/capella/core/model/helpers/BlockArchitectureExt.java", "diffHunk": "@@ -684,15 +684,24 @@ public static boolean isDefaultNameRootFunction(AbstractNamedElement element) {\n    * @param architecture\n    * @param create\n    * @return\n+   * \n+   * @deprecated use {@link BlockArchitecture::getSystem} or {@link BlockArchitectureExt::getOrCreateComponent} instead.\n    */\n+  @Deprecated\n   public static Component getFirstComponent(BlockArchitecture architecture, boolean create) {\n     Component first = null;\n \n     if (architecture instanceof OperationalAnalysis) {\n-      first = ((OperationalAnalysis) architecture).getSystem();\n+      EntityPkg entityPkg = (EntityPkg) getComponentPkg(architecture, true);\n+      EList<Entity> ownedEntities = entityPkg.getOwnedEntities();\n+\n+      first = ownedEntities.stream().filter(x -> !x.isActor()).findFirst().orElse(null);\n+\n       if ((first == null) && create) {\n         first = OaFactory.eINSTANCE.createEntity(NamingConstants.CreateOaAnalysisCmd_entity_name);\n-        ((EntityPkg) getComponentPkg(architecture, true)).getOwnedEntities().add((Entity) first);\n+        ownedEntities.add((Entity) first);\n+\n+        CapellaElementExt.creationService(first);", "originalCommit": "605561b88349aacdd379d1fdf30d45e5b6fa8302", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}