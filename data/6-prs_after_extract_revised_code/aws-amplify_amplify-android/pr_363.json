{"pr_number": 363, "pr_title": "Add unit tests for offline predictions", "pr_createdAt": "2020-04-07T18:47:55Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/363", "timeline": [{"oid": "754f74a12d40b8e2f92a88091a5972708c7e293c", "url": "https://github.com/aws-amplify/amplify-android/commit/754f74a12d40b8e2f92a88091a5972708c7e293c", "message": "Add unit tests for offline predictions", "committedDate": "2020-04-07T18:45:13Z", "type": "commit"}, {"oid": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "url": "https://github.com/aws-amplify/amplify-android/commit/cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "message": "Remove test runners", "committedDate": "2020-04-07T18:52:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0NDEzOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405044138", "bodyText": "One of the reason I user factories all the time is that they allow you to write code above the equivalent of this(...). e.g.,\nstatic TensorFlowTextClassificationService fromContext(@NonNull Context context) {\n    Objects.requireNonNull(context);\n    TextClassificationModel model = new TextClassificationModel(context);\n    TextClassificationDictionary dictionary = new TextClassificationDictionary(context);\n    TextClassifcationLabels labels = new TextClassificationLabels(context);\n    return new TensorFlowTextClassificationService(model, dictionary, labels);\n}\n\nOverall, you just don't have to fight the syntax as hard, with this approach ^^ as compared the constructor-way.", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:02:40Z", "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -62,13 +64,23 @@\n      * @param context the Android context\n      */\n     TensorFlowTextClassificationService(@NonNull Context context) {", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76a513697c6e07f394a6cc694cab213be0043ec7", "chunk": "diff --git a/aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java b/aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java\nindex 5faa0ad7..a2e2c5f4 100644\n--- a/aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java\n+++ b/aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java\n\n@@ -61,14 +62,12 @@ final class TensorFlowTextClassificationService {\n      * Constructs an instance of service to perform text\n      * sentiment interpretation using TensorFlow Lite\n      * interpreter.\n-     * @param context the Android context\n+     * @param interpreter the TensorFlow Lite interpreter with\n+     *                    loaded model\n+     * @param dictionary the dictionary of words and respective\n+     *                   tokens\n+     * @param labels the list of labels for a feature\n      */\n-    TensorFlowTextClassificationService(@NonNull Context context) {\n-        this(new TextClassificationModel(context),\n-                new TextClassificationDictionary(context),\n-                new TextClassificationLabels(context));\n-    }\n-\n     @VisibleForTesting\n     TensorFlowTextClassificationService(\n             TextClassificationModel interpreter,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0OTA4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405049083", "bodyText": "If you already have package visibility for classify(...), can you just test through it?\nThe only problem I can see might be that latch, which would block stuff.\nAh, haha. Okay. Remember that crazy Loadable<List<Loadable<?, PredictionsException>>, PredictionsException>? If you use that, and then accept it as a dependency in the constructor, you can \"fake\" whether or not this service is loaded.\nAssuming you can push loaded.await(); into the implementation of that big Loadable, that'll help you when you run classify from test. (In source, you provide an impl that blocks. In test, you provide a mock(Loadable.class) that does whatever you want.\nI guess the actual latch await call would change to:\nif (!compoundLoadable.isLoaded()) {\n    compountLoadable.load();\n}\n\nOr something like that.", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:11:27Z", "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -132,7 +148,8 @@ void classify(\n         }\n     }\n \n-    private Sentiment fetchSentiment(String text) throws PredictionsException {", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MzMwNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405083304", "bodyText": "This test is to directly test the behavior of fetchSentiment. How about if I write more tests for blocking behavior in the future when I improve on the current latch design?", "author": "raphkim", "createdAt": "2020-04-07T20:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0OTA4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0OTYzMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405049633", "bodyText": "Since both of these are in @Before scope, I would move this when arrangement up right underneath them, there, too.", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:12:23Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that input conversion to TensorFlow Lite tokens\n+ * works as intended.\n+ */\n+public final class InputTokenizerTest {\n+    private static final long LOAD_TIMEOUT_MS = 100;\n+\n+    private Context mockContext;\n+    private AssetManager mockAssets;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock Android context and asset manager\n+        mockContext = mock(Context.class);\n+        mockAssets = mock(AssetManager.class);\n+    }\n+\n+    /**\n+     * Test that text tokenizer converts input text into a 2-D\n+     * array of equivalent token values and pads the rest with 0's.\n+     * @throws Exception if dictionary fails to load\n+     */\n+    @Test\n+    @SuppressWarnings(\"MagicNumber\") // word tokens\n+    public void testInputTextTokenizer() throws Exception {\n+        final CountDownLatch loaded = new CountDownLatch(1);\n+        final AtomicReference<Map<String, Integer>> tokens = new AtomicReference<>();\n+        final AtomicReference<PredictionsException> error = new AtomicReference<>();\n+\n+        final String inputText = \"Where is the bathroom?\";\n+        final InputStream stream = new FileInputStream(\"src/test/resources/word-tokens.txt\");\n+\n+        // Make mock context return mock asset manager\n+        when(mockContext.getAssets()).thenReturn(mockAssets);", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NjQ4Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405066487", "bodyText": "I envision adding more tests in this suite that tests different types of assets to load (for different predictions verbs), so I structured it like this intentionally.", "author": "raphkim", "createdAt": "2020-04-07T19:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0OTYzMw=="}], "type": "inlineReview", "revised_code": {"commit": "76a513697c6e07f394a6cc694cab213be0043ec7", "chunk": "diff --git a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\nindex c63b58d8..445a0786 100644\n--- a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n+++ b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n\n@@ -19,6 +19,7 @@ import android.content.Context;\n import android.content.res.AssetManager;\n \n import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.testutils.Await;\n \n import org.junit.Before;\n import org.junit.Test;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTA5MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405051091", "bodyText": "You can use the Await utility for this:\nMap<String, Integer> tokens = Await.<WhateverResultType, PredictionsException>result(\n    (onResult, onError) -> dictionary.onLoaded(onResult::accept, onError::accept)\n);\n\nThis way, you don't have to mess around with a CountDownLatch,  yourself.", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:15:02Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that input conversion to TensorFlow Lite tokens\n+ * works as intended.\n+ */\n+public final class InputTokenizerTest {\n+    private static final long LOAD_TIMEOUT_MS = 100;\n+\n+    private Context mockContext;\n+    private AssetManager mockAssets;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock Android context and asset manager\n+        mockContext = mock(Context.class);\n+        mockAssets = mock(AssetManager.class);\n+    }\n+\n+    /**\n+     * Test that text tokenizer converts input text into a 2-D\n+     * array of equivalent token values and pads the rest with 0's.\n+     * @throws Exception if dictionary fails to load\n+     */\n+    @Test\n+    @SuppressWarnings(\"MagicNumber\") // word tokens\n+    public void testInputTextTokenizer() throws Exception {\n+        final CountDownLatch loaded = new CountDownLatch(1);\n+        final AtomicReference<Map<String, Integer>> tokens = new AtomicReference<>();\n+        final AtomicReference<PredictionsException> error = new AtomicReference<>();\n+\n+        final String inputText = \"Where is the bathroom?\";\n+        final InputStream stream = new FileInputStream(\"src/test/resources/word-tokens.txt\");\n+\n+        // Make mock context return mock asset manager\n+        when(mockContext.getAssets()).thenReturn(mockAssets);\n+\n+        // Make mock asset manager return pre-determined input stream\n+        when(mockAssets.open(anyString())).thenReturn(stream);\n+\n+        // Load!! (from mock assets)\n+        TextClassificationDictionary dictionary = new TextClassificationDictionary(mockContext)\n+                .onLoaded(\n+                    onLoad -> {\n+                        loaded.countDown();\n+                        tokens.set(onLoad);\n+                    },\n+                    onError -> {\n+                        loaded.countDown();\n+                        error.set(onError);\n+                    }\n+                );", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2OTEyNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405069127", "bodyText": "Ah I was wrestling with that for a bit, but I think I got it now!", "author": "raphkim", "createdAt": "2020-04-07T19:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MTk1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405081957", "bodyText": "Haha yea, it's a compound statement with a lot of syntax...", "author": "jamesonwilliams", "createdAt": "2020-04-07T20:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTA5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "76a513697c6e07f394a6cc694cab213be0043ec7", "chunk": "diff --git a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\nindex c63b58d8..445a0786 100644\n--- a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n+++ b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n\n@@ -19,6 +19,7 @@ import android.content.Context;\n import android.content.res.AssetManager;\n \n import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.testutils.Await;\n \n import org.junit.Before;\n import org.junit.Test;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTU5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405051595", "bodyText": "(This will go away with Await, too. But nit: MILLISECONDS! Not MICROSECONDS.)", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:15:57Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that input conversion to TensorFlow Lite tokens\n+ * works as intended.\n+ */\n+public final class InputTokenizerTest {\n+    private static final long LOAD_TIMEOUT_MS = 100;\n+\n+    private Context mockContext;\n+    private AssetManager mockAssets;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock Android context and asset manager\n+        mockContext = mock(Context.class);\n+        mockAssets = mock(AssetManager.class);\n+    }\n+\n+    /**\n+     * Test that text tokenizer converts input text into a 2-D\n+     * array of equivalent token values and pads the rest with 0's.\n+     * @throws Exception if dictionary fails to load\n+     */\n+    @Test\n+    @SuppressWarnings(\"MagicNumber\") // word tokens\n+    public void testInputTextTokenizer() throws Exception {\n+        final CountDownLatch loaded = new CountDownLatch(1);\n+        final AtomicReference<Map<String, Integer>> tokens = new AtomicReference<>();\n+        final AtomicReference<PredictionsException> error = new AtomicReference<>();\n+\n+        final String inputText = \"Where is the bathroom?\";\n+        final InputStream stream = new FileInputStream(\"src/test/resources/word-tokens.txt\");\n+\n+        // Make mock context return mock asset manager\n+        when(mockContext.getAssets()).thenReturn(mockAssets);\n+\n+        // Make mock asset manager return pre-determined input stream\n+        when(mockAssets.open(anyString())).thenReturn(stream);\n+\n+        // Load!! (from mock assets)\n+        TextClassificationDictionary dictionary = new TextClassificationDictionary(mockContext)\n+                .onLoaded(\n+                    onLoad -> {\n+                        loaded.countDown();\n+                        tokens.set(onLoad);\n+                    },\n+                    onError -> {\n+                        loaded.countDown();\n+                        error.set(onError);\n+                    }\n+                );\n+        dictionary.load();\n+        loaded.await(LOAD_TIMEOUT_MS, TimeUnit.MICROSECONDS);", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2OTcxNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405069716", "bodyText": "oh wow i guess I shouldn't have relied on autocomplete LOL", "author": "raphkim", "createdAt": "2020-04-07T19:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MjU0NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405082544", "bodyText": "This exact thing happens to me all the time. It's probably something IntelliSense could improve.", "author": "jamesonwilliams", "createdAt": "2020-04-07T20:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MTU5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "76a513697c6e07f394a6cc694cab213be0043ec7", "chunk": "diff --git a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\nindex c63b58d8..445a0786 100644\n--- a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n+++ b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n\n@@ -19,6 +19,7 @@ import android.content.Context;\n import android.content.res.AssetManager;\n \n import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.testutils.Await;\n \n import org.junit.Before;\n import org.junit.Test;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MjgwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405052802", "bodyText": "int[] values = { 1, 2, 9, 4, 2};\nfor (int index = 0; index < : values.size(); index++) {\n    expected[0][index] = values[index];\n}", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:18:02Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that input conversion to TensorFlow Lite tokens\n+ * works as intended.\n+ */\n+public final class InputTokenizerTest {\n+    private static final long LOAD_TIMEOUT_MS = 100;\n+\n+    private Context mockContext;\n+    private AssetManager mockAssets;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock Android context and asset manager\n+        mockContext = mock(Context.class);\n+        mockAssets = mock(AssetManager.class);\n+    }\n+\n+    /**\n+     * Test that text tokenizer converts input text into a 2-D\n+     * array of equivalent token values and pads the rest with 0's.\n+     * @throws Exception if dictionary fails to load\n+     */\n+    @Test\n+    @SuppressWarnings(\"MagicNumber\") // word tokens\n+    public void testInputTextTokenizer() throws Exception {\n+        final CountDownLatch loaded = new CountDownLatch(1);\n+        final AtomicReference<Map<String, Integer>> tokens = new AtomicReference<>();\n+        final AtomicReference<PredictionsException> error = new AtomicReference<>();\n+\n+        final String inputText = \"Where is the bathroom?\";\n+        final InputStream stream = new FileInputStream(\"src/test/resources/word-tokens.txt\");\n+\n+        // Make mock context return mock asset manager\n+        when(mockContext.getAssets()).thenReturn(mockAssets);\n+\n+        // Make mock asset manager return pre-determined input stream\n+        when(mockAssets.open(anyString())).thenReturn(stream);\n+\n+        // Load!! (from mock assets)\n+        TextClassificationDictionary dictionary = new TextClassificationDictionary(mockContext)\n+                .onLoaded(\n+                    onLoad -> {\n+                        loaded.countDown();\n+                        tokens.set(onLoad);\n+                    },\n+                    onError -> {\n+                        loaded.countDown();\n+                        error.set(onError);\n+                    }\n+                );\n+        dictionary.load();\n+        loaded.await(LOAD_TIMEOUT_MS, TimeUnit.MICROSECONDS);\n+        if (error.get() != null) {\n+            fail(\"Failed to load dictionary.\");\n+        }\n+\n+        // Assert that load was successful\n+        assertEquals(tokens.get(), dictionary.getValue());\n+\n+        // Tokenize input\n+        float[][] input = dictionary.tokenizeInputText(inputText);\n+        float[][] expected = new float[1][input[0].length];\n+        expected[0][0] = 1; // <START>\n+        expected[0][1] = 2; // Where (<UNKNOWN>)\n+        expected[0][2] = 9; // is\n+        expected[0][3] = 4; // the\n+        expected[0][4] = 2; // bathroom (<UNKNOWN>)\n+        // Followed by 0's (<PAD>)", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MDc4Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405070787", "bodyText": "I was considering that, but I think the way I currently have it written makes it easier to document what each number means", "author": "raphkim", "createdAt": "2020-04-07T19:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1MjgwMg=="}], "type": "inlineReview", "revised_code": {"commit": "76a513697c6e07f394a6cc694cab213be0043ec7", "chunk": "diff --git a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\nindex c63b58d8..445a0786 100644\n--- a/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n+++ b/aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/asset/InputTokenizerTest.java\n\n@@ -19,6 +19,7 @@ import android.content.Context;\n import android.content.res.AssetManager;\n \n import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.testutils.Await;\n \n import org.junit.Before;\n import org.junit.Test;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NTAwNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405055007", "bodyText": "Instead of mocking the dictionary, can your provide text_classification_vocab.txt, and use real one?", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:21:53Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/service/TextClassificationTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+import com.amplifyframework.testutils.random.RandomString;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Random;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that sentiment detection using TensorFlow Lite interpreter\n+ * to output Amplify text interpretation result works.\n+ */\n+public final class TextClassificationTest {\n+\n+    private TextClassificationModel mockInterpreter;\n+    private TextClassificationDictionary mockDictionary;\n+    private TextClassificationLabels mockLabels;\n+\n+    private TensorFlowTextClassificationService service;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock asset loaders\n+        mockInterpreter = mock(TextClassificationModel.class);\n+        mockDictionary = mock(TextClassificationDictionary.class);", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3MjE2Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405072163", "bodyText": "I was trying to stay away from relying on androidx and robolectric if possible. I think this is sufficient for now.", "author": "raphkim", "createdAt": "2020-04-07T19:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MzI2Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405083263", "bodyText": "There are pros and cons -- the less you mock, the more \"real\" your test is, and the more coverage you get. Plus, you'll be able to keep final on your class, to keep it \"closed.\"\nThe only con is really just that Robolectric is slow.", "author": "jamesonwilliams", "createdAt": "2020-04-07T20:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5NDk4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405094983", "bodyText": "One more note --\nI used to write (and I have seen a lot of others write) tests like this:\n// Assuming a simple actor like ...\nclass ObjectUnderTest {\n    private final Dependency dependency;\n    ObjectUnderTest(Dependency dependency) {\n        this.dependency = dependency;\n    }\n    Value lookupValue() {\n        return dependency.getValue();\n     }\n}\n\n// Here, we mock out all dependencies of the unit, and write a test\n// that basically just re-codifies or implementation logic into Mockito syntax.\npublic final class AnemicUnitTest {\n    private Dependency dependency;\n    @Before\n    public void setup() {\n        this.dependency = mock(Dependency.class);\n        this.objectUnderTest = new ObjectUnderTest(dependency);\n    }\n\n    @Test\n    public void lookupValueCallsDependency() {\n        when(dependency.getValue()).thenReturn(Value.of(2));\n        assertEquals(Value.of(2), doSomething.lookupValue());\n    }\n}\n\nThis is an \"anemic\" unit test, where all dependencies are mocked. We've verified that the unit of code (the ObjectUnderTest) calls our Dependency. But so what? The complexity is very low.\nNow, let's imagine Dependency is something like TensorFlow, and getValue() triggers thousands of lines of code to be executed. If we can avoid using the mock, we have a bonafide component test on our hands, and a good indication that the ObjectUnderTest itself will work in a real-world application.\n// Here, we test *both* ObjectUnderTest, and the direct dependencies it needs to its job\npublic final class ComponentTest {\n     private RealDependency dependency;\n     private ObjectUnderTest objectUnderTest;\n\n     @Before\n      public void setup() {\n          this.dependency = new RealDependency();\n          this.objectUnderTest = new ObjectUnderTest(dependency);\n      }\n\n      @Test\n      public void lookupValueReturnsExpectedValue() {\n          // Value is not arranged, but derived form real world business conditions\n          dependency.setColor(\"#441155\"); // Some logic mutates the dependency state\n          assertTrue(Value.of(44), objectUnderTest.getValue());\n      }\n}", "author": "jamesonwilliams", "createdAt": "2020-04-07T20:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NTAwNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NzEyNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405057127", "bodyText": "It might make sense to have a\npublic interface TextClassificationModel<T> extends Loadable<T, PredictionsException> {\n    ...\n}\n\nwith a:\npublic final class TensorFlowTextInterpreter implements TextClassificationModel<Interpreter> {\n    ...\n}\n\nThen, in your test you can mock(TestClassificationModel.class), but in your source, you can keep TensorflowTextInperpreter.", "author": "jamesonwilliams", "createdAt": "2020-04-07T19:25:39Z", "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/TextClassificationModel.java", "diffHunk": "@@ -37,7 +37,7 @@\n  * Loads the pre-trained text classification model into\n  * a TensorFlow Lite interpreter instance.\n  */\n-public final class TextClassificationModel implements Loadable<Interpreter, PredictionsException> {\n+public class TextClassificationModel implements Loadable<Interpreter, PredictionsException> {", "originalCommit": "cd52e3ad7b92d9c37960ac145ee6534b8e37ca86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NjQ2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405076466", "bodyText": "interfaces are almost always great, but I think we shouldn't overuse it either. TextClassificationModel would be a bit too specific of a concept to be appropriate as an interface, and we are not really getting concrete advantage out of it besides allowing its instance to be final.", "author": "raphkim", "createdAt": "2020-04-07T20:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NzEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4Mzc4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405083785", "bodyText": "Yea, actually, agreed. There aren't going be multiple text classification services -- it's the TensorFlow plugin. The only alternate would be for test purposes. So I do agree, that's overkill.", "author": "jamesonwilliams", "createdAt": "2020-04-07T20:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NzEyNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "76a513697c6e07f394a6cc694cab213be0043ec7", "url": "https://github.com/aws-amplify/amplify-android/commit/76a513697c6e07f394a6cc694cab213be0043ec7", "message": "Apply Jameson's PR suggestions", "committedDate": "2020-04-07T20:16:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2MDQxNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/363#discussion_r405260414", "bodyText": "Huh, I like this indexing.", "author": "jamesonwilliams", "createdAt": "2020-04-08T05:06:12Z", "path": "aws-predictions-tensorflow/src/test/java/com/amplifyframework/predictions/tensorflow/service/TextClassificationTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+import com.amplifyframework.testutils.random.RandomString;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Random;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test that sentiment detection using TensorFlow Lite interpreter\n+ * to output Amplify text interpretation result works.\n+ */\n+public final class TextClassificationTest {\n+\n+    private TextClassificationModel mockInterpreter;\n+    private TextClassificationDictionary mockDictionary;\n+    private TextClassificationLabels mockLabels;\n+\n+    private TensorFlowTextClassificationService service;\n+\n+    /**\n+     * Set up mock behavior before each test.\n+     */\n+    @Before\n+    public void setUp() {\n+        // Mock asset loaders\n+        mockInterpreter = mock(TextClassificationModel.class);\n+        mockDictionary = mock(TextClassificationDictionary.class);\n+        mockLabels = mock(TextClassificationLabels.class);\n+\n+        // Create text classifier with mock asset loaders\n+        service = new TensorFlowTextClassificationService(\n+                mockInterpreter,\n+                mockDictionary,\n+                mockLabels\n+        );\n+    }\n+\n+    /**\n+     * Test that fetchSentiment() can do the following.\n+     *\n+     *  - Choose the output with highest score,\n+     *  - obtain the column index,\n+     *  - obtain the label located at that index,\n+     *  - convert the label into {@link SentimentType}, and\n+     *  - return appropriate {@link Sentiment}\n+     *\n+     * @throws Exception if sentiment fetch fails\n+     */\n+    @Test\n+    @SuppressWarnings(\"MagicNumber\") // Double comparison delta epsilon\n+    public void testFetchSentiment() throws Exception {\n+        // List of labels to expect\n+        final List<String> labels = Arrays.asList(\n+                \"negative\",\n+                \"positive\",\n+                \"unknown1\",\n+                \"unknown2\"\n+        );\n+        // Mock random confidence score\n+        final float confidenceScore = new Random().nextFloat();\n+\n+        // Make mock interpreter set confidence score for\n+        // \"positive\" label into pre-determined random value\n+        doAnswer(invocation -> {\n+            float[][] output = invocation.getArgument(1, float[][].class);\n+            output[0][labels.indexOf(\"positive\")] = confidenceScore;", "originalCommit": "76a513697c6e07f394a6cc694cab213be0043ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}