{"pr_number": 656, "pr_title": "chore(datastore): Use AppSyncGraphQLRequest instead of SimpleGraphQLRequest for sync queries", "pr_createdAt": "2020-07-20T23:39:23Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/656", "timeline": [{"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "url": "https://github.com/aws-amplify/amplify-android/commit/0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "message": "Use AppSyncGraphQLRequest instead of SimpleGraphQLRequest for sync queries", "committedDate": "2020-07-20T22:21:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MDkzOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457850939", "bodyText": "Almost certainly not a comment for this PR, but while I'm here:\nI hadn't thought about this at the time, but get, list, sync: these are really verbs from the AppSync domain, aren't they? GraphQL itself has no such pre-defined operation types. Should we aim to move the QueryType enum into aws-api-appsync?", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:47:26Z", "path": "core/src/main/java/com/amplifyframework/api/graphql/QueryType.java", "diffHunk": "@@ -27,7 +27,12 @@\n     /**\n      * GraphQL query list.\n      */\n-    LIST;\n+    LIST,\n+\n+    /**\n+     * GraphQL query sync.\n+     */\n+    SYNC;", "originalCommit": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2ODU3Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r459068577", "bodyText": "That makes sense, I will move it to aws-api-appsync.  I think there's several more things like this that I will also be moving over soon.", "author": "richardmcclellan", "createdAt": "2020-07-22T20:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MDkzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTQ5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457851492", "bodyText": "nit-pick: consider wrapping on the =, not on the ..", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:49:02Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -69,10 +73,10 @@ public void validateRequestGenerationForDeltaSync() throws DataStoreException {\n     @Test\n     public void validateRequestGenerationForPagination() throws DataStoreException {\n         final String nextToken = Resources.readAsString(\"base-sync-request-next-token-value.txt\").trim();\n-        assertEquals(\n-            Resources.readAsString(\"base-sync-request-paginating-blog-owners.txt\"),\n-            AppSyncRequestFactory.buildSyncDoc(BlogOwner.class, null, nextToken)\n-        );\n+        final GraphQLRequest<Iterable<Post>> request = AppSyncRequestFactory\n+                .buildSyncRequest(BlogOwner.class, null, nextToken);", "originalCommit": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd8ba92197a811034bbda03aef4870990d12cc7f", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\nindex bb566c12..f7b562f6 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n\n@@ -73,8 +72,8 @@ public final class AppSyncRequestFactoryTest {\n     @Test\n     public void validateRequestGenerationForPagination() throws DataStoreException {\n         final String nextToken = Resources.readAsString(\"base-sync-request-next-token-value.txt\").trim();\n-        final GraphQLRequest<Iterable<Post>> request = AppSyncRequestFactory\n-                .buildSyncRequest(BlogOwner.class, null, nextToken);\n+        final GraphQLRequest<Iterable<Post>> request =\n+                AppSyncRequestFactory.buildSyncRequest(BlogOwner.class, null, nextToken);\n         assertEquals(Resources.readAsString(\"base-sync-request-paginating-blog-owners.txt\"), request.getQuery());\n         assertEquals(Collections.singletonMap(\"nextToken\", nextToken), request.getVariables());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTcyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457851728", "bodyText": "Just java.util.Collections here, not the Emory repackaged one.", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:49:46Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -30,6 +31,8 @@\n \n import java.util.Map;\n \n+import edu.emory.mathcs.backport.java.util.Collections;", "originalCommit": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd8ba92197a811034bbda03aef4870990d12cc7f", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\nindex bb566c12..f7b562f6 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n\n@@ -29,10 +29,9 @@ import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.robolectric.RobolectricTestRunner;\n \n+import java.util.Collections;\n import java.util.Map;\n \n-import edu.emory.mathcs.backport.java.util.Collections;\n-\n import static org.junit.Assert.assertEquals;\n \n /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MjkyNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457852924", "bodyText": "What are the possible resolutions for T, here -- Iterable<String>, and importantly, some upcoming type of paginated result?", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:53:17Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java", "diffHunk": "@@ -85,70 +84,32 @@ private AppSyncRequestFactory() {}\n      * @throws DataStoreException On Failure to inspect\n      */\n     @NonNull\n-    static <T extends Model> String buildSyncDoc(\n-            @NonNull final Class<T> modelClass,\n+    static <T, M extends Model> AppSyncGraphQLRequest<T> buildSyncRequest(", "originalCommit": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MDk2Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r459060963", "bodyText": "Yep, right now it is Iterable<String>, but my next PR will change it to be PaginatedResult<ModelWithMetadata<M>>", "author": "richardmcclellan", "createdAt": "2020-07-22T20:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MjkyNA=="}], "type": "inlineReview", "revised_code": {"commit": "bd8ba92197a811034bbda03aef4870990d12cc7f", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\nindex 4d18a9f7..b1b8e2ca 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\n\n@@ -95,7 +94,7 @@ final class AppSyncRequestFactory {\n                     .modelClass(modelClass)\n                     .operation(QueryType.SYNC)\n                     .requestOptions(new DataStoreGraphQLRequestOptions())\n-                    .responseType(new TypeToken<Iterable<String>>(){}.getType());\n+                    .responseType(TypeMaker.getParameterizedType(Iterable.class, String.class));\n \n             if (lastSync != null) {\n                 builder.variable(\"lastSync\", \"AWSTimestamp\", lastSync);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MzI0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457853240", "bodyText": "You have your little type factory gizmo where you can do like TypeFactory.of(Iterable.class, String.class) right? That'd remove the gson import from the top of the doc, which would be cool from an encapsulation standpoint.", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:54:18Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java", "diffHunk": "@@ -85,70 +84,32 @@ private AppSyncRequestFactory() {}\n      * @throws DataStoreException On Failure to inspect\n      */\n     @NonNull\n-    static <T extends Model> String buildSyncDoc(\n-            @NonNull final Class<T> modelClass,\n+    static <T, M extends Model> AppSyncGraphQLRequest<T> buildSyncRequest(\n+            @NonNull final Class<M> modelClass,\n             @Nullable final Long lastSync,\n             @SuppressWarnings(\"SameParameterValue\") @Nullable final String nextToken)\n             throws DataStoreException {\n \n-        final StringBuilder doc = new StringBuilder();\n-\n-        ModelSchema schema;\n         try {\n-            schema = ModelSchema.fromModelClass(modelClass);\n-        } catch (AmplifyException amplifyException) {\n-            throw new DataStoreException(\"Failed to get fields for model.\",\n-                    amplifyException, \"Validate your model file.\");\n-        }\n-        final String capitalizedPluralName = Casing.capitalizeFirst(schema.getPluralName());\n-\n-        int indent = 0;\n-        // Outer container, e.g. query SyncBlogPost {\n-        doc.append(\"query Sync\").append(capitalizedPluralName).append(\" {\\n\");\n-\n-        // Inner directive, e.g. syncBlogPosts(\n-        doc.append(padBy(++indent)).append(\"sync\").append(capitalizedPluralName);\n+            AppSyncGraphQLRequest.Builder builder = AppSyncGraphQLRequest.builder()\n+                    .modelClass(modelClass)\n+                    .operation(QueryType.SYNC)\n+                    .requestOptions(new DataStoreGraphQLRequestOptions())\n+                    .responseType(new TypeToken<Iterable<String>>(){}.getType());", "originalCommit": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MTQwMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r459071400", "bodyText": "Updated!", "author": "richardmcclellan", "createdAt": "2020-07-22T20:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MzI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "bd8ba92197a811034bbda03aef4870990d12cc7f", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\nindex 4d18a9f7..b1b8e2ca 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java\n\n@@ -95,7 +94,7 @@ final class AppSyncRequestFactory {\n                     .modelClass(modelClass)\n                     .operation(QueryType.SYNC)\n                     .requestOptions(new DataStoreGraphQLRequestOptions())\n-                    .responseType(new TypeToken<Iterable<String>>(){}.getType());\n+                    .responseType(TypeMaker.getParameterizedType(Iterable.class, String.class));\n \n             if (lastSync != null) {\n                 builder.variable(\"lastSync\", \"AWSTimestamp\", lastSync);\n"}}, {"oid": "bd8ba92197a811034bbda03aef4870990d12cc7f", "url": "https://github.com/aws-amplify/amplify-android/commit/bd8ba92197a811034bbda03aef4870990d12cc7f", "message": "PR feedback", "committedDate": "2020-07-22T20:43:14Z", "type": "commit"}]}