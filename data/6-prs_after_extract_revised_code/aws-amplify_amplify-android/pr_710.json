{"pr_number": 710, "pr_title": "feat(datastore) Trigger hub events during sync", "pr_createdAt": "2020-08-08T02:09:45Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/710", "timeline": [{"oid": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "url": "https://github.com/aws-amplify/amplify-android/commit/3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "message": "feat(datastore) Trigger hub events during sync", "committedDate": "2020-08-08T02:05:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NDYzOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467384639", "bodyText": "Should we also remove REMOTE_SYNC_STARTED and REMOTE_SYNC_STOPPED as part of this? Right now, I think we have some duplicative code. A good goal would be to align the events to iOS and Android. In so doing, that means we have to rename/remove the events we have, that already provide a similar functionality.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:14:38Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -52,7 +52,22 @@\n     /**\n      * The remote synchonization processes stopped.\n      */\n-    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\");\n+    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\"),", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ3MzQ0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467473441", "bodyText": "Makes sense. We're using this for a slightly different purpose I believe (it's more of a orchestrator start and stop), but I don't believe anyone is using this as it is not documented.", "author": "rjuliano", "createdAt": "2020-08-08T15:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NDYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg4ODQ5OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470888499", "bodyText": "I removed REMOTE_SYNC_STOPPED and REMOTE_SYNC_STARTED", "author": "rjuliano", "createdAt": "2020-08-14T22:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NDYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "f84d1a08b86134b63dc8980234947fe41dfd7d04", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\nindex e4486c0c..f6276cb7 100644\n--- a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n\n@@ -65,7 +65,9 @@ public enum DataStoreChannelEventName {\n     SYNC_QUERIES_READY(\"syncQueriesReady\"),\n \n     /**\n-     * All models have been synced.\n+     * The sync process for one of the models has completed. This\n+     * event is emitted with metrics related to the latest sync\n+     * for the model.\n      */\n     MODEL_SYNCED(\"modelSynced\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTM1MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467385350", "bodyText": "I'm not sure what \"sync queries ready\" means, just from the name. Is this a good name?\nThe Javadoc is the same on L63 and L68 so I think at least one needs to be updated.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:16:03Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -52,7 +52,22 @@\n     /**\n      * The remote synchonization processes stopped.\n      */\n-    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\");\n+    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\"),\n+\n+    /**\n+     * The DataStore is about to start the Sync Queries.\n+     */\n+    SYNC_QUERIES_STARTED(\"syncQueriesStarted\"),\n+\n+    /**\n+     * All models have been synced.\n+     */\n+    SYNC_QUERIES_READY(\"syncQueriesReady\"),", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ3MzIxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467473219", "bodyText": "Definitely agree on the naming. That being said, I think we're supposed to align with the names currently used in JS [1]; however, I'll check and see what iOS is currently doing.\nRegarding the javadoc, that's my trademarked Clipboard Inheritance pattern [2] \ud83e\udd13\n[1] - https://github.com/aws-amplify/amplify-js/blob/a7feacea4ed506340d250249d0b15286fe3ef5fa/packages/datastore/src/sync/index.ts#L71-L82\n[2] - There's a wikipedia page for it, so it's real. https://en.wikipedia.org/wiki/Copy-and-paste_programming", "author": "rjuliano", "createdAt": "2020-08-08T15:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ4MTQ4Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467481487", "bodyText": "This was the one that we talked about in the working group that we could possible rename but if we do it then should be done quickly since the JS versions aren't documented yet. Suggest you sync up with Ivan this week.", "author": "undefobj", "createdAt": "2020-08-08T16:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgwMzg5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470803892", "bodyText": "Fixed the javadoc on this one.", "author": "rjuliano", "createdAt": "2020-08-14T18:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "f84d1a08b86134b63dc8980234947fe41dfd7d04", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\nindex e4486c0c..f6276cb7 100644\n--- a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n\n@@ -65,7 +65,9 @@ public enum DataStoreChannelEventName {\n     SYNC_QUERIES_READY(\"syncQueriesReady\"),\n \n     /**\n-     * All models have been synced.\n+     * The sync process for one of the models has completed. This\n+     * event is emitted with metrics related to the latest sync\n+     * for the model.\n      */\n     MODEL_SYNCED(\"modelSynced\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTkwOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467385909", "bodyText": "One says model (singular) and one says models (plural). From the Javadoc, it looks like it means the plural form. If that's so, can we name this ALL_MODELS_SYCNED? This probably means going back to the cross-platform design doc and making sure the other guys do likewise. Or, if JS already has these publicly documented and live, we could at least align some better names with iOS.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:17:19Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -52,7 +52,22 @@\n     /**\n      * The remote synchonization processes stopped.\n      */\n-    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\");\n+    REMOTE_SYNC_STOPPED(\"remote_sync_stopped\"),\n+\n+    /**\n+     * The DataStore is about to start the Sync Queries.\n+     */\n+    SYNC_QUERIES_STARTED(\"syncQueriesStarted\"),\n+\n+    /**\n+     * All models have been synced.\n+     */\n+    SYNC_QUERIES_READY(\"syncQueriesReady\"),\n+\n+    /**\n+     * All models have been synced.\n+     */\n+    MODEL_SYNCED(\"modelSynced\");", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ3Mzg4Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467473886", "bodyText": "This event is emitted once for each individual model, so it makes sense for it to be singular.\nRegarding the event names in general, I'll check in with iOS to see how they're going about implementing. My understanding from one of the meeting we had is that they were going to follow JS though.", "author": "rjuliano", "createdAt": "2020-08-08T15:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NTkwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "f84d1a08b86134b63dc8980234947fe41dfd7d04", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\nindex e4486c0c..f6276cb7 100644\n--- a/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java\n\n@@ -65,7 +65,9 @@ public enum DataStoreChannelEventName {\n     SYNC_QUERIES_READY(\"syncQueriesReady\"),\n \n     /**\n-     * All models have been synced.\n+     * The sync process for one of the models has completed. This\n+     * event is emitted with metrics related to the latest sync\n+     * for the model.\n      */\n     MODEL_SYNCED(\"modelSynced\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4ODA1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467388057", "bodyText": "Since we have the observer pattern here, I don't think you even need to put this in the SyncProcessor at all, do you? You could have this be like a SyncMetricsPublisher.java or a SyncMetricsObserver.java, and then cleanly separate all of this logic into its own little place.\nOverall though, I'm worry about how long hydrate() is getting, here. Any approaches you can think of to break this apart into some smaller bits would probably useful, towards keeping the code clear. -- Keep in mind, the reader expects hydrate() to be mostly about populating data, not broadcasting events.\nThe other benefit to breaking out a separate observer class is that you will no longer have SyncProcessor depending on the LocalStorageAdapter. I don't think I ever completely got there, but you can se several mid-level utilities like the VersionRepository, etc., which abstract away the LocalStorageAdapter from the sync processor. All in all, I think the LocalStorageAdapter is a fairly low level detail for the sync processor and -- where possible -- it would be best to avoid direct dependency on it.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:21:47Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -92,12 +106,67 @@ public static Builder builder() {\n     Completable hydrate() {\n         ModelWithMetadataComparator modelWithMetadataComparator =\n             new ModelWithMetadataComparator(modelProvider, modelSchemaRegistry);\n-\n+        final Map<String, ModelSyncMetrics> metricsByModel = new ConcurrentHashMap<>();\n         final Set<Completable> hydrationTasks = new HashSet<>();\n         for (Class<? extends Model> clazz : modelProvider.models()) {\n+            SyncTime lastSyncTime = syncTimeRegistry.lookupLastSyncTime(clazz)\n+                .map(this::filterOutOldSyncTimes)\n+                .blockingGet();\n+            metricsByModel.put(clazz.getSimpleName(), new ModelSyncMetrics(lastSyncTime));\n             hydrationTasks.add(createHydrationTask(modelWithMetadataComparator, clazz));\n         }\n-        return Completable.concat(hydrationTasks);\n+\n+        // We'll collect metrics for the initial sync by observing changes to the local DataStore.\n+        Cancelable metricsObserver =\n+            localStorageAdapter.observe(itemChange -> {", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ3NDExOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467474118", "bodyText": "LOL...I should have followed my gut on this one. I was going to do just that and talked myself out of it. \ud83e\udd23  The moment I had to add the local LocalStorageAdapter as a dependency, it felt wrong. Glad to refactor this though.", "author": "rjuliano", "createdAt": "2020-08-08T15:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4ODA1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg1ODg1NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r468858855", "bodyText": "I refactored this on the latest commit.", "author": "rjuliano", "createdAt": "2020-08-11T20:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4ODA1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9c41dd18e48709de151985a4e007bdf59148e11b", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\nindex 56e762c6..971f4b4d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n\n@@ -174,16 +174,22 @@ final class SyncProcessor {\n         return syncTimeRegistry.lookupLastSyncTime(modelClass)\n             .map(this::filterOutOldSyncTimes)\n             // And for each, perform a sync. The network response will contain an Iterable<ModelWithMetadata<T>>\n-            .flatMapCompletable(lastSyncTime -> syncModel(modelClass, lastSyncTime)\n-                // Okay, but we want to flatten the Iterable elements back into an Observable stream.\n-                .flatMapObservable(Observable::fromIterable)\n-                // And sort them all, according to their model's topological order,\n-                // So that when we save them, the references will exist.\n-                .sorted(modelWithMetadataComparator::compare)\n-                // For each ModelWithMetadata, merge it into the local store.\n-                .flatMapCompletable(merger::merge)\n-            )\n-            .andThen(syncTimeRegistry.saveLastSyncTime(modelClass, SyncTime.now()))\n+            .flatMap(lastSyncTime -> {\n+                return syncModel(modelClass, lastSyncTime)\n+                    // Okay, but we want to flatten the Iterable elements back into an Observable stream.\n+                    .flatMapObservable(Observable::fromIterable)\n+                    // And sort them all, according to their model's topological order,\n+                    // So that when we save them, the references will exist.\n+                    .sorted(modelWithMetadataComparator::compare)\n+                    // For each ModelWithMetadata, merge it into the local store.\n+                    .flatMapCompletable(merger::merge)\n+                    .toSingle(() -> lastSyncTime.exists() ? SyncType.DELTA : SyncType.BASE);\n+            })\n+            .flatMapCompletable(syncType -> {\n+                return SyncType.DELTA.equals(syncType) ?\n+                    syncTimeRegistry.saveLastDeltaSyncTime(modelClass, SyncTime.now()) :\n+                    syncTimeRegistry.saveLastBaseSyncTime(modelClass, SyncTime.now());\n+            })\n             .doOnError(failureToSync -> {\n                 LOG.warn(\"Initial cloud sync failed.\", failureToSync);\n                 DataStoreErrorHandler dataStoreErrorHandler =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MDQyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467390428", "bodyText": "Ahh. Hm, yea.\nSo, this looks reasonable. Can you create a separate isolated PR for this?\nIf we treat this seriously, I think we can make use of SyncType in a number of places where delta vs. base sync logic is managed currently. If I'm not mistaken, it is a nullability check in most places right now. Like, do I have a timestamp yes vs. no? However, it would be cleaner to be like:\nif (lastSyncTime == null) {\n    syncType = SyncType.FULL;\n}\netc.\nTLDR there's a bunch of places you can use this, and it'll probably be significant enough for its own (~low complexity, but potentially verbose) PR.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:26:38Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncType.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine;\n+\n+/**\n+ * Enum representing the type of initial sync.\n+ */\n+public enum SyncType {", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2Njk0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467666941", "bodyText": "Just posted #713\nNote that in that PR, I'm using BASE instead of FULL since it appears to be more consistent with what I've seen in the docs.\nI have some other changes to this PR which should address some of the other issues. Once we get #713 merged, I can update this PR.", "author": "rjuliano", "createdAt": "2020-08-10T02:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MDQyOA=="}], "type": "inlineReview", "revised_code": {"commit": "9c41dd18e48709de151985a4e007bdf59148e11b", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncType.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncType.java\nindex d91c99c7..30172bed 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncType.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncType.java\n\n@@ -15,6 +15,8 @@\n \n package com.amplifyframework.datastore.syncengine;\n \n+import com.amplifyframework.util.Time;\n+\n /**\n  * Enum representing the type of initial sync.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MDc1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467390757", "bodyText": "Or, alternately, you could just use your enum type? getSyncType()? The way you have it is fine too.", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:27:18Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine.events;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.datastore.syncengine.SyncType;\n+\n+/**\n+ * Hub event payload emitted when the initial sync completes for a given model.\n+ */\n+public final class ModelSyncedEvent {\n+    private final int added;\n+    private final int updated;\n+    private final int deleted;\n+    private final String model;\n+    private final boolean isFullSync;\n+    private final boolean isDeltaSync;\n+\n+    /**\n+     * Constructs a ModelSyncEvent object.\n+     * @param model The of the model.\n+     * @param syncType Indicates whether is a full or delta sync.\n+     * @param added Number of records added during the sync attempt.\n+     * @param updated Number of records updated during the sync attempt.\n+     * @param deleted Number of records deleted during the sync attempt.\n+     */\n+    public ModelSyncedEvent(String model,\n+                            SyncType syncType,\n+                            int added,\n+                            int updated,\n+                            int deleted) {\n+        this.added = added;\n+        this.updated = updated;\n+        this.deleted = deleted;\n+        this.model = model;\n+        this.isFullSync = SyncType.FULL.equals(syncType);\n+        this.isDeltaSync = SyncType.DELTA.equals(syncType);\n+    }\n+\n+    /**\n+     * Getter for the model name.\n+     * @return The model name (ex. Post).\n+     */\n+    public String getModel() {\n+        return model;\n+    }\n+\n+    /**\n+     * Getter for the number of records added during the sync.\n+     * @return Number of records added.\n+     */\n+    public int getAdded() {\n+        return added;\n+    }\n+\n+    /**\n+     * Getter for the number of records updated during the sync.\n+     * @return Number of records updated.\n+     */\n+    public int getUpdated() {\n+        return updated;\n+    }\n+\n+    /**\n+     * Getter for the number of records deleted during the sync.\n+     * @return Number of records deleted.\n+     */\n+    public int getDeleted() {\n+        return deleted;\n+    }\n+\n+    /**\n+     * Getter for the isFullSync property.\n+     * @return True if it's a full sync, false otherwise.\n+     */\n+    public boolean isFullSync() {", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg1OTI5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r468859292", "bodyText": "The event payload calls for isFullSync and isDeltaSync, so I just kept it consistent with what JS is doing.", "author": "rjuliano", "createdAt": "2020-08-11T20:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MDc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "da3fe89f0042bbb51bfbd478ad52f0495f355b90", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java b/core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\nsimilarity index 91%\nrename from aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java\nrename to core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\nindex 989d68c6..7d010f10 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\n\n@@ -13,12 +13,10 @@\n  * permissions and limitations under the License.\n  */\n \n-package com.amplifyframework.datastore.syncengine.events;\n+package com.amplifyframework.datastore.events;\n \n import androidx.annotation.NonNull;\n \n-import com.amplifyframework.datastore.syncengine.SyncType;\n-\n /**\n  * Hub event payload emitted when the initial sync completes for a given model.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MTI5OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467391299", "bodyText": "Since you'll send these back to the customer, be sure that all of your event structures are:\n\nImmutable;\nImplement equals, toString, and hashCode\nIf applicable, implementing Comparable might be appropriate as well?", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:28:27Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine.events;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.datastore.syncengine.SyncType;\n+\n+/**\n+ * Hub event payload emitted when the initial sync completes for a given model.\n+ */\n+public final class ModelSyncedEvent {", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NjIxMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470856211", "bodyText": "1 and 2 should be addressed. I'm not sure it makes sense to implement comparable here since none of the fields really stand out in terms of sorting.", "author": "rjuliano", "createdAt": "2020-08-14T20:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MTI5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "da3fe89f0042bbb51bfbd478ad52f0495f355b90", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java b/core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\nsimilarity index 91%\nrename from aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java\nrename to core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\nindex 989d68c6..7d010f10 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/ModelSyncedEvent.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/events/ModelSyncedEvent.java\n\n@@ -13,12 +13,10 @@\n  * permissions and limitations under the License.\n  */\n \n-package com.amplifyframework.datastore.syncengine.events;\n+package com.amplifyframework.datastore.events;\n \n import androidx.annotation.NonNull;\n \n-import com.amplifyframework.datastore.syncengine.SyncType;\n-\n /**\n  * Hub event payload emitted when the initial sync completes for a given model.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MjM5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r467392396", "bodyText": "If you use the array primitive, be sure to do an Array.copy on the input, so that your DTO won't be effected if the input hcanges. https://docs.oracle.com/javase/7/docs/api/java/util/Arrays.html#copyOf(U[],%20int,%20java.lang.Class)\nsame deal on this one -- equals, toString, and hashCode, please", "author": "jamesonwilliams", "createdAt": "2020-08-08T08:30:34Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/SyncQueriesStartedEvent.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine.events;\n+\n+/**\n+ * Event payload emitted when the sync process starts.\n+ */\n+public final class SyncQueriesStartedEvent {\n+    private String[] models;\n+\n+    /**\n+     * Constructs a SyncQueriesStartedEvent object.\n+     * @param models An array of model names.\n+     */\n+    public SyncQueriesStartedEvent(String[] models) {\n+        this.models = models;", "originalCommit": "3aa959826c1ed00d0950e7b2501fabc8641c2fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg3MDA3OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470870078", "bodyText": "Done. Added tests using EqualsToStringHashValidator", "author": "rjuliano", "createdAt": "2020-08-14T21:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5MjM5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "da3fe89f0042bbb51bfbd478ad52f0495f355b90", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/SyncQueriesStartedEvent.java b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\nsimilarity index 95%\nrename from aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/SyncQueriesStartedEvent.java\nrename to core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\nindex 9c11e617..2fb44c50 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/events/SyncQueriesStartedEvent.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\n\n@@ -13,7 +13,7 @@\n  * permissions and limitations under the License.\n  */\n \n-package com.amplifyframework.datastore.syncengine.events;\n+package com.amplifyframework.datastore.events;\n \n /**\n  * Event payload emitted when the sync process starts.\n"}}, {"oid": "c87b323d17e4c478ec7f61ddabdaffa72f05a1f0", "url": "https://github.com/aws-amplify/amplify-android/commit/c87b323d17e4c478ec7f61ddabdaffa72f05a1f0", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-09T23:48:42Z", "type": "commit"}, {"oid": "9c41dd18e48709de151985a4e007bdf59148e11b", "url": "https://github.com/aws-amplify/amplify-android/commit/9c41dd18e48709de151985a4e007bdf59148e11b", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-11T01:27:09Z", "type": "commit"}, {"oid": "b3a5ef80caa2d912711082329fb20311fdda2905", "url": "https://github.com/aws-amplify/amplify-android/commit/b3a5ef80caa2d912711082329fb20311fdda2905", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-11T18:02:26Z", "type": "commit"}, {"oid": "da3fe89f0042bbb51bfbd478ad52f0495f355b90", "url": "https://github.com/aws-amplify/amplify-android/commit/da3fe89f0042bbb51bfbd478ad52f0495f355b90", "message": "Refactored sync event metrics", "committedDate": "2020-08-11T20:50:49Z", "type": "commit"}, {"oid": "f84d1a08b86134b63dc8980234947fe41dfd7d04", "url": "https://github.com/aws-amplify/amplify-android/commit/f84d1a08b86134b63dc8980234947fe41dfd7d04", "message": "Fix javadoc", "committedDate": "2020-08-14T18:41:25Z", "type": "commit"}, {"oid": "16b30744dd8838b941096b144f8168ea3e6c2fb1", "url": "https://github.com/aws-amplify/amplify-android/commit/16b30744dd8838b941096b144f8168ea3e6c2fb1", "message": "Checkstyle fixes and other minor tweaks", "committedDate": "2020-08-14T19:57:17Z", "type": "commit"}, {"oid": "6dfc3ea34c3a38a915b1f0127aa6177ac6468ca6", "url": "https://github.com/aws-amplify/amplify-android/commit/6dfc3ea34c3a38a915b1f0127aa6177ac6468ca6", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-14T20:15:21Z", "type": "commit"}, {"oid": "d15ec493263bd47821ee5f03dc4e5b13cd6d21a4", "url": "https://github.com/aws-amplify/amplify-android/commit/d15ec493263bd47821ee5f03dc4e5b13cd6d21a4", "message": "Add equals, hashCode, toString to ModelSyncedEvent", "committedDate": "2020-08-14T20:37:45Z", "type": "commit"}, {"oid": "e681a785c85b65703ae5ec6b7a141df6011ee1b8", "url": "https://github.com/aws-amplify/amplify-android/commit/e681a785c85b65703ae5ec6b7a141df6011ee1b8", "message": "Added tests for SyncQueriesStartedEvent", "committedDate": "2020-08-14T21:19:00Z", "type": "commit"}, {"oid": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "url": "https://github.com/aws-amplify/amplify-android/commit/ded64616374bcce33ac4fabfc77b6462fd28fbe0", "message": "Cleaned up old remote sync events", "committedDate": "2020-08-14T22:19:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTA4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931080", "bodyText": "This seems to be a frivolous construct. Isn't this just equivalent to using modelProvider.models() directly?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:22:10Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -97,6 +103,11 @@ public Orchestrator(\n         Merger merger = new Merger(mutationOutbox, versionRepository, localStorageAdapter);\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n+        this.localStorageAdapter = localStorageAdapter;\n+        syncableModels = Observable.fromIterable(modelProvider.models())\n+            .toList()\n+            .blockingGet();", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzODk1Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471438953", "bodyText": "Yeah...initially, I was going to filter based on isSyncable, but we don't have such a flag for Android.", "author": "rjuliano", "createdAt": "2020-08-17T12:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTA4MA=="}], "type": "inlineReview", "revised_code": {"commit": "51df27a8e1d002edfad720278c54c08f6c196782", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex f411f39a..be2c4880 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -104,9 +103,7 @@ public final class Orchestrator {\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n         this.localStorageAdapter = localStorageAdapter;\n-        syncableModels = Observable.fromIterable(modelProvider.models())\n-            .toList()\n-            .blockingGet();\n+        syncableModels = modelProvider.models();\n \n         this.mutationProcessor = new MutationProcessor(merger, versionRepository, mutationOutbox, appSync);\n         this.syncProcessor = SyncProcessor.builder()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTI1MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931250", "bodyText": "It gets assigned here, but where is it used? Do you have behavior in the constructor? If so, can you move it to start() and stop() methods, and keep the constructor only for dependency wiring?\nOther thought: it would be kinda nice if this could be syncProcessor.addObserver(new SyncMtericsObserver()), or if the syncProcessor just managed this thing internally, itself._", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:24:32Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -106,6 +117,9 @@ public Orchestrator(\n             .merger(merger)\n             .dataStoreConfigurationProvider(dataStoreConfigurationProvider)\n             .build();\n+        this.syncObserver = new SyncMetricsObserver(localStorageAdapter,", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNDg1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471624859", "bodyText": "I refactored the logic to make it a bit lighter in terms of dependencies. I created an accumulator class that keeps track of the sync metrics for an individual model. Rather than depending on the local storage adapter and creating an observer, I'm just passing in a reference to this new object into the merge method.", "author": "rjuliano", "createdAt": "2020-08-17T17:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTI1MA=="}], "type": "inlineReview", "revised_code": {"commit": "24d1647d6f2ccf6c890928765b3d79887e34a126", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex f411f39a..290276b2 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -117,9 +113,6 @@ public final class Orchestrator {\n             .merger(merger)\n             .dataStoreConfigurationProvider(dataStoreConfigurationProvider)\n             .build();\n-        this.syncObserver = new SyncMetricsObserver(localStorageAdapter,\n-                                                    syncableModels,\n-                                                    dataStoreConfigurationProvider);\n         this.subscriptionProcessor = new SubscriptionProcessor(appSync, modelProvider, merger);\n         this.storageObserver = new StorageObserver(localStorageAdapter, mutationOutbox);\n         this.currentMode = new AtomicReference<>(Mode.STOPPED);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTMwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931308", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Map<String, ModelSyncMetrics> metricsByModel;\n          \n          \n            \n                private final Map<String, ModelSyncMetrics> metricsByModel;", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:24:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.async.Cancelable;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.datastore.DataStoreChannelEventName;\n+import com.amplifyframework.datastore.DataStoreConfigurationProvider;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.DataStoreItemChange;\n+import com.amplifyframework.datastore.events.ModelSyncedEvent;\n+import com.amplifyframework.datastore.storage.LocalStorageAdapter;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Class that encapsulates the logic of listening to local DataStore changes\n+ * and emitting metrics when base/delta sync completes.\n+ */\n+class SyncMetricsObserver {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n+    private Map<String, ModelSyncMetrics> metricsByModel;", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNTQ5Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471625493", "bodyText": "No longer exists after refactor.", "author": "rjuliano", "createdAt": "2020-08-17T17:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTMwOA=="}], "type": "inlineReview", "revised_code": {"commit": "51df27a8e1d002edfad720278c54c08f6c196782", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\nindex c839cb69..e5711dbf 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n\n@@ -29,8 +29,8 @@ import com.amplifyframework.hub.HubChannel;\n import com.amplifyframework.hub.HubEvent;\n import com.amplifyframework.logging.Logger;\n \n-import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.atomic.AtomicInteger;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTMyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931323", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            class SyncMetricsObserver {\n          \n          \n            \n            final class SyncMetricsObserver {", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:25:08Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.async.Cancelable;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.datastore.DataStoreChannelEventName;\n+import com.amplifyframework.datastore.DataStoreConfigurationProvider;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.DataStoreItemChange;\n+import com.amplifyframework.datastore.events.ModelSyncedEvent;\n+import com.amplifyframework.datastore.storage.LocalStorageAdapter;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Class that encapsulates the logic of listening to local DataStore changes\n+ * and emitting metrics when base/delta sync completes.\n+ */\n+class SyncMetricsObserver {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNTk0Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471625942", "bodyText": "Made it final after renaming it to ModelSyncMetricsAccumulator.", "author": "rjuliano", "createdAt": "2020-08-17T17:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTMyMw=="}], "type": "inlineReview", "revised_code": {"commit": "51df27a8e1d002edfad720278c54c08f6c196782", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\nindex c839cb69..e5711dbf 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n\n@@ -29,8 +29,8 @@ import com.amplifyframework.hub.HubChannel;\n import com.amplifyframework.hub.HubEvent;\n import com.amplifyframework.logging.Logger;\n \n-import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.atomic.AtomicInteger;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTQyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931428", "bodyText": "Maybe invert this, so you can save 4 columns for the main body of the method.\ne.g.\nif (!isSyncProcessChange) {\n    return;\n}\nahaSweetISavedSomeCols();", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:26:22Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.async.Cancelable;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.datastore.DataStoreChannelEventName;\n+import com.amplifyframework.datastore.DataStoreConfigurationProvider;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.DataStoreItemChange;\n+import com.amplifyframework.datastore.events.ModelSyncedEvent;\n+import com.amplifyframework.datastore.storage.LocalStorageAdapter;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Class that encapsulates the logic of listening to local DataStore changes\n+ * and emitting metrics when base/delta sync completes.\n+ */\n+class SyncMetricsObserver {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n+    private Map<String, ModelSyncMetrics> metricsByModel;\n+    private final Cancelable itemChangeObserver;\n+    private final List<Class<? extends Model>> syncableModels;\n+\n+    /**\n+     * Constructor that sets up an observer to watch for mutations\n+     * made by the sync process on the local DataStore.\n+     * @param localStorageAdapter A reference to the implementation of the {@link LocalStorageAdapter}.\n+     * @param syncableModels A list of all the syncable models.\n+     * @param dataStoreConfigurationProvider A reference to the DataStore configuration.\n+     */\n+    SyncMetricsObserver(LocalStorageAdapter localStorageAdapter,\n+                        List<Class<? extends Model>> syncableModels,\n+                        DataStoreConfigurationProvider dataStoreConfigurationProvider) {\n+        itemChangeObserver = localStorageAdapter.observe(\n+            this::onItemChange,\n+            this::onError,\n+            this::onComplete\n+        );\n+        metricsByModel = new ConcurrentHashMap<>();\n+        this.syncableModels = syncableModels;\n+    }\n+\n+    private void onComplete() {\n+        LOG.debug(\"Initial sync metrics observer completed.\");\n+        itemChangeObserver.cancel();\n+    }\n+\n+    private void onError(DataStoreException dataStoreException) {\n+        LOG.warn(\"Unable to gather metrics for remote sync.\", dataStoreException);\n+    }\n+\n+    private void onItemChange(StorageItemChange<? extends Model> itemChange) {\n+        boolean isSyncProcessChange = StorageItemChange.Initiator.SYNC_ENGINE.equals(itemChange.initiator());\n+        if (isSyncProcessChange) {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNjMyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471626321", "bodyText": "No longer needed.", "author": "rjuliano", "createdAt": "2020-08-17T17:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTQyOA=="}], "type": "inlineReview", "revised_code": {"commit": "51df27a8e1d002edfad720278c54c08f6c196782", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\nindex c839cb69..e5711dbf 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncMetricsObserver.java\n\n@@ -29,8 +29,8 @@ import com.amplifyframework.hub.HubChannel;\n import com.amplifyframework.hub.HubEvent;\n import com.amplifyframework.logging.Logger;\n \n-import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.atomic.AtomicInteger;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTU1NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931554", "bodyText": "Is this still needed? Can you remove the commented out stuff?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:28:10Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -206,6 +204,10 @@ public void configureAndInitializeInApiModeWithoutApi() throws JSONException, Am\n      */\n     @Test\n     public void clearStopsSyncUntilNextInteraction() throws AmplifyException, JSONException {\n+//        HubAccumulator subscriptionsStarted =", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTk3MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471629971", "bodyText": "Removed.", "author": "rjuliano", "createdAt": "2020-08-17T17:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTU1NA=="}], "type": "inlineReview", "revised_code": {"commit": "6cef4e0a3d38d51e0cf2a9532d66b360828ba3b8", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\nindex 93d1d572..495a88ec 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\n\n@@ -204,10 +204,6 @@ public final class AWSDataStorePluginTest {\n      */\n     @Test\n     public void clearStopsSyncUntilNextInteraction() throws AmplifyException, JSONException {\n-//        HubAccumulator subscriptionsStarted =\n-//            HubAccumulator.create(HubChannel.DATASTORE, DataStoreChannelEventName.SUBSCRIPTIONS_ESTABLISHED, 1)\n-//                          .start();\n-\n         ApiCategory mockApiCategory = mockApiCategoryWithGraphQlApi();\n         ApiPlugin<?> mockApiPlugin = mockApiCategory.getPlugin(MOCK_API_PLUGIN_NAME);\n         JSONObject dataStorePluginJson = new JSONObject()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTU4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931580", "bodyText": "Can we do this by checking for an event on the hub, instead of by using mockito invocation verification?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:28:41Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -307,16 +309,17 @@ private void assertRemoteSubscriptionsStarted() {\n     }\n \n     /**\n-     * Check that there were no interactions between the SyncProcessor\n-     * and the model provider. This is used to verify that the synchronization\n-     * processes don't start if there's no API configured.\n+     * Check that the SyncProcessor did not start by asserting that the\n+     * only interaction with the API category was triggered by the getPlugins\n+     * method.\n+     * @param mockApi Mock or spy of the ApiCategory being used for the test.\n      */\n-    private void assertSyncProcessorNotStarted() {\n-        boolean syncProcessorNotInvoked = mockingDetails(modelProvider)\n-            .getInvocations()\n-            .stream()\n-            .noneMatch(invocation -> invocation.getLocation().getSourceFile().contains(\"SyncProcessor\"));\n-        assertTrue(syncProcessorNotInvoked);\n+    private void assertSyncProcessorNotStarted(ApiCategory mockApi) {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1NTE3NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471655174", "bodyText": "That will probably be a little trickier since we'd be checking for the absence of an event. It's probably a useful pattern to create in the HubAccumulator, but I'd prefer to do that as a separate PR if that's OK.", "author": "rjuliano", "createdAt": "2020-08-17T17:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTU4MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTY3MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931671", "bodyText": "m -> m.getSimpleName() I think you can write Class::getSimpleName, instead?\nThe stream APIs are a little nicer for simple collection mapping like this aren't they? Oh well.", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:29:45Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -69,13 +79,18 @@\n public final class SyncProcessorTest {\n     private static final long OP_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n     private static final long BASE_SYNC_INTERVAL_MINUTES = TimeUnit.DAYS.toMinutes(1);\n+    private static final List<String> SYSTEM_MODEL_NAMES =\n+        Observable.fromIterable(SystemModelsProviderFactory.create().models())\n+            .map(m -> m.getSimpleName()).toList().blockingGet();", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0OTMxNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471649315", "bodyText": "Done.", "author": "rjuliano", "createdAt": "2020-08-17T17:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTY3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "24d1647d6f2ccf6c890928765b3d79887e34a126", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..349debaa 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -88,7 +88,6 @@ public final class SyncProcessorTest {\n     private SynchronousStorageAdapter storageAdapter;\n \n     private SyncProcessor syncProcessor;\n-    private SyncMetricsObserver syncMetricsObserver;\n     private int errorHandlerCallCount;\n     private int modelCount;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTc0Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931742", "bodyText": "To self document it, you could express this as int expectedModelCount = Arrays.asList(EventObject1.class, EventObject2.class).size().", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:30:18Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -116,6 +140,91 @@ public void setup() throws AmplifyException {\n             .build();\n     }\n \n+    /**\n+     * During a base sync, there are a series of events that should be emitted.\n+     * This test verifies that these events are published via Amplify Hub depending\n+     * on actions takes for each available model.\n+     * @throws DataStoreException Not expected.\n+     */\n+    @Test\n+    public void dataStoreHubEventsTriggered() throws DataStoreException {\n+        // Arrange - BEGIN\n+        // We're only emitting events for Post and Blogger\n+        int expectedModelCount = 2;", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1MDQ4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471650483", "bodyText": "That's a good idea.", "author": "rjuliano", "createdAt": "2020-08-17T17:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1MzMyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471653323", "bodyText": "Done.", "author": "rjuliano", "createdAt": "2020-08-17T17:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..acae9b5e 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -149,8 +139,7 @@ public final class SyncProcessorTest {\n     @Test\n     public void dataStoreHubEventsTriggered() throws DataStoreException {\n         // Arrange - BEGIN\n-        // We're only emitting events for Post and Blogger\n-        int expectedModelCount = 2;\n+        int expectedModelCount = Arrays.asList(Post.class, BlogOwner.class).size();\n         // Collects one syncQueriesStarted event.\n         HubAccumulator syncStartAccumulator =\n             createAccumulator(syncQueryStartedForModels(modelCount), 1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTk2NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931965", "bodyText": "Lambda-fy this?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:33:04Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -400,6 +509,60 @@ public void userProvidedErrorCallbackInvokedOnFailure() {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n+    private void assertOperationTypeCounts(ModelSyncedEvent event,\n+                                           int expectedAdd,\n+                                           int expectedUpdate,\n+                                           int expectedDelete) {\n+        assertEquals(expectedAdd, event.getAdded());\n+        assertEquals(expectedUpdate, event.getUpdated());\n+        assertEquals(expectedDelete, event.getDeleted());\n+    }\n+\n+    private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n+        return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n+    }\n+\n+    private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n+                return eventName.toString().equals(hubEvent.getName());\n+            }\n+        };\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private HubEventFilter syncMetricsEmittedFor(Class<? extends Model>... models) {\n+        List<String> modelNames = Observable.fromIterable(Arrays.asList(models))\n+            .map(model -> model.getSimpleName())\n+            .toList()\n+            .blockingGet();\n+\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n+                if (!(hubEvent.getData() instanceof ModelSyncedEvent)) {\n+                    return false;\n+                }\n+                ModelSyncedEvent hubEventData = (ModelSyncedEvent) hubEvent.getData();\n+                return forEvent(DataStoreChannelEventName.MODEL_SYNCED).filter(hubEvent) &&\n+                    modelNames.contains(hubEventData.getModel());\n+            }\n+        };\n+    }\n+\n+    private static HubEventFilter syncQueryStartedForModels(int modelCount) {\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1MzM3NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r471653375", "bodyText": "Done", "author": "rjuliano", "createdAt": "2020-08-17T17:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTk2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..acae9b5e 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -523,12 +512,7 @@ public final class SyncProcessorTest {\n     }\n \n     private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n-        return new HubEventFilter() {\n-            @Override\n-            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n-                return eventName.toString().equals(hubEvent.getName());\n-            }\n-        };\n+        return hubEvent -> eventName.toString().equals(hubEvent.getName());\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTk3NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931975", "bodyText": "Lambda-fy?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:33:15Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -400,6 +509,60 @@ public void userProvidedErrorCallbackInvokedOnFailure() {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n+    private void assertOperationTypeCounts(ModelSyncedEvent event,\n+                                           int expectedAdd,\n+                                           int expectedUpdate,\n+                                           int expectedDelete) {\n+        assertEquals(expectedAdd, event.getAdded());\n+        assertEquals(expectedUpdate, event.getUpdated());\n+        assertEquals(expectedDelete, event.getDeleted());\n+    }\n+\n+    private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n+        return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n+    }\n+\n+    private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n+                return eventName.toString().equals(hubEvent.getName());\n+            }\n+        };\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private HubEventFilter syncMetricsEmittedFor(Class<? extends Model>... models) {\n+        List<String> modelNames = Observable.fromIterable(Arrays.asList(models))\n+            .map(model -> model.getSimpleName())\n+            .toList()\n+            .blockingGet();\n+\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..acae9b5e 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -523,12 +512,7 @@ public final class SyncProcessorTest {\n     }\n \n     private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n-        return new HubEventFilter() {\n-            @Override\n-            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n-                return eventName.toString().equals(hubEvent.getName());\n-            }\n-        };\n+        return hubEvent -> eventName.toString().equals(hubEvent.getName());\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMTk5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470931995", "bodyText": "Lambda-fy?", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:33:26Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -400,6 +509,60 @@ public void userProvidedErrorCallbackInvokedOnFailure() {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n+    private void assertOperationTypeCounts(ModelSyncedEvent event,\n+                                           int expectedAdd,\n+                                           int expectedUpdate,\n+                                           int expectedDelete) {\n+        assertEquals(expectedAdd, event.getAdded());\n+        assertEquals(expectedUpdate, event.getUpdated());\n+        assertEquals(expectedDelete, event.getDeleted());\n+    }\n+\n+    private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n+        return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n+    }\n+\n+    private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n+        return new HubEventFilter() {\n+            @Override\n+            public boolean filter(@NonNull HubEvent<?> hubEvent) {", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..acae9b5e 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -523,12 +512,7 @@ public final class SyncProcessorTest {\n     }\n \n     private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n-        return new HubEventFilter() {\n-            @Override\n-            public boolean filter(@NonNull HubEvent<?> hubEvent) {\n-                return eventName.toString().equals(hubEvent.getName());\n-            }\n-        };\n+        return hubEvent -> eventName.toString().equals(hubEvent.getName());\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzMjAwMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r470932001", "bodyText": "Suggested change", "author": "jamesonwilliams", "createdAt": "2020-08-15T03:33:35Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -116,6 +140,91 @@ public void setup() throws AmplifyException {\n             .build();\n     }\n \n+    /**\n+     * During a base sync, there are a series of events that should be emitted.\n+     * This test verifies that these events are published via Amplify Hub depending\n+     * on actions takes for each available model.\n+     * @throws DataStoreException Not expected.\n+     */\n+    @Test\n+    public void dataStoreHubEventsTriggered() throws DataStoreException {\n+        // Arrange - BEGIN\n+        // We're only emitting events for Post and Blogger\n+        int expectedModelCount = 2;\n+        // Collects one syncQueriesStarted event.\n+        HubAccumulator syncStartAccumulator =\n+            createAccumulator(syncQueryStartedForModels(modelCount), 1);\n+        // Collects one syncQueriesReady event.\n+        HubAccumulator syncQueryReadyAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.SYNC_QUERIES_READY), 1);\n+        // Collects one modelSynced event for each model.\n+        HubAccumulator modelSyncedAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.MODEL_SYNCED), expectedModelCount);\n+\n+        // Add a couple of seed records so they can be deleted/updated.\n+        storageAdapter.save(DRUM_POST.getModel());\n+        storageAdapter.save(BLOGGER_ISLA.getModel());\n+\n+        // Mock sync query results for a couple of models.\n+        AppSyncMocking.sync(appSync)\n+            .mockSuccessResponse(Post.class, DELETED_DRUM_POST)\n+            .mockSuccessResponse(BlogOwner.class, BLOGGER_ISLA, BLOGGER_JAMESON);\n+\n+        // Start the accumulators.\n+        syncQueryReadyAccumulator.start();\n+        syncStartAccumulator.start();\n+        modelSyncedAccumulator.start();\n+\n+        TestObserver<ModelWithMetadata<? extends Model>> hydrationObserver = TestObserver.create();\n+        // Arrange - END\n+\n+        // Act: kickoff sync.\n+        syncProcessor.hydrate().subscribe(hydrationObserver);\n+\n+        // Check - BEGIN\n+        // Verify that sync completes.\n+        assertTrue(hydrationObserver.awaitTerminalEvent(OP_TIMEOUT_MS, TimeUnit.MILLISECONDS));\n+        hydrationObserver.assertNoErrors();\n+        hydrationObserver.assertComplete();\n+\n+        // Verify that syncQueriesStarted was emitted once.\n+        assertEquals(1, syncStartAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS).size());\n+        // Verify that syncQueriesReady was emitted once.\n+        assertEquals(1, syncQueryReadyAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS).size());\n+\n+        // Get the list of modelSynced events captured.\n+        List<HubEvent<?>> hubEvents = modelSyncedAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+        // Verify that [number of events] = [number of models]\n+        assertEquals(expectedModelCount, hubEvents.size());\n+\n+        // For each event (excluding system models), verify the desired count.\n+        for (HubEvent<?> event : hubEvents) {\n+            ModelSyncedEvent eventData = (ModelSyncedEvent) event.getData();\n+            assertTrue(eventData.isFullSync());\n+            assertFalse(eventData.isDeltaSync());\n+            String eventModel = eventData.getModel();\n+            switch (eventModel) {\n+                case \"BlogOwner\":\n+                    // One BlogOwner added and one updated.\n+                    assertOperationTypeCounts(eventData, 1, 1, 0);\n+                    break;\n+                case \"Post\":\n+                    // One post deleted.\n+                    assertOperationTypeCounts(eventData, 0, 0, 1);\n+                    break;\n+                default:\n+                    // Exclude system models\n+                    if (!SYSTEM_MODEL_NAMES.contains(eventModel)) {\n+                        // Verify there were no unexpected events for any other models.\n+                        assertOperationTypeCounts(eventData, 0, 0, 0);\n+                    }\n+            }\n+        }\n+        // Check - END\n+    }\n+\n+", "originalCommit": "ded64616374bcce33ac4fabfc77b6462fd28fbe0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 8e6ecff7..acae9b5e 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -149,8 +139,7 @@ public final class SyncProcessorTest {\n     @Test\n     public void dataStoreHubEventsTriggered() throws DataStoreException {\n         // Arrange - BEGIN\n-        // We're only emitting events for Post and Blogger\n-        int expectedModelCount = 2;\n+        int expectedModelCount = Arrays.asList(Post.class, BlogOwner.class).size();\n         // Collects one syncQueriesStarted event.\n         HubAccumulator syncStartAccumulator =\n             createAccumulator(syncQueryStartedForModels(modelCount), 1);\n"}}, {"oid": "51df27a8e1d002edfad720278c54c08f6c196782", "url": "https://github.com/aws-amplify/amplify-android/commit/51df27a8e1d002edfad720278c54c08f6c196782", "message": "Removed unnecessary use of rxjava", "committedDate": "2020-08-17T12:28:06Z", "type": "commit"}, {"oid": "24d1647d6f2ccf6c890928765b3d79887e34a126", "url": "https://github.com/aws-amplify/amplify-android/commit/24d1647d6f2ccf6c890928765b3d79887e34a126", "message": "Refactored metrics logic", "committedDate": "2020-08-17T17:06:57Z", "type": "commit"}, {"oid": "6cef4e0a3d38d51e0cf2a9532d66b360828ba3b8", "url": "https://github.com/aws-amplify/amplify-android/commit/6cef4e0a3d38d51e0cf2a9532d66b360828ba3b8", "message": "Cleaned up commented out code", "committedDate": "2020-08-17T17:15:09Z", "type": "commit"}, {"oid": "1de2322917c21dc1ab7824dc2317717319aead21", "url": "https://github.com/aws-amplify/amplify-android/commit/1de2322917c21dc1ab7824dc2317717319aead21", "message": "Minor cleanup", "committedDate": "2020-08-17T17:28:36Z", "type": "commit"}, {"oid": "35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "url": "https://github.com/aws-amplify/amplify-android/commit/35b532a5f6d8e6946b1fdfea1cc623ecb47513d6", "message": "More testing cleanup", "committedDate": "2020-08-17T17:38:18Z", "type": "commit"}, {"oid": "b89d49ef84d8bd8ed86eb2cd4b84928940c55b01", "url": "https://github.com/aws-amplify/amplify-android/commit/b89d49ef84d8bd8ed86eb2cd4b84928940c55b01", "message": "Update aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>", "committedDate": "2020-08-17T17:43:00Z", "type": "commit"}, {"oid": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "url": "https://github.com/aws-amplify/amplify-android/commit/e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-18T19:51:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5MTc0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473591746", "bodyText": "There is a NoOpConsumer.create(), I think? Which might be a little more explicit about the intention.", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:03:56Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -66,6 +67,18 @@\n      * @return A completable operation to merge the model\n      */\n     <T extends Model> Completable merge(ModelWithMetadata<T> modelWithMetadata) {\n+        return merge(modelWithMetadata, value -> { });", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNDE3Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474004176", "bodyText": "I thought we had something like that. I was looking for EmptyConsumer \ud83e\udd26", "author": "rjuliano", "createdAt": "2020-08-20T13:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5MTc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\nindex 508a8494..13ac8191 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n\n@@ -67,7 +68,7 @@ final class Merger {\n      * @return A completable operation to merge the model\n      */\n     <T extends Model> Completable merge(ModelWithMetadata<T> modelWithMetadata) {\n-        return merge(modelWithMetadata, value -> { });\n+        return merge(modelWithMetadata, NoOpConsumer.create());\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5MjAxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473592019", "bodyText": "Ditto here", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:04:29Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -87,8 +100,8 @@\n             .filter(currentVersion -> currentVersion == -1 || incomingVersion > currentVersion)\n             // If we should merge, then do so now, starting with the model data.\n             .flatMapCompletable(shouldMerge ->\n-                (isDelete ? delete(model) : save(model))\n-                    .andThen(save(metadata))\n+                (isDelete ? delete(model, storageItemChangeConsumer) : save(model, storageItemChangeConsumer))\n+                    .andThen(save(metadata, value -> { }))", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\nindex 508a8494..13ac8191 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n\n@@ -101,7 +102,7 @@ final class Merger {\n             // If we should merge, then do so now, starting with the model data.\n             .flatMapCompletable(shouldMerge ->\n                 (isDelete ? delete(model, storageItemChangeConsumer) : save(model, storageItemChangeConsumer))\n-                    .andThen(save(metadata, value -> { }))\n+                    .andThen(save(metadata, NoOpConsumer.create()))\n             )\n             // Let the world know that we've done a good thing.\n             .doOnComplete(() -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwNTc2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473605762", "bodyText": "You don't need this, if you use the Arrays.equals, right?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:27:38Z", "path": "core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.events;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.Arrays;\n+\n+/**\n+ * Event payload emitted when the sync process starts.\n+ */\n+public final class SyncQueriesStartedEvent {\n+    private String[] models;\n+\n+    /**\n+     * Constructs a SyncQueriesStartedEvent object.\n+     * @param models An array of model names.\n+     */\n+    public SyncQueriesStartedEvent(String[] models) {\n+        this.models = Arrays.copyOf(models, models.length);\n+    }\n+\n+    /**\n+     * Getter for the list of models in the initial sync.\n+     * @return An array with the list of models (Ex. [Post, Blog]).\n+     */\n+    public String[] getModels() {\n+        return models;\n+    }\n+\n+    @NonNull\n+    @Override\n+    public String toString() {\n+        return \"SyncQueriesStartedEvent{\" +\n+            \"models=\" + Arrays.toString(models) +\n+            '}';\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Arrays.hashCode(models);\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object thatObject) {\n+        if (this == thatObject) {\n+            return true;\n+        }\n+        if (thatObject == null || getClass() != thatObject.getClass()) {\n+            return false;\n+        }\n+\n+        SyncQueriesStartedEvent that = (SyncQueriesStartedEvent) thatObject;\n+        if (models.length != that.models.length) {\n+            return false;\n+        }", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwODk5NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474008994", "bodyText": "Ah...yes I can.", "author": "rjuliano", "createdAt": "2020-08-20T14:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwNTc2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\nindex e152bb99..9a7eac52 100644\n--- a/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\n\n@@ -24,7 +24,7 @@ import java.util.Arrays;\n  * Event payload emitted when the sync process starts.\n  */\n public final class SyncQueriesStartedEvent {\n-    private String[] models;\n+    private final String[] models;\n \n     /**\n      * Constructs a SyncQueriesStartedEvent object.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwNjAyOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473606029", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String[] models;\n          \n          \n            \n                private final String[] models;", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:27:58Z", "path": "core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.events;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.Arrays;\n+\n+/**\n+ * Event payload emitted when the sync process starts.\n+ */\n+public final class SyncQueriesStartedEvent {\n+    private String[] models;", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\nindex e152bb99..9a7eac52 100644\n--- a/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\n+++ b/core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java\n\n@@ -24,7 +24,7 @@ import java.util.Arrays;\n  * Event payload emitted when the sync process starts.\n  */\n public final class SyncQueriesStartedEvent {\n-    private String[] models;\n+    private final String[] models;\n \n     /**\n      * Constructs a SyncQueriesStartedEvent object.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwOTIyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473609228", "bodyText": "Ah crumbs. I guess HubAccumulator should have taken long, in hindsight, huh?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:32:58Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -116,6 +130,88 @@ public void setup() throws AmplifyException {\n             .build();\n     }\n \n+    /**\n+     * During a base sync, there are a series of events that should be emitted.\n+     * This test verifies that these events are published via Amplify Hub depending\n+     * on actions takes for each available model.\n+     * @throws DataStoreException Not expected.\n+     */\n+    @Test\n+    public void dataStoreHubEventsTriggered() throws DataStoreException {\n+        // Arrange - BEGIN\n+        int expectedModelCount = Arrays.asList(Post.class, BlogOwner.class).size();\n+        // Collects one syncQueriesStarted event.\n+        HubAccumulator syncStartAccumulator =\n+            createAccumulator(syncQueryStartedForModels(modelCount), 1);\n+        // Collects one syncQueriesReady event.\n+        HubAccumulator syncQueryReadyAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.SYNC_QUERIES_READY), 1);\n+        // Collects one modelSynced event for each model.\n+        HubAccumulator modelSyncedAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.MODEL_SYNCED), expectedModelCount);\n+\n+        // Add a couple of seed records so they can be deleted/updated.\n+        storageAdapter.save(DRUM_POST.getModel());\n+        storageAdapter.save(BLOGGER_ISLA.getModel());\n+\n+        // Mock sync query results for a couple of models.\n+        AppSyncMocking.sync(appSync)\n+            .mockSuccessResponse(Post.class, DELETED_DRUM_POST)\n+            .mockSuccessResponse(BlogOwner.class, BLOGGER_ISLA, BLOGGER_JAMESON);\n+\n+        // Start the accumulators.\n+        syncQueryReadyAccumulator.start();\n+        syncStartAccumulator.start();\n+        modelSyncedAccumulator.start();\n+\n+        TestObserver<ModelWithMetadata<? extends Model>> hydrationObserver = TestObserver.create();\n+        // Arrange - END\n+\n+        // Act: kickoff sync.\n+        syncProcessor.hydrate().subscribe(hydrationObserver);\n+\n+        // Check - BEGIN\n+        // Verify that sync completes.\n+        assertTrue(hydrationObserver.awaitTerminalEvent(OP_TIMEOUT_MS, TimeUnit.MILLISECONDS));\n+        hydrationObserver.assertNoErrors();\n+        hydrationObserver.assertComplete();\n+\n+        // Verify that syncQueriesStarted was emitted once.\n+        assertEquals(1, syncStartAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS).size());", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxMzIzMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474013230", "bodyText": "Yeah...we can always change that. I'll make a note to do that in a follow up PR", "author": "rjuliano", "createdAt": "2020-08-20T14:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwOTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA3NTQyMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474075420", "bodyText": "Sounds good, yes -- for a separate PR!", "author": "jamesonwilliams", "createdAt": "2020-08-20T15:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwOTIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 4b07e8c1..64412c57 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -186,6 +186,9 @@ public final class SyncProcessorTest {\n         // Verify that [number of events] = [number of models]\n         assertEquals(expectedModelCount, hubEvents.size());\n \n+        ModelSyncedEvent expectedBlogOwnerCounts = new ModelSyncedEvent(\"BlogOwner\", true, 1, 1, 0);\n+        ModelSyncedEvent expectedPostCounts = new ModelSyncedEvent(\"Post\", true, 0, 0, 1);\n+\n         // For each event (excluding system models), verify the desired count.\n         for (HubEvent<?> event : hubEvents) {\n             ModelSyncedEvent eventData = (ModelSyncedEvent) event.getData();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwOTYwMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473609601", "bodyText": "Can we do BlogOwner.class.getSimpleName() for these case statements, instead of string literal?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:33:39Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -116,6 +130,88 @@ public void setup() throws AmplifyException {\n             .build();\n     }\n \n+    /**\n+     * During a base sync, there are a series of events that should be emitted.\n+     * This test verifies that these events are published via Amplify Hub depending\n+     * on actions takes for each available model.\n+     * @throws DataStoreException Not expected.\n+     */\n+    @Test\n+    public void dataStoreHubEventsTriggered() throws DataStoreException {\n+        // Arrange - BEGIN\n+        int expectedModelCount = Arrays.asList(Post.class, BlogOwner.class).size();\n+        // Collects one syncQueriesStarted event.\n+        HubAccumulator syncStartAccumulator =\n+            createAccumulator(syncQueryStartedForModels(modelCount), 1);\n+        // Collects one syncQueriesReady event.\n+        HubAccumulator syncQueryReadyAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.SYNC_QUERIES_READY), 1);\n+        // Collects one modelSynced event for each model.\n+        HubAccumulator modelSyncedAccumulator =\n+            createAccumulator(forEvent(DataStoreChannelEventName.MODEL_SYNCED), expectedModelCount);\n+\n+        // Add a couple of seed records so they can be deleted/updated.\n+        storageAdapter.save(DRUM_POST.getModel());\n+        storageAdapter.save(BLOGGER_ISLA.getModel());\n+\n+        // Mock sync query results for a couple of models.\n+        AppSyncMocking.sync(appSync)\n+            .mockSuccessResponse(Post.class, DELETED_DRUM_POST)\n+            .mockSuccessResponse(BlogOwner.class, BLOGGER_ISLA, BLOGGER_JAMESON);\n+\n+        // Start the accumulators.\n+        syncQueryReadyAccumulator.start();\n+        syncStartAccumulator.start();\n+        modelSyncedAccumulator.start();\n+\n+        TestObserver<ModelWithMetadata<? extends Model>> hydrationObserver = TestObserver.create();\n+        // Arrange - END\n+\n+        // Act: kickoff sync.\n+        syncProcessor.hydrate().subscribe(hydrationObserver);\n+\n+        // Check - BEGIN\n+        // Verify that sync completes.\n+        assertTrue(hydrationObserver.awaitTerminalEvent(OP_TIMEOUT_MS, TimeUnit.MILLISECONDS));\n+        hydrationObserver.assertNoErrors();\n+        hydrationObserver.assertComplete();\n+\n+        // Verify that syncQueriesStarted was emitted once.\n+        assertEquals(1, syncStartAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS).size());\n+        // Verify that syncQueriesReady was emitted once.\n+        assertEquals(1, syncQueryReadyAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS).size());\n+\n+        // Get the list of modelSynced events captured.\n+        List<HubEvent<?>> hubEvents = modelSyncedAccumulator.await((int) OP_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+        // Verify that [number of events] = [number of models]\n+        assertEquals(expectedModelCount, hubEvents.size());\n+\n+        // For each event (excluding system models), verify the desired count.\n+        for (HubEvent<?> event : hubEvents) {\n+            ModelSyncedEvent eventData = (ModelSyncedEvent) event.getData();\n+            assertTrue(eventData.isFullSync());\n+            assertFalse(eventData.isDeltaSync());\n+            String eventModel = eventData.getModel();\n+            switch (eventModel) {\n+                case \"BlogOwner\":", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyNzExMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474027112", "bodyText": "Interesting...Evidently BlogOwner.class.getSimpleName() is not considered a compile-time constant. Even if I create a final static field and assign it the value of BlogOwner.class.getSimpleName(), the compiler still flags it with a Constant expression required error", "author": "rjuliano", "createdAt": "2020-08-20T14:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwOTYwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 4b07e8c1..64412c57 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -186,6 +186,9 @@ public final class SyncProcessorTest {\n         // Verify that [number of events] = [number of models]\n         assertEquals(expectedModelCount, hubEvents.size());\n \n+        ModelSyncedEvent expectedBlogOwnerCounts = new ModelSyncedEvent(\"BlogOwner\", true, 1, 1, 0);\n+        ModelSyncedEvent expectedPostCounts = new ModelSyncedEvent(\"Post\", true, 0, 0, 1);\n+\n         // For each event (excluding system models), verify the desired count.\n         for (HubEvent<?> event : hubEvents) {\n             ModelSyncedEvent eventData = (ModelSyncedEvent) event.getData();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxMzcxMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473613710", "bodyText": "We have this pattern pretty frequently, by now.\nWe could wrap it into a utility:\nList<String> modelNames = ForEach.inList(models, Model::getSimpleName);\n// In testutils, probskis.\npublic final class ForEach {\n     private ForEach() {}\n\n     <I, O> List<O> inList(List<I> in, Mapping<I, O> mapping) {\n         final List<O> out = new ArrayList<>();\n         for (I item : in) {\n             out.add(mapping.apply(item));\n         }\n         return Immutable.of(out);\n     }\n\n     @FunctionalInterface\n     interface Mapping<I, O> {\n         O apply(I in);\n     }\n}\nSoftware is so cool. Sigh.", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:40:16Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -400,6 +496,48 @@ public void userProvidedErrorCallbackInvokedOnFailure() {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n+    private void assertOperationTypeCounts(ModelSyncedEvent event,\n+                                           int expectedAdd,\n+                                           int expectedUpdate,\n+                                           int expectedDelete) {\n+        assertEquals(expectedAdd, event.getAdded());\n+        assertEquals(expectedUpdate, event.getUpdated());\n+        assertEquals(expectedDelete, event.getDeleted());\n+    }\n+\n+    private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n+        return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n+    }\n+\n+    private static HubEventFilter forEvent(DataStoreChannelEventName eventName) {\n+        return hubEvent -> eventName.toString().equals(hubEvent.getName());\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private HubEventFilter syncMetricsEmittedFor(Class<? extends Model>... models) {\n+        List<String> modelNames = Observable.fromIterable(Arrays.asList(models))\n+            .map(model -> model.getSimpleName())\n+            .toList()\n+            .blockingGet();", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA0NjIxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474046217", "bodyText": "I like it :)", "author": "rjuliano", "createdAt": "2020-08-20T14:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxMzcxMA=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 4b07e8c1..64412c57 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -496,15 +499,6 @@ public final class SyncProcessorTest {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n-    private void assertOperationTypeCounts(ModelSyncedEvent event,\n-                                           int expectedAdd,\n-                                           int expectedUpdate,\n-                                           int expectedDelete) {\n-        assertEquals(expectedAdd, event.getAdded());\n-        assertEquals(expectedUpdate, event.getUpdated());\n-        assertEquals(expectedDelete, event.getDeleted());\n-    }\n-\n     private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n         return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNjIyNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473616224", "bodyText": "When you call this, it is hard to remember which int is which. While potentially overkill, one solution is like:\nassertOperationTypeCounts(event, TypeCounts.builder().added(5).updated(1).deleted(0).build());\nWith a little inner data class to store those vals.\nOr hey, I mean, it's just a test class. Life doesn't always need to be complicated, we could even just have:\nclass TypeCounts {\n    int added;\n    int updated;\n    int deleted;\n}\n\nAnd then prepare them:\nTypeCounts counts = new TypeCounts();\ncounts.added = 4;\ncounts.updated = 9;\ncounts.deleted = 1;", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:44:22Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -400,6 +496,48 @@ public void userProvidedErrorCallbackInvokedOnFailure() {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n+    private void assertOperationTypeCounts(ModelSyncedEvent event,\n+                                           int expectedAdd,\n+                                           int expectedUpdate,\n+                                           int expectedDelete) {", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNzIxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473617217", "bodyText": "Oh duh, or wait -- update. Can you just reuse the ModelSyncMetrics as a pojo to store these immediate values?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNjIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1Njg1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474056859", "bodyText": "Oh yeah...I don't even have to have a separate method. I just created \"expected\" objects and use assertEquals.", "author": "rjuliano", "createdAt": "2020-08-20T15:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNjIyNA=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 4b07e8c1..64412c57 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -496,15 +499,6 @@ public final class SyncProcessorTest {\n         assertEquals(1, errorHandlerCallCount);\n     }\n \n-    private void assertOperationTypeCounts(ModelSyncedEvent event,\n-                                           int expectedAdd,\n-                                           int expectedUpdate,\n-                                           int expectedDelete) {\n-        assertEquals(expectedAdd, event.getAdded());\n-        assertEquals(expectedUpdate, event.getUpdated());\n-        assertEquals(expectedDelete, event.getDeleted());\n-    }\n-\n     private static HubAccumulator createAccumulator(HubEventFilter eventFilter, int times) {\n         return HubAccumulator.create(HubChannel.DATASTORE, eventFilter, times);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNjY1Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473616653", "bodyText": "I discuss a ForEach utility below that may make sense, if we have to pull this same trick more than a time or two.", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:45:07Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java", "diffHunk": "@@ -69,13 +78,17 @@\n public final class SyncProcessorTest {\n     private static final long OP_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n     private static final long BASE_SYNC_INTERVAL_MINUTES = TimeUnit.DAYS.toMinutes(1);\n+    private static final List<String> SYSTEM_MODEL_NAMES =\n+        Observable.fromIterable(SystemModelsProviderFactory.create().models())\n+            .map(Class::getSimpleName).toList().blockingGet();", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\nindex 4b07e8c1..64412c57 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/SyncProcessorTest.java\n\n@@ -79,8 +80,7 @@ public final class SyncProcessorTest {\n     private static final long OP_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n     private static final long BASE_SYNC_INTERVAL_MINUTES = TimeUnit.DAYS.toMinutes(1);\n     private static final List<String> SYSTEM_MODEL_NAMES =\n-        Observable.fromIterable(SystemModelsProviderFactory.create().models())\n-            .map(Class::getSimpleName).toList().blockingGet();\n+        ForEach.inCollection(SystemModelsProviderFactory.create().models(), Class::getSimpleName);\n \n     private AppSync appSync;\n     private ModelProvider modelProvider;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNzg1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473617857", "bodyText": "Does this get sent back to user? Does it need to be public, with equals/hashCode/toString and field accessors?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:47:00Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -340,4 +380,25 @@ public SyncProcessor build() {\n             return modelSchemaRegistry.getModelSchemaForModelInstance(modelWithMetadata.getModel());\n         }\n     }\n+\n+    private static final class ModelSyncMetrics {", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2NDEzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474064137", "bodyText": "Actually...this can be removed entirely.", "author": "rjuliano", "createdAt": "2020-08-20T15:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxNzg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\nindex 86eb6978..9a96ee81 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n\n@@ -380,25 +372,4 @@ final class SyncProcessor {\n             return modelSchemaRegistry.getModelSchemaForModelInstance(modelWithMetadata.getModel());\n         }\n     }\n-\n-    private static final class ModelSyncMetrics {\n-        private final Map<String, AtomicInteger> syncMetrics;\n-        private final SyncTime lastSyncTime;\n-\n-        ModelSyncMetrics(SyncTime lastSyncTime) {\n-            syncMetrics = new ConcurrentHashMap<>();\n-            syncMetrics.put(DataStoreItemChange.Type.CREATE.name(), new AtomicInteger(0));\n-            syncMetrics.put(DataStoreItemChange.Type.UPDATE.name(), new AtomicInteger(0));\n-            syncMetrics.put(DataStoreItemChange.Type.DELETE.name(), new AtomicInteger(0));\n-            this.lastSyncTime = lastSyncTime;\n-        }\n-\n-        public void increment(StorageItemChange.Type changeType) {\n-            syncMetrics.get(changeType.name()).incrementAndGet();\n-        }\n-\n-        public int getCountFor(StorageItemChange.Type changeType) {\n-            return syncMetrics.get(changeType.name()).get();\n-        }\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxODkyNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473618924", "bodyText": "What implications does this have on testability, if you inline Amplify.Hub? Should we instead snake a hub instance in through the constructor? That way, you could provide a mock in test, if you needed to?\nI forget why we put this in the publish arg... it seemed like a good idea at the time?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:48:37Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -113,13 +144,21 @@ private Completable createHydrationTask(\n                     // So that when we save them, the references will exist.\n                     .sorted(modelWithMetadataComparator::compare)\n                     // For each ModelWithMetadata, merge it into the local store.\n-                    .flatMapCompletable(merger::merge)\n+                    .flatMapCompletable(modelWithMetadata ->\n+                        merger.merge(modelWithMetadata, metricsAccumulator::increment)\n+                    )\n                     .toSingle(() -> lastSyncTime.exists() ? SyncType.DELTA : SyncType.BASE);\n             })\n             .flatMapCompletable(syncType -> {\n-                return SyncType.DELTA.equals(syncType) ?\n+                Completable syncTimeSaveCompletable = SyncType.DELTA.equals(syncType) ?\n                     syncTimeRegistry.saveLastDeltaSyncTime(modelClass, SyncTime.now()) :\n                     syncTimeRegistry.saveLastBaseSyncTime(modelClass, SyncTime.now());\n+                return syncTimeSaveCompletable.andThen(Completable.fromAction(() -> {\n+                    metricsAccumulator\n+                        .toModelSyncedEvent(syncType)\n+                        .toHubEvent()\n+                        .publish(HubChannel.DATASTORE, Amplify.Hub);", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2NTY5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474065692", "bodyText": "The original intent was to not have Amplify.Hub references inside the HubEvent class. Let me ponder over this one for a bit.", "author": "rjuliano", "createdAt": "2020-08-20T15:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxODkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA3NDM3OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474074379", "bodyText": "I may have simply been wrong on this. It does feel like encapsulating it HubEvent is cleaner than stating it at random call sites like this, doesn't it?", "author": "jamesonwilliams", "createdAt": "2020-08-20T15:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxODkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMjI5MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r475712290", "bodyText": "I've gone back and changed this a bit. I see HubEvent more as a POJO rather than something that has behavior. I changed the call sites back to:\nAmplify.Hub.publish(HubChannel.DATASTORE, <eventDataPojo>.toHubEvent());", "author": "rjuliano", "createdAt": "2020-08-24T15:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxODkyNA=="}], "type": "inlineReview", "revised_code": {"commit": "16f3eb9c68912fbb312ff0fcc63f1d1d068e300f", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\nindex 86eb6978..79c155aa 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n\n@@ -140,9 +142,6 @@ final class SyncProcessor {\n                 return syncModel(modelClass, lastSyncTime)\n                     // Okay, but we want to flatten the Iterable elements back into an Observable stream.\n                     .flatMapObservable(Observable::fromIterable)\n-                    // And sort them all, according to their model's topological order,\n-                    // So that when we save them, the references will exist.\n-                    .sorted(modelWithMetadataComparator::compare)\n                     // For each ModelWithMetadata, merge it into the local store.\n                     .flatMapCompletable(modelWithMetadata ->\n                         merger.merge(modelWithMetadata, metricsAccumulator::increment)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxOTkxMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473619913", "bodyText": "See other comments about ForEach. This one returns String[] though instead of List<String>. I guess we'd have to standardize. Oh, or like ForEach.inArray, ForEach.inList, etc. Could do multiple collection types", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:50:08Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -74,6 +84,11 @@ private SyncProcessor(\n         this.appSync = Objects.requireNonNull(appSync);\n         this.merger = Objects.requireNonNull(merger);\n         this.dataStoreConfigurationProvider = dataStoreConfigurationProvider;\n+        this.modelNames = Observable.fromIterable(modelProvider.models())\n+                                        .map(m -> m.getSimpleName())\n+                                        .toList()\n+                                        .blockingGet()\n+                                        .toArray(new String[0]);", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA4MzA4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474083083", "bodyText": "I changed the input parameter to be Collection<T> which covers a majority of cases and also added a inArray method in case someone needs it.", "author": "rjuliano", "createdAt": "2020-08-20T15:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYxOTkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\nindex 86eb6978..9a96ee81 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n\n@@ -84,11 +80,7 @@ final class SyncProcessor {\n         this.appSync = Objects.requireNonNull(appSync);\n         this.merger = Objects.requireNonNull(merger);\n         this.dataStoreConfigurationProvider = dataStoreConfigurationProvider;\n-        this.modelNames = Observable.fromIterable(modelProvider.models())\n-                                        .map(m -> m.getSimpleName())\n-                                        .toList()\n-                                        .blockingGet()\n-                                        .toArray(new String[0]);\n+        this.modelNames = ForEach.inCollection(modelProvider.models(), Class::getSimpleName).toArray(new String[0]);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMDI4MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473620281", "bodyText": "Is this a dead store variable? Doesn't look like syncableModels gets used.", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:50:43Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -97,6 +101,9 @@ public Orchestrator(\n         Merger merger = new Merger(mutationOutbox, versionRepository, localStorageAdapter);\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n+        this.localStorageAdapter = localStorageAdapter;\n+        syncableModels = modelProvider.models();", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 290276b2..b0fb724d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -101,9 +97,6 @@ public final class Orchestrator {\n         Merger merger = new Merger(mutationOutbox, versionRepository, localStorageAdapter);\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n-        this.localStorageAdapter = localStorageAdapter;\n-        syncableModels = modelProvider.models();\n-\n         this.mutationProcessor = new MutationProcessor(merger, versionRepository, mutationOutbox, appSync);\n         this.syncProcessor = SyncProcessor.builder()\n             .modelProvider(modelProvider)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMDQ2MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473620461", "bodyText": "Is this dead store, too?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:50:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -97,6 +101,9 @@ public Orchestrator(\n         Merger merger = new Merger(mutationOutbox, versionRepository, localStorageAdapter);\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n+        this.localStorageAdapter = localStorageAdapter;", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA4NzQxNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474087416", "bodyText": "Yup...can't remember why, but I think I was using it somewhere other than the constructor in one of my previous iterations.", "author": "rjuliano", "createdAt": "2020-08-20T15:47:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMDQ2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 290276b2..b0fb724d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -101,9 +97,6 @@ public final class Orchestrator {\n         Merger merger = new Merger(mutationOutbox, versionRepository, localStorageAdapter);\n         SyncTimeRegistry syncTimeRegistry = new SyncTimeRegistry(localStorageAdapter);\n \n-        this.localStorageAdapter = localStorageAdapter;\n-        syncableModels = modelProvider.models();\n-\n         this.mutationProcessor = new MutationProcessor(merger, versionRepository, mutationOutbox, appSync);\n         this.syncProcessor = SyncProcessor.builder()\n             .modelProvider(modelProvider)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMTA4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473621080", "bodyText": "Does it make sense for the key to be the constrained type, DataStoreItemChange.TYPE, instead of just String?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:51:59Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/ModelSyncMetricsAccumulator.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.syncengine;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.datastore.DataStoreItemChange;\n+import com.amplifyframework.datastore.events.ModelSyncedEvent;\n+import com.amplifyframework.datastore.storage.LocalStorageAdapter;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Class that encapsulates the logic of keeping track of sync metrics\n+ * by operation type for a given model.\n+ */\n+final class ModelSyncMetricsAccumulator {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n+    private final Map<String, AtomicInteger> syncMetrics;", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA5MjYwNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474092604", "bodyText": "You know...I tried to do this and couldn't get it to work. Finally just realized why: there is a StorageItemChange.Type and a DataStoreItemChange.Type. When I initially tried this, I was using StorageItemChange.Type in the key declaration, and then trying to retrieve by passing in a variable of DataStoreItemChange.Type. Just brilliant \ud83e\udd23", "author": "rjuliano", "createdAt": "2020-08-20T15:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMTA4MA=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/ModelSyncMetricsAccumulator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/ModelSyncMetricsAccumulator.java\nindex 1ba4e41b..8e671c5f 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/ModelSyncMetricsAccumulator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/ModelSyncMetricsAccumulator.java\n\n@@ -17,7 +17,6 @@ package com.amplifyframework.datastore.syncengine;\n \n import com.amplifyframework.core.Amplify;\n import com.amplifyframework.core.model.Model;\n-import com.amplifyframework.datastore.DataStoreItemChange;\n import com.amplifyframework.datastore.events.ModelSyncedEvent;\n import com.amplifyframework.datastore.storage.LocalStorageAdapter;\n import com.amplifyframework.datastore.storage.StorageItemChange;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMzMxNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r473623314", "bodyText": "Is there anyway we can avoid having these callbacks?\nThe Completable is already an asynchronous signal. Now, this method has two different async signals that have different lifecycles. It's a bit to handle, conceptually.\nOne possible option, if you need to observe save/deletes on the datastore, is the observe() method on the LocalStorageAdapter? Hopefully that can be setup internally, without effecting the Merger's contract?", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:55:25Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -66,6 +67,18 @@\n      * @return A completable operation to merge the model\n      */\n     <T extends Model> Completable merge(ModelWithMetadata<T> modelWithMetadata) {\n+        return merge(modelWithMetadata, value -> { });\n+    }\n+\n+    /**\n+     * Merge an item back into the local store, using a default strategy.\n+     * @param modelWithMetadata A model, combined with metadata about it\n+     * @param storageItemChangeConsumer A callback invoked when the merge method saves or deletes the model.\n+     * @param <T> Type of model\n+     * @return A completable operation to merge the model\n+     */\n+    <T extends Model> Completable merge(ModelWithMetadata<T> modelWithMetadata,\n+                                        Consumer<StorageItemChange<T>> storageItemChangeConsumer) {", "originalCommit": "e0187380dc0aa8f19287eee68ab556d0dea7d8f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMDY4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r474110685", "bodyText": "That was my previous implementation. However, it proved to be cumbersome from the standpoint of determining the lifecycle of the sync attempt for a given model.\nI was creating an observer before kicking off the sync. That observer kept an in-memory map of counters for each model and applied the following logic to each event received.:\n// pseudo-code\nonChangeEvent (changeEvent) {\n if (changeEvent.initiator == SYNC_ENGINE && isUserModel(changeEvent.model)) {\n   incrementCounter(changeEvent.model, changeEvent.changeType)\n } else if (changeEvent.initiator == SYNC_ENGINE && changeEvent.model == LastSyncMetadata) {\n  // That means the sync attempt finished for one of the models\n  let syncMetadata = changeEvent.eventPayload\n  //end of sync attempt for model specified in the \n  emitMetricsFor(syncMetadata.modelName);\n } else {\n   NoOp\n }\n}\n\nWhile this approach worked and it was nicely decoupled, it felt kind of brittle. It assumes that the initial sync  is the only thing emitting events with initiator set to SYNC_ENGINE. While this is true right now, it's one of those things that could change and break this logic. It also assumes that an update to the LastSyncMetadata table made by SYNC_ENGINE was the end of the sync attempt for the model.", "author": "rjuliano", "createdAt": "2020-08-20T16:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc3MDc4NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r478770784", "bodyText": "If I have bandwidth tomorrow, I'll revisit this one to see what I can come up with. Maybe instead of returning a completable, I can return a Single or a Maybe with the StorageItemChange", "author": "rjuliano", "createdAt": "2020-08-28T00:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMxMTQwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r479311402", "bodyText": "I'll do this as a follow-up.", "author": "rjuliano", "createdAt": "2020-08-28T13:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMzMxNA=="}], "type": "inlineReview", "revised_code": {"commit": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\nindex 508a8494..13ac8191 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n\n@@ -67,7 +68,7 @@ final class Merger {\n      * @return A completable operation to merge the model\n      */\n     <T extends Model> Completable merge(ModelWithMetadata<T> modelWithMetadata) {\n-        return merge(modelWithMetadata, value -> { });\n+        return merge(modelWithMetadata, NoOpConsumer.create());\n     }\n \n     /**\n"}}, {"oid": "ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "url": "https://github.com/aws-amplify/amplify-android/commit/ec4304fb38eec93bebea74c8c2c698aa684d4b3a", "message": "PR feedback", "committedDate": "2020-08-20T16:29:47Z", "type": "commit"}, {"oid": "16f3eb9c68912fbb312ff0fcc63f1d1d068e300f", "url": "https://github.com/aws-amplify/amplify-android/commit/16f3eb9c68912fbb312ff0fcc63f1d1d068e300f", "message": "Merge branch 'main' into rjuliano/ds-hub-events", "committedDate": "2020-08-21T19:59:02Z", "type": "commit"}, {"oid": "2e08675b5635e38d45b58d8bee47d08b388fcfa2", "url": "https://github.com/aws-amplify/amplify-android/commit/2e08675b5635e38d45b58d8bee47d08b388fcfa2", "message": "Remove publish from HubEvent", "committedDate": "2020-08-24T15:40:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0ODIwOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r478748209", "bodyText": "Perhaps we can use List<String> or Set<String> here?\nMost de/serializers should be able to easily convert these collections into a json array.", "author": "raphkim", "createdAt": "2020-08-27T23:23:02Z", "path": "core/src/main/java/com/amplifyframework/datastore/events/SyncQueriesStartedEvent.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.events;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.Arrays;\n+\n+/**\n+ * Event payload emitted when the sync process starts.\n+ */\n+public final class SyncQueriesStartedEvent {\n+    private final String[] models;", "originalCommit": "2e08675b5635e38d45b58d8bee47d08b388fcfa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwODY0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r479308640", "bodyText": "I'll probably do this as a follow up PR.", "author": "rjuliano", "createdAt": "2020-08-28T13:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0ODIwOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0ODQ4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r478748480", "bodyText": "cool!", "author": "raphkim", "createdAt": "2020-08-27T23:23:58Z", "path": "core/src/main/java/com/amplifyframework/util/ForEach.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Utility class that reduces boilerplate code in tests\n+ * where an oft-used pattern of mapping a list of values to another by\n+ * applying a function.\n+ */\n+public final class ForEach {", "originalCommit": "2e08675b5635e38d45b58d8bee47d08b388fcfa2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "9a53ef80154be3d21ae48bd2b144f793c0a75b6f", "url": "https://github.com/aws-amplify/amplify-android/commit/9a53ef80154be3d21ae48bd2b144f793c0a75b6f", "message": "Merge remote-tracking branch 'origin/main' into rjuliano/ds-hub-events", "committedDate": "2020-08-27T23:58:19Z", "type": "commit"}, {"oid": "3ddb9275038c7a351b97ae885faec8127a2c85f9", "url": "https://github.com/aws-amplify/amplify-android/commit/3ddb9275038c7a351b97ae885faec8127a2c85f9", "message": "Merge remote-tracking branch 'origin/main' into rjuliano/ds-hub-events", "committedDate": "2020-08-28T14:28:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNTE5NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/710#discussion_r478815194", "bodyText": "The previousStatus.transitionTo(newStatus) is a little bit hidden, currently. I'd put it on its own naked line just so people can see it visibly and make note of the behavioral part. Hidden inside the publish, it could easily be glanced over as \"oh just publish some static stuff...\"", "author": "jamesonwilliams", "createdAt": "2020-08-28T03:49:12Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -783,8 +782,7 @@ public void connectionAcquired(@NonNull Call call, @NonNull Connection connectio\n         private void transitionTo(ApiEndpointStatus newStatus) {\n             ApiEndpointStatus previousStatus = currentNetworkStatus.getAndSet(newStatus);\n             if (previousStatus != newStatus) {\n-                ApiEndpointStatusChangeEvent apiEndpointStatusChangeEvent = previousStatus.transitionTo(newStatus);\n-                apiEndpointStatusChangeEvent.toHubEvent().publish(HubChannel.API, Amplify.Hub);\n+                Amplify.Hub.publish(HubChannel.API, previousStatus.transitionTo(newStatus).toHubEvent());", "originalCommit": "9a53ef80154be3d21ae48bd2b144f793c0a75b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa2907854ee630a69642fcbacc05079bfb9ec34e", "chunk": "diff --git a/aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java b/aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java\nindex 7917a162..26d985ab 100644\n--- a/aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java\n+++ b/aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java\n\n@@ -782,7 +783,8 @@ public final class AWSApiPlugin extends ApiPlugin<Map<String, OkHttpClient>> {\n         private void transitionTo(ApiEndpointStatus newStatus) {\n             ApiEndpointStatus previousStatus = currentNetworkStatus.getAndSet(newStatus);\n             if (previousStatus != newStatus) {\n-                Amplify.Hub.publish(HubChannel.API, previousStatus.transitionTo(newStatus).toHubEvent());\n+                ApiEndpointStatusChangeEvent apiEndpointStatusChangeEvent = previousStatus.transitionTo(newStatus);\n+                Amplify.Hub.publish(HubChannel.API, apiEndpointStatusChangeEvent.toHubEvent());\n             }\n         }\n     }\n"}}, {"oid": "aa2907854ee630a69642fcbacc05079bfb9ec34e", "url": "https://github.com/aws-amplify/amplify-android/commit/aa2907854ee630a69642fcbacc05079bfb9ec34e", "message": "Change call site format for transitionTo", "committedDate": "2020-08-28T17:29:30Z", "type": "commit"}]}