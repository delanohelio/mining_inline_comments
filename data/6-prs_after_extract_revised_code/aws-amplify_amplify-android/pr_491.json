{"pr_number": 491, "pr_title": "[aws-datastore] Permit multiple mutations per model ID", "pr_createdAt": "2020-05-20T01:49:11Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/491", "timeline": [{"oid": "ebcf9861a426f97b3456bf3120ab5b2204bf206c", "url": "https://github.com/aws-amplify/amplify-android/commit/ebcf9861a426f97b3456bf3120ab5b2204bf206c", "message": "[aws-datastore] Permit multiple mutations per model ID\n\nIn order to support conditional outgoing mutations, we need to allow\nmultiple mutations to exist in the queue at the same time.\n\nThis means there is no longer a notion of a single \"pre-existing\nmutation\" for a model ID, there are n-many such.\n\nAll the same, we will concern the _first_ match in the queue, when we\nenact business logic about the outbox state.", "committedDate": "2020-05-20T01:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwNjA3NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/491#discussion_r427706074", "bodyText": "Ah crap this was supposed to say copyOfBuilder, to keep the old ID. Need to validate before push.", "author": "jamesonwilliams", "createdAt": "2020-05-20T02:25:56Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java", "diffHunk": "@@ -650,12 +655,40 @@ public void enqueueEventPostedWhenNewOutboxItemAdded() {\n         mutationOutbox.enqueue(PendingMutation.deletion(BlogOwner.builder()\n             .name(\"Tony Swanson\")\n             .build(), BlogOwner.class\n-        )).blockingAwait();\n+        )).blockingAwait(TIMEOUT_MS, TimeUnit.MILLISECONDS);\n \n         // Assert: we got an event!\n         eventsObserver.awaitCount(1)\n             .assertNoErrors()\n             .assertNotTerminated()\n             .assertValue(OutboxEvent.CONTENT_AVAILABLE);\n     }\n+\n+    /**\n+     * If the queue contains multiple items, then\n+     * {@link PersistentMutationOutbox#nextMutationForModelId(String)}\n+     * returns the first one.\n+     * @throws DataStoreException On failure to arrange content into storage\n+     */\n+    @Test\n+    public void nextItemForModelIdReturnsFirstEnqueued() throws DataStoreException {\n+        BlogOwner originalJoe = BlogOwner.builder()\n+            .name(\"Joe Swanson\")\n+            .build();\n+        PendingMutation<BlogOwner> firstMutation = PendingMutation.update(originalJoe, BlogOwner.class);\n+        storage.save(originalJoe, converter.toRecord(firstMutation));\n+\n+        BlogOwner updatedJoe = BlogOwner.builder()", "originalCommit": "ebcf9861a426f97b3456bf3120ab5b2204bf206c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a7e509d449d6556faf6b92f5a980e235767a723", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java\nindex f670d1d5..74f24799 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java\n\n@@ -678,8 +678,8 @@ public final class PersistentMutationOutboxTest {\n         PendingMutation<BlogOwner> firstMutation = PendingMutation.update(originalJoe, BlogOwner.class);\n         storage.save(originalJoe, converter.toRecord(firstMutation));\n \n-        BlogOwner updatedJoe = BlogOwner.builder()\n-            .name(\"Susan Now Owns the Blog\")\n+        BlogOwner updatedJoe = originalJoe.copyOfBuilder()\n+            .name(\"Joe Swanson, MD. (He finished med school, I guess?)\")\n             .build();\n         PendingMutation<BlogOwner> secondMutation = PendingMutation.update(updatedJoe, BlogOwner.class);\n         storage.save(updatedJoe, converter.toRecord(secondMutation));\n"}}, {"oid": "9a7e509d449d6556faf6b92f5a980e235767a723", "url": "https://github.com/aws-amplify/amplify-android/commit/9a7e509d449d6556faf6b92f5a980e235767a723", "message": "fixup", "committedDate": "2020-05-20T02:28:43Z", "type": "commit"}]}