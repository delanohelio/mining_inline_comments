{"pr_number": 599, "pr_title": "DataStore race condition fix and other stability-related fixes", "pr_createdAt": "2020-06-25T17:00:32Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/599", "timeline": [{"oid": "b359af12eb15b6178db2de1044954cd6ff529650", "url": "https://github.com/aws-amplify/amplify-android/commit/b359af12eb15b6178db2de1044954cd6ff529650", "message": "fix(datastore) Fix race condition on orchestrator init", "committedDate": "2020-06-25T16:40:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNDYzOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r445914639", "bodyText": "Augustus De Morgan sez:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!permitAcquired || !status.compareAndSet(OrchestratorStatus.STOPPED, OrchestratorStatus.STARTING)) {\n          \n          \n            \n                    if (!(permitAcquired && status.compareAndSet(OrchestratorStatus.STOPPED, OrchestratorStatus.STARTING)) {", "author": "jpignata", "createdAt": "2020-06-26T00:56:06Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -115,15 +119,21 @@ public boolean isStarted() {\n      * @return A Completable operation to start the sync engine orchestrator\n      */\n     @NonNull\n-    public Completable start() {\n-        // Only start if it's stopped.\n-        if (!OrchestratorStatus.STOPPED.equals(status.get())) {\n-            return initializationCompletable;\n+    public synchronized Completable start() {\n+        boolean permitAcquired = acquirePermit(OrchestratorAction.START);\n+        // Only start if it's stopped AND if we can get a permit.\n+        if (!permitAcquired || !status.compareAndSet(OrchestratorStatus.STOPPED, OrchestratorStatus.STARTING)) {", "originalCommit": "b359af12eb15b6178db2de1044954cd6ff529650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE5MTEyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r446191121", "bodyText": "hahaha...can't tell you how many times I went back and forth until the IDE \"suggested\" I use OR instead of AND...Only to find out that it would also suggest AND instead of OR when I'd switch \ud83e\udd26", "author": "rjuliano", "createdAt": "2020-06-26T13:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNDYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "3c258bc35473c6db6dfc7eb49fa44458ba1868a9", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 4202632d..afc92c7b 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -128,10 +128,10 @@ public final class Orchestrator {\n             if (permitAcquired) {\n                 startStopSemaphore.release();\n             }\n-            // initializationCompletable == null should never happen, but will protect against it just in case.\n-            return initializationCompletable == null ? Completable.complete() : initializationCompletable;\n+            // If we're not going to start it up, just tell the caller to proceed with whatever they're doing\n+            return Completable.complete();\n         }\n-        initializationCompletable = mutationOutbox.load().andThen(\n+        return mutationOutbox.load().andThen(\n             Completable.fromAction(() -> {\n                 LOG.debug(\"Starting the orchestrator.\");\n                 if (!storageObserver.isObservingStorageChanges()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNTIxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r445915219", "bodyText": "It seems like OrchestratorStatus needs some helpers like isStopped(), isStarting(), etc.", "author": "jpignata", "createdAt": "2020-06-26T00:58:34Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -115,15 +119,21 @@ public boolean isStarted() {\n      * @return A Completable operation to start the sync engine orchestrator\n      */\n     @NonNull\n-    public Completable start() {\n-        // Only start if it's stopped.\n-        if (!OrchestratorStatus.STOPPED.equals(status.get())) {", "originalCommit": "b359af12eb15b6178db2de1044954cd6ff529650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1MjU5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448352595", "bodyText": "I have an isStarted right now. That being said, I did end up changing how we do this a little bit: rather than check the start and perform action, I'm using the compareAndSet method of the AtomicReference.", "author": "rjuliano", "createdAt": "2020-07-01T13:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNTIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "3c258bc35473c6db6dfc7eb49fa44458ba1868a9", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 4202632d..afc92c7b 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -128,10 +128,10 @@ public final class Orchestrator {\n             if (permitAcquired) {\n                 startStopSemaphore.release();\n             }\n-            // initializationCompletable == null should never happen, but will protect against it just in case.\n-            return initializationCompletable == null ? Completable.complete() : initializationCompletable;\n+            // If we're not going to start it up, just tell the caller to proceed with whatever they're doing\n+            return Completable.complete();\n         }\n-        initializationCompletable = mutationOutbox.load().andThen(\n+        return mutationOutbox.load().andThen(\n             Completable.fromAction(() -> {\n                 LOG.debug(\"Starting the orchestrator.\");\n                 if (!storageObserver.isObservingStorageChanges()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNTY1Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r445915653", "bodyText": "Can we wrapped the compareAndSet operation in the same method that grabs the semaphore so it can release it as needed?", "author": "jpignata", "createdAt": "2020-06-26T01:00:29Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -147,25 +157,50 @@ public Completable start() {\n                     subscriptionProcessor.startDrainingMutationBuffer();\n                 }\n                 status.compareAndSet(OrchestratorStatus.STARTING, OrchestratorStatus.STARTED);\n+                LOG.debug(\"Orchestrator started.\");\n             })\n-        );\n+        ).doFinally(startStopSemaphore::release);\n         return initializationCompletable;\n     }\n \n     /**\n      * Stop all model synchronization.\n      */\n-    public void stop() {\n-        if (isStarted()) {\n+    public synchronized void stop() {\n+        boolean permitAcquired = acquirePermit(OrchestratorAction.STOP);\n+        // only stop if it's started AND if we can get a permit.\n+        if (!permitAcquired || !status.compareAndSet(OrchestratorStatus.STARTED, OrchestratorStatus.STOPPING)) {\n+            LOG.warn(String.format(\"Orchestrator could not be stopped. Orchestrator status: %s\", status.get()));\n+            // If we acquired the permit but failed to set the status, let's release the permit.\n+            if (permitAcquired) {\n+                startStopSemaphore.release();\n+            }\n+            return;\n+        }\n+        try {\n             LOG.info(\"Intentionally stopping cloud synchronization, now.\");\n-            status.compareAndSet(OrchestratorStatus.STARTED, OrchestratorStatus.STOPPING);\n             subscriptionProcessor.stopAllSubscriptionActivity();\n             storageObserver.stopObservingStorageChanges();\n             mutationProcessor.stopDrainingMutationOutbox();\n             status.compareAndSet(OrchestratorStatus.STOPPING, OrchestratorStatus.STOPPED);\n             LOG.debug(\"Stopped remote synchronization.\");\n+        } finally {\n+            startStopSemaphore.release();\n         }\n+    }\n \n+    private boolean acquirePermit(OrchestratorAction action) {", "originalCommit": "b359af12eb15b6178db2de1044954cd6ff529650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE5MTU2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r446191566", "bodyText": "I can definitely do that. \ud83d\udc4d", "author": "rjuliano", "createdAt": "2020-06-26T13:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNTY1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3c258bc35473c6db6dfc7eb49fa44458ba1868a9", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 4202632d..afc92c7b 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -160,7 +160,6 @@ public final class Orchestrator {\n                 LOG.debug(\"Orchestrator started.\");\n             })\n         ).doFinally(startStopSemaphore::release);\n-        return initializationCompletable;\n     }\n \n     /**\n"}}, {"oid": "3c258bc35473c6db6dfc7eb49fa44458ba1868a9", "url": "https://github.com/aws-amplify/amplify-android/commit/3c258bc35473c6db6dfc7eb49fa44458ba1868a9", "message": "Don't try to initialize orchestrator in beforeOperation", "committedDate": "2020-06-26T13:26:54Z", "type": "commit"}, {"oid": "3a1f4a054450d1a1fcdb85eb6cc6d9f832d50b5c", "url": "https://github.com/aws-amplify/amplify-android/commit/3a1f4a054450d1a1fcdb85eb6cc6d9f832d50b5c", "message": "Update aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\r\n\r\nDe Morgan's Laws\n\nCo-authored-by: John Pignata <john@pignata.com>", "committedDate": "2020-06-26T14:00:37Z", "type": "commit"}, {"oid": "a26a83fd7ab1b774a33d30f6d1b09c46fb4e24be", "url": "https://github.com/aws-amplify/amplify-android/commit/a26a83fd7ab1b774a33d30f6d1b09c46fb4e24be", "message": "Refactored some stop/start logic", "committedDate": "2020-06-26T14:37:49Z", "type": "commit"}, {"oid": "63a79689fdd4a5475fdcffcc5dfcf681a53bffc0", "url": "https://github.com/aws-amplify/amplify-android/commit/63a79689fdd4a5475fdcffcc5dfcf681a53bffc0", "message": "Merge branch 'rjuliano/bugfix_startcrash' of github.com:aws-amplify/amplify-android into rjuliano/bugfix_startcrash", "committedDate": "2020-06-26T14:39:05Z", "type": "commit"}, {"oid": "97f643e75288b3cc7aec465fbf15284f0639abd0", "url": "https://github.com/aws-amplify/amplify-android/commit/97f643e75288b3cc7aec465fbf15284f0639abd0", "message": "Checkstyle fixes", "committedDate": "2020-06-26T15:47:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r446554249", "bodyText": "I saw this pattern in multiple place in Amplify Android's source code. Is there any reason why we want to perform observeOn and subscribeOn at the same place with the same scheduler?\nShould'nt\norchestrator.start()\n                  .subscribeOn(Schedulers.io());\n\nDo the work? Unless you were using a Subject which may change the threading so you have to reset the scheduler in observeOn but i dont see any Subject in orchestrator", "author": "richardissuperman", "createdAt": "2020-06-27T18:34:47Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -449,7 +450,10 @@ private Completable initializeOrchestrator() {\n         if (api.getPlugins().isEmpty()) {\n             return Completable.complete();\n         } else {\n-            return orchestrator.start();\n+            // Let's prevent the orchestrator startup from possibly running in main.\n+            return orchestrator.start()\n+                .observeOn(Schedulers.io())\n+                .subscribeOn(Schedulers.io());", "originalCommit": "b359af12eb15b6178db2de1044954cd6ff529650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MjM4OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r446972388", "bodyText": "The thinking behind that was to ensure it was not in main since we have the occasional blockingAwait/Get call throughout the process. Not sure if it makes a difference, but the subscriber of the SubscriptionProcessor is a ReplaySubject", "author": "rjuliano", "createdAt": "2020-06-29T13:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzExNDIyNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r447114226", "bodyText": "@rjuliano yeah then i dont think its needed to call observeOn again, it will just wrap the lower stream runnable into the same thread pool.\nwe only need to switch to same scheduler if we have below use case , which is to transform a callback style code into rxjava observable\n Observable.<StorageItemChange<? extends Model>>create(emitter ->\n                localStorageAdapter.observe(emitter::onNext, emitter::onError, emitter::onComplete)\n            )\n            .subscribeOn(Schedulers.single())\n            .observeOn(Schedulers.single())\n\n\nThe above code makes sense cause the emitter will be emitting the onNext event in a different thread other than the one we specify in Schedulers.single(), so it makes sense to quickly switch back to it by calling single,\nsimilar use case : https://github.com/aws-amplify/amplify-android/blob/main/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java#L137\nnit: the above link code i think it need to be changed as well as the onErrorResume() will be executed not in IO() thread scheduler", "author": "richardissuperman", "createdAt": "2020-06-29T16:52:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NjEzNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r447166136", "bodyText": "That makes sense. That's the change you made in #612 right @richardmcclellan ?", "author": "rjuliano", "createdAt": "2020-06-29T18:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3MzU0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r447173546", "bodyText": "I think you meant @richardissuperman, not me :)", "author": "richardmcclellan", "createdAt": "2020-06-29T18:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MjEwNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r447342105", "bodyText": "@rjuliano yep, exactly, but that PR was messed up with my previous commit, will revise all two later tonight", "author": "richardissuperman", "createdAt": "2020-06-30T00:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM0OTg5MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448349890", "bodyText": "Cool...that's super helpful and thanks for updating the PR. I just merged it.", "author": "rjuliano", "createdAt": "2020-07-01T13:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e0999e0b22a0be339040397b82ef79cf7f4ae73", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\nindex 92f427dd..0c8ab11c 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n\n@@ -426,23 +441,51 @@ public final class AWSDataStorePlugin extends DataStorePlugin<Void> {\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        beforeOperation(() -> {\n-            orchestrator.stop();\n-            sqliteStorageAdapter.clear(onComplete, onError);\n-        });\n+        // We shouldn't call beforeOperation when clearing the DataStore. The\n+        // only thing we have to wait for is the category initialization latch.\n+        boolean isCategoryInitialized = false;\n+        try {\n+            isCategoryInitialized = categoryInitializationsPending.await(PLUGIN_INIT_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+        } catch (InterruptedException exception) {\n+            LOG.warn(\"Execution interrupted while waiting for DataStore to be initialized.\");\n+        }\n+        if (!isCategoryInitialized) {\n+            onError.accept(new DataStoreException(\"DataStore not ready to be cleared.\", \"Retry your request.\"));\n+            return;\n+        }\n+        isOrchestratorReady.set(false);\n+        orchestrator.stop()\n+            .subscribeOn(Schedulers.io())\n+            .andThen(Completable.fromAction(() -> sqliteStorageAdapter.clear(() -> {\n+                // Invoke the consumer's callback once the clear operation is finished.\n+                onComplete.call();\n+                // Kick off the orchestrator asynchronously.\n+                initializeOrchestrator()\n+                    .doOnError(throwable -> LOG.warn(\"Failed to restart orchestrator after clearing.\", throwable))\n+                    .doOnComplete(() -> LOG.info(\"Orchestrator restarted after clear operation.\"))\n+                    .subscribe();\n+            }, onError)))\n+            .doOnError(throwable -> LOG.warn(\"Clear operation failed\", throwable))\n+            .doOnComplete(() -> LOG.debug(\"Clear operation completed.\"))\n+            .subscribe();\n     }\n \n     private void beforeOperation(@NonNull final Runnable runnable) {\n-        Completable opCompletable = Completable.fromAction(categoryInitializationsPending::await);\n-        if (!orchestrator.isStarted()) {\n-            opCompletable = opCompletable\n-                .andThen(initializeOrchestrator());\n-        }\n-        Throwable throwable = opCompletable\n+        Throwable throwable = Completable.fromAction(categoryInitializationsPending::await)\n+            .repeatUntil(() -> {\n+                // Repeat until this is true or the blockingGet call times out.\n+                synchronized (isOrchestratorReady) {\n+                    return isOrchestratorReady.get();\n+                }\n+            })\n             .andThen(Completable.fromRunnable(runnable))\n             .blockingGet(PLUGIN_INIT_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n-        if (throwable != null) {\n-            LOG.warn(\"Failed to execute request due to an unexpected error.\", throwable);\n+        if (!(throwable == null && isOrchestratorReady.get())) {\n+            if (!isOrchestratorReady.get()) {\n+                LOG.warn(\"Failed to execute request because DataStore is not fully initialized.\");\n+            } else {\n+                LOG.warn(\"Failed to execute request due to an unexpected error.\", throwable);\n+            }\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0ODc1Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r446848752", "bodyText": "nit: call call", "author": "jamesonwilliams", "createdAt": "2020-06-29T08:13:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -425,19 +426,22 @@ public void observe(\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        beforeOperation(() -> {\n-            orchestrator.stop();\n-            sqliteStorageAdapter.clear(onComplete, onError);\n-        });\n+        // We shouldn't call call beforeOperation when clearing the DataStore. The", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\nindex 6904d962..ba35933d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n\n@@ -426,7 +426,7 @@ public final class AWSDataStorePlugin extends DataStorePlugin<Void> {\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        // We shouldn't call call beforeOperation when clearing the DataStore. The\n+        // We shouldn't call beforeOperation when clearing the DataStore. The\n         // only thing we have to wait for is the category initialization latch.\n         try {\n             categoryInitializationsPending.await();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExODM3Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448118376", "bodyText": "Even before, we weren't checking the return value here -- wether or not the latch actually counted down. Should we be, now?", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:10:07Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -117,14 +117,19 @@ void startSubscriptions() {\n                 clazz,\n                 token -> latch.countDown(),\n                 emitter::onNext,\n-                emitter::onError,\n+                AmplifyDisposables.onErrorConsumerWrapperFor(emitter),\n                 emitter::onComplete\n             );\n             // When the observable is disposed, we need to call cancel() on the subscription\n             // so it can properly dispose of resources if necessary. For the AWS API plugin,\n             // this means means closing the underlying network connection.\n             emitter.setDisposable(AmplifyDisposables.fromCancelable(cancelable));\n-            latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxNTMyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448315321", "bodyText": "That's a good call. If it returns false, we know it was a timeout. If it throws the InterruptedException we know it was killed before the timeout lapsed.", "author": "rjuliano", "createdAt": "2020-07-01T12:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExODM3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java\nindex 917d65c2..0fa40fc5 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java\n\n@@ -125,7 +124,10 @@ final class SubscriptionProcessor {\n             // this means means closing the underlying network connection.\n             emitter.setDisposable(AmplifyDisposables.fromCancelable(cancelable));\n             try {\n-                latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+                if (!latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS)) {\n+                    emitter.onError(new DataStoreException(\"Subscription failed to start due to a timeout\",\n+                                                            AmplifyException.TODO_RECOVERY_SUGGESTION));\n+                }\n             } catch (InterruptedException exception) {\n                 LOG.warn(\"Subscription operation interrupted. \" +\n                     (emitter.isDisposed() ? \" Emitter already disposed.\" : \"\"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTAyNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448119025", "bodyText": "Is it an AmplifyDisposables thing, really? It doesn't build a Disposable. If you only use it from the SubscriptionProcessor, maybe it should live as a static utility method on that class, instead?", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:12:20Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AmplifyDisposables.java", "diffHunk": "@@ -61,4 +71,47 @@ public boolean isDisposed() {\n             }\n         };\n     }\n+\n+    /**\n+     * This function that creates a {@link Consumer} which wraps the {@link ObservableEmitter#onError(Throwable)}\n+     * to prevent it from calling observers that have already been disposed.\n+     *\n+     * <p>\n+     * The scenario is that we have multiple event sources (1 AppSync subscription\n+     * for each model+operation type combination) being consumed by a single downstream\n+     * oberserver. Once the first subscription emits an error, the downstream subscriber\n+     * is placed in a disposed state and will not receive any further notifications.\n+     * In a situation such as loss of connectivity, it's innevitable that multiple subscriptions will fail.\n+     * With that said, after the first failure, the other events sources (AppSync subscriptions)\n+     * will attempt to invoke the downstream onError handler which then results in an\n+     * {@link io.reactivex.exceptions.UndeliverableException} being thrown.\n+     * </p>\n+     *\n+     * <p>\n+     * This method takes a reference of the observable that represents the AppSync subscription,\n+     * wraps it and returns a {@link Consumer} that is used as the onError parameter. The returned\n+     * {@link Consumer} function will delegate the onError call to the downstream observers if it's\n+     * still available, otherwise it logs a warning.\n+     * </p>\n+     *\n+     * @param realEmitter The emitter which will have it's onError function proxied by the return\n+     *                    value of this function.\n+     * @param <T> The type of model handled by the emitter.\n+     * @param <E> The type of exception for the onError consumer\n+     * @return A {@link Consumer} that proxies the {@link ObservableEmitter#onError(Throwable)} call\n+     * to the {@code realEmitter} if it's not disposed or logs a warning.\n+     * @see <a href=\"https://github.com/aws-amplify/amplify-android/issues/541\">GitHub issue #541</a>\n+     *\n+     */\n+    @NonNull\n+    public static <T extends Model, E extends AmplifyException> Consumer<E> onErrorConsumerWrapperFor(", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxMzkxNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448313915", "bodyText": "I'm not sure I'm really comfortable with the fact that it even exists. The more I think about it, the more I feel like we shouldn't have to do this. I added it because we have multiple Observables (one for each subscription) merging into one observer. Once onError is called from any of the subscriptions, the downstream observer is done, while the upstream subscriptions are blissfully unaware of that until they attempt to invoke either onError or onNext (a.k.a the lapsed listener problem\nI'm going to take another look at this today. I feel like there's gotta be a better solution.", "author": "rjuliano", "createdAt": "2020-07-01T11:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MzY3Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448483672", "bodyText": "\u2764\ufe0f was granted for the wiki link! :-D", "author": "jamesonwilliams", "createdAt": "2020-07-01T16:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTAyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTIwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448119208", "bodyText": "Should we be checking the return value here to tell whether or not the latch did count down? What are the appropriate actions to take if so, vs. if not?", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:13:11Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -425,19 +426,22 @@ public void observe(\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        beforeOperation(() -> {\n-            orchestrator.stop();\n-            sqliteStorageAdapter.clear(onComplete, onError);\n-        });\n+        // We shouldn't call call beforeOperation when clearing the DataStore. The\n+        // only thing we have to wait for is the category initialization latch.\n+        try {\n+            categoryInitializationsPending.await();", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1NTIwNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448355204", "bodyText": "Let me think about this one. Just realized also that we don't have a timeout on this await. We'll need to do some testing on this though.", "author": "rjuliano", "createdAt": "2020-07-01T13:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MTg0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452151841", "bodyText": "I added a timeout and it's also now checking the result of the await operation.", "author": "rjuliano", "createdAt": "2020-07-09T11:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTIwOA=="}], "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\nindex 6904d962..ba35933d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n\n@@ -426,7 +426,7 @@ public final class AWSDataStorePlugin extends DataStorePlugin<Void> {\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        // We shouldn't call call beforeOperation when clearing the DataStore. The\n+        // We shouldn't call beforeOperation when clearing the DataStore. The\n         // only thing we have to wait for is the category initialization latch.\n         try {\n             categoryInitializationsPending.await();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTYxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448119619", "bodyText": "Should onComplete.call() be fired as a result of the subscription, when the initialization of the orchestrator completes, later? That is,\ninitializeOrchestrator().subscribe(onComplete::call);", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:14:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -425,19 +426,22 @@ public void observe(\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        beforeOperation(() -> {\n-            orchestrator.stop();\n-            sqliteStorageAdapter.clear(onComplete, onError);\n-        });\n+        // We shouldn't call call beforeOperation when clearing the DataStore. The\n+        // only thing we have to wait for is the category initialization latch.\n+        try {\n+            categoryInitializationsPending.await();\n+        } catch (InterruptedException exception) {\n+            LOG.warn(\"Execution interrupted while waiting for DataStore to be initialized.\");\n+        }\n+        orchestrator.stop();\n+        sqliteStorageAdapter.clear(() -> {\n+            initializeOrchestrator().subscribe();\n+            onComplete.call();", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1NTM4OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448355389", "bodyText": "Done", "author": "rjuliano", "createdAt": "2020-07-01T13:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExOTYxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\nindex 6904d962..ba35933d 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java\n\n@@ -426,7 +426,7 @@ public final class AWSDataStorePlugin extends DataStorePlugin<Void> {\n     @Override\n     public void clear(@NonNull Action onComplete,\n                       @NonNull Consumer<DataStoreException> onError) {\n-        // We shouldn't call call beforeOperation when clearing the DataStore. The\n+        // We shouldn't call beforeOperation when clearing the DataStore. The\n         // only thing we have to wait for is the category initialization latch.\n         try {\n             categoryInitializationsPending.await();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMDQxMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448120412", "bodyText": "Can you get rid of the OrchestratorAction entirely, if you make this:\nprivate boolean transitionToState(OrchestratorState targetState) {\n?", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:17:59Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -147,25 +149,56 @@ public Completable start() {\n                     subscriptionProcessor.startDrainingMutationBuffer();\n                 }\n                 status.compareAndSet(OrchestratorStatus.STARTING, OrchestratorStatus.STARTED);\n+                LOG.debug(\"Orchestrator started.\");\n             })\n-        );\n-        return initializationCompletable;\n+        ).doFinally(startStopSemaphore::release);\n     }\n \n     /**\n      * Stop all model synchronization.\n      */\n-    public void stop() {\n-        if (isStarted()) {\n+    public synchronized void stop() {\n+        if (!performAction(OrchestratorAction.STOP)) {\n+            return;\n+        }\n+        try {\n             LOG.info(\"Intentionally stopping cloud synchronization, now.\");\n-            status.compareAndSet(OrchestratorStatus.STARTED, OrchestratorStatus.STOPPING);\n             subscriptionProcessor.stopAllSubscriptionActivity();\n             storageObserver.stopObservingStorageChanges();\n             mutationProcessor.stopDrainingMutationOutbox();\n             status.compareAndSet(OrchestratorStatus.STOPPING, OrchestratorStatus.STOPPED);\n             LOG.debug(\"Stopped remote synchronization.\");\n+        } finally {\n+            startStopSemaphore.release();\n         }\n+    }\n \n+    private boolean performAction(OrchestratorAction intendedAction) {", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzNTk4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448335983", "bodyText": "Good call. Totally doable.", "author": "rjuliano", "createdAt": "2020-07-01T12:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMDQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 73b1feec..37f61947 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -158,7 +158,7 @@ public final class Orchestrator {\n      * Stop all model synchronization.\n      */\n     public synchronized void stop() {\n-        if (!performAction(OrchestratorAction.STOP)) {\n+        if (!transitionToState(OrchestratorStatus.STOPPED)) {\n             return;\n         }\n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMDY0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448120647", "bodyText": "This might be an error, if the user is expecting cloud sync to function? Should we wire this back to the user error handler somehow, too?", "author": "jamesonwilliams", "createdAt": "2020-07-01T05:18:57Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -147,25 +149,56 @@ public Completable start() {\n                     subscriptionProcessor.startDrainingMutationBuffer();\n                 }\n                 status.compareAndSet(OrchestratorStatus.STARTING, OrchestratorStatus.STARTED);\n+                LOG.debug(\"Orchestrator started.\");\n             })\n-        );\n-        return initializationCompletable;\n+        ).doFinally(startStopSemaphore::release);\n     }\n \n     /**\n      * Stop all model synchronization.\n      */\n-    public void stop() {\n-        if (isStarted()) {\n+    public synchronized void stop() {\n+        if (!performAction(OrchestratorAction.STOP)) {\n+            return;\n+        }\n+        try {\n             LOG.info(\"Intentionally stopping cloud synchronization, now.\");\n-            status.compareAndSet(OrchestratorStatus.STARTED, OrchestratorStatus.STOPPING);\n             subscriptionProcessor.stopAllSubscriptionActivity();\n             storageObserver.stopObservingStorageChanges();\n             mutationProcessor.stopDrainingMutationOutbox();\n             status.compareAndSet(OrchestratorStatus.STOPPING, OrchestratorStatus.STOPPED);\n             LOG.debug(\"Stopped remote synchronization.\");\n+        } finally {\n+            startStopSemaphore.release();\n         }\n+    }\n \n+    private boolean performAction(OrchestratorAction intendedAction) {\n+        OrchestratorStatus expectedCurrentStatus = OrchestratorAction.START.equals(intendedAction) ?\n+            OrchestratorStatus.STOPPED : OrchestratorStatus.STARTED;\n+        try {\n+            LOG.debug(String.format(\"Trying to %s the orchestrator.\", intendedAction.name()));\n+            boolean permitAcquired = startStopSemaphore.tryAcquire(ACQUIRE_PERMIT_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n+            if (!permitAcquired) {\n+                LOG.warn(String.format(\"Unable to acquire permit to %s the orchestrator. \", intendedAction.name()));\n+                return false;\n+            }\n+            boolean statusSet = status.compareAndSet(intendedAction.expectedCurrentStatus, intendedAction.targetStatus);\n+            // only stop if it's started AND if we can get a permit.\n+            if (!statusSet) {\n+                LOG.warn(String.format(\"Failed %s orchestrator. Current status: %s\",", "originalCommit": "97f643e75288b3cc7aec465fbf15284f0639abd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM0MTU1OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r448341558", "bodyText": "I was torn about this one. Part of me thinks I shouldn't bubble up an exception if the orchestrator fails simply because I don't think the consuming app can do anything about it. That being said, it feels wrong not to do so. I like the idea of at least passing the error to the user-provided error handler though (if one is provided).\nGoing to work on that today.", "author": "rjuliano", "createdAt": "2020-07-01T12:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMDY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI0ODE1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452248151", "bodyText": "I added some logic here to invoke the user-provided onError callback (if one is provided)", "author": "rjuliano", "createdAt": "2020-07-09T14:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMDY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\nindex 73b1feec..37f61947 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java\n\n@@ -158,7 +158,7 @@ public final class Orchestrator {\n      * Stop all model synchronization.\n      */\n     public synchronized void stop() {\n-        if (!performAction(OrchestratorAction.STOP)) {\n+        if (!transitionToState(OrchestratorStatus.STOPPED)) {\n             return;\n         }\n         try {\n"}}, {"oid": "c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "url": "https://github.com/aws-amplify/amplify-android/commit/c3aff4bdde6b9c73a6791221f39e4264c2ce12d5", "message": "PR feedback", "committedDate": "2020-07-01T13:31:24Z", "type": "commit"}, {"oid": "b99355025c2f031616ba91e4fdfb40b5237fde5a", "url": "https://github.com/aws-amplify/amplify-android/commit/b99355025c2f031616ba91e4fdfb40b5237fde5a", "message": "Retry logic for subscription processor. Modified start/stop sequence", "committedDate": "2020-07-09T03:53:07Z", "type": "commit"}, {"oid": "80e53ece4faf44f7da70c7a5430ea6f356a6bcf4", "url": "https://github.com/aws-amplify/amplify-android/commit/80e53ece4faf44f7da70c7a5430ea6f356a6bcf4", "message": "Remove file that was incorrectly checked in", "committedDate": "2020-07-09T03:55:36Z", "type": "commit"}, {"oid": "6f546f8d2efeb8f22211f7df6d3d432972e2a58f", "url": "https://github.com/aws-amplify/amplify-android/commit/6f546f8d2efeb8f22211f7df6d3d432972e2a58f", "message": "Fixing lint warnings", "committedDate": "2020-07-09T04:25:43Z", "type": "commit"}, {"oid": "074fae16941849ecac7b83cfe3bb04b50bcb4a54", "url": "https://github.com/aws-amplify/amplify-android/commit/074fae16941849ecac7b83cfe3bb04b50bcb4a54", "message": "Checkstyle issues", "committedDate": "2020-07-09T11:27:30Z", "type": "commit"}, {"oid": "6a4848025c79e928a9ed3d69267a924628241188", "url": "https://github.com/aws-amplify/amplify-android/commit/6a4848025c79e928a9ed3d69267a924628241188", "message": "Fixing tests by introduce a delay to wait for orchestrator to start.", "committedDate": "2020-07-09T14:11:06Z", "type": "commit"}, {"oid": "81391e7b6aaa891df32cc43da3c6d771d68b7b56", "url": "https://github.com/aws-amplify/amplify-android/commit/81391e7b6aaa891df32cc43da3c6d771d68b7b56", "message": "Merge branch 'main' into rjuliano/bugfix_startcrash", "committedDate": "2020-07-09T15:25:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNTkwMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452405901", "bodyText": "Do you have anyConsumer() available here? I forget where that utility lives.", "author": "jamesonwilliams", "createdAt": "2020-07-09T18:20:28Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java", "diffHunk": "@@ -248,5 +249,25 @@ public SyncConfigurator mockSuccessResponses() {\n             );\n             return SyncConfigurator.this;\n         }\n+\n+        /**\n+         * Triggers an exception when invoking the sync method.\n+         * @param <T> Type of models for which a response is mocked\n+         * @return The same Configurator instance, to enable chaining of calls\n+         */\n+        public <T extends Model> SyncConfigurator mockFailure() {\n+            doAnswer(invocation -> {\n+                final int errorConsumerPosition = 3;\n+                final Consumer<DataStoreException> consumer = invocation.getArgument(errorConsumerPosition);\n+                consumer.accept(new DataStoreException(\"Something timed out during sync.\", \"Nothing to do.\"));\n+                return new NoOpCancelable();\n+            }).when(appSync).sync(\n+                any(), // Item class to sync\n+                any(), // last sync time\n+                any(), // Consumer<Iterable<ModelWithMetadata<T>>>", "originalCommit": "6a4848025c79e928a9ed3d69267a924628241188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1MTYzMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r454551633", "bodyText": "It's a private static function buried in SubscriptionProcessorTest It probably should be moved elsewhere.", "author": "rjuliano", "createdAt": "2020-07-14T18:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNTkwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "bb57a46fcfb0c14f60be27ca6e905acd365e20cd", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\nindex ced52dbe..a31d216c 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\n\n@@ -252,14 +252,15 @@ public final class AppSyncMocking {\n \n         /**\n          * Triggers an exception when invoking the sync method.\n+         * @param dataStoreException The exception that will be used for the mock.\n          * @param <T> Type of models for which a response is mocked\n          * @return The same Configurator instance, to enable chaining of calls\n          */\n-        public <T extends Model> SyncConfigurator mockFailure() {\n+        public <T extends Model> SyncConfigurator mockFailure(DataStoreException dataStoreException) {\n             doAnswer(invocation -> {\n                 final int errorConsumerPosition = 3;\n                 final Consumer<DataStoreException> consumer = invocation.getArgument(errorConsumerPosition);\n-                consumer.accept(new DataStoreException(\"Something timed out during sync.\", \"Nothing to do.\"));\n+                consumer.accept(dataStoreException);\n                 return new NoOpCancelable();\n             }).when(appSync).sync(\n                 any(), // Item class to sync\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNjUzNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452406534", "bodyText": "Can you change to accept a DataStoreException, and then pass in the failure when you make the call? That way, the AppSyncMocking can remain as utility software, with any specific values codified external to its implementation.", "author": "jamesonwilliams", "createdAt": "2020-07-09T18:21:27Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java", "diffHunk": "@@ -248,5 +249,25 @@ public SyncConfigurator mockSuccessResponses() {\n             );\n             return SyncConfigurator.this;\n         }\n+\n+        /**\n+         * Triggers an exception when invoking the sync method.\n+         * @param <T> Type of models for which a response is mocked\n+         * @return The same Configurator instance, to enable chaining of calls\n+         */\n+        public <T extends Model> SyncConfigurator mockFailure() {", "originalCommit": "6a4848025c79e928a9ed3d69267a924628241188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Mzc4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r454553785", "bodyText": "Done", "author": "rjuliano", "createdAt": "2020-07-14T18:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNjUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "bb57a46fcfb0c14f60be27ca6e905acd365e20cd", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\nindex ced52dbe..a31d216c 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncMocking.java\n\n@@ -252,14 +252,15 @@ public final class AppSyncMocking {\n \n         /**\n          * Triggers an exception when invoking the sync method.\n+         * @param dataStoreException The exception that will be used for the mock.\n          * @param <T> Type of models for which a response is mocked\n          * @return The same Configurator instance, to enable chaining of calls\n          */\n-        public <T extends Model> SyncConfigurator mockFailure() {\n+        public <T extends Model> SyncConfigurator mockFailure(DataStoreException dataStoreException) {\n             doAnswer(invocation -> {\n                 final int errorConsumerPosition = 3;\n                 final Consumer<DataStoreException> consumer = invocation.getArgument(errorConsumerPosition);\n-                consumer.accept(new DataStoreException(\"Something timed out during sync.\", \"Nothing to do.\"));\n+                consumer.accept(dataStoreException);\n                 return new NoOpCancelable();\n             }).when(appSync).sync(\n                 any(), // Item class to sync\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNzgzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452407837", "bodyText": "We should keep this event driven, even from test. There is an initialization event that is published, currently. The intent of that event was to prevent the need for waits, in test. Between it, and the HubAccumulator, you should be able to await the initialization results. It's a more determinist mechanism than tuning ASSERTION_TIMEOUT_MS.", "author": "jamesonwilliams", "createdAt": "2020-07-09T18:23:55Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -242,6 +247,8 @@ private void assertRemoteSubscriptionsCancelled() {\n     }\n \n     private void assertRemoteSubscriptionsStarted() {\n+        // Introduce a delay to allow the orchestrator to start since this is done in a non-blocking manner now.\n+        Single.just(true).delay(ASSERTION_TIMEOUT_MS, TimeUnit.MILLISECONDS).blockingGet();", "originalCommit": "6a4848025c79e928a9ed3d69267a924628241188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2ODk5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r454568992", "bodyText": "That makes sense. I just changed it so the orchestrator emits a hub event on start and stop. Then modified the test to use the HubAccumulator. It will be in my next commit.", "author": "rjuliano", "createdAt": "2020-07-14T18:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNzgzNw=="}], "type": "inlineReview", "revised_code": {"commit": "bb57a46fcfb0c14f60be27ca6e905acd365e20cd", "chunk": "diff --git a/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java b/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\nindex 81ae9d60..b7bd5397 100644\n--- a/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\n+++ b/aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java\n\n@@ -247,8 +267,6 @@ public final class AWSDataStorePluginTest {\n     }\n \n     private void assertRemoteSubscriptionsStarted() {\n-        // Introduce a delay to allow the orchestrator to start since this is done in a non-blocking manner now.\n-        Single.just(true).delay(ASSERTION_TIMEOUT_MS, TimeUnit.MILLISECONDS).blockingGet();\n         // For each model, there should be 3 subscriptions setup.\n         // If subscriptions are active, the active counters should be:\n         // activeCount - cancelledCount = modelCount * 3\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwODQyNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r452408424", "bodyText": "Can getConfiguration() ever return null? Is there a need to guard against that scenario, here, to prevent a NullPointerException?", "author": "jamesonwilliams", "createdAt": "2020-07-09T18:25:00Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -113,9 +114,18 @@ Completable hydrate() {\n                         .flatMapCompletable(merger::merge)\n                     )\n                     .andThen(syncTimeRegistry.saveLastSyncTime(modelClass, SyncTime.now()))\n-                    .doOnError(failureToSync ->\n-                        LOG.warn(\"Initial cloud sync failed.\", failureToSync)\n-                    )\n+                    .doOnError(failureToSync -> {\n+                        LOG.warn(\"Initial cloud sync failed.\", failureToSync);\n+                        DataStoreErrorHandler dataStoreErrorHandler =\n+                            dataStoreConfigurationProvider.getConfiguration().getDataStoreErrorHandler();", "originalCommit": "6a4848025c79e928a9ed3d69267a924628241188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NzUxMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/599#discussion_r454577510", "bodyText": "I don't think so. That parameter comes from the plugin's constructor and passes the plugin configuration that's initialized here. Since the orchestrator is only started after the plugin is configured, I think we're safe here.", "author": "rjuliano", "createdAt": "2020-07-14T19:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwODQyNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bb57a46fcfb0c14f60be27ca6e905acd365e20cd", "url": "https://github.com/aws-amplify/amplify-android/commit/bb57a46fcfb0c14f60be27ca6e905acd365e20cd", "message": "Addressing PR feedback", "committedDate": "2020-07-14T19:12:34Z", "type": "commit"}, {"oid": "49a37809b53fa4c71d2986d370b5d2449edfce01", "url": "https://github.com/aws-amplify/amplify-android/commit/49a37809b53fa4c71d2986d370b5d2449edfce01", "message": "Merge branch 'rjuliano/bugfix_startcrash' of github.com:aws-amplify/amplify-android into rjuliano/bugfix_startcrash", "committedDate": "2020-07-14T19:14:25Z", "type": "commit"}, {"oid": "6ce46782c0fe5dbd6ddf3efb5ac28e27eeb3c57c", "url": "https://github.com/aws-amplify/amplify-android/commit/6ce46782c0fe5dbd6ddf3efb5ac28e27eeb3c57c", "message": "Add new hub event message types", "committedDate": "2020-07-14T19:22:15Z", "type": "commit"}, {"oid": "890c58d104c30157b4ef471d7d9370887c8be259", "url": "https://github.com/aws-amplify/amplify-android/commit/890c58d104c30157b4ef471d7d9370887c8be259", "message": "Changes related to subscription connectivity problems (#615)\n\n* Changes to the API module", "committedDate": "2020-07-15T13:09:55Z", "type": "commit"}, {"oid": "8ec27f4164b334754c935de426396150309179d5", "url": "https://github.com/aws-amplify/amplify-android/commit/8ec27f4164b334754c935de426396150309179d5", "message": "Adding basic unit tests for retry handler", "committedDate": "2020-07-15T14:41:02Z", "type": "commit"}, {"oid": "576ed5583dcfd1ca814a791e27d6d40fc3f0b4e2", "url": "https://github.com/aws-amplify/amplify-android/commit/576ed5583dcfd1ca814a791e27d6d40fc3f0b4e2", "message": "Checkstyle fixes :(", "committedDate": "2020-07-15T14:49:44Z", "type": "commit"}, {"oid": "2e0999e0b22a0be339040397b82ef79cf7f4ae73", "url": "https://github.com/aws-amplify/amplify-android/commit/2e0999e0b22a0be339040397b82ef79cf7f4ae73", "message": "Fixing another race condition", "committedDate": "2020-07-15T22:23:22Z", "type": "commit"}]}