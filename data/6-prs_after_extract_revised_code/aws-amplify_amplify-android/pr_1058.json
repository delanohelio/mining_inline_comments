{"pr_number": 1058, "pr_title": "fix(aws-datastore): ignore foreign key error during sync", "pr_createdAt": "2020-12-17T01:20:25Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/1058", "timeline": [{"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa", "url": "https://github.com/aws-amplify/amplify-android/commit/4f411de80067818d2ae317e83766e86ece9bc9fa", "message": "swallow foreign key error during sync", "committedDate": "2020-12-17T01:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5MDA2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r544790066", "bodyText": "I think we should avoid putting stuff in the core module unless it'l be used widely. Even though this is a generic utility, it might be better suited to the DataStore module, where it won't add size to the core artifact (if, for example, someone uses Auth, without DataStore.)", "author": "jamesonwilliams", "createdAt": "2020-12-17T03:44:32Z", "path": "core/src/main/java/com/amplifyframework/util/Error.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.util;", "originalCommit": "4f411de80067818d2ae317e83766e86ece9bc9fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f526504c240ffd1393c510b53920c6b5282f5907", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/util/Error.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\nsimilarity index 86%\nrename from core/src/main/java/com/amplifyframework/util/Error.java\nrename to aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\nindex 29c65cbb..d4f6bd5c 100644\n--- a/core/src/main/java/com/amplifyframework/util/Error.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\n\n@@ -13,7 +13,7 @@\n  * permissions and limitations under the License.\n  */\n \n-package com.amplifyframework.util;\n+package com.amplifyframework.datastore.utils;\n \n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIyOTIzNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545229235", "bodyText": "I would expect a class named Error to be instantiable, and to represent a particular error.  What about calling this something like ErrorInspector, or ThrowableInspector, or ErrorCause (and rename containsCause to just contains)?   Just a thought.  I think I like ErrorInspector the best, though I don't feel too strongly.", "author": "richardmcclellan", "createdAt": "2020-12-17T16:34:03Z", "path": "core/src/main/java/com/amplifyframework/util/Error.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.util;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Utility class to provide helpful functions to use on throwable instances.\n+ */\n+public final class Error {", "originalCommit": "4f411de80067818d2ae317e83766e86ece9bc9fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMwNTcwNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545305707", "bodyText": "I too was uncomfortable with the name Error but I didn't want to call it ErrorUtils because that's just lame haha. I'll go with ErrorInspector as you suggested.", "author": "raphkim", "createdAt": "2020-12-17T18:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIyOTIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f526504c240ffd1393c510b53920c6b5282f5907", "chunk": "diff --git a/core/src/main/java/com/amplifyframework/util/Error.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\nsimilarity index 86%\nrename from core/src/main/java/com/amplifyframework/util/Error.java\nrename to aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\nindex 29c65cbb..d4f6bd5c 100644\n--- a/core/src/main/java/com/amplifyframework/util/Error.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/utils/ErrorInspector.java\n\n@@ -13,7 +13,7 @@\n  * permissions and limitations under the License.\n  */\n \n-package com.amplifyframework.util;\n+package com.amplifyframework.datastore.utils;\n \n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MTAyOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545251029", "bodyText": "Swallowing SQLiteConstraintException errors makes sense, but I think we also need to make sure that we do NOT announce a successful merge.\nI think you could do this by doing the announceSuccessfulMerge with andThen, instead of doOnComplete.  That way, it will only happen if there are no errors with the save.\nIt could even make sense to broadcast a new SUBSCRIPTION_DATA_FAILED event if a SQLiteConstraintException is thrown, but I don't think we need that just yet.", "author": "richardmcclellan", "createdAt": "2020-12-17T17:03:09Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -109,6 +111,15 @@\n                 announceSuccessfulMerge(modelWithMetadata);", "originalCommit": "4f411de80067818d2ae317e83766e86ece9bc9fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5MTQ4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545391485", "bodyText": "order matters! since Completable has already encountered error, it has moved onto the Completable that was returned by doOnComplete(). At this stage, the SQLiteConstraintException is caught by .onErrorComplete(), which means that announceSuccessfulMerge() will not be invoked.", "author": "raphkim", "createdAt": "2020-12-17T20:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MTAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5NjI1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545396256", "bodyText": "Thanks for double checking! Rx is hard :)", "author": "richardmcclellan", "createdAt": "2020-12-17T20:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MTAyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "f526504c240ffd1393c510b53920c6b5282f5907", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\nindex dbc19106..e2295eee 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java\n\n@@ -114,7 +114,7 @@ final class Merger {\n             // Remote store may not always respect the foreign key constraint, so\n             // swallow any error caused by foreign key constraint violation.\n             .onErrorComplete(failure -> {\n-                if (!Error.containsCause(failure, SQLiteConstraintException.class)) {\n+                if (!ErrorInspector.contains(failure, SQLiteConstraintException.class)) {\n                     return false;\n                 }\n                 LOG.warn(\"Failed to sync due to foreign key constraint violation: \" + modelWithMetadata, failure);\n"}}, {"oid": "f526504c240ffd1393c510b53920c6b5282f5907", "url": "https://github.com/aws-amplify/amplify-android/commit/f526504c240ffd1393c510b53920c6b5282f5907", "message": "address pr comments and add test", "committedDate": "2020-12-17T20:46:20Z", "type": "commit"}]}