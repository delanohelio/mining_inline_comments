{"pr_number": 713, "pr_title": "Adding SyncType to LastSyncMetadata", "pr_createdAt": "2020-08-10T02:43:36Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/713", "timeline": [{"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "url": "https://github.com/aws-amplify/amplify-android/commit/020f8bd3611c8e469efc77f35e45d45fae7ee05a", "message": "Adding SyncType to LastSyncMetadata", "committedDate": "2020-08-10T02:36:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzE4MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673181", "bodyText": "To cut down on the number of arguments, and since there is already a create(...), how about we replace lastSyncedAt with:\nstatic <T extends Model> LastSyncMetadata baseSyncedAt(@NonNull Class<T> modelClass, long lastBaseSyncTime) {\n    ....\n}\n\nstatic <T extends Model> LastSyncMetadata deltaSyncedAt(@NonNull Class<T> modelClass, long lastDeltaSyncTime) {\n    ....\n}\n\nstatic <T extends Model> LastSyncMetadata neverSynced(@NonNull Class<T> modelClass) {\n    ...\n}", "author": "jamesonwilliams", "createdAt": "2020-08-10T03:28:30Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -53,9 +55,11 @@ private LastSyncMetadata(String id, String modelClassName, Long lastSyncTime) {\n      * @param lastSyncTime Last time it was synced\n      * @return {@link LastSyncMetadata} for the model class\n      */\n-    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass, long lastSyncTime) {\n+    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime,\n+                                                           @NonNull SyncType syncType) {", "originalCommit": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg2MjIwOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467862209", "bodyText": "Good call. Just changed it.", "author": "rjuliano", "createdAt": "2020-08-10T12:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzE4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "32b7de1ca26134a987ab80aec917c841e9d54ab8", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\nindex 95171410..f26021f6 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\n\n@@ -50,16 +50,28 @@ public final class LastSyncMetadata implements Model {\n \n     /**\n      * Creates an instance of an {@link LastSyncMetadata}, indicating that the provided\n-     * model has been sync'd, and that the last sync occurred at the given time.\n+     * model has been base sync'd, and that the last sync occurred at the given time.\n      * @param modelClass Class of model\n      * @param lastSyncTime Last time it was synced\n      * @return {@link LastSyncMetadata} for the model class\n      */\n-    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass,\n-                                                           @Nullable long lastSyncTime,\n-                                                           @NonNull SyncType syncType) {\n+    static <T extends Model> LastSyncMetadata baseSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime) {\n         Objects.requireNonNull(modelClass);\n-        return create(modelClass, lastSyncTime, syncType);\n+        return create(modelClass, lastSyncTime, SyncType.BASE);\n+    }\n+\n+    /**\n+     * Creates an instance of an {@link LastSyncMetadata}, indicating that the provided\n+     * model has been base delta sync'd, and that the last sync occurred at the given time.\n+     * @param modelClass Class of model\n+     * @param lastSyncTime Last time it was synced\n+     * @return {@link LastSyncMetadata} for the model class\n+     */\n+    static <T extends Model> LastSyncMetadata deltaSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime) {\n+        Objects.requireNonNull(modelClass);\n+        return create(modelClass, lastSyncTime, SyncType.DELTA);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzI1Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673252", "bodyText": "Make sure to update equals(), hashCode(), and toString(), as well.", "author": "jamesonwilliams", "createdAt": "2020-08-10T03:29:04Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -38,12 +38,14 @@\n     private final @ModelField(targetType = \"ID\", isRequired = true) String id;\n     private final @ModelField(targetType = \"String\", isRequired = true) String modelClassName;\n     private final @ModelField(targetType = \"AWSTimestamp\", isRequired = true) Long lastSyncTime;\n+    private final @ModelField(targetType = \"String\", isRequired = true) String lastSyncType;", "originalCommit": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MjE2NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467852165", "bodyText": "One of these days, I'll remember doing this. \ud83e\udd23  Just updated it", "author": "rjuliano", "createdAt": "2020-08-10T11:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "32b7de1ca26134a987ab80aec917c841e9d54ab8", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\nindex 95171410..f26021f6 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java\n\n@@ -50,16 +50,28 @@ public final class LastSyncMetadata implements Model {\n \n     /**\n      * Creates an instance of an {@link LastSyncMetadata}, indicating that the provided\n-     * model has been sync'd, and that the last sync occurred at the given time.\n+     * model has been base sync'd, and that the last sync occurred at the given time.\n      * @param modelClass Class of model\n      * @param lastSyncTime Last time it was synced\n      * @return {@link LastSyncMetadata} for the model class\n      */\n-    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass,\n-                                                           @Nullable long lastSyncTime,\n-                                                           @NonNull SyncType syncType) {\n+    static <T extends Model> LastSyncMetadata baseSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime) {\n         Objects.requireNonNull(modelClass);\n-        return create(modelClass, lastSyncTime, syncType);\n+        return create(modelClass, lastSyncTime, SyncType.BASE);\n+    }\n+\n+    /**\n+     * Creates an instance of an {@link LastSyncMetadata}, indicating that the provided\n+     * model has been base delta sync'd, and that the last sync occurred at the given time.\n+     * @param modelClass Class of model\n+     * @param lastSyncTime Last time it was synced\n+     * @return {@link LastSyncMetadata} for the model class\n+     */\n+    static <T extends Model> LastSyncMetadata deltaSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime) {\n+        Objects.requireNonNull(modelClass);\n+        return create(modelClass, lastSyncTime, SyncType.DELTA);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzgxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673817", "bodyText": "Seems like we should just keep the return type from this .map(...) as LastSyncMetadata, here. If you do that, you won't need the AtomicReference. And, you can access the component data in the syncModel(...) call, below, by pulling out getModelClass() and getLastSyncTime().", "author": "jamesonwilliams", "createdAt": "2020-08-10T03:32:17Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -102,8 +103,17 @@ Completable hydrate() {\n \n     private Completable createHydrationTask(\n             ModelWithMetadataComparator modelWithMetadataComparator, Class<? extends Model> modelClass) {\n+        // Default this to BASE since if there is no LastSyncMetadata record for this\n+        // model, a BASE sync will be performed.\n+        AtomicReference<SyncType> syncType = new AtomicReference<>(SyncType.BASE);\n+\n         return syncTimeRegistry.lookupLastSyncTime(modelClass)\n             .map(this::filterOutOldSyncTimes)\n+            .map(lastSyncTime -> {\n+                long syncIntervalMs = dataStoreConfigurationProvider.getConfiguration().getSyncIntervalMs();\n+                syncType.set(SyncType.fromSyncTimeAndThreshold(lastSyncTime, syncIntervalMs));\n+                return lastSyncTime;", "originalCommit": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEwNjY3OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468106678", "bodyText": "I refactored it a bit so we don't need that AtomicReference. Let me know if it makes sense. I did keep the return type of the map as SyncTime because we don't have the storage adapter available to get the LastSyncMetadata record.", "author": "rjuliano", "createdAt": "2020-08-10T18:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "205a7c8da6787a3041d3375c610c141301c7186c", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\nindex 05d190f7..f25d8080 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java\n\n@@ -103,28 +102,25 @@ final class SyncProcessor {\n \n     private Completable createHydrationTask(\n             ModelWithMetadataComparator modelWithMetadataComparator, Class<? extends Model> modelClass) {\n-        // Default this to BASE since if there is no LastSyncMetadata record for this\n-        // model, a BASE sync will be performed.\n-        AtomicReference<SyncType> syncType = new AtomicReference<>(SyncType.BASE);\n-\n         return syncTimeRegistry.lookupLastSyncTime(modelClass)\n             .map(this::filterOutOldSyncTimes)\n-            .map(lastSyncTime -> {\n-                long syncIntervalMs = dataStoreConfigurationProvider.getConfiguration().getSyncIntervalMs();\n-                syncType.set(SyncType.fromSyncTimeAndThreshold(lastSyncTime, syncIntervalMs));\n-                return lastSyncTime;\n-            })\n             // And for each, perform a sync. The network response will contain an Iterable<ModelWithMetadata<T>>\n-            .flatMapCompletable(lastSyncTime -> syncModel(modelClass, lastSyncTime)\n-                // Okay, but we want to flatten the Iterable elements back into an Observable stream.\n-                .flatMapObservable(Observable::fromIterable)\n-                // And sort them all, according to their model's topological order,\n-                // So that when we save them, the references will exist.\n-                .sorted(modelWithMetadataComparator::compare)\n-                // For each ModelWithMetadata, merge it into the local store.\n-                .flatMapCompletable(merger::merge)\n-            )\n-            .andThen(syncTimeRegistry.saveLastSyncTime(modelClass, SyncTime.now(), syncType.get()))\n+            .flatMap(lastSyncTime -> {\n+                return syncModel(modelClass, lastSyncTime)\n+                    // Okay, but we want to flatten the Iterable elements back into an Observable stream.\n+                    .flatMapObservable(Observable::fromIterable)\n+                    // And sort them all, according to their model's topological order,\n+                    // So that when we save them, the references will exist.\n+                    .sorted(modelWithMetadataComparator::compare)\n+                    // For each ModelWithMetadata, merge it into the local store.\n+                    .flatMapCompletable(merger::merge)\n+                    .toSingle(() -> lastSyncTime.exists() ? SyncType.DELTA : SyncType.BASE);\n+            })\n+            .flatMapCompletable(syncType -> {\n+                return SyncType.DELTA.equals(syncType) ?\n+                    syncTimeRegistry.saveLastDeltaSyncTime(modelClass, SyncTime.now()) :\n+                    syncTimeRegistry.saveLastBaseSyncTime(modelClass, SyncTime.now());\n+            })\n             .doOnError(failureToSync -> {\n                 LOG.warn(\"Initial cloud sync failed.\", failureToSync);\n                 DataStoreErrorHandler dataStoreErrorHandler =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzkxMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673913", "bodyText": "Possibly, consider the same saveBaseSyncTime(...) and saveDeltaSyncTime(...) to keep the arg count down? (As with the factories on LastSyncMetadata.)", "author": "jamesonwilliams", "createdAt": "2020-08-10T03:33:06Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java", "diffHunk": "@@ -55,9 +56,11 @@\n         });\n     }\n \n-    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz, SyncTime syncTime) {\n+    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz,", "originalCommit": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEwNzU4NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468107584", "bodyText": "Followed the same pattern here as well.", "author": "rjuliano", "createdAt": "2020-08-10T18:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "32b7de1ca26134a987ab80aec917c841e9d54ab8", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\nindex 55221fd3..73acb3f1 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\n\n@@ -59,9 +59,14 @@ final class SyncTimeRegistry {\n     <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz,\n                                                    @Nullable SyncTime syncTime,\n                                                    @NonNull SyncType syncType) {\n-        LastSyncMetadata metadata = syncTime.exists() ?\n-            LastSyncMetadata.lastSyncedAt(modelClazz, syncTime.toLong(), syncType) :\n-            LastSyncMetadata.neverSynced(modelClazz);\n+        LastSyncMetadata metadata;\n+        if (!syncTime.exists()) {\n+            metadata = LastSyncMetadata.neverSynced(modelClazz);\n+        } else {\n+            metadata = SyncType.BASE.equals(syncType) ?\n+                LastSyncMetadata.baseSyncedAt(modelClazz, syncTime.toLong()) :\n+                LastSyncMetadata.deltaSyncedAt(modelClazz, syncTime.toLong());\n+        }\n \n         return Completable.create(emitter ->\n             localStorageAdapter.save(\n"}}, {"oid": "7ef80ca60316125c6f9551bcf14ef240e098d5ca", "url": "https://github.com/aws-amplify/amplify-android/commit/7ef80ca60316125c6f9551bcf14ef240e098d5ca", "message": "Updating equals, hashCode and toString", "committedDate": "2020-08-10T11:51:50Z", "type": "commit"}, {"oid": "32b7de1ca26134a987ab80aec917c841e9d54ab8", "url": "https://github.com/aws-amplify/amplify-android/commit/32b7de1ca26134a987ab80aec917c841e9d54ab8", "message": "Refactored syncedAt methods", "committedDate": "2020-08-10T12:14:43Z", "type": "commit"}, {"oid": "205a7c8da6787a3041d3375c610c141301c7186c", "url": "https://github.com/aws-amplify/amplify-android/commit/205a7c8da6787a3041d3375c610c141301c7186c", "message": "Addressing PR feedback", "committedDate": "2020-08-10T18:42:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2Njg0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468266840", "bodyText": "Are these two LastSyncMetadata equals()? Should they have the same hashCode()?\n\nPerson.class, null, SyncType.BASE\nPerson.class, null, SyncType.DELTA\n\nMight be an edge case / not super relevant.", "author": "jamesonwilliams", "createdAt": "2020-08-11T01:00:18Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -67,22 +83,23 @@ private LastSyncMetadata(String id, String modelClassName, Long lastSyncTime) {\n      */\n     static <T extends Model> LastSyncMetadata neverSynced(@NonNull Class<T> modelClass) {\n         Objects.requireNonNull(modelClass);\n-        return create(modelClass, null);\n+        return create(modelClass, null, SyncType.BASE);", "originalCommit": "205a7c8da6787a3041d3375c610c141301c7186c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MjczMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468272731", "bodyText": "Interesting...Right now they're treated as not equals, which I think is OK. I ran the following test to verify that:\n        LastSyncMetadata data1 = LastSyncMetadata.create(BlogOwner.class, null, SyncType.BASE);\n        LastSyncMetadata data2 = LastSyncMetadata.create(BlogOwner.class, null, SyncType.DELTA);\n        assertNotEquals(data1, data2);\n        assertNotEquals(data1.hashCode(), data2.hashCode());", "author": "rjuliano", "createdAt": "2020-08-11T01:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2Njg0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2NzE2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468267164", "bodyText": "nit: alignment -- i'd either align arg, or wrap and +8 indent from method head", "author": "jamesonwilliams", "createdAt": "2020-08-11T01:01:35Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java", "diffHunk": "@@ -55,9 +56,26 @@\n         });\n     }\n \n-    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz, SyncTime syncTime) {\n+    <T extends Model> Completable saveLastDeltaSyncTime(@NonNull Class<T> modelClazz,\n+                                                   @Nullable SyncTime syncTime) {", "originalCommit": "205a7c8da6787a3041d3375c610c141301c7186c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MzA5MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468273091", "bodyText": "Ugh...that's ugly. Just fixed it.", "author": "rjuliano", "createdAt": "2020-08-11T01:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2NzE2NA=="}], "type": "inlineReview", "revised_code": {"commit": "5075edcb76c693faa6a4f052635bfea1332884dc", "chunk": "diff --git a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\nindex d3f7f736..02ec916a 100644\n--- a/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\n+++ b/aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java\n\n@@ -57,7 +57,7 @@ final class SyncTimeRegistry {\n     }\n \n     <T extends Model> Completable saveLastDeltaSyncTime(@NonNull Class<T> modelClazz,\n-                                                   @Nullable SyncTime syncTime) {\n+                                                        @Nullable SyncTime syncTime) {\n         LastSyncMetadata metadata = syncTime.exists() ?\n             LastSyncMetadata.deltaSyncedAt(modelClazz, syncTime.toLong()) :\n             LastSyncMetadata.neverSynced(modelClazz);\n"}}, {"oid": "5075edcb76c693faa6a4f052635bfea1332884dc", "url": "https://github.com/aws-amplify/amplify-android/commit/5075edcb76c693faa6a4f052635bfea1332884dc", "message": "Fixed alignment", "committedDate": "2020-08-11T01:22:44Z", "type": "commit"}]}