{"pr_number": 221, "pr_title": "Add gRPC backoff resetter", "pr_createdAt": "2020-09-25T00:52:44Z", "pr_url": "https://github.com/temporalio/sdk-java/pull/221", "timeline": [{"oid": "a2ac4b4c0c7bd6400989674eb490b92e79021704", "url": "https://github.com/temporalio/sdk-java/commit/a2ac4b4c0c7bd6400989674eb490b92e79021704", "message": "Add gRPC backoff resetter", "committedDate": "2020-09-24T23:36:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5Mjc1OQ==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494692759", "bodyText": "Add that it can return null if reset is off", "author": "mfateev", "createdAt": "2020-09-25T01:13:00Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java", "diffHunk": "@@ -174,6 +181,11 @@ public Duration getRpcQueryTimeout() {\n     return rpcQueryTimeout;\n   }\n \n+  /** @return frequency at which connection backoff should be reset. */", "originalCommit": "a2ac4b4c0c7bd6400989674eb490b92e79021704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTcyNg==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494715726", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-09-25T02:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5Mjc1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "734a6210cf1620e81a1d511dda94cff839339b4c", "chunk": "diff --git a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\nindex ac33e31b..db429878 100644\n--- a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\n+++ b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\n\n@@ -181,7 +181,8 @@ public class WorkflowServiceStubsOptions {\n     return rpcQueryTimeout;\n   }\n \n-  /** @return frequency at which connection backoff should be reset. */\n+  /** @return frequency at which connection backoff should be reset or\n+   * null if backoff reset is disabled. */\n   public Duration getConnectionBackoffResetFrequency() {\n     return connectionBackoffResetFrequency;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5MzEzOQ==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494693139", "bodyText": "forgot setter for this property", "author": "mfateev", "createdAt": "2020-09-25T01:14:39Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java", "diffHunk": "@@ -211,6 +223,7 @@ public Scope getMetricsScope() {\n     private Duration rpcTimeout = DEFAULT_RPC_TIMEOUT;\n     private Duration rpcLongPollTimeout = DEFAULT_POLL_RPC_TIMEOUT;\n     private Duration rpcQueryTimeout = DEFAULT_QUERY_RPC_TIMEOUT;\n+    private Duration connectionBackoffResetFrequency = DEFAULT_CONNECTION_BACKOFF_RESET_FREQUENCY;", "originalCommit": "a2ac4b4c0c7bd6400989674eb490b92e79021704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTY2OA==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494715668", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-09-25T02:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5MzEzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5Mzc2MA==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494693760", "bodyText": "Change parameter type to Duration and use milliseconds when initializing executor.", "author": "mfateev", "createdAt": "2020-09-25T01:17:08Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java", "diffHunk": "@@ -151,6 +164,23 @@ public WorkflowServiceStubsImpl(\n     log.info(String.format(\"Created GRPC client for channel: %s\", channel));\n   }\n \n+  private ScheduledExecutorService startConnectionBackoffResetter(long backoffResetFrequency) {", "originalCommit": "a2ac4b4c0c7bd6400989674eb490b92e79021704", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTY0NA==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494715644", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-09-25T02:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5Mzc2MA=="}], "type": "inlineReview", "revised_code": {"commit": "734a6210cf1620e81a1d511dda94cff839339b4c", "chunk": "diff --git a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\nindex 1ca2d500..d08a06e3 100644\n--- a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n+++ b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n\n@@ -164,7 +164,7 @@ public final class WorkflowServiceStubsImpl implements WorkflowServiceStubs {\n     log.info(String.format(\"Created GRPC client for channel: %s\", channel));\n   }\n \n-  private ScheduledExecutorService startConnectionBackoffResetter(long backoffResetFrequency) {\n+  private ScheduledExecutorService startConnectionBackoffResetter(Duration backoffResetFrequency) {\n     ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();\n     executor.scheduleWithFixedDelay(\n         () -> {\n"}}, {"oid": "734a6210cf1620e81a1d511dda94cff839339b4c", "url": "https://github.com/temporalio/sdk-java/commit/734a6210cf1620e81a1d511dda94cff839339b4c", "message": "CR updates", "committedDate": "2020-09-25T02:46:31Z", "type": "commit"}, {"oid": "05b7944f29a5153e529cbee370ad771a3dc7803a", "url": "https://github.com/temporalio/sdk-java/commit/05b7944f29a5153e529cbee370ad771a3dc7803a", "message": "formatting", "committedDate": "2020-09-25T02:47:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNzAyMw==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494717023", "bodyText": "Document default and explain that setting it to null disables the reset.", "author": "mfateev", "createdAt": "2020-09-25T02:49:26Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java", "diffHunk": "@@ -290,6 +307,16 @@ public Builder setRpcLongPollTimeout(Duration timeout) {\n       return this;\n     }\n \n+    /**\n+     * Sets frequency at which gRPC connection backoff should be reset practically defining an upper\n+     * limit for the maximum backoff duration.", "originalCommit": "05b7944f29a5153e529cbee370ad771a3dc7803a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMzgyMg==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494723822", "bodyText": "Updated", "author": "vitarb", "createdAt": "2020-09-25T03:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNzAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "f92e0ffb8cfe85c559290cca7fe1ab36bc36cbda", "chunk": "diff --git a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\nindex 68866616..48ae4328 100644\n--- a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\n+++ b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsOptions.java\n\n@@ -310,7 +310,8 @@ public class WorkflowServiceStubsOptions {\n     /**\n      * Sets frequency at which gRPC connection backoff should be reset practically defining an upper\n      * limit for the maximum backoff duration.\n-     *\n+     * If set to null then no backoff reset will be performed and we'll rely on default gRPC\n+     * backoff behavior defined in ExponentialBackoffPolicy.\n      * @param connectionBackoffResetFrequency frequency.\n      */\n     public void setConnectionBackoffResetFrequency(Duration connectionBackoffResetFrequency) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTg3Ng==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494719876", "bodyText": "nit:\nreturn Executors.new....", "author": "mfateev", "createdAt": "2020-09-25T03:00:18Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java", "diffHunk": "@@ -151,6 +164,23 @@ public WorkflowServiceStubsImpl(\n     log.info(String.format(\"Created GRPC client for channel: %s\", channel));\n   }\n \n+  private ScheduledExecutorService startConnectionBackoffResetter(Duration backoffResetFrequency) {\n+    ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();", "originalCommit": "05b7944f29a5153e529cbee370ad771a3dc7803a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMzk1Mw==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494723953", "bodyText": "We submit a task below, so this will not be possible...", "author": "vitarb", "createdAt": "2020-09-25T03:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f92e0ffb8cfe85c559290cca7fe1ab36bc36cbda", "chunk": "diff --git a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\nindex d08a06e3..ff324dc2 100644\n--- a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n+++ b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n\n@@ -166,6 +168,7 @@ public final class WorkflowServiceStubsImpl implements WorkflowServiceStubs {\n \n   private ScheduledExecutorService startConnectionBackoffResetter(Duration backoffResetFrequency) {\n     ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();\n+\n     executor.scheduleWithFixedDelay(\n         () -> {\n           try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMDE0OA==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494720148", "bodyText": "private final", "author": "mfateev", "createdAt": "2020-09-25T03:01:09Z", "path": "temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java", "diffHunk": "@@ -65,6 +68,7 @@\n   private final WorkflowServiceGrpc.WorkflowServiceBlockingStub blockingStub;\n   private final WorkflowServiceGrpc.WorkflowServiceFutureStub futureStub;\n   private final Server inProcessServer;\n+  private ScheduledExecutorService scheduledBackoffResetter;", "originalCommit": "05b7944f29a5153e529cbee370ad771a3dc7803a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMzk3Nw==", "url": "https://github.com/temporalio/sdk-java/pull/221#discussion_r494723977", "bodyText": "Done", "author": "vitarb", "createdAt": "2020-09-25T03:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMDE0OA=="}], "type": "inlineReview", "revised_code": {"commit": "f92e0ffb8cfe85c559290cca7fe1ab36bc36cbda", "chunk": "diff --git a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\nindex d08a06e3..ff324dc2 100644\n--- a/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n+++ b/temporal-serviceclient/src/main/java/io/temporal/serviceclient/WorkflowServiceStubsImpl.java\n\n@@ -68,7 +68,7 @@ public final class WorkflowServiceStubsImpl implements WorkflowServiceStubs {\n   private final WorkflowServiceGrpc.WorkflowServiceBlockingStub blockingStub;\n   private final WorkflowServiceGrpc.WorkflowServiceFutureStub futureStub;\n   private final Server inProcessServer;\n-  private ScheduledExecutorService scheduledBackoffResetter;\n+  private final ScheduledExecutorService scheduledBackoffResetter;\n \n   /**\n    * Creates a factory that connects to the Temporal according to the specified options. When\n"}}, {"oid": "f92e0ffb8cfe85c559290cca7fe1ab36bc36cbda", "url": "https://github.com/temporalio/sdk-java/commit/f92e0ffb8cfe85c559290cca7fe1ab36bc36cbda", "message": "addressingCR feedback", "committedDate": "2020-09-25T03:16:25Z", "type": "commit"}, {"oid": "0922ad997d8473a5c1f68b6bdcec30613dbcc667", "url": "https://github.com/temporalio/sdk-java/commit/0922ad997d8473a5c1f68b6bdcec30613dbcc667", "message": "formatting", "committedDate": "2020-09-25T03:18:29Z", "type": "commit"}, {"oid": "0185321365022c6498d8868b0f54aae3925b705c", "url": "https://github.com/temporalio/sdk-java/commit/0185321365022c6498d8868b0f54aae3925b705c", "message": "return builder", "committedDate": "2020-09-25T03:35:39Z", "type": "commit"}]}