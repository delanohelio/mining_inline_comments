{"pr_number": 289, "pr_title": "Dynamic workflow and activity implementation support", "pr_createdAt": "2020-12-26T00:40:22Z", "pr_url": "https://github.com/temporalio/sdk-java/pull/289", "timeline": [{"oid": "0605b0dfba4cc29a0e16f0e55803424e38b8d545", "url": "https://github.com/temporalio/sdk-java/commit/0605b0dfba4cc29a0e16f0e55803424e38b8d545", "message": "Added UntypedWorkflow. Renamed add to register", "committedDate": "2020-12-24T02:18:11Z", "type": "commit"}, {"oid": "abbb6991c6982199cda84221ea0a2f6e45eed3e1", "url": "https://github.com/temporalio/sdk-java/commit/abbb6991c6982199cda84221ea0a2f6e45eed3e1", "message": "Fixed UntypedWorkflowTest", "committedDate": "2020-12-24T04:40:21Z", "type": "commit"}, {"oid": "fa71694cf4fd9078f0c7f862dc9c4349b93e3185", "url": "https://github.com/temporalio/sdk-java/commit/fa71694cf4fd9078f0c7f862dc9c4349b93e3185", "message": "Added UntypedSignalHandler", "committedDate": "2020-12-24T05:42:50Z", "type": "commit"}, {"oid": "48efb6d0522d62e90a241d90d55f0eaa03d4557f", "url": "https://github.com/temporalio/sdk-java/commit/48efb6d0522d62e90a241d90d55f0eaa03d4557f", "message": "Changed UpdatedWorkflow to EncodedValues", "committedDate": "2020-12-24T17:50:11Z", "type": "commit"}, {"oid": "7775d6eeeb8c074f5fdbe2ba2a6046db05f9f67e", "url": "https://github.com/temporalio/sdk-java/commit/7775d6eeeb8c074f5fdbe2ba2a6046db05f9f67e", "message": "Switched untyped handlers to EncodedValues", "committedDate": "2020-12-24T20:59:51Z", "type": "commit"}, {"oid": "953c16cb518d652b789d04fdebc450e7b6b6eb60", "url": "https://github.com/temporalio/sdk-java/commit/953c16cb518d652b789d04fdebc450e7b6b6eb60", "message": "Added support for UntypedWorkflow factory", "committedDate": "2020-12-25T21:08:17Z", "type": "commit"}, {"oid": "798167e3495ee93d0c0e8887bd0589ea88a45c5c", "url": "https://github.com/temporalio/sdk-java/commit/798167e3495ee93d0c0e8887bd0589ea88a45c5c", "message": "Added UntypedActivityHandler", "committedDate": "2020-12-25T22:47:44Z", "type": "commit"}, {"oid": "f7000c6f9efe9374f4dfc38d022e759184b5a662", "url": "https://github.com/temporalio/sdk-java/commit/f7000c6f9efe9374f4dfc38d022e759184b5a662", "message": "Renamed untyped to dynamic", "committedDate": "2020-12-25T23:04:47Z", "type": "commit"}, {"oid": "7abd413904e99d3ade453b3465d7395b43bab022", "url": "https://github.com/temporalio/sdk-java/commit/7abd413904e99d3ade453b3465d7395b43bab022", "message": "Documentation added", "committedDate": "2020-12-25T23:52:04Z", "type": "commit"}, {"oid": "28dfbe30c6b804b1f8c7dc7186f2a75dbcd8ac64", "url": "https://github.com/temporalio/sdk-java/commit/28dfbe30c6b804b1f8c7dc7186f2a75dbcd8ac64", "message": "Self review fixes", "committedDate": "2020-12-26T00:37:46Z", "type": "commit"}, {"oid": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "url": "https://github.com/temporalio/sdk-java/commit/7cbe996e4f51482a2e5c3080b993b5b460fd47da", "message": "Added dynamic local activity invocation test", "committedDate": "2020-12-26T19:22:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQzNjAxNA==", "url": "https://github.com/temporalio/sdk-java/pull/289#discussion_r549436014", "bodyText": "One sentence example might be useful", "author": "Sushisource", "createdAt": "2020-12-28T18:06:45Z", "path": "temporal-sdk/src/main/java/io/temporal/activity/DynamicActivity.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.activity;\n+\n+import io.temporal.common.converter.EncodedValues;\n+\n+/**\n+ * Use DynamicActivity to implement any number of activity types dynamically. When an activity\n+ * implementation that extends DynamicActivity is registered it is called for any activity type\n+ * invocation that doesn't have an explicitly registered handler. Only one instance that implements\n+ * DynamicActivity per {@link io.temporal.worker.Worker} is allowed.\n+ *\n+ * <p>The DynamicActivity can be useful for integrations with existing libraries.", "originalCommit": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64e8476c08c47db334c56076e235d8af6975fd88", "chunk": "diff --git a/temporal-sdk/src/main/java/io/temporal/activity/DynamicActivity.java b/temporal-sdk/src/main/java/io/temporal/activity/DynamicActivity.java\nindex 6bfe2e0e..960bf434 100644\n--- a/temporal-sdk/src/main/java/io/temporal/activity/DynamicActivity.java\n+++ b/temporal-sdk/src/main/java/io/temporal/activity/DynamicActivity.java\n\n@@ -27,7 +27,8 @@ import io.temporal.common.converter.EncodedValues;\n  * invocation that doesn't have an explicitly registered handler. Only one instance that implements\n  * DynamicActivity per {@link io.temporal.worker.Worker} is allowed.\n  *\n- * <p>The DynamicActivity can be useful for integrations with existing libraries.\n+ * <p>The DynamicActivity can be useful for integrations with existing libraries. For example it can\n+ * be used to call some external HTTP API with each function exposed as a different activity type.\n  *\n  * <p>Use {@link Activity#getExecutionContext()} to query information about the activity type that\n  * should be implemented dynamically.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQzNzU1OQ==", "url": "https://github.com/temporalio/sdk-java/pull/289#discussion_r549437559", "bodyText": "Would be good to indicate workers can only have one DynamicActivity implementation in a docstring somewhere", "author": "Sushisource", "createdAt": "2020-12-28T18:12:38Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java", "diffHunk": "@@ -83,11 +86,19 @@\n     this.interceptors = Objects.requireNonNull(interceptors);\n   }\n \n-  private void addActivityImplementation(\n+  private void registerActivityImplementation(\n       Object activity, BiFunction<Method, Object, ActivityTaskExecutor> newTaskExecutor) {\n     if (activity instanceof Class) {\n       throw new IllegalArgumentException(\"Activity object instance expected, not the class\");\n     }\n+    if (activity instanceof DynamicActivity) {\n+      if (dynamicActivity != null) {\n+        throw new IllegalStateException(\n+            \"An implementation of DynamicActivity is already registered with the worker\");\n+      }", "originalCommit": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQzODQyNA==", "url": "https://github.com/temporalio/sdk-java/pull/289#discussion_r549438424", "bodyText": "Quite a lot of the code in here is quite similar to the above POJOActivityImplementation -- would be nice to dedupe as reasonable.", "author": "Sushisource", "createdAt": "2020-12-28T18:15:46Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java", "diffHunk": "@@ -287,6 +301,96 @@ public Object execute(Object[] arguments) {\n     }\n   }\n \n+  private class DynamicActivityImplementation implements ActivityTaskExecutor {\n+\n+    private final DynamicActivity activity;\n+\n+    public DynamicActivityImplementation(DynamicActivity activity) {\n+      this.activity = activity;\n+    }\n+\n+    @Override\n+    public ActivityTaskHandler.Result execute(ActivityInfoImpl info, Scope metricsScope) {", "originalCommit": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b1d46e48230f109bc87dff459d506dfbf95b9524", "chunk": "diff --git a/temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java b/temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java\nindex b28cc68c..2bbb82a9 100644\n--- a/temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java\n+++ b/temporal-sdk/src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java\n\n@@ -336,30 +313,34 @@ final class POJOActivityTaskHandler implements ActivityTaskHandler {\n         return new ActivityTaskHandler.Result(\n             info.getActivityId(), request.build(), null, null, null);\n       } catch (Throwable e) {\n-        e = CheckedExceptionWrapper.unwrap(e);\n-        if (e instanceof ActivityCanceledException) {\n-          if (log.isInfoEnabled()) {\n-            log.info(\n-                \"Activity canceled. ActivityId=\"\n-                    + info.getActivityId()\n-                    + \", activityType=\"\n-                    + info.getActivityType()\n-                    + \", attempt=\"\n-                    + info.getAttempt());\n-          }\n-        } else if (log.isWarnEnabled()) {\n-          log.warn(\n-              \"Activity failure. ActivityId=\"\n-                  + info.getActivityId()\n-                  + \", activityType=\"\n-                  + info.getActivityType()\n-                  + \", attempt=\"\n-                  + info.getAttempt(),\n-              e);\n-        }\n-        return mapToActivityFailure(e, info.getActivityId(), metricsScope, false);\n+        return activityFailureToResult(info, metricsScope, e);\n+      }\n+    }\n+  }\n+\n+  private Result activityFailureToResult(ActivityInfoImpl info, Scope metricsScope, Throwable e) {\n+    e = CheckedExceptionWrapper.unwrap(e);\n+    if (e instanceof ActivityCanceledException) {\n+      if (log.isInfoEnabled()) {\n+        log.info(\n+            \"Activity canceled. ActivityId=\"\n+                + info.getActivityId()\n+                + \", activityType=\"\n+                + info.getActivityType()\n+                + \", attempt=\"\n+                + info.getAttempt());\n       }\n+    } else if (log.isWarnEnabled()) {\n+      log.warn(\n+          \"Activity failure. ActivityId=\"\n+              + info.getActivityId()\n+              + \", activityType=\"\n+              + info.getActivityType()\n+              + \", attempt=\"\n+              + info.getAttempt(),\n+          e);\n     }\n+    return mapToActivityFailure(e, info.getActivityId(), metricsScope, false);\n   }\n \n   private static class DynamicActivityInboundCallsInterceptor\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQzODc5Mg==", "url": "https://github.com/temporalio/sdk-java/pull/289#discussion_r549438792", "bodyText": "Same as other comment - would be nice to expose this restriction to user in docstring.", "author": "Sushisource", "createdAt": "2020-12-28T18:17:00Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/sync/POJOWorkflowImplementationFactory.java", "diffHunk": "@@ -94,23 +97,33 @@\n     this.contextPropagators = contextPropagators;\n   }\n \n-  void addWorkflowImplementationTypes(\n+  void registerWorkflowImplementationTypes(\n       WorkflowImplementationOptions options, Class<?>[] workflowImplementationTypes) {\n     for (Class<?> type : workflowImplementationTypes) {\n-      addWorkflowImplementationType(options, type);\n+      registerWorkflowImplementationType(options, type);\n     }\n   }\n \n   <R> void addWorkflowImplementationFactory(Class<R> clazz, Functions.Func<R> factory) {\n+    @SuppressWarnings(\"unchecked\")\n     WorkflowImplementationOptions unitTestingOptions =\n         WorkflowImplementationOptions.newBuilder()\n             .setFailWorkflowExceptionTypes(Throwable.class)\n             .build();\n     addWorkflowImplementationFactory(unitTestingOptions, clazz, factory);\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n   <R> void addWorkflowImplementationFactory(\n       WorkflowImplementationOptions options, Class<R> clazz, Functions.Func<R> factory) {\n+    if (DynamicWorkflow.class.isAssignableFrom(clazz)) {\n+      if (dynamicWorkflowImplementationFactory != null) {\n+        throw new IllegalStateException(\n+            \"An implementation of DynamicWorkflow or its factory is already registered with the worker\");", "originalCommit": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0MzA0OA==", "url": "https://github.com/temporalio/sdk-java/pull/289#discussion_r549443048", "bodyText": "Presumably it's necessary for the dynamic workflow to always be deterministic in the same way that normal workflows are, right? IE: Deterministic w.r.t. EncodedValues. Might be worth making reference to that here just so users don't think magically that requirement has gone away.", "author": "Sushisource", "createdAt": "2020-12-28T18:23:36Z", "path": "temporal-sdk/src/main/java/io/temporal/workflow/DynamicWorkflow.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ *  Copyright (C) 2020 Temporal Technologies, Inc. All Rights Reserved.\n+ *\n+ *  Copyright 2012-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Modifications copyright (C) 2017 Uber Technologies, Inc.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\"). You may not\n+ *  use this file except in compliance with the License. A copy of the License is\n+ *  located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed on\n+ *  an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package io.temporal.workflow;\n+\n+import io.temporal.common.converter.EncodedValues;\n+\n+/**\n+ * Use DynamicWorkflow to implement any number of workflow types dynamically. When a workflow\n+ * implementation type that extends DynamicWorkflow is registered, it is used to implement any\n+ * workflow type that is not implicitly registered with the {@link io.temporal.worker.Worker}. Only\n+ * one type that implements DynamicWorkflow per worker is allowed.\n+ *\n+ * <p>The main use case for DynamicWorkflow is an implementation of custom Domain Specific Languages\n+ * (DSLs). A single implementation can implement a workflow type which definition is dynamically\n+ * loaded from some external source.\n+ *", "originalCommit": "7cbe996e4f51482a2e5c3080b993b5b460fd47da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64e8476c08c47db334c56076e235d8af6975fd88", "chunk": "diff --git a/temporal-sdk/src/main/java/io/temporal/workflow/DynamicWorkflow.java b/temporal-sdk/src/main/java/io/temporal/workflow/DynamicWorkflow.java\nindex 822d0d7a..10351531 100644\n--- a/temporal-sdk/src/main/java/io/temporal/workflow/DynamicWorkflow.java\n+++ b/temporal-sdk/src/main/java/io/temporal/workflow/DynamicWorkflow.java\n\n@@ -38,6 +38,8 @@ import io.temporal.common.converter.EncodedValues;\n  * using {@link DynamicSignalHandler} and {@link DynamicQueryHandler} to implement handlers that can\n  * support any signal or query type dynamically.\n  *\n+ * <p>All the determinism rules still apply to workflows that implement this interface.\n+ *\n  * @see io.temporal.activity.DynamicActivity\n  */\n public interface DynamicWorkflow {\n"}}, {"oid": "64e8476c08c47db334c56076e235d8af6975fd88", "url": "https://github.com/temporalio/sdk-java/commit/64e8476c08c47db334c56076e235d8af6975fd88", "message": "updated comments", "committedDate": "2020-12-29T03:38:28Z", "type": "commit"}, {"oid": "b1d46e48230f109bc87dff459d506dfbf95b9524", "url": "https://github.com/temporalio/sdk-java/commit/b1d46e48230f109bc87dff459d506dfbf95b9524", "message": "Eliminated some duplicated code", "committedDate": "2020-12-29T03:47:16Z", "type": "commit"}]}