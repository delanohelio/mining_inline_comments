{"pr_number": 219, "pr_title": "Verify that next page is not empty in the history iterator", "pr_createdAt": "2020-09-23T04:36:04Z", "pr_url": "https://github.com/temporalio/sdk-java/pull/219", "timeline": [{"oid": "33e4d01d197bcca1bd19580856584cee414767f4", "url": "https://github.com/temporalio/sdk-java/commit/33e4d01d197bcca1bd19580856584cee414767f4", "message": "Verify that next page is not empty in the history iterator", "committedDate": "2020-09-23T04:42:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5NDM2Nw==", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493194367", "bodyText": "I think you can avoid this call here if line 111 calls this.hasNext", "author": "mfateev", "createdAt": "2020-09-23T04:46:05Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java", "diffHunk": "@@ -77,6 +112,24 @@ public HistoryEvent next() {\n       return current.next();\n     }\n \n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory(", "originalCommit": "33e4d01d197bcca1bd19580856584cee414767f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIyNzE4OQ==", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493227189", "bodyText": "That call is to current.hasNext() (not this.hasNext()), which is just cached history.\nWe should make a server call if current is empty and page token is available.\nThis would make it possible to safely call it.next() without calling it.hasNext() first.\nThat being said I've updated implementation, added tests and verified that it's working in bench, please take a look", "author": "vitarb", "createdAt": "2020-09-23T06:28:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5NDM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b845eff787e131007414996e8e373e7baba7aaf8", "chunk": "diff --git a/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java b/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\nindex c7357a45..ee6474b7 100644\n--- a/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\n+++ b/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\n\n@@ -112,24 +97,14 @@ class WorkflowHistoryIterator implements Iterator<HistoryEvent> {\n       return current.next();\n     }\n \n-    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory(\n-        GetWorkflowExecutionHistoryRequest.newBuilder()\n-            .setNamespace(namespace)\n-            .setExecution(task.getWorkflowExecution())\n-            .setNextPageToken(nextPageToken)\n-            .build());\n-\n-    current = response.getHistory().getEventsList().iterator();\n-    nextPageToken = response.getNextPageToken();\n+    current = nextResponse.getHistory().getEventsList().iterator();\n+    nextPageToken = nextResponse.getNextPageToken();\n \n     return current.next();\n   }\n \n   private GetWorkflowExecutionHistoryResponse queryWorkflowExecutionHistory(\n       GetWorkflowExecutionHistoryRequest request) {\n-    if (cachedResponse != null && request.equals(cachedResponse.request)) {\n-      return cachedResponse.response;\n-    }\n     Duration passed = Duration.ofMillis(System.currentTimeMillis()).minus(paginationStart);\n     Duration expiration = workflowTaskTimeout.minus(passed);\n     if (expiration.isZero() || expiration.isNegative()) {\n"}}, {"oid": "b845eff787e131007414996e8e373e7baba7aaf8", "url": "https://github.com/temporalio/sdk-java/commit/b845eff787e131007414996e8e373e7baba7aaf8", "message": "Verify that next page is not empty in the history iterator", "committedDate": "2020-09-23T04:53:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1NTY5Mg==", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493855692", "bodyText": "I don't think it is correct. As it is still going to blow up with the response contains an empty history and hasNext is not called from outside.\nMy proposal is to change the line 94 to:\nif (this.hasNext()) {\n   return current.next();\n}\nand ensure that hasNext either caches non empty events in current or returns false.", "author": "mfateev", "createdAt": "2020-09-23T19:51:46Z", "path": "temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java", "diffHunk": "@@ -66,17 +66,44 @@\n     nextPageToken = task.getNextPageToken();\n   }\n \n+  // Returns true if more history events are available.\n+  // Server can return page tokens that point to empty pages.\n+  // We need to verify that page is valid before returning true.\n+  // Otherwise next() method would throw NoSuchElementException after hasNext() returning true.\n   @Override\n   public boolean hasNext() {\n-    return current.hasNext() || !nextPageToken.isEmpty();\n+    if (current.hasNext()) {\n+      return true;\n+    }\n+    if (nextPageToken.isEmpty()) {\n+      return false;\n+    }\n+\n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory();\n+\n+    current = response.getHistory().getEventsList().iterator();\n+    nextPageToken = response.getNextPageToken();\n+\n+    return current.hasNext();\n   }\n \n   @Override\n   public HistoryEvent next() {\n-    if (current.hasNext()) {\n+    // If current has next element then simply return it, otherwise check if we have next page token\n+    // If no page token available then we should call next() which throws NoSuchElementException.\n+    if (current.hasNext() || nextPageToken.isEmpty()) {\n       return current.next();\n     }\n \n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory();", "originalCommit": "9e97f80f5a4f8a0172329fa2c1edb415858dbfc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MDM3OA==", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493870378", "bodyText": "Simplified the code a bit, but kept behavior same.", "author": "vitarb", "createdAt": "2020-09-23T20:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1NTY5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fd1134daee974dcb68f26a43f859e324d7c26c4b", "chunk": "diff --git a/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java b/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\nindex 421ec90d..a8bf7bec 100644\n--- a/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\n+++ b/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java\n\n@@ -89,18 +90,10 @@ class WorkflowHistoryIterator implements Iterator<HistoryEvent> {\n \n   @Override\n   public HistoryEvent next() {\n-    // If current has next element then simply return it, otherwise check if we have next page token\n-    // If no page token available then we should call next() which throws NoSuchElementException.\n-    if (current.hasNext() || nextPageToken.isEmpty()) {\n+    if (hasNext()) {\n       return current.next();\n     }\n-\n-    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory();\n-\n-    current = response.getHistory().getEventsList().iterator();\n-    nextPageToken = response.getNextPageToken();\n-\n-    return current.next();\n+    throw new NoSuchElementException();\n   }\n \n   GetWorkflowExecutionHistoryResponse queryWorkflowExecutionHistory() {\n"}}, {"oid": "fd1134daee974dcb68f26a43f859e324d7c26c4b", "url": "https://github.com/temporalio/sdk-java/commit/fd1134daee974dcb68f26a43f859e324d7c26c4b", "message": "Verify that next page is not empty in the history iterator", "committedDate": "2020-09-23T20:16:24Z", "type": "commit"}, {"oid": "fd1134daee974dcb68f26a43f859e324d7c26c4b", "url": "https://github.com/temporalio/sdk-java/commit/fd1134daee974dcb68f26a43f859e324d7c26c4b", "message": "Verify that next page is not empty in the history iterator", "committedDate": "2020-09-23T20:16:24Z", "type": "forcePushed"}, {"oid": "66aa6afaf41944dd020d1f96a0b25b8f03c871d0", "url": "https://github.com/temporalio/sdk-java/commit/66aa6afaf41944dd020d1f96a0b25b8f03c871d0", "message": "remove test service from the test", "committedDate": "2020-09-23T20:22:50Z", "type": "commit"}, {"oid": "f859e575f04eb11af1d49c99ad3306984076e1a2", "url": "https://github.com/temporalio/sdk-java/commit/f859e575f04eb11af1d49c99ad3306984076e1a2", "message": "Improve test scenario to process an empty page", "committedDate": "2020-09-23T20:38:32Z", "type": "commit"}, {"oid": "7c0784496f75732a7e1d830d118f6f114a810259", "url": "https://github.com/temporalio/sdk-java/commit/7c0784496f75732a7e1d830d118f6f114a810259", "message": "update comment", "committedDate": "2020-09-23T20:40:42Z", "type": "commit"}]}