{"pr_number": 3142, "pr_title": "NMS-12889: Fix duplicated key for multi-app services", "pr_createdAt": "2020-09-03T10:40:47Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3142", "timeline": [{"oid": "869fdf17fa2ac7c45530133b5ca979d99b305fe6", "url": "https://github.com/OpenNMS/opennms/commit/869fdf17fa2ac7c45530133b5ca979d99b305fe6", "message": "NMS-12889: Fix duplicated key for multi-app services", "committedDate": "2020-09-03T10:39:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNjMwNA==", "url": "https://github.com/OpenNMS/opennms/pull/3142#discussion_r482906304", "bodyText": "Just to be sure to cover all cases - can you add additional tests for:\n\napplication with services and without locations\napplication with locations and without services", "author": "christianpape", "createdAt": "2020-09-03T11:27:56Z", "path": "features/perspectivepoller/src/test/java/org/opennms/netmgt/perspectivepoller/PerspectivePollerdIT.java", "diffHunk": "@@ -598,6 +615,46 @@ public void testPerspectivePollerThresholding() throws Exception {\n         this.eventIpcManager.getEventAnticipator().verifyAnticipated();\n     }\n \n+    @Test\n+    public void testStartWithEmptyApp() throws Exception {\n+        this.databasePopulator.getTransactionTemplate().execute(tx -> {\n+            final OnmsApplication app = new OnmsApplication();\n+            app.setName(\"App Empty\");\n+            this.databasePopulator.getApplicationDao().save(app);\n+\n+            return null;\n+        });\n+\n+        this.perspectivePollerd.start();\n+    }\n+\n+    @Test\n+    public void testStartWithDuplicatedService() throws Exception {", "originalCommit": "869fdf17fa2ac7c45530133b5ca979d99b305fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkxMDIzOQ==", "url": "https://github.com/OpenNMS/opennms/pull/3142#discussion_r482910239", "bodyText": "Good point. Done.", "author": "fooker", "createdAt": "2020-09-03T11:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNjMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkxNDM2Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3142#discussion_r482914367", "bodyText": "Perfect.", "author": "christianpape", "createdAt": "2020-09-03T11:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNjMwNA=="}], "type": "inlineReview", "revised_code": {"commit": "cff631dd6221fd6ee7e1a05600a0ff678db27dc0", "chunk": "diff --git a/features/perspectivepoller/src/test/java/org/opennms/netmgt/perspectivepoller/PerspectivePollerdIT.java b/features/perspectivepoller/src/test/java/org/opennms/netmgt/perspectivepoller/PerspectivePollerdIT.java\nindex 6746a4a6631..c54a01d172f 100644\n--- a/features/perspectivepoller/src/test/java/org/opennms/netmgt/perspectivepoller/PerspectivePollerdIT.java\n+++ b/features/perspectivepoller/src/test/java/org/opennms/netmgt/perspectivepoller/PerspectivePollerdIT.java\n\n@@ -628,6 +628,37 @@ public class PerspectivePollerdIT implements InitializingBean, TemporaryDatabase\n         this.perspectivePollerd.start();\n     }\n \n+    @Test\n+    public void testStartWithLocationOnlyApp() throws Exception {\n+        this.databasePopulator.getTransactionTemplate().execute(tx -> {\n+            final OnmsApplication app = new OnmsApplication();\n+            app.setName(\"App Empty\");\n+            app.addPerspectiveLocation(this.databasePopulator.getLocRDU());\n+            this.databasePopulator.getApplicationDao().save(app);\n+\n+            return null;\n+        });\n+\n+        this.perspectivePollerd.start();\n+    }\n+\n+    @Test\n+    public void testStartWithServiceOnlyApp() throws Exception {\n+        this.databasePopulator.getTransactionTemplate().execute(tx -> {\n+            final OnmsApplication app = new OnmsApplication();\n+            app.setName(\"App Empty\");\n+            app.addMonitoredService(this.node1icmp);\n+            this.databasePopulator.getApplicationDao().save(app);\n+\n+            this.node1icmp.addApplication(app);\n+            this.databasePopulator.getMonitoredServiceDao().saveOrUpdate(this.node1icmp);\n+\n+            return null;\n+        });\n+\n+        this.perspectivePollerd.start();\n+    }\n+\n     @Test\n     public void testStartWithDuplicatedService() throws Exception {\n         this.databasePopulator.getTransactionTemplate().execute(tx -> {\n"}}, {"oid": "cff631dd6221fd6ee7e1a05600a0ff678db27dc0", "url": "https://github.com/OpenNMS/opennms/commit/cff631dd6221fd6ee7e1a05600a0ff678db27dc0", "message": "fixup! NMS-12889: Fix duplicated key for multi-app services", "committedDate": "2020-09-03T11:35:20Z", "type": "commit"}]}