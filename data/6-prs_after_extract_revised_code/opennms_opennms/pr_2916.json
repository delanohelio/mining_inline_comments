{"pr_number": 2916, "pr_title": "NMS-12569: Resolve Hostnames in BMP parser", "pr_createdAt": "2020-03-12T11:37:58Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2916", "timeline": [{"oid": "6bbffd949444bc6091994d5c1fb64adeff28c403", "url": "https://github.com/OpenNMS/opennms/commit/6bbffd949444bc6091994d5c1fb64adeff28c403", "message": "NMS-12569: Resolve Hostnames in BMP parser\n\nThis resolves IPs to hostnames while parsing BMP messages.\nIPs are resolved for Initiation messages and for each message containing\na peer header.\n\nThe DNS resolution is done asynchonous before dispatching the message to\nthe sink module. The behaviour is disabled by default and can be enabled\nusing parsing parameters.", "committedDate": "2020-03-12T11:31:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NjU1OQ==", "url": "https://github.com/OpenNMS/opennms/pull/2916#discussion_r391996559", "bodyText": "Can we enable this by default?", "author": "j-white", "createdAt": "2020-03-13T02:20:49Z", "path": "features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java", "diffHunk": "@@ -130,11 +133,16 @@\n \n     private HashSet<InetAddress> connections = Sets.newHashSet();\n \n+    private final DnsResolver dnsResolver;\n+    private boolean dnsLookupsEnabled;", "originalCommit": "6bbffd949444bc6091994d5c1fb64adeff28c403", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "442ab320bd963f2a1d57df71ba33cb3250b0e7d5", "chunk": "diff --git a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\nindex ecc271a2435..484fb335c2f 100644\n--- a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n+++ b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n\n@@ -131,7 +140,7 @@ public class BmpParser implements TcpParser {\n \n     private ScheduledFuture<?> heartbeatFuture;\n \n-    private HashSet<InetAddress> connections = Sets.newHashSet();\n+    private Set<InetAddress> connections = Sets.newConcurrentHashSet();\n \n     private final DnsResolver dnsResolver;\n     private boolean dnsLookupsEnabled;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NzA1MQ==", "url": "https://github.com/OpenNMS/opennms/pull/2916#discussion_r391997051", "bodyText": "We haven't necessarily dispatched it yet. We should move this into the thenCompose block above.", "author": "j-white", "createdAt": "2020-03-13T02:23:04Z", "path": "features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java", "diffHunk": "@@ -187,25 +195,39 @@ public Handler accept(final InetSocketAddress remoteAddress,\n \n                 LOG.trace(\"Got packet: {}\", packet);\n \n+                // Build the message from the received packet\n+                final Transport.Message.Builder message = Transport.Message.newBuilder()\n+                                                                           .setVersion(header.version);\n+\n+                packet.accept(new Serializer(message));\n+\n                 packet.accept(new Packet.Visitor.Adapter() {\n                     @Override\n-                    public void visit(InitiationPacket packet) {\n+                    public void visit(final InitiationPacket packet) {\n                         packet.information.first(InformationElement.Type.BGP_ID)\n-                                .map(InetAddressUtils::addr)\n-                                .ifPresent(_bgpId -> bgpId = _bgpId);\n+                                          .map(InetAddressUtils::addr)\n+                                          .ifPresent(_bgpId -> bgpId = _bgpId);\n                     }\n                 });\n \n-                final Transport.Message.Builder message = Transport.Message.newBuilder()\n-                                                                           .setVersion(header.version);\n-\n                 if (bgpId != null) {\n-                    message.setBgpId(address(bgpId));\n+                    message.setBgpId(BmpParser.address(bgpId));\n                 }\n \n-                packet.accept(new Serializer(message));\n \n-                final CompletableFuture<AsyncDispatcher.DispatchStatus> dispatched = dispatcher.send(new TelemetryMessage(remoteAddress, ByteBuffer.wrap(message.build().toByteArray())));\n+                // Enrich the message with resolved hostnames\n+                CompletableFuture<Transport.Message.Builder> enriched = CompletableFuture.completedFuture(message);\n+                if (BmpParser.this.dnsLookupsEnabled) {\n+                    enriched = enriched.thenCompose(BmpParser.this.resolvePeer(packet))\n+                                       .thenCompose(BmpParser.this.resolveSysName(packet, remoteAddress.getAddress()));\n+                }\n+\n+                // Dispatch the final message\n+                final CompletableFuture<AsyncDispatcher.DispatchStatus> dispatched = enriched.thenCompose(msg -> {\n+                    final ByteBuffer payload = ByteBuffer.wrap(msg.build().toByteArray());\n+                    return BmpParser.this.dispatcher.send(new TelemetryMessage(remoteAddress, payload));\n+                });\n+\n                 BmpParser.this.recordsDispatched.mark();", "originalCommit": "6bbffd949444bc6091994d5c1fb64adeff28c403", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "442ab320bd963f2a1d57df71ba33cb3250b0e7d5", "chunk": "diff --git a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\nindex ecc271a2435..484fb335c2f 100644\n--- a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n+++ b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n\n@@ -187,7 +205,7 @@ public class BmpParser implements TcpParser {\n \n                 final Packet packet;\n                 if (buffer.isReadable(header.payloadLength())) {\n-                    packet = header.parsePayload(slice(buffer, header.payloadLength()));\n+                    packet = header.parsePayload(slice(buffer, header.payloadLength()), peerAccessor);\n                 } else {\n                     buffer.resetReaderIndex();\n                     return Optional.empty();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwMDkwNQ==", "url": "https://github.com/OpenNMS/opennms/pull/2916#discussion_r392000905", "bodyText": "We need to find a way to put backpressure on the listener if we're not able to keep up. If there are already K enrichments in flight, then we should block until one of these finishes, otherwise we can OOM.\nWe handle this in org.opennms.netmgt.telemetry.protocols.netflow.parser.ParserBase, rather non-intutively. Maybe we can find a better way here? We already have resilience4j in the class-path - we could try and make use of the bulkhead: https://resilience4j.readme.io/docs/bulkhead", "author": "j-white", "createdAt": "2020-03-13T02:40:52Z", "path": "features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java", "diffHunk": "@@ -187,25 +195,39 @@ public Handler accept(final InetSocketAddress remoteAddress,\n \n                 LOG.trace(\"Got packet: {}\", packet);\n \n+                // Build the message from the received packet\n+                final Transport.Message.Builder message = Transport.Message.newBuilder()\n+                                                                           .setVersion(header.version);\n+\n+                packet.accept(new Serializer(message));\n+\n                 packet.accept(new Packet.Visitor.Adapter() {\n                     @Override\n-                    public void visit(InitiationPacket packet) {\n+                    public void visit(final InitiationPacket packet) {\n                         packet.information.first(InformationElement.Type.BGP_ID)\n-                                .map(InetAddressUtils::addr)\n-                                .ifPresent(_bgpId -> bgpId = _bgpId);\n+                                          .map(InetAddressUtils::addr)\n+                                          .ifPresent(_bgpId -> bgpId = _bgpId);\n                     }\n                 });\n \n-                final Transport.Message.Builder message = Transport.Message.newBuilder()\n-                                                                           .setVersion(header.version);\n-\n                 if (bgpId != null) {\n-                    message.setBgpId(address(bgpId));\n+                    message.setBgpId(BmpParser.address(bgpId));\n                 }\n \n-                packet.accept(new Serializer(message));\n \n-                final CompletableFuture<AsyncDispatcher.DispatchStatus> dispatched = dispatcher.send(new TelemetryMessage(remoteAddress, ByteBuffer.wrap(message.build().toByteArray())));\n+                // Enrich the message with resolved hostnames\n+                CompletableFuture<Transport.Message.Builder> enriched = CompletableFuture.completedFuture(message);\n+                if (BmpParser.this.dnsLookupsEnabled) {\n+                    enriched = enriched.thenCompose(BmpParser.this.resolvePeer(packet))", "originalCommit": "6bbffd949444bc6091994d5c1fb64adeff28c403", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "442ab320bd963f2a1d57df71ba33cb3250b0e7d5", "chunk": "diff --git a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\nindex ecc271a2435..484fb335c2f 100644\n--- a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n+++ b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/BmpParser.java\n\n@@ -187,7 +205,7 @@ public class BmpParser implements TcpParser {\n \n                 final Packet packet;\n                 if (buffer.isReadable(header.payloadLength())) {\n-                    packet = header.parsePayload(slice(buffer, header.payloadLength()));\n+                    packet = header.parsePayload(slice(buffer, header.payloadLength()), peerAccessor);\n                 } else {\n                     buffer.resetReaderIndex();\n                     return Optional.empty();\n"}}, {"oid": "442ab320bd963f2a1d57df71ba33cb3250b0e7d5", "url": "https://github.com/OpenNMS/opennms/commit/442ab320bd963f2a1d57df71ba33cb3250b0e7d5", "message": "Merge remote-tracking branch 'origin/release-26.0.0' into jira/NMS-12569", "committedDate": "2020-04-03T00:11:32Z", "type": "commit"}, {"oid": "c7e0646629dd5cd91ecf6179689853e31b36f579", "url": "https://github.com/OpenNMS/opennms/commit/c7e0646629dd5cd91ecf6179689853e31b36f579", "message": "NMS-12638: Fix ConcurrentModificationException - don't modify map while iterating", "committedDate": "2020-04-03T01:06:31Z", "type": "commit"}, {"oid": "295284bc16f4021659d1cd1e10cd7a37b96a2038", "url": "https://github.com/OpenNMS/opennms/commit/295284bc16f4021659d1cd1e10cd7a37b96a2038", "message": "NMS-12569: Add bulkhead pattern to BmpParser to gate the number of\npackets in flight pending async DNS resolution.", "committedDate": "2020-04-03T03:26:28Z", "type": "commit"}, {"oid": "033cea7adf14311299e22dbe23e540c25d4673e3", "url": "https://github.com/OpenNMS/opennms/commit/033cea7adf14311299e22dbe23e540c25d4673e3", "message": "NMS-12569: Review feedback.", "committedDate": "2020-04-03T03:32:37Z", "type": "commit"}]}