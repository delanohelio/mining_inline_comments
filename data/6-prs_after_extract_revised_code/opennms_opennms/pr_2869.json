{"pr_number": 2869, "pr_title": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]", "pr_createdAt": "2020-01-14T20:22:48Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2869", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYwNzQ5Mw==", "url": "https://github.com/OpenNMS/opennms/pull/2869#discussion_r366607493", "bodyText": "As discussed lets see if we can get rid of these copy...() methods by updating the copyFrom() methods to interrogate the object via the has...() methods to determine if a default would be given or not.", "author": "mattixtech", "createdAt": "2020-01-14T22:31:05Z", "path": "features/events/api/src/main/java/org/opennms/netmgt/events/api/model/IAlarmData.java", "diffHunk": "@@ -35,11 +35,14 @@\n  */\n public interface IAlarmData {\n     Integer getAlarmType();\n+    Integer copyAlarmType();", "originalCommit": "c52bda37c4067f825963268bdd1693de646b8da8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMTU3OA==", "url": "https://github.com/OpenNMS/opennms/pull/2869#discussion_r366611578", "bodyText": "If the ImmutableMapper implementations are updated to check the has method first and set the appropriate value on the Immutable object we should be able to get rid of the copy methods on the interface since we know the value returned by the getter will be as-set not a default.\n\nShould be able to delete all the new copy...() methods from the interfaces.\nShould be able to delete all the new copy...() methods from the JAXB types.", "author": "mattixtech", "createdAt": "2020-01-14T22:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYwNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMjgzMw==", "url": "https://github.com/OpenNMS/opennms/pull/2869#discussion_r366612833", "bodyText": "Ex using AlarmData updating the set calls to check first for defaulted types:\n    public static ImmutableAlarmData fromMutableAlarmData(AlarmData alarmData) {\n        if (alarmData == null) {\n            return null;\n        }\n\n        return ImmutableAlarmData.newBuilder()\n                .setReductionKey(alarmData.getReductionKey())\n                .setAlarmType(alarmData.hasAlarmType() ? alarmData.getAlarmType() : null)\n                .setClearKey(alarmData.getClearKey())\n                .setAutoClean(alarmData.hasAutoClean() ? alarmData.getAutoClean() : null)\n                .setX733AlarmType(alarmData.getX733AlarmType())\n                .setX733ProbableCause(alarmData.hasX733ProbableCause() ? alarmData.getX733ProbableCause() : null)\n                .setUpdateFieldList(\n                        alarmData.getUpdateFieldList()\n                                .stream().map(ImmutableMapper::fromMutableUpdateField)\n                                .collect(Collectors.toList()))\n                .setManagedObject(fromMutableManagedObject(alarmData.getManagedObject()))\n                .build();\n    }", "author": "mattixtech", "createdAt": "2020-01-14T22:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYwNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjkzNjQ4Mw==", "url": "https://github.com/OpenNMS/opennms/pull/2869#discussion_r366936483", "bodyText": "Updated to remove the copy...() methods and make use of has...() methods.  Thanks for the feedback.  :)", "author": "bouff", "createdAt": "2020-01-15T15:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYwNzQ5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4c93c5b60f5ecba5e8145c4aff29b76a4e331662", "chunk": "diff --git a/features/events/api/src/main/java/org/opennms/netmgt/events/api/model/IAlarmData.java b/features/events/api/src/main/java/org/opennms/netmgt/events/api/model/IAlarmData.java\nindex fb82d766a87..fa21e5d3f4b 100644\n--- a/features/events/api/src/main/java/org/opennms/netmgt/events/api/model/IAlarmData.java\n+++ b/features/events/api/src/main/java/org/opennms/netmgt/events/api/model/IAlarmData.java\n\n@@ -35,14 +35,14 @@ import java.util.List;\n  */\n public interface IAlarmData {\n     Integer getAlarmType();\n-    Integer copyAlarmType();\n+    boolean hasAlarmType();\n     Boolean getAutoClean();\n-    Boolean copyAutoClean();\n+    boolean hasAutoClean();\n     String getClearKey();\n     String getReductionKey();\n     String getX733AlarmType();\n     Integer getX733ProbableCause();\n-    Integer copyX733ProbableCause();\n+    boolean hasX733ProbableCause();\n     Boolean isAutoClean();\n     List<IUpdateField> getUpdateFieldList();\n     Boolean hasUpdateFields();\n"}}, {"oid": "4c93c5b60f5ecba5e8145c4aff29b76a4e331662", "url": "https://github.com/OpenNMS/opennms/commit/4c93c5b60f5ecba5e8145c4aff29b76a4e331662", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Review updates", "committedDate": "2020-01-15T15:13:25Z", "type": "forcePushed"}, {"oid": "e5144f8682d143946ce9aa844f3d6a0890b7c932", "url": "https://github.com/OpenNMS/opennms/commit/e5144f8682d143946ce9aa844f3d6a0890b7c932", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Work in progress... Propagate immutable event to event listeners.", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "90914f9b3776adf98c02a8994fbd001df20f7e59", "url": "https://github.com/OpenNMS/opennms/commit/90914f9b3776adf98c02a8994fbd001df20f7e59", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix a unit test", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "14f47ca627852e01169e5eecae0857f5328484ba", "url": "https://github.com/OpenNMS/opennms/commit/14f47ca627852e01169e5eecae0857f5328484ba", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix another unit test", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "93e9e89afe6e3e64d96ab3e5d0a1b10790e4ccf2", "url": "https://github.com/OpenNMS/opennms/commit/93e9e89afe6e3e64d96ab3e5d0a1b10790e4ccf2", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-More fixing...", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "77133536eceaf59b62d4fcb772e340b79bdd3158", "url": "https://github.com/OpenNMS/opennms/commit/77133536eceaf59b62d4fcb772e340b79bdd3158", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix for smoke test\n-Tentative fix for some unit tests", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "5683c78b863e1a6f0102b0c5ea8c0f13f90d3b9b", "url": "https://github.com/OpenNMS/opennms/commit/5683c78b863e1a6f0102b0c5ea8c0f13f90d3b9b", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix unit test (issue in DefaultPollContext)", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "255c84b0e95ea33d36c52c3857bcc75d1b5ecb96", "url": "https://github.com/OpenNMS/opennms/commit/255c84b0e95ea33d36c52c3857bcc75d1b5ecb96", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Further fixes", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "376dcb5508cd84d759984a051976f5cb588d1b36", "url": "https://github.com/OpenNMS/opennms/commit/376dcb5508cd84d759984a051976f5cb588d1b36", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix mapping issue (fields with defaulted values).", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "ec682bfec694ec997916dc0ca32865fc12f118e4", "url": "https://github.com/OpenNMS/opennms/commit/ec682bfec694ec997916dc0ca32865fc12f118e4", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Some small touch-ups", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "ad8fede9a3ea51c24c35b74e2caf998062619b7e", "url": "https://github.com/OpenNMS/opennms/commit/ad8fede9a3ea51c24c35b74e2caf998062619b7e", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Review updates", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "f288d18c2da2012e3c19f7f6b8d10ec42c7d60ef", "url": "https://github.com/OpenNMS/opennms/commit/f288d18c2da2012e3c19f7f6b8d10ec42c7d60ef", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Fix compilation issue.", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "4aaac60a1566bfc0920685e3a0114c5412641006", "url": "https://github.com/OpenNMS/opennms/commit/4aaac60a1566bfc0920685e3a0114c5412641006", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Add explanation for 'has...()' methods on interfaces that have them.", "committedDate": "2020-01-17T18:27:42Z", "type": "commit"}, {"oid": "4aaac60a1566bfc0920685e3a0114c5412641006", "url": "https://github.com/OpenNMS/opennms/commit/4aaac60a1566bfc0920685e3a0114c5412641006", "message": "NMS-10720: Make Events immutable (avoid CMEs and fix non-deterministic behavior) [Part 2]\n\n-Add explanation for 'has...()' methods on interfaces that have them.", "committedDate": "2020-01-17T18:27:42Z", "type": "forcePushed"}]}