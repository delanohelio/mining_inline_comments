{"pr_number": 2920, "pr_title": "NMS-12571: Parse BGP capabilities", "pr_createdAt": "2020-03-17T12:01:14Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2920", "timeline": [{"oid": "4b027ca97838f22e3edc4a6db3579e5e45ed45ea", "url": "https://github.com/OpenNMS/opennms/commit/4b027ca97838f22e3edc4a6db3579e5e45ed45ea", "message": "NMS-12571: WIP", "committedDate": "2020-03-13T13:34:54Z", "type": "commit"}, {"oid": "003682fe0c47f4e69c1b6161de012668947f8032", "url": "https://github.com/OpenNMS/opennms/commit/003682fe0c47f4e69c1b6161de012668947f8032", "message": "NMS-12571: Added transport code", "committedDate": "2020-03-17T11:57:27Z", "type": "commit"}, {"oid": "cc338e6307475b64ca283f9d6cb6466ebfad128e", "url": "https://github.com/OpenNMS/opennms/commit/cc338e6307475b64ca283f9d6cb6466ebfad128e", "message": "Merge branch 'features/bmp' into jira/NMS-12571", "committedDate": "2020-03-17T12:01:03Z", "type": "commit"}, {"oid": "271f29b0bf4cbfef20dc6571aa5bd867f06f53c4", "url": "https://github.com/OpenNMS/opennms/commit/271f29b0bf4cbfef20dc6571aa5bd867f06f53c4", "message": "NMS-12571: Review changes", "committedDate": "2020-03-17T14:44:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1MzQ3NQ==", "url": "https://github.com/OpenNMS/opennms/pull/2920#discussion_r393853475", "bodyText": "Not that it currently is required to implement right now, but do we have a clue about what this value could be?", "author": "fooker", "createdAt": "2020-03-17T17:35:35Z", "path": "features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/Capability.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.telemetry.protocols.bmp.parser.proto.bgp.packets;\n+\n+import static org.opennms.netmgt.telemetry.listeners.utils.BufferUtils.slice;\n+import static org.opennms.netmgt.telemetry.listeners.utils.BufferUtils.uint8;\n+\n+import com.google.protobuf.ByteString;\n+\n+import io.netty.buffer.ByteBuf;\n+\n+public class Capability {\n+\n+    private final int code;\n+    private final int length;\n+    private final ByteBuf value;\n+\n+    public Capability(final ByteBuf buffer) {\n+        this.code = uint8(buffer);\n+        this.length = uint8(buffer);\n+        this.value = slice(buffer, this.length);\n+    }\n+\n+    public int getCode() {\n+        return code;\n+    }\n+\n+    public int getLength() {\n+        return length;\n+    }\n+\n+    public ByteString getValue() {\n+        return ByteString.copyFrom(value.array());", "originalCommit": "271f29b0bf4cbfef20dc6571aa5bd867f06f53c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEyMzc4NA==", "url": "https://github.com/OpenNMS/opennms/pull/2920#discussion_r394123784", "bodyText": "We currently implement the parsing for this value for code 1 and 69, like the OpenBMP implementation does.", "author": "christianpape", "createdAt": "2020-03-18T06:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1MzQ3NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1NTk0Nw==", "url": "https://github.com/OpenNMS/opennms/pull/2920#discussion_r393855947", "bodyText": "I don't think we should filter the parameters, as capabilities are parameters, too. An we should keep the link to the rfc for further reference to there parameter types, if there are any.", "author": "fooker", "createdAt": "2020-03-17T17:39:26Z", "path": "features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/OpenPacket.java", "diffHunk": "@@ -66,8 +92,10 @@ public OpenPacket(final Header header, final ByteBuf buffer, final PeerFlags fla\n \n         final int parametersLength = uint8(buffer);\n \n-        // Skip the parameters (see https://tools.ietf.org/html/rfc4271#section-4.2)\n-        skip(buffer, parametersLength);\n+        final List<Parameter> list = repeatRemaining(slice(buffer, parametersLength), Parameter::new);\n+\n+        parameters = list.stream().filter(p -> p.type != 2).collect(Collectors.toList());", "originalCommit": "271f29b0bf4cbfef20dc6571aa5bd867f06f53c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEyMzg2NA==", "url": "https://github.com/OpenNMS/opennms/pull/2920#discussion_r394123864", "bodyText": "Ok", "author": "christianpape", "createdAt": "2020-03-18T06:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1NTk0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b647a093f6e25b5cc5f33851af1209243f416655", "chunk": "diff --git a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/OpenPacket.java b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/OpenPacket.java\nindex 426a43619b0..8f900d08dd1 100644\n--- a/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/OpenPacket.java\n+++ b/features/telemetry/protocols/bmp/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/parser/proto/bgp/packets/OpenPacket.java\n\n@@ -92,10 +92,10 @@ public class OpenPacket implements Packet {\n \n         final int parametersLength = uint8(buffer);\n \n-        final List<Parameter> list = repeatRemaining(slice(buffer, parametersLength), Parameter::new);\n-\n-        parameters = list.stream().filter(p -> p.type != 2).collect(Collectors.toList());\n-        capabilities = list.stream().filter(p -> p.type == 2).flatMap(p -> repeatRemaining(slice(p.value, p.length), Capability::new).stream()).collect(Collectors.toList());\n+        // see https://tools.ietf.org/html/rfc4271#section-4.2\n+        this.parameters = repeatRemaining(slice(buffer, parametersLength), Parameter::new);\n+        // see https://tools.ietf.org/html/rfc3392\n+        this.capabilities = this.parameters.stream().filter(p -> p.type == 2).flatMap(p -> repeatRemaining(slice(p.value, p.length), Capability::new).stream()).collect(Collectors.toList());\n     }\n \n     @Override\n"}}, {"oid": "b647a093f6e25b5cc5f33851af1209243f416655", "url": "https://github.com/OpenNMS/opennms/commit/b647a093f6e25b5cc5f33851af1209243f416655", "message": "NMS-12571: Review changes", "committedDate": "2020-03-18T06:12:45Z", "type": "commit"}]}