{"pr_number": 3025, "pr_title": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API - Part 1", "pr_createdAt": "2020-05-31T19:45:09Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3025", "timeline": [{"oid": "64677b439fc9b02fc2a91636f25cc8c2363acdf4", "url": "https://github.com/OpenNMS/opennms/commit/64677b439fc9b02fc2a91636f25cc8c2363acdf4", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: introduce timeseriesSearcherCache", "committedDate": "2020-06-09T18:46:41Z", "type": "forcePushed"}, {"oid": "390791be1c977fe5783344ae3a57b6e286a8a1b0", "url": "https://github.com/OpenNMS/opennms/commit/390791be1c977fe5783344ae3a57b6e286a8a1b0", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries", "committedDate": "2020-06-14T16:51:08Z", "type": "forcePushed"}, {"oid": "026b677162a672639b72711c23a41e572f988671", "url": "https://github.com/OpenNMS/opennms/commit/026b677162a672639b72711c23a41e572f988671", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries", "committedDate": "2020-06-17T19:03:34Z", "type": "forcePushed"}, {"oid": "8062cd005f77301190373295397fd38c15adb7f9", "url": "https://github.com/OpenNMS/opennms/commit/8062cd005f77301190373295397fd38c15adb7f9", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: Initial commit", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "e8487ba7d5ac5fa12c82b70af5fdb87f85ac7abd", "url": "https://github.com/OpenNMS/opennms/commit/e8487ba7d5ac5fa12c82b70af5fdb87f85ac7abd", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "c5d8fca4d522fdb4810dd635bb7157c6edcccf53", "url": "https://github.com/OpenNMS/opennms/commit/c5d8fca4d522fdb4810dd635bb7157c6edcccf53", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao: add test", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "3d6055d0540a75df47420110d4419bf6e0d76a21", "url": "https://github.com/OpenNMS/opennms/commit/3d6055d0540a75df47420110d4419bf6e0d76a21", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao: fix checkstyle", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "d118e6d9bc768b51cfb352c57f6409227827a2a3", "url": "https://github.com/OpenNMS/opennms/commit/d118e6d9bc768b51cfb352c57f6409227827a2a3", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: cleanup unused config", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "3f31d030f2fb6f4674c93de03cc93bb0bdf8d6fc", "url": "https://github.com/OpenNMS/opennms/commit/3f31d030f2fb6f4674c93de03cc93bb0bdf8d6fc", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: introduce timeseriesSearcherCache", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "3a18feec70529160d1f801b13ad7da89d729d732", "url": "https://github.com/OpenNMS/opennms/commit/3a18feec70529160d1f801b13ad7da89d729d732", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries", "committedDate": "2020-06-20T22:18:25Z", "type": "commit"}, {"oid": "3a18feec70529160d1f801b13ad7da89d729d732", "url": "https://github.com/OpenNMS/opennms/commit/3a18feec70529160d1f801b13ad7da89d729d732", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries", "committedDate": "2020-06-20T22:18:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyNDUzNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445824535", "bodyText": "There is no need for the try block. If the call throws, it must be a runtime exception and we can just propagate without wrapping.", "author": "fooker", "createdAt": "2020-06-25T20:38:58Z", "path": "core/cache/src/main/java/org/opennms/core/cache/Cache.java", "diffHunk": "@@ -84,6 +85,18 @@ public V get(K key) throws ExecutionException {\n         }\n     }\n \n+    public V get(K key, Callable<? extends V> valueLoader) throws ExecutionException {\n+        Objects.requireNonNull(key);\n+        if (config.isEnabled()) {\n+            return delegate.get(key, valueLoader);\n+        }\n+        try {\n+            return valueLoader.call();\n+        } catch (Throwable t) {\n+            throw new RuntimeException(t);", "originalCommit": "3a18feec70529160d1f801b13ad7da89d729d732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIyNzQxNA==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r446227414", "bodyText": "java.util.concurrent.Callable declares to throw Exception:\nhttps://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html\nI assume that is the reason for the existing code. Do you have an idea for a more elegant solution?", "author": "patrick-schweizer", "createdAt": "2020-06-26T14:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyNDUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2ODc3MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r446368771", "bodyText": "You are totally right. I mixed it up with the Producer interface. But this Callable is more appropriate as an error can happen and should be expected.", "author": "fooker", "createdAt": "2020-06-26T19:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyNDUzNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTMxMw==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445841313", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<String, String> attributesForResource = cache.get(meta.getResourceId(), HashMap::new);\n          \n          \n            \n                        if(attributesForResource.get(meta.getName()) == null) {\n          \n          \n            \n                        Map<String, String> attributesForResource = cache.getIfPresent(meta.getResourceId());\n          \n          \n            \n                        if(attributesForResource != null && attributesForResource.contains(meta.getName())) {\n          \n      \n    \n    \n  \n\nTo save the allocation", "author": "fooker", "createdAt": "2020-06-25T21:13:05Z", "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java", "diffHunk": "@@ -69,34 +69,35 @@\n \n     private final DataSource dataSource;\n \n-    private final Map<String, Map<String, String>> cache; // resourceId, Map<name, value>\n+    private final Cache<String, Map<String, String>> cache; // resourceId, Map<name, value>\n \n     @Autowired\n     public TimeSeriesMetaDataDao(final DataSource dataSource,\n                                  @Named(\"timeseries.metadata.cache_size\") long cacheSize,\n                                  @Named(\"timeseries.metadata.cache_duration\") long cacheDuration) {\n         this.dataSource = dataSource;\n-        Cache<String, Map<String, String>> cache = CacheBuilder.newBuilder()\n+        this.cache = CacheBuilder.newBuilder()\n                 .maximumSize(cacheSize)\n                 .expireAfterWrite(cacheDuration, TimeUnit.SECONDS) // to make sure cache and db are in sync\n                 .build();\n-        this.cache = cache.asMap();\n     }\n \n-    public void store(final Collection<MetaData> metaDataCollection) throws SQLException {\n+    public void store(final Collection<MetaData> metaDataCollection) throws SQLException, ExecutionException {\n         Objects.requireNonNull(metaDataCollection);\n-        Set<MetaData> uncached = new HashSet<>();\n+        Set<MetaData> writeToDb = new HashSet<>();\n \n         // find all MetaData that is not present in the cache\n         for(MetaData meta : metaDataCollection) {\n-            if(!Optional\n-                    .ofNullable(cache.get(meta.getResourceId()))\n-                    .map(entry -> entry.get(meta.getName()))\n-                    .isPresent()) {\n-                uncached.add(meta);\n+            Map<String, String> attributesForResource = cache.get(meta.getResourceId(), HashMap::new);\n+            if(attributesForResource.get(meta.getName()) == null) {", "originalCommit": "3a18feec70529160d1f801b13ad7da89d729d732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIyOTY3Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r446229676", "bodyText": "\ud83d\udc4d", "author": "patrick-schweizer", "createdAt": "2020-06-26T14:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTMxMw=="}], "type": "inlineReview", "revised_code": {"commit": "8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "chunk": "diff --git a/features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java b/features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java\nindex dd8378b67ee..c78b0397ecf 100644\n--- a/features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java\n+++ b/features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java\n\n@@ -88,8 +88,8 @@ public class TimeSeriesMetaDataDao {\n \n         // find all MetaData that is not present in the cache\n         for(MetaData meta : metaDataCollection) {\n-            Map<String, String> attributesForResource = cache.get(meta.getResourceId(), HashMap::new);\n-            if(attributesForResource.get(meta.getName()) == null) {\n+            Map<String, String> attributesForResource = cache.getIfPresent(meta.getResourceId());\n+            if(attributesForResource != null && attributesForResource.contains(meta.getName())) {\n                 writeToDb.add(meta);\n                 attributesForResource.put(meta.getName(), meta.getValue()); // add to cache\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDk1OQ==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445844959", "bodyText": "If you call the other side that you should prefix the instance with this. :-)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Objects.equals(m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(m_relativePath, that.m_relativePath) &&\n          \n          \n            \n                            Objects.equals(m_rrdFile, that.m_rrdFile) &&\n          \n          \n            \n                            Objects.equals(m_resource, that.m_resource);\n          \n          \n            \n                    return Objects.equals(this.m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(this.m_relativePath, that.m_relativePath) &&\n          \n          \n            \n                            Objects.equals(this.m_rrdFile, that.m_rrdFile) &&\n          \n          \n            \n                            Objects.equals(this.m_resource, that.m_resource);", "author": "fooker", "createdAt": "2020-06-25T21:21:06Z", "path": "opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java", "diffHunk": "@@ -136,4 +137,19 @@ public String toString() {\n     \treturn \"\"+m_resource + '.' + m_name;\n \t}\n \n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) return true;\n+        if (o == null || getClass() != o.getClass()) return false;\n+        RrdGraphAttribute that = (RrdGraphAttribute) o;\n+        return Objects.equals(m_name, that.m_name) &&\n+                Objects.equals(m_relativePath, that.m_relativePath) &&\n+                Objects.equals(m_rrdFile, that.m_rrdFile) &&\n+                Objects.equals(m_resource, that.m_resource);", "originalCommit": "3a18feec70529160d1f801b13ad7da89d729d732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzMjgwMw==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r446232803", "bodyText": "\ud83d\udc4d", "author": "patrick-schweizer", "createdAt": "2020-06-26T14:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "chunk": "diff --git a/opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java b/opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java\nindex 7e1ab9467d5..b6d450496ed 100644\n--- a/opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java\n+++ b/opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java\n\n@@ -142,10 +142,10 @@ public class RrdGraphAttribute implements OnmsAttribute {\n         if (this == o) return true;\n         if (o == null || getClass() != o.getClass()) return false;\n         RrdGraphAttribute that = (RrdGraphAttribute) o;\n-        return Objects.equals(m_name, that.m_name) &&\n-                Objects.equals(m_relativePath, that.m_relativePath) &&\n-                Objects.equals(m_rrdFile, that.m_rrdFile) &&\n-                Objects.equals(m_resource, that.m_resource);\n+        return Objects.equals(this.m_name, that.m_name) &&\n+                Objects.equals(this.m_relativePath, that.m_relativePath) &&\n+                Objects.equals(this.m_rrdFile, that.m_rrdFile) &&\n+                Objects.equals(this.m_resource, that.m_resource);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTIyNw==", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445845227", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Objects.equals(m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(m_value, that.m_value) &&\n          \n          \n            \n                            Objects.equals(m_resource, that.m_resource);\n          \n          \n            \n                    return Objects.equals(this.m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(this.m_value, that.m_value) &&\n          \n          \n            \n                            Objects.equals(this.m_resource, that.m_resource);", "author": "fooker", "createdAt": "2020-06-25T21:21:42Z", "path": "opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java", "diffHunk": "@@ -89,4 +91,19 @@ public OnmsResource getResource() {\n     public void setResource(OnmsResource resource) {\n         m_resource = resource;\n     }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) return true;\n+        if (o == null || getClass() != o.getClass()) return false;\n+        StringPropertyAttribute that = (StringPropertyAttribute) o;\n+        return Objects.equals(m_name, that.m_name) &&\n+                Objects.equals(m_value, that.m_value) &&\n+                Objects.equals(m_resource, that.m_resource);", "originalCommit": "3a18feec70529160d1f801b13ad7da89d729d732", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "chunk": "diff --git a/opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java b/opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java\nindex 9b88574b263..11787b146dd 100644\n--- a/opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java\n+++ b/opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java\n\n@@ -97,9 +97,9 @@ public class StringPropertyAttribute implements OnmsAttribute {\n         if (this == o) return true;\n         if (o == null || getClass() != o.getClass()) return false;\n         StringPropertyAttribute that = (StringPropertyAttribute) o;\n-        return Objects.equals(m_name, that.m_name) &&\n-                Objects.equals(m_value, that.m_value) &&\n-                Objects.equals(m_resource, that.m_resource);\n+        return Objects.equals(this.m_name, that.m_name) &&\n+                Objects.equals(this.m_value, that.m_value) &&\n+                Objects.equals(this.m_resource, that.m_resource);\n     }\n \n     @Override\n"}}, {"oid": "8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "url": "https://github.com/OpenNMS/opennms/commit/8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "message": "Apply suggestions from code review\r\n\r\nNMS-12731: PR suggestions\n\nCo-authored-by: Dustin Frisch <fooker@lab.sh>", "committedDate": "2020-06-26T15:10:45Z", "type": "commit"}, {"oid": "1292d46c92bee9ef530d50312370b1243aae354b", "url": "https://github.com/OpenNMS/opennms/commit/1292d46c92bee9ef530d50312370b1243aae354b", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage: fix java version problem", "committedDate": "2020-06-29T17:20:32Z", "type": "commit"}, {"oid": "01e87c13716a63c9ecc228cf3d2911527b9d142c", "url": "https://github.com/OpenNMS/opennms/commit/01e87c13716a63c9ecc228cf3d2911527b9d142c", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage: fix cache problem", "committedDate": "2020-07-01T20:19:40Z", "type": "commit"}, {"oid": "abcdfd29b92792e0a133a52488f72cac44f3afc3", "url": "https://github.com/OpenNMS/opennms/commit/abcdfd29b92792e0a133a52488f72cac44f3afc3", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API - Part 2", "committedDate": "2020-07-07T00:19:00Z", "type": "commit"}, {"oid": "e37d635f56308d665565b64bf425edacd2d09f6e", "url": "https://github.com/OpenNMS/opennms/commit/e37d635f56308d665565b64bf425edacd2d09f6e", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: fix caching of non existent paths under wildcard", "committedDate": "2020-07-08T16:29:04Z", "type": "commit"}]}