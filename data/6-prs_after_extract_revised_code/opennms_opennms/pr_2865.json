{"pr_number": 2865, "pr_title": "NMS-12460: Merged poll and test command", "pr_createdAt": "2020-01-10T14:01:24Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2865", "timeline": [{"oid": "ffe8435a470bb6815f595f20b3b1bb7d724974c8", "url": "https://github.com/OpenNMS/opennms/commit/ffe8435a470bb6815f595f20b3b1bb7d724974c8", "message": "NMS-12460: Merged poll and test command", "committedDate": "2020-01-10T14:00:35Z", "type": "commit"}, {"oid": "5b5bbb3224b52f86341dca61b1c4e07e8e5f5db8", "url": "https://github.com/OpenNMS/opennms/commit/5b5bbb3224b52f86341dca61b1c4e07e8e5f5db8", "message": "NMS-12460: Documentation changes", "committedDate": "2020-01-13T08:58:06Z", "type": "commit"}, {"oid": "5b5bbb3224b52f86341dca61b1c4e07e8e5f5db8", "url": "https://github.com/OpenNMS/opennms/commit/5b5bbb3224b52f86341dca61b1c4e07e8e5f5db8", "message": "NMS-12460: Documentation changes", "committedDate": "2020-01-13T08:58:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgzMjU4Mw==", "url": "https://github.com/OpenNMS/opennms/pull/2865#discussion_r365832583", "bodyText": "Can you use SessionUtils instead?\nUsing TransactionOperations may result in weird bundle states when bundle:watch * is enabled or a bundle is trying to refresh.", "author": "mvrueden", "createdAt": "2020-01-13T14:28:21Z", "path": "features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java", "diffHunk": "@@ -44,60 +47,147 @@\n import org.apache.karaf.shell.api.action.Option;\n import org.apache.karaf.shell.api.action.lifecycle.Reference;\n import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.opennms.core.utils.InetAddressUtils;\n+import org.opennms.core.xml.JaxbUtils;\n+import org.opennms.netmgt.config.PollerConfig;\n+import org.opennms.netmgt.config.poller.Package;\n+import org.opennms.netmgt.config.poller.Parameter;\n+import org.opennms.netmgt.dao.api.IpInterfaceDao;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.model.OnmsIpInterface;\n+import org.opennms.netmgt.model.OnmsNode;\n import org.opennms.netmgt.poller.LocationAwarePollerClient;\n+import org.opennms.netmgt.poller.MonitoredService;\n import org.opennms.netmgt.poller.PollStatus;\n import org.opennms.netmgt.poller.PollerResponse;\n+import org.opennms.netmgt.poller.ServiceMonitor;\n import org.opennms.netmgt.poller.support.SimpleMonitoredService;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionOperations;\n \n-@Command(scope = \"poller\", name = \"poll\", description = \"Used to invoke a monitor against a host at a specified location\")\n+@Command(scope = \"opennms-poller\", name = \"poll\", description = \"Used to invoke a monitor against a host at a specified location\")\n @Service\n public class Poll implements Action {\n \n     @Option(name = \"-l\", aliases = \"--location\", description = \"Location\", required = false, multiValued = false)\n-    String location;\n+    String location = \"Default\";\n+\n+    @Option(name = \"-S\", aliases = \"--service\", description = \"Service name\", required = false, multiValued = false)\n+    String serviceName;\n+\n+    @Option(name = \"-P\", aliases = \"--package\", description = \"Poller Package\", required = false, multiValued = false)\n+    String packageName;\n \n     @Option(name = \"-s\", aliases = \"--system-id\", description = \"System ID\")\n     String systemId;\n \n     @Option(name = \"-t\", aliases = \"--ttl\", description = \"Time to live\", required = false, multiValued = false)\n     Long ttlInMs;\n-    \n+\n     @Option(name = \"-n\", aliases = \"--node-id\", description = \"Node Id for Service\", required = false, multiValued = false)\n     int nodeId;\n \n-    @Argument(index = 0, name = \"monitorClass\", description = \"Monitor class\", required = true, multiValued = false)\n+    @Option(name = \"-c\", aliases = \"--class\", description = \"Monitor Class\", required = false, multiValued = false)\n     @Completion(MonitorClassNameCompleter.class)\n     String className;\n \n-    @Argument(index = 1, name = \"host\", description = \"Hostname or IP Address of the system to poll\", required = true, multiValued = false)\n+    @Argument(index = 0, name = \"host\", description = \"Hostname or IP Address of the system to poll\", required = true, multiValued = false)\n     String host;\n \n-    @Argument(index = 2, name = \"attributes\", description = \"Monitor specific attributes in key=value form\", multiValued = true)\n+    @Argument(index = 1, name = \"attributes\", description = \"Monitor specific attributes in key=value form\", multiValued = true)\n     List<String> attributes;\n \n     @Reference\n     public LocationAwarePollerClient locationAwarePollerClient;\n \n+    @Reference\n+    public NodeDao nodeDao;\n+\n+    @Reference\n+    public IpInterfaceDao ipInterfaceDao;\n+\n+    @Reference\n+    public TransactionOperations transactionTemplate;", "originalCommit": "5b5bbb3224b52f86341dca61b1c4e07e8e5f5db8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efd98285297a02e457859802c1dc4f83f28e2c0e", "chunk": "diff --git a/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java b/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\nindex 51a3544f791..7610d70ae7a 100644\n--- a/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\n+++ b/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\n\n@@ -54,6 +54,7 @@ import org.opennms.netmgt.config.poller.Package;\n import org.opennms.netmgt.config.poller.Parameter;\n import org.opennms.netmgt.dao.api.IpInterfaceDao;\n import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n import org.opennms.netmgt.model.OnmsIpInterface;\n import org.opennms.netmgt.model.OnmsNode;\n import org.opennms.netmgt.poller.LocationAwarePollerClient;\n"}}, {"oid": "efd98285297a02e457859802c1dc4f83f28e2c0e", "url": "https://github.com/OpenNMS/opennms/commit/efd98285297a02e457859802c1dc4f83f28e2c0e", "message": "NMS-12460: Review changes", "committedDate": "2020-01-14T12:06:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI1MjMzMQ==", "url": "https://github.com/OpenNMS/opennms/pull/2865#discussion_r365252331", "bodyText": "What about changing the description to reflect the two purposes of the command?\nI'm thinking about something like this:\nUsed to invoke a monitor against a host at a specific location, or to test a service monitor definition from a given poller package.", "author": "agalue", "createdAt": "2020-01-10T14:14:53Z", "path": "features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java", "diffHunk": "@@ -44,60 +47,147 @@\n import org.apache.karaf.shell.api.action.Option;\n import org.apache.karaf.shell.api.action.lifecycle.Reference;\n import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.opennms.core.utils.InetAddressUtils;\n+import org.opennms.core.xml.JaxbUtils;\n+import org.opennms.netmgt.config.PollerConfig;\n+import org.opennms.netmgt.config.poller.Package;\n+import org.opennms.netmgt.config.poller.Parameter;\n+import org.opennms.netmgt.dao.api.IpInterfaceDao;\n+import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.model.OnmsIpInterface;\n+import org.opennms.netmgt.model.OnmsNode;\n import org.opennms.netmgt.poller.LocationAwarePollerClient;\n+import org.opennms.netmgt.poller.MonitoredService;\n import org.opennms.netmgt.poller.PollStatus;\n import org.opennms.netmgt.poller.PollerResponse;\n+import org.opennms.netmgt.poller.ServiceMonitor;\n import org.opennms.netmgt.poller.support.SimpleMonitoredService;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.support.TransactionCallback;\n+import org.springframework.transaction.support.TransactionOperations;\n \n-@Command(scope = \"poller\", name = \"poll\", description = \"Used to invoke a monitor against a host at a specified location\")\n+@Command(scope = \"opennms-poller\", name = \"poll\", description = \"Used to invoke a monitor against a host at a specified location\")", "originalCommit": "ffe8435a470bb6815f595f20b3b1bb7d724974c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efd98285297a02e457859802c1dc4f83f28e2c0e", "chunk": "diff --git a/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java b/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\nindex 51a3544f791..7610d70ae7a 100644\n--- a/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\n+++ b/features/poller/shell/src/main/java/org/opennms/netmgt/poller/shell/Poll.java\n\n@@ -54,6 +54,7 @@ import org.opennms.netmgt.config.poller.Package;\n import org.opennms.netmgt.config.poller.Parameter;\n import org.opennms.netmgt.dao.api.IpInterfaceDao;\n import org.opennms.netmgt.dao.api.NodeDao;\n+import org.opennms.netmgt.dao.api.SessionUtils;\n import org.opennms.netmgt.model.OnmsIpInterface;\n import org.opennms.netmgt.model.OnmsNode;\n import org.opennms.netmgt.poller.LocationAwarePollerClient;\n"}}, {"oid": "64dd0ac829ae15a1f271242a68e8a1a07cdaac8a", "url": "https://github.com/OpenNMS/opennms/commit/64dd0ac829ae15a1f271242a68e8a1a07cdaac8a", "message": "NMS-12460: Changed description", "committedDate": "2020-01-14T14:07:39Z", "type": "commit"}]}