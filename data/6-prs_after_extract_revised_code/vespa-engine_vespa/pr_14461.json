{"pr_number": 14461, "pr_title": "Jonmv/async document v1", "pr_createdAt": "2020-09-21T08:20:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14461", "timeline": [{"oid": "bc3e2448a1c805d90b4ac8b6ea59af6f8efd7cc1", "url": "https://github.com/vespa-engine/vespa/commit/bc3e2448a1c805d90b4ac8b6ea59af6f8efd7cc1", "message": "Let successful RemoveReponse and UpdateRespone have NOT_FOUND outcome", "committedDate": "2020-09-21T06:36:59Z", "type": "commit"}, {"oid": "433df784ef747fe85883ab7612c08cd51866b32a", "url": "https://github.com/vespa-engine/vespa/commit/433df784ef747fe85883ab7612c08cd51866b32a", "message": "Update abi spec", "committedDate": "2020-09-21T06:51:25Z", "type": "commit"}, {"oid": "af3afdb3d165df39d4548406553e4f0adee591c7", "url": "https://github.com/vespa-engine/vespa/commit/af3afdb3d165df39d4548406553e4f0adee591c7", "message": "Provide a MessageBugDocumentAccess lazily, in containers", "committedDate": "2020-09-21T08:16:53Z", "type": "commit"}, {"oid": "86157db42aab6749f62104ff0660b66ce4a649ba", "url": "https://github.com/vespa-engine/vespa/commit/86157db42aab6749f62104ff0660b66ce4a649ba", "message": "Update doc in DocumentAccess", "committedDate": "2020-09-21T08:20:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491918120", "bodyText": "Why creating it at all if shutdown is set. Can you just add it to the outer if as '&& !shutDown'", "author": "baldersheim", "createdAt": "2020-09-21T09:50:38Z", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)", "originalCommit": "86157db42aab6749f62104ff0660b66ce4a649ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMTg4Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491921887", "bodyText": "Then you'd return null. I thought it better to preserve the existing error message you'd get when trying to use a shut down document access.", "author": "jonmv", "createdAt": "2020-09-21T09:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjE0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491922141", "bodyText": "Alternatively could throw something custom that was clear on this.", "author": "jonmv", "createdAt": "2020-09-21T09:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMDYyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491930629", "bodyText": "Throw instead, no point in constructing mbus access and shut it down just to preserve error message in this case.\nThis should never happen, but throwing is probably a good idea.", "author": "baldersheim", "createdAt": "2020-09-21T10:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk0MDAyNg==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491940026", "bodyText": "Can do. 'twas my first impulse as well. And, yes, this should never happen, unless someone breaks DI.", "author": "jonmv", "createdAt": "2020-09-21T10:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxODEyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4MzYxOA==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491983618", "bodyText": "IMHO, throwing an exception for duplicate calls to deconstruct() is ok - it should not happen. This is too defensive.", "author": "bjorncs", "createdAt": "2020-09-21T11:53:08Z", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {\n+        this.documentmanagerConfig = documentmanagerConfig;\n+        this.loadTypeConfig = loadTypeConfig;\n+    }\n+\n+    @Override\n+    public DocumentAccess get() {\n+        synchronized (monitor) {\n+            if (access == null) {\n+                access = new MessageBusDocumentAccess((MessageBusParams) new MessageBusParams(new LoadTypeSet(loadTypeConfig)).setDocumentmanagerConfig(documentmanagerConfig));\n+                if (shutDown)\n+                    access.shutdown();\n+            }\n+            return access;\n+        }\n+    }\n+\n+    @Override\n+    public void deconstruct() {\n+        synchronized (monitor) {\n+            if ( ! shutDown) {", "originalCommit": "af3afdb3d165df39d4548406553e4f0adee591c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjM5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986397", "bodyText": "Is this config available for all types of container clusters (e.g clustercontroller, metricsproxy, logserver)?", "author": "bjorncs", "createdAt": "2020-09-21T11:56:14Z", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/MessageBusDocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.container.core.documentapi;\n+\n+import com.google.inject.Inject;\n+import com.yahoo.component.AbstractComponent;\n+import com.yahoo.container.di.componentgraph.Provider;\n+import com.yahoo.document.config.DocumentmanagerConfig;\n+import com.yahoo.documentapi.DocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n+import com.yahoo.documentapi.messagebus.MessageBusParams;\n+import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.vespa.config.content.LoadTypeConfig;\n+\n+/**\n+ * Has a lazily populated reference to a {@link MessageBusDocumentAccess}.\n+ *\n+ * @author jonmv\n+ */\n+public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+\n+    private final DocumentmanagerConfig documentmanagerConfig;\n+    private final LoadTypeConfig loadTypeConfig;\n+    private final Object monitor = new Object();\n+    private boolean shutDown = false;\n+    private DocumentAccess access = null;\n+\n+    @Inject\n+    public MessageBusDocumentAccessProvider(DocumentmanagerConfig documentmanagerConfig, LoadTypeConfig loadTypeConfig) {", "originalCommit": "af3afdb3d165df39d4548406553e4f0adee591c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYyMA==", "url": "https://github.com/vespa-engine/vespa/pull/14461#discussion_r491986620", "bodyText": "Should this component be available for non-application-container-clusters?", "author": "bjorncs", "createdAt": "2020-09-21T11:56:41Z", "path": "config-model/src/main/java/com/yahoo/vespa/model/container/ContainerCluster.java", "diffHunk": "@@ -181,6 +181,7 @@ public ContainerCluster(AbstractConfigProducer<?> parent, String subId, String n\n         addSimpleComponent(com.yahoo.metrics.simple.jdisc.JdiscMetricsFactory.class.getName(), null, MetricProperties.BUNDLE_SYMBOLIC_NAME);\n         addSimpleComponent(\"com.yahoo.container.jdisc.state.StateMonitor\");\n         addSimpleComponent(\"com.yahoo.container.jdisc.ContainerThreadFactory\");\n+        addSimpleComponent(com.yahoo.container.core.documentapi.MessageBusDocumentAccessProvider.class.getName());", "originalCommit": "af3afdb3d165df39d4548406553e4f0adee591c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}