{"pr_number": 15071, "pr_title": "Add \"documentType\" to \"documents_processed\" metric", "pr_createdAt": "2020-10-28T16:09:29Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15071", "timeline": [{"oid": "1f493d32ed2a20eb224db0101be7bad9debdfb83", "url": "https://github.com/vespa-engine/vespa/commit/1f493d32ed2a20eb224db0101be7bad9debdfb83", "message": "Add \"documentType\" to \"documents_processed\" metric", "committedDate": "2020-10-28T16:09:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3MzQ0NA==", "url": "https://github.com/vespa-engine/vespa/pull/15071#discussion_r513573444", "bodyText": "Should probably put this elsewhere.", "author": "jonmv", "createdAt": "2020-10-28T16:10:59Z", "path": "docproc/src/main/java/com/yahoo/docproc/jdisc/metric/MockMetric.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.docproc.jdisc.metric;\n+\n+import com.yahoo.jdisc.Metric;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Metric implementation for tests.\n+ *\n+ * @author jonmv\n+ */\n+public class MockMetric implements Metric {", "originalCommit": "1f493d32ed2a20eb224db0101be7bad9debdfb83", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45e4edf81bc1987d8b8d7e1e806b6d26fd329940", "chunk": "diff --git a/docproc/src/main/java/com/yahoo/docproc/jdisc/metric/MockMetric.java b/jdisc_core/src/main/java/com/yahoo/jdisc/test/MockMetric.java\nsimilarity index 97%\nrename from docproc/src/main/java/com/yahoo/docproc/jdisc/metric/MockMetric.java\nrename to jdisc_core/src/main/java/com/yahoo/jdisc/test/MockMetric.java\nindex a3cdd7d339..cce082aeb1 100644\n--- a/docproc/src/main/java/com/yahoo/docproc/jdisc/metric/MockMetric.java\n+++ b/jdisc_core/src/main/java/com/yahoo/jdisc/test/MockMetric.java\n\n@@ -1,5 +1,5 @@\n // Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n-package com.yahoo.docproc.jdisc.metric;\n+package com.yahoo.jdisc.test;\n \n import com.yahoo.jdisc.Metric;\n \n"}}, {"oid": "45e4edf81bc1987d8b8d7e1e806b6d26fd329940", "url": "https://github.com/vespa-engine/vespa/commit/45e4edf81bc1987d8b8d7e1e806b6d26fd329940", "message": "Move MockMetric to jdisc_core test package", "committedDate": "2020-10-28T16:13:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3OTcyNA==", "url": "https://github.com/vespa-engine/vespa/pull/15071#discussion_r513579724", "bodyText": "In all backend metrics this dimension is named \"documenttype\". We should use the same her I guess.", "author": "geirst", "createdAt": "2020-10-28T16:19:19Z", "path": "docproc/src/main/java/com/yahoo/docproc/DocprocExecutor.java", "diffHunk": "@@ -176,4 +181,15 @@ private void logProgress(Processing processing, DocumentProcessor.Progress progr\n         }\n         return progress;\n     }\n+\n+    private Function<String, Metric.Context> cachedContexts(String chainDimension) {\n+        Map<String, Metric.Context> contextCache = new ConcurrentHashMap<>();\n+        return documentType -> contextCache.computeIfAbsent(documentType, type -> {\n+            Map<String, String> dimensions = new HashMap<>(2);\n+            dimensions.put(\"chain\", chainDimension);\n+            dimensions.put(\"documentType\", type);", "originalCommit": "45e4edf81bc1987d8b8d7e1e806b6d26fd329940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzMDAxNw==", "url": "https://github.com/vespa-engine/vespa/pull/15071#discussion_r513630017", "bodyText": "Geir is correct. The dimension name must be exactly \"documenttype\", or it cannot be used in combination with other metrics. The option would likely be to replicated \"documenttype\" into \"documentType\" for all other metrics having this already, if we conclude \"documentType\" is the better name.", "author": "yngveaasheim", "createdAt": "2020-10-28T17:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3OTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1ODUxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/15071#discussion_r513658511", "bodyText": "Thanhks.", "author": "jonmv", "createdAt": "2020-10-28T18:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3OTcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "5cf9a45e59dcbf96eeda0c37d27b282e953bea66", "chunk": "diff --git a/docproc/src/main/java/com/yahoo/docproc/DocprocExecutor.java b/docproc/src/main/java/com/yahoo/docproc/DocprocExecutor.java\nindex 0882de890a..d0334af857 100644\n--- a/docproc/src/main/java/com/yahoo/docproc/DocprocExecutor.java\n+++ b/docproc/src/main/java/com/yahoo/docproc/DocprocExecutor.java\n\n@@ -187,7 +187,7 @@ public class DocprocExecutor {\n         return documentType -> contextCache.computeIfAbsent(documentType, type -> {\n             Map<String, String> dimensions = new HashMap<>(2);\n             dimensions.put(\"chain\", chainDimension);\n-            dimensions.put(\"documentType\", type);\n+            dimensions.put(\"documenttype\", type);\n             return metric.createContext(dimensions);\n         });\n     }\n"}}, {"oid": "5cf9a45e59dcbf96eeda0c37d27b282e953bea66", "url": "https://github.com/vespa-engine/vespa/commit/5cf9a45e59dcbf96eeda0c37d27b282e953bea66", "message": "Use \"documenttype\" as elsewhere", "committedDate": "2020-10-28T18:09:06Z", "type": "commit"}, {"oid": "a9c8188ae74553255f0f232a06c22a19985d9273", "url": "https://github.com/vespa-engine/vespa/commit/a9c8188ae74553255f0f232a06c22a19985d9273", "message": "Defensively copy given properties in MockMetric", "committedDate": "2020-10-28T18:13:35Z", "type": "commit"}]}