{"pr_number": 15556, "pr_title": "Fix reconfiguration", "pr_createdAt": "2020-12-01T09:54:54Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15556", "timeline": [{"oid": "e4d0d2c6a9a1334eca85b48ac64fccca0e995a87", "url": "https://github.com/vespa-engine/vespa/commit/e4d0d2c6a9a1334eca85b48ac64fccca0e995a87", "message": "Use correct variable when calling reconfigure()", "committedDate": "2020-12-01T09:52:08Z", "type": "commit"}, {"oid": "dd75f7ebef2b3a02ad264957d3e364910a4c72c5", "url": "https://github.com/vespa-engine/vespa/commit/dd75f7ebef2b3a02ad264957d3e364910a4c72c5", "message": "More testing of reconfiguration", "committedDate": "2020-12-01T09:54:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2NjIxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15556#discussion_r533266219", "bodyText": "Is this ever updated? Looks like it's only set when starting the server, so shouldReconfigure is always comparing the new config to the first config it received, not the current.", "author": "mpolden", "createdAt": "2020-12-01T10:06:54Z", "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -88,10 +83,48 @@ private String connectionSpec(ZookeeperServerConfig config) {\n         return String.join(\",\", servers(config));\n     }\n \n-    private List<String> servers(ZookeeperServerConfig config) {\n+    private static List<String> servers(ZookeeperServerConfig config) {\n         return config.server().stream()\n                 .map(server -> server.hostname() + \":\" + server.quorumPort() + \":\" + server.electionPort())\n                 .collect(Collectors.toList());\n     }\n \n+    ZookeeperServerConfig existingConfig() {\n+        return zooKeeperRunner.zookeeperServerConfig();", "originalCommit": "dd75f7ebef2b3a02ad264957d3e364910a4c72c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2OTgyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/15556#discussion_r533269821", "bodyText": "You are right, that's wrong.", "author": "hmusum", "createdAt": "2020-12-01T10:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2NjIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "bc5fd832bf41f2f7ea3c1040da23e95ce5c5652e", "chunk": "diff --git a/zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java b/zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java\nindex b92d49e259..5f945b5ea1 100644\n--- a/zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java\n+++ b/zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java\n\n@@ -90,7 +93,7 @@ public class Reconfigurer extends AbstractComponent {\n     }\n \n     ZookeeperServerConfig existingConfig() {\n-        return zooKeeperRunner.zookeeperServerConfig();\n+        return zookeeperServerConfig;\n     }\n \n     static class ReconfigurationInfo {\n"}}, {"oid": "bc5fd832bf41f2f7ea3c1040da23e95ce5c5652e", "url": "https://github.com/vespa-engine/vespa/commit/bc5fd832bf41f2f7ea3c1040da23e95ce5c5652e", "message": "Keep track of config in use", "committedDate": "2020-12-01T10:15:23Z", "type": "commit"}]}