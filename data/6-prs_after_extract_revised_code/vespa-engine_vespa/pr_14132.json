{"pr_number": 14132, "pr_title": "Call deconstruct in reverse dependency order", "pr_createdAt": "2020-08-21T15:42:25Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14132", "timeline": [{"oid": "dbcc9107e3ae49e61270e002e241d9a07864facd", "url": "https://github.com/vespa-engine/vespa/commit/dbcc9107e3ae49e61270e002e241d9a07864facd", "message": "Call deconstruct in reverse dependency order", "committedDate": "2020-08-21T15:41:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNTc3OA==", "url": "https://github.com/vespa-engine/vespa/pull/14132#discussion_r474835778", "bodyText": "Should this be outerComponent.inject(middleComponent); ?", "author": "bratseth", "createdAt": "2020-08-21T17:37:09Z", "path": "container-di/src/test/java/com/yahoo/container/di/componentgraph/core/ComponentGraphTest.java", "diffHunk": "@@ -86,6 +87,28 @@ public void component_taking_config_can_be_instantiated() {\n         assertThat(instance.config.stringVal(), is(\"test-value\"));\n     }\n \n+    @Test\n+    public void all_created_components_are_returned_in_reverse_topological_order() {\n+        Node innerComponent = mockComponentNode(SimpleComponent.class);\n+        Node middleComponent = mockComponentNode(ComponentTakingComponent.class);\n+        Node outerComponent = mockComponentNode(ComponentTakingComponentTakingComponent.class);\n+        middleComponent.inject(innerComponent);\n+        outerComponent.inject(innerComponent);", "originalCommit": "dbcc9107e3ae49e61270e002e241d9a07864facd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1OTAxNg==", "url": "https://github.com/vespa-engine/vespa/pull/14132#discussion_r475059016", "bodyText": "Yes, it should. Not sure it changes anything, and no idea why it's allowed, though :) Perhaps this isn't needed at all for the unit test.", "author": "jonmv", "createdAt": "2020-08-22T07:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1OTA2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14132#discussion_r475059063", "bodyText": "Also, the test should probably run lots of times, to catch the 1/6 false positives each time. With randomised operation order before verification.", "author": "jonmv", "createdAt": "2020-08-22T07:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNTc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "4212668752b756ae73216f900cc7a25544338325", "chunk": "diff --git a/container-di/src/test/java/com/yahoo/container/di/componentgraph/core/ComponentGraphTest.java b/container-di/src/test/java/com/yahoo/container/di/componentgraph/core/ComponentGraphTest.java\nindex 2a30d71c33..70dc4c8665 100644\n--- a/container-di/src/test/java/com/yahoo/container/di/componentgraph/core/ComponentGraphTest.java\n+++ b/container-di/src/test/java/com/yahoo/container/di/componentgraph/core/ComponentGraphTest.java\n\n@@ -89,24 +89,24 @@ public class ComponentGraphTest {\n \n     @Test\n     public void all_created_components_are_returned_in_reverse_topological_order() {\n-        Node innerComponent = mockComponentNode(SimpleComponent.class);\n-        Node middleComponent = mockComponentNode(ComponentTakingComponent.class);\n-        Node outerComponent = mockComponentNode(ComponentTakingComponentTakingComponent.class);\n-        middleComponent.inject(innerComponent);\n-        outerComponent.inject(innerComponent);\n-\n-        ComponentGraph componentGraph = new ComponentGraph();\n-        componentGraph.add(innerComponent);\n-        componentGraph.add(middleComponent);\n-        componentGraph.add(outerComponent);\n-        componentGraph.complete();\n+        for (int i = 0; i < 10; i++) {\n+            Node innerComponent = mockComponentNode(SimpleComponent.class);\n+            Node middleComponent = mockComponentNode(ComponentTakingComponent.class);\n+            Node outerComponent = mockComponentNode(ComponentTakingComponentTakingComponent.class);\n+\n+            ComponentGraph componentGraph = new ComponentGraph();\n+            componentGraph.add(innerComponent);\n+            componentGraph.add(middleComponent);\n+            componentGraph.add(outerComponent);\n+            componentGraph.complete();\n \n-        innerComponent.constructInstance();\n-        middleComponent.constructInstance();\n-        outerComponent.constructInstance();\n+            innerComponent.constructInstance();\n+            middleComponent.constructInstance();\n+            outerComponent.constructInstance();\n \n-        assertEquals(List.of(outerComponent.constructedInstance().get(), middleComponent.constructedInstance().get(), innerComponent.constructedInstance().get()),\n-                     componentGraph.allConstructedComponentsAndProviders());\n+            assertEquals(List.of(outerComponent.constructedInstance().get(), middleComponent.constructedInstance().get(), innerComponent.constructedInstance().get()),\n+                         componentGraph.allConstructedComponentsAndProviders());\n+        }\n     }\n \n     @Test\n"}}, {"oid": "4212668752b756ae73216f900cc7a25544338325", "url": "https://github.com/vespa-engine/vespa/commit/4212668752b756ae73216f900cc7a25544338325", "message": "Remove unneeded inject statements and rerun test a few times", "committedDate": "2020-08-24T05:55:53Z", "type": "commit"}]}