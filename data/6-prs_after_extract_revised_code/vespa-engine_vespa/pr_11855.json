{"pr_number": 11855, "pr_title": "Jvenstad/optional submission data", "pr_createdAt": "2020-01-20T11:51:18Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11855", "timeline": [{"oid": "115a3b242be1e6043d927bcd7570de5c6efefa44", "url": "https://github.com/vespa-engine/vespa/commit/115a3b242be1e6043d927bcd7570de5c6efefa44", "message": "Make mojo send only specified data, and make it all optional", "committedDate": "2020-01-20T11:07:11Z", "type": "commit"}, {"oid": "5f4ca0aab540012fb02326fd597207c2a181add6", "url": "https://github.com/vespa-engine/vespa/commit/5f4ca0aab540012fb02326fd597207c2a181add6", "message": "Make ApplicationVersion id depend on number and commit, and make revision optional", "committedDate": "2020-01-20T11:50:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUwOTIwMw==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368509203", "bodyText": "\ud83d\udc4f", "author": "freva", "createdAt": "2020-01-20T11:54:18Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java", "diffHunk": "@@ -39,24 +40,22 @@\n     public ApplicationVersion(Optional<SourceRevision> source, OptionalLong buildNumber, Optional<String> authorEmail,\n                                Optional<Version> compileVersion, Optional<Instant> buildTime, Optional<String> sourceUrl,\n                                Optional<String> commit) {\n-        Objects.requireNonNull(source, \"source cannot be null\");\n-        Objects.requireNonNull(buildNumber, \"buildNumber cannot be null\");\n-        Objects.requireNonNull(authorEmail, \"author cannot be null\");\n-        if (source.isPresent() != buildNumber.isPresent()) {\n-            throw new IllegalArgumentException(\"both buildNumber and source must be set together\");\n-        }\n-        if (compileVersion.isPresent() != buildTime.isPresent()) {\n-            throw new IllegalArgumentException(\"both compileVersion and buildTime must be set together\");\n-        }\n-        if (buildNumber.isPresent() && buildNumber.getAsLong() <= 0) {\n-            throw new IllegalArgumentException(\"buildNumber must be > 0\");\n-        }\n-        if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\")) {\n+        if (buildNumber.isEmpty() && (   source.isPresent() || authorEmail.isPresent() || compileVersion.isPresent()\n+                                      || buildTime.isPresent() || sourceUrl.isPresent() || commit.isPresent()))\n+            throw new IllegalArgumentException(\"Build number must be present if any other attribute is\");\n+\n+        if (buildNumber.isPresent() && buildNumber.getAsLong() <= 0)\n+            throw new IllegalArgumentException(\"Build number must be > 0\");\n+\n+        if (commit.isPresent() && commit.get().length() > 128)\n+            throw new IllegalArgumentException(\"Commit may not be longer than 128 characters\");", "originalCommit": "5f4ca0aab540012fb02326fd597207c2a181add6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bce0531c3f7679a4176a892608a9f77b31f9848d", "chunk": "diff --git a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\nindex 9c024d3245..685eed2269 100644\n--- a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n+++ b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n\n@@ -50,6 +51,8 @@ public class ApplicationVersion implements Comparable<ApplicationVersion> {\n         if (commit.isPresent() && commit.get().length() > 128)\n             throw new IllegalArgumentException(\"Commit may not be longer than 128 characters\");\n \n+        sourceUrl.map(URI::create);\n+\n         if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\"))\n             throw new IllegalArgumentException(\"Invalid author email '\" + authorEmail.get() + \"'.\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368511134", "bodyText": "When can buildNumber be empty?", "author": "freva", "createdAt": "2020-01-20T11:59:12Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java", "diffHunk": "@@ -39,24 +40,22 @@\n     public ApplicationVersion(Optional<SourceRevision> source, OptionalLong buildNumber, Optional<String> authorEmail,\n                                Optional<Version> compileVersion, Optional<Instant> buildTime, Optional<String> sourceUrl,\n                                Optional<String> commit) {\n-        Objects.requireNonNull(source, \"source cannot be null\");\n-        Objects.requireNonNull(buildNumber, \"buildNumber cannot be null\");\n-        Objects.requireNonNull(authorEmail, \"author cannot be null\");\n-        if (source.isPresent() != buildNumber.isPresent()) {\n-            throw new IllegalArgumentException(\"both buildNumber and source must be set together\");\n-        }\n-        if (compileVersion.isPresent() != buildTime.isPresent()) {\n-            throw new IllegalArgumentException(\"both compileVersion and buildTime must be set together\");\n-        }\n-        if (buildNumber.isPresent() && buildNumber.getAsLong() <= 0) {\n-            throw new IllegalArgumentException(\"buildNumber must be > 0\");\n-        }\n-        if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\")) {\n+        if (buildNumber.isEmpty() && (   source.isPresent() || authorEmail.isPresent() || compileVersion.isPresent()", "originalCommit": "5f4ca0aab540012fb02326fd597207c2a181add6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMzA1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368513059", "bodyText": "ApplicationVersion.empty.", "author": "jonmv", "createdAt": "2020-01-20T12:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxNDMzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368514335", "bodyText": "But is it only used internally or is it possible to get this as response to some job? (I know that at least in the past deployments to dev did not have build number)", "author": "freva", "createdAt": "2020-01-20T12:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxNjYwNA==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368516604", "bodyText": "They explicitly use the empty one.", "author": "jonmv", "createdAt": "2020-01-20T12:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxNzA5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368517097", "bodyText": ":(", "author": "freva", "createdAt": "2020-01-20T12:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyMDgxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368520819", "bodyText": "Why sad face?", "author": "jonmv", "createdAt": "2020-01-20T12:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyMzM1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368523359", "bodyText": "Would be nice to have something we can use to consistently refer to builds in console", "author": "freva", "createdAt": "2020-01-20T12:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "bce0531c3f7679a4176a892608a9f77b31f9848d", "chunk": "diff --git a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\nindex 9c024d3245..685eed2269 100644\n--- a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n+++ b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n\n@@ -50,6 +51,8 @@ public class ApplicationVersion implements Comparable<ApplicationVersion> {\n         if (commit.isPresent() && commit.get().length() > 128)\n             throw new IllegalArgumentException(\"Commit may not be longer than 128 characters\");\n \n+        sourceUrl.map(URI::create);\n+\n         if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\"))\n             throw new IllegalArgumentException(\"Invalid author email '\" + authorEmail.get() + \"'.\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTQxOA==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368511418", "bodyText": "Validate URL somewhere?", "author": "freva", "createdAt": "2020-01-20T11:59:58Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java", "diffHunk": "@@ -39,24 +40,22 @@\n     public ApplicationVersion(Optional<SourceRevision> source, OptionalLong buildNumber, Optional<String> authorEmail,\n                                Optional<Version> compileVersion, Optional<Instant> buildTime, Optional<String> sourceUrl,\n                                Optional<String> commit) {\n-        Objects.requireNonNull(source, \"source cannot be null\");\n-        Objects.requireNonNull(buildNumber, \"buildNumber cannot be null\");\n-        Objects.requireNonNull(authorEmail, \"author cannot be null\");\n-        if (source.isPresent() != buildNumber.isPresent()) {\n-            throw new IllegalArgumentException(\"both buildNumber and source must be set together\");\n-        }\n-        if (compileVersion.isPresent() != buildTime.isPresent()) {\n-            throw new IllegalArgumentException(\"both compileVersion and buildTime must be set together\");\n-        }\n-        if (buildNumber.isPresent() && buildNumber.getAsLong() <= 0) {\n-            throw new IllegalArgumentException(\"buildNumber must be > 0\");\n-        }\n-        if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\")) {\n+        if (buildNumber.isEmpty() && (   source.isPresent() || authorEmail.isPresent() || compileVersion.isPresent()\n+                                      || buildTime.isPresent() || sourceUrl.isPresent() || commit.isPresent()))\n+            throw new IllegalArgumentException(\"Build number must be present if any other attribute is\");\n+\n+        if (buildNumber.isPresent() && buildNumber.getAsLong() <= 0)\n+            throw new IllegalArgumentException(\"Build number must be > 0\");\n+\n+        if (commit.isPresent() && commit.get().length() > 128)", "originalCommit": "5f4ca0aab540012fb02326fd597207c2a181add6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMzU3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368513571", "bodyText": "Hmm... Yes, for the explicitly passed sourceUrl, I guess that makes sense. I don't dare do it for the generated ones :)", "author": "jonmv", "createdAt": "2020-01-20T12:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxNzM4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11855#discussion_r368517389", "bodyText": "URI.create() is a start, but unfortunately it allows relative URLs or just the path component", "author": "freva", "createdAt": "2020-01-20T12:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxMTQxOA=="}], "type": "inlineReview", "revised_code": {"commit": "bce0531c3f7679a4176a892608a9f77b31f9848d", "chunk": "diff --git a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\nindex 9c024d3245..685eed2269 100644\n--- a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n+++ b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/ApplicationVersion.java\n\n@@ -50,6 +51,8 @@ public class ApplicationVersion implements Comparable<ApplicationVersion> {\n         if (commit.isPresent() && commit.get().length() > 128)\n             throw new IllegalArgumentException(\"Commit may not be longer than 128 characters\");\n \n+        sourceUrl.map(URI::create);\n+\n         if (authorEmail.isPresent() && ! authorEmail.get().matches(\"[^@]+@[^@]+\"))\n             throw new IllegalArgumentException(\"Invalid author email '\" + authorEmail.get() + \"'.\");\n \n"}}, {"oid": "bce0531c3f7679a4176a892608a9f77b31f9848d", "url": "https://github.com/vespa-engine/vespa/commit/bce0531c3f7679a4176a892608a9f77b31f9848d", "message": "Validate sourceUrl parameters", "committedDate": "2020-01-20T12:10:24Z", "type": "commit"}]}