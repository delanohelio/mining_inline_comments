{"pr_number": 11814, "pr_title": "Refuse to start container if resolved IP address does not match node-repo IP", "pr_createdAt": "2020-01-16T13:36:20Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11814", "timeline": [{"oid": "e768afe1c72d2ed165224f62f3f76012d6f09ede", "url": "https://github.com/vespa-engine/vespa/commit/e768afe1c72d2ed165224f62f3f76012d6f09ede", "message": "Return CommandResult from DockerOperations::executeCommandInNetworkNamespace", "committedDate": "2020-01-16T13:14:10Z", "type": "commit"}, {"oid": "91369adf8f525d96c2a03821a44e1487fdee2b22", "url": "https://github.com/vespa-engine/vespa/commit/91369adf8f525d96c2a03821a44e1487fdee2b22", "message": "Fail if IP address from node-repo does not match the resolved IP address if feature flag i set", "committedDate": "2020-01-16T13:23:10Z", "type": "commit"}, {"oid": "3f16a26ec4a8893ab4d01b6c6e232c8585f25f2f", "url": "https://github.com/vespa-engine/vespa/commit/3f16a26ec4a8893ab4d01b6c6e232c8585f25f2f", "message": "Throw ConvergenceException instead", "committedDate": "2020-01-16T13:28:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MzE3MA==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367463170", "bodyText": "Btw I think Optional.toString() works fine too (leaving out orElse()).", "author": "hakonhall", "createdAt": "2020-01-16T14:55:49Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/docker/DockerOperationsImpl.java", "diffHunk": "@@ -120,10 +125,24 @@ public void createContainer(NodeAgentContext context, ContainerData containerDat\n         command.create();\n     }\n \n+    private static void assertEqualIpAddresses(HostName hostName, Optional<? extends InetAddress> resolvedAddress,\n+                                               Set<String> nrAddresses, IPVersion ipVersion) {\n+        Optional<InetAddress> nrAddress = nrAddresses.stream()\n+                .map(InetAddresses::forString)\n+                .filter(ipVersion::match)\n+                .findFirst();\n+        if (resolvedAddress.equals(nrAddress)) return;\n+\n+        throw new ConvergenceException(String.format(\n+                \"IP address (%s) resolved from %s  does not match IP address (%s) in node-repo\",\n+                resolvedAddress.map(InetAddresses::toAddrString).orElse(\"[none]\"), hostName,", "originalCommit": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDE0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367464142", "bodyText": "I'd vote for execute() instead of executeSilently().", "author": "hakonhall", "createdAt": "2020-01-16T14:57:28Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/docker/DockerOperationsImpl.java", "diffHunk": "@@ -193,31 +212,17 @@ public ProcessResult executeCommandInContainerAsRoot(NodeAgentContext context, S\n     }\n \n     @Override\n-    public ProcessResult executeCommandInNetworkNamespace(NodeAgentContext context, String... command) {\n+    public CommandResult executeCommandInNetworkNamespace(NodeAgentContext context, String... command) {\n         int containerPid = docker.getContainer(context.containerName())\n                 .filter(container -> container.state.isRunning())\n                 .orElseThrow(() -> new RuntimeException(\n                         \"Found no running container named \" + context.containerName().asString()))\n                 .pid;\n \n-        String[] wrappedCommand = Stream.concat(Stream.of(\"nsenter\",\n-                                                          String.format(\"--net=/proc/%d/ns/net\", containerPid),\n-                                                          \"--\"),\n-                                                Stream.of(command))\n-                                        .toArray(String[]::new);\n-\n-        try {\n-            Pair<Integer, String> result = processExecuter.exec(wrappedCommand);\n-            if (result.getFirst() != 0) {\n-                throw new RuntimeException(String.format(\n-                        \"Failed to execute %s in network namespace for %s (PID = %d), exit code: %d, output: %s\",\n-                        Arrays.toString(wrappedCommand), context.containerName().asString(), containerPid, result.getFirst(), result.getSecond()));\n-            }\n-            return new ProcessResult(0, result.getSecond(), \"\");\n-        } catch (IOException e) {\n-            throw new RuntimeException(String.format(\"IOException while executing %s in network namespace for %s (PID = %d)\",\n-                    Arrays.toString(wrappedCommand), context.containerName().asString(), containerPid), e);\n-        }\n+        return terminal.newCommandLine(context)\n+                .add(\"nsenter\", String.format(\"--net=/proc/%d/ns/net\", containerPid), \"--\")\n+                .add(command)\n+                .executeSilently();", "originalCommit": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MjAyNA==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367472024", "bodyText": "Not really practical at this level - this method is executed every tick to for example list the current rules to see if a modification is needed.", "author": "freva", "createdAt": "2020-01-16T15:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ4ODA0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367488046", "bodyText": "got it", "author": "hakonhall", "createdAt": "2020-01-16T15:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDE0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2NDkzOA==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367464938", "bodyText": "nice", "author": "hakonhall", "createdAt": "2020-01-16T14:58:44Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/maintenance/acl/AclMaintainer.java", "diffHunk": "@@ -88,13 +85,9 @@ private boolean edit(NodeAgentContext context, String table, IPVersion ipVersion\n     }\n \n     private Supplier<List<String>> listTable(NodeAgentContext context, String table, IPVersion ipVersion) {\n-        return () -> {\n-            ProcessResult currentRulesResult =\n-                    dockerOperations.executeCommandInNetworkNamespace(context, ipVersion.iptablesCmd(), \"-S\", \"-t\", table);\n-            return Arrays.stream(currentRulesResult.getOutput().split(\"\\n\"))\n-                    .map(String::trim)\n-                    .collect(Collectors.toList());\n-        };\n+        return () -> dockerOperations\n+                .executeCommandInNetworkNamespace(context, ipVersion.iptablesCmd(), \"-S\", \"-t\", table)\n+                .mapEachLine(String::trim);", "originalCommit": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2OTAyNg==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367469026", "bodyText": "Why not use TestTerminal?", "author": "hakonhall", "createdAt": "2020-01-16T15:05:42Z", "path": "node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/integrationTests/DockerTester.java", "diffHunk": "@@ -75,8 +74,7 @@\n         ipAddresses.addAddress(HOST_HOSTNAME.value(), \"f000::\");\n         for (int i = 1; i < 4; i++) ipAddresses.addAddress(\"host\" + i + \".test.yahoo.com\", \"f000::\" + i);\n \n-        ProcessExecuter processExecuter = mock(ProcessExecuter.class);\n-        uncheck(() -> when(processExecuter.exec(any(String[].class))).thenReturn(new Pair<>(0, \"\")));\n+        TerminalImpl terminal = new TerminalImpl(command -> new TestChildProcess2(0, \"\"));", "originalCommit": "9a87e61b9806e79ab5669b2a126ba0d0960a7c15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MTAxNQ==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367471015", "bodyText": "This is basically \"integration test\" for node-admin: it runs the entire node-admin, starts multiple containers which run regular ticks. There is no way to list all the expected commands here...", "author": "freva", "createdAt": "2020-01-16T15:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2OTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ4Nzc5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11814#discussion_r367487792", "bodyText": "Yes, TestTerminal needs a method that returns a given exit code & response forever. If it's non-trivial it's OK to leave as-is.", "author": "hakonhall", "createdAt": "2020-01-16T15:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2OTAyNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "8b3dc39da9b25413d72eca88a78a70981017ec0e", "url": "https://github.com/vespa-engine/vespa/commit/8b3dc39da9b25413d72eca88a78a70981017ec0e", "message": "Merge branch 'master' into freva/fallback-to-node-repo-address\n\n# Conflicts:\n#\tflags/src/main/java/com/yahoo/vespa/flags/Flags.java", "committedDate": "2020-01-16T15:27:35Z", "type": "commit"}, {"oid": "8b3dc39da9b25413d72eca88a78a70981017ec0e", "url": "https://github.com/vespa-engine/vespa/commit/8b3dc39da9b25413d72eca88a78a70981017ec0e", "message": "Merge branch 'master' into freva/fallback-to-node-repo-address\n\n# Conflicts:\n#\tflags/src/main/java/com/yahoo/vespa/flags/Flags.java", "committedDate": "2020-01-16T15:27:35Z", "type": "forcePushed"}]}