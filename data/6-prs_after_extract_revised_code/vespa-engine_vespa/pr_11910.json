{"pr_number": 11910, "pr_title": "Since-timestamp on Orc suspended status", "pr_createdAt": "2020-01-23T16:04:08Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11910", "timeline": [{"oid": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "url": "https://github.com/vespa-engine/vespa/commit/967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "message": "Since-timestamp on Orc suspended status\n\n - Introduce a new type of suspension status: PERMANENTLY_DOWN, which\n   is set when a node is scheduled to be removed from the application.\n   A normal resume call will NOT clear PERMANENTLY_DOWN.\n - Store a JSON for each suspended host: Contains status, and a since timestamp\n   for the time when the node was suspended. The suspension timestamp\n   is preserved when switching statuses between suspension statuses.\n - The JSON is stored in a new path, void of any zone. This means that\n   we eventually can get rid of the zone-part of the application instance\n   reference.", "committedDate": "2020-01-23T15:58:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNTQ1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370525452", "bodyText": "Can be removed", "author": "freva", "createdAt": "2020-01-24T08:52:25Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -45,7 +48,7 @@\n     final static String HOST_STATUS_CACHE_COUNTER_PATH = \"/vespa/host-status-service-cache-counter\";", "originalCommit": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU0NTU4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370545589", "bodyText": "Done", "author": "hakonhall", "createdAt": "2020-01-24T09:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNTQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c62e3b2e96d565cb2c785661e1899a9e62556163", "chunk": "diff --git a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\nindex ca6f3c524a..ecf3a161c8 100644\n--- a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\n+++ b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\n\n@@ -45,7 +45,6 @@ public class ZookeeperStatusService implements StatusService {\n \n     final static String HOST_STATUS_BASE_PATH = \"/vespa/host-status-service\";\n     final static String APPLICATION_STATUS_BASE_PATH = \"/vespa/application-status-service\";\n-    final static String HOST_STATUS_CACHE_COUNTER_PATH = \"/vespa/host-status-service-cache-counter\";\n \n     private final Curator curator;\n     private final HostInfosCache hostInfosCache;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMDIwMw==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370530203", "bodyText": "Filter for what's not already in hostInfos?", "author": "freva", "createdAt": "2020-01-24T09:05:16Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -247,6 +285,55 @@ public HostStatus getHostStatus(ApplicationInstanceReference applicationInstance\n         }\n     }\n \n+    /** Do not call this directly: should be called behind a cache. */\n+    private HostInfos getHostInfosFromZk(ApplicationInstanceReference application) {\n+        Map<HostName, HostInfo> hostInfos;\n+        String hostsRootPath = hostsPath(application);\n+        if (uncheck(() -> curator.framework().checkExists().forPath(hostsRootPath)) == null) {\n+            hostInfos = new HashMap<>();\n+        } else {\n+            List<String> hostnames = uncheck(() -> curator.framework().getChildren().forPath(hostsRootPath));\n+            hostInfos = new HashMap<>(hostnames.stream().collect(Collectors.toMap(\n+                    hostname -> new HostName(hostname),\n+                    hostname -> {\n+                        byte[] bytes = uncheck(() -> curator.framework().getData().forPath(hostsRootPath + \"/\" + hostname));\n+                        return WireHostInfo.deserialize(bytes);\n+                    })));\n+        }\n+\n+        // For backwards compatibility we'll add HostInfos from the old hosts-allowed-down ZK path,\n+        // using the creation time as the since path. The new hosts ZK path should contain a subset of\n+        // the hostnames under hosts-allowed-down ZK path. Eventually these sets should be identical.\n+        // Once that's true we can stop writing to hosts-allowed-down, remove this code, and all\n+        // data in hosts-allowed-down can be removed.\n+        Set<HostName> legacyHostsDown = hostsDownFor(application);\n+        Map<HostName, HostInfo> legacyHostInfos = legacyHostsDown.stream().collect(Collectors.toMap(", "originalCommit": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU0NjE5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370546197", "bodyText": "Done", "author": "hakonhall", "createdAt": "2020-01-24T09:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMDIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "c62e3b2e96d565cb2c785661e1899a9e62556163", "chunk": "diff --git a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\nindex ca6f3c524a..ecf3a161c8 100644\n--- a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\n+++ b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java\n\n@@ -307,7 +306,9 @@ public class ZookeeperStatusService implements StatusService {\n         // Once that's true we can stop writing to hosts-allowed-down, remove this code, and all\n         // data in hosts-allowed-down can be removed.\n         Set<HostName> legacyHostsDown = hostsDownFor(application);\n-        Map<HostName, HostInfo> legacyHostInfos = legacyHostsDown.stream().collect(Collectors.toMap(\n+        Map<HostName, HostInfo> legacyHostInfos = legacyHostsDown.stream()\n+                .filter(hostname -> !hostInfos.containsKey(hostname))\n+                .collect(Collectors.toMap(\n                 hostname -> hostname,\n                 hostname -> {\n                     Stat stat = uncheck(() -> curator.framework()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNTUyMg==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370535522", "bodyText": "Consider adding a method that returns true when the status is one of the down statuses to avoid doing != NO_REMARKS", "author": "freva", "createdAt": "2020-01-24T09:19:22Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java", "diffHunk": "@@ -2,11 +2,20 @@\n package com.yahoo.vespa.orchestrator.status;\n \n /**\n- * Enumeration of the different status' a host can have.\n+ * Enumeration of the different statuses a host can have.\n  *\n  * @author oyving\n  */\n public enum HostStatus {\n+    /** The services on the host is supposed to be up. */\n     NO_REMARKS,\n-    ALLOWED_TO_BE_DOWN;\n+\n+    /** The services on the host is allowed to be down. */\n+    ALLOWED_TO_BE_DOWN,", "originalCommit": "967fe4dd3f5a3e418b0dd6b2bcd06fe5fd460290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1MDE0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11910#discussion_r370550142", "bodyText": "Done", "author": "hakonhall", "createdAt": "2020-01-24T09:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNTUyMg=="}], "type": "inlineReview", "revised_code": {"commit": "c62e3b2e96d565cb2c785661e1899a9e62556163", "chunk": "diff --git a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java\nindex f23917042e..6764ffb48e 100644\n--- a/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java\n+++ b/orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/HostStatus.java\n\n@@ -8,14 +8,19 @@ package com.yahoo.vespa.orchestrator.status;\n  */\n public enum HostStatus {\n     /** The services on the host is supposed to be up. */\n-    NO_REMARKS,\n+    NO_REMARKS(false),\n \n     /** The services on the host is allowed to be down. */\n-    ALLOWED_TO_BE_DOWN,\n+    ALLOWED_TO_BE_DOWN(true),\n \n     /**\n      * Same as ALLOWED_TO_BE_DOWN, but in addition, it is expected\n      * the host may be removed from its application at any moment.\n      */\n-    PERMANENTLY_DOWN;\n+    PERMANENTLY_DOWN(true);\n+\n+    private final boolean suspended;\n+\n+    HostStatus(boolean suspended) { this.suspended = suspended; }\n+    public boolean isSuspended() { return suspended; }\n }\n"}}, {"oid": "c62e3b2e96d565cb2c785661e1899a9e62556163", "url": "https://github.com/vespa-engine/vespa/commit/c62e3b2e96d565cb2c785661e1899a9e62556163", "message": "Define suspended attribute on HostStatus, plus minor review fixes", "committedDate": "2020-01-24T10:05:19Z", "type": "commit"}]}