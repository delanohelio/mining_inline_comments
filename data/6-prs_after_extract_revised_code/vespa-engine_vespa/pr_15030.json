{"pr_number": 15030, "pr_title": "Fix corner case for system/staging test jobs", "pr_createdAt": "2020-10-26T08:33:45Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15030", "timeline": [{"oid": "76078e116c7e9a1932b7b3093373be2fed0098e7", "url": "https://github.com/vespa-engine/vespa/commit/76078e116c7e9a1932b7b3093373be2fed0098e7", "message": "Fix corner case for system/staging test jobs\n\nThis fixes a corner case where we compute versions to run in system and staging tests, where the first production deployment used to compute the versions has a newer platform that what we are deploying \u2014\u00a0this confused the algorithm into believing it needed both a run which was a success both on the deploying change, AND on the newer version, which is obviously impossible. When a newer version exists in the production deployment, this is now used instead of, not in addition to, the deploying change.", "committedDate": "2020-10-26T08:33:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5MDc0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15030#discussion_r511790746", "bodyText": "I think there's a better name to be found.", "author": "mpolden", "createdAt": "2020-10-26T08:35:57Z", "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentTriggerTest.java", "diffHunk": "@@ -1216,4 +1217,42 @@ public void testEagerTests() {\n         app.assertNotRunning(stagingTest);\n     }\n \n+    @Test\n+    public void test() {", "originalCommit": "76078e116c7e9a1932b7b3093373be2fed0098e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNjI1MA==", "url": "https://github.com/vespa-engine/vespa/pull/15030#discussion_r511806250", "bodyText": "\ud83d\ude02", "author": "jonmv", "createdAt": "2020-10-26T09:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5MDc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNjM3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15030#discussion_r511806372", "bodyText": "Had no idea what the problem was when I started writing the test ...", "author": "jonmv", "createdAt": "2020-10-26T09:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5MDc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNjcwMg==", "url": "https://github.com/vespa-engine/vespa/pull/15030#discussion_r511806702", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void test() {\n          \n          \n            \n                public void testTriggeringOfIdleTestJobsWhenFirstDeploymentIsOnNewerVersionThanChange() {", "author": "jonmv", "createdAt": "2020-10-26T09:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5MDc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNzc3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15030#discussion_r511807776", "bodyText": "Sounds familiar. \ud83d\ude42", "author": "mpolden", "createdAt": "2020-10-26T09:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5MDc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "41ba2d8a54a7997270e0eb2c20b841a36e9d80d7", "chunk": "diff --git a/controller-server/src/test/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentTriggerTest.java b/controller-server/src/test/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentTriggerTest.java\nindex e0241e9024..6e5a9ddc7a 100644\n--- a/controller-server/src/test/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentTriggerTest.java\n+++ b/controller-server/src/test/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentTriggerTest.java\n\n@@ -1218,7 +1218,7 @@ public class DeploymentTriggerTest {\n     }\n \n     @Test\n-    public void test() {\n+    public void testTriggeringOfIdleTestJobsWhenFirstDeploymentIsOnNewerVersionThanChange() {\n         ApplicationPackage applicationPackage = new ApplicationPackageBuilder().systemTest()\n                                                                                .stagingTest()\n                                                                                .region(\"us-east-3\")\n"}}, {"oid": "41ba2d8a54a7997270e0eb2c20b841a36e9d80d7", "url": "https://github.com/vespa-engine/vespa/commit/41ba2d8a54a7997270e0eb2c20b841a36e9d80d7", "message": "Rename test method", "committedDate": "2020-10-26T09:04:11Z", "type": "commit"}]}