{"pr_number": 15098, "pr_title": "Handle timeout units in doc/v1, and catch parse errors in handler", "pr_createdAt": "2020-10-29T18:42:58Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15098", "timeline": [{"oid": "50c1f916a1699daac57f35cbc0c37060d09aed54", "url": "https://github.com/vespa-engine/vespa/commit/50c1f916a1699daac57f35cbc0c37060d09aed54", "message": "Handle timeout units in doc/v1, and catch parse errors in handler", "committedDate": "2020-10-29T18:42:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTMzMQ==", "url": "https://github.com/vespa-engine/vespa/pull/15098#discussion_r514489331", "bodyText": "What about us and ns ?\nDon't we have som utility method for this ?", "author": "baldersheim", "createdAt": "2020-10-29T18:48:39Z", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java", "diffHunk": "@@ -113,7 +114,11 @@\n \n     private static final Logger log = Logger.getLogger(DocumentV1ApiHandler.class.getName());\n     private static final Parser<Integer> integerParser = Integer::parseInt;\n-    private static final Parser<Double> doubleParser = Double::parseDouble;\n+    private static final Parser<Double> timeoutParser = value -> {\n+        int suffixLength = value.endsWith(\"ms\") ? 2 : value.endsWith(\"s\") ? 1 : 0;", "originalCommit": "50c1f916a1699daac57f35cbc0c37060d09aed54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwMTQ3OA==", "url": "https://github.com/vespa-engine/vespa/pull/15098#discussion_r514501478", "bodyText": "It doesn't need to be an integer, do I don't see the need for other units. The search handler recognises ms, and treats everything else as s. I think this is strictly better.", "author": "jonmv", "createdAt": "2020-10-29T19:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwMzQzMw==", "url": "https://github.com/vespa-engine/vespa/pull/15098#discussion_r514503433", "bodyText": "Actually, it recognise ks and \u00b5s as well, which is just obscene. I found the code, which is split out somewhere, but it's in the search module.", "author": "jonmv", "createdAt": "2020-10-29T19:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwNTU5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15098#discussion_r514505596", "bodyText": "May as well use that code, then.", "author": "jonmv", "createdAt": "2020-10-29T19:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwNTg1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15098#discussion_r514505856", "bodyText": "(It was already a dependency of this module.)", "author": "jonmv", "createdAt": "2020-10-29T19:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTMzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "5b8f92a7e2ec58b5d227326488a4b4c3d3fda636", "chunk": "diff --git a/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java b/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java\nindex f9bb94b3cc..8287b6f163 100644\n--- a/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java\n+++ b/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java\n\n@@ -112,13 +112,11 @@ import static java.util.stream.Collectors.toUnmodifiableMap;\n  */\n public class DocumentV1ApiHandler extends AbstractRequestHandler {\n \n+    private static final Duration defaultTimeout = Duration.ofSeconds(175);\n+\n     private static final Logger log = Logger.getLogger(DocumentV1ApiHandler.class.getName());\n     private static final Parser<Integer> integerParser = Integer::parseInt;\n-    private static final Parser<Double> timeoutParser = value -> {\n-        int suffixLength = value.endsWith(\"ms\") ? 2 : value.endsWith(\"s\") ? 1 : 0;\n-        double factor = suffixLength == 2 ? 1e-3 : 1;\n-        return Double.parseDouble(value.substring(0, value.length() - suffixLength)) * factor;\n-    };\n+    private static final Parser<Long> timeoutMillisParser = value -> ParameterParser.asMilliSeconds(value, defaultTimeout.toMillis());\n     private static final Parser<Boolean> booleanParser = Boolean::parseBoolean;\n \n     private static final CompletionHandler logException = new CompletionHandler() {\n"}}, {"oid": "5b8f92a7e2ec58b5d227326488a4b4c3d3fda636", "url": "https://github.com/vespa-engine/vespa/commit/5b8f92a7e2ec58b5d227326488a4b4c3d3fda636", "message": "Use existing timeout parse code", "committedDate": "2020-10-29T19:15:54Z", "type": "commit"}]}