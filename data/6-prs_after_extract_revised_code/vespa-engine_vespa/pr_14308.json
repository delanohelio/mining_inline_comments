{"pr_number": 14308, "pr_title": " Move code from RemoteSession to SessionRepository, take 2", "pr_createdAt": "2020-09-07T12:25:54Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14308", "timeline": [{"oid": "d29de4a867577220a6afb838175fe73c39f1bccd", "url": "https://github.com/vespa-engine/vespa/commit/d29de4a867577220a6afb838175fe73c39f1bccd", "message": "Simplify and move in the direction of unifying remote and local sessions\nMove tests and avoid a lot of low-level setup code\n\nDo not use `synchronized` for ensureApplicationLoaded()", "committedDate": "2020-09-07T12:24:26Z", "type": "commit"}, {"oid": "f2f6dd4bcfe2f37656ed2b95336006ab42857d38", "url": "https://github.com/vespa-engine/vespa/commit/f2f6dd4bcfe2f37656ed2b95336006ab42857d38", "message": "Remove file added unintentionally", "committedDate": "2020-09-08T06:17:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NzU2Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14308#discussion_r484687566", "bodyText": "Sure this shouldn't be synchronized, but more fine-grained than on the session repository shared by all sessions?", "author": "jonmv", "createdAt": "2020-09-08T06:49:01Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -394,13 +402,84 @@ private void loadSessionIfActive(RemoteSession session) {\n         for (ApplicationId applicationId : applicationRepo.activeApplications()) {\n             if (applicationRepo.requireActiveSessionOf(applicationId) == session.getSessionId()) {\n                 log.log(Level.FINE, () -> \"Found active application for session \" + session.getSessionId() + \" , loading it\");\n-                applicationRepo.reloadConfig(session.ensureApplicationLoaded());\n+                applicationRepo.reloadConfig(ensureApplicationLoaded(session));\n                 log.log(Level.INFO, session.logPre() + \"Application activated successfully: \" + applicationId + \" (generation \" + session.getSessionId() + \")\");\n                 return;\n             }\n         }\n     }\n \n+    void prepareRemoteSession(RemoteSession session) {\n+        SessionZooKeeperClient sessionZooKeeperClient = createSessionZooKeeperClient(session.getSessionId());\n+        Curator.CompletionWaiter waiter = sessionZooKeeperClient.getPrepareWaiter();\n+        ensureApplicationLoaded(session);\n+        notifyCompletion(waiter, session);\n+    }\n+\n+    public ApplicationSet ensureApplicationLoaded(RemoteSession session) {\n+        Optional<ApplicationSet> applicationSet = session.applicationSet();\n+        if (applicationSet.isPresent()) {\n+            return applicationSet.get();\n+        }\n+\n+        ApplicationSet newApplicationSet = loadApplication(session);\n+        RemoteSession newSession = new RemoteSession(session.getTenantName(),\n+                                    session.getSessionId(),\n+                                    session.getSessionZooKeeperClient(),\n+                                    Optional.of(newApplicationSet));\n+        remoteSessionCache.putSession(newSession);", "originalCommit": "f2f6dd4bcfe2f37656ed2b95336006ab42857d38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc0MjM4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14308#discussion_r484742389", "bodyText": "Yes, I think you are right. Need to look into that.", "author": "hmusum", "createdAt": "2020-09-08T08:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NzU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ca25b29442cc8ec5955bea1b06f496c7b1c3be18", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\nindex d71b8f4d46..84379b629d 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n\n@@ -417,18 +417,13 @@ public class SessionRepository {\n     }\n \n     public ApplicationSet ensureApplicationLoaded(RemoteSession session) {\n-        Optional<ApplicationSet> applicationSet = session.applicationSet();\n-        if (applicationSet.isPresent()) {\n-            return applicationSet.get();\n+        if (session.applicationSet().isPresent()) {\n+            return session.applicationSet().get();\n         }\n \n-        ApplicationSet newApplicationSet = loadApplication(session);\n-        RemoteSession newSession = new RemoteSession(session.getTenantName(),\n-                                    session.getSessionId(),\n-                                    session.getSessionZooKeeperClient(),\n-                                    Optional.of(newApplicationSet));\n-        remoteSessionCache.putSession(newSession);\n-        return newApplicationSet;\n+        ApplicationSet applicationSet = loadApplication(session);\n+        remoteSessionCache.putSession(session.activated(applicationSet));\n+        return applicationSet;\n     }\n \n     void confirmUpload(RemoteSession session) {\n"}}, {"oid": "ca25b29442cc8ec5955bea1b06f496c7b1c3be18", "url": "https://github.com/vespa-engine/vespa/commit/ca25b29442cc8ec5955bea1b06f496c7b1c3be18", "message": "Add activated method to RemoteSession", "committedDate": "2020-09-08T08:10:58Z", "type": "commit"}, {"oid": "65e4c52d21c7d3b6d61d18100f61cfc030145787", "url": "https://github.com/vespa-engine/vespa/commit/65e4c52d21c7d3b6d61d18100f61cfc030145787", "message": "Use session lock when loading application", "committedDate": "2020-09-08T09:07:04Z", "type": "commit"}, {"oid": "25ae5f7e4533a84f6d1e1c70690e8bd2d1d6015c", "url": "https://github.com/vespa-engine/vespa/commit/25ae5f7e4533a84f6d1e1c70690e8bd2d1d6015c", "message": "Remove stray files", "committedDate": "2020-09-08T09:08:03Z", "type": "commit"}]}