{"pr_number": 11788, "pr_title": " Jvenstad/deployment summary in instance deployment list ", "pr_createdAt": "2020-01-14T16:14:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11788", "timeline": [{"oid": "46ba71c23d5a11a0307e82bbb470f7fde7a78214", "url": "https://github.com/vespa-engine/vespa/commit/46ba71c23d5a11a0307e82bbb470f7fde7a78214", "message": "Add dummy objects for new deployments to list in instance response", "committedDate": "2020-01-14T15:05:55Z", "type": "commit"}, {"oid": "8f7ce3d0bcbd837887a4b8f52d1793ebbfc4cb63", "url": "https://github.com/vespa-engine/vespa/commit/8f7ce3d0bcbd837887a4b8f52d1793ebbfc4cb63", "message": "Deployment glance-value info in list in instance", "committedDate": "2020-01-14T16:00:21Z", "type": "commit"}, {"oid": "16683947708ad11b91d89dee6f3b30cf0cc7df9c", "url": "https://github.com/vespa-engine/vespa/commit/16683947708ad11b91d89dee6f3b30cf0cc7df9c", "message": "Expose endpointStatus in deployment JSON responses", "committedDate": "2020-01-14T16:13:36Z", "type": "commit"}, {"oid": "b5df3bc7b5c3f541fbe2f8eeef6272d9569bea76", "url": "https://github.com/vespa-engine/vespa/commit/b5df3bc7b5c3f541fbe2f8eeef6272d9569bea76", "message": "Reorder expected output", "committedDate": "2020-01-14T16:18:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc3ODkyNg==", "url": "https://github.com/vespa-engine/vespa/pull/11788#discussion_r366778926", "bodyText": "Just noticed I wrote the wrong path on slack when requesting this feature. Could you please move it to deployment? Where endpointStatus is.", "author": "freva", "createdAt": "2020-01-15T09:45:40Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -951,9 +952,23 @@ private void toSlime(Cursor object, Instance instance, DeploymentStatus status,\n                     toSlime(instance.rotationStatus().of(instance.rotations().get(0).rotationId(), deployment),\n                             deploymentObject);\n                 }\n-                if (!instance.rotations().isEmpty()) {\n+                if ( ! recurseOverDeployments(request) && ! instance.rotations().isEmpty()) { // TODO jonmv: clean up when clients have converged.\n                     toSlime(instance.rotations(), instance.rotationStatus(), deployment, deploymentObject);\n                 }\n+\n+                JobType.from(controller.system(), deployment.zone())", "originalCommit": "b5df3bc7b5c3f541fbe2f8eeef6272d9569bea76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgwNTE4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11788#discussion_r366805189", "bodyText": "It would bring me the greatest pleasure to do so.", "author": "jonmv", "createdAt": "2020-01-15T10:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc3ODkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzMDI3OA==", "url": "https://github.com/vespa-engine/vespa/pull/11788#discussion_r366830278", "bodyText": "\u2705", "author": "jonmv", "createdAt": "2020-01-15T11:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc3ODkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "3ad1c325062d2a2b470547a4bbd7012df05c9827", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java\nindex a0aa6b23f0..0f176f3333 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java\n\n@@ -956,19 +956,6 @@ public class ApplicationApiHandler extends LoggingRequestHandler {\n                     toSlime(instance.rotations(), instance.rotationStatus(), deployment, deploymentObject);\n                 }\n \n-                JobType.from(controller.system(), deployment.zone())\n-                       .map(type -> new JobId(instance.id(), type))\n-                       .map(status.jobSteps()::get)\n-                       .ifPresent(stepStatus -> {\n-                           deploymentObject.setString(\"platform\", deployment.version().toFullString());\n-                           toSlime(deployment.applicationVersion(), deploymentObject.setObject(\"applicationVersion\"));\n-                           if ( ! status.jobsToRun().containsKey(stepStatus.job().get()))\n-                               deploymentObject.setString(\"status\", \"complete\");\n-                           else if (stepStatus.readyAt(instance.change()).map(controller.clock().instant()::isBefore).orElse(false))\n-                               deploymentObject.setString(\"status\", \"pending\");\n-                           else deploymentObject.setString(\"status\", \"running\");\n-\n-                       });\n             }\n \n             if (recurseOverDeployments(request)) // List full deployment information when recursive.\n"}}, {"oid": "3ad1c325062d2a2b470547a4bbd7012df05c9827", "url": "https://github.com/vespa-engine/vespa/commit/3ad1c325062d2a2b470547a4bbd7012df05c9827", "message": "Move job status info to deployment", "committedDate": "2020-01-15T11:38:00Z", "type": "commit"}]}