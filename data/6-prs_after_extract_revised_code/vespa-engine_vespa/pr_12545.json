{"pr_number": 12545, "pr_title": "Restrict directly routed endpoints to qualified deployments", "pr_createdAt": "2020-03-12T10:19:04Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12545", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzMjM3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12545#discussion_r391532375", "bodyText": "Consider adding a comment why this is required.\nsomething like: \"test framework currently use this identity when executing requests against containers\"", "author": "tokle", "createdAt": "2020-03-12T10:37:52Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/RoutingController.java", "diffHunk": "@@ -249,4 +264,29 @@ public void removeEndpointsInDns(Instance instance) {\n         return Collections.unmodifiableList(routingMethods);\n     }\n \n+    /** Returns whether traffic can be directly routed to given deployment */\n+    private boolean canRouteDirectlyTo(DeploymentId deploymentId, Application application) {\n+        if (controller.system().isPublic()) return true; // Public always supports direct routing\n+\n+        // Check Athenz service presence", "originalCommit": "fd3ef5ea007c18b43fc5030a49e25faf3f82829c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58df1263e48ff6a089ee722d62715a2c9820169c", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/RoutingController.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/RoutingController.java\nindex b238b73acb..c8f936c214 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/RoutingController.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/RoutingController.java\n\n@@ -268,7 +268,8 @@ public class RoutingController {\n     private boolean canRouteDirectlyTo(DeploymentId deploymentId, Application application) {\n         if (controller.system().isPublic()) return true; // Public always supports direct routing\n \n-        // Check Athenz service presence\n+        // Check Athenz service presence. The test framework uses this identity when sending requests to the\n+        // deployment's container(s).\n         var athenzService = application.deploymentSpec().instance(deploymentId.applicationId().instance())\n                                        .flatMap(instance -> instance.athenzService(deploymentId.zoneId().environment(),\n                                                                                    deploymentId.zoneId().region()));\n"}}, {"oid": "58df1263e48ff6a089ee722d62715a2c9820169c", "url": "https://github.com/vespa-engine/vespa/commit/58df1263e48ff6a089ee722d62715a2c9820169c", "message": "Restrict directly routed zone endpoints to qualified deployments", "committedDate": "2020-03-12T11:12:20Z", "type": "commit"}, {"oid": "ec71e642f5e44b525aad55cfdb342c6859908444", "url": "https://github.com/vespa-engine/vespa/commit/ec71e642f5e44b525aad55cfdb342c6859908444", "message": "Restrict directly routed global endpoints to qualified deployments", "committedDate": "2020-03-12T11:12:21Z", "type": "commit"}, {"oid": "39b0457169616f1c25dbd85f58951cc7b77dd5c4", "url": "https://github.com/vespa-engine/vespa/commit/39b0457169616f1c25dbd85f58951cc7b77dd5c4", "message": "Reduce application reads", "committedDate": "2020-03-12T11:12:21Z", "type": "commit"}, {"oid": "39b0457169616f1c25dbd85f58951cc7b77dd5c4", "url": "https://github.com/vespa-engine/vespa/commit/39b0457169616f1c25dbd85f58951cc7b77dd5c4", "message": "Reduce application reads", "committedDate": "2020-03-12T11:12:21Z", "type": "forcePushed"}]}