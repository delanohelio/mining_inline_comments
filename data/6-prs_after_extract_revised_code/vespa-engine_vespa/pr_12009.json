{"pr_number": 12009, "pr_title": "Bjorncs/support access token in athenz filter", "pr_createdAt": "2020-01-30T12:42:12Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12009", "timeline": [{"oid": "2a056e05db247b39ec395631364b8c0d286d6085", "url": "https://github.com/vespa-engine/vespa/commit/2a056e05db247b39ec395631364b8c0d286d6085", "message": "Access tokens should not be an empty string", "committedDate": "2020-01-29T16:10:45Z", "type": "commit"}, {"oid": "79bd9b2122efb99805d89e89a0354f70161420ed", "url": "https://github.com/vespa-engine/vespa/commit/79bd9b2122efb99805d89e89a0354f70161420ed", "message": "Add toString() to ResourceNameAndAction", "committedDate": "2020-01-29T16:11:17Z", "type": "commit"}, {"oid": "6df641688fed097505d3e675960b49d7162c6828", "url": "https://github.com/vespa-engine/vespa/commit/6df641688fed097505d3e675960b49d7162c6828", "message": "Add debug logging of error responses", "committedDate": "2020-01-29T16:12:24Z", "type": "commit"}, {"oid": "eb4b7b8fcdc7aa5de13c05872a1fdca4076179b9", "url": "https://github.com/vespa-engine/vespa/commit/eb4b7b8fcdc7aa5de13c05872a1fdca4076179b9", "message": "Add methods to convert AthenzRole to and from single string", "committedDate": "2020-01-30T11:43:28Z", "type": "commit"}, {"oid": "23bdf059f1b8345495e0b72f61d30bc15761d4da", "url": "https://github.com/vespa-engine/vespa/commit/23bdf059f1b8345495e0b72f61d30bc15761d4da", "message": "Rewrite AthenzAuthorizationFilter to accept access tokens\n\nChange athenz-authorization-filter.def to have an enum set of enabled credentials.\nDelegate to ZPE to determine if a certificate is an Athenz role or identity certificate.\nIntroduce various request attributes to propagate result from ZPE.", "committedDate": "2020-01-30T12:37:59Z", "type": "commit"}, {"oid": "959960a0e24d33a22d360468834cb4e41fa145c5", "url": "https://github.com/vespa-engine/vespa/commit/959960a0e24d33a22d360468834cb4e41fa145c5", "message": "Remove unused methods\n\nMethods were unused and relied on hardcoded issuer names (ouch!).", "committedDate": "2020-01-30T12:37:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4NjIyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/12009#discussion_r373386229", "bodyText": "consider naming the method to reflect that it expects the format :role.", "author": "tokle", "createdAt": "2020-01-31T09:29:39Z", "path": "vespa-athenz/src/main/java/com/yahoo/vespa/athenz/api/AthenzRole.java", "diffHunk": "@@ -20,6 +22,16 @@ public AthenzRole(String domain, String roleName) {\n         this.roleName = roleName;\n     }\n \n+    public static AthenzRole fromString(String string) {", "originalCommit": "eb4b7b8fcdc7aa5de13c05872a1fdca4076179b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwODI3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12009#discussion_r373408272", "bodyText": "Addressed in new commit.", "author": "bjorncs", "createdAt": "2020-01-31T10:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4NjIyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "045cb0fa8fb519f7470f2f63c5c0e6884d63b3b0", "chunk": "diff --git a/vespa-athenz/src/main/java/com/yahoo/vespa/athenz/api/AthenzRole.java b/vespa-athenz/src/main/java/com/yahoo/vespa/athenz/api/AthenzRole.java\nindex a7c9dbff3f..4e43276829 100644\n--- a/vespa-athenz/src/main/java/com/yahoo/vespa/athenz/api/AthenzRole.java\n+++ b/vespa-athenz/src/main/java/com/yahoo/vespa/athenz/api/AthenzRole.java\n\n@@ -22,14 +22,17 @@ public class AthenzRole {\n         this.roleName = roleName;\n     }\n \n-    public static AthenzRole fromString(String string) {\n-        if (!string.contains(DOMAIN_ROLE_NAME_DELIMITER)) {\n-            throw new IllegalArgumentException(\"Not a valid role: \" + string);\n+    public static AthenzRole fromResourceNameString(String string) {\n+        return fromResourceName(AthenzResourceName.fromString(string));\n+    }\n+\n+    public static AthenzRole fromResourceName(AthenzResourceName resourceName) {\n+        String entityName = resourceName.getEntityName();\n+        if (!entityName.startsWith(ROLE_RESOURCE_PREFIX)) {\n+            throw new IllegalArgumentException(\"Not a valid role: \" + resourceName.toResourceNameString());\n         }\n-        int delimiterIndex = string.indexOf(DOMAIN_ROLE_NAME_DELIMITER);\n-        String domain = string.substring(0, delimiterIndex);\n-        String roleName = string.substring(delimiterIndex + DOMAIN_ROLE_NAME_DELIMITER.length());\n-        return new AthenzRole(domain, roleName);\n+        String roleName = entityName.substring(ROLE_RESOURCE_PREFIX.length());\n+        return new AthenzRole(resourceName.getDomain(), roleName);\n     }\n \n     public AthenzDomain domain() {\n"}}, {"oid": "045cb0fa8fb519f7470f2f63c5c0e6884d63b3b0", "url": "https://github.com/vespa-engine/vespa/commit/045cb0fa8fb519f7470f2f63c5c0e6884d63b3b0", "message": "Improve naming of string conversion methods for AthenzRole", "committedDate": "2020-01-31T10:18:04Z", "type": "commit"}, {"oid": "293994259901b6c5e80f2df20313f88238ce7cdb", "url": "https://github.com/vespa-engine/vespa/commit/293994259901b6c5e80f2df20313f88238ce7cdb", "message": "Add public modifier to constructor and filter()", "committedDate": "2020-01-31T15:58:25Z", "type": "commit"}]}