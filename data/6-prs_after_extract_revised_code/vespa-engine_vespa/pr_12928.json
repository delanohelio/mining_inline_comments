{"pr_number": 12928, "pr_title": "Bratseth/vespa http client improvements", "pr_createdAt": "2020-04-15T14:57:23Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12928", "timeline": [{"oid": "f6b90d5e48dfc894bb7c5299522f5cea0ec0c658", "url": "https://github.com/vespa-engine/vespa/commit/f6b90d5e48dfc894bb7c5299522f5cea0ec0c658", "message": "Nonfunctional changes only", "committedDate": "2020-04-15T10:20:52Z", "type": "commit"}, {"oid": "3881d6283dc36646f958da16b948cbb2affec845", "url": "https://github.com/vespa-engine/vespa/commit/3881d6283dc36646f958da16b948cbb2affec845", "message": "The document queue is always shared", "committedDate": "2020-04-15T14:18:06Z", "type": "commit"}, {"oid": "874968628cb824e2a8dc99e1b9148e61c09a867e", "url": "https://github.com/vespa-engine/vespa/commit/874968628cb824e2a8dc99e1b9148e61c09a867e", "message": "Nonfunctional changes only", "committedDate": "2020-04-15T14:34:51Z", "type": "commit"}, {"oid": "748fcdf0901196fb6c7339ffdaf45bd47c56c78b", "url": "https://github.com/vespa-engine/vespa/commit/748fcdf0901196fb6c7339ffdaf45bd47c56c78b", "message": "Randomize chunk size", "committedDate": "2020-04-15T14:54:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4NTc0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409385742", "bodyText": "Should this be \"(...) or null if the failure occurred before this (...)\"?", "author": "vekterli", "createdAt": "2020-04-16T08:44:48Z", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java", "diffHunk": "@@ -20,8 +20,7 @@ public EndpointIOException(Endpoint endpoint, String message, Throwable cause) {\n         this.endpoint = endpoint;\n     }\n \n-    public Endpoint getEndpoint() {\n-        return endpoint;\n-    }\n+    /** Returns the endpoint, or the failure occurred before  this was assigned to a unique endpoint */", "originalCommit": "3881d6283dc36646f958da16b948cbb2affec845", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42c17ff03aede800278ce5f56a4124059bf29e7b", "chunk": "diff --git a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java\nindex f9279f429f..d8efeea93b 100644\n--- a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java\n+++ b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/EndpointIOException.java\n\n@@ -20,7 +20,7 @@ public class EndpointIOException extends IOException {\n         this.endpoint = endpoint;\n     }\n \n-    /** Returns the endpoint, or the failure occurred before  this was assigned to a unique endpoint */\n+    /** Returns the endpoint, or null if the failure occurred before this was assigned to a unique endpoint */\n     public Endpoint getEndpoint() { return endpoint; }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5MjAwMA==", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409392000", "bodyText": "Should probably be Level.FINEST to match log.finest() call below", "author": "vekterli", "createdAt": "2020-04-16T08:54:24Z", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -184,22 +184,22 @@ public String toString() {\n                 chunkSizeBytes = doc.size();\n             }\n         } catch (InterruptedException ie) {\n-            log.fine(\"Got break signal while waiting for new documents to feed.\");\n+            log.fine(\"Got break signal while waiting for new documents to feed\");\n             return docsForSendChunk;\n         }\n         int pendingSize = 1 + resultQueue.getPendingSize();\n         // see if we can get more documents without blocking\n+\n         while (chunkSizeBytes < maxChunkSizeBytes && pendingSize < maxInFlightRequests) {\n             drainFirstDocumentsInQueueIfOld();\n-            Document d = documentQueue.poll();\n-            if (d == null) {\n-                break;\n-            }\n-            docsForSendChunk.add(d);\n-            chunkSizeBytes += d.size();\n+            Document document = documentQueue.poll();\n+            if (document == null) break;\n+            docsForSendChunk.add(document);\n+            chunkSizeBytes += document.size();\n             pendingSize++;\n         }\n-        log.finest(\"Chunk has \" + docsForSendChunk.size() + \" docs with a size \" + chunkSizeBytes + \" bytes.\");\n+        if (log.isLoggable(Level.FINE))", "originalCommit": "874968628cb824e2a8dc99e1b9148e61c09a867e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42c17ff03aede800278ce5f56a4124059bf29e7b", "chunk": "diff --git a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\nindex dfc5d0d0a6..44799e598b 100644\n--- a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\n+++ b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\n\n@@ -188,9 +190,13 @@ class IOThread implements Runnable, AutoCloseable {\n             return docsForSendChunk;\n         }\n         int pendingSize = 1 + resultQueue.getPendingSize();\n-        // see if we can get more documents without blocking\n \n-        while (chunkSizeBytes < maxChunkSizeBytes && pendingSize < maxInFlightRequests) {\n+        // see if we can get more documents without blocking\n+        // slightly randomize how much is taken to avoid harmonic interactions leading\n+        // to some threads consistently taking more than others\n+        int thisMaxChunkSizeBytes = randomize(maxChunkSizeBytes);\n+        int thisMaxInFlightRequests = randomize(maxInFlightRequests);\n+        while (chunkSizeBytes < thisMaxChunkSizeBytes && pendingSize < thisMaxInFlightRequests) {\n             drainFirstDocumentsInQueueIfOld();\n             Document document = documentQueue.poll();\n             if (document == null) break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5OTk3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12928#discussion_r409399972", "bodyText": "This import does not seem to have been used", "author": "vekterli", "createdAt": "2020-04-16T09:06:35Z", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -17,7 +17,9 @@\n import java.util.Collection;\n import java.util.List;\n import java.util.Optional;\n+import java.util.Random;\n import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ThreadLocalRandom;", "originalCommit": "748fcdf0901196fb6c7339ffdaf45bd47c56c78b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "42c17ff03aede800278ce5f56a4124059bf29e7b", "chunk": "diff --git a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\nindex a6460c6237..44799e598b 100644\n--- a/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\n+++ b/vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java\n\n@@ -19,7 +19,6 @@ import java.util.List;\n import java.util.Optional;\n import java.util.Random;\n import java.util.concurrent.CountDownLatch;\n-import java.util.concurrent.ThreadLocalRandom;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.logging.Level;\n"}}, {"oid": "42c17ff03aede800278ce5f56a4124059bf29e7b", "url": "https://github.com/vespa-engine/vespa/commit/42c17ff03aede800278ce5f56a4124059bf29e7b", "message": "Minor fixes", "committedDate": "2020-04-16T09:14:09Z", "type": "commit"}]}