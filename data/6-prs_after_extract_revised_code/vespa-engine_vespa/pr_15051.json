{"pr_number": 15051, "pr_title": "Report image pull duration metric", "pr_createdAt": "2020-10-27T15:03:59Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15051", "timeline": [{"oid": "845f46409721b45f3b773fa9ebe55c80d942d9a5", "url": "https://github.com/vespa-engine/vespa/commit/845f46409721b45f3b773fa9ebe55c80d942d9a5", "message": "Improve name", "committedDate": "2020-10-27T13:04:22Z", "type": "commit"}, {"oid": "528ee45baf83349d2bb11112273f04e4de8c7274", "url": "https://github.com/vespa-engine/vespa/commit/528ee45baf83349d2bb11112273f04e4de8c7274", "message": "Docker image -> container image", "committedDate": "2020-10-27T14:10:13Z", "type": "commit"}, {"oid": "aee7f79dc8eae7e3e9bd4b75b39cbd04e0d794a1", "url": "https://github.com/vespa-engine/vespa/commit/aee7f79dc8eae7e3e9bd4b75b39cbd04e0d794a1", "message": "Report image pull duration metric", "committedDate": "2020-10-27T14:44:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3NzI4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15051#discussion_r512777286", "bodyText": "Include repo in the tag value as well?", "author": "freva", "createdAt": "2020-10-27T15:12:03Z", "path": "docker-api/src/main/java/com/yahoo/vespa/hosted/dockerapi/DockerEngine.java", "diffHunk": "@@ -369,7 +379,16 @@ public void onComplete() {\n                 numberOfDockerApiFails.increment();\n                 throw new DockerClientException(\"Could not download image: \" + dockerImage);\n             }\n+            sampleDuration();\n         }\n+\n+        private void sampleDuration() {\n+            Gauge gauge = metrics.declareGauge(\"docker.imagePullDurationSecs\",\n+                                               new Dimensions(Map.of(\"tag\", dockerImage.tagAsVersion().toFullString())));", "originalCommit": "aee7f79dc8eae7e3e9bd4b75b39cbd04e0d794a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5819ebc4125557632ee9cacea4b1a07bcd33490a", "chunk": "diff --git a/docker-api/src/main/java/com/yahoo/vespa/hosted/dockerapi/DockerEngine.java b/docker-api/src/main/java/com/yahoo/vespa/hosted/dockerapi/DockerEngine.java\nindex 25b8a1c274..bbd622a0d2 100644\n--- a/docker-api/src/main/java/com/yahoo/vespa/hosted/dockerapi/DockerEngine.java\n+++ b/docker-api/src/main/java/com/yahoo/vespa/hosted/dockerapi/DockerEngine.java\n\n@@ -384,7 +384,7 @@ public class DockerEngine implements ContainerEngine {\n \n         private void sampleDuration() {\n             Gauge gauge = metrics.declareGauge(\"docker.imagePullDurationSecs\",\n-                                               new Dimensions(Map.of(\"tag\", dockerImage.tagAsVersion().toFullString())));\n+                                               new Dimensions(Map.of(\"image\", dockerImage.asString())));\n             Duration pullDuration = Duration.between(startedAt, clock.instant());\n             gauge.sample(pullDuration.getSeconds());\n         }\n"}}, {"oid": "5819ebc4125557632ee9cacea4b1a07bcd33490a", "url": "https://github.com/vespa-engine/vespa/commit/5819ebc4125557632ee9cacea4b1a07bcd33490a", "message": "Use complete image as dimension", "committedDate": "2020-10-27T15:17:52Z", "type": "commit"}]}