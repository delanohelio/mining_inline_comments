{"pr_number": 14941, "pr_title": "Take correct lock for each node when retiring", "pr_createdAt": "2020-10-19T07:57:41Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14941", "timeline": [{"oid": "85f772f10c6aa5aed413a2e0ff1422f3bd99ca38", "url": "https://github.com/vespa-engine/vespa/commit/85f772f10c6aa5aed413a2e0ff1422f3bd99ca38", "message": "Perform operation on current node", "committedDate": "2020-10-19T07:58:51Z", "type": "commit"}, {"oid": "99e17aecf46e5b9caf882e1824a84df6d3086a16", "url": "https://github.com/vespa-engine/vespa/commit/99e17aecf46e5b9caf882e1824a84df6d3086a16", "message": "Take correct lock for each node when retiring", "committedDate": "2020-10-19T07:58:51Z", "type": "commit"}, {"oid": "99e17aecf46e5b9caf882e1824a84df6d3086a16", "url": "https://github.com/vespa-engine/vespa/commit/99e17aecf46e5b9caf882e1824a84df6d3086a16", "message": "Take correct lock for each node when retiring", "committedDate": "2020-10-19T07:58:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU2NjAyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14941#discussion_r507566021", "bodyText": "This is an improvement.\nI'm a bit sceptical of the method API: Usually, some condition has led to the caller wanting to set this node to dirty.  I would guess that whole condition needs to be reevaluated under the unallocated lock?  More than just the presence of the node may have changed between testing the condition and coming to this point where the lock is held.", "author": "hakonhall", "createdAt": "2020-10-19T08:31:35Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeRepository.java", "diffHunk": "@@ -809,13 +814,19 @@ else if (!node.type().isHost()) { // removing a child node\n         // perform operation while holding locks\n         List<Node> resultingNodes = new ArrayList<>();\n         try (Mutex lock = lockUnallocated()) {\n-            for (Node node : unallocatedNodes)\n-                resultingNodes.add(action.apply(node, lock));\n+            for (Node node : unallocatedNodes) {\n+                Optional<Node> currentNode = db.readNode(node.hostname()); // Re-read while holding lock", "originalCommit": "99e17aecf46e5b9caf882e1824a84df6d3086a16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU3ODQyOA==", "url": "https://github.com/vespa-engine/vespa/pull/14941#discussion_r507578428", "bodyText": "Agree, the API is not ideal.", "author": "mpolden", "createdAt": "2020-10-19T08:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU2NjAyMQ=="}], "type": "inlineReview", "revised_code": null}]}