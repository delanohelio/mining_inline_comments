{"pr_number": 14630, "pr_title": "Use BigDecimal for budget inside the Quota", "pr_createdAt": "2020-09-30T09:06:06Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14630", "timeline": [{"oid": "68176288649b5ebc3bbf00ae934875c17b9a75b7", "url": "https://github.com/vespa-engine/vespa/commit/68176288649b5ebc3bbf00ae934875c17b9a75b7", "message": "Use BigDecimal for budget inside the Quota\n\n- To allow budgets below $1/hour we change the internal representation of budget\n  to a decimal number.  Some interfaces that assume integers are kept to keep the\n  API stable.\n\n- Created a nicer method .unlimited() instead of .empt() to better show semantics.\n\n- Added some serialisation tests to make sure we support integers and decimals.", "committedDate": "2020-09-30T09:03:43Z", "type": "commit"}, {"oid": "ef52f22d1a495ccd3497384d19feeebe70439378", "url": "https://github.com/vespa-engine/vespa/commit/ef52f22d1a495ccd3497384d19feeebe70439378", "message": "Merge remote-tracking branch 'origin/master' into ogronnesby/quota-decimal", "committedDate": "2020-09-30T09:08:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NjY2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14630#discussion_r497446669", "bodyText": "Consider BigDecimal parameter instead of Optional. That way you avoid the initial problem where signatures with generic types cannot be overloaded. Same for the other method.", "author": "mpolden", "createdAt": "2020-09-30T11:48:57Z", "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -14,42 +16,57 @@\n  * @author ogronnesby\n  */\n public class Quota {\n+    private static final Quota UNLIMITED = new Quota(Optional.empty(), Optional.empty());\n \n+    /** The max size of a cluster inside application */\n     private final Optional<Integer> maxClusterSize;\n \n     /** The max budget in dollars per hour */\n-    private final Optional<Integer> budget;\n+    private final Optional<BigDecimal> budget;\n \n-    public Quota(Optional<Integer> maybeClusterSize, Optional<Integer> budget) {\n-        this.maxClusterSize = maybeClusterSize;\n-        this.budget = budget;\n+    // TODO: Remove constructor once Vespa < 7.300 is gone from production\n+    public Quota(Optional<Integer> maxClusterSize, Optional<Integer> budget) {\n+        this(maxClusterSize, budget.map(BigDecimal::new), true);\n+    }\n+\n+    private Quota(Optional<Integer> maxClusterSize, Optional<BigDecimal> budget, boolean isDecimal) {\n+        this.maxClusterSize = Objects.requireNonNull(maxClusterSize);\n+        this.budget = Objects.requireNonNull(budget);\n     }\n \n     public static Quota fromSlime(Inspector inspector) {\n         var clusterSize = SlimeUtils.optionalLong(inspector.field(\"clusterSize\"));\n-        var budget = SlimeUtils.optionalLong(inspector.field(\"budget\"));\n-        return new Quota(clusterSize.map(Long::intValue), budget.map(Long::intValue));\n+        var budget = budgetFromSlime(inspector.field(\"budget\"));\n+        return new Quota(clusterSize.map(Long::intValue), budget, true);\n+    }\n+\n+    public Quota withBudget(Optional<BigDecimal> budget) {", "originalCommit": "ef52f22d1a495ccd3497384d19feeebe70439378", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "55b24de2df59ecb1accb919deecdf818d44ff1c4", "chunk": "diff --git a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\nindex 01ed33e023..00d194a37a 100644\n--- a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n+++ b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n\n@@ -40,12 +40,12 @@ public class Quota {\n         return new Quota(clusterSize.map(Long::intValue), budget, true);\n     }\n \n-    public Quota withBudget(Optional<BigDecimal> budget) {\n-        return new Quota(this.maxClusterSize, budget, true);\n+    public Quota withBudget(BigDecimal budget) {\n+        return new Quota(this.maxClusterSize, Optional.of(budget), true);\n     }\n \n-    public Quota withClusterSize(Optional<Integer> clusterSize) {\n-        return new Quota(clusterSize, this.budget, true);\n+    public Quota withClusterSize(int clusterSize) {\n+        return new Quota(Optional.of(clusterSize), this.budget, true);\n     }\n \n     public Slime toSlime() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0OTgyMw==", "url": "https://github.com/vespa-engine/vespa/pull/14630#discussion_r497449823", "bodyText": "Missing @author.", "author": "mpolden", "createdAt": "2020-09-30T11:54:52Z", "path": "config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.SlimeUtils;\n+import org.junit.Test;\n+\n+\n+import java.math.BigDecimal;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QuotaTest {", "originalCommit": "ef52f22d1a495ccd3497384d19feeebe70439378", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "55b24de2df59ecb1accb919deecdf818d44ff1c4", "chunk": "diff --git a/config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java b/config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java\nindex 83d4ffbbe7..b4a7ff7c76 100644\n--- a/config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java\n+++ b/config-model-api/src/test/java/com/yahoo/config/model/api/QuotaTest.java\n\n@@ -9,6 +9,9 @@ import java.math.BigDecimal;\n \n import static org.junit.Assert.assertEquals;\n \n+/**\n+ * @author ogronnesby\n+ */\n public class QuotaTest {\n \n     @Test\n"}}, {"oid": "55b24de2df59ecb1accb919deecdf818d44ff1c4", "url": "https://github.com/vespa-engine/vespa/commit/55b24de2df59ecb1accb919deecdf818d44ff1c4", "message": "Don't use optional in with* methods\n\nAlso added a serialisation/deserialiasation test for quota", "committedDate": "2020-09-30T13:32:38Z", "type": "commit"}]}