{"pr_number": 13599, "pr_title": "[VESPA-18430] Stabilize unit test", "pr_createdAt": "2020-06-16T07:12:13Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13599", "timeline": [{"oid": "f64388e0b095e77707cfa444a93e0e9e251fab41", "url": "https://github.com/vespa-engine/vespa/commit/f64388e0b095e77707cfa444a93e0e9e251fab41", "message": "Simplify with CountDownLatch and Callable", "committedDate": "2020-06-16T06:54:24Z", "type": "commit"}, {"oid": "17addf0d23559238f5dc7d9436831a0adcdd68c1", "url": "https://github.com/vespa-engine/vespa/commit/17addf0d23559238f5dc7d9436831a0adcdd68c1", "message": "Wait until other thread is waiting for new context to stabilize unit test", "committedDate": "2020-06-16T07:10:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MzIwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13599#discussion_r440653201", "bodyText": "This should be a method on NodeAgentContext using Object::wait and notify with no sleep necessary.", "author": "hakonhall", "createdAt": "2020-06-16T07:49:18Z", "path": "node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextManagerTest.java", "diffHunk": "@@ -141,51 +141,43 @@ public void setFrozen_is_successful_if_converged_in_time() throws InterruptedExc\n         assertEquals(Optional.of(true), asyncScheduler.response);\n     }\n \n+    private void waitUntilWaitingForNextContext() {", "originalCommit": "17addf0d23559238f5dc7d9436831a0adcdd68c1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f1c0b9585520cedb76da6a4dbd08330ad93650bc", "chunk": "diff --git a/node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextManagerTest.java b/node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextManagerTest.java\nindex 240a29080c..a082addd77 100644\n--- a/node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextManagerTest.java\n+++ b/node-admin/src/test/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentContextManagerTest.java\n\n@@ -141,14 +141,6 @@ public class NodeAgentContextManagerTest {\n         assertEquals(Optional.of(true), asyncScheduler.response);\n     }\n \n-    private void waitUntilWaitingForNextContext() {\n-        while (!manager.isWaitingForNextContext()) {\n-            try {\n-                Thread.sleep(10);\n-            } catch (InterruptedException ignored) { }\n-        }\n-    }\n-\n     private static NodeAgentContext generateContext() {\n         return new NodeAgentContextImpl.Builder(\"container-123.domain.tld\").build();\n     }\n"}}, {"oid": "f1c0b9585520cedb76da6a4dbd08330ad93650bc", "url": "https://github.com/vespa-engine/vespa/commit/f1c0b9585520cedb76da6a4dbd08330ad93650bc", "message": "Avoid busy wait", "committedDate": "2020-06-16T08:50:26Z", "type": "commit"}]}