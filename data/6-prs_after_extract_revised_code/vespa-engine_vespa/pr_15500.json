{"pr_number": 15500, "pr_title": "Handle event data being null", "pr_createdAt": "2020-11-27T10:17:49Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15500", "timeline": [{"oid": "1677b17dd4483843f9b8507c199bd496b2d03389", "url": "https://github.com/vespa-engine/vespa/commit/1677b17dd4483843f9b8507c199bd496b2d03389", "message": "Handle event data being null", "committedDate": "2020-11-27T10:17:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyMDY4OA==", "url": "https://github.com/vespa-engine/vespa/pull/15500#discussion_r531520688", "bodyText": "null is passed when connection is suspended, lost, or on (re)connected, or when cache is initialized(?)  So I think the correct thing to do is to duplicate the current statement to within each case in the below switch (and document getData may be null on some other event types)", "author": "hakonhall", "createdAt": "2020-11-27T10:38:59Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/application/TenantApplications.java", "diffHunk": "@@ -185,7 +186,9 @@ public Lock lock(ApplicationId id) {\n \n     private void childEvent(CuratorFramework ignored, PathChildrenCacheEvent event) {\n         zkWatcherExecutor.execute(() -> {\n-            ApplicationId applicationId = ApplicationId.fromSerializedForm(Path.fromString(event.getData().getPath()).getName());\n+            ChildData data = event.getData();\n+            if (data == null) return; // Node might have been deleted after we got event", "originalCommit": "1677b17dd4483843f9b8507c199bd496b2d03389", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzMTczNw==", "url": "https://github.com/vespa-engine/vespa/pull/15500#discussion_r531531737", "bodyText": "Right, thanks, will do as suggested", "author": "hmusum", "createdAt": "2020-11-27T10:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyMDY4OA=="}], "type": "inlineReview", "revised_code": {"commit": "d971c712477246b5562661cdd12c0a01a1141e0a", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/application/TenantApplications.java b/configserver/src/main/java/com/yahoo/vespa/config/server/application/TenantApplications.java\nindex 75a981f1a1..5a34217dbd 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/application/TenantApplications.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/application/TenantApplications.java\n\n@@ -186,18 +186,17 @@ public class TenantApplications implements RequestHandler, HostValidator<Applica\n \n     private void childEvent(CuratorFramework ignored, PathChildrenCacheEvent event) {\n         zkWatcherExecutor.execute(() -> {\n-            ChildData data = event.getData();\n-            if (data == null) return; // Node might have been deleted after we got event\n-            ApplicationId applicationId = ApplicationId.fromSerializedForm(Path.fromString(data.getPath()).getName());\n+            // Note: event.getData() might return null on types not handled here (CONNECTION_*, INITIALIZED, see javadoc)\n             switch (event.getType()) {\n                 case CHILD_ADDED:\n                     /* A new application is added when a session is added, @see\n                     {@link com.yahoo.vespa.config.server.session.SessionRepository#childEvent(CuratorFramework, PathChildrenCacheEvent)} */\n+                    ApplicationId applicationId = ApplicationId.fromSerializedForm(Path.fromString(event.getData().getPath()).getName());\n                     log.log(Level.FINE, TenantRepository.logPre(applicationId) + \"Application added: \" + applicationId);\n                     break;\n                 // Event CHILD_REMOVED will be triggered on all config servers if deleteApplication() above is called on one of them\n                 case CHILD_REMOVED:\n-                    removeApplication(applicationId);\n+                    removeApplication(ApplicationId.fromSerializedForm(Path.fromString(event.getData().getPath()).getName()));\n                     break;\n                 case CHILD_UPDATED:\n                     // do nothing, application just got redeployed\n"}}, {"oid": "d971c712477246b5562661cdd12c0a01a1141e0a", "url": "https://github.com/vespa-engine/vespa/commit/d971c712477246b5562661cdd12c0a01a1141e0a", "message": "Get data for some event types only, for others data might be null", "committedDate": "2020-11-27T11:09:41Z", "type": "commit"}]}