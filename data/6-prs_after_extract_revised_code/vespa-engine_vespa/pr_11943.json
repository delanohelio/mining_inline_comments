{"pr_number": 11943, "pr_title": "Remove use-bucket-space-metric feature flag", "pr_createdAt": "2020-01-25T23:50:51Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11943", "timeline": [{"oid": "7b99c625f39d334638b13f5a083c680e4ee3018b", "url": "https://github.com/vespa-engine/vespa/commit/7b99c625f39d334638b13f5a083c680e4ee3018b", "message": "Remove use-bucket-space-metric feature flag\n\nThe flag controlled config read by the Cluster Controller. Therefore, I have\nleft the ModelContextImpl.Properties method and implementation (now always\nreturning true), but the model has stopped using that method internally, and\nthe config is no longer used in the CC.\n\nThe field in the fleetcontroller.def is left unchanged and documented as\ndeprecated.", "committedDate": "2020-01-25T23:46:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjMzNw==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r370976337", "bodyText": "Remove comment for the removed argument as well", "author": "hmusum", "createdAt": "2020-01-26T06:19:11Z", "path": "clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java", "diffHunk": "@@ -42,8 +42,8 @@ protected void setUp(boolean dontInitializeNode2) throws Exception {\n         {\n             Set<ConfiguredNode> nodes = FleetControllerTest.toNodes(0, 1, 2, 3);\n             ContentCluster cluster = new ContentCluster(\n-                    \"books\", nodes, distribution, 6 /* minStorageNodesUp*/, 0.9 /* minRatioOfStorageNodesUp */,\n-                    true /* determineBucketsFromBucketSpaceMetric */);\n+                    \"books\", nodes, distribution, 6 /* minStorageNodesUp*/, 0.9 /* minRatioOfStorageNodesUp */\n+                    /* determineBucketsFromBucketSpaceMetric */);", "originalCommit": "7b99c625f39d334638b13f5a083c680e4ee3018b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MzMyMg==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371183322", "bodyText": "Fixed", "author": "hakonhall", "createdAt": "2020-01-27T11:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjMzNw=="}], "type": "inlineReview", "revised_code": {"commit": "f61f6c701dc91e839b865f158a6da56ff166def7", "chunk": "diff --git a/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java b/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\nindex bb4e5c0053..faebbf8755 100644\n--- a/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\n+++ b/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\n\n@@ -42,8 +42,7 @@ public abstract class StateRestApiTest {\n         {\n             Set<ConfiguredNode> nodes = FleetControllerTest.toNodes(0, 1, 2, 3);\n             ContentCluster cluster = new ContentCluster(\n-                    \"books\", nodes, distribution, 6 /* minStorageNodesUp*/, 0.9 /* minRatioOfStorageNodesUp */\n-                    /* determineBucketsFromBucketSpaceMetric */);\n+                    \"books\", nodes, distribution, 6 /* minStorageNodesUp*/, 0.9 /* minRatioOfStorageNodesUp */);\n             initializeCluster(cluster, nodes);\n             AnnotatedClusterState baselineState = AnnotatedClusterState.withoutAnnotations(ClusterState.stateFromString(\"distributor:4 storage:4\"));\n             Map<String, AnnotatedClusterState> bucketSpaceStates = new HashMap<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjMzOA==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r370976338", "bodyText": "Remove comment for the removed argument as well", "author": "hmusum", "createdAt": "2020-01-26T06:19:17Z", "path": "clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java", "diffHunk": "@@ -57,8 +57,8 @@ protected void setUp(boolean dontInitializeNode2) throws Exception {\n             Set<ConfiguredNode> nodesInSlobrok = FleetControllerTest.toNodes(1, 3, 5, 7);\n \n             ContentCluster cluster = new ContentCluster(\n-                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0 /* minRatioOfStorageNodesUp */,\n-                    true /* determineBucketsFromBucketSpaceMetric */);\n+                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0 /* minRatioOfStorageNodesUp */\n+                    /* determineBucketsFromBucketSpaceMetric */);", "originalCommit": "7b99c625f39d334638b13f5a083c680e4ee3018b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MzU4NA==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371183584", "bodyText": "Fixed", "author": "hakonhall", "createdAt": "2020-01-27T11:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjMzOA=="}], "type": "inlineReview", "revised_code": {"commit": "f61f6c701dc91e839b865f158a6da56ff166def7", "chunk": "diff --git a/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java b/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\nindex bb4e5c0053..faebbf8755 100644\n--- a/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\n+++ b/clustercontroller-core/src/test/java/com/yahoo/vespa/clustercontroller/core/restapiv2/StateRestApiTest.java\n\n@@ -57,8 +56,7 @@ public abstract class StateRestApiTest {\n             Set<ConfiguredNode> nodesInSlobrok = FleetControllerTest.toNodes(1, 3, 5, 7);\n \n             ContentCluster cluster = new ContentCluster(\n-                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0 /* minRatioOfStorageNodesUp */\n-                    /* determineBucketsFromBucketSpaceMetric */);\n+                    \"music\", nodes, distribution, 4 /* minStorageNodesUp*/, 0.0 /* minRatioOfStorageNodesUp */);\n             if (dontInitializeNode2) {\n                 // TODO: this skips initialization of node 2 to fake that it is not answering\n                 // which really leaves us in an illegal state\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjM3MA==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r370976370", "bodyText": "Consider making a default implementation of the method in the interface, then you could remove this now", "author": "hmusum", "createdAt": "2020-01-26T06:20:39Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java", "diffHunk": "@@ -217,8 +214,9 @@ public String athenzDnsSuffix() {\n         @Override\n         public double defaultTermwiseLimit() { return defaultTermwiseLimit; }\n \n+        // TODO: Remove\n         @Override\n-        public boolean useBucketSpaceMetric() { return useBucketSpaceMetric; }\n+        public boolean useBucketSpaceMetric() { return true; }", "originalCommit": "7b99c625f39d334638b13f5a083c680e4ee3018b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5MTI4Mw==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371191283", "bodyText": "I don't think I can do that since the interface is in config-model-api: Old deployments would only see the old interface and therefore no default implementation.", "author": "hakonhall", "createdAt": "2020-01-27T11:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5Mjc2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371192769", "bodyText": "Maybe I don't get this, but old config models implement the method, so that should not be an issue. Anyway, this is nitpicking, so I wouldn't bother.", "author": "hmusum", "createdAt": "2020-01-27T11:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIwMDU2OA==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371200568", "bodyText": "The implementation is in ModelContextImpl, in the configserver bundle, and is always at the latest config server Vespa version, and independent on the particular version of the model running?", "author": "hakonhall", "createdAt": "2020-01-27T11:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIwMTgxNg==", "url": "https://github.com/vespa-engine/vespa/pull/11943#discussion_r371201816", "bodyText": "You are completely right, I wrongly assumed this was in the model. Thanks.", "author": "hmusum", "createdAt": "2020-01-27T12:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjM3MA=="}], "type": "inlineReview", "revised_code": {"commit": "b105eead1fbbcefbb85bc962749f2a12fa660bbe", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java b/configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java\nindex 23bdf972a0..400460d2ce 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/deploy/ModelContextImpl.java\n\n@@ -214,9 +241,28 @@ public class ModelContextImpl implements ModelContext {\n         @Override\n         public double defaultTermwiseLimit() { return defaultTermwiseLimit; }\n \n+        public double defaultSoftStartSeconds() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public double defaultTopKProbability() {\n+            return defaultTopKprobability;\n+        }\n+\n         // TODO: Remove\n         @Override\n         public boolean useBucketSpaceMetric() { return true; }\n+\n+        @Override\n+        public boolean useNewAthenzFilter() { return true; }\n+\n+        @Override\n+        public String proxyProtocol() { return proxyProtocol; }\n+\n+        @Override\n+        public Optional<AthenzDomain> athenzDomain() { return athenzDomain; }\n+\n     }\n \n }\n"}}, {"oid": "f61f6c701dc91e839b865f158a6da56ff166def7", "url": "https://github.com/vespa-engine/vespa/commit/f61f6c701dc91e839b865f158a6da56ff166def7", "message": "Remove stray parameter doc", "committedDate": "2020-01-27T11:35:54Z", "type": "commit"}, {"oid": "b105eead1fbbcefbb85bc962749f2a12fa660bbe", "url": "https://github.com/vespa-engine/vespa/commit/b105eead1fbbcefbb85bc962749f2a12fa660bbe", "message": "Merge branch 'master' into hakonhall/remove-use-bucket-space-metric-feature-flag", "committedDate": "2020-04-20T08:36:33Z", "type": "commit"}]}