{"pr_number": 13846, "pr_title": "Delete expired locks (older than 1 day)", "pr_createdAt": "2020-07-09T09:38:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13846", "timeline": [{"oid": "8edf60cd8d701509a23a90712f1f97a71771d4a5", "url": "https://github.com/vespa-engine/vespa/commit/8edf60cd8d701509a23a90712f1f97a71771d4a5", "message": "Delete expired locks (older than 1 day)\n\n* There has never been any cleanup of locks, but until we started taking\n  a lock per session this has not been seen as an issue, since there were\n  few of them\n* Add code to maintainer that deletes locks older than 1 day", "committedDate": "2020-07-09T09:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyMzc0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452123745", "bodyText": "nit: the middle part of the message could be simplified to \" locks older than \"", "author": "gjoranv", "createdAt": "2020-07-09T10:34:56Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java", "diffHunk": "@@ -35,5 +35,9 @@ protected void maintain() {\n             int deleted = applicationRepository.deleteExpiredRemoteSessions(expiryTime);\n             log.log(LogLevel.FINE, \"Deleted \" + deleted + \" expired remote sessions, expiry time \" + expiryTime);\n         }\n+\n+        Duration lockExpiryTime = Duration.ofDays(1);\n+        int deleted = applicationRepository.deleteExpiredLocks(lockExpiryTime);\n+        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" expired locks, expiry time \" + lockExpiryTime);", "originalCommit": "8edf60cd8d701509a23a90712f1f97a71771d4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMTAzNA==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452131034", "bodyText": "thanks, will fix", "author": "hmusum", "createdAt": "2020-07-09T10:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyMzc0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java b/configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java\nindex 46b1f26a62..ec06336c80 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/maintenance/SessionsMaintainer.java\n\n@@ -38,6 +38,6 @@ public class SessionsMaintainer extends ConfigServerMaintainer {\n \n         Duration lockExpiryTime = Duration.ofDays(1);\n         int deleted = applicationRepository.deleteExpiredLocks(lockExpiryTime);\n-        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" expired locks, expiry time \" + lockExpiryTime);\n+        log.log(LogLevel.INFO, \"Deleted \" + deleted + \" locks older than \" + lockExpiryTime);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNDIyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452124221", "bodyText": "intended? I don't see any new usage in this PR.", "author": "gjoranv", "createdAt": "2020-07-09T10:35:51Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -665,7 +687,7 @@ public Lock lock(long sessionId) {\n         return curator.lock(lockPath(sessionId), Duration.ofMinutes(1)); // These locks shouldn't be held for very long.\n     }\n \n-    private Path lockPath(long sessionId) {\n+    public Path lockPath(long sessionId) {", "originalCommit": "8edf60cd8d701509a23a90712f1f97a71771d4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMDk4NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452130985", "bodyText": "I tried to write a test that needed this (but that was abandoned), so not anymore, will fix", "author": "hmusum", "createdAt": "2020-07-09T10:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNDIyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\nindex 312a574bb2..b3eb0342a2 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n\n@@ -687,7 +682,7 @@ public class SessionRepository {\n         return curator.lock(lockPath(sessionId), Duration.ofMinutes(1)); // These locks shouldn't be held for very long.\n     }\n \n-    public Path lockPath(long sessionId) {\n+    private Path lockPath(long sessionId) {\n         return locksPath.append(String.valueOf(sessionId));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyOTg2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452129863", "bodyText": "perhaps this should return an Optional instead, and empty where it now returns the current time?", "author": "gjoranv", "createdAt": "2020-07-09T10:47:21Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java", "diffHunk": "@@ -281,6 +282,27 @@ public int deleteExpiredRemoteSessions(Clock clock, Duration expiryTime) {\n         return deleted;\n     }\n \n+    public int deleteExpiredLocks(Clock clock, Duration expiryTime) {\n+        int deleted = 0;\n+        for (var lock : curator.getChildren(locksPath)) {\n+            Path path = locksPath.append(lock);\n+            if (zooKeeperNodeCreated(path).isBefore(clock.instant().minus(expiryTime))) {\n+                log.log(Level.INFO, \"Lock  \" + path + \" has expired, deleting it\");\n+                curator.delete(path);\n+                deleted++;\n+            }\n+        }\n+        return deleted;\n+    }\n+\n+    private Instant zooKeeperNodeCreated(Path path) {", "originalCommit": "8edf60cd8d701509a23a90712f1f97a71771d4a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMTIyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13846#discussion_r452131225", "bodyText": "Yes, probably better, thanks", "author": "hmusum", "createdAt": "2020-07-09T10:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyOTg2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\nindex 312a574bb2..b3eb0342a2 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/session/SessionRepository.java\n\n@@ -286,7 +285,7 @@ public class SessionRepository {\n         int deleted = 0;\n         for (var lock : curator.getChildren(locksPath)) {\n             Path path = locksPath.append(lock);\n-            if (zooKeeperNodeCreated(path).isBefore(clock.instant().minus(expiryTime))) {\n+            if (zooKeeperNodeCreated(path).orElse(clock.instant()).isBefore(clock.instant().minus(expiryTime))) {\n                 log.log(Level.INFO, \"Lock  \" + path + \" has expired, deleting it\");\n                 curator.delete(path);\n                 deleted++;\n"}}, {"oid": "4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "url": "https://github.com/vespa-engine/vespa/commit/4ffd74ae2eabd17e49f95427addb7ed82bf11ee7", "message": "Minor changes after review feedback", "committedDate": "2020-07-09T11:00:09Z", "type": "commit"}]}