{"pr_number": 14761, "pr_title": "Destroy visitor session in other thread to avoid deadlock, and 1000 q\u2026", "pr_createdAt": "2020-10-07T14:59:13Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14761", "timeline": [{"oid": "322f2c1d29e55aa798037193a4f13a48a137484f", "url": "https://github.com/vespa-engine/vespa/commit/322f2c1d29e55aa798037193a4f13a48a137484f", "message": "Destroy visitor session in other thread to avoid deadlock, and 1000 queue size", "committedDate": "2020-10-07T14:58:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMDg0Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14761#discussion_r501100847", "bodyText": "The executor must be shutdown in close/deconstruct", "author": "bjorncs", "createdAt": "2020-10-07T15:22:01Z", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/DocumentOperationExecutorImpl.java", "diffHunk": "@@ -85,6 +86,7 @@\n     private final DelayQueue throttled;\n     private final DelayQueue timeouts;\n     private final Map<VisitorControlHandler, VisitorSession> visits = new ConcurrentHashMap<>();\n+    private final Executor visitSessionShutdownExecutor = Executors.newSingleThreadExecutor();", "originalCommit": "322f2c1d29e55aa798037193a4f13a48a137484f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMjUzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14761#discussion_r501102535", "bodyText": "Also give the thread a name", "author": "bjorncs", "createdAt": "2020-10-07T15:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMDg0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "958ff2da163fbe254b7baae7522c845ecfef38ad", "chunk": "diff --git a/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/DocumentOperationExecutorImpl.java b/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/DocumentOperationExecutorImpl.java\nindex 79c6352268..1ebef12947 100644\n--- a/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/DocumentOperationExecutorImpl.java\n+++ b/vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/DocumentOperationExecutorImpl.java\n\n@@ -86,7 +86,7 @@ public class DocumentOperationExecutorImpl implements DocumentOperationExecutor\n     private final DelayQueue throttled;\n     private final DelayQueue timeouts;\n     private final Map<VisitorControlHandler, VisitorSession> visits = new ConcurrentHashMap<>();\n-    private final Executor visitSessionShutdownExecutor = Executors.newSingleThreadExecutor();\n+    private final ExecutorService visitSessionShutdownExecutor = Executors.newSingleThreadExecutor(new DaemonThreadFactory(\"visit-session-shutdown-\"));\n \n     public DocumentOperationExecutorImpl(ClusterListConfig clustersConfig, AllClustersBucketSpacesConfig bucketsConfig,\n                                          DocumentOperationExecutorConfig executorConfig, DocumentAccess access, Clock clock) {\n"}}, {"oid": "958ff2da163fbe254b7baae7522c845ecfef38ad", "url": "https://github.com/vespa-engine/vespa/commit/958ff2da163fbe254b7baae7522c845ecfef38ad", "message": "Shut down executor and use named thread", "committedDate": "2020-10-07T15:25:55Z", "type": "commit"}, {"oid": "10f3a803e1985b7bc1c09323d8da50f3eb2bbfd1", "url": "https://github.com/vespa-engine/vespa/commit/10f3a803e1985b7bc1c09323d8da50f3eb2bbfd1", "message": "Avoid wait(0)", "committedDate": "2020-10-07T17:25:43Z", "type": "commit"}]}