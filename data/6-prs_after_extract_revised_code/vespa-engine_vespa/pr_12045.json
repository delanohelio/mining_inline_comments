{"pr_number": 12045, "pr_title": "Bratseth/optimization on sddocname and recall", "pr_createdAt": "2020-02-03T12:24:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12045", "timeline": [{"oid": "2bd58b013477ff190b6a678666de5e3cee922ad9", "url": "https://github.com/vespa-engine/vespa/commit/2bd58b013477ff190b6a678666de5e3cee922ad9", "message": "Failed reproduction of https://github.com/vespa-engine/vespa/issues/11975", "committedDate": "2020-01-31T15:41:16Z", "type": "commit"}, {"oid": "ee7cccc90c0857e95898fe4cea21b875e2b6c85b", "url": "https://github.com/vespa-engine/vespa/commit/ee7cccc90c0857e95898fe4cea21b875e2b6c85b", "message": "Don't remove ranked terms when recalling all", "committedDate": "2020-02-03T12:20:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA4MjY2MA==", "url": "https://github.com/vespa-engine/vespa/pull/12045#discussion_r374082660", "bodyText": "if (isRanked(child)) return true;\nNo need to iterate all children if one is unhappy.", "author": "baldersheim", "createdAt": "2020-02-03T12:47:49Z", "path": "container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java", "diffHunk": "@@ -200,6 +204,21 @@ private static void removeOtherNonrankedChildren(CompositeItem parent, int index\n                 parent.removeItem(i);\n         }\n     }\n+\n+    private static boolean isRanked(Item item) {\n+        if (item instanceof CompositeItem) {\n+            boolean isRanked = false;\n+            for (Item child : ((CompositeItem)item).items())\n+                isRanked |= isRanked(child);", "originalCommit": "ee7cccc90c0857e95898fe4cea21b875e2b6c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "92864c3e09cda266a91a03c502c8941f5c9f0541", "chunk": "diff --git a/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java b/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\nindex e35994eb2a..5a936d42cc 100644\n--- a/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\n+++ b/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\n\n@@ -207,10 +207,9 @@ public class QueryRewrite {\n \n     private static boolean isRanked(Item item) {\n         if (item instanceof CompositeItem) {\n-            boolean isRanked = false;\n             for (Item child : ((CompositeItem)item).items())\n-                isRanked |= isRanked(child);\n-            return isRanked;\n+                if (isRanked(child)) return true;\n+            return false;\n         }\n         else if (item instanceof HasIndexItem && Hit.SDDOCNAME_FIELD.equals(((HasIndexItem)item).getIndexName())) {\n             return false; // No point in ranking by sddocname\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA4Mjc5NA==", "url": "https://github.com/vespa-engine/vespa/pull/12045#discussion_r374082794", "bodyText": "return false;", "author": "baldersheim", "createdAt": "2020-02-03T12:48:09Z", "path": "container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java", "diffHunk": "@@ -200,6 +204,21 @@ private static void removeOtherNonrankedChildren(CompositeItem parent, int index\n                 parent.removeItem(i);\n         }\n     }\n+\n+    private static boolean isRanked(Item item) {\n+        if (item instanceof CompositeItem) {\n+            boolean isRanked = false;\n+            for (Item child : ((CompositeItem)item).items())\n+                isRanked |= isRanked(child);\n+            return isRanked;", "originalCommit": "ee7cccc90c0857e95898fe4cea21b875e2b6c85b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA4NDk0NA==", "url": "https://github.com/vespa-engine/vespa/pull/12045#discussion_r374084944", "bodyText": "ok, done", "author": "bratseth", "createdAt": "2020-02-03T12:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA4Mjc5NA=="}], "type": "inlineReview", "revised_code": {"commit": "92864c3e09cda266a91a03c502c8941f5c9f0541", "chunk": "diff --git a/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java b/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\nindex e35994eb2a..5a936d42cc 100644\n--- a/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\n+++ b/container-search/src/main/java/com/yahoo/prelude/querytransform/QueryRewrite.java\n\n@@ -207,10 +207,9 @@ public class QueryRewrite {\n \n     private static boolean isRanked(Item item) {\n         if (item instanceof CompositeItem) {\n-            boolean isRanked = false;\n             for (Item child : ((CompositeItem)item).items())\n-                isRanked |= isRanked(child);\n-            return isRanked;\n+                if (isRanked(child)) return true;\n+            return false;\n         }\n         else if (item instanceof HasIndexItem && Hit.SDDOCNAME_FIELD.equals(((HasIndexItem)item).getIndexName())) {\n             return false; // No point in ranking by sddocname\n"}}, {"oid": "92864c3e09cda266a91a03c502c8941f5c9f0541", "url": "https://github.com/vespa-engine/vespa/commit/92864c3e09cda266a91a03c502c8941f5c9f0541", "message": "Short-circuit if true", "committedDate": "2020-02-03T12:51:56Z", "type": "commit"}]}