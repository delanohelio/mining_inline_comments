{"pr_number": 13688, "pr_title": "Set spare count 0 where we can provision on demand MERGEOK", "pr_createdAt": "2020-06-24T10:34:48Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13688", "timeline": [{"oid": "9ac30a7be83d3a0965fa49fdd2bffa5bd09f571b", "url": "https://github.com/vespa-engine/vespa/commit/9ac30a7be83d3a0965fa49fdd2bffa5bd09f571b", "message": "Set spare count 0 where we can provision on demand", "committedDate": "2020-06-24T10:34:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODU2OA==", "url": "https://github.com/vespa-engine/vespa/pull/13688#discussion_r444808568", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                         zone.environment().isProduction() && provisionServiceProvider.getHostProvisioner().isEmpty() ? 1 : 0);\n          \n          \n            \n                         zone.environment().isProduction() && ! zone.getCloud().dynamicProvisioning() ? 1 : 0);", "author": "bratseth", "createdAt": "2020-06-24T10:49:45Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/NodeRepository.java", "diffHunk": "@@ -124,7 +123,7 @@ public NodeRepository(NodeRepositoryConfig config,\n              new DnsNameResolver(),\n              DockerImage.fromString(config.dockerImage()), config.useCuratorClientCache(),\n              provisionServiceProvider.getHostProvisioner().isPresent(),\n-             zone.environment() == Environment.prod ? 1 : 0);\n+             zone.environment().isProduction() && provisionServiceProvider.getHostProvisioner().isEmpty() ? 1 : 0);", "originalCommit": "9ac30a7be83d3a0965fa49fdd2bffa5bd09f571b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwOTQ3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13688#discussion_r444809472", "bodyText": "This wont exclude cd-aws-us-east-1a", "author": "freva", "createdAt": "2020-06-24T10:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxNDQyNg==", "url": "https://github.com/vespa-engine/vespa/pull/13688#discussion_r444814426", "bodyText": "Because we pre-provision there? I think we should correct the definition for it then. dynamicProvisioning() definition:\n\n/** Returns whether this can provision hosts dynamically */\n\nAnd that looks to me like the exact right condition for when we should have spares.", "author": "bratseth", "createdAt": "2020-06-24T11:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxODEyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13688#discussion_r444818121", "bodyText": "... looks like we need to know both whether it can and if it wants to always provision dynamically ... or something. We should clean up this stuff, but independent of this PR.", "author": "bratseth", "createdAt": "2020-06-24T11:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODU2OA=="}], "type": "inlineReview", "revised_code": null}]}