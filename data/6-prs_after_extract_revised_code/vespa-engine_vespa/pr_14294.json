{"pr_number": 14294, "pr_title": "Jonmv/feed client error code handling", "pr_createdAt": "2020-09-04T15:08:25Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14294", "timeline": [{"oid": "7ed06b86cf547d1cbb33878a224af7488b6ecb0e", "url": "https://github.com/vespa-engine/vespa/commit/7ed06b86cf547d1cbb33878a224af7488b6ecb0e", "message": "Simplify", "committedDate": "2020-09-04T15:08:01Z", "type": "commit"}, {"oid": "dca8a74a0a96739912343962c5857d9e6d4f67c1", "url": "https://github.com/vespa-engine/vespa/commit/dca8a74a0a96739912343962c5857d9e6d4f67c1", "message": "Fail all queued documents on 401 or 403 (will repeat until done)", "committedDate": "2020-09-04T15:08:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODAwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484238004", "bodyText": "If we want to we could exit, but I'm not sure it's always the best thing to do since there could be a fix to the problem rolling out simultaneously, we could be feeding to multiple clusters etc. I think in general this client wants to keep trying until timeout, for better or worse.", "author": "bratseth", "createdAt": "2020-09-07T07:37:54Z", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -348,11 +347,16 @@ private ConnectionState cycle(ConnectionState connectionState) {\n                     currentConnection.handshake();\n                     successfulHandshakes.getAndIncrement();\n                 } catch (ServerResponseException ser) {\n+                    int code = ser.getResponseCode();\n+                    if (code == 401 || code == 403) {\n+                        drainDocumentQueueWhenFailingPermanently(new Exception(\"Denied access by endpoint:\" + ser.getResponseString()));\n+                        log.log(Level.SEVERE, \"Failed authentication or authorization with '\" + endpoint + \"': \" + Exceptions.toMessageString(ser));\n+                        return ConnectionState.CONNECTED; // Should ideally exit immediately, instead of doing this per X documents :/", "originalCommit": "dca8a74a0a96739912343962c5857d9e6d4f67c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NzYxNg==", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484257616", "bodyText": "Yep.", "author": "jonmv", "createdAt": "2020-09-07T08:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODAwNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODk5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484238999", "bodyText": "Thanks for dissolving my math! I just wrote down the function I had in mind \ud83d\ude1d", "author": "bratseth", "createdAt": "2020-09-07T07:39:57Z", "path": "vespa-http-client/src/main/java/com/yahoo/vespa/http/client/core/communication/IOThread.java", "diffHunk": "@@ -595,12 +599,9 @@ private boolean timeToPoll(GatewayConnection connection) {\n             if (connection.lastPollTime() == null) return true;\n \n             // Exponential (2^x) dropoff:\n-            double unit = pollIntervalUS / 1000.0;\n-            double x = (  clock.millis() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-            double lastX = (  connection.lastPollTime().toEpochMilli() - connection.connectionTime().plus(connectionTimeToLive).toEpochMilli() ) / unit;\n-\n-            double currentDelayDoublings = Math.log(lastX)/Math.log(2);\n-            return (x - lastX) > Math.pow(2, currentDelayDoublings);\n+            double connectionEndOfLife = connection.connectionTime().plus(connectionTimeToLive).toEpochMilli();\n+            double connectionLastPolled = connection.lastPollTime().toEpochMilli();\n+            return clock.millis() - connectionEndOfLife > 2 * (connectionLastPolled - connectionEndOfLife);", "originalCommit": "dca8a74a0a96739912343962c5857d9e6d4f67c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NzI5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14294#discussion_r484257299", "bodyText": "\ud83d\ude1c", "author": "jonmv", "createdAt": "2020-09-07T07:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzODk5OQ=="}], "type": "inlineReview", "revised_code": null}]}