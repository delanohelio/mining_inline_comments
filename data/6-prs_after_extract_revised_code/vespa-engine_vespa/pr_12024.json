{"pr_number": 12024, "pr_title": "Handle empty source revision", "pr_createdAt": "2020-01-31T14:15:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12024", "timeline": [{"oid": "c49feda53eef265802aff4b5e8fc1c8160bdc167", "url": "https://github.com/vespa-engine/vespa/commit/c49feda53eef265802aff4b5e8fc1c8160bdc167", "message": "Handle empty source revision", "committedDate": "2020-01-31T14:13:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5ODQ2Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12024#discussion_r373598466", "bodyText": "@jonmv This was the bug. When source revision is empty, no fields are written to the latestVersion object, but the object itself is created, thus becoming an unknown version. Subsequent reads fail because the Application constructor throws if latestVersion is unknown so fromSlime/toSlime is asymmetric.\n\nWhat are the other changes here?\n\nCleanup of SourceRevision. SourceRevision where all fields are empty is now treated as an empty source revision.\nThe fact they can be empty might point to a bug or lack of validation in the submission API?", "author": "mpolden", "createdAt": "2020-01-31T17:35:53Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/persistence/ApplicationSerializer.java", "diffHunk": "@@ -258,15 +258,13 @@ private void zoneIdToSlime(ZoneId zone, Cursor object) {\n     }\n \n     private void toSlime(ApplicationVersion applicationVersion, Cursor object) {\n-        if (applicationVersion.buildNumber().isPresent() && applicationVersion.source().isPresent()) {", "originalCommit": "c49feda53eef265802aff4b5e8fc1c8160bdc167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMDE0Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12024#discussion_r373610143", "bodyText": "Yes, this was the bug. We still have serialised unknown latestVersions, though? Or did you clean them out by hand?\nAre the fields all empty? I'd imagine the commit field wasn't. The plan was to remove SourceRevision, since they're only used for the commit and the generated source URLs.", "author": "jonmv", "createdAt": "2020-01-31T18:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5ODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY0ODMxNg==", "url": "https://github.com/vespa-engine/vespa/pull/12024#discussion_r373648316", "bodyText": "Or did you clean them out by hand?\n\nYes.\n\nAre the fields all empty?\n\nIn the production data, sourceRevision is either a) null, b) an object with all non-empty fields or c) an object with all empty fields.", "author": "mpolden", "createdAt": "2020-01-31T19:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5ODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1MDYzMg==", "url": "https://github.com/vespa-engine/vespa/pull/12024#discussion_r373650632", "bodyText": "The plan was to remove SourceRevision.\n\nPlease do! \ud83d\udd25", "author": "mpolden", "createdAt": "2020-01-31T19:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5ODQ2Ng=="}], "type": "inlineReview", "revised_code": null}]}