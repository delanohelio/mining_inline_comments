{"pr_number": 14088, "pr_title": "Quotas in the configuration server ", "pr_createdAt": "2020-08-18T12:21:31Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14088", "timeline": [{"oid": "09cf2d8732627f3499dfa216587c34d6f6a29a67", "url": "https://github.com/vespa-engine/vespa/commit/09cf2d8732627f3499dfa216587c34d6f6a29a67", "message": "Create a quota JSON encoded parameter", "committedDate": "2020-08-17T12:06:09Z", "type": "commit"}, {"oid": "e8dd34f536526bed82f19e60e92b98035694764e", "url": "https://github.com/vespa-engine/vespa/commit/e8dd34f536526bed82f19e60e92b98035694764e", "message": "Propagate quota from PrepareParams to ModelContext.Properties", "committedDate": "2020-08-18T07:37:48Z", "type": "commit"}, {"oid": "84ce756ab8aade82759e9ffdf8101915633f8ede", "url": "https://github.com/vespa-engine/vespa/commit/84ce756ab8aade82759e9ffdf8101915633f8ede", "message": "Persist quota and read it back", "committedDate": "2020-08-18T11:05:59Z", "type": "commit"}, {"oid": "2d09d33d7e224e1699ad923937cdd29053f9133d", "url": "https://github.com/vespa-engine/vespa/commit/2d09d33d7e224e1699ad923937cdd29053f9133d", "message": "Check maxClusterSize quota in Validator step", "committedDate": "2020-08-20T14:38:37Z", "type": "commit"}, {"oid": "8fdc33273c6993ea983cf7f3211a0a2628890f17", "url": "https://github.com/vespa-engine/vespa/commit/8fdc33273c6993ea983cf7f3211a0a2628890f17", "message": "Merge branch 'master' into ogronnesby/configserver-quota", "committedDate": "2020-08-24T07:16:04Z", "type": "commit"}, {"oid": "24ed7ae1a12840c6c5aa5080fe8ca13a67c371e7", "url": "https://github.com/vespa-engine/vespa/commit/24ed7ae1a12840c6c5aa5080fe8ca13a67c371e7", "message": "Default to Quota.empty() in TestProperties", "committedDate": "2020-08-24T11:57:06Z", "type": "commit"}, {"oid": "257f4b21f4755efc29e51738e919029610e04e98", "url": "https://github.com/vespa-engine/vespa/commit/257f4b21f4755efc29e51738e919029610e04e98", "message": "Merge branch 'ogronnesby/configserver-quota' of github.com:vespa-engine/vespa into ogronnesby/configserver-quota", "committedDate": "2020-08-24T11:57:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjMyMg==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536322", "bodyText": "Add javadoc and author. Quota for what? \ud83d\ude42", "author": "mpolden", "createdAt": "2020-08-24T11:33:51Z", "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {", "originalCommit": "8fdc33273c6993ea983cf7f3211a0a2628890f17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "chunk": "diff --git a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\nindex 814f1b62c8..cb600bc0a5 100644\n--- a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n+++ b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.config.model.api;\n \n import com.yahoo.slime.Inspector;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNjkwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475536905", "bodyText": "Nit: Consider OptionalInt.", "author": "mpolden", "createdAt": "2020-08-24T11:35:03Z", "path": "config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.yahoo.config.model.api;\n+\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+import com.yahoo.slime.SlimeUtils;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+public class Quota {\n+    private final Optional<Integer> maxClusterSize;\n+    private final Optional<Integer> budget;", "originalCommit": "8fdc33273c6993ea983cf7f3211a0a2628890f17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "chunk": "diff --git a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\nindex 814f1b62c8..cb600bc0a5 100644\n--- a/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n+++ b/config-model-api/src/main/java/com/yahoo/config/model/api/Quota.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.config.model.api;\n \n import com.yahoo.slime.Inspector;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNzIwMw==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475537203", "bodyText": "IllegalArgumentException?", "author": "mpolden", "createdAt": "2020-08-24T11:35:42Z", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {\n+    @Override\n+    public void validate(VespaModel model, DeployState deployState) {\n+        var quota = deployState.getProperties().quota();\n+        quota.maxClusterSize().ifPresent(maxClusterSize -> validateMaxClusterSize(maxClusterSize, model));\n+    }\n+\n+    private void validateMaxClusterSize(int maxClusterSize, VespaModel model) {\n+        var invalidClusters = model.allClusters().stream()\n+                .filter(clusterId -> {\n+                    var cluster = model.provisioned().all().get(clusterId);\n+                    var clusterSize = cluster.maxResources().nodes();\n+                    return clusterSize > maxClusterSize;\n+                })\n+                .map(ClusterSpec.Id::value)\n+                .collect(Collectors.toList());\n+\n+        if (!invalidClusters.isEmpty()) {\n+            // TODO(ogronnesby): Find better exception", "originalCommit": "8fdc33273c6993ea983cf7f3211a0a2628890f17", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "chunk": "diff --git a/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java b/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\nindex ddb469811c..6670b7ce94 100644\n--- a/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\n+++ b/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.vespa.model.application.validation;\n \n import com.yahoo.config.model.deploy.DeployState;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjM4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556382", "bodyText": "Nit: Consider OptionalLong.", "author": "mpolden", "createdAt": "2020-08-24T12:16:12Z", "path": "vespajlib/src/main/java/com/yahoo/slime/SlimeUtils.java", "diffHunk": "@@ -124,6 +124,13 @@ public static Slime jsonToSlimeOrThrow(byte[] json) {\n         return Optional.of(inspector.asString()).filter(s -> !s.isEmpty());\n     }\n \n+    public static Optional<Long> optionalLong(Inspector inspector) {", "originalCommit": "257f4b21f4755efc29e51738e919029610e04e98", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjkwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475556905", "bodyText": "Add javadoc and author.", "author": "mpolden", "createdAt": "2020-08-24T12:17:12Z", "path": "config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.deploy.DeployState;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.vespa.model.VespaModel;\n+\n+import java.util.stream.Collectors;\n+\n+public class QuotaValidator extends Validator {", "originalCommit": "257f4b21f4755efc29e51738e919029610e04e98", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "chunk": "diff --git a/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java b/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\nindex ddb469811c..6670b7ce94 100644\n--- a/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\n+++ b/config-model/src/main/java/com/yahoo/vespa/model/application/validation/QuotaValidator.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.vespa.model.application.validation;\n \n import com.yahoo.config.model.deploy.DeployState;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NzM3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14088#discussion_r475557376", "bodyText": "Missing author.", "author": "mpolden", "createdAt": "2020-08-24T12:18:09Z", "path": "config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.yahoo.vespa.model.application.validation;\n+\n+import com.yahoo.config.model.api.Quota;\n+import com.yahoo.config.model.deploy.TestProperties;\n+import com.yahoo.config.provision.Environment;\n+import org.junit.Test;\n+\n+import java.util.Optional;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class QuotaValidatorTest {", "originalCommit": "257f4b21f4755efc29e51738e919029610e04e98", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "chunk": "diff --git a/config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java b/config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java\nindex 1855701cdc..f8aa3fd529 100644\n--- a/config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java\n+++ b/config-model/src/test/java/com/yahoo/vespa/model/application/validation/QuotaValidatorTest.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.vespa.model.application.validation;\n \n import com.yahoo.config.model.api.Quota;\n"}}, {"oid": "e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "url": "https://github.com/vespa-engine/vespa/commit/e0b3c2a58afc92b1c4ac07babd8c00c1ec087230", "message": "Javadoc and authors", "committedDate": "2020-08-24T13:21:14Z", "type": "commit"}, {"oid": "728cac3f63f404bd9ed21d16dbd6b6d9680a014e", "url": "https://github.com/vespa-engine/vespa/commit/728cac3f63f404bd9ed21d16dbd6b6d9680a014e", "message": "Merge remote-tracking branch 'origin/master' into ogronnesby/configserver-quota", "committedDate": "2020-08-25T07:53:42Z", "type": "commit"}, {"oid": "177be35feddd2f9916b4b60dd1f0d21f926d4526", "url": "https://github.com/vespa-engine/vespa/commit/177be35feddd2f9916b4b60dd1f0d21f926d4526", "message": "Fix parameter type after it was changed on master", "committedDate": "2020-08-25T07:54:48Z", "type": "commit"}]}