{"pr_number": 14550, "pr_title": "Jonmv/async doc v1", "pr_createdAt": "2020-09-25T08:38:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14550", "timeline": [{"oid": "0d12e6650c20799240eb9324ef426745d70ee58f", "url": "https://github.com/vespa-engine/vespa/commit/0d12e6650c20799240eb9324ef426745d70ee58f", "message": "Non-functional changes", "committedDate": "2020-09-25T07:34:43Z", "type": "commit"}, {"oid": "f6d6f0db9f6dab4a48aea33dd8c41b28ff624ad5", "url": "https://github.com/vespa-engine/vespa/commit/f6d6f0db9f6dab4a48aea33dd8c41b28ff624ad5", "message": "Let the injectable lazy document access be specifically injected", "committedDate": "2020-09-25T07:53:42Z", "type": "commit"}, {"oid": "17c6dc3a23badb17f468fe8b38bda57eab717a4c", "url": "https://github.com/vespa-engine/vespa/commit/17c6dc3a23badb17f468fe8b38bda57eab717a4c", "message": "Eliminate config self-subscription from MessageBusDocumentAccess", "committedDate": "2020-09-25T08:37:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg0NDY2NA==", "url": "https://github.com/vespa-engine/vespa/pull/14550#discussion_r494844664", "bodyText": "This lets us use this in internal classes as well, without fear that the user may have configured their own DocumentAccess component.", "author": "jonmv", "createdAt": "2020-09-25T08:52:37Z", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java", "diffHunk": "@@ -27,18 +27,18 @@\n  *\n  * @author jonmv\n  */\n-public class MessageBusDocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccess> {\n+public class DocumentAccessProvider extends AbstractComponent implements Provider<DocumentAccessProvider.LazyWrapper> {", "originalCommit": "f6d6f0db9f6dab4a48aea33dd8c41b28ff624ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cd240de82eedbad02868290c89036e91d3f8e7d", "chunk": "diff --git a/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java b/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\nindex 1fc156d4e9..6eb80ae1aa 100644\n--- a/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\n+++ b/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\n\n@@ -1,25 +1,11 @@\n package com.yahoo.container.core.documentapi;\n \n import com.google.inject.Inject;\n+import com.yahoo.cloud.config.SlobroksConfig;\n import com.yahoo.component.AbstractComponent;\n import com.yahoo.container.di.componentgraph.Provider;\n import com.yahoo.document.config.DocumentmanagerConfig;\n-import com.yahoo.document.select.parser.ParseException;\n-import com.yahoo.documentapi.AsyncParameters;\n-import com.yahoo.documentapi.AsyncSession;\n-import com.yahoo.documentapi.DocumentAccess;\n-import com.yahoo.documentapi.DocumentAccessParams;\n-import com.yahoo.documentapi.SubscriptionParameters;\n-import com.yahoo.documentapi.SubscriptionSession;\n-import com.yahoo.documentapi.SyncParameters;\n-import com.yahoo.documentapi.SyncSession;\n-import com.yahoo.documentapi.VisitorDestinationParameters;\n-import com.yahoo.documentapi.VisitorDestinationSession;\n-import com.yahoo.documentapi.VisitorParameters;\n-import com.yahoo.documentapi.VisitorSession;\n-import com.yahoo.documentapi.messagebus.MessageBusDocumentAccess;\n-import com.yahoo.documentapi.messagebus.MessageBusParams;\n-import com.yahoo.documentapi.messagebus.loadtypes.LoadTypeSet;\n+import com.yahoo.messagebus.MessagebusConfig;\n import com.yahoo.vespa.config.content.LoadTypeConfig;\n \n /**\n"}}, {"oid": "2cd240de82eedbad02868290c89036e91d3f8e7d", "url": "https://github.com/vespa-engine/vespa/commit/2cd240de82eedbad02868290c89036e91d3f8e7d", "message": "Move injectable lazy document access to top level and rename to VespaDocumentAccess", "committedDate": "2020-09-25T09:23:06Z", "type": "commit"}, {"oid": "1ce342752d01f2118688d9a7016944b98c4946b1", "url": "https://github.com/vespa-engine/vespa/commit/1ce342752d01f2118688d9a7016944b98c4946b1", "message": "Update abi spec", "committedDate": "2020-09-25T09:23:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4MDMwOA==", "url": "https://github.com/vespa-engine/vespa/pull/14550#discussion_r494880308", "bodyText": "Add copyright header to your intellij template :)", "author": "bjorncs", "createdAt": "2020-09-25T09:55:20Z", "path": "container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.yahoo.container.core.documentapi;", "originalCommit": "1ce342752d01f2118688d9a7016944b98c4946b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg5MjMzMg==", "url": "https://github.com/vespa-engine/vespa/pull/14550#discussion_r494892332", "bodyText": "Done!", "author": "jonmv", "createdAt": "2020-09-25T10:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4MDMwOA=="}], "type": "inlineReview", "revised_code": {"commit": "e51cf8cde83e94a1ce33bdc1ff00301851f5f165", "chunk": "diff --git a/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java b/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\nindex 6eb80ae1aa..5e3f873bba 100644\n--- a/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\n+++ b/container-core/src/main/java/com/yahoo/container/core/documentapi/DocumentAccessProvider.java\n\n@@ -1,3 +1,4 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.container.core.documentapi;\n \n import com.google.inject.Inject;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4MDg4NA==", "url": "https://github.com/vespa-engine/vespa/pull/14550#discussion_r494880884", "bodyText": "Consider adding warning in log if self-subscription", "author": "bjorncs", "createdAt": "2020-09-25T09:56:28Z", "path": "documentapi/src/main/java/com/yahoo/documentapi/messagebus/MessageBusDocumentAccess.java", "diffHunk": "@@ -60,7 +60,9 @@ public MessageBusDocumentAccess(MessageBusParams params) {\n                 bus = new NetworkMessageBus(network, new MessageBus(network, mbusParams));\n             }\n             else {\n-                bus = new RPCMessageBus(mbusParams, params.getRPCNetworkParams(), params.getRoutingConfigId());\n+                bus = params.getRPCNetworkParams().getSlobroksConfig() != null && mbusParams.getMessageBusConfig() != null\n+                      ? new RPCMessageBus(mbusParams, params.getRPCNetworkParams()) // prefer without self-subscription if config is set\n+                      : new RPCMessageBus(mbusParams, params.getRPCNetworkParams(), params.getRoutingConfigId());", "originalCommit": "1ce342752d01f2118688d9a7016944b98c4946b1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e51cf8cde83e94a1ce33bdc1ff00301851f5f165", "chunk": "diff --git a/documentapi/src/main/java/com/yahoo/documentapi/messagebus/MessageBusDocumentAccess.java b/documentapi/src/main/java/com/yahoo/documentapi/messagebus/MessageBusDocumentAccess.java\nindex 3e35e9bd12..8b1e25758a 100644\n--- a/documentapi/src/main/java/com/yahoo/documentapi/messagebus/MessageBusDocumentAccess.java\n+++ b/documentapi/src/main/java/com/yahoo/documentapi/messagebus/MessageBusDocumentAccess.java\n\n@@ -60,9 +64,12 @@ public class MessageBusDocumentAccess extends DocumentAccess {\n                 bus = new NetworkMessageBus(network, new MessageBus(network, mbusParams));\n             }\n             else {\n-                bus = params.getRPCNetworkParams().getSlobroksConfig() != null && mbusParams.getMessageBusConfig() != null\n-                      ? new RPCMessageBus(mbusParams, params.getRPCNetworkParams()) // prefer without self-subscription if config is set\n-                      : new RPCMessageBus(mbusParams, params.getRPCNetworkParams(), params.getRoutingConfigId());\n+                if (params.getRPCNetworkParams().getSlobroksConfig() != null && mbusParams.getMessageBusConfig() != null)\n+                    bus = new RPCMessageBus(mbusParams, params.getRPCNetworkParams());\n+                else {\n+                    log.log(Level.INFO, \"Setting up self-subscription to config because explicit config was missing;\u00a0try to avoid this in containers\");\n+                    bus = new RPCMessageBus(mbusParams, params.getRPCNetworkParams(), params.getRoutingConfigId());\n+                }\n             }\n         }\n         catch (Exception e) {\n"}}, {"oid": "e51cf8cde83e94a1ce33bdc1ff00301851f5f165", "url": "https://github.com/vespa-engine/vespa/commit/e51cf8cde83e94a1ce33bdc1ff00301851f5f165", "message": "Log on self-subscroption and fix copyright hreaders", "committedDate": "2020-09-25T10:15:04Z", "type": "commit"}, {"oid": "77978067f2c6eddedfbb08ae7abc732f18adfd8e", "url": "https://github.com/vespa-engine/vespa/commit/77978067f2c6eddedfbb08ae7abc732f18adfd8e", "message": "Refer to correct class i config model", "committedDate": "2020-09-25T10:18:14Z", "type": "commit"}]}