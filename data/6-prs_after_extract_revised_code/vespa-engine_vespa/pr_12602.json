{"pr_number": 12602, "pr_title": "Gjoranv/concurrent metrics retriever", "pr_createdAt": "2020-03-17T16:12:18Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12602", "timeline": [{"oid": "1f6ca96d4ee3081faa9f14bb69b72faebf25d212", "url": "https://github.com/vespa-engine/vespa/commit/1f6ca96d4ee3081faa9f14bb69b72faebf25d212", "message": "Don't recreate the thread pool upon exceptions.", "committedDate": "2020-03-17T15:57:20Z", "type": "commit"}, {"oid": "56ccfebb300ea7338e740544ce336bf9b50a7885", "url": "https://github.com/vespa-engine/vespa/commit/56ccfebb300ea7338e740544ce336bf9b50a7885", "message": "Use a synchronizedMap for metrics snapshots for each node.", "committedDate": "2020-03-17T16:12:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDY5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393800692", "bodyText": "Use ConcurrentHashMap instead. I am pretty sure that Collections.synchronizedMap may thrown ConcurrentModificationException if the map is iterated on concurrently with mutating operations.", "author": "bjorncs", "createdAt": "2020-03-17T16:16:39Z", "path": "metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java", "diffHunk": "@@ -41,7 +42,7 @@\n     private final HttpClient httpClient;\n     private final Clock clock;\n \n-    private final Map<ConsumerId, Snapshot> snapshots = new HashMap<>();\n+    private final Map<ConsumerId, Snapshot> snapshots = Collections.synchronizedMap(new HashMap<>());", "originalCommit": "56ccfebb300ea7338e740544ce336bf9b50a7885", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMjg5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393802897", "bodyText": "Yes, you are right.", "author": "gjoranv", "createdAt": "2020-03-17T16:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDY5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "chunk": "diff --git a/metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java b/metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java\nindex f5f9daef94..145eef3f74 100644\n--- a/metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java\n+++ b/metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/NodeMetricsClient.java\n\n@@ -42,7 +43,7 @@ public class NodeMetricsClient {\n     private final HttpClient httpClient;\n     private final Clock clock;\n \n-    private final Map<ConsumerId, Snapshot> snapshots = Collections.synchronizedMap(new HashMap<>());\n+    private final Map<ConsumerId, Snapshot> snapshots = new ConcurrentHashMap<>();\n     private long snapshotsRetrieved = 0;\n \n     NodeMetricsClient(HttpClient httpClient, Node node, Clock clock) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDk0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393800941", "bodyText": "Consider making forkJoinPool final.", "author": "bjorncs", "createdAt": "2020-03-17T16:16:59Z", "path": "metrics-proxy/src/main/java/ai/vespa/metricsproxy/http/application/ApplicationMetricsRetriever.java", "diffHunk": "@@ -82,8 +82,6 @@ public void deconstruct() {\n \n         } catch (Exception e) {\n             // Since the task is a ForkJoinTask, we don't need special handling of InterruptedException\n-            forkJoinPool.shutdownNow();", "originalCommit": "1f6ca96d4ee3081faa9f14bb69b72faebf25d212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwNjc4MA==", "url": "https://github.com/vespa-engine/vespa/pull/12602#discussion_r393806780", "bodyText": "Thanks, I forgot.", "author": "gjoranv", "createdAt": "2020-03-17T16:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMDk0MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "url": "https://github.com/vespa-engine/vespa/commit/1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "message": "Use a ConcurrentHashMap for metrics snapshots for each node.", "committedDate": "2020-03-17T16:23:53Z", "type": "commit"}, {"oid": "1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "url": "https://github.com/vespa-engine/vespa/commit/1d1c1a2d52be87944f960375ccd8b17c21bea8c7", "message": "Use a ConcurrentHashMap for metrics snapshots for each node.", "committedDate": "2020-03-17T16:23:53Z", "type": "forcePushed"}, {"oid": "f67a70e76e628d558b244c99c61f805a97ca1adc", "url": "https://github.com/vespa-engine/vespa/commit/f67a70e76e628d558b244c99c61f805a97ca1adc", "message": "Declare the thread pool final.", "committedDate": "2020-03-17T16:25:08Z", "type": "commit"}]}