{"pr_number": 15441, "pr_title": "Report metric for non-active nodes", "pr_createdAt": "2020-11-24T12:06:57Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15441", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ5OTkyOA==", "url": "https://github.com/vespa-engine/vespa/pull/15441#discussion_r529499928", "bodyText": "byCluster?", "author": "bratseth", "createdAt": "2020-11-24T12:14:09Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MetricsReporter.java", "diffHunk": "@@ -70,9 +72,38 @@ public boolean maintain() {\n         updateLockMetrics();\n         updateDockerMetrics(nodes);\n         updateTenantUsageMetrics(nodes);\n+        updateAllocationMetrics(nodes);\n         return true;\n     }\n \n+    private void updateAllocationMetrics(NodeList nodes) {\n+        Map<ClusterKey, List<Node>> byApplication = nodes.stream()", "originalCommit": "493c2df9ffe6bd846dade947104ad200d2e42961", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUxNTg4NA==", "url": "https://github.com/vespa-engine/vespa/pull/15441#discussion_r529515884", "bodyText": "Yes, thanks. Fixed!", "author": "mpolden", "createdAt": "2020-11-24T12:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ5OTkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "fade2716cb016e07d9d8d273d7f8af7aaed00b36", "chunk": "diff --git a/node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MetricsReporter.java b/node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MetricsReporter.java\nindex 1f950f3d84..a598e042d0 100644\n--- a/node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MetricsReporter.java\n+++ b/node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MetricsReporter.java\n\n@@ -77,10 +77,10 @@ public class MetricsReporter extends NodeRepositoryMaintainer {\n     }\n \n     private void updateAllocationMetrics(NodeList nodes) {\n-        Map<ClusterKey, List<Node>> byApplication = nodes.stream()\n-                                                            .filter(node -> node.allocation().isPresent())\n-                                                            .collect(Collectors.groupingBy(node -> new ClusterKey(node.allocation().get().owner(), node.allocation().get().membership().cluster().id())));\n-        byApplication.forEach((clusterKey, allocatedNodes) -> {\n+        Map<ClusterKey, List<Node>> byCluster = nodes.stream()\n+                                                     .filter(node -> node.allocation().isPresent())\n+                                                     .collect(Collectors.groupingBy(node -> new ClusterKey(node.allocation().get().owner(), node.allocation().get().membership().cluster().id())));\n+        byCluster.forEach((clusterKey, allocatedNodes) -> {\n             int activeNodes = 0;\n             int nonActiveNodes = 0;\n             for (var node : allocatedNodes) {\n"}}, {"oid": "fade2716cb016e07d9d8d273d7f8af7aaed00b36", "url": "https://github.com/vespa-engine/vespa/commit/fade2716cb016e07d9d8d273d7f8af7aaed00b36", "message": "Report metric for non-active nodes", "committedDate": "2020-11-24T12:41:44Z", "type": "forcePushed"}, {"oid": "d7013eef05cd91a49640d479c100652d4a792b93", "url": "https://github.com/vespa-engine/vespa/commit/d7013eef05cd91a49640d479c100652d4a792b93", "message": "Report metric for non-active nodes", "committedDate": "2020-11-24T13:33:00Z", "type": "commit"}, {"oid": "d7013eef05cd91a49640d479c100652d4a792b93", "url": "https://github.com/vespa-engine/vespa/commit/d7013eef05cd91a49640d479c100652d4a792b93", "message": "Report metric for non-active nodes", "committedDate": "2020-11-24T13:33:00Z", "type": "forcePushed"}]}