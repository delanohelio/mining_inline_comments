{"pr_number": 15010, "pr_title": "Add type resolving for ONNX models", "pr_createdAt": "2020-10-22T12:53:22Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15010", "timeline": [{"oid": "3594ad3bfce131b317d9c073b16eb47a7983be4d", "url": "https://github.com/vespa-engine/vespa/commit/3594ad3bfce131b317d9c073b16eb47a7983be4d", "message": "Add type resolving for ONNX models", "committedDate": "2020-10-22T12:36:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2Nzg3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15010#discussion_r510667876", "bodyText": "This seems like a hack to me but I guess it will work. I think we should be able to ask the application package to give us the file regardless of how it is stored in the implementation class.\nThere's probably more than enough in the PR already, but we should follow it up somehow. @hmusum any thoughts on this?", "author": "bratseth", "createdAt": "2020-10-23T06:44:12Z", "path": "config-model/src/main/java/com/yahoo/searchdefinition/processing/OnnxModelTypeResolver.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+package com.yahoo.searchdefinition.processing;\n+\n+import com.yahoo.cloud.config.ConfigserverConfig;\n+import com.yahoo.component.Version;\n+import com.yahoo.config.FileReference;\n+import com.yahoo.config.application.api.ApplicationFile;\n+import com.yahoo.config.application.api.ApplicationPackage;\n+import com.yahoo.config.application.api.DeployLogger;\n+import com.yahoo.config.application.api.FileRegistry;\n+import com.yahoo.path.Path;\n+import com.yahoo.searchdefinition.OnnxModel;\n+import com.yahoo.searchdefinition.RankProfileRegistry;\n+import com.yahoo.searchdefinition.Search;\n+import com.yahoo.searchdefinition.expressiontransforms.OnnxModelTransformer;\n+import com.yahoo.vespa.defaults.Defaults;\n+import com.yahoo.vespa.model.container.search.QueryProfiles;\n+import onnx.Onnx;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Processes every \"onnx-model\" element in the schema. Parses the model file,\n+ * adds missing input and output mappings (assigning default names), and\n+ * adds tensor types to all model inputs and outputs.\n+ *\n+ * Must be processed before RankingExpressingTypeResolver.\n+ *\n+ * @author lesters\n+ */\n+public class OnnxModelTypeResolver extends Processor {\n+\n+    public OnnxModelTypeResolver(Search search, DeployLogger deployLogger, RankProfileRegistry rankProfileRegistry, QueryProfiles queryProfiles) {\n+        super(search, deployLogger, rankProfileRegistry, queryProfiles);\n+    }\n+\n+    @Override\n+    public void process(boolean validate, boolean documentsOnly) {\n+        if (documentsOnly) return;\n+\n+        for (Map.Entry<String, OnnxModel> entry : search.onnxModels().asMap().entrySet())  {\n+            OnnxModel modelConfig = entry.getValue();\n+            try (InputStream inputStream = openModelFile(modelConfig.getFilePath())) {\n+                Onnx.ModelProto model = Onnx.ModelProto.parseFrom(inputStream);\n+\n+                // Model inputs - if not defined, assumes a function is provided with a valid name\n+                for (Onnx.ValueInfoProto valueInfo : model.getGraph().getInputList()) {\n+                    String onnxInputName = valueInfo.getName();\n+                    String vespaInputName = OnnxModelTransformer.asValidIdentifier(onnxInputName);\n+                    modelConfig.addInputNameMapping(onnxInputName, vespaInputName, false);\n+                    modelConfig.addInputType(onnxInputName, valueInfo.getType());\n+                }\n+\n+                // Model outputs\n+                for (Onnx.ValueInfoProto valueInfo : model.getGraph().getOutputList()) {\n+                    String onnxOutputName = valueInfo.getName();\n+                    String vespaOutputName = OnnxModelTransformer.asValidIdentifier(onnxOutputName);\n+                    modelConfig.addOutputNameMapping(onnxOutputName, vespaOutputName, false);\n+                    modelConfig.addOutputType(onnxOutputName, valueInfo.getType());\n+                }\n+\n+                // Set the first output as default\n+                if ( ! model.getGraph().getOutputList().isEmpty()) {\n+                    modelConfig.setDefaultOutput(model.getGraph().getOutput(0).getName());\n+                }\n+\n+            } catch (IOException e) {\n+                throw new IllegalArgumentException(\"Unable to parse ONNX model\", e);\n+            }\n+        }\n+    }\n+\n+    static boolean modelFileExists(String path, ApplicationPackage app) {\n+        Path pathInApplicationPackage = Path.fromString(path);\n+        if (getFile(pathInApplicationPackage, app).exists()) {\n+            return true;\n+        }\n+        if (getFileReference(pathInApplicationPackage, app).isPresent()) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    private InputStream openModelFile(Path path) throws FileNotFoundException {\n+        ApplicationFile file;\n+        Optional<FileReference> reference;\n+        Path modelsPath = ApplicationPackage.MODELS_DIR.append(path);\n+\n+        if ((file = getFile(path)).exists()) {\n+            return file.createInputStream();\n+        }\n+        if ((file = getFile(modelsPath)).exists()) {\n+            return file.createInputStream();\n+        }\n+        if ((reference = getFileReference(path)).isPresent()) {\n+            return openFromFileRepository(path, reference.get());\n+        }\n+        if ((reference = getFileReference(modelsPath)).isPresent()) {\n+            return openFromFileRepository(modelsPath, reference.get());\n+        }\n+\n+        throw new IllegalArgumentException(\"Unable to find ONNX model file \\\"\" + path + \"\\\" \" +\n+            \"in application package or file repository.\");\n+    }\n+\n+    private ApplicationFile getFile(Path path) {\n+        return getFile(path, search.applicationPackage());\n+    }\n+\n+    private static ApplicationFile getFile(Path path, ApplicationPackage app) {\n+        return app.getFile(path);\n+    }\n+\n+    private static InputStream openFromFileRepository(Path path, FileReference reference) throws FileNotFoundException {\n+        return new FileInputStream(new File(getFileRepositoryPath(path, reference.value())));\n+    }\n+\n+    public static String getFileRepositoryPath(Path path, String fileReference) {", "originalCommit": "3594ad3bfce131b317d9c073b16eb47a7983be4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5OTU5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15010#discussion_r510699595", "bodyText": "I think we can just drop the getFileReference (and subsequent openFromFileRepository) calls. If getFile fails getFileReference will also fail. If there exists is a file reference for a file in the application package it will be added to the application package directory immediately afterwards and it will be found when doing getFile.", "author": "hmusum", "createdAt": "2020-10-23T07:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2Nzg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDczMTY5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15010#discussion_r510731692", "bodyText": "So, the reason this is here is the getFile fails to find the file when the application package is backed by ZKApplicationPackage because the actual file hasn't been added there. See ZooKeeperClient.java. During the prepare step, as far as I understand, at first the application package is a FilesApplicationPackage. Here the file exists. However, during config deriving, the ZK application package will be created, and the model file will not be put there, in the .preprocessed directory. However, we still require the actual file. That's why we look in the file repository, and at this stage the file reference exists and the file has been added there.\nNow, I'm not sure what happens with this scenario when we have multiple config servers. I guess we'll just have to try?", "author": "lesters", "createdAt": "2020-10-23T08:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2Nzg3Ng=="}], "type": "inlineReview", "revised_code": null}]}