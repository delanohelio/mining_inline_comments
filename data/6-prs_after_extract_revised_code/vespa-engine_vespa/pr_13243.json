{"pr_number": 13243, "pr_title": "Provision application roles  ", "pr_createdAt": "2020-05-13T14:18:17Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13243", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyMjQwNA==", "url": "https://github.com/vespa-engine/vespa/pull/13243#discussion_r424922404", "bodyText": "We should make deployment fail on failed role creation.", "author": "oyving", "createdAt": "2020-05-14T07:22:34Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java", "diffHunk": "@@ -328,10 +333,19 @@ public ActivateResult deploy2(JobId job, boolean deploySourceVersions) { // TODO\n                 endpointCertificateMetadata = endpointCertificateManager.getEndpointCertificateMetadata(instance, zone);\n \n                 endpoints = controller.routing().registerEndpointsInDns(application.get(), job.application().instance(), zone);\n+\n+                // Provision application roles if enabled for the zone\n+                if (provisionApplicationRoles.with(FetchVector.Dimension.ZONE_ID, zone.value()).value()) {\n+                    try {\n+                        applicationRoles = controller.serviceRegistry().applicationRoleService().createApplicationRoles(instance.id());\n+                    } catch (Exception e) {\n+                        log.log(Level.SEVERE, \"Exception creating application roles for application: \" + instance.id(), e);", "originalCommit": "30609118ff8644aa68c443ddae8e09202abdc846", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dfa23cab41d83b7c21a34d199e747fe8e5747ea3", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java\nindex 6a69fae369..e02c1b9f5d 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java\n\n@@ -333,19 +328,10 @@ public class ApplicationController {\n                 endpointCertificateMetadata = endpointCertificateManager.getEndpointCertificateMetadata(instance, zone);\n \n                 endpoints = controller.routing().registerEndpointsInDns(application.get(), job.application().instance(), zone);\n-\n-                // Provision application roles if enabled for the zone\n-                if (provisionApplicationRoles.with(FetchVector.Dimension.ZONE_ID, zone.value()).value()) {\n-                    try {\n-                        applicationRoles = controller.serviceRegistry().applicationRoleService().createApplicationRoles(instance.id());\n-                    } catch (Exception e) {\n-                        log.log(Level.SEVERE, \"Exception creating application roles for application: \" + instance.id(), e);\n-                    }\n-                }\n             } // Release application lock while doing the deployment, which is a lengthy task.\n \n             // Carry out deployment without holding the application lock.\n-            ActivateResult result = deploy(job.application(), applicationPackage, zone, platform, endpoints, endpointCertificateMetadata, applicationRoles);\n+            ActivateResult result = deploy(job.application(), applicationPackage, zone, platform, endpoints, endpointCertificateMetadata);\n \n             lockApplicationOrThrow(applicationId, application ->\n                     store(application.with(job.application().instance(),\n"}}, {"oid": "dfa23cab41d83b7c21a34d199e747fe8e5747ea3", "url": "https://github.com/vespa-engine/vespa/commit/dfa23cab41d83b7c21a34d199e747fe8e5747ea3", "message": "Create application iam role service", "committedDate": "2020-05-18T08:29:28Z", "type": "commit"}, {"oid": "efd71d02a2d65c12022b62011ace1ceca7f6ef8a", "url": "https://github.com/vespa-engine/vespa/commit/efd71d02a2d65c12022b62011ace1ceca7f6ef8a", "message": "Provision application roles and include in cfg deployment", "committedDate": "2020-05-18T08:29:28Z", "type": "commit"}, {"oid": "31adb5d8888abe44fba6a4b51aab1a97248b877f", "url": "https://github.com/vespa-engine/vespa/commit/31adb5d8888abe44fba6a4b51aab1a97248b877f", "message": "Fail deployment when role creating fails", "committedDate": "2020-05-18T09:45:51Z", "type": "commit"}, {"oid": "31adb5d8888abe44fba6a4b51aab1a97248b877f", "url": "https://github.com/vespa-engine/vespa/commit/31adb5d8888abe44fba6a4b51aab1a97248b877f", "message": "Fail deployment when role creating fails", "committedDate": "2020-05-18T09:45:51Z", "type": "forcePushed"}]}