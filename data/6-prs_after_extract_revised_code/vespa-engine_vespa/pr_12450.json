{"pr_number": 12450, "pr_title": "Jvenstad/integration test deployments with new deploy path", "pr_createdAt": "2020-03-05T10:16:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12450", "timeline": [{"oid": "854ae50b97510c55df0ada623038f5048a50aaaf", "url": "https://github.com/vespa-engine/vespa/commit/854ae50b97510c55df0ada623038f5048a50aaaf", "message": "Remove unused TesterCloud methods", "committedDate": "2020-03-05T10:07:48Z", "type": "commit"}, {"oid": "21ffbf56b2d6ef21c55641d5fc41460f8a2e6d47", "url": "https://github.com/vespa-engine/vespa/commit/21ffbf56b2d6ef21c55641d5fc41460f8a2e6d47", "message": "Remove \"endpoints\" from test-config responses", "committedDate": "2020-03-05T10:07:48Z", "type": "commit"}, {"oid": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "url": "https://github.com/vespa-engine/vespa/commit/ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "message": "Validate CNAMEs and IP lookup after deployment", "committedDate": "2020-03-05T10:10:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMzc1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388203755", "bodyText": "s/cNames/nameService/", "author": "mpolden", "createdAt": "2020-03-05T10:27:21Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java", "diffHunk": "@@ -1,24 +1,34 @@\n // Copyright 2018 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n package com.yahoo.vespa.hosted.controller.api.integration.stubs;\n \n+import com.yahoo.config.provision.HostName;\n import com.yahoo.vespa.hosted.controller.api.identifiers.DeploymentId;\n import com.yahoo.vespa.hosted.controller.api.integration.LogEntry;\n import com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.MemoryNameService;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.NameService;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.Record;\n+import com.yahoo.vespa.hosted.controller.api.integration.dns.RecordName;\n \n import java.net.URI;\n import java.util.ArrayList;\n import java.util.List;\n+import java.util.Optional;\n import java.util.stream.Collectors;\n \n import static com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud.Status.NOT_STARTED;\n import static com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud.Status.RUNNING;\n \n public class MockTesterCloud implements TesterCloud {\n \n+    private final NameService cNames;", "originalCommit": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "057227e623d661fe6f2e6fdb9c04614b5194e008", "chunk": "diff --git a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java\nindex f5594e6020..eb5360bc4b 100644\n--- a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java\n+++ b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/stubs/MockTesterCloud.java\n\n@@ -5,7 +5,6 @@ import com.yahoo.config.provision.HostName;\n import com.yahoo.vespa.hosted.controller.api.identifiers.DeploymentId;\n import com.yahoo.vespa.hosted.controller.api.integration.LogEntry;\n import com.yahoo.vespa.hosted.controller.api.integration.deployment.TesterCloud;\n-import com.yahoo.vespa.hosted.controller.api.integration.dns.MemoryNameService;\n import com.yahoo.vespa.hosted.controller.api.integration.dns.NameService;\n import com.yahoo.vespa.hosted.controller.api.integration.dns.Record;\n import com.yahoo.vespa.hosted.controller.api.integration.dns.RecordName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjMzNA==", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388206334", "bodyText": "Combine with previous condition? Or is it necessary to treat them differently?", "author": "mpolden", "createdAt": "2020-03-05T10:31:55Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java", "diffHunk": "@@ -472,11 +471,41 @@ private boolean endpointsAvailable(ApplicationId id, ZoneId zone, DualLogger log\n             logger.log(\"Endpoints not yet ready.\");\n             return false;\n         }\n-        for (var endpoint : endpoints.get(zone).keySet())\n-            if ( ! controller.jobController().cloud().exists(endpoint)) {\n-                logger.log(INFO, \"DNS lookup yielded no IP address for '\" + endpoint + \"'.\");\n+        var policies = controller.routing().policies().get(new DeploymentId(id, zone));\n+        for (var endpoint : endpoints.get(zone)) {\n+            HostName endpointName = HostName.from(endpoint.dnsName());\n+            var ipAddress = controller.jobController().cloud().resolveHostName(endpointName);\n+            if (ipAddress.isEmpty()) {\n+                logger.log(INFO, \"DNS lookup yielded no IP address for '\" + endpointName + \"'.\");\n                 return false;\n             }\n+            if (endpoint.routingMethod() == RoutingMethod.exclusive)  {\n+                var policy = policies.get(new RoutingPolicyId(id, ClusterSpec.Id.from(endpoint.name()), zone));\n+                if (policy == null)\n+                    throw new IllegalStateException(endpoint + \" has no matching policy in \" + policies);\n+\n+                var cNameValue = controller.jobController().cloud().resolveCName(endpointName);\n+                if (cNameValue.isEmpty()) {\n+                    logger.log(INFO, \"CNAME '\" + endpointName + \"' does not yet point to anything\");\n+                    return false;\n+                }\n+                if ( ! cNameValue.get().equals(policy.canonicalName())) {", "originalCommit": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0MDY4OA==", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388240688", "bodyText": "Could probably collapse this, yes.", "author": "jonmv", "createdAt": "2020-03-05T11:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNjMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "057227e623d661fe6f2e6fdb9c04614b5194e008", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java\nindex 729ceaeff3..af36708ccd 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java\n\n@@ -484,24 +484,17 @@ public class InternalStepRunner implements StepRunner {\n                 if (policy == null)\n                     throw new IllegalStateException(endpoint + \" has no matching policy in \" + policies);\n \n-                var cNameValue = controller.jobController().cloud().resolveCName(endpointName);\n-                if (cNameValue.isEmpty()) {\n-                    logger.log(INFO, \"CNAME '\" + endpointName + \"' does not yet point to anything\");\n-                    return false;\n-                }\n-                if ( ! cNameValue.get().equals(policy.canonicalName())) {\n-                    logger.log(INFO, \"CNAME '\" + endpointName + \"' doesn't point to expected host name '\" + policy.canonicalName() + \"'\");\n+                var cNameValue = controller.jobController().cloud().resolveCname(endpointName);\n+                if ( ! cNameValue.map(policy.canonicalName()::equals).orElse(false)) {\n+                    logger.log(INFO, \"CNAME '\" + endpointName + \"' points at \" +\n+                                     cNameValue.map(name -> \"'\" + name + \"'\").orElse(\"nothing\") +\n+                                     \" but should point at load balancer '\" + policy.canonicalName() + \"'\");\n                     return false;\n                 }\n                 var loadBalancerAddress = controller.jobController().cloud().resolveHostName(policy.canonicalName());\n-                if (loadBalancerAddress.isEmpty()) {\n-                    logger.log(INFO, \"DNS lookup yielded no IP address for load balancer '\" + policy.canonicalName() + \"'\");\n-                    return false;\n-                }\n-                // Verify that the JVMs internal DNS cache has seen the update. Both names should resolve to the same IP address.\n                 if ( ! loadBalancerAddress.equals(ipAddress)) {\n                     logger.log(INFO, \"IP address of CNAME '\" + endpointName + \"' (\" + ipAddress.get() + \") and load balancer '\" +\n-                                     policy.canonicalName() + \"' (\" + loadBalancerAddress.get() + \") are not equal\");\n+                                     policy.canonicalName() + \"' (\" + loadBalancerAddress.orElse(\"empty\") + \") are not equal\");\n                     return false;\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNzk3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388207971", "bodyText": "Consider renaming to either resolveCNAME or resolveCname (I think we mostly use the latter: camel-case regardless of actual casing).", "author": "mpolden", "createdAt": "2020-03-05T10:34:57Z", "path": "controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java", "diffHunk": "@@ -29,14 +32,11 @@\n     /** Returns whether the test container is ready to serve */\n     boolean testerReady(DeploymentId deploymentId);\n \n-    /** Returns whether the given URL is registered in DNS. */\n-    boolean exists(URI endpointUrl);\n+    /** Returns the IP address of the given host name, if any. */\n+    Optional<String> resolveHostName(HostName hostname);\n \n-    /**\n-     * Returns whether the given URL is registered in DNS. Always returns true,\n-     * as endpoints are not use in this case\n-     */\n-    default boolean exists(DeploymentId deploymentId) { return true; }\n+    /** Returns the host name of the given CNAME, if any. */\n+    Optional<HostName> resolveCName(HostName hostName);", "originalCommit": "ad5f5c22b4e9a9612073eb863abf0e6441fab0ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0MTI2MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12450#discussion_r388241261", "bodyText": "Will do the latter.", "author": "jonmv", "createdAt": "2020-03-05T11:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNzk3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "057227e623d661fe6f2e6fdb9c04614b5194e008", "chunk": "diff --git a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java\nindex f09340ce47..b8f52694b6 100644\n--- a/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java\n+++ b/controller-api/src/main/java/com/yahoo/vespa/hosted/controller/api/integration/deployment/TesterCloud.java\n\n@@ -36,7 +36,7 @@ public interface TesterCloud {\n     Optional<String> resolveHostName(HostName hostname);\n \n     /** Returns the host name of the given CNAME, if any. */\n-    Optional<HostName> resolveCName(HostName hostName);\n+    Optional<HostName> resolveCname(HostName hostName);\n \n     enum Status {\n \n"}}, {"oid": "057227e623d661fe6f2e6fdb9c04614b5194e008", "url": "https://github.com/vespa-engine/vespa/commit/057227e623d661fe6f2e6fdb9c04614b5194e008", "message": "Rename some things, collapse some code", "committedDate": "2020-03-05T11:49:52Z", "type": "commit"}]}