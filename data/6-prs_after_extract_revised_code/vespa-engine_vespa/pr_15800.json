{"pr_number": 15800, "pr_title": "Refactor code and document code to verify that ZooKeeper is working", "pr_createdAt": "2020-12-14T08:07:57Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15800", "timeline": [{"oid": "e752af8a5e6b462caed8faaeff0aafa30417c912", "url": "https://github.com/vespa-engine/vespa/commit/e752af8a5e6b462caed8faaeff0aafa30417c912", "message": "Refactor code and document code to verify that ZooKeeper is working", "committedDate": "2020-12-14T08:05:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNTY4Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15800#discussion_r542205683", "bodyText": "Consider implementing this by calling CuratorFramework.blockUntilConnected().", "author": "hakonhall", "createdAt": "2020-12-14T08:46:18Z", "path": "clustercontroller-apps/src/main/java/com/yahoo/vespa/clustercontroller/apps/clustercontroller/ClusterController.java", "diffHunk": "@@ -104,4 +95,18 @@ void shutdownController(FleetController controller) throws Exception {\n         controller.shutdown();\n     }\n \n+    /**\n+     * Creates a path in zookeeper for this fleetcontroller. Seems like this is meant as a check\n+     * that zookeeper server is up and that we are able to do operations against it.", "originalCommit": "e752af8a5e6b462caed8faaeff0aafa30417c912", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI0MTY1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15800#discussion_r542241652", "bodyText": "Much nicer, thanks, fixed.", "author": "hmusum", "createdAt": "2020-12-14T09:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNTY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5e933b7a8e75bae020e504dbc35e61faaceafa59", "chunk": "diff --git a/clustercontroller-apps/src/main/java/com/yahoo/vespa/clustercontroller/apps/clustercontroller/ClusterController.java b/clustercontroller-apps/src/main/java/com/yahoo/vespa/clustercontroller/apps/clustercontroller/ClusterController.java\nindex 26ad2784b2..eba3b35fcb 100644\n--- a/clustercontroller-apps/src/main/java/com/yahoo/vespa/clustercontroller/apps/clustercontroller/ClusterController.java\n+++ b/clustercontroller-apps/src/main/java/com/yahoo/vespa/clustercontroller/apps/clustercontroller/ClusterController.java\n\n@@ -96,16 +96,12 @@ public class ClusterController extends AbstractComponent\n     }\n \n     /**\n-     * Creates a path in zookeeper for this fleetcontroller. Seems like this is meant as a check\n-     * that zookeeper server is up and that we are able to do operations against it.\n+     * Block until we are connected to zookeeper server\n      */\n     private void verifyThatZooKeeperWorks(FleetControllerOptions options) throws Exception {\n         if (options.zooKeeperServerAddress != null && !\"\".equals(options.zooKeeperServerAddress)) {\n-            String path = \"/\" + options.clusterName + options.fleetControllerIndex;\n             Curator curator = Curator.create(options.zooKeeperServerAddress);\n-            if (curator.framework().checkExists().forPath(path) != null)\n-                curator.framework().delete().deletingChildrenIfNeeded().forPath(path);\n-            curator.framework().create().creatingParentsIfNeeded().forPath(path);\n+            curator.framework().blockUntilConnected();\n         }\n     }\n \n"}}, {"oid": "5e933b7a8e75bae020e504dbc35e61faaceafa59", "url": "https://github.com/vespa-engine/vespa/commit/5e933b7a8e75bae020e504dbc35e61faaceafa59", "message": "Use CuratorFramework.blockUntilConnected() to verify connection", "committedDate": "2020-12-14T09:39:11Z", "type": "commit"}]}