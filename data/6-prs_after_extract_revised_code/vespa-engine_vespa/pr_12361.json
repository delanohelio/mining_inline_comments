{"pr_number": 12361, "pr_title": "Only get list of nodes when actually needed", "pr_createdAt": "2020-02-27T11:04:45Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12361", "timeline": [{"oid": "c6dd9ee63a9979faac91db16d7a9bf27fa65a0d4", "url": "https://github.com/vespa-engine/vespa/commit/c6dd9ee63a9979faac91db16d7a9bf27fa65a0d4", "message": "Only get list of nodes when actually needed\n\nUse a supplier and get list of nodes only when needed (when wanting to retire\na node). This should improve performance for all other patch requests.", "committedDate": "2020-02-27T11:03:20Z", "type": "commit"}, {"oid": "fa97b892603f76ab45c5d03c6e62b6d6bdacdf53", "url": "https://github.com/vespa-engine/vespa/commit/fa97b892603f76ab45c5d03c6e62b6d6bdacdf53", "message": "Merge branch 'master' into hmusum/get-all-nodes-only-when-needed", "committedDate": "2020-02-27T13:13:20Z", "type": "commit"}, {"oid": "ae06cc33e932ce132867744eab058eb8fddea25d", "url": "https://github.com/vespa-engine/vespa/commit/ae06cc33e932ce132867744eab058eb8fddea25d", "message": "Add node from request last", "committedDate": "2020-02-27T17:23:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyMDUzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12361#discussion_r385420535", "bodyText": "If more than one of WANT_TO_RETIRE, ipAddresses, additionalIpAddresses are specified in the patch request, then this PR will invoke nodeRepository.list(lock) that many times. This happens e.g. on provisioning, when the last two are specified. At the risk of making this much more convoluted, consider listing at most once.", "author": "hakonhall", "createdAt": "2020-02-27T23:00:36Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/restapi/v2/NodePatcher.java", "diffHunk": "@@ -133,9 +130,9 @@ private Node applyField(Node node, String name, Inspector value) {\n             case \"parentHostname\" :\n                 return node.withParentHostname(asString(value));\n             case \"ipAddresses\" :\n-                return IP.Config.verify(node.with(node.ipConfig().with(asStringSet(value))), nodes);\n+                return IP.Config.verify(node.with(node.ipConfig().with(asStringSet(value))), nodes.get());\n             case \"additionalIpAddresses\" :\n-                return IP.Config.verify(node.with(node.ipConfig().with(IP.Pool.of(asStringSet(value)))), nodes);\n+                return IP.Config.verify(node.with(node.ipConfig().with(IP.Pool.of(asStringSet(value)))), nodes.get());", "originalCommit": "ae06cc33e932ce132867744eab058eb8fddea25d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyMDc5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12361#discussion_r385420796", "bodyText": "The overall impact of this PR should be a great win, so merging now...", "author": "hakonhall", "createdAt": "2020-02-27T23:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyMDUzNQ=="}], "type": "inlineReview", "revised_code": null}]}