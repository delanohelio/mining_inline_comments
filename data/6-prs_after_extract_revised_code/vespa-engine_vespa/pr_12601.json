{"pr_number": 12601, "pr_title": "Bjorncs/implicit access control", "pr_createdAt": "2020-03-17T15:14:34Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12601", "timeline": [{"oid": "cd94fe9d8619873b066c3dde986f0ee87f09e02d", "url": "https://github.com/vespa-engine/vespa/commit/cd94fe9d8619873b066c3dde986f0ee87f09e02d", "message": "Extract to method 'isHostedTenantApplication'", "committedDate": "2020-03-17T14:14:34Z", "type": "commit"}, {"oid": "100a45031e31c0c3dbd64bb8d1fd07dd94c02208", "url": "https://github.com/vespa-engine/vespa/commit/100a45031e31c0c3dbd64bb8d1fd07dd94c02208", "message": "Move call to 'addImplicitHttpIfPresent' up one level and rename", "committedDate": "2020-03-17T14:14:34Z", "type": "commit"}, {"oid": "58c77c37f204b724c71a1dfad2ef25fcbd3a5a25", "url": "https://github.com/vespa-engine/vespa/commit/58c77c37f204b724c71a1dfad2ef25fcbd3a5a25", "message": "Make method private", "committedDate": "2020-03-17T14:14:34Z", "type": "commit"}, {"oid": "d0e879d09ed8f63bab738b461a7365d5be292c7c", "url": "https://github.com/vespa-engine/vespa/commit/d0e879d09ed8f63bab738b461a7365d5be292c7c", "message": "Group public methods above private", "committedDate": "2020-03-17T14:14:34Z", "type": "commit"}, {"oid": "3a48cdb53107e1be7112d711bfda77790cbdefff", "url": "https://github.com/vespa-engine/vespa/commit/3a48cdb53107e1be7112d711bfda77790cbdefff", "message": "Combine 'setHandlers' + 'setServlets' to single method", "committedDate": "2020-03-17T14:14:34Z", "type": "commit"}, {"oid": "8c4c00e79390ce4d670ed1482e6f777e5c86461f", "url": "https://github.com/vespa-engine/vespa/commit/8c4c00e79390ce4d670ed1482e6f777e5c86461f", "message": "Add implicit access control for hosted tenant applications", "committedDate": "2020-03-17T14:15:22Z", "type": "commit"}, {"oid": "2ae2b42dc0c323e8965918078bee538f746cdf31", "url": "https://github.com/vespa-engine/vespa/commit/2ae2b42dc0c323e8965918078bee538f746cdf31", "message": "Prefer Athenz domain from deploy properties\n\nOnly use domain from 'access-control' if domain is not provided by\ndeploy properties. Make 'domain' in 'access-control' optional.", "committedDate": "2020-03-17T15:11:36Z", "type": "commit"}, {"oid": "3001a98e3e6799f569c5852151b579495ccb53b6", "url": "https://github.com/vespa-engine/vespa/commit/3001a98e3e6799f569c5852151b579495ccb53b6", "message": "Add Athenz domain to TestProperties", "committedDate": "2020-03-17T15:38:15Z", "type": "commit"}, {"oid": "96808803dda3cc863056599b27656a3ee43ebcc7", "url": "https://github.com/vespa-engine/vespa/commit/96808803dda3cc863056599b27656a3ee43ebcc7", "message": "Test that access control is implicitly added for hosted apps", "committedDate": "2020-03-17T15:38:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0ODU3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12601#discussion_r393948575", "bodyText": "will this fail the first redeploy (after config server is upgraded) ? or will this only be evaluated when application is deployed with the new version?", "author": "tokle", "createdAt": "2020-03-17T20:26:13Z", "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java", "diffHunk": "@@ -79,6 +82,28 @@ private AccessControl buildAccessControl(DeployState deployState, AbstractConfig\n         return builder.build();\n     }\n \n+    // TODO Fail if domain is not provided through deploy properties\n+    private static AthenzDomain getAccessControlDomain(DeployState deployState, Element accessControlElem) {\n+        AthenzDomain tenantDomain = deployState.getProperties().athenzDomain().orElse(null);", "originalCommit": "2ae2b42dc0c323e8965918078bee538f746cdf31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzNTM4Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12601#discussion_r394235387", "bodyText": "Only if domain attribute is missing from access-control. This attribute has been mandatory up to now, so it should not be the case.", "author": "bjorncs", "createdAt": "2020-03-18T10:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0ODU3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a41f870975382beaa403111db7f7440509a884ad", "chunk": "diff --git a/config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java b/config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java\nindex feb82c40ee..dc74e2afbb 100644\n--- a/config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java\n+++ b/config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java\n\n@@ -95,7 +95,7 @@ public class HttpBuilder extends VespaDomBuilder.DomConfigProducerBuilder<Http>\n             deployState.getDeployLogger().log(Level.WARNING, \"Athenz tenant is not provided by deploy call. This will soon be handled as failure.\");\n         }\n         if (explicitDomain != null) {\n-            if (explicitDomain.equals(tenantDomain)) {\n+            if (tenantDomain != null && !explicitDomain.equals(tenantDomain)) {\n                 throw new IllegalArgumentException(\n                         String.format(\"Domain in access-control ('%s') does not match tenant domain ('%s')\", tenantDomain, explicitDomain));\n             }\n"}}, {"oid": "a41f870975382beaa403111db7f7440509a884ad", "url": "https://github.com/vespa-engine/vespa/commit/a41f870975382beaa403111db7f7440509a884ad", "message": "Fix check for non-identical domains", "committedDate": "2020-03-18T10:08:46Z", "type": "commit"}]}