{"pr_number": 13050, "pr_title": "add more tracing and debug logging of stemming", "pr_createdAt": "2020-04-24T08:46:22Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13050", "timeline": [{"oid": "976f28680df424bf028eb12a3f413049c17bf098", "url": "https://github.com/vespa-engine/vespa/commit/976f28680df424bf028eb12a3f413049c17bf098", "message": "add more tracing and debug logging of stemming", "committedDate": "2020-04-24T08:34:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQxODIxNw==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414418217", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        getLogger().log(LogLevel.DEBUG, \"Stem '\"+current.stringValue()+\"' mode \"+index.getStemMode()\n          \n          \n            \n                        getLogger().log(LogLevel.DEBUG, () -> \"Stem '\"+current.stringValue()+\"' mode \"+index.getStemMode()", "author": "bratseth", "createdAt": "2020-04-24T09:07:30Z", "path": "container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java", "diffHunk": "@@ -183,9 +184,20 @@ private Item stem(BlockItem current, StemContext context, Index index) {\n         Substring substring = getOffsets(current);\n \n         if (segments.size() == 1) {\n+            getLogger().log(LogLevel.DEBUG, \"Stem '\"+current.stringValue()+\"' mode \"+index.getStemMode()", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java b/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\nindex 9b846d9f0a..7279e1d6a3 100644\n--- a/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\n+++ b/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\n\n@@ -184,7 +184,7 @@ public class StemmingSearcher extends Searcher {\n         Substring substring = getOffsets(current);\n \n         if (segments.size() == 1) {\n-            getLogger().log(LogLevel.DEBUG, \"Stem '\"+current.stringValue()+\"' mode \"+index.getStemMode()\n+            getLogger().log(LogLevel.DEBUG, () -> \"Stem '\"+current.stringValue()+\"' mode \"+index.getStemMode()\n                             +\" and language '\"+context.language+\"' -> '\"+segments.get(0)+\"'\");\n             TaggableItem w = singleWordSegment(current, segments.get(0), index, substring, context.insidePhrase);\n             setMetaData(current, context.reverseConnectivity, w);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQxOTQ0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414419445", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        getLogger().log(LogLevel.DEBUG, \"Stem to multiple segments '\"+segment+\"'\");\n          \n          \n            \n                        getLogger().log(LogLevel.DEBUG, () -> \"Stem to multiple segments '\"+segment+\"'\");", "author": "bratseth", "createdAt": "2020-04-24T09:09:20Z", "path": "container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java", "diffHunk": "@@ -194,6 +206,7 @@ private Item stem(BlockItem current, StemContext context, Index index) {\n             composite = chooseComposite(current, ((Item) current).getParent(), indexName);\n \n         for (StemList segment : segments) {\n+            getLogger().log(LogLevel.DEBUG, \"Stem to multiple segments '\"+segment+\"'\");", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java b/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\nindex 9b846d9f0a..7279e1d6a3 100644\n--- a/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\n+++ b/container-search/src/main/java/com/yahoo/prelude/querytransform/StemmingSearcher.java\n\n@@ -206,7 +206,7 @@ public class StemmingSearcher extends Searcher {\n             composite = chooseComposite(current, ((Item) current).getParent(), indexName);\n \n         for (StemList segment : segments) {\n-            getLogger().log(LogLevel.DEBUG, \"Stem to multiple segments '\"+segment+\"'\");\n+            getLogger().log(LogLevel.DEBUG, () -> \"Stem to multiple segments '\"+segment+\"'\");\n             TaggableItem w = singleWordSegment(current, segment, index, substring, context.insidePhrase);\n \n             if (composite instanceof AndSegmentItem) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMDE1Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414420153", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.log(Level.FINEST, \"getStemmerForLanguage '\"+language+\"' mode: \"+stemMode);\n          \n          \n            \n                    log.log(Level.FINEST, () -> \"getStemmerForLanguage '\"+language+\"' mode: \"+stemMode);", "author": "bratseth", "createdAt": "2020-04-24T09:10:21Z", "path": "linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java", "diffHunk": "@@ -57,6 +60,7 @@ public OpenNlpTokenizer(Normalizer normalizer, Transformer transformer) {\n     }\n \n     private Stemmer getStemmerForLanguage(Language language, StemMode stemMode) {\n+        log.log(Level.FINEST, \"getStemmerForLanguage '\"+language+\"' mode: \"+stemMode);", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\nindex 0ebd4e0f63..9a1e6da762 100644\n--- a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n\n@@ -60,7 +60,7 @@ public class OpenNlpTokenizer implements Tokenizer {\n     }\n \n     private Stemmer getStemmerForLanguage(Language language, StemMode stemMode) {\n-        log.log(Level.FINEST, \"getStemmerForLanguage '\"+language+\"' mode: \"+stemMode);\n+        log.log(Level.FINEST, () -> \"getStemmerForLanguage '\"+language+\"' mode: \"+stemMode);\n         if (language == null || Language.ENGLISH.equals(language) || StemMode.NONE.equals(stemMode)) {\n             return null;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMDQyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414420429", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n          \n          \n            \n                    log.log(Level.FINEST, () -> \"processToken '\"+token+\"'\");", "author": "bratseth", "createdAt": "2020-04-24T09:10:43Z", "path": "linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java", "diffHunk": "@@ -120,13 +124,17 @@ private Stemmer getStemmerForLanguage(Language language, StemMode stemMode) {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n+        log.log(Level.FINEST, \"processToken '\"+token+\"'\");", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\nindex 0ebd4e0f63..9a1e6da762 100644\n--- a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n\n@@ -124,7 +124,7 @@ public class OpenNlpTokenizer implements Tokenizer {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n-        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n+        log.log(Level.FINEST, () -> \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMDYyMA==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414420620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n          \n          \n            \n                        log.log(Level.FINEST, () -> \"stem '\"+oldToken+\"' to '\"+token+\"'\");", "author": "bratseth", "createdAt": "2020-04-24T09:11:02Z", "path": "linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java", "diffHunk": "@@ -120,13 +124,17 @@ private Stemmer getStemmerForLanguage(Language language, StemMode stemMode) {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n+        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n             token = transformer.accentDrop(token, language);\n         if (stemMode != StemMode.NONE) {\n+            String oldToken = token;\n             token = doStemming(token, stemmer);\n+            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\nindex 0ebd4e0f63..9a1e6da762 100644\n--- a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n\n@@ -124,7 +124,7 @@ public class OpenNlpTokenizer implements Tokenizer {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n-        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n+        log.log(Level.FINEST, () -> \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMDgyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414420822", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.log(Level.FINEST, \"processed token is: \"+token);\n          \n          \n            \n                    log.log(Level.FINEST, () -> \"processed token is: \"+token);", "author": "bratseth", "createdAt": "2020-04-24T09:11:20Z", "path": "linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java", "diffHunk": "@@ -120,13 +124,17 @@ private Stemmer getStemmerForLanguage(Language language, StemMode stemMode) {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n+        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n             token = transformer.accentDrop(token, language);\n         if (stemMode != StemMode.NONE) {\n+            String oldToken = token;\n             token = doStemming(token, stemmer);\n+            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n         }\n+        log.log(Level.FINEST, \"processed token is: \"+token);", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\nindex 0ebd4e0f63..9a1e6da762 100644\n--- a/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/opennlp/OpenNlpTokenizer.java\n\n@@ -124,7 +124,7 @@ public class OpenNlpTokenizer implements Tokenizer {\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents,\n                                 Stemmer stemmer) {\n-        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n+        log.log(Level.FINEST, () -> \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMTAzOA==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414421038", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.log(Level.FINE, \"guessing language \"+result.get()+\" from input: \"+input);\n          \n          \n            \n                    log.log(Level.FINE, () -> \"guessing language \"+result.get()+\" from input: \"+input);", "author": "bratseth", "createdAt": "2020-04-24T09:11:39Z", "path": "linguistics/src/main/java/com/yahoo/language/opennlp/OptimaizeDetector.java", "diffHunk": "@@ -96,6 +99,7 @@ public Language guessLanguage(String input) {\n     private static Language guessLanguageUsingOptimaize(String input) {\n         Optional<LdLocale> result = languageDetector.detect(textObjectFactory.forText(input));\n         if ( ! result.isPresent()) return Language.UNKNOWN;\n+        log.log(Level.FINE, \"guessing language \"+result.get()+\" from input: \"+input);", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/opennlp/OptimaizeDetector.java b/linguistics/src/main/java/com/yahoo/language/opennlp/OptimaizeDetector.java\nindex a42c9f0504..bf07c91ba4 100644\n--- a/linguistics/src/main/java/com/yahoo/language/opennlp/OptimaizeDetector.java\n+++ b/linguistics/src/main/java/com/yahoo/language/opennlp/OptimaizeDetector.java\n\n@@ -99,7 +99,7 @@ public class OptimaizeDetector implements Detector {\n     private static Language guessLanguageUsingOptimaize(String input) {\n         Optional<LdLocale> result = languageDetector.detect(textObjectFactory.forText(input));\n         if ( ! result.isPresent()) return Language.UNKNOWN;\n-        log.log(Level.FINE, \"guessing language \"+result.get()+\" from input: \"+input);\n+        log.log(Level.FINE, () -> \"guessing language \"+result.get()+\" from input: \"+input);\n \n         return Language.fromLocale(new Locale(result.get().getLanguage()));\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMTI3NA==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414421274", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n          \n          \n            \n                        log.log(Level.FINEST, () -> \"stem '\"+oldToken+\"' to '\"+token+\"'\");", "author": "bratseth", "createdAt": "2020-04-24T09:11:57Z", "path": "linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java", "diffHunk": "@@ -64,12 +67,17 @@ public SimpleTokenizer(Normalizer normalizer, Transformer transformer) {\n     }\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents) {\n+        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n             token = transformer.accentDrop(token, language);\n-        if (stemMode != StemMode.NONE)\n+        if (stemMode != StemMode.NONE) {\n+            String oldToken = token;\n             token = stemmer.stem(token);\n+            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java b/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\nindex a8470d8686..aa24e359b5 100644\n--- a/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\n\n@@ -75,9 +75,9 @@ public class SimpleTokenizer implements Tokenizer {\n         if (stemMode != StemMode.NONE) {\n             String oldToken = token;\n             token = stemmer.stem(token);\n-            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n+            log.log(Level.FINEST, () -> \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n         }\n-        log.log(Level.FINEST, \"processed token is: \"+token);\n+        log.log(Level.FINEST, () -> \"processed token is: \"+token);\n         return token;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyMTM5NA==", "url": "https://github.com/vespa-engine/vespa/pull/13050#discussion_r414421394", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.log(Level.FINEST, \"processed token is: \"+token);\n          \n          \n            \n                    log.log(Level.FINEST, () -> \"processed token is: \"+token);", "author": "bratseth", "createdAt": "2020-04-24T09:12:09Z", "path": "linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java", "diffHunk": "@@ -64,12 +67,17 @@ public SimpleTokenizer(Normalizer normalizer, Transformer transformer) {\n     }\n \n     private String processToken(String token, Language language, StemMode stemMode, boolean removeAccents) {\n+        log.log(Level.FINEST, \"processToken '\"+token+\"'\");\n         token = normalizer.normalize(token);\n         token = LinguisticsCase.toLowerCase(token);\n         if (removeAccents)\n             token = transformer.accentDrop(token, language);\n-        if (stemMode != StemMode.NONE)\n+        if (stemMode != StemMode.NONE) {\n+            String oldToken = token;\n             token = stemmer.stem(token);\n+            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n+        }\n+        log.log(Level.FINEST, \"processed token is: \"+token);", "originalCommit": "976f28680df424bf028eb12a3f413049c17bf098", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "chunk": "diff --git a/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java b/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\nindex a8470d8686..aa24e359b5 100644\n--- a/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\n+++ b/linguistics/src/main/java/com/yahoo/language/simple/SimpleTokenizer.java\n\n@@ -75,9 +75,9 @@ public class SimpleTokenizer implements Tokenizer {\n         if (stemMode != StemMode.NONE) {\n             String oldToken = token;\n             token = stemmer.stem(token);\n-            log.log(Level.FINEST, \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n+            log.log(Level.FINEST, () -> \"stem '\"+oldToken+\"' to '\"+token+\"'\");\n         }\n-        log.log(Level.FINEST, \"processed token is: \"+token);\n+        log.log(Level.FINEST, () -> \"processed token is: \"+token);\n         return token;\n     }\n \n"}}, {"oid": "be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "url": "https://github.com/vespa-engine/vespa/commit/be1fb0d49eead759e69ed224c403cd8ecf5ed84e", "message": "Apply suggestions from code review\n\nCo-Authored-By: Jon Bratseth <bratseth@oath.com>", "committedDate": "2020-04-24T09:18:18Z", "type": "commit"}, {"oid": "b1e84e7c2275cf787826e7621934480c7056f142", "url": "https://github.com/vespa-engine/vespa/commit/b1e84e7c2275cf787826e7621934480c7056f142", "message": "variables in lambdas must be final", "committedDate": "2020-04-24T09:29:53Z", "type": "commit"}]}