{"pr_number": 12652, "pr_title": "Bratseth/deprovision fixes", "pr_createdAt": "2020-03-20T16:36:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12652", "timeline": [{"oid": "c2db24290ce65a80e02adcec53a5ababdc3987ec", "url": "https://github.com/vespa-engine/vespa/commit/c2db24290ce65a80e02adcec53a5ababdc3987ec", "message": "Preserve only specific fields when reprovisioning", "committedDate": "2020-03-20T16:33:11Z", "type": "commit"}, {"oid": "9355926f5faec617354279b02adcf56ae59b4f9f", "url": "https://github.com/vespa-engine/vespa/commit/9355926f5faec617354279b02adcf56ae59b4f9f", "message": "Only move *tenant* hosts to deprovisioned", "committedDate": "2020-03-20T16:35:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDgwNg==", "url": "https://github.com/vespa-engine/vespa/pull/12652#discussion_r395760806", "bodyText": "is -> it?", "author": "freva", "createdAt": "2020-03-20T16:42:23Z", "path": "node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java", "diffHunk": "@@ -148,32 +148,42 @@ public void delete_host_only_after_all_the_children_have_been_deleted() {\n     }\n \n     @Test\n-    public void deprovisioned_hosts_are_resurrected_on_add() {\n+    public void relevant_information_from_deprovisioned_hosts_are_merged_into_readded_host() {\n         NodeRepositoryTester tester = new NodeRepositoryTester();\n         Instant testStart = tester.nodeRepository().clock().instant();\n \n-        ((ManualClock)tester.nodeRepository().clock()).advance(Duration.ofSeconds(1));\n+        tester.clock().advance(Duration.ofSeconds(1));\n         tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n         tester.addNode(\"id2\", \"host2\", \"default\", NodeType.host);\n         assertFalse(tester.nodeRepository().getNode(\"host1\").get().history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n \n-        // Set host 1 properties and remove it\n+        // Set host 1 properties and deprovision it\n         Node host1 = tester.nodeRepository().getNode(\"host1\").get();\n         host1 = host1.withWantToRetire(true, Agent.system, tester.nodeRepository().clock().instant());\n         host1 = host1.with(host1.status().withWantToDeprovision(true));\n+        host1 = host1.withFirmwareVerifiedAt(tester.clock().instant());\n+        host1 = host1.with(host1.status().withIncreasedFailCount());\n+        host1 = host1.with(host1.reports().withReport(Report.basicReport(\"id\", Report.Type.HARD_FAIL, tester.clock().instant(), \"Test report\")));\n         tester.nodeRepository().write(host1, tester.nodeRepository().lock(host1));\n         tester.nodeRepository().removeRecursively(\"host1\");\n \n         // Host 1 is deprovisioned and unwanted properties are cleared\n         host1 = tester.nodeRepository().getNode(\"host1\").get();\n         assertEquals(Node.State.deprovisioned, host1.state());\n         assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n-        assertFalse(host1.status().wantToRetire());\n-        assertFalse(host1.status().wantToDeprovision());\n \n-        // Adding it again moves it from deprovisioned\n-        host1 = tester.addNode(\"id1\", \"host1\", \"default\", NodeType.host);\n-        assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n+        // Adding it again preserves some information from the deprovisioned host and removes is", "originalCommit": "9355926f5faec617354279b02adcf56ae59b4f9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NDg1Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12652#discussion_r395764853", "bodyText": "Thanks", "author": "bratseth", "createdAt": "2020-03-20T16:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDgwNg=="}], "type": "inlineReview", "revised_code": {"commit": "4ebd848b1a5aa1b15debdb209b623612464d42f2", "chunk": "diff --git a/node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java b/node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java\nindex 24c7a191dc..38b46df77f 100644\n--- a/node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java\n+++ b/node-repository/src/test/java/com/yahoo/vespa/hosted/provision/NodeRepositoryTest.java\n\n@@ -172,7 +172,7 @@ public class NodeRepositoryTest {\n         assertEquals(Node.State.deprovisioned, host1.state());\n         assertTrue(host1.history().hasEventAfter(History.Event.Type.deprovisioned, testStart));\n \n-        // Adding it again preserves some information from the deprovisioned host and removes is\n+        // Adding it again preserves some information from the deprovisioned host and removes it\n         tester.addNode(\"id2\", \"host1\", \"default\", NodeType.host);\n         host1 = tester.nodeRepository().getNode(\"host1\").get();\n         assertEquals(\"This is the newly added node\", \"id2\", host1.id());\n"}}, {"oid": "4ebd848b1a5aa1b15debdb209b623612464d42f2", "url": "https://github.com/vespa-engine/vespa/commit/4ebd848b1a5aa1b15debdb209b623612464d42f2", "message": "Correct comment", "committedDate": "2020-03-20T16:48:48Z", "type": "commit"}]}