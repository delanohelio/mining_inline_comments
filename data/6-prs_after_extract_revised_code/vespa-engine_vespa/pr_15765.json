{"pr_number": 15765, "pr_title": "Add ReindexingTriggerer to controller maintenance", "pr_createdAt": "2020-12-09T16:10:53Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15765", "timeline": [{"oid": "b2133db1ab7c171dfb9e15d11c3b6da59904e370", "url": "https://github.com/vespa-engine/vespa/commit/b2133db1ab7c171dfb9e15d11c3b6da59904e370", "message": "Add ReindexingTriggerer to controller maintenance", "committedDate": "2020-12-09T16:10:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4OTE1NA==", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539589154", "bodyText": "Should be closed. \ud83d\ude42", "author": "mpolden", "createdAt": "2020-12-09T19:34:30Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java", "diffHunk": "@@ -81,6 +82,7 @@ public ControllerMaintenance(Controller controller, Metric metric) {\n         applicationMetaDataGarbageCollector = new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector);\n         containerImageExpirer = new ContainerImageExpirer(controller, intervals.containerImageExpirer);\n         hostSwitchUpdater = new HostSwitchUpdater(controller, intervals.hostSwitchUpdater);\n+        reindexingTriggerer = new ReindexingTriggerer(controller, intervals.reindexingTriggerer);", "originalCommit": "b2133db1ab7c171dfb9e15d11c3b6da59904e370", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5MDI5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539590297", "bodyText": "Oooh :)", "author": "jonmv", "createdAt": "2020-12-09T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4OTE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "a963e9ed4580e22e3b351c584ba49b01b4bf03ce", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\nindex e25c7f4d2c..06e489c7f5 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\n\n@@ -28,91 +29,46 @@ import static java.time.temporal.ChronoUnit.SECONDS;\n  */\n public class ControllerMaintenance extends AbstractComponent {\n \n-    private final DeploymentExpirer deploymentExpirer;\n-    private final DeploymentIssueReporter deploymentIssueReporter;\n-    private final MetricsReporter metricsReporter;\n-    private final OutstandingChangeDeployer outstandingChangeDeployer;\n-    private final VersionStatusUpdater versionStatusUpdater;\n     private final Upgrader upgrader;\n-    private final ReadyJobsTrigger readyJobsTrigger;\n-    private final DeploymentMetricsMaintainer deploymentMetricsMaintainer;\n-    private final ApplicationOwnershipConfirmer applicationOwnershipConfirmer;\n-    private final SystemUpgrader systemUpgrader;\n-    private final List<OsUpgrader> osUpgraders;\n-    private final OsVersionStatusUpdater osVersionStatusUpdater;\n-    private final JobRunner jobRunner;\n-    private final ContactInformationMaintainer contactInformationMaintainer;\n-    private final CostReportMaintainer costReportMaintainer;\n-    private final ResourceMeterMaintainer resourceMeterMaintainer;\n-    private final NameServiceDispatcher nameServiceDispatcher;\n-    private final CloudEventReporter cloudEventReporter;\n-    private final RotationStatusUpdater rotationStatusUpdater;\n-    private final ResourceTagMaintainer resourceTagMaintainer;\n-    private final SystemRoutingPolicyMaintainer systemRoutingPolicyMaintainer;\n-    private final ApplicationMetaDataGarbageCollector applicationMetaDataGarbageCollector;\n-    private final ContainerImageExpirer containerImageExpirer;\n-    private final HostSwitchUpdater hostSwitchUpdater;\n-    private final ReindexingTriggerer reindexingTriggerer;\n+    private final List<ControllerMaintainer> maintainers = new ArrayList<>();\n \n     @Inject\n     @SuppressWarnings(\"unused\") // instantiated by Dependency Injection\n     public ControllerMaintenance(Controller controller, Metric metric) {\n         Intervals intervals = new Intervals(controller.system());\n-        deploymentExpirer = new DeploymentExpirer(controller, intervals.defaultInterval);\n-        deploymentIssueReporter = new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval);\n-        metricsReporter = new MetricsReporter(controller, metric);\n-        outstandingChangeDeployer = new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer);\n-        versionStatusUpdater = new VersionStatusUpdater(controller, intervals.versionStatusUpdater);\n         upgrader = new Upgrader(controller, intervals.defaultInterval);\n-        readyJobsTrigger = new ReadyJobsTrigger(controller, intervals.readyJobsTrigger);\n-        deploymentMetricsMaintainer = new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer);\n-        applicationOwnershipConfirmer = new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues());\n-        systemUpgrader = new SystemUpgrader(controller, intervals.systemUpgrader);\n-        jobRunner = new JobRunner(controller, intervals.jobRunner);\n-        osUpgraders = osUpgraders(controller, intervals.osUpgrader);\n-        osVersionStatusUpdater = new OsVersionStatusUpdater(controller, intervals.defaultInterval);\n-        contactInformationMaintainer = new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer);\n-        nameServiceDispatcher = new NameServiceDispatcher(controller, intervals.nameServiceDispatcher);\n-        costReportMaintainer = new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer());\n-        resourceMeterMaintainer = new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService());\n-        cloudEventReporter = new CloudEventReporter(controller, intervals.cloudEventReporter, metric);\n-        rotationStatusUpdater = new RotationStatusUpdater(controller, intervals.defaultInterval);\n-        resourceTagMaintainer = new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger());\n-        systemRoutingPolicyMaintainer = new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer);\n-        applicationMetaDataGarbageCollector = new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector);\n-        containerImageExpirer = new ContainerImageExpirer(controller, intervals.containerImageExpirer);\n-        hostSwitchUpdater = new HostSwitchUpdater(controller, intervals.hostSwitchUpdater);\n-        reindexingTriggerer = new ReindexingTriggerer(controller, intervals.reindexingTriggerer);\n+        maintainers.add(upgrader);\n+        maintainers.addAll(osUpgraders(controller, intervals.osUpgrader));\n+        maintainers.add(new DeploymentExpirer(controller, intervals.defaultInterval));\n+        maintainers.add(new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval));\n+        maintainers.add(new MetricsReporter(controller, metric));\n+        maintainers.add(new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer));\n+        maintainers.add(new VersionStatusUpdater(controller, intervals.versionStatusUpdater));\n+        maintainers.add(new ReadyJobsTrigger(controller, intervals.readyJobsTrigger));\n+        maintainers.add(new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer));\n+        maintainers.add(new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues()));\n+        maintainers.add(new SystemUpgrader(controller, intervals.systemUpgrader));\n+        maintainers.add(new JobRunner(controller, intervals.jobRunner));\n+        maintainers.add(new OsVersionStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer));\n+        maintainers.add(new NameServiceDispatcher(controller, intervals.nameServiceDispatcher));\n+        maintainers.add(new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer()));\n+        maintainers.add(new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService()));\n+        maintainers.add(new CloudEventReporter(controller, intervals.cloudEventReporter, metric));\n+        maintainers.add(new RotationStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger()));\n+        maintainers.add(new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer));\n+        maintainers.add(new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector));\n+        maintainers.add(new ContainerImageExpirer(controller, intervals.containerImageExpirer));\n+        maintainers.add(new HostSwitchUpdater(controller, intervals.hostSwitchUpdater));\n+        maintainers.add(new ReindexingTriggerer(controller, intervals.reindexingTriggerer));\n     }\n \n     public Upgrader upgrader() { return upgrader; }\n \n     @Override\n     public void deconstruct() {\n-        deploymentExpirer.close();\n-        deploymentIssueReporter.close();\n-        metricsReporter.close();\n-        outstandingChangeDeployer.close();\n-        versionStatusUpdater.close();\n-        upgrader.close();\n-        readyJobsTrigger.close();\n-        deploymentMetricsMaintainer.close();\n-        applicationOwnershipConfirmer.close();\n-        systemUpgrader.close();\n-        osUpgraders.forEach(ControllerMaintainer::close);\n-        osVersionStatusUpdater.close();\n-        jobRunner.close();\n-        contactInformationMaintainer.close();\n-        costReportMaintainer.close();\n-        resourceMeterMaintainer.close();\n-        nameServiceDispatcher.close();\n-        cloudEventReporter.close();\n-        rotationStatusUpdater.close();\n-        resourceTagMaintainer.close();\n-        systemRoutingPolicyMaintainer.close();\n-        applicationMetaDataGarbageCollector.close();\n-        containerImageExpirer.close();\n-        hostSwitchUpdater.close();\n+        maintainers.forEach(ControllerMaintainer::close);\n     }\n \n     /** Create one OS upgrader per cloud found in the zone registry of controller */\n"}}, {"oid": "d57ee62839849ff05bb554edb1dfb899c0f2202c", "url": "https://github.com/vespa-engine/vespa/commit/d57ee62839849ff05bb554edb1dfb899c0f2202c", "message": "Close reindexing triggerer", "committedDate": "2020-12-09T19:37:43Z", "type": "commit"}, {"oid": "a963e9ed4580e22e3b351c584ba49b01b4bf03ce", "url": "https://github.com/vespa-engine/vespa/commit/a963e9ed4580e22e3b351c584ba49b01b4bf03ce", "message": "Automate deletion of newly added maintainers :))", "committedDate": "2020-12-09T19:43:11Z", "type": "commit"}, {"oid": "0107067c0a9c29dd4e60231ad79e35786c390626", "url": "https://github.com/vespa-engine/vespa/commit/0107067c0a9c29dd4e60231ad79e35786c390626", "message": "Update API test", "committedDate": "2020-12-09T19:46:19Z", "type": "commit"}, {"oid": "c8f8e85351b70a02b9915b6978dd05e1c2cc55c7", "url": "https://github.com/vespa-engine/vespa/commit/c8f8e85351b70a02b9915b6978dd05e1c2cc55c7", "message": "Split (async) shutdown and (sync) wait for it, and use lists in all maintainer owners", "committedDate": "2020-12-09T20:12:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzOTEyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539639125", "bodyText": "Better, but why do we need both if close calls shutdown when necessary?", "author": "mpolden", "createdAt": "2020-12-09T20:52:36Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java", "diffHunk": "@@ -28,89 +31,47 @@\n  */\n public class ControllerMaintenance extends AbstractComponent {\n \n-    private final DeploymentExpirer deploymentExpirer;\n-    private final DeploymentIssueReporter deploymentIssueReporter;\n-    private final MetricsReporter metricsReporter;\n-    private final OutstandingChangeDeployer outstandingChangeDeployer;\n-    private final VersionStatusUpdater versionStatusUpdater;\n     private final Upgrader upgrader;\n-    private final ReadyJobsTrigger readyJobsTrigger;\n-    private final DeploymentMetricsMaintainer deploymentMetricsMaintainer;\n-    private final ApplicationOwnershipConfirmer applicationOwnershipConfirmer;\n-    private final SystemUpgrader systemUpgrader;\n-    private final List<OsUpgrader> osUpgraders;\n-    private final OsVersionStatusUpdater osVersionStatusUpdater;\n-    private final JobRunner jobRunner;\n-    private final ContactInformationMaintainer contactInformationMaintainer;\n-    private final CostReportMaintainer costReportMaintainer;\n-    private final ResourceMeterMaintainer resourceMeterMaintainer;\n-    private final NameServiceDispatcher nameServiceDispatcher;\n-    private final CloudEventReporter cloudEventReporter;\n-    private final RotationStatusUpdater rotationStatusUpdater;\n-    private final ResourceTagMaintainer resourceTagMaintainer;\n-    private final SystemRoutingPolicyMaintainer systemRoutingPolicyMaintainer;\n-    private final ApplicationMetaDataGarbageCollector applicationMetaDataGarbageCollector;\n-    private final ContainerImageExpirer containerImageExpirer;\n-    private final HostSwitchUpdater hostSwitchUpdater;\n+    private final List<Maintainer> maintainers = new CopyOnWriteArrayList<>();\n \n     @Inject\n     @SuppressWarnings(\"unused\") // instantiated by Dependency Injection\n     public ControllerMaintenance(Controller controller, Metric metric) {\n         Intervals intervals = new Intervals(controller.system());\n-        deploymentExpirer = new DeploymentExpirer(controller, intervals.defaultInterval);\n-        deploymentIssueReporter = new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval);\n-        metricsReporter = new MetricsReporter(controller, metric);\n-        outstandingChangeDeployer = new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer);\n-        versionStatusUpdater = new VersionStatusUpdater(controller, intervals.versionStatusUpdater);\n         upgrader = new Upgrader(controller, intervals.defaultInterval);\n-        readyJobsTrigger = new ReadyJobsTrigger(controller, intervals.readyJobsTrigger);\n-        deploymentMetricsMaintainer = new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer);\n-        applicationOwnershipConfirmer = new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues());\n-        systemUpgrader = new SystemUpgrader(controller, intervals.systemUpgrader);\n-        jobRunner = new JobRunner(controller, intervals.jobRunner);\n-        osUpgraders = osUpgraders(controller, intervals.osUpgrader);\n-        osVersionStatusUpdater = new OsVersionStatusUpdater(controller, intervals.defaultInterval);\n-        contactInformationMaintainer = new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer);\n-        nameServiceDispatcher = new NameServiceDispatcher(controller, intervals.nameServiceDispatcher);\n-        costReportMaintainer = new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer());\n-        resourceMeterMaintainer = new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService());\n-        cloudEventReporter = new CloudEventReporter(controller, intervals.cloudEventReporter, metric);\n-        rotationStatusUpdater = new RotationStatusUpdater(controller, intervals.defaultInterval);\n-        resourceTagMaintainer = new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger());\n-        systemRoutingPolicyMaintainer = new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer);\n-        applicationMetaDataGarbageCollector = new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector);\n-        containerImageExpirer = new ContainerImageExpirer(controller, intervals.containerImageExpirer);\n-        hostSwitchUpdater = new HostSwitchUpdater(controller, intervals.hostSwitchUpdater);\n+        maintainers.add(upgrader);\n+        maintainers.addAll(osUpgraders(controller, intervals.osUpgrader));\n+        maintainers.add(new DeploymentExpirer(controller, intervals.defaultInterval));\n+        maintainers.add(new DeploymentIssueReporter(controller, controller.serviceRegistry().deploymentIssues(), intervals.defaultInterval));\n+        maintainers.add(new MetricsReporter(controller, metric));\n+        maintainers.add(new OutstandingChangeDeployer(controller, intervals.outstandingChangeDeployer));\n+        maintainers.add(new VersionStatusUpdater(controller, intervals.versionStatusUpdater));\n+        maintainers.add(new ReadyJobsTrigger(controller, intervals.readyJobsTrigger));\n+        maintainers.add(new DeploymentMetricsMaintainer(controller, intervals.deploymentMetricsMaintainer));\n+        maintainers.add(new ApplicationOwnershipConfirmer(controller, intervals.applicationOwnershipConfirmer, controller.serviceRegistry().ownershipIssues()));\n+        maintainers.add(new SystemUpgrader(controller, intervals.systemUpgrader));\n+        maintainers.add(new JobRunner(controller, intervals.jobRunner));\n+        maintainers.add(new OsVersionStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ContactInformationMaintainer(controller, intervals.contactInformationMaintainer));\n+        maintainers.add(new NameServiceDispatcher(controller, intervals.nameServiceDispatcher));\n+        maintainers.add(new CostReportMaintainer(controller, intervals.costReportMaintainer, controller.serviceRegistry().costReportConsumer()));\n+        maintainers.add(new ResourceMeterMaintainer(controller, intervals.resourceMeterMaintainer, metric, controller.serviceRegistry().meteringService()));\n+        maintainers.add(new CloudEventReporter(controller, intervals.cloudEventReporter, metric));\n+        maintainers.add(new RotationStatusUpdater(controller, intervals.defaultInterval));\n+        maintainers.add(new ResourceTagMaintainer(controller, intervals.resourceTagMaintainer, controller.serviceRegistry().resourceTagger()));\n+        maintainers.add(new SystemRoutingPolicyMaintainer(controller, intervals.systemRoutingPolicyMaintainer));\n+        maintainers.add(new ApplicationMetaDataGarbageCollector(controller, intervals.applicationMetaDataGarbageCollector));\n+        maintainers.add(new ContainerImageExpirer(controller, intervals.containerImageExpirer));\n+        maintainers.add(new HostSwitchUpdater(controller, intervals.hostSwitchUpdater));\n+        maintainers.add(new ReindexingTriggerer(controller, intervals.reindexingTriggerer));\n     }\n \n     public Upgrader upgrader() { return upgrader; }\n \n     @Override\n     public void deconstruct() {\n-        deploymentExpirer.close();\n-        deploymentIssueReporter.close();\n-        metricsReporter.close();\n-        outstandingChangeDeployer.close();\n-        versionStatusUpdater.close();\n-        upgrader.close();\n-        readyJobsTrigger.close();\n-        deploymentMetricsMaintainer.close();\n-        applicationOwnershipConfirmer.close();\n-        systemUpgrader.close();\n-        osUpgraders.forEach(ControllerMaintainer::close);\n-        osVersionStatusUpdater.close();\n-        jobRunner.close();\n-        contactInformationMaintainer.close();\n-        costReportMaintainer.close();\n-        resourceMeterMaintainer.close();\n-        nameServiceDispatcher.close();\n-        cloudEventReporter.close();\n-        rotationStatusUpdater.close();\n-        resourceTagMaintainer.close();\n-        systemRoutingPolicyMaintainer.close();\n-        applicationMetaDataGarbageCollector.close();\n-        containerImageExpirer.close();\n-        hostSwitchUpdater.close();\n+        maintainers.forEach(Maintainer::shutdown);\n+        maintainers.forEach(Maintainer::close);", "originalCommit": "c8f8e85351b70a02b9915b6978dd05e1c2cc55c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY0MzcyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539643725", "bodyText": "If it's to initiate shutdown on everything at once and then wait, I suggest renaming close. awaitShutdown?", "author": "mpolden", "createdAt": "2020-12-09T21:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzOTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkxNzIwNg==", "url": "https://github.com/vespa-engine/vespa/pull/15765#discussion_r539917206", "bodyText": "Good idea.", "author": "jonmv", "createdAt": "2020-12-10T07:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzOTEyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "06803b97348d9a4fb56df083cae73e2afbc44438", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\nindex 6266e8da57..ff2a196396 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/ControllerMaintenance.java\n\n@@ -71,7 +70,7 @@ public class ControllerMaintenance extends AbstractComponent {\n     @Override\n     public void deconstruct() {\n         maintainers.forEach(Maintainer::shutdown);\n-        maintainers.forEach(Maintainer::close);\n+        maintainers.forEach(Maintainer::awaitShutdown);\n     }\n \n     /** Create one OS upgrader per cloud found in the zone registry of controller */\n"}}, {"oid": "06803b97348d9a4fb56df083cae73e2afbc44438", "url": "https://github.com/vespa-engine/vespa/commit/06803b97348d9a4fb56df083cae73e2afbc44438", "message": "Rename close to awaitShutdown", "committedDate": "2020-12-10T07:01:50Z", "type": "commit"}]}