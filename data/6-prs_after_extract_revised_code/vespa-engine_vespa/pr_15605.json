{"pr_number": 15605, "pr_title": "Limit HostSwitchUpdater to relevant systems", "pr_createdAt": "2020-12-02T14:22:28Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15605", "timeline": [{"oid": "99bcfff52bf4982e214e31a75cab31651b03490c", "url": "https://github.com/vespa-engine/vespa/commit/99bcfff52bf4982e214e31a75cab31651b03490c", "message": "Limit HostSwitchUpdater to relevant systems", "committedDate": "2020-12-02T14:21:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIwNzAzNg==", "url": "https://github.com/vespa-engine/vespa/pull/15605#discussion_r534207036", "bodyText": "Could also limit this to yahoo cloud zones...", "author": "freva", "createdAt": "2020-12-02T14:26:26Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java", "diffHunk": "@@ -31,14 +36,22 @@ protected boolean maintain() {\n         Map<String, NodeEntity> nodeEntities = controller().serviceRegistry().entityService().listNodes().stream()\n                                                            .collect(Collectors.toMap(NodeEntity::hostname,\n                                                                                      Function.identity()));\n-        for (var zone : controller().zoneRegistry().zones().controllerUpgraded().all().ids()) {\n-            for (var node : nodeRepository.list(zone)) {\n-                NodeEntity nodeEntity = nodeEntities.get(node.hostname().value());\n-                if (!shouldUpdate(node, nodeEntity)) continue;\n-\n-                NodeRepositoryNode updatedNode = new NodeRepositoryNode();\n-                updatedNode.setSwitchHostname(nodeEntity.switchHostname().get());\n-                nodeRepository.patchNode(zone, node.hostname().value(), updatedNode);\n+        int nodesUpdated = 0;\n+        try {\n+            for (var zone : controller().zoneRegistry().zones().controllerUpgraded().all().ids()) {", "originalCommit": "99bcfff52bf4982e214e31a75cab31651b03490c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIxODI0OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15605#discussion_r534218249", "bodyText": "Yes, but that's not available here so would have to use string. \ud83d\ude1e", "author": "mpolden", "createdAt": "2020-12-02T14:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIwNzAzNg=="}], "type": "inlineReview", "revised_code": {"commit": "079a183dfca7a290cf697e4c7ee2d479e04f4d39", "chunk": "diff --git a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java\nindex b703607020..4065645ee5 100644\n--- a/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java\n+++ b/controller-server/src/main/java/com/yahoo/vespa/hosted/controller/maintenance/HostSwitchUpdater.java\n\n@@ -40,7 +44,7 @@ public class HostSwitchUpdater extends ControllerMaintainer {\n         try {\n             for (var zone : controller().zoneRegistry().zones().controllerUpgraded().all().ids()) {\n                 for (var node : nodeRepository.list(zone)) {\n-                    NodeEntity nodeEntity = nodeEntities.get(node.hostname().value());\n+                    NodeEntity nodeEntity = nodeEntities.get(registeredHostnameOf(node));\n                     if (!shouldUpdate(node, nodeEntity)) continue;\n \n                     NodeRepositoryNode updatedNode = new NodeRepositoryNode();\n"}}, {"oid": "079a183dfca7a290cf697e4c7ee2d479e04f4d39", "url": "https://github.com/vespa-engine/vespa/commit/079a183dfca7a290cf697e4c7ee2d479e04f4d39", "message": "Handle hosts registered under a different hostname", "committedDate": "2020-12-02T18:26:17Z", "type": "commit"}]}