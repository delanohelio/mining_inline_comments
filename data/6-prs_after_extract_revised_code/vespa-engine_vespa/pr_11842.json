{"pr_number": 11842, "pr_title": "accept and store json endpoint cert metadata on deploy", "pr_createdAt": "2020-01-17T16:00:42Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11842", "timeline": [{"oid": "e66e0ba2ccd2b973a13eff8645af66073eba31ed", "url": "https://github.com/vespa-engine/vespa/commit/e66e0ba2ccd2b973a13eff8645af66073eba31ed", "message": "accept and store json endpoint cert metadata on deploy\n\nalso refactor from tlsSecretKeys -> several \"endpoint certificate\" classes", "committedDate": "2020-01-17T15:59:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTU5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368399597", "bodyText": "We've had cases where the version of private key and cert were incompatible. Would it make sense to validate that the cert is indeed issued using the private key?", "author": "tokle", "createdAt": "2020-01-20T07:30:11Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java", "diffHunk": "@@ -0,0 +1,37 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.tenant;\n+\n+import com.yahoo.config.model.api.EndpointCertificateMetadata;\n+import com.yahoo.config.model.api.EndpointCertificateSecrets;\n+import com.yahoo.container.jdisc.secretstore.SecretStore;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Used to retrieve actual endpoint certificate/key from secret store.\n+ *\n+ * @author andreer\n+ */\n+public class EndpointCertificateRetriever {\n+\n+    private final SecretStore secretStore;\n+\n+    public EndpointCertificateRetriever(SecretStore secretStore) {\n+        this.secretStore = secretStore;\n+    }\n+\n+    public Optional<EndpointCertificateSecrets> readEndpointCertificateSecrets(EndpointCertificateMetadata metadata) {\n+        return Optional.of(readFromSecretStore(metadata));\n+    }\n+\n+    private EndpointCertificateSecrets readFromSecretStore(EndpointCertificateMetadata endpointCertificateMetadata) {", "originalCommit": "e66e0ba2ccd2b973a13eff8645af66073eba31ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MDc5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368440799", "bodyText": "Yes, I think I have a ticket on this too. Might as well add it now.", "author": "andreer", "createdAt": "2020-01-20T09:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTU5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c67da739049f3c392b8d6c16953a771fcb1df5fd", "chunk": "diff --git a/configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java b/configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java\nindex cc757ef703..5f40e5e141 100644\n--- a/configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java\n+++ b/configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateRetriever.java\n\n@@ -4,7 +4,12 @@ package com.yahoo.vespa.config.server.tenant;\n import com.yahoo.config.model.api.EndpointCertificateMetadata;\n import com.yahoo.config.model.api.EndpointCertificateSecrets;\n import com.yahoo.container.jdisc.secretstore.SecretStore;\n+import com.yahoo.security.KeyUtils;\n+import com.yahoo.security.X509CertificateUtils;\n \n+import java.security.PrivateKey;\n+import java.security.PublicKey;\n+import java.security.cert.X509Certificate;\n import java.util.Optional;\n \n /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTc0Mw==", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368399743", "bodyText": "Won't this violate the principle of \"serialized on version N+1 can be read by version N\"?", "author": "tokle", "createdAt": "2020-01-20T07:30:47Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/tenant/EndpointCertificateMetadataSerializer.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.yahoo.vespa.config.server.tenant;\n+\n+import com.yahoo.config.model.api.EndpointCertificateMetadata;\n+import com.yahoo.slime.Cursor;\n+import com.yahoo.slime.Inspector;\n+import com.yahoo.slime.Slime;\n+\n+/**\n+ * (de)serializes endpoint certificate metadata\n+ *\n+ * @author andreer\n+ */\n+public class EndpointCertificateMetadataSerializer {\n+\n+    // WARNING: Since there are multiple servers in a ZooKeeper cluster and they upgrade one by one\n+    //          (and rewrite all nodes on startup), changes to the serialized format must be made\n+    //          such that what is serialized on version N+1 can be read by version N:\n+    //          - ADDING FIELDS: Always ok\n+    //          - REMOVING FIELDS: Stop reading the field first. Stop writing it on a later version.\n+    //          - CHANGING THE FORMAT OF A FIELD: Don't do it bro.\n+\n+    private final static String keyNameField = \"keyName\";\n+    private final static String certNameField = \"certName\";\n+    private final static String versionField = \"version\";\n+\n+    public static void toSlime(EndpointCertificateMetadata metadata, Cursor object) {", "originalCommit": "e66e0ba2ccd2b973a13eff8645af66073eba31ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MTgyMA==", "url": "https://github.com/vespa-engine/vespa/pull/11842#discussion_r368441820", "bodyText": "The configserver can already read this format: https://github.com/vespa-engine/vespa/blob/master/configserver/src/test/java/com/yahoo/vespa/config/server/tenant/TlsSecretsKeysTest.java#L49-L58\nWe only start writing it now.", "author": "andreer", "createdAt": "2020-01-20T09:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5OTc0Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c67da739049f3c392b8d6c16953a771fcb1df5fd", "url": "https://github.com/vespa-engine/vespa/commit/c67da739049f3c392b8d6c16953a771fcb1df5fd", "message": "verify public key matches private key", "committedDate": "2020-01-20T10:19:41Z", "type": "commit"}, {"oid": "db7ae7f2f7e65c01703689a418476f963e3d8dd4", "url": "https://github.com/vespa-engine/vespa/commit/db7ae7f2f7e65c01703689a418476f963e3d8dd4", "message": "use valid cert/key in test", "committedDate": "2020-01-20T11:04:54Z", "type": "commit"}, {"oid": "49c8929ab9523af3e702af0e04b2994e98ac88e7", "url": "https://github.com/vespa-engine/vespa/commit/49c8929ab9523af3e702af0e04b2994e98ac88e7", "message": "use valid cert/key in test", "committedDate": "2020-01-20T12:42:00Z", "type": "commit"}]}