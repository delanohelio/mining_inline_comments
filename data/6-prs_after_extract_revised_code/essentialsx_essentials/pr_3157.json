{"pr_number": 3157, "pr_title": "Save player logout times on shutdown", "pr_createdAt": "2020-04-11T15:45:30Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3157", "timeline": [{"oid": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "url": "https://github.com/EssentialsX/Essentials/commit/9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "message": "Add isStopping support", "committedDate": "2020-04-11T15:43:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTAzNw==", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141037", "bodyText": "This is definitely the wrong thing to run here.\nShould instead be user.cleanup() - user.dispose() will create an async task to eventually call user.cleanup, which will throw an exception. (Or should, since the server is shutting down).", "author": "Ichbinjoe", "createdAt": "2020-04-12T03:41:26Z", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();", "originalCommit": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0Mzk2MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407143960", "bodyText": "Ah okay, got confused on what did what :P", "author": "JRoy", "createdAt": "2020-04-12T04:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTAzNw=="}], "type": "inlineReview", "revised_code": {"commit": "def752e4db6c69406464fcf33723ff57c5250814", "chunk": "diff --git a/Essentials/src/com/earth2me/essentials/Essentials.java b/Essentials/src/com/earth2me/essentials/Essentials.java\nindex e5da3e783..926557484 100644\n--- a/Essentials/src/com/earth2me/essentials/Essentials.java\n+++ b/Essentials/src/com/earth2me/essentials/Essentials.java\n\n@@ -392,10 +392,10 @@ public class Essentials extends JavaPlugin implements net.ess3.api.IEssentials {\n                     user.setLastLogout(System.currentTimeMillis());\n                 }\n                 user.stopTransaction();\n-                user.dispose();\n-                continue;\n+                user.cleanup();\n+            } else {\n+                user.stopTransaction();\n             }\n-            user.stopTransaction();\n         }\n         cleanupOpenInventories();\n         if (i18n != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0MTA4OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407141089", "bodyText": "Wrap in else and remove continue - helps convey flow.", "author": "Ichbinjoe", "createdAt": "2020-04-12T03:42:08Z", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,11 +373,28 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.dispose();\n+                continue;\n+            }\n             user.stopTransaction();", "originalCommit": "9497dc15c3bdb71563e2763d4646ae7c0f7d6a20", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "def752e4db6c69406464fcf33723ff57c5250814", "chunk": "diff --git a/Essentials/src/com/earth2me/essentials/Essentials.java b/Essentials/src/com/earth2me/essentials/Essentials.java\nindex e5da3e783..926557484 100644\n--- a/Essentials/src/com/earth2me/essentials/Essentials.java\n+++ b/Essentials/src/com/earth2me/essentials/Essentials.java\n\n@@ -392,10 +392,10 @@ public class Essentials extends JavaPlugin implements net.ess3.api.IEssentials {\n                     user.setLastLogout(System.currentTimeMillis());\n                 }\n                 user.stopTransaction();\n-                user.dispose();\n-                continue;\n+                user.cleanup();\n+            } else {\n+                user.stopTransaction();\n             }\n-            user.stopTransaction();\n         }\n         cleanupOpenInventories();\n         if (i18n != null) {\n"}}, {"oid": "def752e4db6c69406464fcf33723ff57c5250814", "url": "https://github.com/EssentialsX/Essentials/commit/def752e4db6c69406464fcf33723ff57c5250814", "message": "Review changes", "committedDate": "2020-04-12T04:25:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyMDIxOA==", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407320218", "bodyText": "@md678685 shouldn't this be called anyways (regardless of shutdown)? Could see instances where this isn't called on Disable due to a /reload or plugman bullshit where we lose data.", "author": "Ichbinjoe", "createdAt": "2020-04-13T05:05:38Z", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -357,12 +373,29 @@ private void registerListeners(PluginManager pm) {\n \n     @Override\n     public void onDisable() {\n+        boolean stopping = false;\n+        if (isStopping != null) {\n+            try {\n+                stopping = (boolean) isStopping.invoke();\n+            } catch (Throwable throwable) {\n+                throwable.printStackTrace();\n+            }\n+        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n-            user.stopTransaction();\n+            if (stopping) {\n+                user.setLogoutLocation();\n+                if (!user.isHidden()) {\n+                    user.setLastLogout(System.currentTimeMillis());\n+                }\n+                user.stopTransaction();\n+                user.cleanup();", "originalCommit": "def752e4db6c69406464fcf33723ff57c5250814", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2NzQ3Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3157#discussion_r407367472", "bodyText": "stopTransaction and cleanup both run a save task on another thread, but cleanup waits for that task to complete. Running cleanup during a reload means the server will hang up while saving data for everyone, which isn't necessary. I'm pretty sure loading the user data would wait for the save task regardless, if we actually are reloading.", "author": "mdcfe", "createdAt": "2020-04-13T08:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyMDIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "b419da49e65339abf86c81e0724fc827552ee2c1", "chunk": "diff --git a/Essentials/src/com/earth2me/essentials/Essentials.java b/Essentials/src/com/earth2me/essentials/Essentials.java\nindex 926557484..b3bad321a 100644\n--- a/Essentials/src/com/earth2me/essentials/Essentials.java\n+++ b/Essentials/src/com/earth2me/essentials/Essentials.java\n\n@@ -373,29 +374,12 @@ public class Essentials extends JavaPlugin implements net.ess3.api.IEssentials {\n \n     @Override\n     public void onDisable() {\n-        boolean stopping = false;\n-        if (isStopping != null) {\n-            try {\n-                stopping = (boolean) isStopping.invoke();\n-            } catch (Throwable throwable) {\n-                throwable.printStackTrace();\n-            }\n-        }\n         for (User user : getOnlineUsers()) {\n             if (user.isVanished()) {\n                 user.setVanished(false);\n                 user.sendMessage(tl(\"unvanishedReload\"));\n             }\n-            if (stopping) {\n-                user.setLogoutLocation();\n-                if (!user.isHidden()) {\n-                    user.setLastLogout(System.currentTimeMillis());\n-                }\n-                user.stopTransaction();\n-                user.cleanup();\n-            } else {\n-                user.stopTransaction();\n-            }\n+            user.stopTransaction();\n         }\n         cleanupOpenInventories();\n         if (i18n != null) {\n"}}, {"oid": "b419da49e65339abf86c81e0724fc827552ee2c1", "url": "https://github.com/EssentialsX/Essentials/commit/b419da49e65339abf86c81e0724fc827552ee2c1", "message": "Merge branch '2.x' into feature/2764\n\n# Conflicts:\n#\tEssentials/src/com/earth2me/essentials/Essentials.java", "committedDate": "2020-04-13T21:00:54Z", "type": "commit"}, {"oid": "2a3c4e552851f99d210ed25ea66389ab2b276baa", "url": "https://github.com/EssentialsX/Essentials/commit/2a3c4e552851f99d210ed25ea66389ab2b276baa", "message": "Reduce diff", "committedDate": "2020-04-13T21:01:42Z", "type": "commit"}, {"oid": "9e60e7bd8abfadbacdc647290a45c238d527a9c0", "url": "https://github.com/EssentialsX/Essentials/commit/9e60e7bd8abfadbacdc647290a45c238d527a9c0", "message": "Add support for legacy and non-paper forks", "committedDate": "2020-04-13T22:18:26Z", "type": "commit"}, {"oid": "dd650a1a78477f86782a616d4b7bc1d514e459af", "url": "https://github.com/EssentialsX/Essentials/commit/dd650a1a78477f86782a616d4b7bc1d514e459af", "message": "Move isRunning/isStopping code to separate class", "committedDate": "2020-05-11T13:39:47Z", "type": "commit"}]}