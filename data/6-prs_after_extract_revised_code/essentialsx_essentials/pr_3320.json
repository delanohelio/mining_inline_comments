{"pr_number": 3320, "pr_title": "Add support for permission contexts", "pr_createdAt": "2020-05-23T01:14:44Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3320", "timeline": [{"oid": "2469a6b13ee28387bc4dc02a157990d36b8ee4e5", "url": "https://github.com/EssentialsX/Essentials/commit/2469a6b13ee28387bc4dc02a157990d36b8ee4e5", "message": "Add permission contexts to Essentials", "committedDate": "2020-05-23T00:53:33Z", "type": "commit"}, {"oid": "784efcf855738ab2bb97e26b703af59c30873532", "url": "https://github.com/EssentialsX/Essentials/commit/784efcf855738ab2bb97e26b703af59c30873532", "message": "More abstraction", "committedDate": "2020-05-23T03:37:24Z", "type": "commit"}, {"oid": "6fff9500bb61101039bf406b984821497f642e60", "url": "https://github.com/EssentialsX/Essentials/commit/6fff9500bb61101039bf406b984821497f642e60", "message": "Apply suggestions", "committedDate": "2020-05-24T03:59:27Z", "type": "commit"}, {"oid": "a8f6667f6343d5c92f36caa2451e155bc8046d04", "url": "https://github.com/EssentialsX/Essentials/commit/a8f6667f6343d5c92f36caa2451e155bc8046d04", "message": "iterable instead of set", "committedDate": "2020-05-24T07:55:08Z", "type": "commit"}, {"oid": "ebe6553d93cf6ca55c30c0b3be627c52f2de2b85", "url": "https://github.com/EssentialsX/Essentials/commit/ebe6553d93cf6ca55c30c0b3be627c52f2de2b85", "message": "Address concerns about reloads", "committedDate": "2020-05-24T23:44:38Z", "type": "commit"}, {"oid": "85b626cc2ef70c19afceae801cc6d8d6243a969a", "url": "https://github.com/EssentialsX/Essentials/commit/85b626cc2ef70c19afceae801cc6d8d6243a969a", "message": "Support context prefixing", "committedDate": "2020-05-24T23:58:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4OTM1Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r429689352", "bodyText": "Just want to note my objection here to defaulting to no namespacing! :)", "author": "mbax", "createdAt": "2020-05-25T00:09:40Z", "path": "Essentials/src/com/earth2me/essentials/Settings.java", "diffHunk": "@@ -1653,6 +1653,12 @@ public boolean logCommandBlockCommands() {\n         return blacklist;\n     }\n \n+    // #easteregg\n+    @Override\n+    public String getContextPrefix() {\n+        return config.getString(\"context-prefix\", \"\");", "originalCommit": "85b626cc2ef70c19afceae801cc6d8d6243a969a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MDc3OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r429690778", "bodyText": "Noted! I went and explained my reasoning below. The issue of default namespacing can be tackled at a later date, assuming that it becomes a real issue.", "author": "pop4959", "createdAt": "2020-05-25T00:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4OTM1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "495f90cc1e4206199754658033620327b6947bb5", "chunk": "diff --git a/Essentials/src/com/earth2me/essentials/Settings.java b/Essentials/src/com/earth2me/essentials/Settings.java\nindex 12a76e1b4..5f1551685 100644\n--- a/Essentials/src/com/earth2me/essentials/Settings.java\n+++ b/Essentials/src/com/earth2me/essentials/Settings.java\n\n@@ -1653,12 +1653,6 @@ public class Settings implements net.ess3.api.ISettings {\n         return blacklist;\n     }\n \n-    // #easteregg\n-    @Override\n-    public String getContextPrefix() {\n-        return config.getString(\"context-prefix\", \"\");\n-    }\n-\n     @Override\n     public Set<Predicate<String>> getNickBlacklist() {\n         return nickBlacklist;\n"}}, {"oid": "495f90cc1e4206199754658033620327b6947bb5", "url": "https://github.com/EssentialsX/Essentials/commit/495f90cc1e4206199754658033620327b6947bb5", "message": "Revert \"Support context prefixing\"\n\nThis reverts commit 85b626cc2ef70c19afceae801cc6d8d6243a969a.", "committedDate": "2020-05-25T02:44:48Z", "type": "commit"}, {"oid": "050c1cc62aed555bdb4a3768298191aeeb172fbb", "url": "https://github.com/EssentialsX/Essentials/commit/050c1cc62aed555bdb4a3768298191aeeb172fbb", "message": "Static prefix", "committedDate": "2020-05-25T02:46:09Z", "type": "commit"}, {"oid": "a421958a0ea239c4701f7b43f95a5e69ac97dabd", "url": "https://github.com/EssentialsX/Essentials/commit/a421958a0ea239c4701f7b43f95a5e69ac97dabd", "message": "this is probably also good to do", "committedDate": "2020-05-25T03:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r429907931", "bodyText": "These register calls should probably be in onEnable??\nUnless I'm missing something, they're currently being added on every PluginEnableEvent? (this is gonna fire every time a plugin loads?!)", "author": "lucko", "createdAt": "2020-05-25T12:26:00Z", "path": "Essentials/src/com/earth2me/essentials/EssentialsPluginListener.java", "diffHunk": "@@ -25,6 +27,9 @@ public void onPluginEnable(final PluginEnableEvent event) {\n         }\n         ess.getPermissionsHandler().setUseSuperperms(ess.getSettings().useBukkitPermissions());\n         ess.getPermissionsHandler().checkPermissions();\n+        ess.getPermissionsHandler().registerContext(\"ess-afk\", player -> Collections.singleton(String.valueOf(ess.getUser(player).isAfk())), () -> ImmutableSet.of(\"true\", \"false\"));", "originalCommit": "a421958a0ea239c4701f7b43f95a5e69ac97dabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1NTM2OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430055369", "bodyText": "No... I think you're right about that. It is definitely going to fire every time a plugin loads. I actually did originally have these in onEnable, but the problem is that before checkPermissions is run (which is only done here) the handler in PermissionsHandler is null. It's probably done in this fashion to avoid adding softdepends on every Vault-based permission plugin.\nTwo possible solutions:\n\nFrom the event, check if the plugin is a known one that supports contexts.\nSchedule a task to register contexts on the first server tick.\n\nI don't particularly like either solution, but it doesn't seem like Bukkit has any event that gets called after all plugins are loaded. Maybe something else works too, but this is what comes to mind. Any opinions?", "author": "pop4959", "createdAt": "2020-05-25T19:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1OTc1OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430059759", "bodyText": "So I got another idea from Glare (on Discord) that I like slightly better, which is a spin-off of my first solution. Instead of checking from this event, we do actually do it in onEnable, since after we've checked that a context supporting permission plugin is loaded, it should be safe to register the contexts since Essentials has a softdepend on it, and thus checkPermissions has to have run already and have a non-null handler.", "author": "pop4959", "createdAt": "2020-05-25T19:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2MTgzMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430061832", "bodyText": "You're also already storing a\nprivate Set<ContextCalculator<Player>> contextCalculators\nWouldn't be the biggest change to make that a Map<String, ContextCalculator<Player>> and just check to see if already registered - just an idea.\nHowever, I'd suggest re-thinking whether that logic really needs to be running every time a plugin enables in the first place...", "author": "lucko", "createdAt": "2020-05-25T20:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2MjU0Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430062543", "bodyText": "ess.getPermissionsHandler().setUseSuperperms(ess.getSettings().useBukkitPermissions());\ness.getPermissionsHandler().checkPermissions();\ness.getPermissionsHandler().registerContext(...);\ncan all be moved to onEnable, you're softdepending on LuckPerms now anyway.\nThen just keep a single call to\ness.getPermissionsHandler().checkPermissions();\nin the plugin enable listener to catch other permission plugins.\nThe call to\ness.getPermissionsHandler().unregisterContexts();\ndefinitely needs to be moved to onDisable. In it's current position, contexts are going to be unregistered every time any plugin is disabled.", "author": "lucko", "createdAt": "2020-05-25T20:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NzYzNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430067634", "bodyText": "These should only be re-applied when the currently active permissions handler changes.\nI'm not sure how I feel about registering these here - I'd personally have put them in a separate method or even a new class, as the amount of contexts will likely increase and it feels cluttered to throw them in here. Perhaps they could be added to a default registerContexts method on PermissionHandler?", "author": "mdcfe", "createdAt": "2020-05-25T20:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA5MDY5MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3320#discussion_r430090690", "bodyText": "Yeah, it wasn't my intention to leave the registrations there either. It was just an easy place to put them for now while testing everything. They can be registered from anywhere though, whether that's primarily in onEnable, or a registerContexts method. For the latter, we probably want to consider if all contexts will always be enabled all at once, or if there are contexts which may need to be initialized elsewhere (because the calculator function needs to be defined in scope of whatever it's using, although most of the time that would probably be the Essentials instance).", "author": "pop4959", "createdAt": "2020-05-25T22:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwNzkzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "bcee1e598528a7a1ae7d843e7e822ce0649a0fca", "chunk": "diff --git a/Essentials/src/com/earth2me/essentials/EssentialsPluginListener.java b/Essentials/src/com/earth2me/essentials/EssentialsPluginListener.java\nindex e5b276abc..d7543cdc8 100644\n--- a/Essentials/src/com/earth2me/essentials/EssentialsPluginListener.java\n+++ b/Essentials/src/com/earth2me/essentials/EssentialsPluginListener.java\n\n@@ -27,9 +25,6 @@ public class EssentialsPluginListener implements Listener, IConf {\n         }\n         ess.getPermissionsHandler().setUseSuperperms(ess.getSettings().useBukkitPermissions());\n         ess.getPermissionsHandler().checkPermissions();\n-        ess.getPermissionsHandler().registerContext(\"ess-afk\", player -> Collections.singleton(String.valueOf(ess.getUser(player).isAfk())), () -> ImmutableSet.of(\"true\", \"false\"));\n-        ess.getPermissionsHandler().registerContext(\"ess-muted\", player -> Collections.singleton(String.valueOf(ess.getUser(player).isMuted())), () -> ImmutableSet.of(\"true\", \"false\"));\n-        ess.getPermissionsHandler().registerContext(\"ess-vanished\", player -> Collections.singleton(String.valueOf(ess.getUser(player).isHidden())), () -> ImmutableSet.of(\"true\", \"false\"));\n         ess.getAlternativeCommandsHandler().addPlugin(event.getPlugin());\n         if (!Methods.hasMethod() && Methods.setMethod(ess.getServer().getPluginManager())) {\n             ess.getLogger().log(Level.INFO, \"Payment method found (\" + Methods.getMethod().getLongName() + \" version: \" + ess.getPaymentMethod().getMethod().getVersion() + \")\");\n"}}, {"oid": "bcee1e598528a7a1ae7d843e7e822ce0649a0fca", "url": "https://github.com/EssentialsX/Essentials/commit/bcee1e598528a7a1ae7d843e7e822ce0649a0fca", "message": "Handle registrations in onEnable/onDisable", "committedDate": "2020-05-26T09:13:21Z", "type": "commit"}, {"oid": "e51f400afff9da4dbd93a31beb16efecbd370a6b", "url": "https://github.com/EssentialsX/Essentials/commit/e51f400afff9da4dbd93a31beb16efecbd370a6b", "message": "Change prefixes again", "committedDate": "2020-05-26T09:15:53Z", "type": "commit"}, {"oid": "00a9b9e5db4b1897c8522c2a3439b1d57e2832af", "url": "https://github.com/EssentialsX/Essentials/commit/00a9b9e5db4b1897c8522c2a3439b1d57e2832af", "message": "Change context registrations only when the active permission handler changes", "committedDate": "2020-05-31T21:58:41Z", "type": "commit"}]}