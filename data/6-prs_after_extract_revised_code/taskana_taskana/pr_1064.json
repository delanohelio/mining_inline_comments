{"pr_number": 1064, "pr_title": "TSK-1218: Prevent unsecure access to TASKANA", "pr_createdAt": "2020-05-13T06:48:14Z", "pr_url": "https://github.com/Taskana/taskana/pull/1064", "timeline": [{"oid": "ebd22c3fb7858a801929a136dbd40c003d51aee4", "url": "https://github.com/Taskana/taskana/commit/ebd22c3fb7858a801929a136dbd40c003d51aee4", "message": "TSK-1218: Prevent unsecure access to TASKANA", "committedDate": "2020-05-13T09:23:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU5NzI0MQ==", "url": "https://github.com/Taskana/taskana/pull/1064#discussion_r425597241", "bodyText": "why do you check this? Even if security is activated we might be the first one and want to insert this information into the database, don't we?", "author": "holgerhagen", "createdAt": "2020-05-15T06:42:23Z", "path": "lib/taskana-core/src/main/java/pro/taskana/common/internal/configuration/SecurityVerifier.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package pro.taskana.common.internal.configuration;\n+\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import javax.sql.DataSource;\n+import org.apache.ibatis.jdbc.SqlRunner;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import pro.taskana.common.api.exceptions.SystemException;\n+\n+public class SecurityVerifier {\n+\n+  private static final Logger LOGGER = LoggerFactory.getLogger(SecurityVerifier.class);\n+  private static final String SECURITY_FLAG_COLUMN_NAME = \"ENFORCE_SECURITY\";\n+  private static final String INSERT_SECURITY_FLAG = \"INSERT INTO %s.CONFIGURATION VALUES (%b)\";\n+  private static final String SELECT_SECURITY_FLAG = \"SELECT %s FROM %s.CONFIGURATION\";\n+  private final String schemaName;\n+  private DataSource dataSource;\n+\n+\n+  public SecurityVerifier(DataSource dataSource, String schema) {\n+    super();\n+    this.dataSource = dataSource;\n+    this.schemaName = schema;\n+  }\n+\n+  public void checkSecureAccess(boolean securityEnabled) {\n+\n+    if (!securityEnabled) {", "originalCommit": "ebd22c3fb7858a801929a136dbd40c003d51aee4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02f364e5100535c7ccaf33cdcf865bb4d4921a78", "chunk": "diff --git a/lib/taskana-core/src/main/java/pro/taskana/common/internal/configuration/SecurityVerifier.java b/lib/taskana-core/src/main/java/pro/taskana/common/internal/configuration/SecurityVerifier.java\nindex 63444ff74..fefae5aa7 100644\n--- a/lib/taskana-core/src/main/java/pro/taskana/common/internal/configuration/SecurityVerifier.java\n+++ b/lib/taskana-core/src/main/java/pro/taskana/common/internal/configuration/SecurityVerifier.java\n\n@@ -28,35 +28,40 @@ public class SecurityVerifier {\n \n   public void checkSecureAccess(boolean securityEnabled) {\n \n-    if (!securityEnabled) {\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(String.format(\"Entering checkSecureAccess with securityEnabled set to %b\",\n+          securityEnabled));\n+    }\n \n-      LOGGER.debug(\"Trying to connect in disabled security-mode\");\n+    try (Connection connection = dataSource.getConnection()) {\n \n-      try (Connection connection = dataSource.getConnection()) {\n+      if (LOGGER.isDebugEnabled()) {\n+        LOGGER.debug(connection.getMetaData().toString());\n+      }\n \n-        if (LOGGER.isDebugEnabled()) {\n-          LOGGER.debug(connection.getMetaData().toString());\n-        }\n+      SqlRunner sqlRunner = new SqlRunner(connection);\n \n-        SqlRunner sqlRunner = new SqlRunner(connection);\n+      String querySecurity = String.format(SELECT_SECURITY_FLAG, SECURITY_FLAG_COLUMN_NAME,\n+          schemaName);\n \n-        String querySecurity = String.format(SELECT_SECURITY_FLAG, SECURITY_FLAG_COLUMN_NAME,\n-            schemaName);\n+      if ((boolean) sqlRunner.selectOne(querySecurity).get(SECURITY_FLAG_COLUMN_NAME)\n+              && !securityEnabled) {\n \n-        if ((boolean) sqlRunner.selectOne(querySecurity).get(SECURITY_FLAG_COLUMN_NAME)) {\n+        LOGGER.error(\"Tried to start TASKANA in unsecured mode while secured mode is enforced!\");\n \n-          throw new SystemException(\n-              \"Secured TASKANA mode is enforced, can't start in unsecured mode\");\n-        }\n-      } catch (SQLException ex) {\n+        throw new SystemException(\n+            \"Secured TASKANA mode is enforced, can't start in unsecured mode\");\n+\n+      }\n+    } catch (SQLException ex) {\n \n-        LOGGER.info(String.format(\n-            \"Security-mode is not yet set. Setting security flag to %b\", securityEnabled));\n+      LOGGER.info(String.format(\n+          \"Security-mode is not yet set. Setting security flag to %b\", securityEnabled));\n \n-        setInitialSecurityMode(securityEnabled);\n+      setInitialSecurityMode(securityEnabled);\n \n-      }\n     }\n+\n     LOGGER.debug(\"Security-mode is enabled\");\n \n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU5ODA3OQ==", "url": "https://github.com/Taskana/taskana/pull/1064#discussion_r425598079", "bodyText": "According to my comment above: do we miss the test for starting secure the first time and initialize the security flag?", "author": "holgerhagen", "createdAt": "2020-05-15T06:44:40Z", "path": "lib/taskana-core/src/test/java/acceptance/config/TaskanaSecurityConfigAccTest.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package acceptance.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatCode;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import javax.sql.DataSource;\n+import org.assertj.core.api.ThrowableAssert.ThrowingCallable;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import pro.taskana.TaskanaEngineConfiguration;\n+import pro.taskana.common.api.exceptions.SystemException;\n+import pro.taskana.common.internal.TaskanaEngineTestConfiguration;\n+import pro.taskana.common.internal.configuration.DbSchemaCreator;\n+import pro.taskana.sampledata.SampleDataGenerator;\n+\n+public class TaskanaSecurityConfigAccTest {\n+\n+  @BeforeAll\n+  public static void setupTests() throws SQLException {\n+    DataSource dataSource = TaskanaEngineTestConfiguration.getDataSource();\n+    String schemaName = TaskanaEngineTestConfiguration.getSchemaName();\n+    DbSchemaCreator dbSchemaCreator = new DbSchemaCreator(dataSource, schemaName);\n+    dbSchemaCreator.run();\n+  }\n+\n+  @AfterEach\n+  public void cleanDb() {\n+    DataSource dataSource = TaskanaEngineTestConfiguration.getDataSource();\n+    String schemaName = TaskanaEngineTestConfiguration.getSchemaName();\n+\n+    SampleDataGenerator sampleDataGenerator = new SampleDataGenerator(dataSource, schemaName);\n+    sampleDataGenerator.clearDb();\n+  }\n+\n+  @Test\n+  public void should_ThrowException_When_CreatingUnsecuredEngineConfigWhileSecurityIsEnforced()\n+      throws SQLException {\n+\n+    setSecurityFlag(true);\n+\n+    ThrowingCallable createUnsecuredTaskanaEngineConfiguration = () -> {\n+\n+      TaskanaEngineConfiguration taskanaEngineConfiguration = new TaskanaEngineConfiguration(\n+          TaskanaEngineTestConfiguration.getDataSource(), false, false,\n+          TaskanaEngineTestConfiguration.getSchemaName());\n+    };\n+\n+    assertThatThrownBy(createUnsecuredTaskanaEngineConfiguration)\n+        .isInstanceOf(SystemException.class)\n+        .hasMessageContaining(\"Secured TASKANA mode is enforced, can't start in unsecured mode\");\n+\n+  }\n+\n+  @Test\n+  public void should_StartUpNormally_When_CreatingUnsecuredEngineConfigWhileSecurityIsNotEnforced()\n+      throws SQLException {\n+\n+    setSecurityFlag(false);\n+\n+    ThrowingCallable createUnsecuredTaskanaEngineConfiguration = () -> {\n+\n+      TaskanaEngineConfiguration taskanaEngineConfiguration = new TaskanaEngineConfiguration(\n+          TaskanaEngineTestConfiguration.getDataSource(), false, false,\n+          TaskanaEngineTestConfiguration.getSchemaName());\n+    };\n+\n+    assertThatCode(createUnsecuredTaskanaEngineConfiguration).doesNotThrowAnyException();\n+\n+  }\n+\n+  @Test\n+  public void should_SetSecurityFlag_When_SecurityFlagIsNotSet() throws SQLException {\n+\n+    assertThat(retrieveSecurityFlag()).isNull();\n+\n+    ThrowingCallable createUnsecuredTaskanaEngineConfiguration = () -> {\n+\n+      TaskanaEngineConfiguration taskanaEngineConfiguration = new TaskanaEngineConfiguration(\n+          TaskanaEngineTestConfiguration.getDataSource(), false, false,\n+          TaskanaEngineTestConfiguration.getSchemaName());\n+    };\n+\n+    assertThatCode(createUnsecuredTaskanaEngineConfiguration).doesNotThrowAnyException();\n+\n+    assertThat(retrieveSecurityFlag()).isFalse();\n+\n+  }\n+\n+  private Boolean retrieveSecurityFlag() throws SQLException {", "originalCommit": "ebd22c3fb7858a801929a136dbd40c003d51aee4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02f364e5100535c7ccaf33cdcf865bb4d4921a78", "chunk": "diff --git a/lib/taskana-core/src/test/java/acceptance/config/TaskanaSecurityConfigAccTest.java b/lib/taskana-core/src/test/java/acceptance/config/TaskanaSecurityConfigAccTest.java\nindex bf8ebbca9..257628507 100644\n--- a/lib/taskana-core/src/test/java/acceptance/config/TaskanaSecurityConfigAccTest.java\n+++ b/lib/taskana-core/src/test/java/acceptance/config/TaskanaSecurityConfigAccTest.java\n\n@@ -10,8 +10,7 @@ import java.sql.SQLException;\n import java.sql.Statement;\n import javax.sql.DataSource;\n import org.assertj.core.api.ThrowableAssert.ThrowingCallable;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n import pro.taskana.TaskanaEngineConfiguration;\n"}}, {"oid": "02f364e5100535c7ccaf33cdcf865bb4d4921a78", "url": "https://github.com/Taskana/taskana/commit/02f364e5100535c7ccaf33cdcf865bb4d4921a78", "message": "Insert initial securityEnabled value from first TaskanaEngine into database also when it's true", "committedDate": "2020-05-15T09:18:52Z", "type": "commit"}]}