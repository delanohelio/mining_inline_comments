{"pr_number": 1866, "pr_title": "Fix coop replay parsing", "pr_createdAt": "2020-08-22T12:48:59Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/1866", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyODkwNQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475228905", "bodyText": "Use the KnowFeaturedMod Enum", "author": "1-alex98", "createdAt": "2020-08-23T14:52:46Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -513,14 +513,14 @@ private void runFafReplayFile(Path path) throws IOException {\n \n     // For some reason in the coop replay the map name is null in the metadata\n     // So we just take it directly from the replay data.\n-    if (StringUtils.isEmptyOrNull(mapName)) {\n+    if (gameType.equals(\"coop\")) {", "originalCommit": "9eac943200932726d6a555f59b9359448dfbe969", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "810aca401dbcb18181bd812b67636e6981ce68ac", "chunk": "diff --git a/src/main/java/com/faforever/client/replay/ReplayService.java b/src/main/java/com/faforever/client/replay/ReplayService.java\nindex 18ec202ac..1b3fefad9 100644\n--- a/src/main/java/com/faforever/client/replay/ReplayService.java\n+++ b/src/main/java/com/faforever/client/replay/ReplayService.java\n\n@@ -509,22 +508,7 @@ public class ReplayService {\n     String gameType = replayInfo.getFeaturedMod();\n     Integer replayId = replayInfo.getUid();\n     Map<String, Integer> modVersions = replayInfo.getFeaturedModVersions();\n-    String mapName = replayInfo.getMapname();\n-\n-    // For some reason in the coop replay the map name is null in the metadata\n-    // So we just take it directly from the replay data.\n-    if (gameType.equals(\"coop\")) {\n-      mapName = parseMapFolderName(rawReplayBytes);\n-    }\n-\n-    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n-    // from replay data, and DB does not contain generated maps.\n-    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n-      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n-      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n-        mapName = maybeMapGen;\n-      }\n-    }\n+    String mapName = parseMapFolderName(rawReplayBytes);\n \n     Set<String> simMods = replayInfo.getSimMods() != null ? replayInfo.getSimMods().keySet() : emptySet();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475229007", "bodyText": "Could we maybe test this method with a real replay :D Then we would solve this issue forever", "author": "1-alex98", "createdAt": "2020-08-23T14:53:59Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -513,14 +513,14 @@ private void runFafReplayFile(Path path) throws IOException {\n \n     // For some reason in the coop replay the map name is null in the metadata", "originalCommit": "9eac943200932726d6a555f59b9359448dfbe969", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMjI4NQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475232285", "bodyText": "Do you mean just get the map name from the replay data for all maps?", "author": "Sheikah45", "createdAt": "2020-08-23T15:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzNjQyMw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475236423", "bodyText": "I made a change assuming that is what you meant", "author": "Sheikah45", "createdAt": "2020-08-23T16:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0Mjk3Ng==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475242976", "bodyText": "seems to work", "author": "Sheikah45", "createdAt": "2020-08-23T17:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI2MzgyNg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475263826", "bodyText": "Was absolutely not what I meant XD I meant write a unit test", "author": "1-alex98", "createdAt": "2020-08-23T20:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI2MzkwMw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475263903", "bodyText": "Concerning what u did I don't know if that's a good idea. No idea what pros and cons are too that", "author": "1-alex98", "createdAt": "2020-08-23T20:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI2NDA2OQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475264069", "bodyText": "Maybe @micheljung @Wesmania know what pros and cons are about reading the map from the replay file or the replayInfo stored in the databse.", "author": "1-alex98", "createdAt": "2020-08-23T20:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI2NjkwNg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475266906", "bodyText": "It's the right thing to do for randomized maps, since these will never be stored in the DB. The coop map issue is here: FAForever/server#372\nI don't know which is right for all the rest tbh.", "author": "Wesmania", "createdAt": "2020-08-23T21:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI2OTEwOA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r475269108", "bodyText": "I tested it and it worked for maps in the vault as well. I think an issue would arise if for some reason the map in the lua header was different than the vault or if the map table structure is intended to be changed. Also I believe the replayinfo that is being read here is stored in the replay file as well just it is the part in the faf header vs the lua header.", "author": "Sheikah45", "createdAt": "2020-08-23T21:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NjIzMA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1866#discussion_r476356230", "bodyText": "Hmm well I mean if it works better let's do it this way right.", "author": "1-alex98", "createdAt": "2020-08-25T10:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIyOTAwNw=="}], "type": "inlineReview", "revised_code": {"commit": "810aca401dbcb18181bd812b67636e6981ce68ac", "chunk": "diff --git a/src/main/java/com/faforever/client/replay/ReplayService.java b/src/main/java/com/faforever/client/replay/ReplayService.java\nindex 18ec202ac..1b3fefad9 100644\n--- a/src/main/java/com/faforever/client/replay/ReplayService.java\n+++ b/src/main/java/com/faforever/client/replay/ReplayService.java\n\n@@ -509,22 +508,7 @@ public class ReplayService {\n     String gameType = replayInfo.getFeaturedMod();\n     Integer replayId = replayInfo.getUid();\n     Map<String, Integer> modVersions = replayInfo.getFeaturedModVersions();\n-    String mapName = replayInfo.getMapname();\n-\n-    // For some reason in the coop replay the map name is null in the metadata\n-    // So we just take it directly from the replay data.\n-    if (gameType.equals(\"coop\")) {\n-      mapName = parseMapFolderName(rawReplayBytes);\n-    }\n-\n-    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n-    // from replay data, and DB does not contain generated maps.\n-    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n-      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n-      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n-        mapName = maybeMapGen;\n-      }\n-    }\n+    String mapName = parseMapFolderName(rawReplayBytes);\n \n     Set<String> simMods = replayInfo.getSimMods() != null ? replayInfo.getSimMods().keySet() : emptySet();\n \n"}}, {"oid": "461cd48e68c3ebaf8928d241ce62acc40c494636", "url": "https://github.com/FAForever/downlords-faf-client/commit/461cd48e68c3ebaf8928d241ce62acc40c494636", "message": "Fix coop replay parsing\n\nReads in mapName from replay bytes if game type is coop.\nUpdates FAF to correct version for replay.", "committedDate": "2020-08-28T11:31:00Z", "type": "commit"}, {"oid": "810aca401dbcb18181bd812b67636e6981ce68ac", "url": "https://github.com/FAForever/downlords-faf-client/commit/810aca401dbcb18181bd812b67636e6981ce68ac", "message": "Parse replay bytes for map name for all replays", "committedDate": "2020-08-28T11:31:02Z", "type": "commit"}, {"oid": "810aca401dbcb18181bd812b67636e6981ce68ac", "url": "https://github.com/FAForever/downlords-faf-client/commit/810aca401dbcb18181bd812b67636e6981ce68ac", "message": "Parse replay bytes for map name for all replays", "committedDate": "2020-08-28T11:31:02Z", "type": "forcePushed"}]}