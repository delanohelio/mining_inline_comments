{"pr_number": 1882, "pr_title": "Add in check for local preview for generated maps ", "pr_createdAt": "2020-09-03T12:07:01Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/1882", "timeline": [{"oid": "ab37bb0a28bebf0cd2169edb31483da1fd656a32", "url": "https://github.com/FAForever/downlords-faf-client/commit/ab37bb0a28bebf0cd2169edb31483da1fd656a32", "message": "Add in check for local preview for generated maps", "committedDate": "2020-09-03T12:09:36Z", "type": "commit"}, {"oid": "ab37bb0a28bebf0cd2169edb31483da1fd656a32", "url": "https://github.com/FAForever/downlords-faf-client/commit/ab37bb0a28bebf0cd2169edb31483da1fd656a32", "message": "Add in check for local preview for generated maps", "committedDate": "2020-09-03T12:09:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNTI3Nw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r483805277", "bodyText": "Just that you know I think having the random icon was a feature and was not done because guys that wrote it did not know how to fetch the preview...\nBut since you are the maintainer of map gen I leave it to u, just think about it that maybe having the mystery about how the map looks until you join might be interesting.", "author": "1-alex98", "createdAt": "2020-09-04T19:17:48Z", "path": "src/main/java/com/faforever/client/map/MapService.java", "diffHunk": "@@ -303,7 +306,12 @@ public MapBean readMap(Path mapFolder) throws MapLoadException {\n   @Cacheable(value = CacheNames.MAP_PREVIEW, unless = \"#result == null\")\n   public Image loadPreview(String mapName, PreviewSize previewSize) {", "originalCommit": "ab37bb0a28bebf0cd2169edb31483da1fd656a32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgxMTE3MQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r483811171", "bodyText": "yeah I was just considering whether it should show the preview since we also added the options but am honestly not sure about this yet just implemented to see. This also will only get it for the host before they create the game", "author": "Sheikah45", "createdAt": "2020-09-04T19:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNTI3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f259599994f49d090b2a192eac6aa09999a0f47c", "chunk": "diff --git a/src/main/java/com/faforever/client/map/MapService.java b/src/main/java/com/faforever/client/map/MapService.java\nindex c723062a..20a3a5ee 100644\n--- a/src/main/java/com/faforever/client/map/MapService.java\n+++ b/src/main/java/com/faforever/client/map/MapService.java\n\n@@ -307,8 +305,7 @@ public class MapService implements InitializingBean, DisposableBean {\n   public Image loadPreview(String mapName, PreviewSize previewSize) {\n     if (mapGeneratorService.isGeneratedMap(mapName)) {\n       try {\n-        BufferedImage image = ImageIO.read(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile());\n-        return SwingFXUtils.toFXImage(image, null);\n+        return new Image(new FileInputStream(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile()));\n       } catch (IOException e) {\n         return mapGeneratorService.getGeneratedMapPreviewImage();\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNTc5NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r483805794", "bodyText": "Why do we have an AWT image only to convert it to an java fx image later, makes little sense to me pls try do this the java fx way...", "author": "1-alex98", "createdAt": "2020-09-04T19:19:06Z", "path": "src/main/java/com/faforever/client/map/MapService.java", "diffHunk": "@@ -303,7 +306,12 @@ public MapBean readMap(Path mapFolder) throws MapLoadException {\n   @Cacheable(value = CacheNames.MAP_PREVIEW, unless = \"#result == null\")\n   public Image loadPreview(String mapName, PreviewSize previewSize) {\n     if (mapGeneratorService.isGeneratedMap(mapName)) {\n-      return mapGeneratorService.getGeneratedMapPreviewImage();\n+      try {\n+        BufferedImage image = ImageIO.read(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile());", "originalCommit": "ab37bb0a28bebf0cd2169edb31483da1fd656a32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgxMDcxMA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r483810710", "bodyText": "yeah i was just lazy and didnt change the import settings but will do so", "author": "Sheikah45", "createdAt": "2020-09-04T19:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNTc5NA=="}], "type": "inlineReview", "revised_code": {"commit": "f259599994f49d090b2a192eac6aa09999a0f47c", "chunk": "diff --git a/src/main/java/com/faforever/client/map/MapService.java b/src/main/java/com/faforever/client/map/MapService.java\nindex c723062a..20a3a5ee 100644\n--- a/src/main/java/com/faforever/client/map/MapService.java\n+++ b/src/main/java/com/faforever/client/map/MapService.java\n\n@@ -307,8 +305,7 @@ public class MapService implements InitializingBean, DisposableBean {\n   public Image loadPreview(String mapName, PreviewSize previewSize) {\n     if (mapGeneratorService.isGeneratedMap(mapName)) {\n       try {\n-        BufferedImage image = ImageIO.read(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile());\n-        return SwingFXUtils.toFXImage(image, null);\n+        return new Image(new FileInputStream(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile()));\n       } catch (IOException e) {\n         return mapGeneratorService.getGeneratedMapPreviewImage();\n       }\n"}}, {"oid": "f259599994f49d090b2a192eac6aa09999a0f47c", "url": "https://github.com/FAForever/downlords-faf-client/commit/f259599994f49d090b2a192eac6aa09999a0f47c", "message": "Use javafx image initially", "committedDate": "2020-09-09T21:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE1MDMyOQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r486150329", "bodyText": "Can u not do new Image(....getURL())", "author": "1-alex98", "createdAt": "2020-09-10T08:13:29Z", "path": "src/main/java/com/faforever/client/map/MapService.java", "diffHunk": "@@ -303,7 +304,11 @@ public MapBean readMap(Path mapFolder) throws MapLoadException {\n   @Cacheable(value = CacheNames.MAP_PREVIEW, unless = \"#result == null\")\n   public Image loadPreview(String mapName, PreviewSize previewSize) {\n     if (mapGeneratorService.isGeneratedMap(mapName)) {\n-      return mapGeneratorService.getGeneratedMapPreviewImage();\n+      try {\n+        return new Image(new FileInputStream(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile()));", "originalCommit": "f259599994f49d090b2a192eac6aa09999a0f47c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI1MzcwMA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r486253700", "bodyText": "There is no url for this image as this is getting the image generated on the local filesystem", "author": "Sheikah45", "createdAt": "2020-09-10T11:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE1MDMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0ODA2MA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1882#discussion_r486648060", "bodyText": "Hard to read. My proposal:\nPath previewPath = forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\");\nreturn new Image(Files.newInputStream(previewPath));\n\nI'm also not totally sure when the exception would be thrown? If the file does not exist yet? That shouldn't be catched via try-catch but with Files.exists(previewPath) instead (-> never use Exceptions for control flow).\nIf it's used for anything else, please add a comment.", "author": "Brutus5000", "createdAt": "2020-09-10T21:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE1MDMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c8c456ab7f7eb4c525c59cb0afce06be2d0dbd0f", "chunk": "diff --git a/src/main/java/com/faforever/client/map/MapService.java b/src/main/java/com/faforever/client/map/MapService.java\nindex 20a3a5ee..6fc3b26e 100644\n--- a/src/main/java/com/faforever/client/map/MapService.java\n+++ b/src/main/java/com/faforever/client/map/MapService.java\n\n@@ -300,17 +300,18 @@ public class MapService implements InitializingBean, DisposableBean {\n     }\n   }\n \n+  @SneakyThrows(IOException.class)\n   @NotNull\n   @Cacheable(value = CacheNames.MAP_PREVIEW, unless = \"#result == null\")\n   public Image loadPreview(String mapName, PreviewSize previewSize) {\n     if (mapGeneratorService.isGeneratedMap(mapName)) {\n-      try {\n-        return new Image(new FileInputStream(forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\").toFile()));\n-      } catch (IOException e) {\n+      Path previewPath = forgedAlliancePreferences.getCustomMapsDirectory().resolve(mapName).resolve(mapName + \"_preview.png\");\n+      if (Files.exists(previewPath)) {\n+        return new Image(Files.newInputStream(previewPath));\n+      } else {\n         return mapGeneratorService.getGeneratedMapPreviewImage();\n       }\n     }\n-\n     return loadPreview(getPreviewUrl(mapName, mapPreviewUrlFormat, previewSize), previewSize);\n   }\n \n"}}, {"oid": "c8c456ab7f7eb4c525c59cb0afce06be2d0dbd0f", "url": "https://github.com/FAForever/downlords-faf-client/commit/c8c456ab7f7eb4c525c59cb0afce06be2d0dbd0f", "message": "Improve readability", "committedDate": "2020-09-10T22:41:10Z", "type": "commit"}, {"oid": "c8c456ab7f7eb4c525c59cb0afce06be2d0dbd0f", "url": "https://github.com/FAForever/downlords-faf-client/commit/c8c456ab7f7eb4c525c59cb0afce06be2d0dbd0f", "message": "Improve readability", "committedDate": "2020-09-10T22:41:10Z", "type": "forcePushed"}]}