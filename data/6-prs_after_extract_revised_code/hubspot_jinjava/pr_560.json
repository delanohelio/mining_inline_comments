{"pr_number": 560, "pr_title": "Implement EagerFromTag and EagerImportTag", "pr_createdAt": "2020-12-07T18:14:56Z", "pr_url": "https://github.com/HubSpot/jinjava/pull/560", "timeline": [{"oid": "e6f8a38400b8a1abebcd818fdc2c9ada6a8a57a5", "url": "https://github.com/HubSpot/jinjava/commit/e6f8a38400b8a1abebcd818fdc2c9ada6a8a57a5", "message": "Checkout EagerFromTag and EagerImportTag logic and enable more tests", "committedDate": "2020-12-03T21:53:27Z", "type": "commit"}, {"oid": "1f0fe2fd8d58fd928d7ebc5004f97b10be1b1f61", "url": "https://github.com/HubSpot/jinjava/commit/1f0fe2fd8d58fd928d7ebc5004f97b10be1b1f61", "message": "Fix deferred and non-deferred import var logic", "committedDate": "2020-12-03T21:53:27Z", "type": "commit"}, {"oid": "bfbf1e00c15acc1aa6c55ac5109dde63870ddec2", "url": "https://github.com/HubSpot/jinjava/commit/bfbf1e00c15acc1aa6c55ac5109dde63870ddec2", "message": "Fix import logic for multi-layer imports", "committedDate": "2020-12-03T21:53:27Z", "type": "commit"}, {"oid": "f5f3961431bf30eaf9f52e4e5d1489d16bef5fcc", "url": "https://github.com/HubSpot/jinjava/commit/f5f3961431bf30eaf9f52e4e5d1489d16bef5fcc", "message": "Fixing multi layer imports", "committedDate": "2020-12-04T20:24:31Z", "type": "commit"}, {"oid": "dbc39765088351fafc6b028b80b29446ba8ccada", "url": "https://github.com/HubSpot/jinjava/commit/dbc39765088351fafc6b028b80b29446ba8ccada", "message": "Get all tests passing", "committedDate": "2020-12-04T20:52:40Z", "type": "commit"}, {"oid": "181387573ea6d997728dabcc833fec0252fd10c0", "url": "https://github.com/HubSpot/jinjava/commit/181387573ea6d997728dabcc833fec0252fd10c0", "message": "Cleanup import changes", "committedDate": "2020-12-04T21:26:37Z", "type": "commit"}, {"oid": "c405b785ac0a1b54c64c12da80f68b8920f1edf9", "url": "https://github.com/HubSpot/jinjava/commit/c405b785ac0a1b54c64c12da80f68b8920f1edf9", "message": "Handle imports, but naming collisions aren't perfect", "committedDate": "2020-12-04T23:39:18Z", "type": "commit"}, {"oid": "d54d2dc7a639830a839c6f68072581bb35af12f5", "url": "https://github.com/HubSpot/jinjava/commit/d54d2dc7a639830a839c6f68072581bb35af12f5", "message": "Fix build", "committedDate": "2020-12-04T23:46:26Z", "type": "commit"}, {"oid": "5b669175117707e1d2a6ee16d1b590a1462faaf1", "url": "https://github.com/HubSpot/jinjava/commit/5b669175117707e1d2a6ee16d1b590a1462faaf1", "message": "Remove unused method", "committedDate": "2020-12-04T23:47:20Z", "type": "commit"}, {"oid": "94c7dc53faca8597b52f8dd3d2c884eb2f3a4d03", "url": "https://github.com/HubSpot/jinjava/commit/94c7dc53faca8597b52f8dd3d2c884eb2f3a4d03", "message": "Clean up some methods", "committedDate": "2020-12-07T15:15:18Z", "type": "commit"}, {"oid": "6e05d2385b384f1a909988ebd6b588a37bc8b477", "url": "https://github.com/HubSpot/jinjava/commit/6e05d2385b384f1a909988ebd6b588a37bc8b477", "message": "Simplify set tag logic in import", "committedDate": "2020-12-07T17:34:00Z", "type": "commit"}, {"oid": "92f7f742e6d1170a3c8135acae8f15f698d9b96e", "url": "https://github.com/HubSpot/jinjava/commit/92f7f742e6d1170a3c8135acae8f15f698d9b96e", "message": "Merge branch 'master' of github.com:HubSpot/jinjava into eager-from-import-a", "committedDate": "2020-12-10T17:32:30Z", "type": "commit"}, {"oid": "a8ab1fbf000b9264019eccf7ce4093ea6ccf246e", "url": "https://github.com/HubSpot/jinjava/commit/a8ab1fbf000b9264019eccf7ce4093ea6ccf246e", "message": "Fix after merge", "committedDate": "2020-12-10T17:34:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4Mzk2MQ==", "url": "https://github.com/HubSpot/jinjava/pull/560#discussion_r545283961", "bodyText": "Maybe this should be in the Util?", "author": "Joeoh", "createdAt": "2020-12-17T17:50:10Z", "path": "src/main/java/com/hubspot/jinjava/lib/tag/SetTag.java", "diffHunk": "@@ -108,32 +108,37 @@ public String interpret(TagNode tagNode, JinjavaInterpreter interpreter) {\n     String[] varTokens = var.split(\",\");\n \n     try {\n-      executeSet((TagToken) tagNode.getMaster(), interpreter, varTokens, expr);\n+      executeSet((TagToken) tagNode.getMaster(), interpreter, varTokens, expr, false);\n     } catch (DeferredValueException e) {\n-      for (String varToken : varTokens) {\n-        String key = varToken.trim();\n-        Object originalValue = interpreter.getContext().get(key);\n-        if (originalValue != null) {\n-          if (originalValue instanceof DeferredValue) {\n-            interpreter.getContext().put(key, originalValue);\n-          } else {\n-            interpreter.getContext().put(key, DeferredValue.instance(originalValue));\n-          }\n-        } else {\n-          interpreter.getContext().put(key, DeferredValue.instance());\n-        }\n-      }\n+      deferVariables(varTokens, interpreter);\n       throw e;\n     }\n \n     return \"\";\n   }\n \n+  public static void deferVariables(String[] varTokens, JinjavaInterpreter interpreter) {", "originalCommit": "a8ab1fbf000b9264019eccf7ce4093ea6ccf246e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e81a41a1057e4a100ac018f5986cf313042e4544", "chunk": "diff --git a/src/main/java/com/hubspot/jinjava/lib/tag/SetTag.java b/src/main/java/com/hubspot/jinjava/lib/tag/SetTag.java\nindex da3ec7fa..1e7891fe 100644\n--- a/src/main/java/com/hubspot/jinjava/lib/tag/SetTag.java\n+++ b/src/main/java/com/hubspot/jinjava/lib/tag/SetTag.java\n\n@@ -110,29 +111,13 @@ public class SetTag implements Tag {\n     try {\n       executeSet((TagToken) tagNode.getMaster(), interpreter, varTokens, expr, false);\n     } catch (DeferredValueException e) {\n-      deferVariables(varTokens, interpreter);\n+      DeferredValueUtils.deferVariables(varTokens, interpreter.getContext());\n       throw e;\n     }\n \n     return \"\";\n   }\n \n-  public static void deferVariables(String[] varTokens, JinjavaInterpreter interpreter) {\n-    for (String varToken : varTokens) {\n-      String key = varToken.trim();\n-      Object originalValue = interpreter.getContext().get(key);\n-      if (originalValue != null) {\n-        if (originalValue instanceof DeferredValue) {\n-          interpreter.getContext().put(key, originalValue);\n-        } else {\n-          interpreter.getContext().put(key, DeferredValue.instance(originalValue));\n-        }\n-      } else {\n-        interpreter.getContext().put(key, DeferredValue.instance());\n-      }\n-    }\n-  }\n-\n   public void executeSet(\n     TagToken tagToken,\n     JinjavaInterpreter interpreter,\n"}}, {"oid": "e81a41a1057e4a100ac018f5986cf313042e4544", "url": "https://github.com/HubSpot/jinjava/commit/e81a41a1057e4a100ac018f5986cf313042e4544", "message": "Move deferVariables method to DeferredValueUtils", "committedDate": "2020-12-17T18:40:36Z", "type": "commit"}, {"oid": "e0aa12d2660a42eb63172eb68a156fc54e3bfecb", "url": "https://github.com/HubSpot/jinjava/commit/e0aa12d2660a42eb63172eb68a156fc54e3bfecb", "message": "Merge branch 'master' of github.com:HubSpot/jinjava into eager-from-import-a", "committedDate": "2020-12-17T18:40:49Z", "type": "commit"}]}