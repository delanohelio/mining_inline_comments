{"pr_number": 463, "pr_title": "log error on parent loop", "pr_createdAt": "2020-07-09T18:05:55Z", "pr_url": "https://github.com/HubSpot/jinjava/pull/463", "timeline": [{"oid": "a87d06bdcf89d9a4bc53f8d8a74c85acd2f792fe", "url": "https://github.com/HubSpot/jinjava/commit/a87d06bdcf89d9a4bc53f8d8a74c85acd2f792fe", "message": "log error on parent loop", "committedDate": "2020-07-09T18:04:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDY5NQ==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r452430695", "bodyText": "I think you only need to check new parent against the existing parents, right? If we're running this every time a new ScopeMap is created, it will get them all.", "author": "boulter", "createdAt": "2020-07-09T19:06:55Z", "path": "src/main/java/com/hubspot/jinjava/util/ScopeMap.java", "diffHunk": "@@ -19,6 +25,23 @@ public ScopeMap() {\n   public ScopeMap(ScopeMap<K, V> parent) {\n     this.scope = new HashMap<K, V>();\n     this.parent = parent;\n+\n+    Set<ScopeMap<K, V>> parents = new HashSet<>();", "originalCommit": "a87d06bdcf89d9a4bc53f8d8a74c85acd2f792fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzMjcwNw==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r452832707", "bodyText": "So are you suggesting storing all the parents in a Set on the ScopeMap? Either way we have to run up the parent tree in the constructor.", "author": "kacperadach", "createdAt": "2020-07-10T13:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk0ODc2MA==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r452948760", "bodyText": "yeah, I was thinking just run up the whole parent tree in the constructor. I think that will take a trivial amount of time.", "author": "boulter", "createdAt": "2020-07-10T16:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMjMwNA==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r453722304", "bodyText": "Should I add a config to enable/disable this check?", "author": "kacperadach", "createdAt": "2020-07-13T15:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczMDU5Nw==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r453730597", "bodyText": "I can't think of a reason why you'd want to turn it off.", "author": "boulter", "createdAt": "2020-07-13T15:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDY5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "13ff418d24cc3a19690dc1aef3f5aa0648866b83", "chunk": "diff --git a/src/main/java/com/hubspot/jinjava/util/ScopeMap.java b/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\nindex 35866c35..1ab81169 100644\n--- a/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\n+++ b/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\n\n@@ -25,12 +27,13 @@ public class ScopeMap<K, V> implements Map<K, V> {\n   public ScopeMap(ScopeMap<K, V> parent) {\n     this.scope = new HashMap<K, V>();\n     this.parent = parent;\n+    this.parents =\n \n     Set<ScopeMap<K, V>> parents = new HashSet<>();\n     ScopeMap<K, V> p = parent;\n     while (p != null) {\n       if (parents.contains(p)) {\n-        LOG.error(\n+        ENGINE_LOG.error(\n           \"Parent loop detected:\\n{}\",\n           Arrays\n             .stream(Thread.currentThread().getStackTrace())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1ODQxMA==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r452858410", "bodyText": "I see we use ENGINE_LOG everywhere else in jinjava, should we keep using that?", "author": "hs-lsong", "createdAt": "2020-07-10T13:54:12Z", "path": "src/main/java/com/hubspot/jinjava/util/ScopeMap.java", "diffHunk": "@@ -2,13 +2,19 @@\n \n import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.Collection;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class ScopeMap<K, V> implements Map<K, V> {\n+  private static final Logger LOG = LoggerFactory.getLogger(ScopeMap.class);", "originalCommit": "a87d06bdcf89d9a4bc53f8d8a74c85acd2f792fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg3MjEzMw==", "url": "https://github.com/HubSpot/jinjava/pull/463#discussion_r452872133", "bodyText": "Good call", "author": "kacperadach", "createdAt": "2020-07-10T14:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1ODQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "13ff418d24cc3a19690dc1aef3f5aa0648866b83", "chunk": "diff --git a/src/main/java/com/hubspot/jinjava/util/ScopeMap.java b/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\nindex 35866c35..1ab81169 100644\n--- a/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\n+++ b/src/main/java/com/hubspot/jinjava/util/ScopeMap.java\n\n@@ -1,5 +1,7 @@\n package com.hubspot.jinjava.util;\n \n+import static com.hubspot.jinjava.util.Logging.ENGINE_LOG;\n+\n import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n import java.util.ArrayList;\n import java.util.Arrays;\n"}}, {"oid": "13ff418d24cc3a19690dc1aef3f5aa0648866b83", "url": "https://github.com/HubSpot/jinjava/commit/13ff418d24cc3a19690dc1aef3f5aa0648866b83", "message": "use ENGINE_LOG", "committedDate": "2020-07-10T14:17:52Z", "type": "commit"}, {"oid": "8fa8809eb77fae2c0ff7a51e6cd3b8ecf20a82ed", "url": "https://github.com/HubSpot/jinjava/commit/8fa8809eb77fae2c0ff7a51e6cd3b8ecf20a82ed", "message": "only check if current parent is in parent tree", "committedDate": "2020-07-13T14:24:53Z", "type": "commit"}]}