{"pr_number": 558, "pr_title": "Implement EagerPrintTag and EagerDoTag", "pr_createdAt": "2020-12-01T21:57:17Z", "pr_url": "https://github.com/HubSpot/jinjava/pull/558", "timeline": [{"oid": "421ef4ba0c189d8dd1e712afb47a9b899aafa722", "url": "https://github.com/HubSpot/jinjava/commit/421ef4ba0c189d8dd1e712afb47a9b899aafa722", "message": "Checkout eager do and print tags", "committedDate": "2020-11-30T22:29:39Z", "type": "commit"}, {"oid": "428f6a55b1df4ce9fb4fa6c8a1b4702e88bea12e", "url": "https://github.com/HubSpot/jinjava/commit/428f6a55b1df4ce9fb4fa6c8a1b4702e88bea12e", "message": "Add error if helpers are empty", "committedDate": "2020-11-30T22:29:39Z", "type": "commit"}, {"oid": "112f280880ac2c81bd78a422fc0f206e83a7d3a0", "url": "https://github.com/HubSpot/jinjava/commit/112f280880ac2c81bd78a422fc0f206e83a7d3a0", "message": "Enable raw wrap test", "committedDate": "2020-11-30T22:30:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1NjgyOQ==", "url": "https://github.com/HubSpot/jinjava/pull/558#discussion_r534256829", "bodyText": "just as a personal preference, if inputs and expected files are short enough, I would just put them right in the code here. It's way easier to read when you don't have to flip back and forth  between files.\nSomeday we'll get text blocks.", "author": "boulter", "createdAt": "2020-12-02T15:28:28Z", "path": "src/test/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTagTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import com.hubspot.jinjava.ExpectedNodeInterpreter;\n+import com.hubspot.jinjava.JinjavaConfig;\n+import com.hubspot.jinjava.interpret.DeferredValue;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.lib.tag.DoTagTest;\n+import com.hubspot.jinjava.lib.tag.Tag;\n+import com.hubspot.jinjava.mode.EagerExecutionMode;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class EagerDoTagTest extends DoTagTest {\n+  private Tag tag;\n+  private ExpectedNodeInterpreter expectedNodeInterpreter;\n+\n+  @Before\n+  public void eagerSetup() {\n+    interpreter =\n+      new JinjavaInterpreter(\n+        jinjava,\n+        context,\n+        JinjavaConfig.newBuilder().withExecutionMode(new EagerExecutionMode()).build()\n+      );\n+\n+    tag = new EagerDoTag();\n+    context.registerTag(tag);\n+    context.put(\"deferred\", DeferredValue.instance());\n+    expectedNodeInterpreter =\n+      new ExpectedNodeInterpreter(interpreter, tag, \"tags/eager/dotag\");\n+    JinjavaInterpreter.pushCurrent(interpreter);\n+  }\n+\n+  @After\n+  public void teardown() {\n+    JinjavaInterpreter.popCurrent();\n+  }\n+\n+  @Test\n+  public void itHandlesDeferredDo() {\n+    context.put(\"foo\", 2);\n+    expectedNodeInterpreter.assertExpectedOutput(\"handles-deferred-do\");", "originalCommit": "112f280880ac2c81bd78a422fc0f206e83a7d3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMxNTM0Mw==", "url": "https://github.com/HubSpot/jinjava/pull/558#discussion_r534315343", "bodyText": "Okay, I'll make a note to clean up the one-liners, and text blocks would be perfect here if we get them", "author": "jasmith-hs", "createdAt": "2020-12-02T16:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1NjgyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "708ab9e04de1373baabbcd64e51edeccb63194d9", "chunk": "diff --git a/src/test/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTagTest.java b/src/test/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTagTest.java\nindex 0ca45d6b..b1807779 100644\n--- a/src/test/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTagTest.java\n+++ b/src/test/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTagTest.java\n\n@@ -6,6 +6,7 @@ import com.hubspot.jinjava.ExpectedNodeInterpreter;\n import com.hubspot.jinjava.JinjavaConfig;\n import com.hubspot.jinjava.interpret.DeferredValue;\n import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateError.ErrorReason;\n import com.hubspot.jinjava.lib.tag.DoTagTest;\n import com.hubspot.jinjava.lib.tag.Tag;\n import com.hubspot.jinjava.mode.EagerExecutionMode;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI3NTU1OQ==", "url": "https://github.com/HubSpot/jinjava/pull/558#discussion_r535275559", "bodyText": "Should be \"do\"", "author": "Joeoh", "createdAt": "2020-12-03T14:32:21Z", "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.DoTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import java.util.StringJoiner;\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class EagerDoTag extends EagerStateChangingTag<DoTag> {\n+\n+  public EagerDoTag() {\n+    super(new DoTag());\n+  }\n+\n+  public EagerDoTag(DoTag doTag) {\n+    super(doTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    String expr = tagToken.getHelpers();\n+    if (StringUtils.isBlank(expr)) {\n+      throw new TemplateSyntaxException(\n+        interpreter,\n+        tagToken.getImage(),\n+        \"Tag 'print' expects expression\"", "originalCommit": "112f280880ac2c81bd78a422fc0f206e83a7d3a0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c006c4386ecbc055b11bbff790115a7b5052a92b", "chunk": "diff --git a/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java b/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\nindex 98ad4dc1..34ad53bb 100644\n--- a/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\n+++ b/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\n\n@@ -4,8 +4,6 @@ import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n import com.hubspot.jinjava.lib.tag.DoTag;\n import com.hubspot.jinjava.tree.parse.TagToken;\n-import com.hubspot.jinjava.util.ChunkResolver;\n-import java.util.StringJoiner;\n import org.apache.commons.lang3.StringUtils;\n \n public class EagerDoTag extends EagerStateChangingTag<DoTag> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NDQ4Ng==", "url": "https://github.com/HubSpot/jinjava/pull/558#discussion_r535294486", "bodyText": "Looks like this logic is the same for both tags, and maybe others? Should we split it out into a function?", "author": "Joeoh", "createdAt": "2020-12-03T14:48:30Z", "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.DoTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import java.util.StringJoiner;\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class EagerDoTag extends EagerStateChangingTag<DoTag> {\n+\n+  public EagerDoTag() {\n+    super(new DoTag());\n+  }\n+\n+  public EagerDoTag(DoTag doTag) {\n+    super(doTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    String expr = tagToken.getHelpers();\n+    if (StringUtils.isBlank(expr)) {\n+      throw new TemplateSyntaxException(\n+        interpreter,\n+        tagToken.getImage(),\n+        \"Tag 'print' expects expression\"\n+      );\n+    }\n+    ChunkResolver chunkResolver = new ChunkResolver(expr, tagToken, interpreter);\n+    EagerStringResult resolvedExpression = executeInChildContext(\n+      eagerInterpreter -> chunkResolver.resolveChunks(),\n+      interpreter,\n+      true\n+    );\n+    StringJoiner joiner = new StringJoiner(\" \");", "originalCommit": "112f280880ac2c81bd78a422fc0f206e83a7d3a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyNTc3Mw==", "url": "https://github.com/HubSpot/jinjava/pull/558#discussion_r535525773", "bodyText": "Yes, that is a good call.", "author": "jasmith-hs", "createdAt": "2020-12-03T19:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5NDQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c006c4386ecbc055b11bbff790115a7b5052a92b", "chunk": "diff --git a/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java b/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\nindex 98ad4dc1..34ad53bb 100644\n--- a/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\n+++ b/src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerDoTag.java\n\n@@ -4,8 +4,6 @@ import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n import com.hubspot.jinjava.lib.tag.DoTag;\n import com.hubspot.jinjava.tree.parse.TagToken;\n-import com.hubspot.jinjava.util.ChunkResolver;\n-import java.util.StringJoiner;\n import org.apache.commons.lang3.StringUtils;\n \n public class EagerDoTag extends EagerStateChangingTag<DoTag> {\n"}}, {"oid": "c006c4386ecbc055b11bbff790115a7b5052a92b", "url": "https://github.com/HubSpot/jinjava/commit/c006c4386ecbc055b11bbff790115a7b5052a92b", "message": "Refactor shared logic into its own function", "committedDate": "2020-12-03T19:31:58Z", "type": "commit"}, {"oid": "ca1bedfdf583923624729b0fcb1a84ce85dc95e4", "url": "https://github.com/HubSpot/jinjava/commit/ca1bedfdf583923624729b0fcb1a84ce85dc95e4", "message": "Merge branch 'eager-set' of github.com:HubSpot/jinjava into eager-print-do", "committedDate": "2020-12-03T19:43:18Z", "type": "commit"}, {"oid": "c8fcdfdcd44d14f2f69e21b4c8a17c1d35c9e275", "url": "https://github.com/HubSpot/jinjava/commit/c8fcdfdcd44d14f2f69e21b4c8a17c1d35c9e275", "message": "Merge branch 'eager-set' of github.com:HubSpot/jinjava into eager-print-do", "committedDate": "2020-12-03T19:46:13Z", "type": "commit"}, {"oid": "708ab9e04de1373baabbcd64e51edeccb63194d9", "url": "https://github.com/HubSpot/jinjava/commit/708ab9e04de1373baabbcd64e51edeccb63194d9", "message": "Add length limited string joiner for print/do", "committedDate": "2020-12-03T19:46:44Z", "type": "commit"}, {"oid": "d245323fb41823cb3cd6d3fb79e090f824715086", "url": "https://github.com/HubSpot/jinjava/commit/d245323fb41823cb3cd6d3fb79e090f824715086", "message": "Remove unused import", "committedDate": "2020-12-03T20:10:05Z", "type": "commit"}, {"oid": "5310a84f4b888714ca71577ee93569e30a420939", "url": "https://github.com/HubSpot/jinjava/commit/5310a84f4b888714ca71577ee93569e30a420939", "message": "Merge branch 'eager-set' of github.com:HubSpot/jinjava into eager-print-do", "committedDate": "2020-12-03T21:52:49Z", "type": "commit"}, {"oid": "f65714a845f32252a2e4361bbd409f0aceb0e0e3", "url": "https://github.com/HubSpot/jinjava/commit/f65714a845f32252a2e4361bbd409f0aceb0e0e3", "message": "Merge branch 'master' of github.com:HubSpot/jinjava into eager-print-do", "committedDate": "2020-12-09T22:15:11Z", "type": "commit"}, {"oid": "15607afc47be30f1c8386bc5d1b4ee9721fe7d46", "url": "https://github.com/HubSpot/jinjava/commit/15607afc47be30f1c8386bc5d1b4ee9721fe7d46", "message": "Fix from merge and inline do tag tests", "committedDate": "2020-12-09T22:18:36Z", "type": "commit"}]}