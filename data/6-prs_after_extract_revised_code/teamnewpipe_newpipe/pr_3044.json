{"pr_number": 3044, "pr_title": "Description fix and some PeerTube fixes", "pr_createdAt": "2020-02-02T16:03:26Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/3044", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MDMxNw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376080317", "bodyText": "Maybe we can avoid the if conditions here by creating a description class in the extractor with fields content and type.\nprepareDescription(info.getDescription().getContent(), info.getDescription().getType());", "author": "yausername", "createdAt": "2020-02-06T21:03:06Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1126,7 +1142,20 @@ public void handleResult(@NonNull StreamInfo info) {\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n-        prepareDescription(info.getDescription());\n+        int serviceId = info.getServiceId();\n+\n+        if (serviceId != YOUTUBE_SERVICE_ID) {\n+            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n+        }\n+\n+        if (serviceId == PEERTUBE_SERVICE_ID) {", "originalCommit": "c95126f5458295d8a7ba05317a5d60b9950cc4b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MjM4OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376082389", "bodyText": "Sounds like a good solution", "author": "TobiGr", "createdAt": "2020-02-06T21:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MDMxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEwNTc2MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376105760", "bodyText": "Isn't it better for readability to make\nprepareDescription(info.getDescription()), with prepareDescription(Description description)?", "author": "B0pol", "createdAt": "2020-02-06T21:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MDMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\nindex a297cddf3..c6c8ca04c 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n\n@@ -1142,20 +1139,7 @@ public class VideoDetailFragment\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n-        int serviceId = info.getServiceId();\n-\n-        if (serviceId != YOUTUBE_SERVICE_ID) {\n-            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n-        }\n-\n-        if (serviceId == PEERTUBE_SERVICE_ID) {\n-            prepareDescription(info.getDescription(), DESCRIPTION_MARKDOWN);\n-        } else if (serviceId == MEDIACCC_SERVICE_ID) {\n-            prepareDescription(info.getDescription(), DESCRIPTION_PLAIN_TEXT);\n-        } else {\n-            prepareDescription(info.getDescription(), DESCRIPTION_HTML);\n-        }\n-\n+        prepareDescription(info.getDescription());\n         updateProgressInfo(info);\n \n         animateView(spinnerToolbar, true, 500);\n"}}, {"oid": "7045f9711c04a4a0610553f605c8c69a7fd4f21f", "url": "https://github.com/TeamNewPipe/NewPipe/commit/7045f9711c04a4a0610553f605c8c69a7fd4f21f", "message": "fix thumbnail for PeerTube, and description changes\n\ndescription:\n- PeerTube: it's now full description (it cut at 250 characters before), and it displays ok (newlines are ok, but markdown isn't)\n- MediaCCC: descriptions are now displayed well (newlines added)\n- YouTube: timestamps in descriptions are clickable and work\n\nmore PeerTube fixes:\nthumbnail is now high quality\nage limit is now handled\nupload date in \u00abrecently added\u00bb feed is good now (it was one hour delayed)\nall fixes come from https://github.com/TeamNewPipe/NewPipeExtractor/pull/239, so it need to be merged before this PR", "committedDate": "2020-02-06T21:42:09Z", "type": "commit"}, {"oid": "7045f9711c04a4a0610553f605c8c69a7fd4f21f", "url": "https://github.com/TeamNewPipe/NewPipe/commit/7045f9711c04a4a0610553f605c8c69a7fd4f21f", "message": "fix thumbnail for PeerTube, and description changes\n\ndescription:\n- PeerTube: it's now full description (it cut at 250 characters before), and it displays ok (newlines are ok, but markdown isn't)\n- MediaCCC: descriptions are now displayed well (newlines added)\n- YouTube: timestamps in descriptions are clickable and work\n\nmore PeerTube fixes:\nthumbnail is now high quality\nage limit is now handled\nupload date in \u00abrecently added\u00bb feed is good now (it was one hour delayed)\nall fixes come from https://github.com/TeamNewPipe/NewPipeExtractor/pull/239, so it need to be merged before this PR", "committedDate": "2020-02-06T21:42:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIzMzgzMQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376233831", "bodyText": "How about checking for non-html instead of non-youtube?\nAlso, it would be better to move this into prepareDescription", "author": "yausername", "createdAt": "2020-02-07T06:35:49Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1126,6 +1135,10 @@ public void handleResult(@NonNull StreamInfo info) {\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n+        if (info.getServiceId() != ServiceList.YouTube.getServiceId()) {", "originalCommit": "55837c11ba1dd4db6f13a18b70d0bb19bf01c98b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3ODM1Mg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376378352", "bodyText": "I thought about that but it was late in the evening. Thanks for the reminder", "author": "B0pol", "createdAt": "2020-02-07T13:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIzMzgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\nindex e44c6bf07..c6c8ca04c 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n\n@@ -1135,10 +1139,6 @@ public class VideoDetailFragment\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n-        if (info.getServiceId() != ServiceList.YouTube.getServiceId()) {\n-            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n-        }\n-\n         prepareDescription(info.getDescription());\n         updateProgressInfo(info);\n \n"}}, {"oid": "1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "url": "https://github.com/TeamNewPipe/NewPipe/commit/1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "message": "refactor Description", "committedDate": "2020-02-07T13:03:24Z", "type": "forcePushed"}, {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "url": "https://github.com/TeamNewPipe/NewPipe/commit/badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "message": "refactor Description", "committedDate": "2020-02-07T13:14:55Z", "type": "commit"}, {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "url": "https://github.com/TeamNewPipe/NewPipe/commit/badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "message": "refactor Description", "committedDate": "2020-02-07T13:14:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDcwNA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376694704", "bodyText": "Sorry for asking for so many changes but we would be better off not manipulating the string since it can be buggy.\nWe can add a markdown library to render later in a separate PR.", "author": "yausername", "createdAt": "2020-02-08T07:42:04Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -919,28 +917,43 @@ private VideoStream getSelectedVideoStream() {\n         return sortedVideoStreams != null ? sortedVideoStreams.get(selectedVideoStreamIndex) : null;\n     }\n \n-    private void prepareDescription(final String descriptionHtml) {\n-        if (TextUtils.isEmpty(descriptionHtml)) {\n+    private void prepareDescription(Description description) {\n+        if (TextUtils.isEmpty(description.getContent()) || description == Description.emptyDescription) {\n             return;\n         }\n \n-        disposables.add(Single.just(descriptionHtml)\n-                .map((@io.reactivex.annotations.NonNull String description) -> {\n-                    Spanned parsedDescription;\n-                    if (Build.VERSION.SDK_INT >= 24) {\n-                        parsedDescription = Html.fromHtml(description, 0);\n-                    } else {\n-                        //noinspection deprecation\n-                        parsedDescription = Html.fromHtml(description);\n-                    }\n-                    return parsedDescription;\n-                })\n-                .subscribeOn(Schedulers.computation())\n-                .observeOn(AndroidSchedulers.mainThread())\n-                .subscribe((@io.reactivex.annotations.NonNull Spanned spanned) -> {\n-                    videoDescriptionView.setText(spanned);\n-                    videoDescriptionView.setVisibility(View.VISIBLE);\n-                }));\n+        if (description.getType() != Description.HTML) {\n+            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n+        }\n+\n+        if (description.getType() == Description.HTML) {\n+            disposables.add(Single.just(description.getContent())\n+                    .map((@io.reactivex.annotations.NonNull String descriptionText) -> {\n+                        Spanned parsedDescription;\n+                        if (Build.VERSION.SDK_INT >= 24) {\n+                            parsedDescription = Html.fromHtml(descriptionText, 0);\n+                        } else {\n+                            //noinspection deprecation\n+                            parsedDescription = Html.fromHtml(descriptionText);\n+                        }\n+                        return parsedDescription;\n+                    })\n+                    .subscribeOn(Schedulers.computation())\n+                    .observeOn(AndroidSchedulers.mainThread())\n+                    .subscribe((@io.reactivex.annotations.NonNull Spanned spanned) -> {\n+                        videoDescriptionView.setText(spanned);\n+                        videoDescriptionView.setVisibility(View.VISIBLE);\n+                    }));\n+        } else if (description.getType() == Description.MARKDOWN) {\n+            //in the future we would use a library or a good method to show markdown.\n+            //rn, we just remove **bold**, and let PLAIN_TEXT otherwise\n+            videoDescriptionView.setText(description.getContent().replace(\"**\", \"\"), TextView.BufferType.SPANNABLE);", "originalCommit": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwMDI0OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376700249", "bodyText": "I added Markwon library, it works perfectly.", "author": "B0pol", "createdAt": "2020-02-08T09:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwMTQ5MQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376701491", "bodyText": "Awesome!", "author": "yausername", "createdAt": "2020-02-08T10:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDcwNA=="}], "type": "inlineReview", "revised_code": {"commit": "2d62fa401d63551785859b0d909f8414e94ba191", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\nindex c6c8ca04c..3c594bdfa 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java\n\n@@ -922,10 +924,6 @@ public class VideoDetailFragment\n             return;\n         }\n \n-        if (description.getType() != Description.HTML) {\n-            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n-        }\n-\n         if (description.getType() == Description.HTML) {\n             disposables.add(Single.just(description.getContent())\n                     .map((@io.reactivex.annotations.NonNull String descriptionText) -> {\n"}}, {"oid": "2d62fa401d63551785859b0d909f8414e94ba191", "url": "https://github.com/TeamNewPipe/NewPipe/commit/2d62fa401d63551785859b0d909f8414e94ba191", "message": "real markdown support for descriptions\n\nand update third-party licences in about page", "committedDate": "2020-02-08T09:48:36Z", "type": "commit"}, {"oid": "88c68315f64a879522497e694f98fd69786f785c", "url": "https://github.com/TeamNewPipe/NewPipe/commit/88c68315f64a879522497e694f98fd69786f785c", "message": "Merge branch 'dev' into tubepeer", "committedDate": "2020-02-08T09:54:05Z", "type": "commit"}, {"oid": "3f3d1bfccf9be4182bd2872358263d3c904e447a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3f3d1bfccf9be4182bd2872358263d3c904e447a", "message": "update extractor version", "committedDate": "2020-02-08T23:00:14Z", "type": "commit"}]}