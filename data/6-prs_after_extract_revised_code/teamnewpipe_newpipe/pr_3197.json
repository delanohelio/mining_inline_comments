{"pr_number": 3197, "pr_title": "Fix bug in main screen tabs state management", "pr_createdAt": "2020-03-08T01:24:26Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/3197", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODU0NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3197#discussion_r389348544", "bodyText": "Invert the condition in the if:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!hasTabsChanged) {\n          \n          \n            \n                        if (viewPager.getOffscreenPageLimit() != tabsList.size()) {\n          \n          \n            \n                            viewPager.setOffscreenPageLimit(tabsList.size());\n          \n          \n            \n                        }\n          \n          \n            \n                    } else {\n          \n          \n            \n                        setupTabs();\n          \n          \n            \n                    }\n          \n          \n            \n                    if (hasTabsChanged) {\n          \n          \n            \n                        setupTabs();\n          \n          \n            \n                    } else {\n          \n          \n            \n                        if (viewPager.getOffscreenPageLimit() != tabsList.size()) {\n          \n          \n            \n                            viewPager.setOffscreenPageLimit(tabsList.size());\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "author": "Stypox", "createdAt": "2020-03-08T08:45:44Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java", "diffHunk": "@@ -89,7 +89,13 @@ protected void initViews(View rootView, Bundle savedInstanceState) {\n     public void onResume() {\n         super.onResume();\n \n-        if (hasTabsChanged) setupTabs();\n+        if (!hasTabsChanged) {\n+            if (viewPager.getOffscreenPageLimit() != tabsList.size()) {\n+                viewPager.setOffscreenPageLimit(tabsList.size());\n+            }\n+        } else {\n+            setupTabs();\n+        }", "originalCommit": "ee5220c0ba2c742affbae05007928ea6d33657a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2526ed5a892b0e59d2c575437d7782000f1d664", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\nindex 00b91a5d3..e3dfb8982 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n\n@@ -89,13 +89,7 @@ public class MainFragment extends BaseFragment implements TabLayout.OnTabSelecte\n     public void onResume() {\n         super.onResume();\n \n-        if (!hasTabsChanged) {\n-            if (viewPager.getOffscreenPageLimit() != tabsList.size()) {\n-                viewPager.setOffscreenPageLimit(tabsList.size());\n-            }\n-        } else {\n-            setupTabs();\n-        }\n+        if (hasTabsChanged) setupTabs();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODcwNQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3197#discussion_r389348705", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (pagerAdapter == null || !pagerAdapter.sameTabs(tabsList)) {\n          \n          \n            \n                    if (wasAdapterNull || !pagerAdapter.sameTabs(tabsList)) {", "author": "Stypox", "createdAt": "2020-03-08T08:48:02Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java", "diffHunk": "@@ -136,16 +142,23 @@ public boolean onOptionsItemSelected(MenuItem item) {\n     // Tabs\n     //////////////////////////////////////////////////////////////////////////*/\n \n-    public void setupTabs() {\n+    private void setupTabs() {\n         tabsList.clear();\n         tabsList.addAll(tabsManager.getTabs());\n \n+        boolean wasAdapterNull = pagerAdapter == null;\n         if (pagerAdapter == null || !pagerAdapter.sameTabs(tabsList)) {", "originalCommit": "ee5220c0ba2c742affbae05007928ea6d33657a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2MzMwMw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3197#discussion_r389363303", "bodyText": "I think the name was confusing at first and I decided to keep things clear, however, later on I renamed to something more readable and indeed, it would be better to do this.", "author": "mauriciocolli", "createdAt": "2020-03-08T12:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODcwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2526ed5a892b0e59d2c575437d7782000f1d664", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\nindex 00b91a5d3..e3dfb8982 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n\n@@ -146,19 +140,13 @@ public class MainFragment extends BaseFragment implements TabLayout.OnTabSelecte\n         tabsList.clear();\n         tabsList.addAll(tabsManager.getTabs());\n \n-        boolean wasAdapterNull = pagerAdapter == null;\n         if (pagerAdapter == null || !pagerAdapter.sameTabs(tabsList)) {\n             pagerAdapter = new SelectedTabsPagerAdapter(requireContext(), getChildFragmentManager(), tabsList);\n         }\n-        // Clear previous tabs/fragments and set new adapter\n-        viewPager.setAdapter(pagerAdapter);\n \n-        // If the adapter was null, postpone setting the limit after the state is restored (onResume was chosen).\n-        // Otherwise, the view pager will create new fragments while the old ones still exist due to the way\n-        // the restore and this method were implemented.\n-        if (!wasAdapterNull) {\n-            viewPager.setOffscreenPageLimit(tabsList.size());\n-        }\n+        viewPager.setAdapter(null);\n+        viewPager.setOffscreenPageLimit(tabsList.size());\n+        viewPager.setAdapter(pagerAdapter);\n \n         updateTabsIconAndDescription();\n         updateTitleForTab(viewPager.getCurrentItem());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0OTY3Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3197#discussion_r389349677", "bodyText": "Couldn't this be put inside the if (!wasAdapterNull), too?", "author": "Stypox", "createdAt": "2020-03-08T09:02:17Z", "path": "app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java", "diffHunk": "@@ -136,16 +142,23 @@ public boolean onOptionsItemSelected(MenuItem item) {\n     // Tabs\n     //////////////////////////////////////////////////////////////////////////*/\n \n-    public void setupTabs() {\n+    private void setupTabs() {\n         tabsList.clear();\n         tabsList.addAll(tabsManager.getTabs());\n \n+        boolean wasAdapterNull = pagerAdapter == null;\n         if (pagerAdapter == null || !pagerAdapter.sameTabs(tabsList)) {\n             pagerAdapter = new SelectedTabsPagerAdapter(requireContext(), getChildFragmentManager(), tabsList);\n         }\n         // Clear previous tabs/fragments and set new adapter\n         viewPager.setAdapter(pagerAdapter);", "originalCommit": "ee5220c0ba2c742affbae05007928ea6d33657a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2526ed5a892b0e59d2c575437d7782000f1d664", "chunk": "diff --git a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\nindex 00b91a5d3..e3dfb8982 100644\n--- a/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n+++ b/app/src/main/java/org/schabi/newpipe/fragments/MainFragment.java\n\n@@ -146,19 +140,13 @@ public class MainFragment extends BaseFragment implements TabLayout.OnTabSelecte\n         tabsList.clear();\n         tabsList.addAll(tabsManager.getTabs());\n \n-        boolean wasAdapterNull = pagerAdapter == null;\n         if (pagerAdapter == null || !pagerAdapter.sameTabs(tabsList)) {\n             pagerAdapter = new SelectedTabsPagerAdapter(requireContext(), getChildFragmentManager(), tabsList);\n         }\n-        // Clear previous tabs/fragments and set new adapter\n-        viewPager.setAdapter(pagerAdapter);\n \n-        // If the adapter was null, postpone setting the limit after the state is restored (onResume was chosen).\n-        // Otherwise, the view pager will create new fragments while the old ones still exist due to the way\n-        // the restore and this method were implemented.\n-        if (!wasAdapterNull) {\n-            viewPager.setOffscreenPageLimit(tabsList.size());\n-        }\n+        viewPager.setAdapter(null);\n+        viewPager.setOffscreenPageLimit(tabsList.size());\n+        viewPager.setAdapter(pagerAdapter);\n \n         updateTabsIconAndDescription();\n         updateTitleForTab(viewPager.getCurrentItem());\n"}}, {"oid": "f2526ed5a892b0e59d2c575437d7782000f1d664", "url": "https://github.com/TeamNewPipe/NewPipe/commit/f2526ed5a892b0e59d2c575437d7782000f1d664", "message": "Fix bug in main screen tabs state management\n\nTabs were not being destroyed/restored correctly due to a call to a\nmethod that populated the view pager before it even had a chance of\nrestoring itself.\n\nThe solution was to null out the adapter before calling that method so\nthe view pager will postpone the populating process.", "committedDate": "2020-03-08T12:09:04Z", "type": "commit"}, {"oid": "f2526ed5a892b0e59d2c575437d7782000f1d664", "url": "https://github.com/TeamNewPipe/NewPipe/commit/f2526ed5a892b0e59d2c575437d7782000f1d664", "message": "Fix bug in main screen tabs state management\n\nTabs were not being destroyed/restored correctly due to a call to a\nmethod that populated the view pager before it even had a chance of\nrestoring itself.\n\nThe solution was to null out the adapter before calling that method so\nthe view pager will postpone the populating process.", "committedDate": "2020-03-08T12:09:04Z", "type": "forcePushed"}]}