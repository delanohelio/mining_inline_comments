{"pr_number": 4288, "pr_title": "Performance increase", "pr_createdAt": "2020-09-17T20:47:29Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/4288", "timeline": [{"oid": "5b8eda48053ddfc2f732cd7e0e793e7f636ea53b", "url": "https://github.com/TeamNewPipe/NewPipe/commit/5b8eda48053ddfc2f732cd7e0e793e7f636ea53b", "message": "Increased performance of the UI. main thread is not as busy as before", "committedDate": "2020-09-17T20:42:35Z", "type": "commit"}, {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51", "url": "https://github.com/TeamNewPipe/NewPipe/commit/c843e77183ffeed80db442ecd53376a6a3d8fa51", "message": "Made notification thumbnail smaller", "committedDate": "2020-09-23T12:20:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495575837", "bodyText": "Is this change needed with the MedidaStyle notifications?", "author": "TobiGr", "createdAt": "2020-09-27T13:56:32Z", "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "originalCommit": "c843e77183ffeed80db442ecd53376a6a3d8fa51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjM0NQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495576345", "bodyText": "I think so, as doing this in the background prevents it from being done by Android on the main thread. Also, I think the slowdown is not related to MediaStyle, but rather to the MediaSession, so this code probably helps independently of the type of notifications used. @vkay94 correct me if I'm wrong ;-)", "author": "Stypox", "createdAt": "2020-09-27T14:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTI2Mg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495581262", "bodyText": "In this place\nBitmap.createScaledBitmap\nI'm scaling down the image only once before assigning it to currentThumbnail. Without it Android will resize the thumbnail on every notification update which is a heavy task if the image is large (on YouTube it's large). In this case I made it smaller (much smaller) and if Android needs to resize it the time needed for the resize will be small. I'm not sure about the quality of the thumbnail but for me it looks ok compared to previous thumbnail impelementation. You can then change the width from 200dp (player_notification_thumbnail_width) to something else if the quality is not as good as you want.\nThe main thing that eats main thread's CPU time is an image resize but after this change there is no such problem. Actually I didn't tested in profiler after the change but visually it doesn't lock main thread as before on rotation change and after other changes.", "author": "avently", "createdAt": "2020-09-27T14:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjA2NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495582064", "bodyText": "With media style notifications the thumbnail can be even smaller because it use less space than previous notifications.", "author": "avently", "createdAt": "2020-09-27T15:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MzA0Ng==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495583046", "bodyText": "Would be better to somehow get the size for thumbnail inside media style notification and apply this size instead of 200dp. Does anyone know the exact size Android uses for notification?", "author": "avently", "createdAt": "2020-09-27T15:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MDA1NQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495590055", "bodyText": "no. I assume that varies from screen size and density.", "author": "TobiGr", "createdAt": "2020-09-27T16:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0370fa6c007ebc2b2f2e02266598179f65ecfece", "url": "https://github.com/TeamNewPipe/NewPipe/commit/0370fa6c007ebc2b2f2e02266598179f65ecfece", "message": "Merged 'dev' branch", "committedDate": "2020-09-27T15:02:31Z", "type": "commit"}]}