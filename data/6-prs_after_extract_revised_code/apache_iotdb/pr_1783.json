{"pr_number": 1783, "pr_title": "[IOTDB-943]  Fix cpu usage too high by removing unnecessary lock in MManager", "pr_createdAt": "2020-09-30T03:07:16Z", "pr_url": "https://github.com/apache/iotdb/pull/1783", "timeline": [{"oid": "bc4940707826fad677529d4c286fd1c1f83cbb51", "url": "https://github.com/apache/iotdb/commit/bc4940707826fad677529d4c286fd1c1f83cbb51", "message": "remove unnecessary lock", "committedDate": "2020-09-30T03:05:36Z", "type": "commit"}, {"oid": "58e4037a6006cbe00b644203cfd91dbd7b6c2fc2", "url": "https://github.com/apache/iotdb/commit/58e4037a6006cbe00b644203cfd91dbd7b6c2fc2", "message": "format", "committedDate": "2020-09-30T03:06:50Z", "type": "commit"}, {"oid": "1f5f010b02fd554c6ba6dd06cdbcf82ff884dde6", "url": "https://github.com/apache/iotdb/commit/1f5f010b02fd554c6ba6dd06cdbcf82ff884dde6", "message": "format", "committedDate": "2020-09-30T03:08:38Z", "type": "commit"}, {"oid": "4afd1c6d35e82c73493faeb4ae1e1ce7988d7d5f", "url": "https://github.com/apache/iotdb/commit/4afd1c6d35e82c73493faeb4ae1e1ce7988d7d5f", "message": "remove lock in both MManager and MNode, use concurrent hash map to sync", "committedDate": "2020-09-30T13:38:13Z", "type": "commit"}, {"oid": "e4459b7da3ea6ffd536a14061fd099ef1e570a92", "url": "https://github.com/apache/iotdb/commit/e4459b7da3ea6ffd536a14061fd099ef1e570a92", "message": "add comments", "committedDate": "2020-10-01T01:35:47Z", "type": "commit"}, {"oid": "38f27ecc17dc10ef6c8a5d81caf78f519ca10cde", "url": "https://github.com/apache/iotdb/commit/38f27ecc17dc10ef6c8a5d81caf78f519ca10cde", "message": "fix tests in IoTDBAlignByDeviceIT", "committedDate": "2020-10-03T18:38:07Z", "type": "commit"}, {"oid": "17bb6b5293b96c8a104f9f32f22e98382dc0fd6c", "url": "https://github.com/apache/iotdb/commit/17bb6b5293b96c8a104f9f32f22e98382dc0fd6c", "message": "fix tests in TTLTest", "committedDate": "2020-10-03T18:56:29Z", "type": "commit"}, {"oid": "f76ee4657ffac635a541375765940b9cbe91cd13", "url": "https://github.com/apache/iotdb/commit/f76ee4657ffac635a541375765940b9cbe91cd13", "message": "fix tests in IoTDBCreateSnapshotIT", "committedDate": "2020-10-03T19:42:53Z", "type": "commit"}, {"oid": "295ccfa00272505e73b28e65f6da823cf7872c4a", "url": "https://github.com/apache/iotdb/commit/295ccfa00272505e73b28e65f6da823cf7872c4a", "message": "fix tests in IoTDBQueryDemoIT", "committedDate": "2020-10-03T20:27:59Z", "type": "commit"}, {"oid": "84d00c5700cbae9d1d642c556035cf31825b8140", "url": "https://github.com/apache/iotdb/commit/84d00c5700cbae9d1d642c556035cf31825b8140", "message": "fix tests in IoTDBLastIT", "committedDate": "2020-10-03T20:47:02Z", "type": "commit"}, {"oid": "3f175ed403451e2bff10fb5712a8cd21b8e3436b", "url": "https://github.com/apache/iotdb/commit/3f175ed403451e2bff10fb5712a8cd21b8e3436b", "message": "fix loadTsFileTestWithAutoCreateSchema in IoTDBLoadExternalTsfileIT", "committedDate": "2020-10-04T06:07:58Z", "type": "commit"}, {"oid": "fc2683b96b1cbf104b0c808b105a7d5184474452", "url": "https://github.com/apache/iotdb/commit/fc2683b96b1cbf104b0c808b105a7d5184474452", "message": "fix testShowTimeseriesWithLimitOffset in IoTDBSimpleQueryIT", "committedDate": "2020-10-04T06:22:01Z", "type": "commit"}, {"oid": "fcf492b2d138f196fd5a33b5dca0ee2abcb6b9ea", "url": "https://github.com/apache/iotdb/commit/fcf492b2d138f196fd5a33b5dca0ee2abcb6b9ea", "message": "fix tests in IoTDBMetadataFetchIT", "committedDate": "2020-10-04T07:35:25Z", "type": "commit"}, {"oid": "308eea1beaa0bd64bd693cc26b6575f0b3d7564d", "url": "https://github.com/apache/iotdb/commit/308eea1beaa0bd64bd693cc26b6575f0b3d7564d", "message": "fix tests in IoTDBTtlIT", "committedDate": "2020-10-04T07:47:02Z", "type": "commit"}, {"oid": "199a8a1ddbe5dcc16a5023d492fc7cb402558746", "url": "https://github.com/apache/iotdb/commit/199a8a1ddbe5dcc16a5023d492fc7cb402558746", "message": "fix tests in IoTDBTagIT", "committedDate": "2020-10-04T08:23:35Z", "type": "commit"}, {"oid": "600f5528fff0383985267791a6ba8d9db84706f9", "url": "https://github.com/apache/iotdb/commit/600f5528fff0383985267791a6ba8d9db84706f9", "message": "fix tests in IoTDBSortedShowTimeseriesIT", "committedDate": "2020-10-04T08:59:37Z", "type": "commit"}, {"oid": "1516d4bab7b1a2407e47d47909e6474c916e4909", "url": "https://github.com/apache/iotdb/commit/1516d4bab7b1a2407e47d47909e6474c916e4909", "message": "fix tests in IoTDBDisableAlignIT", "committedDate": "2020-10-04T10:47:58Z", "type": "commit"}, {"oid": "d18a587ebfe55ac3894952853d386074e63eb63e", "url": "https://github.com/apache/iotdb/commit/d18a587ebfe55ac3894952853d386074e63eb63e", "message": "improve code style", "committedDate": "2020-10-04T11:43:43Z", "type": "commit"}, {"oid": "24366254f1f188c82cffb3d2400df03cb515083b", "url": "https://github.com/apache/iotdb/commit/24366254f1f188c82cffb3d2400df03cb515083b", "message": "fix all tests in session", "committedDate": "2020-10-04T13:17:17Z", "type": "commit"}, {"oid": "ebadece8bf4b9c5c488d0b49a811a0cc51af7811", "url": "https://github.com/apache/iotdb/commit/ebadece8bf4b9c5c488d0b49a811a0cc51af7811", "message": "Merge pull request #1794 from SteveYurongSu/KF\n\nFix tests after removing locks from MManager and MNode", "committedDate": "2020-10-05T01:17:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDM0Ng==", "url": "https://github.com/apache/iotdb/pull/1783#discussion_r500050346", "bodyText": "If there is no read lock anymore, what about change the method name to getDeviceNodeWithAutoCreate?", "author": "HTHou", "createdAt": "2020-10-06T07:07:43Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1121,7 +970,6 @@ public StorageGroupMNode getStorageGroupNodeByPath(PartialPath path) throws Meta\n    */\n   public MNode getDeviceNodeWithAutoCreateAndReadLock(\n       PartialPath path, boolean autoCreateSchema, int sgLevel) throws MetadataException {", "originalCommit": "ebadece8bf4b9c5c488d0b49a811a0cc51af7811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQzNzE2Ng==", "url": "https://github.com/apache/iotdb/pull/1783#discussion_r501437166", "bodyText": "fixed", "author": "qiaojialin", "createdAt": "2020-10-08T04:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDM0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a9af4c40362ebadf58dca5b491455886fd218ed6", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex b9036ec24c..3efbf76a6c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -964,11 +964,9 @@ public class MManager {\n    * get device node, if the storage group is not set, create it when autoCreateSchema is true <p>\n    * (we develop this method as we need to get the node's lock after we get the lock.writeLock())\n    *\n-   * <p>!!!!!!Attention!!!!! must call the return node's readUnlock() if you call this method.\n-   *\n    * @param path path\n    */\n-  public MNode getDeviceNodeWithAutoCreateAndReadLock(\n+  public MNode getDeviceNodeWithAutoCreate(\n       PartialPath path, boolean autoCreateSchema, int sgLevel) throws MetadataException {\n     MNode node = null;\n     boolean shouldSetStorageGroup;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NTQyMQ==", "url": "https://github.com/apache/iotdb/pull/1783#discussion_r500055421", "bodyText": "Remove it?", "author": "HTHou", "createdAt": "2020-10-06T07:18:11Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1205,25 +1039,16 @@ public String getDeviceId(PartialPath path) {\n     return device;\n   }\n \n+  // concurrent warning: you should get parent read lock before calling this method", "originalCommit": "ebadece8bf4b9c5c488d0b49a811a0cc51af7811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQzNzE3OQ==", "url": "https://github.com/apache/iotdb/pull/1783#discussion_r501437179", "bodyText": "fixed", "author": "qiaojialin", "createdAt": "2020-10-08T04:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NTQyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a9af4c40362ebadf58dca5b491455886fd218ed6", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex b9036ec24c..3efbf76a6c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1028,10 +1026,9 @@ public class MManager {\n    * @return deviceId\n    */\n   public String getDeviceId(PartialPath path) {\n-    MNode deviceNode = null;\n     String device = null;\n     try {\n-      deviceNode = getDeviceNode(path);\n+      MNode deviceNode = getDeviceNode(path);\n       device = deviceNode.getFullPath();\n     } catch (MetadataException | NullPointerException e) {\n       // Cannot get deviceId from MManager, return the input deviceId\n"}}, {"oid": "74c4aa42341e63aa02e4378647d5c8e1fcb87169", "url": "https://github.com/apache/iotdb/commit/74c4aa42341e63aa02e4378647d5c8e1fcb87169", "message": "Merge branch 'master' into KF", "committedDate": "2020-10-07T07:59:53Z", "type": "commit"}, {"oid": "c04354ff0f0a6e9d40395b4b2aa7cf734d9d671a", "url": "https://github.com/apache/iotdb/commit/c04354ff0f0a6e9d40395b4b2aa7cf734d9d671a", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb into KF\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "committedDate": "2020-10-07T08:28:30Z", "type": "commit"}, {"oid": "fb16327cc225d15d4fb27831afe63956d2ebb404", "url": "https://github.com/apache/iotdb/commit/fb16327cc225d15d4fb27831afe63956d2ebb404", "message": "Merge branch 'KF' of https://github.com/apache/incubator-iotdb into KF\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "committedDate": "2020-10-07T08:39:25Z", "type": "commit"}, {"oid": "d96a7b278861dca60e87947daf51f529a2770ed7", "url": "https://github.com/apache/iotdb/commit/d96a7b278861dca60e87947daf51f529a2770ed7", "message": "fix bug and add comment", "committedDate": "2020-10-08T03:08:46Z", "type": "commit"}, {"oid": "1380343ede85d68c357e79ac405a01b7e66243ca", "url": "https://github.com/apache/iotdb/commit/1380343ede85d68c357e79ac405a01b7e66243ca", "message": "fix smell", "committedDate": "2020-10-08T03:19:31Z", "type": "commit"}, {"oid": "a9af4c40362ebadf58dca5b491455886fd218ed6", "url": "https://github.com/apache/iotdb/commit/a9af4c40362ebadf58dca5b491455886fd218ed6", "message": "fix review", "committedDate": "2020-10-08T04:09:47Z", "type": "commit"}, {"oid": "e942a5476ae008eb89411e6e6260f821c6ebf477", "url": "https://github.com/apache/iotdb/commit/e942a5476ae008eb89411e6e6260f821c6ebf477", "message": "fix smell", "committedDate": "2020-10-08T06:29:24Z", "type": "commit"}, {"oid": "cf2c9bcde60026e3797c9fdecadf9f46da3a6f96", "url": "https://github.com/apache/iotdb/commit/cf2c9bcde60026e3797c9fdecadf9f46da3a6f96", "message": "suppress warning", "committedDate": "2020-10-08T06:52:08Z", "type": "commit"}]}