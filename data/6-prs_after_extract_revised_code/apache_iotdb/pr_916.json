{"pr_number": 916, "pr_title": "fix execute flush command while inserting bug", "pr_createdAt": "2020-03-17T02:40:31Z", "pr_url": "https://github.com/apache/iotdb/pull/916", "timeline": [{"oid": "9302734bfdc2bf0092abaf3f6a5bb406864a4f62", "url": "https://github.com/apache/iotdb/commit/9302734bfdc2bf0092abaf3f6a5bb406864a4f62", "message": "fix flush", "committedDate": "2020-03-17T02:39:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxNzgzMQ==", "url": "https://github.com/apache/iotdb/pull/916#discussion_r393417831", "bodyText": "Don't we have to close the file resources? Should we move it to syncCloseAllTsFileProcessors() instead of directly deleting it?", "author": "JackieTien97", "createdAt": "2020-03-17T02:57:52Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java", "diffHunk": "@@ -303,9 +303,7 @@ public void insert(InsertPlan insertPlan)\n   public void syncCloseAllProcessor() {\n     logger.info(\"Start closing all storage group processor\");\n     for (StorageGroupProcessor processor : processorMap.values()) {\n-      processor.waitForAllCurrentTsFileProcessorsClosed();\n-      //TODO do we need to wait for all merging tasks to be finished here?\n-      processor.closeAllResources();", "originalCommit": "9302734bfdc2bf0092abaf3f6a5bb406864a4f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyMDk2MQ==", "url": "https://github.com/apache/iotdb/pull/916#discussion_r393420961", "bodyText": "It's already be closed in closeUnsealedTsFileProcessor() when the close call back", "author": "qiaojialin", "createdAt": "2020-03-17T03:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQxNzgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "51558bf3e8982e1a691117b3a9e032ba45afd6e1", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java b/server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java\nindex 6b742d706..6bd9b146f 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java\n\n@@ -303,7 +303,7 @@ public class StorageEngine implements IService {\n   public void syncCloseAllProcessor() {\n     logger.info(\"Start closing all storage group processor\");\n     for (StorageGroupProcessor processor : processorMap.values()) {\n-      processor.syncCloseAllTsFileProcessors();\n+      processor.syncCloseAllWorkingTsFileProcessors();\n     }\n   }\n \n"}}, {"oid": "51558bf3e8982e1a691117b3a9e032ba45afd6e1", "url": "https://github.com/apache/iotdb/commit/51558bf3e8982e1a691117b3a9e032ba45afd6e1", "message": "enable write when executing flush command", "committedDate": "2020-03-17T03:05:26Z", "type": "commit"}, {"oid": "04eceef6df3a870371f0305e2595d78990765ffb", "url": "https://github.com/apache/iotdb/commit/04eceef6df3a870371f0305e2595d78990765ffb", "message": "rename closeUnsealedTsFileProcessor to closeUnsealedTsFileProcessorCallBack", "committedDate": "2020-03-17T03:07:29Z", "type": "commit"}]}