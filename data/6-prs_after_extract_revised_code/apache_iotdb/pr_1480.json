{"pr_number": 1480, "pr_title": "update log and add some reader close", "pr_createdAt": "2020-07-10T10:44:52Z", "pr_url": "https://github.com/apache/iotdb/pull/1480", "timeline": [{"oid": "9b2f178941eb17a742828d46d41b7dfe6a045743", "url": "https://github.com/apache/iotdb/commit/9b2f178941eb17a742828d46d41b7dfe6a045743", "message": "update log and add some reader close", "committedDate": "2020-07-10T10:44:10Z", "type": "commit"}, {"oid": "48d79624c698371a3cbb704ab2d567b87c3a4232", "url": "https://github.com/apache/iotdb/commit/48d79624c698371a3cbb704ab2d567b87c3a4232", "message": "try test reader and writer open and close", "committedDate": "2020-07-10T12:24:55Z", "type": "commit"}, {"oid": "38ee495a42635f194fef575380ac90f31c1db3ab", "url": "https://github.com/apache/iotdb/commit/38ee495a42635f194fef575380ac90f31c1db3ab", "message": "try to figure same file bug in windows", "committedDate": "2020-07-10T13:29:23Z", "type": "commit"}, {"oid": "567339591fa673f836f896da7e49960cba3fd07e", "url": "https://github.com/apache/iotdb/commit/567339591fa673f836f896da7e49960cba3fd07e", "message": "Revert \"try test reader and writer open and close\"\n\nThis reverts commit 48d79624c698371a3cbb704ab2d567b87c3a4232.", "committedDate": "2020-07-10T13:51:09Z", "type": "commit"}, {"oid": "bf350566317422299d13572c363fc35bd33547da", "url": "https://github.com/apache/iotdb/commit/bf350566317422299d13572c363fc35bd33547da", "message": "remove useless reader close", "committedDate": "2020-07-10T13:52:33Z", "type": "commit"}, {"oid": "44f8527990dfa66926f8876ae94f45f36eaeeb65", "url": "https://github.com/apache/iotdb/commit/44f8527990dfa66926f8876ae94f45f36eaeeb65", "message": "update vm file to version", "committedDate": "2020-07-14T11:36:52Z", "type": "commit"}, {"oid": "b61c097466a73da5f46b2c55cba0fd8c3088d27a", "url": "https://github.com/apache/iotdb/commit/b61c097466a73da5f46b2c55cba0fd8c3088d27a", "message": "merge", "committedDate": "2020-07-14T12:38:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyNTY1OA==", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454325658", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  String vmVersionStr = f.getPath()\n          \n          \n            \n                  String vmLevel = f.getPath()", "author": "qiaojialin", "createdAt": "2020-07-14T12:39:31Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -574,16 +575,25 @@ else if (upgradeFolder.exists()) {\n       }\n     }\n \n-    Map<String, List<TsFileResource>> vmTsFileResourceMap = new HashMap<>();\n+    Map<String, List<List<TsFileResource>>> vmTsFileResourceMap = new HashMap<>();\n     for (File f : vmFiles) {\n       TsFileResource fileResource = new TsFileResource(f);\n       fileResource.setClosed(false);\n       String tsfilePrefix = f.getPath()\n-          .substring(0, f.getPath().lastIndexOf(FILE_NAME_SEPARATOR));\n-      vmTsFileResourceMap.computeIfAbsent(tsfilePrefix, k -> new ArrayList<>()).add(fileResource);\n+          .substring(0, f.getPath().lastIndexOf(TSFILE_SUFFIX)) + TSFILE_SUFFIX;\n+      String vmVersionStr = f.getPath()", "originalCommit": "44f8527990dfa66926f8876ae94f45f36eaeeb65", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\nindex da55ca883..7b56aba57 100755\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\n\n@@ -581,15 +581,15 @@ public class StorageGroupProcessor {\n       fileResource.setClosed(false);\n       String tsfilePrefix = f.getPath()\n           .substring(0, f.getPath().lastIndexOf(TSFILE_SUFFIX)) + TSFILE_SUFFIX;\n-      String vmVersionStr = f.getPath()\n+      String vmLevelStr = f.getPath()\n           .substring(f.getPath().lastIndexOf(FILE_NAME_SEPARATOR) + 1).replaceAll(VM_SUFFIX, \"\");\n-      int vmVersion = Integer.parseInt(vmVersionStr);\n+      int vmLevel = Integer.parseInt(vmLevelStr);\n       List<List<TsFileResource>> tsFileList = vmTsFileResourceMap\n           .computeIfAbsent(tsfilePrefix, k -> new ArrayList<>());\n-      while (tsFileList.size() <= vmVersion) {\n+      while (tsFileList.size() <= vmLevel) {\n         tsFileList.add(new ArrayList<>());\n       }\n-      tsFileList.get(vmVersion).add(fileResource);\n+      tsFileList.get(vmLevel).add(fileResource);\n     }\n     vmTsFileResourceMap.values()\n         .forEach(tsFileResources -> tsFileResources\n"}}, {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "url": "https://github.com/apache/iotdb/commit/e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "message": "update version and level", "committedDate": "2020-07-14T12:46:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjAwMQ==", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336001", "bodyText": "I prefer to put the level ahead of system time...", "author": "qiaojialin", "createdAt": "2020-07-14T12:57:32Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -586,12 +603,23 @@ private void releaseFlushedMemTable(IMemTable memTable) {\n     }\n   }\n \n-  public static File createNewVMFile(TsFileResource tsFileResource) {\n-    File parent = tsFileResource.getTsFile().getParentFile();\n-    return FSFactoryProducer.getFSFactory().getFile(parent,\n-        tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n-            .currentTimeMillis()\n-            + VM_SUFFIX);\n+  public File createNewVMFile(TsFileResource tsFileResource, int level) {\n+    vmFileCreateLock.writeLock().lock();\n+    try {\n+      TimeUnit.MILLISECONDS.sleep(1);\n+      File parent = tsFileResource.getTsFile().getParentFile();\n+      File newVmFile = FSFactoryProducer.getFSFactory().getFile(parent,\n+          tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n+              .currentTimeMillis() + IoTDBConstant.FILE_NAME_SEPARATOR + level", "originalCommit": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be8e4198861871c6687eaf698cd3476333de3a00", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\nindex 2fb70d5a3..7059de3e9 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n\n@@ -609,9 +609,9 @@ public class TsFileProcessor {\n       TimeUnit.MILLISECONDS.sleep(1);\n       File parent = tsFileResource.getTsFile().getParentFile();\n       File newVmFile = FSFactoryProducer.getFSFactory().getFile(parent,\n-          tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n-              .currentTimeMillis() + IoTDBConstant.FILE_NAME_SEPARATOR + level\n-              + VM_SUFFIX);\n+          tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + level\n+              + IoTDBConstant.FILE_NAME_SEPARATOR + System\n+              .currentTimeMillis() + VM_SUFFIX);\n       return newVmFile;\n     } catch (InterruptedException e) {\n       logger.error(\"{}: {}, closing task is interrupted.\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjU0OQ==", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336549", "bodyText": "change to debug level", "author": "qiaojialin", "createdAt": "2020-07-14T12:58:22Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -600,11 +628,13 @@ private void deleteVmFiles(List<TsFileResource> vmMergeTsFiles,\n         tsFileResource.getTsFile().getName());\n     for (int i = 0; i < vmMergeTsFiles.size(); i++) {\n       vmMergeWriters.get(i).close();\n-      logger.info(\"{} vm file open a writer\", vmMergeWriters.get(i).getFile().getName());\n+      logger.info(\"{} vm file close a writer\", vmMergeWriters.get(i).getFile().getName());", "originalCommit": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNzMwMw==", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454337303", "bodyText": "are they consistent and can be put together?", "author": "qiaojialin", "createdAt": "2020-07-14T12:59:37Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -683,10 +715,16 @@ public void flushOneMemTable() {\n         RestorableTsFileIOWriter curWriter;\n         if (config.isEnableVm()) {\n           logger.info(\"[Flush] flush a vm\");\n-          File newVmFile = createNewVMFile(tsFileResource);\n-          vmTsFileResources.add(new TsFileResource(newVmFile));\n+          File newVmFile = createNewVMFile(tsFileResource, 0);\n+          if (vmWriters.size() <= 0) {\n+            vmWriters.add(new ArrayList<>());\n+          }\n+          if (vmTsFileResources.size() <= 0) {\n+            vmTsFileResources.add(new ArrayList<>());\n+          }", "originalCommit": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a1d36c6566deed0a68cedcf4f2689ef7e0ac3387", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\nindex 2fb70d5a3..0c00e3a69 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n\n@@ -718,8 +718,6 @@ public class TsFileProcessor {\n           File newVmFile = createNewVMFile(tsFileResource, 0);\n           if (vmWriters.size() <= 0) {\n             vmWriters.add(new ArrayList<>());\n-          }\n-          if (vmTsFileResources.size() <= 0) {\n             vmTsFileResources.add(new ArrayList<>());\n           }\n           vmTsFileResources.get(0).add(new TsFileResource(newVmFile));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzODQxNQ==", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454338415", "bodyText": "add javadoc, or rename this to copiedVmTsFileResources", "author": "qiaojialin", "createdAt": "2020-07-14T13:01:28Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -802,9 +840,17 @@ public void flushOneMemTable() {\n         mergeWorking = true;\n         logger.info(\"{}: {} submit a vm merge task\", storageGroupName,\n             tsFileResource.getTsFile().getName());\n+        List<List<TsFileResource>> currVmTsFileResources = new ArrayList<>();", "originalCommit": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "be8e4198861871c6687eaf698cd3476333de3a00", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\nindex 2fb70d5a3..7059de3e9 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n\n@@ -840,17 +838,18 @@ public class TsFileProcessor {\n         mergeWorking = true;\n         logger.info(\"{}: {} submit a vm merge task\", storageGroupName,\n             tsFileResource.getTsFile().getName());\n-        List<List<TsFileResource>> currVmTsFileResources = new ArrayList<>();\n+        // fork current vm tsfile and writer, then commit then to vm merge\n+        List<List<TsFileResource>> copiedVmTsFileResources = new ArrayList<>();\n         for (List<TsFileResource> subVmTsFileResources : vmTsFileResources) {\n-          currVmTsFileResources.add(new ArrayList<>(subVmTsFileResources));\n+          copiedVmTsFileResources.add(new ArrayList<>(subVmTsFileResources));\n         }\n-        List<List<RestorableTsFileIOWriter>> currVmWriters = new ArrayList<>();\n+        List<List<RestorableTsFileIOWriter>> copiedVmWriters = new ArrayList<>();\n         for (List<RestorableTsFileIOWriter> subVmWriters : vmWriters) {\n-          currVmWriters.add(new ArrayList<>(subVmWriters));\n+          copiedVmWriters.add(new ArrayList<>(subVmWriters));\n         }\n         VmMergeTaskPoolManager.getInstance()\n             .submit(\n-                new VmMergeTask(currVmTsFileResources, currVmWriters));\n+                new VmMergeTask(copiedVmTsFileResources, copiedVmWriters));\n       } else {\n         logger.info(\"{}: {} last vm merge task is working, skip current merge\", storageGroupName,\n             tsFileResource.getTsFile().getName());\n"}}, {"oid": "a1d36c6566deed0a68cedcf4f2689ef7e0ac3387", "url": "https://github.com/apache/iotdb/commit/a1d36c6566deed0a68cedcf4f2689ef7e0ac3387", "message": "merge if condition", "committedDate": "2020-07-14T13:01:44Z", "type": "commit"}, {"oid": "be8e4198861871c6687eaf698cd3476333de3a00", "url": "https://github.com/apache/iotdb/commit/be8e4198861871c6687eaf698cd3476333de3a00", "message": "fix comment code", "committedDate": "2020-07-14T13:12:32Z", "type": "commit"}]}