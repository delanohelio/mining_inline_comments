{"pr_number": 2220, "pr_title": "Add compaction test", "pr_createdAt": "2020-12-08T14:51:30Z", "pr_url": "https://github.com/apache/iotdb/pull/2220", "timeline": [{"oid": "09288cdfa689921fadd6f794884515dc909302aa", "url": "https://github.com/apache/iotdb/commit/09288cdfa689921fadd6f794884515dc909302aa", "message": "add enable unseq compaction", "committedDate": "2020-11-06T11:30:43Z", "type": "commit"}, {"oid": "49fab34ba14c60d99f540297a3113295eee3a08f", "url": "https://github.com/apache/iotdb/commit/49fab34ba14c60d99f540297a3113295eee3a08f", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-07T06:18:17Z", "type": "commit"}, {"oid": "2854f931acefe3bca3d9548ddcf5b37760473980", "url": "https://github.com/apache/iotdb/commit/2854f931acefe3bca3d9548ddcf5b37760473980", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-07T10:43:36Z", "type": "commit"}, {"oid": "9ba681617dab53da7e51865d9aee14dd6ebbe335", "url": "https://github.com/apache/iotdb/commit/9ba681617dab53da7e51865d9aee14dd6ebbe335", "message": "Merge branches 'master' and 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-08T08:34:09Z", "type": "commit"}, {"oid": "9da683521fabfb7ad05f84d319d9b504c71a4f2b", "url": "https://github.com/apache/iotdb/commit/9da683521fabfb7ad05f84d319d9b504c71a4f2b", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-10T05:54:00Z", "type": "commit"}, {"oid": "f438705f15d0e2eea26ed27f5348414f2e58f231", "url": "https://github.com/apache/iotdb/commit/f438705f15d0e2eea26ed27f5348414f2e58f231", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-11T03:13:16Z", "type": "commit"}, {"oid": "b5a17d52eea06efa2650921ecb1d104e00309415", "url": "https://github.com/apache/iotdb/commit/b5a17d52eea06efa2650921ecb1d104e00309415", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-12T02:03:02Z", "type": "commit"}, {"oid": "ae79d884d1c520da33dba51a4f1ef84ee52a70a8", "url": "https://github.com/apache/iotdb/commit/ae79d884d1c520da33dba51a4f1ef84ee52a70a8", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-12T10:33:05Z", "type": "commit"}, {"oid": "97a2b13f188a81b9f6228fd599e18a818fcf331a", "url": "https://github.com/apache/iotdb/commit/97a2b13f188a81b9f6228fd599e18a818fcf331a", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-13T02:41:57Z", "type": "commit"}, {"oid": "725524238dbe29d79e974784fea80f99442eaf8d", "url": "https://github.com/apache/iotdb/commit/725524238dbe29d79e974784fea80f99442eaf8d", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-16T09:26:36Z", "type": "commit"}, {"oid": "e7a4e32d6fc98f30bffaf368bd8354107f32005a", "url": "https://github.com/apache/iotdb/commit/e7a4e32d6fc98f30bffaf368bd8354107f32005a", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-18T14:03:07Z", "type": "commit"}, {"oid": "181682b69b3ffd4b538cbbbbe83f41eeb9175e2f", "url": "https://github.com/apache/iotdb/commit/181682b69b3ffd4b538cbbbbe83f41eeb9175e2f", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-29T02:03:48Z", "type": "commit"}, {"oid": "1b1a09bfbf785980536d5184164f5c43799c5220", "url": "https://github.com/apache/iotdb/commit/1b1a09bfbf785980536d5184164f5c43799c5220", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-11-30T09:35:38Z", "type": "commit"}, {"oid": "ae6b81129a5590c175d696eab47742c3d4cc8019", "url": "https://github.com/apache/iotdb/commit/ae6b81129a5590c175d696eab47742c3d4cc8019", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-12-01T02:28:55Z", "type": "commit"}, {"oid": "ad2130246f172bd1f58a7c1b8f32054ea48f4d5b", "url": "https://github.com/apache/iotdb/commit/ad2130246f172bd1f58a7c1b8f32054ea48f4d5b", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-12-02T06:30:18Z", "type": "commit"}, {"oid": "8f906cdc53269c0701f41d4a55cbb8deda25de76", "url": "https://github.com/apache/iotdb/commit/8f906cdc53269c0701f41d4a55cbb8deda25de76", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-12-08T04:52:39Z", "type": "commit"}, {"oid": "b740657c5bc92907271c079f4f8689ddc6ed8433", "url": "https://github.com/apache/iotdb/commit/b740657c5bc92907271c079f4f8689ddc6ed8433", "message": "add compaction test", "committedDate": "2020-12-08T14:51:03Z", "type": "commit"}, {"oid": "1ea81ff840122529072d5378a914d889fb07d12e", "url": "https://github.com/apache/iotdb/commit/1ea81ff840122529072d5378a914d889fb07d12e", "message": "add license", "committedDate": "2020-12-08T15:00:24Z", "type": "commit"}, {"oid": "7667b4b77f61039f1d5c8b20daf5df7d06f472da", "url": "https://github.com/apache/iotdb/commit/7667b4b77f61039f1d5c8b20daf5df7d06f472da", "message": "fix test close and code smell", "committedDate": "2020-12-09T03:31:33Z", "type": "commit"}, {"oid": "0085fe6af041f71cd06fa6b0fb370905aeeb92eb", "url": "https://github.com/apache/iotdb/commit/0085fe6af041f71cd06fa6b0fb370905aeeb92eb", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-12-09T03:38:27Z", "type": "commit"}, {"oid": "73b621f2fb50e22d17720dc6d626b09f435578ed", "url": "https://github.com/apache/iotdb/commit/73b621f2fb50e22d17720dc6d626b09f435578ed", "message": "Merge branch 'master' into add_compaction_test\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "committedDate": "2020-12-09T03:39:13Z", "type": "commit"}, {"oid": "dc811eec9c5591e23d0f4d8bfb8c3139f6ac84e9", "url": "https://github.com/apache/iotdb/commit/dc811eec9c5591e23d0f4d8bfb8c3139f6ac84e9", "message": "update updatePlanIndexes", "committedDate": "2020-12-09T03:49:38Z", "type": "commit"}, {"oid": "18a864d1260ba5991e040c1a4f4956afa975467c", "url": "https://github.com/apache/iotdb/commit/18a864d1260ba5991e040c1a4f4956afa975467c", "message": "fix test", "committedDate": "2020-12-09T04:14:52Z", "type": "commit"}, {"oid": "8d99e4160ccac776b39db8220bf6e47f4e124b64", "url": "https://github.com/apache/iotdb/commit/8d99e4160ccac776b39db8220bf6e47f4e124b64", "message": "fix log delete bug by wait", "committedDate": "2020-12-09T04:55:46Z", "type": "commit"}, {"oid": "c461b596e74422928521536a9c76951c8468c46c", "url": "https://github.com/apache/iotdb/commit/c461b596e74422928521536a9c76951c8468c46c", "message": "fix test", "committedDate": "2020-12-09T05:50:46Z", "type": "commit"}, {"oid": "ca9b00b8e4941d3af1282fd00a2827290411c4af", "url": "https://github.com/apache/iotdb/commit/ca9b00b8e4941d3af1282fd00a2827290411c4af", "message": "fix doc and recover", "committedDate": "2020-12-09T13:35:14Z", "type": "commit"}, {"oid": "97d99d36f92804e09a6222c284cd5d6f6b04d058", "url": "https://github.com/apache/iotdb/commit/97d99d36f92804e09a6222c284cd5d6f6b04d058", "message": "fix windows ci", "committedDate": "2020-12-10T04:33:54Z", "type": "commit"}, {"oid": "b22d3e2f90a1857d4def7981464527245394de8c", "url": "https://github.com/apache/iotdb/commit/b22d3e2f90a1857d4def7981464527245394de8c", "message": "fix windows ci bug", "committedDate": "2020-12-10T06:18:58Z", "type": "commit"}, {"oid": "795d32fcc6d7e25609524bf5b7dc801a75ecc953", "url": "https://github.com/apache/iotdb/commit/795d32fcc6d7e25609524bf5b7dc801a75ecc953", "message": "fix windows ci", "committedDate": "2020-12-10T11:21:56Z", "type": "commit"}, {"oid": "5a0677a2ecddce40c6e103048809ed8d2c20cf10", "url": "https://github.com/apache/iotdb/commit/5a0677a2ecddce40c6e103048809ed8d2c20cf10", "message": "update device, offset log", "committedDate": "2020-12-11T08:40:15Z", "type": "commit"}, {"oid": "848f5963a9b04de741ce5ae61c40c311cd16c7b2", "url": "https://github.com/apache/iotdb/commit/848f5963a9b04de741ce5ae61c40c311cd16c7b2", "message": "update", "committedDate": "2020-12-11T13:13:44Z", "type": "commit"}, {"oid": "570ef6d26b4ccfeee124ada9360ab480979a4d50", "url": "https://github.com/apache/iotdb/commit/570ef6d26b4ccfeee124ada9360ab480979a4d50", "message": "add truncate test", "committedDate": "2020-12-11T13:18:31Z", "type": "commit"}, {"oid": "b4e1876a1b902c53796d6dbdc499ef93eae83290", "url": "https://github.com/apache/iotdb/commit/b4e1876a1b902c53796d6dbdc499ef93eae83290", "message": "add comment", "committedDate": "2020-12-12T03:44:49Z", "type": "commit"}, {"oid": "af195408b5c160f65c64e02069ae3a9390a3b9b4", "url": "https://github.com/apache/iotdb/commit/af195408b5c160f65c64e02069ae3a9390a3b9b4", "message": "fix windows ci", "committedDate": "2020-12-12T03:52:04Z", "type": "commit"}, {"oid": "f436a95d07a70965011dbdbf16c0bc80e89b6f32", "url": "https://github.com/apache/iotdb/commit/f436a95d07a70965011dbdbf16c0bc80e89b6f32", "message": "fix recover restart bug", "committedDate": "2020-12-12T04:23:44Z", "type": "commit"}, {"oid": "0fe2e732e351994593a26b6c9f2d7c91eecb5b25", "url": "https://github.com/apache/iotdb/commit/0fe2e732e351994593a26b6c9f2d7c91eecb5b25", "message": "fix windows ci", "committedDate": "2020-12-12T08:36:26Z", "type": "commit"}, {"oid": "5b0a16363e6a920b29eca4086fb96df17ae1d329", "url": "https://github.com/apache/iotdb/commit/5b0a16363e6a920b29eca4086fb96df17ae1d329", "message": "fix mod bug and update about recover", "committedDate": "2020-12-15T04:23:38Z", "type": "commit"}, {"oid": "44c8d85c5ac146b0582693d1e4f4986a088d4352", "url": "https://github.com/apache/iotdb/commit/44c8d85c5ac146b0582693d1e4f4986a088d4352", "message": "fix sonar", "committedDate": "2020-12-15T07:44:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5MDAxNA==", "url": "https://github.com/apache/iotdb/pull/2220#discussion_r541490014", "bodyText": "The fullMerge is not used now, it's better to add comment or javadoc to describe what is fullmerge", "author": "qiaojialin", "createdAt": "2020-12-12T03:33:56Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/compaction/level/LevelCompactionTsFileManagement.java", "diffHunk": "@@ -330,37 +334,36 @@ public void recover() {\n           return;\n         }\n         if (fullMerge) {", "originalCommit": "570ef6d26b4ccfeee124ada9360ab480979a4d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4e1876a1b902c53796d6dbdc499ef93eae83290", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/compaction/level/LevelCompactionTsFileManagement.java b/server/src/main/java/org/apache/iotdb/db/engine/compaction/level/LevelCompactionTsFileManagement.java\nindex ee1def5cf..85d0cf8a7 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/compaction/level/LevelCompactionTsFileManagement.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/compaction/level/LevelCompactionTsFileManagement.java\n\n@@ -334,17 +334,20 @@ public class LevelCompactionTsFileManagement extends TsFileManagement {\n           return;\n         }\n         if (fullMerge) {\n+          // get tsfile resource from list, as they have been recovered in StorageGroupProcessor\n           TsFileResource targetTsFileResource = getTsFileResource(targetFile, isSeq);\n           long timePartition = targetTsFileResource.getTimePartition();\n           if (!isMergeFinished) {\n             File target = new File(targetFile);\n             if (!deviceSet.isEmpty()) {\n+              // if not in compaction, just delete the target file\n               if (target.exists()) {\n                 Files.delete(target.toPath());\n               }\n             } else {\n               RestorableTsFileIOWriter writer = new RestorableTsFileIOWriter(\n                   new File(targetFile));\n+              // if not complete compaction, resume merge\n               if (writer.hasCrashed()) {\n                 if (offset > 0) {\n                   writer.getIOWriterOut().truncate(offset - 1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4NDk3OQ==", "url": "https://github.com/apache/iotdb/pull/2220#discussion_r542184979", "bodyText": "why false?", "author": "qiaojialin", "createdAt": "2020-12-14T08:11:34Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/compaction/utils/CompactionLogger.java", "diffHunk": "@@ -42,15 +40,17 @@\n   public CompactionLogger(String storageGroupDir, String storageGroupName) throws IOException {\n     logStream = new BufferedWriter(\n         new FileWriter(SystemFileFactory.INSTANCE.getFile(storageGroupDir,\n-            storageGroupName + COMPACTION_LOG_NAME), true));\n+            storageGroupName + COMPACTION_LOG_NAME), false));", "originalCommit": "0fe2e732e351994593a26b6c9f2d7c91eecb5b25", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b0a16363e6a920b29eca4086fb96df17ae1d329", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/compaction/utils/CompactionLogger.java b/server/src/main/java/org/apache/iotdb/db/engine/compaction/utils/CompactionLogger.java\nindex 5338aaa78..1145d981e 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/compaction/utils/CompactionLogger.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/compaction/utils/CompactionLogger.java\n\n@@ -40,7 +40,7 @@ public class CompactionLogger {\n   public CompactionLogger(String storageGroupDir, String storageGroupName) throws IOException {\n     logStream = new BufferedWriter(\n         new FileWriter(SystemFileFactory.INSTANCE.getFile(storageGroupDir,\n-            storageGroupName + COMPACTION_LOG_NAME), false));\n+            storageGroupName + COMPACTION_LOG_NAME), true));\n   }\n \n   public void close() throws IOException {\n"}}]}