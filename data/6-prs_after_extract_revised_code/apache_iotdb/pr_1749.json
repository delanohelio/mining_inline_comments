{"pr_number": 1749, "pr_title": "Avoid type conversion when encoding MeasureSchema", "pr_createdAt": "2020-09-22T06:15:11Z", "pr_url": "https://github.com/apache/iotdb/pull/1749", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU0Njc0Nw==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492546747", "bodyText": "byte i\uff0c why call this name", "author": "mychaow", "createdAt": "2020-09-22T08:07:42Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/CompressionType.java", "diffHunk": "@@ -52,6 +52,35 @@ public static CompressionType deserialize(short i) {\n     }\n   }\n \n+  /**\n+   * give an byte to return a compression type.\n+   *\n+   * @param i byte number\n+   * @return CompressionType\n+   */\n+  public static CompressionType byteToEnum(byte i) {", "originalCommit": "36b4f557004cacce8e92851a4c4a69cd68219760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2MzA5Ng==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492563096", "bodyText": "It's my negligence. I'll change it", "author": "yanhongwangg", "createdAt": "2020-09-22T08:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU0Njc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2e4338814390f0c32e95aed22943b81e68b4e0dd", "chunk": "diff --git a/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/CompressionType.java b/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/CompressionType.java\nindex 9503c89795..47143fc93d 100644\n--- a/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/CompressionType.java\n+++ b/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/CompressionType.java\n\n@@ -55,11 +58,14 @@ public enum CompressionType {\n   /**\n    * give an byte to return a compression type.\n    *\n-   * @param i byte number\n+   * @param compressor byte number\n    * @return CompressionType\n    */\n-  public static CompressionType byteToEnum(byte i) {\n-    switch (i) {\n+  public static CompressionType byteToEnum(byte compressor) {\n+    if (compressor >= 8) {\n+      throw new IllegalArgumentException(\"Invalid input: \" + compressor);\n+    }\n+    switch (compressor) {\n       case 0:\n         return UNCOMPRESSED;\n       case 1:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2NzE5OQ==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492567199", "bodyText": "better to check the size of this parameter as TSDataType", "author": "neuyilan", "createdAt": "2020-09-22T08:41:18Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/TSEncoding.java", "diffHunk": "@@ -51,6 +51,35 @@ public static TSEncoding deserialize(short i) {\n     }\r\n   }\r\n \r\n+  /**\r\n+   * give an byte to return a encoding type.\r\n+   *\r\n+   * @param i byte number\r\n+   * @return encoding type\r\n+   */\r\n+  public static TSEncoding byteToEnum(byte i) {\r\n+    switch (i) {\r", "originalCommit": "36b4f557004cacce8e92851a4c4a69cd68219760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwMDY5NQ==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492600695", "bodyText": "Copy that. I'll change it", "author": "yanhongwangg", "createdAt": "2020-09-22T09:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2NzE5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e4338814390f0c32e95aed22943b81e68b4e0dd", "chunk": "diff --git a/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/TSEncoding.java b/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/TSEncoding.java\nindex 3d2a2d291d..2c8e525691 100644\n--- a/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/TSEncoding.java\n+++ b/tsfile/src/main/java/org/apache/iotdb/tsfile/file/metadata/enums/TSEncoding.java\n\n@@ -54,11 +57,14 @@ public enum TSEncoding {\n   /**\n    * give an byte to return a encoding type.\n    *\n-   * @param i byte number\n+   * @param encoding byte number\n    * @return encoding type\n    */\n-  public static TSEncoding byteToEnum(byte i) {\n-    switch (i) {\n+  public static TSEncoding byteToEnum(byte encoding) {\n+    if (encoding >= 8) {\n+      throw new IllegalArgumentException(\"Invalid input: \" + encoding);\n+    }\n+    switch (encoding) {\n       case 0:\n         return PLAIN;\n       case 1:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2ODI0Ng==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492568246", "bodyText": "Add one UT of the serialize and deserialize method", "author": "neuyilan", "createdAt": "2020-09-22T08:43:04Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/MeasurementSchema.java", "diffHunk": "@@ -98,12 +98,11 @@ public static MeasurementSchema deserializeFrom(InputStream inputStream) throws\n \n     measurementSchema.measurementId = ReadWriteIOUtils.readString(inputStream);", "originalCommit": "36b4f557004cacce8e92851a4c4a69cd68219760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwMDkyNA==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r492600924", "bodyText": "OK, I'll add it", "author": "yanhongwangg", "createdAt": "2020-09-22T09:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2ODI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2e4338814390f0c32e95aed22943b81e68b4e0dd", "chunk": "diff --git a/tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/MeasurementSchema.java b/tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/MeasurementSchema.java\nindex c65415e6e7..d9ea02b5c5 100644\n--- a/tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/MeasurementSchema.java\n+++ b/tsfile/src/main/java/org/apache/iotdb/tsfile/write/schema/MeasurementSchema.java\n\n@@ -98,11 +98,11 @@ public class MeasurementSchema implements Comparable<MeasurementSchema>, Seriali\n \n     measurementSchema.measurementId = ReadWriteIOUtils.readString(inputStream);\n \n-    measurementSchema.type = ReadWriteIOUtils.readByte(inputStream);\n+    measurementSchema.type = ReadWriteIOUtils.readDataType(inputStream).enumToByte();\n \n-    measurementSchema.encoding = ReadWriteIOUtils.readByte(inputStream);\n+    measurementSchema.encoding = ReadWriteIOUtils.readEncoding(inputStream).enumToByte();\n \n-    measurementSchema.compressor = ReadWriteIOUtils.readByte(inputStream);\n+    measurementSchema.compressor = ReadWriteIOUtils.readCompressionType(inputStream).enumToByte();\n \n     int size = ReadWriteIOUtils.readInt(inputStream);\n     if (size > 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0Mjg1Mw==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r493242853", "bodyText": "Please add the Apache header.", "author": "HTHou", "createdAt": "2020-09-23T07:02:29Z", "path": "tsfile/src/test/java/org/apache/iotdb/tsfile/write/writer/MeasurementSchemaSerializeTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.apache.iotdb.tsfile.write.writer;\r", "originalCommit": "a02a588bf99148f562229b32f03e2666c04053c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyNjU4Nw==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r494226587", "bodyText": "copy that", "author": "yanhongwangg", "createdAt": "2020-09-24T11:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI0Mjg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6ed142e4958dcf20f59b46116a0729e8387cfb1d", "chunk": "diff --git a/tsfile/src/test/java/org/apache/iotdb/tsfile/write/writer/MeasurementSchemaSerializeTest.java b/tsfile/src/test/java/org/apache/iotdb/tsfile/write/writer/MeasurementSchemaSerializeTest.java\nindex 307dc71481..ac914fe694 100644\n--- a/tsfile/src/test/java/org/apache/iotdb/tsfile/write/writer/MeasurementSchemaSerializeTest.java\n+++ b/tsfile/src/test/java/org/apache/iotdb/tsfile/write/writer/MeasurementSchemaSerializeTest.java\n\n@@ -1,3 +1,21 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n package org.apache.iotdb.tsfile.write.writer;\n \n import static org.junit.Assert.assertEquals;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0NjQ4OA==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r493446488", "bodyText": "hm.. this method is overdesigned..\nIf you read InputStream.read(byte[]) method, you will find it actually just call byte c = (byte)read();\nSo, just return (byte) read() is ok.", "author": "jixuan1989", "createdAt": "2020-09-23T10:53:48Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/utils/ReadWriteIOUtils.java", "diffHunk": "@@ -82,6 +83,19 @@ public static boolean readBool(ByteBuffer buffer) {\n     return a == 1;\n   }\n \n+  /**\n+   * read a byte from inputStream.\n+   */\n+  public static byte readByte(InputStream inputStream) throws IOException {", "originalCommit": "a02a588bf99148f562229b32f03e2666c04053c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyNjYxNQ==", "url": "https://github.com/apache/iotdb/pull/1749#discussion_r494226615", "bodyText": "OK, thanks for your guidance", "author": "yanhongwangg", "createdAt": "2020-09-24T11:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0NjQ4OA=="}], "type": "inlineReview", "revised_code": {"commit": "6ed142e4958dcf20f59b46116a0729e8387cfb1d", "chunk": "diff --git a/tsfile/src/main/java/org/apache/iotdb/tsfile/utils/ReadWriteIOUtils.java b/tsfile/src/main/java/org/apache/iotdb/tsfile/utils/ReadWriteIOUtils.java\nindex cc9f00b0a7..4d55f16118 100644\n--- a/tsfile/src/main/java/org/apache/iotdb/tsfile/utils/ReadWriteIOUtils.java\n+++ b/tsfile/src/main/java/org/apache/iotdb/tsfile/utils/ReadWriteIOUtils.java\n\n@@ -83,19 +82,6 @@ public class ReadWriteIOUtils {\n     return a == 1;\n   }\n \n-  /**\n-   * read a byte from inputStream.\n-   */\n-  public static byte readByte(InputStream inputStream) throws IOException {\n-    byte[] bytes = new byte[BYTE_LEN];\n-    int readLen = inputStream.read(bytes);\n-    if (readLen != BYTE_LEN) {\n-      throw new IOException(String.format(\"Intend to read %d bytes but %d are actually returned\",\n-          BYTE_LEN, readLen));\n-    }\n-    return bytes[0];\n-  }\n-\n   /**\n    * read a byte from byteBuffer.\n    */\n"}}, {"oid": "2e4338814390f0c32e95aed22943b81e68b4e0dd", "url": "https://github.com/apache/iotdb/commit/2e4338814390f0c32e95aed22943b81e68b4e0dd", "message": "serializeTo", "committedDate": "2020-09-24T08:40:51Z", "type": "forcePushed"}, {"oid": "6ed142e4958dcf20f59b46116a0729e8387cfb1d", "url": "https://github.com/apache/iotdb/commit/6ed142e4958dcf20f59b46116a0729e8387cfb1d", "message": "serializeTo", "committedDate": "2020-09-24T11:03:34Z", "type": "forcePushed"}, {"oid": "895b59ef97aaafd0ca01f27568bed421301fc684", "url": "https://github.com/apache/iotdb/commit/895b59ef97aaafd0ca01f27568bed421301fc684", "message": "Cancel type conversion", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "b486b1ada40153aacf2cd19c3b67075138ef7aac", "url": "https://github.com/apache/iotdb/commit/b486b1ada40153aacf2cd19c3b67075138ef7aac", "message": "modify", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "602a2993746dc7f900751d6a9b21da79aa648c9a", "url": "https://github.com/apache/iotdb/commit/602a2993746dc7f900751d6a9b21da79aa648c9a", "message": "modify", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "0028bc89f7fa78c64fb1476230e2d07965467062", "url": "https://github.com/apache/iotdb/commit/0028bc89f7fa78c64fb1476230e2d07965467062", "message": "modify", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "b4add6136b00bb5f55891e498ab54d3edc1e616b", "url": "https://github.com/apache/iotdb/commit/b4add6136b00bb5f55891e498ab54d3edc1e616b", "message": "modify", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "655fe19b1c5ddf6caa38a55cba8df12b33c869bc", "url": "https://github.com/apache/iotdb/commit/655fe19b1c5ddf6caa38a55cba8df12b33c869bc", "message": "\u201cimprove\u201d", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "f38fb081ce3b50ad0e4636c457faa8c3ea03876c", "url": "https://github.com/apache/iotdb/commit/f38fb081ce3b50ad0e4636c457faa8c3ea03876c", "message": "\u201cimprove\u201d", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "9b036d285319d05896550af594fb5b538bb57f97", "url": "https://github.com/apache/iotdb/commit/9b036d285319d05896550af594fb5b538bb57f97", "message": "serializeTo", "committedDate": "2020-09-25T08:19:29Z", "type": "commit"}, {"oid": "9b036d285319d05896550af594fb5b538bb57f97", "url": "https://github.com/apache/iotdb/commit/9b036d285319d05896550af594fb5b538bb57f97", "message": "serializeTo", "committedDate": "2020-09-25T08:19:29Z", "type": "forcePushed"}]}