{"pr_number": 1698, "pr_title": "[IOTDB-850] check list user/role privilege ", "pr_createdAt": "2020-09-07T08:03:22Z", "pr_url": "https://github.com/apache/iotdb/pull/1698", "timeline": [{"oid": "f9d063b7a63848ac26c565b79ea526e2e708cc69", "url": "https://github.com/apache/iotdb/commit/f9d063b7a63848ac26c565b79ea526e2e708cc69", "message": "commit code", "committedDate": "2020-09-07T07:47:20Z", "type": "commit"}, {"oid": "cc4cf8fa0c1940535873d909facc2d7544f3eba4", "url": "https://github.com/apache/iotdb/commit/cc4cf8fa0c1940535873d909facc2d7544f3eba4", "message": "edit", "committedDate": "2020-09-07T07:49:04Z", "type": "commit"}, {"oid": "c80d274f487d3edcc06a3ac45aa72391279575d8", "url": "https://github.com/apache/iotdb/commit/c80d274f487d3edcc06a3ac45aa72391279575d8", "message": "commit code", "committedDate": "2020-09-07T07:55:42Z", "type": "commit"}, {"oid": "e6f48efb43b96e8ccef505f3cce3cae3e5c18b88", "url": "https://github.com/apache/iotdb/commit/e6f48efb43b96e8ccef505f3cce3cae3e5c18b88", "message": "edit", "committedDate": "2020-09-07T07:57:10Z", "type": "commit"}, {"oid": "3d5c4a4d0ce7a5be921b9bd5d5b567ded6fcc70c", "url": "https://github.com/apache/iotdb/commit/3d5c4a4d0ce7a5be921b9bd5d5b567ded6fcc70c", "message": "Merge branch 'master' into master_list_user", "committedDate": "2020-09-07T08:04:23Z", "type": "commit"}, {"oid": "aade19f9c195c06499dee8d981e05d5977b4d515", "url": "https://github.com/apache/iotdb/commit/aade19f9c195c06499dee8d981e05d5977b4d515", "message": "commit code", "committedDate": "2020-09-07T08:33:34Z", "type": "commit"}, {"oid": "4a3ffd5c08bb85aa856a715c1c180eb06c89e0e1", "url": "https://github.com/apache/iotdb/commit/4a3ffd5c08bb85aa856a715c1c180eb06c89e0e1", "message": "edit", "committedDate": "2020-09-07T08:33:34Z", "type": "commit"}, {"oid": "5f6472fee21b50a670d6dcd4b117106ff8c73bc5", "url": "https://github.com/apache/iotdb/commit/5f6472fee21b50a670d6dcd4b117106ff8c73bc5", "message": "edit username", "committedDate": "2020-09-07T08:33:34Z", "type": "commit"}, {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d", "url": "https://github.com/apache/iotdb/commit/b093fbe89c2309caeeca0221cf9cefcd7531e42d", "message": "Merge branch 'master_list_user' of github.com:kelggu/incubator-iotdb into master_list_user", "committedDate": "2020-09-07T08:38:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r485299335", "bodyText": "Does every physical plan have to have a userName?\nfor OOP, I do not think its a good design.", "author": "neuyilan", "createdAt": "2020-09-09T02:24:49Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "diffHunk": "@@ -48,6 +48,7 @@\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n+  protected String userName;", "originalCommit": "b093fbe89c2309caeeca0221cf9cefcd7531e42d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyNzAxMQ==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r485327011", "bodyText": "Yes, I will change it to AuthorPlan only. Thank you for your comment!", "author": "haimeiguo", "createdAt": "2020-09-09T04:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE0MjM2MA==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r489142360", "bodyText": "I have a different opinion. Every physical plan is issued by a user and keeping this information will help us tracking user behaviors in the future.", "author": "jt2594838", "createdAt": "2020-09-16T03:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "0839efb75458ec6ed8daa2648526009ddb268c9d", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java\nindex 4001841681..d6cf9c992e 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java\n\n@@ -48,7 +48,6 @@ public abstract class PhysicalPlan {\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n-  protected String userName;\n   private boolean isQuery;\n   private Operator.OperatorType operatorType;\n   private static final int NULL_VALUE_LEN = -1;\n"}}, {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d", "url": "https://github.com/apache/iotdb/commit/0839efb75458ec6ed8daa2648526009ddb268c9d", "message": "edited username to author plan only; add list role privilege check", "committedDate": "2020-09-10T02:10:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzcwMA==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133700", "bodyText": "delete the blank space.", "author": "mychaow", "createdAt": "2020-09-10T07:46:12Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1059,7 +1060,7 @@ protected boolean deleteStorageGroups(DeleteStorageGroupPlan deleteStorageGroupP\n     }\n     return true;\n   }\n-\n+  ", "originalCommit": "0839efb75458ec6ed8daa2648526009ddb268c9d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 4e8f04285c..731ec4123e 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -1060,7 +1060,7 @@ public class PlanExecutor implements IPlanExecutor {\n     }\n     return true;\n   }\n-  \n+\n   protected QueryDataSet processAuthorQuery(AuthorPlan plan)\n       throws QueryProcessException {\n     AuthorType authorType = plan.getAuthorType();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzk1Mw==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133953", "bodyText": "delete the blank space.", "author": "mychaow", "createdAt": "2020-09-10T07:46:38Z", "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java", "diffHunk": "@@ -793,15 +793,19 @@ public void testListRolePrivileges() throws ClassNotFoundException, SQLException\n \n     try {\n       adminStmt.execute(\"CREATE ROLE role1\");\n-      adminStmt.execute(\n+      ResultSet resultSet = adminStmt.executeQuery(\"LIST ROLE PRIVILEGES role1\");\n+      String ans = \"\";\n+      try {\n+        //not granted list role privilege, should return empty\n+        validateResultSet(resultSet, ans);\n+\n+        adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.a.b.c\");\n-      adminStmt.execute(\n+        adminStmt.execute(", "originalCommit": "0839efb75458ec6ed8daa2648526009ddb268c9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQyMw==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717423", "bodyText": "done. Thank you :)", "author": "haimeiguo", "createdAt": "2020-09-11T01:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzk1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "chunk": "diff --git a/server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java b/server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java\nindex 4a49979937..9970b08e6e 100644\n--- a/server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java\n+++ b/server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java\n\n@@ -801,7 +801,7 @@ public class IoTDBAuthorizationIT {\n \n         adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.a.b.c\");\n-        adminStmt.execute(\n+      adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.d.b.c\");\n         resultSet = adminStmt.executeQuery(\"LIST ROLE PRIVILEGES role1\");\n         ans = \"root.a.b.c : INSERT_TIMESERIES READ_TIMESERIES DELETE_TIMESERIES,\\n\"\n"}}, {"oid": "1590c1f4f5ff48694a291978cfd07e07ada46d3a", "url": "https://github.com/apache/iotdb/commit/1590c1f4f5ff48694a291978cfd07e07ada46d3a", "message": "add loginUserName", "committedDate": "2020-09-10T09:33:31Z", "type": "commit"}, {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "url": "https://github.com/apache/iotdb/commit/2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "message": "delete space", "committedDate": "2020-09-10T10:01:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzA4MA==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717080", "bodyText": "What is this index for?", "author": "jt2594838", "createdAt": "2020-09-11T01:15:05Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege\n+    boolean hasListUserPrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), paths, plan.getOperatorType(), plan.getLoginUserName());\n+\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_USER, false));\n     typeList.add(TSDataType.TEXT);\n-    int index = 0;\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    if (!hasListUserPrivilege) {\n+      return dataSet;\n+    }\n+\n+    List<String> userList = authorizer.listAllUsers();\n+    int index = 0;", "originalCommit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 731ec4123e..cc321b8626 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -1126,25 +1126,21 @@ public class PlanExecutor implements IPlanExecutor {\n   }\n \n   private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n-    List<PartialPath> paths = new ArrayList<>();\n-    paths.add(plan.getNodeName());\n-    // check if current user is granted list_user privilege\n-    boolean hasListUserPrivilege = AuthorityChecker\n-        .check(plan.getLoginUserName(), paths, plan.getOperatorType(), plan.getLoginUserName());\n-\n+    int index = 0;\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_USER, false));\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n \n+    // check if current user is granted list_user privilege\n+    boolean hasListUserPrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), Collections.singletonList((plan.getNodeName())), plan.getOperatorType(), plan.getLoginUserName());\n     if (!hasListUserPrivilege) {\n       return dataSet;\n     }\n \n     List<String> userList = authorizer.listAllUsers();\n-    int index = 0;\n-\n     for (String user : userList) {\n       RowRecord record = new RowRecord(index++);\n       Field field = new Field(TSDataType.TEXT);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzM4MQ==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717381", "bodyText": "Better replaced with Collections.singletonList()", "author": "jt2594838", "createdAt": "2020-09-11T01:16:08Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege", "originalCommit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 731ec4123e..cc321b8626 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -1126,25 +1126,21 @@ public class PlanExecutor implements IPlanExecutor {\n   }\n \n   private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n-    List<PartialPath> paths = new ArrayList<>();\n-    paths.add(plan.getNodeName());\n-    // check if current user is granted list_user privilege\n-    boolean hasListUserPrivilege = AuthorityChecker\n-        .check(plan.getLoginUserName(), paths, plan.getOperatorType(), plan.getLoginUserName());\n-\n+    int index = 0;\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_USER, false));\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n \n+    // check if current user is granted list_user privilege\n+    boolean hasListUserPrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), Collections.singletonList((plan.getNodeName())), plan.getOperatorType(), plan.getLoginUserName());\n     if (!hasListUserPrivilege) {\n       return dataSet;\n     }\n \n     List<String> userList = authorizer.listAllUsers();\n-    int index = 0;\n-\n     for (String user : userList) {\n       RowRecord record = new RowRecord(index++);\n       Field field = new Field(TSDataType.TEXT);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQ5Nw==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717497", "bodyText": "Better replaced with Collections.emptyList().", "author": "jt2594838", "createdAt": "2020-09-11T01:16:36Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1098,13 +1099,21 @@ protected QueryDataSet processAuthorQuery(AuthorPlan plan)\n     return dataSet;\n   }\n \n-  private ListDataSet executeListRole() {\n+  private ListDataSet executeListRole(AuthorPlan plan) throws AuthException {\n     int index = 0;\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_ROLE, false));\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    boolean hasListRolePrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), new ArrayList<>(), plan.getOperatorType(), plan.getLoginUserName());", "originalCommit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 731ec4123e..cc321b8626 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -1107,9 +1107,9 @@ public class PlanExecutor implements IPlanExecutor {\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n \n+    // check if current user is granted list_role privilege\n     boolean hasListRolePrivilege = AuthorityChecker\n-        .check(plan.getLoginUserName(), new ArrayList<>(), plan.getOperatorType(), plan.getLoginUserName());\n-\n+        .check(plan.getLoginUserName(), Collections.emptyList(), plan.getOperatorType(), plan.getLoginUserName());\n     if (!hasListRolePrivilege) {\n       return dataSet;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxODA0Nw==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486718047", "bodyText": "I think maybe we can push loginUserName down to PhysicalPlan. It is often meaningful to know who issued this plan.", "author": "jt2594838", "createdAt": "2020-09-11T01:18:43Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java", "diffHunk": "@@ -39,12 +39,13 @@\n public class AuthorPlan extends PhysicalPlan {\n \n   private AuthorOperator.AuthorType authorType;\n-  private String userName;\n   private String roleName;\n   private String password;\n   private String newPassword;\n   private Set<Integer> permissions;\n   private PartialPath nodeName;\n+  private String userName;\n+  private String loginUserName;", "originalCommit": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyMzYwOA==", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r487023608", "bodyText": "done. thank you!\nindex is for rowRocord, it was there before my edit.", "author": "haimeiguo", "createdAt": "2020-09-11T12:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxODA0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java\nindex 6475ad298f..b43bee9688 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java\n\n@@ -45,7 +45,6 @@ public class AuthorPlan extends PhysicalPlan {\n   private Set<Integer> permissions;\n   private PartialPath nodeName;\n   private String userName;\n-  private String loginUserName;\n \n   /**\n    * AuthorPlan Constructor.\n"}}, {"oid": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "url": "https://github.com/apache/iotdb/commit/5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "message": "moved loginUserName to physical plan", "committedDate": "2020-09-11T04:05:04Z", "type": "commit"}]}