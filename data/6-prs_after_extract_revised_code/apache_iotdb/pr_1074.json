{"pr_number": 1074, "pr_title": "Fix OOM", "pr_createdAt": "2020-04-20T13:43:04Z", "pr_url": "https://github.com/apache/iotdb/pull/1074", "timeline": [{"oid": "fadc454475973bed14d4ac991ed6c1086a08ee30", "url": "https://github.com/apache/iotdb/commit/fadc454475973bed14d4ac991ed6c1086a08ee30", "message": "modify new memtable size estimation and limit the total memoty size of write log to up to allocate for write size / 10", "committedDate": "2020-04-20T13:29:52Z", "type": "commit"}, {"oid": "74446b3595e0e8362e0293221a345f0fde8d6412", "url": "https://github.com/apache/iotdb/commit/74446b3595e0e8362e0293221a345f0fde8d6412", "message": "merge master", "committedDate": "2020-04-20T13:38:41Z", "type": "commit"}, {"oid": "52f3b8e3d45b2802c68e43153d6726b83dbe65e9", "url": "https://github.com/apache/iotdb/commit/52f3b8e3d45b2802c68e43153d6726b83dbe65e9", "message": "update dynamic adapter equation", "committedDate": "2020-04-20T13:54:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgwMjQ4Ng==", "url": "https://github.com/apache/iotdb/pull/1074#discussion_r411802486", "bodyText": "Hi, this may slow down the write performance of TEXT data heavily. It's better to do sampling or calculate the constant header of Binary and byte[].", "author": "qiaojialin", "createdAt": "2020-04-21T01:29:08Z", "path": "server/src/main/java/org/apache/iotdb/db/utils/MemUtils.java", "diffHunk": "@@ -88,7 +86,7 @@ public static long getRecordSize(BatchInsertPlan batchInsertPlan, int start, int\n         case TEXT:\n           memSize += (end - start) * 8L;\n           for (int j = start; j < end; j++) {\n-            memSize += ((Binary[]) batchInsertPlan.getColumns()[i])[j].getLength();\n+            memSize += RamUsageEstimator.sizeOf(((Binary[]) batchInsertPlan.getColumns()[i])[j]);", "originalCommit": "52f3b8e3d45b2802c68e43153d6726b83dbe65e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3MTYwMQ==", "url": "https://github.com/apache/iotdb/pull/1074#discussion_r411971601", "bodyText": "Agreed.", "author": "jt2594838", "createdAt": "2020-04-21T08:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgwMjQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExMzY2MA==", "url": "https://github.com/apache/iotdb/pull/1074#discussion_r412113660", "bodyText": "I have modified the way to estimate the size of Binary. In new way, the efficiency is nearly same with the origin way which approved that it'll not affect the performance of the engine.", "author": "fanhualta", "createdAt": "2020-04-21T11:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgwMjQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "7fbab0b03c1edf0649129e142474dfdc90528dcc", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/utils/MemUtils.java b/server/src/main/java/org/apache/iotdb/db/utils/MemUtils.java\nindex edeb1f10c..7946ba6b6 100644\n--- a/server/src/main/java/org/apache/iotdb/db/utils/MemUtils.java\n+++ b/server/src/main/java/org/apache/iotdb/db/utils/MemUtils.java\n\n@@ -86,7 +90,7 @@ public class MemUtils {\n         case TEXT:\n           memSize += (end - start) * 8L;\n           for (int j = start; j < end; j++) {\n-            memSize += RamUsageEstimator.sizeOf(((Binary[]) batchInsertPlan.getColumns()[i])[j]);\n+            memSize += getBinarySize(((Binary[]) batchInsertPlan.getColumns()[i])[j]);\n           }\n           break;\n         default:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3MDYxMA==", "url": "https://github.com/apache/iotdb/pull/1074#discussion_r411970610", "bodyText": "This import is added but I cannot find usages of it in this PR, so maybe it is unused?", "author": "jt2594838", "createdAt": "2020-04-21T08:13:17Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -44,6 +44,7 @@\n import org.apache.iotdb.db.conf.IoTDBDescriptor;\n import org.apache.iotdb.db.conf.directories.DirectoryManager;\n import org.apache.iotdb.db.engine.StorageEngine;\n+import org.apache.iotdb.db.engine.cache.RamUsageEstimator;", "originalCommit": "52f3b8e3d45b2802c68e43153d6726b83dbe65e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExNjEzOA==", "url": "https://github.com/apache/iotdb/pull/1074#discussion_r412116138", "bodyText": "fixed", "author": "fanhualta", "createdAt": "2020-04-21T11:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3MDYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "f8797d85b1cf809231e9565fc23a95a5af89f980", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\nindex 3dc316579..1ac1e85ac 100755\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java\n\n@@ -44,7 +44,6 @@ import org.apache.iotdb.db.conf.IoTDBConstant;\n import org.apache.iotdb.db.conf.IoTDBDescriptor;\n import org.apache.iotdb.db.conf.directories.DirectoryManager;\n import org.apache.iotdb.db.engine.StorageEngine;\n-import org.apache.iotdb.db.engine.cache.RamUsageEstimator;\n import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n import org.apache.iotdb.db.engine.flush.TsFileFlushPolicy;\n import org.apache.iotdb.db.engine.merge.manage.MergeManager;\n"}}, {"oid": "7fbab0b03c1edf0649129e142474dfdc90528dcc", "url": "https://github.com/apache/iotdb/commit/7fbab0b03c1edf0649129e142474dfdc90528dcc", "message": "modify text size eatimation considering efficiency", "committedDate": "2020-04-21T11:44:31Z", "type": "commit"}, {"oid": "f8797d85b1cf809231e9565fc23a95a5af89f980", "url": "https://github.com/apache/iotdb/commit/f8797d85b1cf809231e9565fc23a95a5af89f980", "message": "remove useless import", "committedDate": "2020-04-21T11:50:18Z", "type": "commit"}, {"oid": "f8797d85b1cf809231e9565fc23a95a5af89f980", "url": "https://github.com/apache/iotdb/commit/f8797d85b1cf809231e9565fc23a95a5af89f980", "message": "remove useless import", "committedDate": "2020-04-21T11:50:18Z", "type": "forcePushed"}]}