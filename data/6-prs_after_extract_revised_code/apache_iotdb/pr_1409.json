{"pr_number": 1409, "pr_title": "Support partition removal", "pr_createdAt": "2020-06-23T04:25:42Z", "pr_url": "https://github.com/apache/iotdb/pull/1409", "timeline": [{"oid": "6a5c090c58fe52572aadb054447ac34541b8c2a4", "url": "https://github.com/apache/iotdb/commit/6a5c090c58fe52572aadb054447ac34541b8c2a4", "message": "support partition removal", "committedDate": "2020-06-23T04:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY4NzE0Mg==", "url": "https://github.com/apache/iotdb/pull/1409#discussion_r444687142", "bodyText": "still 87?", "author": "jixuan1989", "createdAt": "2020-06-24T07:05:22Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java", "diffHunk": "@@ -151,6 +151,7 @@ private SQLConstant() {\n   public static final int TOK_LOAD_CONFIGURATION_LOCAL = 86;\n \n   public static final int TOK_SHOW_MERGE_STATUS = 87;\n+  public static final int TOK_DELETE_PARTITION = 87;", "originalCommit": "6a5c090c58fe52572aadb054447ac34541b8c2a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1MTA3NQ==", "url": "https://github.com/apache/iotdb/pull/1409#discussion_r444751075", "bodyText": "fixed", "author": "jt2594838", "createdAt": "2020-06-24T09:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY4NzE0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fa0d8522096b7125412526f3f506420b70dc618e", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java b/server/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java\nindex db7ff5f15c..596b708df5 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java\n\n@@ -151,7 +151,7 @@ public class SQLConstant {\n   public static final int TOK_LOAD_CONFIGURATION_LOCAL = 86;\n \n   public static final int TOK_SHOW_MERGE_STATUS = 87;\n-  public static final int TOK_DELETE_PARTITION = 87;\n+  public static final int TOK_DELETE_PARTITION = 88;\n \n   public static final Map<Integer, String> tokenSymbol = new HashMap<>();\n   public static final Map<Integer, String> tokenNames = new HashMap<>();\n"}}, {"oid": "dc62a6a826631a524c7342f4d50ae46fbf601d4d", "url": "https://github.com/apache/iotdb/commit/dc62a6a826631a524c7342f4d50ae46fbf601d4d", "message": "Merge remote-tracking branch 'origin/master' into add_partition_removal", "committedDate": "2020-06-24T07:52:56Z", "type": "commit"}, {"oid": "cce6ee30134e172553d5fb709e86d09063304dc5", "url": "https://github.com/apache/iotdb/commit/cce6ee30134e172553d5fb709e86d09063304dc5", "message": "extract duplicated codes into a  function", "committedDate": "2020-06-24T08:37:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDQ3NQ==", "url": "https://github.com/apache/iotdb/pull/1409#discussion_r444754475", "bodyText": "I notice you add storageGroupSubTasks and storageGroupMainTasks in 6.9. When to clear the finished tasks?", "author": "jixuan1989", "createdAt": "2020-06-24T09:09:31Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -2410,4 +2410,58 @@ public boolean isFileAlreadyExist(TsFileResource tsFileResource, long partitionN\n \n     void call(TsFileResource caller);\n   }\n+\n+  /**\n+   * remove all partitions that satisfy a filter.\n+   * @param filter\n+   */\n+  public void removePartitions(TimePartitionFilter filter) {\n+    // this requires blocking all other activities\n+    insertLock.writeLock().lock();\n+    mergeLock.writeLock().lock();\n+    try {\n+      // abort ongoing merges\n+      MergeManager.getINSTANCE().abortMerge(storageGroupName);", "originalCommit": "cce6ee30134e172553d5fb709e86d09063304dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5ODgyMw==", "url": "https://github.com/apache/iotdb/pull/1409#discussion_r444798823", "bodyText": "There is a TaskCleanerThread in MergeManager.", "author": "jt2594838", "createdAt": "2020-06-24T10:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDQ3NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fa0d8522096b7125412526f3f506420b70dc618e", "url": "https://github.com/apache/iotdb/commit/fa0d8522096b7125412526f3f506420b70dc618e", "message": "fix grammar and constant", "committedDate": "2020-06-24T09:24:58Z", "type": "commit"}, {"oid": "e87607f3bce3976934c9ddd20c860c7dfba2f5bc", "url": "https://github.com/apache/iotdb/commit/e87607f3bce3976934c9ddd20c860c7dfba2f5bc", "message": "fix grammar", "committedDate": "2020-06-24T10:53:43Z", "type": "commit"}, {"oid": "63736be10bd9340790c80dd1bedc37d136ad4bab", "url": "https://github.com/apache/iotdb/commit/63736be10bd9340790c80dd1bedc37d136ad4bab", "message": "Merge branch 'master' into add_partition_removal\n\n# Conflicts:\n#\tserver/src/main/antlr4/org/apache/iotdb/db/qp/strategy/SqlBase.g4\n#\tserver/src/main/java/org/apache/iotdb/db/qp/Planner.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/logical/Operator.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/strategy/LogicalGenerator.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "committedDate": "2020-06-28T09:06:28Z", "type": "commit"}, {"oid": "e207add2fcccf331eb173db169bb30fd6bab8136", "url": "https://github.com/apache/iotdb/commit/e207add2fcccf331eb173db169bb30fd6bab8136", "message": "Merge branch 'master' into add_partition_removal\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "committedDate": "2020-06-29T02:20:01Z", "type": "commit"}, {"oid": "f35286fb9b5ec44a57451de07cf4f881acde9ddb", "url": "https://github.com/apache/iotdb/commit/f35286fb9b5ec44a57451de07cf4f881acde9ddb", "message": "Merge branch 'master' into add_partition_removal\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/qp/constant/SQLConstant.java\n#\tserver/src/main/java/org/apache/iotdb/db/qp/logical/Operator.java", "committedDate": "2020-06-29T03:47:56Z", "type": "commit"}]}