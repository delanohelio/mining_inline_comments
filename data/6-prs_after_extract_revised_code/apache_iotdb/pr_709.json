{"pr_number": 709, "pr_title": "[IOTDB-401]Correct the calculation of a chunk if there is no data in the chunk", "pr_createdAt": "2020-01-06T13:51:54Z", "pr_url": "https://github.com/apache/iotdb/pull/709", "timeline": [{"oid": "6d65b743d62a2600159b5cd1a246faa422565424", "url": "https://github.com/apache/iotdb/commit/6d65b743d62a2600159b5cd1a246faa422565424", "message": "IOTDB-401, skip the size of a chunk header if the chunk has no data points", "committedDate": "2020-01-06T13:47:06Z", "type": "commit"}, {"oid": "99f9ef9e2390750425623159dad4d7d6768d1a4d", "url": "https://github.com/apache/iotdb/commit/99f9ef9e2390750425623159dad4d7d6768d1a4d", "message": "Merge branch 'master' of github.com:apache/incubator-iotdb", "committedDate": "2020-01-06T13:47:36Z", "type": "commit"}, {"oid": "30e562f7573284f427f94f8910e3ebe171915839", "url": "https://github.com/apache/iotdb/commit/30e562f7573284f427f94f8910e3ebe171915839", "message": "support jdk8", "committedDate": "2020-01-06T14:09:09Z", "type": "commit"}, {"oid": "661d27bc06ffaec7f776b9921df1f6838c04d925", "url": "https://github.com/apache/iotdb/commit/661d27bc06ffaec7f776b9921df1f6838c04d925", "message": "fix code smell", "committedDate": "2020-01-06T14:21:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjU3Mg==", "url": "https://github.com/apache/iotdb/pull/709#discussion_r363636572", "bodyText": "Is this check necessary?", "author": "qiaojialin", "createdAt": "2020-01-07T08:27:48Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/chunk/ChunkWriterImpl.java", "diffHunk": "@@ -231,6 +231,9 @@ public long estimateMaxSeriesMemSize() {\n \n   @Override\n   public long getCurrentChunkSize() {\n+    if (this.getCurrentDataSize() == 0) {", "originalCommit": "661d27bc06ffaec7f776b9921df1f6838c04d925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY0Njk1NA==", "url": "https://github.com/apache/iotdb/pull/709#discussion_r363646954", "bodyText": "You may save the calculation result and use it in line238 to avoid duplicated calculation.\nAnd if all chunks in a chunk group are empty, this chunk group should not be flushed into the file, which will generate an empty ChunkGroupMetadata and waste some space.", "author": "jt2594838", "createdAt": "2020-01-07T08:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg1MzA0NQ==", "url": "https://github.com/apache/iotdb/pull/709#discussion_r363853045", "bodyText": "this.getCurrentDataSize() actually is pageBuffer.size() while pageBuffer call outputstream.count.\nTherefore, I remove getCurrentDataSize() and use pageBuffer.size() instead.\n@qiaojialin , yes I think so.\nNo matter whether you check the serialized size in flushAll... method, this method is needed and should check the data size here.", "author": "jixuan1989", "createdAt": "2020-01-07T17:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjU3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d1b833d16192f0ab8eef8e726ed4d1288d706f33", "chunk": "diff --git a/tsfile/src/main/java/org/apache/iotdb/tsfile/write/chunk/ChunkWriterImpl.java b/tsfile/src/main/java/org/apache/iotdb/tsfile/write/chunk/ChunkWriterImpl.java\nindex 8d116127b5..befd74d360 100644\n--- a/tsfile/src/main/java/org/apache/iotdb/tsfile/write/chunk/ChunkWriterImpl.java\n+++ b/tsfile/src/main/java/org/apache/iotdb/tsfile/write/chunk/ChunkWriterImpl.java\n\n@@ -231,12 +231,11 @@ public class ChunkWriterImpl implements IChunkWriter {\n \n   @Override\n   public long getCurrentChunkSize() {\n-    if (this.getCurrentDataSize() == 0) {\n+    if (pageBuffer.size() == 0) {\n       return 0;\n     }\n     // return the serialized size of the chunk header + all pages\n-    return ChunkHeader.getSerializedSize(measurementSchema.getMeasurementId()) + this\n-        .getCurrentDataSize();\n+    return ChunkHeader.getSerializedSize(measurementSchema.getMeasurementId()) + pageBuffer.size();\n   }\n \n   @Override\n"}}, {"oid": "d1b833d16192f0ab8eef8e726ed4d1288d706f33", "url": "https://github.com/apache/iotdb/commit/d1b833d16192f0ab8eef8e726ed4d1288d706f33", "message": "in ChunkWriterImpl, use pageBuffer.size() to replace ChunkWriterImpl", "committedDate": "2020-01-07T16:58:22Z", "type": "commit"}, {"oid": "c074c9a21b82ccaac8db95898b85cea7ba2a77b0", "url": "https://github.com/apache/iotdb/commit/c074c9a21b82ccaac8db95898b85cea7ba2a77b0", "message": "fix sonarCloud reported bug", "committedDate": "2020-01-08T09:13:14Z", "type": "commit"}]}