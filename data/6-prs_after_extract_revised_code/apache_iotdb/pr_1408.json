{"pr_number": 1408, "pr_title": "move getSeriesSchemas to MManager", "pr_createdAt": "2020-06-23T03:50:40Z", "pr_url": "https://github.com/apache/iotdb/pull/1408", "timeline": [{"oid": "aa102ba0fa932d79ec9c0da02282d7f8503be550", "url": "https://github.com/apache/iotdb/commit/aa102ba0fa932d79ec9c0da02282d7f8503be550", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-23T04:03:27Z", "type": "forcePushed"}, {"oid": "0d5105b438986ff1e68e38f085ca591db3a5b162", "url": "https://github.com/apache/iotdb/commit/0d5105b438986ff1e68e38f085ca591db3a5b162", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-23T04:15:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1MTQ3NA==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444051474", "bodyText": "No need to set this, the insertplan will be gc soon", "author": "qiaojialin", "createdAt": "2020-06-23T08:27:42Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1800,4 +1807,207 @@ private void checkMTreeModified() {\n       }\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemasAndLock(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n+    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n+    if (plan instanceof InsertPlan) {\n+      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else if (plan instanceof InsertTabletPlan) {\n+      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else {\n+      throw new MetadataException(String.format(\n+        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n+    }", "originalCommit": "0d5105b438986ff1e68e38f085ca591db3a5b162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4OTY0NA==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444589644", "bodyText": "ok", "author": "mychaow", "createdAt": "2020-06-24T01:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1MTQ3NA=="}], "type": "inlineReview", "revised_code": {"commit": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex 591d0a759..573227741 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1823,15 +1807,6 @@ public class MManager {\n     MNode deviceNode = null;\n     // 1. get device node\n     deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n-    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n-    if (plan instanceof InsertPlan) {\n-      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else if (plan instanceof InsertTabletPlan) {\n-      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else {\n-      throw new MetadataException(String.format(\n-        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n-    }\n \n     // 2. get schema of each measurement\n     for (int i = 0; i < measurementList.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA1OTkwNw==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444059907", "bodyText": "what if the measurement already exists?\nadd\nelse {\nisCreated = true\n}\nbesides\uff0ccombine these to one line", "author": "qiaojialin", "createdAt": "2020-06-23T08:41:09Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1800,4 +1807,207 @@ private void checkMTreeModified() {\n       }\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemasAndLock(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n+    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n+    if (plan instanceof InsertPlan) {\n+      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else if (plan instanceof InsertTabletPlan) {\n+      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else {\n+      throw new MetadataException(String.format(\n+        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n+    }\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        boolean isCreated = false;\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+          isCreated = true;\n+        }", "originalCommit": "0d5105b438986ff1e68e38f085ca591db3a5b162", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex 591d0a759..573227741 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1823,15 +1807,6 @@ public class MManager {\n     MNode deviceNode = null;\n     // 1. get device node\n     deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n-    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n-    if (plan instanceof InsertPlan) {\n-      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else if (plan instanceof InsertTabletPlan) {\n-      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else {\n-      throw new MetadataException(String.format(\n-        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n-    }\n \n     // 2. get schema of each measurement\n     for (int i = 0; i < measurementList.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MDQ3Mg==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444060472", "bodyText": "insertDataType", "author": "qiaojialin", "createdAt": "2020-06-23T08:42:11Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1800,4 +1807,207 @@ private void checkMTreeModified() {\n       }\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemasAndLock(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n+    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n+    if (plan instanceof InsertPlan) {\n+      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else if (plan instanceof InsertTabletPlan) {\n+      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else {\n+      throw new MetadataException(String.format(\n+        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n+    }\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        boolean isCreated = false;\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+          isCreated = true;\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        if (plan instanceof InsertTabletPlan) {\n+          TSDataType trueType = getTypeInLoc(plan, i);", "originalCommit": "0d5105b438986ff1e68e38f085ca591db3a5b162", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex 591d0a759..573227741 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1823,15 +1807,6 @@ public class MManager {\n     MNode deviceNode = null;\n     // 1. get device node\n     deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n-    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n-    if (plan instanceof InsertPlan) {\n-      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else if (plan instanceof InsertTabletPlan) {\n-      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else {\n-      throw new MetadataException(String.format(\n-        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n-    }\n \n     // 2. get schema of each measurement\n     for (int i = 0; i < measurementList.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjY2NQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444062665", "bodyText": "Is the isCreated needed? If a measurement does not exist, we already throw an exception", "author": "qiaojialin", "createdAt": "2020-06-23T08:45:48Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1800,4 +1807,207 @@ private void checkMTreeModified() {\n       }\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemasAndLock(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n+    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n+    if (plan instanceof InsertPlan) {\n+      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else if (plan instanceof InsertTabletPlan) {\n+      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n+    } else {\n+      throw new MetadataException(String.format(\n+        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n+    }\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        boolean isCreated = false;\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+          isCreated = true;\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        if (plan instanceof InsertTabletPlan) {\n+          TSDataType trueType = getTypeInLoc(plan, i);\n+          if (measurementNode.getSchema().getType() != trueType) {\n+            logger.warn(\"Datatype mismatch, Insert measurement {} type {}, metadata tree type {}\",\n+              measurementList[i], trueType, measurementNode.getSchema().getType());\n+            if (!config.isEnablePartialInsert()) {\n+              throw new MetadataException(String.format(\n+                \"Datatype mismatch, Insert measurement %s type %s, metadata tree type %s\",\n+                measurementList[i], measurementNode.getSchema().getType(),\n+                trueType));\n+            } else {\n+              // mark failed measurement\n+              ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+              continue;\n+            }\n+          }\n+        }\n+\n+        if ((plan instanceof InsertPlan) && isCreated) {", "originalCommit": "0d5105b438986ff1e68e38f085ca591db3a5b162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzI4Mw==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444593283", "bodyText": "if a measurement exist, but the value is string (like jdbc insert), we need to convert the value to the true type", "author": "mychaow", "createdAt": "2020-06-24T01:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2MjY2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex 591d0a759..573227741 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1823,15 +1807,6 @@ public class MManager {\n     MNode deviceNode = null;\n     // 1. get device node\n     deviceNode = getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n-    // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n-    if (plan instanceof InsertPlan) {\n-      ((InsertPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else if (plan instanceof InsertTabletPlan) {\n-      ((InsertTabletPlan) plan).setDeviceId(deviceNode.getFullPath());\n-    } else {\n-      throw new MetadataException(String.format(\n-        \"Only support insert and insertTablets, deviceId[%s], plans [%s]\", deviceId, plan.getOperatorType()));\n-    }\n \n     // 2. get schema of each measurement\n     for (int i = 0; i < measurementList.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MDI2OQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444080269", "bodyText": "remove these two methods and use mManager.getSeriesSchemasAndLock direclty", "author": "qiaojialin", "createdAt": "2020-06-23T09:13:36Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -907,6 +907,17 @@ public void delete(Path path, long timestamp) throws QueryProcessException {\n     }\n   }\n \n+  protected MeasurementSchema[] getSeriesSchemas(InsertPlan insertPlan)\n+    throws MetadataException {\n+    return mManager.getSeriesSchemasAndLock(insertPlan.getDeviceId(), insertPlan.getMeasurements(), insertPlan);\n+  }\n+\n+  protected MeasurementSchema[] getSeriesSchemas(InsertTabletPlan insertTabletPlan)\n+    throws MetadataException {\n+    return mManager.getSeriesSchemasAndLock(insertTabletPlan.getDeviceId(),\n+      insertTabletPlan.getMeasurements(), insertTabletPlan);\n+  }\n+", "originalCommit": "0d5105b438986ff1e68e38f085ca591db3a5b162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODkyOQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444588929", "bodyText": "These functions is just for cluster version, cluster version will override this two function.", "author": "mychaow", "createdAt": "2020-06-24T01:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MDI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "af3f72c664ead46a244da81bf0cf4293a5cd031b", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 169ac5d6e..c5047f65d 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -909,18 +843,19 @@ public class PlanExecutor implements IPlanExecutor {\n \n   protected MeasurementSchema[] getSeriesSchemas(InsertPlan insertPlan)\n     throws MetadataException {\n-    return mManager.getSeriesSchemasAndLock(insertPlan.getDeviceId(), insertPlan.getMeasurements(), insertPlan);\n+    return mManager.getSeriesSchemas(insertPlan.getDeviceId(), insertPlan.getMeasurements(), insertPlan);\n   }\n \n   protected MeasurementSchema[] getSeriesSchemas(InsertTabletPlan insertTabletPlan)\n     throws MetadataException {\n-    return mManager.getSeriesSchemasAndLock(insertTabletPlan.getDeviceId(),\n+    return mManager.getSeriesSchemas(insertTabletPlan.getDeviceId(),\n       insertTabletPlan.getMeasurements(), insertTabletPlan);\n   }\n \n   @Override\n   public void insert(InsertPlan insertPlan) throws QueryProcessException {\n     try {\n+      mManager.lockInsert(insertPlan.getDeviceId());\n       MeasurementSchema[] schemas = getSeriesSchemas(insertPlan);\n       insertPlan.setSchemasAndTransferType(schemas);\n       StorageEngine.getInstance().insert(insertPlan);\n"}}, {"oid": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "url": "https://github.com/apache/iotdb/commit/cd4552a3b49343f60d0edc2ed157da8df5752d6d", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-24T01:34:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc4NTA4MQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444785081", "bodyText": "I would suggest you separate the locking part from getSeriesSchemasAndLock and explicitly call it in this method, as it is always better to explicitly put lock and unlock in the same code block.", "author": "jt2594838", "createdAt": "2020-06-24T10:02:49Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -915,227 +926,19 @@ public void insert(InsertPlan insertPlan) throws QueryProcessException {\n       StorageEngine.getInstance().insert(insertPlan);\n       if (insertPlan.getFailedMeasurements() != null) {\n         throw new StorageEngineException(\n-            \"failed to insert points \" + insertPlan.getFailedMeasurements());\n+            \"failed to insert measurements \" + insertPlan.getFailedMeasurements());\n       }\n     } catch (StorageEngineException | MetadataException e) {\n       throw new QueryProcessException(e);\n-    }\n-  }\n-\n-  protected MeasurementSchema[] getSeriesSchemas(InsertPlan insertPlan) throws MetadataException {\n-    String[] measurementList = insertPlan.getMeasurements();\n-    String deviceId = insertPlan.getDeviceId();\n-    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n-\n-    MNode node = null;\n-    try {\n-      node = mManager.getDeviceNodeWithAutoCreateAndReadLock(deviceId);\n-      // To reduce the String number in memory, set the deviceId from MManager to insertPlan\n-      insertPlan.setDeviceId(node.getFullPath());\n-    } catch (PathNotExistException e) {\n-      // ignore\n-    }\n-    try {\n-      for (int i = 0; i < measurementList.length; i++) {\n-        try {\n-          schemas[i] = getSeriesSchema(node, insertPlan, i);\n-          if (schemas[i] != null) {\n-            measurementList[i] = schemas[i].getMeasurementId();\n-          }\n-        } catch (MetadataException e) {\n-          logger.warn(\"meet error when check {}.{}, message: {}\", deviceId, measurementList[i],\n-              e.getMessage());\n-          if (enablePartialInsert) {\n-            insertPlan.markMeasurementInsertionFailed(i);\n-          } else {\n-            throw e;\n-          }\n-        }\n-      }\n     } finally {\n-      if (node != null) {\n-        node.readUnlock();\n-      }\n-    }\n-    return schemas;\n-  }\n-\n-  /**\n-   * @param loc index of measurement in insertPlan\n-   */\n-  private MeasurementSchema getSeriesSchema(MNode deviceNode, InsertPlan insertPlan, int loc)\n-      throws MetadataException {\n-    String measurement = insertPlan.getMeasurements()[loc];\n-    String deviceId = insertPlan.getDeviceId();\n-    Object value = insertPlan.getValues()[loc];\n-    boolean isInferType = insertPlan.isInferType();\n-\n-    MeasurementSchema measurementSchema;\n-    if (deviceNode != null && !deviceNode.hasChild(measurement)) {\n-      // devices exists in MTree\n-      if (!IoTDBDescriptor.getInstance().getConfig().isAutoCreateSchemaEnabled()) {\n-        // but measurement not in MTree and cannot auto-create, try the cache\n-        measurementSchema = MManager.getInstance().getSeriesSchema(deviceId, measurement);\n-        if (measurementSchema == null) {\n-          throw new PathNotExistException(deviceId + PATH_SEPARATOR + measurement);\n-        }\n-      } else {\n-        // auto-create\n-        TSDataType dataType = TypeInferenceUtils.getPredictedDataType(value, isInferType);\n-        Path path = new Path(deviceId, measurement);\n-        internalCreateTimeseries(path.toString(), dataType);\n-\n-        MeasurementMNode measurementNode = (MeasurementMNode) mManager\n-            .getChild(deviceNode, measurement);\n-        measurementSchema = measurementNode.getSchema();\n-        if (!isInferType) {\n-          checkType(insertPlan, loc, measurementNode.getSchema().getType());\n-        }\n-      }\n-    } else if (deviceNode != null) {\n-      // device and measurement exists in MTree\n-      MeasurementMNode measurementNode = (MeasurementMNode) MManager.getInstance()\n-          .getChild(deviceNode, measurement);\n-      measurementSchema = measurementNode.getSchema();\n-    } else {\n-      // device in not in MTree, try the cache\n-      measurementSchema = mManager.getSeriesSchema(deviceId, measurement);\n-    }\n-    return measurementSchema;\n-  }\n-\n-  private void checkType(InsertPlan plan, int loc, TSDataType type) {\n-    plan.getTypes()[loc] = type;\n-    try {\n-      switch (type) {\n-        case INT32:\n-          if (!(plan.getValues()[loc] instanceof Integer)) {\n-            plan.getValues()[loc] =\n-                Integer.parseInt(((Binary) plan.getValues()[loc]).getStringValue());\n-          }\n-          break;\n-        case INT64:\n-          if (!(plan.getValues()[loc] instanceof Long)) {\n-            plan.getValues()[loc] =\n-                Long.parseLong(((Binary) plan.getValues()[loc]).getStringValue());\n-          }\n-          break;\n-        case DOUBLE:\n-          if (!(plan.getValues()[loc] instanceof Double)) {\n-            plan.getValues()[loc] =\n-                Double.parseDouble(((Binary) plan.getValues()[loc]).getStringValue());\n-          }\n-          break;\n-        case FLOAT:\n-          if (!(plan.getValues()[loc] instanceof Float)) {\n-            plan.getValues()[loc] =\n-                Float.parseFloat(((Binary) plan.getValues()[loc]).getStringValue());\n-          }\n-          break;\n-        case BOOLEAN:\n-          if (!(plan.getValues()[loc] instanceof Boolean)) {\n-            plan.getValues()[loc] =\n-                Boolean.parseBoolean(((Binary) plan.getValues()[loc]).getStringValue());\n-          }\n-          break;\n-        case TEXT:\n-          // need to do nothing\n-          break;\n-      }\n-    } catch (ClassCastException e) {\n-      logger.error(\"inconsistent type between client and server\");\n-    }\n-  }\n-\n-  /**\n-   * create timeseries with ignore PathAlreadyExistException\n-   */\n-  private void internalCreateTimeseries(String path, TSDataType dataType) throws MetadataException {\n-    try {\n-      mManager.createTimeseries(\n-          path,\n-          dataType,\n-          getDefaultEncoding(dataType),\n-          TSFileDescriptor.getInstance().getConfig().getCompressor(),\n-          Collections.emptyMap());\n-    } catch (PathAlreadyExistException e) {\n-      if (logger.isDebugEnabled()) {\n-        logger.debug(\"Ignore PathAlreadyExistException when Concurrent inserting\"\n-            + \" a non-exist time series {}\", path);\n-      }\n-    }\n-  }\n-\n-  /**\n-   * Get default encoding by dataType\n-   */\n-  private TSEncoding getDefaultEncoding(TSDataType dataType) {\n-    IoTDBConfig conf = IoTDBDescriptor.getInstance().getConfig();\n-    switch (dataType) {\n-      case BOOLEAN:\n-        return conf.getDefaultBooleanEncoding();\n-      case INT32:\n-        return conf.getDefaultInt32Encoding();\n-      case INT64:\n-        return conf.getDefaultInt64Encoding();\n-      case FLOAT:\n-        return conf.getDefaultFloatEncoding();\n-      case DOUBLE:\n-        return conf.getDefaultDoubleEncoding();\n-      case TEXT:\n-        return conf.getDefaultTextEncoding();\n-      default:\n-        throw new UnSupportedDataTypeException(\n-            String.format(\"Data type %s is not supported.\", dataType.toString()));\n+      mManager.unlockInsert(insertPlan.getDeviceId());", "originalCommit": "cd4552a3b49343f60d0edc2ed157da8df5752d6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3OTg5NA==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r444879894", "bodyText": "ok", "author": "mychaow", "createdAt": "2020-06-24T13:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc4NTA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "af3f72c664ead46a244da81bf0cf4293a5cd031b", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\nindex 169ac5d6e..c5047f65d 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java\n\n@@ -909,18 +843,19 @@ public class PlanExecutor implements IPlanExecutor {\n \n   protected MeasurementSchema[] getSeriesSchemas(InsertPlan insertPlan)\n     throws MetadataException {\n-    return mManager.getSeriesSchemasAndLock(insertPlan.getDeviceId(), insertPlan.getMeasurements(), insertPlan);\n+    return mManager.getSeriesSchemas(insertPlan.getDeviceId(), insertPlan.getMeasurements(), insertPlan);\n   }\n \n   protected MeasurementSchema[] getSeriesSchemas(InsertTabletPlan insertTabletPlan)\n     throws MetadataException {\n-    return mManager.getSeriesSchemasAndLock(insertTabletPlan.getDeviceId(),\n+    return mManager.getSeriesSchemas(insertTabletPlan.getDeviceId(),\n       insertTabletPlan.getMeasurements(), insertTabletPlan);\n   }\n \n   @Override\n   public void insert(InsertPlan insertPlan) throws QueryProcessException {\n     try {\n+      mManager.lockInsert(insertPlan.getDeviceId());\n       MeasurementSchema[] schemas = getSeriesSchemas(insertPlan);\n       insertPlan.setSchemasAndTransferType(schemas);\n       StorageEngine.getInstance().insert(insertPlan);\n"}}, {"oid": "af3f72c664ead46a244da81bf0cf4293a5cd031b", "url": "https://github.com/apache/iotdb/commit/af3f72c664ead46a244da81bf0cf4293a5cd031b", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-24T13:21:51Z", "type": "forcePushed"}, {"oid": "63220cba546c627a96418756a1a6765236588555", "url": "https://github.com/apache/iotdb/commit/63220cba546c627a96418756a1a6765236588555", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-28T01:21:21Z", "type": "forcePushed"}, {"oid": "3894fb40d5b2a7043b096428a8345670a8b6bec2", "url": "https://github.com/apache/iotdb/commit/3894fb40d5b2a7043b096428a8345670a8b6bec2", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-28T08:36:44Z", "type": "forcePushed"}, {"oid": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "url": "https://github.com/apache/iotdb/commit/be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-28T08:41:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzU5OQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446643599", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // if values is String[], isNeedInferType must be true, so we could infer types from them\n          \n          \n            \n              // if isNeedInferType is true, the values must be String[], so we could infer types from them", "author": "qiaojialin", "createdAt": "2020-06-28T12:18:41Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java", "diffHunk": "@@ -57,9 +58,9 @@\n   private TSDataType[] types;\n   private MeasurementSchema[] schemas;\n \n-  // if inferType is false, use the type of values directly\n-  // if inferType is true, values is String[], and infer types from them\n-  private boolean inferType = false;\n+  // if values is String[], isNeedInferType must be true, so we could infer types from them", "originalCommit": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03c4f03aff1845f9342706ab5a15a208711f07ad", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java\nindex 5d8ed5191..0190699a8 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/InsertPlan.java\n\n@@ -58,7 +58,7 @@ public class InsertPlan extends PhysicalPlan {\n   private TSDataType[] types;\n   private MeasurementSchema[] schemas;\n \n-  // if values is String[], isNeedInferType must be true, so we could infer types from them\n+  // if isNeedInferType is true, the values must be String[], so we could infer types from them\n   // if values is object[], we could use the raw type of them, and we should set this to false\n   private boolean isNeedInferType = false;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0Mzk0OA==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446643948", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ((plan instanceof InsertPlan)) {\n          \n          \n            \n                    if ((plan instanceof InsertPlan && ((InsertPlan) plan).isNeedInferType()) {", "author": "qiaojialin", "createdAt": "2020-06-28T12:21:45Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1846,4 +1836,219 @@ public void createMTreeSnapshot() {\n       lock.readLock().unlock();\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemas(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNode(deviceId);\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        TSDataType insertDataType = null;\n+        if (plan instanceof InsertPlan) {\n+          if (!((InsertPlan)plan).isNeedInferType()) {\n+            // only when InsertPlan's values is object[], we should check type\n+            insertDataType = getTypeInLoc(plan, i);\n+          } else {\n+            insertDataType = measurementNode.getSchema().getType();\n+          }\n+        } else if (plan instanceof InsertTabletPlan) {\n+          insertDataType = getTypeInLoc(plan, i);\n+        }\n+\n+        if (measurementNode.getSchema().getType() != insertDataType) {\n+          logger.warn(\"DataType mismatch, Insert measurement {} type {}, metadata tree type {}\",\n+            measurementList[i], insertDataType, measurementNode.getSchema().getType());\n+          if (!config.isEnablePartialInsert()) {\n+            throw new MetadataException(String.format(\n+              \"DataType mismatch, Insert measurement %s type %s, metadata tree type %s\",\n+              measurementList[i], insertDataType, measurementNode.getSchema().getType()));\n+          } else {\n+            // mark failed measurement\n+            if (plan instanceof InsertTabletPlan) {\n+              ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+            } else if (plan instanceof InsertPlan) {\n+              ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+            }\n+            continue;\n+          }\n+        }\n+\n+        // maybe need to convert value type to the true type\n+        if ((plan instanceof InsertPlan)) {", "originalCommit": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03c4f03aff1845f9342706ab5a15a208711f07ad", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex a2d622af6..b573f4091 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1910,8 +1911,8 @@ public class MManager {\n         }\n \n         // maybe need to convert value type to the true type\n-        if ((plan instanceof InsertPlan)) {\n-          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        if ((plan instanceof InsertPlan) && ((InsertPlan) plan).isNeedInferType()) {\n+          changeStringValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n         }\n \n         schemas[i] = measurementNode.getSchema();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDAwNQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446644005", "bodyText": "The String needs to be cast to Binary", "author": "qiaojialin", "createdAt": "2020-06-28T12:22:23Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1846,4 +1836,219 @@ public void createMTreeSnapshot() {\n       lock.readLock().unlock();\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemas(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNode(deviceId);\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        TSDataType insertDataType = null;\n+        if (plan instanceof InsertPlan) {\n+          if (!((InsertPlan)plan).isNeedInferType()) {\n+            // only when InsertPlan's values is object[], we should check type\n+            insertDataType = getTypeInLoc(plan, i);\n+          } else {\n+            insertDataType = measurementNode.getSchema().getType();\n+          }\n+        } else if (plan instanceof InsertTabletPlan) {\n+          insertDataType = getTypeInLoc(plan, i);\n+        }\n+\n+        if (measurementNode.getSchema().getType() != insertDataType) {\n+          logger.warn(\"DataType mismatch, Insert measurement {} type {}, metadata tree type {}\",\n+            measurementList[i], insertDataType, measurementNode.getSchema().getType());\n+          if (!config.isEnablePartialInsert()) {\n+            throw new MetadataException(String.format(\n+              \"DataType mismatch, Insert measurement %s type %s, metadata tree type %s\",\n+              measurementList[i], insertDataType, measurementNode.getSchema().getType()));\n+          } else {\n+            // mark failed measurement\n+            if (plan instanceof InsertTabletPlan) {\n+              ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+            } else if (plan instanceof InsertPlan) {\n+              ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+            }\n+            continue;\n+          }\n+        }\n+\n+        // maybe need to convert value type to the true type\n+        if ((plan instanceof InsertPlan)) {\n+          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        }\n+\n+        schemas[i] = measurementNode.getSchema();\n+        if (schemas[i] != null) {\n+          measurementList[i] = schemas[i].getMeasurementId();\n+        }\n+      } catch (MetadataException e) {\n+        logger.warn(\"meet error when check {}.{}, message: {}\", deviceId, measurementList[i],\n+          e.getMessage());\n+        if (config.isEnablePartialInsert()) {\n+          // mark failed measurement\n+          if (plan instanceof InsertPlan) {\n+            ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+          } else if (plan instanceof InsertTabletPlan) {\n+            ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+          }\n+        } else {\n+          throw e;\n+        }\n+      }\n+    }\n+    return schemas;\n+  }\n+\n+  private void changeValueToRealType(InsertPlan plan, int loc, TSDataType type) throws MetadataException {\n+    plan.getTypes()[loc] = type;\n+    try {\n+      switch (type) {\n+        case INT32:\n+          if (!(plan.getValues()[loc] instanceof Integer)) {\n+            plan.getValues()[loc] =\n+              Integer.parseInt(String.valueOf(plan.getValues()[loc]));\n+          }\n+          break;\n+        case INT64:\n+          if (!(plan.getValues()[loc] instanceof Long)) {\n+            plan.getValues()[loc] =\n+              Long.parseLong(String.valueOf(plan.getValues()[loc]));\n+          }\n+          break;\n+        case DOUBLE:\n+          if (!(plan.getValues()[loc] instanceof Double)) {\n+            plan.getValues()[loc] =\n+              Double.parseDouble(String.valueOf(plan.getValues()[loc]));\n+          }\n+          break;\n+        case FLOAT:\n+          if (!(plan.getValues()[loc] instanceof Float)) {\n+            plan.getValues()[loc] =\n+              Float.parseFloat(String.valueOf(plan.getValues()[loc]));\n+          }\n+          break;\n+        case BOOLEAN:\n+          if (!(plan.getValues()[loc] instanceof Boolean)) {\n+            plan.getValues()[loc] =\n+              Boolean.parseBoolean(String.valueOf(plan.getValues()[loc]));\n+          }\n+          break;\n+        case TEXT:\n+          // need to do nothing", "originalCommit": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03c4f03aff1845f9342706ab5a15a208711f07ad", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex a2d622af6..b573f4091 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1910,8 +1911,8 @@ public class MManager {\n         }\n \n         // maybe need to convert value type to the true type\n-        if ((plan instanceof InsertPlan)) {\n-          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        if ((plan instanceof InsertPlan) && ((InsertPlan) plan).isNeedInferType()) {\n+          changeStringValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n         }\n \n         schemas[i] = measurementNode.getSchema();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDA4Mw==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446644083", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void changeValueToRealType(InsertPlan plan, int loc, TSDataType type) throws MetadataException {\n          \n          \n            \n              private void changeStringValueToRealType(InsertPlan plan, int loc, TSDataType type) throws MetadataException {", "author": "qiaojialin", "createdAt": "2020-06-28T12:23:02Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1846,4 +1836,219 @@ public void createMTreeSnapshot() {\n       lock.readLock().unlock();\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemas(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNode(deviceId);\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        TSDataType insertDataType = null;\n+        if (plan instanceof InsertPlan) {\n+          if (!((InsertPlan)plan).isNeedInferType()) {\n+            // only when InsertPlan's values is object[], we should check type\n+            insertDataType = getTypeInLoc(plan, i);\n+          } else {\n+            insertDataType = measurementNode.getSchema().getType();\n+          }\n+        } else if (plan instanceof InsertTabletPlan) {\n+          insertDataType = getTypeInLoc(plan, i);\n+        }\n+\n+        if (measurementNode.getSchema().getType() != insertDataType) {\n+          logger.warn(\"DataType mismatch, Insert measurement {} type {}, metadata tree type {}\",\n+            measurementList[i], insertDataType, measurementNode.getSchema().getType());\n+          if (!config.isEnablePartialInsert()) {\n+            throw new MetadataException(String.format(\n+              \"DataType mismatch, Insert measurement %s type %s, metadata tree type %s\",\n+              measurementList[i], insertDataType, measurementNode.getSchema().getType()));\n+          } else {\n+            // mark failed measurement\n+            if (plan instanceof InsertTabletPlan) {\n+              ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+            } else if (plan instanceof InsertPlan) {\n+              ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+            }\n+            continue;\n+          }\n+        }\n+\n+        // maybe need to convert value type to the true type\n+        if ((plan instanceof InsertPlan)) {\n+          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        }\n+\n+        schemas[i] = measurementNode.getSchema();\n+        if (schemas[i] != null) {\n+          measurementList[i] = schemas[i].getMeasurementId();\n+        }\n+      } catch (MetadataException e) {\n+        logger.warn(\"meet error when check {}.{}, message: {}\", deviceId, measurementList[i],\n+          e.getMessage());\n+        if (config.isEnablePartialInsert()) {\n+          // mark failed measurement\n+          if (plan instanceof InsertPlan) {\n+            ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+          } else if (plan instanceof InsertTabletPlan) {\n+            ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+          }\n+        } else {\n+          throw e;\n+        }\n+      }\n+    }\n+    return schemas;\n+  }\n+\n+  private void changeValueToRealType(InsertPlan plan, int loc, TSDataType type) throws MetadataException {", "originalCommit": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "03c4f03aff1845f9342706ab5a15a208711f07ad", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex a2d622af6..b573f4091 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1910,8 +1911,8 @@ public class MManager {\n         }\n \n         // maybe need to convert value type to the true type\n-        if ((plan instanceof InsertPlan)) {\n-          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        if ((plan instanceof InsertPlan) && ((InsertPlan) plan).isNeedInferType()) {\n+          changeStringValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n         }\n \n         schemas[i] = measurementNode.getSchema();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDE1NQ==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446644155", "bodyText": "Do we need this check? I think only String value need to be inferred.", "author": "qiaojialin", "createdAt": "2020-06-28T12:23:48Z", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1846,4 +1836,219 @@ public void createMTreeSnapshot() {\n       lock.readLock().unlock();\n     }\n   }\n+\n+  /**\n+   * get schema for device.\n+   * Attention!!!  Only support insertPlan and insertTabletsPlan\n+   * @param deviceId\n+   * @param measurementList\n+   * @param plan\n+   * @return\n+   * @throws MetadataException\n+   */\n+  public MeasurementSchema[] getSeriesSchemas(String deviceId, String[] measurementList, PhysicalPlan plan) throws MetadataException {\n+    MeasurementSchema[] schemas = new MeasurementSchema[measurementList.length];\n+\n+    MNode deviceNode = null;\n+    // 1. get device node\n+    deviceNode = getDeviceNode(deviceId);\n+\n+    // 2. get schema of each measurement\n+    for (int i = 0; i < measurementList.length; i++) {\n+      try {\n+        // if do not has measurement\n+        if (!deviceNode.hasChild(measurementList[i])) {\n+          // could not create it\n+          if (!config.isAutoCreateSchemaEnabled()) {\n+            throw new MetadataException(String.format(\n+              \"Current deviceId[%s] does not contain measurement:%s\", deviceId, measurementList[i]));\n+          }\n+\n+          // create it\n+          Path path = new Path(deviceId, measurementList[i]);\n+          TSDataType dataType = getTypeInLoc(plan, i);\n+\n+          createTimeseries(\n+            path.getFullPath(),\n+            dataType,\n+            getDefaultEncoding(dataType),\n+            TSFileDescriptor.getInstance().getConfig().getCompressor(),\n+            Collections.emptyMap());\n+        }\n+\n+        MeasurementMNode measurementNode = (MeasurementMNode) getChild(deviceNode, measurementList[i]);\n+\n+        // check type is match\n+        TSDataType insertDataType = null;\n+        if (plan instanceof InsertPlan) {\n+          if (!((InsertPlan)plan).isNeedInferType()) {\n+            // only when InsertPlan's values is object[], we should check type\n+            insertDataType = getTypeInLoc(plan, i);\n+          } else {\n+            insertDataType = measurementNode.getSchema().getType();\n+          }\n+        } else if (plan instanceof InsertTabletPlan) {\n+          insertDataType = getTypeInLoc(plan, i);\n+        }\n+\n+        if (measurementNode.getSchema().getType() != insertDataType) {\n+          logger.warn(\"DataType mismatch, Insert measurement {} type {}, metadata tree type {}\",\n+            measurementList[i], insertDataType, measurementNode.getSchema().getType());\n+          if (!config.isEnablePartialInsert()) {\n+            throw new MetadataException(String.format(\n+              \"DataType mismatch, Insert measurement %s type %s, metadata tree type %s\",\n+              measurementList[i], insertDataType, measurementNode.getSchema().getType()));\n+          } else {\n+            // mark failed measurement\n+            if (plan instanceof InsertTabletPlan) {\n+              ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+            } else if (plan instanceof InsertPlan) {\n+              ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+            }\n+            continue;\n+          }\n+        }\n+\n+        // maybe need to convert value type to the true type\n+        if ((plan instanceof InsertPlan)) {\n+          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        }\n+\n+        schemas[i] = measurementNode.getSchema();\n+        if (schemas[i] != null) {\n+          measurementList[i] = schemas[i].getMeasurementId();\n+        }\n+      } catch (MetadataException e) {\n+        logger.warn(\"meet error when check {}.{}, message: {}\", deviceId, measurementList[i],\n+          e.getMessage());\n+        if (config.isEnablePartialInsert()) {\n+          // mark failed measurement\n+          if (plan instanceof InsertPlan) {\n+            ((InsertPlan) plan).markMeasurementInsertionFailed(i);\n+          } else if (plan instanceof InsertTabletPlan) {\n+            ((InsertTabletPlan) plan).markMeasurementInsertionFailed(i);\n+          }\n+        } else {\n+          throw e;\n+        }\n+      }\n+    }\n+    return schemas;\n+  }\n+\n+  private void changeValueToRealType(InsertPlan plan, int loc, TSDataType type) throws MetadataException {\n+    plan.getTypes()[loc] = type;\n+    try {\n+      switch (type) {\n+        case INT32:\n+          if (!(plan.getValues()[loc] instanceof Integer)) {", "originalCommit": "be88cfbf8eada8efea5fc4eb756f60d66c2f30fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NTI5Mw==", "url": "https://github.com/apache/iotdb/pull/1408#discussion_r446645293", "bodyText": "yes, could remove this check.", "author": "mychaow", "createdAt": "2020-06-28T12:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "03c4f03aff1845f9342706ab5a15a208711f07ad", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\nindex a2d622af6..b573f4091 100644\n--- a/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/metadata/MManager.java\n\n@@ -1910,8 +1911,8 @@ public class MManager {\n         }\n \n         // maybe need to convert value type to the true type\n-        if ((plan instanceof InsertPlan)) {\n-          changeValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n+        if ((plan instanceof InsertPlan) && ((InsertPlan) plan).isNeedInferType()) {\n+          changeStringValueToRealType((InsertPlan) plan, i, measurementNode.getSchema().getType());\n         }\n \n         schemas[i] = measurementNode.getSchema();\n"}}, {"oid": "03c4f03aff1845f9342706ab5a15a208711f07ad", "url": "https://github.com/apache/iotdb/commit/03c4f03aff1845f9342706ab5a15a208711f07ad", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-28T12:52:10Z", "type": "commit"}, {"oid": "03c4f03aff1845f9342706ab5a15a208711f07ad", "url": "https://github.com/apache/iotdb/commit/03c4f03aff1845f9342706ab5a15a208711f07ad", "message": "move getSeriesSchemas to MManager", "committedDate": "2020-06-28T12:52:10Z", "type": "forcePushed"}]}