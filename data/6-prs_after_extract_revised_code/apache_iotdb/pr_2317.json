{"pr_number": 2317, "pr_title": "[To rel/0.11] [IOTDB-1069] restrict the flushing memtable number to avoid OOM when mem_control is disabled ", "pr_createdAt": "2020-12-23T08:24:28Z", "pr_url": "https://github.com/apache/iotdb/pull/2317", "timeline": [{"oid": "f9780a9370fc46f12cee0c54560b68693e831fe7", "url": "https://github.com/apache/iotdb/commit/f9780a9370fc46f12cee0c54560b68693e831fe7", "message": "restrict flushing memtable number", "committedDate": "2020-12-23T08:20:17Z", "type": "commit"}, {"oid": "db70c362929c10d326c9047ca1ba90a1705f46ef", "url": "https://github.com/apache/iotdb/commit/db70c362929c10d326c9047ca1ba90a1705f46ef", "message": "restrict flushing memtable number", "committedDate": "2020-12-23T08:23:28Z", "type": "commit"}, {"oid": "360750937d282f47de4264df66e041caaa7afd59", "url": "https://github.com/apache/iotdb/commit/360750937d282f47de4264df66e041caaa7afd59", "message": "fix code smells", "committedDate": "2020-12-24T01:38:16Z", "type": "commit"}, {"oid": "fa02e4ef5185057477f0d9ceff57cc8c41da5e78", "url": "https://github.com/apache/iotdb/commit/fa02e4ef5185057477f0d9ceff57cc8c41da5e78", "message": "fix flushing memtable size", "committedDate": "2020-12-24T05:01:43Z", "type": "commit"}, {"oid": "c2cca41e7227c000547ea4fb5813af6684cd8170", "url": "https://github.com/apache/iotdb/commit/c2cca41e7227c000547ea4fb5813af6684cd8170", "message": "fix code smell", "committedDate": "2020-12-24T06:08:57Z", "type": "commit"}, {"oid": "3d6d89ead67e5bdd4a6a935f1c29974be070d2fe", "url": "https://github.com/apache/iotdb/commit/3d6d89ead67e5bdd4a6a935f1c29974be070d2fe", "message": "fix synchronized", "committedDate": "2020-12-24T06:28:25Z", "type": "commit"}, {"oid": "921ac8af1afd790e313d48d1b75da9e6e91d9163", "url": "https://github.com/apache/iotdb/commit/921ac8af1afd790e313d48d1b75da9e6e91d9163", "message": "change 1000 to 100", "committedDate": "2020-12-25T00:59:31Z", "type": "commit"}, {"oid": "e67c336ad1fa1b511dbb760b0de2054395c512f6", "url": "https://github.com/apache/iotdb/commit/e67c336ad1fa1b511dbb760b0de2054395c512f6", "message": "add max memtable number", "committedDate": "2020-12-25T05:49:18Z", "type": "commit"}, {"oid": "dd833f52775ffdb4a3ed9fe467f51b291c602362", "url": "https://github.com/apache/iotdb/commit/dd833f52775ffdb4a3ed9fe467f51b291c602362", "message": "change max memtable number to 0", "committedDate": "2020-12-25T08:45:49Z", "type": "commit"}, {"oid": "888c769eaf7d06fd4e4174250f3c8db00e2beb02", "url": "https://github.com/apache/iotdb/commit/888c769eaf7d06fd4e4174250f3c8db00e2beb02", "message": "add synchronized", "committedDate": "2020-12-25T09:08:35Z", "type": "commit"}, {"oid": "bd0084d06d8255f422bc790e251cc81be8edbfd2", "url": "https://github.com/apache/iotdb/commit/bd0084d06d8255f422bc790e251cc81be8edbfd2", "message": "add memtable manager", "committedDate": "2020-12-25T16:25:36Z", "type": "commit"}, {"oid": "6eeb002ce00e2bad7975633f87ca373d7259fa72", "url": "https://github.com/apache/iotdb/commit/6eeb002ce00e2bad7975633f87ca373d7259fa72", "message": "fix name", "committedDate": "2020-12-26T07:19:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2OTA3Mg==", "url": "https://github.com/apache/iotdb/pull/2317#discussion_r549069072", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // wait until the size of flushingMemTables is less than 2\n          \n          \n            \n                  // wait until the total memtable number is less than the capacity of the system", "author": "qiaojialin", "createdAt": "2020-12-27T05:47:07Z", "path": "server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.rescon;\n+\n+import org.apache.iotdb.db.conf.IoTDBConfig;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.memtable.IMemTable;\n+import org.apache.iotdb.db.engine.memtable.PrimitiveMemTable;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+public class MemTableManager {\n+\n+  private static final IoTDBConfig CONFIG = IoTDBDescriptor.getInstance().getConfig();\n+\n+  private static final Logger logger = LoggerFactory.getLogger(MemTableManager.class);\n+\n+  private static final int WAIT_TIME = 100;\n+  public static final int MEMTABLE_NUM_FOR_EACH_PARTITION = 4;\n+  private int currentMemtableNumber = 0;\n+\n+  private MemTableManager() {\n+  }\n+\n+  public static MemTableManager getInstance() {\n+    return InstanceHolder.INSTANCE;\n+  }\n+\n+  /**\n+   * Called when memory control is disabled\n+   */\n+  public synchronized IMemTable getAvailableMemTable(TsFileResource tsFileResource) {\n+    if (!reachMaxMemtableNumber()) {\n+      currentMemtableNumber++;\n+      return new PrimitiveMemTable();\n+    } else {\n+      // wait until the size of flushingMemTables is less than 2", "originalCommit": "6eeb002ce00e2bad7975633f87ca373d7259fa72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b17a6288536af9254b622481be4ef568bcd6c84", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java b/server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java\nindex eca59b7f54..5244ad8250 100644\n--- a/server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java\n+++ b/server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java\n\n@@ -53,7 +53,7 @@ public class MemTableManager {\n       currentMemtableNumber++;\n       return new PrimitiveMemTable();\n     } else {\n-      // wait until the size of flushingMemTables is less than 2\n+      // wait until the total memtable number is less than the capacity of the system\n       int waitCount = 1;\n       while (true) {\n         if (!reachMaxMemtableNumber()) {\n"}}, {"oid": "8b17a6288536af9254b622481be4ef568bcd6c84", "url": "https://github.com/apache/iotdb/commit/8b17a6288536af9254b622481be4ef568bcd6c84", "message": "Update server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "committedDate": "2020-12-27T05:48:13Z", "type": "commit"}]}