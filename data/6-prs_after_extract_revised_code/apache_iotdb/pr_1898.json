{"pr_number": 1898, "pr_title": "[IOTDB-968] Support time predicate in select last", "pr_createdAt": "2020-10-29T02:40:47Z", "pr_url": "https://github.com/apache/iotdb/pull/1898", "timeline": [{"oid": "8c3ce9fc94afb51d2306cb4074a72493762f21aa", "url": "https://github.com/apache/iotdb/commit/8c3ce9fc94afb51d2306cb4074a72493762f21aa", "message": "Support time filter for last query", "committedDate": "2020-10-29T02:39:27Z", "type": "commit"}, {"oid": "8dbbf1829033c30097a23742ab5bae201f0ade9e", "url": "https://github.com/apache/iotdb/commit/8dbbf1829033c30097a23742ab5bae201f0ade9e", "message": "Add last with filter test", "committedDate": "2020-10-29T03:05:09Z", "type": "commit"}, {"oid": "3d7cb616c65acaad3aa929a972bdba18674b3ef1", "url": "https://github.com/apache/iotdb/commit/3d7cb616c65acaad3aa929a972bdba18674b3ef1", "message": "Fix test issues", "committedDate": "2020-10-29T04:54:40Z", "type": "commit"}, {"oid": "a0d4ef0fa34451057de106c4b2607b956d503b78", "url": "https://github.com/apache/iotdb/commit/a0d4ef0fa34451057de106c4b2607b956d503b78", "message": "Refuse to accept value filter in FROM clause", "committedDate": "2020-10-29T07:08:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1Mzc3NA==", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514053774", "bodyText": "if the filter is null, shoudn't we return true?", "author": "JackieTien97", "createdAt": "2020-10-29T07:33:29Z", "path": "server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java", "diffHunk": "@@ -127,103 +127,64 @@ protected TimeValuePair calculateLastPairForOneSeries(\n    * @param context query context\n    * @return TimeValuePair\n    */\n-  @SuppressWarnings(\"squid:S3776\") // Suppress high Cognitive Complexity warning\n   public static TimeValuePair calculateLastPairForOneSeriesLocally(\n-      PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements)\n+      PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+      IExpression expression, Set<String> deviceMeasurements)\n       throws IOException, QueryProcessException, StorageEngineException {\n \n     // Retrieve last value from MNode\n     MeasurementMNode node = null;\n+    Filter filter = null;\n     if (lastCacheEnabled) {\n+      if (expression != null) {\n+        filter = ((GlobalTimeExpression) expression).getFilter();\n+      }\n       try {\n         node = (MeasurementMNode) IoTDB.metaManager.getNodeByPath(seriesPath);\n       } catch (MetadataException e) {\n         TimeValuePair timeValuePair = IoTDB.metaManager.getLastCache(seriesPath);\n-        if (timeValuePair != null) {\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n           return timeValuePair;\n         }\n       }\n \n       if (node != null && node.getCachedLast() != null) {\n-        return node.getCachedLast();\n+        TimeValuePair timeValuePair =  node.getCachedLast();\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n+          return timeValuePair;\n+        }\n       }\n     }\n \n-    return calculateLastPairByScanningTsFiles(seriesPath, tsDataType, context, deviceMeasurements, node);\n+    return calculateLastPairByScanningTsFiles(\n+        seriesPath, tsDataType, context, filter, deviceMeasurements, node);\n   }\n \n   private static TimeValuePair calculateLastPairByScanningTsFiles(\n-          PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements,\n-          MeasurementMNode node) throws QueryProcessException, StorageEngineException, IOException {\n+          PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+          Filter filter, Set<String> deviceMeasurements, MeasurementMNode node)\n+      throws QueryProcessException, StorageEngineException, IOException {\n \n     QueryDataSource dataSource =\n-        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, null);\n-\n-    List<TsFileResource> seqFileResources = dataSource.getSeqResources();\n-    List<TsFileResource> unseqFileResources = dataSource.getUnseqResources();\n-\n-    TimeValuePair resultPair = new TimeValuePair(Long.MIN_VALUE, null);\n-\n-    if (!seqFileResources.isEmpty()) {\n-      for (int i = seqFileResources.size() - 1; i >= 0; i--) {\n-        TimeseriesMetadata timeseriesMetadata = FileLoaderUtils.loadTimeSeriesMetadata(\n-            seqFileResources.get(i), seriesPath, context, null, deviceMeasurements);\n-        if (timeseriesMetadata != null) {\n-          if (!timeseriesMetadata.isModified()) {\n-            Statistics timeseriesMetadataStats = timeseriesMetadata.getStatistics();\n-            resultPair = constructLastPair(\n-                timeseriesMetadataStats.getEndTime(),\n-                timeseriesMetadataStats.getLastValue(),\n-                tsDataType);\n-            break;\n-          } else {\n-            List<ChunkMetadata> chunkMetadataList = timeseriesMetadata.loadChunkMetadataList();\n-            if (!chunkMetadataList.isEmpty()) {\n-              ChunkMetadata lastChunkMetaData = chunkMetadataList.get(chunkMetadataList.size() - 1);\n-              Statistics chunkStatistics = lastChunkMetaData.getStatistics();\n-              resultPair =\n-                  constructLastPair(\n-                      chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-              break;\n-            }\n-          }\n-        }\n-      }\n-    }\n+        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, filter);\n \n-    long version = 0;\n-    for (TsFileResource resource : unseqFileResources) {\n-      if (resource.getEndTime(seriesPath.getDevice()) < resultPair.getTimestamp()) {\n-        continue;\n-      }\n-      TimeseriesMetadata timeseriesMetadata =\n-          FileLoaderUtils\n-              .loadTimeSeriesMetadata(resource, seriesPath, context, null, deviceMeasurements);\n-      if (timeseriesMetadata != null) {\n-        for (ChunkMetadata chunkMetaData : timeseriesMetadata.loadChunkMetadataList()) {\n-          if (chunkMetaData.getEndTime() > resultPair.getTimestamp()\n-              || (chunkMetaData.getEndTime() == resultPair.getTimestamp()\n-              && chunkMetaData.getVersion() > version)) {\n-            Statistics chunkStatistics = chunkMetaData.getStatistics();\n-            resultPair =\n-                constructLastPair(\n-                    chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-            version = chunkMetaData.getVersion();\n-          }\n-        }\n-      }\n-    }\n+    LastPointReader lastReader = new LastPointReader(\n+        seriesPath, tsDataType, deviceMeasurements, context, dataSource, Long.MAX_VALUE, filter);\n+    TimeValuePair resultPair = lastReader.readLastPoint();\n \n-    // Update cached last value with low priority\n-    if (lastCacheEnabled) {\n-      IoTDB.metaManager.updateLastCache(seriesPath,\n-              resultPair, false, Long.MIN_VALUE, node);\n+    // Update cached last value with low priority unless \"FROM\" expression exists\n+    if (lastCacheEnabled && filter == null) {\n+      IoTDB.metaManager.updateLastCache(\n+          seriesPath, resultPair, false, Long.MIN_VALUE, node);\n     }\n     return resultPair;\n   }\n \n-  private static TimeValuePair constructLastPair(long timestamp, Object value,\n-                                                 TSDataType dataType) {\n-    return new TimeValuePair(timestamp, TsPrimitiveType.getByType(dataType, value));\n+  private static boolean satisfyFilter(Filter filter, TimeValuePair tvPair) {\n+    if (filter != null &&\n+        filter.satisfy(tvPair.getTimestamp(), tvPair.getValue().getValue())) {\n+      return true;\n+    }", "originalCommit": "a0d4ef0fa34451057de106c4b2607b956d503b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0NTQ0MA==", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514345440", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-10-29T15:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1Mzc3NA=="}], "type": "inlineReview", "revised_code": {"commit": "beef6909e2d3f9e93d16a6d45ce9abba4d53a81f", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java b/server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java\nindex 677edf4bcb..1231d08c06 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java\n\n@@ -181,7 +181,7 @@ public class LastQueryExecutor {\n   }\n \n   private static boolean satisfyFilter(Filter filter, TimeValuePair tvPair) {\n-    if (filter != null &&\n+    if (filter == null ||\n         filter.satisfy(tvPair.getTimestamp(), tvPair.getValue().getValue())) {\n       return true;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1NTE4NA==", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514055184", "bodyText": "Same as before, if the filter is null, shoudn't we return true?", "author": "JackieTien97", "createdAt": "2020-10-29T07:36:41Z", "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "diffHunk": "@@ -216,6 +216,9 @@ private boolean shouldUpdate(long time, long version, long newTime, long newVers\n   }\n \n   private boolean endtimeContainedByTimeFilter(Statistics statistics) {\n+    if (timeFilter == null) {\n+      return false;\n+    }", "originalCommit": "a0d4ef0fa34451057de106c4b2607b956d503b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0NTQ5MQ==", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514345491", "bodyText": "Fixed", "author": "wshao08", "createdAt": "2020-10-29T15:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1NTE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "beef6909e2d3f9e93d16a6d45ce9abba4d53a81f", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java b/server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java\nindex 94d8376bba..219546710d 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java\n\n@@ -217,7 +217,7 @@ public class LastPointReader {\n \n   private boolean endtimeContainedByTimeFilter(Statistics statistics) {\n     if (timeFilter == null) {\n-      return false;\n+      return true;\n     }\n     return timeFilter.containStartEndTime(statistics.getEndTime(), statistics.getEndTime());\n   }\n"}}, {"oid": "beef6909e2d3f9e93d16a6d45ce9abba4d53a81f", "url": "https://github.com/apache/iotdb/commit/beef6909e2d3f9e93d16a6d45ce9abba4d53a81f", "message": "Fix code bug", "committedDate": "2020-10-29T08:19:09Z", "type": "commit"}, {"oid": "56410f87c90cf22b5997250529ea018d170e01fa", "url": "https://github.com/apache/iotdb/commit/56410f87c90cf22b5997250529ea018d170e01fa", "message": "Update docs", "committedDate": "2020-10-29T23:52:29Z", "type": "commit"}]}