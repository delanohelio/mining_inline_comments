{"pr_number": 1174, "pr_title": "Concurrently write time partition", "pr_createdAt": "2020-05-08T11:48:15Z", "pr_url": "https://github.com/apache/iotdb/pull/1174", "timeline": [{"oid": "ce841efcec562edcd80c30fbf8361f892be0dbf0", "url": "https://github.com/apache/iotdb/commit/ce841efcec562edcd80c30fbf8361f892be0dbf0", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-05T02:16:06Z", "type": "commit"}, {"oid": "c82abe4d67253a889a4dedbe18bf28bd9b62b921", "url": "https://github.com/apache/iotdb/commit/c82abe4d67253a889a4dedbe18bf28bd9b62b921", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-11T01:32:18Z", "type": "commit"}, {"oid": "202e7fa8b36d8487e6a7b1f9b641786608c2891b", "url": "https://github.com/apache/iotdb/commit/202e7fa8b36d8487e6a7b1f9b641786608c2891b", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-17T01:19:37Z", "type": "commit"}, {"oid": "610082b233713e76f2a8067724cb7dc3de60938e", "url": "https://github.com/apache/iotdb/commit/610082b233713e76f2a8067724cb7dc3de60938e", "message": "add time partition when recovery", "committedDate": "2020-02-17T02:20:25Z", "type": "commit"}, {"oid": "829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "url": "https://github.com/apache/iotdb/commit/829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-19T11:55:08Z", "type": "commit"}, {"oid": "890566ed46eef36c6b2be09fc9bfa634f6c166bf", "url": "https://github.com/apache/iotdb/commit/890566ed46eef36c6b2be09fc9bfa634f6c166bf", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-02-26T08:23:14Z", "type": "commit"}, {"oid": "45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "url": "https://github.com/apache/iotdb/commit/45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "message": "merge", "committedDate": "2020-03-27T10:45:03Z", "type": "commit"}, {"oid": "2f0465a32097202eda3422ab4bb7b362c6169f5c", "url": "https://github.com/apache/iotdb/commit/2f0465a32097202eda3422ab4bb7b362c6169f5c", "message": "fix deletion bug", "committedDate": "2020-03-27T10:45:59Z", "type": "commit"}, {"oid": "693832e459d59baa365301dbbf6868eb8d7b6ab7", "url": "https://github.com/apache/iotdb/commit/693832e459d59baa365301dbbf6868eb8d7b6ab7", "message": "Revert \"fix deletion bug\"\n\nThis reverts commit 2f0465a32097202eda3422ab4bb7b362c6169f5c.", "committedDate": "2020-03-27T10:47:27Z", "type": "commit"}, {"oid": "275fe1816f1a7fa88f439af7ee3960730abd3a56", "url": "https://github.com/apache/iotdb/commit/275fe1816f1a7fa88f439af7ee3960730abd3a56", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-04-23T02:37:13Z", "type": "commit"}, {"oid": "495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "url": "https://github.com/apache/iotdb/commit/495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-05-01T02:57:34Z", "type": "commit"}, {"oid": "24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "url": "https://github.com/apache/iotdb/commit/24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb", "committedDate": "2020-05-08T02:49:41Z", "type": "commit"}, {"oid": "77677dea2a0005ff6aba512756395e63862f8e3e", "url": "https://github.com/apache/iotdb/commit/77677dea2a0005ff6aba512756395e63862f8e3e", "message": "init", "committedDate": "2020-05-08T03:15:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3MDA3Ng==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r422570076", "bodyText": "format back", "author": "qiaojialin", "createdAt": "2020-05-10T01:42:39Z", "path": "server/src/main/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapter.java", "diffHunk": "@@ -30,86 +30,70 @@\n  * This class is to dynamically adjust some important parameters of the system, determine the speed\n  * of MenTable brushing disk, the speed of file sealing and so on, with the continuous change of\n  * load in the process of system operation.\n- *\n+ * <p>\n  * There are three dynamically adjustable parameters: maxMemTableNum, memtableSize and\n  * tsFileSizeThreshold.\n- *\n+ * <p>\n  * 1. maxMemTableNum. This parameter represents the size of the MemTable available in the MemTable\n  * pool, which is closely related to the number of storage groups. When adding or deleting a storage\n  * group, the parameter also adds or deletes four MemTables. The reason why adding or deleting four\n  * MemTables is that when the system is running stably, the speed of the flush operation is faster\n  * than that of data writing, so one is used for the Flush process and the other is used for data\n  * writing. Otherwise, the system should limit the speed of data writing to maintain stability. And\n  * two for sequence data, two for unsequence data.\n- *\n+ * <p>\n  * 2. memtableSize. This parameter determines the threshold value for the MemTable in memory to be\n  * flushed into disk. When the system load increases, the parameter should be set smaller so that\n  * the data in memory can be flushed into disk as soon as possible.\n- *\n+ * <p>\n  * 3. tsFileSizeThreshold. This parameter determines the speed of the tsfile seal, and then\n  * determines the maximum size of metadata information maintained in memory. When the system load\n  * increases, the parameter should be smaller to seal the file as soon as possible, release the\n  * memory occupied by the corresponding metadata information as soon as possible.\n- *\n+ * <p>\n  * The following equation is used to adjust the dynamic parameters of the data:\n- *\n- * Abbreviation of parameters:\n- * 1 memtableSize: m\n- * 2 maxMemTableNum: Nm\n- * 3 maxSeriesNumberAmongStorageGroup: Ns\n- * 4 tsFileSizeThreshold: Sf\n- * 5 CompressionRatio: c\n- * 6 chunk metadata size: a\n- * 7 static memory: b\n- * 8 allocate memory for write: S\n- *\n- * The equation: m * Nm + Nm * Ns * Sf * a * c / m + b = S\n- * Namely: MemTable data memory size + chunk metadata memory size + static memory size = memory size for write\n- *\n+ * <p>\n+ * Abbreviation of parameters: 1 memtableSize: m 2 maxMemTableNum: Nm 3\n+ * maxSeriesNumberAmongStorageGroup: Ns 4 tsFileSizeThreshold: Sf 5 CompressionRatio: c 6 chunk\n+ * metadata size: a 7 static memory: b 8 allocate memory for write: S\n+ * <p>\n+ * The equation: m * Nm + Nm * Ns * Sf * a * c / m + b = S Namely: MemTable data memory size + chunk\n+ * metadata memory size + static memory size = memory size for write", "originalCommit": "77677dea2a0005ff6aba512756395e63862f8e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjczMDEwMw==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r422730103", "bodyText": "Sure~", "author": "SilverNarcissus", "createdAt": "2020-05-11T01:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3MDA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d5f4b5f218064c042aba836e84a3e9c6b8e354e3", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapter.java b/server/src/main/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapter.java\nindex 56830a8ca3..b8342866d0 100644\n--- a/server/src/main/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapter.java\n+++ b/server/src/main/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapter.java\n\n@@ -53,12 +53,21 @@ import org.slf4j.LoggerFactory;\n  * <p>\n  * The following equation is used to adjust the dynamic parameters of the data:\n  * <p>\n- * Abbreviation of parameters: 1 memtableSize: m 2 maxMemTableNum: Nm 3\n- * maxSeriesNumberAmongStorageGroup: Ns 4 tsFileSizeThreshold: Sf 5 CompressionRatio: c 6 chunk\n- * metadata size: a 7 static memory: b 8 allocate memory for write: S\n- * <p>\n- * The equation: m * Nm + Nm * Ns * Sf * a * c / m + b = S Namely: MemTable data memory size + chunk\n- * metadata memory size + static memory size = memory size for write\n+ * *\n+ *\n+ * Abbreviation of parameters:\n+ * 1 memtableSize: m\n+ * 2 maxMemTableNum: Nm\n+ * 3 maxSeriesNumberAmongStorageGroup: Ns\n+ * 4 tsFileSizeThreshold: Sf\n+ * 5 CompressionRatio: c\n+ * 6 chunk metadata size: a\n+ * 7 static memory: b\n+ * 8 allocate memory for write: S\n+ *\n+ * The equation: m * Nm + Nm * Ns * Sf * a * c / m + b = S\n+ * Namely: MemTable data memory size + chunk metadata memory size + static memory size = memory size for write\n+ *\n  */\n public class IoTDBConfigDynamicAdapter implements IDynamicAdapter {\n \n"}}, {"oid": "d5f4b5f218064c042aba836e84a3e9c6b8e354e3", "url": "https://github.com/apache/iotdb/commit/d5f4b5f218064c042aba836e84a3e9c6b8e354e3", "message": "reformat", "committedDate": "2020-05-11T01:08:50Z", "type": "commit"}, {"oid": "dd2173c34eebad6d9bcec36ef5ef74e83391b5c6", "url": "https://github.com/apache/iotdb/commit/dd2173c34eebad6d9bcec36ef5ef74e83391b5c6", "message": "fix test", "committedDate": "2020-05-11T10:00:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NTE4MA==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r424245180", "bodyText": "why divide 4?", "author": "jixuan1989", "createdAt": "2020-05-13T07:59:06Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -276,7 +275,7 @@ private long getMemtableSizeThresholdBasedOnSeriesNum() {\n       return config.getMemtableSizeThreshold();\n     }\n     long memTableSize = (long) (config.getMemtableSizeThreshold() * config.getMaxMemtableNumber()\n-        / IoTDBDescriptor.getInstance().getConfig().getMemtableNumInEachStorageGroup()\n+        / IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() / 4", "originalCommit": "dd2173c34eebad6d9bcec36ef5ef74e83391b5c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NTg1Mw==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r424245853", "bodyText": "Ok I see...\nBut you'd better set 4 as a constant value, and refer to the const \"4\" in  addOrDeleteStorageGroup()", "author": "jixuan1989", "createdAt": "2020-05-13T08:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NTE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM4NTE0MA==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r424385140", "bodyText": "Sure~ I will fix it!", "author": "SilverNarcissus", "createdAt": "2020-05-13T12:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NTE4MA=="}], "type": "inlineReview", "revised_code": {"commit": "fdce56576e350e637e7ccde94bb2673974c78ca9", "chunk": "diff --git a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\nindex 30bbdf817c..b0f308e48d 100644\n--- a/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n+++ b/server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java\n\n@@ -275,7 +277,7 @@ public class TsFileProcessor {\n       return config.getMemtableSizeThreshold();\n     }\n     long memTableSize = (long) (config.getMemtableSizeThreshold() * config.getMaxMemtableNumber()\n-        / IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() / 4\n+        / IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() / MEMTABLE_NUM_FOR_EACH_PARTITION\n         * ActiveTimeSeriesCounter.getInstance()\n         .getActiveRatio(storageGroupName));\n     return Math.max(memTableSize, config.getMemtableSizeThreshold());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NjE5NQ==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r424246195", "bodyText": "The same issue, set 4 as const and a reference from addOrDeleteStorageGroup()", "author": "jixuan1989", "createdAt": "2020-05-13T08:00:49Z", "path": "server/src/test/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapterTest.java", "diffHunk": "@@ -66,7 +66,7 @@ public void addOrDeleteStorageGroup() throws ConfigAdjusterException {\n     for (int i = 1; i < 1000000; i++) {\n       try {\n         IoTDBConfigDynamicAdapter.getInstance().addOrDeleteStorageGroup(1);\n-        memTableNum += IoTDBDescriptor.getInstance().getConfig().getMemtableNumInEachStorageGroup();\n+        memTableNum += IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() * 4 + 1;", "originalCommit": "dd2173c34eebad6d9bcec36ef5ef74e83391b5c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM4NTE4Mw==", "url": "https://github.com/apache/iotdb/pull/1174#discussion_r424385183", "bodyText": "Sure~ I will fix it!", "author": "SilverNarcissus", "createdAt": "2020-05-13T12:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0NjE5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fdce56576e350e637e7ccde94bb2673974c78ca9", "chunk": "diff --git a/server/src/test/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapterTest.java b/server/src/test/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapterTest.java\nindex b903619d93..5f34b5113b 100644\n--- a/server/src/test/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapterTest.java\n+++ b/server/src/test/java/org/apache/iotdb/db/conf/adapter/IoTDBConfigDynamicAdapterTest.java\n\n@@ -66,7 +67,7 @@ public class IoTDBConfigDynamicAdapterTest {\n     for (int i = 1; i < 1000000; i++) {\n       try {\n         IoTDBConfigDynamicAdapter.getInstance().addOrDeleteStorageGroup(1);\n-        memTableNum += IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() * 4 + 1;\n+        memTableNum += IoTDBDescriptor.getInstance().getConfig().getConcurrentWritingTimePartition() * MEMTABLE_NUM_FOR_EACH_PARTITION + 1;\n         assertEquals(IoTDBConfigDynamicAdapter.getInstance().getCurrentMemTableSize(),\n             CONFIG.getMemtableSizeThreshold());\n         assertEquals(CONFIG.getMaxMemtableNumber(), memTableNum);\n"}}, {"oid": "fdce56576e350e637e7ccde94bb2673974c78ca9", "url": "https://github.com/apache/iotdb/commit/fdce56576e350e637e7ccde94bb2673974c78ca9", "message": "fix bug", "committedDate": "2020-05-13T12:08:29Z", "type": "commit"}]}