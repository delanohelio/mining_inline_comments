{"pr_number": 3861, "pr_title": "Zero downtime nb worker", "pr_createdAt": "2020-11-18T16:00:57Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3861", "timeline": [{"oid": "d4549582e2286f8b53c536dbf6f8181e7e0f20ed", "url": "https://github.com/telstra/open-kilda/commit/d4549582e2286f8b53c536dbf6f8181e7e0f20ed", "message": "Nbworker blue-green", "committedDate": "2020-11-18T16:25:37Z", "type": "forcePushed"}, {"oid": "41c69e71f651e73c63753ec16ad61c547a3bf6f3", "url": "https://github.com/telstra/open-kilda/commit/41c69e71f651e73c63753ec16ad61c547a3bf6f3", "message": "Nbworker blue-green", "committedDate": "2020-11-18T21:21:58Z", "type": "forcePushed"}, {"oid": "c3f0786f5c01861b8959809be7566f094767eccd", "url": "https://github.com/telstra/open-kilda/commit/c3f0786f5c01861b8959809be7566f094767eccd", "message": "Nbworker blue-green", "committedDate": "2020-11-25T08:04:26Z", "type": "forcePushed"}, {"oid": "4cafd3cc77f2621ffbffa2ce1d1f13a08d0f16aa", "url": "https://github.com/telstra/open-kilda/commit/4cafd3cc77f2621ffbffa2ce1d1f13a08d0f16aa", "message": "Nbworker blue-green", "committedDate": "2020-11-25T12:19:04Z", "type": "forcePushed"}, {"oid": "3123e079de3c61540271e2a4507e13d24f4fa610", "url": "https://github.com/telstra/open-kilda/commit/3123e079de3c61540271e2a4507e13d24f4fa610", "message": "Nbworker blue-green", "committedDate": "2020-11-26T06:48:22Z", "type": "forcePushed"}, {"oid": "96e480e966b949487e20ce874a6364b656952453", "url": "https://github.com/telstra/open-kilda/commit/96e480e966b949487e20ce874a6364b656952453", "message": "Nbworker blue-green", "committedDate": "2020-11-26T06:53:17Z", "type": "forcePushed"}, {"oid": "7dbf621c11d157c65b52ae862cd52b939c7c2984", "url": "https://github.com/telstra/open-kilda/commit/7dbf621c11d157c65b52ae862cd52b939c7c2984", "message": "Nbworker blue-green", "committedDate": "2020-11-27T12:11:55Z", "type": "forcePushed"}, {"oid": "7efc9a1b46242032ae403f98ce1065291e61a612", "url": "https://github.com/telstra/open-kilda/commit/7efc9a1b46242032ae403f98ce1065291e61a612", "message": "Nbworker blue-green", "committedDate": "2020-11-29T09:14:20Z", "type": "forcePushed"}, {"oid": "96b43f8684ac2b0d2fdb43e2a5537620b74f033a", "url": "https://github.com/telstra/open-kilda/commit/96b43f8684ac2b0d2fdb43e2a5537620b74f033a", "message": "Nbworker blue-green", "committedDate": "2020-11-29T09:21:34Z", "type": "forcePushed"}, {"oid": "bac4999570e27ea06d823ccda73268aedc1a4b21", "url": "https://github.com/telstra/open-kilda/commit/bac4999570e27ea06d823ccda73268aedc1a4b21", "message": "Nbworker blue-green", "committedDate": "2020-12-03T06:30:29Z", "type": "forcePushed"}, {"oid": "7fe68e88ad0ab634607e97bd18fb9d54806075c0", "url": "https://github.com/telstra/open-kilda/commit/7fe68e88ad0ab634607e97bd18fb9d54806075c0", "message": "Nbworker blue-green", "committedDate": "2020-12-07T08:06:37Z", "type": "forcePushed"}, {"oid": "6d3d1111194a80f1e873515c2e4236690db4111f", "url": "https://github.com/telstra/open-kilda/commit/6d3d1111194a80f1e873515c2e4236690db4111f", "message": "Nbworker blue-green", "committedDate": "2020-12-07T09:23:51Z", "type": "forcePushed"}, {"oid": "043539ae5d93d82e27c367362972390a23b7818f", "url": "https://github.com/telstra/open-kilda/commit/043539ae5d93d82e27c367362972390a23b7818f", "message": "Nbworker blue-green", "committedDate": "2020-12-09T11:49:24Z", "type": "forcePushed"}, {"oid": "39fd417e651753b084bfb1915a148c3906cdaad2", "url": "https://github.com/telstra/open-kilda/commit/39fd417e651753b084bfb1915a148c3906cdaad2", "message": "Nbworker blue-green", "committedDate": "2020-12-11T14:13:59Z", "type": "forcePushed"}, {"oid": "77f103eccf54c617707055e0267e53fb62c0b0a1", "url": "https://github.com/telstra/open-kilda/commit/77f103eccf54c617707055e0267e53fb62c0b0a1", "message": "Nbworker blue-green", "committedDate": "2020-12-23T09:19:30Z", "type": "forcePushed"}, {"oid": "597eba4e4e20f59a544542b7dbb846327aa2d3fa", "url": "https://github.com/telstra/open-kilda/commit/597eba4e4e20f59a544542b7dbb846327aa2d3fa", "message": "Nbworker blue-green", "committedDate": "2020-12-28T11:46:30Z", "type": "forcePushed"}, {"oid": "1873c5a3be5cac3896a12f87ef18049f0a04b111", "url": "https://github.com/telstra/open-kilda/commit/1873c5a3be5cac3896a12f87ef18049f0a04b111", "message": "Nbworker blue-green", "committedDate": "2020-12-30T11:20:37Z", "type": "forcePushed"}, {"oid": "1e4c99ccb9e8c4500dfd97801d56744896fcd785", "url": "https://github.com/telstra/open-kilda/commit/1e4c99ccb9e8c4500dfd97801d56744896fcd785", "message": "Nbworker blue-green", "committedDate": "2021-01-14T10:50:17Z", "type": "forcePushed"}, {"oid": "3ef5d2c87df58bea7211b66c5f4ad19838865086", "url": "https://github.com/telstra/open-kilda/commit/3ef5d2c87df58bea7211b66c5f4ad19838865086", "message": "Nbworker blue-green", "committedDate": "2021-01-14T19:25:38Z", "type": "forcePushed"}, {"oid": "229f33dce9b6685834eba21b0c7902d69cb69697", "url": "https://github.com/telstra/open-kilda/commit/229f33dce9b6685834eba21b0c7902d69cb69697", "message": "Nbworker blue-green", "committedDate": "2021-01-20T13:32:35Z", "type": "forcePushed"}, {"oid": "24ff84d73e58631e5c34c7d111e3951b67fea78b", "url": "https://github.com/telstra/open-kilda/commit/24ff84d73e58631e5c34c7d111e3951b67fea78b", "message": "Nbworker blue-green", "committedDate": "2021-01-25T08:14:36Z", "type": "forcePushed"}, {"oid": "2a62ebcd27632bd1839a03be5569ba29125e931d", "url": "https://github.com/telstra/open-kilda/commit/2a62ebcd27632bd1839a03be5569ba29125e931d", "message": "Nbworker blue-green", "committedDate": "2021-01-27T08:00:10Z", "type": "forcePushed"}, {"oid": "64fa00fdbc091a6912569243362108017e05ea66", "url": "https://github.com/telstra/open-kilda/commit/64fa00fdbc091a6912569243362108017e05ea66", "message": "Nbworker blue-green", "committedDate": "2021-01-29T05:58:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc1NzQyMQ==", "url": "https://github.com/telstra/open-kilda/pull/3861#discussion_r566757421", "bodyText": "should we set deferedShutdownEvent = null here?", "author": "niksv", "createdAt": "2021-01-29T11:29:24Z", "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/bolts/FlowValidationHubBolt.java", "diffHunk": "@@ -62,7 +68,24 @@ public FlowValidationHubBolt(Config config, PersistenceManager persistenceManage\n     @Override\n     public void prepare(Map stormConf, TopologyContext context, OutputCollector collector) {\n         super.prepare(stormConf, context, collector);\n-        service = new FlowValidationHubService(persistenceManager, flowResourcesConfig);\n+        service = new FlowValidationHubService(persistenceManager, flowResourcesConfig,\n+                new FlowValidationHubCarrierImpl(null));\n+    }\n+\n+    @Override\n+    protected void handleLifeCycleEvent(LifecycleEvent event) {\n+        if (event.getSignal().equals(Signal.SHUTDOWN)) {\n+            if (service.deactivate()) {\n+                emit(ZkStreams.ZK.toString(), getCurrentTuple(), new Values(event, getCommandContext()));\n+            } else {\n+                deferedShutdownEvent = event;\n+            }\n+        } else if (event.getSignal().equals(Signal.START)) {\n+            service.activate();", "originalCommit": "64fa00fdbc091a6912569243362108017e05ea66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc1NzQ3Mw==", "url": "https://github.com/telstra/open-kilda/pull/3861#discussion_r566757473", "bodyText": "can be replaced with\nactive = false;\nreturn fsms.isEmpty();", "author": "niksv", "createdAt": "2021-01-29T11:29:30Z", "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowMeterModifyHubService.java", "diffHunk": "@@ -110,6 +112,26 @@ private void process(FlowMeterModifyFsm fsm) {\n \n         if (exitStates.contains(fsm.getCurrentState())) {\n             fsms.remove(fsm.getKey());\n+            if (fsms.isEmpty() && !active) {\n+                defaultCarrier.sendInactive();\n+            }\n         }\n     }\n+\n+\n+    /**\n+     * Deactivates service.\n+     */\n+    public boolean deactivate() {\n+        active = false;\n+        if (fsms.isEmpty()) {\n+            return true;\n+        }\n+        return false;", "originalCommit": "64fa00fdbc091a6912569243362108017e05ea66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwMjY1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3861#discussion_r567502653", "bodyText": "Does it make sense to introduce a dedicated \"build\" method instead of repeating \"getZkTopoName(), getConfig().getBlueGreenMode()\" each time?", "author": "sergii-iakovenko", "createdAt": "2021-01-31T23:32:24Z", "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/NbWorkerTopology.java", "diffHunk": "@@ -239,45 +260,58 @@ public StormTopology createTopology() {\n                 .shuffleGrouping(SWITCHES_BOLT_NAME, StreamType.DISCO.toString())\n                 .shuffleGrouping(FEATURE_TOGGLES_BOLT_NAME, FeatureTogglesBolt.STREAM_NOTIFICATION_ID);\n \n-        KafkaBolt kafkaNbBolt = buildKafkaBolt(topologyConfig.getKafkaNorthboundTopic());\n+        KafkaBolt kafkaNbBolt = buildKafkaBolt(topologyConfig.getKafkaNorthboundTopic(),\n+                getZkTopoName(), getConfig().getBlueGreenMode());", "originalCommit": "64fa00fdbc091a6912569243362108017e05ea66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwMzk2Mw==", "url": "https://github.com/telstra/open-kilda/pull/3861#discussion_r567503963", "bodyText": "Could we introduce a default constructor instead of passing null? Currently, it's ambiguous and not clear why null.", "author": "sergii-iakovenko", "createdAt": "2021-01-31T23:43:20Z", "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/bolts/FlowValidationHubBolt.java", "diffHunk": "@@ -62,7 +68,24 @@ public FlowValidationHubBolt(Config config, PersistenceManager persistenceManage\n     @Override\n     public void prepare(Map stormConf, TopologyContext context, OutputCollector collector) {\n         super.prepare(stormConf, context, collector);\n-        service = new FlowValidationHubService(persistenceManager, flowResourcesConfig);\n+        service = new FlowValidationHubService(persistenceManager, flowResourcesConfig,\n+                new FlowValidationHubCarrierImpl(null));", "originalCommit": "64fa00fdbc091a6912569243362108017e05ea66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "6c93a4a0c045c759092f38848beea52bebcbaca6", "url": "https://github.com/telstra/open-kilda/commit/6c93a4a0c045c759092f38848beea52bebcbaca6", "message": "Nbworker blue-green", "committedDate": "2021-02-03T12:50:55Z", "type": "forcePushed"}, {"oid": "1e41c75bd14ba239feab66d9e3f3c5a5841414c1", "url": "https://github.com/telstra/open-kilda/commit/1e41c75bd14ba239feab66d9e3f3c5a5841414c1", "message": "Nbworker blue-green", "committedDate": "2021-02-03T12:57:49Z", "type": "commit"}, {"oid": "1e41c75bd14ba239feab66d9e3f3c5a5841414c1", "url": "https://github.com/telstra/open-kilda/commit/1e41c75bd14ba239feab66d9e3f3c5a5841414c1", "message": "Nbworker blue-green", "committedDate": "2021-02-03T12:57:49Z", "type": "forcePushed"}]}