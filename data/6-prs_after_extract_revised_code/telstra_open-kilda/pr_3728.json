{"pr_number": 3728, "pr_title": "update port/vlan should not cause reroute", "pr_createdAt": "2020-09-21T09:26:18Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3728", "timeline": [{"oid": "9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "url": "https://github.com/telstra/open-kilda/commit/9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T17:41:06Z", "type": "forcePushed"}, {"oid": "143363279802b3288787476b082285ac22d481ab", "url": "https://github.com/telstra/open-kilda/commit/143363279802b3288787476b082285ac22d481ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T19:34:41Z", "type": "forcePushed"}, {"oid": "332f335944e73c553cc506f6ba22fa843721d0a1", "url": "https://github.com/telstra/open-kilda/commit/332f335944e73c553cc506f6ba22fa843721d0a1", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T20:12:43Z", "type": "forcePushed"}, {"oid": "b3c63f1dd21e465be4d5dc62fb90f37064356e52", "url": "https://github.com/telstra/open-kilda/commit/b3c63f1dd21e465be4d5dc62fb90f37064356e52", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T08:33:54Z", "type": "forcePushed"}, {"oid": "830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "url": "https://github.com/telstra/open-kilda/commit/830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T08:49:41Z", "type": "forcePushed"}, {"oid": "d4f906cce5aa8061e5520a472183ef0116516289", "url": "https://github.com/telstra/open-kilda/commit/d4f906cce5aa8061e5520a472183ef0116516289", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T09:23:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5NjcyMA==", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494496720", "bodyText": "It should be fine but I'll ask just  in case. Did you checked that enabling/disabling of connected devices on flow endpoint works correct if we change connected devices flag and src_port (for example)? I'm worried about situation when we install Ingress/egress rules and adds some new rules (like connected devices) in one command.", "author": "niksv", "createdAt": "2020-09-24T17:40:11Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java", "diffHunk": "@@ -159,6 +185,44 @@ private String getOrCreateFlowGroupId(String flowId) throws FlowProcessingExcept\n                         format(\"Flow %s not found\", flowId)));\n     }\n \n+    private FlowUpdateFsm.EndpointUpdate updateEndpointRulesOnly(RequestedFlow originalFlow, RequestedFlow targetFlow,\n+                                                                 String originalGroupId, String targetGroupId) {\n+        boolean updateEndpointOnly = originalFlow.getSrcSwitch().equals(targetFlow.getSrcSwitch());\n+        updateEndpointOnly &= originalFlow.getDestSwitch().equals(targetFlow.getDestSwitch());\n+\n+        updateEndpointOnly &= originalFlow.isAllocateProtectedPath() == targetFlow.isAllocateProtectedPath();\n+        updateEndpointOnly &= originalFlow.getBandwidth() == targetFlow.getBandwidth();\n+        updateEndpointOnly &= originalFlow.isIgnoreBandwidth() == targetFlow.isIgnoreBandwidth();\n+\n+        updateEndpointOnly &= Objects.equal(originalFlow.getMaxLatency(), targetFlow.getMaxLatency());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getFlowEncapsulationType(),\n+                targetFlow.getFlowEncapsulationType());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getPathComputationStrategy(),\n+                targetFlow.getPathComputationStrategy());", "originalCommit": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc2Nzg3OA==", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494767878", "bodyText": "good catch, updated", "author": "timofei-durakov", "createdAt": "2020-09-25T06:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5NjcyMA=="}], "type": "inlineReview", "revised_code": {"commit": "440011d73162a65b8028ecc88b0effd2fbec7b0f", "chunk": "diff --git a/src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java b/src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java\nindex 4808c55d2..3e0bfdfd5 100644\n--- a/src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java\n+++ b/src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java\n\n@@ -202,24 +203,31 @@ public class UpdateFlowAction extends NbTrackableAction<FlowUpdateFsm, State, Ev\n \n         updateEndpointOnly &= Objects.equal(originalGroupId, targetGroupId);\n \n-        boolean portOrVlanChangedSrc = originalFlow.getSrcPort() != targetFlow.getSrcPort();\n-        portOrVlanChangedSrc |= originalFlow.getSrcVlan() != targetFlow.getSrcVlan();\n-        portOrVlanChangedSrc |= originalFlow.getSrcInnerVlan() != targetFlow.getSrcInnerVlan();\n+        DetectConnectedDevices originalConnectedDevices = originalFlow.getDetectConnectedDevices();\n+        DetectConnectedDevices targetConnectedDevices = targetFlow.getDetectConnectedDevices();\n+\n+        boolean srcEndpointChanged = originalFlow.getSrcPort() != targetFlow.getSrcPort();\n+        srcEndpointChanged |= originalFlow.getSrcVlan() != targetFlow.getSrcVlan();\n+        srcEndpointChanged |= originalFlow.getSrcInnerVlan() != targetFlow.getSrcInnerVlan();\n+        srcEndpointChanged |= originalConnectedDevices.isSrcArp() != targetConnectedDevices.isSrcArp();\n+        srcEndpointChanged |= originalConnectedDevices.isSrcLldp() != targetConnectedDevices.isSrcLldp();\n+\n+        boolean dstEndpointChanged = originalFlow.getDestPort() != targetFlow.getDestPort();\n+        dstEndpointChanged |= originalFlow.getDestVlan() != targetFlow.getDestVlan();\n+        dstEndpointChanged |= originalFlow.getDestInnerVlan() != targetFlow.getDestInnerVlan();\n+        dstEndpointChanged |= originalConnectedDevices.isDstArp() != targetConnectedDevices.isDstArp();\n+        dstEndpointChanged |= originalConnectedDevices.isDstLldp() != targetConnectedDevices.isDstLldp();\n \n-        boolean portOrVlanChangedDst = originalFlow.getDestPort() != targetFlow.getDestPort();\n-        portOrVlanChangedDst |= originalFlow.getDestVlan() != targetFlow.getDestVlan();\n-        portOrVlanChangedDst |= originalFlow.getDestInnerVlan() != targetFlow.getDestInnerVlan();\n         if (updateEndpointOnly) {\n-            if (portOrVlanChangedDst && portOrVlanChangedSrc) {\n+            if (srcEndpointChanged && dstEndpointChanged) {\n                 return EndpointUpdate.BOTH;\n-            } else if (portOrVlanChangedSrc) {\n+            } else if (srcEndpointChanged) {\n                 return EndpointUpdate.SOURCE;\n-            } else if (portOrVlanChangedDst) {\n+            } else if (dstEndpointChanged) {\n                 return EndpointUpdate.DESTINATION;\n             } else {\n                 return EndpointUpdate.NONE;\n             }\n-\n         }\n         return EndpointUpdate.NONE;\n     }\n"}}, {"oid": "440011d73162a65b8028ecc88b0effd2fbec7b0f", "url": "https://github.com/telstra/open-kilda/commit/440011d73162a65b8028ecc88b0effd2fbec7b0f", "message": "Get rid of Direction enum in command builder", "committedDate": "2020-09-25T06:11:20Z", "type": "forcePushed"}, {"oid": "f893bec4ff7f72f69a48051db4fe749416dc345d", "url": "https://github.com/telstra/open-kilda/commit/f893bec4ff7f72f69a48051db4fe749416dc345d", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T06:13:38Z", "type": "forcePushed"}, {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T11:22:04Z", "type": "commit"}, {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T11:22:04Z", "type": "forcePushed"}]}