{"pr_number": 3108, "pr_title": "Fix double network failure handling", "pr_createdAt": "2020-01-10T14:06:20Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3108", "timeline": [{"oid": "199f6b0d5353f7e63a3455869c05bdaee6f933b7", "url": "https://github.com/telstra/open-kilda/commit/199f6b0d5353f7e63a3455869c05bdaee6f933b7", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-10T14:13:22Z", "type": "forcePushed"}, {"oid": "a53e58db77d8e19e8db366e77713169e05fad0f0", "url": "https://github.com/telstra/open-kilda/commit/a53e58db77d8e19e8db366e77713169e05fad0f0", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-10T14:39:38Z", "type": "forcePushed"}, {"oid": "3c9787f8ecf4219b20313086626c028cf73ee679", "url": "https://github.com/telstra/open-kilda/commit/3c9787f8ecf4219b20313086626c028cf73ee679", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-10T15:51:53Z", "type": "forcePushed"}, {"oid": "e8c838f465ddf802894fe470f0f71af686476acb", "url": "https://github.com/telstra/open-kilda/commit/e8c838f465ddf802894fe470f0f71af686476acb", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-10T17:26:00Z", "type": "forcePushed"}, {"oid": "093bb7bf4298b6b91f79f1656706dddcdbd1c851", "url": "https://github.com/telstra/open-kilda/commit/093bb7bf4298b6b91f79f1656706dddcdbd1c851", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-11T16:31:33Z", "type": "forcePushed"}, {"oid": "d876f11bc4833e04517e978b083d754f7a0648d4", "url": "https://github.com/telstra/open-kilda/commit/d876f11bc4833e04517e978b083d754f7a0648d4", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-12T12:42:09Z", "type": "forcePushed"}, {"oid": "12cede5a5b5922b02f9a7f6887ec44694571bfb7", "url": "https://github.com/telstra/open-kilda/commit/12cede5a5b5922b02f9a7f6887ec44694571bfb7", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-12T17:34:53Z", "type": "forcePushed"}, {"oid": "6e2dc1197fe27f979feecefd85307e76f2547fa6", "url": "https://github.com/telstra/open-kilda/commit/6e2dc1197fe27f979feecefd85307e76f2547fa6", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-12T19:05:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NjkxMA==", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365746910", "bodyText": "what's the purpose of such aggregation?", "author": "timofei-durakov", "createdAt": "2020-01-13T11:03:54Z", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -67,33 +72,51 @@ public RerouteService(PersistenceManager persistenceManager) {\n      * @param command origin command\n      */\n     public void rerouteAffectedFlows(MessageSender sender, String correlationId, RerouteAffectedFlows command) {\n+        // TODO(surabujin): need better/more detailed representation of failed ISL\n         PathNode pathNode = command.getPathNode();\n         int port = pathNode.getPortNo();\n         SwitchId switchId = pathNode.getSwitchId();\n+        final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n+\n         Collection<FlowPath> affectedFlowPaths\n                 = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n+        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);", "originalCommit": "6e2dc1197fe27f979feecefd85307e76f2547fa6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "chunk": "diff --git a/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java b/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\nindex 172f532bb..4b12e995d 100644\n--- a/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\n+++ b/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\n\n@@ -78,9 +80,7 @@ public class RerouteService {\n         SwitchId switchId = pathNode.getSwitchId();\n         final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n \n-        Collection<FlowPath> affectedFlowPaths\n-                = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n-        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);\n+        Collection<FlowPath> affectedFlowPaths = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n \n         // swapping affected primary paths with available protected\n         List<FlowPath> pathsForSwapping = getPathsForSwapping(affectedFlowPaths);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NzExMQ==", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365747111", "bodyText": "could you please comment out a scenario for this", "author": "timofei-durakov", "createdAt": "2020-01-13T11:04:24Z", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -67,33 +72,51 @@ public RerouteService(PersistenceManager persistenceManager) {\n      * @param command origin command\n      */\n     public void rerouteAffectedFlows(MessageSender sender, String correlationId, RerouteAffectedFlows command) {\n+        // TODO(surabujin): need better/more detailed representation of failed ISL\n         PathNode pathNode = command.getPathNode();\n         int port = pathNode.getPortNo();\n         SwitchId switchId = pathNode.getSwitchId();\n+        final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n+\n         Collection<FlowPath> affectedFlowPaths\n                 = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n+        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);\n \n         // swapping affected primary paths with available protected\n         List<FlowPath> pathsForSwapping = getPathsForSwapping(affectedFlowPaths);\n         for (FlowPath path : pathsForSwapping) {\n             sender.emitPathSwapCommand(correlationId, path, command.getReason());\n         }\n-        Map<Flow, Set<PathId>> flowsForRerouting = groupFlowsForRerouting(affectedFlowPaths);\n-        for (Entry<Flow, Set<PathId>> entry : flowsForRerouting.entrySet()) {\n-            Flow flow = entry.getKey();\n+\n+        Map<String, List<FlowPath>> flowsForRerouting = groupPathsForRerouting(affectedFlowPaths);\n+        for (Entry<String, List<FlowPath>> entry : flowsForRerouting.entrySet()) {\n+            String flowId = entry.getKey();\n+            List<FlowPath> flowPaths = entry.getValue();\n+\n+            Flow flow = flowById.get(flowId);", "originalCommit": "6e2dc1197fe27f979feecefd85307e76f2547fa6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "chunk": "diff --git a/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java b/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\nindex 172f532bb..4b12e995d 100644\n--- a/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\n+++ b/services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java\n\n@@ -78,9 +80,7 @@ public class RerouteService {\n         SwitchId switchId = pathNode.getSwitchId();\n         final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n \n-        Collection<FlowPath> affectedFlowPaths\n-                = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n-        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);\n+        Collection<FlowPath> affectedFlowPaths = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n \n         // swapping affected primary paths with available protected\n         List<FlowPath> pathsForSwapping = getPathsForSwapping(affectedFlowPaths);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NzkxMA==", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365747910", "bodyText": "what does it mean? leave a doc", "author": "timofei-durakov", "createdAt": "2020-01-13T11:06:35Z", "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/flow/FlowRerouteRequest.java", "diffHunk": "@@ -41,29 +41,37 @@\n     protected String flowId;\n \n     @JsonProperty(\"path_ids\")\n-    protected Set<PathId> pathIds;\n+    protected Set<IslEndpoint> affectedIsl;\n \n     /**\n      * Update flow even if path will not be changed.\n      */\n     @JsonProperty(\"force\")\n     private boolean force;\n \n+    @JsonProperty(\"effectively_down\")\n+    private boolean effectivelyDown;", "originalCommit": "6e2dc1197fe27f979feecefd85307e76f2547fa6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "url": "https://github.com/telstra/open-kilda/commit/448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-13T13:18:08Z", "type": "commit"}, {"oid": "448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "url": "https://github.com/telstra/open-kilda/commit/448f16bf48a6e2aac82bf4b7cec009e83cc426ca", "message": "Fix double network failure handling\n\nAdd queue in front of reroute \"handler\" so if reroute for the flow is\ngoing and new reroute request for this flow received (double network\nfailure case) second request will be postponed.\n\nAt the end of reroute request processing \"handler\" check presence of\npostponed request and handle them.", "committedDate": "2020-01-13T13:18:08Z", "type": "forcePushed"}]}