{"pr_number": 2764, "pr_title": "Fix the trimmed and not transferred segment case in S/T", "pr_createdAt": "2020-09-08T22:35:33Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2764", "timeline": [{"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba", "url": "https://github.com/CorfuDB/CorfuDB/commit/ff6082b0968fc425c4a35b10ee19fa651dda48ba", "message": "Fix the Trimmed/Not Transferred case in S/T", "committedDate": "2020-09-08T22:26:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MjU3NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r485252574", "bodyText": "maybe use two filter methods?\n.filter(segment -> segment.getEnd() <= trimMark)\n.filter(segment ->  !segmentContainsServer(segment, getServer()))", "author": "xnull", "createdAt": "2020-09-08T23:37:40Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java", "diffHunk": "@@ -222,6 +223,38 @@ public static boolean canRestoreRedundancyOrMergeSegments(Layout layout, String\n                 .collect(ImmutableList.toImmutableList());\n     }\n \n+    /**\n+     * Get all the layout segments that were trimmed and that do not contain a current server, and\n+     * return them as TRANSFERRED segments. Since these segments were trimmed, they\n+     * contain zero transferable addresses, and hence are not eligible for state transfer.\n+     * However, since they also do not contain a current server, they should be considered\n+     * TRANSFERRED, eligible for the layout redundancy restoration.\n+     *\n+     * @param layout   A current layout.\n+     * @param trimMark A current global trim mark.\n+     * @return A list of transfer segments.\n+     */\n+    public ImmutableList<TransferSegment> getTrimmedNotRestoredSegments(Layout layout, long trimMark) {\n+        return layout.getSegments()\n+                .stream()\n+                .filter(segment -> segment.getEnd() <= trimMark && !segmentContainsServer(segment, getServer()))", "originalCommit": "ff6082b0968fc425c4a35b10ee19fa651dda48ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU5ODIxNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r486598214", "bodyText": "Usually, when there are multiple consecutive HOFs I think it's better to merge them into one HOF. For example,\n.map(x -> x + 1)\n.map(x -> x * 2) \n\nI think is better expressed as .map(x -> (x + 1) * 2)", "author": "PavelZaytsev", "createdAt": "2020-09-10T19:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MjU3NA=="}], "type": "inlineReview", "revised_code": {"commit": "4146661ef07957fd59411b53a46e6fe323b4d430", "chunk": "diff --git a/infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java b/infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java\nindex af9bb091980..b5520165bd1 100644\n--- a/infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java\n+++ b/infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java\n\n@@ -223,38 +222,6 @@ public class RedundancyCalculator {\n                 .collect(ImmutableList.toImmutableList());\n     }\n \n-    /**\n-     * Get all the layout segments that were trimmed and that do not contain a current server, and\n-     * return them as TRANSFERRED segments. Since these segments were trimmed, they\n-     * contain zero transferable addresses, and hence are not eligible for state transfer.\n-     * However, since they also do not contain a current server, they should be considered\n-     * TRANSFERRED, eligible for the layout redundancy restoration.\n-     *\n-     * @param layout   A current layout.\n-     * @param trimMark A current global trim mark.\n-     * @return A list of transfer segments.\n-     */\n-    public ImmutableList<TransferSegment> getTrimmedNotRestoredSegments(Layout layout, long trimMark) {\n-        return layout.getSegments()\n-                .stream()\n-                .filter(segment -> segment.getEnd() <= trimMark && !segmentContainsServer(segment, getServer()))\n-                .map(segment -> {\n-                    TransferSegmentStatus transferred = TransferSegmentStatus\n-                            .builder()\n-                            .segmentState(TRANSFERRED)\n-                            .build();\n-\n-                    return TransferSegment\n-                            .builder()\n-                            .startAddress(segment.getStart())\n-                            .endAddress(segment.getEnd() - 1L)\n-                            .status(transferred)\n-                            .logUnitServers(ImmutableList.copyOf(segment.getAllLogServers()))\n-                            .build();\n-                })\n-                .collect(ImmutableList.toImmutableList());\n-    }\n-\n     /**\n      * Creates the list of transfer segment ranges\n      * given the transfer segment list and the committed tail.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NjIwOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r486076209", "bodyText": "Even if addresses before the trim mark have been trimmed, they are on disk right?  How is that data restored on B and C?", "author": "pankti-m", "createdAt": "2020-09-10T05:35:45Z", "path": "infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java", "diffHunk": "@@ -556,4 +558,47 @@ public void testPrepareTransferWorkloadCommittedTailSplitsSegment() {\n                 s -> s.equals(testSegments.get(1).getStatus()))).isTrue();\n     }\n \n+    @Test\n+    public void testGetTrimmedNotRestoredSegments() {\n+        Layout.ReplicationMode replicationMode = CHAIN_REPLICATION;\n+        LayoutStripe layoutStripe1 = new LayoutStripe(ImmutableList.of(\"A\"));\n+        LayoutSegment segment1 = new LayoutSegment(replicationMode, 0L, 100L,", "originalCommit": "ff6082b0968fc425c4a35b10ee19fa651dda48ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0NzkxMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r486547910", "bodyText": "There is no real reason to transfer trimmed addresses because logically they are trimmed. The starting address has moved and is past the trim mark. So whether they are present on disk or not, we check it either way and get the same result:\nprivate boolean isTrimmed(long address) {\n        return address < dataStore.getStartingAddress();\n    }", "author": "PavelZaytsev", "createdAt": "2020-09-10T18:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NjIwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4146661ef07957fd59411b53a46e6fe323b4d430", "chunk": "diff --git a/infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java b/infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java\nindex 58731d094cc..82fd87a7fee 100644\n--- a/infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java\n+++ b/infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java\n\n@@ -558,47 +556,4 @@ public class RedundancyCalculatorTest extends LayoutBasedTestHelper implements T\n                 s -> s.equals(testSegments.get(1).getStatus()))).isTrue();\n     }\n \n-    @Test\n-    public void testGetTrimmedNotRestoredSegments() {\n-        Layout.ReplicationMode replicationMode = CHAIN_REPLICATION;\n-        LayoutStripe layoutStripe1 = new LayoutStripe(ImmutableList.of(\"A\"));\n-        LayoutSegment segment1 = new LayoutSegment(replicationMode, 0L, 100L,\n-                ImmutableList.of(layoutStripe1));\n-        LayoutStripe layoutStripe2 = new LayoutStripe(ImmutableList.of(\"B\", \"C\"));\n-        LayoutSegment segment2 = new LayoutSegment(replicationMode, 100L, 150L,\n-                ImmutableList.of(layoutStripe2));\n-        List<String> allServers = ImmutableList.of(\"A\", \"B\", \"C\");\n-        Layout layout = new Layout(allServers, allServers,\n-                ImmutableList.of(segment1, segment2), ImmutableList.of(), 1L,\n-                UUID.randomUUID());\n-        long trimMark = 101L;\n-\n-        ImmutableList<TransferSegment> trimmedNotRestoredSegmentsForA =\n-                new RedundancyCalculator(\"A\")\n-                        .getTrimmedNotRestoredSegments(layout, trimMark);\n-\n-        assertThat(trimmedNotRestoredSegmentsForA).isEmpty();\n-\n-        ImmutableList<TransferSegment> trimmedNotRestoredSegmentsForB =\n-                new RedundancyCalculator(\"B\")\n-                .getTrimmedNotRestoredSegments(layout, trimMark);\n-\n-        ImmutableList<TransferSegment> trimmedNotRestoredSegmentsForC =\n-                new RedundancyCalculator(\"C\")\n-                        .getTrimmedNotRestoredSegments(layout, trimMark);\n-\n-        TransferSegmentStatus transferredStatus =\n-                TransferSegmentStatus.builder().segmentState(TRANSFERRED).build();\n-\n-        ImmutableList<TransferSegment> expectedList = ImmutableList.of(TransferSegment.builder()\n-                .startAddress(0L)\n-                .endAddress(99L)\n-                .logUnitServers(ImmutableList.copyOf(segment1.getAllLogServers()))\n-                .status(transferredStatus).build());\n-\n-        assertThat(trimmedNotRestoredSegmentsForB).isEqualTo(expectedList);\n-\n-        assertThat(trimmedNotRestoredSegmentsForC).isEqualTo(expectedList);\n-    }\n-\n }\n"}}, {"oid": "4146661ef07957fd59411b53a46e6fe323b4d430", "url": "https://github.com/CorfuDB/CorfuDB/commit/4146661ef07957fd59411b53a46e6fe323b4d430", "message": "Calculate Remaining Replicated Entries based on TxStream\n\n- Calculate replicated remaining entries based on the txStream\n  to avoid the issue of holes enforced on regular streams by the checkpointer.\n- Minor bug fix, restarted Snapshot Sync same baseSnapshot (not reject)\n- Add some valuable logging for debugging", "committedDate": "2020-09-10T08:04:00Z", "type": "commit"}, {"oid": "557c9cb9fdeff440763430bf308240eed45b9677", "url": "https://github.com/CorfuDB/CorfuDB/commit/557c9cb9fdeff440763430bf308240eed45b9677", "message": "Merge branch 'master' into st-trim-bug-fix", "committedDate": "2020-09-10T18:05:56Z", "type": "commit"}, {"oid": "a91cc08043966830fcb3a5f787dedf235939fedb", "url": "https://github.com/CorfuDB/CorfuDB/commit/a91cc08043966830fcb3a5f787dedf235939fedb", "message": "Merge branch 'calculateRemainingReplication' of github.com:CorfuDB/CorfuDB into st-trim-bug-fix", "committedDate": "2020-09-10T19:59:10Z", "type": "commit"}, {"oid": "3cfd920d1354714420a5f25d8455cdf1482f7aef", "url": "https://github.com/CorfuDB/CorfuDB/commit/3cfd920d1354714420a5f25d8455cdf1482f7aef", "message": "Fix flaky test", "committedDate": "2020-09-10T21:16:02Z", "type": "commit"}, {"oid": "d4692cfe9ad6e02c83e5785f8ee47310b15d7023", "url": "https://github.com/CorfuDB/CorfuDB/commit/d4692cfe9ad6e02c83e5785f8ee47310b15d7023", "message": "Merge branch 'st-trim-bug-fix' of github.com:CorfuDB/CorfuDB into st-trim-bug-fix", "committedDate": "2020-09-10T21:16:16Z", "type": "commit"}, {"oid": "cbbc5fca6f8891a3418562fcf6477c5a16b04d03", "url": "https://github.com/CorfuDB/CorfuDB/commit/cbbc5fca6f8891a3418562fcf6477c5a16b04d03", "message": "Merge branch 'master' into st-trim-bug-fix", "committedDate": "2020-09-10T21:19:00Z", "type": "commit"}]}