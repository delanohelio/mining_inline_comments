{"pr_number": 2492, "pr_title": "Fix Trim Exception on Raw Stream Access", "pr_createdAt": "2020-03-30T07:49:25Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2492", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNzQ2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492#discussion_r400027460", "bodyText": "Actually for raw streams, looks like we never load the checkpoints: in line 356 there is a filter .filter(x -> x.containsStream(context.id)), which filters out the entries on checkpoint stream, but we still read it because the filter is applied after the read, which is unnecessary. If that is the case, I think we need a clean up, otherwise it's ineffiecient and the logic is fragile, but maybe be can do later as we are short of time now.", "author": "WenbinZhu", "createdAt": "2020-03-30T08:53:00Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/stream/AbstractQueuedStreamView.java", "diffHunk": "@@ -370,6 +371,7 @@ private void processTrimmedException(TrimmedException te) {\n         } else {\n             // Clear the entries which were read\n             context.readQueue.headSet(maxGlobal, true).clear();\n+            context.readCpQueue.headSet(maxGlobal, true).clear();", "originalCommit": "dc5e512c3ffa1e7c5c98ac011c788377f273f3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM3NjM5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492#discussion_r400376395", "bodyText": "so, that's the comment I added as I reminder for us to discuss on what is the right behavior. We do \"load\" the checkpoint (in the sense that we get the addresses for it and we read them, but we don't return them to the consumer of the remaining API). So we need to define the correct behavior, if we decide not to return them we should do a bit of refactoring, cause that means that trying to reuse the stream layer In the same way for object consumption vs. raw consumption was actually not correct and is inefficient, as they behave differently.", "author": "annym", "createdAt": "2020-03-30T17:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNzQ2MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0ab4014c94f050a584bfab0750faed3ae5434893", "url": "https://github.com/CorfuDB/CorfuDB/commit/0ab4014c94f050a584bfab0750faed3ae5434893", "message": "Fix Trim Exception on Raw Stream Access\n\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\n\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP.", "committedDate": "2020-03-31T23:14:11Z", "type": "commit"}, {"oid": "0ab4014c94f050a584bfab0750faed3ae5434893", "url": "https://github.com/CorfuDB/CorfuDB/commit/0ab4014c94f050a584bfab0750faed3ae5434893", "message": "Fix Trim Exception on Raw Stream Access\n\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\n\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP.", "committedDate": "2020-03-31T23:14:11Z", "type": "forcePushed"}]}