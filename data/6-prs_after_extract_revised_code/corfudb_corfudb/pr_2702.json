{"pr_number": 2702, "pr_title": "If layoutHelper returns a WrongClusterException best to shutdown", "pr_createdAt": "2020-08-12T00:08:50Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2702", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzg3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r468937873", "bodyText": "Should the exception still be thrown after the handler is called ?", "author": "Maithem", "createdAt": "2020-08-12T00:30:01Z", "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -1140,6 +1140,7 @@ private void pruneRemovedRouters(@Nonnull Layout layout) {\n                     } catch (WrongClusterException we) {\n                         // It is futile trying to re-connect to the wrong cluster\n                         log.warn(\"Giving up since cluster is incorrect or reconfigured!\");\n+                        parameters.getSystemDownHandler().run();\n                         throw we;", "originalCommit": "d0c656f7f33822f651a4d7b64bfc9681218b6c45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxOTA2Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r469419067", "bodyText": "the reason for throwing the exception is some shutdown handlers may just be no-ops (by intent), in which case we want to still fail the operation.", "author": "hisundar", "createdAt": "2020-08-12T17:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzg3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c3139cc4858e15085277707242a9eb31f3823865", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java b/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\nindex 858a512cb7b..7008afff135 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\n\n@@ -1140,7 +1140,6 @@ public class CorfuRuntime {\n                     } catch (WrongClusterException we) {\n                         // It is futile trying to re-connect to the wrong cluster\n                         log.warn(\"Giving up since cluster is incorrect or reconfigured!\");\n-                        parameters.getSystemDownHandler().run();\n                         throw we;\n                     } catch (ExecutionException ee){\n                         if (ee.getCause() instanceof TimeoutException) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r468943325", "bodyText": "Should we change the layoutHelper instead of here? Here it's fetchLayout, but other operations can still hit WCE", "author": "WenbinZhu", "createdAt": "2020-08-12T00:50:25Z", "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -1140,6 +1140,7 @@ private void pruneRemovedRouters(@Nonnull Layout layout) {\n                     } catch (WrongClusterException we) {\n                         // It is futile trying to re-connect to the wrong cluster\n                         log.warn(\"Giving up since cluster is incorrect or reconfigured!\");\n+                        parameters.getSystemDownHandler().run();", "originalCommit": "d0c656f7f33822f651a4d7b64bfc9681218b6c45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxNTUyNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r469015525", "bodyText": "+1", "author": "annym", "createdAt": "2020-08-12T05:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxOTMwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r469419308", "bodyText": "will do. thanks", "author": "hisundar", "createdAt": "2020-08-12T17:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1Njk2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r470156964", "bodyText": "done. thanks", "author": "hisundar", "createdAt": "2020-08-13T18:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MjUyNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r470162524", "bodyText": "Looks like sometimes this method, fetchLayout, is called inside LayoutHelper, so we will invoke SystemDownHandler twice right? Will this be a problem?", "author": "WenbinZhu", "createdAt": "2020-08-13T18:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NDc4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r470364786", "bodyText": "systemDownHandler are supposed to exit the JVM, so not unless there is another bug right?", "author": "hisundar", "createdAt": "2020-08-14T01:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2OTEzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r470369131", "bodyText": "@hisundar Actually I feel this catch block will never be executed. The exceptions should come from layoutFuture.get(), but that will be wrapped in ExecutionException, which we check in the next catch block, right?", "author": "WenbinZhu", "createdAt": "2020-08-14T01:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyOTY2NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471729665", "bodyText": "@annym @WenbinZhu Since Sundar is out, I fixed it in two places where the issue might happen.\nOne way to get WCE is to invalidateLayout() after our local current node has joined another cluster and it had an identity (clusterId) before that. That WCE is hit when we call invalidateLayout() inside a layoutHelper. checkClusterId inside fetchLayout will throw WrongClusterException that will not be handled, so the runtime layout future will complete with ExecutionException with the cause of the WrongClusterException. Then when in layoutHelper we call getLayoutUninterruptibly() and we call get on the this layout future, we will hit ExecutionException with the the cause of WrongClusterException. Here we should call a systemDownHandler and then propagate this exception (since downhandler might be a no-op).\nAnother way to get WCE is in function.apply in the layoutHelper. This can happen if the function is an RPC and the client message was stamped with one clusterId but the server router on the remote node has another clusterId. Here we should also call a systemDownHandler and propagate the exception.", "author": "PavelZaytsev", "createdAt": "2020-08-17T19:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0ODc0MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471748740", "bodyText": "@PavelZaytsev invalidateLayout() can be called outside of AbstractView, which means if users use runtime.invalidateLayout() directly, then SystemDownHandler will not be trigger, because you don't trigger it in fetchLayout(). So I think the  invocation of SystemDownHandler should be put into CorfuRuntime::fetchLayout instead of AbstractView::getLayoutUninterruptibly(), and also we already have SystemDownHandler invocation logic in fetchLayout()", "author": "WenbinZhu", "createdAt": "2020-08-17T20:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc2MjY1MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471762651", "bodyText": "@WenbinZhu. Ok, I will call it in fetchLayout then every client would have to call system down handler. We still need to call it in the layoutHelper for the RPC case though.  I removed it from getLayoutUninterruptibly, so it will just get propagated as ExecutionException with a RuntimeException cause after the systemDownHandler is called.", "author": "PavelZaytsev", "createdAt": "2020-08-17T20:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc3NzEyMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471777122", "bodyText": "@PavelZaytsev Thanks, but I think there is another problem as I mentioned in the initial commit.  Looks like catch (WrongClusterException we) will never be reached (a bug in the existing code), because execption is wrapped in the ExecutionException. I think this exception handling block should be moved to the catch (ExecutionException ee)  block below, otherwise it will not work.", "author": "WenbinZhu", "createdAt": "2020-08-17T21:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5MjgyNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471792825", "bodyText": "@WenbinZhu catch (WrongClusterException we) is actually getting caught right now and is getting propagated because it is coming from checkClusterId, so it is not wrapped into ExecutionException. You are probably referring to layoutFuture.get() that is being called after getLayout(). But this one can not fail with a WrongClusterException because it is a LAYOUT_REQUEST, and we ignore a clusterId check for it.\nLAYOUT_REQUEST(10, new TypeToken<CorfuPayloadMsg<Long>>(){}, true, true)", "author": "PavelZaytsev", "createdAt": "2020-08-17T21:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMzg3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2702#discussion_r471833873", "bodyText": "I see", "author": "WenbinZhu", "createdAt": "2020-08-17T23:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c3139cc4858e15085277707242a9eb31f3823865", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java b/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\nindex 858a512cb7b..7008afff135 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java\n\n@@ -1140,7 +1140,6 @@ public class CorfuRuntime {\n                     } catch (WrongClusterException we) {\n                         // It is futile trying to re-connect to the wrong cluster\n                         log.warn(\"Giving up since cluster is incorrect or reconfigured!\");\n-                        parameters.getSystemDownHandler().run();\n                         throw we;\n                     } catch (ExecutionException ee){\n                         if (ee.getCause() instanceof TimeoutException) {\n"}}, {"oid": "1917b8bf05a45e1e74509591c0d4b6001a1b2d98", "url": "https://github.com/CorfuDB/CorfuDB/commit/1917b8bf05a45e1e74509591c0d4b6001a1b2d98", "message": "If layoutHelper returns a WrongClusterException best to shutdown", "committedDate": "2020-08-13T07:05:42Z", "type": "forcePushed"}, {"oid": "b38389d35694744088fbf71f26c922c8ea4c3724", "url": "https://github.com/CorfuDB/CorfuDB/commit/b38389d35694744088fbf71f26c922c8ea4c3724", "message": "If layoutHelper returns a WrongClusterException best to shutdown", "committedDate": "2020-08-13T19:04:30Z", "type": "commit"}, {"oid": "b38389d35694744088fbf71f26c922c8ea4c3724", "url": "https://github.com/CorfuDB/CorfuDB/commit/b38389d35694744088fbf71f26c922c8ea4c3724", "message": "If layoutHelper returns a WrongClusterException best to shutdown", "committedDate": "2020-08-13T19:04:30Z", "type": "forcePushed"}, {"oid": "c3139cc4858e15085277707242a9eb31f3823865", "url": "https://github.com/CorfuDB/CorfuDB/commit/c3139cc4858e15085277707242a9eb31f3823865", "message": "Fix WCE invocation", "committedDate": "2020-08-17T19:08:44Z", "type": "commit"}, {"oid": "fcd3fda2742bd703699b8da20e615411574709c7", "url": "https://github.com/CorfuDB/CorfuDB/commit/fcd3fda2742bd703699b8da20e615411574709c7", "message": "Call system down handler in fetch layout", "committedDate": "2020-08-17T20:35:18Z", "type": "commit"}, {"oid": "cd41b436811c309e08bd1e20f3409fce34a96e9b", "url": "https://github.com/CorfuDB/CorfuDB/commit/cd41b436811c309e08bd1e20f3409fce34a96e9b", "message": "Merge branch 'master' into invokeSysDownOnWE", "committedDate": "2020-08-18T04:52:36Z", "type": "commit"}]}