{"pr_number": 2455, "pr_title": "CorfuQueue: Sort entries before returning in entryList()", "pr_createdAt": "2020-03-02T23:28:13Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2455", "timeline": [{"oid": "e23268a23379cd6736d6ca2f74fc748aa541a674", "url": "https://github.com/CorfuDB/CorfuDB/commit/e23268a23379cd6736d6ca2f74fc748aa541a674", "message": "CorfuQueue: Sort entries before returning in entryList()\n\nThis is to preserve order if checkpointer runs first.\nCheckpointer uses a normal HashMap and not a LinkedHashMap\ncausing a loss of ordering if it runs first.\nFix is to sort the entries first.\nThis also enables the api to allow entries to be returned\nonly after a user specified previous entry.", "committedDate": "2020-03-02T23:25:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczODkxNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2455#discussion_r386738915", "bodyText": "Should we filter keys out before collecting to a list?", "author": "zhangn49", "createdAt": "2020-03-03T00:49:01Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuQueue.java", "diffHunk": "@@ -257,16 +259,19 @@ public int compareTo(CorfuQueueRecord<? extends E> o) {\n         List<CorfuQueueRecord<E>> copy = new ArrayList<>(\n                 Math.min(corfuTable.size(), maxEntries)\n         );\n+\n         int index = 0;\n-        for (Map.Entry<Long, E> entry : corfuTable.entrySet()) {\n+        for (Long entryId : corfuTable.keySet().stream().sorted().collect(Collectors.toList())) {", "originalCommit": "e23268a23379cd6736d6ca2f74fc748aa541a674", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0MDIyNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2455#discussion_r386740226", "bodyText": "For maxEntries, maybe we can use Stream.limit()", "author": "zhangn49", "createdAt": "2020-03-03T00:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NjE3OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2455#discussion_r387256178", "bodyText": "I thought about this too, but if we specify stream.limit() then it is possible that the stream has only a small number of entries and if the user has specified a start point towards the end, then it will miss out on the entries.\nhere is the example,\nQ: 1, 2, 3, 4, 5\nUser wants 2 entries AFTER item number 3:\nWe should return: 4, 5\nWith Stream.limit() our collect() will have only 2 entries : 1, 2\nwhich means 4, 5 cannot be processed.\nHope this helps?", "author": "hisundar", "createdAt": "2020-03-03T19:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI3NTIzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2455#discussion_r387275234", "bodyText": "Fixed, I have used the stream.filter as suggested. thanks!", "author": "hisundar", "createdAt": "2020-03-03T20:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczODkxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "6a2f4da53340df5a9b27e4eb799d72781413a07f", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/CorfuQueue.java b/runtime/src/main/java/org/corfudb/runtime/collections/CorfuQueue.java\nindex ee1e6a894c8..7fa5b7837fe 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/CorfuQueue.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/CorfuQueue.java\n\n@@ -261,10 +261,9 @@ public class CorfuQueue<E> {\n         );\n \n         int index = 0;\n-        for (Long entryId : corfuTable.keySet().stream().sorted().collect(Collectors.toList())) {\n-            if (entryId <= entriesAfter) {\n-                continue;\n-            }\n+        for (Long entryId : corfuTable.keySet().stream()\n+                .filter(e -> e > entriesAfter)\n+                .sorted().collect(Collectors.toList())) {\n             if (++index >= maxEntries) {\n                 break;\n             }\n"}}, {"oid": "6a2f4da53340df5a9b27e4eb799d72781413a07f", "url": "https://github.com/CorfuDB/CorfuDB/commit/6a2f4da53340df5a9b27e4eb799d72781413a07f", "message": "CorfuQueue: use stream.filter in entryList()", "committedDate": "2020-03-03T20:28:38Z", "type": "commit"}, {"oid": "de7868a920e0b662562f428152541454111065cc", "url": "https://github.com/CorfuDB/CorfuDB/commit/de7868a920e0b662562f428152541454111065cc", "message": "CorfuQueueTxTest: Use lock() around enqueue to validate order", "committedDate": "2020-03-03T22:29:32Z", "type": "commit"}, {"oid": "749a2a3d7db113e4cf7a789f92106d6f39ff12b3", "url": "https://github.com/CorfuDB/CorfuDB/commit/749a2a3d7db113e4cf7a789f92106d6f39ff12b3", "message": "Merge branch 'master' into sortQorder", "committedDate": "2020-03-04T00:46:01Z", "type": "commit"}]}