{"pr_number": 2385, "pr_title": "move scanAndFilter to StreamingMap", "pr_createdAt": "2020-02-08T22:56:47Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2385", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjExNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376746115", "bodyText": "This is using Java's common pool. I believe this will introduce a regression -- this is why a separate thread pool was introduced.", "author": "vjeko", "createdAt": "2020-02-09T01:01:10Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java", "diffHunk": "@@ -131,4 +135,25 @@ public void clear() {\n     public Set<Entry<K, V>> entrySet() {\n         return mapImpl.entrySet();\n     }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n+        return mapImpl.values().parallelStream()\n+                .filter(valuePredicate)\n+                .collect(Collectors.toCollection(ArrayList::new));\n+    }", "originalCommit": "094169a7d6e53414afe38de3a8a89e068732cafc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MTIzNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376751237", "bodyText": "Done.", "author": "zhangn49", "createdAt": "2020-02-09T03:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjExNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f002b15c4e4ab67975473f8377c59680393d13dd", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\nindex 97daa719ded..93f3b2eb3de 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\n\n@@ -141,9 +157,9 @@ public class StreamingMapDecorator<K, V> implements ContextAwareMap<K, V> {\n      */\n     @Override\n     public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return mapImpl.values().parallelStream()\n+        return pool.submit(() -> mapImpl.values().parallelStream()\n                 .filter(valuePredicate)\n-                .collect(Collectors.toCollection(ArrayList::new));\n+                .collect(Collectors.toCollection(ArrayList::new))).join();\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjEyNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376746124", "bodyText": "Same comment here.", "author": "vjeko", "createdAt": "2020-02-09T01:01:18Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java", "diffHunk": "@@ -131,4 +135,25 @@ public void clear() {\n     public Set<Entry<K, V>> entrySet() {\n         return mapImpl.entrySet();\n     }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n+        return mapImpl.values().parallelStream()\n+                .filter(valuePredicate)\n+                .collect(Collectors.toCollection(ArrayList::new));\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Collection<Entry<K, V>> scanAndFilterByEntry(\n+            Predicate<? super Entry<K, V>> entryPredicate) {\n+        return mapImpl.entrySet().parallelStream()\n+                .filter(entryPredicate)\n+                .collect(Collectors.toCollection(ArrayList::new));\n+    }", "originalCommit": "094169a7d6e53414afe38de3a8a89e068732cafc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MTIyNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376751225", "bodyText": "Done.", "author": "zhangn49", "createdAt": "2020-02-09T03:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjEyNA=="}], "type": "inlineReview", "revised_code": {"commit": "f002b15c4e4ab67975473f8377c59680393d13dd", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\nindex 97daa719ded..93f3b2eb3de 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMapDecorator.java\n\n@@ -141,9 +157,9 @@ public class StreamingMapDecorator<K, V> implements ContextAwareMap<K, V> {\n      */\n     @Override\n     public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return mapImpl.values().parallelStream()\n+        return pool.submit(() -> mapImpl.values().parallelStream()\n                 .filter(valuePredicate)\n-                .collect(Collectors.toCollection(ArrayList::new));\n+                .collect(Collectors.toCollection(ArrayList::new))).join();\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjIxMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376746210", "bodyText": "PersistedStreamingMap cannot take advantage of parallel processing, so there is no point of spawning more than one thread. Is there a reason why ForkJoinPool was moved out of CorfuTable?", "author": "vjeko", "createdAt": "2020-02-09T01:03:33Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -33,6 +38,19 @@\n  */\n @Slf4j\n public class PersistedStreamingMap<K, V> implements ContextAwareMap<K, V> {\n+    // Accessor/Mutator threads can interleave in a way that create a deadlock because they can create a\n+    // circular dependency between the VersionLockedObject(VLO) lock and the common forkjoin thread pool. In order\n+    // to break the dependency, parallel stream operations have to execute on a separate pool that applications\n+    // cant use. For example, if there are 4 accessor threads all using the common forkjoin pool, one of the threads\n+    // can acquire the VLO lock and cause the other 3 threads to wait, but after acquiring the VLO lock, the thread\n+    // gets block on parallel stream, because the pool is exhausted with threads that are trying to acquire the VLO\n+    // look, which creates a circular dependency. In other words, a deadlock.\n+    private final static ForkJoinPool pool = new ForkJoinPool(Runtime.getRuntime().availableProcessors() - 1,\n+            pool -> {\n+                final ForkJoinWorkerThread worker = ForkJoinPool.defaultForkJoinWorkerThreadFactory.newThread(pool);\n+                worker.setName(\"PersistedStreamingMap-Forkjoin-pool-\" + worker.getPoolIndex());\n+                return worker;\n+            }, null, true);", "originalCommit": "094169a7d6e53414afe38de3a8a89e068732cafc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjgyMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376746823", "bodyText": "I was not very clear about PersistedStreamingMap.\nForkJoinPool was moved out of CorfuTable because I need StreamingMapDecorator.scanAndFilter to get rid of fromMap. If PersistedStreamingMap cannot take advantage of parallel processing, I should put ForkJoinPool to StreamingMapDecorator.", "author": "zhangn49", "createdAt": "2020-02-09T01:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0ODA4Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376748082", "bodyText": "Just to give you a bit of context.\nPersistedStreamingMap uses RocksDB underneath, which by design does not allow multi-threaded data iteration. So in this case, you can just scan the data using the same client thread -- no need for a new thread pool executor.\nStreamingMapDecorator on the other hand has no such restrictions, and this is why parallelStream() can be used. However, there was a bug with using a common thread pool that would cause deadlock in some circumstances. This is why ForkJoinPool was introduced.", "author": "vjeko", "createdAt": "2020-02-09T01:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MTIxMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r376751210", "bodyText": "Thanks for the context. I thought RocksDB iterator could somehow split data and operate in parallel so moved it here.\nI have moved it to StreamingMapDecorator", "author": "zhangn49", "createdAt": "2020-02-09T03:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjIxMA=="}], "type": "inlineReview", "revised_code": {"commit": "f002b15c4e4ab67975473f8377c59680393d13dd", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java b/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\nindex 7b6ad1ba3d7..3bbd41532f6 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\n\n@@ -38,19 +36,6 @@ import java.util.stream.Stream;\n  */\n @Slf4j\n public class PersistedStreamingMap<K, V> implements ContextAwareMap<K, V> {\n-    // Accessor/Mutator threads can interleave in a way that create a deadlock because they can create a\n-    // circular dependency between the VersionLockedObject(VLO) lock and the common forkjoin thread pool. In order\n-    // to break the dependency, parallel stream operations have to execute on a separate pool that applications\n-    // cant use. For example, if there are 4 accessor threads all using the common forkjoin pool, one of the threads\n-    // can acquire the VLO lock and cause the other 3 threads to wait, but after acquiring the VLO lock, the thread\n-    // gets block on parallel stream, because the pool is exhausted with threads that are trying to acquire the VLO\n-    // look, which creates a circular dependency. In other words, a deadlock.\n-    private final static ForkJoinPool pool = new ForkJoinPool(Runtime.getRuntime().availableProcessors() - 1,\n-            pool -> {\n-                final ForkJoinWorkerThread worker = ForkJoinPool.defaultForkJoinWorkerThreadFactory.newThread(pool);\n-                worker.setName(\"PersistedStreamingMap-Forkjoin-pool-\" + worker.getPoolIndex());\n-                return worker;\n-            }, null, true);\n \n     static {\n         RocksDB.loadLibrary();\n"}}, {"oid": "f002b15c4e4ab67975473f8377c59680393d13dd", "url": "https://github.com/CorfuDB/CorfuDB/commit/f002b15c4e4ab67975473f8377c59680393d13dd", "message": "move scanAndFilter to StreamingMap", "committedDate": "2020-02-09T02:31:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwODA2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r377308060", "bodyText": "Maybe we can do this in another patch, but we need to get rid of this.\nIf the table set cannot fit in memory, then its possible that the resulting set won't fit in memory.\nApplications can just directly use the Stream exposed by entryStream.", "author": "Maithem", "createdAt": "2020-02-10T20:49:27Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -275,6 +278,27 @@ public void clear() {\n         return resStream;\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n+        return entryStream()\n+                .map(Entry::getValue).filter(valuePredicate)\n+                .collect(Collectors.toCollection(ArrayList::new));\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Collection<Entry<K, V>> scanAndFilterByEntry(\n+            Predicate<? super Entry<K, V>> entryPredicate) {\n+        return entryStream()\n+                .filter(entryPredicate)\n+                .collect(Collectors.toCollection(ArrayList::new));\n+    }\n+", "originalCommit": "f002b15c4e4ab67975473f8377c59680393d13dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d86317e5229970b72c88885209ff9c518a081616", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java b/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\nindex 3bbd41532f6..c190bf2e602 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java\n\n@@ -278,27 +274,6 @@ public class PersistedStreamingMap<K, V> implements ContextAwareMap<K, V> {\n         return resStream;\n     }\n \n-    /**\n-     * {@inheritDoc}\n-     */\n-    @Override\n-    public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return entryStream()\n-                .map(Entry::getValue).filter(valuePredicate)\n-                .collect(Collectors.toCollection(ArrayList::new));\n-    }\n-\n-    /**\n-     * {@inheritDoc}\n-     */\n-    @Override\n-    public Collection<Entry<K, V>> scanAndFilterByEntry(\n-            Predicate<? super Entry<K, V>> entryPredicate) {\n-        return entryStream()\n-                .filter(entryPredicate)\n-                .collect(Collectors.toCollection(ArrayList::new));\n-    }\n-\n     /**\n      * Close the underlying database.\n      */\n"}}, {"oid": "d86317e5229970b72c88885209ff9c518a081616", "url": "https://github.com/CorfuDB/CorfuDB/commit/d86317e5229970b72c88885209ff9c518a081616", "message": "move scanAndFilter to StreamingMap", "committedDate": "2020-02-11T00:38:37Z", "type": "commit"}, {"oid": "d86317e5229970b72c88885209ff9c518a081616", "url": "https://github.com/CorfuDB/CorfuDB/commit/d86317e5229970b72c88885209ff9c518a081616", "message": "move scanAndFilter to StreamingMap", "committedDate": "2020-02-11T00:38:37Z", "type": "forcePushed"}, {"oid": "03d6120b485f0833b532ad6463505b9208bd98ed", "url": "https://github.com/CorfuDB/CorfuDB/commit/03d6120b485f0833b532ad6463505b9208bd98ed", "message": "Merge branch 'master' into scan_and_filter", "committedDate": "2020-02-11T00:54:46Z", "type": "commit"}, {"oid": "730497c6c0b6a6d9ffb4190f6220d42b02d38067", "url": "https://github.com/CorfuDB/CorfuDB/commit/730497c6c0b6a6d9ffb4190f6220d42b02d38067", "message": "Merge branch 'master' into scan_and_filter", "committedDate": "2020-02-11T06:19:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDQ5Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r377480492", "bodyText": "Can you use try-resources on the stream so that It is explicitly closed after its used.\nLike this\ne8f154e#diff-6f23471c25711fa551fa3b560d27d49dR154", "author": "Maithem", "createdAt": "2020-02-11T07:48:42Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java", "diffHunk": "@@ -368,17 +365,11 @@ public void insert(@ConflictParameter K key, V value) {\n         // operations are needed to be executed on the internal data structure\n     }\n \n-    /**\n-     * Returns a filtered {@link List} view of the values contained in this map.\n-     * This method has a memory/CPU advantage over the map iterators as no deep copy\n-     * is actually performed.\n-     *\n-     * @param valuePredicate java predicate (function to evaluate)\n-     * @return a view of the values contained in this map meeting the predicate condition.\n-     */\n+    /** {@inheritDoc} */\n+    @Override\n     @Accessor\n     public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return pool.submit(() -> mainMap.entryStream()\n+        return pool.submit(() -> mainMap.mutableEntryStream()\n                 .map(Entry::getValue).filter(valuePredicate)", "originalCommit": "730497c6c0b6a6d9ffb4190f6220d42b02d38067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzNTIyMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r377835220", "bodyText": "done.", "author": "zhangn49", "createdAt": "2020-02-11T19:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDQ5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "891280874c28fe4abe3a7e00a7c9a4c14c26915a", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java b/runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java\nindex f5f53aa2b13..4630a082cb9 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java\n\n@@ -369,9 +369,11 @@ public class CorfuTable<K, V> implements\n     @Override\n     @Accessor\n     public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return pool.submit(() -> mainMap.mutableEntryStream()\n-                .map(Entry::getValue).filter(valuePredicate)\n-                .collect(Collectors.toCollection(ArrayList::new))).join();\n+        try (Stream<Map.Entry<K, V>> entries = mainMap.unsafeEntryStream()) {\n+            return pool.submit(() -> entries\n+                    .map(Entry::getValue).filter(valuePredicate)\n+                    .collect(Collectors.toCollection(ArrayList::new))).join();\n+        }\n     }\n \n     /** {@inheritDoc} */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MTI2Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2385#discussion_r377481262", "bodyText": "I think unsafeStream is a more appropriate adjective. It also makes it clear that it can only be used under an Accessor lock.\nI would also prefer to not have a default method. Just stub it out in the implementation.", "author": "Maithem", "createdAt": "2020-02-11T07:51:25Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/StreamingMap.java", "diffHunk": "@@ -21,4 +20,8 @@\n      * @return stream of entries\n      */\n     Stream<Map.Entry<K, V>> entryStream();\n+\n+    default Stream<Map.Entry<K, V>> mutableEntryStream() {", "originalCommit": "730497c6c0b6a6d9ffb4190f6220d42b02d38067", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "891280874c28fe4abe3a7e00a7c9a4c14c26915a", "chunk": "diff --git a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMap.java b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMap.java\nindex cea1443e219..2f7c8f216b1 100644\n--- a/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMap.java\n+++ b/runtime/src/main/java/org/corfudb/runtime/collections/StreamingMap.java\n\n@@ -21,7 +21,7 @@ public interface StreamingMap<K, V> extends Map<K, V> {\n      */\n     Stream<Map.Entry<K, V>> entryStream();\n \n-    default Stream<Map.Entry<K, V>> mutableEntryStream() {\n+    default Stream<Map.Entry<K, V>> unsafeEntryStream() {\n         return entryStream();\n     }\n }\n"}}, {"oid": "891280874c28fe4abe3a7e00a7c9a4c14c26915a", "url": "https://github.com/CorfuDB/CorfuDB/commit/891280874c28fe4abe3a7e00a7c9a4c14c26915a", "message": "address comment", "committedDate": "2020-02-11T19:00:42Z", "type": "commit"}]}