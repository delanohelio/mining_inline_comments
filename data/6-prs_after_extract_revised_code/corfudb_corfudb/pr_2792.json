{"pr_number": 2792, "pr_title": "Use Node Id to match topology for LR", "pr_createdAt": "2020-10-16T03:14:52Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2792", "timeline": [{"oid": "c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "url": "https://github.com/CorfuDB/CorfuDB/commit/c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "message": "Use node_id to match topology in LR", "committedDate": "2020-10-16T04:07:50Z", "type": "forcePushed"}, {"oid": "b2b5223b23c2cf4967cd7cb402abf996a1b65e66", "url": "https://github.com/CorfuDB/CorfuDB/commit/b2b5223b23c2cf4967cd7cb402abf996a1b65e66", "message": "Use node_id to match topology in LR", "committedDate": "2020-10-16T04:13:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MTQyOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506661428", "bodyText": "can we add a logging warning if no Node Id file path is found?", "author": "annym", "createdAt": "2020-10-16T18:46:57Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -864,4 +875,20 @@ private void updateReplicationStatus() {\n             statusFlag = true;\n         }\n     }\n+\n+    private void setupLocalNodeId() {\n+        // Retrieve system-specific node id\n+        LogReplicationPluginConfig config = new LogReplicationPluginConfig(serverContext.getPluginConfigFilePath());\n+        String nodeIdFilePath = config.getNodeIdFilePath();\n+        if (nodeIdFilePath != null) {\n+            File nodeIdFile = new File(nodeIdFilePath);\n+            try (BufferedReader bufferedReader = new BufferedReader(new FileReader(nodeIdFile))) {\n+                String line = bufferedReader.readLine();\n+                localNodeId = Optional.of(line.split(\"=\")[1].trim().toLowerCase());\n+                log.info(\"setupLocalNodeId succeeded, node id is {}\", localNodeId);\n+            } catch (Exception e) {\n+                log.warn(\"setupLocalNodeId failed\", e);\n+            }\n+        }", "originalCommit": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY3MDU0OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506670548", "bodyText": "Added", "author": "zhangn49", "createdAt": "2020-10-16T19:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MTQyOA=="}], "type": "inlineReview", "revised_code": {"commit": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "chunk": "diff --git a/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java b/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\nindex 44e1c78083a..20d48e20076 100644\n--- a/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\n+++ b/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\n\n@@ -889,6 +889,8 @@ public class CorfuReplicationDiscoveryService implements Runnable, CorfuReplicat\n             } catch (Exception e) {\n                 log.warn(\"setupLocalNodeId failed\", e);\n             }\n+        } else {\n+            log.warn(\"setupLocalNodeId failed, because nodeId file path is missing!\");\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MjM0Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506662346", "bodyText": "Can you add a comment on the method that specifies the format in which the node must be written in this file? for future reference..", "author": "annym", "createdAt": "2020-10-16T18:48:51Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/LogReplicationPluginConfig.java", "diffHunk": "@@ -83,6 +86,8 @@ public LogReplicationPluginConfig(String filepath) {\n \n             this.topologyManagerAdapterJARPath = prop.getProperty(\"topology_manager_adapter_JAR_path\");\n             this.topologyManagerAdapterName = prop.getProperty(\"topology_manager_adapter_class_name\");\n+\n+            this.nodeIdFilePath = prop.getProperty(\"local_node_id_path\");", "originalCommit": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY3MDkyOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506670929", "bodyText": "Added file format :\n\nnode_id=99F30C42-F96D-A0A7-5531-468E52926A01", "author": "zhangn49", "createdAt": "2020-10-16T19:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MjM0Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "url": "https://github.com/CorfuDB/CorfuDB/commit/47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "message": "Use node_id to match topology in LR\n\nAddressed comments", "committedDate": "2020-10-16T19:05:41Z", "type": "commit"}, {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "url": "https://github.com/CorfuDB/CorfuDB/commit/47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "message": "Use node_id to match topology in LR\n\nAddressed comments", "committedDate": "2020-10-16T19:05:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc1MDE4Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506750183", "bodyText": "can we only say 'nodeId format'?  what does 'file' mean here?", "author": "pankti-m", "createdAt": "2020-10-16T22:38:36Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/LogReplicationPluginConfig.java", "diffHunk": "@@ -67,6 +67,11 @@\n     @Getter\n     private String snapshotSyncPluginCanonicalName;\n \n+    // nodeId file format:", "originalCommit": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}