{"pr_number": 3648, "pr_title": "added default queue for device profile", "pr_createdAt": "2020-10-28T12:48:46Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3648", "timeline": [{"oid": "e381208557185ed77b457180bae1b4b0a2ebd950", "url": "https://github.com/thingsboard/thingsboard/commit/e381208557185ed77b457180bae1b4b0a2ebd950", "message": "added default queue for device profile", "committedDate": "2020-10-28T12:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0MDM0NQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3648#discussion_r513440345", "bodyText": "Please add one more option and the following method\nTbMsg.transformMsg(tbMsg, targetRuleChainId, targetQueueName)", "author": "ashvayka", "createdAt": "2020-10-28T13:27:09Z", "path": "application/src/main/java/org/thingsboard/server/service/queue/DefaultTbClusterService.java", "diffHunk": "@@ -159,6 +159,10 @@ private TbMsg transformMsg(TbMsg tbMsg, DeviceProfile deviceProfile) {\n             if (targetRuleChainId != null && !targetRuleChainId.equals(tbMsg.getRuleChainId())) {\n                 tbMsg = TbMsg.transformMsg(tbMsg, targetRuleChainId);\n             }\n+            String targetQueueName = deviceProfile.getDefaultQueueName();", "originalCommit": "e381208557185ed77b457180bae1b4b0a2ebd950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4OTg1Ng==", "url": "https://github.com/thingsboard/thingsboard/pull/3648#discussion_r513489856", "bodyText": "done", "author": "YevhenBondarenko", "createdAt": "2020-10-28T14:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0MDM0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5213529785d9eb888007bba22eddecbabac123fd", "chunk": "diff --git a/application/src/main/java/org/thingsboard/server/service/queue/DefaultTbClusterService.java b/application/src/main/java/org/thingsboard/server/service/queue/DefaultTbClusterService.java\nindex 5d59955e2b..9a331bb208 100644\n--- a/application/src/main/java/org/thingsboard/server/service/queue/DefaultTbClusterService.java\n+++ b/application/src/main/java/org/thingsboard/server/service/queue/DefaultTbClusterService.java\n\n@@ -156,11 +156,15 @@ public class DefaultTbClusterService implements TbClusterService {\n     private TbMsg transformMsg(TbMsg tbMsg, DeviceProfile deviceProfile) {\n         if (deviceProfile != null) {\n             RuleChainId targetRuleChainId = deviceProfile.getDefaultRuleChainId();\n-            if (targetRuleChainId != null && !targetRuleChainId.equals(tbMsg.getRuleChainId())) {\n-                tbMsg = TbMsg.transformMsg(tbMsg, targetRuleChainId);\n-            }\n             String targetQueueName = deviceProfile.getDefaultQueueName();\n-            if (targetQueueName != null && !targetQueueName.equals(tbMsg.getQueueName())) {\n+            boolean isRuleChainTransform = targetRuleChainId != null && !targetRuleChainId.equals(tbMsg.getRuleChainId());\n+            boolean isQueueTransform = targetQueueName != null && !targetQueueName.equals(tbMsg.getQueueName());\n+\n+            if (isRuleChainTransform && isQueueTransform) {\n+                tbMsg = TbMsg.transformMsg(tbMsg, targetRuleChainId, targetQueueName);\n+            } else if (isRuleChainTransform) {\n+                tbMsg = TbMsg.transformMsg(tbMsg, targetRuleChainId);\n+            } else if (isQueueTransform) {\n                 tbMsg = TbMsg.transformMsg(tbMsg, targetQueueName);\n             }\n         }\n"}}, {"oid": "5213529785d9eb888007bba22eddecbabac123fd", "url": "https://github.com/thingsboard/thingsboard/commit/5213529785d9eb888007bba22eddecbabac123fd", "message": "DefaultTransportService refactored", "committedDate": "2020-10-28T14:28:04Z", "type": "commit"}, {"oid": "b41fb89e281bad82e1776af9d7a6999fc643e59b", "url": "https://github.com/thingsboard/thingsboard/commit/b41fb89e281bad82e1776af9d7a6999fc643e59b", "message": "revert import changes from DefaultTransportService", "committedDate": "2020-10-28T14:56:13Z", "type": "commit"}, {"oid": "c9f638d799b3141ed8232074639d16089c25371e", "url": "https://github.com/thingsboard/thingsboard/commit/c9f638d799b3141ed8232074639d16089c25371e", "message": "revert DefaultTransportService", "committedDate": "2020-10-28T15:00:31Z", "type": "commit"}]}