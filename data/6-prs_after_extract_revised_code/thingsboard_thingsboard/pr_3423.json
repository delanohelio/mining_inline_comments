{"pr_number": 3423, "pr_title": "[3.2] Feature/Proto Converter", "pr_createdAt": "2020-09-07T16:18:46Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3423", "timeline": [{"oid": "d182692364388e01042423c18e99c6f44e7e7768", "url": "https://github.com/thingsboard/thingsboard/commit/d182692364388e01042423c18e99c6f44e7e7768", "message": "device post-telemetry & post-attributes & claim", "committedDate": "2020-05-18T16:31:16Z", "type": "commit"}, {"oid": "7c68aa16386a165fc45575454efa347e1852d3b8", "url": "https://github.com/thingsboard/thingsboard/commit/7c68aa16386a165fc45575454efa347e1852d3b8", "message": "device rpc to/from server & attributes request, attributes updates", "committedDate": "2020-05-19T15:08:57Z", "type": "commit"}, {"oid": "5d6b67f8a06b0518ead55107df9634256b216542", "url": "https://github.com/thingsboard/thingsboard/commit/5d6b67f8a06b0518ead55107df9634256b216542", "message": "refactoring & added implementation for gateway protos api", "committedDate": "2020-05-20T12:50:37Z", "type": "commit"}, {"oid": "965dc1dcb403518e0d761eb280c83defc6b7bd9b", "url": "https://github.com/thingsboard/thingsboard/commit/965dc1dcb403518e0d761eb280c83defc6b7bd9b", "message": "added timeseries/attributes mqtt tests", "committedDate": "2020-05-26T09:43:31Z", "type": "commit"}, {"oid": "6df50ac59fa656fa8263f1e48358062654f3df7b", "url": "https://github.com/thingsboard/thingsboard/commit/6df50ac59fa656fa8263f1e48358062654f3df7b", "message": "fix MqttTimseriesIntegrationTest values asserts", "committedDate": "2020-05-26T11:54:40Z", "type": "commit"}, {"oid": "e1ef1edfe422a9170fa1b14c0f9351a06e8c9758", "url": "https://github.com/thingsboard/thingsboard/commit/e1ef1edfe422a9170fa1b14c0f9351a06e8c9758", "message": "mqtt attributes tests improvements", "committedDate": "2020-05-26T14:10:51Z", "type": "commit"}, {"oid": "eedb9aa4052ad4c28cd8ed17b63630b45cac81ae", "url": "https://github.com/thingsboard/thingsboard/commit/eedb9aa4052ad4c28cd8ed17b63630b45cac81ae", "message": "optimized time for telemetry & attributes tests", "committedDate": "2020-05-27T08:42:02Z", "type": "commit"}, {"oid": "2a6ac25d90b68a2ab195d32cc1bd988825249772", "url": "https://github.com/thingsboard/thingsboard/commit/2a6ac25d90b68a2ab195d32cc1bd988825249772", "message": "update proto files, refactoring converter, attribute requests tests", "committedDate": "2020-06-03T19:47:32Z", "type": "commit"}, {"oid": "4b2d2a63ab2a712ef47f7fa27c4b5f3034f3c5b9", "url": "https://github.com/thingsboard/thingsboard/commit/4b2d2a63ab2a712ef47f7fa27c4b5f3034f3c5b9", "message": "added claim tests, attribute request test", "committedDate": "2020-06-11T16:14:53Z", "type": "commit"}, {"oid": "8ca4b0058c6c3f938ca5d76b96d4a7bd7d8ca060", "url": "https://github.com/thingsboard/thingsboard/commit/8ca4b0058c6c3f938ca5d76b96d4a7bd7d8ca060", "message": "added deleted keys to gateway response on attributes request & refactored tests", "committedDate": "2020-06-12T12:18:46Z", "type": "commit"}, {"oid": "751dd3cfef4360e4835bbe47fbd3d049a282e6b0", "url": "https://github.com/thingsboard/thingsboard/commit/751dd3cfef4360e4835bbe47fbd3d049a282e6b0", "message": "added attribute updates test & refactored attribute requests tests", "committedDate": "2020-06-25T08:54:53Z", "type": "commit"}, {"oid": "659863692c758f77574495f358d8dc2f43a2706d", "url": "https://github.com/thingsboard/thingsboard/commit/659863692c758f77574495f358d8dc2f43a2706d", "message": "merge with develop/2.5.3", "committedDate": "2020-06-25T09:43:26Z", "type": "commit"}, {"oid": "962adaa4697cf14f538e5859aeb03061bd7e0723", "url": "https://github.com/thingsboard/thingsboard/commit/962adaa4697cf14f538e5859aeb03061bd7e0723", "message": "added attribute updates tests for gateways", "committedDate": "2020-07-30T10:59:01Z", "type": "commit"}, {"oid": "870733683a4fdd0d4761592b6eca0d7dd9f6dc07", "url": "https://github.com/thingsboard/thingsboard/commit/870733683a4fdd0d4761592b6eca0d7dd9f6dc07", "message": "merge with develop-2.5.3", "committedDate": "2020-08-13T14:21:56Z", "type": "commit"}, {"oid": "110cc3b76de89aef6e1811248d3524c4207bd5a6", "url": "https://github.com/thingsboard/thingsboard/commit/110cc3b76de89aef6e1811248d3524c4207bd5a6", "message": "added tests for RPC", "committedDate": "2020-08-18T12:55:36Z", "type": "commit"}, {"oid": "150f489e556465108a57561be85f87a0be8b5c90", "url": "https://github.com/thingsboard/thingsboard/commit/150f489e556465108a57561be85f87a0be8b5c90", "message": "fix tests & cleanup code", "committedDate": "2020-08-26T12:30:24Z", "type": "commit"}, {"oid": "f43b86ddc9164b14323130f3e8aba26f21d40490", "url": "https://github.com/thingsboard/thingsboard/commit/f43b86ddc9164b14323130f3e8aba26f21d40490", "message": "Merge branch 'develop/2.5.4' into feature/proto-converter", "committedDate": "2020-08-26T12:34:32Z", "type": "commit"}, {"oid": "9becb1203b5ef49932bfd7131ea118ee83251db7", "url": "https://github.com/thingsboard/thingsboard/commit/9becb1203b5ef49932bfd7131ea118ee83251db7", "message": "fix typo & cleanup transport.proto file", "committedDate": "2020-08-26T12:49:25Z", "type": "commit"}, {"oid": "19b4ef127e422279625c8233cabcc954dfb8e811", "url": "https://github.com/thingsboard/thingsboard/commit/19b4ef127e422279625c8233cabcc954dfb8e811", "message": "added more timeouts", "committedDate": "2020-08-26T15:00:24Z", "type": "commit"}, {"oid": "2e156ad368a92903e0b48313a5080655089eadf3", "url": "https://github.com/thingsboard/thingsboard/commit/2e156ad368a92903e0b48313a5080655089eadf3", "message": "Merge branch 'develop/2.5.5' into feature/proto-converter", "committedDate": "2020-09-07T08:50:27Z", "type": "commit"}, {"oid": "d6a36286b98c38095f6db4c3df3aa0db86109d74", "url": "https://github.com/thingsboard/thingsboard/commit/d6a36286b98c38095f6db4c3df3aa0db86109d74", "message": "Merge branch 'develop/2.5.5' into feature/proto-converter", "committedDate": "2020-09-07T08:53:43Z", "type": "commit"}, {"oid": "e8cdcb1bf84f1a08b56fbde46e040239efd87b62", "url": "https://github.com/thingsboard/thingsboard/commit/e8cdcb1bf84f1a08b56fbde46e040239efd87b62", "message": "revert handleGetAttributesRequest method", "committedDate": "2020-09-07T09:04:28Z", "type": "commit"}, {"oid": "feb646cc99ed4256696476c6c21c05d8c6b569d1", "url": "https://github.com/thingsboard/thingsboard/commit/feb646cc99ed4256696476c6c21c05d8c6b569d1", "message": "revert package-locks", "committedDate": "2020-09-07T09:19:11Z", "type": "commit"}, {"oid": "0c3875607fee6f648563f0c986987d64be121d8b", "url": "https://github.com/thingsboard/thingsboard/commit/0c3875607fee6f648563f0c986987d64be121d8b", "message": "fix getJsonObjectForGateway method", "committedDate": "2020-09-07T09:36:16Z", "type": "commit"}, {"oid": "c52ad0f0f0c878149d63029cb8f1eb38f62f8aa5", "url": "https://github.com/thingsboard/thingsboard/commit/c52ad0f0f0c878149d63029cb8f1eb38f62f8aa5", "message": "fix validateSharedResponseGateway method in AbstractMqttAttributesRequestIntegrationTest", "committedDate": "2020-09-07T09:50:13Z", "type": "commit"}, {"oid": "c8ac0036e7306e26b76904fdb05ec9bdb1492898", "url": "https://github.com/thingsboard/thingsboard/commit/c8ac0036e7306e26b76904fdb05ec9bdb1492898", "message": "fix mqtt topics", "committedDate": "2020-09-07T14:36:23Z", "type": "commit"}, {"oid": "388ed1f1b693609b2d1429139511e98062d9b703", "url": "https://github.com/thingsboard/thingsboard/commit/388ed1f1b693609b2d1429139511e98062d9b703", "message": "merge with 3.2", "committedDate": "2020-09-07T16:12:55Z", "type": "commit"}, {"oid": "8c4a8dcb2dbfca6f6cf7e1c073c6a79382a52e11", "url": "https://github.com/thingsboard/thingsboard/commit/8c4a8dcb2dbfca6f6cf7e1c073c6a79382a52e11", "message": "merge with develop 3.2", "committedDate": "2020-09-27T11:15:32Z", "type": "commit"}, {"oid": "6bb90a2f323c41bcbc9b825e4499d4b39fd11ba8", "url": "https://github.com/thingsboard/thingsboard/commit/6bb90a2f323c41bcbc9b825e4499d4b39fd11ba8", "message": "fix license headers", "committedDate": "2020-09-27T11:18:21Z", "type": "commit"}, {"oid": "4576efcdb204f80b3a8f99d5f81a71d7eb7a91e7", "url": "https://github.com/thingsboard/thingsboard/commit/4576efcdb204f80b3a8f99d5f81a71d7eb7a91e7", "message": "refactor tests", "committedDate": "2020-09-29T07:49:21Z", "type": "commit"}, {"oid": "7a763bc4122129a560a84a32e588bf84e00e43ea", "url": "https://github.com/thingsboard/thingsboard/commit/7a763bc4122129a560a84a32e588bf84e00e43ea", "message": "remove todo and lck files from pull", "committedDate": "2020-09-29T07:56:55Z", "type": "commit"}, {"oid": "d47d29ee39e01f5de3886dcc00b15dfe85a28d6f", "url": "https://github.com/thingsboard/thingsboard/commit/d47d29ee39e01f5de3886dcc00b15dfe85a28d6f", "message": "Merge branch 'develop/3.2' of github.com:ShvaykaD/thingsboard into feature/proto-converter", "committedDate": "2020-09-29T09:30:20Z", "type": "commit"}, {"oid": "aa0aba4bd8ad14ab2d129e60b47e4c85ef3cab83", "url": "https://github.com/thingsboard/thingsboard/commit/aa0aba4bd8ad14ab2d129e60b47e4c85ef3cab83", "message": "improvements for claiming tests", "committedDate": "2020-09-30T08:55:28Z", "type": "commit"}, {"oid": "511d136bfa1c7f7a54daa0672748c92d7f6d6c1f", "url": "https://github.com/thingsboard/thingsboard/commit/511d136bfa1c7f7a54daa0672748c92d7f6d6c1f", "message": "update device creation logic from gateway request", "committedDate": "2020-09-30T10:58:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMTE0Ng==", "url": "https://github.com/thingsboard/thingsboard/pull/3423#discussion_r497621146", "bodyText": "please assign default value.", "author": "ashvayka", "createdAt": "2020-09-30T15:54:44Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java", "diffHunk": "@@ -16,11 +16,14 @@\n package org.thingsboard.server.common.data.device.profile;\n \n import lombok.Data;\n+import org.thingsboard.server.common.data.TransportPayloadType;\n import org.thingsboard.server.common.data.DeviceTransportType;\n \n @Data\n public class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {\n \n+    private TransportPayloadType transportPayloadType;", "originalCommit": "511d136bfa1c7f7a54daa0672748c92d7f6d6c1f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b76feec9fb1aa0845015dd3c52b7f79b3373dade", "chunk": "diff --git a/common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java b/common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java\nindex bacc5b4374..d88ac24cbb 100644\n--- a/common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java\n+++ b/common/data/src/main/java/org/thingsboard/server/common/data/device/profile/MqttDeviceProfileTransportConfiguration.java\n\n@@ -22,7 +22,7 @@ import org.thingsboard.server.common.data.DeviceTransportType;\n @Data\n public class MqttDeviceProfileTransportConfiguration implements DeviceProfileTransportConfiguration {\n \n-    private TransportPayloadType transportPayloadType;\n+    private TransportPayloadType transportPayloadType = TransportPayloadType.JSON;\n \n     private String deviceTelemetryTopic = MqttTopics.DEVICE_TELEMETRY_TOPIC;\n     private String deviceAttributesTopic = MqttTopics.DEVICE_ATTRIBUTES_TOPIC;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMzU2Nw==", "url": "https://github.com/thingsboard/thingsboard/pull/3423#discussion_r497623567", "bodyText": "var adaptor = deviceSessionCtx.getPayloadAdaptor(). Then you don't need to do a copy-paste all the time.", "author": "ashvayka", "createdAt": "2020-09-30T15:58:12Z", "path": "common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java", "diffHunk": "@@ -216,22 +243,28 @@ private void handleGatewayPublishMsg(String topicName, int msgId, MqttPublishMes\n     private void processDevicePublish(ChannelHandlerContext ctx, MqttPublishMessage mqttMsg, String topicName, int msgId) {\n         try {\n             if (deviceSessionCtx.isDeviceTelemetryTopic(topicName)) {\n-                TransportProtos.PostTelemetryMsg postTelemetryMsg = adaptor.convertToPostTelemetry(deviceSessionCtx, mqttMsg);\n+                TransportProtos.PostTelemetryMsg postTelemetryMsg = deviceSessionCtx.isJsonPayloadType() ?", "originalCommit": "511d136bfa1c7f7a54daa0672748c92d7f6d6c1f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b76feec9fb1aa0845015dd3c52b7f79b3373dade", "chunk": "diff --git a/common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java b/common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java\nindex 2708d81e07..5304b19711 100644\n--- a/common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java\n+++ b/common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/MqttTransportHandler.java\n\n@@ -243,28 +208,22 @@ public class MqttTransportHandler extends ChannelInboundHandlerAdapter implement\n     private void processDevicePublish(ChannelHandlerContext ctx, MqttPublishMessage mqttMsg, String topicName, int msgId) {\n         try {\n             if (deviceSessionCtx.isDeviceTelemetryTopic(topicName)) {\n-                TransportProtos.PostTelemetryMsg postTelemetryMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToPostTelemetry(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToPostTelemetry(deviceSessionCtx, mqttMsg);\n+                TransportProtos.PostTelemetryMsg postTelemetryMsg = deviceSessionCtx.getPayloadAdaptor().convertToPostTelemetry(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), postTelemetryMsg, getPubAckCallback(ctx, msgId, postTelemetryMsg));\n             } else if (deviceSessionCtx.isDeviceAttributesTopic(topicName)) {\n-                TransportProtos.PostAttributeMsg postAttributeMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToPostAttributes(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToPostAttributes(deviceSessionCtx, mqttMsg);\n+                TransportProtos.PostAttributeMsg postAttributeMsg = deviceSessionCtx.getPayloadAdaptor().convertToPostAttributes(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), postAttributeMsg, getPubAckCallback(ctx, msgId, postAttributeMsg));\n             } else if (topicName.startsWith(MqttTopics.DEVICE_ATTRIBUTES_REQUEST_TOPIC_PREFIX)) {\n-                TransportProtos.GetAttributeRequestMsg getAttributeMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToGetAttributes(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToGetAttributes(deviceSessionCtx, mqttMsg);\n+                TransportProtos.GetAttributeRequestMsg getAttributeMsg = deviceSessionCtx.getPayloadAdaptor().convertToGetAttributes(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), getAttributeMsg, getPubAckCallback(ctx, msgId, getAttributeMsg));\n             } else if (topicName.startsWith(MqttTopics.DEVICE_RPC_RESPONSE_TOPIC)) {\n-                TransportProtos.ToDeviceRpcResponseMsg rpcResponseMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToDeviceRpcResponse(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToDeviceRpcResponse(deviceSessionCtx, mqttMsg);\n+                TransportProtos.ToDeviceRpcResponseMsg rpcResponseMsg = deviceSessionCtx.getPayloadAdaptor().convertToDeviceRpcResponse(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), rpcResponseMsg, getPubAckCallback(ctx, msgId, rpcResponseMsg));\n             } else if (topicName.startsWith(MqttTopics.DEVICE_RPC_REQUESTS_TOPIC)) {\n-                TransportProtos.ToServerRpcRequestMsg rpcRequestMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToServerRpcRequest(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToServerRpcRequest(deviceSessionCtx, mqttMsg);\n+                TransportProtos.ToServerRpcRequestMsg rpcRequestMsg = deviceSessionCtx.getPayloadAdaptor().convertToServerRpcRequest(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), rpcRequestMsg, getPubAckCallback(ctx, msgId, rpcRequestMsg));\n             } else if (topicName.equals(MqttTopics.DEVICE_CLAIM_TOPIC)) {\n-                TransportProtos.ClaimDeviceMsg claimDeviceMsg = deviceSessionCtx.isJsonPayloadType() ?\n-                        jsonMqttAdaptor.convertToClaimDevice(deviceSessionCtx, mqttMsg) : protoMqttAdaptor.convertToClaimDevice(deviceSessionCtx, mqttMsg);\n+                TransportProtos.ClaimDeviceMsg claimDeviceMsg = deviceSessionCtx.getPayloadAdaptor().convertToClaimDevice(deviceSessionCtx, mqttMsg);\n                 transportService.process(deviceSessionCtx.getSessionInfo(), claimDeviceMsg, getPubAckCallback(ctx, msgId, claimDeviceMsg));\n             } else {\n                 transportService.reportActivity(deviceSessionCtx.getSessionInfo());\n"}}, {"oid": "b76feec9fb1aa0845015dd3c52b7f79b3373dade", "url": "https://github.com/thingsboard/thingsboard/commit/b76feec9fb1aa0845015dd3c52b7f79b3373dade", "message": "refactoring", "committedDate": "2020-10-01T09:51:45Z", "type": "commit"}, {"oid": "33950ac2a3671b3fc0a584a2672f08c1681aa33d", "url": "https://github.com/thingsboard/thingsboard/commit/33950ac2a3671b3fc0a584a2672f08c1681aa33d", "message": "extract TransportService process calls to private methods", "committedDate": "2020-10-01T10:10:45Z", "type": "commit"}, {"oid": "18452559af66e59f211034ff1abfd3d626bf7966", "url": "https://github.com/thingsboard/thingsboard/commit/18452559af66e59f211034ff1abfd3d626bf7966", "message": "fix duplicates & removed empty lines", "committedDate": "2020-10-02T08:28:00Z", "type": "commit"}]}