{"pr_number": 3602, "pr_title": "[3.2.1] Log telemetry update event to populate it into rule chains", "pr_createdAt": "2020-10-19T09:06:58Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3602", "timeline": [{"oid": "7bf0cb90fa1415fdcdbaea22525e830a561cc532", "url": "https://github.com/thingsboard/thingsboard/commit/7bf0cb90fa1415fdcdbaea22525e830a561cc532", "message": "Log telemetry update event to populate it into rule chain", "committedDate": "2020-10-19T09:03:28Z", "type": "commit"}, {"oid": "0fc43c3bd4b1b5623397acc93bbe987e2a06381f", "url": "https://github.com/thingsboard/thingsboard/commit/0fc43c3bd4b1b5623397acc93bbe987e2a06381f", "message": "Add 'Timeseries Updated' into message type switch node", "committedDate": "2020-10-23T08:42:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIyNzI0NQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3602#discussion_r521227245", "bodyText": "TsKvEntry also has a timestamp. The timestamp is lost in such a case. This is wrong.\nI suggest using the following format\n         [\n            {\n                \"ts\":1527863043000,\n                \"values\":{\n                    \"battery\":3.99,\n                    \"temperature\":27.05\n                }\n            },\n            {\n                \"ts\":1527863044000,\n                \"values\":{\n                    \"battery\":3.98,\n                    \"temperature\":27.06\n                }\n            }\n        ]", "author": "ashvayka", "createdAt": "2020-11-11T09:29:22Z", "path": "application/src/main/java/org/thingsboard/server/controller/BaseController.java", "diffHunk": "@@ -775,6 +769,13 @@ public static Exception toException(Throwable error) {\n                         if (keys != null) {\n                             keys.forEach(attrsArrayNode::add);\n                         }\n+                    } else if (actionType == ActionType.TIMESERIES_UPDATED) {\n+                        List<TsKvEntry> telemetry = extractParameter(List.class, 0, additionalInfo);\n+                        if (telemetry != null) {\n+                            for (TsKvEntry tsKvEntry : telemetry) {\n+                                addKvEntry(entityNode, tsKvEntry);", "originalCommit": "0fc43c3bd4b1b5623397acc93bbe987e2a06381f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NDkwMA==", "url": "https://github.com/thingsboard/thingsboard/pull/3602#discussion_r521554900", "bodyText": "In current implementation, the condition at line 772 will be true only when method saveTelemetry() in TelemetryController was called. The timestamp is set in the same saveTelemetry() method (TelemetryController, line 425) and equals to current system time.\nSo tsKvEntry element of the list will always have timestamp here.\nTo process telemetry update according to proposed format it's necessary to add a new endpoint (to avoid API breaking changes) in TelemetryController, in addition to existing ones:\n\nPOST /api/plugins/telemetry/{entityType}/{entityId}/timeseries/{scope}\nPOST /api/plugins/telemetry/{entityType}/{entityId}/timeseries/{scope}/{ttl}\n@ashvayka should I add a new endpoint to handle the proposed format of request body?", "author": "vkukhtyn", "createdAt": "2020-11-11T18:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIyNzI0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f4bec22a616bb1f43ac2e51eeedda9162d880c9c", "chunk": "diff --git a/application/src/main/java/org/thingsboard/server/controller/BaseController.java b/application/src/main/java/org/thingsboard/server/controller/BaseController.java\nindex 063930f1cc..b6acfdd7fd 100644\n--- a/application/src/main/java/org/thingsboard/server/controller/BaseController.java\n+++ b/application/src/main/java/org/thingsboard/server/controller/BaseController.java\n\n@@ -771,10 +771,13 @@ public abstract class BaseController {\n                         }\n                     } else if (actionType == ActionType.TIMESERIES_UPDATED) {\n                         List<TsKvEntry> telemetry = extractParameter(List.class, 0, additionalInfo);\n-                        if (telemetry != null) {\n+                        if (telemetry != null && !telemetry.isEmpty()) {\n+                            ObjectNode values = json.createObjectNode();\n                             for (TsKvEntry tsKvEntry : telemetry) {\n-                                addKvEntry(entityNode, tsKvEntry);\n+                                addKvEntry(values, tsKvEntry);\n                             }\n+                            entityNode.put(\"ts\", telemetry.get(0).getTs());\n+                            entityNode.set(\"values\", values);\n                         }\n                     }\n                 }\n"}}, {"oid": "c3ee6785aa381ca130a9423c8f928df983d36227", "url": "https://github.com/thingsboard/thingsboard/commit/c3ee6785aa381ca130a9423c8f928df983d36227", "message": "Merge branch 'master' into feature/log-telemetry-updated", "committedDate": "2020-11-11T09:44:42Z", "type": "commit"}, {"oid": "f4bec22a616bb1f43ac2e51eeedda9162d880c9c", "url": "https://github.com/thingsboard/thingsboard/commit/f4bec22a616bb1f43ac2e51eeedda9162d880c9c", "message": "Send to rule chain a timestamp when KV entries were updated", "committedDate": "2020-11-12T17:15:40Z", "type": "commit"}, {"oid": "6ccb9d6036b81cee83e77d9acdfb732409cf4f34", "url": "https://github.com/thingsboard/thingsboard/commit/6ccb9d6036b81cee83e77d9acdfb732409cf4f34", "message": "Send array of KV entry grouped by timestamp to rule chain", "committedDate": "2020-11-13T10:47:07Z", "type": "commit"}, {"oid": "c03356e94456c526bc17c56acfc1d9563fb20483", "url": "https://github.com/thingsboard/thingsboard/commit/c03356e94456c526bc17c56acfc1d9563fb20483", "message": "Merge branch 'master' into feature/log-telemetry-updated", "committedDate": "2020-11-13T11:10:09Z", "type": "commit"}, {"oid": "9829dd17cc3fc1489bfb405a25367d4a3e72629c", "url": "https://github.com/thingsboard/thingsboard/commit/9829dd17cc3fc1489bfb405a25367d4a3e72629c", "message": "Merge branch 'master' into feature/log-telemetry-updated", "committedDate": "2020-12-23T14:16:15Z", "type": "commit"}, {"oid": "9c44920fe749b07fdb089a6a9eb1075789fc53ed", "url": "https://github.com/thingsboard/thingsboard/commit/9c44920fe749b07fdb089a6a9eb1075789fc53ed", "message": "Merge branch 'master' into feature/log-telemetry-updated", "committedDate": "2020-12-24T11:24:55Z", "type": "commit"}, {"oid": "f1fb0cedae51eb129e24b69a8b2ad44e2b57e463", "url": "https://github.com/thingsboard/thingsboard/commit/f1fb0cedae51eb129e24b69a8b2ad44e2b57e463", "message": "Add audit log details for telemetry deleted and telemetry updated types", "committedDate": "2020-12-25T16:24:31Z", "type": "commit"}, {"oid": "03a2195998ac686010d61b1193d2181ffbdf5de9", "url": "https://github.com/thingsboard/thingsboard/commit/03a2195998ac686010d61b1193d2181ffbdf5de9", "message": "Merge branch 'master' into feature/log-telemetry-updated", "committedDate": "2020-12-25T16:25:21Z", "type": "commit"}]}