{"pr_number": 3552, "pr_title": "fixed sending inactivity event after device creation.", "pr_createdAt": "2020-10-07T16:16:40Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3552", "timeline": [{"oid": "b7fad59b2f9ce1d022302059cfd3a7dc718b4ee1", "url": "https://github.com/thingsboard/thingsboard/commit/b7fad59b2f9ce1d022302059cfd3a7dc718b4ee1", "message": "fixed sending inactivity event after device creation.", "committedDate": "2020-10-07T16:15:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwMjA0MA==", "url": "https://github.com/thingsboard/thingsboard/pull/3552#discussion_r501602040", "bodyText": "Add device creation time to the DeviceStateData (device.getCreatedTime()) in the getOrFetchDeviceStateData", "author": "ashvayka", "createdAt": "2020-10-08T10:08:18Z", "path": "application/src/main/java/org/thingsboard/server/service/state/DefaultDeviceStateService.java", "diffHunk": "@@ -392,7 +393,7 @@ private void updateState() {\n             if (stateData != null) {\n                 DeviceState state = stateData.getState();\n                 state.setActive(ts < state.getLastActivityTime() + state.getInactivityTimeout());\n-                if (!state.isActive() && (state.getLastInactivityAlarmTime() == 0L || state.getLastInactivityAlarmTime() < state.getLastActivityTime())) {\n+                if (!state.isActive() && (state.getLastInactivityAlarmTime() == 0L || state.getLastInactivityAlarmTime() < state.getLastActivityTime()) && UUIDs.unixTimestamp(deviceId.getId()) + state.getInactivityTimeout() < ts) {", "originalCommit": "b7fad59b2f9ce1d022302059cfd3a7dc718b4ee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNzE2NQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3552#discussion_r501607165", "bodyText": "done", "author": "YevhenBondarenko", "createdAt": "2020-10-08T10:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwMjA0MA=="}], "type": "inlineReview", "revised_code": {"commit": "4740ed83a8d68b7c0c3b0814db0bf637533d750c", "chunk": "diff --git a/application/src/main/java/org/thingsboard/server/service/state/DefaultDeviceStateService.java b/application/src/main/java/org/thingsboard/server/service/state/DefaultDeviceStateService.java\nindex c6f771216b..9d5df549da 100644\n--- a/application/src/main/java/org/thingsboard/server/service/state/DefaultDeviceStateService.java\n+++ b/application/src/main/java/org/thingsboard/server/service/state/DefaultDeviceStateService.java\n\n@@ -393,7 +393,7 @@ public class DefaultDeviceStateService implements DeviceStateService {\n             if (stateData != null) {\n                 DeviceState state = stateData.getState();\n                 state.setActive(ts < state.getLastActivityTime() + state.getInactivityTimeout());\n-                if (!state.isActive() && (state.getLastInactivityAlarmTime() == 0L || state.getLastInactivityAlarmTime() < state.getLastActivityTime()) && UUIDs.unixTimestamp(deviceId.getId()) + state.getInactivityTimeout() < ts) {\n+                if (!state.isActive() && (state.getLastInactivityAlarmTime() == 0L || state.getLastInactivityAlarmTime() < state.getLastActivityTime()) && stateData.getDeviceCreationTime() + state.getInactivityTimeout() < ts) {\n                     state.setLastInactivityAlarmTime(ts);\n                     pushRuleEngineMessage(stateData, INACTIVITY_EVENT);\n                     save(deviceId, INACTIVITY_ALARM_TIME, ts);\n"}}, {"oid": "4740ed83a8d68b7c0c3b0814db0bf637533d750c", "url": "https://github.com/thingsboard/thingsboard/commit/4740ed83a8d68b7c0c3b0814db0bf637533d750c", "message": "added deviceCreationTime to the DeviceStateData", "committedDate": "2020-10-08T10:15:49Z", "type": "commit"}, {"oid": "d2fd431a5294f6a44322864fa64f32a424d745ad", "url": "https://github.com/thingsboard/thingsboard/commit/d2fd431a5294f6a44322864fa64f32a424d745ad", "message": "refactored", "committedDate": "2020-10-08T10:22:01Z", "type": "commit"}]}