{"pr_number": 3208, "pr_title": "Improvements/activity event reporting and clear alarm node", "pr_createdAt": "2020-07-31T13:51:03Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3208", "timeline": [{"oid": "69e2c3f862f2dc912a80170fd34b69f82bcf66af", "url": "https://github.com/thingsboard/thingsboard/commit/69e2c3f862f2dc912a80170fd34b69f82bcf66af", "message": "changed logic to report activity & improvements for clear alarm node", "committedDate": "2020-07-31T12:06:47Z", "type": "commit"}, {"oid": "0b985a40c006936f7a72d6bfa61bf1b6976584a8", "url": "https://github.com/thingsboard/thingsboard/commit/0b985a40c006936f7a72d6bfa61bf1b6976584a8", "message": "added buildAlarmDetails for clearAlarmByAlarmOriginator method", "committedDate": "2020-07-31T13:29:49Z", "type": "commit"}, {"oid": "21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91", "url": "https://github.com/thingsboard/thingsboard/commit/21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91", "message": "fix typo", "committedDate": "2020-07-31T13:49:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIzNzA2OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3208#discussion_r464237069", "bodyText": "ctx.logJsEvalResponse() not  ctx.logJsEvalRequest()", "author": "ashvayka", "createdAt": "2020-08-03T07:23:29Z", "path": "rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java", "diffHunk": "@@ -56,10 +57,38 @@ protected TbClearAlarmNodeConfiguration loadAlarmNodeConfig(TbNodeConfiguration\n     @Override\n     protected ListenableFuture<AlarmResult> processAlarm(TbContext ctx, TbMsg msg) {\n         String alarmType = TbNodeUtils.processPattern(this.config.getAlarmType(), msg.getMetaData());\n-        ListenableFuture<Alarm> latest = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n-        return Futures.transformAsync(latest, a -> {\n-            if (a != null && !a.getStatus().isCleared()) {\n-                return clearAlarm(ctx, msg, a);\n+        if (msg.getOriginator().getEntityType().equals(EntityType.ALARM)) {\n+            return clearAlarmByAlarmOriginator(ctx, msg);\n+        } else {\n+            ListenableFuture<Alarm> latest = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n+            return Futures.transformAsync(latest, a -> {\n+                if (a != null && !a.getStatus().isCleared()) {\n+                    return clearAlarm(ctx, msg, a);\n+                }\n+                return Futures.immediateFuture(new AlarmResult(false, false, false, null));\n+            }, ctx.getDbCallbackExecutor());\n+        }\n+    }\n+\n+    private ListenableFuture<AlarmResult> clearAlarmByAlarmOriginator(TbContext ctx, TbMsg msg) {\n+        ListenableFuture<Alarm> alarmByIdAsync = ctx.getAlarmService().findAlarmByIdAsync(ctx.getTenantId(), new AlarmId(msg.getOriginator().getId()));\n+        return Futures.transformAsync(alarmByIdAsync, alarm -> {\n+            if (alarm != null && !alarm.getStatus().isCleared()) {\n+                ctx.logJsEvalRequest();\n+                ListenableFuture<JsonNode> asyncDetails = buildAlarmDetails(ctx, msg, alarm.getDetails());\n+                return Futures.transformAsync(asyncDetails, details -> {\n+                    ctx.logJsEvalRequest();", "originalCommit": "21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0Mzk4Mg==", "url": "https://github.com/thingsboard/thingsboard/pull/3208#discussion_r464243982", "bodyText": "there is a lot of code duplication now. This is redundant.", "author": "ashvayka", "createdAt": "2020-08-03T07:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIzNzA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2dc44fed70296dc50d7dcb0da4b9ca88983a2b79", "chunk": "diff --git a/rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java b/rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java\nindex d3c6429e34..30bf2d4d6e 100644\n--- a/rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java\n+++ b/rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java\n\n@@ -57,38 +57,15 @@ public class TbClearAlarmNode extends TbAbstractAlarmNode<TbClearAlarmNodeConfig\n     @Override\n     protected ListenableFuture<AlarmResult> processAlarm(TbContext ctx, TbMsg msg) {\n         String alarmType = TbNodeUtils.processPattern(this.config.getAlarmType(), msg.getMetaData());\n+        ListenableFuture<Alarm> alarmFuture;\n         if (msg.getOriginator().getEntityType().equals(EntityType.ALARM)) {\n-            return clearAlarmByAlarmOriginator(ctx, msg);\n+            alarmFuture = ctx.getAlarmService().findAlarmByIdAsync(ctx.getTenantId(), new AlarmId(msg.getOriginator().getId()));\n         } else {\n-            ListenableFuture<Alarm> latest = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n-            return Futures.transformAsync(latest, a -> {\n-                if (a != null && !a.getStatus().isCleared()) {\n-                    return clearAlarm(ctx, msg, a);\n-                }\n-                return Futures.immediateFuture(new AlarmResult(false, false, false, null));\n-            }, ctx.getDbCallbackExecutor());\n+            alarmFuture = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n         }\n-    }\n-\n-    private ListenableFuture<AlarmResult> clearAlarmByAlarmOriginator(TbContext ctx, TbMsg msg) {\n-        ListenableFuture<Alarm> alarmByIdAsync = ctx.getAlarmService().findAlarmByIdAsync(ctx.getTenantId(), new AlarmId(msg.getOriginator().getId()));\n-        return Futures.transformAsync(alarmByIdAsync, alarm -> {\n-            if (alarm != null && !alarm.getStatus().isCleared()) {\n-                ctx.logJsEvalRequest();\n-                ListenableFuture<JsonNode> asyncDetails = buildAlarmDetails(ctx, msg, alarm.getDetails());\n-                return Futures.transformAsync(asyncDetails, details -> {\n-                    ctx.logJsEvalRequest();\n-                    long clearTs = System.currentTimeMillis();\n-                    ListenableFuture<Boolean> clearAlarmFuture = ctx.getAlarmService().clearAlarm(ctx.getTenantId(), alarm.getId(), details, clearTs);\n-                    return Futures.transformAsync(clearAlarmFuture, cleared -> {\n-                        if (cleared) {\n-                            alarm.setClearTs(clearTs);\n-                            alarm.setDetails(details);\n-                        }\n-                        alarm.setStatus(alarm.getStatus().isAck() ? AlarmStatus.CLEARED_ACK : AlarmStatus.CLEARED_UNACK);\n-                        return Futures.immediateFuture(new AlarmResult(false, false, true, alarm));\n-                    }, ctx.getDbCallbackExecutor());\n-                }, ctx.getDbCallbackExecutor());\n+        return Futures.transformAsync(alarmFuture, a -> {\n+            if (a != null && !a.getStatus().isCleared()) {\n+                return clearAlarm(ctx, msg, a);\n             }\n             return Futures.immediateFuture(new AlarmResult(false, false, false, null));\n         }, ctx.getDbCallbackExecutor());\n"}}, {"oid": "2dc44fed70296dc50d7dcb0da4b9ca88983a2b79", "url": "https://github.com/thingsboard/thingsboard/commit/2dc44fed70296dc50d7dcb0da4b9ca88983a2b79", "message": "refactoring & added alarmCanBeClearedWithAlarmOriginator test", "committedDate": "2020-08-03T10:54:40Z", "type": "commit"}, {"oid": "b5878613744ad8c30149fc828f6e27e81dc5ef9d", "url": "https://github.com/thingsboard/thingsboard/commit/b5878613744ad8c30149fc828f6e27e81dc5ef9d", "message": "fix typo", "committedDate": "2020-08-03T10:57:45Z", "type": "commit"}, {"oid": "cc7c09cffbd755d96667d653b45642f1e4e2cb04", "url": "https://github.com/thingsboard/thingsboard/commit/cc7c09cffbd755d96667d653b45642f1e4e2cb04", "message": "Merge branch 'develop/2.5.3' of github.com:thingsboard/thingsboard into improvements/activity-event-reporting-and-clear-alarm-node", "committedDate": "2020-08-03T11:03:58Z", "type": "commit"}]}