{"pr_number": 787, "pr_title": "Fix retry logic", "pr_createdAt": "2020-04-01T21:33:55Z", "pr_url": "https://github.com/box/box-java-sdk/pull/787", "timeline": [{"oid": "dc65ef7a9fb3ef63501d3d1f416a3182cc19c9dc", "url": "https://github.com/box/box-java-sdk/commit/dc65ef7a9fb3ef63501d3d1f416a3182cc19c9dc", "message": "done", "committedDate": "2020-04-01T20:54:32Z", "type": "commit"}, {"oid": "3e94b0c8eff64589e32e3aeb094f5d270811b165", "url": "https://github.com/box/box-java-sdk/commit/3e94b0c8eff64589e32e3aeb094f5d270811b165", "message": "update changelog", "committedDate": "2020-04-01T21:33:17Z", "type": "commit"}, {"oid": "1e9317b794a24fa74b5f15f200478b28f60985f4", "url": "https://github.com/box/box-java-sdk/commit/1e9317b794a24fa74b5f15f200478b28f60985f4", "message": "Update CHANGELOG.md", "committedDate": "2020-04-01T21:34:33Z", "type": "commit"}, {"oid": "04c255ce058c246ff6bab0f2379dc5768aa4f446", "url": "https://github.com/box/box-java-sdk/commit/04c255ce058c246ff6bab0f2379dc5768aa4f446", "message": "clean up code and tests passing", "committedDate": "2020-04-01T21:54:01Z", "type": "commit"}, {"oid": "043690d5b506aef14097ee24a0e0e334e97cea4c", "url": "https://github.com/box/box-java-sdk/commit/043690d5b506aef14097ee24a0e0e334e97cea4c", "message": "Merge branch 'master' into amend-retry-logic", "committedDate": "2020-04-06T16:56:20Z", "type": "commit"}, {"oid": "e01a3595af46693c9d42eeec98a8ed934f4ac599", "url": "https://github.com/box/box-java-sdk/commit/e01a3595af46693c9d42eeec98a8ed934f4ac599", "message": "Refactor waitBackoff()", "committedDate": "2020-04-06T23:29:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MjIzNA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r402562234", "bodyText": "Can we add a check for \"invalid_grant,\" as in python: https://github.com/box/box-python-sdk/blob/594df43e1f5eec1b9fc714a58f03fd0756d1776b/boxsdk/auth/jwt_auth.py#L313", "author": "PJSimon", "createdAt": "2020-04-02T19:33:56Z", "path": "src/main/java/com/box/sdk/BoxAPIRequest.java", "diffHunk": "@@ -756,10 +764,13 @@ void shouldAuthenticate(boolean shouldAuthenticate) {\n     /**\n      *\n      * @param  responseCode HTTP error code of the response\n+     * @param  apiException BoxAPIException thrown\n      * @return true if the response is one that should be retried, otherwise false\n      */\n-    public static boolean isResponseRetryable(int responseCode) {\n-        return (responseCode >= 500 || responseCode == 429);\n+    public static boolean isResponseRetryable(int responseCode, BoxAPIException apiException) {\n+        String message = apiException.getMessage();\n+        Boolean isClockSkewError =  responseCode == 400 && message.contains(\"exp\");", "originalCommit": "04c255ce058c246ff6bab0f2379dc5768aa4f446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzMjg5NQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r404932895", "bodyText": "Going to fix this once we decide whether to rollback the Max Request Attempts commit or not.", "author": "sujaygarlanka", "createdAt": "2020-04-07T16:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MjIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNjQ5OQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405136499", "bodyText": "OK, lemme know when it's ready for final review.", "author": "PJSimon", "createdAt": "2020-04-07T21:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MjIzNA=="}], "type": "inlineReview", "revised_code": {"commit": "451e8788648bdf667f70d827992185c45fd5a2e0", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxAPIRequest.java b/src/main/java/com/box/sdk/BoxAPIRequest.java\nindex 29e2c833..47c81302 100644\n--- a/src/main/java/com/box/sdk/BoxAPIRequest.java\n+++ b/src/main/java/com/box/sdk/BoxAPIRequest.java\n\n@@ -769,7 +769,15 @@ public class BoxAPIRequest {\n      */\n     public static boolean isResponseRetryable(int responseCode, BoxAPIException apiException) {\n         String message = apiException.getMessage();\n-        Boolean isClockSkewError =  responseCode == 400 && message.contains(\"exp\");\n+        String errorCode = \"\";\n+        try {\n+            JsonObject responseBody = JsonObject.readFrom(apiException.getResponse());\n+            errorCode = responseBody.get(\"code\").toString();\n+        } catch (Exception e) { }\n+\n+        Boolean isClockSkewError =  responseCode == 400\n+                                    && errorCode.contains(\"invalid_grant\")\n+                                    && message.contains(\"exp\");\n         return (isClockSkewError || responseCode >= 500 || responseCode == 429);\n     }\n     private static boolean isResponseRedirect(int responseCode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MzM3Mw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r404553373", "bodyText": "Setting it to 5 makes the max total attempts 6, which is in line with the box-python-sdk (https://github.com/box/box-python-sdk/blob/9cdebdde39e68e735069dd97e0a459e09382455d/boxsdk/session/session.py#L341)", "author": "PJSimon", "createdAt": "2020-04-07T05:58:44Z", "path": "src/main/java/com/box/sdk/BoxAPIConnection.java", "diffHunk": "@@ -22,9 +22,9 @@\n  */\n public class BoxAPIConnection {\n     /**\n-     * The default maximum number of times an API request will be tried when an error occurs.\n+     * The default maximum number of times an API request will be retried after an error occurs.\n      */\n-    public static final int DEFAULT_MAX_ATTEMPTS = 5;\n+    public static final int DEFAULT_MAX_RETRIES = 5;", "originalCommit": "a734a649f88a50182a7679db0ac1ad38cd33c5bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyODYyMA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r404928620", "bodyText": "I like the idea of renaming this, but I think changing this value DEFAULT_MAX_RETRIES may be a breaking change. We are changing public values like the the functions to set and get the value. So if we are okay with our next release being a major release, then I am fine with this.", "author": "sujaygarlanka", "createdAt": "2020-04-07T16:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwODYxNQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405108615", "bodyText": "Agreed.  I would think the chances someone is using that variable outside the SDK are very low, but if we deprecate it, then we can prevent the breaking change.  See next commit...", "author": "PJSimon", "createdAt": "2020-04-07T20:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExNTE0Nw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405115147", "bodyText": "Makes sense. I think we also need to deprecate getMaxRequestAttempts and setMaxRequestAttempts in BoxAPIConnection and BoxGlobalSettings as well. If we do this, it should be fine. The only other possible issue is the restore method in BoxAPIConnection. It takes in an object and restores settings. If someone is storing an object before this change, then when they restore with that object there will be an issue. The old object will have the key maxRequestAttempts, but our new restore will only look for maxRetryAttempts. I don't think this will be a big issue, but not sure. We could put logic in to check for both. I think it may make sense to wait until we have a breaking change, to make this change. What do you think?", "author": "sujaygarlanka", "createdAt": "2020-04-07T21:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg2ODEyMQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405868121", "bodyText": "Did the other method deprecations you mentioned.\nAlso added a test to ensure restore works with \"old\" state strings.", "author": "PJSimon", "createdAt": "2020-04-08T23:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1MzM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a75232365c2262676f77f6f65f4f3a52939821e8", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxAPIConnection.java b/src/main/java/com/box/sdk/BoxAPIConnection.java\nindex 85c1f25d..60440aa9 100644\n--- a/src/main/java/com/box/sdk/BoxAPIConnection.java\n+++ b/src/main/java/com/box/sdk/BoxAPIConnection.java\n\n@@ -22,9 +22,9 @@ import com.eclipsesource.json.JsonObject;\n  */\n public class BoxAPIConnection {\n     /**\n-     * The default maximum number of times an API request will be retried after an error occurs.\n+     * The default maximum number of times an API request will be tried when an error occurs.\n      */\n-    public static final int DEFAULT_MAX_RETRIES = 5;\n+    public static final int DEFAULT_MAX_ATTEMPTS = 5;\n \n     private static final String AUTHORIZATION_URL = \"https://account.box.com/api/oauth2/authorize\";\n     private static final String TOKEN_URL_STRING = \"https://api.box.com/oauth2/token\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU1NDMxNA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r404554314", "bodyText": "Adding + 1 is the way to go, other wise we'd have to modify BackoffCounter.decrement() which seems too far.", "author": "PJSimon", "createdAt": "2020-04-07T06:01:16Z", "path": "src/main/java/com/box/sdk/BoxAPIRequest.java", "diffHunk": "@@ -371,9 +371,9 @@ public BoxAPIResponse send() {\n      */\n     public BoxAPIResponse send(ProgressListener listener) {\n         if (this.api == null) {\n-            this.backoffCounter.reset(BoxGlobalSettings.getMaxRequestAttempts() + 1);\n+            this.backoffCounter.reset(BoxGlobalSettings.getMaxRetryAttempts() + 1);\n         } else {\n-            this.backoffCounter.reset(this.api.getMaxRequestAttempts() + 1);\n+            this.backoffCounter.reset(this.api.getMaxRetryAttempts() + 1);", "originalCommit": "a734a649f88a50182a7679db0ac1ad38cd33c5bf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a75232365c2262676f77f6f65f4f3a52939821e8", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxAPIRequest.java b/src/main/java/com/box/sdk/BoxAPIRequest.java\nindex 3a534db9..29e2c833 100644\n--- a/src/main/java/com/box/sdk/BoxAPIRequest.java\n+++ b/src/main/java/com/box/sdk/BoxAPIRequest.java\n\n@@ -371,9 +371,9 @@ public class BoxAPIRequest {\n      */\n     public BoxAPIResponse send(ProgressListener listener) {\n         if (this.api == null) {\n-            this.backoffCounter.reset(BoxGlobalSettings.getMaxRetryAttempts() + 1);\n+            this.backoffCounter.reset(BoxGlobalSettings.getMaxRequestAttempts() + 1);\n         } else {\n-            this.backoffCounter.reset(this.api.getMaxRetryAttempts() + 1);\n+            this.backoffCounter.reset(this.api.getMaxRequestAttempts() + 1);\n         }\n \n         while (this.backoffCounter.getAttemptsRemaining() > 0) {\n"}}, {"oid": "e01a3595af46693c9d42eeec98a8ed934f4ac599", "url": "https://github.com/box/box-java-sdk/commit/e01a3595af46693c9d42eeec98a8ed934f4ac599", "message": "Refactor waitBackoff()", "committedDate": "2020-04-06T23:29:23Z", "type": "forcePushed"}, {"oid": "a75232365c2262676f77f6f65f4f3a52939821e8", "url": "https://github.com/box/box-java-sdk/commit/a75232365c2262676f77f6f65f4f3a52939821e8", "message": "Update CHANGELOG", "committedDate": "2020-04-07T21:50:15Z", "type": "commit"}, {"oid": "c5ad4d4e85d677586e1de6e36a41327339054857", "url": "https://github.com/box/box-java-sdk/commit/c5ad4d4e85d677586e1de6e36a41327339054857", "message": "Merge branch 'master' into amend-retry-logic", "committedDate": "2020-04-07T21:53:20Z", "type": "commit"}, {"oid": "451e8788648bdf667f70d827992185c45fd5a2e0", "url": "https://github.com/box/box-java-sdk/commit/451e8788648bdf667f70d827992185c45fd5a2e0", "message": "add check for retrying requests", "committedDate": "2020-04-07T22:37:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NzQ4NA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405167484", "bodyText": "I believe in Java, it's better to check for existence of \"code\" than to rely on the overhead of throwing an exception, if it doesn't exist.", "author": "PJSimon", "createdAt": "2020-04-07T23:13:57Z", "path": "src/main/java/com/box/sdk/BoxAPIRequest.java", "diffHunk": "@@ -769,7 +769,15 @@ void shouldAuthenticate(boolean shouldAuthenticate) {\n      */\n     public static boolean isResponseRetryable(int responseCode, BoxAPIException apiException) {\n         String message = apiException.getMessage();\n-        Boolean isClockSkewError =  responseCode == 400 && message.contains(\"exp\");\n+        String errorCode = \"\";\n+        try {\n+            JsonObject responseBody = JsonObject.readFrom(apiException.getResponse());\n+            errorCode = responseBody.get(\"code\").toString();\n+        } catch (Exception e) { }", "originalCommit": "451e8788648bdf667f70d827992185c45fd5a2e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3MjkyMA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405172920", "bodyText": "Do you still need the try \u2026 catch now?", "author": "PJSimon", "createdAt": "2020-04-07T23:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NDUwNw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405174507", "bodyText": "What if the readFrom fails, such as when the body is null on a 500 error?", "author": "sujaygarlanka", "createdAt": "2020-04-07T23:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NDc0NQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405174745", "bodyText": "We should check for that case, as well, then, for the same reason as above.", "author": "PJSimon", "createdAt": "2020-04-07T23:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4ODMxMA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405188310", "bodyText": "Have to put the try catch back again because of a test case that wasn't passing here. Apparently, an html body can be returned. In this case, I don't know how to do a check that the body is not HTML other than the try catch.", "author": "sujaygarlanka", "createdAt": "2020-04-08T00:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NzQ4NA=="}], "type": "inlineReview", "revised_code": {"commit": "446386ad9291518a6b81f20ac66f52a6f9050be1", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxAPIRequest.java b/src/main/java/com/box/sdk/BoxAPIRequest.java\nindex 47c81302..1dd5cace 100644\n--- a/src/main/java/com/box/sdk/BoxAPIRequest.java\n+++ b/src/main/java/com/box/sdk/BoxAPIRequest.java\n\n@@ -772,7 +772,9 @@ public class BoxAPIRequest {\n         String errorCode = \"\";\n         try {\n             JsonObject responseBody = JsonObject.readFrom(apiException.getResponse());\n-            errorCode = responseBody.get(\"code\").toString();\n+            if (responseBody.get(\"code\") != null) {\n+                errorCode = responseBody.get(\"code\").toString();\n+            }\n         } catch (Exception e) { }\n \n         Boolean isClockSkewError =  responseCode == 400\n"}}, {"oid": "446386ad9291518a6b81f20ac66f52a6f9050be1", "url": "https://github.com/box/box-java-sdk/commit/446386ad9291518a6b81f20ac66f52a6f9050be1", "message": "code clean up", "committedDate": "2020-04-07T23:24:27Z", "type": "commit"}, {"oid": "b3b60c67c1661477e6d96695b3a3268258aa83e7", "url": "https://github.com/box/box-java-sdk/commit/b3b60c67c1661477e6d96695b3a3268258aa83e7", "message": "refactor code", "committedDate": "2020-04-08T00:27:04Z", "type": "commit"}, {"oid": "994d9c16ab37217e51fb889cbf2b29680385bc88", "url": "https://github.com/box/box-java-sdk/commit/994d9c16ab37217e51fb889cbf2b29680385bc88", "message": "Refactor 'Max Attempts' to 'Max Retries'", "committedDate": "2020-04-08T22:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg2ODY1MQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r405868651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void shouldUseGlobalMaxRequests() {\n          \n          \n            \n                public void shouldUseGlobalMaxRetries() {", "author": "PJSimon", "createdAt": "2020-04-08T23:18:22Z", "path": "src/test/java/com/box/sdk/BoxAPIConnectionTest.java", "diffHunk": "@@ -841,15 +859,15 @@ public String getJSON() {\n     @Category(UnitTest.class)\n     public void shouldUseGlobalMaxRequests() {", "originalCommit": "994d9c16ab37217e51fb889cbf2b29680385bc88", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87dd6707b1e341cd7f3d1e5a2f18f6079f8b04fe", "chunk": "diff --git a/src/test/java/com/box/sdk/BoxAPIConnectionTest.java b/src/test/java/com/box/sdk/BoxAPIConnectionTest.java\nindex 0cb74c5a..7014778d 100644\n--- a/src/test/java/com/box/sdk/BoxAPIConnectionTest.java\n+++ b/src/test/java/com/box/sdk/BoxAPIConnectionTest.java\n\n@@ -857,7 +857,7 @@ public class BoxAPIConnectionTest {\n \n     @Test\n     @Category(UnitTest.class)\n-    public void shouldUseGlobalMaxRequests() {\n+    public void shouldUseGlobalMaxRetries() {\n \n         int defaultMaxRetries = BoxGlobalSettings.getMaxRetryAttempts();\n         int newMaxRetries = defaultMaxRetries + 5;\n"}}, {"oid": "87dd6707b1e341cd7f3d1e5a2f18f6079f8b04fe", "url": "https://github.com/box/box-java-sdk/commit/87dd6707b1e341cd7f3d1e5a2f18f6079f8b04fe", "message": "Update src/test/java/com/box/sdk/BoxAPIConnectionTest.java", "committedDate": "2020-04-08T23:18:57Z", "type": "commit"}, {"oid": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "url": "https://github.com/box/box-java-sdk/commit/e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "message": "Fix Test", "committedDate": "2020-04-09T03:08:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NjA0Mg==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406286042", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.wrappedConnection.setMaxRetryAttempts(attempts);\n          \n          \n            \n                    this.wrappedConnection.setMaxRequestAttempts(attempts);", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:25:19Z", "path": "src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "diffHunk": "@@ -93,14 +93,50 @@ public boolean getAutoRefresh() {\n         return this.wrappedConnection.getAutoRefresh();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @return the maximum number of request attempts.\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRequestAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @param attempts the maximum number of request attempts.\n+     * @deprecated setMaxRetryAttempts is preferred because it more clearly sets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public void setMaxRequestAttempts(int attempts) {\n-        this.wrappedConnection.setMaxRequestAttempts(attempts);\n+        this.wrappedConnection.setMaxRetryAttempts(attempts);", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "003d0086d439585865725b5b9e8685e91507f1ba", "chunk": "diff --git a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\nindex a8ef5ee8..0b7fa3a6 100644\n--- a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n+++ b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n\n@@ -103,7 +103,7 @@ public class SharedLinkAPIConnection extends BoxAPIConnection {\n     @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRetryAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts() + 1;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NjM3Mw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406286373", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return this.wrappedConnection.getMaxRetryAttempts();\n          \n          \n            \n                    return this.wrappedConnection.getMaxRequestAttempts();", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:25:41Z", "path": "src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "diffHunk": "@@ -93,14 +93,50 @@ public boolean getAutoRefresh() {\n         return this.wrappedConnection.getAutoRefresh();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @return the maximum number of request attempts.\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRequestAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts();", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "003d0086d439585865725b5b9e8685e91507f1ba", "chunk": "diff --git a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\nindex a8ef5ee8..0b7fa3a6 100644\n--- a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n+++ b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n\n@@ -103,7 +103,7 @@ public class SharedLinkAPIConnection extends BoxAPIConnection {\n     @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRetryAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts() + 1;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NjY1NA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406286654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    BoxGlobalSettings.maxRetryAttempts = attempts;\n          \n          \n            \n                    BoxGlobalSettings.maxRetryAttempts = attempts - 1;", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:26:06Z", "path": "src/main/java/com/box/sdk/BoxGlobalSettings.java", "diffHunk": "@@ -44,18 +44,44 @@ public static void setReadTimeout(int readTimeout) {\n     }\n \n     /**\n-     * Returns the global maximum number of request attempts.\n+     * Returns the global total maximum number of times an API request will be tried when error responses\n+     * are received.\n      * @return max number of request attempts\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n      */\n+    @Deprecated\n     public static int getMaxRequestAttempts() {\n-        return maxRequestAttempts;\n+        return maxRetryAttempts;\n     }\n \n     /**\n-     * Sets the global default maximum number of request attempts.\n-     * @param maxRequestAttempts maximum number of request attempts\n+     * Sets the global total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @param attempts maximum number of request attempts\n+     * @deprecated setMaxRetryAttempts is preferred because it more clearly sets the number\n+     * of times a request should be retried after an error response is received.\n      */\n-    public static void setMaxRequestAttempts(int maxRequestAttempts) {\n-        BoxGlobalSettings.maxRequestAttempts = maxRequestAttempts;\n+    @Deprecated\n+    public static void setMaxRequestAttempts(int attempts) {\n+        BoxGlobalSettings.maxRetryAttempts = attempts;", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "767b1c8e0127659d2e17d83b42f8bae506429d55", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxGlobalSettings.java b/src/main/java/com/box/sdk/BoxGlobalSettings.java\nindex 2ae2c78e..9ea1f5bb 100644\n--- a/src/main/java/com/box/sdk/BoxGlobalSettings.java\n+++ b/src/main/java/com/box/sdk/BoxGlobalSettings.java\n\n@@ -64,7 +64,7 @@ public final class BoxGlobalSettings {\n      */\n     @Deprecated\n     public static void setMaxRequestAttempts(int attempts) {\n-        BoxGlobalSettings.maxRetryAttempts = attempts;\n+        BoxGlobalSettings.maxRetryAttempts = attempts - 1;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MDA2Mw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406290063", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return this.maxRetryAttempts + 1;\n          \n          \n            \n                    return this.maxRetryAttempts;", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:30:34Z", "path": "src/main/java/com/box/sdk/BoxAPIConnection.java", "diffHunk": "@@ -419,19 +429,45 @@ public boolean getAutoRefresh() {\n     }\n \n     /**\n-     * Gets the maximum number of times an API request will be tried when an error occurs.\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n      * @return the maximum number of request attempts.\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n      */\n+    @Deprecated\n     public int getMaxRequestAttempts() {\n-        return this.maxRequestAttempts;\n+        return this.maxRetryAttempts + 1;", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NjUyNA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406296524", "bodyText": "The + 1 should be removed because when our retry logic calls this method, it should return the number of retries. It will add 1 to the number of retries when it executes.", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MDA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyOTkxOA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406329918", "bodyText": "This method is deprecated, so the SDK doesn't call it anymore. It's just preserved for client apps that may have been calling it.", "author": "PJSimon", "createdAt": "2020-04-09T16:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MDA2Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MTk5Nw==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406291997", "bodyText": "Leaving this in doesn't do anything because we don't use this anywhere. By deprecating it, we allow them to set it, but it doesn't affect functionality. So in the end, it is a breaking change unless we find a way to read this value and DEFAULT_MAX_RETRIES.", "author": "sujaygarlanka", "createdAt": "2020-04-09T15:33:31Z", "path": "src/main/java/com/box/sdk/BoxAPIConnection.java", "diffHunk": "@@ -22,10 +22,20 @@\n  */\n public class BoxAPIConnection {\n     /**\n-     * The default maximum number of times an API request will be tried when an error occurs.\n+     * The default total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @deprecated DEFAULT_MAX_RETRIES is preferred because it more clearly sets the number\n+     * of times a request should be retried after an error response is received.\n      */\n+    @Deprecated\n     public static final int DEFAULT_MAX_ATTEMPTS = 5;", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNjM1OQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406336359", "bodyText": "Correct, it's no longer used in the SDK.  It's deprecated because it's public, so it's possible that there are client apps out there reading this value from the SDK, for use in their client code.\nI don't understand your last sentence.", "author": "PJSimon", "createdAt": "2020-04-09T16:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2Mzc5OQ==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406363799", "bodyText": "You're right. Forgot it's static and can't be set.", "author": "sujaygarlanka", "createdAt": "2020-04-09T17:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MTk5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "767b1c8e0127659d2e17d83b42f8bae506429d55", "url": "https://github.com/box/box-java-sdk/commit/767b1c8e0127659d2e17d83b42f8bae506429d55", "message": "Update src/main/java/com/box/sdk/BoxGlobalSettings.java\n\nCo-Authored-By: Sujay Garlanka <sujay.garlanka@gmail.com>", "committedDate": "2020-04-09T16:37:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzMTkzMg==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406331932", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return maxRetryAttempts;\n          \n          \n            \n                    return maxRetryAttempts + 1;", "author": "PJSimon", "createdAt": "2020-04-09T16:36:27Z", "path": "src/main/java/com/box/sdk/BoxGlobalSettings.java", "diffHunk": "@@ -44,18 +44,44 @@ public static void setReadTimeout(int readTimeout) {\n     }\n \n     /**\n-     * Returns the global maximum number of request attempts.\n+     * Returns the global total maximum number of times an API request will be tried when error responses\n+     * are received.\n      * @return max number of request attempts\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n      */\n+    @Deprecated\n     public static int getMaxRequestAttempts() {\n-        return maxRequestAttempts;\n+        return maxRetryAttempts;", "originalCommit": "e466b6c40c038b4f9abb201a100c9a4d8a0b8529", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "767b1c8e0127659d2e17d83b42f8bae506429d55", "chunk": "diff --git a/src/main/java/com/box/sdk/BoxGlobalSettings.java b/src/main/java/com/box/sdk/BoxGlobalSettings.java\nindex 2ae2c78e..9ea1f5bb 100644\n--- a/src/main/java/com/box/sdk/BoxGlobalSettings.java\n+++ b/src/main/java/com/box/sdk/BoxGlobalSettings.java\n\n@@ -64,7 +64,7 @@ public final class BoxGlobalSettings {\n      */\n     @Deprecated\n     public static void setMaxRequestAttempts(int attempts) {\n-        BoxGlobalSettings.maxRetryAttempts = attempts;\n+        BoxGlobalSettings.maxRetryAttempts = attempts - 1;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNzYxMA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406337610", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return this.wrappedConnection.getMaxRetryAttempts();\n          \n          \n            \n                    return this.wrappedConnection.getMaxRetryAttempts() + 1;", "author": "PJSimon", "createdAt": "2020-04-09T16:46:02Z", "path": "src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "diffHunk": "@@ -93,14 +93,50 @@ public boolean getAutoRefresh() {\n         return this.wrappedConnection.getAutoRefresh();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @return the maximum number of request attempts.\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRequestAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts();", "originalCommit": "767b1c8e0127659d2e17d83b42f8bae506429d55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzODA2OA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406338068", "bodyText": "Good point, but adding plus one to getMaxRetryAttempts is better because getMaxRequestAttempts is deprecated, now.", "author": "PJSimon", "createdAt": "2020-04-09T16:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNzYxMA=="}], "type": "inlineReview", "revised_code": {"commit": "003d0086d439585865725b5b9e8685e91507f1ba", "chunk": "diff --git a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\nindex a8ef5ee8..0b7fa3a6 100644\n--- a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n+++ b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n\n@@ -103,7 +103,7 @@ public class SharedLinkAPIConnection extends BoxAPIConnection {\n     @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRetryAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts() + 1;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzODM4Mg==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406338382", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.wrappedConnection.setMaxRetryAttempts(attempts);\n          \n          \n            \n                    this.wrappedConnection.setMaxRetryAttempts(attempts - 1);", "author": "PJSimon", "createdAt": "2020-04-09T16:47:24Z", "path": "src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "diffHunk": "@@ -93,14 +93,50 @@ public boolean getAutoRefresh() {\n         return this.wrappedConnection.getAutoRefresh();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @return the maximum number of request attempts.\n+     * @deprecated getMaxRetryAttempts is preferred because it more clearly gets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRequestAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts();\n     }\n \n+    /**\n+     * Sets the total maximum number of times an API request will be tried when error responses\n+     * are received.\n+     * @param attempts the maximum number of request attempts.\n+     * @deprecated setMaxRetryAttempts is preferred because it more clearly sets the number\n+     * of times a request should be retried after an error response is received.\n+     */\n+    @Deprecated\n     @Override\n     public void setMaxRequestAttempts(int attempts) {\n-        this.wrappedConnection.setMaxRequestAttempts(attempts);\n+        this.wrappedConnection.setMaxRetryAttempts(attempts);", "originalCommit": "767b1c8e0127659d2e17d83b42f8bae506429d55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzODU2NA==", "url": "https://github.com/box/box-java-sdk/pull/787#discussion_r406338564", "bodyText": "Good point, but subtracting one is better because getMaxRequestAttempts is deprecated, now.", "author": "PJSimon", "createdAt": "2020-04-09T16:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzODM4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "003d0086d439585865725b5b9e8685e91507f1ba", "chunk": "diff --git a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\nindex a8ef5ee8..0b7fa3a6 100644\n--- a/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n+++ b/src/main/java/com/box/sdk/SharedLinkAPIConnection.java\n\n@@ -103,7 +103,7 @@ public class SharedLinkAPIConnection extends BoxAPIConnection {\n     @Deprecated\n     @Override\n     public int getMaxRequestAttempts() {\n-        return this.wrappedConnection.getMaxRetryAttempts();\n+        return this.wrappedConnection.getMaxRetryAttempts() + 1;\n     }\n \n     /**\n"}}, {"oid": "33585a11ec0ab89e97b327b12c636eeb4cc61717", "url": "https://github.com/box/box-java-sdk/commit/33585a11ec0ab89e97b327b12c636eeb4cc61717", "message": "Update src/main/java/com/box/sdk/BoxGlobalSettings.java", "committedDate": "2020-04-09T16:50:53Z", "type": "commit"}, {"oid": "bb61a926b773f68b25e27c0c9e5c50193aa41bdd", "url": "https://github.com/box/box-java-sdk/commit/bb61a926b773f68b25e27c0c9e5c50193aa41bdd", "message": "Update CHANGELOG.md", "committedDate": "2020-04-09T16:51:10Z", "type": "commit"}, {"oid": "003d0086d439585865725b5b9e8685e91507f1ba", "url": "https://github.com/box/box-java-sdk/commit/003d0086d439585865725b5b9e8685e91507f1ba", "message": "Update src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "committedDate": "2020-04-09T16:51:39Z", "type": "commit"}, {"oid": "156d1385e5d887d16610e81d9c6146f1eaa7b10a", "url": "https://github.com/box/box-java-sdk/commit/156d1385e5d887d16610e81d9c6146f1eaa7b10a", "message": "Update src/main/java/com/box/sdk/SharedLinkAPIConnection.java", "committedDate": "2020-04-09T16:51:51Z", "type": "commit"}, {"oid": "e12800f6f8773c442bf1e0ad1ddefaf62636e59b", "url": "https://github.com/box/box-java-sdk/commit/e12800f6f8773c442bf1e0ad1ddefaf62636e59b", "message": "Merge branch 'master' into amend-retry-logic", "committedDate": "2020-04-09T16:55:15Z", "type": "commit"}, {"oid": "22afd34fbb052b31c6495381654def3adebb5a90", "url": "https://github.com/box/box-java-sdk/commit/22afd34fbb052b31c6495381654def3adebb5a90", "message": "Update CHANGELOG.md", "committedDate": "2020-04-09T17:37:42Z", "type": "commit"}]}