{"pr_number": 2228, "pr_title": "[CALCITE-4225] Make RelDecorrelator pluggable", "pr_createdAt": "2020-10-21T02:35:08Z", "pr_url": "https://github.com/apache/calcite/pull/2228", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2NzY1MQ==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r508967651", "bodyText": "It may be more efficient to replace this with !getPostDecorrelateRules().isEmpty()", "author": "liyafan82", "createdAt": "2020-10-21T03:30:03Z", "path": "core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java", "diffHunk": "@@ -280,16 +285,19 @@ protected RelNode decorrelate(RelNode root) {\n     final Frame frame = getInvoke(root, null);\n     if (frame != null) {\n       // has been rewritten; apply rules post-decorrelation\n-      final HepProgram program2 = HepProgram.builder()\n+      final HepProgramBuilder builder = HepProgram.builder()\n           .addRuleInstance(\n               CoreRules.FILTER_INTO_JOIN.config\n                   .withRelBuilderFactory(f)\n                   .toRule())\n           .addRuleInstance(\n               CoreRules.JOIN_CONDITION_PUSH.config\n                   .withRelBuilderFactory(f)\n-                  .toRule())\n-          .build();\n+                  .toRule());\n+      if (getPostDecorrelateRules().size() > 0) {", "originalCommit": "0c540c21796a216df7dc55005ae5a2c66042ebbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MzA3Mw==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r508973073", "bodyText": "Which kind of list has a more efficient impl ?", "author": "danny0405", "createdAt": "2020-10-21T03:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2NzY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3ODIxOQ==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r508978219", "bodyText": "For example, ArrayList has O(1) time complexity for size() operation. However, the time complexity for org.apache.calcite.runtime.ConsList is O(n).", "author": "liyafan82", "createdAt": "2020-10-21T04:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2NzY1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7893542b606c78f98fcd3737c8c6599436080911", "chunk": "diff --git a/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java b/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\nindex 255c37844..5a6b364d8 100644\n--- a/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\n+++ b/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\n\n@@ -294,7 +294,7 @@ protected RelNode decorrelate(RelNode root) {\n               CoreRules.JOIN_CONDITION_PUSH.config\n                   .withRelBuilderFactory(f)\n                   .toRule());\n-      if (getPostDecorrelateRules().size() > 0) {\n+      if (!getPostDecorrelateRules().isEmpty()) {\n         builder.addRuleCollection(getPostDecorrelateRules());\n       }\n       final HepProgram program2 = builder.build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2Nzc4NQ==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r508967785", "bodyText": "this class -> this object", "author": "liyafan82", "createdAt": "2020-10-21T03:30:28Z", "path": "core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java", "diffHunk": "@@ -2962,4 +2970,23 @@ assert allLessThan(this.oldToNewOutputs.values(),\n     /** Sets {@link #decorrelator}. */\n     Config withDecorrelator(RelDecorrelator decorrelator);\n   }\n+\n+  // -------------------------------------------------------------------------\n+  //  Getter/Setter\n+  // -------------------------------------------------------------------------\n+\n+  /**\n+   * Returns the {@code visitor} on which the {@code MethodDispatcher} dispatches\n+   * each {@code decorrelateRel} method, the default implementation returns this class,", "originalCommit": "0c540c21796a216df7dc55005ae5a2c66042ebbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7893542b606c78f98fcd3737c8c6599436080911", "chunk": "diff --git a/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java b/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\nindex 255c37844..5a6b364d8 100644\n--- a/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\n+++ b/core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java\n\n@@ -2977,7 +2977,7 @@ assert allLessThan(this.oldToNewOutputs.values(),\n \n   /**\n    * Returns the {@code visitor} on which the {@code MethodDispatcher} dispatches\n-   * each {@code decorrelateRel} method, the default implementation returns this class,\n+   * each {@code decorrelateRel} method, the default implementation returns this instance,\n    * if you got a sub-class, override this method to replace the {@code visitor} as the\n    * sub-class instance.\n    */\n"}}, {"oid": "7893542b606c78f98fcd3737c8c6599436080911", "url": "https://github.com/apache/calcite/commit/7893542b606c78f98fcd3737c8c6599436080911", "message": "[CALCITE-4225] Make RelDecorrelator pluggable\n\n* Change all the members of RelDecorrelator protected scope\n* Add RelDecorrelator.getVisitor to override the dispatcher visitor\n* Add RelDecorrelator.getPostDecorrelateRules for post decorrelation\n  optimisation", "committedDate": "2020-10-21T03:51:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NjMyNQ==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r510576325", "bodyText": "Do we want to consider annotating it with \"@NotNull\"?", "author": "liyafan82", "createdAt": "2020-10-23T03:41:08Z", "path": "core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java", "diffHunk": "@@ -2962,4 +2970,23 @@ assert allLessThan(this.oldToNewOutputs.values(),\n     /** Sets {@link #decorrelator}. */\n     Config withDecorrelator(RelDecorrelator decorrelator);\n   }\n+\n+  // -------------------------------------------------------------------------\n+  //  Getter/Setter\n+  // -------------------------------------------------------------------------\n+\n+  /**\n+   * Returns the {@code visitor} on which the {@code MethodDispatcher} dispatches\n+   * each {@code decorrelateRel} method, the default implementation returns this instance,\n+   * if you got a sub-class, override this method to replace the {@code visitor} as the\n+   * sub-class instance.\n+   */\n+  protected RelDecorrelator getVisitor() {\n+    return this;\n+  }\n+\n+  /** Returns the rules applied on the rel after decorrelation, never null. */\n+  protected Collection<RelOptRule> getPostDecorrelateRules() {", "originalCommit": "7893542b606c78f98fcd3737c8c6599436080911", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NjU0NA==", "url": "https://github.com/apache/calcite/pull/2228#discussion_r510576544", "bodyText": "No, because @NotNull should be the default.", "author": "danny0405", "createdAt": "2020-10-23T03:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU3NjMyNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "57997b53d4ca5c04a0282b3267a38f8a79f42283", "url": "https://github.com/apache/calcite/commit/57997b53d4ca5c04a0282b3267a38f8a79f42283", "message": "[CALCITE-4225] Make RelDecorrelator pluggable\n\n* Change all the members of RelDecorrelator as protected scope\n* Add RelDecorrelator.getVisitor to override the dispatcher visitor\n* Add RelDecorrelator.getPostDecorrelateRules for post decorrelation\n  optimisation", "committedDate": "2020-10-23T04:01:40Z", "type": "commit"}, {"oid": "57997b53d4ca5c04a0282b3267a38f8a79f42283", "url": "https://github.com/apache/calcite/commit/57997b53d4ca5c04a0282b3267a38f8a79f42283", "message": "[CALCITE-4225] Make RelDecorrelator pluggable\n\n* Change all the members of RelDecorrelator as protected scope\n* Add RelDecorrelator.getVisitor to override the dispatcher visitor\n* Add RelDecorrelator.getPostDecorrelateRules for post decorrelation\n  optimisation", "committedDate": "2020-10-23T04:01:40Z", "type": "forcePushed"}]}