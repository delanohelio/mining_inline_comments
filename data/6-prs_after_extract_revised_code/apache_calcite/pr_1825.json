{"pr_number": 1825, "pr_title": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "pr_createdAt": "2020-02-24T08:30:29Z", "pr_url": "https://github.com/apache/calcite/pull/1825", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEzMDE3MQ==", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383130171", "bodyText": "No need to use LinkedHashMultimap because the key should be unique.", "author": "chunweilei", "createdAt": "2020-02-24T08:31:48Z", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -239,8 +237,8 @@\n \n   /** Maps rule classes to their name, to ensure that the names are unique and\n    * conform to rules. */\n-  private final SetMultimap<String, Class> ruleNames =\n-      LinkedHashMultimap.create();\n+  private final Map<String, RelOptRule> ruleNames = new HashMap<>();", "originalCommit": "bb593bbfda7f0ce82a7f0b4895923758632dedec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "1c97cba020806951a97b2960dad26acfc267e019", "url": "https://github.com/apache/calcite/commit/1c97cba020806951a97b2960dad26acfc267e019", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "committedDate": "2020-02-24T09:19:15Z", "type": "forcePushed"}, {"oid": "df80e6b5421f4ed14462ecf347d75f3fe115dd88", "url": "https://github.com/apache/calcite/commit/df80e6b5421f4ed14462ecf347d75f3fe115dd88", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "committedDate": "2020-02-24T09:55:20Z", "type": "forcePushed"}, {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6", "url": "https://github.com/apache/calcite/commit/10f52f7934c0801fe553689dece70beac9bf1fe6", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "committedDate": "2020-02-24T10:00:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0NTQ1MA==", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383445450", "bodyText": "You can simplify this as -\nif (ruleNames.put(ruleName, rule)) {\n...\n}\nthen you won't need the else block.", "author": "xndai", "createdAt": "2020-02-24T18:45:51Z", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -451,12 +449,11 @@ public boolean addRule(RelOptRule rule) {\n     assert added;\n \n     final String ruleName = rule.toString();\n-    if (ruleNames.put(ruleName, rule.getClass())) {\n-      Set<Class> x = ruleNames.get(ruleName);\n-      if (x.size() > 1) {\n-        throw new RuntimeException(\"Rule description '\" + ruleName\n-            + \"' is not unique; classes: \" + x);\n-      }\n+    if (ruleNames.containsKey(ruleName)) {", "originalCommit": "10f52f7934c0801fe553689dece70beac9bf1fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwMzUwNQ==", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383603505", "bodyText": "Good idea~", "author": "chunweilei", "createdAt": "2020-02-25T00:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0NTQ1MA=="}], "type": "inlineReview", "revised_code": {"commit": "72650e363360f0a651c549e798c4fadb7981175d", "chunk": "diff --git a/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java b/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java\nindex 5aea93351..3020490a2 100644\n--- a/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java\n+++ b/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java\n\n@@ -449,11 +449,9 @@ public boolean addRule(RelOptRule rule) {\n     assert added;\n \n     final String ruleName = rule.toString();\n-    if (ruleNames.containsKey(ruleName)) {\n+    if (ruleNames.put(ruleName, rule) != null) {\n       throw new RuntimeException(\"Rule description '\" + ruleName\n           + \"' is not unique. \");\n-    } else {\n-      ruleNames.put(ruleName, rule);\n     }\n \n     mapRuleDescription(rule);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0NjAyNA==", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383446024", "bodyText": "It's interesting that this is only called during planner clean up phase. But I think it's still good to fix this.", "author": "xndai", "createdAt": "2020-02-24T18:46:54Z", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -493,6 +490,9 @@ public boolean removeRule(RelOptRule rule) {\n       return false;\n     }\n \n+    // Remove rule name.\n+    ruleNames.remove(rule.toString());\n+", "originalCommit": "10f52f7934c0801fe553689dece70beac9bf1fe6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "72650e363360f0a651c549e798c4fadb7981175d", "url": "https://github.com/apache/calcite/commit/72650e363360f0a651c549e798c4fadb7981175d", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "committedDate": "2020-02-25T00:59:14Z", "type": "commit"}, {"oid": "72650e363360f0a651c549e798c4fadb7981175d", "url": "https://github.com/apache/calcite/commit/72650e363360f0a651c549e798c4fadb7981175d", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "committedDate": "2020-02-25T00:59:14Z", "type": "forcePushed"}]}