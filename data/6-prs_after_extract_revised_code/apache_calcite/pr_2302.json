{"pr_number": 2302, "pr_title": "[CALCITE-4437] The Sort rel should be decorrelated even though it has fetch or limit when it is not inside a Correlate (Thomas Rebele)", "pr_createdAt": "2020-12-16T10:49:13Z", "pr_url": "https://github.com/apache/calcite/pull/2302", "timeline": [{"oid": "f0a3fe5549567a5ae75504417f5a1d61d4b0ca91", "url": "https://github.com/apache/calcite/commit/f0a3fe5549567a5ae75504417f5a1d61d4b0ca91", "message": "[CALCITE-4437] The Sort rel should be decorrelated even though it has fetch or limit when it is not inside a Correlate (Thomas Rebele)", "committedDate": "2020-12-16T11:01:06Z", "type": "commit"}, {"oid": "f0a3fe5549567a5ae75504417f5a1d61d4b0ca91", "url": "https://github.com/apache/calcite/commit/f0a3fe5549567a5ae75504417f5a1d61d4b0ca91", "message": "[CALCITE-4437] The Sort rel should be decorrelated even though it has fetch or limit when it is not inside a Correlate (Thomas Rebele)", "committedDate": "2020-12-16T11:01:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580104993", "bodyText": "Is there other way to handle the isCorVarDefined variables ? For example, keep it as a internal state while decorrelating.", "author": "danny0405", "createdAt": "2021-02-22T09:39:05Z", "path": "core/src/main/java/org/apache/calcite/sql2rel/RelDecorrelator.java", "diffHunk": "@@ -429,7 +430,7 @@ protected RexNode removeCorrelationExpr(\n         ImmutableSortedMap.of());\n   }\n \n-  public @Nullable Frame decorrelateRel(Sort rel) {\n+  public @Nullable Frame decorrelateRel(Sort rel, boolean isCorVarDefined) {\n     //", "originalCommit": "f0a3fe5549567a5ae75504417f5a1d61d4b0ca91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDE5NDU5OA==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580194598", "bodyText": "Thanks for the feedback @danny0405 .\nI guess it could be possible to keep it in an internal state, but I believe it might be not that simple. For example (if I am not mistaken) if we deal with a Correlate within a Correlate, when the inner one is done, it should not set the state back to \"non-correlate\" because we are still in the context of the outer one.\nWhat do you think @thomasrebele  ?", "author": "rubenada", "createdAt": "2021-02-22T11:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIyMDE0Nw==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580220147", "bodyText": "Indeed, @rubenada's example needs to be taken care of if we would remove the isCorVarDefined. By passing it as an parameter we avoid such subtle problems. We could translate it to an attribute and wrap the code that changes the attribute in a try-finally block:\nboolean prevCorVarDefined = isCorVarDefined\ntry {\n    // ...\n}\nfinally {\n    isCorVarDefined = prevCorVarDefined;\n}\n\nI'm slightly leaning towards using a parameter, which looks a bit cleaner to me. Does anyone have another suggestions how to handle this variable?", "author": "thomasrebele", "createdAt": "2021-02-22T12:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIyNzIzNw==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580227237", "bodyText": "IMHO the solution proposed in the PR, even though it probably is not the most elegant one, is effective and arguably less error-prone than other alternatives, so I'd lean towards accepting it and merging the PR as it is. Especially if we consider that 1.27 release is around the corner and we should get this fixed before that.\nAny thoughts @danny0405 ?", "author": "rubenada", "createdAt": "2021-02-22T12:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDg3MTIzMQ==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580871231", "bodyText": "I have no ideas yet, keep an recursive state in the decorrelator is really a complex work and needs careful design logic, we can merge this PR first and refactor it later on.", "author": "danny0405", "createdAt": "2021-02-23T09:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDg4MzAzNg==", "url": "https://github.com/apache/calcite/pull/2302#discussion_r580883036", "bodyText": "I agree, I think the safest approach would be merging this PR to get it fixed for 1.27; and then considering a potential refactoring in a subsequent version.\nSo, if there are no objections, I'll merge this PR in the next 24/48 h", "author": "rubenada", "createdAt": "2021-02-23T09:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDEwNDk5Mw=="}], "type": "inlineReview", "revised_code": null}]}