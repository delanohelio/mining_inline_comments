{"pr_number": 2072, "pr_title": "[CALCITE-4118] RexSimplify might remove CAST from RexNode incorrectly", "pr_createdAt": "2020-07-17T09:56:26Z", "pr_url": "https://github.com/apache/calcite/pull/2072", "timeline": [{"oid": "6e2b263173e53d6b86bbfb5258f722f857973a2d", "url": "https://github.com/apache/calcite/commit/6e2b263173e53d6b86bbfb5258f722f857973a2d", "message": "[CALCITE-4118] RexSimplify might remove CAST from RexNode incorrectly", "committedDate": "2020-07-17T10:15:23Z", "type": "forcePushed"}, {"oid": "9ceac24d15d47867d5f79927f17249f1aefc1fb3", "url": "https://github.com/apache/calcite/commit/9ceac24d15d47867d5f79927f17249f1aefc1fb3", "message": "[CALCITE-4118] RexSimplify might remove CAST from RexNode incorrectly", "committedDate": "2020-07-27T13:58:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMxMTQ1Mw==", "url": "https://github.com/apache/calcite/pull/2072#discussion_r461311453", "bodyText": "Should be SqlTypeCoercionRule ?", "author": "danny0405", "createdAt": "2020-07-28T04:32:12Z", "path": "core/src/main/java/org/apache/calcite/rex/RexSimplify.java", "diffHunk": "@@ -1917,7 +1918,9 @@ private RexNode simplifyCast(RexCall e) {\n       if (RexUtil.isLosslessCast(intExpr.getType(), operand.getType())\n           && (e.getType().getSqlTypeName() == operand.getType().getSqlTypeName()\n           || e.getType().getSqlTypeName() == SqlTypeName.CHAR\n-          || operand.getType().getSqlTypeName() != SqlTypeName.CHAR)) {\n+          || operand.getType().getSqlTypeName() != SqlTypeName.CHAR)\n+          && SqlTypeAssignmentRule.instance()\n+          .canApplyFrom(intExpr.getType().getSqlTypeName(), e.getType().getSqlTypeName())) {\n         return rexBuilder.makeCast(e.getType(), intExpr);", "originalCommit": "9ceac24d15d47867d5f79927f17249f1aefc1fb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyNTkxOA==", "url": "https://github.com/apache/calcite/pull/2072#discussion_r461325918", "bodyText": "It seems you're right. BTW, what's the difference between SqlTypeCoercionRule  and SqlTypeAssignmentRule ?", "author": "chunweilei", "createdAt": "2020-07-28T05:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMxMTQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0ODY5Mg==", "url": "https://github.com/apache/calcite/pull/2072#discussion_r461348692", "bodyText": "See the java doc which already gave good explanation.", "author": "danny0405", "createdAt": "2020-07-28T06:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMxMTQ1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fab1392a1d435e153bf2b55b048b966e78bf1f90", "chunk": "diff --git a/core/src/main/java/org/apache/calcite/rex/RexSimplify.java b/core/src/main/java/org/apache/calcite/rex/RexSimplify.java\nindex a9e6dc841..db6f39bfb 100644\n--- a/core/src/main/java/org/apache/calcite/rex/RexSimplify.java\n+++ b/core/src/main/java/org/apache/calcite/rex/RexSimplify.java\n\n@@ -1919,7 +1919,7 @@ private RexNode simplifyCast(RexCall e) {\n           && (e.getType().getSqlTypeName() == operand.getType().getSqlTypeName()\n           || e.getType().getSqlTypeName() == SqlTypeName.CHAR\n           || operand.getType().getSqlTypeName() != SqlTypeName.CHAR)\n-          && SqlTypeAssignmentRule.instance()\n+          && SqlTypeCoercionRule.instance()\n           .canApplyFrom(intExpr.getType().getSqlTypeName(), e.getType().getSqlTypeName())) {\n         return rexBuilder.makeCast(e.getType(), intExpr);\n       }\n"}}, {"oid": "fab1392a1d435e153bf2b55b048b966e78bf1f90", "url": "https://github.com/apache/calcite/commit/fab1392a1d435e153bf2b55b048b966e78bf1f90", "message": "[CALCITE-4118] RexSimplify might remove CAST from RexNode incorrectly", "committedDate": "2020-07-28T05:26:32Z", "type": "commit"}, {"oid": "fab1392a1d435e153bf2b55b048b966e78bf1f90", "url": "https://github.com/apache/calcite/commit/fab1392a1d435e153bf2b55b048b966e78bf1f90", "message": "[CALCITE-4118] RexSimplify might remove CAST from RexNode incorrectly", "committedDate": "2020-07-28T05:26:32Z", "type": "forcePushed"}]}