{"pr_number": 2222, "pr_title": "[CALCITE-4277] When rel has been removed from its subset, skip the origin rule match (Jiatao Tao)", "pr_createdAt": "2020-10-17T14:36:29Z", "pr_url": "https://github.com/apache/calcite/pull/2222", "timeline": [{"oid": "f373eba8b33160f86ce0c2664a12ea911e34c907", "url": "https://github.com/apache/calcite/commit/f373eba8b33160f86ce0c2664a12ea911e34c907", "message": "[CALCITE-4277] Skip rule match when rel's RelSet is obsolete (Jiatao Tao)", "committedDate": "2020-10-17T14:45:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r508971252", "bodyText": "Could you please explain in what scenarios does the following condition hold?\n!subset.getRelList().contains(rel)", "author": "liyafan82", "createdAt": "2020-10-21T03:43:28Z", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleCall.java", "diffHunk": "@@ -190,7 +190,8 @@ protected void onMatch() {\n           return;\n         }\n \n-        if (subset.set.equivalentSet != null) {\n+        if ((subset.set.equivalentSet != null)\n+            || (subset != rel && !subset.getRelList().contains(rel))) {", "originalCommit": "f373eba8b33160f86ce0c2664a12ea911e34c907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MjA5Mg==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r508972092", "bodyText": "when we merge set, the rel may be obsolete, but the rule match is still in the rule queue. Later I'll try to contrast a ut to cover this.", "author": "Aaaaaaron", "createdAt": "2020-10-21T03:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NzM0Nw==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r508977347", "bodyText": "Thanks for your feedback. When merging set, the condition should already been covered by subset.set.equivalentSet != null?", "author": "liyafan82", "createdAt": "2020-10-21T04:08:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwODY2MQ==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r509008661", "bodyText": "Latter I'll debug again, we found this in our product env.", "author": "Aaaaaaron", "createdAt": "2020-10-21T06:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MjU4Nw==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r513342587", "bodyText": "@liyafan82 I dig the code, and it's not about equivalentSet, let me explain to you:\n\nIn RelSet#mergeWith, we ill rename parent rels. note, what we renamed is the equivalentSet's parent, so it may not have equivalentSet(child have equivalentSet)\n\n    // Update all rels which have a child in the other set, to reflect the\n    // fact that the child has been renamed.\n    //\n    // Copy array to prevent ConcurrentModificationException.\n    final List<RelNode> previousParents =\n        ImmutableList.copyOf(otherSet.getParentRels());\n    for (RelNode parentRel : previousParents) {\n      planner.rename(parentRel);\n    }\n\n\nin VolcanoPlanner#rename(RelNode rel), we found equivRel for the rel, we will remove the rel from the subset\n\n        // Remove rel from its subset. (This may leave the subset\n        // empty, but if so, that will be dealt with when the sets\n        // get merged.)\n       final RelSubset subset = mapRel2Subset.put(rel, equivRelSubset);\n       boolean existed = subset.set.rels.remove(rel);\n\nthat's why I add this condition", "author": "Aaaaaaron", "createdAt": "2020-10-28T10:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQwNjkwNQ==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r513406905", "bodyText": "@Aaaaaaron Thanks for the clarification. It would be nice if we could add a brief description in the comment.", "author": "liyafan82", "createdAt": "2020-10-28T12:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMzM4Ng==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r514033386", "bodyText": "@Aaaaaaron Thanks for the clarification. It would be nice if we could add a brief description in the comment.\n\nUpdated, could you please take a look?", "author": "Aaaaaaron", "createdAt": "2020-10-29T06:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MTY5OA==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r514051698", "bodyText": "Looks good. Thanks.\nThis PR seems like a positive change.", "author": "liyafan82", "createdAt": "2020-10-29T07:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgwODIyNg==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r514808226", "bodyText": "The operation subset.getRelList().contains(rel) is with poor performance. Can you give evidence how much gains of the patch ?", "author": "danny0405", "createdAt": "2020-10-30T03:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUyMzEwOA==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r519523108", "bodyText": "Hi @danny0405 , sorry for the late reply. We found this case in our product env and it been so long that I can not find the origin case \ud83d\ude02, I'll try again.\nBy the performance, we had monitor, it does not increase the planning time.", "author": "Aaaaaaron", "createdAt": "2020-11-09T02:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUyNDIyOQ==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r519524229", "bodyText": "For the potential performance issue, how about I add a method getRelSet, the set#contains's performance should be better than list#contain", "author": "Aaaaaaron", "createdAt": "2020-11-09T02:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyODI4Mw==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r519628283", "bodyText": "Thanks for the explanation, i'm fine with the change.", "author": "danny0405", "createdAt": "2020-11-09T08:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE3NzMxOQ==", "url": "https://github.com/apache/calcite/pull/2222#discussion_r534177319", "bodyText": "This patch results in 20-30% CPU time increase in org.apache.calcite.adapter.tpch.TpchTest#testQuery07 :(", "author": "vlsi", "createdAt": "2020-12-02T13:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b789b3b217bf6ebb05d1a0e092fb6668b3db0ed2", "chunk": "diff --git a/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleCall.java b/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleCall.java\nindex 3498ae173..31fe0b4cc 100644\n--- a/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleCall.java\n+++ b/core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleCall.java\n\n@@ -191,6 +191,9 @@ protected void onMatch() {\n         }\n \n         if ((subset.set.equivalentSet != null)\n+            // When rename RelNode via VolcanoPlanner#rename(RelNode rel),\n+            // we may remove rel from its subset: \"subset.set.rels.remove(rel)\".\n+            // Skip rule match when the rel has been removed from set.\n             || (subset != rel && !subset.getRelList().contains(rel))) {\n           LOGGER.debug(\n               \"Rule [{}] not fired because operand #{} ({}) belongs to obsolete set\",\n"}}, {"oid": "6cb7f9152bda8ace25db19d7954f09da0534fcc2", "url": "https://github.com/apache/calcite/commit/6cb7f9152bda8ace25db19d7954f09da0534fcc2", "message": "[CALCITE-4277] When rel has been renamed, skip the origin rule match (Jiatao Tao)", "committedDate": "2020-10-29T06:47:43Z", "type": "forcePushed"}, {"oid": "b789b3b217bf6ebb05d1a0e092fb6668b3db0ed2", "url": "https://github.com/apache/calcite/commit/b789b3b217bf6ebb05d1a0e092fb6668b3db0ed2", "message": "[CALCITE-4277] When rel has been removed from its subset, skip the origin rule match (Jiatao Tao)", "committedDate": "2020-10-29T06:54:01Z", "type": "commit"}, {"oid": "b789b3b217bf6ebb05d1a0e092fb6668b3db0ed2", "url": "https://github.com/apache/calcite/commit/b789b3b217bf6ebb05d1a0e092fb6668b3db0ed2", "message": "[CALCITE-4277] When rel has been removed from its subset, skip the origin rule match (Jiatao Tao)", "committedDate": "2020-10-29T06:54:01Z", "type": "forcePushed"}]}