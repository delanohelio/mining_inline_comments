{"pr_number": 2164, "pr_title": "[CALCITE-4176] Key descriptor can be optional in SESSION table function", "pr_createdAt": "2020-09-22T12:17:27Z", "pr_url": "https://github.com/apache/calcite/pull/2164", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4ODQ0OA==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493788448", "bodyText": "Seems like you have changed this test which intended to test whether the first augment is named param is ok? If so can you change it back?", "author": "amaliujia", "createdAt": "2020-09-23T18:05:49Z", "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -10512,41 +10515,47 @@ private void checkCustomColumnResolving(String table) {\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n         .ok();\n-    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"session(\\n\"\n-        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"data => table orders,\\n\"\n         + \"timecol => descriptor(rowtime),\\n\"\n-        + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n-        .fails(\"Param 'data' not found in function 'SESSION'; did you mean 'DATA'\\\\?\");", "originalCommit": "960b89ea868ca3180b3163c3bfd35be3f7676ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5Mzg2OA==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493993868", "bodyText": "The test you mentioned is at L10534, I just add some new tests.", "author": "liupc", "createdAt": "2020-09-24T01:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4ODQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5ODM1OA==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493998358", "bodyText": "Got it. Thanks!", "author": "amaliujia", "createdAt": "2020-09-24T02:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4ODQ0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTAxMQ==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493789011", "bodyText": "One thing I am not sure is, does current Calcite named argument has an ordering requirement? Will Calcite accept if key/timecol is reordered?", "author": "amaliujia", "createdAt": "2020-09-23T18:06:51Z", "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -10512,41 +10515,47 @@ private void checkCustomColumnResolving(String table) {\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n         .ok();\n-    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"session(\\n\"\n-        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"data => table orders,\\n\"\n         + \"timecol => descriptor(rowtime),\\n\"\n-        + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n-        .fails(\"Param 'data' not found in function 'SESSION'; did you mean 'DATA'\\\\?\");\n+        .ok();\n+    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"^session(\\n\"\n         + \"data => table orders,\\n\"\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour)^)\")\n-        .fails(\"Invalid number of arguments to function 'SESSION'. Was expecting 4 arguments\");\n+        .fails(\"Cannot apply 'SESSION' to arguments of type 'SESSION\\\\(<RECORDTYPE\\\\(TIMESTAMP\\\\(\"\n+            + \"0\\\\) ROWTIME, INTEGER PRODUCTID, INTEGER ORDERID\\\\)>, <COLUMN_LIST>, \"\n+            + \"<INTERVAL HOUR>\\\\)'. Supported form\\\\(s\\\\): SESSION\\\\(TABLE table_name, DESCRIPTOR\\\\(\"\n+            + \"timecol\\\\), DESCRIPTOR\\\\(key\\\\) optional, datetime interval\\\\)\");\n     sql(\"select * from table(\\n\"\n-        + \"^session(table orders, descriptor(rowtime), interval '2' hour)^)\")\n-        .fails(\"Invalid number of arguments to function 'SESSION'. Was expecting 4 arguments\");\n+        + \"session(\\n\"\n+        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"timecol => descriptor(rowtime),\\n\"\n+        + \"key => descriptor(productid),\\n\"", "originalCommit": "960b89ea868ca3180b3163c3bfd35be3f7676ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5NDYyOQ==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493994629", "bodyText": "Yes, Calcite will permute the operands before checking if it's a SqlArgumentAssignmentOperator, so here is ok.", "author": "liupc", "createdAt": "2020-09-24T01:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5ODQ5Mg==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493998492", "bodyText": "Thanks for the clarification.", "author": "amaliujia", "createdAt": "2020-09-24T02:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTAxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTc5Mg==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493789792", "bodyText": "Why need this addition (as this PR is to change SESSION)? is there a test case verify this line of change?", "author": "amaliujia", "createdAt": "2020-09-23T18:08:17Z", "path": "core/src/main/java/org/apache/calcite/sql/SqlHopTableFunction.java", "diffHunk": "@@ -48,6 +48,9 @@ public SqlHopTableFunction() {\n       if (!checkTableAndDescriptorOperands(callBinding, 1)) {\n         return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);\n       }\n+      if (!checkTimeColumnDescriptorOperand(callBinding, 1)) {\n+        return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);", "originalCommit": "960b89ea868ca3180b3163c3bfd35be3f7676ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5NzIzNA==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493997234", "bodyText": "For TUMBLE/HOP table function, the descriptor must refer to a time column, I just add this check by the way.\ncurrently, there are no tests to verify this change, but If it's ok to do it in this PR, I can add some tests for it.\nOr maybe we can put it in another PR? what's your idea?", "author": "liupc", "createdAt": "2020-09-24T02:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5Nzk4Nw==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493997987", "bodyText": "I see. Please add tests to this PR (for both TUMBLE and HOP) and we can merge it together.", "author": "amaliujia", "createdAt": "2020-09-24T02:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTc5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4MDY5Mg==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r494880692", "bodyText": "Done", "author": "liupc", "createdAt": "2020-09-25T09:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTc5Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYyNA==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493999624", "bodyText": "In fact, as I recall checkTableAndDescriptorOperands will check whether the second argument is a descriptor, so this line might not be needed.", "author": "amaliujia", "createdAt": "2020-09-24T02:18:16Z", "path": "core/src/main/java/org/apache/calcite/sql/SqlSessionTableFunction.java", "diffHunk": "@@ -42,25 +43,41 @@ public SqlSessionTableFunction() {\n   private static class OperandMetadataImpl extends AbstractOperandMetadata {\n     OperandMetadataImpl() {\n       super(ImmutableList.of(PARAM_DATA, PARAM_TIMECOL, PARAM_KEY, PARAM_SIZE),\n-          4);\n+          3);\n     }\n \n     @Override public boolean checkOperandTypes(SqlCallBinding callBinding,\n         boolean throwOnFailure) {\n-      final SqlValidator validator = callBinding.getValidator();\n-      if (!checkTableAndDescriptorOperands(callBinding, 2)) {\n+      if (!checkTableAndDescriptorOperands(callBinding, 1)) {\n+        return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);\n+      }\n+      if (!checkTimeColumnDescriptorOperand(callBinding, 1)) {", "originalCommit": "960b89ea868ca3180b3163c3bfd35be3f7676ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMDE0OQ==", "url": "https://github.com/apache/calcite/pull/2164#discussion_r494000149", "bodyText": "Never mind. checkTimeColumnDescriptorOperand added a check for TIMESTAMP type for the one specified by DESCRIPTOR. We can keep this function here.", "author": "amaliujia", "createdAt": "2020-09-24T02:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYyNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "21df2389371ad55bfb2a5baa70f950e16a6592c9", "url": "https://github.com/apache/calcite/commit/21df2389371ad55bfb2a5baa70f950e16a6592c9", "message": "[CALCITE-4176] Key descriptor can be optional in SESSION table function\n\nFix style\n\nFix style\n\nAdding tests to check time column for TUMBLE/HOP table function\n\nFix style", "committedDate": "2020-09-27T12:07:49Z", "type": "commit"}, {"oid": "21df2389371ad55bfb2a5baa70f950e16a6592c9", "url": "https://github.com/apache/calcite/commit/21df2389371ad55bfb2a5baa70f950e16a6592c9", "message": "[CALCITE-4176] Key descriptor can be optional in SESSION table function\n\nFix style\n\nFix style\n\nAdding tests to check time column for TUMBLE/HOP table function\n\nFix style", "committedDate": "2020-09-27T12:07:49Z", "type": "forcePushed"}]}