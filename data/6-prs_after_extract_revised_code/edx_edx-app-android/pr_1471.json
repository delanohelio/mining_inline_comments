{"pr_number": 1471, "pr_title": "Disabled user account handling", "pr_createdAt": "2020-10-15T18:58:51Z", "pr_url": "https://github.com/edx/edx-app-android/pull/1471", "timeline": [{"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "url": "https://github.com/edx/edx-app-android/commit/e466aa2c51743c0c46a6af265672e42e0babe1c4", "message": "Disabled user account handling\n- LEARNER-7913\n- Log out learner on receiving the error code `user_is_disabled`.\n- Show a proper error when a disable user tries to login.", "committedDate": "2020-10-15T18:41:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506313185", "bodyText": "IMO, we can remove the finish() from this method as we are clearing the stack in forceLogout", "author": "omerhabib26", "createdAt": "2020-10-16T11:23:06Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java", "diffHunk": "@@ -279,6 +279,9 @@ protected boolean isLandscape() {\n      */\n     @SuppressWarnings(\"unused\")\n     public void onEvent(LogoutEvent event) {\n+        environment.getRouter().forceLogout(this,\n+                environment.getAnalyticsRegistry(),\n+                environment.getNotificationDelegate());\n         finish();", "originalCommit": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyNzgzOA==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506327838", "bodyText": "Plus, in environment.getRouter().forceLogout we can remove the EventBus.getDefault().post(new LogoutEvent()); as it can make a loop", "author": "omerhabib26", "createdAt": "2020-10-16T11:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3NjY2MQ==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506376661", "bodyText": "removed.", "author": "farhan-arshad-dev", "createdAt": "2020-10-16T12:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQzMDkyOA==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506430928", "bodyText": "added again the finish(); statment for the safe side.", "author": "farhan-arshad-dev", "createdAt": "2020-10-16T13:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "76f4e729e305b122d414c6c537b8391417b154fd", "chunk": "diff --git a/OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java b/OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java\nindex 8b10a6a3..7b8f9977 100755\n--- a/OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java\n+++ b/OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java\n\n@@ -282,7 +282,6 @@ public abstract class BaseFragmentActivity extends BaseAppActivity\n         environment.getRouter().forceLogout(this,\n                 environment.getAnalyticsRegistry(),\n                 environment.getNotificationDelegate());\n-        finish();\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMDg1Ng==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506320856", "bodyText": "Can we add a doc here?\nIf the user logged In through social auth & if user got disabled then on next first API call app will force the user to logout and navigate it to the splash screen", "author": "omerhabib26", "createdAt": "2020-10-16T11:32:57Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java", "diffHunk": "@@ -88,6 +91,9 @@ public synchronized Request authenticate(Route route, final Response response) t\n                                 .header(\"Authorization\", currentAuth.token_type + \" \" + currentAuth.access_token)\n                                 .build();\n                     }\n+                case DISABLED_USER_ERROR_MESSAGE:", "originalCommit": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4MjQ3NQ==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506382475", "bodyText": "update to\n                     // If the user is logged-in & marked as disabled then on the next server response\n                    // app will force the user to logout and navigate it to the launcher screen.", "author": "farhan-arshad-dev", "createdAt": "2020-10-16T12:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMDg1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "76f4e729e305b122d414c6c537b8391417b154fd", "chunk": "diff --git a/OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java b/OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java\nindex 85bcea7c..9d69841a 100644\n--- a/OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java\n+++ b/OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java\n\n@@ -92,6 +92,8 @@ public class OauthRefreshTokenAuthenticator implements Authenticator {\n                                 .build();\n                     }\n                 case DISABLED_USER_ERROR_MESSAGE:\n+                    // If the user is logged-in & marked as disabled then on the next server response\n+                    // app will force the user to logout and navigate it to the launcher screen.\n                     EventBus.getDefault().post(new LogoutEvent());\n                     break;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMDg4MA==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506330880", "bodyText": "Can we change the subject in the email to \"Account Disabled\"", "author": "omerhabib26", "createdAt": "2020-10-16T11:45:16Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java", "diffHunk": "@@ -357,17 +357,28 @@ public void onUserLoginFailure(Exception ex, String accessToken, String backend)\n                     errorMessage.getMessageLine1(),\n                     (errorMessage.getMessageLine2() != null) ?\n                             errorMessage.getMessageLine2() : getString(R.string.login_failed));\n-        } else if (ex != null && ex instanceof HttpStatusException &&\n-                ((HttpStatusException) ex).getStatusCode() == HttpStatus.UPGRADE_REQUIRED) {\n-            LoginActivity.this.showAlertDialog(null,\n-                    getString(R.string.app_version_unsupported_login_msg),\n-                    getString(R.string.label_update),\n-                    new DialogInterface.OnClickListener() {\n-                        @Override\n-                        public void onClick(DialogInterface dialog, int which) {\n-                            AppStoreUtils.openAppInAppStore(LoginActivity.this);\n-                        }\n-                    }, getString(android.R.string.cancel), null);\n+        } else if (ex != null && ex instanceof HttpStatusException) {\n+            switch (((HttpStatusException) ex).getStatusCode()) {\n+                case HttpStatus.UPGRADE_REQUIRED:\n+                    LoginActivity.this.showAlertDialog(null,\n+                            getString(R.string.app_version_unsupported_login_msg),\n+                            getString(R.string.label_update),\n+                            (dialog, which) -> AppStoreUtils\n+                                    .openAppInAppStore(LoginActivity.this),\n+                            getString(android.R.string.cancel), null);\n+                    break;\n+                case HttpStatus.FORBIDDEN:\n+                    LoginActivity.this.showAlertDialog(getString(R.string.login_error),\n+                            getString(R.string.auth_provider_disabled_user_error),\n+                            getString(R.string.CUSTOMER_SUPPORT),\n+                            (dialog, which) -> environment.getRouter()\n+                                    .showFeedbackScreen(LoginActivity.this,", "originalCommit": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4NTI4Nw==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506385287", "bodyText": "done.", "author": "farhan-arshad-dev", "createdAt": "2020-10-16T12:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMDg4MA=="}], "type": "inlineReview", "revised_code": {"commit": "76f4e729e305b122d414c6c537b8391417b154fd", "chunk": "diff --git a/OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java b/OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java\nindex 323c0453..0d753fe6 100644\n--- a/OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java\n+++ b/OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java\n\n@@ -370,10 +369,10 @@ public class LoginActivity\n                 case HttpStatus.FORBIDDEN:\n                     LoginActivity.this.showAlertDialog(getString(R.string.login_error),\n                             getString(R.string.auth_provider_disabled_user_error),\n-                            getString(R.string.CUSTOMER_SUPPORT),\n+                            getString(R.string.label_customer_support),\n                             (dialog, which) -> environment.getRouter()\n                                     .showFeedbackScreen(LoginActivity.this,\n-                                            getString(R.string.email_subject)), getString(android.R.string.cancel), null);\n+                                            getString(R.string.email_subject_account_disabled)), getString(android.R.string.cancel), null);\n                     break;\n                 default:\n                     showAlertDialog(getString(R.string.login_error), ErrorUtils.getErrorMessage(ex, LoginActivity.this));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMTQ4MQ==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506331481", "bodyText": "change email subject here as well", "author": "omerhabib26", "createdAt": "2020-10-16T11:46:09Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java", "diffHunk": "@@ -653,9 +653,17 @@ public void onUserLoginFailure(Exception ex, String accessToken, String backend)\n         // handle if this is a LoginException\n         tryToSetUIInteraction(true);\n         logger.error(ex);\n-        SocialFactory.SOCIAL_SOURCE_TYPE socialType = SocialFactory.SOCIAL_SOURCE_TYPE.fromString(backend);\n-        updateUIOnSocialLoginToEdxFailure(socialType, accessToken);\n-\n+        if (ex instanceof HttpStatusException && ((HttpStatusException) ex).getStatusCode() == HttpStatus.FORBIDDEN) {\n+            RegisterActivity.this.showAlertDialog(getString(R.string.login_error),\n+                    getString(R.string.auth_provider_disabled_user_error),\n+                    getString(R.string.CUSTOMER_SUPPORT),\n+                    (dialog, which) -> environment.getRouter()\n+                            .showFeedbackScreen(RegisterActivity.this,", "originalCommit": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4NTMyOA==", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506385328", "bodyText": "done.", "author": "farhan-arshad-dev", "createdAt": "2020-10-16T12:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMTQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "76f4e729e305b122d414c6c537b8391417b154fd", "chunk": "diff --git a/OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java b/OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java\nindex 69edbfaf..be27c0df 100644\n--- a/OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java\n+++ b/OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java\n\n@@ -656,10 +656,10 @@ public class RegisterActivity extends BaseFragmentActivity\n         if (ex instanceof HttpStatusException && ((HttpStatusException) ex).getStatusCode() == HttpStatus.FORBIDDEN) {\n             RegisterActivity.this.showAlertDialog(getString(R.string.login_error),\n                     getString(R.string.auth_provider_disabled_user_error),\n-                    getString(R.string.CUSTOMER_SUPPORT),\n+                    getString(R.string.label_customer_support),\n                     (dialog, which) -> environment.getRouter()\n                             .showFeedbackScreen(RegisterActivity.this,\n-                                    getString(R.string.email_subject)), getString(android.R.string.cancel), null);\n+                                    getString(R.string.email_subject_account_disabled)), getString(android.R.string.cancel), null);\n         } else {\n             SocialFactory.SOCIAL_SOURCE_TYPE socialType = SocialFactory.SOCIAL_SOURCE_TYPE.fromString(backend);\n             updateUIOnSocialLoginToEdxFailure(socialType, accessToken);\n"}}, {"oid": "76f4e729e305b122d414c6c537b8391417b154fd", "url": "https://github.com/edx/edx-app-android/commit/76f4e729e305b122d414c6c537b8391417b154fd", "message": "Address PR commits", "committedDate": "2020-10-16T13:26:52Z", "type": "commit"}, {"oid": "0cc2b862b2810535a6f320eec2f9a614789d90c5", "url": "https://github.com/edx/edx-app-android/commit/0cc2b862b2810535a6f320eec2f9a614789d90c5", "message": "Finish for the safe side", "committedDate": "2020-10-16T13:35:35Z", "type": "commit"}]}