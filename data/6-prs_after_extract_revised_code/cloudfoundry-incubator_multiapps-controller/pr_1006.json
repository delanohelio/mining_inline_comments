{"pr_number": 1006, "pr_title": "Applications v3", "pr_createdAt": "2020-12-07T11:54:49Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006", "timeline": [{"oid": "508bb88dcadf3488967cca1e253be523ee69029a", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/508bb88dcadf3488967cca1e253be523ee69029a", "message": "Optimize calls to CC", "committedDate": "2020-12-07T12:04:24Z", "type": "forcePushed"}, {"oid": "af58f5582392b458ae657a797f41d646362da862", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/af58f5582392b458ae657a797f41d646362da862", "message": "Optimize calls to CC", "committedDate": "2020-12-08T12:11:41Z", "type": "forcePushed"}, {"oid": "f7a8395b44139808efa09ea27bc48743c4024bbb", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/f7a8395b44139808efa09ea27bc48743c4024bbb", "message": "Optimize calls to CC", "committedDate": "2020-12-08T12:14:50Z", "type": "forcePushed"}, {"oid": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "message": "Optimize calls to CC", "committedDate": "2020-12-08T12:23:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0NDAzOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538344038", "bodyText": "Why are these needed?", "author": "radito3", "createdAt": "2020-12-08T13:04:28Z", "path": "multiapps-controller-process/src/main/java/module-info.java", "diffHunk": "@@ -50,6 +50,8 @@\n     requires spring.core;\n     requires spring.security.oauth2;\n     requires spring.web;\n+    requires reactor.netty;\n+    requires io.netty.handler;", "originalCommit": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU2NjE4Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538566182", "bodyText": "Error occurred during initialization of boot layer\njava.lang.module.FindException: Module reactor.netty not found, required by com.sap.cloudfoundry.client.facade\nThey are required as far as I understood", "author": "IvanBorislavovDimitrov", "createdAt": "2020-12-08T16:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0NDAzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0NzE3NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538347174", "bodyText": "Can appArchiveId be retrieved in this method instead of passing it as a parameter?", "author": "radito3", "createdAt": "2020-12-08T13:07:34Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java", "diffHunk": "@@ -94,6 +99,34 @@ public StepPhase executeAsyncStep(ProcessContext context) throws FileStorageExce\n         return StepPhase.DONE;\n     }\n \n+    private CloudPackage createDockerPackage(CloudControllerClient client, CloudApplicationExtended application) {\n+        UUID applicationGuid = client.getApplicationGuid(application.getName());\n+        return client.createDockerPackage(applicationGuid, application.getDockerInfo());\n+    }\n+\n+    private String getNewApplicationDigest(ProcessContext context, String appArchiveId, String fileName) throws FileStorageException {\n+        return fileService.processFileContent(context.getVariable(Variables.SPACE_GUID), appArchiveId,", "originalCommit": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU2NjIzOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538566239", "bodyText": "Yes, it can.", "author": "IvanBorislavovDimitrov", "createdAt": "2020-12-08T16:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0NzE3NA=="}], "type": "inlineReview", "revised_code": {"commit": "fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "chunk": "diff --git a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\nindex 66af0bf84..f5a78b756 100644\n--- a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n+++ b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n\n@@ -104,8 +103,9 @@ public class UploadAppStep extends TimeoutAsyncFlowableStep {\n         return client.createDockerPackage(applicationGuid, application.getDockerInfo());\n     }\n \n-    private String getNewApplicationDigest(ProcessContext context, String appArchiveId, String fileName) throws FileStorageException {\n-        return fileService.processFileContent(context.getVariable(Variables.SPACE_GUID), appArchiveId,\n+    private String getNewApplicationDigest(ProcessContext context, String fileName) throws FileStorageException {\n+        return fileService.processFileContent(context.getVariable(Variables.SPACE_GUID),\n+                                              context.getRequiredVariable(Variables.APP_ARCHIVE_ID),\n                                               createDigestCalculatorFileContentProcessor(fileName));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM1OTg0Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538359843", "bodyText": "If I understand correctly, this flow means that there isn't a file entry in the MTAR associated with this module because it is described as a docker application, is this right?\nIf so, how did we operate with docker apps so far?", "author": "radito3", "createdAt": "2020-12-08T13:20:11Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java", "diffHunk": "@@ -63,17 +64,21 @@ public StepPhase executeAsyncStep(ProcessContext context) throws FileStorageExce\n \n         MtaArchiveElements mtaArchiveElements = context.getVariable(Variables.MTA_ARCHIVE_ELEMENTS);\n         String moduleFileName = mtaArchiveElements.getModuleFileName(applicationToProcess.getModuleName());\n+        CloudControllerClient client = context.getControllerClient();\n         if (moduleFileName == null) {\n             getStepLogger().debug(Messages.NO_CONTENT_TO_UPLOAD);\n+            if (applicationToProcess.getDockerInfo() != null) {", "originalCommit": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU2NjMwMA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538566300", "bodyText": "In v2 the docker apps do not require packages, they are just created as docker image apps and started. In v3 it is required to create a docker package to deploy the application. If there is no module name the application is probably a docker app but I added this check just in case if the user does not provide docker parameters otherwise a null pointer will occur.", "author": "IvanBorislavovDimitrov", "createdAt": "2020-12-08T16:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM1OTg0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "chunk": "diff --git a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\nindex 66af0bf84..f5a78b756 100644\n--- a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n+++ b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n\n@@ -74,8 +74,7 @@ public class UploadAppStep extends TimeoutAsyncFlowableStep {\n             return StepPhase.DONE;\n         }\n \n-        String newApplicationDigest = getNewApplicationDigest(context, context.getRequiredVariable(Variables.APP_ARCHIVE_ID),\n-                                                              moduleFileName);\n+        String newApplicationDigest = getNewApplicationDigest(context, moduleFileName);\n         CloudApplication cloudApp = client.getApplication(applicationToProcess.getName());\n \n         boolean contentChanged = detectApplicationFileDigestChanges(cloudApp, newApplicationDigest);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM2MTE2Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538361163", "bodyText": "Why isn't the guid in the CloudApplicationExtended object used but a request to the CC is made to fetch the guid?", "author": "radito3", "createdAt": "2020-12-08T13:21:31Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java", "diffHunk": "@@ -94,6 +99,34 @@ public StepPhase executeAsyncStep(ProcessContext context) throws FileStorageExce\n         return StepPhase.DONE;\n     }\n \n+    private CloudPackage createDockerPackage(CloudControllerClient client, CloudApplicationExtended application) {\n+        UUID applicationGuid = client.getApplicationGuid(application.getName());", "originalCommit": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU2NjMzOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538566338", "bodyText": "Because it set in BuildApplicationDeployModelStep and its guid is unknown -> the id is null.", "author": "IvanBorislavovDimitrov", "createdAt": "2020-12-08T16:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM2MTE2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "chunk": "diff --git a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\nindex 66af0bf84..f5a78b756 100644\n--- a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n+++ b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UploadAppStep.java\n\n@@ -104,8 +103,9 @@ public class UploadAppStep extends TimeoutAsyncFlowableStep {\n         return client.createDockerPackage(applicationGuid, application.getDockerInfo());\n     }\n \n-    private String getNewApplicationDigest(ProcessContext context, String appArchiveId, String fileName) throws FileStorageException {\n-        return fileService.processFileContent(context.getVariable(Variables.SPACE_GUID), appArchiveId,\n+    private String getNewApplicationDigest(ProcessContext context, String fileName) throws FileStorageException {\n+        return fileService.processFileContent(context.getVariable(Variables.SPACE_GUID),\n+                                              context.getRequiredVariable(Variables.APP_ARCHIVE_ID),\n                                               createDigestCalculatorFileContentProcessor(fileName));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3NjU3Nw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538376577", "bodyText": "Maybe dockerStaging would be more descriptive", "author": "radito3", "createdAt": "2020-12-08T13:36:29Z", "path": "multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStepTest.java", "diffHunk": "@@ -92,16 +92,19 @@ void testCreateApplicationFromDockerImage() {\n                                                                                           .password(\"somePassword\")\n                                                                                           .build())\n                                                    .build();\n+        Staging staging = ImmutableStaging.builder()", "originalCommit": "d5a6a0a52f9fe87b6e9d9e0c8ef6fa22dc694847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU2NjQ0OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/1006#discussion_r538566448", "bodyText": "Done", "author": "IvanBorislavovDimitrov", "createdAt": "2020-12-08T16:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM3NjU3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "267b271c197d749c79dbccf0418b32a383e0938b", "chunk": "diff --git a/multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStepTest.java b/multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStepTest.java\nindex a535d30d0..0f37adf47 100644\n--- a/multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStepTest.java\n+++ b/multiapps-controller-process/src/test/java/org/cloudfoundry/multiapps/controller/process/steps/CreateOrUpdateAppStepTest.java\n\n@@ -92,11 +92,11 @@ class CreateOrUpdateAppStepTest extends SyncFlowableStepTest<CreateOrUpdateAppSt\n                                                                                           .password(\"somePassword\")\n                                                                                           .build())\n                                                    .build();\n-        Staging staging = ImmutableStaging.builder()\n-                                          .dockerInfo(dockerInfo)\n-                                          .build();\n+        Staging dockerStaging = ImmutableStaging.builder()\n+                                                .dockerInfo(dockerInfo)\n+                                                .build();\n \n-        CloudApplicationExtended application = buildApplication(staging, 128, 256, Collections.emptySet());\n+        CloudApplicationExtended application = buildApplication(dockerStaging, 128, 256, Collections.emptySet());\n         application = ImmutableCloudApplicationExtended.copyOf(application)\n                                                        .withDockerInfo(dockerInfo);\n         prepareContext(application, Collections.emptyMap());\n"}}, {"oid": "267b271c197d749c79dbccf0418b32a383e0938b", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/267b271c197d749c79dbccf0418b32a383e0938b", "message": "Adopt v3 applications api", "committedDate": "2020-12-08T16:26:43Z", "type": "commit"}, {"oid": "fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "message": "Optimize calls to CC", "committedDate": "2020-12-08T16:26:46Z", "type": "commit"}, {"oid": "fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/fee0461fd8d1ce401c77be58a5e22c15474ff9a0", "message": "Optimize calls to CC", "committedDate": "2020-12-08T16:26:46Z", "type": "forcePushed"}, {"oid": "392a1ccd159e92e732042765fe77925f8442c01e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/392a1ccd159e92e732042765fe77925f8442c01e", "message": "Refactoring", "committedDate": "2020-12-09T14:53:52Z", "type": "commit"}, {"oid": "ae701a5bd352dd83d0cf5a0e19d4280245eea315", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/ae701a5bd352dd83d0cf5a0e19d4280245eea315", "message": "Remove unused method", "committedDate": "2020-12-10T13:26:25Z", "type": "commit"}, {"oid": "b4e1f96fb0ef7661757400ce0d3dac92b833806a", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/b4e1f96fb0ef7661757400ce0d3dac92b833806a", "message": "Adopt cloudfoundry-client-facade 2.4.0", "committedDate": "2020-12-11T15:13:30Z", "type": "commit"}]}