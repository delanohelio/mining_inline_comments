{"pr_number": 725, "pr_title": "Adopt retrieval of application packages during staging", "pr_createdAt": "2020-01-14T11:54:59Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725", "timeline": [{"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "message": "Adopt retrieval of application packages during staging", "committedDate": "2020-01-14T12:25:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MTczOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366391738", "bodyText": "Can we avoid the fetch of this app?", "author": "nictas", "createdAt": "2020-01-14T15:08:07Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StageAppStep.java", "diffHunk": "@@ -26,8 +27,11 @@\n \n     @Override\n     protected StepPhase executeAsyncStep(ExecutionWrapper execution) {\n-        CloudApplication app = StepsUtil.getApp(execution.getContext());\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        String appName = StepsUtil.getApp(execution.getContext())\n+                                  .getName();\n+        CloudControllerClient client = execution.getControllerClient();\n+        CloudApplication app = client.getApplication(appName);", "originalCommit": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzNjE0NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366836145", "bodyText": "We need the GUID...\nIt is in the ApplicationStager app.getMetadata().getGuid()", "author": "enchobelezirev", "createdAt": "2020-01-15T11:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MTczOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MjY2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366392665", "bodyText": "There are two ands in this variable name.", "author": "nictas", "createdAt": "2020-01-14T15:09:44Z", "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java", "diffHunk": "@@ -214,10 +218,49 @@ public void testBindDropletToApp() {\n     }\n \n     @Test\n-    public void testStageAppIfThereIsNoUploadToken() {\n+    public void testStageAppIfThereIsNoUploadTokenAndThereAreNoPackages() {\n         Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n                .thenReturn(null);\n-        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, null, null));\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        Mockito.when(client.getPackagesForApplication(Mockito.eq(testApplicationGuid), Mockito.any()))\n+               .thenReturn(Collections.emptyList());\n+\n+        Mockito.verifyNoInteractions(stepLogger);\n+        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, testApplication, stepLogger));\n+    }\n+\n+    @Test\n+    public void testStageAppIfThereIsNoUploadTokenAndThereIsOnlyOnePackage() {\n+        Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n+               .thenReturn(null);\n+        UUID packageGuid = UUID.randomUUID();\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        CloudPackage andAndOnlyApplicationPackage = ImmutableCloudPackage.builder()", "originalCommit": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45a3be1338875c9be5ca2dc92905f02c9a660380", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java b/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java\nindex f4c2dd4b9..a498c4f86 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java\n\n@@ -247,7 +247,7 @@ public class ApplicationStagerTest {\n                                                                                                     .build())\n                                                                     .name(\"test-app\")\n                                                                     .build();\n-        CloudPackage andAndOnlyApplicationPackage = ImmutableCloudPackage.builder()\n+        CloudPackage applicationPackage = ImmutableCloudPackage.builder()\n                                                                          .metadata(ImmutableCloudMetadata.builder()\n                                                                                                          .guid(packageGuid)\n                                                                                                          .updatedAt(Date.from(Instant.now()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NDEwMw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366394103", "bodyText": "Do uploadToken.getPackageGuid() here and remove the stageApplication method overload below.", "author": "nictas", "createdAt": "2020-01-14T15:12:09Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java", "diffHunk": "@@ -133,11 +137,28 @@ public void bindDropletToApplication(DelegateExecution context, UUID appGuid) {\n \n     public StepPhase stageApp(DelegateExecution context, CloudApplication app, StepLogger stepLogger) {\n         UploadToken uploadToken = StepsUtil.getUploadToken(context);\n-        if (uploadToken == null) {\n-            return StepPhase.DONE;\n+        if (uploadToken != null) {\n+            stepLogger.debug(Messages.UPLOAD_TOKEN_FOR_APPLICATION_0_1, app.getName(), JsonUtil.toJson(uploadToken, true));\n+            return stageApplication(context, app, stepLogger, uploadToken);", "originalCommit": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "45a3be1338875c9be5ca2dc92905f02c9a660380", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java\nindex 6025ddbc8..38a7e1e04 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java\n\n@@ -139,7 +138,7 @@ public class ApplicationStager {\n         UploadToken uploadToken = StepsUtil.getUploadToken(context);\n         if (uploadToken != null) {\n             stepLogger.debug(Messages.UPLOAD_TOKEN_FOR_APPLICATION_0_1, app.getName(), JsonUtil.toJson(uploadToken, true));\n-            return stageApplication(context, app, stepLogger, uploadToken);\n+            return stageApplication(context, app, stepLogger, uploadToken.getPackageGuid());\n         }\n \n         CloudPackage lastApplicationPackage = getLastPackageForApplication(app);\n"}}, {"oid": "45a3be1338875c9be5ca2dc92905f02c9a660380", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/45a3be1338875c9be5ca2dc92905f02c9a660380", "message": "Adopt retrieval of application packages during staging", "committedDate": "2020-01-15T11:55:24Z", "type": "forcePushed"}, {"oid": "58961c54a6463cb483c149e40c881348fceef8b3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/58961c54a6463cb483c149e40c881348fceef8b3", "message": "Adopt retrieval of application packages during staging", "committedDate": "2020-01-15T13:41:00Z", "type": "commit"}, {"oid": "58961c54a6463cb483c149e40c881348fceef8b3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/58961c54a6463cb483c149e40c881348fceef8b3", "message": "Adopt retrieval of application packages during staging", "committedDate": "2020-01-15T13:41:00Z", "type": "forcePushed"}]}