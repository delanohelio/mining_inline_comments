{"pr_number": 928, "pr_title": "Add ConfigurationSubscriptionCleaner", "pr_createdAt": "2020-08-12T09:31:48Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/928", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNzQ5Nw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/928#discussion_r469227497", "bodyText": "Good to find that!\nIt was regression delivered by me :(", "author": "boyan-velinov", "createdAt": "2020-08-12T12:37:29Z", "path": "multiapps-controller-core/src/main/java/org/cloudfoundry/multiapps/controller/core/persistence/query/impl/ConfigurationSubscriptionQueryImpl.java", "diffHunk": "@@ -126,7 +126,8 @@ public int deleteAll(String spaceId) {\n                                                                        .condition(getCriteriaBuilder()::equal)\n                                                                        .value(spaceId)\n                                                                        .build());\n-        return executeInTransaction(manager -> createDeleteQuery(manager, queryCriteria, ConfigurationEntryDto.class).executeUpdate());\n+        return executeInTransaction(manager -> createDeleteQuery(manager, queryCriteria,", "originalCommit": "ab2a9acf836233f7c2414eb955e2d1b0f55ad4ab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjM4NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/928#discussion_r469302385", "bodyText": "If one exception is thrown at the begining of stream processing, the deletion of other entries will not happen at all.\nSo, let's not rethrow the exception.", "author": "boyan-velinov", "createdAt": "2020-08-12T14:29:21Z", "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/jobs/ConfigurationSubscriptionCleaner.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package org.cloudfoundry.multiapps.controller.process.jobs;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.CloudControllerClientImpl;\n+import org.cloudfoundry.client.lib.CloudCredentials;\n+import org.cloudfoundry.client.lib.CloudOperationException;\n+import org.cloudfoundry.multiapps.controller.core.auditlogging.AuditLoggingProvider;\n+import org.cloudfoundry.multiapps.controller.core.model.ConfigurationSubscription;\n+import org.cloudfoundry.multiapps.controller.core.persistence.service.ConfigurationSubscriptionService;\n+import org.cloudfoundry.multiapps.controller.core.util.ApplicationConfiguration;\n+import org.cloudfoundry.multiapps.controller.core.util.SecurityUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.http.HttpStatus;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.UUID;\n+\n+@Named\n+@Order(40)\n+public class ConfigurationSubscriptionCleaner implements Cleaner {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigurationSubscriptionCleaner.class);\n+    private static final String AUTH_ORIGIN = \"uaa\";\n+\n+    protected ApplicationConfiguration configuration;\n+    protected ConfigurationSubscriptionService configurationSubscriptionService;\n+    protected CloudControllerClient cfClient;\n+    private boolean executed;\n+\n+    @Inject\n+    public ConfigurationSubscriptionCleaner(ApplicationConfiguration applicationConfiguration, ConfigurationSubscriptionService configurationSubscriptionService) {\n+        this.configuration = applicationConfiguration;\n+        this.configurationSubscriptionService = configurationSubscriptionService;\n+        this.executed = false;\n+    }\n+\n+    @Override\n+    public void execute(Date expirationTime) {\n+        if (!executed) {\n+            LOGGER.debug(CleanUpJob.LOG_MARKER, \"Deleting orphaned configuration subscriptions...\");\n+            deleteOrphanedConfigurationSubscriptions();\n+            LOGGER.debug(CleanUpJob.LOG_MARKER, \"Orphaned configuration subscriptions deleted\");\n+            executed = true;\n+        }\n+    }\n+\n+    private void deleteOrphanedConfigurationSubscriptions() {\n+        List<ConfigurationSubscription> configurationSubscriptions = configurationSubscriptionService.createQuery()\n+                                                                                                     .list();\n+        configurationSubscriptions.stream()\n+                                  .filter(this::hasNoAssociatedSpace)\n+                                  .peek(this::auditLogDeletion)\n+                                  .map(ConfigurationSubscription::getSpaceId)\n+                                  .distinct()\n+                                  .forEach(this::deleteConfigurationSubscriptionsBySpaceId);\n+    }\n+\n+    private boolean hasNoAssociatedSpace(ConfigurationSubscription configurationSubscription) {\n+        String spaceId = configurationSubscription.getSpaceId();\n+        return !spaceExists(spaceId);\n+    }\n+\n+    private boolean spaceExists(String spaceId) {\n+        if (cfClient == null) {\n+            initCloudControllerClient();\n+        }\n+        try {\n+            cfClient.getSpace(UUID.fromString(spaceId));\n+            return true;\n+        } catch (CloudOperationException e) {\n+            if (e.getStatusCode()\n+                 .equals(HttpStatus.NOT_FOUND)) {\n+                return false;\n+            }\n+            throw e;", "originalCommit": "ab2a9acf836233f7c2414eb955e2d1b0f55ad4ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxMjc0OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/928#discussion_r469312749", "bodyText": "only logging as a handling?", "author": "radoslav-d", "createdAt": "2020-08-12T14:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjM4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "e362b6439ec1aa963afbb64c2c545b76f356f9b3", "chunk": "diff --git a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/jobs/ConfigurationSubscriptionCleaner.java b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/jobs/ConfigurationSubscriptionCleaner.java\nindex 1a50c1e49..6d9bea0d6 100644\n--- a/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/jobs/ConfigurationSubscriptionCleaner.java\n+++ b/multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/jobs/ConfigurationSubscriptionCleaner.java\n\n@@ -77,7 +77,9 @@ public class ConfigurationSubscriptionCleaner implements Cleaner {\n                  .equals(HttpStatus.NOT_FOUND)) {\n                 return false;\n             }\n-            throw e;\n+            LOGGER.error(CleanUpJob.LOG_MARKER, \"Could not get space by uuid\", e);\n+            // will skip deletion of data\n+            return true;\n         }\n     }\n \n"}}, {"oid": "e362b6439ec1aa963afbb64c2c545b76f356f9b3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e362b6439ec1aa963afbb64c2c545b76f356f9b3", "message": "Add ConfigurationSubscriptionCleaner\n\nAdd new clean-up job, which will delete all orphaned configuration\nsubscription, which were not handled by the UserDataCleaner. The cleaner\nwill execute once per DS application run. The cleaner queries for all\nconfiguration subscriptions and checks each one whether its space is\nexisting. All configuration subscriptions with non-existence space are\ndeleted.\nNOTE: this cleaner should be removed for the next takt.\nJIRA: LMCROSSITXSADEPLOY-2130", "committedDate": "2020-08-12T14:50:52Z", "type": "commit"}, {"oid": "e362b6439ec1aa963afbb64c2c545b76f356f9b3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e362b6439ec1aa963afbb64c2c545b76f356f9b3", "message": "Add ConfigurationSubscriptionCleaner\n\nAdd new clean-up job, which will delete all orphaned configuration\nsubscription, which were not handled by the UserDataCleaner. The cleaner\nwill execute once per DS application run. The cleaner queries for all\nconfiguration subscriptions and checks each one whether its space is\nexisting. All configuration subscriptions with non-existence space are\ndeleted.\nNOTE: this cleaner should be removed for the next takt.\nJIRA: LMCROSSITXSADEPLOY-2130", "committedDate": "2020-08-12T14:50:52Z", "type": "forcePushed"}]}