{"pr_number": 883, "pr_title": "Change retrival of default domain to not fail", "pr_createdAt": "2020-06-17T11:55:43Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883", "timeline": [{"oid": "75a6f2016cee5b57836f6c1b72276caf02b3d71a", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/75a6f2016cee5b57836f6c1b72276caf02b3d71a", "message": "Change retrival of default domain to not fail\n\nIssue: LMCROSSITXSADEPLOY-2007", "committedDate": "2020-06-22T12:38:11Z", "type": "forcePushed"}, {"oid": "837b1446c73790be949fa20f171c6f67a156ad11", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/837b1446c73790be949fa20f171c6f67a156ad11", "message": "Change retrival of default domain to not fail\n\nIssue: LMCROSSITXSADEPLOY-2007", "committedDate": "2020-06-22T12:39:16Z", "type": "forcePushed"}, {"oid": "8edada0ac69e5f7dae840cd34f3ba670cdbf4192", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/8edada0ac69e5f7dae840cd34f3ba670cdbf4192", "message": "Remove unneccessary NameUtil methods", "committedDate": "2020-06-25T08:32:23Z", "type": "forcePushed"}, {"oid": "0d8b21aac00675978d800d11d92044a325cd0420", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0d8b21aac00675978d800d11d92044a325cd0420", "message": "Remove unused methods & variables in StepsUtil", "committedDate": "2020-06-25T09:03:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQzMzAwMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445433001", "bodyText": "Why these tests were removed?", "author": "theghost5800", "createdAt": "2020-06-25T09:36:36Z", "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/util/NameUtilTest.java", "diffHunk": "@@ -17,38 +17,6 @@\n \n public class NameUtilTest {\n \n-    @Test\n-    public void testIsValidXsAppNameWhenNamesAreValid() {", "originalCommit": "0d8b21aac00675978d800d11d92044a325cd0420", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4MzIwOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445483208", "bodyText": "Because the method \"isNameValid\" did nothing custom, it just delegated its arguments to String::matches. That's why it's deleted and so are its tests.", "author": "radito3", "createdAt": "2020-06-25T11:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQzMzAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "e27a377e9e91e7755c5ee74c4e5f77aee12c2c72", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/util/NameUtilTest.java b/com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/util/NameUtilTest.java\nindex be0ea5673..ea89ebb41 100644\n--- a/com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/util/NameUtilTest.java\n+++ b/com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/util/NameUtilTest.java\n\n@@ -17,6 +17,38 @@ import com.sap.cloud.lm.sl.cf.core.util.NameUtil.NameRequirements;\n \n public class NameUtilTest {\n \n+    @Test\n+    public void testIsValidXsAppNameWhenNamesAreValid() {\n+        testIsValidName(Arrays.asList(\"Fo0\", \"foo.bar\", \"foo_bar\", \"foo-bar\", \"//foo\\\\\"), NameRequirements.XS_APP_NAME_PATTERN, true);\n+    }\n+\n+    @Test\n+    public void testIsValidXsAppNameWhenNamesAreInvalid() {\n+        String longName = StringUtils.repeat(\"f\", NameRequirements.XS_APP_NAME_MAX_LENGTH + 1);\n+\n+        testIsValidName(Arrays.asList(\"sap_system\", \"sap_system_1\", \"foo&&bar\", \"foo bar\", longName), NameRequirements.XS_APP_NAME_PATTERN,\n+                        false);\n+    }\n+\n+    @Test\n+    public void testIsValidContainerNameWhenNamesAreValid() {\n+        testIsValidName(Arrays.asList(\"FOO\", \"FOO_BAR\", \"1_FOO\", \"FOO_1_BAR\"), NameRequirements.CONTAINER_NAME_PATTERN, true);\n+    }\n+\n+    @Test\n+    public void testIsValidContainerNameWhenNamesAreInvalid() {\n+        String longName = StringUtils.repeat(\"F\", NameRequirements.CONTAINER_NAME_MAX_LENGTH + 1);\n+\n+        testIsValidName(Arrays.asList(\"foo\", \"FOO BAR\", \"1-FOO\", \"FOO_&_BAR\", \"_FOO\", \" \", longName),\n+                        NameRequirements.CONTAINER_NAME_PATTERN, false);\n+    }\n+\n+    private void testIsValidName(List<String> names, String namePattern, boolean expectedResult) {\n+        for (String name : names) {\n+            assertEquals(expectedResult, NameUtil.isValidName(name, namePattern));\n+        }\n+    }\n+\n     public static Stream<Arguments> testGetNameWithProperLength() {\n         return Stream.of(\n         // @formatter:off\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0MTg1MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445441850", "bodyText": "If CloudDomain object is null it will be throw NPE when try to execute getName() method", "author": "theghost5800", "createdAt": "2020-06-25T09:51:50Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java", "diffHunk": "@@ -68,12 +68,14 @@ protected String getStepErrorMessage(ProcessContext context) {\n         return Messages.ERROR_COLLECTING_SYSTEM_PARAMETERS;\n     }\n \n-    private String getDefaultDomain(CloudControllerClient client) {\n-        CloudDomain defaultDomain = client.getDefaultDomain();\n-        if (defaultDomain != null) {\n-            return defaultDomain.getName();\n+    private String getDefaultDomain(CloudControllerClient client, ProcessContext context) {\n+        try {\n+            return client.getDefaultDomain()", "originalCommit": "0d8b21aac00675978d800d11d92044a325cd0420", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4Mzg2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445483865", "bodyText": "Our cf java client can't return a null object on getDefaultDomain", "author": "radito3", "createdAt": "2020-06-25T11:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0MTg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "2902b1cd8fd7b5256bed18ba54c81b540231c473", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\nindex eedcfc512..3009b860c 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n\n@@ -74,7 +76,7 @@ public class CollectSystemParametersStep extends SyncFlowableStep {\n                          .getName();\n         } catch (CloudOperationException exc) {\n             context.setVariable(Variables.MISSING_DEFAULT_DOMAIN, true);\n-            return \"apps.internal\";\n+            return DEFAULT_DOMAIN_PLACEHOLDER;\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0MjI4OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445442289", "bodyText": "Why we don't return null?", "author": "theghost5800", "createdAt": "2020-06-25T09:52:37Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java", "diffHunk": "@@ -68,12 +68,14 @@ protected String getStepErrorMessage(ProcessContext context) {\n         return Messages.ERROR_COLLECTING_SYSTEM_PARAMETERS;\n     }\n \n-    private String getDefaultDomain(CloudControllerClient client) {\n-        CloudDomain defaultDomain = client.getDefaultDomain();\n-        if (defaultDomain != null) {\n-            return defaultDomain.getName();\n+    private String getDefaultDomain(CloudControllerClient client, ProcessContext context) {\n+        try {\n+            return client.getDefaultDomain()\n+                         .getName();\n+        } catch (CloudOperationException exc) {\n+            context.setVariable(Variables.MISSING_DEFAULT_DOMAIN, true);\n+            return \"apps.internal\";", "originalCommit": "0d8b21aac00675978d800d11d92044a325cd0420", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4NDM4MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445484380", "bodyText": "It doesn't work with null. The reference parsing for ${default-domain} in the mta descriptor will fail if this is null", "author": "radito3", "createdAt": "2020-06-25T11:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0MjI4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2902b1cd8fd7b5256bed18ba54c81b540231c473", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\nindex eedcfc512..3009b860c 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n\n@@ -74,7 +76,7 @@ public class CollectSystemParametersStep extends SyncFlowableStep {\n                          .getName();\n         } catch (CloudOperationException exc) {\n             context.setVariable(Variables.MISSING_DEFAULT_DOMAIN, true);\n-            return \"apps.internal\";\n+            return DEFAULT_DOMAIN_PLACEHOLDER;\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0Mzk0Nw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445443947", "bodyText": "Why this was returned to old for each variant? What is wrong with lambda expression?", "author": "theghost5800", "createdAt": "2020-06-25T09:55:35Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java", "diffHunk": "@@ -34,27 +35,26 @@ public void check(DeploymentDescriptor descriptor) {\n \n     private void checkForCommonParameters(NamedParametersContainer namedParametersContainer, Set<String> readOnlyParameters,\n                                           Map<String, Set<String>> commonReadOnlyParameters) {\n-        Set<String> commonParameters = Sets.intersection(namedParametersContainer.getParameters()\n-                                                                                 .keySet(),\n-                                                         readOnlyParameters);\n+        Set<String> commonParameters = SetUtils.intersection(namedParametersContainer.getParameters()\n+                                                                                     .keySet(),\n+                                                             readOnlyParameters);\n         if (!commonParameters.isEmpty()) {\n             commonReadOnlyParameters.put(namedParametersContainer.getName(), commonParameters);\n         }\n     }\n \n     private void checkCollectionForCommonParameters(List<? extends NamedParametersContainer> namedElementsWithParametersContainers,\n                                                     Set<String> readOnlyParameters, Map<String, Set<String>> commonReadOnlyParameters) {\n-        namedElementsWithParametersContainers.forEach(namedElementWithParametersContainers -> checkForCommonParameters(namedElementWithParametersContainers,\n-                                                                                                                       readOnlyParameters,\n-                                                                                                                       commonReadOnlyParameters));\n+        for (NamedParametersContainer namedElement : namedElementsWithParametersContainers) {", "originalCommit": "0d8b21aac00675978d800d11d92044a325cd0420", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4NDg0Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445484842", "bodyText": "In my opinion the lambda expression was too long a line and it was unreadable. Doing it with a loop makes it more expressive", "author": "radito3", "createdAt": "2020-06-25T11:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ0Mzk0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "1623bf28ae4aef8dd266106af1f167f9d55a57f2", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\nindex 2b25b96f4..65677f471 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\n\n@@ -36,8 +36,7 @@ public class ReadOnlyParametersChecker {\n     private void checkForCommonParameters(NamedParametersContainer namedParametersContainer, Set<String> readOnlyParameters,\n                                           Map<String, Set<String>> commonReadOnlyParameters) {\n         Set<String> commonParameters = SetUtils.intersection(namedParametersContainer.getParameters()\n-                                                                                     .keySet(),\n-                                                             readOnlyParameters);\n+                                                                                     .keySet(), readOnlyParameters);\n         if (!commonParameters.isEmpty()) {\n             commonReadOnlyParameters.put(namedParametersContainer.getName(), commonParameters);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ1MjMzMw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r445452333", "bodyText": "This could be throw class cast exception if the user set non boolean value for \"no-route\" parameter. getProprtyValue method should be refactored to pass what class type you expect and throw exception if doesn't match to the required class type. If this refactor requires a lot of change, you can skip it but track BI in our jira or look for existing one and increase the prio.", "author": "theghost5800", "createdAt": "2020-06-25T10:10:54Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java", "diffHunk": "@@ -240,22 +242,27 @@ protected ServiceKeysCloudModelBuilder getServiceKeysCloudModelBuilder(ProcessCo\n     private List<String> getDomainsFromApps(ProcessContext context, DeploymentDescriptor descriptor,\r\n                                             ApplicationCloudModelBuilder applicationCloudModelBuilder, List<? extends Module> modules,\r\n                                             ModuleToDeployHelper moduleToDeployHelper) {\r\n-        String defaultDomain = (String) descriptor.getParameters()\r\n-                                                  .get(SupportedParameters.DEFAULT_DOMAIN);\r\n-\r\n         Set<String> domains = new TreeSet<>();\r\n         for (Module module : modules) {\r\n             if (!moduleToDeployHelper.isApplication(module)) {\r\n                 continue;\r\n             }\r\n             ParametersChainBuilder parametersChainBuilder = new ParametersChainBuilder(context.getVariable(Variables.COMPLETE_DEPLOYMENT_DESCRIPTOR));\r\n-            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(parametersChainBuilder.buildModuleChain(module.getName()),\r\n-                                                                                         module);\r\n+            List<Map<String, Object>> paramsList = parametersChainBuilder.buildModuleChain(module.getName());\r\n+\r\n+            boolean noRoute = (Boolean) PropertiesUtil.getPropertyValue(paramsList, SupportedParameters.NO_ROUTE, false);\r", "originalCommit": "0d8b21aac00675978d800d11d92044a325cd0420", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1623bf28ae4aef8dd266106af1f167f9d55a57f2", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\nindex 86f374dca..4beeb6b5d 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\n\n@@ -248,14 +248,14 @@ public class BuildCloudDeployModelStep extends SyncFlowableStep {\n                 continue;\n             }\n             ParametersChainBuilder parametersChainBuilder = new ParametersChainBuilder(context.getVariable(Variables.COMPLETE_DEPLOYMENT_DESCRIPTOR));\n-            List<Map<String, Object>> paramsList = parametersChainBuilder.buildModuleChain(module.getName());\n+            List<Map<String, Object>> parametersList = parametersChainBuilder.buildModuleChain(module.getName());\n \n-            boolean noRoute = (Boolean) PropertiesUtil.getPropertyValue(paramsList, SupportedParameters.NO_ROUTE, false);\n+            boolean noRoute = (Boolean) PropertiesUtil.getPropertyValue(parametersList, SupportedParameters.NO_ROUTE, false);\n             if (!noRoute && context.getVariable(Variables.MISSING_DEFAULT_DOMAIN)) {\n                 throw new SLException(Messages.ERROR_MISSING_DEFAULT_DOMAIN);\n             }\n \n-            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(paramsList, module);\n+            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(parametersList, module);\n             if (appDomains != null) {\n                 domains.addAll(appDomains);\n             }\n"}}, {"oid": "2902b1cd8fd7b5256bed18ba54c81b540231c473", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/2902b1cd8fd7b5256bed18ba54c81b540231c473", "message": "Remove unused methods & variables in StepsUtil", "committedDate": "2020-06-26T08:44:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNjM0NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446116344", "bodyText": "Rename to parametersList", "author": "boyan-velinov", "createdAt": "2020-06-26T11:02:35Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java", "diffHunk": "@@ -240,22 +242,27 @@ protected ServiceKeysCloudModelBuilder getServiceKeysCloudModelBuilder(ProcessCo\n     private List<String> getDomainsFromApps(ProcessContext context, DeploymentDescriptor descriptor,\r\n                                             ApplicationCloudModelBuilder applicationCloudModelBuilder, List<? extends Module> modules,\r\n                                             ModuleToDeployHelper moduleToDeployHelper) {\r\n-        String defaultDomain = (String) descriptor.getParameters()\r\n-                                                  .get(SupportedParameters.DEFAULT_DOMAIN);\r\n-\r\n         Set<String> domains = new TreeSet<>();\r\n         for (Module module : modules) {\r\n             if (!moduleToDeployHelper.isApplication(module)) {\r\n                 continue;\r\n             }\r\n             ParametersChainBuilder parametersChainBuilder = new ParametersChainBuilder(context.getVariable(Variables.COMPLETE_DEPLOYMENT_DESCRIPTOR));\r\n-            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(parametersChainBuilder.buildModuleChain(module.getName()),\r\n-                                                                                         module);\r\n+            List<Map<String, Object>> paramsList = parametersChainBuilder.buildModuleChain(module.getName());\r", "originalCommit": "cda29cf27cc016d9b4889d6a2fb67748e7541d6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzAyOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446623029", "bodyText": "Done", "author": "radito3", "createdAt": "2020-06-28T08:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNjM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "1623bf28ae4aef8dd266106af1f167f9d55a57f2", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\nindex 86f374dca..4beeb6b5d 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudDeployModelStep.java\n\n@@ -248,14 +248,14 @@ public class BuildCloudDeployModelStep extends SyncFlowableStep {\n                 continue;\n             }\n             ParametersChainBuilder parametersChainBuilder = new ParametersChainBuilder(context.getVariable(Variables.COMPLETE_DEPLOYMENT_DESCRIPTOR));\n-            List<Map<String, Object>> paramsList = parametersChainBuilder.buildModuleChain(module.getName());\n+            List<Map<String, Object>> parametersList = parametersChainBuilder.buildModuleChain(module.getName());\n \n-            boolean noRoute = (Boolean) PropertiesUtil.getPropertyValue(paramsList, SupportedParameters.NO_ROUTE, false);\n+            boolean noRoute = (Boolean) PropertiesUtil.getPropertyValue(parametersList, SupportedParameters.NO_ROUTE, false);\n             if (!noRoute && context.getVariable(Variables.MISSING_DEFAULT_DOMAIN)) {\n                 throw new SLException(Messages.ERROR_MISSING_DEFAULT_DOMAIN);\n             }\n \n-            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(paramsList, module);\n+            List<String> appDomains = applicationCloudModelBuilder.getApplicationDomains(parametersList, module);\n             if (appDomains != null) {\n                 domains.addAll(appDomains);\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNzIyNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446117225", "bodyText": "What if CloudOPerationException is thrown for other reaseon?\nI think, we will consider that default domain is missing where there was a temporary issue with controller, for example.", "author": "boyan-velinov", "createdAt": "2020-06-26T11:04:48Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java", "diffHunk": "@@ -68,12 +70,14 @@ protected String getStepErrorMessage(ProcessContext context) {\n         return Messages.ERROR_COLLECTING_SYSTEM_PARAMETERS;\n     }\n \n-    private String getDefaultDomain(CloudControllerClient client) {\n-        CloudDomain defaultDomain = client.getDefaultDomain();\n-        if (defaultDomain != null) {\n-            return defaultDomain.getName();\n+    private String getDefaultDomain(CloudControllerClient client, ProcessContext context) {\n+        try {\n+            return client.getDefaultDomain()\n+                         .getName();\n+        } catch (CloudOperationException exc) {", "originalCommit": "cda29cf27cc016d9b4889d6a2fb67748e7541d6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjY0Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446622643", "bodyText": "For that to happen, the exception must be thrown 4 times. This is our retryable client, so if a timeout, or a network issue occurs, it will retry automatically. But for a missing default domain, it will always fail with this exception.", "author": "radito3", "createdAt": "2020-06-28T08:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyNzMyOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446827329", "bodyText": "I cannot fully agree with that because client is defined as CloudControllerClient, not as some special RetryableClient or anything else that have some logic.\nAlso CloudControllerClient does not declare throwing of such exception.\nSo if the retry failed all 4 times, what will happen. I guess we will continue silently with the DEFAULT_DOMAIN_PLACEHOLDER, right?", "author": "boyan-velinov", "createdAt": "2020-06-29T07:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNzIyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e27a377e9e91e7755c5ee74c4e5f77aee12c2c72", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\nindex 3009b860c..def4ad4ea 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CollectSystemParametersStep.java\n\n@@ -74,9 +75,12 @@ public class CollectSystemParametersStep extends SyncFlowableStep {\n         try {\n             return client.getDefaultDomain()\n                          .getName();\n-        } catch (CloudOperationException exc) {\n-            context.setVariable(Variables.MISSING_DEFAULT_DOMAIN, true);\n-            return DEFAULT_DOMAIN_PLACEHOLDER;\n+        } catch (CloudOperationException e) {\n+            if (e.getStatusCode() == HttpStatus.NOT_FOUND) {\n+                context.setVariable(Variables.MISSING_DEFAULT_DOMAIN, true);\n+                return DEFAULT_DOMAIN_PLACEHOLDER;\n+            }\n+            throw e;\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEyMDU4Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446120583", "bodyText": "Why this is replaced and formatting is changed?", "author": "boyan-velinov", "createdAt": "2020-06-26T11:12:36Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java", "diffHunk": "@@ -34,27 +35,26 @@ public void check(DeploymentDescriptor descriptor) {\n \n     private void checkForCommonParameters(NamedParametersContainer namedParametersContainer, Set<String> readOnlyParameters,\n                                           Map<String, Set<String>> commonReadOnlyParameters) {\n-        Set<String> commonParameters = Sets.intersection(namedParametersContainer.getParameters()\n-                                                                                 .keySet(),\n-                                                         readOnlyParameters);\n+        Set<String> commonParameters = SetUtils.intersection(namedParametersContainer.getParameters()", "originalCommit": "2902b1cd8fd7b5256bed18ba54c81b540231c473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzAxOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446623018", "bodyText": "Guava should only be kept as a transitive dependency, there is no need to use it when the Apache commons libraries have simpler implementations for some utility methods, like this one.", "author": "radito3", "createdAt": "2020-06-28T08:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEyMDU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyMzY4MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/883#discussion_r446823681", "bodyText": "Good!\nI missed that Sets is coming from guava", "author": "boyan-velinov", "createdAt": "2020-06-29T07:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEyMDU4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "1623bf28ae4aef8dd266106af1f167f9d55a57f2", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\nindex 2b25b96f4..65677f471 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ReadOnlyParametersChecker.java\n\n@@ -36,8 +36,7 @@ public class ReadOnlyParametersChecker {\n     private void checkForCommonParameters(NamedParametersContainer namedParametersContainer, Set<String> readOnlyParameters,\n                                           Map<String, Set<String>> commonReadOnlyParameters) {\n         Set<String> commonParameters = SetUtils.intersection(namedParametersContainer.getParameters()\n-                                                                                     .keySet(),\n-                                                             readOnlyParameters);\n+                                                                                     .keySet(), readOnlyParameters);\n         if (!commonParameters.isEmpty()) {\n             commonReadOnlyParameters.put(namedParametersContainer.getName(), commonParameters);\n         }\n"}}, {"oid": "1623bf28ae4aef8dd266106af1f167f9d55a57f2", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1623bf28ae4aef8dd266106af1f167f9d55a57f2", "message": "Remove unused methods & variables in StepsUtil", "committedDate": "2020-06-28T09:03:56Z", "type": "forcePushed"}, {"oid": "e27a377e9e91e7755c5ee74c4e5f77aee12c2c72", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e27a377e9e91e7755c5ee74c4e5f77aee12c2c72", "message": "Change retrival of default domain to not fail\n\nIssue: LMCROSSITXSADEPLOY-2007", "committedDate": "2020-06-29T11:26:46Z", "type": "commit"}, {"oid": "3841647520b6c99dd8b05228f741b2f0a77497b3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/3841647520b6c99dd8b05228f741b2f0a77497b3", "message": "Remove duplicate code in Host & Domain validators", "committedDate": "2020-06-29T11:26:46Z", "type": "commit"}, {"oid": "0ecc610eef71c38109d2e290dc5be6b1f0e66afa", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0ecc610eef71c38109d2e290dc5be6b1f0e66afa", "message": "Remove usage of Guava class & refactoring", "committedDate": "2020-06-29T11:26:46Z", "type": "commit"}, {"oid": "d596c919baffab3306609a3665c7e8edd9bcc601", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d596c919baffab3306609a3665c7e8edd9bcc601", "message": "Remove unneccessary NameUtil methods", "committedDate": "2020-06-29T11:26:46Z", "type": "commit"}, {"oid": "68b4d622b93441812b410236e0a8e34fdcc89cc3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/68b4d622b93441812b410236e0a8e34fdcc89cc3", "message": "Remove unused methods & variables in StepsUtil", "committedDate": "2020-06-29T11:26:46Z", "type": "commit"}, {"oid": "68b4d622b93441812b410236e0a8e34fdcc89cc3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/68b4d622b93441812b410236e0a8e34fdcc89cc3", "message": "Remove unused methods & variables in StepsUtil", "committedDate": "2020-06-29T11:26:46Z", "type": "forcePushed"}]}