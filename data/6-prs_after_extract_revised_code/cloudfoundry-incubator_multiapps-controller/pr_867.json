{"pr_number": 867, "pr_title": "Adjust names of hooks' phases", "pr_createdAt": "2020-05-28T10:37:27Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867", "timeline": [{"oid": "a60d18b831be760803fd0eea2887f55b6a1abe28", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/a60d18b831be760803fd0eea2887f55b6a1abe28", "message": "Adjust names of hooks' phases", "committedDate": "2020-05-28T10:49:06Z", "type": "forcePushed"}, {"oid": "19e852880763bc18ad607080653e06b7cfa83421", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/19e852880763bc18ad607080653e06b7cfa83421", "message": "Adjust names of hooks' phases", "committedDate": "2020-05-28T10:53:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg2NDgzNA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r431864834", "bodyText": "Add this to the abstract *WithHooks step", "author": "enchobelezirev", "createdAt": "2020-05-28T14:10:29Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/RestartAppStep.java", "diffHunk": "@@ -28,6 +29,8 @@\n \r\n     @Inject\r\n     protected RecentLogsRetriever recentLogsRetriever;\r\n+    @Inject\r\n+    private HooksPhaseBuilder hooksPhaseBuilder;\r", "originalCommit": "78911872acd2c91e82dbe3a9788588bdc34c1367", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd36759977453fe025fd01b64d910c4a3d061d2f", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/RestartAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/RestartAppStep.java\nindex 1eb56a148..9d6fe9b75 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/RestartAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/RestartAppStep.java\n\n@@ -29,8 +28,6 @@ public class RestartAppStep extends TimeoutAsyncFlowableStepWithHooks implements\n \n     @Inject\n     protected RecentLogsRetriever recentLogsRetriever;\n-    @Inject\n-    private HooksPhaseBuilder hooksPhaseBuilder;\n \n     @Override\n     public StepPhase executePollingStep(ProcessContext context) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg2ODA3MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r431868070", "bodyText": "I do not get why we need this.\nIf we need the blue_green phase, why not directly put it here - SubprocessPhase -> BlueGreenPhase\nand the corresponding phases will be IDLE/LIVE", "author": "enchobelezirev", "createdAt": "2020-05-28T14:15:05Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/SubprocessPhase.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.sap.cloud.lm.sl.cf.core.model;\n+\n+public enum SubprocessPhase {", "originalCommit": "19e852880763bc18ad607080653e06b7cfa83421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg2ODg5Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r431868896", "bodyText": "Or can we use only the Phase.AFTER_RESUME in order to determine whether we are in IDLE or LIVE phases?", "author": "enchobelezirev", "createdAt": "2020-05-28T14:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg2ODA3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NTIxMw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r431875213", "bodyText": "I would extract the whole logic as follows - as we are having hook phases which consists of the following parts ... we could extract this logic in different methods or inner classes and the whole method would look like this:\npublic String buildHookPhase(HookPhase hookPhase){\n     String getDeploymentType = getDeploymentType(); // perform some validation whether the current deployment                                                                                                                                                      type is deploy or blue-green\n     String optionalPhaseLocator = getOptionalPhaseLocator(); // here the check whether the context.getVariable(Variables.PHASE) != Phase.AFTER_RESUME should be made\n     return getDeploymentType + \".\" + DEFAULT_HOOK_ENTITY + \".\" + hookPhase.getValue() + \".\" + optionalPhaseLocator // if presented, else it should be omitted.\n\n}", "author": "enchobelezirev", "createdAt": "2020-05-28T14:24:44Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.sap.cloud.lm.sl.cf.process.util;\n+\n+import com.sap.cloud.lm.sl.cf.core.model.HookPhase;\n+import com.sap.cloud.lm.sl.cf.core.model.HookPhaseProcessType;\n+import com.sap.cloud.lm.sl.cf.core.model.HookProcessPhase;\n+import com.sap.cloud.lm.sl.cf.core.model.Phase;\n+import com.sap.cloud.lm.sl.cf.core.model.SubprocessPhase;\n+import com.sap.cloud.lm.sl.cf.process.steps.ProcessContext;\n+import com.sap.cloud.lm.sl.cf.process.variables.Variables;\n+import com.sap.cloud.lm.sl.cf.web.api.model.ProcessType;\n+\n+public class HooksPhaseBuilder {\n+\n+    private static final String HOOKS_DELIMITER = \".\";\n+    private final ProcessTypeParser processTypeParser;\n+    private final ProcessContext context;\n+\n+    public HooksPhaseBuilder(ProcessTypeParser processTypeParser, ProcessContext context) {\n+        this.processTypeParser = processTypeParser;\n+        this.context = context;\n+    }\n+\n+    public String buildHookPhase(HookPhase hookPhase) {", "originalCommit": "19e852880763bc18ad607080653e06b7cfa83421", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd36759977453fe025fd01b64d910c4a3d061d2f", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\nindex 8d398db94..6f2daac6b 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\n\n@@ -1,5 +1,11 @@\n package com.sap.cloud.lm.sl.cf.process.util;\n \n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n import com.sap.cloud.lm.sl.cf.core.model.HookPhase;\n import com.sap.cloud.lm.sl.cf.core.model.HookPhaseProcessType;\n import com.sap.cloud.lm.sl.cf.core.model.HookProcessPhase;\n"}}, {"oid": "cd36759977453fe025fd01b64d910c4a3d061d2f", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/cd36759977453fe025fd01b64d910c4a3d061d2f", "message": "Adjust names of hooks' phases", "committedDate": "2020-05-28T15:07:25Z", "type": "forcePushed"}, {"oid": "98d98fdc93c91c4517c83095b8f968695ed46140", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/98d98fdc93c91c4517c83095b8f968695ed46140", "message": "Adjust names of hooks' phases", "committedDate": "2020-05-29T10:34:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQzODAxMw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r432438013", "bodyText": "can replace this with Function.identity()", "author": "ikasarov", "createdAt": "2020-05-29T12:04:54Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/HookPhase.java", "diffHunk": "@@ -6,26 +6,33 @@\n import java.util.stream.Collectors;\n \n public enum HookPhase {\n-    APPLICATION_BEFORE_STOP_LIVE(\"application.before-stop.live\"),\n-    APPLICATION_BEFORE_STOP_IDLE(\"application.before-stop.idle\"),\n-    APPLICATION_AFTER_STOP_LIVE(\"application.after-stop.live\"),\n-    APPLICATION_AFTER_STOP_IDLE(\"application.after-stop.idle\"),\n-    APPLICATION_BEFORE_UNMAP_ROUTES(\"application.before-unmap-routes\"),\n-    APPLICATION_BEFORE_START_IDLE(\"application.before-start.idle\"),\n-    APPLICATION_BEFORE_START_LIVE(\"application.before-start.live\"),\n-    APPLICATION_BEFORE_START(\"application.before-start\"),\n+    BEFORE_STOP(\"before-stop\"),\n+    DEPLOY_APPLICATION_BEFORE_STOP(\"deploy.application.before-stop\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_STOP_IDLE(\"blue-green.application.before-stop.idle\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_STOP_LIVE(\"blue-green.application.before-stop.live\"),\n+    AFTER_STOP(\"after-stop\"),\n+    DEPLOY_APPLICATION_AFTER_STOP(\"deploy.application.after-stop\"),\n+    BLUE_GREEN_APPLICATION_AFTER_STOP_IDLE(\"blue-green.application.after-stop.idle\"),\n+    BLUE_GREEN_APPLICATION_AFTER_STOP_LIVE(\"blue-green.application.after-stop.live\"),\n+    BEFORE_UNMAP_ROUTES(\"before-unmap-routes\"),\n+    DEPLOY_APPLICATION_BEFORE_UNMAP_ROUTES(\"deploy.application.before-unmap-routes\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_UNMAP_ROUTES_LIVE(\"blue-green.application.before-unmap-routes.live\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_UNMAP_ROUTES_IDLE(\"blue-green.application.before-unmap-routes.idle\"),\n+    BEFORE_START(\"before-start\"),\n+    DEPLOY_APPLICATION_BEFORE_START(\"deploy.application.before-start\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_START_IDLE(\"blue-green.application.before-start.idle\"),\n+    BLUE_GREEN_APPLICATION_BEFORE_START_LIVE(\"blue-green.application.before-start.live\"),\n     NONE(\"\");\n \n+    private static Map<String, HookPhase> namesToValues = Arrays.stream(HookPhase.values())\n+                                                                .collect(Collectors.toMap(hookPhase -> hookPhase.value,\n+                                                                                          hookPhase -> hookPhase));", "originalCommit": "98d98fdc93c91c4517c83095b8f968695ed46140", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "95f9c849a8e614a380e95b893a93530c6b5733fd", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/HookPhase.java b/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/HookPhase.java\nindex 3f903d8c6..91e32db65 100644\n--- a/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/HookPhase.java\n+++ b/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/HookPhase.java\n\n@@ -2,10 +2,25 @@ package com.sap.cloud.lm.sl.cf.core.model;\n \n import java.text.MessageFormat;\n import java.util.Arrays;\n+import java.util.List;\n import java.util.Map;\n+import java.util.function.Function;\n import java.util.stream.Collectors;\n \n public enum HookPhase {\n+    \n+    @Deprecated\n+    APPLICATION_BEFORE_STOP_LIVE(\"application.before-stop.live\"),\n+    @Deprecated\n+    APPLICATION_BEFORE_STOP_IDLE(\"application.before-stop.idle\"),\n+    @Deprecated\n+    APPLICATION_AFTER_STOP_LIVE(\"application.after-stop.live\"),\n+    @Deprecated\n+    APPLICATION_AFTER_STOP_IDLE(\"application.after-stop.idle\"),\n+    @Deprecated\n+    APPLICATION_BEFORE_UNMAP_ROUTES(\"application.before-unmap-routes\"),\n+\n+\n     BEFORE_STOP(\"before-stop\"),\n     DEPLOY_APPLICATION_BEFORE_STOP(\"deploy.application.before-stop\"),\n     BLUE_GREEN_APPLICATION_BEFORE_STOP_IDLE(\"blue-green.application.before-stop.idle\"),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ0OTM2NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r432449365", "bodyText": "why is this saved in the executedHooks but not used for anything?", "author": "ikasarov", "createdAt": "2020-05-29T12:27:56Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/SyncFlowableStepWithHooks.java", "diffHunk": "@@ -25,20 +26,21 @@\n     @Inject\n     private HooksPhaseGetter hooksPhaseGetter;\n     @Inject\n-    private HooksExecutor hooksExecutor;\n+    protected HooksPhaseBuilder hooksPhaseBuilder;\n \n     @Override\n     protected StepPhase executeStep(ProcessContext context) {\n         ModuleDeterminer moduleDeterminer = getModuleDeterminer(context);\n         StepPhase currentStepPhase = context.getVariable(Variables.STEP_PHASE);\n         Module moduleToDeploy = moduleDeterminer.determineModuleToDeploy(context);\n         HooksCalculator hooksCalculator = getHooksCalculator(context);\n-        List<Hook> executedHooks = hooksExecutor.executeBeforeStepHooks(hooksCalculator, moduleToDeploy, currentStepPhase);\n+        HooksExecutor hooksExecutor = getHooksExecutor(hooksCalculator, moduleToDeploy);\n+        List<Hook> executedHooks = hooksExecutor.executeBeforeStepHooks(currentStepPhase);", "originalCommit": "98d98fdc93c91c4517c83095b8f968695ed46140", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ2NjM1NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r432466355", "bodyText": "wouldn't it make a bit more sense to have this code in the enum for the HookPhase itself?", "author": "ikasarov", "createdAt": "2020-05-29T13:01:11Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.sap.cloud.lm.sl.cf.process.util;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.sap.cloud.lm.sl.cf.core.model.HookPhase;\n+import com.sap.cloud.lm.sl.cf.core.model.HookPhaseProcessType;\n+import com.sap.cloud.lm.sl.cf.core.model.HookProcessPhase;\n+import com.sap.cloud.lm.sl.cf.core.model.Phase;\n+import com.sap.cloud.lm.sl.cf.core.model.SubprocessPhase;\n+import com.sap.cloud.lm.sl.cf.process.steps.ProcessContext;\n+import com.sap.cloud.lm.sl.cf.process.variables.Variables;\n+import com.sap.cloud.lm.sl.cf.web.api.model.ProcessType;\n+\n+@Named\n+public class HooksPhaseBuilder {\n+\n+    private static final String HOOKS_DELIMITER = \".\";\n+    private static final String DEFAULT_HOOK_ENTITY = \"application\";\n+    private final ProcessTypeParser processTypeParser;\n+\n+    @Inject\n+    public HooksPhaseBuilder(ProcessTypeParser processTypeParser) {\n+        this.processTypeParser = processTypeParser;\n+    }\n+\n+    public List<HookPhase> buildHookPhases(List<HookPhase> hookPhases, ProcessContext context) {\n+        return hookPhases.stream()\n+                         .map(hookPhase -> buildPhase(hookPhase, context))\n+                         .map(HookPhase::fromString)\n+                         .collect(Collectors.toList());\n+    }\n+\n+    private String buildPhase(HookPhase hookPhase, ProcessContext context) {", "originalCommit": "98d98fdc93c91c4517c83095b8f968695ed46140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ2ODE3Ng==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r432468176", "bodyText": "for example: HOOKS_DELIMITER is something already used in the enum, as well as the enum has a method to get a value from 1 string, why not add a method to get a value from all the needed strings (deploymentType, phase, phaseLocator)", "author": "ikasarov", "createdAt": "2020-05-29T13:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ2NjM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "95f9c849a8e614a380e95b893a93530c6b5733fd", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\nindex 16fb37846..d99e982f9 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/HooksPhaseBuilder.java\n\n@@ -35,6 +35,9 @@ public class HooksPhaseBuilder {\n     }\n \n     private String buildPhase(HookPhase hookPhase, ProcessContext context) {\n+        if (HookPhase.getOldPhases().contains(hookPhase)) {\n+            return hookPhase.getValue();\n+        }\n         String deploymentType = getDeploymentType(context);\n         String fullHookPhase = deploymentType + HOOKS_DELIMITER + DEFAULT_HOOK_ENTITY + HOOKS_DELIMITER + hookPhase.getValue();\n         String optionalPhaseLocator = getOptionalPhaseLocator(context);\n"}}, {"oid": "95f9c849a8e614a380e95b893a93530c6b5733fd", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/95f9c849a8e614a380e95b893a93530c6b5733fd", "message": "Support for old phases", "committedDate": "2020-06-01T07:26:00Z", "type": "forcePushed"}, {"oid": "8366ba55439f634eedf1ef18f2d6dad51b63d388", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/8366ba55439f634eedf1ef18f2d6dad51b63d388", "message": "Support for old phases", "committedDate": "2020-06-01T08:33:29Z", "type": "forcePushed"}, {"oid": "eae61914f7ef8e5a7f2140231e1f9d031995e547", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/eae61914f7ef8e5a7f2140231e1f9d031995e547", "message": "Support for old phases", "committedDate": "2020-06-01T08:41:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0OTk5OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r433149999", "bodyText": "Try extracting the whole block of code into another method and try to re-use it below, in the method getHookPhasesAfterStep, because it seems like a copy-pasted below?", "author": "enchobelezirev", "createdAt": "2020-06-01T10:09:54Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StopAppStep.java", "diffHunk": "@@ -58,12 +59,28 @@ protected String getStepErrorMessage(ProcessContext context) {\n \r\n     @Override\r\n     public List<HookPhase> getHookPhasesBeforeStep(ProcessContext context) {\r\n-        return hooksPhaseBuilder.buildHookPhases(Collections.singletonList(HookPhase.BEFORE_STOP), context);\r\n+        List<HookPhase> hookPhases = new ArrayList<>();\r\n+        hookPhases.add(HookPhase.BEFORE_STOP);\r\n+        ProcessType processType = processTypeParser.getProcessType(context.getExecution());\r\n+        if (ProcessType.BLUE_GREEN_DEPLOY.equals(processType)) {\r\n+            hookPhases.add(HookPhase.APPLICATION_BEFORE_STOP_IDLE);\r\n+        } else {\r\n+            hookPhases.add(HookPhase.APPLICATION_BEFORE_STOP_LIVE);\r\n+        }\r\n+        return hooksPhaseBuilder.buildHookPhases(hookPhases, context);\r", "originalCommit": "eae61914f7ef8e5a7f2140231e1f9d031995e547", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StopAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StopAppStep.java\nindex 9531d5823..003230a55 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StopAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StopAppStep.java\n\n@@ -59,28 +59,27 @@ public class StopAppStep extends SyncFlowableStepWithHooks implements BeforeStep\n \n     @Override\n     public List<HookPhase> getHookPhasesBeforeStep(ProcessContext context) {\n-        List<HookPhase> hookPhases = new ArrayList<>();\n+        List<HookPhase> hookPhases = getHookPhases(HookPhase.APPLICATION_BEFORE_STOP_IDLE, HookPhase.APPLICATION_BEFORE_STOP_LIVE, context);\n         hookPhases.add(HookPhase.BEFORE_STOP);\n-        ProcessType processType = processTypeParser.getProcessType(context.getExecution());\n-        if (ProcessType.BLUE_GREEN_DEPLOY.equals(processType)) {\n-            hookPhases.add(HookPhase.APPLICATION_BEFORE_STOP_IDLE);\n-        } else {\n-            hookPhases.add(HookPhase.APPLICATION_BEFORE_STOP_LIVE);\n-        }\n         return hooksPhaseBuilder.buildHookPhases(hookPhases, context);\n     }\n \n     @Override\n     public List<HookPhase> getHookPhasesAfterStep(ProcessContext context) {\n-        List<HookPhase> hookPhases = new ArrayList<>();\n+        List<HookPhase> hookPhases = getHookPhases(HookPhase.APPLICATION_AFTER_STOP_IDLE, HookPhase.APPLICATION_AFTER_STOP_LIVE, context);\n         hookPhases.add(HookPhase.AFTER_STOP);\n+        return hooksPhaseBuilder.buildHookPhases(hookPhases, context);\n+    }\n+\n+    private List<HookPhase> getHookPhases(HookPhase beforeStepHookPhase, HookPhase afterStepHookPhase, ProcessContext context) {\n+        List<HookPhase> hookPhases = new ArrayList<>();\n         ProcessType processType = processTypeParser.getProcessType(context.getExecution());\n         if (ProcessType.BLUE_GREEN_DEPLOY.equals(processType)) {\n-            hookPhases.add(HookPhase.APPLICATION_AFTER_STOP_IDLE);\n+            hookPhases.add(beforeStepHookPhase);\n         } else {\n-            hookPhases.add(HookPhase.APPLICATION_AFTER_STOP_LIVE);\n+            hookPhases.add(afterStepHookPhase);\n         }\n-        return hooksPhaseBuilder.buildHookPhases(hookPhases, context);\n+        return hookPhases;\n     }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1MjI1MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r433152251", "bodyText": "rename to containsOldPhase", "author": "enchobelezirev", "createdAt": "2020-06-01T10:15:17Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java", "diffHunk": "@@ -82,7 +82,26 @@ private boolean shouldExecuteHook(Map<String, List<String>> alreadyExecutedHooks\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));\n+    }\n+\n+    @Deprecated\n+    private List<HookPhase> getHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n+        boolean isThereOldPhase = hookToBeExecuted.getPhases()", "originalCommit": "eae61914f7ef8e5a7f2140231e1f9d031995e547", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\nindex 6a1058712..5c0425cc1 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n\n@@ -82,26 +82,32 @@ public class ModuleHooksAggregator {\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));\n+        List<HookPhase> modifiedHookPhasesForHook = getModifiedHookPhasesForCurrentStepPhase(hookToBeExecuted,\n+                                                                                             hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(modifiedHookPhasesForHook);\n     }\n \n     @Deprecated\n-    private List<HookPhase> getHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n-        boolean isThereOldPhase = hookToBeExecuted.getPhases()\n-                                                  .stream()\n-                                                  .anyMatch(hookPhase -> HookPhase.getOldPhases()\n-                                                                                  .contains(HookPhase.fromString(hookPhase)));\n-        if (isThereOldPhase) {\n+    private List<HookPhase> getModifiedHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n+        if (doesHookContainOldPhases(hookToBeExecuted)) {\n             return hookPhasesForCurrentStepPhase.stream()\n-                                                .filter(hookPhase -> HookPhase.getOldPhases()\n-                                                                              .contains(hookPhase))\n+                                                .filter(this::containsOldPhase)\n                                                 .collect(Collectors.toList());\n         }\n         return hookPhasesForCurrentStepPhase.stream()\n-                                            .filter(hookPhase -> !HookPhase.getOldPhases()\n-                                                                           .contains(hookPhase))\n+                                            .filter(hookPhase -> !containsOldPhase(hookPhase))\n                                             .collect(Collectors.toList());\n+    }\n+\n+    private boolean doesHookContainOldPhases(Hook hookToBeExecuted) {\n+        return hookToBeExecuted.getPhases()\n+                               .stream()\n+                               .anyMatch(hookPhase -> containsOldPhase(HookPhase.fromString(hookPhase)));\n+    }\n \n+    private boolean containsOldPhase(HookPhase hookPhase) {\n+        return HookPhase.getOldPhases()\n+                        .contains(hookPhase);\n     }\n \n     private List<HookPhase> getExecutedHookPhasesForHook(Map<String, List<String>> alreadyExecutedHooks, String hookName) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1Mjc2OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r433152769", "bodyText": "extract this getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase) to a variable", "author": "enchobelezirev", "createdAt": "2020-06-01T10:16:41Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java", "diffHunk": "@@ -82,7 +82,26 @@ private boolean shouldExecuteHook(Map<String, List<String>> alreadyExecutedHooks\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));", "originalCommit": "eae61914f7ef8e5a7f2140231e1f9d031995e547", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\nindex 6a1058712..5c0425cc1 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n\n@@ -82,26 +82,32 @@ public class ModuleHooksAggregator {\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));\n+        List<HookPhase> modifiedHookPhasesForHook = getModifiedHookPhasesForCurrentStepPhase(hookToBeExecuted,\n+                                                                                             hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(modifiedHookPhasesForHook);\n     }\n \n     @Deprecated\n-    private List<HookPhase> getHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n-        boolean isThereOldPhase = hookToBeExecuted.getPhases()\n-                                                  .stream()\n-                                                  .anyMatch(hookPhase -> HookPhase.getOldPhases()\n-                                                                                  .contains(HookPhase.fromString(hookPhase)));\n-        if (isThereOldPhase) {\n+    private List<HookPhase> getModifiedHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n+        if (doesHookContainOldPhases(hookToBeExecuted)) {\n             return hookPhasesForCurrentStepPhase.stream()\n-                                                .filter(hookPhase -> HookPhase.getOldPhases()\n-                                                                              .contains(hookPhase))\n+                                                .filter(this::containsOldPhase)\n                                                 .collect(Collectors.toList());\n         }\n         return hookPhasesForCurrentStepPhase.stream()\n-                                            .filter(hookPhase -> !HookPhase.getOldPhases()\n-                                                                           .contains(hookPhase))\n+                                            .filter(hookPhase -> !containsOldPhase(hookPhase))\n                                             .collect(Collectors.toList());\n+    }\n+\n+    private boolean doesHookContainOldPhases(Hook hookToBeExecuted) {\n+        return hookToBeExecuted.getPhases()\n+                               .stream()\n+                               .anyMatch(hookPhase -> containsOldPhase(HookPhase.fromString(hookPhase)));\n+    }\n \n+    private boolean containsOldPhase(HookPhase hookPhase) {\n+        return HookPhase.getOldPhases()\n+                        .contains(hookPhase);\n     }\n \n     private List<HookPhase> getExecutedHookPhasesForHook(Map<String, List<String>> alreadyExecutedHooks, String hookName) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1MzAyMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/867#discussion_r433153021", "bodyText": "Extract HookPhase.getOldPhases() .contains(hookPhase) into method and re-use it below", "author": "enchobelezirev", "createdAt": "2020-06-01T10:17:20Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java", "diffHunk": "@@ -82,7 +82,26 @@ private boolean shouldExecuteHook(Map<String, List<String>> alreadyExecutedHooks\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));\n+    }\n+\n+    @Deprecated\n+    private List<HookPhase> getHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n+        boolean isThereOldPhase = hookToBeExecuted.getPhases()\n+                                                  .stream()\n+                                                  .anyMatch(hookPhase -> HookPhase.getOldPhases()\n+                                                                                  .contains(HookPhase.fromString(hookPhase)));\n+        if (isThereOldPhase) {\n+            return hookPhasesForCurrentStepPhase.stream()\n+                                                .filter(hookPhase -> HookPhase.getOldPhases()", "originalCommit": "eae61914f7ef8e5a7f2140231e1f9d031995e547", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\nindex 6a1058712..5c0425cc1 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ModuleHooksAggregator.java\n\n@@ -82,26 +82,32 @@ public class ModuleHooksAggregator {\n     private boolean hasAllPhasesExecuted(Map<String, List<String>> alreadyExecutedHooks, Hook hookToBeExecuted,\n                                          List<HookPhase> hookPhasesForCurrentStepPhase) {\n         List<HookPhase> executedHookPhasesForHook = getExecutedHookPhasesForHook(alreadyExecutedHooks, hookToBeExecuted.getName());\n-        return executedHookPhasesForHook.containsAll(getHookPhasesForCurrentStepPhase(hookToBeExecuted, hookPhasesForCurrentStepPhase));\n+        List<HookPhase> modifiedHookPhasesForHook = getModifiedHookPhasesForCurrentStepPhase(hookToBeExecuted,\n+                                                                                             hookPhasesForCurrentStepPhase);\n+        return executedHookPhasesForHook.containsAll(modifiedHookPhasesForHook);\n     }\n \n     @Deprecated\n-    private List<HookPhase> getHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n-        boolean isThereOldPhase = hookToBeExecuted.getPhases()\n-                                                  .stream()\n-                                                  .anyMatch(hookPhase -> HookPhase.getOldPhases()\n-                                                                                  .contains(HookPhase.fromString(hookPhase)));\n-        if (isThereOldPhase) {\n+    private List<HookPhase> getModifiedHookPhasesForCurrentStepPhase(Hook hookToBeExecuted, List<HookPhase> hookPhasesForCurrentStepPhase) {\n+        if (doesHookContainOldPhases(hookToBeExecuted)) {\n             return hookPhasesForCurrentStepPhase.stream()\n-                                                .filter(hookPhase -> HookPhase.getOldPhases()\n-                                                                              .contains(hookPhase))\n+                                                .filter(this::containsOldPhase)\n                                                 .collect(Collectors.toList());\n         }\n         return hookPhasesForCurrentStepPhase.stream()\n-                                            .filter(hookPhase -> !HookPhase.getOldPhases()\n-                                                                           .contains(hookPhase))\n+                                            .filter(hookPhase -> !containsOldPhase(hookPhase))\n                                             .collect(Collectors.toList());\n+    }\n+\n+    private boolean doesHookContainOldPhases(Hook hookToBeExecuted) {\n+        return hookToBeExecuted.getPhases()\n+                               .stream()\n+                               .anyMatch(hookPhase -> containsOldPhase(HookPhase.fromString(hookPhase)));\n+    }\n \n+    private boolean containsOldPhase(HookPhase hookPhase) {\n+        return HookPhase.getOldPhases()\n+                        .contains(hookPhase);\n     }\n \n     private List<HookPhase> getExecutedHookPhasesForHook(Map<String, List<String>> alreadyExecutedHooks, String hookName) {\n"}}, {"oid": "bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/bafd28a2a9ab045a08ff29d250ae1ad50a820c6e", "message": "Support for old phases", "committedDate": "2020-06-01T10:41:13Z", "type": "forcePushed"}, {"oid": "805c1ebd4c246b8f669beccfd2a254aea9a92bd5", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/805c1ebd4c246b8f669beccfd2a254aea9a92bd5", "message": "Support for old phases", "committedDate": "2020-06-01T11:27:50Z", "type": "forcePushed"}, {"oid": "c8397f19e2ade37fe95266b851c0d7bb9bbc2e78", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/c8397f19e2ade37fe95266b851c0d7bb9bbc2e78", "message": "Adjust names of hooks' phases", "committedDate": "2020-06-01T12:08:00Z", "type": "forcePushed"}, {"oid": "00d7548ab95249272d9cb7614a7f41989be19245", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/00d7548ab95249272d9cb7614a7f41989be19245", "message": "Adjust names of hooks' phases", "committedDate": "2020-06-01T12:54:39Z", "type": "commit"}, {"oid": "c1fc9d482dfe0aa8c2f866c7c1243f01adce7b20", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/c1fc9d482dfe0aa8c2f866c7c1243f01adce7b20", "message": "Support for old phases", "committedDate": "2020-06-01T12:54:41Z", "type": "commit"}, {"oid": "c1fc9d482dfe0aa8c2f866c7c1243f01adce7b20", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/c1fc9d482dfe0aa8c2f866c7c1243f01adce7b20", "message": "Support for old phases", "committedDate": "2020-06-01T12:54:41Z", "type": "forcePushed"}]}