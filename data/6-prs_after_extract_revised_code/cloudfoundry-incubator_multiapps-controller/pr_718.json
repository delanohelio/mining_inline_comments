{"pr_number": 718, "pr_title": "Build tree to get all leaf nodes to abort process", "pr_createdAt": "2020-01-07T08:47:57Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMTYwNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363701605", "bodyText": "For me an you leaf is an understandable word but not for the rest of the team.\nMaybe renaming it to child processes or subProcessLeafs would be better.", "author": "enchobelezirev", "createdAt": "2020-01-07T11:15:19Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -113,6 +113,11 @@ public boolean hasDeadLetterJobs(String processId) {\n         return !getDeadLetterJobs(processId).isEmpty();\n     }\n \n+    private boolean haveAllLeafsHaveDeadLetterJobs(List<Execution> executions) {", "originalCommit": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5OTkyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r364199926", "bodyText": "Done", "author": "boyan-velinov", "createdAt": "2020-01-08T12:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMTYwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\nindex edf0ea2fc..6fb3c74f2 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n\n@@ -113,7 +114,7 @@ public class FlowableFacade {\n         return !getDeadLetterJobs(processId).isEmpty();\n     }\n \n-    private boolean haveAllLeafsHaveDeadLetterJobs(List<Execution> executions) {\n+    private boolean allExecutionsHaveDeadLetterJobs(List<Execution> executions) {\n         return executions.stream()\n                          .allMatch(e -> !getDeadLetterJobsForExecution(e).isEmpty());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMzk5OQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363703999", "bodyText": "This is a lot complexity: O(n^2).\nCould we revert the things like this:\n\nFind the execution which is related to the processInstanceId\nFind each executions which have parentId = processInstaceId || superExecutionId = processInstanceId\nDo 1 and 2, recursively for each execution foud in the step 2\nWould this work?\nThis way we would lower the complexity to O(nlogn)", "author": "enchobelezirev", "createdAt": "2020-01-07T11:22:23Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -268,6 +280,25 @@ public boolean isProcessInstanceAtReceiveTask(String processInstanceId) {\n                                    .collect(Collectors.toList());\n     }\n \n+    private List<Execution> getAllLeafExecutions(String processInstanceId) {\n+        List<Execution> allExecutions = getAllProcessExecutions(processInstanceId);\n+        return allExecutions.stream()", "originalCommit": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIwMDcxNA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r364200714", "bodyText": "About the complexity I do agree.\nHowever, I am not sure if it worths to have recursion here in order to optimize a little bit when the code will not look nicer.", "author": "boyan-velinov", "createdAt": "2020-01-08T12:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMzk5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\nindex edf0ea2fc..6fb3c74f2 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n\n@@ -280,7 +283,7 @@ public class FlowableFacade {\n                                    .collect(Collectors.toList());\n     }\n \n-    private List<Execution> getAllLeafExecutions(String processInstanceId) {\n+    private List<Execution> getAllSubprocessExecutionsWithoutChildren(String processInstanceId) {\n         List<Execution> allExecutions = getAllProcessExecutions(processInstanceId);\n         return allExecutions.stream()\n                             .filter(execution -> isNotParent(allExecutions, execution))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwNDMzNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363704335", "bodyText": "What if there is a bug in the code? We would stay in the loop forever.\nMaybe giving it some time would be enough in order the executions to finish. For instance, 10 mins MAX or more?", "author": "enchobelezirev", "createdAt": "2020-01-07T11:23:21Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -230,6 +235,13 @@ public void deleteProcessInstance(String processInstanceId, String deleteReason)\n                 // different if the process has parallel executions.\n                 processEngine.getRuntimeService()\n                              .setVariable(processInstanceId, Constants.PROCESS_ABORTED, Boolean.TRUE);\n+                while (true) {\n+                    List<Execution> allLeafExecutions = getAllLeafExecutions(processInstanceId);\n+\n+                    if (haveAllLeafsHaveDeadLetterJobs(allLeafExecutions)) {\n+                        break;\n+                    }", "originalCommit": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIwMDAyNg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r364200026", "bodyText": "Thanks for the idea!\nDone", "author": "boyan-velinov", "createdAt": "2020-01-08T12:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwNDMzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\nindex edf0ea2fc..6fb3c74f2 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java\n\n@@ -235,10 +236,12 @@ public class FlowableFacade {\n                 // different if the process has parallel executions.\n                 processEngine.getRuntimeService()\n                              .setVariable(processInstanceId, Constants.PROCESS_ABORTED, Boolean.TRUE);\n+                long allSubprocessesFinishedDeadline = System.currentTimeMillis() + DEFAULT_ABORT_WAIT_TIMEOUT_MS;\n                 while (true) {\n-                    List<Execution> allLeafExecutions = getAllLeafExecutions(processInstanceId);\n+                    List<Execution> subprocessExecutionsWithoutChildren = getAllSubprocessExecutionsWithoutChildren(processInstanceId);\n \n-                    if (haveAllLeafsHaveDeadLetterJobs(allLeafExecutions)) {\n+                    if (allExecutionsHaveDeadLetterJobs(subprocessExecutionsWithoutChildren)\n+                        || isPastDeadline(allSubprocessesFinishedDeadline)) {\n                         break;\n                     }\n                 }\n"}}, {"oid": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761", "committedDate": "2020-01-08T12:08:38Z", "type": "forcePushed"}, {"oid": "be2257b81c31606fcf15ad0a831a2283452123a1", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be2257b81c31606fcf15ad0a831a2283452123a1", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761", "committedDate": "2020-01-08T15:20:24Z", "type": "commit"}, {"oid": "be2257b81c31606fcf15ad0a831a2283452123a1", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be2257b81c31606fcf15ad0a831a2283452123a1", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761", "committedDate": "2020-01-08T15:20:24Z", "type": "forcePushed"}]}