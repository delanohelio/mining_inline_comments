{"pr_number": 757, "pr_title": "[Metadata] Several bugfixes", "pr_createdAt": "2020-02-12T14:19:24Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757", "timeline": [{"oid": "4560351493559c885dffcaaf687f906e38091246", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/4560351493559c885dffcaaf687f906e38091246", "message": "[Metadata] Detach service from MTA when undeploying without --delete-services\n\nWhen someone undeploys an MTA WITHOUT using the --delete-services CLI option, the mta\nmetadata must be removed from the service in order to avoid future\ndetection of the same MTA.\nCurrently, it uses a workaround by setting empty (\"\") mta_id in\nservices' metadata because the cf-java-client has a bug which does not\nallow deleting metadata labels/annotations.", "committedDate": "2020-02-12T14:31:24Z", "type": "forcePushed"}, {"oid": "1041c8df650c399a91a55a8d127d9d21f2e6d279", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1041c8df650c399a91a55a8d127d9d21f2e6d279", "message": "[Metadata] Detach service from MTA when --delete-services not used\n\nWhen someone undeploys an MTA WITHOUT using the --delete-services CLI option, the mta\nmetadata must be removed from the service in order to avoid future\ndetection of the same MTA.\nCurrently, it uses a workaround by setting empty (\"\") mta_id in\nservices' metadata because the cf-java-client has a bug which does not\nallow deleting metadata labels/annotations.", "committedDate": "2020-02-12T14:31:43Z", "type": "forcePushed"}, {"oid": "d1b2001396a499a5a1d088f8dbb2e9fa63034571", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d1b2001396a499a5a1d088f8dbb2e9fa63034571", "message": "[Metadata] Ensure services part of new MTA are not marked as discontinued\n\nHaving Environment metadata, if a service had no bound applications,\nthere was no way to determine if that service is part of the MTA as the\nservice itself does not have environment. With the v3 Metadata, the\nservice has its own metadata, therefore we can now determine if the\nservice is part of the MTA or not. This is an enhancement which fixes an\nold issue where using --delete-services on orphaned services would\ndelete them because of the mentioned detection above.", "committedDate": "2020-02-12T19:08:09Z", "type": "forcePushed"}, {"oid": "f99b6ec09f471a26962a2f4ac607f74368dc6cfe", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/f99b6ec09f471a26962a2f4ac607f74368dc6cfe", "message": "[Metadata] Ensure services part of new MTA are not marked as discontinued\n\nHaving Environment metadata, if a service had no bound applications,\nthere was no way to determine if that service is part of the MTA as the\nservice itself does not have environment. With the v3 Metadata, the\nservice has its own metadata, therefore we can now determine if the\nservice is part of the MTA or not. This is an enhancement which fixes an\nold issue where using --delete-services on orphaned services would\ndelete them because of the mentioned detection above.", "committedDate": "2020-02-12T19:23:48Z", "type": "forcePushed"}, {"oid": "b219be6e4761b85d7699cde13c1d4d4fc5430a76", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/b219be6e4761b85d7699cde13c1d4d4fc5430a76", "message": "[Metadata] Ensure services part of new MTA are not marked as discontinued\n\nHaving Environment metadata, if a service had no bound applications,\nthere was no way to determine if that service is part of the MTA as the\nservice itself does not have environment. With the v3 Metadata, the\nservice has its own metadata, therefore we can now determine if the\nservice is part of the MTA or not. This is an enhancement which fixes an\nold issue where using --delete-services on orphaned services would\ndelete them because of the mentioned detection above.", "committedDate": "2020-02-12T19:26:12Z", "type": "forcePushed"}, {"oid": "d69622fea731ddab8ee8fc9847feafb8cf4c42c2", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/d69622fea731ddab8ee8fc9847feafb8cf4c42c2", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-12T20:37:27Z", "type": "forcePushed"}, {"oid": "3d2d6d6c36128e71b95f0f29e43a5e5943bbbe4b", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/3d2d6d6c36128e71b95f0f29e43a5e5943bbbe4b", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-12T21:10:26Z", "type": "forcePushed"}, {"oid": "e07f7aeff4f4a1d16fead347cf8b89ec9538700b", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/e07f7aeff4f4a1d16fead347cf8b89ec9538700b", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:38:07Z", "type": "forcePushed"}, {"oid": "8062a19ab3886de557672322f3c721eba3f6b717", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/8062a19ab3886de557672322f3c721eba3f6b717", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:42:07Z", "type": "forcePushed"}, {"oid": "608e943a9f0490a3eb7a27ff9890da0a6003dae9", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/608e943a9f0490a3eb7a27ff9890da0a6003dae9", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:43:35Z", "type": "forcePushed"}, {"oid": "955ef605e01aaafdef1312d4a10aad7626753cc1", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/955ef605e01aaafdef1312d4a10aad7626753cc1", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:49:33Z", "type": "forcePushed"}, {"oid": "0209fbb9e0c5635064f3d25a33c4bffba8f4522c", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0209fbb9e0c5635064f3d25a33c4bffba8f4522c", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:51:24Z", "type": "forcePushed"}, {"oid": "461d3c0d98514efedd6e35e62bfcf8ec84fd66de", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/461d3c0d98514efedd6e35e62bfcf8ec84fd66de", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:55:31Z", "type": "forcePushed"}, {"oid": "ce9576fd3f51b340ca9e1378e31374cc2372a988", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/ce9576fd3f51b340ca9e1378e31374cc2372a988", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T06:59:13Z", "type": "forcePushed"}, {"oid": "1138536aa09d0e9247ae8b7d7c332af6c2784087", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1138536aa09d0e9247ae8b7d7c332af6c2784087", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T07:16:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczMzY1MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378733651", "bodyText": "Let's add unit test for that", "author": "boyan-velinov", "createdAt": "2020-02-13T09:13:52Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -44,10 +46,21 @@\n         List<CloudEntity> mtaMetadataEntities = mtaMetadataEntityCollectors.stream()\n                                                                            .map(collector -> collector.collect(client, criteria))\n                                                                            .flatMap(List::stream)\n+                                                                           .filter(this::nonEmptyMtaId)\n                                                                            .collect(Collectors.toList());\n         return mtaMetadataEntityAggregator.aggregate(mtaMetadataEntities);\n     }\n \n+    private boolean nonEmptyMtaId(CloudEntity entity) {", "originalCommit": "68405b4e1bfd7ca32e02462ba3368b143d3db751", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczMzkzMQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378733931", "bodyText": "Is it a good idea to use Optional for such composition of nullable objects", "author": "boyan-velinov", "createdAt": "2020-02-13T09:14:26Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -44,10 +46,21 @@\n         List<CloudEntity> mtaMetadataEntities = mtaMetadataEntityCollectors.stream()\n                                                                            .map(collector -> collector.collect(client, criteria))\n                                                                            .flatMap(List::stream)\n+                                                                           .filter(this::nonEmptyMtaId)\n                                                                            .collect(Collectors.toList());\n         return mtaMetadataEntityAggregator.aggregate(mtaMetadataEntities);\n     }\n \n+    private boolean nonEmptyMtaId(CloudEntity entity) {\n+        Metadata serviceMetadata = entity.getV3Metadata();\n+        if (serviceMetadata == null || serviceMetadata.getLabels() == null) {\n+            return false;\n+        }\n+        String mtaId = serviceMetadata.getLabels()\n+                                      .get(MtaMetadataLabels.MTA_ID);\n+        return !StringUtils.isEmpty(mtaId);", "originalCommit": "68405b4e1bfd7ca32e02462ba3368b143d3db751", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczNDMxNw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378734317", "bodyText": "Can we have some unit tests for the step", "author": "boyan-velinov", "createdAt": "2020-02-13T09:15:16Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.steps;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.process.message.Messages;\n+import org.apache.commons.lang3.StringUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+import javax.inject.Named;\n+import java.text.MessageFormat;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+@Named(\"detachServicesFromMtaStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetachServicesFromMtaStep extends SyncFlowableStep {", "originalCommit": "68405b4e1bfd7ca32e02462ba3368b143d3db751", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\nindex 5964130e1..d978ee50c 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\n\n@@ -1,5 +1,6 @@\n package com.sap.cloud.lm.sl.cf.process.steps;\n \n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n import com.sap.cloud.lm.sl.cf.process.message.Messages;\n import org.apache.commons.lang3.StringUtils;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczOTQxMA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378739410", "bodyText": "What will happen if resource has type \"existing-service-key\"", "author": "boyan-velinov", "createdAt": "2020-02-13T09:24:35Z", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationCloudModelBuilder.java", "diffHunk": "@@ -117,18 +116,10 @@ protected CloudApplicationExtended getApplication(Module module) {\n                                                 .dockerInfo(parseParameters(parametersList, new DockerInfoParser()))\r\n                                                 .attributesUpdateStrategy(getApplicationAttributesUpdateStrategy(parametersList))\r\n                                                 .v3Metadata(ApplicationMetadataBuilder.build(deploymentDescriptor, module,\r\n-                                                                                             resourcesAndResourceTypes))\r\n+                                                                                             getApplicationServices(module)))\r", "originalCommit": "50a1d5b11de41facd7e2761d92d787c003c24246", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5OTEyNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378799125", "bodyText": "Tested, seems fine as the filtering works.", "author": "valentinEmpy", "createdAt": "2020-02-13T11:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczOTQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationCloudModelBuilder.java b/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationCloudModelBuilder.java\nindex 08aa9a77f..ec18f106e 100644\n--- a/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationCloudModelBuilder.java\n+++ b/com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationCloudModelBuilder.java\n\n@@ -116,10 +117,18 @@ public class ApplicationCloudModelBuilder {\n                                                 .dockerInfo(parseParameters(parametersList, new DockerInfoParser()))\n                                                 .attributesUpdateStrategy(getApplicationAttributesUpdateStrategy(parametersList))\n                                                 .v3Metadata(ApplicationMetadataBuilder.build(deploymentDescriptor, module,\n-                                                                                             getApplicationServices(module)))\n+                                                                                             resourcesAndResourceTypes))\n                                                 .build();\n     }\n \n+    private List<ResourceAndResourceType> getResourcesAndResourceTypesFromModule(Module module) {\n+        return module.getRequiredDependencies()\n+                     .stream()\n+                     .map(dependency -> getResourceWithType(dependency.getName()))\n+                     .filter(Objects::nonNull)\n+                     .collect(Collectors.toList());\n+    }\n+\n     private AttributeUpdateStrategy getApplicationAttributesUpdateStrategy(List<Map<String, Object>> parametersList) {\n         return parseParameters(parametersList, new ApplicationAttributeUpdateStrategyParser());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MjY5MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378742690", "bodyText": "Add unit test", "author": "boyan-velinov", "createdAt": "2020-02-13T09:30:26Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java", "diffHunk": "@@ -144,20 +154,23 @@ private void setComponentsToUndeploy(DelegateExecution context, List<String> ser\n     }\n \n     private List<String> computeServicesToDelete(List<DeployedMtaApplication> appsWithoutChange,\n-                                                 List<DeployedMtaService> deployedMtaServices, Set<String> servicesForApplications) {\n+                                                 List<DeployedMtaService> deployedMtaServices, Set<String> servicesForApplications,\n+                                                 List<String> servicesForCurrentDeployment) {\n         return deployedMtaServices.stream()\n                                   .map(DeployedMtaService::getName)\n-                                  .filter(name -> shouldDeleteService(appsWithoutChange, name, servicesForApplications))\n+                                  .filter(service -> shouldDeleteService(service, appsWithoutChange, servicesForApplications,\n+                                                                         servicesForCurrentDeployment))\n                                   .sorted()\n                                   .collect(Collectors.toList());\n     }\n \n-    private boolean shouldDeleteService(List<DeployedMtaApplication> appsToKeep, String service, Set<String> servicesForApplications) {\n+    private boolean shouldDeleteService(String service, List<DeployedMtaApplication> appsToKeep, Set<String> servicesForApplications,\n+                                        List<String> servicesForCurrentDeployment) {\n         return appsToKeep.stream()\n                          .flatMap(module -> module.getBoundMtaServices()\n                                                   .stream())\n                          .noneMatch(service::equalsIgnoreCase)\n-            && !servicesForApplications.contains(service);\n+            && !servicesForApplications.contains(service) && !servicesForCurrentDeployment.contains(service);", "originalCommit": "5f3d81b6dbf72aae2166abe116f5dee6ee7622ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java\nindex 43088fcae..17c6b0c31 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java\n\n@@ -154,23 +144,20 @@ public class BuildCloudUndeployModelStep extends SyncFlowableStep {\n     }\n \n     private List<String> computeServicesToDelete(List<DeployedMtaApplication> appsWithoutChange,\n-                                                 List<DeployedMtaService> deployedMtaServices, Set<String> servicesForApplications,\n-                                                 List<String> servicesForCurrentDeployment) {\n+                                                 List<DeployedMtaService> deployedMtaServices, Set<String> servicesForApplications) {\n         return deployedMtaServices.stream()\n                                   .map(DeployedMtaService::getName)\n-                                  .filter(service -> shouldDeleteService(service, appsWithoutChange, servicesForApplications,\n-                                                                         servicesForCurrentDeployment))\n+                                  .filter(name -> shouldDeleteService(appsWithoutChange, name, servicesForApplications))\n                                   .sorted()\n                                   .collect(Collectors.toList());\n     }\n \n-    private boolean shouldDeleteService(String service, List<DeployedMtaApplication> appsToKeep, Set<String> servicesForApplications,\n-                                        List<String> servicesForCurrentDeployment) {\n+    private boolean shouldDeleteService(List<DeployedMtaApplication> appsToKeep, String service, Set<String> servicesForApplications) {\n         return appsToKeep.stream()\n                          .flatMap(module -> module.getBoundMtaServices()\n                                                   .stream())\n                          .noneMatch(service::equalsIgnoreCase)\n-            && !servicesForApplications.contains(service) && !servicesForCurrentDeployment.contains(service);\n+            && !servicesForApplications.contains(service);\n     }\n \n     private List<DeployedMtaApplication> computeModulesToUndeploy(DeployedMta deployedMta, Set<String> mtaModules,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0Mzk5NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/757#discussion_r378743994", "bodyText": "Better clean everything MTA related, not only MTA_ID", "author": "boyan-velinov", "createdAt": "2020-02-13T09:32:42Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.steps;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.process.message.Messages;\n+import org.apache.commons.lang3.StringUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+\n+import javax.inject.Named;\n+import java.text.MessageFormat;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+@Named(\"detachServicesFromMtaStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class DetachServicesFromMtaStep extends SyncFlowableStep {\n+\n+    @Override\n+    protected StepPhase executeStep(ExecutionWrapper execution) {\n+        getStepLogger().debug(Messages.DETACHING_SERVICES_FROM_MTA);\n+\n+        List<String> serviceNamesToDetachFromMta = StepsUtil.getServicesToDelete(execution.getContext());\n+        CloudControllerClient client = execution.getControllerClient();\n+        List<CloudServiceInstance> servicesToDetachFromMta = getServices(serviceNamesToDetachFromMta, client);\n+        deleteMtaMetadataFromServices(servicesToDetachFromMta, client);\n+\n+        getStepLogger().debug(Messages.SERVICES_DETACHED_FROM_MTA);\n+        return StepPhase.DONE;\n+    }\n+\n+    private List<CloudServiceInstance> getServices(List<String> serviceNames, CloudControllerClient client) {\n+        return serviceNames.stream()\n+                           .map(client::getServiceInstance)\n+                           .collect(Collectors.toList());\n+    }\n+\n+    private void deleteMtaMetadataFromServices(List<CloudServiceInstance> servicesToDetachFromMta, CloudControllerClient client) {\n+        for (CloudServiceInstance serviceToDetachFromMta : servicesToDetachFromMta) {\n+            Metadata serviceMetadata = serviceToDetachFromMta.getV3Metadata();\n+            if (serviceMetadata == null) {\n+                continue;\n+            }\n+            getStepLogger().info(MessageFormat.format(Messages.DETACHING_SERVICE_0_FROM_MTA, serviceToDetachFromMta.getName()));\n+            UUID serviceGuid = serviceToDetachFromMta.getMetadata()\n+                                                     .getGuid();\n+            client.updateServiceMetadata(serviceGuid, getMetadataWithEmptyMtaId(serviceMetadata));\n+        }\n+    }\n+\n+    // FIXME Once the fix for deleting metadata is available in cf-java-client, the whole MTA metadata must be deleted instead of setting an empty MTA_ID value\n+    private Metadata getMetadataWithEmptyMtaId(Metadata metadata) {\n+        return Metadata.builder()\n+                       .from(metadata)\n+                       .label(MtaMetadataLabels.MTA_ID, StringUtils.EMPTY)", "originalCommit": "68405b4e1bfd7ca32e02462ba3368b143d3db751", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\nindex 5964130e1..d978ee50c 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetachServicesFromMtaStep.java\n\n@@ -1,5 +1,6 @@\n package com.sap.cloud.lm.sl.cf.process.steps;\n \n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n import com.sap.cloud.lm.sl.cf.process.message.Messages;\n import org.apache.commons.lang3.StringUtils;\n"}}, {"oid": "6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6a2561b3d70fc22b1884bb9e3886b16fc298aad1", "message": "[Metadata] Detach service from MTA when --delete-services not used\n\nWhen someone undeploys an MTA WITHOUT using the --delete-services CLI option, the mta\nmetadata must be removed from the service in order to avoid future\ndetection of the same MTA.\nCurrently, it uses a workaround by setting empty (\"\") mta_id in\nservices' metadata because the cf-java-client has a bug which does not\nallow deleting metadata labels/annotations.", "committedDate": "2020-02-13T10:58:22Z", "type": "commit"}, {"oid": "24d42a3b0e8bbb3a74dd980077eaacb696a08d50", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/24d42a3b0e8bbb3a74dd980077eaacb696a08d50", "message": "[Metadata] Do not store existing-service in metadata\n\nEnvironment metadata does not include existing-service in application's\nmetadata (bound services). This should not happen for v3 metadata\neither, for consistency. Also it is unnecessary as they're not needed.", "committedDate": "2020-02-13T10:58:27Z", "type": "commit"}, {"oid": "dbd077df16faffd9d359920bc10e920cf7440009", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/dbd077df16faffd9d359920bc10e920cf7440009", "message": "[Metadata] Ensure services part of new MTA are not marked as discontinued\n\nHaving Environment metadata, if a service had no bound applications,\nthere was no way to determine if that service is part of the MTA as the\nservice itself does not have environment. With the v3 Metadata, the\nservice has its own metadata, therefore we can now determine if the\nservice is part of the MTA or not. This is an enhancement which fixes an\nold issue where using --delete-services on orphaned services would\ndelete them because of the mentioned detection above.", "committedDate": "2020-02-13T11:14:55Z", "type": "commit"}, {"oid": "9db67c1fe3721f32881b94896fffb6494b8201b9", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/9db67c1fe3721f32881b94896fffb6494b8201b9", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T11:14:59Z", "type": "commit"}, {"oid": "9db67c1fe3721f32881b94896fffb6494b8201b9", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/9db67c1fe3721f32881b94896fffb6494b8201b9", "message": "[Metadata] Handle service metadata update action correctly\n\nThere was an UpdateServiceMetadataStep but it was not part of the\n'create-or-update-services.bpmn'. This commit adds it to the bpmn and\nremoves several unnecessary lines of code.", "committedDate": "2020-02-13T11:14:59Z", "type": "forcePushed"}]}