{"pr_number": 778, "pr_title": "Skip rebind of services after testing phase", "pr_createdAt": "2020-02-26T16:29:14Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2MzA5Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385063093", "bodyText": "See PrepareAppsRestartStep. Can't we do something similar to what is done there?", "author": "nictas", "createdAt": "2020-02-27T11:15:37Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/listeners/EnteredTestingPhaseListener.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.sap.cloud.lm.sl.cf.process.listeners;\n+\n+import com.sap.cloud.lm.sl.cf.process.Constants;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.inject.Named;\n+\n+@Named(\"enteredTestingPhaseListener\")\n+public class EnteredTestingPhaseListener extends AbstractProcessExecutionListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnteredTestingPhaseListener.class);\n+\n+    @Override\n+    protected void notifyInternal(DelegateExecution context)  {\n+        context.setVariable(Constants.VAR_ENTERED_TESTING_PHASE, true);\n+    }", "originalCommit": "3e49d87e5eddc0f35cce885c937a577c77251d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/listeners/EnteredTestingPhaseListener.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/listeners/EnteredTestingPhaseListener.java\ndeleted file mode 100644\nindex e1c507348..000000000\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/listeners/EnteredTestingPhaseListener.java\n+++ /dev/null\n\n@@ -1,24 +0,0 @@\n-package com.sap.cloud.lm.sl.cf.process.listeners;\n-\n-import com.sap.cloud.lm.sl.cf.process.Constants;\n-import org.flowable.engine.delegate.DelegateExecution;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import javax.inject.Named;\n-\n-@Named(\"enteredTestingPhaseListener\")\n-public class EnteredTestingPhaseListener extends AbstractProcessExecutionListener {\n-\n-    private static final Logger LOGGER = LoggerFactory.getLogger(EnteredTestingPhaseListener.class);\n-\n-    @Override\n-    protected void notifyInternal(DelegateExecution context)  {\n-        context.setVariable(Constants.VAR_ENTERED_TESTING_PHASE, true);\n-    }\n-\n-    @Override\n-    protected Logger getLogger() {\n-        return LOGGER;\n-    }\n-}\n"}}, {"oid": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6020fdc5b997b6b375b64b7dc26413412da4e41f", "message": "Skip rebind of services after testing phase\n\nLMCROSSITXSADEPLOY-1868", "committedDate": "2020-02-27T13:27:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5NjI0Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385596243", "bodyText": "The name of the variable is too specific. Why should the CreateOrUpdateAppStep know about the existence of a testing phase? What we want to tell the step via this variable is whether it should skip the bindings or not.", "author": "nictas", "createdAt": "2020-02-28T09:41:55Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Constants.java", "diffHunk": "@@ -166,6 +166,7 @@\n     public static final String VAR_HOOK_FOR_EXECUTION = \"hookForExecution\";\r\n     public static final String VAR_FILE_ENTRIES = \"fileEntries\";\r\n     public static final String VAR_APPS_TO_RENAME = \"appsToRename\";\r\n+    public static final String VAR_PASSED_TESTING_PHASE = \"passedTestingPhase\";\r", "originalCommit": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYzMTc3NA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385631774", "bodyText": "Changed to \"shouldSkipServiceRebinding\"", "author": "radito3", "createdAt": "2020-02-28T10:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5NjI0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "29debd47910f8d1740b9af17bcc71debe135c12e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Constants.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Constants.java\nindex dba16c065..a996be28c 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Constants.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Constants.java\n\n@@ -166,7 +166,7 @@ public class Constants {\n     public static final String VAR_HOOK_FOR_EXECUTION = \"hookForExecution\";\n     public static final String VAR_FILE_ENTRIES = \"fileEntries\";\n     public static final String VAR_APPS_TO_RENAME = \"appsToRename\";\n-    public static final String VAR_PASSED_TESTING_PHASE = \"passedTestingPhase\";\n+    public static final String VAR_SHOULD_SKIP_SERVICE_REBINDING = \"shouldSkipServiceRebinding\";\n \n     public static final String TOOL_TYPE = \"tool_type\";\n     public static final String FEEDBACK_MAIL = \"feedback_form\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5Njc5MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385596791", "bodyText": "Why not handle this in a getter in StepsUtil. There we already have a generic method that allows you to provide a default value.", "author": "nictas", "createdAt": "2020-02-28T09:42:54Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -245,6 +251,14 @@ public void handleApplicationAttributes() {\n \r\n         @Override\r\n         public void handleApplicationServices() throws FileStorageException {\r\n+            Boolean passedTestingPhase = (Boolean) execution.getContext()\r\n+                                                            .getVariable(Constants.VAR_PASSED_TESTING_PHASE);\r\n+            if (processTypeParser.getProcessType(execution.getContext())\r\n+                                 .equals(ProcessType.BLUE_GREEN_DEPLOY) &&\r\n+                BooleanUtils.toBooleanDefaultIfNull(passedTestingPhase, false)) {\r", "originalCommit": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYzMjIyOA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385632228", "bodyText": "Changed to StepsUtil.getBoolean(context, varName, defaultValue) and removed check for blue-green deploy process id", "author": "radito3", "createdAt": "2020-02-28T10:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5Njc5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "29debd47910f8d1740b9af17bcc71debe135c12e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\nindex 2c5343c25..9b1f3ee85 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\n\n@@ -251,11 +245,7 @@ public class CreateOrUpdateAppStep extends SyncFlowableStep {\n \n         @Override\n         public void handleApplicationServices() throws FileStorageException {\n-            Boolean passedTestingPhase = (Boolean) execution.getContext()\n-                                                            .getVariable(Constants.VAR_PASSED_TESTING_PHASE);\n-            if (processTypeParser.getProcessType(execution.getContext())\n-                                 .equals(ProcessType.BLUE_GREEN_DEPLOY) &&\n-                BooleanUtils.toBooleanDefaultIfNull(passedTestingPhase, false)) {\n+            if (StepsUtil.getBoolean(execution.getContext(), Constants.VAR_SHOULD_SKIP_SERVICE_REBINDING, false)) {\n                 return;\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5NzAxOQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385597019", "bodyText": "Does it matter whether the deployment is \"blue-green\" or not? If the variable is set to true we should skip the bindings.", "author": "nictas", "createdAt": "2020-02-28T09:43:23Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -245,6 +251,14 @@ public void handleApplicationAttributes() {\n \r\n         @Override\r\n         public void handleApplicationServices() throws FileStorageException {\r\n+            Boolean passedTestingPhase = (Boolean) execution.getContext()\r\n+                                                            .getVariable(Constants.VAR_PASSED_TESTING_PHASE);\r\n+            if (processTypeParser.getProcessType(execution.getContext())\r", "originalCommit": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "29debd47910f8d1740b9af17bcc71debe135c12e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\nindex 2c5343c25..9b1f3ee85 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java\n\n@@ -251,11 +245,7 @@ public class CreateOrUpdateAppStep extends SyncFlowableStep {\n \n         @Override\n         public void handleApplicationServices() throws FileStorageException {\n-            Boolean passedTestingPhase = (Boolean) execution.getContext()\n-                                                            .getVariable(Constants.VAR_PASSED_TESTING_PHASE);\n-            if (processTypeParser.getProcessType(execution.getContext())\n-                                 .equals(ProcessType.BLUE_GREEN_DEPLOY) &&\n-                BooleanUtils.toBooleanDefaultIfNull(passedTestingPhase, false)) {\n+            if (StepsUtil.getBoolean(execution.getContext(), Constants.VAR_SHOULD_SKIP_SERVICE_REBINDING, false)) {\n                 return;\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5ODI5Mw==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385598293", "bodyText": "Are you absolutely sure this works? SyncFlowableStepTest has JUnit4 annotations, while here you're using JUnit5. Check whether this test is not lying about being successful both in the IDE and in the console (mvn clean install). I remember that with some versions of JUnit4 and JUnit5, the integration did not work well. The test would pass successfully, even when it should've failed.", "author": "nictas", "createdAt": "2020-02-28T09:47:11Z", "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateStepWithExistingAppTest.java", "diffHunk": "@@ -3,26 +3,26 @@\n import static org.mockito.ArgumentMatchers.eq;\r\n \r\n import java.util.ArrayList;\r\n-import java.util.Arrays;\r\n import java.util.Collections;\r\n import java.util.HashMap;\r\n import java.util.List;\r\n import java.util.Map;\r\n import java.util.stream.Collectors;\r\n+import java.util.stream.Stream;\r\n \r\n import org.apache.commons.collections4.ListUtils;\r\n import org.cloudfoundry.client.lib.ApplicationServicesUpdateCallback;\r\n import org.cloudfoundry.client.lib.domain.*;\r\n import org.cloudfoundry.client.lib.domain.CloudApplication.State;\r\n import org.flowable.engine.delegate.DelegateExecution;\r\n-import org.junit.Before;\r\n-import org.junit.Rule;\r\n-import org.junit.Test;\r\n-import org.junit.rules.ExpectedException;\r\n-import org.junit.runner.RunWith;\r\n-import org.junit.runners.Parameterized;\r\n-import org.junit.runners.Parameterized.Parameters;\r\n+import org.junit.jupiter.api.Assertions;\r", "originalCommit": "6020fdc5b997b6b375b64b7dc26413412da4e41f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYyODE1Mg==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/778#discussion_r385628152", "bodyText": "It works", "author": "radito3", "createdAt": "2020-02-28T10:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5ODI5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "29debd47910f8d1740b9af17bcc71debe135c12e", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateStepWithExistingAppTest.java b/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateStepWithExistingAppTest.java\nindex 7dd018c31..b4be53b8f 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateStepWithExistingAppTest.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateStepWithExistingAppTest.java\n\n@@ -22,7 +22,6 @@ import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.Arguments;\n import org.junit.jupiter.params.provider.MethodSource;\n import org.mockito.Mockito;\n-import org.mockito.Spy;\n \n import com.sap.cloud.lm.sl.cf.client.lib.domain.CloudApplicationExtended;\n import com.sap.cloud.lm.sl.cf.client.lib.domain.CloudServiceExtended;\n"}}, {"oid": "29debd47910f8d1740b9af17bcc71debe135c12e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/29debd47910f8d1740b9af17bcc71debe135c12e", "message": "Skip rebind of services after testing phase\n\nLMCROSSITXSADEPLOY-1868", "committedDate": "2020-02-28T10:55:41Z", "type": "commit"}, {"oid": "29debd47910f8d1740b9af17bcc71debe135c12e", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/29debd47910f8d1740b9af17bcc71debe135c12e", "message": "Skip rebind of services after testing phase\n\nLMCROSSITXSADEPLOY-1868", "committedDate": "2020-02-28T10:55:41Z", "type": "forcePushed"}]}