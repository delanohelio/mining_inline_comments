{"pr_number": 773, "pr_title": "Skip upload of unchanged application content", "pr_createdAt": "2020-02-21T17:05:22Z", "pr_url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxNzQ5NQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383217495", "bodyText": "This call is already made on line 156. Could we reuse the CloudApplication?", "author": "enchobelezirev", "createdAt": "2020-02-24T11:40:07Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r\n+            return StepPhase.DONE;\r\n+        }\r\n+\r\n+        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, appName);\r\n         UploadToken uploadToken = asyncUploadFiles(execution, client, app, appArchiveId, fileName);\r\n-        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, app.getName());\r\n+\r\n+        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, appName);\r\n         StepsUtil.setUploadToken(uploadToken, execution.getContext());\r\n         return StepPhase.POLL;\r\n     }\r\n \r\n+    private boolean isAppStagedCorrectly(CloudControllerClient client, String appName) {\r\n+        ApplicationStager appStager = new ApplicationStager(client);\r\n+        CloudApplication cloudApp = client.getApplication(appName);\r", "originalCommit": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1ODcxNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383258715", "bodyText": "Done.", "author": "VaskoBozhurski", "createdAt": "2020-02-24T13:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxNzQ5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "bdc048b780740de311902fc40ecb4d196cbb0d75", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\nindex 5fe339986..21aa833c3 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\n\n@@ -70,8 +70,9 @@ public class UploadAppStep extends TimeoutAsyncFlowableStep {\n         }\n \n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\n-        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\n-        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\n+        CloudApplication cloudApp = client.getApplication(appName);\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, cloudApp, client, newApplicationDigest);\n+        if (!contentChanged && isAppStagedCorrectly(client, cloudApp)) {\n             getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\n             return StepPhase.DONE;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODEyNQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383218125", "bodyText": "Better naming of the variable.\nAlso, could you extract StepsUtil.getUploadToken(execution.getContext()) into separate variable?", "author": "enchobelezirev", "createdAt": "2020-02-24T11:41:36Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java", "diffHunk": "@@ -40,11 +39,10 @@ protected StepPhase executeStep(ExecutionWrapper execution) {\n         getStepLogger().debug(Messages.CURRENT_STATE, appName, currentState);\n         ApplicationStartupState desiredState = computeDesiredState(execution.getContext(), app);\n         getStepLogger().debug(Messages.DESIRED_STATE, appName, desiredState);\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        boolean isAppStaged = StepsUtil.getUploadToken(execution.getContext()) == null;", "originalCommit": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MjE2MQ==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383292161", "bodyText": "Done. I've renamed it and inverted it so it is easier to understand.", "author": "VaskoBozhurski", "createdAt": "2020-02-24T14:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODEyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "bdc048b780740de311902fc40ecb4d196cbb0d75", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java\nindex 7e1fd1c77..b7a78057a 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java\n\n@@ -39,10 +40,11 @@ public class DetermineDesiredStateAchievingActionsStep extends SyncFlowableStep\n         getStepLogger().debug(Messages.CURRENT_STATE, appName, currentState);\n         ApplicationStartupState desiredState = computeDesiredState(execution.getContext(), app);\n         getStepLogger().debug(Messages.DESIRED_STATE, appName, desiredState);\n-        boolean isAppStaged = StepsUtil.getUploadToken(execution.getContext()) == null;\n+        UploadToken uploadToken = StepsUtil.getUploadToken(execution.getContext());\n+        boolean appHasUnstagedContent = uploadToken != null;\n         Set<ApplicationStateAction> actionsToExecute = getActionsCalculator(execution.getContext()).determineActionsToExecute(currentState,\n                                                                                                                               desiredState,\n-                                                                                                                              isAppStaged);\n+                                                                                                                              !appHasUnstagedContent);\n         getStepLogger().debug(Messages.ACTIONS_TO_EXECUTE, appName, actionsToExecute);\n \n         StepsUtil.setAppStateActionsToExecute(execution.getContext(), actionsToExecute);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODY3OA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383218678", "bodyText": "Is this necessarry to be info message?", "author": "enchobelezirev", "createdAt": "2020-02-24T11:43:04Z", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r", "originalCommit": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1ODY1MA==", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383258650", "bodyText": "I think it is much more easier to understand what is happening with your deployment when this message exists as otherwise you only see the message saying \"Uploading Application X\", while there is no actual deployment happening.", "author": "VaskoBozhurski", "createdAt": "2020-02-24T13:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODY3OA=="}], "type": "inlineReview", "revised_code": {"commit": "bdc048b780740de311902fc40ecb4d196cbb0d75", "chunk": "diff --git a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\nindex 5fe339986..21aa833c3 100644\n--- a/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\n+++ b/com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java\n\n@@ -70,8 +70,9 @@ public class UploadAppStep extends TimeoutAsyncFlowableStep {\n         }\n \n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\n-        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\n-        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\n+        CloudApplication cloudApp = client.getApplication(appName);\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, cloudApp, client, newApplicationDigest);\n+        if (!contentChanged && isAppStagedCorrectly(client, cloudApp)) {\n             getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\n             return StepPhase.DONE;\n         }\n"}}, {"oid": "bdc048b780740de311902fc40ecb4d196cbb0d75", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/bdc048b780740de311902fc40ecb4d196cbb0d75", "message": "Skip upload of unchanged application content\n\nSkip upload of unchanged app content if the last staging of the\napplication was successful.", "committedDate": "2020-02-24T14:22:36Z", "type": "commit"}]}