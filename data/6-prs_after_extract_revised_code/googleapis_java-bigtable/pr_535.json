{"pr_number": 535, "pr_title": "feat: Surface the server-timing metric", "pr_createdAt": "2020-11-12T23:49:51Z", "pr_url": "https://github.com/googleapis/java-bigtable/pull/535", "timeline": [{"oid": "62a20dfdd223b8763ce358e3c5bb2feb672d2551", "url": "https://github.com/googleapis/java-bigtable/commit/62a20dfdd223b8763ce358e3c5bb2feb672d2551", "message": "Extract server-timing trailer and create metrics for gfe latency", "committedDate": "2020-11-12T01:17:10Z", "type": "commit"}, {"oid": "335d1dce7ee661631c05d2abb20cf0a45b46c2c8", "url": "https://github.com/googleapis/java-bigtable/commit/335d1dce7ee661631c05d2abb20cf0a45b46c2c8", "message": "Add more tests and refactor", "committedDate": "2020-11-12T20:44:48Z", "type": "commit"}, {"oid": "5fac4bdbdc672a76a8f82f89db200a41265d77c3", "url": "https://github.com/googleapis/java-bigtable/commit/5fac4bdbdc672a76a8f82f89db200a41265d77c3", "message": "Refactor comments and imports", "committedDate": "2020-11-12T22:33:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxNDUwMA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r522514500", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Adds HeaderTracer and SpanName to CallOptions so we could surface metrics in the header\n          \n          \n            \n               * with {@link com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n          \n          \n            \n               * */\n          \n          \n            \n               * Adds HeaderTracer and SpanName to CallOptions so we could surface metrics in the header with\n          \n          \n            \n               * {@link com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n          \n          \n            \n               */", "author": "yoshi-code-bot", "createdAt": "2020-11-12T23:51:48Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java", "diffHunk": "@@ -686,6 +710,28 @@ public EnhancedBigtableStub(EnhancedBigtableStubSettings settings, ClientContext\n   }\n   // </editor-fold>\n \n+  /**\n+   * Adds HeaderTracer and SpanName to CallOptions so we could surface metrics in the header\n+   * with {@link com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n+   * */", "originalCommit": "5fac4bdbdc672a76a8f82f89db200a41265d77c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ae57a761d36f94a0d6001c941cce3b14900a358", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\nindex 9277ce70..50c74f5b 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n\n@@ -711,9 +711,9 @@ public class EnhancedBigtableStub implements AutoCloseable {\n   // </editor-fold>\n \n   /**\n-   * Adds HeaderTracer and SpanName to CallOptions so we could surface metrics in the header\n-   * with {@link com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n-   * */\n+   * Adds HeaderTracer and SpanName to CallOptions so we could surface metrics in the header with\n+   * {@link com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n+   */\n   private ApiCallContext getContextWithTracer(SpanName spanName) {\n     ApiCallContext apiCallContext = clientContext.getDefaultCallContext();\n     if (!(apiCallContext instanceof GrpcCallContext)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxNDUwMQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r522514501", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_LATENCY;\n          \n          \n            \n            import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_LATENCY;", "author": "yoshi-code-bot", "createdAt": "2020-11-12T23:51:48Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java", "diffHunk": "@@ -17,6 +17,8 @@\n \n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_APP_PROFILE_ID;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_ATTEMPT_LATENCY;\n+import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_LATENCY;", "originalCommit": "5fac4bdbdc672a76a8f82f89db200a41265d77c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ae57a761d36f94a0d6001c941cce3b14900a358", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\nindex 7df6d88c..e84c9e7a 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n\n@@ -17,8 +17,8 @@ package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_APP_PROFILE_ID;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_ATTEMPT_LATENCY;\n-import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_LATENCY;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT;\n+import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_GFE_LATENCY;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_INSTANCE_ID;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_OP;\n import static com.google.cloud.bigtable.data.v2.stub.metrics.RpcMeasureConstants.BIGTABLE_OP_ATTEMPT_COUNT;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxNDUwMw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r522514503", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import io.opencensus.tags.Tagger;\n          \n          \n            \n            import io.opencensus.tags.Tags;\n          \n          \n            \n            import io.opencensus.tags.Tagger;", "author": "yoshi-code-bot", "createdAt": "2020-11-12T23:51:48Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;", "originalCommit": "5fac4bdbdc672a76a8f82f89db200a41265d77c3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ae57a761d36f94a0d6001c941cce3b14900a358", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\nindex 5b1e0a06..fb8457af 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n\n@@ -24,7 +24,6 @@ import io.opencensus.stats.StatsRecorder;\n import io.opencensus.tags.TagKey;\n import io.opencensus.tags.TagValue;\n import io.opencensus.tags.Tagger;\n-import io.opencensus.tags.Tags;\n import java.util.Map;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n"}}, {"oid": "8ae57a761d36f94a0d6001c941cce3b14900a358", "url": "https://github.com/googleapis/java-bigtable/commit/8ae57a761d36f94a0d6001c941cce3b14900a358", "message": "reformatting", "committedDate": "2020-11-13T00:14:54Z", "type": "commit"}, {"oid": "dff4d283f5f210fb034ec3238ba84b5efea87002", "url": "https://github.com/googleapis/java-bigtable/commit/dff4d283f5f210fb034ec3238ba84b5efea87002", "message": "Clean up comments", "committedDate": "2020-11-13T00:38:38Z", "type": "commit"}, {"oid": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "url": "https://github.com/googleapis/java-bigtable/commit/6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "message": "Merge branch 'master' into gfe-metrics", "committedDate": "2020-11-17T14:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5MTk4MQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530391981", "bodyText": "I dont think this is needed for the emulator as it will only be sent by the GFE. So I think this should go in the newBuilder factory method. However that also creates frictions for users that would want to install their interceptor. Now they have to worry about chaining it with ours. So I think this should be injected at the end in finalizeSettings?", "author": "igorbernstein2", "createdAt": "2020-11-25T13:57:01Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/BigtableDataSettings.java", "diffHunk": "@@ -127,6 +128,7 @@ public ManagedChannelBuilder apply(ManagedChannelBuilder input) {\n                 .setKeepAliveTime(Duration.ofSeconds(30)) // sends ping in this interval\n                 .setKeepAliveTimeout(\n                     Duration.ofSeconds(10)) // wait this long before considering the connection dead\n+                .setInterceptorProvider(BigtableInterceptorProvider.createDefault())", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzNjk4Ng==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532936986", "bodyText": "Removed the interceptor, using GrpcResponseMetadata instead.", "author": "mutianf", "createdAt": "2020-11-30T22:11:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5MTk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/BigtableDataSettings.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/BigtableDataSettings.java\nindex d3c35029..ff20075f 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/BigtableDataSettings.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/BigtableDataSettings.java\n\n@@ -128,7 +127,6 @@ public final class BigtableDataSettings {\n                 .setKeepAliveTime(Duration.ofSeconds(30)) // sends ping in this interval\n                 .setKeepAliveTimeout(\n                     Duration.ofSeconds(10)) // wait this long before considering the connection dead\n-                .setInterceptorProvider(BigtableInterceptorProvider.createDefault())\n                 .build());\n \n     LOGGER.info(\"Connecting to the Bigtable emulator at \" + hostname + \":\" + port);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NjQ4Ng==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530396486", "bodyText": "I think it would be better to name this FixedIterceptorProvider and put this in the gaxx package and then in the future to move it to gax proper. (This implies that the construction of the ClientHEaderInterceptor should move out of this class to the caller)", "author": "igorbernstein2", "createdAt": "2020-11-25T14:03:55Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/BigtableInterceptorProvider.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub;\n+\n+import com.google.api.core.BetaApi;\n+import com.google.api.gax.grpc.GrpcInterceptorProvider;\n+import com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor;\n+import com.google.common.collect.ImmutableList;\n+import io.grpc.ClientInterceptor;\n+import java.util.List;\n+\n+@BetaApi\n+public class BigtableInterceptorProvider implements GrpcInterceptorProvider {", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/BigtableInterceptorProvider.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/BigtableInterceptorProvider.java\ndeleted file mode 100644\nindex a6442d60..00000000\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/BigtableInterceptorProvider.java\n+++ /dev/null\n\n@@ -1,47 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.google.cloud.bigtable.data.v2.stub;\n-\n-import com.google.api.core.BetaApi;\n-import com.google.api.gax.grpc.GrpcInterceptorProvider;\n-import com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor;\n-import com.google.common.collect.ImmutableList;\n-import io.grpc.ClientInterceptor;\n-import java.util.List;\n-\n-@BetaApi\n-public class BigtableInterceptorProvider implements GrpcInterceptorProvider {\n-\n-  private static final ClientHeaderInterceptor headerInterceptor = new ClientHeaderInterceptor();\n-  private List<ClientInterceptor> clientInterceptors;\n-\n-  private BigtableInterceptorProvider(List<ClientInterceptor> interceptors) {\n-    this.clientInterceptors = interceptors;\n-  }\n-\n-  public static BigtableInterceptorProvider createDefault() {\n-    return new BigtableInterceptorProvider(ImmutableList.<ClientInterceptor>of(headerInterceptor));\n-  }\n-\n-  public static BigtableInterceptorProvider create(List<ClientInterceptor> interceptors) {\n-    return new BigtableInterceptorProvider(interceptors);\n-  }\n-\n-  @Override\n-  public List<ClientInterceptor> getInterceptors() {\n-    return clientInterceptors;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNTIyNA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530405224", "bodyText": "I think this should be extracted into its own Callable that injects the CallOptions into the passed in ApiCallOptions", "author": "igorbernstein2", "createdAt": "2020-11-25T14:16:34Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java", "diffHunk": "@@ -686,6 +710,29 @@ public EnhancedBigtableStub(EnhancedBigtableStubSettings settings, ClientContext\n   }\n   // </editor-fold>\n \n+  /**\n+   * Adds a HeaderTracer instance and current span name to CallOptions so we could surface metrics\n+   * in the header with {@link\n+   * com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n+   */\n+  private ApiCallContext getContextWithTracer(SpanName spanName) {", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\nindex bacab8c7..025794bf 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n\n@@ -710,27 +733,8 @@ public class EnhancedBigtableStub implements AutoCloseable {\n   }\n   // </editor-fold>\n \n-  /**\n-   * Adds a HeaderTracer instance and current span name to CallOptions so we could surface metrics\n-   * in the header with {@link\n-   * com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n-   */\n-  private ApiCallContext getContextWithTracer(SpanName spanName) {\n-    ApiCallContext apiCallContext = clientContext.getDefaultCallContext();\n-    if (!(apiCallContext instanceof GrpcCallContext)) {\n-      LOGGER.warning(\n-          \"Failed to add tracer in call context. Expected GrpcCallContext but had \"\n-              + apiCallContext.getClass());\n-      return apiCallContext;\n-    }\n-    GrpcCallContext grpcCallContext = (GrpcCallContext) apiCallContext;\n-    CallOptions options = grpcCallContext.getCallOptions();\n-    options =\n-        options\n-            .withOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY, settings.getHeaderTracer())\n-            .withOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY, spanName.toString());\n-    grpcCallContext = grpcCallContext.withCallOptions(options);\n-    return grpcCallContext;\n+  private SpanName getSpanName(String methodName) {\n+    return SpanName.of(CLIENT_NAME, methodName);\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNjIwOA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530406208", "bodyText": "I would try to wrap both values in a single object to minimize the overhead of adding CallOptions entries which is backed by an array", "author": "igorbernstein2", "createdAt": "2020-11-25T14:17:51Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java", "diffHunk": "@@ -686,6 +710,29 @@ public EnhancedBigtableStub(EnhancedBigtableStubSettings settings, ClientContext\n   }\n   // </editor-fold>\n \n+  /**\n+   * Adds a HeaderTracer instance and current span name to CallOptions so we could surface metrics\n+   * in the header with {@link\n+   * com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n+   */\n+  private ApiCallContext getContextWithTracer(SpanName spanName) {\n+    ApiCallContext apiCallContext = clientContext.getDefaultCallContext();\n+    if (!(apiCallContext instanceof GrpcCallContext)) {\n+      LOGGER.warning(\n+          \"Failed to add tracer in call context. Expected GrpcCallContext but had \"\n+              + apiCallContext.getClass());\n+      return apiCallContext;\n+    }\n+    GrpcCallContext grpcCallContext = (GrpcCallContext) apiCallContext;\n+    CallOptions options = grpcCallContext.getCallOptions();\n+    options =\n+        options\n+            .withOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY, settings.getHeaderTracer())\n+            .withOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY, spanName.toString());", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\nindex bacab8c7..025794bf 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n\n@@ -710,27 +733,8 @@ public class EnhancedBigtableStub implements AutoCloseable {\n   }\n   // </editor-fold>\n \n-  /**\n-   * Adds a HeaderTracer instance and current span name to CallOptions so we could surface metrics\n-   * in the header with {@link\n-   * com.google.cloud.bigtable.data.v2.stub.metrics.ClientHeaderInterceptor}.\n-   */\n-  private ApiCallContext getContextWithTracer(SpanName spanName) {\n-    ApiCallContext apiCallContext = clientContext.getDefaultCallContext();\n-    if (!(apiCallContext instanceof GrpcCallContext)) {\n-      LOGGER.warning(\n-          \"Failed to add tracer in call context. Expected GrpcCallContext but had \"\n-              + apiCallContext.getClass());\n-      return apiCallContext;\n-    }\n-    GrpcCallContext grpcCallContext = (GrpcCallContext) apiCallContext;\n-    CallOptions options = grpcCallContext.getCallOptions();\n-    options =\n-        options\n-            .withOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY, settings.getHeaderTracer())\n-            .withOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY, spanName.toString());\n-    grpcCallContext = grpcCallContext.withCallOptions(options);\n-    return grpcCallContext;\n+  private SpanName getSpanName(String methodName) {\n+    return SpanName.of(CLIENT_NAME, methodName);\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwODY1MQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530408651", "bodyText": "I would add a comment that this shouldn't ever happen because the tracer is injected in ....", "author": "igorbernstein2", "createdAt": "2020-11-25T14:21:04Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import io.grpc.CallOptions;\n+import io.grpc.Channel;\n+import io.grpc.ClientCall;\n+import io.grpc.ClientInterceptor;\n+import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n+import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n+import io.grpc.Metadata;\n+import io.grpc.MethodDescriptor;\n+import java.util.logging.Logger;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Surface GFE server-timing metric.\n+ *\n+ * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n+ * receives the first byte of a request and reads the first byte of the response. It also tracks the\n+ * number of occurrences of missing server-timing header.\n+ */\n+@BetaApi\n+public class ClientHeaderInterceptor implements ClientInterceptor {\n+  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @Override\n+  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n+      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n+    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n+    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n+    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n+    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n+      @Override\n+      public void start(Listener<RespT> responseListener, Metadata headers) {\n+        super.start(\n+            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n+              @Override\n+              public void onHeaders(Metadata headers) {\n+                processHeader(headers, tracer, span);\n+                super.onHeaders(headers);\n+              }\n+            },\n+            headers);\n+      }\n+    };\n+  }\n+\n+  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n+    if (tracer == null) {\n+      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMzkyMQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530423921", "bodyText": "I'm also a little concerned about flooding the customer logs here. If the tracer is missing, it is quite likely that it will be missing for all of the requests. So this will log for every request", "author": "igorbernstein2", "createdAt": "2020-11-25T14:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwODY1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\ndeleted file mode 100644\nindex 19ecf68e..00000000\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\n+++ /dev/null\n\n@@ -1,90 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.google.cloud.bigtable.data.v2.stub.metrics;\n-\n-import com.google.api.core.BetaApi;\n-import io.grpc.CallOptions;\n-import io.grpc.Channel;\n-import io.grpc.ClientCall;\n-import io.grpc.ClientInterceptor;\n-import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n-import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n-import io.grpc.Metadata;\n-import io.grpc.MethodDescriptor;\n-import java.util.logging.Logger;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n-\n-/**\n- * Surface GFE server-timing metric.\n- *\n- * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n- * receives the first byte of a request and reads the first byte of the response. It also tracks the\n- * number of occurrences of missing server-timing header.\n- */\n-@BetaApi\n-public class ClientHeaderInterceptor implements ClientInterceptor {\n-  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n-\n-  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n-      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n-  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n-\n-  @Override\n-  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n-      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n-    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n-    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n-    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n-    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n-      @Override\n-      public void start(Listener<RespT> responseListener, Metadata headers) {\n-        super.start(\n-            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n-              @Override\n-              public void onHeaders(Metadata headers) {\n-                processHeader(headers, tracer, span);\n-                super.onHeaders(headers);\n-              }\n-            },\n-            headers);\n-      }\n-    };\n-  }\n-\n-  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n-    if (tracer == null) {\n-      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");\n-      return;\n-    }\n-    if (headers.get(SERVER_TIMING_HEADER_KEY) != null) {\n-      String serverTiming = headers.get(SERVER_TIMING_HEADER_KEY);\n-      Matcher matcher = SERVER_TIMING_HEADER_PATTERN.matcher(serverTiming);\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 0L, span);\n-      if (matcher.find()) {\n-        long latency = Long.valueOf(matcher.group(\"dur\"));\n-        tracer.record(RpcMeasureConstants.BIGTABLE_GFE_LATENCY, latency, span);\n-      } else {\n-        LOGGER.warning(\n-            String.format(\n-                \"Failed to get GFE latency from %s header: %s.\",\n-                SERVER_TIMING_HEADER_KEY.name(), serverTiming));\n-      }\n-    } else {\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 1L, span);\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxMDcwMQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530410701", "bodyText": "I would keep this as a private method and instead expose concrete helpers that describe what you are recording: ie recordGfeLatency(String method, Duration duration)\nrecordMissingGfeHeader(String method)", "author": "igorbernstein2", "createdAt": "2020-11-25T14:24:02Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.CallOptions;\n+import io.opencensus.stats.Measure.MeasureDouble;\n+import io.opencensus.stats.Measure.MeasureLong;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@BetaApi\n+public class HeaderTracer {\n+  public static final CallOptions.Key<HeaderTracer> HEADER_TRACER_CONTEXT_KEY =\n+      CallOptions.Key.create(\"BigtableHeaderTracer\");\n+  public static final CallOptions.Key<String> SPAN_NAME_CONTEXT_KEY =\n+      CallOptions.Key.create(\"BigtableSpanName\");\n+\n+  private Tagger tagger;\n+  private StatsRecorder stats;\n+  private Map<TagKey, TagValue> statsAttributes;\n+\n+  private HeaderTracer(Builder builder) {\n+    tagger = builder.getTagger();\n+    stats = builder.getStats();\n+    statsAttributes = builder.getStatsAttributes();\n+  }\n+\n+  public static class Builder {\n+    private Tagger tagger;\n+    private StatsRecorder stats;\n+    private Map<TagKey, TagValue> statsAttributes;\n+\n+    private Builder() {\n+      tagger = Tags.getTagger();\n+      stats = Stats.getStatsRecorder();\n+      statsAttributes = ImmutableMap.of();\n+    }\n+\n+    private Builder(HeaderTracer headerTracer) {\n+      tagger = headerTracer.tagger;\n+      stats = headerTracer.stats;\n+      statsAttributes = headerTracer.statsAttributes;\n+    }\n+\n+    // <editor-fold desc=\"Public API\">\n+    public Builder setTagger(@Nonnull Tagger tagger) {\n+      Preconditions.checkNotNull(tagger);\n+      this.tagger = tagger;\n+      return this;\n+    }\n+\n+    public Builder setStats(@Nonnull StatsRecorder stats) {\n+      Preconditions.checkNotNull(stats);\n+      this.stats = stats;\n+      return this;\n+    }\n+\n+    public Builder setStatsAttributes(@Nonnull Map<TagKey, TagValue> statsAttributes) {\n+      Preconditions.checkNotNull(statsAttributes);\n+      this.statsAttributes = statsAttributes;\n+      return this;\n+    }\n+\n+    public Tagger getTagger() {\n+      return tagger;\n+    }\n+\n+    public StatsRecorder getStats() {\n+      return stats;\n+    }\n+\n+    public Map<TagKey, TagValue> getStatsAttributes() {\n+      return statsAttributes;\n+    }\n+\n+    public HeaderTracer build() {\n+      Preconditions.checkNotNull(stats, \"StatsRecorder must be set\");\n+      Preconditions.checkNotNull(tagger, \"Tagger must be set\");\n+      Preconditions.checkNotNull(statsAttributes, \"Stats attributes must be set\");\n+      return new HeaderTracer(this);\n+    }\n+    // </editor-fold>\n+  }\n+\n+  public Tagger getTagger() {\n+    return tagger;\n+  }\n+\n+  public StatsRecorder getStats() {\n+    return stats;\n+  }\n+\n+  public Map<TagKey, TagValue> getStatsAttributes() {\n+    return statsAttributes;\n+  }\n+\n+  public void record(MeasureLong measure, long value, @Nullable String span) {", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 89b165cf..877b77b7 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -15,13 +15,11 @@\n  */\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n-import com.google.api.core.BetaApi;\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n import com.google.common.base.Preconditions;\n-import com.google.common.collect.ImmutableMap;\n-import io.grpc.CallOptions;\n-import io.opencensus.stats.Measure.MeasureDouble;\n-import io.opencensus.stats.Measure.MeasureLong;\n+import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n import io.opencensus.stats.StatsRecorder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxMTc2NA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530411764", "bodyText": "Should this be exposed to users? Unless there is a specific reason to access something, we should limit the exposed surface so that we can evolve our internal apis without worrying about breaking users", "author": "igorbernstein2", "createdAt": "2020-11-25T14:25:32Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.CallOptions;\n+import io.opencensus.stats.Measure.MeasureDouble;\n+import io.opencensus.stats.Measure.MeasureLong;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@BetaApi", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzNzg3MA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532937870", "bodyText": "Updated to InternalApi. This class still needs to be public so EnhancedStubSettings and EnhancedStub can use it.", "author": "mutianf", "createdAt": "2020-11-30T22:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxMTc2NA=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 89b165cf..877b77b7 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -15,13 +15,11 @@\n  */\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n-import com.google.api.core.BetaApi;\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n import com.google.common.base.Preconditions;\n-import com.google.common.collect.ImmutableMap;\n-import io.grpc.CallOptions;\n-import io.opencensus.stats.Measure.MeasureDouble;\n-import io.opencensus.stats.Measure.MeasureLong;\n+import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n import io.opencensus.stats.StatsRecorder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxMjc4OA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530412788", "bodyText": "We should discuss if these should be part of the standard exposed metrics", "author": "igorbernstein2", "createdAt": "2020-11-25T14:27:00Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java", "diffHunk": "@@ -31,7 +31,9 @@\n           RpcViewConstants.BIGTABLE_COMPLETED_OP_VIEW,\n           RpcViewConstants.BIGTABLE_READ_ROWS_FIRST_ROW_LATENCY_VIEW,\n           RpcViewConstants.BIGTABLE_ATTEMPT_LATENCY_VIEW,\n-          RpcViewConstants.BIGTABLE_ATTEMPTS_PER_OP_VIEW);\n+          RpcViewConstants.BIGTABLE_ATTEMPTS_PER_OP_VIEW,\n+          RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzODA0OA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532938048", "bodyText": "Added a separate function for registering GFE views.", "author": "mutianf", "createdAt": "2020-11-30T22:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxMjc4OA=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\nindex 84d1a50f..1623f597 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\n\n@@ -31,7 +31,10 @@ public class RpcViews {\n           RpcViewConstants.BIGTABLE_COMPLETED_OP_VIEW,\n           RpcViewConstants.BIGTABLE_READ_ROWS_FIRST_ROW_LATENCY_VIEW,\n           RpcViewConstants.BIGTABLE_ATTEMPT_LATENCY_VIEW,\n-          RpcViewConstants.BIGTABLE_ATTEMPTS_PER_OP_VIEW,\n+          RpcViewConstants.BIGTABLE_ATTEMPTS_PER_OP_VIEW);\n+\n+  private static final ImmutableSet<View> GFE_VIEW_SET =\n+      ImmutableSet.of(\n           RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n           RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxOTk2NQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530419965", "bodyText": "We should avoid exposing this to customers. It's an implementation detail for the current approach. When this gets pushed into gax, we will move this into ApiTracer so we should minimize the amount public methods exposed (even if Beta). if this needs to be public then it should be INternalApi", "author": "igorbernstein2", "createdAt": "2020-11-25T14:36:45Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java", "diffHunk": "@@ -759,6 +772,19 @@ public boolean isRefreshingChannel() {\n       return primedTableIds;\n     }\n \n+    /** Configure the header tracer for surfacing metrics in the header. */", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzODQzMQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532938431", "bodyText": "Updated functions to protected.", "author": "mutianf", "createdAt": "2020-11-30T22:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQxOTk2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ea9bb3017c9ba009fa7b7b1d9e113fea50984383", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java\nindex 4448e700..48647fcd 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java\n\n@@ -773,15 +771,13 @@ public class EnhancedBigtableStubSettings extends StubSettings<EnhancedBigtableS\n     }\n \n     /** Configure the header tracer for surfacing metrics in the header. */\n-    @BetaApi\n-    public Builder setHeaderTracer(HeaderTracer headerTracer) {\n+    Builder setHeaderTracer(HeaderTracer headerTracer) {\n       this.headerTracer = headerTracer;\n       return this;\n     }\n \n     /** Gets the header tracer that'll be used to surface metrics in the header. */\n-    @BetaApi\n-    public HeaderTracer getHeaderTracer() {\n+    HeaderTracer getHeaderTracer() {\n       return headerTracer;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMjc3OQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530422779", "bodyText": "Do we need to record anything here?", "author": "igorbernstein2", "createdAt": "2020-11-25T14:40:39Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import io.grpc.CallOptions;\n+import io.grpc.Channel;\n+import io.grpc.ClientCall;\n+import io.grpc.ClientInterceptor;\n+import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n+import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n+import io.grpc.Metadata;\n+import io.grpc.MethodDescriptor;\n+import java.util.logging.Logger;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Surface GFE server-timing metric.\n+ *\n+ * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n+ * receives the first byte of a request and reads the first byte of the response. It also tracks the\n+ * number of occurrences of missing server-timing header.\n+ */\n+@BetaApi\n+public class ClientHeaderInterceptor implements ClientInterceptor {\n+  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @Override\n+  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n+      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n+    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n+    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n+    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n+    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n+      @Override\n+      public void start(Listener<RespT> responseListener, Metadata headers) {\n+        super.start(\n+            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n+              @Override\n+              public void onHeaders(Metadata headers) {\n+                processHeader(headers, tracer, span);\n+                super.onHeaders(headers);\n+              }\n+            },\n+            headers);\n+      }\n+    };\n+  }\n+\n+  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n+    if (tracer == null) {\n+      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");\n+      return;\n+    }\n+    if (headers.get(SERVER_TIMING_HEADER_KEY) != null) {\n+      String serverTiming = headers.get(SERVER_TIMING_HEADER_KEY);\n+      Matcher matcher = SERVER_TIMING_HEADER_PATTERN.matcher(serverTiming);\n+      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 0L, span);", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0MjQ4Ng==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532942486", "bodyText": "This logic is moved to HeaderTracer.\nI decided to keep this so if in any case gfe_latency is not recorded (for example, if the regex failed), we can check if gfe metrics were being tracked by check if gfe_header_missing_count recorded any values.", "author": "mutianf", "createdAt": "2020-11-30T22:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMjc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\ndeleted file mode 100644\nindex 19ecf68e..00000000\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\n+++ /dev/null\n\n@@ -1,90 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.google.cloud.bigtable.data.v2.stub.metrics;\n-\n-import com.google.api.core.BetaApi;\n-import io.grpc.CallOptions;\n-import io.grpc.Channel;\n-import io.grpc.ClientCall;\n-import io.grpc.ClientInterceptor;\n-import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n-import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n-import io.grpc.Metadata;\n-import io.grpc.MethodDescriptor;\n-import java.util.logging.Logger;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n-\n-/**\n- * Surface GFE server-timing metric.\n- *\n- * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n- * receives the first byte of a request and reads the first byte of the response. It also tracks the\n- * number of occurrences of missing server-timing header.\n- */\n-@BetaApi\n-public class ClientHeaderInterceptor implements ClientInterceptor {\n-  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n-\n-  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n-      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n-  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n-\n-  @Override\n-  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n-      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n-    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n-    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n-    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n-    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n-      @Override\n-      public void start(Listener<RespT> responseListener, Metadata headers) {\n-        super.start(\n-            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n-              @Override\n-              public void onHeaders(Metadata headers) {\n-                processHeader(headers, tracer, span);\n-                super.onHeaders(headers);\n-              }\n-            },\n-            headers);\n-      }\n-    };\n-  }\n-\n-  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n-    if (tracer == null) {\n-      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");\n-      return;\n-    }\n-    if (headers.get(SERVER_TIMING_HEADER_KEY) != null) {\n-      String serverTiming = headers.get(SERVER_TIMING_HEADER_KEY);\n-      Matcher matcher = SERVER_TIMING_HEADER_PATTERN.matcher(serverTiming);\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 0L, span);\n-      if (matcher.find()) {\n-        long latency = Long.valueOf(matcher.group(\"dur\"));\n-        tracer.record(RpcMeasureConstants.BIGTABLE_GFE_LATENCY, latency, span);\n-      } else {\n-        LOGGER.warning(\n-            String.format(\n-                \"Failed to get GFE latency from %s header: %s.\",\n-                SERVER_TIMING_HEADER_KEY.name(), serverTiming));\n-      }\n-    } else {\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 1L, span);\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyNDIzNQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530424235", "bodyText": "Same flooding concern as above", "author": "igorbernstein2", "createdAt": "2020-11-25T14:42:35Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import io.grpc.CallOptions;\n+import io.grpc.Channel;\n+import io.grpc.ClientCall;\n+import io.grpc.ClientInterceptor;\n+import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n+import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n+import io.grpc.Metadata;\n+import io.grpc.MethodDescriptor;\n+import java.util.logging.Logger;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Surface GFE server-timing metric.\n+ *\n+ * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n+ * receives the first byte of a request and reads the first byte of the response. It also tracks the\n+ * number of occurrences of missing server-timing header.\n+ */\n+@BetaApi\n+public class ClientHeaderInterceptor implements ClientInterceptor {\n+  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @Override\n+  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n+      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n+    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n+    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n+    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n+    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n+      @Override\n+      public void start(Listener<RespT> responseListener, Metadata headers) {\n+        super.start(\n+            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n+              @Override\n+              public void onHeaders(Metadata headers) {\n+                processHeader(headers, tracer, span);\n+                super.onHeaders(headers);\n+              }\n+            },\n+            headers);\n+      }\n+    };\n+  }\n+\n+  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n+    if (tracer == null) {\n+      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");\n+      return;\n+    }\n+    if (headers.get(SERVER_TIMING_HEADER_KEY) != null) {\n+      String serverTiming = headers.get(SERVER_TIMING_HEADER_KEY);\n+      Matcher matcher = SERVER_TIMING_HEADER_PATTERN.matcher(serverTiming);\n+      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 0L, span);\n+      if (matcher.find()) {\n+        long latency = Long.valueOf(matcher.group(\"dur\"));\n+        tracer.record(RpcMeasureConstants.BIGTABLE_GFE_LATENCY, latency, span);\n+      } else {\n+        LOGGER.warning(", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\ndeleted file mode 100644\nindex 19ecf68e..00000000\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/ClientHeaderInterceptor.java\n+++ /dev/null\n\n@@ -1,90 +0,0 @@\n-/*\n- * Copyright 2020 Google LLC\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package com.google.cloud.bigtable.data.v2.stub.metrics;\n-\n-import com.google.api.core.BetaApi;\n-import io.grpc.CallOptions;\n-import io.grpc.Channel;\n-import io.grpc.ClientCall;\n-import io.grpc.ClientInterceptor;\n-import io.grpc.ForwardingClientCall.SimpleForwardingClientCall;\n-import io.grpc.ForwardingClientCallListener.SimpleForwardingClientCallListener;\n-import io.grpc.Metadata;\n-import io.grpc.MethodDescriptor;\n-import java.util.logging.Logger;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n-\n-/**\n- * Surface GFE server-timing metric.\n- *\n- * <p>This class exports the metric from server-timing header that tracks the latency between GFE\n- * receives the first byte of a request and reads the first byte of the response. It also tracks the\n- * number of occurrences of missing server-timing header.\n- */\n-@BetaApi\n-public class ClientHeaderInterceptor implements ClientInterceptor {\n-  private static final Logger LOGGER = Logger.getLogger(ClientHeaderInterceptor.class.getName());\n-\n-  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n-      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n-  private static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n-\n-  @Override\n-  public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n-      final MethodDescriptor<ReqT, RespT> method, final CallOptions callOptions, Channel channel) {\n-    final ClientCall<ReqT, RespT> clientCall = channel.newCall(method, callOptions);\n-    final String span = callOptions.getOption(HeaderTracer.SPAN_NAME_CONTEXT_KEY);\n-    final HeaderTracer tracer = callOptions.getOption(HeaderTracer.HEADER_TRACER_CONTEXT_KEY);\n-    return new SimpleForwardingClientCall<ReqT, RespT>(clientCall) {\n-      @Override\n-      public void start(Listener<RespT> responseListener, Metadata headers) {\n-        super.start(\n-            new SimpleForwardingClientCallListener<RespT>(responseListener) {\n-              @Override\n-              public void onHeaders(Metadata headers) {\n-                processHeader(headers, tracer, span);\n-                super.onHeaders(headers);\n-              }\n-            },\n-            headers);\n-      }\n-    };\n-  }\n-\n-  private void processHeader(Metadata headers, HeaderTracer tracer, String span) {\n-    if (tracer == null) {\n-      LOGGER.warning(\"Couldn't find HeaderTracer in call options. Skip exporting gfe metrics\");\n-      return;\n-    }\n-    if (headers.get(SERVER_TIMING_HEADER_KEY) != null) {\n-      String serverTiming = headers.get(SERVER_TIMING_HEADER_KEY);\n-      Matcher matcher = SERVER_TIMING_HEADER_PATTERN.matcher(serverTiming);\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 0L, span);\n-      if (matcher.find()) {\n-        long latency = Long.valueOf(matcher.group(\"dur\"));\n-        tracer.record(RpcMeasureConstants.BIGTABLE_GFE_LATENCY, latency, span);\n-      } else {\n-        LOGGER.warning(\n-            String.format(\n-                \"Failed to get GFE latency from %s header: %s.\",\n-                SERVER_TIMING_HEADER_KEY.name(), serverTiming));\n-      }\n-    } else {\n-      tracer.record(RpcMeasureConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT, 1L, span);\n-    }\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyNDgxMw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r530424813", "bodyText": "Also consider using auto-value", "author": "igorbernstein2", "createdAt": "2020-11-25T14:43:26Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.BetaApi;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.CallOptions;\n+import io.opencensus.stats.Measure.MeasureDouble;\n+import io.opencensus.stats.Measure.MeasureLong;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@BetaApi\n+public class HeaderTracer {", "originalCommit": "6a7f526c4f2b7b92905f163ab2f0c3c2f91a3dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0MTUwNw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r532941507", "bodyText": "Refactored HeaderTracer to use autovalue.", "author": "mutianf", "createdAt": "2020-11-30T22:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyNDgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 89b165cf..877b77b7 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -15,13 +15,11 @@\n  */\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n-import com.google.api.core.BetaApi;\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n import com.google.common.base.Preconditions;\n-import com.google.common.collect.ImmutableMap;\n-import io.grpc.CallOptions;\n-import io.opencensus.stats.Measure.MeasureDouble;\n-import io.opencensus.stats.Measure.MeasureLong;\n+import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n import io.opencensus.stats.StatsRecorder;\n"}}, {"oid": "c55d9d6891f3f4a4b3479779b6b867e6bd666666", "url": "https://github.com/googleapis/java-bigtable/commit/c55d9d6891f3f4a4b3479779b6b867e6bd666666", "message": "Refactor, use GrpcMetadataResponse to get the trailer", "committedDate": "2020-11-30T21:43:43Z", "type": "commit"}, {"oid": "ea9bb3017c9ba009fa7b7b1d9e113fea50984383", "url": "https://github.com/googleapis/java-bigtable/commit/ea9bb3017c9ba009fa7b7b1d9e113fea50984383", "message": "Fix based on the code review", "committedDate": "2020-11-30T22:09:44Z", "type": "commit"}, {"oid": "d2e8f8c6e1a23168dc022a39e5b5e529c02824c9", "url": "https://github.com/googleapis/java-bigtable/commit/d2e8f8c6e1a23168dc022a39e5b5e529c02824c9", "message": "clean up HeaderTracerResponseObserver", "committedDate": "2020-12-01T02:39:22Z", "type": "commit"}, {"oid": "eb78b631a32582236e293e4f7cd9b84a17cb6d26", "url": "https://github.com/googleapis/java-bigtable/commit/eb78b631a32582236e293e4f7cd9b84a17cb6d26", "message": "Merge branch 'master' into gfe-metrics", "committedDate": "2020-12-01T02:56:48Z", "type": "commit"}, {"oid": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "url": "https://github.com/googleapis/java-bigtable/commit/8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "message": "Add more tests for all the ops", "committedDate": "2020-12-01T20:13:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0ODc3OQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534248779", "bodyText": "Can you make this map instance shared with the attrs above?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:18:31Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java", "diffHunk": "@@ -203,7 +205,25 @@ public static EnhancedBigtableStubSettings finalizeSettings(\n                         .build()),\n                 // Add user configured tracer\n                 settings.getTracerFactory())));\n-\n+    builder.setHeaderTracer(\n+        builder\n+            .getHeaderTracer()\n+            .toBuilder()\n+            .setStats(stats)\n+            .setTagger(tagger)\n+            .setStatsAttributes(\n+                ImmutableMap.<TagKey, TagValue>builder()", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\nindex 9bb1c4b2..44839039 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStub.java\n\n@@ -189,20 +198,7 @@ public class EnhancedBigtableStub implements AutoCloseable {\n                             GaxProperties.getLibraryVersion(EnhancedBigtableStubSettings.class))\n                         .build()),\n                 // Add OpenCensus Metrics\n-                MetricsTracerFactory.create(\n-                    tagger,\n-                    stats,\n-                    ImmutableMap.<TagKey, TagValue>builder()\n-                        .put(\n-                            RpcMeasureConstants.BIGTABLE_PROJECT_ID,\n-                            TagValue.create(settings.getProjectId()))\n-                        .put(\n-                            RpcMeasureConstants.BIGTABLE_INSTANCE_ID,\n-                            TagValue.create(settings.getInstanceId()))\n-                        .put(\n-                            RpcMeasureConstants.BIGTABLE_APP_PROFILE_ID,\n-                            TagValue.create(settings.getAppProfileId()))\n-                        .build()),\n+                MetricsTracerFactory.create(tagger, stats, attributes),\n                 // Add user configured tracer\n                 settings.getTracerFactory())));\n     builder.setHeaderTracer(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1NDc0Mw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534254743", "bodyText": "do these have to be public?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:25:58Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import io.grpc.Metadata;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@InternalApi\n+@AutoValue\n+public abstract class HeaderTracer {\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 877b77b7..f3eb0ef1 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -18,7 +18,6 @@ package com.google.cloud.bigtable.data.v2.stub.metrics;\n import com.google.api.core.InternalApi;\n import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n-import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1NTU0MQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534255541", "bodyText": "do we need the getters on the builder?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:26:55Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import io.grpc.Metadata;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@InternalApi\n+@AutoValue\n+public abstract class HeaderTracer {\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  public static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @AutoValue.Builder\n+  public abstract static class Builder {\n+    // <editor-fold desc=\"Public API\">\n+    public abstract Builder setTagger(@Nonnull Tagger tagger);\n+\n+    public abstract Builder setStats(@Nonnull StatsRecorder stats);\n+\n+    public abstract Builder setStatsAttributes(@Nonnull Map<TagKey, TagValue> statsAttributes);\n+\n+    public abstract Tagger getTagger();", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 877b77b7..f3eb0ef1 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -18,7 +18,6 @@ package com.google.cloud.bigtable.data.v2.stub.metrics;\n import com.google.api.core.InternalApi;\n import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n-import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1NjYyOA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534256628", "bodyText": "Unless I;m mistaken, this shouldnt be necessary, autovalue should do null checks for all properties that arent marked Nullable", "author": "igorbernstein2", "createdAt": "2020-12-02T15:28:15Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import io.grpc.Metadata;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@InternalApi\n+@AutoValue\n+public abstract class HeaderTracer {\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  public static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @AutoValue.Builder\n+  public abstract static class Builder {\n+    // <editor-fold desc=\"Public API\">\n+    public abstract Builder setTagger(@Nonnull Tagger tagger);\n+\n+    public abstract Builder setStats(@Nonnull StatsRecorder stats);\n+\n+    public abstract Builder setStatsAttributes(@Nonnull Map<TagKey, TagValue> statsAttributes);\n+\n+    public abstract Tagger getTagger();\n+\n+    public abstract StatsRecorder getStats();\n+\n+    public abstract Map<TagKey, TagValue> getStatsAttributes();\n+\n+    abstract HeaderTracer autoBuild();\n+\n+    public HeaderTracer build() {\n+      HeaderTracer headerTracer = autoBuild();\n+      Preconditions.checkNotNull(headerTracer.getStats(), \"StatsRecorder must be set\");\n+      Preconditions.checkNotNull(headerTracer.getTagger(), \"Tagger must be set\");\n+      Preconditions.checkNotNull(headerTracer.getStatsAttributes(), \"Stats attributes must be set\");", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 877b77b7..f3eb0ef1 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -18,7 +18,6 @@ package com.google.cloud.bigtable.data.v2.stub.metrics;\n import com.google.api.core.InternalApi;\n import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n-import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI1OTQxMA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534259410", "bodyText": "Please add a comment as to when spanName might be null. Its a bit surprising to me", "author": "igorbernstein2", "createdAt": "2020-12-02T15:31:28Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.auto.value.AutoValue;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Preconditions;\n+import io.grpc.Metadata;\n+import io.opencensus.stats.MeasureMap;\n+import io.opencensus.stats.Stats;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagContextBuilder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import io.opencensus.tags.Tags;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+@InternalApi\n+@AutoValue\n+public abstract class HeaderTracer {\n+\n+  public static final Metadata.Key<String> SERVER_TIMING_HEADER_KEY =\n+      Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER);\n+  public static final Pattern SERVER_TIMING_HEADER_PATTERN = Pattern.compile(\".*dur=(?<dur>\\\\d+)\");\n+\n+  @AutoValue.Builder\n+  public abstract static class Builder {\n+    // <editor-fold desc=\"Public API\">\n+    public abstract Builder setTagger(@Nonnull Tagger tagger);\n+\n+    public abstract Builder setStats(@Nonnull StatsRecorder stats);\n+\n+    public abstract Builder setStatsAttributes(@Nonnull Map<TagKey, TagValue> statsAttributes);\n+\n+    public abstract Tagger getTagger();\n+\n+    public abstract StatsRecorder getStats();\n+\n+    public abstract Map<TagKey, TagValue> getStatsAttributes();\n+\n+    abstract HeaderTracer autoBuild();\n+\n+    public HeaderTracer build() {\n+      HeaderTracer headerTracer = autoBuild();\n+      Preconditions.checkNotNull(headerTracer.getStats(), \"StatsRecorder must be set\");\n+      Preconditions.checkNotNull(headerTracer.getTagger(), \"Tagger must be set\");\n+      Preconditions.checkNotNull(headerTracer.getStatsAttributes(), \"Stats attributes must be set\");\n+      return headerTracer;\n+    }\n+    // </editor-fold>\n+  }\n+\n+  public abstract Tagger getTagger();\n+\n+  public abstract StatsRecorder getStats();\n+\n+  public abstract Map<TagKey, TagValue> getStatsAttributes();\n+\n+  public void recordGfeMetrics(@Nonnull Metadata metadata, String spanName) {", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\nindex 877b77b7..f3eb0ef1 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracer.java\n\n@@ -18,7 +18,6 @@ package com.google.cloud.bigtable.data.v2.stub.metrics;\n import com.google.api.core.InternalApi;\n import com.google.auto.value.AutoValue;\n import com.google.common.base.MoreObjects;\n-import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import io.opencensus.stats.MeasureMap;\n import io.opencensus.stats.Stats;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MDMzNQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534260335", "bodyText": "I think these should be final", "author": "igorbernstein2", "createdAt": "2020-12-02T15:32:37Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.api.gax.grpc.GrpcResponseMetadata;\n+import com.google.api.gax.rpc.ApiCallContext;\n+import com.google.api.gax.rpc.ResponseObserver;\n+import com.google.api.gax.rpc.ServerStreamingCallable;\n+import com.google.api.gax.rpc.StreamController;\n+import io.grpc.Metadata;\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Record GFE metrics.\n+ *\n+ * <p>This class is considered an internal implementation detail and not meant to be used by\n+ * applications.\n+ */\n+@InternalApi\n+public class HeaderTracerStreamingCallable<RequestT, ResponseT>\n+    extends ServerStreamingCallable<RequestT, ResponseT> {\n+\n+  private ServerStreamingCallable<RequestT, ResponseT> innerCallable;", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\nindex 7f6194f7..8c5932f9 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n\n@@ -21,11 +21,20 @@ import com.google.api.gax.rpc.ApiCallContext;\n import com.google.api.gax.rpc.ResponseObserver;\n import com.google.api.gax.rpc.ServerStreamingCallable;\n import com.google.api.gax.rpc.StreamController;\n+import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import javax.annotation.Nonnull;\n \n /**\n- * Record GFE metrics.\n+ * This callable will inject a {@link GrpcResponseMetadata} to access the headers and trailers\n+ * returned by gRPC methods upon completion. The {@link HeaderTracer} will process metrics that were\n+ * injected in the header/trailer and publish them to OpenCensus. If {@link\n+ * GrpcResponseMetadata#getMetadata()} returned null, it probably means that the request has never\n+ * reached GFE, and it'll increment the gfe_header_missing_counter in this case.\n+ *\n+ * <p>If GFE metrics are not registered in {@link RpcViews}, skip injecting GrpcResponseMetadata.\n+ * This is for the case where direct path is enabled, all the requests won't go through GFE and\n+ * therefore won't have the server-timing header.\n  *\n  * <p>This class is considered an internal implementation detail and not meant to be used by\n  * applications.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MDU4OQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534260589", "bodyText": "Precondition checks would be good here", "author": "igorbernstein2", "createdAt": "2020-12-02T15:32:56Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.api.gax.grpc.GrpcResponseMetadata;\n+import com.google.api.gax.rpc.ApiCallContext;\n+import com.google.api.gax.rpc.ResponseObserver;\n+import com.google.api.gax.rpc.ServerStreamingCallable;\n+import com.google.api.gax.rpc.StreamController;\n+import io.grpc.Metadata;\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Record GFE metrics.\n+ *\n+ * <p>This class is considered an internal implementation detail and not meant to be used by\n+ * applications.\n+ */\n+@InternalApi\n+public class HeaderTracerStreamingCallable<RequestT, ResponseT>\n+    extends ServerStreamingCallable<RequestT, ResponseT> {\n+\n+  private ServerStreamingCallable<RequestT, ResponseT> innerCallable;\n+  private HeaderTracer headerTracer;\n+  private String spanName;\n+\n+  public HeaderTracerStreamingCallable(\n+      @Nonnull ServerStreamingCallable<RequestT, ResponseT> callable,\n+      @Nonnull HeaderTracer headerTracer,\n+      @Nonnull String spanName) {\n+    this.innerCallable = callable;", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\nindex 7f6194f7..8c5932f9 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n\n@@ -21,11 +21,20 @@ import com.google.api.gax.rpc.ApiCallContext;\n import com.google.api.gax.rpc.ResponseObserver;\n import com.google.api.gax.rpc.ServerStreamingCallable;\n import com.google.api.gax.rpc.StreamController;\n+import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import javax.annotation.Nonnull;\n \n /**\n- * Record GFE metrics.\n+ * This callable will inject a {@link GrpcResponseMetadata} to access the headers and trailers\n+ * returned by gRPC methods upon completion. The {@link HeaderTracer} will process metrics that were\n+ * injected in the header/trailer and publish them to OpenCensus. If {@link\n+ * GrpcResponseMetadata#getMetadata()} returned null, it probably means that the request has never\n+ * reached GFE, and it'll increment the gfe_header_missing_counter in this case.\n+ *\n+ * <p>If GFE metrics are not registered in {@link RpcViews}, skip injecting GrpcResponseMetadata.\n+ * This is for the case where direct path is enabled, all the requests won't go through GFE and\n+ * therefore won't have the server-timing header.\n  *\n  * <p>This class is considered an internal implementation detail and not meant to be used by\n  * applications.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MzE5MA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534263190", "bodyText": "Please add a comment as to what this does. It will be helpful for future maintainers..Something like:\nThis callable will inject GrpcResponseMetadata into the ApiCallOptions. Upon rpc completion, gax will inject grpc trailers into this class. The trailers will then be processed by HeaderTracer", "author": "igorbernstein2", "createdAt": "2020-12-02T15:36:04Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.InternalApi;\n+import com.google.api.gax.grpc.GrpcResponseMetadata;\n+import com.google.api.gax.rpc.ApiCallContext;\n+import com.google.api.gax.rpc.ResponseObserver;\n+import com.google.api.gax.rpc.ServerStreamingCallable;\n+import com.google.api.gax.rpc.StreamController;\n+import io.grpc.Metadata;\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Record GFE metrics.\n+ *\n+ * <p>This class is considered an internal implementation detail and not meant to be used by\n+ * applications.\n+ */\n+@InternalApi", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NTM4Mw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534265383", "bodyText": "Also, can you add the new internal api classes to this exclusion list:\nhttps://github.com/googleapis/java-bigtable/blob/master/pom.xml#L252", "author": "igorbernstein2", "createdAt": "2020-12-02T15:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5NDYzMQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r535494631", "bodyText": "Good to know! In this case my classes were added under metrics so I think it's covered by: https://github.com/googleapis/java-bigtable/blob/master/pom.xml#L285", "author": "mutianf", "createdAt": "2020-12-03T18:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MzE5MA=="}], "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\nindex 7f6194f7..8c5932f9 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerStreamingCallable.java\n\n@@ -21,11 +21,20 @@ import com.google.api.gax.rpc.ApiCallContext;\n import com.google.api.gax.rpc.ResponseObserver;\n import com.google.api.gax.rpc.ServerStreamingCallable;\n import com.google.api.gax.rpc.StreamController;\n+import com.google.common.base.Preconditions;\n import io.grpc.Metadata;\n import javax.annotation.Nonnull;\n \n /**\n- * Record GFE metrics.\n+ * This callable will inject a {@link GrpcResponseMetadata} to access the headers and trailers\n+ * returned by gRPC methods upon completion. The {@link HeaderTracer} will process metrics that were\n+ * injected in the header/trailer and publish them to OpenCensus. If {@link\n+ * GrpcResponseMetadata#getMetadata()} returned null, it probably means that the request has never\n+ * reached GFE, and it'll increment the gfe_header_missing_counter in this case.\n+ *\n+ * <p>If GFE metrics are not registered in {@link RpcViews}, skip injecting GrpcResponseMetadata.\n+ * This is for the case where direct path is enabled, all the requests won't go through GFE and\n+ * therefore won't have the server-timing header.\n  *\n  * <p>This class is considered an internal implementation detail and not meant to be used by\n  * applications.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NDE3NQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534264175", "bodyText": "similar to above", "author": "igorbernstein2", "createdAt": "2020-12-02T15:37:07Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerUnaryCallable.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import com.google.api.core.ApiFuture;\n+import com.google.api.core.InternalApi;\n+import com.google.api.gax.grpc.GrpcResponseMetadata;\n+import com.google.api.gax.rpc.ApiCallContext;\n+import com.google.api.gax.rpc.UnaryCallable;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import io.grpc.Metadata;\n+\n+/**\n+ * Record GFE metrics.\n+ *\n+ * <p>This class is considered an internal implementation detail and not meant to be used by\n+ * applications.", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerUnaryCallable.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerUnaryCallable.java\nindex 0190878d..9ea28e8f 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerUnaryCallable.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerUnaryCallable.java\n\n@@ -20,11 +20,21 @@ import com.google.api.core.InternalApi;\n import com.google.api.gax.grpc.GrpcResponseMetadata;\n import com.google.api.gax.rpc.ApiCallContext;\n import com.google.api.gax.rpc.UnaryCallable;\n+import com.google.common.base.Preconditions;\n import com.google.common.util.concurrent.MoreExecutors;\n import io.grpc.Metadata;\n+import javax.annotation.Nonnull;\n \n /**\n- * Record GFE metrics.\n+ * This callable will inject a {@link GrpcResponseMetadata} to access the headers and trailers\n+ * returned by gRPC methods upon completion. The {@link HeaderTracer} will process metrics that were\n+ * injected in the header/trailer and publish them to OpenCensus. If {@link\n+ * GrpcResponseMetadata#getMetadata()} returned null, it probably means that the request has never\n+ * reached GFE, and it'll increment the gfe_header_missing_counter in this case.\n+ *\n+ * <p>If GFE metrics are not registered in {@link RpcViews}, skip injecting GrpcResponseMetadata.\n+ * This is for the case where direct path is enabled, all the requests won't go through GFE and\n+ * therefore won't have the server-timing header.\n  *\n  * <p>This class is considered an internal implementation detail and not meant to be used by\n  * applications.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NjM2MA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534266360", "bodyText": "This description is meant for end users who don't really know what t4t7 latency means. Can you reword this a bit?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:39:44Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java", "diffHunk": "@@ -124,4 +128,22 @@\n               BIGTABLE_APP_PROFILE_ID,\n               BIGTABLE_OP,\n               BIGTABLE_STATUS));\n+\n+  static final View BIGTABLE_GFE_LATENCY_VIEW =\n+      View.create(\n+          View.Name.create(\"cloud.google.com/java/bigtable/gfe_latency\"),\n+          \"GFE t4t7 latency in msecs\",", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\nindex e84c9e7a..84aa6355 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n\n@@ -132,7 +132,7 @@ class RpcViewConstants {\n   static final View BIGTABLE_GFE_LATENCY_VIEW =\n       View.create(\n           View.Name.create(\"cloud.google.com/java/bigtable/gfe_latency\"),\n-          \"GFE t4t7 latency in msecs\",\n+          \"Latency between Google's network receives an RPC and reads back the first byte of the response\",\n           BIGTABLE_GFE_LATENCY,\n           AGGREGATION_WITH_MILLIS_HISTOGRAM,\n           ImmutableList.of(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2Njk2MQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534266961", "bodyText": "Can you add a note what this means? ie. that most likely the request never made it to the google's load balancers?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:40:28Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java", "diffHunk": "@@ -124,4 +128,22 @@\n               BIGTABLE_APP_PROFILE_ID,\n               BIGTABLE_OP,\n               BIGTABLE_STATUS));\n+\n+  static final View BIGTABLE_GFE_LATENCY_VIEW =\n+      View.create(\n+          View.Name.create(\"cloud.google.com/java/bigtable/gfe_latency\"),\n+          \"GFE t4t7 latency in msecs\",\n+          BIGTABLE_GFE_LATENCY,\n+          AGGREGATION_WITH_MILLIS_HISTOGRAM,\n+          ImmutableList.of(\n+              BIGTABLE_INSTANCE_ID, BIGTABLE_PROJECT_ID, BIGTABLE_APP_PROFILE_ID, BIGTABLE_OP));\n+\n+  static final View BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW =\n+      View.create(\n+          View.Name.create(\"cloud.google.com/java/bigtable/gfe_header_missing_count\"),\n+          \"Number of responses without the server-timing header\",", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\nindex e84c9e7a..84aa6355 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViewConstants.java\n\n@@ -132,7 +132,7 @@ class RpcViewConstants {\n   static final View BIGTABLE_GFE_LATENCY_VIEW =\n       View.create(\n           View.Name.create(\"cloud.google.com/java/bigtable/gfe_latency\"),\n-          \"GFE t4t7 latency in msecs\",\n+          \"Latency between Google's network receives an RPC and reads back the first byte of the response\",\n           BIGTABLE_GFE_LATENCY,\n           AGGREGATION_WITH_MILLIS_HISTOGRAM,\n           ImmutableList.of(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NzgwNQ==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534267805", "bodyText": "Please add a lot more docs explaining why you'd wanna do this. Also,@BetaApi", "author": "igorbernstein2", "createdAt": "2020-12-02T15:41:31Z", "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java", "diffHunk": "@@ -33,15 +33,32 @@\n           RpcViewConstants.BIGTABLE_ATTEMPT_LATENCY_VIEW,\n           RpcViewConstants.BIGTABLE_ATTEMPTS_PER_OP_VIEW);\n \n+  private static final ImmutableSet<View> GFE_VIEW_SET =\n+      ImmutableSet.of(\n+          RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+          RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW);\n+\n   /** Registers all Bigtable specific views. */\n   public static void registerBigtableClientViews() {\n     registerBigtableClientViews(Stats.getViewManager());\n   }\n \n+  /** Register views for GFE metrics. */", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5NTc0OA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r535495748", "bodyText": "RpcViews class is already marked with @BetaApi so I'm skipping adding it here", "author": "mutianf", "createdAt": "2020-12-03T18:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NzgwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\nindex 1623f597..9e8f6084 100644\n--- a/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\n+++ b/google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/metrics/RpcViews.java\n\n@@ -38,12 +38,19 @@ public class RpcViews {\n           RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n           RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW);\n \n+  private static boolean gfeMetricsRegistered = false;\n+\n   /** Registers all Bigtable specific views. */\n   public static void registerBigtableClientViews() {\n     registerBigtableClientViews(Stats.getViewManager());\n   }\n \n-  /** Register views for GFE metrics. */\n+  /**\n+   * Register views for GFE metrics, including gfe_latency and gfe_header_missing_count. gfe_latency\n+   * measures the latency between Google's network receives an RPC and reads back the first byte of\n+   * the response. gfe_header_missing_count is a counter of the number of RPC responses without a\n+   * server-timing header.\n+   */\n   public static void registerBigtableClientGfeViews() {\n     registerBigtableClientGfeViews(Stats.getViewManager());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2OTA0Nw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534269047", "bodyText": "I think this needs to be atomic because this is set by a test thread and read by a server thread. Otherwise the cpu cache line might not be flushed", "author": "igorbernstein2", "createdAt": "2020-12-02T15:43:09Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java", "diffHunk": "@@ -0,0 +1,461 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import com.google.api.gax.rpc.ClientContext;\n+import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.bigtable.v2.CheckAndMutateRowRequest;\n+import com.google.bigtable.v2.CheckAndMutateRowResponse;\n+import com.google.bigtable.v2.MutateRowRequest;\n+import com.google.bigtable.v2.MutateRowResponse;\n+import com.google.bigtable.v2.MutateRowsRequest;\n+import com.google.bigtable.v2.MutateRowsResponse;\n+import com.google.bigtable.v2.ReadModifyWriteRowRequest;\n+import com.google.bigtable.v2.ReadModifyWriteRowResponse;\n+import com.google.bigtable.v2.ReadRowsRequest;\n+import com.google.bigtable.v2.ReadRowsResponse;\n+import com.google.bigtable.v2.SampleRowKeysRequest;\n+import com.google.bigtable.v2.SampleRowKeysResponse;\n+import com.google.cloud.bigtable.data.v2.BigtableDataSettings;\n+import com.google.cloud.bigtable.data.v2.FakeServiceHelper;\n+import com.google.cloud.bigtable.data.v2.models.BulkMutation;\n+import com.google.cloud.bigtable.data.v2.models.ConditionalRowMutation;\n+import com.google.cloud.bigtable.data.v2.models.Mutation;\n+import com.google.cloud.bigtable.data.v2.models.Query;\n+import com.google.cloud.bigtable.data.v2.models.ReadModifyWriteRow;\n+import com.google.cloud.bigtable.data.v2.models.Row;\n+import com.google.cloud.bigtable.data.v2.models.RowCell;\n+import com.google.cloud.bigtable.data.v2.models.RowMutation;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStub;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStubSettings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.protobuf.ByteString;\n+import io.grpc.ForwardingServerCall.SimpleForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.stub.StreamObserver;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tags;\n+import java.util.Random;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Answers;\n+import org.mockito.Mock;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.mockito.stubbing.Answer;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerCallableTest {\n+  @Rule public MockitoRule mockitoRule = MockitoJUnit.rule();\n+\n+  private FakeServiceHelper serviceHelper;\n+  private FakeServiceHelper serviceHelperNoHeader;\n+\n+  @Mock(answer = Answers.CALLS_REAL_METHODS)\n+  private BigtableGrpc.BigtableImplBase fakeService;\n+\n+  private StatsComponent localStats = new StatsComponentImpl();\n+  private EnhancedBigtableStub stub;\n+  private EnhancedBigtableStub noHeaderStub;\n+\n+  private static final String PROJECT_ID = \"fake-project\";\n+  private static final String INSTANCE_ID = \"fake-instance\";\n+  private static final String APP_PROFILE_ID = \"default\";\n+  private static final String TABLE_ID = \"fake-table\";\n+\n+  private static final long WAIT_FOR_METRICS_TIME_MS = 1_000;\n+\n+  private int fakeServerTiming;", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\nindex 4bfa6649..9538b6a1 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n\n@@ -16,11 +16,11 @@\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n import static com.google.common.truth.Truth.assertThat;\n-import static org.mockito.Matchers.any;\n-import static org.mockito.Mockito.doAnswer;\n+import static org.junit.Assert.fail;\n \n import com.google.api.gax.rpc.ClientContext;\n-import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.api.gax.rpc.UnavailableException;\n+import com.google.bigtable.v2.BigtableGrpc.BigtableImplBase;\n import com.google.bigtable.v2.CheckAndMutateRowRequest;\n import com.google.bigtable.v2.CheckAndMutateRowResponse;\n import com.google.bigtable.v2.MutateRowRequest;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3MjAzNw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534272037", "bodyText": "Would you mind adding tests that ensure that the metric is incremented when server returns a non-ok status as well?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:46:41Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java", "diffHunk": "@@ -0,0 +1,461 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import com.google.api.gax.rpc.ClientContext;\n+import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.bigtable.v2.CheckAndMutateRowRequest;\n+import com.google.bigtable.v2.CheckAndMutateRowResponse;\n+import com.google.bigtable.v2.MutateRowRequest;\n+import com.google.bigtable.v2.MutateRowResponse;\n+import com.google.bigtable.v2.MutateRowsRequest;\n+import com.google.bigtable.v2.MutateRowsResponse;\n+import com.google.bigtable.v2.ReadModifyWriteRowRequest;\n+import com.google.bigtable.v2.ReadModifyWriteRowResponse;\n+import com.google.bigtable.v2.ReadRowsRequest;\n+import com.google.bigtable.v2.ReadRowsResponse;\n+import com.google.bigtable.v2.SampleRowKeysRequest;\n+import com.google.bigtable.v2.SampleRowKeysResponse;\n+import com.google.cloud.bigtable.data.v2.BigtableDataSettings;\n+import com.google.cloud.bigtable.data.v2.FakeServiceHelper;\n+import com.google.cloud.bigtable.data.v2.models.BulkMutation;\n+import com.google.cloud.bigtable.data.v2.models.ConditionalRowMutation;\n+import com.google.cloud.bigtable.data.v2.models.Mutation;\n+import com.google.cloud.bigtable.data.v2.models.Query;\n+import com.google.cloud.bigtable.data.v2.models.ReadModifyWriteRow;\n+import com.google.cloud.bigtable.data.v2.models.Row;\n+import com.google.cloud.bigtable.data.v2.models.RowCell;\n+import com.google.cloud.bigtable.data.v2.models.RowMutation;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStub;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStubSettings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.protobuf.ByteString;\n+import io.grpc.ForwardingServerCall.SimpleForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.stub.StreamObserver;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tags;\n+import java.util.Random;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Answers;\n+import org.mockito.Mock;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.mockito.stubbing.Answer;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerCallableTest {", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\nindex 4bfa6649..9538b6a1 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n\n@@ -16,11 +16,11 @@\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n import static com.google.common.truth.Truth.assertThat;\n-import static org.mockito.Matchers.any;\n-import static org.mockito.Mockito.doAnswer;\n+import static org.junit.Assert.fail;\n \n import com.google.api.gax.rpc.ClientContext;\n-import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.api.gax.rpc.UnavailableException;\n+import com.google.bigtable.v2.BigtableGrpc.BigtableImplBase;\n import com.google.bigtable.v2.CheckAndMutateRowRequest;\n import com.google.bigtable.v2.CheckAndMutateRowResponse;\n import com.google.bigtable.v2.MutateRowRequest;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3MjQ2MA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534272460", "bodyText": "final?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:47:14Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import java.util.Map;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Mockito;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerTest {\n+\n+  private StatsComponent localStats = new StatsComponentImpl();", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\nindex fb8457af..ec616d0e 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n\n@@ -36,12 +36,13 @@ public class HeaderTracerTest {\n   private StatsComponent localStats = new StatsComponentImpl();\n \n   @Test\n-  public void testEmptyBuilder() {\n+  public void testDefaultBuilder() {\n     HeaderTracer.Builder builder = HeaderTracer.newBuilder();\n-    assertThat(builder.getStats()).isNotNull();\n-    assertThat(builder.getTagger()).isNotNull();\n-    assertThat(builder.getStatsAttributes()).isNotNull();\n-    assertThat(builder.getStatsAttributes()).isEmpty();\n+    HeaderTracer tracer = builder.build();\n+    assertThat(tracer.getStats()).isNotNull();\n+    assertThat(tracer.getTagger()).isNotNull();\n+    assertThat(tracer.getStatsAttributes()).isNotNull();\n+    assertThat(tracer.getStatsAttributes()).isEmpty();\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3MjY2Mg==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534272662", "bodyText": "final?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:47:30Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java", "diffHunk": "@@ -0,0 +1,461 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import com.google.api.gax.rpc.ClientContext;\n+import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.bigtable.v2.CheckAndMutateRowRequest;\n+import com.google.bigtable.v2.CheckAndMutateRowResponse;\n+import com.google.bigtable.v2.MutateRowRequest;\n+import com.google.bigtable.v2.MutateRowResponse;\n+import com.google.bigtable.v2.MutateRowsRequest;\n+import com.google.bigtable.v2.MutateRowsResponse;\n+import com.google.bigtable.v2.ReadModifyWriteRowRequest;\n+import com.google.bigtable.v2.ReadModifyWriteRowResponse;\n+import com.google.bigtable.v2.ReadRowsRequest;\n+import com.google.bigtable.v2.ReadRowsResponse;\n+import com.google.bigtable.v2.SampleRowKeysRequest;\n+import com.google.bigtable.v2.SampleRowKeysResponse;\n+import com.google.cloud.bigtable.data.v2.BigtableDataSettings;\n+import com.google.cloud.bigtable.data.v2.FakeServiceHelper;\n+import com.google.cloud.bigtable.data.v2.models.BulkMutation;\n+import com.google.cloud.bigtable.data.v2.models.ConditionalRowMutation;\n+import com.google.cloud.bigtable.data.v2.models.Mutation;\n+import com.google.cloud.bigtable.data.v2.models.Query;\n+import com.google.cloud.bigtable.data.v2.models.ReadModifyWriteRow;\n+import com.google.cloud.bigtable.data.v2.models.Row;\n+import com.google.cloud.bigtable.data.v2.models.RowCell;\n+import com.google.cloud.bigtable.data.v2.models.RowMutation;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStub;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStubSettings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.protobuf.ByteString;\n+import io.grpc.ForwardingServerCall.SimpleForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.stub.StreamObserver;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tags;\n+import java.util.Random;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Answers;\n+import org.mockito.Mock;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.mockito.stubbing.Answer;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerCallableTest {\n+  @Rule public MockitoRule mockitoRule = MockitoJUnit.rule();", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\nindex 4bfa6649..9538b6a1 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n\n@@ -16,11 +16,11 @@\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n import static com.google.common.truth.Truth.assertThat;\n-import static org.mockito.Matchers.any;\n-import static org.mockito.Mockito.doAnswer;\n+import static org.junit.Assert.fail;\n \n import com.google.api.gax.rpc.ClientContext;\n-import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.api.gax.rpc.UnavailableException;\n+import com.google.bigtable.v2.BigtableGrpc.BigtableImplBase;\n import com.google.bigtable.v2.CheckAndMutateRowRequest;\n import com.google.bigtable.v2.CheckAndMutateRowResponse;\n import com.google.bigtable.v2.MutateRowRequest;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3NDQzOA==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534274438", "bodyText": "I think this is a personal taste thing, but why go through mockito for this? Wouldnt it be simpler to just implement a fake BigtableImplBase?", "author": "igorbernstein2", "createdAt": "2020-12-02T15:49:46Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java", "diffHunk": "@@ -0,0 +1,461 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import com.google.api.gax.rpc.ClientContext;\n+import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.bigtable.v2.CheckAndMutateRowRequest;\n+import com.google.bigtable.v2.CheckAndMutateRowResponse;\n+import com.google.bigtable.v2.MutateRowRequest;\n+import com.google.bigtable.v2.MutateRowResponse;\n+import com.google.bigtable.v2.MutateRowsRequest;\n+import com.google.bigtable.v2.MutateRowsResponse;\n+import com.google.bigtable.v2.ReadModifyWriteRowRequest;\n+import com.google.bigtable.v2.ReadModifyWriteRowResponse;\n+import com.google.bigtable.v2.ReadRowsRequest;\n+import com.google.bigtable.v2.ReadRowsResponse;\n+import com.google.bigtable.v2.SampleRowKeysRequest;\n+import com.google.bigtable.v2.SampleRowKeysResponse;\n+import com.google.cloud.bigtable.data.v2.BigtableDataSettings;\n+import com.google.cloud.bigtable.data.v2.FakeServiceHelper;\n+import com.google.cloud.bigtable.data.v2.models.BulkMutation;\n+import com.google.cloud.bigtable.data.v2.models.ConditionalRowMutation;\n+import com.google.cloud.bigtable.data.v2.models.Mutation;\n+import com.google.cloud.bigtable.data.v2.models.Query;\n+import com.google.cloud.bigtable.data.v2.models.ReadModifyWriteRow;\n+import com.google.cloud.bigtable.data.v2.models.Row;\n+import com.google.cloud.bigtable.data.v2.models.RowCell;\n+import com.google.cloud.bigtable.data.v2.models.RowMutation;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStub;\n+import com.google.cloud.bigtable.data.v2.stub.EnhancedBigtableStubSettings;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.protobuf.ByteString;\n+import io.grpc.ForwardingServerCall.SimpleForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.stub.StreamObserver;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tags;\n+import java.util.Random;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Answers;\n+import org.mockito.Mock;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.mockito.stubbing.Answer;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerCallableTest {\n+  @Rule public MockitoRule mockitoRule = MockitoJUnit.rule();\n+\n+  private FakeServiceHelper serviceHelper;\n+  private FakeServiceHelper serviceHelperNoHeader;\n+\n+  @Mock(answer = Answers.CALLS_REAL_METHODS)\n+  private BigtableGrpc.BigtableImplBase fakeService;\n+\n+  private StatsComponent localStats = new StatsComponentImpl();\n+  private EnhancedBigtableStub stub;\n+  private EnhancedBigtableStub noHeaderStub;\n+\n+  private static final String PROJECT_ID = \"fake-project\";\n+  private static final String INSTANCE_ID = \"fake-instance\";\n+  private static final String APP_PROFILE_ID = \"default\";\n+  private static final String TABLE_ID = \"fake-table\";\n+\n+  private static final long WAIT_FOR_METRICS_TIME_MS = 1_000;\n+\n+  private int fakeServerTiming;\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    RpcViews.registerBigtableClientGfeViews(localStats.getViewManager());\n+\n+    // Create a server that'll inject a server-timing header with a random number and a stub that\n+    // connects to this server.\n+    fakeServerTiming = new Random().nextInt(1000) + 1;\n+    serviceHelper =\n+        new FakeServiceHelper(\n+            new ServerInterceptor() {\n+              @Override\n+              public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(\n+                  ServerCall<ReqT, RespT> serverCall,\n+                  Metadata metadata,\n+                  ServerCallHandler<ReqT, RespT> serverCallHandler) {\n+                return serverCallHandler.startCall(\n+                    new SimpleForwardingServerCall<ReqT, RespT>(serverCall) {\n+                      @Override\n+                      public void sendHeaders(Metadata headers) {\n+                        headers.put(\n+                            Metadata.Key.of(\"server-timing\", Metadata.ASCII_STRING_MARSHALLER),\n+                            String.format(\"gfet4t7; dur=%d\", fakeServerTiming));\n+                        super.sendHeaders(headers);\n+                      }\n+                    },\n+                    metadata);\n+              }\n+            },\n+            fakeService);\n+    serviceHelper.start();\n+\n+    BigtableDataSettings settings =\n+        BigtableDataSettings.newBuilderForEmulator(serviceHelper.getPort())\n+            .setProjectId(PROJECT_ID)\n+            .setInstanceId(INSTANCE_ID)\n+            .setAppProfileId(APP_PROFILE_ID)\n+            .build();\n+    EnhancedBigtableStubSettings stubSettings =\n+        EnhancedBigtableStub.finalizeSettings(\n+            settings.getStubSettings(), Tags.getTagger(), localStats.getStatsRecorder());\n+    stub = new EnhancedBigtableStub(stubSettings, ClientContext.create(stubSettings));\n+\n+    // Create another server without injecting the server-timing header and another stub that\n+    // connects to it.\n+    serviceHelperNoHeader = new FakeServiceHelper(fakeService);\n+    serviceHelperNoHeader.start();\n+\n+    BigtableDataSettings noHeaderSettings =\n+        BigtableDataSettings.newBuilderForEmulator(serviceHelperNoHeader.getPort())\n+            .setProjectId(PROJECT_ID)\n+            .setInstanceId(INSTANCE_ID)\n+            .setAppProfileId(APP_PROFILE_ID)\n+            .build();\n+    EnhancedBigtableStubSettings noHeaderStubSettings =\n+        EnhancedBigtableStub.finalizeSettings(\n+            noHeaderSettings.getStubSettings(), Tags.getTagger(), localStats.getStatsRecorder());\n+    noHeaderStub =\n+        new EnhancedBigtableStub(noHeaderStubSettings, ClientContext.create(noHeaderStubSettings));\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    stub.close();\n+    noHeaderStub.close();\n+    serviceHelper.shutdown();\n+    serviceHelperNoHeader.shutdown();\n+  }\n+\n+  @Test\n+  public void testGFELatencyMetricReadRows() throws InterruptedException {\n+    doAnswer(new ReadRowsAnswer())\n+        .when(fakeService)\n+        .readRows(any(ReadRowsRequest.class), anyObserver(ReadRowsResponse.class));\n+\n+    stub.readRowsCallable().call(Query.create(TABLE_ID));\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.<TagKey, TagValue>of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.ReadRows\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFELatencyMetricMutateRow() throws InterruptedException {\n+    doAnswer(new MutateRowAnswer())\n+        .when(fakeService)\n+        .mutateRow(any(MutateRowRequest.class), anyObserver(MutateRowResponse.class));\n+\n+    stub.mutateRowCallable().call(RowMutation.create(TABLE_ID, \"fake-key\"));\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.of(RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.MutateRow\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFELatencyMetricMutateRows() throws InterruptedException {\n+    doAnswer(new MutateRowsAnswer())\n+        .when(fakeService)\n+        .mutateRows(any(MutateRowsRequest.class), anyObserver(MutateRowsResponse.class));\n+\n+    BulkMutation mutations =\n+        BulkMutation.create(TABLE_ID)\n+            .add(\"key\", Mutation.create().setCell(\"fake-family\", \"fake-qualifier\", \"fake-value\"));\n+    stub.bulkMutateRowsCallable().call(mutations);\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.MutateRows\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFELatencySampleRowKeys() throws InterruptedException {\n+    doAnswer(new SampleRowKeysAnswer())\n+        .when(fakeService)\n+        .sampleRowKeys(any(SampleRowKeysRequest.class), anyObserver(SampleRowKeysResponse.class));\n+    stub.sampleRowKeysCallable().call(TABLE_ID);\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.SampleRowKeys\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFELatencyCheckAndMutateRow() throws InterruptedException {\n+    doAnswer(new CheckAndMutateRowAnswer())\n+        .when(fakeService)\n+        .checkAndMutateRow(\n+            any(CheckAndMutateRowRequest.class), anyObserver(CheckAndMutateRowResponse.class));\n+\n+    ConditionalRowMutation mutation =\n+        ConditionalRowMutation.create(TABLE_ID, \"fake-key\")\n+            .then(Mutation.create().setCell(\"fake-family\", \"fake-qualifier\", \"fake-value\"));\n+    stub.checkAndMutateRowCallable().call(mutation);\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.CheckAndMutateRow\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFELatencyReadModifyWriteRow() throws InterruptedException {\n+    doAnswer(new ReadModifyWriteRowAnswer())\n+        .when(fakeService)\n+        .readModifyWriteRow(\n+            any(ReadModifyWriteRowRequest.class), anyObserver(ReadModifyWriteRowResponse.class));\n+\n+    ReadModifyWriteRow request =\n+        ReadModifyWriteRow.create(TABLE_ID, \"fake-key\")\n+            .append(\"fake-family\", \"fake-qualifier\", \"suffix\");\n+    stub.readModifyWriteRowCallable().call(request);\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+    long latency =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_LATENCY_VIEW,\n+            ImmutableMap.of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.ReadModifyWriteRow\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+    assertThat(latency).isEqualTo(fakeServerTiming);\n+  }\n+\n+  @Test\n+  public void testGFEMissingHeaderMetric() throws InterruptedException {\n+    doAnswer(new ReadRowsAnswer())\n+        .when(fakeService)\n+        .readRows(any(ReadRowsRequest.class), anyObserver(ReadRowsResponse.class));\n+    doAnswer(new MutateRowAnswer())\n+        .when(fakeService)\n+        .mutateRow(any(MutateRowRequest.class), anyObserver(MutateRowResponse.class));\n+\n+    // Make a few calls to the server which will inject the server-timing header and the counter\n+    // should be 0.\n+    stub.readRowsCallable().call(Query.create(TABLE_ID));\n+    stub.mutateRowCallable().call(RowMutation.create(TABLE_ID, \"key\"));\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+    long mutateRowMissingCount =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW,\n+            ImmutableMap.of(RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.MutateRow\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+    long readRowsMissingCount =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW,\n+            ImmutableMap.<TagKey, TagValue>of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.ReadRows\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+\n+    assertThat(mutateRowMissingCount).isEqualTo(0);\n+    assertThat(readRowsMissingCount).isEqualTo(0);\n+\n+    // Make a few more calls to the server which won't add the header and the counter should match\n+    // the number of requests sent.\n+    int readRowsCalls = new Random().nextInt(10) + 1;\n+    int mutateRowCalls = new Random().nextInt(10) + 1;\n+    for (int i = 0; i < mutateRowCalls; i++) {\n+      noHeaderStub.mutateRowCallable().call(RowMutation.create(TABLE_ID, \"fake-key\" + i));\n+    }\n+    for (int i = 0; i < readRowsCalls; i++) {\n+      noHeaderStub.readRowsCallable().call(Query.create(TABLE_ID));\n+    }\n+\n+    Thread.sleep(WAIT_FOR_METRICS_TIME_MS);\n+\n+    mutateRowMissingCount =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW,\n+            ImmutableMap.of(RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.MutateRow\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+    readRowsMissingCount =\n+        StatsTestUtils.getAggregationValueAsLong(\n+            localStats,\n+            RpcViewConstants.BIGTABLE_GFE_HEADER_MISSING_COUNT_VIEW,\n+            ImmutableMap.<TagKey, TagValue>of(\n+                RpcMeasureConstants.BIGTABLE_OP, TagValue.create(\"Bigtable.ReadRows\")),\n+            PROJECT_ID,\n+            INSTANCE_ID,\n+            APP_PROFILE_ID);\n+\n+    assertThat(mutateRowMissingCount).isEqualTo(mutateRowCalls);\n+    assertThat(readRowsMissingCount).isEqualTo(readRowsCalls);\n+  }\n+\n+  private class ReadRowAnswer implements Answer {", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\nindex 4bfa6649..9538b6a1 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerCallableTest.java\n\n@@ -16,11 +16,11 @@\n package com.google.cloud.bigtable.data.v2.stub.metrics;\n \n import static com.google.common.truth.Truth.assertThat;\n-import static org.mockito.Matchers.any;\n-import static org.mockito.Mockito.doAnswer;\n+import static org.junit.Assert.fail;\n \n import com.google.api.gax.rpc.ClientContext;\n-import com.google.bigtable.v2.BigtableGrpc;\n+import com.google.api.gax.rpc.UnavailableException;\n+import com.google.bigtable.v2.BigtableGrpc.BigtableImplBase;\n import com.google.bigtable.v2.CheckAndMutateRowRequest;\n import com.google.bigtable.v2.CheckAndMutateRowResponse;\n import com.google.bigtable.v2.MutateRowRequest;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3NDkyMw==", "url": "https://github.com/googleapis/java-bigtable/pull/535#discussion_r534274923", "bodyText": "nit. testDefaultBuilder()", "author": "igorbernstein2", "createdAt": "2020-12-02T15:50:20Z", "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.bigtable.data.v2.stub.metrics;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.opencensus.impl.stats.StatsComponentImpl;\n+import io.opencensus.stats.StatsComponent;\n+import io.opencensus.stats.StatsRecorder;\n+import io.opencensus.tags.TagKey;\n+import io.opencensus.tags.TagValue;\n+import io.opencensus.tags.Tagger;\n+import java.util.Map;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+import org.mockito.Mockito;\n+\n+@RunWith(JUnit4.class)\n+public class HeaderTracerTest {\n+\n+  private StatsComponent localStats = new StatsComponentImpl();\n+\n+  @Test\n+  public void testEmptyBuilder() {", "originalCommit": "8ee3b64a1bf454d6afdfeaf55324c00bec9a5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "chunk": "diff --git a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\nindex fb8457af..ec616d0e 100644\n--- a/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n+++ b/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/stub/metrics/HeaderTracerTest.java\n\n@@ -36,12 +36,13 @@ public class HeaderTracerTest {\n   private StatsComponent localStats = new StatsComponentImpl();\n \n   @Test\n-  public void testEmptyBuilder() {\n+  public void testDefaultBuilder() {\n     HeaderTracer.Builder builder = HeaderTracer.newBuilder();\n-    assertThat(builder.getStats()).isNotNull();\n-    assertThat(builder.getTagger()).isNotNull();\n-    assertThat(builder.getStatsAttributes()).isNotNull();\n-    assertThat(builder.getStatsAttributes()).isEmpty();\n+    HeaderTracer tracer = builder.build();\n+    assertThat(tracer.getStats()).isNotNull();\n+    assertThat(tracer.getTagger()).isNotNull();\n+    assertThat(tracer.getStatsAttributes()).isNotNull();\n+    assertThat(tracer.getStatsAttributes()).isEmpty();\n   }\n \n   @Test\n"}}, {"oid": "797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "url": "https://github.com/googleapis/java-bigtable/commit/797e9b2ff0333fd5e4d3cae27937737ae709e3f8", "message": "Improve documents, changes for directPath and more tests", "committedDate": "2020-12-03T18:48:48Z", "type": "commit"}, {"oid": "125587f11974b6ad7cc96389111116a736376eac", "url": "https://github.com/googleapis/java-bigtable/commit/125587f11974b6ad7cc96389111116a736376eac", "message": "Merge branch 'master' into gfe-metrics", "committedDate": "2020-12-03T18:49:40Z", "type": "commit"}, {"oid": "20ec8d6bd0fdb8df8dc27265606986a07abca661", "url": "https://github.com/googleapis/java-bigtable/commit/20ec8d6bd0fdb8df8dc27265606986a07abca661", "message": "Small fixes in the doc", "committedDate": "2020-12-03T19:07:38Z", "type": "commit"}, {"oid": "757d12b3d3735d02c8bddabf7fc7ac63ab82e02a", "url": "https://github.com/googleapis/java-bigtable/commit/757d12b3d3735d02c8bddabf7fc7ac63ab82e02a", "message": "small clean up", "committedDate": "2020-12-10T01:14:37Z", "type": "commit"}]}