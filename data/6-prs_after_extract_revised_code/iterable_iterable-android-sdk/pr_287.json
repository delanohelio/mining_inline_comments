{"pr_number": 287, "pr_title": "[MOB-2002] - Request Processor - Online", "pr_createdAt": "2020-11-25T22:51:50Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/287", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjMzNg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530682336", "bodyText": "Why did you remove email/userId/authToken?", "author": "vbabenkoru", "createdAt": "2020-11-25T22:53:12Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -429,14 +429,14 @@ public boolean isIterableIntent(@Nullable Intent intent) {\n      * @param deviceToken Push token obtained from GCM or FCM\n      */\n     public void registerDeviceToken(@NonNull String deviceToken) {\n-        registerDeviceToken(_email, _userId, _authToken, getPushIntegrationName(), deviceToken, deviceAttributes);\n+        registerDeviceToken(getPushIntegrationName(), deviceToken, deviceAttributes);\n     }\n \n-    protected void registerDeviceToken(final @Nullable String email, final @Nullable String userId, final @Nullable String authToken, final @NonNull String applicationName, final @NonNull String deviceToken, final HashMap<String, String> deviceAttributes) {", "originalCommit": "d9c5be040ad79b59de7d56b760f7430523e7d098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NjI0NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530686245", "bodyText": "I am thinking, now that we have authProvider, why not make only requestProcessor take email, userID and auth from that interface.\nAlso noticed that\n\npublic method only takes token.\nwe already have email, userId set before calling registerForPush\n\nAlthough not sure why the line 435 method is protected.", "author": "Ayyanchira", "createdAt": "2020-11-25T23:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY5MDQ0Nw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530690447", "bodyText": "Hmm.. we should have regression tests for these. Basically, the reason we're passing email, userId and authToken here is because getting a token is asynchronous. By the time we get the token, the user identifiers might've changed.\nExample:\n\nYou set email to null\nIt calls disableDevice to disable the token for the logged out user\nIf we pass the current email/userId/authToken and then set email to null, we'll be able to call disableDevice with old auth even though the current one is all null\nIf we don't store the auth with the token request, it will get the current auth info from authProvider, which is already null, and will fail to disable the device.", "author": "vbabenkoru", "createdAt": "2020-11-25T23:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczNDEzMw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530734133", "bodyText": "Added an integration/regression test here: #288.", "author": "vbabenkoru", "createdAt": "2020-11-26T02:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjMzNg=="}], "type": "inlineReview", "revised_code": {"commit": "d0aa49ed94d667c9461fe720aacaa0687b4d8db1", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex c3b1d46..e9f1890 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -429,14 +429,14 @@ private static final String TAG = \"IterableApi\";\n      * @param deviceToken Push token obtained from GCM or FCM\n      */\n     public void registerDeviceToken(@NonNull String deviceToken) {\n-        registerDeviceToken(getPushIntegrationName(), deviceToken, deviceAttributes);\n+        registerDeviceToken(_email, _userId, _authToken, getPushIntegrationName(), deviceToken, deviceAttributes);\n     }\n \n-    protected void registerDeviceToken(final @NonNull String applicationName, final @NonNull String deviceToken, final HashMap<String, String> deviceAttributes) {\n+    protected void registerDeviceToken(final @Nullable String email, final @Nullable String userId, final @Nullable String authToken, final @NonNull String applicationName, final @NonNull String deviceToken, final HashMap<String, String> deviceAttributes) {\n         if (deviceToken != null) {\n             final Thread registrationThread = new Thread(new Runnable() {\n                 public void run() {\n-                    registerDeviceToken(applicationName, deviceToken, null, deviceAttributes);\n+                    registerDeviceToken(email, userId, authToken, applicationName, deviceToken, null, deviceAttributes);\n                 }\n             });\n             registrationThread.start();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjU1MQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530682551", "bodyText": "Do we need to create the request processor every time?", "author": "vbabenkoru", "createdAt": "2020-11-25T22:54:03Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApiClient.java", "diffHunk": "@@ -473,20 +473,12 @@ void tryAddArrayToJSON(JSONObject requestJSON, String key, Object[] value) {\n      * @param json\n      */\n     void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json) {\n-        sendPostRequest(resourcePath, json, authProvider.getAuthToken());\n-    }\n-\n-    void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable String authToken) {\n-        sendPostRequest(resourcePath, json, authToken, null, null);\n+        sendPostRequest(resourcePath, json, null, null);\n     }\n \n     void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable IterableHelper.SuccessHandler onSuccess, @Nullable IterableHelper.FailureHandler onFailure) {\n-        sendPostRequest(resourcePath, json, authProvider.getAuthToken(), onSuccess, onFailure);\n-    }\n-\n-    void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable String authToken, @Nullable IterableHelper.SuccessHandler onSuccess, @Nullable IterableHelper.FailureHandler onFailure) {\n-        IterableApiRequest request = new IterableApiRequest(authProvider.getApiKey(), resourcePath, json, IterableApiRequest.POST, authToken, onSuccess, onFailure);\n-        new IterableRequest().execute(request);\n+        RequestProcessor requestProcessor = new OnlineRequestProcessor();", "originalCommit": "d9c5be040ad79b59de7d56b760f7430523e7d098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NDE3MQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r530684171", "bodyText": "For now... Once we take parameters from config whether its online or offline, apiclient can create corresponding global request processor.", "author": "Ayyanchira", "createdAt": "2020-11-25T22:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MjU1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0aa49ed94d667c9461fe720aacaa0687b4d8db1", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApiClient.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApiClient.java\nindex a13a1e1..976bcdf 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApiClient.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApiClient.java\n\n@@ -473,12 +473,16 @@ class IterableApiClient {\n      * @param json\n      */\n     void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json) {\n-        sendPostRequest(resourcePath, json, null, null);\n+        sendPostRequest(resourcePath, json, null, null, null);\n+    }\n+\n+    void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable String authToken) {\n+        sendPostRequest(resourcePath, json, authToken, null, null);\n     }\n \n-    void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable IterableHelper.SuccessHandler onSuccess, @Nullable IterableHelper.FailureHandler onFailure) {\n+    void sendPostRequest(@NonNull String resourcePath, @NonNull JSONObject json, @Nullable String authToken, @Nullable IterableHelper.SuccessHandler onSuccess, @Nullable IterableHelper.FailureHandler onFailure) {\n         RequestProcessor requestProcessor = new OnlineRequestProcessor();\n-        requestProcessor.processPostRequest(authProvider, resourcePath, json, onSuccess, onFailure);\n+        requestProcessor.processPostRequest(authProvider.getApiKey(), resourcePath, json, authToken, onSuccess, onFailure);\n     }\n \n     /**\n"}}, {"oid": "d0aa49ed94d667c9461fe720aacaa0687b4d8db1", "url": "https://github.com/Iterable/iterable-android-sdk/commit/d0aa49ed94d667c9461fe720aacaa0687b4d8db1", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T02:47:36Z", "type": "forcePushed"}, {"oid": "97aa0524c48e957420d25acf998dbf4d962a634a", "url": "https://github.com/Iterable/iterable-android-sdk/commit/97aa0524c48e957420d25acf998dbf4d962a634a", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T02:49:45Z", "type": "forcePushed"}, {"oid": "515be0a21058275ceeac15093f503015f7c68f8a", "url": "https://github.com/Iterable/iterable-android-sdk/commit/515be0a21058275ceeac15093f503015f7c68f8a", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T02:50:50Z", "type": "forcePushed"}, {"oid": "893ef7d7b41fbe344304b7a0d898629f8a6d5ae7", "url": "https://github.com/Iterable/iterable-android-sdk/commit/893ef7d7b41fbe344304b7a0d898629f8a6d5ae7", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T02:53:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4OTMzMw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r533789333", "bodyText": "Rebase on latest master and maybe drop the merge commit to drop this change from the PR", "author": "vbabenkoru", "createdAt": "2020-12-01T23:22:29Z", "path": "iterableapi/src/test/java/com/iterable/iterableapi/IterableApiIntegrationTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.iterable.iterableapi;\n+\n+import android.content.Context;\n+\n+import org.json.JSONObject;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.robolectric.shadows.ShadowPausedAsyncTask;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+\n+import okhttp3.mockwebserver.MockResponse;\n+import okhttp3.mockwebserver.MockWebServer;\n+import okhttp3.mockwebserver.RecordedRequest;\n+\n+import static android.os.Looper.getMainLooper;\n+import static junit.framework.Assert.assertEquals;\n+import static junit.framework.Assert.assertNotNull;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+public class IterableApiIntegrationTest extends BaseTest {", "originalCommit": "893ef7d7b41fbe344304b7a0d898629f8a6d5ae7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4OTQ2NA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/287#discussion_r533789464", "bodyText": "same, this should already be in master", "author": "vbabenkoru", "createdAt": "2020-12-01T23:22:50Z", "path": "iterableapi/src/test/java/com/iterable/iterableapi/IterableApiTest.java", "diffHunk": "@@ -50,6 +50,7 @@\n     private MockWebServer server;\n     private IterableApiClient originalApiClient;\n     private IterableApiClient mockApiClient;\n+    private IterablePushRegistration.IterablePushRegistrationImpl originalPushRegistrationImpl;", "originalCommit": "893ef7d7b41fbe344304b7a0d898629f8a6d5ae7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "777f5e43ef322e4293ee9bba4cd7578d38a0727c", "url": "https://github.com/Iterable/iterable-android-sdk/commit/777f5e43ef322e4293ee9bba4cd7578d38a0727c", "message": "[MOB-2002] - Request Processor - Online\n\n1. Introduced RequestProcessor interface\n2. Implemented OnlineRequestProcessor which now creates IterableRequest and executes it\n3. emails, userIds and authToken is now mainly fetched from authProvider from apiClient\n4. changed/removed method signature for internal methods which had authToken or passed emailId or userId around\n5  Changed IterablePushRegistration classes to accomodate authHandler changes\n6. Changes in test method to make it pass.", "committedDate": "2020-12-01T23:47:05Z", "type": "commit"}, {"oid": "c76949d59b22515a4e10698370bb187bfbd612c6", "url": "https://github.com/Iterable/iterable-android-sdk/commit/c76949d59b22515a4e10698370bb187bfbd612c6", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T23:47:05Z", "type": "commit"}, {"oid": "c76949d59b22515a4e10698370bb187bfbd612c6", "url": "https://github.com/Iterable/iterable-android-sdk/commit/c76949d59b22515a4e10698370bb187bfbd612c6", "message": "Revision 1\n\n1. Merged the test method branch\n2. Reverted the authhandler code", "committedDate": "2020-12-01T23:47:05Z", "type": "forcePushed"}]}