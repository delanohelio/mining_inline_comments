{"pr_number": 229, "pr_title": "[MOB-1424] InAppFragment improvements, delayed display", "pr_createdAt": "2020-05-07T02:17:22Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/229", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU1Ng==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421314556", "bodyText": "\ud83d\udc4c", "author": "Ayyanchira", "createdAt": "2020-05-07T08:02:41Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java", "diffHunk": "@@ -190,20 +192,27 @@ public void run() {\n         if (savedInstanceState == null || !savedInstanceState.getBoolean(INAPP_OPEN_TRACKED, false)) {\n             IterableApi.sharedInstance.trackInAppOpen(messageId, location);\n         }\n+        hideDialogView();\n         return relativeLayout;\n     }\n \n-    private void hideDialogView(Dialog dialog) {\n+    private void hideDialogView() {\n         try {\n-            dialog.getWindow().getDecorView().setVisibility(View.INVISIBLE);\n+            webView.setVisibility(View.INVISIBLE);\n+            webView.postDelayed(new Runnable() {\n+                @Override\n+                public void run() {\n+                    showDialogView();\n+                }\n+            }, DELAY_THRESHOLD_MS);", "originalCommit": "e3bfd4a7d6845785284d72f15ad63e62528b26f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\nindex 9f17c66..a664e73 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n\n@@ -198,7 +198,7 @@ public class IterableInAppFragmentHTMLNotification extends DialogFragment implem\n \n     private void hideDialogView() {\n         try {\n-            webView.setVisibility(View.INVISIBLE);\n+            getDialog().getWindow().getDecorView().setAlpha(0.0f);\n             webView.postDelayed(new Runnable() {\n                 @Override\n                 public void run() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421314578", "bodyText": "Just a suggestion. With this approach the status bar on API 29 device seems to flash before hiding and showing.\ngetDialog().getWindow().getDecorView().setAlpha(0);\ncan be a good alternative and more closer to what we had achieved previously.", "author": "Ayyanchira", "createdAt": "2020-05-07T08:02:43Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java", "diffHunk": "@@ -190,20 +192,27 @@ public void run() {\n         if (savedInstanceState == null || !savedInstanceState.getBoolean(INAPP_OPEN_TRACKED, false)) {\n             IterableApi.sharedInstance.trackInAppOpen(messageId, location);\n         }\n+        hideDialogView();\n         return relativeLayout;\n     }\n \n-    private void hideDialogView(Dialog dialog) {\n+    private void hideDialogView() {\n         try {\n-            dialog.getWindow().getDecorView().setVisibility(View.INVISIBLE);\n+            webView.setVisibility(View.INVISIBLE);", "originalCommit": "e3bfd4a7d6845785284d72f15ad63e62528b26f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyOTYyNg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421829626", "bodyText": "If Android suspends everything when DecorView is invisible, I'm wondering if they might also do that for opacity 0 at some point..", "author": "vbabenkoru", "createdAt": "2020-05-07T22:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzMjIxNA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421832214", "bodyText": "I dont think so...\nAs opacity is more of cosmetic property (which can be used to animate). It also means that the space will be acquired by the view even if it's not visible because it is present.\nWhile invisibility (with reference to iOS framework) actually has potential to remove the object. (Like for e.g A Button when hidden is actually removed from view hierarchy)", "author": "Ayyanchira", "createdAt": "2020-05-07T22:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzMzk3Ng==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421833976", "bodyText": "View.INVISIBLE is supposed to be like that: it makes it invisible without removing it from the layout (unlike what View.GONE does).", "author": "vbabenkoru", "createdAt": "2020-05-07T22:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzNDY2OA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421834668", "bodyText": "Thats true too \ud83e\udd37\u200d\u2642\ufe0f", "author": "Ayyanchira", "createdAt": "2020-05-07T22:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgzODczMA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421838730", "bodyText": "Yeah, alpha looks better, changed to that.", "author": "vbabenkoru", "createdAt": "2020-05-07T22:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\nindex 9f17c66..a664e73 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n\n@@ -198,7 +198,7 @@ public class IterableInAppFragmentHTMLNotification extends DialogFragment implem\n \n     private void hideDialogView() {\n         try {\n-            webView.setVisibility(View.INVISIBLE);\n+            getDialog().getWindow().getDecorView().setAlpha(0.0f);\n             webView.postDelayed(new Runnable() {\n                 @Override\n                 public void run() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDc5MQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/229#discussion_r421314791", "bodyText": "getDialog().getWindow().getDecorView().setAlpha(1);\n?", "author": "Ayyanchira", "createdAt": "2020-05-07T08:03:05Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java", "diffHunk": "@@ -190,20 +192,27 @@ public void run() {\n         if (savedInstanceState == null || !savedInstanceState.getBoolean(INAPP_OPEN_TRACKED, false)) {\n             IterableApi.sharedInstance.trackInAppOpen(messageId, location);\n         }\n+        hideDialogView();\n         return relativeLayout;\n     }\n \n-    private void hideDialogView(Dialog dialog) {\n+    private void hideDialogView() {\n         try {\n-            dialog.getWindow().getDecorView().setVisibility(View.INVISIBLE);\n+            webView.setVisibility(View.INVISIBLE);\n+            webView.postDelayed(new Runnable() {\n+                @Override\n+                public void run() {\n+                    showDialogView();\n+                }\n+            }, DELAY_THRESHOLD_MS);\n         } catch (NullPointerException e) {\n             IterableLogger.e(TAG, \"View not present. Failed to hide before resizing inapp\");\n         }\n     }\n \n-    private void showDialogView(Dialog dialog) {\n+    private void showDialogView() {\n         try {\n-            dialog.getWindow().getDecorView().setVisibility(View.VISIBLE);\n+            webView.setVisibility(View.VISIBLE);", "originalCommit": "e3bfd4a7d6845785284d72f15ad63e62528b26f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\nindex 9f17c66..a664e73 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppFragmentHTMLNotification.java\n\n@@ -198,7 +198,7 @@ public class IterableInAppFragmentHTMLNotification extends DialogFragment implem\n \n     private void hideDialogView() {\n         try {\n-            webView.setVisibility(View.INVISIBLE);\n+            getDialog().getWindow().getDecorView().setAlpha(0.0f);\n             webView.postDelayed(new Runnable() {\n                 @Override\n                 public void run() {\n"}}, {"oid": "aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "url": "https://github.com/Iterable/iterable-android-sdk/commit/aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "message": "InAppFragment improvements, delayed display\n\n* Hide the webView instead of DecorView for compatibility with API 29+\n* Show the dialog when the WebView is fully loaded, or after 500 ms, whichever happens earlier", "committedDate": "2020-05-07T22:50:36Z", "type": "commit"}, {"oid": "aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "url": "https://github.com/Iterable/iterable-android-sdk/commit/aa3be890c6a00efda6cab6bbdf3e28b6adb2e071", "message": "InAppFragment improvements, delayed display\n\n* Hide the webView instead of DecorView for compatibility with API 29+\n* Show the dialog when the WebView is fully loaded, or after 500 ms, whichever happens earlier", "committedDate": "2020-05-07T22:50:36Z", "type": "forcePushed"}]}