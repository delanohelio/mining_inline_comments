{"pr_number": 236, "pr_title": "[MOB-1482] Add Device Attributes methods", "pr_createdAt": "2020-05-27T20:05:29Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/236", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0ODIzNw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r433548237", "bodyText": "Why not initialize it here?", "author": "vbabenkoru", "createdAt": "2020-06-01T23:54:16Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -52,6 +55,7 @@\n \n     private IterableInAppManager inAppManager;\n     private String inboxSessionId;\n+    private HashMap<String, String> deviceAttributes;", "originalCommit": "3ad48161970de903d9c93961d25831d91c0301fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d414ab544e176144e3b8dc348aef61f81ce5b44d", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex 99995ad..e5ee101 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -55,7 +53,7 @@ private static final String TAG = \"IterableApi\";\n \n     private IterableInAppManager inAppManager;\n     private String inboxSessionId;\n-    private HashMap<String, String> deviceAttributes;\n+    private HashMap<String, String> deviceAttributes = new HashMap<>();\n \n //---------------------------------------------------------------------------------------\n //endregion\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0ODM2NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r433548365", "bodyText": "You can remove these checks if you initialize it above.", "author": "vbabenkoru", "createdAt": "2020-06-01T23:54:40Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -201,6 +205,23 @@ void setNotificationData(IterableNotificationData data) {\n             setAttributionInfo(new IterableAttributionInfo(data.getCampaignId(), data.getTemplateId(), data.getMessageId()));\n         }\n     }\n+\n+    HashMap getDeviceAttributes() {\n+        return deviceAttributes;\n+    }\n+\n+    public void setDeviceAttribute(String key, String value) {\n+        if (deviceAttributes == null) {", "originalCommit": "3ad48161970de903d9c93961d25831d91c0301fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d414ab544e176144e3b8dc348aef61f81ce5b44d", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex 99995ad..e5ee101 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -211,16 +209,11 @@ private static final String TAG = \"IterableApi\";\n     }\n \n     public void setDeviceAttribute(String key, String value) {\n-        if (deviceAttributes == null) {\n-            deviceAttributes = new HashMap<>();\n-        }\n         deviceAttributes.put(key, value);\n     }\n \n     public void removeFromDeviceAttribute(String key) {\n-        if (deviceAttributes != null) {\n-            deviceAttributes.remove(key);\n-        }\n+        deviceAttributes.remove(key);\n     }\n //---------------------------------------------------------------------------------------\n //endregion\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0OTE3NA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r433549174", "bodyText": "You can just do for(HashMap.Entry<String, String> entry : deviceAttributes.entrySet())", "author": "vbabenkoru", "createdAt": "2020-06-01T23:57:36Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -1114,6 +1135,15 @@ protected void registerDeviceToken(@Nullable String email, @Nullable String user\n             if (dataFields == null) {\n                 dataFields = new JSONObject();\n             }\n+\n+            if (deviceAttributes != null) {\n+                Iterator<HashMap.Entry<String, String>> deviceAttributesIterator = deviceAttributes.entrySet().iterator();", "originalCommit": "3ad48161970de903d9c93961d25831d91c0301fc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d414ab544e176144e3b8dc348aef61f81ce5b44d", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex 99995ad..e5ee101 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -1135,15 +1128,9 @@ private static final String TAG = \"IterableApi\";\n             if (dataFields == null) {\n                 dataFields = new JSONObject();\n             }\n-\n-            if (deviceAttributes != null) {\n-                Iterator<HashMap.Entry<String, String>> deviceAttributesIterator = deviceAttributes.entrySet().iterator();\n-                while (deviceAttributesIterator.hasNext()) {\n-                    Map.Entry<String, String> entry = deviceAttributesIterator.next();\n-                    dataFields.put(entry.getKey(), entry.getValue());\n-                }\n+            for(HashMap.Entry<String, String> entry : deviceAttributes.entrySet()){\n+                dataFields.put(entry.getKey(),entry.getValue());\n             }\n-\n             dataFields.put(IterableConstants.FIREBASE_TOKEN_TYPE, IterableConstants.MESSAGING_PLATFORM_FIREBASE);\n             dataFields.put(IterableConstants.FIREBASE_COMPATIBLE, true);\n             dataFields.put(IterableConstants.DEVICE_BRAND, Build.BRAND); //brand: google\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0OTUzOA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r433549538", "bodyText": "Hmmm I'm wondering if we should put device attributes in iterablePushRegistrationData since we store everything else related to the push registration there.. I don't think this will make a significant difference, but could be better for consistency. Your call.", "author": "vbabenkoru", "createdAt": "2020-06-01T23:59:04Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterablePushRegistration.java", "diffHunk": "@@ -33,7 +34,8 @@ protected Void doInBackground(IterablePushRegistrationData... params) {\n                             iterablePushRegistrationData.email,\n                             iterablePushRegistrationData.userId,\n                             iterablePushRegistrationData.pushIntegrationName,\n-                            pushRegistrationObject.token);\n+                            pushRegistrationObject.token,\n+                            IterableApi.getInstance().getDeviceAttributes());", "originalCommit": "3ad48161970de903d9c93961d25831d91c0301fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0MQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r433680341", "bodyText": "Sticking with current one. I had thought about it too. DeviceAttributes is something developer can set on later stage too apart from during a push registration state. PushRegistration felt more related to Push and Firebase side of functionality and didn't felt like adding it there. This looks fine to me :)", "author": "Ayyanchira", "createdAt": "2020-06-02T07:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0OTUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1MzA3Nw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r434853077", "bodyText": "The reason these properties are packed within the object is getting the token takes some time to get the token, so we capture the email, userId, push integration name at the time push registration was requested to make sure it is consistent.", "author": "vbabenkoru", "createdAt": "2020-06-03T21:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0OTUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1Mzk5Mw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r434853993", "bodyText": "Oh, actually we should keep it this way to make sure device attributes can be set after initialization. :) Disregard this.", "author": "vbabenkoru", "createdAt": "2020-06-03T21:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0OTUzOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d414ab544e176144e3b8dc348aef61f81ce5b44d", "url": "https://github.com/Iterable/iterable-android-sdk/commit/d414ab544e176144e3b8dc348aef61f81ce5b44d", "message": "[MOB-1482] Add Device Attributes methods\n\nAdding methods to add custom device attributes, remove device attributes. Integrated it with existing push registration and test methods.", "committedDate": "2020-06-02T07:37:09Z", "type": "forcePushed"}, {"oid": "1e28fa4e61fb2c96564245e8d4f8b7fa5c706015", "url": "https://github.com/Iterable/iterable-android-sdk/commit/1e28fa4e61fb2c96564245e8d4f8b7fa5c706015", "message": "[MOB-1482] Add Device Attributes methods\n\nAdding methods to add custom device attributes, remove device attributes. Integrated it with existing push registration and test methods.", "committedDate": "2020-06-02T15:39:58Z", "type": "forcePushed"}, {"oid": "36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "url": "https://github.com/Iterable/iterable-android-sdk/commit/36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "message": "[MOB-1482] Add Device Attributes methods\n\nAdding methods to add custom device attributes, remove device attributes. Integrated it with existing push registration and test methods.", "committedDate": "2020-06-02T15:57:06Z", "type": "commit"}, {"oid": "36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "url": "https://github.com/Iterable/iterable-android-sdk/commit/36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "message": "[MOB-1482] Add Device Attributes methods\n\nAdding methods to add custom device attributes, remove device attributes. Integrated it with existing push registration and test methods.", "committedDate": "2020-06-02T15:57:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1NDQ4NA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r434854484", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void removeFromDeviceAttribute(String key) {\n          \n          \n            \n                public void removeDeviceAttribute(String key) {", "author": "vbabenkoru", "createdAt": "2020-06-03T21:04:31Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -201,6 +203,18 @@ void setNotificationData(IterableNotificationData data) {\n             setAttributionInfo(new IterableAttributionInfo(data.getCampaignId(), data.getTemplateId(), data.getMessageId()));\n         }\n     }\n+\n+    HashMap getDeviceAttributes() {\n+        return deviceAttributes;\n+    }\n+\n+    public void setDeviceAttribute(String key, String value) {\n+        deviceAttributes.put(key, value);\n+    }\n+\n+    public void removeFromDeviceAttribute(String key) {", "originalCommit": "36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8fb232dc16386291a75fd3191a8d643ac8f8193d", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex 7780807..bfc5541 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -212,7 +212,7 @@ private static final String TAG = \"IterableApi\";\n         deviceAttributes.put(key, value);\n     }\n \n-    public void removeFromDeviceAttribute(String key) {\n+    public void removeDeviceAttribute(String key) {\n         deviceAttributes.remove(key);\n     }\n //---------------------------------------------------------------------------------------\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg1NDgzOQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/236#discussion_r434854839", "bodyText": "It is never null", "author": "vbabenkoru", "createdAt": "2020-06-03T21:04:56Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java", "diffHunk": "@@ -1114,6 +1128,13 @@ protected void registerDeviceToken(@Nullable String email, @Nullable String user\n             if (dataFields == null) {\n                 dataFields = new JSONObject();\n             }\n+\n+            if (deviceAttributes != null) {", "originalCommit": "36ffccfe6231f22c2f49b5bcf3ceef0404f32263", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8fb232dc16386291a75fd3191a8d643ac8f8193d", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\nindex 7780807..bfc5541 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\n@@ -1129,10 +1129,8 @@ private static final String TAG = \"IterableApi\";\n                 dataFields = new JSONObject();\n             }\n \n-            if (deviceAttributes != null) {\n-                for (HashMap.Entry<String, String> entry : deviceAttributes.entrySet()) {\n-                    dataFields.put(entry.getKey(), entry.getValue());\n-                }\n+            for (HashMap.Entry<String, String> entry : deviceAttributes.entrySet()) {\n+                dataFields.put(entry.getKey(), entry.getValue());\n             }\n \n             dataFields.put(IterableConstants.FIREBASE_TOKEN_TYPE, IterableConstants.MESSAGING_PLATFORM_FIREBASE);\n"}}, {"oid": "8fb232dc16386291a75fd3191a8d643ac8f8193d", "url": "https://github.com/Iterable/iterable-android-sdk/commit/8fb232dc16386291a75fd3191a8d643ac8f8193d", "message": "Update iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\nCo-authored-by: Victor Babenko <victor@iterable.com>", "committedDate": "2020-06-03T21:22:07Z", "type": "forcePushed"}, {"oid": "0e3fbee0e95dfd3a573b6390df69510e315adef4", "url": "https://github.com/Iterable/iterable-android-sdk/commit/0e3fbee0e95dfd3a573b6390df69510e315adef4", "message": "Update iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\nCo-authored-by: Victor Babenko <victor@iterable.com>", "committedDate": "2020-06-03T21:22:58Z", "type": "commit"}, {"oid": "0e3fbee0e95dfd3a573b6390df69510e315adef4", "url": "https://github.com/Iterable/iterable-android-sdk/commit/0e3fbee0e95dfd3a573b6390df69510e315adef4", "message": "Update iterableapi/src/main/java/com/iterable/iterableapi/IterableApi.java\n\nCo-authored-by: Victor Babenko <victor@iterable.com>", "committedDate": "2020-06-03T21:22:58Z", "type": "forcePushed"}]}