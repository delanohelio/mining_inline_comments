{"pr_number": 301, "pr_title": "[MOB-2152] - Offline Network Monitoring", "pr_createdAt": "2020-12-21T16:52:35Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/301", "timeline": [{"oid": "487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "url": "https://github.com/Iterable/iterable-android-sdk/commit/487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "message": "[MOB-2152] - Offline Network Monitoring\n\n1. Created NetworkConnectivity Manager: One place to have all out network related work. Made it with interface so other modules can subscribe to it and listen to network events\n2. TaskRunner now implements ConnectivityManager interfaces too and calls RunNow function when onNetworkConnected callback is called.\n3. ProcessTask function will check for networkConnectivity before processing and deleting the task\n4. ConnectivityManager's lifecycle will start with initialization of OfflineRequestProcessor and will remain shared instance\n5. Changes in Test method to accompany networkConnectivityMonitor in task runner\n6. Pending work: What if device is below LOLLIPOP? What should the networkManager should do?", "committedDate": "2020-12-21T16:56:20Z", "type": "commit"}, {"oid": "487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "url": "https://github.com/Iterable/iterable-android-sdk/commit/487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "message": "[MOB-2152] - Offline Network Monitoring\n\n1. Created NetworkConnectivity Manager: One place to have all out network related work. Made it with interface so other modules can subscribe to it and listen to network events\n2. TaskRunner now implements ConnectivityManager interfaces too and calls RunNow function when onNetworkConnected callback is called.\n3. ProcessTask function will check for networkConnectivity before processing and deleting the task\n4. ConnectivityManager's lifecycle will start with initialization of OfflineRequestProcessor and will remain shared instance\n5. Changes in Test method to accompany networkConnectivityMonitor in task runner\n6. Pending work: What if device is below LOLLIPOP? What should the networkManager should do?", "committedDate": "2020-12-21T16:56:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyNjU2NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r546926565", "bodyText": "this will be a private function", "author": "Ayyanchira", "createdAt": "2020-12-21T20:59:10Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.iterable.iterableapi;\n+\n+import android.content.Context;\n+import android.net.ConnectivityManager;\n+import android.net.Network;\n+import android.net.NetworkRequest;\n+import android.os.Build;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+\n+import java.util.ArrayList;\n+\n+class IterableNetworkConnectivityManager {\n+    private static final String TAG = \"NetworkConnectivityManager\";\n+    private boolean isConnected;\n+\n+    private static IterableNetworkConnectivityManager sharedInstance;\n+\n+    private ArrayList<IterableNetworkMonitorListener> networkMonitorListeners = new ArrayList<>();\n+\n+    public interface IterableNetworkMonitorListener {\n+        void onNetworkConnected();\n+\n+        void onNetworkDisconnected();\n+    }\n+\n+    static IterableNetworkConnectivityManager sharedInstance(Context context) {\n+        if (sharedInstance == null) {\n+            sharedInstance = new IterableNetworkConnectivityManager(context);\n+        }\n+        return sharedInstance;\n+    }\n+\n+    private IterableNetworkConnectivityManager(Context context) {\n+        if (context == null) {\n+            return;\n+        }\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+            startNetworkCallback(context);\n+        }\n+    }\n+\n+    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n+    public void startNetworkCallback(Context context) {", "originalCommit": "487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\nindex 3cb97a2..d7c0f2f 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\n\n@@ -42,7 +42,7 @@ class IterableNetworkConnectivityManager {\n     }\n \n     @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n-    public void startNetworkCallback(Context context) {\n+    private void startNetworkCallback(Context context) {\n         ConnectivityManager connectivityManager = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);\n         NetworkRequest.Builder networkBuilder = new NetworkRequest.Builder();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyNjgyMQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r546926821", "bodyText": "This will be package private", "author": "Ayyanchira", "createdAt": "2020-12-21T20:59:47Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.iterable.iterableapi;\n+\n+import android.content.Context;\n+import android.net.ConnectivityManager;\n+import android.net.Network;\n+import android.net.NetworkRequest;\n+import android.os.Build;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+\n+import java.util.ArrayList;\n+\n+class IterableNetworkConnectivityManager {\n+    private static final String TAG = \"NetworkConnectivityManager\";\n+    private boolean isConnected;\n+\n+    private static IterableNetworkConnectivityManager sharedInstance;\n+\n+    private ArrayList<IterableNetworkMonitorListener> networkMonitorListeners = new ArrayList<>();\n+\n+    public interface IterableNetworkMonitorListener {\n+        void onNetworkConnected();\n+\n+        void onNetworkDisconnected();\n+    }\n+\n+    static IterableNetworkConnectivityManager sharedInstance(Context context) {\n+        if (sharedInstance == null) {\n+            sharedInstance = new IterableNetworkConnectivityManager(context);\n+        }\n+        return sharedInstance;\n+    }\n+\n+    private IterableNetworkConnectivityManager(Context context) {\n+        if (context == null) {\n+            return;\n+        }\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+            startNetworkCallback(context);\n+        }\n+    }\n+\n+    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n+    public void startNetworkCallback(Context context) {\n+        ConnectivityManager connectivityManager = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);\n+        NetworkRequest.Builder networkBuilder = new NetworkRequest.Builder();\n+\n+        if (connectivityManager != null) {\n+            connectivityManager.registerNetworkCallback(networkBuilder.build(), new ConnectivityManager.NetworkCallback() {\n+                @Override\n+                public void onAvailable(@NonNull Network network) {\n+                    super.onAvailable(network);\n+                    IterableLogger.v(TAG, \"Network Connected\");\n+                    isConnected = true;\n+                    for (IterableNetworkMonitorListener listener : networkMonitorListeners) {\n+                        listener.onNetworkConnected();\n+                    }\n+                }\n+\n+                @Override\n+                public void onLost(@NonNull Network network) {\n+                    super.onLost(network);\n+                    IterableLogger.v(TAG, \"Network Disconnected\");\n+                    isConnected = false;\n+                    for (IterableNetworkMonitorListener listener : networkMonitorListeners) {\n+                        listener.onNetworkDisconnected();\n+                    }\n+                }\n+            });\n+        }\n+    }\n+\n+    public void addNetworkListener(IterableNetworkMonitorListener listener) {", "originalCommit": "487b2b0747da3a2f4ef8b9ff7a1107aef2149027", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "chunk": "diff --git a/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java b/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\nindex 3cb97a2..d7c0f2f 100644\n--- a/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\n+++ b/iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java\n\n@@ -42,7 +42,7 @@ class IterableNetworkConnectivityManager {\n     }\n \n     @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n-    public void startNetworkCallback(Context context) {\n+    private void startNetworkCallback(Context context) {\n         ConnectivityManager connectivityManager = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);\n         NetworkRequest.Builder networkBuilder = new NetworkRequest.Builder();\n \n"}}, {"oid": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "url": "https://github.com/Iterable/iterable-android-sdk/commit/fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "message": "Modification 1\n\n1. setOfflineProcessing method checks for SDK version > Lollipop. (Default is onlineProcessing)\n2. made startNetworkCallback private to have it started only once when network manager is constructed\n3. addNetworkListener is package private now\n4. Added test methods to check if request made when network is offline", "committedDate": "2020-12-22T18:34:53Z", "type": "commit"}, {"oid": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "url": "https://github.com/Iterable/iterable-android-sdk/commit/fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "message": "Modification 1\n\n1. setOfflineProcessing method checks for SDK version > Lollipop. (Default is onlineProcessing)\n2. made startNetworkCallback private to have it started only once when network manager is constructed\n3. addNetworkListener is package private now\n4. Added test methods to check if request made when network is offline", "committedDate": "2020-12-22T18:34:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547498940", "bodyText": "Which thread is this going to run on?", "author": "vbabenkoru", "createdAt": "2020-12-22T20:44:42Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableNetworkConnectivityManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.iterable.iterableapi;\n+\n+import android.content.Context;\n+import android.net.ConnectivityManager;\n+import android.net.Network;\n+import android.net.NetworkRequest;\n+import android.os.Build;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+\n+import java.util.ArrayList;\n+\n+class IterableNetworkConnectivityManager {\n+    private static final String TAG = \"NetworkConnectivityManager\";\n+    private boolean isConnected;\n+\n+    private static IterableNetworkConnectivityManager sharedInstance;\n+\n+    private ArrayList<IterableNetworkMonitorListener> networkMonitorListeners = new ArrayList<>();\n+\n+    public interface IterableNetworkMonitorListener {\n+        void onNetworkConnected();\n+\n+        void onNetworkDisconnected();\n+    }\n+\n+    static IterableNetworkConnectivityManager sharedInstance(Context context) {\n+        if (sharedInstance == null) {\n+            sharedInstance = new IterableNetworkConnectivityManager(context);\n+        }\n+        return sharedInstance;\n+    }\n+\n+    private IterableNetworkConnectivityManager(Context context) {\n+        if (context == null) {\n+            return;\n+        }\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {\n+            startNetworkCallback(context);\n+        }\n+    }\n+\n+    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n+    private void startNetworkCallback(Context context) {\n+        ConnectivityManager connectivityManager = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);\n+        NetworkRequest.Builder networkBuilder = new NetworkRequest.Builder();\n+\n+        if (connectivityManager != null) {\n+            connectivityManager.registerNetworkCallback(networkBuilder.build(), new ConnectivityManager.NetworkCallback() {\n+                @Override\n+                public void onAvailable(@NonNull Network network) {\n+                    super.onAvailable(network);\n+                    IterableLogger.v(TAG, \"Network Connected\");\n+                    isConnected = true;\n+                    for (IterableNetworkMonitorListener listener : networkMonitorListeners) {", "originalCommit": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMjkxMg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547512912", "bodyText": "oh.. it will be on main thread right?", "author": "Ayyanchira", "createdAt": "2020-12-22T21:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxNDY5OA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547514698", "bodyText": "Depends on the thread ConnectivityManager.NetworkCallback is called from.", "author": "vbabenkoru", "createdAt": "2020-12-22T21:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxNTMwMg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547515302", "bodyText": "It says default internal handler", "author": "Ayyanchira", "createdAt": "2020-12-22T21:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxOTkxNA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547519914", "bodyText": "Looks like it is a separate thread/handler spun by Android's ConnectivityManager class.", "author": "Ayyanchira", "createdAt": "2020-12-22T21:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM3MjIyMg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r548372222", "bodyText": "I'll create a separate JIRA and take a look at this later as part of my PR.", "author": "vbabenkoru", "createdAt": "2020-12-24T04:00:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5ODk0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMDM4NA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547500384", "bodyText": "Why is it called twice?", "author": "vbabenkoru", "createdAt": "2020-12-22T20:48:05Z", "path": "iterableapi/src/test/java/com/iterable/iterableapi/IterableTaskRunnerTest.java", "diffHunk": "@@ -77,6 +84,40 @@ public void testRunOnTaskCreatedCallsCompletionListener() throws Exception {\n         verify(taskCompletedListener).onTaskCompleted(any(String.class), eq(IterableTaskRunner.TaskResult.SUCCESS), any(IterableApiResponse.class));\n     }\n \n+    @Test\n+    public void testNoRequestsWhenOffline() throws Exception {\n+        clearInvocations(mockTaskStorage);\n+        IterableApiRequest request = new IterableApiRequest(\"apiKey\", \"api/test\", new JSONObject(), \"POST\", null, null, null);\n+        IterableTask task = new IterableTask(\"testTask\", IterableTaskType.API, request.toJSONObject().toString());\n+        when(mockTaskStorage.getNextScheduledTask()).thenReturn(task).thenReturn(null);\n+        when(mockNetworkConnectivityManager.isConnected()).thenReturn(false);\n+        IterableTaskRunner.TaskCompletedListener taskCompletedListener = mock(IterableTaskRunner.TaskCompletedListener.class);\n+        taskRunner.addTaskCompletedListener(taskCompletedListener);\n+\n+        server.enqueue(new MockResponse().setResponseCode(200).setBody(\"{}\"));\n+        taskRunner.onTaskCreated(null);\n+\n+        runHandlerTasks(taskRunner);\n+        verify(mockNetworkConnectivityManager, times(1)).isConnected();\n+        RecordedRequest recordedRequest = server.takeRequest(1, TimeUnit.SECONDS);\n+        assertNull(recordedRequest);\n+        shadowOf(getMainLooper()).idle();\n+        verifyNoInteractions(taskCompletedListener);\n+        verifyNoInteractions(mockTaskStorage);\n+    }\n+\n+    @Test\n+    public void testIfNetworkCheckedBeforeProcessingTask() throws Exception {\n+        IterableApiRequest request = new IterableApiRequest(\"apiKey\", \"api/test\", new JSONObject(), \"POST\", null, null, null);\n+        IterableTask task = new IterableTask(\"testTask\", IterableTaskType.API, request.toJSONObject().toString());\n+        when(mockTaskStorage.getNextScheduledTask()).thenReturn(task).thenReturn(null);\n+        when(mockNetworkConnectivityManager.isConnected()).thenReturn(true);\n+        taskRunner.onTaskCreated(null);\n+        runHandlerTasks(taskRunner);\n+        shadowOf(getMainLooper()).idle();\n+        verify(mockNetworkConnectivityManager, times(2)).isConnected();", "originalCommit": "fcf4a43bfa68bc8a8465b8b25d76f1aa9d65d199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMjI2Mg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547502262", "bodyText": "while isConnected -> next task -> processes the task\nwhile isConnected -> nextTask is null and breaks.. Thus two times \ud83d\ude05\nI was looking to just see if the networkConnectivityManager is invoked.. but couldn't recall a mockito method for that", "author": "Ayyanchira", "createdAt": "2020-12-22T20:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMDM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMjEwMA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/301#discussion_r547512100", "bodyText": "Ah, I see.. This sounds good then.", "author": "vbabenkoru", "createdAt": "2020-12-22T21:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUwMDM4NA=="}], "type": "inlineReview", "revised_code": null}]}