{"pr_number": 8112, "pr_title": "Issue #7469: Use ArchUnit library to control source code", "pr_createdAt": "2020-04-16T21:28:08Z", "pr_url": "https://github.com/checkstyle/checkstyle/pull/8112", "timeline": [{"oid": "49c2b70d36288d128309fc4e32b954b45977fa35", "url": "https://github.com/checkstyle/checkstyle/commit/49c2b70d36288d128309fc4e32b954b45977fa35", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-16T23:43:52Z", "type": "forcePushed"}, {"oid": "f57f9fb15adafb25e68e4a956fbaf9d72a184db4", "url": "https://github.com/checkstyle/checkstyle/commit/f57f9fb15adafb25e68e4a956fbaf9d72a184db4", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-17T08:38:15Z", "type": "forcePushed"}, {"oid": "e753fa2a29855e97246329aec2c343f6f4657ca1", "url": "https://github.com/checkstyle/checkstyle/commit/e753fa2a29855e97246329aec2c343f6f4657ca1", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-27T23:26:59Z", "type": "forcePushed"}, {"oid": "a2a2cb79b447538bb9c694cfee92ae4d9bc91c79", "url": "https://github.com/checkstyle/checkstyle/commit/a2a2cb79b447538bb9c694cfee92ae4d9bc91c79", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-28T10:32:21Z", "type": "forcePushed"}, {"oid": "4c5a8b86f4ae909034c3c6a0d46d521fb53ebdd0", "url": "https://github.com/checkstyle/checkstyle/commit/4c5a8b86f4ae909034c3c6a0d46d521fb53ebdd0", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-29T00:09:42Z", "type": "forcePushed"}, {"oid": "3191ccfb1a1cb7a6f55006981e42f1d5fd8a12e6", "url": "https://github.com/checkstyle/checkstyle/commit/3191ccfb1a1cb7a6f55006981e42f1d5fd8a12e6", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-29T10:13:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r417303736", "bodyText": "please explain why https://www.archunit.org/userguide/html/000_Index.html#_ignoring_violations does not work for us.", "author": "romani", "createdAt": "2020-04-29T13:14:22Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+////////////////////////////////////////////////////////////////////////////////\n+// checkstyle: Checks Java source code for adherence to a set of rules.\n+// Copyright (C) 2001-2020 the original author or authors.\n+//\n+// This library is free software; you can redistribute it and/or\n+// modify it under the terms of the GNU Lesser General Public\n+// License as published by the Free Software Foundation; either\n+// version 2.1 of the License, or (at your option) any later version.\n+//\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+// Lesser General Public License for more details.\n+//\n+// You should have received a copy of the GNU Lesser General Public\n+// License along with this library; if not, write to the Free Software\n+// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n+////////////////////////////////////////////////////////////////////////////////\n+\n+package com.puppycrawl.tools.checkstyle.internal;\n+\n+import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n+import static com.tngtech.archunit.library.dependencies.SlicesRuleDefinition.slices;\n+import static java.nio.file.Files.lines;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.github.difflib.DiffUtils;\n+import com.github.difflib.UnifiedDiffUtils;\n+import com.github.difflib.algorithm.DiffException;\n+import com.github.difflib.patch.Patch;\n+import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.importer.ClassFileImporter;\n+import com.tngtech.archunit.core.importer.ImportOption;\n+import com.tngtech.archunit.lang.ArchRule;\n+\n+public class ArchUnitTest {\n+\n+    /**\n+     * Test contains asserts in callstack, but idea does not see them.\n+     *\n+     * @noinspection JUnitTestMethodWithNoAssertions\n+     */\n+    @Test\n+    public void packageCyclicDependencyTest() throws Exception {\n+        final JavaClasses importedClasses = new ClassFileImporter()\n+                .withImportOption(ImportOption.Predefined.DO_NOT_INCLUDE_TESTS)\n+                .importPackages(\"com.puppycrawl.tools.checkstyle\");\n+\n+        final ArchRule cyclicPackageRule = slices()\n+                .matching(\"com.puppycrawl.tools.checkstyle.(**)..\")\n+            .should().beFreeOfCycles();\n+        try {\n+            cyclicPackageRule.check(importedClasses);\n+        }\n+        catch (AssertionError assertionError) {\n+            processDiff(assertionError.getMessage());\n+        }\n+    }\n+\n+    /**\n+     * Test contains asserts in callstack, but idea does not see them.\n+     *\n+     * @noinspection JUnitTestMethodWithNoAssertions\n+     */\n+    @Test\n+    public void nonProtectedCheckMethodsTest() {\n+        final JavaClasses importedClasses = new ClassFileImporter()\n+                .withImportOption(ImportOption.Predefined.DO_NOT_INCLUDE_TESTS)\n+                .importPackages(\"com.puppycrawl.tools.checkstyle.checks\");\n+\n+        final ArchRule checkMethodsShouldNotBeProtectedRule = methods().that()\n+            .areDeclaredInClassesThat().haveNameMatching(\"^(Abstract).*Check\")\n+            .should().notBeProtected();\n+\n+        checkMethodsShouldNotBeProtectedRule.check(importedClasses);\n+    }\n+\n+    private static void processDiff(String errorMsg) throws IOException, DiffException {\n+        final List<String> prevSuppresions = lines(Paths.get(\"archunit_suppressions.txt\"))", "originalCommit": "3191ccfb1a1cb7a6f55006981e42f1d5fd8a12e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMyOTIwOQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r417329209", "bodyText": "@romani I used breakpoints in the archunit code corresponding to this feature.\nThe FailureMessages are of the type:\njava.lang.AssertionError: Architecture Violation [Priority: MEDIUM] - Rule 'slices matching 'com.puppycrawl.tools.checkstyle.(**)..' should be free of cycles' was violated (13 times):\nCycle detected: Slice api -> Slice checks.naming -> Slice api\nDependencies of Slice api\nMethod <com.puppycrawl.tools.checkstyle.api.AutomaticBean$RelaxedAccessModifierArrayConverter.convert(java.lang.Class, java.lang.Object)> calls method <com.puppycrawl.tools.checkstyle.checks.naming.AccessModifier.getInstance(java.lang.String)> in (AutomaticBean.java:398)\nDependencies of Slice checks.naming\nMethod 1....\nClass 1....\nCycle detected: Slice api -> Slice checks.desgin -> Slice api\nMethod 1 ....\nMethod 2 ....\n.\n.\n.\n\nHere each section starting with Cycle detected: are treated as a single message in their filtering code.\nWhat we aim to achieve is that, in archunit_suppressions.txt we should put\nMethod 1 ...\nMethod 2 ...\nClass 1 ...\n\nBut in their ignoring violation feature if we specify Method 1.* as a regex whole of the message ie, the block starting with Cycles detected:  will be removed which is not desirable.\nSo, to treat individual Method 1 ..., Method 2 ... suppressions I have used diff.", "author": "gaurabdg", "createdAt": "2020-04-29T13:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3MTgwMw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r418071803", "bodyText": "you did not answered my question, please do.\nPlease ask archunit maintainers (forum, stackverflow, .... ) on how to do suppression on all existing violations to prevent new violations to appear.\nmeanwhile please move to config/archunit_suppressions.txt, this file is in unmanageable size.", "author": "romani", "createdAt": "2020-04-30T14:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MjA5MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r418162091", "bodyText": "@romani the last answer explains why the archunit_ignore_patterns.txt do not work. I did ask the maintainers. Here's the link TNG/ArchUnit#350\nThey also suggested to use freezing arch rule, the one which I implemented earlier.", "author": "gaurabdg", "createdAt": "2020-04-30T17:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxODcwNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r418218706", "bodyText": "@romani Even if we use the feature in the link you mentioned(archunit_ignore_patterns.txt), we do need an UT to check the current violations and tell the user to either fix the new violation or that a exisiting violation has been fixed and needs to be removed from the suppression file, for which we require diff. If we use their feature we have to write all the violations in regex format which is a bit of extra work provided the way I have implemented already satisfies all needs. Please let me know if I am missing something.", "author": "gaurabdg", "createdAt": "2020-04-30T18:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU3NDU0Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r418574542", "bodyText": "I try to avoid big files that keep state of some plugins.\nCan you confirm that freezer will fail if any changes appear in store ? How diff on store will looks like ?\n\nfrom referenced ticket in archunit ...\ncan we use slices()...should().beFreeOfCycles().ignoreDependency ?\nand to make it useful ... we will create test method for each package, so our ignoreXxxxxx will be more specific. So we might be able to resolve dependency one by one and visually see what we still have in ignoreXXXX.\nLets make just another PR to try this.\nLets make one more PR with freeze rule, to see it in action on changes (second commit can remove some dependency by brutal code removal, some will fail but we need to see a diff on store file).\n\n\nSo, to treat individual Method 1 ..., Method 2 ... suppressions I have used diff.\n\nWhy do we care that much of dependency of methods on class? I always thought of it as dependency between classes.\ncan we keep in repo archunit_ignore_patterns.txt as plain text file and do simple string compare by google.truth assert. If diff is happening, conributor just need  to generate new ignore file and send a change on it.", "author": "romani", "createdAt": "2020-05-01T14:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMzczNg=="}], "type": "inlineReview", "revised_code": {"commit": "4dc27d4b3a75a9ee7c620c9677963ef2187ec95c", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\nindex aaf6e29a9..4dbc3b2cd 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n\n@@ -24,7 +24,6 @@ import static com.tngtech.archunit.library.dependencies.SlicesRuleDefinition.sli\n import static java.nio.file.Files.lines;\n import static org.junit.Assert.assertEquals;\n \n-import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.Arrays;\n import java.util.Collections;\n"}}, {"oid": "4dc27d4b3a75a9ee7c620c9677963ef2187ec95c", "url": "https://github.com/checkstyle/checkstyle/commit/4dc27d4b3a75a9ee7c620c9677963ef2187ec95c", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-29T14:17:49Z", "type": "forcePushed"}, {"oid": "79b7728992d2359fd7a822366c767b43b93ff840", "url": "https://github.com/checkstyle/checkstyle/commit/79b7728992d2359fd7a822366c767b43b93ff840", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-29T18:07:12Z", "type": "forcePushed"}, {"oid": "d9d4a7dfa53f28459016db4e3a0369bffa002050", "url": "https://github.com/checkstyle/checkstyle/commit/d9d4a7dfa53f28459016db4e3a0369bffa002050", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-04-30T18:56:28Z", "type": "forcePushed"}, {"oid": "fb39e0fc7c3c2e4d769ba4bf70e4d7599ab590dc", "url": "https://github.com/checkstyle/checkstyle/commit/fb39e0fc7c3c2e4d769ba4bf70e4d7599ab590dc", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-02T15:15:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r423322368", "bodyText": "#7469 (comment)\n\nChecks should not have protected methods or fields.\n\nBy the name matching \"^(Abstract), isn't this only checking that methods in classes named \"Abstract\" are not allowed to have protected methods? If that is the case, shouldn't that result in a failure as the whole point of abstract classes is to have protected methods.\nExample: \n  \n    \n      checkstyle/src/main/java/com/puppycrawl/tools/checkstyle/checks/coding/AbstractSuperCheck.java\n    \n    \n         Line 55\n      in\n      2e8c277\n    \n    \n    \n    \n\n        \n          \n           protected abstract String getMethodName(); \n        \n    \n  \n\n\nEven for protected methods in final classes, we will have some that are overridden from the super class. Do we need to distinguish between these?", "author": "rnveach", "createdAt": "2020-05-11T21:11:37Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+////////////////////////////////////////////////////////////////////////////////\n+// checkstyle: Checks Java source code for adherence to a set of rules.\n+// Copyright (C) 2001-2020 the original author or authors.\n+//\n+// This library is free software; you can redistribute it and/or\n+// modify it under the terms of the GNU Lesser General Public\n+// License as published by the Free Software Foundation; either\n+// version 2.1 of the License, or (at your option) any later version.\n+//\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+// Lesser General Public License for more details.\n+//\n+// You should have received a copy of the GNU Lesser General Public\n+// License along with this library; if not, write to the Free Software\n+// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n+////////////////////////////////////////////////////////////////////////////////\n+\n+package com.puppycrawl.tools.checkstyle.internal;\n+\n+import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.importer.ClassFileImporter;\n+import com.tngtech.archunit.core.importer.ImportOption;\n+import com.tngtech.archunit.lang.ArchRule;\n+\n+public class ArchUnitTest {\n+\n+    /**\n+     * Test contains asserts in callstack, but idea does not see them.\n+     *\n+     * @noinspection JUnitTestMethodWithNoAssertions\n+     */\n+    @Test\n+    public void nonProtectedCheckMethodsTest() {\n+        final JavaClasses importedClasses = new ClassFileImporter()\n+                .withImportOption(ImportOption.Predefined.DO_NOT_INCLUDE_TESTS)\n+                .importPackages(\"com.puppycrawl.tools.checkstyle.checks\");\n+\n+        final ArchRule checkMethodsShouldNotBeProtectedRule = methods().that()\n+            .areDeclaredInClassesThat().haveNameMatching(\"^(Abstract).*Check\")", "originalCommit": "fb39e0fc7c3c2e4d769ba4bf70e4d7599ab590dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzczNTUyMA==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r423735520", "bodyText": "good catch.\n\n^(Abstract)\n\nshould be changed to all Checks except for Abstract...Check\n\nDo we need to distinguish between these?\n\nThis should not be violation (as it has Override annotation):\n\n  \n    \n      checkstyle/src/main/java/com/puppycrawl/tools/checkstyle/checks/coding/SuperFinalizeCheck.java\n    \n    \n        Lines 46 to 49\n      in\n      4768470\n    \n    \n    \n    \n\n        \n          \n           public class SuperFinalizeCheck extends AbstractSuperCheck { \n        \n\n        \n          \n            \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               protected String getMethodName() {", "author": "romani", "createdAt": "2020-05-12T13:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzMTM2OQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424031369", "bodyText": "@romani @gaurabdg If you agree with my analysis that we are not checking the right class names, why isn't there a violation in travis?\nIf it is scanning abstract classes, why didn't it flag them as I pointed out we have non-override protected methods in an abstract class. If it is not scanning abstract classes, why didn't it flag the methods with the Override annotations. Nothing says to specifically ignore overridden methods and it seems always skipping or defaulting to skip them would lead to issues with people unfamilar with arch unit.\nI couldn't confirm anything in their documentation and didn't try to debug this more.", "author": "rnveach", "createdAt": "2020-05-12T21:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3ODE1Ng==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424578156", "bodyText": "I wrote this condition for the test:\n        final ArchRule checkMethodsShouldNotBeProtectedRule =\n            methods().that()\n            .areNotAnnotatedWith(Override.class).and()\n            .areDeclaredInClassesThat()\n            .haveSimpleNameEndingWith(\"Check\").and()\n            .doNotHaveModifier(JavaModifier.ABSTRACT)\n            .should().notBeProtected();\n\nThe error reported was as follows:\ncom.tngtech.archunit.base.ArchUnitException$InvalidSyntaxUsageException: Annotation type java.lang.Override has @Retention(SOURCE), thus the information is gone after compile. So checking this with ArchUnit is useless. \nSo, we can't essentially use the Override annotation to skip methods such as processFiltered. I am looking at other workarounds.", "author": "gaurabdg", "createdAt": "2020-05-13T16:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDQ2OA==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424600468", "bodyText": "One thing I can do is to collect all Abstract.* class' methods and generate a regex string like .*(processFiltered | getMethodName...) to add to the archrule condition ..methods().that().haveNameNotMatching(regex) to skip them. Shall I implement this?", "author": "gaurabdg", "createdAt": "2020-05-13T17:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NjQ2MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424666461", "bodyText": "One thing I can do is to collect all Abstract.* class' methods\n\nCan ArchUnit do this for you so you don't have to? Or is it strictly a violation tool.\nI don't see any other choice for specific methods unless we create some new annotation to line up with Override. I would add some type of comment that says what the method list is.\nWhat about my concern for the currently pushed code not producing a violation when it looks like it should be?", "author": "rnveach", "createdAt": "2020-05-13T19:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzUwNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424697506", "bodyText": "What about my concern for the currently pushed code not producing a violation when it looks like it should be?\n\nI was assuming it was ignoring only Abstract.* checks, but it skipped all, it was a mistake on my part.\n\nCan ArchUnit do this for you so you don't have to? Or is it strictly a violation tool.\n\nI will look into it.\n\nI don't see any other choice for specific methods unless we create some new annotation to line up with Override.\n\nYes, we can create a new annotation with custom retention.\n\nI would add some type of comment that says what the method list is.\n\nI didn' understand what you are trying to say. Are you saying we should create an ignoreList set, to ignore?", "author": "gaurabdg", "createdAt": "2020-05-13T20:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg0ODU3Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r424848572", "bodyText": "I didn' understand what you are trying to say.\n\nIf we create a list of methods to suppress, we need a comment saying something like \"these methods are a list of methods with the Override annotation\". This way it is clear when new Override method is added, we know it should be added to the list and should not add a method that is protected without an Override.\n@romani please chime in on your thoughts on workaround. It seems ArchUnit has some limitations.", "author": "rnveach", "createdAt": "2020-05-14T03:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNzE1Nw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r426317157", "bodyText": "as the whole point of abstract classes is to have protected methods.\n\nis to have same implementation of some methods irrespective of modifier. Projected methods are visible not only Child classes, BUT to same package classes also - this is the biggest problems of them, they have two sides of visibility (NOT a single).", "author": "romani", "createdAt": "2020-05-17T23:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNzgwMw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r426317803", "bodyText": "@gaurabdg ,\n\nSo, we can't essentially use the Override annotation to skip methods such as processFiltered. I am looking at other workarounds.\n\nplease report this to ArchUnit maintainers and ask them for for workaround, there might be some option to disable this error. Static analysys tool need to work on annotations that have no effect in runtime, majority of annotations are flags/metadata/markers.  Please share link to discussion.\n\nnew annotation\n\nno, it is better to not use archunit for this. We should not damage our code in favor of tool.\n\nIf we create a list of methods to suppress, we need a comment saying something like \"these methods are a list of methods with the Override annotation\"\n\nI am ok for this now as workaround, if list of methods is manageable size. But we still need to contact Archunit team for help, to avoid ArchUnitException$InvalidSyntaxUsageException.", "author": "romani", "createdAt": "2020-05-17T23:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2NjU3MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r427466571", "bodyText": "Here is the issue TNG/ArchUnit#359\nIf they don't reply within a few days, I'll implement the workaround.", "author": "gaurabdg", "createdAt": "2020-05-19T17:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NjUyMw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r427596523", "bodyText": "Here is the reply TNG/ArchUnit#359 (comment), its not possible it seems. I am starting working on a workaround.", "author": "gaurabdg", "createdAt": "2020-05-19T20:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NTE3Mw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r431875173", "bodyText": "rnveach od not have time to continue this PR, I take over it.", "author": "romani", "createdAt": "2020-05-28T14:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjM2OA=="}], "type": "inlineReview", "revised_code": {"commit": "832909679689b858edf647eab99ce0381074d84b", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\nindex 739f84559..e4bed8628 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n\n@@ -24,12 +24,12 @@ import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n import org.junit.jupiter.api.Test;\n \n import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.domain.JavaModifier;\n import com.tngtech.archunit.core.importer.ClassFileImporter;\n import com.tngtech.archunit.core.importer.ImportOption;\n import com.tngtech.archunit.lang.ArchRule;\n \n public class ArchUnitTest {\n-\n     /**\n      * Test contains asserts in callstack, but idea does not see them.\n      *\n"}}, {"oid": "832909679689b858edf647eab99ce0381074d84b", "url": "https://github.com/checkstyle/checkstyle/commit/832909679689b858edf647eab99ce0381074d84b", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-20T22:12:18Z", "type": "forcePushed"}, {"oid": "2ae84cb908883015c9e4c5a29fa9b5313aaae9db", "url": "https://github.com/checkstyle/checkstyle/commit/2ae84cb908883015c9e4c5a29fa9b5313aaae9db", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-21T14:23:25Z", "type": "forcePushed"}, {"oid": "41d1196af2e755314f8eef141aa92a84bb90b2ec", "url": "https://github.com/checkstyle/checkstyle/commit/41d1196af2e755314f8eef141aa92a84bb90b2ec", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-21T15:01:40Z", "type": "forcePushed"}, {"oid": "9b7eae89add35f5d8bc5d4bbb7e31db714692c02", "url": "https://github.com/checkstyle/checkstyle/commit/9b7eae89add35f5d8bc5d4bbb7e31db714692c02", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-23T20:06:04Z", "type": "forcePushed"}, {"oid": "f754ac13a8569ba6c574b5f9030ab4e73c5200d5", "url": "https://github.com/checkstyle/checkstyle/commit/f754ac13a8569ba6c574b5f9030ab4e73c5200d5", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-23T23:01:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk0MzIxMQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r429943211", "bodyText": "please add as first sentence:\nThe goal is to ensure all classes of a specific name pattern have non-protected methods, except for those which are annotated with Override. In the bytecode there is no trace anymore if this method was annotated with @Override or not (limitation of Archunit), eventually we need to make checkstyle's Check on this.", "author": "romani", "createdAt": "2020-05-25T13:45:26Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+////////////////////////////////////////////////////////////////////////////////\n+// checkstyle: Checks Java source code for adherence to a set of rules.\n+// Copyright (C) 2001-2020 the original author or authors.\n+//\n+// This library is free software; you can redistribute it and/or\n+// modify it under the terms of the GNU Lesser General Public\n+// License as published by the Free Software Foundation; either\n+// version 2.1 of the License, or (at your option) any later version.\n+//\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+// Lesser General Public License for more details.\n+//\n+// You should have received a copy of the GNU Lesser General Public\n+// License along with this library; if not, write to the Free Software\n+// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n+////////////////////////////////////////////////////////////////////////////////\n+\n+package com.puppycrawl.tools.checkstyle.internal;\n+\n+import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.domain.JavaModifier;\n+import com.tngtech.archunit.core.importer.ClassFileImporter;\n+import com.tngtech.archunit.core.importer.ImportOption;\n+import com.tngtech.archunit.lang.ArchRule;\n+\n+public class ArchUnitTest {\n+    /**\n+     * Test contains asserts in callstack, but idea does not see them.", "originalCommit": "f754ac13a8569ba6c574b5f9030ab4e73c5200d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA5NzI5OQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r430097299", "bodyText": "Done.", "author": "gaurabdg", "createdAt": "2020-05-25T23:35:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk0MzIxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "69b83046cd5b395d18b784925ff0ac904583838d", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\nindex 54e655068..bbcb3c484 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n\n@@ -31,6 +31,10 @@ import com.tngtech.archunit.lang.ArchRule;\n \n public class ArchUnitTest {\n     /**\n+     * The goal is to ensure all classes of a specific name pattern have non-protected methods,\n+     * except for those which are annotated with Override. In the bytecode there is no trace anymore\n+     * if this method was annotated with @Override or not (limitation of Archunit), eventually we\n+     * need to make checkstyle's Check on this.\n      * Test contains asserts in callstack, but idea does not see them.\n      *\n      * @noinspection JUnitTestMethodWithNoAssertions\n"}}, {"oid": "69b83046cd5b395d18b784925ff0ac904583838d", "url": "https://github.com/checkstyle/checkstyle/commit/69b83046cd5b395d18b784925ff0ac904583838d", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-25T23:34:41Z", "type": "forcePushed"}, {"oid": "8be5055aed0285ce1dae1a82ea11e676767f9dcd", "url": "https://github.com/checkstyle/checkstyle/commit/8be5055aed0285ce1dae1a82ea11e676767f9dcd", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-26T14:13:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MDUyNw==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r432350527", "bodyText": "which are annotated with Override\nwas annotated with @Override\ndoc should be consistent.\nAlso, to avoid some reporting of some tools that @Override is not a valid tag, please use {@code blablabla} or {@literal @}", "author": "strkkk", "createdAt": "2020-05-29T08:59:11Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+////////////////////////////////////////////////////////////////////////////////\n+// checkstyle: Checks Java source code for adherence to a set of rules.\n+// Copyright (C) 2001-2020 the original author or authors.\n+//\n+// This library is free software; you can redistribute it and/or\n+// modify it under the terms of the GNU Lesser General Public\n+// License as published by the Free Software Foundation; either\n+// version 2.1 of the License, or (at your option) any later version.\n+//\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+// Lesser General Public License for more details.\n+//\n+// You should have received a copy of the GNU Lesser General Public\n+// License along with this library; if not, write to the Free Software\n+// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n+////////////////////////////////////////////////////////////////////////////////\n+\n+package com.puppycrawl.tools.checkstyle.internal;\n+\n+import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.domain.JavaModifier;\n+import com.tngtech.archunit.core.importer.ClassFileImporter;\n+import com.tngtech.archunit.core.importer.ImportOption;\n+import com.tngtech.archunit.lang.ArchRule;\n+\n+public class ArchUnitTest {\n+    /**\n+     * The goal is to ensure all classes of a specific name pattern have non-protected methods,\n+     * except for those which are annotated with Override. In the bytecode there is no trace anymore\n+     * if this method was annotated with @Override or not (limitation of Archunit), eventually we", "originalCommit": "8be5055aed0285ce1dae1a82ea11e676767f9dcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzcyOA==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r432867728", "bodyText": "done", "author": "gaurabdg", "createdAt": "2020-05-30T16:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MDUyNw=="}], "type": "inlineReview", "revised_code": {"commit": "b2b47b0b5b794e6e828bf7210ec5105f1cf2eb3c", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\nindex bbcb3c484..34d9af36a 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n\n@@ -32,10 +32,12 @@ import com.tngtech.archunit.lang.ArchRule;\n public class ArchUnitTest {\n     /**\n      * The goal is to ensure all classes of a specific name pattern have non-protected methods,\n-     * except for those which are annotated with Override. In the bytecode there is no trace anymore\n-     * if this method was annotated with @Override or not (limitation of Archunit), eventually we\n+     * except for those which are annotated with {@code Override}. In the bytecode there is no\n+     * trace\n+     * anymore\n+     * if this method was annotated with {@code Override} or not (limitation of Archunit), eventually we\n      * need to make checkstyle's Check on this.\n-     * Test contains asserts in callstack, but idea does not see them.\n+     * Test contains assertions in the callstack, but TeamCity inspection does not see them.\n      *\n      * @noinspection JUnitTestMethodWithNoAssertions\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MTYxNg==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r432351616", "bodyText": "contains asserts -> contains assertions\nbut idea does not see them - > it is not idea, it is teamcity inspection", "author": "strkkk", "createdAt": "2020-05-29T09:01:00Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+////////////////////////////////////////////////////////////////////////////////\n+// checkstyle: Checks Java source code for adherence to a set of rules.\n+// Copyright (C) 2001-2020 the original author or authors.\n+//\n+// This library is free software; you can redistribute it and/or\n+// modify it under the terms of the GNU Lesser General Public\n+// License as published by the Free Software Foundation; either\n+// version 2.1 of the License, or (at your option) any later version.\n+//\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+// Lesser General Public License for more details.\n+//\n+// You should have received a copy of the GNU Lesser General Public\n+// License along with this library; if not, write to the Free Software\n+// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n+////////////////////////////////////////////////////////////////////////////////\n+\n+package com.puppycrawl.tools.checkstyle.internal;\n+\n+import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.methods;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.tngtech.archunit.core.domain.JavaClasses;\n+import com.tngtech.archunit.core.domain.JavaModifier;\n+import com.tngtech.archunit.core.importer.ClassFileImporter;\n+import com.tngtech.archunit.core.importer.ImportOption;\n+import com.tngtech.archunit.lang.ArchRule;\n+\n+public class ArchUnitTest {\n+    /**\n+     * The goal is to ensure all classes of a specific name pattern have non-protected methods,\n+     * except for those which are annotated with Override. In the bytecode there is no trace anymore\n+     * if this method was annotated with @Override or not (limitation of Archunit), eventually we\n+     * need to make checkstyle's Check on this.\n+     * Test contains asserts in callstack, but idea does not see them.", "originalCommit": "8be5055aed0285ce1dae1a82ea11e676767f9dcd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzczNQ==", "url": "https://github.com/checkstyle/checkstyle/pull/8112#discussion_r432867735", "bodyText": "done", "author": "gaurabdg", "createdAt": "2020-05-30T16:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MTYxNg=="}], "type": "inlineReview", "revised_code": {"commit": "b2b47b0b5b794e6e828bf7210ec5105f1cf2eb3c", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\nindex bbcb3c484..34d9af36a 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/internal/ArchUnitTest.java\n\n@@ -32,10 +32,12 @@ import com.tngtech.archunit.lang.ArchRule;\n public class ArchUnitTest {\n     /**\n      * The goal is to ensure all classes of a specific name pattern have non-protected methods,\n-     * except for those which are annotated with Override. In the bytecode there is no trace anymore\n-     * if this method was annotated with @Override or not (limitation of Archunit), eventually we\n+     * except for those which are annotated with {@code Override}. In the bytecode there is no\n+     * trace\n+     * anymore\n+     * if this method was annotated with {@code Override} or not (limitation of Archunit), eventually we\n      * need to make checkstyle's Check on this.\n-     * Test contains asserts in callstack, but idea does not see them.\n+     * Test contains assertions in the callstack, but TeamCity inspection does not see them.\n      *\n      * @noinspection JUnitTestMethodWithNoAssertions\n      */\n"}}, {"oid": "b2b47b0b5b794e6e828bf7210ec5105f1cf2eb3c", "url": "https://github.com/checkstyle/checkstyle/commit/b2b47b0b5b794e6e828bf7210ec5105f1cf2eb3c", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-30T16:19:02Z", "type": "forcePushed"}, {"oid": "74ed295ddb49d7b7f97247812c41e44cbdf988b5", "url": "https://github.com/checkstyle/checkstyle/commit/74ed295ddb49d7b7f97247812c41e44cbdf988b5", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-30T16:24:21Z", "type": "commit"}, {"oid": "74ed295ddb49d7b7f97247812c41e44cbdf988b5", "url": "https://github.com/checkstyle/checkstyle/commit/74ed295ddb49d7b7f97247812c41e44cbdf988b5", "message": "Issue #7469: Use ArchUnit library to control source code", "committedDate": "2020-05-30T16:24:21Z", "type": "forcePushed"}]}