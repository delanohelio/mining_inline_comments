{"pr_number": 7845, "pr_title": "Issue #5089: LineLength measures Java characters, not Unicode characters", "pr_createdAt": "2020-03-13T17:33:28Z", "pr_url": "https://github.com/checkstyle/checkstyle/pull/7845", "timeline": [{"oid": "3adfac79d9c518e9b6dc1f2bdb9bf4ea6984b92a", "url": "https://github.com/checkstyle/checkstyle/commit/3adfac79d9c518e9b6dc1f2bdb9bf4ea6984b92a", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-13T22:20:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392600020", "bodyText": "I can only reproduce the issue with maven and not in Eclipse. Since I can't debug, I am starting to add more print outs to see the issue. I removed changes to CommonUtil and the issue remained.\nMaven and Eclipse disagree on line index 4 and 6.\nEclipse says lengths are 2-6 bytes shorter than reported by maven.\nLooking at maven alone, old code and new code always reported a length of 103 so I am not seeing why there wasn't a violation to begin with,", "author": "rnveach", "createdAt": "2020-03-14T16:20:15Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheck.java", "diffHunk": "@@ -130,7 +130,7 @@ protected void processFiltered(File file, FileText fileText) {\n         for (int i = 0; i < fileText.size(); i++) {\n             final String line = fileText.get(i);\n             final int realLength = CommonUtil.lengthExpandedTabs(\n-                line, line.length(), getTabWidth());\n+                line, line.codePointCount(0, line.length()), getTabWidth());", "originalCommit": "3adfac79d9c518e9b6dc1f2bdb9bf4ea6984b92a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMTE2Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392601162", "bodyText": "I opened the file in a hex editor and the line in question is 103 bytes (not include \\n). This is the same size being reported in the code.\nI believe the issue is the input file and that it may not be recognized in the right file format which you may be trying to use.\nThe bytes in question are: F0 9F 92 A9\nEclipse uses charset UTF-8. Maven uses charset windows-1252.", "author": "rnveach", "createdAt": "2020-03-14T16:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMTk1Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392601952", "bodyText": "@nmancus1 @romani The issue is the charset used to load the files. The default charset for Windows, since one isn't being supplied, is Cp1252 and thus is causing the files to be loaded using windows-1252.\nSee https://github.com/checkstyle/checkstyle/blob/master/src/main/java/com/puppycrawl/tools/checkstyle/Checker.java#L122\nTo fix the issue, tests would need to specify a UTF-8 charset to Checker or you would need to use a code in the input file that is supported by both charsets and reproduces the reported issue.", "author": "rnveach", "createdAt": "2020-03-14T16:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyNDU5Nw==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392624597", "bodyText": "if we define this in test it means all Windows user who want to have this issue fixed, then they HAVE to define charset UTF-8 in config.\n@rnveach , Am I get this right?\nif yes, we need to make ATTENTION note at issue.\nand yes, define UTF8 in Test.\n@nmancus1 , while we waiting for confirmation ... please add charset in Test with comment // we need to set charset to let test pass on windows where default charset is not UTF-8", "author": "romani", "createdAt": "2020-03-14T22:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyNDgzOA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392624838", "bodyText": "@rnveach , Am I get this right?\n\nYes.\nIt will not affect just windows users, it is anyone who does not specify the right character set for their files. If you force linux chartset to be Cp1252, they would see the same issue too.", "author": "rnveach", "createdAt": "2020-03-14T22:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyNjE3MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392626171", "bodyText": "I updated issue.", "author": "romani", "createdAt": "2020-03-14T23:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYwMDAyMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4513592170419f4441c2f09cfb182ac9b55f006a", "url": "https://github.com/checkstyle/checkstyle/commit/4513592170419f4441c2f09cfb182ac9b55f006a", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-15T11:48:02Z", "type": "forcePushed"}, {"oid": "647b00688e42a58ee940f08fc13f21ab630969e8", "url": "https://github.com/checkstyle/checkstyle/commit/647b00688e42a58ee940f08fc13f21ab630969e8", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-15T11:56:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2NzkyMg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392667922", "bodyText": "I don't see this is acceptable as it will clash with all other tests and not just this one. You don't even unset the property so you will be leaking into other tests. Even if you do unset, your not guaranteed your code will hit the unset even in the same test.\nThis has to be passed into the configuration object and set via checker property just like you set the max property for the check.", "author": "rnveach", "createdAt": "2020-03-15T12:13:36Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java", "diffHunk": "@@ -98,4 +100,21 @@ public void shouldNotLogLongLinks() throws Exception {\n         verify(checkConfig, getPath(\"InputLineLengthLongLink.java\"), expected);\n     }\n \n+    @Test\n+    public void countUnicodePointsOnce() throws Exception {\n+        final DefaultConfiguration checkConfig =\n+                createModuleConfig(LineLengthCheck.class);\n+        checkConfig.addAttribute(\"max\", \"100\");\n+        // we need to set charset to let test pass on windows where default charset is not UTF-8\n+        System.setProperty(\"file.encoding\", StandardCharsets.UTF_8.name());", "originalCommit": "647b00688e42a58ee940f08fc13f21ab630969e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2ODQwNg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392668406", "bodyText": "I didn't feel good about this either, thanks for suggesting an alternative.", "author": "nmancus1", "createdAt": "2020-03-15T12:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2NzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTUzNg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392679536", "bodyText": "Fixed.", "author": "nmancus1", "createdAt": "2020-03-15T14:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2NzkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "8473b7fd5cb38705082d25c8893a7e9d50853a5f", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\nindex 0af8f67ff..f540e39f2 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n\n@@ -105,15 +105,17 @@ public class LineLengthCheckTest extends AbstractModuleTestSupport {\n         final DefaultConfiguration checkConfig =\n                 createModuleConfig(LineLengthCheck.class);\n         checkConfig.addAttribute(\"max\", \"100\");\n-        // we need to set charset to let test pass on windows where default charset is not UTF-8\n-        System.setProperty(\"file.encoding\", StandardCharsets.UTF_8.name());\n+        // we need to set charset to let test pass when default charset is not UTF-8\n+        final DefaultConfiguration checkerConfig = createRootConfig(null);\n+        checkerConfig.addAttribute(\"charset\", StandardCharsets.UTF_8.name());\n+        checkerConfig.addChild(checkConfig);\n \n         final String[] expected = {\n             \"6: \" + getCheckMessage(MSG_KEY, 100, 136),\n             \"7: \" + getCheckMessage(MSG_KEY, 100, 136),\n         };\n \n-        verify(checkConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n+        verify(checkerConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2ODA2OA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392668068", "bodyText": "In this case other tests will be affected.\nPlease see https://github.com/checkstyle/checkstyle/blob/master/src/test/java/com/puppycrawl/tools/checkstyle/checks/blocks/EmptyCatchBlockCheckTest.java#L92", "author": "strkkk", "createdAt": "2020-03-15T12:15:40Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java", "diffHunk": "@@ -98,4 +100,21 @@ public void shouldNotLogLongLinks() throws Exception {\n         verify(checkConfig, getPath(\"InputLineLengthLongLink.java\"), expected);\n     }\n \n+    @Test\n+    public void countUnicodePointsOnce() throws Exception {\n+        final DefaultConfiguration checkConfig =\n+                createModuleConfig(LineLengthCheck.class);\n+        checkConfig.addAttribute(\"max\", \"100\");\n+        // we need to set charset to let test pass on windows where default charset is not UTF-8\n+        System.setProperty(\"file.encoding\", StandardCharsets.UTF_8.name());", "originalCommit": "647b00688e42a58ee940f08fc13f21ab630969e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2OTI2MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392669261", "bodyText": "I would recommend something like https://github.com/checkstyle/checkstyle/blob/master/src/test/java/com/puppycrawl/tools/checkstyle/CheckerTest.java#L515\nline.separator couldn't be change in checker config, charset for files can be.", "author": "rnveach", "createdAt": "2020-03-15T12:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2ODA2OA=="}], "type": "inlineReview", "revised_code": {"commit": "8473b7fd5cb38705082d25c8893a7e9d50853a5f", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\nindex 0af8f67ff..f540e39f2 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n\n@@ -105,15 +105,17 @@ public class LineLengthCheckTest extends AbstractModuleTestSupport {\n         final DefaultConfiguration checkConfig =\n                 createModuleConfig(LineLengthCheck.class);\n         checkConfig.addAttribute(\"max\", \"100\");\n-        // we need to set charset to let test pass on windows where default charset is not UTF-8\n-        System.setProperty(\"file.encoding\", StandardCharsets.UTF_8.name());\n+        // we need to set charset to let test pass when default charset is not UTF-8\n+        final DefaultConfiguration checkerConfig = createRootConfig(null);\n+        checkerConfig.addAttribute(\"charset\", StandardCharsets.UTF_8.name());\n+        checkerConfig.addChild(checkConfig);\n \n         final String[] expected = {\n             \"6: \" + getCheckMessage(MSG_KEY, 100, 136),\n             \"7: \" + getCheckMessage(MSG_KEY, 100, 136),\n         };\n \n-        verify(checkConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n+        verify(checkerConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2ODEyNQ==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392668125", "bodyText": "not only windows, every system with other default encoding", "author": "strkkk", "createdAt": "2020-03-15T12:16:09Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java", "diffHunk": "@@ -98,4 +100,21 @@ public void shouldNotLogLongLinks() throws Exception {\n         verify(checkConfig, getPath(\"InputLineLengthLongLink.java\"), expected);\n     }\n \n+    @Test\n+    public void countUnicodePointsOnce() throws Exception {\n+        final DefaultConfiguration checkConfig =\n+                createModuleConfig(LineLengthCheck.class);\n+        checkConfig.addAttribute(\"max\", \"100\");\n+        // we need to set charset to let test pass on windows where default charset is not UTF-8", "originalCommit": "647b00688e42a58ee940f08fc13f21ab630969e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTQ1OA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392679458", "bodyText": "Fixed.", "author": "nmancus1", "createdAt": "2020-03-15T14:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2ODEyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8473b7fd5cb38705082d25c8893a7e9d50853a5f", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\nindex 0af8f67ff..f540e39f2 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n\n@@ -105,15 +105,17 @@ public class LineLengthCheckTest extends AbstractModuleTestSupport {\n         final DefaultConfiguration checkConfig =\n                 createModuleConfig(LineLengthCheck.class);\n         checkConfig.addAttribute(\"max\", \"100\");\n-        // we need to set charset to let test pass on windows where default charset is not UTF-8\n-        System.setProperty(\"file.encoding\", StandardCharsets.UTF_8.name());\n+        // we need to set charset to let test pass when default charset is not UTF-8\n+        final DefaultConfiguration checkerConfig = createRootConfig(null);\n+        checkerConfig.addAttribute(\"charset\", StandardCharsets.UTF_8.name());\n+        checkerConfig.addChild(checkConfig);\n \n         final String[] expected = {\n             \"6: \" + getCheckMessage(MSG_KEY, 100, 136),\n             \"7: \" + getCheckMessage(MSG_KEY, 100, 136),\n         };\n \n-        verify(checkConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n+        verify(checkerConfig, getPath(\"InputLineLengthUnicodeChars.java\"), expected);\n \n     }\n \n"}}, {"oid": "8473b7fd5cb38705082d25c8893a7e9d50853a5f", "url": "https://github.com/checkstyle/checkstyle/commit/8473b7fd5cb38705082d25c8893a7e9d50853a5f", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-15T14:29:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4MzY0Mg==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392683642", "bodyText": "Why not createRootConfig(checkConfig)?", "author": "rnveach", "createdAt": "2020-03-15T15:19:42Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java", "diffHunk": "@@ -98,4 +100,23 @@ public void shouldNotLogLongLinks() throws Exception {\n         verify(checkConfig, getPath(\"InputLineLengthLongLink.java\"), expected);\n     }\n \n+    @Test\n+    public void countUnicodePointsOnce() throws Exception {\n+        final DefaultConfiguration checkConfig =\n+                createModuleConfig(LineLengthCheck.class);\n+        checkConfig.addAttribute(\"max\", \"100\");\n+        // we need to set charset to let test pass when default charset is not UTF-8\n+        final DefaultConfiguration checkerConfig = createRootConfig(null);\n+        checkerConfig.addAttribute(\"charset\", StandardCharsets.UTF_8.name());\n+        checkerConfig.addChild(checkConfig);", "originalCommit": "8473b7fd5cb38705082d25c8893a7e9d50853a5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4NDgzMA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392684830", "bodyText": "I wrote this to emulate the structure of the *checks.xml files.  Would you like me to change it?", "author": "nmancus1", "createdAt": "2020-03-15T15:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4MzY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4NjM0OA==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392686348", "bodyText": "createRootConfig(null);\n\nThe reason root config has the parameter is to receive the child that will be connected to it. If we can remove the call to addChild and just pass the child to createRootConfig then we should. It all should amount to the same thing in the end.", "author": "rnveach", "createdAt": "2020-03-15T15:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4MzY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4NzU2Nw==", "url": "https://github.com/checkstyle/checkstyle/pull/7845#discussion_r392687567", "bodyText": "Oh, yes, of course.  That makes sense. I will update and push right away, thanks for explaining that.", "author": "nmancus1", "createdAt": "2020-03-15T16:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY4MzY0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "86041c61bdc6c435115f628e1e08d888bdd9937c", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\nindex f540e39f2..bf88bf1a6 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/checks/sizes/LineLengthCheckTest.java\n\n@@ -106,9 +106,8 @@ public class LineLengthCheckTest extends AbstractModuleTestSupport {\n                 createModuleConfig(LineLengthCheck.class);\n         checkConfig.addAttribute(\"max\", \"100\");\n         // we need to set charset to let test pass when default charset is not UTF-8\n-        final DefaultConfiguration checkerConfig = createRootConfig(null);\n+        final DefaultConfiguration checkerConfig = createRootConfig(checkConfig);\n         checkerConfig.addAttribute(\"charset\", StandardCharsets.UTF_8.name());\n-        checkerConfig.addChild(checkConfig);\n \n         final String[] expected = {\n             \"6: \" + getCheckMessage(MSG_KEY, 100, 136),\n"}}, {"oid": "86041c61bdc6c435115f628e1e08d888bdd9937c", "url": "https://github.com/checkstyle/checkstyle/commit/86041c61bdc6c435115f628e1e08d888bdd9937c", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-15T16:10:26Z", "type": "commit"}, {"oid": "86041c61bdc6c435115f628e1e08d888bdd9937c", "url": "https://github.com/checkstyle/checkstyle/commit/86041c61bdc6c435115f628e1e08d888bdd9937c", "message": "Issue #5089: LineLength measures Java characters, not Unicode characters", "committedDate": "2020-03-15T16:10:26Z", "type": "forcePushed"}]}