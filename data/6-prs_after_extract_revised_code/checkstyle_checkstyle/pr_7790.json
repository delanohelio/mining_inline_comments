{"pr_number": 7790, "pr_title": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "pr_createdAt": "2020-03-07T06:39:32Z", "pr_url": "https://github.com/checkstyle/checkstyle/pull/7790", "timeline": [{"oid": "3a07e276750ba1d83fa95c6ef63e7348ee305099", "url": "https://github.com/checkstyle/checkstyle/commit/3a07e276750ba1d83fa95c6ef63e7348ee305099", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-07T12:50:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0NzI3NA==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389347274", "bodyText": "I doubt it should be like this. In very rare case, e.g.\nenum A {}; enum B{} no violation will be reported.\nPlease change it.", "author": "strkkk", "createdAt": "2020-03-08T08:28:15Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -98,8 +99,9 @@\n      */\n     private boolean publicTypeFound;\n \n-    /** Mapping between type names and line numbers of the type declarations.*/\n-    private final SortedMap<Integer, String> lineNumberTypeMap = new TreeMap<>();\n+    /** Mapping between type names and DetailAST nodes of the type declarations.*/\n+    private final SortedMap<DetailAST, String> lineNumberTypeMap =\n+            new TreeMap<>(Comparator.comparingInt(DetailAST::getLineNo));", "originalCommit": "3a07e276750ba1d83fa95c6ef63e7348ee305099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1NzM5MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389357391", "bodyText": "I changed the comparator to also check the column number if the line number is equal. That should be good enough to ensure the nodes are unique and still in order.", "author": "wltan", "createdAt": "2020-03-08T10:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0NzI3NA=="}], "type": "inlineReview", "revised_code": {"commit": "c1b8f440c6d52f73e7f9fa63c01856de19f35ef5", "chunk": "diff --git a/src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java b/src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java\nindex 8565e260d..5a0fef688 100644\n--- a/src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java\n+++ b/src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java\n\n@@ -93,15 +93,19 @@ public class OneTopLevelClassCheck extends AbstractCheck {\n      */\n     public static final String MSG_KEY = \"one.top.level.class\";\n \n+    /** Compare DetailAST nodes by line and then column number to make a unique ordering. */\n+    private static final Comparator<DetailAST> LINE_AND_COL_COMPARATOR =\n+            Comparator.comparingInt(DetailAST::getLineNo).thenComparingInt(DetailAST::getColumnNo);\n+\n     /**\n      * True if a java source file contains a type\n      * with a public access level modifier.\n      */\n     private boolean publicTypeFound;\n \n-    /** Mapping between type names and DetailAST nodes of the type declarations.*/\n+    /** Mapping between type names and DetailAST nodes of the type declarations. */\n     private final SortedMap<DetailAST, String> lineNumberTypeMap =\n-            new TreeMap<>(Comparator.comparingInt(DetailAST::getLineNo));\n+            new TreeMap<>(LINE_AND_COL_COMPARATOR);\n \n     @Override\n     public int[] getDefaultTokens() {\n"}}, {"oid": "c1b8f440c6d52f73e7f9fa63c01856de19f35ef5", "url": "https://github.com/checkstyle/checkstyle/commit/c1b8f440c6d52f73e7f9fa63c01856de19f35ef5", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-08T10:23:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODIyMg==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389428222", "bodyText": "I am lost where the unique ordering is needed. Checkstyle will drop violations for the same line/column/message/check. It also already sorts violations on line/column. Can you explain what I am missing?", "author": "rnveach", "createdAt": "2020-03-09T01:17:36Z", "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -92,14 +93,19 @@\n      */\n     public static final String MSG_KEY = \"one.top.level.class\";\n \n+    /** Compare DetailAST nodes by line and then column number to make a unique ordering. */\n+    private static final Comparator<DetailAST> LINE_AND_COL_COMPARATOR =\n+            Comparator.comparingInt(DetailAST::getLineNo).thenComparingInt(DetailAST::getColumnNo);", "originalCommit": "c1b8f440c6d52f73e7f9fa63c01856de19f35ef5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzOTA4MQ==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389439081", "bodyText": "The sorting is not so much for the order of the violations, but for this rule:\n\nIf file doesn't contains public class, enum or interface, top-level type is the first type in file.\n\nDetailAST on its own is not comparable, so we have to apply our own comparator to determine which is the first type in the file. This comes from extending the existing TreeMap to remember not just the line number, but the whole DetailAST node as well.\nIn hindsight, traversing the AST in beginTree should already visit the nodes in order. Maybe we can use a more efficient data structure instead? I'm thinking of using some sort of List; I just need a List<DetailAST> that stores the nodes in the traversed (sorted) order and I can get the individual type name from the node itself later.", "author": "wltan", "createdAt": "2020-03-09T02:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ0MDg1NA==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389440854", "bodyText": "Thanks. I see now. Original map sorted on integer which is the key.\n\nMaybe we can use a more efficient data structure instead\n\nFeel free to create a new issue and PR for this change.", "author": "rnveach", "createdAt": "2020-03-09T02:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODIyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODMxNA==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389428314", "bodyText": "Undo unnecessary changes like this. I see others in the same diff.", "author": "rnveach", "createdAt": "2020-03-09T01:18:22Z", "path": "src/test/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheckTest.java", "diffHunk": "@@ -132,43 +132,66 @@ public void testFileWithThreeTopLevelEnum() throws Exception {\n         final DefaultConfiguration checkConfig =\n                 createModuleConfig(OneTopLevelClassCheck.class);\n         final String[] expected = {\n-            \"3: \" + getCheckMessage(MSG_KEY, \"InputOneTopLevelClassEnum2inner1\"),\n-            \"11: \" + getCheckMessage(MSG_KEY, \"InputOneTopLevelClassEnum2inner2\"),\n+            \"3:1: \" + getCheckMessage(MSG_KEY, \"InputOneTopLevelClassEnum2inner1\"),\n+            \"11:1: \" + getCheckMessage(MSG_KEY, \"InputOneTopLevelClassEnum2inner2\"),\n         };\n         verify(checkConfig, getPath(\"InputOneTopLevelClassEnum2.java\"), expected);\n     }\n \n     @Test\n     public void testFileWithFewTopLevelClasses() throws Exception {\n         final DefaultConfiguration checkConfig =\n-            createModuleConfig(OneTopLevelClassCheck.class);\n+                createModuleConfig(OneTopLevelClassCheck.class);", "originalCommit": "c1b8f440c6d52f73e7f9fa63c01856de19f35ef5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzOTIwOA==", "url": "https://github.com/checkstyle/checkstyle/pull/7790#discussion_r389439208", "bodyText": "Fixed (I think I got all of them)", "author": "wltan", "createdAt": "2020-03-09T02:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODMxNA=="}], "type": "inlineReview", "revised_code": {"commit": "c0801c72fa078b5ace7274f7033c9b6bb7394787", "chunk": "diff --git a/src/test/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheckTest.java b/src/test/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheckTest.java\nindex 1752b7bef..af58f6002 100644\n--- a/src/test/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheckTest.java\n+++ b/src/test/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheckTest.java\n\n@@ -141,7 +141,7 @@ public class OneTopLevelClassCheckTest extends AbstractModuleTestSupport {\n     @Test\n     public void testFileWithFewTopLevelClasses() throws Exception {\n         final DefaultConfiguration checkConfig =\n-                createModuleConfig(OneTopLevelClassCheck.class);\n+            createModuleConfig(OneTopLevelClassCheck.class);\n         final String[] expected = {\n             \"25:1: \" + getCheckMessage(MSG_KEY, \"NoSuperClone\"),\n             \"29:1: \" + getCheckMessage(MSG_KEY, \"InnerClone\"),\n"}}, {"oid": "c0801c72fa078b5ace7274f7033c9b6bb7394787", "url": "https://github.com/checkstyle/checkstyle/commit/c0801c72fa078b5ace7274f7033c9b6bb7394787", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-09T02:02:36Z", "type": "forcePushed"}, {"oid": "117346f32b859fc5205e983d50b6e3fdd2bd790d", "url": "https://github.com/checkstyle/checkstyle/commit/117346f32b859fc5205e983d50b6e3fdd2bd790d", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-09T13:15:43Z", "type": "forcePushed"}, {"oid": "8e98bb4edf222195d53d324576ddf42556972d88", "url": "https://github.com/checkstyle/checkstyle/commit/8e98bb4edf222195d53d324576ddf42556972d88", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-10T17:28:06Z", "type": "commit"}, {"oid": "8e98bb4edf222195d53d324576ddf42556972d88", "url": "https://github.com/checkstyle/checkstyle/commit/8e98bb4edf222195d53d324576ddf42556972d88", "message": "Issue #7754: Update AbstractChecks to log DetailAST - OneTopLevelClass", "committedDate": "2020-03-10T17:28:06Z", "type": "forcePushed"}]}