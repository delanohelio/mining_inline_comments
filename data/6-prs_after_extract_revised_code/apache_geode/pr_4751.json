{"pr_number": 4751, "pr_title": "GEODE-7727: modify sender thread to detect relese of connection", "pr_createdAt": "2020-03-01T18:16:32Z", "pr_url": "https://github.com/apache/geode/pull/4751", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Mzk1MA==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387193950", "bodyText": "See earlier comment about descriptive test names.\nAlso, I wanted to check that this test is able to detect the failure condition it was written for (a hang caused by async messaging) so I ran it against the previous commit on this branch, before the asyncMode field was added to the Connection class. The test doesn't pass, as expected, but it takes 5 minutes to report the hang. Would it be possible to have the test use a smaller timeout instead of the default 5 minutes to speed things up a bit for if/when it does fail?", "author": "DonalEvans", "createdAt": "2020-03-03T17:57:09Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java", "diffHunk": "@@ -113,6 +116,88 @@ public void basicAcceptConnection() throws Exception {\n     }\n   }\n \n+\n+  @Test\n+  public void testClosingOfSenderConnections() throws Exception {\n+    final VM vm1 = VM.getVM(1);\n+    final VM vm2 = VM.getVM(2);\n+    final VM vm3 = VM.getVM(3);\n+\n+    disconnectAllFromDS();\n+\n+    int port = startLocator();\n+    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n+\n+    vm1.invoke(() -> startServer(properties));\n+    vm2.invoke(() -> startServer(properties));\n+    vm3.invoke(() -> startServer(properties));\n+\n+    await().untilAsserted(() -> {\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n+    });\n+\n+    try {\n+      await(\"for message to be sent\").until(() -> {\n+        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n+        serialAckedMessage.send(system.getAllOtherMembers(), false);\n+        return true;\n+      });\n+    } finally {\n+      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n+      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n+      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n+        vm.invoke(\"crash system in case it's hung\", () -> {\n+          if (system != null && system.isConnected()) {\n+            DistributedTestUtils.crashDistributedSystem(system);\n+          }\n+        });\n+      }\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(0);\n+      DistributedTestUtils.crashDistributedSystem(system);\n+    }\n+  }\n+\n+  @Test\n+  public void testAsyncHanging() throws Exception {", "originalCommit": "08720eeae54c92ced8170574f80da47d7c375418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MjQ2Ng==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387692466", "bodyText": "await() functionality has default timeout of 5 minutes, which as I was told should not be changed.", "author": "mivanac", "createdAt": "2020-03-04T14:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Mzk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "efb3bd4087e35992c8a038ec27935bee7c0c955e", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\nindex 59fa9dfedd..9462c72f09 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n\n@@ -116,88 +113,6 @@ public class TCPConduitDUnitTest extends DistributedTestCase {\n     }\n   }\n \n-\n-  @Test\n-  public void testClosingOfSenderConnections() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(0);\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-  @Test\n-  public void testAsyncHanging() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-    properties.put(\"async-distribution-timeout\", \"5\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-\n   private int startLocator() throws Exception {\n     Locator locator = Locator.startLocatorAndDS(0, new File(\"\"), properties);\n     system = (InternalDistributedSystem) locator.getDistributedSystem();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NTAwOQ==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387195009", "bodyText": "This test name could do with being more descriptive. A good test name should describe what part of the code is being tested, using which parameters, and what the expected outcome is.\nAlso, this test appears to be identical to the first test method in this class, with the addition of one extra assert. Are both cases needed?", "author": "DonalEvans", "createdAt": "2020-03-03T17:59:10Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java", "diffHunk": "@@ -113,6 +116,88 @@ public void basicAcceptConnection() throws Exception {\n     }\n   }\n \n+\n+  @Test\n+  public void testClosingOfSenderConnections() throws Exception {", "originalCommit": "08720eeae54c92ced8170574f80da47d7c375418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MzM5MQ==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387693391", "bodyText": "This added assert is for testing of modification added in this PR.", "author": "mivanac", "createdAt": "2020-03-04T14:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NTAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNTk1OA==", "url": "https://github.com/apache/geode/pull/4751#discussion_r389915958", "bodyText": "This test is removed", "author": "mivanac", "createdAt": "2020-03-09T19:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NTAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "efb3bd4087e35992c8a038ec27935bee7c0c955e", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\nindex 59fa9dfedd..9462c72f09 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n\n@@ -116,88 +113,6 @@ public class TCPConduitDUnitTest extends DistributedTestCase {\n     }\n   }\n \n-\n-  @Test\n-  public void testClosingOfSenderConnections() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(0);\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-  @Test\n-  public void testAsyncHanging() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-    properties.put(\"async-distribution-timeout\", \"5\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-\n   private int startLocator() throws Exception {\n     Locator locator = Locator.startLocatorAndDS(0, new File(\"\"), properties);\n     system = (InternalDistributedSystem) locator.getDistributedSystem();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NDM0NA==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387254344", "bodyText": "This block of code doesn't appear to achieve anything. The test runs the same with or without it, both before and after the asyncMode fix introduction.", "author": "DonalEvans", "createdAt": "2020-03-03T19:48:55Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java", "diffHunk": "@@ -113,6 +116,88 @@ public void basicAcceptConnection() throws Exception {\n     }\n   }\n \n+\n+  @Test\n+  public void testClosingOfSenderConnections() throws Exception {\n+    final VM vm1 = VM.getVM(1);\n+    final VM vm2 = VM.getVM(2);\n+    final VM vm3 = VM.getVM(3);\n+\n+    disconnectAllFromDS();\n+\n+    int port = startLocator();\n+    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n+\n+    vm1.invoke(() -> startServer(properties));\n+    vm2.invoke(() -> startServer(properties));\n+    vm3.invoke(() -> startServer(properties));\n+\n+    await().untilAsserted(() -> {\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n+    });\n+\n+    try {\n+      await(\"for message to be sent\").until(() -> {\n+        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n+        serialAckedMessage.send(system.getAllOtherMembers(), false);\n+        return true;\n+      });\n+    } finally {\n+      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n+      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n+      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n+        vm.invoke(\"crash system in case it's hung\", () -> {\n+          if (system != null && system.isConnected()) {\n+            DistributedTestUtils.crashDistributedSystem(system);\n+          }\n+        });\n+      }\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(0);\n+      DistributedTestUtils.crashDistributedSystem(system);\n+    }\n+  }\n+\n+  @Test\n+  public void testAsyncHanging() throws Exception {\n+    final VM vm1 = VM.getVM(1);\n+    final VM vm2 = VM.getVM(2);\n+    final VM vm3 = VM.getVM(3);\n+\n+    disconnectAllFromDS();\n+\n+    int port = startLocator();\n+    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n+    properties.put(\"async-distribution-timeout\", \"5\");\n+\n+    vm1.invoke(() -> startServer(properties));\n+    vm2.invoke(() -> startServer(properties));\n+    vm3.invoke(() -> startServer(properties));\n+\n+    await().untilAsserted(() -> {\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n+    });\n+\n+    try {\n+      await(\"for message to be sent\").until(() -> {\n+        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n+        serialAckedMessage.send(system.getAllOtherMembers(), false);\n+        return true;\n+      });\n+    } finally {\n+      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n+      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n+      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n+        vm.invoke(\"crash system in case it's hung\", () -> {\n+          if (system != null && system.isConnected()) {\n+            DistributedTestUtils.crashDistributedSystem(system);\n+          }\n+        });\n+      }\n+      DistributedTestUtils.crashDistributedSystem(system);", "originalCommit": "08720eeae54c92ced8170574f80da47d7c375418", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efb3bd4087e35992c8a038ec27935bee7c0c955e", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\nindex 59fa9dfedd..9462c72f09 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java\n\n@@ -116,88 +113,6 @@ public class TCPConduitDUnitTest extends DistributedTestCase {\n     }\n   }\n \n-\n-  @Test\n-  public void testClosingOfSenderConnections() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(0);\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-  @Test\n-  public void testAsyncHanging() throws Exception {\n-    final VM vm1 = VM.getVM(1);\n-    final VM vm2 = VM.getVM(2);\n-    final VM vm3 = VM.getVM(3);\n-\n-    disconnectAllFromDS();\n-\n-    int port = startLocator();\n-    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n-    properties.put(\"async-distribution-timeout\", \"5\");\n-\n-    vm1.invoke(() -> startServer(properties));\n-    vm2.invoke(() -> startServer(properties));\n-    vm3.invoke(() -> startServer(properties));\n-\n-    await().untilAsserted(() -> {\n-      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n-    });\n-\n-    try {\n-      await(\"for message to be sent\").until(() -> {\n-        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n-        serialAckedMessage.send(system.getAllOtherMembers(), false);\n-        return true;\n-      });\n-    } finally {\n-      // DUnit won't clean up properly if the sockets are hung; we have to crash the systems.\n-      IgnoredException.addIgnoredException(\"ForcedDisconnectException|loss of quorum\");\n-      for (VM vm : Arrays.asList(vm1, vm2, vm3)) {\n-        vm.invoke(\"crash system in case it's hung\", () -> {\n-          if (system != null && system.isConnected()) {\n-            DistributedTestUtils.crashDistributedSystem(system);\n-          }\n-        });\n-      }\n-      DistributedTestUtils.crashDistributedSystem(system);\n-    }\n-  }\n-\n-\n   private int startLocator() throws Exception {\n     Locator locator = Locator.startLocatorAndDS(0, new File(\"\"), properties);\n     system = (InternalDistributedSystem) locator.getDistributedSystem();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MzE0NA==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387263144", "bodyText": "What is the reason for adding this as an ignored exception?  Why do we now expect to see this exception and feel okay ignoring it?", "author": "DonalEvans", "createdAt": "2020-03-03T20:05:22Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/management/DistributedSystemMXBeanWithAlertsDistributedTest.java", "diffHunk": "@@ -137,6 +137,7 @@ public void setUp() throws Exception {\n     memberVM3 = getVM(3);\n \n     managerMember = managerVM.invoke(() -> createManager());\n+    IgnoredException.addIgnoredException(\"Cannot form connection to alert listener\");", "originalCommit": "08720eeae54c92ced8170574f80da47d7c375418", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5NDg3Ng==", "url": "https://github.com/apache/geode/pull/4751#discussion_r387694876", "bodyText": "Due to previous solution, sender thread did not detect release of connection. So this is the reason why this exception did not appear in test logs.", "author": "mivanac", "createdAt": "2020-03-04T14:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MzE0NA=="}], "type": "inlineReview", "revised_code": {"commit": "efb3bd4087e35992c8a038ec27935bee7c0c955e", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/management/DistributedSystemMXBeanWithAlertsDistributedTest.java b/geode-core/src/distributedTest/java/org/apache/geode/management/DistributedSystemMXBeanWithAlertsDistributedTest.java\nindex 8aa3adacbc..c549fe48c4 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/management/DistributedSystemMXBeanWithAlertsDistributedTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/management/DistributedSystemMXBeanWithAlertsDistributedTest.java\n\n@@ -137,7 +137,6 @@ public class DistributedSystemMXBeanWithAlertsDistributedTest implements Seriali\n     memberVM3 = getVM(3);\n \n     managerMember = managerVM.invoke(() -> createManager());\n-    IgnoredException.addIgnoredException(\"Cannot form connection to alert listener\");\n \n     for (VM memberVM : toArray(memberVM1, memberVM2, memberVM3)) {\n       memberVM.invoke(() -> {\n"}}, {"oid": "efb3bd4087e35992c8a038ec27935bee7c0c955e", "url": "https://github.com/apache/geode/commit/efb3bd4087e35992c8a038ec27935bee7c0c955e", "message": "GEODE-7727: modify sender thread to detect relese of connection", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "a4a53c370fbdb42079afffd9387e5af8a666d503", "url": "https://github.com/apache/geode/commit/a4a53c370fbdb42079afffd9387e5af8a666d503", "message": "GEODE-7727: Update solution only for shared connections", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "af2de9269a25dc515157371e418ac9e0154a5eb0", "url": "https://github.com/apache/geode/commit/af2de9269a25dc515157371e418ac9e0154a5eb0", "message": "GEODE-7727: added test", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "c9b6a3dcbc1dc6dedc729202d4b576f9469becca", "url": "https://github.com/apache/geode/commit/c9b6a3dcbc1dc6dedc729202d4b576f9469becca", "message": "GEODE-7727: update ater comments", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "e7dc729854f972d3ef7a522b3b923b2179c3e0b4", "url": "https://github.com/apache/geode/commit/e7dc729854f972d3ef7a522b3b923b2179c3e0b4", "message": "GEODE-7727: update test", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "c4ea0deec4b684d349d22a0a156411b736fd37dd", "url": "https://github.com/apache/geode/commit/c4ea0deec4b684d349d22a0a156411b736fd37dd", "message": "GEODE-7727: fix for async write hanging", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "bf1561c24b8d1e5a89949c4d42b3cda4ddeb84df", "url": "https://github.com/apache/geode/commit/bf1561c24b8d1e5a89949c4d42b3cda4ddeb84df", "message": "GEODE-7727: Test of region operations in the face of closed connections\n\nAdding a test for what happens to region operations when a connection is closed\nout from under the system. This test hangs without the changes to let the\nreader thread keep running.\n\nFix to test", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "0224b15129529753165f58e4eb9dc6a5a11dd55e", "url": "https://github.com/apache/geode/commit/0224b15129529753165f58e4eb9dc6a5a11dd55e", "message": "GEODE-7727: Preventing a double release of the input buffer\n\nThe releaseInputBuffer method was not thread safe. If it is called\nconcurrently, it will end up being released twice, which will add the buffer to\nto the buffer pool twice. Later, this could result in two threads using the\nsame buffer, resulting in corruption of the buffer.\n\nWith the changes for GEODE-7727, we made it likely that releaseInputBuffer\nwould be called concurrently. If a member departs, one thread will call\nConnection.close. Connection.close will close the socket and call\nreleaseInputBuffer. However, closing the socket will wake up the reader thread,\nwhich will also call releaseInputBuffer concurrently.\n\nMaking releaseInputBuffer thread safe by introducing a lock.", "committedDate": "2020-03-07T14:10:43Z", "type": "commit"}, {"oid": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "url": "https://github.com/apache/geode/commit/73163ce0d5520fb6d6dc2a771313882bf3546ca2", "message": "GEODE-7727: update after merge", "committedDate": "2020-03-07T14:28:23Z", "type": "commit"}, {"oid": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "url": "https://github.com/apache/geode/commit/73163ce0d5520fb6d6dc2a771313882bf3546ca2", "message": "GEODE-7727: update after merge", "committedDate": "2020-03-07T14:28:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk0NTExNw==", "url": "https://github.com/apache/geode/pull/4751#discussion_r389945117", "bodyText": "There is an empty finally block here that should either be removed along with the try, or have something relevant done in it.", "author": "DonalEvans", "createdAt": "2020-03-09T20:33:24Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.tcp;\n+\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.Serializable;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.distributed.internal.InternalDistributedSystem;\n+import org.apache.geode.distributed.internal.SerialAckedMessage;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+import org.apache.geode.test.dunit.rules.MemberVM;\n+\n+public class ConnectionChangeHangTest implements Serializable {\n+  int serversToStart = 3;\n+\n+  protected static InternalDistributedSystem system =\n+      InternalDistributedSystem.getConnectedInstance();\n+\n+  @Rule\n+  public ClusterStartupRule cluster = new ClusterStartupRule(serversToStart + 1);\n+\n+  MemberVM locator;\n+  MemberVM server1;\n+  MemberVM server2;\n+  MemberVM server3;\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    locator = cluster.startLocatorVM(0);\n+\n+  }\n+\n+  private MemberVM startServer(final int vmIndex) {\n+    return cluster.startServerVM(\n+        vmIndex, s -> s.withConnectionToLocator(locator.getPort())\n+            .withProperty(\"async-distribution-timeout\", \"5\"));\n+  }\n+\n+  @Test\n+\n+  public void testNoHanging() {\n+    server1 = startServer(1);\n+    server2 = startServer(2);\n+    server3 = startServer(3);\n+    locator.invoke(() -> await().untilAsserted(() -> {\n+      assertThat(ConnectionTable.getNumSenderSharedConnections()).isEqualTo(3);\n+    }));\n+\n+\n+    try {\n+      locator.invoke(() -> await(\"for message to be sent\").until(() -> {\n+        final SerialAckedMessage serialAckedMessage = new SerialAckedMessage();\n+        serialAckedMessage.send(system.getAllOtherMembers(), false);\n+        return true;\n+      }));\n+    } finally {\n+\n+    }", "originalCommit": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "53d139afd491b04515c7f536ddb337d2fc39d7f6", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nsimilarity index 84%\nrename from geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\nrename to geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nindex eb2e7936b2..be57e26881 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\n\n@@ -28,7 +28,7 @@ import org.apache.geode.distributed.internal.SerialAckedMessage;\n import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n import org.apache.geode.test.dunit.rules.MemberVM;\n \n-public class ConnectionChangeHangTest implements Serializable {\n+public class TestServerStartupWhenAsyncDistributionTimeoutIsSet implements Serializable {\n   int serversToStart = 3;\n \n   protected static InternalDistributedSystem system =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk0NTg3Nw==", "url": "https://github.com/apache/geode/pull/4751#discussion_r389945877", "bodyText": "This test name would be more descriptive if it was something like \"serverStartupDoesNotHangWhenAsyncDistributionTimeoutIsSet\"", "author": "DonalEvans", "createdAt": "2020-03-09T20:34:54Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.tcp;\n+\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.Serializable;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.distributed.internal.InternalDistributedSystem;\n+import org.apache.geode.distributed.internal.SerialAckedMessage;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+import org.apache.geode.test.dunit.rules.MemberVM;\n+\n+public class ConnectionChangeHangTest implements Serializable {\n+  int serversToStart = 3;\n+\n+  protected static InternalDistributedSystem system =\n+      InternalDistributedSystem.getConnectedInstance();\n+\n+  @Rule\n+  public ClusterStartupRule cluster = new ClusterStartupRule(serversToStart + 1);\n+\n+  MemberVM locator;\n+  MemberVM server1;\n+  MemberVM server2;\n+  MemberVM server3;\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    locator = cluster.startLocatorVM(0);\n+\n+  }\n+\n+  private MemberVM startServer(final int vmIndex) {\n+    return cluster.startServerVM(\n+        vmIndex, s -> s.withConnectionToLocator(locator.getPort())\n+            .withProperty(\"async-distribution-timeout\", \"5\"));\n+  }\n+\n+  @Test\n+\n+  public void testNoHanging() {", "originalCommit": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "53d139afd491b04515c7f536ddb337d2fc39d7f6", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nsimilarity index 84%\nrename from geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\nrename to geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nindex eb2e7936b2..be57e26881 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\n\n@@ -28,7 +28,7 @@ import org.apache.geode.distributed.internal.SerialAckedMessage;\n import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n import org.apache.geode.test.dunit.rules.MemberVM;\n \n-public class ConnectionChangeHangTest implements Serializable {\n+public class TestServerStartupWhenAsyncDistributionTimeoutIsSet implements Serializable {\n   int serversToStart = 3;\n \n   protected static InternalDistributedSystem system =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk0NTkzOA==", "url": "https://github.com/apache/geode/pull/4751#discussion_r389945938", "bodyText": "There is an extra line break here", "author": "DonalEvans", "createdAt": "2020-03-09T20:35:02Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.tcp;\n+\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.Serializable;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.distributed.internal.InternalDistributedSystem;\n+import org.apache.geode.distributed.internal.SerialAckedMessage;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+import org.apache.geode.test.dunit.rules.MemberVM;\n+\n+public class ConnectionChangeHangTest implements Serializable {\n+  int serversToStart = 3;\n+\n+  protected static InternalDistributedSystem system =\n+      InternalDistributedSystem.getConnectedInstance();\n+\n+  @Rule\n+  public ClusterStartupRule cluster = new ClusterStartupRule(serversToStart + 1);\n+\n+  MemberVM locator;\n+  MemberVM server1;\n+  MemberVM server2;\n+  MemberVM server3;\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    locator = cluster.startLocatorVM(0);\n+\n+  }\n+\n+  private MemberVM startServer(final int vmIndex) {\n+    return cluster.startServerVM(\n+        vmIndex, s -> s.withConnectionToLocator(locator.getPort())\n+            .withProperty(\"async-distribution-timeout\", \"5\"));\n+  }\n+\n+  @Test\n+", "originalCommit": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "53d139afd491b04515c7f536ddb337d2fc39d7f6", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nsimilarity index 84%\nrename from geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\nrename to geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nindex eb2e7936b2..be57e26881 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\n\n@@ -28,7 +28,7 @@ import org.apache.geode.distributed.internal.SerialAckedMessage;\n import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n import org.apache.geode.test.dunit.rules.MemberVM;\n \n-public class ConnectionChangeHangTest implements Serializable {\n+public class TestServerStartupWhenAsyncDistributionTimeoutIsSet implements Serializable {\n   int serversToStart = 3;\n \n   protected static InternalDistributedSystem system =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk0NjY3OQ==", "url": "https://github.com/apache/geode/pull/4751#discussion_r389946679", "bodyText": "This class should be renamed. The original name was a placeholder for use while debugging.", "author": "DonalEvans", "createdAt": "2020-03-09T20:36:29Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.tcp;\n+\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.Serializable;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.distributed.internal.InternalDistributedSystem;\n+import org.apache.geode.distributed.internal.SerialAckedMessage;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+import org.apache.geode.test.dunit.rules.MemberVM;\n+\n+public class ConnectionChangeHangTest implements Serializable {", "originalCommit": "73163ce0d5520fb6d6dc2a771313882bf3546ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "53d139afd491b04515c7f536ddb337d2fc39d7f6", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nsimilarity index 84%\nrename from geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\nrename to geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\nindex eb2e7936b2..be57e26881 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/ConnectionChangeHangTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TestServerStartupWhenAsyncDistributionTimeoutIsSet.java\n\n@@ -28,7 +28,7 @@ import org.apache.geode.distributed.internal.SerialAckedMessage;\n import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n import org.apache.geode.test.dunit.rules.MemberVM;\n \n-public class ConnectionChangeHangTest implements Serializable {\n+public class TestServerStartupWhenAsyncDistributionTimeoutIsSet implements Serializable {\n   int serversToStart = 3;\n \n   protected static InternalDistributedSystem system =\n"}}, {"oid": "53d139afd491b04515c7f536ddb337d2fc39d7f6", "url": "https://github.com/apache/geode/commit/53d139afd491b04515c7f536ddb337d2fc39d7f6", "message": "GEODE-7727: update test name", "committedDate": "2020-03-09T21:22:43Z", "type": "commit"}]}