{"pr_number": 5851, "pr_title": "GEODE-8790: Evicted entries sometimes remain in region map", "pr_createdAt": "2020-12-14T23:23:03Z", "pr_url": "https://github.com/apache/geode/pull/5851", "timeline": [{"oid": "a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "url": "https://github.com/apache/geode/commit/a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region", "committedDate": "2020-12-15T00:28:33Z", "type": "forcePushed"}, {"oid": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "url": "https://github.com/apache/geode/commit/2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region", "committedDate": "2020-12-15T00:29:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MjM1Nw==", "url": "https://github.com/apache/geode/pull/5851#discussion_r552972357", "bodyText": "I think it would be better to change it so the only the we don't do if we are evicting is handleEntryNotFound(). When evicting we do not want an exception if the entry is already gone.\nSo I would change line 369 to just be an \"else\" and then put a \"if (!isEviction)\" on handleEntryNotFound (even better might be to change handleEntryNotFound to test isEviction and return since this is the only place it is called).\nThen you can get rid of your new code on 375 and 376.\nI do think it is probably correct to call removeEntryOrLeaveTombstone for an eviction just to make sure it follows the normal rules of scheduling a tombstone when concurrency checks are enabled. This method is already a noop if evicting without concurrency checks.", "author": "dschneider-pivotal", "createdAt": "2021-01-06T21:35:08Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java", "diffHunk": "@@ -372,6 +372,8 @@ private void retryRemoveWithTombstone() {\n           } finally {\n             removeEntryOrLeaveTombstone();\n           }\n+        } else if (regionEntry == null && !newRegionEntry.isTombstone()) {", "originalCommit": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU4NjkyOA==", "url": "https://github.com/apache/geode/pull/5851#discussion_r553586928", "bodyText": "I moved a bit fast here with the first solution, as it appears we fail to pass the unit test evictDestroyOfExistingTombstoneWithConcurrencyChecksReturnsFalse. Suggesting that we don't properly handle the case where we're in an eviction and already set the region entry as tombstone. If we break up the check on isEviction and newRegionEntry.isTombstone we cause more unit tests to fail.\nWith the current issue, we're trying to catch the specific case where we have concurrency checks enabled, we're in an eviction, and we've created a new region entry marked as tombstone. I've restructured retryRemoveWithTombstone some so eviction and non-evictions go down the same path, and avoids a clause with a lone call to removeEntryOrLeaveTombstone that addresses this issue and passes unit tests.", "author": "luissson", "createdAt": "2021-01-07T21:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MjM1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7157fff8397511f19a808eff45d3718b7393c55a", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java b/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\nindex a05cf05623..2497cf3a6b 100644\n--- a/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\n+++ b/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\n\n@@ -366,14 +366,12 @@ public class RegionMapDestroy {\n           retry = true;\n           doContinue = true;\n           return;\n-        } else if (!isEviction) {\n+        } else {\n           try {\n             handleEntryNotFound();\n           } finally {\n             removeEntryOrLeaveTombstone();\n           }\n-        } else if (regionEntry == null && !newRegionEntry.isTombstone()) {\n-          removeEntryOrLeaveTombstone();\n         }\n       } // synchronized(newRegionEntry)\n     }\n"}}, {"oid": "7157fff8397511f19a808eff45d3718b7393c55a", "url": "https://github.com/apache/geode/commit/7157fff8397511f19a808eff45d3718b7393c55a", "message": "refactor", "committedDate": "2021-01-07T00:33:01Z", "type": "forcePushed"}, {"oid": "10b60d190d0372bc86fcbd23ca7cc79b71d86757", "url": "https://github.com/apache/geode/commit/10b60d190d0372bc86fcbd23ca7cc79b71d86757", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map", "committedDate": "2021-01-07T01:08:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ4ODEwMA==", "url": "https://github.com/apache/geode/pull/5851#discussion_r553488100", "bodyText": "This is just a code style thing but add curlys around the return statement.", "author": "dschneider-pivotal", "createdAt": "2021-01-07T17:53:48Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java", "diffHunk": "@@ -528,6 +528,9 @@ private void handleEntryNotFound() {\n     boolean throwException = false;\n     EntryNotFoundException entryNotFoundException = null;\n \n+    if(isEviction)", "originalCommit": "10b60d190d0372bc86fcbd23ca7cc79b71d86757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUwMzc0OQ==", "url": "https://github.com/apache/geode/pull/5851#discussion_r553503749", "bodyText": "done!", "author": "luissson", "createdAt": "2021-01-07T18:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ4ODEwMA=="}], "type": "inlineReview", "revised_code": {"commit": "8f8071838fadfc957b2f5324cc962995790670be", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java b/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\nindex 2497cf3a6b..960a510b03 100644\n--- a/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\n+++ b/geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java\n\n@@ -528,8 +528,9 @@ public class RegionMapDestroy {\n     boolean throwException = false;\n     EntryNotFoundException entryNotFoundException = null;\n \n-    if(isEviction)\n+    if (isEviction) {\n       return;\n+    }\n \n     if (!cacheWrite) {\n       throwException = true;\n"}}, {"oid": "8f8071838fadfc957b2f5324cc962995790670be", "url": "https://github.com/apache/geode/commit/8f8071838fadfc957b2f5324cc962995790670be", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map", "committedDate": "2021-01-07T18:22:50Z", "type": "forcePushed"}, {"oid": "ba855bfb27b631659361159438bdb9eedb672ae6", "url": "https://github.com/apache/geode/commit/ba855bfb27b631659361159438bdb9eedb672ae6", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map", "committedDate": "2021-01-07T19:59:24Z", "type": "forcePushed"}, {"oid": "79854e7014d5b6bf5bca7e1a3e0ac64960096266", "url": "https://github.com/apache/geode/commit/79854e7014d5b6bf5bca7e1a3e0ac64960096266", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map", "committedDate": "2021-01-07T21:02:48Z", "type": "forcePushed"}, {"oid": "83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "url": "https://github.com/apache/geode/commit/83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "message": "GEODE-8790: Evicted entries sometimes remain in region map (#5851)\n\n- Modifies regionMapDestroy.retryRemoveWithTombstone to handle case where an evicted entry was left in the region map when concurrency checks is enabled", "committedDate": "2021-01-07T23:49:38Z", "type": "commit"}, {"oid": "83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "url": "https://github.com/apache/geode/commit/83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "message": "GEODE-8790: Evicted entries sometimes remain in region map (#5851)\n\n- Modifies regionMapDestroy.retryRemoveWithTombstone to handle case where an evicted entry was left in the region map when concurrency checks is enabled", "committedDate": "2021-01-07T23:49:38Z", "type": "forcePushed"}]}