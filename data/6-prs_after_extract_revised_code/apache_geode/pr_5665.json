{"pr_number": 5665, "pr_title": "GEODE-8651: MsgReader's readHeader and readMessage should be synchron\u2026", "pr_createdAt": "2020-10-23T22:19:16Z", "pr_url": "https://github.com/apache/geode/pull/5665", "timeline": [{"oid": "46addf39f4e8576c24553098ae45e20c85801812", "url": "https://github.com/apache/geode/commit/46addf39f4e8576c24553098ae45e20c85801812", "message": "GEODE-8651: MsgReader's readHeader and readMessage should be synchronized\n\n    Co-authored-by: Anil <agingade@pivotal.io>\n    Co-authored-by: Darrel Schneider <darrel@vmware.com>\n    Co-authored-by: Bill Burcham <bill.burcham@gmail.com>\n    Co-authored-by: Ernie Burghardt <eburghardt@pivotal.io>", "committedDate": "2020-10-23T22:16:18Z", "type": "commit"}, {"oid": "907c9f609a7b14526b0f7d4a4cdb7d33987b6cb1", "url": "https://github.com/apache/geode/commit/907c9f609a7b14526b0f7d4a4cdb7d33987b6cb1", "message": "add junit test", "committedDate": "2020-10-27T16:20:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg5OTQzMA==", "url": "https://github.com/apache/geode/pull/5665#discussion_r512899430", "bodyText": "I don't like that we verify that getConduit is called 1 time. I understand after looking at the code but it seems rather indirect logically and brittle. I would prefer that you extract the block of code in notifyHandshakeWaiter starting at line 810 into a method named \"clearSSLInputBuffer\". Then this test can assert that clearSSLInputBuffer is only called 1 time. This would be much clearer and less brittle and would not increase the diffs much", "author": "dschneider-pivotal", "createdAt": "2020-10-27T17:43:37Z", "path": "geode-core/src/test/java/org/apache/geode/internal/tcp/ConnectionTest.java", "diffHunk": "@@ -113,4 +114,35 @@ public void connectTimeoutIsShortWhenAlerting() throws UnknownHostException {\n       assertThat(connection.getP2PConnectTimeout(distributionConfig)).isEqualTo(100);\n     });\n   }\n+\n+  @Test\n+  public void notifyHandshakeWaiterShouldPositionByteBufferOnlyOnce() throws Exception {\n+    ConnectionTable connectionTable = mock(ConnectionTable.class);\n+    Distribution distribution = mock(Distribution.class);\n+    DistributionManager distributionManager = mock(DistributionManager.class);\n+    DMStats dmStats = mock(DMStats.class);\n+    CancelCriterion stopper = mock(CancelCriterion.class);\n+    SocketCloser socketCloser = mock(SocketCloser.class);\n+    TCPConduit tcpConduit = mock(TCPConduit.class);\n+\n+    when(connectionTable.getBufferPool()).thenReturn(new BufferPool(dmStats));\n+    when(connectionTable.getConduit()).thenReturn(tcpConduit);\n+    when(connectionTable.getDM()).thenReturn(distributionManager);\n+    when(connectionTable.getSocketCloser()).thenReturn(socketCloser);\n+    when(distributionManager.getDistribution()).thenReturn(distribution);\n+    when(stopper.cancelInProgress()).thenReturn(null);\n+    when(tcpConduit.getCancelCriterion()).thenReturn(stopper);\n+    when(tcpConduit.getDM()).thenReturn(distributionManager);\n+    when(tcpConduit.getSocketId()).thenReturn(new InetSocketAddress(getLocalHost(), 10337));\n+    when(tcpConduit.getStats()).thenReturn(dmStats);\n+\n+    SocketChannel channel = SocketChannel.open();\n+\n+    Connection connection = new Connection(connectionTable, channel.socket());\n+    connection = spy(connection);\n+    connection.setSharedUnorderedForTest();\n+    connection.run();\n+\n+    verify(connection, times(1)).getConduit();", "originalCommit": "907c9f609a7b14526b0f7d4a4cdb7d33987b6cb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyODA0NQ==", "url": "https://github.com/apache/geode/pull/5665#discussion_r512928045", "bodyText": "fixed.", "author": "gesterzhou", "createdAt": "2020-10-27T18:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg5OTQzMA=="}], "type": "inlineReview", "revised_code": {"commit": "fb26890baaf3fd6b7e27cf0f9fb84b6f545a5abd", "chunk": "diff --git a/geode-core/src/test/java/org/apache/geode/internal/tcp/ConnectionTest.java b/geode-core/src/test/java/org/apache/geode/internal/tcp/ConnectionTest.java\nindex 518d55e227..c064afba73 100644\n--- a/geode-core/src/test/java/org/apache/geode/internal/tcp/ConnectionTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/internal/tcp/ConnectionTest.java\n\n@@ -115,8 +116,7 @@ public class ConnectionTest {\n     });\n   }\n \n-  @Test\n-  public void notifyHandshakeWaiterShouldPositionByteBufferOnlyOnce() throws Exception {\n+  private Connection createSpiedConnection() throws IOException {\n     ConnectionTable connectionTable = mock(ConnectionTable.class);\n     Distribution distribution = mock(Distribution.class);\n     DistributionManager distributionManager = mock(DistributionManager.class);\n"}}, {"oid": "fb26890baaf3fd6b7e27cf0f9fb84b6f545a5abd", "url": "https://github.com/apache/geode/commit/fb26890baaf3fd6b7e27cf0f9fb84b6f545a5abd", "message": "add more test cases", "committedDate": "2020-10-27T18:19:46Z", "type": "commit"}]}