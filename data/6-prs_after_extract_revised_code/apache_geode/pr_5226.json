{"pr_number": 5226, "pr_title": "GEODE-8205: Feature flag unsupported Redis commands", "pr_createdAt": "2020-06-08T21:44:18Z", "pr_url": "https://github.com/apache/geode/pull/5226", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NTAzMA==", "url": "https://github.com/apache/geode/pull/5226#discussion_r437475030", "bodyText": "We should also add some security meta data here:\n@ResourceOperation(resource = ResourcePermission.Resource.DATA, operation = ResourcePermission.Operation.MANAGE);", "author": "jdeppe-pivotal", "createdAt": "2020-06-09T14:38:57Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommand.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.redis.internal.gfsh;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.springframework.shell.core.annotation.CliCommand;\n+import org.springframework.shell.core.annotation.CliOption;\n+\n+import org.apache.geode.distributed.DistributedMember;\n+import org.apache.geode.management.cli.SingleGfshCommand;\n+import org.apache.geode.management.internal.cli.result.model.ResultModel;\n+import org.apache.geode.management.internal.functions.CliFunctionResult;\n+\n+public class RedisCommand extends SingleGfshCommand {\n+  public static final String REDIS = \"redis\";\n+  public static final String REDIS__HELP =\n+      \"Commands related to the Redis API for Geode.\";\n+  public static final String REDIS__ENABLE_UNSUPPORTED_COMMANDS = \"enable-unsupported-commands\";\n+  public static final String REDIS__ENABLE_UNSUPPORTED_COMMANDS__HELP =\n+      \"Boolean value to determine \"\n+          + \"whether or not to enable unsupported commands. Unsupported commands have not been fully tested.\";\n+\n+  @CliCommand(value = {REDIS}, help = REDIS__HELP)\n+  public ResultModel enableUnsupportedCommands(", "originalCommit": "f910d9f8352351ec0d0d0f83fdf445395782bc34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNTAwNA==", "url": "https://github.com/apache/geode/pull/5226#discussion_r437725004", "bodyText": "Updated it! Thank you!", "author": "sabbey37", "createdAt": "2020-06-09T21:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NTAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "2d0b1c3769f73bd3f311e570fa3adfc1f09298e9", "chunk": "diff --git a/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommand.java b/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommand.java\nindex abe6cb09d6..6039bb9469 100644\n--- a/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommand.java\n+++ b/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommand.java\n\n@@ -25,6 +25,8 @@ import org.apache.geode.distributed.DistributedMember;\n import org.apache.geode.management.cli.SingleGfshCommand;\n import org.apache.geode.management.internal.cli.result.model.ResultModel;\n import org.apache.geode.management.internal.functions.CliFunctionResult;\n+import org.apache.geode.management.internal.security.ResourceOperation;\n+import org.apache.geode.security.ResourcePermission;\n \n public class RedisCommand extends SingleGfshCommand {\n   public static final String REDIS = \"redis\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NzA5OA==", "url": "https://github.com/apache/geode/pull/5226#discussion_r437477098", "bodyText": "For consistency with other cli-related functions we should extend CliFunction instead of implements Function. That class exposes an execute that just needs to return a CliFunctionResult. CliFunction also extends InternalFunction which is more secure (it cannot be user-invoked in any way - for example via gfsh).", "author": "jdeppe-pivotal", "createdAt": "2020-06-09T14:41:27Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommandFunction.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.redis.internal.gfsh;\n+\n+import org.apache.geode.cache.execute.Function;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.internal.cache.InternalCache;\n+import org.apache.geode.management.internal.functions.CliFunctionResult;\n+import org.apache.geode.redis.internal.GeodeRedisService;\n+\n+public class RedisCommandFunction implements Function<Boolean> {", "originalCommit": "f910d9f8352351ec0d0d0f83fdf445395782bc34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNTExMQ==", "url": "https://github.com/apache/geode/pull/5226#discussion_r437725111", "bodyText": "I updated it, let me know what you think.", "author": "sabbey37", "createdAt": "2020-06-09T21:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NzA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "2d0b1c3769f73bd3f311e570fa3adfc1f09298e9", "chunk": "diff --git a/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommandFunction.java b/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommandFunction.java\nindex 15e29e8657..58ed73fa78 100644\n--- a/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommandFunction.java\n+++ b/geode-redis/src/main/java/org/apache/geode/redis/internal/gfsh/RedisCommandFunction.java\n\n@@ -14,44 +14,40 @@\n  */\n package org.apache.geode.redis.internal.gfsh;\n \n-import org.apache.geode.cache.execute.Function;\n import org.apache.geode.cache.execute.FunctionContext;\n import org.apache.geode.cache.execute.FunctionService;\n import org.apache.geode.internal.cache.InternalCache;\n+import org.apache.geode.management.cli.CliFunction;\n import org.apache.geode.management.internal.functions.CliFunctionResult;\n import org.apache.geode.redis.internal.GeodeRedisService;\n \n-public class RedisCommandFunction implements Function<Boolean> {\n+public class RedisCommandFunction extends CliFunction<Boolean> {\n \n   public static void register() {\n     FunctionService.registerFunction(new RedisCommandFunction());\n   }\n \n   @Override\n-  public void execute(FunctionContext<Boolean> context) {\n+  public CliFunctionResult executeFunction(FunctionContext<Boolean> context) {\n     boolean enableUnsupportedCommands = context.getArguments();\n \n     InternalCache cache = (InternalCache) context.getCache();\n \n     if (!cache.getInternalDistributedSystem().getConfig().getRedisEnabled()) {\n-      context.getResultSender().lastResult(\n-          new CliFunctionResult(context.getMemberName(), false, \"Error: Redis is not enabled\"));\n-      return;\n+      return new CliFunctionResult(context.getMemberName(), false, \"Error: Redis is not enabled\");\n     }\n \n     GeodeRedisService geodeRedisService = cache.getService(GeodeRedisService.class);\n \n     if (geodeRedisService == null) {\n-      context.getResultSender().lastResult(new CliFunctionResult(context.getMemberName(), false,\n-          \"Error: GeodeRedisService is not running.\"));\n-      return;\n+      return new CliFunctionResult(context.getMemberName(), false,\n+          \"Error: GeodeRedisService is not running.\");\n     }\n \n     geodeRedisService.setEnableUnsupported(enableUnsupportedCommands);\n \n     String unsupportedCommandsString = enableUnsupportedCommands ? \"Unsupported commands enabled.\"\n         : \"Unsupported commands disabled.\";\n-    context.getResultSender().lastResult(\n-        new CliFunctionResult(context.getMemberName(), true, unsupportedCommandsString));\n+    return new CliFunctionResult(context.getMemberName(), true, unsupportedCommandsString);\n   }\n }\n"}}, {"oid": "2d0b1c3769f73bd3f311e570fa3adfc1f09298e9", "url": "https://github.com/apache/geode/commit/2d0b1c3769f73bd3f311e570fa3adfc1f09298e9", "message": "WIP", "committedDate": "2020-06-09T21:43:10Z", "type": "forcePushed"}, {"oid": "375a4eb6e49df348ecae1bc5d80b097b7e11eaf1", "url": "https://github.com/apache/geode/commit/375a4eb6e49df348ecae1bc5d80b097b7e11eaf1", "message": "GEODE-8205: Feature flag unsupported Redis commands\n\nAdded log message and redis --enable-unsupported-commands gfsh command.", "committedDate": "2020-06-09T21:46:13Z", "type": "commit"}, {"oid": "375a4eb6e49df348ecae1bc5d80b097b7e11eaf1", "url": "https://github.com/apache/geode/commit/375a4eb6e49df348ecae1bc5d80b097b7e11eaf1", "message": "GEODE-8205: Feature flag unsupported Redis commands\n\nAdded log message and redis --enable-unsupported-commands gfsh command.", "committedDate": "2020-06-09T21:46:13Z", "type": "forcePushed"}, {"oid": "f474fdf5da0e30b0d73ddb315dcb53130e3c97f9", "url": "https://github.com/apache/geode/commit/f474fdf5da0e30b0d73ddb315dcb53130e3c97f9", "message": "Adds command type back to unsupported command error message", "committedDate": "2020-06-10T13:29:32Z", "type": "commit"}]}