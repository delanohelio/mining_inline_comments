{"pr_number": 4741, "pr_title": "GEODE-7820: Avoid Unnecessary toArray Invocations", "pr_createdAt": "2020-02-27T12:58:19Z", "pr_url": "https://github.com/apache/geode/pull/4741", "timeline": [{"oid": "b1ca00dd2d56be4ce4e13e545994b2501b05b128", "url": "https://github.com/apache/geode/commit/b1ca00dd2d56be4ce4e13e545994b2501b05b128", "message": "GEODE-7820: Avoid Unnecessary toArray Invocations\n\nAvoid unnecessary invocations to the 'toArray' method and directly\nuse the java collection received instead.", "committedDate": "2020-02-27T12:55:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5OTY2Mw==", "url": "https://github.com/apache/geode/pull/4741#discussion_r385199663", "bodyText": "I think we could get rid of getRecipientsArray() with a little more work.  It's only used until we get down to the messaging layer (GMSMembership.send(), DirectChannel.sendToMany()).  That would get rid of an array-copy for every message we send.", "author": "bschuchardt", "createdAt": "2020-02-27T15:55:43Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java", "diffHunk": "@@ -301,15 +300,16 @@ public void resetRecipients() {\n     if (this.multicast || this.recipients == null) {\n       return ALL_RECIPIENTS_ARRAY;\n     }\n-    return this.recipients;\n+\n+    return this.recipients.toArray(EMPTY_RECIPIENTS_ARRAY);", "originalCommit": "b1ca00dd2d56be4ce4e13e545994b2501b05b128", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxNzU2Mg==", "url": "https://github.com/apache/geode/pull/4741#discussion_r385217562", "bodyText": "Sounds good @bschuchardt, will make the changes, thanks!.", "author": "jujoramos", "createdAt": "2020-02-27T16:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5OTY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "0dd1a883b33124e5eefda0bf0a0e72ea59022d9c", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\nindex 4b1ba34174..4fed3c1e97 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\n\n@@ -291,19 +283,6 @@ public abstract class DistributionMessage\n     this.multicast = false;\n   }\n \n-  /**\n-   * Returns the intended recipient(s) of this message. If the message is intended to delivered to\n-   * all distribution managers, then the array will contain ALL_RECIPIENTS. If the recipients have\n-   * not been set null is returned.\n-   */\n-  public InternalDistributedMember[] getRecipientsArray() {\n-    if (this.multicast || this.recipients == null) {\n-      return ALL_RECIPIENTS_ARRAY;\n-    }\n-\n-    return this.recipients.toArray(EMPTY_RECIPIENTS_ARRAY);\n-  }\n-\n   /**\n    * Returns true if message will be sent to everyone.\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIwMDUxNQ==", "url": "https://github.com/apache/geode/pull/4741#discussion_r385200515", "bodyText": "You could replace The Arrays.toString() here with \"recipients\".  There is at least one other place in the code doing this same thing that you could change.", "author": "bschuchardt", "createdAt": "2020-02-27T15:56:54Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java", "diffHunk": "@@ -547,8 +548,9 @@ public void setBreadcrumbsInSender() {\n       if (pid != 0) {\n         procId = \"processorId=\" + pid;\n       }\n-      if (this.recipients != null && this.recipients.length <= 10) { // set a limit on recipients\n-        Breadcrumbs.setSendSide(procId + \" recipients=\" + Arrays.toString(this.recipients));\n+\n+      if (this.recipients != null && this.recipients.size() <= 10) { // set a limit on recipients\n+        Breadcrumbs.setSendSide(procId + \" recipients=\" + Arrays.toString(getRecipientsArray()));", "originalCommit": "b1ca00dd2d56be4ce4e13e545994b2501b05b128", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0dd1a883b33124e5eefda0bf0a0e72ea59022d9c", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\nindex 4b1ba34174..4fed3c1e97 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/DistributionMessage.java\n\n@@ -550,7 +529,7 @@ public abstract class DistributionMessage\n       }\n \n       if (this.recipients != null && this.recipients.size() <= 10) { // set a limit on recipients\n-        Breadcrumbs.setSendSide(procId + \" recipients=\" + Arrays.toString(getRecipientsArray()));\n+        Breadcrumbs.setSendSide(procId + \" recipients=\" + getRecipients());\n       } else {\n         if (procId.length() > 0) {\n           Breadcrumbs.setSendSide(procId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIwMzExOQ==", "url": "https://github.com/apache/geode/pull/4741#discussion_r385203119", "bodyText": "I think this could just be getRecipients().toString()", "author": "bschuchardt", "createdAt": "2020-02-27T16:00:35Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/tx/RemoteOperationMessage.java", "diffHunk": "@@ -417,18 +418,18 @@ public String toString() {\n    */\n   protected void appendFields(StringBuffer buff) {\n     buff.append(\"; sender=\").append(getSender()).append(\"; recipients=[\");\n-    InternalDistributedMember[] recips = getRecipientsArray();\n-    for (int i = 0; i < recips.length - 1; i++) {\n-      buff.append(recips[i]).append(',');\n+    List<InternalDistributedMember> recipients = getRecipients();", "originalCommit": "b1ca00dd2d56be4ce4e13e545994b2501b05b128", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "0dd1a883b33124e5eefda0bf0a0e72ea59022d9c", "url": "https://github.com/apache/geode/commit/0dd1a883b33124e5eefda0bf0a0e72ea59022d9c", "message": "GEODE-7820: Further clean up and removal of getRecipientsArray.", "committedDate": "2020-02-27T16:27:02Z", "type": "commit"}]}