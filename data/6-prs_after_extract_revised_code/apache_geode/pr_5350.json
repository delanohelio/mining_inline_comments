{"pr_number": 5350, "pr_title": "GEODE-8200: Rebalance operations stuck in \"IN_PROGRESS\" state forever", "pr_createdAt": "2020-07-07T00:43:05Z", "pr_url": "https://github.com/apache/geode/pull/5350", "timeline": [{"oid": "2c490f6ef7e64156b8accb260b668b4d038191ef", "url": "https://github.com/apache/geode/commit/2c490f6ef7e64156b8accb260b668b4d038191ef", "message": "DUnit test that reproduces the bug.\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-17T19:18:28Z", "type": "commit"}, {"oid": "9a3d9164c3c8b17172312e9ebad62772ddc2bbed", "url": "https://github.com/apache/geode/commit/9a3d9164c3c8b17172312e9ebad62772ddc2bbed", "message": "Check locator status before returning result\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-19T00:31:38Z", "type": "commit"}, {"oid": "4f38fd84b7f3321a54f5b3be3972b8e8fa3a8f88", "url": "https://github.com/apache/geode/commit/4f38fd84b7f3321a54f5b3be3972b8e8fa3a8f88", "message": "Remove temporary product change\n\nRecord locator as a string instead of InternalDistributedMember\nRemove temporary product change that is used for reproducing the bug\nRemove some debugging messages\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-23T18:42:41Z", "type": "commit"}, {"oid": "6d8006b92a2b23cffb7f33e4ac192c926cd00231", "url": "https://github.com/apache/geode/commit/6d8006b92a2b23cffb7f33e4ac192c926cd00231", "message": "spotlessApply\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-23T18:58:25Z", "type": "commit"}, {"oid": "825810c2717f20b04998ba2b7d831d584d40872c", "url": "https://github.com/apache/geode/commit/825810c2717f20b04998ba2b7d831d584d40872c", "message": "Refactor the code and fix unit test failures\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-27T00:13:49Z", "type": "commit"}, {"oid": "35c2e31a36b6a6b3a9489a4c593f35882fc287da", "url": "https://github.com/apache/geode/commit/35c2e31a36b6a6b3a9489a4c593f35882fc287da", "message": "Merge branch 'develop' into feature/GEODE-8200", "committedDate": "2020-06-27T01:22:12Z", "type": "commit"}, {"oid": "b11bee272cdeeb2b4f88d396cf3a2b67a302860d", "url": "https://github.com/apache/geode/commit/b11bee272cdeeb2b4f88d396cf3a2b67a302860d", "message": "add OperationManagementUpgradeTest", "committedDate": "2020-06-27T01:23:25Z", "type": "commit"}, {"oid": "268f0b4fb40cf62ff3780ee7529ac08902848b7f", "url": "https://github.com/apache/geode/commit/268f0b4fb40cf62ff3780ee7529ac08902848b7f", "message": "Fix deserialization error in rolling upgrade test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-06-27T01:26:35Z", "type": "commit"}, {"oid": "867a861887c372746be86dcaa89c0da74a85798c", "url": "https://github.com/apache/geode/commit/867a861887c372746be86dcaa89c0da74a85798c", "message": "Validate the locator in OperationHistoryManager\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-06T21:25:41Z", "type": "commit"}, {"oid": "04e96e33b6b947590f6c7e2c809315c03ebf074b", "url": "https://github.com/apache/geode/commit/04e96e33b6b947590f6c7e2c809315c03ebf074b", "message": "Add more tests\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-07T00:38:26Z", "type": "commit"}, {"oid": "6c5ba559fce3618894697a514cc48cc29b1b1d34", "url": "https://github.com/apache/geode/commit/6c5ba559fce3618894697a514cc48cc29b1b1d34", "message": "Fix the failure of serializable test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-07T17:28:47Z", "type": "commit"}, {"oid": "12f6a646962c8c1e90fe52418a5e5f3d1bd10f00", "url": "https://github.com/apache/geode/commit/12f6a646962c8c1e90fe52418a5e5f3d1bd10f00", "message": "Remove the rolling upgrade test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-07T17:59:08Z", "type": "commit"}, {"oid": "b4a890b09dc9056351157dd4f34388f5439b3058", "url": "https://github.com/apache/geode/commit/b4a890b09dc9056351157dd4f34388f5439b3058", "message": "Revert \"Remove the rolling upgrade test\"\n\nThis reverts commit 12f6a646962c8c1e90fe52418a5e5f3d1bd10f00.", "committedDate": "2020-07-07T19:39:22Z", "type": "commit"}, {"oid": "830650f602214758bb0535ea0467b668f9aef26e", "url": "https://github.com/apache/geode/commit/830650f602214758bb0535ea0467b668f9aef26e", "message": "Test rolling upgrade to 1.13 once it is available\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-07T19:55:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjIwNg==", "url": "https://github.com/apache/geode/pull/5350#discussion_r451826206", "bodyText": "this is just one line operation, is this not atomic? If not, can we put the synchronize on the method?", "author": "jinmeiliao", "createdAt": "2020-07-08T21:08:11Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationState.java", "diffHunk": "@@ -28,12 +28,25 @@\n  */\n public class OperationState<A extends ClusterManagementOperation<V>, V extends OperationResult>\n     implements Identifiable<String> {\n+  private static final long serialVersionUID = 8212319653561969588L;\n   private final String opId;\n   private final A operation;\n   private final Date operationStart;\n   private Date operationEnd;\n   private V result;\n   private Throwable throwable;\n+  private String locator;\n+\n+  public String getLocator() {\n+    return this.locator;\n+  }\n+\n+  public void setLocator(\n+      String locator) {\n+    synchronized (this) {", "originalCommit": "830650f602214758bb0535ea0467b668f9aef26e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4ODI3Nw==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452488277", "bodyText": "This is for consistency. setOperationEnd() does the same.", "author": "jchen21", "createdAt": "2020-07-09T21:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjIwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzU4Mg==", "url": "https://github.com/apache/geode/pull/5350#discussion_r451833582", "bodyText": "instead of adding this interface, you can change the method of recordStart() to add the a locator id parameter, since when started, we should always know what locator started this operation.", "author": "jinmeiliao", "createdAt": "2020-07-08T21:24:15Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java", "diffHunk": "@@ -53,6 +53,8 @@\n    */\n   <V extends OperationResult> void recordEnd(String opId, V result, Throwable exception);\n \n+  void recordLocator(String opId, String locator);", "originalCommit": "830650f602214758bb0535ea0467b668f9aef26e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4ODY0OA==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452488648", "bodyText": "Good point.", "author": "jchen21", "createdAt": "2020-07-09T21:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzU4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d4396d35a6a04930f67b15841c075d1657168216", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java b/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java\nindex c60b96498a..d2b8c1c293 100644\n--- a/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java\n+++ b/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java\n\n@@ -53,8 +53,6 @@ public interface OperationStateStore {\n    */\n   <V extends OperationResult> void recordEnd(String opId, V result, Throwable exception);\n \n-  void recordLocator(String opId, String locator);\n-\n   /**\n    * Removes an existing {@link OperationState}.\n    * If the instance is not found this is a no-op.\n"}}, {"oid": "d4396d35a6a04930f67b15841c075d1657168216", "url": "https://github.com/apache/geode/commit/d4396d35a6a04930f67b15841c075d1657168216", "message": "Move recordLocator to recordStart\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-09T22:24:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNzc1MQ==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452517751", "bodyText": "Can this be DistributedID than a String ID. That way we can avoid converting to string in other places?", "author": "agingade", "createdAt": "2020-07-09T22:09:20Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationState.java", "diffHunk": "@@ -28,12 +28,25 @@\n  */\n public class OperationState<A extends ClusterManagementOperation<V>, V extends OperationResult>\n     implements Identifiable<String> {\n+  private static final long serialVersionUID = 8212319653561969588L;\n   private final String opId;\n   private final A operation;\n   private final Date operationStart;\n   private Date operationEnd;\n   private V result;\n   private Throwable throwable;\n+  private String locator;", "originalCommit": "830650f602214758bb0535ea0467b668f9aef26e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNzI5Mg==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452537292", "bodyText": "Do you mean InternalDistributedMember when you talk about DistributedID? I was using the InternalDistributedMember as the type for locator field. But it is a large object with many fields. We only need to identify the locator, so a String type of a member's ID should be good.", "author": "jchen21", "createdAt": "2020-07-09T23:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNzc1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxODU3Nw==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452518577", "bodyText": "Does it need to be compared? can it be changed to \"equals\"....", "author": "agingade", "createdAt": "2020-07-09T22:11:43Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java", "diffHunk": "@@ -90,6 +95,27 @@ private static boolean isExpired(long expirationTime, OperationState<?, ?> opera\n     return operationEnd.getTime() <= expirationTime;\n   }\n \n+  private OperationState<?, ?> validateLocator(OperationState<?, ?> operationState) {\n+    if (isLocatorOffline(operationState)) {\n+      operationState.setOperationEnd(new Date(), null,\n+          new RuntimeException(\"Locator that initiated the Rest API operation is offline: \"\n+              + operationState.getLocator()));\n+    }\n+\n+    return operationState;\n+  }\n+\n+  private boolean isLocatorOffline(OperationState operationState) {\n+    if (operationState.getOperationEnd() == null\n+        && (operationState.getLocator() != null)\n+        && cache.getMyId().toString().compareTo(operationState.getLocator()) != 0", "originalCommit": "830650f602214758bb0535ea0467b668f9aef26e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNDU3NA==", "url": "https://github.com/apache/geode/pull/5350#discussion_r452534574", "bodyText": "Good point!", "author": "jchen21", "createdAt": "2020-07-09T22:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxODU3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d4396d35a6a04930f67b15841c075d1657168216", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java b/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java\nindex 8682fb22e2..3f0d9183c3 100644\n--- a/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java\n+++ b/geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java\n\n@@ -106,23 +106,20 @@ public class OperationHistoryManager {\n   }\n \n   private boolean isLocatorOffline(OperationState operationState) {\n-    if (operationState.getOperationEnd() == null\n+    return operationState.getOperationEnd() == null\n         && (operationState.getLocator() != null)\n         && cache.getMyId().toString().compareTo(operationState.getLocator()) != 0\n         && (!cache.getDistributedSystem().getAllOtherMembers().stream().map(Object::toString)\n-            .collect(Collectors.toSet()).contains(operationState.getLocator()))) {\n-      return true;\n-    }\n-    return false;\n+            .collect(Collectors.toSet()).contains(operationState.getLocator()));\n   }\n \n   /**\n    * Stores a new operation in the history and returns its unique identifier.\n    */\n-  public String recordStart(ClusterManagementOperation<?> op) {\n+  public String recordStart(ClusterManagementOperation<?> op, String locator) {\n     expireHistory();\n \n-    return operationStateStore.recordStart(op);\n+    return operationStateStore.recordStart(op, locator);\n   }\n \n   /**\n"}}, {"oid": "0062a1033ea757b9aa1a896017683affba6a5057", "url": "https://github.com/apache/geode/commit/0062a1033ea757b9aa1a896017683affba6a5057", "message": "Use equals for string comparison\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-09T23:11:37Z", "type": "commit"}, {"oid": "f4734da93b94bc56dbacd158e600205db46452c0", "url": "https://github.com/apache/geode/commit/f4734da93b94bc56dbacd158e600205db46452c0", "message": "Add the missing NOT operator\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>", "committedDate": "2020-07-10T18:43:26Z", "type": "commit"}]}