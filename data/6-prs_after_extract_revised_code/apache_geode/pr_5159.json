{"pr_number": 5159, "pr_title": "GEODE-7956: correct legal region names", "pr_createdAt": "2020-05-25T11:34:29Z", "pr_url": "https://github.com/apache/geode/pull/5159", "timeline": [{"oid": "6ae487653ae031d3fb484a20aa85f1ed6d8189f2", "url": "https://github.com/apache/geode/commit/6ae487653ae031d3fb484a20aa85f1ed6d8189f2", "message": "GEODE-7956: correct legal region names", "committedDate": "2020-05-25T11:32:23Z", "type": "commit"}, {"oid": "fed2d604e3acaab2c5b400212b9efb4ad2bfa4be", "url": "https://github.com/apache/geode/commit/fed2d604e3acaab2c5b400212b9efb4ad2bfa4be", "message": "allow square brackets due to test use", "committedDate": "2020-05-25T13:05:15Z", "type": "commit"}, {"oid": "751f1068038a1618609820a51bb780df1c061702", "url": "https://github.com/apache/geode/commit/751f1068038a1618609820a51bb780df1c061702", "message": "changes after comments", "committedDate": "2020-05-27T05:55:43Z", "type": "commit"}, {"oid": "a21f6ba7da6f18e86794c1baa0e1cab459e9c53f", "url": "https://github.com/apache/geode/commit/a21f6ba7da6f18e86794c1baa0e1cab459e9c53f", "message": "empty commit to re-launch CI", "committedDate": "2020-05-27T12:55:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw==", "url": "https://github.com/apache/geode/pull/5159#discussion_r432739787", "bodyText": "I don't understand why you changed this Pattern. I think GEODE-7956 was just about correcting the docs. It looks to me like you are expanding what a legal region name is to include square brackets. Did this get approved in a RFC? If not I think you should do so before this gets approved. In we end up keeping square brackets in region names then update GEODE-7956 to say we should and why it is valuable.", "author": "dschneider-pivotal", "createdAt": "2020-05-29T21:17:34Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/RegionNameValidation.java", "diffHunk": "@@ -24,7 +24,7 @@\n \n public class RegionNameValidation {\n \n-  private static final Pattern NAME_PATTERN = Pattern.compile(\"[aA-zZ0-9-_.]+\");\n+  private static final Pattern NAME_PATTERN = Pattern.compile(\"[a-zA-Z\\\\[\\\\]0-9-_.]+\");", "originalCommit": "a21f6ba7da6f18e86794c1baa0e1cab459e9c53f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0MTU1Mw==", "url": "https://github.com/apache/geode/pull/5159#discussion_r432741553", "bodyText": "I see your comment now about the old regex allowing extra characters. Can you enhance the RegionNameValidationTest to demonstrate that these were allowed before. I think it would be safest to just document all the characters already supported in a region name by the product and not change it. If someone already put one of those characters in their region name we done want to break them. I don't understand how the old regex let those sneak in. Did aA-zZ include ^, `, [, ], and backslash somehow?", "author": "dschneider-pivotal", "createdAt": "2020-05-29T21:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3NzQ3Mg==", "url": "https://github.com/apache/geode/pull/5159#discussion_r433077472", "bodyText": "I didn't find RFC for this, but old pattern include this characters and you can see it if you add logger for names in test startingWithMatchingCharactersAreOk in RegionNameValidationTest where it validates all characters which is allowed by this pattern.\nFrom ASCII table A is 65 and z is 122, and this part A-z include all characters between these two values, and this characters(^, `, [, ], and backslash) are between 91 and 96.\nOld pattern [aA-zZ0-9-_.]+ is the same as [A-z0-9-_.]+.\nSo we can go with change pattern to [A-z0-9-_.]+ and be sure that if someone is using it we don't break them. And also document all charactes which is allowed.\nDo you agree with that?", "author": "mkevo", "createdAt": "2020-06-01T07:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzM2Nw==", "url": "https://github.com/apache/geode/pull/5159#discussion_r433083367", "bodyText": "When I read aA-zZ I thought it was just a special regex pattern to match a-zA-Z. I bet whoever wrote this thought that. But since the product was already released with a pattern that allows those other characters it would be safest to continue to allow those characters. To make a breaking change I think we need an RFC. For now it is best to change the docs to describe the behavior of the existing geode release. We could schedule removing these special characters from region names in a future release. I think it would be good to rewrite the regex to still match what it did before but to do it more explicitly (something like a-zA-Z0-9-_.^`[]\\) or add comments to make clear what A-z matches. I also think it would be good to have some explicit test methods that show that these special characters are allowed in region names.\nThanks for figuring this out!", "author": "dschneider-pivotal", "createdAt": "2020-06-01T07:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA5MDI1Mg==", "url": "https://github.com/apache/geode/pull/5159#discussion_r433090252", "bodyText": "Yes, I agree. I also think that aA-zZ is the same as a-zA-Z.\nThe new regex will be [a-zA-Z0-9-_.^`[]\\]+. Is it ok with you?\nThis more clear to see what is included. I will also add separate tests for all of these characters.", "author": "mkevo", "createdAt": "2020-06-01T07:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzExMTI5OA==", "url": "https://github.com/apache/geode/pull/5159#discussion_r433111298", "bodyText": "Sounds perfect!", "author": "dschneider-pivotal", "createdAt": "2020-06-01T08:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczOTc4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "0c5fe076b3c9baa2f38f6f5003664a6aaa64fca8", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/internal/cache/RegionNameValidation.java b/geode-core/src/main/java/org/apache/geode/internal/cache/RegionNameValidation.java\nindex 3fcb7ca5b5..be72c2b329 100644\n--- a/geode-core/src/main/java/org/apache/geode/internal/cache/RegionNameValidation.java\n+++ b/geode-core/src/main/java/org/apache/geode/internal/cache/RegionNameValidation.java\n\n@@ -24,7 +24,7 @@ import org.apache.geode.cache.Region;\n \n public class RegionNameValidation {\n \n-  private static final Pattern NAME_PATTERN = Pattern.compile(\"[a-zA-Z\\\\[\\\\]0-9-_.]+\");\n+  private static final Pattern NAME_PATTERN = Pattern.compile(\"[a-zA-Z0-9-_.^`\\\\[\\\\]\\\\\\\\]+\");\n \n   static Pattern getNamePattern() {\n     return NAME_PATTERN;\n"}}, {"oid": "0c5fe076b3c9baa2f38f6f5003664a6aaa64fca8", "url": "https://github.com/apache/geode/commit/0c5fe076b3c9baa2f38f6f5003664a6aaa64fca8", "message": "add changes due to comments", "committedDate": "2020-06-01T08:47:11Z", "type": "commit"}, {"oid": "f4a62c7e5c011c9691d16efc5266e3bba54efba6", "url": "https://github.com/apache/geode/commit/f4a62c7e5c011c9691d16efc5266e3bba54efba6", "message": "fix typo", "committedDate": "2020-06-01T18:27:42Z", "type": "commit"}]}