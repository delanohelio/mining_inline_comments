{"pr_number": 5422, "pr_title": "GEODE-6950: hot loop in PrimaryHandler.processRequest()", "pr_createdAt": "2020-08-04T21:25:38Z", "pr_url": "https://github.com/apache/geode/pull/5422", "timeline": [{"oid": "09b4de556a290e8aef81d7d13767dca311d74610", "url": "https://github.com/apache/geode/commit/09b4de556a290e8aef81d7d13767dca311d74610", "message": "GEODE-6950: Locator can't start if a lot of clients already started\n\nI've implemented the suggested fix & added unit tests.  The\n\"processRequest\" test covers the fix.  I added a couple of other tests to\nmake sure the other primary paths through\nPrimaryHandler.processRequest() are covered.", "committedDate": "2020-08-04T21:18:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU0MzU1MQ==", "url": "https://github.com/apache/geode/pull/5422#discussion_r466543551", "bodyText": "Injecting the sleeper is a good idea", "author": "Bill", "createdAt": "2020-08-06T16:41:49Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/PrimaryHandler.java", "diffHunk": "@@ -39,9 +39,17 @@\n   private TcpServer tcpServer;\n   private int locatorWaitTime;\n \n-  PrimaryHandler(TcpHandler fallbackHandler, int locatorWaitTime) {\n+  @FunctionalInterface\n+  interface Sleeper {\n+    void sleep(long msToSleep) throws InterruptedException;\n+  }\n+\n+  private Sleeper sleeper;\n+\n+  PrimaryHandler(TcpHandler fallbackHandler, int locatorWaitTime, Sleeper sleeper) {", "originalCommit": "09b4de556a290e8aef81d7d13767dca311d74610", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4b8e18df6c67cf0d994453c53bed0cc37466d34f", "chunk": "diff --git a/geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/PrimaryHandler.java b/geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/PrimaryHandler.java\nindex bba1aa7ea8..03603c063d 100644\n--- a/geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/PrimaryHandler.java\n+++ b/geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/PrimaryHandler.java\n\n@@ -44,11 +44,20 @@ public class PrimaryHandler implements TcpHandler {\n     void sleep(long msToSleep) throws InterruptedException;\n   }\n \n+  @FunctionalInterface\n+  interface MillisecondProvider {\n+    long millisecondTime();\n+  }\n+\n+  private final MillisecondProvider millisecondProvider;\n   private Sleeper sleeper;\n \n-  PrimaryHandler(TcpHandler fallbackHandler, int locatorWaitTime, Sleeper sleeper) {\n+  PrimaryHandler(TcpHandler fallbackHandler, int locatorWaitTime,\n+      MillisecondProvider millisecondProvider,\n+      Sleeper sleeper) {\n     this.locatorWaitTime = locatorWaitTime;\n     this.fallbackHandler = fallbackHandler;\n+    this.millisecondProvider = millisecondProvider;\n     this.sleeper = sleeper;\n     allHandlers.add(fallbackHandler);\n   }\n"}}, {"oid": "4b8e18df6c67cf0d994453c53bed0cc37466d34f", "url": "https://github.com/apache/geode/commit/4b8e18df6c67cf0d994453c53bed0cc37466d34f", "message": "altered the test to have a deterministic clock", "committedDate": "2020-08-06T20:52:24Z", "type": "commit"}]}