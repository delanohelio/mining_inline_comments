{"pr_number": 4564, "pr_title": "GEODE-7649 upgrade tests fail when v1.11 is added to geode-old-versions", "pr_createdAt": "2020-01-06T20:01:00Z", "pr_url": "https://github.com/apache/geode/pull/4564", "timeline": [{"oid": "c11c856e0b12a409cd48e9f7fab26583e2b189af", "url": "https://github.com/apache/geode/commit/c11c856e0b12a409cd48e9f7fab26583e2b189af", "message": "GEODE-7649 upgrade tests fail when v1.11 is added to geode-old-versions\n\nGeode v1.11 inadvertently changed the form of its saved membership view\nby using a FileOutputStream to write it to disk instead of using\nan ObjectOutputStream.  The latter writes additional information during\nserialization.\n\nNote: there is already a test for this change that will start running\nwhen v1.12 is created and v1.11 is added as a geode-old-version in\nsettings.gradle.", "committedDate": "2020-01-06T19:53:12Z", "type": "commit"}, {"oid": "0cc482a10d749b5b88577bf8667570cd8c3e848c", "url": "https://github.com/apache/geode/commit/0cc482a10d749b5b88577bf8667570cd8c3e848c", "message": "corrected serialization in integration test", "committedDate": "2020-01-06T21:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxODgyNA==", "url": "https://github.com/apache/geode/pull/4564#discussion_r363518824", "bodyText": "Maybe flip this equals check Version.GEODE_1_11_0.equals(geodeVersion) - I think fromOrdinalNoThrow could return null if the version is not found?", "author": "upthewaterspout", "createdAt": "2020-01-06T22:44:19Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/GMSLocator.java", "diffHunk": "@@ -449,15 +450,21 @@ boolean recoverFromFile(File file) {\n \n       int version = ois.readInt();\n       int currentVersion = Version.getCurrentVersion().ordinal();\n-      DataInputStream input = new DataInputStream(fileInputStream);\n-      if (version != currentVersion) {\n+      DataInputStream input;\n+      if (version == currentVersion) {\n+        input = new DataInputStream(ois);\n+      } else if (version > currentVersion) {\n+        return false;\n+      } else {\n         Version geodeVersion = Version.fromOrdinalNoThrow((short) version, false);\n         logger.info(\"Peer locator found that persistent view was written with version {}\",\n             geodeVersion);\n-        if (version > currentVersion) {\n-          return false;\n+        if (geodeVersion.equals(Version.GEODE_1_11_0)) {", "originalCommit": "0cc482a10d749b5b88577bf8667570cd8c3e848c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9df4ffe8f57553dcd57d1a808a586e511a4b2fdc", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/GMSLocator.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/GMSLocator.java\nindex 09b8cafd13..f2119dec62 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/GMSLocator.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/membership/gms/locator/GMSLocator.java\n\n@@ -459,7 +459,7 @@ public class GMSLocator<ID extends MemberIdentifier> implements Locator<ID> {\n         Version geodeVersion = Version.fromOrdinalNoThrow((short) version, false);\n         logger.info(\"Peer locator found that persistent view was written with version {}\",\n             geodeVersion);\n-        if (geodeVersion.equals(Version.GEODE_1_11_0)) {\n+        if (Version.GEODE_1_11_0.equals(geodeVersion)) {\n           // v1.11 did not create the file with an ObjectOutputStream, so don't use one here\n           input = new VersionedDataInputStream(fileInputStream, geodeVersion);\n         } else {\n"}}, {"oid": "9df4ffe8f57553dcd57d1a808a586e511a4b2fdc", "url": "https://github.com/apache/geode/commit/9df4ffe8f57553dcd57d1a808a586e511a4b2fdc", "message": "flipping equals() check to avoid possible NPE", "committedDate": "2020-01-06T22:53:46Z", "type": "commit"}]}