{"pr_number": 5182, "pr_title": "GEODE-7591: Fix for hang in ClusterDistributionManager", "pr_createdAt": "2020-05-29T06:12:04Z", "pr_url": "https://github.com/apache/geode/pull/5182", "timeline": [{"oid": "756b4592ad78226f02ea10e91b116f50d1159479", "url": "https://github.com/apache/geode/commit/756b4592ad78226f02ea10e91b116f50d1159479", "message": "GEODE-7591: Fix for hang in ClusterDistributionManager\n\nAdded timeout after which it will be periodically checked whether\ndistribution manager is disconnecting while waiting on the membership\nview installation to avoid hanging", "committedDate": "2020-05-29T05:58:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwMTEzOA==", "url": "https://github.com/apache/geode/pull/5182#discussion_r436001138", "bodyText": "pauses like this often cause tests to periodically fail in CI.  Waiting for a semaphore to be triggered by the executor thread might be better.", "author": "bschuchardt", "createdAt": "2020-06-05T15:35:08Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java", "diffHunk": "@@ -370,6 +371,33 @@ public void testWaitForViewInstallation() {\n         .untilAsserted(() -> assertThat(waitForViewInstallationDone.get()).isTrue());\n   }\n \n+  /**\n+   * show that waitForViewInstallation works as expected when distribution manager is closed\n+   * while waiting for the latest membership view to install\n+   */\n+  @Test\n+  public void testWaitForViewInstallationDisconnectDS() {\n+    InternalDistributedSystem system = getSystem();\n+    ClusterDistributionManager dm = (ClusterDistributionManager) system.getDM();\n+    MembershipView<InternalDistributedMember> view = dm.getDistribution().getView();\n+\n+    AtomicBoolean waitForViewInstallationDone = new AtomicBoolean();\n+    executorService.submit(() -> {\n+      try {\n+        dm.waitForViewInstallation(view.getViewId() + 1);\n+        waitForViewInstallationDone.set(true);\n+      } catch (InterruptedException e) {\n+        errorCollector.addError(e);\n+      }\n+    });\n+\n+    await().timeout(2000, TimeUnit.MILLISECONDS);", "originalCommit": "756b4592ad78226f02ea10e91b116f50d1159479", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMzAxNw==", "url": "https://github.com/apache/geode/pull/5182#discussion_r436033017", "bodyText": "I don't think await() without an until of some sort does anything. It's the until clauses that start the waiting. I recommend using a CyclicBarrier to sync up the actions of the two threads and a Future to wait for completion:\nCyclicBarrier cyclicBarrier = new CyclicBarrier(2);\n\nFuture<Void> future = executorService.submit(() -> {\n  try {\n    cyclicBarrier.await(getTimeout().toMillis(), MILLISECONDS);\n    dm.waitForViewInstallation(view.getViewId() + 1);\n  } catch (InterruptedException e) {\n    errorCollector.addError(e);\n  }\n});\n\ncyclicBarrier.await(getTimeout().toMillis(), MILLISECONDS);\nsystem.disconnect();\n\nfuture.getTimeout().toMillis(), MILLISECONDS);\n\nThere's still no guarantee that the executor thread will actually be deep inside dm.waitForViewInstallation when the main thread calls disconnect, but there will be some percentage of CI runs that are hitting this scenario as desired. So as long as the test remains passing 100% of the time, we're confident enough that the scenario is tested and passing.\nTo really guarantee the exact combination of two threads being in specific places would require some crazy test hooks down in dm and/or system which would probably require some unnatural acts of coding (not recommended). Another approach is to write an IntegrationTest or UnitTest in which some of the classes involved are mocks or spies but even then it's nice to have the dunit coverage as well.", "author": "kirklund", "createdAt": "2020-06-05T16:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwMTEzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2NDA1NQ==", "url": "https://github.com/apache/geode/pull/5182#discussion_r437164055", "bodyText": "Thank you both for the comments and elaborate proposal! I will update test as Kirk suggested.", "author": "jvarenina", "createdAt": "2020-06-09T06:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwMTEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "4bfa40da4785acef81eec0b5419124d731b1822b", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java b/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\nindex 463370bb19..e5384899fe 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\n\n@@ -381,21 +387,24 @@ public class ClusterDistributionManagerDUnitTest extends CacheTestCase {\n     ClusterDistributionManager dm = (ClusterDistributionManager) system.getDM();\n     MembershipView<InternalDistributedMember> view = dm.getDistribution().getView();\n \n-    AtomicBoolean waitForViewInstallationDone = new AtomicBoolean();\n-    executorService.submit(() -> {\n+    CyclicBarrier cyclicBarrier = new CyclicBarrier(2);\n+    Future future = executorService.submit(() -> {\n       try {\n+        cyclicBarrier.await(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n         dm.waitForViewInstallation(view.getViewId() + 1);\n-        waitForViewInstallationDone.set(true);\n-      } catch (InterruptedException e) {\n+      } catch (InterruptedException | BrokenBarrierException | TimeoutException e) {\n         errorCollector.addError(e);\n       }\n     });\n \n-    await().timeout(2000, TimeUnit.MILLISECONDS);\n-    system.disconnect();\n-\n-    await()\n-        .untilAsserted(() -> assertThat(waitForViewInstallationDone.get()).isTrue());\n+    try {\n+      cyclicBarrier.await(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n+      system.disconnect();\n+      future.get(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n+    } catch (InterruptedException | TimeoutException | ExecutionException\n+        | BrokenBarrierException e) {\n+      errorCollector.addError(e);\n+    }\n   }\n \n   private CacheListener<String, String> getSleepingListener(final boolean playDead) {\n"}}, {"oid": "4bfa40da4785acef81eec0b5419124d731b1822b", "url": "https://github.com/apache/geode/commit/4bfa40da4785acef81eec0b5419124d731b1822b", "message": "DUnit test updated\n\n* CyclicBarrier thread synchronization used instad await()\n* Future used to wait for completion of test", "committedDate": "2020-06-09T08:46:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczMDUwMg==", "url": "https://github.com/apache/geode/pull/5182#discussion_r437730502", "bodyText": "You can delete the catch-block and use of errorCollector in the main thread. You only need to do that inside the Runnable that you submitted. From line 400 on, it's better to just let the Exceptions percolate out of the test method and let junit catch it.", "author": "kirklund", "createdAt": "2020-06-09T21:22:49Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java", "diffHunk": "@@ -370,6 +377,36 @@ public void testWaitForViewInstallation() {\n         .untilAsserted(() -> assertThat(waitForViewInstallationDone.get()).isTrue());\n   }\n \n+  /**\n+   * show that waitForViewInstallation works as expected when distribution manager is closed\n+   * while waiting for the latest membership view to install\n+   */\n+  @Test\n+  public void testWaitForViewInstallationDisconnectDS() {\n+    InternalDistributedSystem system = getSystem();\n+    ClusterDistributionManager dm = (ClusterDistributionManager) system.getDM();\n+    MembershipView<InternalDistributedMember> view = dm.getDistribution().getView();\n+\n+    CyclicBarrier cyclicBarrier = new CyclicBarrier(2);\n+    Future future = executorService.submit(() -> {\n+      try {\n+        cyclicBarrier.await(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n+        dm.waitForViewInstallation(view.getViewId() + 1);\n+      } catch (InterruptedException | BrokenBarrierException | TimeoutException e) {\n+        errorCollector.addError(e);\n+      }\n+    });\n+\n+    try {\n+      cyclicBarrier.await(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n+      system.disconnect();\n+      future.get(getTimeout().toMillis(), TimeUnit.MILLISECONDS);\n+    } catch (InterruptedException | TimeoutException | ExecutionException", "originalCommit": "4bfa40da4785acef81eec0b5419124d731b1822b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkyNDgyNg==", "url": "https://github.com/apache/geode/pull/5182#discussion_r437924826", "bodyText": "You are right! Done.", "author": "jvarenina", "createdAt": "2020-06-10T07:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczMDUwMg=="}], "type": "inlineReview", "revised_code": {"commit": "5e28f2cf55991148955fc2a1f1ff2283d82a1051", "chunk": "diff --git a/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java b/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\nindex e5384899fe..9d3bbd98b6 100644\n--- a/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\n+++ b/geode-core/src/distributedTest/java/org/apache/geode/distributed/internal/ClusterDistributionManagerDUnitTest.java\n\n@@ -382,7 +382,8 @@ public class ClusterDistributionManagerDUnitTest extends CacheTestCase {\n    * while waiting for the latest membership view to install\n    */\n   @Test\n-  public void testWaitForViewInstallationDisconnectDS() {\n+  public void testWaitForViewInstallationDisconnectDS()\n+      throws InterruptedException, TimeoutException, BrokenBarrierException, ExecutionException {\n     InternalDistributedSystem system = getSystem();\n     ClusterDistributionManager dm = (ClusterDistributionManager) system.getDM();\n     MembershipView<InternalDistributedMember> view = dm.getDistribution().getView();\n"}}, {"oid": "5e28f2cf55991148955fc2a1f1ff2283d82a1051", "url": "https://github.com/apache/geode/commit/5e28f2cf55991148955fc2a1f1ff2283d82a1051", "message": "DUnit test updated\n\nExceptions added to test method signature", "committedDate": "2020-06-10T07:34:45Z", "type": "commit"}]}