{"pr_number": 5188, "pr_title": "GEODE-8099: add dlock around cms create/delete operations.", "pr_createdAt": "2020-05-30T00:10:35Z", "pr_url": "https://github.com/apache/geode/pull/5188", "timeline": [{"oid": "1344f6c2a2f054520c5cacec585fce9f066019d7", "url": "https://github.com/apache/geode/commit/1344f6c2a2f054520c5cacec585fce9f066019d7", "message": "GEODE-8099: add dlock around cms create/delete operations.", "committedDate": "2020-06-01T21:08:28Z", "type": "forcePushed"}, {"oid": "51249618c93781f7637d3ebc84eed92f27dca2b8", "url": "https://github.com/apache/geode/commit/51249618c93781f7637d3ebc84eed92f27dca2b8", "message": "GEODE-8099: add dlock around cms create/delete operations.", "committedDate": "2020-06-02T16:00:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA5ODYwNA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r434098604", "bodyText": "This code change could loose code coverage for the constructor LocatorClusterManagementService(InternalCache cache, InternalConfigurationPersistenceService persistenceService). I don't see this constructor is covered anywhere else.", "author": "jchen21", "createdAt": "2020-06-02T18:39:49Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java", "diffHunk": "@@ -125,22 +127,48 @@ public void before() throws Exception {\n     doReturn(true).when(persistenceService).lockSharedConfiguration();\n     doNothing().when(persistenceService).unlockSharedConfiguration();\n     operationManager = mock(OperationManager.class);\n+    dLockService = mock(DistributedLockService.class);\n+\n     service =\n         spy(new LocatorClusterManagementService(cache, persistenceService, managers, validators,\n             memberValidator, cacheElementValidator, operationManager));\n+    doReturn(dLockService).when(service).getCmsDlockService();\n \n     regionConfig = new Region();\n     regionConfig.setName(\"region1\");\n \n     rebalanceOperation = new RebalanceOperation();\n   }\n \n+  @Test\n+  public void lockAndUnlockCalledAtCreate() {\n+    try {\n+      service.create(regionConfig);\n+    } catch (Exception ignore) {\n+    }\n+\n+    verify(dLockService).lock(LocatorClusterManagementService.CMS_NAME, -1, -1);\n+    verify(dLockService).unlock(LocatorClusterManagementService.CMS_NAME);\n+  }\n+\n+  @Test\n+  public void lockAndUnlockCalledAtDelete() {\n+    try {\n+      service.delete(regionConfig);\n+    } catch (Exception ignore) {\n+    }\n+\n+    verify(dLockService).lock(LocatorClusterManagementService.CMS_NAME, -1, -1);\n+    verify(dLockService).unlock(LocatorClusterManagementService.CMS_NAME);\n+  }\n+\n   @Test\n   public void create_persistenceIsNull() {\n     org.apache.geode.cache.Region<Object, Object> region =\n         mock(org.apache.geode.cache.Region.class);\n     when(cache.getRegion(any())).thenReturn(region);\n-    service = new LocatorClusterManagementService(cache, null);", "originalCommit": "1344f6c2a2f054520c5cacec585fce9f066019d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "chunk": "diff --git a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\nindex ae6b77aec1..f64c210239 100644\n--- a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n\n@@ -147,8 +147,8 @@ public class LocatorClusterManagementServiceTest {\n     } catch (Exception ignore) {\n     }\n \n-    verify(dLockService).lock(LocatorClusterManagementService.CMS_NAME, -1, -1);\n-    verify(dLockService).unlock(LocatorClusterManagementService.CMS_NAME);\n+    verify(dLockService).lock(LocatorClusterManagementService.CMS_DLOCK_SERVICE_NAME, -1, -1);\n+    verify(dLockService).unlock(LocatorClusterManagementService.CMS_DLOCK_SERVICE_NAME);\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExNDY5Mg==", "url": "https://github.com/apache/geode/pull/5188#discussion_r434114692", "bodyText": "It would be better to add some comment for this constant.", "author": "jchen21", "createdAt": "2020-06-02T19:08:46Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java", "diffHunk": "@@ -105,7 +107,12 @@\n import org.apache.geode.management.runtime.OperationResult;\n import org.apache.geode.management.runtime.RuntimeInfo;\n \n+/**\n+ * each locator will have one instance of this running if enabled\n+ */\n public class LocatorClusterManagementService implements ClusterManagementService {\n+  @VisibleForTesting\n+  static final String CMS_NAME = \"CMS_LOCK_SERVICE\";", "originalCommit": "1344f6c2a2f054520c5cacec585fce9f066019d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\nindex aca4d9569e..2404091991 100644\n--- a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n+++ b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n\n@@ -112,7 +112,8 @@ import org.apache.geode.management.runtime.RuntimeInfo;\n  */\n public class LocatorClusterManagementService implements ClusterManagementService {\n   @VisibleForTesting\n-  static final String CMS_NAME = \"CMS_LOCK_SERVICE\";\n+  // the dlock service name used by the CMS\n+  static final String CMS_DLOCK_SERVICE_NAME = \"CMS_DLOCK_SERVICE\";\n   private static final Logger logger = LogService.getLogger();\n   private final InternalConfigurationPersistenceService persistenceService;\n   private final Map<Class, ConfigurationManager> managers;\n"}}, {"oid": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "url": "https://github.com/apache/geode/commit/2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "message": "review changes", "committedDate": "2020-06-03T21:31:35Z", "type": "commit"}, {"oid": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "url": "https://github.com/apache/geode/commit/2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "message": "review changes", "committedDate": "2020-06-03T21:31:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4MTA1Mg==", "url": "https://github.com/apache/geode/pull/5188#discussion_r436081052", "bodyText": "I recommend moving all the field and var creations at the top, then move all the when blocks together, order both blocks in some way (I alphabetize), and then consider moving the subject(s) under test to the bottom of the setup method.\nI also recommend cleaning up any statics in tearDown that you've configured in setUp. For example: how to undo this statement in tearDown:\nBaseManagementService.setManagementService(cache, managementService);\n\nThe statics will still have this configured after each test completes.", "author": "kirklund", "createdAt": "2020-06-05T18:06:06Z", "path": "geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java", "diffHunk": "@@ -56,13 +57,38 @@ public void tearDown() {\n     }\n   }\n \n+  @Before\n+  public void setup() throws URISyntaxException {", "originalCommit": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "533e365eb93fef1a7fcb95525d17334c716183be", "chunk": "diff --git a/geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java b/geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\nsimilarity index 97%\nrename from geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java\nrename to geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\nindex 60d2d51936..c9b8971046 100644\n--- a/geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\n\n@@ -50,13 +49,6 @@ public class InternalLocatorClusterManagementServiceIntegrationTest {\n   private AgentUtil agentUtil;\n   private HttpService httpService;\n \n-  @After\n-  public void tearDown() {\n-    if (internalLocator != null) {\n-      internalLocator.stop();\n-    }\n-  }\n-\n   @Before\n   public void setup() throws URISyntaxException {\n     distributionConfig = mock(DistributionConfigImpl.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4NDkzNQ==", "url": "https://github.com/apache/geode/pull/5188#discussion_r436084935", "bodyText": "Let's move away from lazy-initializing and mutable fields and just make it final.\nI'm assuming you made it mutable for testing. This is where you typically want to chain more than one constructor. One of the constructors needs @VisibleForTesting and pass in the DistributedLockService (as a mock or whatever). The main public constructor can then create the DistributedLockService and pass it as a parameter to the next constructor. The test would use the next constructor that accepts a DistributedLockService.", "author": "kirklund", "createdAt": "2020-06-05T18:11:45Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java", "diffHunk": "@@ -114,6 +122,7 @@\n   private final MemberValidator memberValidator;\n   private final CommonConfigurationValidator commonValidator;\n   private final InternalCache cache;\n+  private DistributedLockService cmsDlockService;", "originalCommit": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMzIzMA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r437003230", "bodyText": "I tried your approach, but that affects lots of other integration tests that uses some API in InternalLocator that would start the cms service and hit error when they can't get the dlockservice to inject to it. So I had to revert it back", "author": "jinmeiliao", "createdAt": "2020-06-08T21:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4NDkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "533e365eb93fef1a7fcb95525d17334c716183be", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\nindex 2404091991..c91fcaa3ef 100644\n--- a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n+++ b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n\n@@ -122,14 +120,16 @@ public class LocatorClusterManagementService implements ClusterManagementService\n   private final MemberValidator memberValidator;\n   private final CommonConfigurationValidator commonValidator;\n   private final InternalCache cache;\n-  private DistributedLockService cmsDlockService;\n+  private final DistributedLockService cmsDlockService;\n \n   public LocatorClusterManagementService(InternalCache cache,\n-      InternalConfigurationPersistenceService persistenceService) {\n+      InternalConfigurationPersistenceService persistenceService,\n+      DistributedLockService cmsDlockService) {\n     this(cache, persistenceService, new ConcurrentHashMap<>(), new ConcurrentHashMap<>(),\n         new MemberValidator(cache, persistenceService), new CommonConfigurationValidator(),\n         new OperationManager(cache,\n-            new OperationHistoryManager(new RegionOperationStateStore(cache))));\n+            new OperationHistoryManager(new RegionOperationStateStore(cache))),\n+        cmsDlockService);\n     // initialize the list of managers\n     managers.put(Region.class, new RegionConfigManager(persistenceService));\n     managers.put(Pdx.class, new PdxManager(persistenceService));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwODYyMA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r436208620", "bodyText": "With these changes does this test need to become a unit test rather than an integration test?", "author": "mhansonp", "createdAt": "2020-06-05T23:45:33Z", "path": "geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java", "diffHunk": "@@ -56,13 +57,38 @@ public void tearDown() {\n     }\n   }\n \n+  @Before\n+  public void setup() throws URISyntaxException {\n+    distributionConfig = mock(DistributionConfigImpl.class);\n+    cache = mock(InternalCacheForClientAccess.class);\n+    managementService = mock(BaseManagementService.class);", "originalCommit": "2ce5ccb05c54fd2edc292fc9d68dc54db25992fd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "533e365eb93fef1a7fcb95525d17334c716183be", "chunk": "diff --git a/geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java b/geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\nsimilarity index 97%\nrename from geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java\nrename to geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\nindex 60d2d51936..c9b8971046 100644\n--- a/geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/InternalLocatorClusterManagementServiceIntegrationTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java\n\n@@ -50,13 +49,6 @@ public class InternalLocatorClusterManagementServiceIntegrationTest {\n   private AgentUtil agentUtil;\n   private HttpService httpService;\n \n-  @After\n-  public void tearDown() {\n-    if (internalLocator != null) {\n-      internalLocator.stop();\n-    }\n-  }\n-\n   @Before\n   public void setup() throws URISyntaxException {\n     distributionConfig = mock(DistributionConfigImpl.class);\n"}}, {"oid": "533e365eb93fef1a7fcb95525d17334c716183be", "url": "https://github.com/apache/geode/commit/533e365eb93fef1a7fcb95525d17334c716183be", "message": "review update", "committedDate": "2020-06-08T20:10:20Z", "type": "commit"}, {"oid": "b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "url": "https://github.com/apache/geode/commit/b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "message": "revert back to lazy dlock initialization\n\nSo many tests are affected by the previous change set. They are lots of integration tests that is not easy to update to inject the dlock service.", "committedDate": "2020-06-08T21:07:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1MzI5MQ==", "url": "https://github.com/apache/geode/pull/5188#discussion_r438353291", "bodyText": "Looking at BaseManagementService, this is the only instances.remove statement to remove an entry from the HashMap. Entries are put to the HashMap, but never removed individually. There is instances.clear, but it removes everything in the HashMap. This concern maybe outside the scope of this JIRA ticket though.", "author": "jchen21", "createdAt": "2020-06-10T19:17:49Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/BaseManagementService.java", "diffHunk": "@@ -94,6 +94,13 @@ public static void setManagementService(InternalCacheForClientAccess cache,\n     }\n   }\n \n+  @VisibleForTesting\n+  public static void clearManagementService(InternalCacheForClientAccess cache) {\n+    synchronized (instances) {\n+      instances.remove(cache);", "originalCommit": "b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA4MjY5Ng==", "url": "https://github.com/apache/geode/pull/5188#discussion_r439082696", "bodyText": "yeah, this is legacy code. for testing purpose, I had to add this here.", "author": "jinmeiliao", "createdAt": "2020-06-11T21:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1MzI5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4NjU1MQ==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440286551", "bodyText": "Is create expected to throw some Exception every time this test runs? If not, then let's remove the try-catch and add throws Exception clause to the method.", "author": "kirklund", "createdAt": "2020-06-15T16:07:50Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java", "diffHunk": "@@ -125,16 +127,41 @@ public void before() throws Exception {\n     doReturn(true).when(persistenceService).lockSharedConfiguration();\n     doNothing().when(persistenceService).unlockSharedConfiguration();\n     operationManager = mock(OperationManager.class);\n+    dLockService = mock(DistributedLockService.class);\n+\n     service =\n         spy(new LocatorClusterManagementService(cache, persistenceService, managers, validators,\n             memberValidator, cacheElementValidator, operationManager));\n+    doReturn(dLockService).when(service).getCmsDlockService();\n \n     regionConfig = new Region();\n     regionConfig.setName(\"region1\");\n \n     rebalanceOperation = new RebalanceOperation();\n   }\n \n+  @Test\n+  public void lockAndUnlockCalledAtCreate() {\n+    try {\n+      service.create(regionConfig);\n+    } catch (Exception ignore) {", "originalCommit": "b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjY3MA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440316670", "bodyText": "same as \"delete\" case.", "author": "jinmeiliao", "createdAt": "2020-06-15T16:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4NjU1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b5f87d877e95973ec44dbf4325e6e930e9cffde8", "chunk": "diff --git a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\nindex f64c210239..451bbbb9c6 100644\n--- a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n\n@@ -141,7 +141,7 @@ public class LocatorClusterManagementServiceTest {\n   }\n \n   @Test\n-  public void lockAndUnlockCalledAtCreate() {\n+  public void lockAndUnlockCalledAtCreateWithException() {\n     try {\n       service.create(regionConfig);\n     } catch (Exception ignore) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4Njg4OA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440286888", "bodyText": "Can we remove try-block and use throws Exception?", "author": "kirklund", "createdAt": "2020-06-15T16:08:24Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java", "diffHunk": "@@ -125,16 +127,41 @@ public void before() throws Exception {\n     doReturn(true).when(persistenceService).lockSharedConfiguration();\n     doNothing().when(persistenceService).unlockSharedConfiguration();\n     operationManager = mock(OperationManager.class);\n+    dLockService = mock(DistributedLockService.class);\n+\n     service =\n         spy(new LocatorClusterManagementService(cache, persistenceService, managers, validators,\n             memberValidator, cacheElementValidator, operationManager));\n+    doReturn(dLockService).when(service).getCmsDlockService();\n \n     regionConfig = new Region();\n     regionConfig.setName(\"region1\");\n \n     rebalanceOperation = new RebalanceOperation();\n   }\n \n+  @Test\n+  public void lockAndUnlockCalledAtCreate() {\n+    try {\n+      service.create(regionConfig);\n+    } catch (Exception ignore) {\n+    }\n+\n+    verify(dLockService).lock(LocatorClusterManagementService.CMS_DLOCK_SERVICE_NAME, -1, -1);\n+    verify(dLockService).unlock(LocatorClusterManagementService.CMS_DLOCK_SERVICE_NAME);\n+  }\n+\n+  @Test\n+  public void lockAndUnlockCalledAtDelete() {\n+    try {\n+      service.delete(regionConfig);\n+    } catch (Exception ignore) {", "originalCommit": "b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjI2NA==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440316264", "bodyText": "in this test setup, a NPE will already be thrown. This test is to make sure the two calls always get called when any exception happens. I changed the test method to be lockAndUnlockCalledAtDeleteWithException. And added the verification to another test setup when deletion is successful.", "author": "jinmeiliao", "createdAt": "2020-06-15T16:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4Njg4OA=="}], "type": "inlineReview", "revised_code": {"commit": "b5f87d877e95973ec44dbf4325e6e930e9cffde8", "chunk": "diff --git a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\nindex f64c210239..451bbbb9c6 100644\n--- a/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n+++ b/geode-core/src/test/java/org/apache/geode/management/internal/api/LocatorClusterManagementServiceTest.java\n\n@@ -141,7 +141,7 @@ public class LocatorClusterManagementServiceTest {\n   }\n \n   @Test\n-  public void lockAndUnlockCalledAtCreate() {\n+  public void lockAndUnlockCalledAtCreateWithException() {\n     try {\n       service.create(regionConfig);\n     } catch (Exception ignore) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4ODAzMw==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440288033", "bodyText": "This method should be synchronized since cmsDlockService is lazy initialized.", "author": "kirklund", "createdAt": "2020-06-15T16:10:13Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java", "diffHunk": "@@ -154,6 +163,24 @@ public LocatorClusterManagementService(\n     this.operationManager = operationManager;\n   }\n \n+  @VisibleForTesting\n+  DistributedLockService getCmsDlockService() {", "originalCommit": "b43402ca618b8f9a25edbe7c2bbdbc40da34925d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjM3NQ==", "url": "https://github.com/apache/geode/pull/5188#discussion_r440316375", "bodyText": "good catch.", "author": "jinmeiliao", "createdAt": "2020-06-15T16:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4ODAzMw=="}], "type": "inlineReview", "revised_code": {"commit": "b5f87d877e95973ec44dbf4325e6e930e9cffde8", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\nindex 2404091991..9ff83f8b88 100644\n--- a/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n+++ b/geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java\n\n@@ -164,7 +164,8 @@ public class LocatorClusterManagementService implements ClusterManagementService\n   }\n \n   @VisibleForTesting\n-  DistributedLockService getCmsDlockService() {\n+  // synchronized because cmsDlockService is lazily initialized\n+  synchronized DistributedLockService getCmsDlockService() {\n     if (cmsDlockService == null) {\n       cmsDlockService =\n           DLockService.getOrCreateService(CMS_DLOCK_SERVICE_NAME,\n"}}, {"oid": "b5f87d877e95973ec44dbf4325e6e930e9cffde8", "url": "https://github.com/apache/geode/commit/b5f87d877e95973ec44dbf4325e6e930e9cffde8", "message": "review update", "committedDate": "2020-06-15T16:54:51Z", "type": "commit"}]}