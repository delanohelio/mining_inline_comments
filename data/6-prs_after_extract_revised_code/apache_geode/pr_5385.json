{"pr_number": 5385, "pr_title": "GEODE-8370: Add test for maxInactiveInterval", "pr_createdAt": "2020-07-20T17:43:35Z", "pr_url": "https://github.com/apache/geode/pull/5385", "timeline": [{"oid": "f8d6847ed01ceaaeb2b208389c2df382ae8fa5ec", "url": "https://github.com/apache/geode/commit/f8d6847ed01ceaaeb2b208389c2df382ae8fa5ec", "message": "GEODE-8370: Add test for maxInactiveInterval", "committedDate": "2020-07-20T17:42:18Z", "type": "commit"}, {"oid": "4a56803cc528994ca90d0d5958bff4e2c24f7111", "url": "https://github.com/apache/geode/commit/4a56803cc528994ca90d0d5958bff4e2c24f7111", "message": "removes sout", "committedDate": "2020-07-20T17:47:21Z", "type": "commit"}, {"oid": "cf10b0c37aef6ea6e394edf3bec23da025f25d92", "url": "https://github.com/apache/geode/commit/cf10b0c37aef6ea6e394edf3bec23da025f25d92", "message": "tweaks", "committedDate": "2020-07-20T18:02:25Z", "type": "commit"}, {"oid": "f828df23af3d2b6b9f93e8669c3207b227cabe9c", "url": "https://github.com/apache/geode/commit/f828df23af3d2b6b9f93e8669c3207b227cabe9c", "message": "Corrects ByteInputStream", "committedDate": "2020-07-20T18:10:05Z", "type": "commit"}, {"oid": "d0938a4c341c1f839d0c5fc84f7ac8205d30149d", "url": "https://github.com/apache/geode/commit/d0938a4c341c1f839d0c5fc84f7ac8205d30149d", "message": "ignores irrelevant test in native redis", "committedDate": "2020-07-20T19:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjQ2MA==", "url": "https://github.com/apache/geode/pull/5385#discussion_r458216460", "bodyText": "Normally when I see an ignore on a test I want to know why the test is being ignored. I think it is something we could fix and then have this test. In this case I think we are overriding a test that we will never do with native redis. It seems like the empty method impl takes care of that and you would not need the ignore. This is just my opinion, I'd be okay if you leave the ignore if you think that is best.", "author": "dschneider-pivotal", "createdAt": "2020-07-21T16:08:20Z", "path": "geode-redis/src/acceptanceTest/java/session/NativeRedisSessionExpirationAcceptanceTest.java", "diffHunk": "@@ -50,4 +50,10 @@ public static void setup() {\n   public void sessionShouldTimeout_whenAppFailsOverToAnotherRedisServer() {\n     // Only using one server for Native Redis\n   }\n+\n+  @Test\n+  @Ignore", "originalCommit": "d0938a4c341c1f839d0c5fc84f7ac8205d30149d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyOTY5Mw==", "url": "https://github.com/apache/geode/pull/5385#discussion_r458229693", "bodyText": "Just updated it and took out the ignores!", "author": "sabbey37", "createdAt": "2020-07-21T16:28:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "be985ab3ba298db47a5083f154550ab37f3c9fa7", "chunk": "diff --git a/geode-redis/src/acceptanceTest/java/session/NativeRedisSessionExpirationAcceptanceTest.java b/geode-redis/src/acceptanceTest/java/session/NativeRedisSessionExpirationAcceptanceTest.java\nindex 880af7cad7..c6f1f9a6f2 100644\n--- a/geode-redis/src/acceptanceTest/java/session/NativeRedisSessionExpirationAcceptanceTest.java\n+++ b/geode-redis/src/acceptanceTest/java/session/NativeRedisSessionExpirationAcceptanceTest.java\n\n@@ -46,13 +45,11 @@ public class NativeRedisSessionExpirationAcceptanceTest extends SessionExpiratio\n   }\n \n   @Test\n-  @Ignore\n   public void sessionShouldTimeout_whenAppFailsOverToAnotherRedisServer() {\n     // Only using one server for Native Redis\n   }\n \n   @Test\n-  @Ignore\n   public void sessionShouldNotTimeout_whenPersisted() {\n     // Only using one server for Native Redis, no need to compare redundant copies\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMDY0Ng==", "url": "https://github.com/apache/geode/pull/5385#discussion_r458220646", "bodyText": "instead of the hard coded \"113\", ask the PartitionedRegion for its max bucket. See PartitionedRegion.getTotalNumberOfBuckets. This will help in the future when we allow the redis bucket count to be configured", "author": "dschneider-pivotal", "createdAt": "2020-07-21T16:14:24Z", "path": "geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionExpirationDUnitTest.java", "diffHunk": "@@ -86,15 +100,78 @@ public void sessionShouldTimeout_whenAppFailsOverToAnotherRedisServer() {\n     }\n   }\n \n+  @Test\n+  public void sessionShouldNotTimeout_whenPersisted() {\n+    String sessionCookie = createNewSessionWithNote(APP2, \"note1\");\n+    setMaxInactiveInterval(APP2, sessionCookie, -1);\n+\n+    compareMaxInactiveIntervals();\n+  }\n+\n   private void waitForTheSessionToExpire(String sessionId) {\n     GeodeAwaitility.await().ignoreExceptions().atMost((SHORT_SESSION_TIMEOUT + 5), TimeUnit.SECONDS)\n         .until(\n-            () -> jedisConnetedToServer1.ttl(\"spring:session:sessions:expires:\" + sessionId) < 0);\n+            () -> jedisConnetedToServer1.ttl(\"spring:session:sessions:expires:\" + sessionId) == -2);\n   }\n \n   private void refreshSession(String sessionCookie, int sessionApp) {\n     GeodeAwaitility.await()\n         .during(SHORT_SESSION_TIMEOUT + 2, TimeUnit.SECONDS)\n         .until(() -> getSessionNotes(sessionApp, sessionCookie) != null);\n   }\n+\n+  void setMaxInactiveInterval(int sessionApp, String sessionCookie, int maxInactiveInterval) {\n+    HttpHeaders requestHeaders = new HttpHeaders();\n+    requestHeaders.add(\"Cookie\", sessionCookie);\n+    HttpEntity<Integer> request = new HttpEntity<>(maxInactiveInterval, requestHeaders);\n+    new RestTemplate()\n+        .postForEntity(\n+            \"http://localhost:\" + ports.get(sessionApp) + \"/setMaxInactiveInterval\",\n+            request,\n+            Integer.class)\n+        .getHeaders();\n+  }\n+\n+  private void compareMaxInactiveIntervals() {\n+    cluster.getVM(1).invoke(() -> {\n+      for (int j = 0; j < 113; j++) {", "originalCommit": "d0938a4c341c1f839d0c5fc84f7ac8205d30149d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyOTgxMQ==", "url": "https://github.com/apache/geode/pull/5385#discussion_r458229811", "bodyText": "Good suggestion! Just updated it!", "author": "sabbey37", "createdAt": "2020-07-21T16:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMDY0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "be985ab3ba298db47a5083f154550ab37f3c9fa7", "chunk": "diff --git a/geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionExpirationDUnitTest.java b/geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionExpirationDUnitTest.java\nindex 49c5ca147f..abe15324a1 100644\n--- a/geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionExpirationDUnitTest.java\n+++ b/geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionExpirationDUnitTest.java\n\n@@ -134,9 +134,9 @@ public class SessionExpirationDUnitTest extends SessionDUnitTest {\n \n   private void compareMaxInactiveIntervals() {\n     cluster.getVM(1).invoke(() -> {\n-      for (int j = 0; j < 113; j++) {\n-        InternalCache cache = ClusterStartupRule.getCache();\n-        PartitionedRegion region = (PartitionedRegion) cache.getRegion(\"__REDIS_DATA\");\n+      InternalCache cache = ClusterStartupRule.getCache();\n+      PartitionedRegion region = (PartitionedRegion) cache.getRegion(\"__REDIS_DATA\");\n+      for (int j = 0; j < region.getTotalNumberOfBuckets(); j++) {\n         List<BucketDump> buckets = region.getAllBucketEntries(j);\n         if (buckets.isEmpty()) {\n           continue;\n"}}, {"oid": "be985ab3ba298db47a5083f154550ab37f3c9fa7", "url": "https://github.com/apache/geode/commit/be985ab3ba298db47a5083f154550ab37f3c9fa7", "message": "PR review changes", "committedDate": "2020-07-21T16:27:29Z", "type": "commit"}]}