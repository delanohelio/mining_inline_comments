{"pr_number": 5174, "pr_title": "GEODE-8166: reimplement redis expiration to use new data model", "pr_createdAt": "2020-05-28T07:17:59Z", "pr_url": "https://github.com/apache/geode/pull/5174", "timeline": [{"oid": "10402cfef3f0eb8104814b3f7bb6d1be11d5351f", "url": "https://github.com/apache/geode/commit/10402cfef3f0eb8104814b3f7bb6d1be11d5351f", "message": "refactored the delta code for RedisHash and RedisSet into AbstractRedisData\n\nadded timestamp field to RedisData and implemented serialization and delta for it\n\nactive expiration now implemented\n\nimplemented passive expiration\n\nAdds test for passive expiration", "committedDate": "2020-05-27T16:04:05Z", "type": "commit"}, {"oid": "50376e86f8d373fbd85ed2245ccb27ae6ba030d3", "url": "https://github.com/apache/geode/commit/50376e86f8d373fbd85ed2245ccb27ae6ba030d3", "message": "RedisString now subclasses AbstractRedisData", "committedDate": "2020-05-27T16:47:50Z", "type": "commit"}, {"oid": "29cfd358797111766187bea0574968f28835aa69", "url": "https://github.com/apache/geode/commit/29cfd358797111766187bea0574968f28835aa69", "message": "RedisStringInRegion will now do active expiration\nRedisKeyInRegion no longer needed the RegionProvider", "committedDate": "2020-05-27T18:46:53Z", "type": "commit"}, {"oid": "24801acca74ff373623129ac93ed345a984366d2", "url": "https://github.com/apache/geode/commit/24801acca74ff373623129ac93ed345a984366d2", "message": "fixed expiration on String commands\nrenabld some ignored expiration tests\nremoved the old expiration code", "committedDate": "2020-05-27T21:23:32Z", "type": "commit"}, {"oid": "1dd4e264e64d4b600b4de708ef0833308181183f", "url": "https://github.com/apache/geode/commit/1dd4e264e64d4b600b4de708ef0833308181183f", "message": "fixed some serialization issues", "committedDate": "2020-05-27T23:11:23Z", "type": "commit"}, {"oid": "8fd78f9a85880733df362d2eba2a7936e99a3169", "url": "https://github.com/apache/geode/commit/8fd78f9a85880733df362d2eba2a7936e99a3169", "message": "passive expiration now uses the correct hasExpired method", "committedDate": "2020-05-27T23:15:57Z", "type": "commit"}, {"oid": "be3b1aec2f68cce3c178b4be19b267c4f7d1f963", "url": "https://github.com/apache/geode/commit/be3b1aec2f68cce3c178b4be19b267c4f7d1f963", "message": "type command now uses function", "committedDate": "2020-05-27T23:33:53Z", "type": "commit"}, {"oid": "f6e1a665e8704671a9df4f1ecec8d5617c94b75c", "url": "https://github.com/apache/geode/commit/f6e1a665e8704671a9df4f1ecec8d5617c94b75c", "message": "fixed analyze serializables test", "committedDate": "2020-05-28T05:18:20Z", "type": "commit"}, {"oid": "5b6fc03624f312847a051b089689b3517f359e8f", "url": "https://github.com/apache/geode/commit/5b6fc03624f312847a051b089689b3517f359e8f", "message": "fixed smove", "committedDate": "2020-05-28T05:21:36Z", "type": "commit"}, {"oid": "f8ac51463cc8e250aaa05b695c17528465e1def2", "url": "https://github.com/apache/geode/commit/f8ac51463cc8e250aaa05b695c17528465e1def2", "message": "incr now uses function", "committedDate": "2020-05-28T05:22:53Z", "type": "commit"}, {"oid": "3350d217ba44842a20ba2f04428a69b84037102f", "url": "https://github.com/apache/geode/commit/3350d217ba44842a20ba2f04428a69b84037102f", "message": "decr now uses a function and is atomic", "committedDate": "2020-05-28T05:34:18Z", "type": "commit"}, {"oid": "74e34f44a0c67b19352c55fbdddedd7ece16afb2", "url": "https://github.com/apache/geode/commit/74e34f44a0c67b19352c55fbdddedd7ece16afb2", "message": "getset now uses a function and is atomic\nfixed an issue with the set commands doing expiration that caused them to do an extra network roundtrip", "committedDate": "2020-05-28T06:00:58Z", "type": "commit"}, {"oid": "42af3009f8558498a082d182dff0cf902047fdf0", "url": "https://github.com/apache/geode/commit/42af3009f8558498a082d182dff0cf902047fdf0", "message": "fixed exception handling of hincrby", "committedDate": "2020-05-28T06:15:39Z", "type": "commit"}, {"oid": "cf457882e369d45b7d3f5daf941e3644137cdcf7", "url": "https://github.com/apache/geode/commit/cf457882e369d45b7d3f5daf941e3644137cdcf7", "message": "fixed some of the exception messages for numerics", "committedDate": "2020-05-28T06:50:33Z", "type": "commit"}, {"oid": "adb5adb9a0e3648603d4297756d5cad8e61b3b5b", "url": "https://github.com/apache/geode/commit/adb5adb9a0e3648603d4297756d5cad8e61b3b5b", "message": "decrby and incrby now use functions and are atomic", "committedDate": "2020-05-28T07:15:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk1NTQyNQ==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431955425", "bodyText": "Is there a resion why we're calling expire separately instead of using a set option?", "author": "ringles", "createdAt": "2020-05-28T16:10:30Z", "path": "geode-redis/src/distributedTest/java/org/apache/geode/redis/executors/keys/PersistDUnitTest.java", "diffHunk": "@@ -134,10 +133,8 @@ public void testConcurrentPersistOperations() throws InterruptedException {\n \n   private void setKeysWithExpiration(Jedis jedis, Long iterationCount, String key) {\n     for (int i = 0; i < iterationCount; i++) {\n-      SetParams setParams = new SetParams();\n-      setParams.ex(600);\n-\n-      jedis.set(key + i, \"value\" + i, setParams);\n+      jedis.sadd(key + i, \"value\" + 9);\n+      jedis.expire(key + i, 600);", "originalCommit": "adb5adb9a0e3648603d4297756d5cad8e61b3b5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4MDQ0Mw==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431980443", "bodyText": "early on this branch, the new expiration was only working on sets and hashes. So I changed these tests to use sets instead of strings. It seems like this test is okay with any data type so I left it using a set.", "author": "dschneider-pivotal", "createdAt": "2020-05-28T16:49:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk1NTQyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk1Njg3MA==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431956870", "bodyText": "Is there a reason for switching from string values to Sets?", "author": "ringles", "createdAt": "2020-05-28T16:12:17Z", "path": "geode-redis/src/distributedTest/java/org/apache/geode/redis/executors/ExpireDUnitTest.java", "diffHunk": "@@ -115,7 +113,7 @@ public static void tearDown() {\n   public void expireOnOneServer_shouldPropagateToAllServers() {\n     String key = \"key\";\n \n-    jedis1.set(key, \"value\");\n+    jedis1.sadd(key, \"value\");", "originalCommit": "adb5adb9a0e3648603d4297756d5cad8e61b3b5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4MDM2OQ==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431980369", "bodyText": "early on this branch, the new expiration was only working on sets and hashes. So I changed these tests to use sets instead of strings. It seems like this test is okay with any data type so I left it using a set.", "author": "dschneider-pivotal", "createdAt": "2020-05-28T16:49:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk1Njg3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk2MTg5MA==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431961890", "bodyText": "To check my understanding - the jedis.keys() command will just get the keyset, but since it doesn't get the values of the keys it doesn't trigger the active expiration. Right?", "author": "ringles", "createdAt": "2020-05-28T16:19:07Z", "path": "geode-redis/src/integrationTest/java/org/apache/geode/redis/general/ExpireIntegrationTest.java", "diffHunk": "@@ -366,4 +371,12 @@ public void CallingExpireOnAKeyThatAlreadyHasAnExiprationTime_ShouldUpdateTheExp\n     Long timeToLive = jedis.ttl(key);\n     assertThat(timeToLive).isGreaterThan(21);\n   }\n+\n+  @Test\n+  public void should_passivelyExpireKeys() {\n+    jedis.sadd(\"key\", \"value\");\n+    jedis.pexpire(\"key\", 100);\n+\n+    GeodeAwaitility.await().until(() -> jedis.keys(\"key\").isEmpty());", "originalCommit": "adb5adb9a0e3648603d4297756d5cad8e61b3b5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3ODI4OA==", "url": "https://github.com/apache/geode/pull/5174#discussion_r431978288", "bodyText": "right", "author": "dschneider-pivotal", "createdAt": "2020-05-28T16:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk2MTg5MA=="}], "type": "inlineReview", "revised_code": null}]}