{"pr_number": 5246, "pr_title": "GEODE-8221: Commits session data prior to sending output to browser", "pr_createdAt": "2020-06-11T21:05:34Z", "pr_url": "https://github.com/apache/geode/pull/5246", "timeline": [{"oid": "9959568668839eb8ba5501d06f6b595f27707ffe", "url": "https://github.com/apache/geode/commit/9959568668839eb8ba5501d06f6b595f27707ffe", "message": "GEODE-8221: GEODE-8221: Fixes tests.", "committedDate": "2020-06-15T19:25:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzE2Ng==", "url": "https://github.com/apache/geode/pull/5246#discussion_r441207166", "bodyText": "Can you change this to use the AbstractCommitSessionValve's Logger (the static log variable) instead of the Context's logger? I'm not sure why its like this, but if we use the AbstractCommitSessionValve's Logger, then only 1 line in logging.properties is necessary to debug this class rather than 2:\norg.apache.geode.modules.session.level = FINE", "author": "boglesby", "createdAt": "2020-06-17T00:03:31Z", "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/AbstractCommitSessionValve.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.modules.session.catalina;\n+\n+import static org.apache.geode.util.internal.UncheckedUtils.uncheckedCast;\n+\n+import java.io.IOException;\n+\n+import javax.servlet.ServletException;\n+\n+import org.apache.catalina.Context;\n+import org.apache.catalina.Manager;\n+import org.apache.catalina.connector.Request;\n+import org.apache.catalina.connector.Response;\n+import org.apache.catalina.valves.ValveBase;\n+import org.apache.juli.logging.Log;\n+import org.apache.juli.logging.LogFactory;\n+\n+\n+public abstract class AbstractCommitSessionValve<SelfT extends AbstractCommitSessionValve<?>>\n+    extends ValveBase {\n+\n+  private static final Log log = LogFactory.getLog(AbstractCommitSessionValve.class);\n+\n+  protected static final String info =\n+      \"org.apache.geode.modules.session.catalina.CommitSessionValve/1.0\";\n+\n+  AbstractCommitSessionValve() {\n+    log.info(\"Initialized\");\n+  }\n+\n+  @Override\n+  public void invoke(final Request request, final Response response)\n+      throws IOException, ServletException {\n+    // Invoke the next Valve\n+    try {\n+      getNext().invoke(request, wrapResponse(response));\n+    } finally {\n+      commitSession(request);\n+    }\n+  }\n+\n+  /**\n+   * Commit session only if DeltaSessionManager is in place.\n+   *\n+   * @param request to commit session from.\n+   */\n+  protected static <SelfT extends AbstractCommitSessionValve<?>> void commitSession(\n+      final Request request) {\n+    final Context context = request.getContext();\n+    final Manager manager = context.getManager();\n+    if (manager instanceof DeltaSessionManager) {\n+      final DeltaSessionFacade session = (DeltaSessionFacade) request.getSession(false);\n+      if (session != null) {\n+        final DeltaSessionManager<SelfT> deltaSessionManager = uncheckedCast(manager);\n+        final Log contextLogger = context.getLogger();", "originalCommit": "9959568668839eb8ba5501d06f6b595f27707ffe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f9bf457251b69def3d33ab2fd0c4d0dd54728968", "chunk": "diff --git a/extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/AbstractCommitSessionValve.java b/extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/AbstractCommitSessionValve.java\nindex c60dcfcacf..47f5a27873 100644\n--- a/extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/AbstractCommitSessionValve.java\n+++ b/extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/AbstractCommitSessionValve.java\n\n@@ -14,13 +14,10 @@\n  */\n package org.apache.geode.modules.session.catalina;\n \n-import static org.apache.geode.util.internal.UncheckedUtils.uncheckedCast;\n-\n import java.io.IOException;\n \n import javax.servlet.ServletException;\n \n-import org.apache.catalina.Context;\n import org.apache.catalina.Manager;\n import org.apache.catalina.connector.Request;\n import org.apache.catalina.connector.Response;\n"}}, {"oid": "f9bf457251b69def3d33ab2fd0c4d0dd54728968", "url": "https://github.com/apache/geode/commit/f9bf457251b69def3d33ab2fd0c4d0dd54728968", "message": "GEODE-8221: Initial abstraction of CommitSessionValve", "committedDate": "2020-06-17T21:14:42Z", "type": "commit"}, {"oid": "c5a3091353c5ae161691487e2601810087f14113", "url": "https://github.com/apache/geode/commit/c5a3091353c5ae161691487e2601810087f14113", "message": "GEODE-8221: Initial Tomcat 8 implementation.", "committedDate": "2020-06-17T21:14:42Z", "type": "commit"}, {"oid": "b5926dad0addf877ceb7d6ecc0e1a1b4d81ef1a4", "url": "https://github.com/apache/geode/commit/b5926dad0addf877ceb7d6ecc0e1a1b4d81ef1a4", "message": "GEODE-8221: Wraps OutputBuffer to commit sessions.", "committedDate": "2020-06-17T21:14:42Z", "type": "commit"}, {"oid": "cb02dbfa0babef2b232a3cbffd7b5dca03d06beb", "url": "https://github.com/apache/geode/commit/cb02dbfa0babef2b232a3cbffd7b5dca03d06beb", "message": "GEODE-8221: Adds 7 and 9 support", "committedDate": "2020-06-17T21:14:42Z", "type": "commit"}, {"oid": "eedb422cd13b3e1e90e38f8190fe2df141b70607", "url": "https://github.com/apache/geode/commit/eedb422cd13b3e1e90e38f8190fe2df141b70607", "message": "GEODE-8221: GEODE-8221: Fixes tests.", "committedDate": "2020-06-17T21:14:43Z", "type": "commit"}, {"oid": "d20c6cfa9e919c1f077299e2aa88ef8b102bd64e", "url": "https://github.com/apache/geode/commit/d20c6cfa9e919c1f077299e2aa88ef8b102bd64e", "message": "Corrects issue with double wrapping that OutputBuffer.", "committedDate": "2020-06-18T19:52:07Z", "type": "commit"}, {"oid": "d20c6cfa9e919c1f077299e2aa88ef8b102bd64e", "url": "https://github.com/apache/geode/commit/d20c6cfa9e919c1f077299e2aa88ef8b102bd64e", "message": "Corrects issue with double wrapping that OutputBuffer.", "committedDate": "2020-06-18T19:52:07Z", "type": "forcePushed"}, {"oid": "b52f1a9458567615778f37d830a807489f35f2ed", "url": "https://github.com/apache/geode/commit/b52f1a9458567615778f37d830a807489f35f2ed", "message": "PR feedback", "committedDate": "2020-06-19T17:24:26Z", "type": "commit"}]}