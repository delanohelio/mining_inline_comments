{"pr_number": 4885, "pr_title": "GEODE-7938: change dev rest api to support slashes in key parameters", "pr_createdAt": "2020-03-30T19:28:23Z", "pr_url": "https://github.com/apache/geode/pull/4885", "timeline": [{"oid": "527ea8d8e4612880f30d8c9f1001ed7207e53386", "url": "https://github.com/apache/geode/commit/527ea8d8e4612880f30d8c9f1001ed7207e53386", "message": "keys are now decoded before being used\ntests have been added with encoded keys", "committedDate": "2020-03-30T19:26:03Z", "type": "commit"}, {"oid": "747a4ed056f7f6719227fdba62f6189d69ec843b", "url": "https://github.com/apache/geode/commit/747a4ed056f7f6719227fdba62f6189d69ec843b", "message": "delete now decodes its keys\nadded more tests of lists of keys with slashes", "committedDate": "2020-03-30T23:50:30Z", "type": "commit"}, {"oid": "22a52e3ee2780bf7b0825e347929fb0ef95796c5", "url": "https://github.com/apache/geode/commit/22a52e3ee2780bf7b0825e347929fb0ef95796c5", "message": "Merge branch 'develop' into rest-slashes", "committedDate": "2020-03-31T00:21:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MTU4OQ==", "url": "https://github.com/apache/geode/pull/4885#discussion_r400651589", "bodyText": "Have you considered just using the Spring annotations and patterns to match the remainder of the URL path?\n@RequestMapping(value = \"/{region}/**\", ...)\nand\nString[] keys = request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE).split(\",\")", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T05:27:20Z", "path": "geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java", "diffHunk": "@@ -295,12 +296,13 @@ protected String getRestApiVersion() {\n       @ApiResponse(code = 500, message = \"GemFire throws an error or exception.\")})\n   @PreAuthorize(\"@securityService.authorize('WRITE', #region, #keys)\")\n   public ResponseEntity<?> update(@PathVariable(\"region\") String region,\n-      @PathVariable(\"keys\") final String[] keys,\n+      @PathVariable(\"keys\") String[] keys,", "originalCommit": "22a52e3ee2780bf7b0825e347929fb0ef95796c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MTA1MA==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401071050", "bodyText": "It is not clear to me why using /** would be an better than the current solution. The current code is allowing spring to parse the pathvar into an array of String. Why is your way of doing it explicitly better? And how does this relate to supporting a slash in a key? Would your solution not require the keys to be encoded by the user? This /** solution is discouraged here: https://www.baeldung.com/spring-slash-character-in-url but so is encoding/decoding. The current code base already did decoding of each {region} pathvar so that is why I went with also decoding the {keys} pathvar. Also if we don't decode then the swagger page will not work with keys because swagger automatically encodes path and query vars when you execute the apis from the web page.", "author": "dschneider-pivotal", "createdAt": "2020-03-31T17:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MTU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA5ODUxNw==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401098517", "bodyText": "It relates to supporting slashes in the path without needing to encode them. It makes sense to do it they way you proposed if we are already expecting the region to be encoded.", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T17:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MTU4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cc60b74adfc566d213636cbaa5e85551f6ab7728", "chunk": "diff --git a/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java b/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\nindex 89946414d1..aa161b8799 100644\n--- a/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\n+++ b/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\n\n@@ -294,15 +294,14 @@ public class PdxBasedCrudController extends CommonCrudController {\n       @ApiResponse(code = 409,\n           message = \"For CAS, @old value does not match to the current value in region\"),\n       @ApiResponse(code = 500, message = \"GemFire throws an error or exception.\")})\n-  @PreAuthorize(\"@securityService.authorize('WRITE', #region, #keys)\")\n   public ResponseEntity<?> update(@PathVariable(\"region\") String region,\n-      @PathVariable(\"keys\") String[] keys,\n       @RequestParam(value = \"op\", defaultValue = \"PUT\") final String opValue,\n-      @RequestBody final String json) {\n+      @RequestBody final String json, HttpServletRequest request) {\n+    String[] keys = parseKeys(request, region);\n+    securityService.authorize(\"WRITE\", region, keys);\n     logger.debug(\"updating key(s) for region ({}) \", region);\n \n     region = decode(region);\n-    keys = decode(keys);\n \n     if (keys.length > 1) {\n       // putAll case\n"}}, {"oid": "cc60b74adfc566d213636cbaa5e85551f6ab7728", "url": "https://github.com/apache/geode/commit/cc60b74adfc566d213636cbaa5e85551f6ab7728", "message": "now uses ** instead of {keys}. This allows keys\nto have a slash in them without the client needing\nto encode the keys. Since the server no longer decodes\nthen this should not break any existing use cases.", "committedDate": "2020-03-31T22:37:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2MjgyMA==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401262820", "bodyText": "Curious... why write it like this?", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T22:56:57Z", "path": "geode-web-api/src/integrationTest/java/org/apache/geode/rest/internal/web/controllers/RestAccessControllerTest.java", "diffHunk": "@@ -182,8 +183,7 @@ public void postEntry() throws Exception {\n   @Test\n   @WithMockUser\n   public void postEntryWithSlashKey() throws Exception {\n-    String decodedKey = \"1/2\";\n-    String key = URLEncoder.encode(decodedKey, \"UTF-8\");\n+    String key = \"1\" + SLASH + \"2\";", "originalCommit": "cc60b74adfc566d213636cbaa5e85551f6ab7728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2OTc0MQ==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401269741", "bodyText": "I just wanted on easy way to be able to change the value of SLASH and have all the tests use it. I was curious about other special characters", "author": "dschneider-pivotal", "createdAt": "2020-03-31T23:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2MjgyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2MzIxOA==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401263218", "bodyText": "So does doing this now effect any swagger documentation or code generation?", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T22:58:08Z", "path": "geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java", "diffHunk": "@@ -196,10 +198,9 @@ protected String getRestApiVersion() {\n    * Reading data for set of keys\n    *\n    * @param region gemfire region name\n-   * @param keys string containing comma separated keys\n    * @return JSON document\n    */\n-  @RequestMapping(method = RequestMethod.GET, value = \"/{region}/{keys}\",\n+  @RequestMapping(method = RequestMethod.GET, value = \"/{region}/**\",", "originalCommit": "cc60b74adfc566d213636cbaa5e85551f6ab7728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3NjQ3MQ==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401276471", "bodyText": "swagger shows the endpoint as /v1/{region}/** which seems okay\nBut if you click try it out it gives you no way (that I could find) to specify a value for the **", "author": "dschneider-pivotal", "createdAt": "2020-03-31T23:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2MzIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3NzQzNw==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401277437", "bodyText": "Feels like there is no real good solution to this problem.", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T23:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2MzIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "88b5a4bc424f621e62a080896a768e0ee1c29039", "chunk": "diff --git a/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java b/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\nindex aa161b8799..ce2ddd4f13 100644\n--- a/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\n+++ b/geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/PdxBasedCrudController.java\n\n@@ -203,7 +203,7 @@ public class PdxBasedCrudController extends CommonCrudController {\n   @RequestMapping(method = RequestMethod.GET, value = \"/{region}/**\",\n       produces = APPLICATION_JSON_UTF8_VALUE)\n   @ApiOperation(value = \"read data for specific keys\",\n-      notes = \"Read data for specific set of keys in region.\")\n+      notes = \"Read data for specific set of keys in a region. The keys, ** in the endpoint, are a comma separated list.\")\n   @ApiResponses({@ApiResponse(code = 200, message = \"OK.\"),\n       @ApiResponse(code = 400, message = \"Bad Request.\"),\n       @ApiResponse(code = 401, message = \"Invalid Username or Password.\"),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2Mzg4Mw==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401263883", "bodyText": "Did request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE) not work?", "author": "pivotal-jbarrett", "createdAt": "2020-03-31T23:00:06Z", "path": "geode-web-api/src/main/java/org/apache/geode/rest/internal/web/controllers/AbstractBaseController.java", "diffHunk": "@@ -983,4 +974,16 @@ protected QueryService getQueryService() {\n     targetedMembers.add(cache.getDistributedSystem().getDistributedMember());\n     return targetedMembers;\n   }\n+\n+  protected String[] parseKeys(HttpServletRequest request, String region) {\n+    String uri = request.getRequestURI();", "originalCommit": "cc60b74adfc566d213636cbaa5e85551f6ab7728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2OTMzNw==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401269337", "bodyText": "No it did not. It gave the entire uri. This was in the context of the RestAccessControllerTest", "author": "dschneider-pivotal", "createdAt": "2020-03-31T23:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2Mzg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3MTE0Nw==", "url": "https://github.com/apache/geode/pull/4885#discussion_r401271147", "bodyText": "Another thing that did not do what was expected was \"request.getContextPath()\". It returned an empty string. I found an example that expected it to be the first part of the URL up to the start of {region}.", "author": "dschneider-pivotal", "createdAt": "2020-03-31T23:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2Mzg4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "88b5a4bc424f621e62a080896a768e0ee1c29039", "url": "https://github.com/apache/geode/commit/88b5a4bc424f621e62a080896a768e0ee1c29039", "message": "improved swagger docs", "committedDate": "2020-03-31T23:49:24Z", "type": "commit"}]}