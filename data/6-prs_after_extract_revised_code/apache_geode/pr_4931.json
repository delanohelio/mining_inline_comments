{"pr_number": 4931, "pr_title": "Geode 7751: fix for Tomcat9CachingClientServerTest.containersShouldExpireInSetTimeframe", "pr_createdAt": "2020-04-08T23:45:23Z", "pr_url": "https://github.com/apache/geode/pull/4931", "timeline": [{"oid": "4eb703d7cc0373d2764fc36eb6d5e58b6847cb45", "url": "https://github.com/apache/geode/commit/4eb703d7cc0373d2764fc36eb6d5e58b6847cb45", "message": "Cleaned up test", "committedDate": "2020-04-08T20:18:36Z", "type": "commit"}, {"oid": "b235ee1f361aa3cc863a441828807d211ac3e5d0", "url": "https://github.com/apache/geode/commit/b235ee1f361aa3cc863a441828807d211ac3e5d0", "message": "Spotless", "committedDate": "2020-04-08T20:21:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMjE5Mw==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406322193", "bodyText": "You should be able to delete the 2-second sleep. The very next line is an await.", "author": "kirklund", "createdAt": "2020-04-09T16:20:49Z", "path": "geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java", "diffHunk": "@@ -246,13 +250,14 @@ public void containersShouldExpireInSetTimeframe()\n \n     client.setPort(Integer.parseInt(manager.getContainerPort(0)));\n     Client.Response resp = client.set(key, value);\n-\n-    getKeyValueDataOnAllClients(key, value, resp.getSessionCookie());\n-\n-    client.setMaxInactive(1);\n-    Thread.sleep(5000);\n-\n-    verifySessionIsRemoved(key);\n+    await().untilAsserted(() -> getKeyValueDataOnAllClients(key, value, resp.getSessionCookie()));\n+    client.setMaxInactive(1); // max inactive time is 1 second. Lets wait a second.\n+    Thread.sleep(2000);", "originalCommit": "b235ee1f361aa3cc863a441828807d211ac3e5d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzMzIwMA==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406333200", "bodyText": "This sleep forces the timeout to expire so I cannot delete it.", "author": "mhansonp", "createdAt": "2020-04-09T16:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMjE5Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMzY1OA==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406323658", "bodyText": "It should be ok as is, but I recommend making the Logger static final because that's the standard.", "author": "kirklund", "createdAt": "2020-04-09T16:23:06Z", "path": "geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java", "diffHunk": "@@ -23,30 +25,32 @@\n import java.nio.file.Paths;\n import java.util.function.IntSupplier;\n \n+import org.apache.logging.log4j.Logger;\n import org.junit.After;\n import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.experimental.categories.Category;\n import org.junit.rules.TestName;\n \n+import org.apache.geode.internal.AvailablePortHelper;\n import org.apache.geode.internal.UniquePortSupplier;\n import org.apache.geode.logging.internal.log4j.api.LogService;\n import org.apache.geode.modules.session.functions.GetMaxInactiveInterval;\n-import org.apache.geode.test.awaitility.GeodeAwaitility;\n import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n import org.apache.geode.test.dunit.rules.MemberVM;\n import org.apache.geode.test.junit.categories.SessionTest;\n \n /**\n  * Base class for test of session replication.\n- *\n+ * <p>\n  * This class contains all of the tests of session replication functionality. Subclasses of this\n  * class configure different containers in order to run these tests against specific containers.\n  */\n @Category({SessionTest.class})\n public abstract class CargoTestBase {\n   private final UniquePortSupplier portSupplier = new UniquePortSupplier();\n+  Logger logger = LogService.getLogger();", "originalCommit": "b235ee1f361aa3cc863a441828807d211ac3e5d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDAwOA==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406334008", "bodyText": "yup.", "author": "mhansonp", "createdAt": "2020-04-09T16:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMzY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "b8009c6826c87486bf3cecd2555aa8c5b0af665b", "chunk": "diff --git a/geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java b/geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java\nindex 75523b9ae9..4ef5c786c2 100644\n--- a/geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java\n+++ b/geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java\n\n@@ -50,7 +50,7 @@ import org.apache.geode.test.junit.categories.SessionTest;\n @Category({SessionTest.class})\n public abstract class CargoTestBase {\n   private final UniquePortSupplier portSupplier = new UniquePortSupplier();\n-  Logger logger = LogService.getLogger();\n+  private static Logger logger = LogService.getLogger();\n \n   @Rule\n   public TestName testName = new TestName();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNjgyNA==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406326824", "bodyText": "await has a built-in sleep between each iteration, so you could delete this thread sleep as well.", "author": "kirklund", "createdAt": "2020-04-09T16:28:08Z", "path": "geode-assembly/src/distributedTest/java/org/apache/geode/session/tests/CargoTestBase.java", "diffHunk": "@@ -246,13 +250,14 @@ public void containersShouldExpireInSetTimeframe()\n \n     client.setPort(Integer.parseInt(manager.getContainerPort(0)));\n     Client.Response resp = client.set(key, value);\n-\n-    getKeyValueDataOnAllClients(key, value, resp.getSessionCookie());\n-\n-    client.setMaxInactive(1);\n-    Thread.sleep(5000);\n-\n-    verifySessionIsRemoved(key);\n+    await().untilAsserted(() -> getKeyValueDataOnAllClients(key, value, resp.getSessionCookie()));\n+    client.setMaxInactive(1); // max inactive time is 1 second. Lets wait a second.\n+    Thread.sleep(2000);\n+\n+    await().untilAsserted(() -> {\n+      verifySessionIsRemoved(key);\n+      Thread.sleep(1000);", "originalCommit": "b235ee1f361aa3cc863a441828807d211ac3e5d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDI4OQ==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406334289", "bodyText": "It was waiting a very small amount and setting the poll delay was not working.", "author": "mhansonp", "createdAt": "2020-04-09T16:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNjgyNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyODExOQ==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406328119", "bodyText": "This looks like debugging code that was left in. Delete it?", "author": "kirklund", "createdAt": "2020-04-09T16:30:10Z", "path": "geode-tcp-server/src/main/java/org/apache/geode/distributed/internal/tcpserver/AdvancedSocketCreatorImpl.java", "diffHunk": "@@ -97,6 +98,9 @@ public Socket connect(HostAndPort addr, int timeout,\n       InetSocketAddress inetSocketAddress = addr.getSocketInetAddress();\n       try {\n         socket.connect(inetSocketAddress, Math.max(timeout, 0));\n+      } catch (ConnectException connectException) {\n+        LogService.getLogger().info(\"Failed to connect to \" + inetSocketAddress);", "originalCommit": "b235ee1f361aa3cc863a441828807d211ac3e5d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDk0NQ==", "url": "https://github.com/apache/geode/pull/4931#discussion_r406334945", "bodyText": "This is debugging code, but it is necessary to leave in. When running multiple workers, it is not possible to tell them apart unless you have the address thrown in. For debugging testing I put this in, but I also think that is necessary generally speaking.", "author": "mhansonp", "createdAt": "2020-04-09T16:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyODExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b8009c6826c87486bf3cecd2555aa8c5b0af665b", "chunk": "diff --git a/geode-tcp-server/src/main/java/org/apache/geode/distributed/internal/tcpserver/AdvancedSocketCreatorImpl.java b/geode-tcp-server/src/main/java/org/apache/geode/distributed/internal/tcpserver/AdvancedSocketCreatorImpl.java\nindex 10bb310483..4a2cbd9491 100644\n--- a/geode-tcp-server/src/main/java/org/apache/geode/distributed/internal/tcpserver/AdvancedSocketCreatorImpl.java\n+++ b/geode-tcp-server/src/main/java/org/apache/geode/distributed/internal/tcpserver/AdvancedSocketCreatorImpl.java\n\n@@ -99,7 +101,7 @@ public class AdvancedSocketCreatorImpl implements AdvancedSocketCreator {\n       try {\n         socket.connect(inetSocketAddress, Math.max(timeout, 0));\n       } catch (ConnectException connectException) {\n-        LogService.getLogger().info(\"Failed to connect to \" + inetSocketAddress);\n+        logger.info(\"Failed to connect to \" + inetSocketAddress);\n         throw connectException;\n       } finally {\n         if (optionalWatcher != null) {\n"}}, {"oid": "b8009c6826c87486bf3cecd2555aa8c5b0af665b", "url": "https://github.com/apache/geode/commit/b8009c6826c87486bf3cecd2555aa8c5b0af665b", "message": "GEODE-7751: refactoring\n\n- making logger private static\n- removing debug logging I left in.", "committedDate": "2020-04-09T17:33:12Z", "type": "commit"}]}