{"pr_number": 4668, "pr_title": "GEODE-7760: NPE in Locator during auto-reconnect", "pr_createdAt": "2020-02-03T19:20:22Z", "pr_url": "https://github.com/apache/geode/pull/4668", "timeline": [{"oid": "d76da5baa10e50fbfa0d2cc6e288d724e0a6878d", "url": "https://github.com/apache/geode/commit/d76da5baa10e50fbfa0d2cc6e288d724e0a6878d", "message": "GEODE-7760: NPE in Locator during auto-reconnect", "committedDate": "2020-02-03T19:19:32Z", "type": "commit"}, {"oid": "609e8d897413a5aafc7249c8382d9629bb8fb431", "url": "https://github.com/apache/geode/commit/609e8d897413a5aafc7249c8382d9629bb8fb431", "message": "empty commit", "committedDate": "2020-02-03T20:14:52Z", "type": "commit"}, {"oid": "b6604d21c3825ab925d8d3390f83323c105b595e", "url": "https://github.com/apache/geode/commit/b6604d21c3825ab925d8d3390f83323c105b595e", "message": "fixes for stress-testing", "committedDate": "2020-02-03T22:22:44Z", "type": "commit"}, {"oid": "47e61b11135008426f2f8049ca7d7c74d3eeb8c2", "url": "https://github.com/apache/geode/commit/47e61b11135008426f2f8049ca7d7c74d3eeb8c2", "message": "working on another stresstest failure\n\nThis test passes all the time outside of stress testing", "committedDate": "2020-02-03T22:55:37Z", "type": "commit"}, {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167", "url": "https://github.com/apache/geode/commit/2e0c7189782806320b050b7081cc5bbbfbf96167", "message": "ignoring test that seems to have trouble with workingDir/configDir and temporary folders in stress testing", "committedDate": "2020-02-03T23:32:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzE1Mw==", "url": "https://github.com/apache/geode/pull/4668#discussion_r374407153", "bodyText": "don't want to mind-read here, what was the rationale for a local copy?", "author": "echobravopapa", "createdAt": "2020-02-03T23:52:09Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;", "originalCommit": "2e0c7189782806320b050b7081cc5bbbfbf96167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NzA5Nw==", "url": "https://github.com/apache/geode/pull/4668#discussion_r375357097", "bodyText": "this caches the value to ensure that it doesn't go null after this check", "author": "bschuchardt", "createdAt": "2020-02-05T16:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzE1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\nindex 0351c52de2..d7e0f70a47 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n\n@@ -778,14 +778,13 @@ public class InternalLocator extends Locator implements ConnectListener, LogConf\n     startConfigurationPersistenceService();\n \n     InternalCache myCache = this.internalCache;\n-    InternalLocator currentLocator = InternalLocator.locator;\n \n-    if (myCache == null || currentLocator == null) {\n+    if (myCache == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,\n-        currentLocator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(myCache,\n+        configurationPersistenceService);\n \n     // start management rest service\n     AgentUtil agentUtil = new AgentUtil(GemFireVersion.getGemFireVersion());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMzAzNQ==", "url": "https://github.com/apache/geode/pull/4668#discussion_r374413035", "bodyText": "should \"currentLocator.internalCache\" be changed to \"myCache\"?", "author": "dschneider-pivotal", "createdAt": "2020-02-04T00:12:56Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "originalCommit": "2e0c7189782806320b050b7081cc5bbbfbf96167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxMzE2Nw==", "url": "https://github.com/apache/geode/pull/4668#discussion_r375413167", "bodyText": "yes.  It looks like Aditya Anchuri added that code early in 2019.  I'll change it.", "author": "bschuchardt", "createdAt": "2020-02-05T17:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMzAzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\nindex 0351c52de2..d7e0f70a47 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n\n@@ -778,14 +778,13 @@ public class InternalLocator extends Locator implements ConnectListener, LogConf\n     startConfigurationPersistenceService();\n \n     InternalCache myCache = this.internalCache;\n-    InternalLocator currentLocator = InternalLocator.locator;\n \n-    if (myCache == null || currentLocator == null) {\n+    if (myCache == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,\n-        currentLocator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(myCache,\n+        configurationPersistenceService);\n \n     // start management rest service\n     AgentUtil agentUtil = new AgentUtil(GemFireVersion.getGemFireVersion());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNDYyMA==", "url": "https://github.com/apache/geode/pull/4668#discussion_r374414620", "bodyText": "If this expression is true it seems like we just silently returned without starting all of the locator's services. I have seen runs (recently) in which this happens because the InternalDistributedSystem does a concurrent InternalLocator.stop while another thread is executing the restart of this locator. So before returning here should this locator be marked in some way as not having been started? I think the thread that waits for this thread (the one executing startClusterManagementService) just joins and then says we are started.", "author": "dschneider-pivotal", "createdAt": "2020-02-04T00:18:26Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {", "originalCommit": "2e0c7189782806320b050b7081cc5bbbfbf96167", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\nindex 0351c52de2..d7e0f70a47 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n\n@@ -778,14 +778,13 @@ public class InternalLocator extends Locator implements ConnectListener, LogConf\n     startConfigurationPersistenceService();\n \n     InternalCache myCache = this.internalCache;\n-    InternalLocator currentLocator = InternalLocator.locator;\n \n-    if (myCache == null || currentLocator == null) {\n+    if (myCache == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,\n-        currentLocator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(myCache,\n+        configurationPersistenceService);\n \n     // start management rest service\n     AgentUtil agentUtil = new AgentUtil(GemFireVersion.getGemFireVersion());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNTEwMQ==", "url": "https://github.com/apache/geode/pull/4668#discussion_r374415101", "bodyText": "Since this is an instance method on InternalLocator, why don't we just use this.internalCache and this.configurationPersistenceService instead of trying to get the locator from a static. This method should be initializing itself.", "author": "dschneider-pivotal", "createdAt": "2020-02-04T00:20:06Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "originalCommit": "2e0c7189782806320b050b7081cc5bbbfbf96167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxNzAwMw==", "url": "https://github.com/apache/geode/pull/4668#discussion_r375417003", "bodyText": "yes, I agree.  I'm going to make a pass through InternalLocator and remove the use of the \"locator\" static wherever possible.  These uses all seem to come from cluster-configuration work.", "author": "bschuchardt", "createdAt": "2020-02-05T18:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNTEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\nindex 0351c52de2..d7e0f70a47 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java\n\n@@ -778,14 +778,13 @@ public class InternalLocator extends Locator implements ConnectListener, LogConf\n     startConfigurationPersistenceService();\n \n     InternalCache myCache = this.internalCache;\n-    InternalLocator currentLocator = InternalLocator.locator;\n \n-    if (myCache == null || currentLocator == null) {\n+    if (myCache == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,\n-        currentLocator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(myCache,\n+        configurationPersistenceService);\n \n     // start management rest service\n     AgentUtil agentUtil = new AgentUtil(GemFireVersion.getGemFireVersion());\n"}}, {"oid": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "url": "https://github.com/apache/geode/commit/b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "message": "remove use of static locator variable in InternalLocator.  added crash test.  unset shutdownHandled after locator restarts", "committedDate": "2020-02-05T23:46:17Z", "type": "commit"}, {"oid": "0de2ba169ce193487f3fbe36c8aa869a87b26677", "url": "https://github.com/apache/geode/commit/0de2ba169ce193487f3fbe36c8aa869a87b26677", "message": "fixing stresstest issues", "committedDate": "2020-02-06T19:12:19Z", "type": "commit"}]}