{"pr_number": 5739, "pr_title": "GEODE-8697: Propagate ForcedDisconnectException to the user application", "pr_createdAt": "2020-11-12T17:32:33Z", "pr_url": "https://github.com/apache/geode/pull/5739", "timeline": [{"oid": "377324373be9544a4b2b08d9497923217ff4b7ef", "url": "https://github.com/apache/geode/commit/377324373be9544a4b2b08d9497923217ff4b7ef", "message": "GEODE-8697: Propagate ForcedDisconnectException to the user application\n\navoid setting MemberDisconnectedException as a rootCause in\nClusterDistributionManager, even temporarily, as it's an internal\nexception that should not be exposed to applications.", "committedDate": "2020-11-12T17:06:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI5NjI4Mg==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522296282", "bodyText": "this line is the crucial part of the fix, no?", "author": "echobravopapa", "createdAt": "2020-11-12T17:44:44Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;\n+      Throwable cause = t;\n+      if (cause != null && !(cause instanceof ForcedDisconnectException)) {\n+        logger.info(\"cluster membership failed due to \", cause);\n+        cause = new ForcedDisconnectException(cause.getMessage());\n       }\n+      dm.setRootCause(cause);", "originalCommit": "377324373be9544a4b2b08d9497923217ff4b7ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0OTc2MA==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522349760", "bodyText": "yes.  The rest is a small refactor to make DMListener testable", "author": "bschuchardt", "createdAt": "2020-11-12T19:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI5NjI4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMzI2Ng==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522303266", "bodyText": "How is this connected to this issue?", "author": "echobravopapa", "createdAt": "2020-11-12T17:55:25Z", "path": "geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java", "diffHunk": "@@ -79,6 +79,7 @@ public static boolean skipLogMsgs(String type) {\n     expected.add(Pattern.compile(\"SystemAlertManager: A simple Alert.\"));\n \n     expected.add(Pattern.compile(\"org.apache.geode.management.DependenciesNotFoundException\"));\n+    expected.add(Pattern.compile(\"EntryNotFoundException\"));", "originalCommit": "377324373be9544a4b2b08d9497923217ff4b7ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0ODMwMQ==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522348301", "bodyText": "oops - that was left over from some debugging on another ticket.  I'll get rid of that.", "author": "bschuchardt", "createdAt": "2020-11-12T19:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMzI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "chunk": "diff --git a/geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java b/geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java\nindex e42c0d227c..2ca5d031fd 100644\n--- a/geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java\n+++ b/geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java\n\n@@ -79,7 +79,6 @@ public class ExpectedStrings {\n     expected.add(Pattern.compile(\"SystemAlertManager: A simple Alert.\"));\n \n     expected.add(Pattern.compile(\"org.apache.geode.management.DependenciesNotFoundException\"));\n-    expected.add(Pattern.compile(\"EntryNotFoundException\"));\n \n     // expected.add(Pattern.compile(\"Java version older than\"));\n     // expected.add(Pattern.compile(\"Minimum system requirements not met. Unexpected behavior may\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwNDc0MA==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522304740", "bodyText": "extra credit: could the comment \"// added for #37950\" be converted into some words; i.e. whatever that old issue was/fixed etc...", "author": "echobravopapa", "createdAt": "2020-11-12T17:57:37Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2357,9 +2361,9 @@ public void memberDeparted(InternalDistributedMember theId, boolean crashed, Str\n           message.setIgnoreAlertListenerRemovalFailure(true); // we don't know if it was a listener\n                                                               // so\n           // don't issue a warning\n-          message.setRecipient(localAddress);\n+          message.setRecipient(dm.getDistributionManagerId());\n           message.setReason(reason); // added for #37950", "originalCommit": "377324373be9544a4b2b08d9497923217ff4b7ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MzE0NQ==", "url": "https://github.com/apache/geode/pull/5739#discussion_r522353145", "bodyText": "I'll just delete that comment", "author": "bschuchardt", "createdAt": "2020-11-12T19:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwNDc0MA=="}], "type": "inlineReview", "revised_code": {"commit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "chunk": "diff --git a/geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java b/geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java\nindex 3df1c6eb3c..bc41c87af4 100644\n--- a/geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java\n+++ b/geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java\n\n@@ -2362,7 +2362,7 @@ public class ClusterDistributionManager implements DistributionManager {\n                                                               // so\n           // don't issue a warning\n           message.setRecipient(dm.getDistributionManagerId());\n-          message.setReason(reason); // added for #37950\n+          message.setReason(reason);\n           dm.handleIncomingDMsg(message);\n         }\n         dm.handleManagerDeparture(theId, crashed, reason);\n"}}, {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "url": "https://github.com/apache/geode/commit/6aa1066e719a31e09c012e9bbf78a6b8a3744531", "message": "addressing Ernie's comments", "committedDate": "2020-11-12T19:16:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjE4NA==", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286184", "bodyText": "Good improvement making this inner class static \u2713", "author": "Bill", "createdAt": "2020-11-13T23:38:24Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2283,7 +2288,7 @@ public Distribution getDistribution() {\n    * This is the listener implementation for responding from events from the Membership Manager.\n    *\n    */\n-  private class DMListener implements\n+  static class DMListener implements", "originalCommit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjI5Mw==", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286293", "bodyText": "ah now that this inner class is static we have to use an accessor to get at the test hooks \u2713", "author": "Bill", "createdAt": "2020-11-13T23:38:54Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;\n+      Throwable cause = t;\n+      if (cause != null && !(cause instanceof ForcedDisconnectException)) {\n+        logger.info(\"cluster membership failed due to \", cause);\n+        cause = new ForcedDisconnectException(cause.getMessage());\n       }\n+      dm.setRootCause(cause);\n       try {\n-        if (membershipTestHooks != null) {\n-          List<MembershipTestHook> l = membershipTestHooks;\n-          for (final MembershipTestHook aL : l) {\n-            MembershipTestHook dml = aL;\n-            dml.beforeMembershipFailure(reason, rootCause);\n+        List<MembershipTestHook> testHooks = dm.getMembershipTestHooks();", "originalCommit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjU2NQ==", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286565", "bodyText": "DMListener needs an accessor now ok", "author": "Bill", "createdAt": "2020-11-13T23:39:50Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2209,6 +2209,11 @@ private void removeAllHealthMonitors() {\n     }\n   }\n \n+  private List<MembershipTestHook> getMembershipTestHooks() {\n+    return membershipTestHooks;\n+  }", "originalCommit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NzA5NA==", "url": "https://github.com/apache/geode/pull/5739#discussion_r523287094", "bodyText": "It's a little bit surprising that the ClusterDistributionManager test, mocks the ClusterDistributionManager ;-) But I get it and it's ok. It's really a test of the inner DMListener \u2713", "author": "Bill", "createdAt": "2020-11-13T23:42:07Z", "path": "geode-core/src/test/java/org/apache/geode/distributed/internal/ClusterDistributionManagerTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.distributed.internal;\n+\n+import static org.mockito.ArgumentMatchers.isA;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+import org.junit.Test;\n+\n+import org.apache.geode.ForcedDisconnectException;\n+import org.apache.geode.distributed.internal.membership.api.MemberDisconnectedException;\n+\n+public class ClusterDistributionManagerTest {\n+\n+  @Test\n+  public void membershipFailureProcessingCreatesForcedDisconnectException() {\n+    ClusterDistributionManager manager = mock(ClusterDistributionManager.class);", "originalCommit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg0MDI1NA==", "url": "https://github.com/apache/geode/pull/5739#discussion_r523840254", "bodyText": "Can we please start renaming back variables to something more meaningful.", "author": "kohlmu-pivotal", "createdAt": "2020-11-16T00:41:28Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;", "originalCommit": "6aa1066e719a31e09c012e9bbf78a6b8a3744531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}