{"pr_number": 5351, "pr_title": "GEODE-8338: Redis commands may be repeated when server dies", "pr_createdAt": "2020-07-07T21:26:42Z", "pr_url": "https://github.com/apache/geode/pull/5351", "timeline": [{"oid": "1f95e8e1072387a2fdbcd8db9c3411751549cc8c", "url": "https://github.com/apache/geode/commit/1f95e8e1072387a2fdbcd8db9c3411751549cc8c", "message": "GEODE-8338: Redis commands may be repeated when server dies", "committedDate": "2020-07-07T21:25:50Z", "type": "commit"}, {"oid": "b1d9088dc54b3c89a356446e0ae832ca2e57b902", "url": "https://github.com/apache/geode/commit/b1d9088dc54b3c89a356446e0ae832ca2e57b902", "message": "fixed HashAndCrashes test by adding exception handling", "committedDate": "2020-07-07T22:02:11Z", "type": "commit"}, {"oid": "15aa38c7d12674f07a6714f1ab8efeccdde56f50", "url": "https://github.com/apache/geode/commit/15aa38c7d12674f07a6714f1ab8efeccdde56f50", "message": "CommandFunction invoke will now retry if BucketMoved is thrown.\nAdded a sleep before returning an error that a server crashed", "committedDate": "2020-07-08T06:04:11Z", "type": "commit"}, {"oid": "da6e5f7a7d000d52a431c7282c25996851c5ad5e", "url": "https://github.com/apache/geode/commit/da6e5f7a7d000d52a431c7282c25996851c5ad5e", "message": "Adds retry logic to session dunit tests", "committedDate": "2020-07-08T15:16:33Z", "type": "commit"}, {"oid": "ce36bb81c6fd1be6ba2e19bf9a69a00fdd20ee4d", "url": "https://github.com/apache/geode/commit/ce36bb81c6fd1be6ba2e19bf9a69a00fdd20ee4d", "message": "now retries function on PrimaryBucketException", "committedDate": "2020-07-08T16:10:15Z", "type": "commit"}, {"oid": "6ce70326d1335bd3fd7d0ff4bd45e262490e8365", "url": "https://github.com/apache/geode/commit/6ce70326d1335bd3fd7d0ff4bd45e262490e8365", "message": "now handles FunctionException with nested BucketMovedException", "committedDate": "2020-07-08T16:40:49Z", "type": "commit"}, {"oid": "e7288a5d70ab0728915547c25411ae3edcf3a55f", "url": "https://github.com/apache/geode/commit/e7288a5d70ab0728915547c25411ae3edcf3a55f", "message": "more exception handling retry", "committedDate": "2020-07-08T17:02:34Z", "type": "commit"}, {"oid": "a8cf6ed2308aea91cbdf202cd9db3b22dad72896", "url": "https://github.com/apache/geode/commit/a8cf6ed2308aea91cbdf202cd9db3b22dad72896", "message": "fixed index out of bounds exception", "committedDate": "2020-07-08T17:37:17Z", "type": "commit"}, {"oid": "345491c85e87d4a2d90c966b66806e1aa9ef4f66", "url": "https://github.com/apache/geode/commit/345491c85e87d4a2d90c966b66806e1aa9ef4f66", "message": "more exception handling work\nalso fixed a race in registering the function after the region is created\nalso added retry logic to some tests", "committedDate": "2020-07-08T21:23:39Z", "type": "commit"}, {"oid": "5927c11499ae62a9cebc9ae94661ddf0843a5b7f", "url": "https://github.com/apache/geode/commit/5927c11499ae62a9cebc9ae94661ddf0843a5b7f", "message": "more test retry logic", "committedDate": "2020-07-08T23:18:32Z", "type": "commit"}, {"oid": "e7ccb675b030ae57f7bf575d85e7b052486831d5", "url": "https://github.com/apache/geode/commit/e7ccb675b030ae57f7bf575d85e7b052486831d5", "message": "improved handling of FunctionInvocationTargetException\nwe no longer retry on this acception since the application\nneeds to decide if the op needs to be done again", "committedDate": "2020-07-09T16:57:07Z", "type": "commit"}, {"oid": "37097e67bc8c941a9017619a02ca00d811844c6c", "url": "https://github.com/apache/geode/commit/37097e67bc8c941a9017619a02ca00d811844c6c", "message": "test now do a better job of handling retry if a server departs\nremoved a sleep that was added before failing due to a server departing", "committedDate": "2020-07-09T18:10:58Z", "type": "commit"}, {"oid": "c29b3d9e686ef696186977850dbf253723e8f4ae", "url": "https://github.com/apache/geode/commit/c29b3d9e686ef696186977850dbf253723e8f4ae", "message": "refactored how functions are invoked so that both\nthe CommandFunction and RenameFunction would have consistent retry logic", "committedDate": "2020-07-09T22:11:14Z", "type": "commit"}, {"oid": "8e9ad68d2415fefabe1ffac3c42a836621b0fa90", "url": "https://github.com/apache/geode/commit/8e9ad68d2415fefabe1ffac3c42a836621b0fa90", "message": "added missing file", "committedDate": "2020-07-09T22:29:24Z", "type": "commit"}, {"oid": "b1220716df44d7dee12925d147559a051e812f66", "url": "https://github.com/apache/geode/commit/b1220716df44d7dee12925d147559a051e812f66", "message": "fixed some compiler warnings", "committedDate": "2020-07-09T23:36:28Z", "type": "commit"}, {"oid": "5eea2da922377fa0a4315cad6e16617519e5217e", "url": "https://github.com/apache/geode/commit/5eea2da922377fa0a4315cad6e16617519e5217e", "message": "changed computeWithPrimaryLocked to throw new PrimaryBucketLockException\nif it fails to lock the primary down for computation.\nThe function invoke retry logic now only retries if it sees\na PrimaryBucketLockException or if the function is not\nregistered yet.", "committedDate": "2020-07-10T17:20:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5OTIzOQ==", "url": "https://github.com/apache/geode/pull/5351#discussion_r453099239", "bodyText": "I'd prefer to see this retry logic happen in the Controller, but we can make that change later.", "author": "jdeppe-pivotal", "createdAt": "2020-07-10T22:08:01Z", "path": "geode-redis/src/distributedTest/java/org/apache/geode/redis/session/SessionDUnitTest.java", "diffHunk": "@@ -144,26 +146,51 @@ protected String createNewSessionWithNote(int sessionApp, String note) {\n     HttpHeaders requestHeaders = new HttpHeaders();\n     requestHeaders.add(\"Cookie\", sessionCookie);\n     HttpEntity<String> request2 = new HttpEntity<>(\"\", requestHeaders);\n-\n-    return new RestTemplate()\n-        .exchange(\n-            \"http://localhost:\" + ports.get(sessionApp) + \"/getSessionNotes\",\n-            HttpMethod.GET,\n-            request2,\n-            String[].class)\n-        .getBody();\n+    boolean sesssionObtained = false;\n+    String[] responseBody = new String[0];\n+    do {\n+      try {\n+        responseBody = new RestTemplate()\n+            .exchange(\n+                \"http://localhost:\" + ports.get(sessionApp) + \"/getSessionNotes\",\n+                HttpMethod.GET,\n+                request2,\n+                String[].class)\n+            .getBody();\n+        sesssionObtained = true;\n+      } catch (HttpServerErrorException e) {\n+        if (e.getMessage().contains(\"Internal Server Error\")) {\n+          // retry\n+        } else {\n+          throw e;\n+        }\n+      }\n+    } while (!sesssionObtained);\n+    return responseBody;", "originalCommit": "5eea2da922377fa0a4315cad6e16617519e5217e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwMzU2MQ==", "url": "https://github.com/apache/geode/pull/5351#discussion_r453103561", "bodyText": "Is the Controller part of the product or part of this test app?", "author": "dschneider-pivotal", "createdAt": "2020-07-10T22:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5OTIzOQ=="}], "type": "inlineReview", "revised_code": null}]}