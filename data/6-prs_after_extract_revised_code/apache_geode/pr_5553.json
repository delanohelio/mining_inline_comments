{"pr_number": 5553, "pr_title": "GEODE-8536: Allow limited retries when creating Lucene IndexWriter", "pr_createdAt": "2020-09-25T16:12:05Z", "pr_url": "https://github.com/apache/geode/pull/5553", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyNjgxNQ==", "url": "https://github.com/apache/geode/pull/5553#discussion_r498526815", "bodyText": "Do you think the number of retries is enough?\nBased on the original ticket description, the IOException thrown is caused by \"LuceneEventListener is asynchronously updating the fileAndChunkRegion\". Do we know if the wait is enough for the updating to finish? Is it a problem if IndexWriter creation needs to wait longer for the resources to be freed?\nDo we know \"updating the fileAndChunkRegion\" usually do not require a minute to finish, or we actually hit this issue due to different threads keep updating the fileAndChunkRegion? If so, we can decide the number of attempts and whether the wait needs to be using different intervals.\nIf we do not know answers for these, I think this code change is fine to fix the StackOverflowError.", "author": "pivotal-eshu", "createdAt": "2020-10-01T21:39:55Z", "path": "geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java", "diffHunk": "@@ -44,6 +44,7 @@\n   private static final Logger logger = LogService.getLogger();\n   public static final String FILE_REGION_LOCK_FOR_BUCKET_ID = \"FileRegionLockForBucketId:\";\n   public static final String APACHE_GEODE_INDEX_COMPLETE = \"APACHE_GEODE_INDEX_COMPLETE\";\n+  protected static final int GET_INDEX_WRITER_MAX_ATTEMPTS = 10;", "originalCommit": "c54594d47bf8a1fd19114e18cd73ef3ba5e789bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMTk0OQ==", "url": "https://github.com/apache/geode/pull/5553#discussion_r499011949", "bodyText": "As I understand it, the timing window to hit the IOException is quite small and difficult to hit, since this problem only shows up in about 1 in 1000 runs of the test I used to diagnose the issue. If the fileAndChunkRegion was unavailable for a long period of time, I would expect to see this issue reproduce more often. After running some experiments, I was able to increase the number of retries to 200 without any noticeable negative effects, which would increase the time window during which IOExceptions would have to be consistently encountered and an exception thrown to 1 second, which should help reduce the chances of encountering it. However, I don't think it's possible to know for certain how long the fileAndChunkRegion might be unavailable, since that could change based on the operation being used on it, the size of the region, current system resources etc.", "author": "DonalEvans", "createdAt": "2020-10-02T19:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyNjgxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8afd208962f536d0676ccfd9f2a91795ad25ced1", "chunk": "diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java\nindex ceed72b42e..7db8b96f20 100644\n--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java\n+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java\n\n@@ -44,7 +44,7 @@ public class IndexRepositoryFactory {\n   private static final Logger logger = LogService.getLogger();\n   public static final String FILE_REGION_LOCK_FOR_BUCKET_ID = \"FileRegionLockForBucketId:\";\n   public static final String APACHE_GEODE_INDEX_COMPLETE = \"APACHE_GEODE_INDEX_COMPLETE\";\n-  protected static final int GET_INDEX_WRITER_MAX_ATTEMPTS = 10;\n+  protected static final int GET_INDEX_WRITER_MAX_ATTEMPTS = 200;\n \n   public IndexRepositoryFactory() {}\n \n"}}, {"oid": "ce55fcf27dfb7ac1ff5eb847741de4100f038220", "url": "https://github.com/apache/geode/commit/ce55fcf27dfb7ac1ff5eb847741de4100f038220", "message": "GEODE-8536: Allow limited retries when creating Lucene IndexWriter\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-10-02T20:55:21Z", "type": "commit"}, {"oid": "8afd208962f536d0676ccfd9f2a91795ad25ced1", "url": "https://github.com/apache/geode/commit/8afd208962f536d0676ccfd9f2a91795ad25ced1", "message": "Increase max retry count to 200\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-10-02T20:55:21Z", "type": "commit"}, {"oid": "8afd208962f536d0676ccfd9f2a91795ad25ced1", "url": "https://github.com/apache/geode/commit/8afd208962f536d0676ccfd9f2a91795ad25ced1", "message": "Increase max retry count to 200\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-10-02T20:55:21Z", "type": "forcePushed"}]}