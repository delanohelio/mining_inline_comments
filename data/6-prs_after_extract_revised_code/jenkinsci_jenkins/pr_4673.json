{"pr_number": 4673, "pr_title": "Add support for bearer tokens in Jenkins CLI", "pr_createdAt": "2020-04-19T21:25:52Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4673", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMTU2Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413721566", "bodyText": "Is it possible that the bearer token here is empty ?", "author": "sladyn98", "createdAt": "2020-04-23T11:03:06Z", "path": "cli/src/main/java/hudson/cli/CLIConnectionFactory.java", "diffHunk": "@@ -36,4 +36,19 @@ public CLIConnectionFactory basicAuth(String userInfo) {\n         return authorization(\"Basic \" + Base64.getEncoder().encodeToString(userInfo.getBytes()));\n     }\n \n+    /**\n+     * Convenience method to call {@link #authorization} with the HTTP bearer authentication.\n+     * Cf. {@code BasicHeaderApiTokenAuthenticator}.\n+     */\n+    public CLIConnectionFactory bearerAuth(String bearerToken) {\n+        return authorization(\"Bearer \" + bearerToken);", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MTQ3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413951478", "bodyText": "From my understanding of CLI class, it can be an empty string but not null -- follows the semantics of basicAuth", "author": "sorend", "createdAt": "2020-04-23T16:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMTU2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "chunk": "diff --git a/cli/src/main/java/hudson/cli/CLIConnectionFactory.java b/cli/src/main/java/hudson/cli/CLIConnectionFactory.java\nindex ec15ce55e9..eceff79eff 100644\n--- a/cli/src/main/java/hudson/cli/CLIConnectionFactory.java\n+++ b/cli/src/main/java/hudson/cli/CLIConnectionFactory.java\n\n@@ -43,12 +43,4 @@ public class CLIConnectionFactory {\n     public CLIConnectionFactory bearerAuth(String bearerToken) {\n         return authorization(\"Bearer \" + bearerToken);\n     }\n-\n-    /**\n-     * Convenience method to call {@link #basicAuth} or {@link #bearerAuth} depending on the input content\n-     */\n-    public CLIConnectionFactory of(String input) {\n-        return input.contains(\":\") ? basicAuth(input) : bearerAuth(input);\n-    }\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjIxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413722216", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CLIConnectionFactory sut;\n          \n          \n            \n                CLIConnectionFactory cliFactory;", "author": "sladyn98", "createdAt": "2020-04-23T11:04:17Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory sut;", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "chunk": "diff --git a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\nindex e6f36df72d..2f7d7b7e44 100644\n--- a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n+++ b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n\n@@ -1,26 +1,25 @@\n package hudson.cli;\n \n-import org.junit.Assert;\n+import org.junit.jupiter.api.Assertions;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n class CLIConnectionFactoryTest {\n \n-    CLIConnectionFactory sut;\n+    CLIConnectionFactory cliFactory;\n \n     @BeforeEach\n     void setUp() {\n-        sut = new CLIConnectionFactory();\n+        cliFactory = new CLIConnectionFactory();\n     }\n \n     @Test\n     void testBearerFromToken() {\n-        Assert.assertEquals(\"Bearer some-token\", sut.of(\"some-token\").authorization);\n+        Assertions.assertEquals(\"Bearer some-token\", cliFactory.bearerAuth(\"some-token\").authorization);\n     }\n \n     @Test\n     void testBasicFromUserAndPass() {\n-        Assert.assertEquals(\"Basic c29tZTpwYXNz\", sut.of(\"some:pass\").authorization);\n+        Assertions.assertEquals(\"Basic c29tZTpwYXNz\", cliFactory.basicAuth(\"some:pass\").authorization);\n     }\n-\n-}\n\\ No newline at end of file\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413722500", "bodyText": "Would it be better if we also include  an Empty Bearer Token test ?", "author": "sladyn98", "createdAt": "2020-04-23T11:04:50Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory sut;\n+\n+    @BeforeEach\n+    void setUp() {\n+        sut = new CLIConnectionFactory();\n+    }\n+\n+    @Test\n+    void testBearerFromToken() {\n+        Assert.assertEquals(\"Bearer some-token\", sut.of(\"some-token\").authorization);\n+    }\n+", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MjM2NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413952364", "bodyText": "I can add the test, but the cli will behave in the same was as if empty auth is passed to basicAuth, semantics are the same. Suggest not to implement test, but open to your suggestion :-)", "author": "sorend", "createdAt": "2020-04-23T16:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNjk0OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418926948", "bodyText": "Okay, I do not have a deep understanding of basicAuth here, if I understand correctly if empty token is passed it will be handled normally and therefore we do not need to test it. Might need some additional review\nCC @daniel-beck", "author": "sladyn98", "createdAt": "2020-05-02T07:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA=="}], "type": "inlineReview", "revised_code": {"commit": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "chunk": "diff --git a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\nindex e6f36df72d..2f7d7b7e44 100644\n--- a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n+++ b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n\n@@ -1,26 +1,25 @@\n package hudson.cli;\n \n-import org.junit.Assert;\n+import org.junit.jupiter.api.Assertions;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n class CLIConnectionFactoryTest {\n \n-    CLIConnectionFactory sut;\n+    CLIConnectionFactory cliFactory;\n \n     @BeforeEach\n     void setUp() {\n-        sut = new CLIConnectionFactory();\n+        cliFactory = new CLIConnectionFactory();\n     }\n \n     @Test\n     void testBearerFromToken() {\n-        Assert.assertEquals(\"Bearer some-token\", sut.of(\"some-token\").authorization);\n+        Assertions.assertEquals(\"Bearer some-token\", cliFactory.bearerAuth(\"some-token\").authorization);\n     }\n \n     @Test\n     void testBasicFromUserAndPass() {\n-        Assert.assertEquals(\"Basic c29tZTpwYXNz\", sut.of(\"some:pass\").authorization);\n+        Assertions.assertEquals(\"Basic c29tZTpwYXNz\", cliFactory.basicAuth(\"some:pass\").authorization);\n     }\n-\n-}\n\\ No newline at end of file\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MDM2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r417880367", "bodyText": "This is not empty when the test name suggests so?", "author": "varyvol", "createdAt": "2020-04-30T09:32:45Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory cliFactory;\n+\n+    @BeforeEach\n+    void setUp() {\n+        cliFactory = new CLIConnectionFactory();\n+    }\n+\n+    @Test\n+    void testBearerFromToken() {\n+        Assert.assertEquals(\"Bearer some-token\", cliFactory.of(\"some-token\").authorization);\n+    }\n+\n+    @Test\n+    void testBearerFromEmptyToken() {\n+        Assert.assertEquals(\"Bearer some-token\", cliFactory.of(\"some-token\").authorization);", "originalCommit": "1ecafd520a7df7c7b0e0cd8c2f5fa0faaf08c42a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyOTIzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418529233", "bodyText": "Sorry a missing cleanup.", "author": "sorend", "createdAt": "2020-05-01T12:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MDM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "chunk": "diff --git a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\nindex 06a24af418..2f7d7b7e44 100644\n--- a/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n+++ b/cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java\n\n@@ -1,6 +1,6 @@\n package hudson.cli;\n \n-import org.junit.Assert;\n+import org.junit.jupiter.api.Assertions;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n"}}, {"oid": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "url": "https://github.com/jenkinsci/jenkins/commit/eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "message": "added -bearer argument to jenkins-cli", "committedDate": "2020-05-21T18:11:39Z", "type": "commit"}, {"oid": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "url": "https://github.com/jenkinsci/jenkins/commit/eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "message": "added -bearer argument to jenkins-cli", "committedDate": "2020-05-21T18:11:39Z", "type": "forcePushed"}, {"oid": "81412e2c648d9c6eaa5a5be2ae845d1b1ba728cb", "url": "https://github.com/jenkinsci/jenkins/commit/81412e2c648d9c6eaa5a5be2ae845d1b1ba728cb", "message": "updated message related to bearer/auth. added warning when both are used anyway.", "committedDate": "2020-05-22T06:04:06Z", "type": "commit"}]}