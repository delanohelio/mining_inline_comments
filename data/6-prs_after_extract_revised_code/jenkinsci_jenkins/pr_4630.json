{"pr_number": 4630, "pr_title": "[JENKINS-61808] Always transmit f:password values as Secret", "pr_createdAt": "2020-04-06T12:22:52Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4630", "timeline": [{"oid": "db57f60ab9cc20e9a43d11f45ceede4a24efb16a", "url": "https://github.com/jenkinsci/jenkins/commit/db57f60ab9cc20e9a43d11f45ceede4a24efb16a", "message": "[JENKINS-61808] Always transmit f:password values as Secret", "committedDate": "2020-04-06T09:02:36Z", "type": "commit"}, {"oid": "13d242af0472e99757770846dc9a0022df40ada2", "url": "https://github.com/jenkinsci/jenkins/commit/13d242af0472e99757770846dc9a0022df40ada2", "message": "Merge branch 'master' into JENKINS-61808", "committedDate": "2020-04-06T12:32:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1NDM2Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4630#discussion_r418254362", "bodyText": "shouldn't this redirect be pointing here https://www.jenkins.io/doc/developer/security/secrets/ instead of the wiki?", "author": "timja", "createdAt": "2020-04-30T19:58:19Z", "path": "core/src/main/java/hudson/Functions.java", "diffHunk": "@@ -2013,21 +2014,66 @@ public static String generateConsoleAnnotationScriptAndStylesheet() {\n      * Used by {@code <f:password/>} so that we send an encrypted value to the client.\n      */\n     public String getPasswordValue(Object o) {\n-        if (o==null)    return null;\n-        if (o instanceof Secret) {\n-            StaplerRequest req = Stapler.getCurrentRequest();\n+        if (o == null) {\n+            return null;\n+        }\n+\n+        /*\n+         Return plain value if it's the default value for PasswordParameterDefinition.\n+         This needs to work even when the user doesn't have CONFIGURE permission\n+         */\n+        if (o.equals(PasswordParameterDefinition.DEFAULT_VALUE)) {\n+            return o.toString();\n+        }\n+\n+        /* Mask from Extended Read */\n+        StaplerRequest req = Stapler.getCurrentRequest();\n+        if (o instanceof Secret || Secret.BLANK_NONSECRET_PASSWORD_FIELDS_WITHOUT_ITEM_CONFIGURE) {\n             if (req != null) {\n                 Item item = req.findAncestorObject(Item.class);\n                 if (item != null && !item.hasPermission(Item.CONFIGURE)) {\n                     return \"********\";\n                 }\n             }\n+        }\n+\n+        /* Return encrypted value if it's a Secret */\n+        if (o instanceof Secret) {\n             return ((Secret) o).getEncryptedValue();\n         }\n-        if (getIsUnitTest() && !o.equals(PasswordParameterDefinition.DEFAULT_VALUE)) {\n-            throw new SecurityException(\"attempted to render plaintext \u2018\" + o + \"\u2019 in password field; use a getter of type Secret instead\");\n+\n+        /* Log a warning if we're in development mode (core or plugin): There's an f:password backed by a non-Secret */\n+        if (req != null && (Boolean.getBoolean(\"hudson.hpi.run\") || Boolean.getBoolean(\"hudson.Main.development\"))) {\n+            LOGGER.log(Level.WARNING, () -> \"<f:password/> form control in \" + getJellyViewsInformationForCurrentRequest() +\n+                    \" is not backed by hudson.util.Secret. Learn more: https://jenkins.io/redirect/hudson.util.Secret\");", "originalCommit": "13d242af0472e99757770846dc9a0022df40ada2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NTQ1MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4630#discussion_r418285451", "bodyText": "Yup, the redirect target is terrible, needs to be changed. But not worth doing another redirect for it. We probably need a new docs page to talk about this + toString.", "author": "daniel-beck", "createdAt": "2020-04-30T20:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1NDM2Mg=="}], "type": "inlineReview", "revised_code": null}]}