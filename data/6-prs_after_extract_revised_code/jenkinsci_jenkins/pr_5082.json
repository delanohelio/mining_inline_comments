{"pr_number": 5082, "pr_title": "[JENKINS-58101] Cache blockage reasons when considering parked executors", "pr_createdAt": "2020-11-27T16:38:07Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/5082", "timeline": [{"oid": "168fe1857799f10eef243d5996e894a71b980728", "url": "https://github.com/jenkinsci/jenkins/commit/168fe1857799f10eef243d5996e894a71b980728", "message": "Cache blockage reasons", "committedDate": "2020-11-27T16:29:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc5NzI3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/5082#discussion_r531797276", "bodyText": "Putting null to reasonMap is expected IIUC\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    CauseOfBlockage reason;\n          \n          \n            \n                                    if (reasonMap.containsKey(offerNode)) {\n          \n          \n            \n                                        reason = reasonMap.get(offerNode);\n          \n          \n            \n                                    } else {\n          \n          \n            \n                                        reason = j.getCauseOfBlockage(p);\n          \n          \n            \n                                        reasonMap.put(offerNode, reason);\n          \n          \n            \n                                    }\n          \n          \n            \n                                    CauseOfBlockage reason = reasonMap.get(offerNode);\n          \n          \n            \n                                    if (reason == null) {\n          \n          \n            \n                                        reason = j.getCauseOfBlockage(p);\n          \n          \n            \n                                        reasonMap.put(offerNode, reason);\n          \n          \n            \n                                    }", "author": "oleg-nenashev", "createdAt": "2020-11-27T22:15:15Z", "path": "core/src/main/java/hudson/model/Queue.java", "diffHunk": "@@ -1631,17 +1632,23 @@ public void maintain() {\n                 } else {\n \n                     List<JobOffer> candidates = new ArrayList<>(parked.size());\n-                    List<CauseOfBlockage> reasons = new ArrayList<>(parked.size());\n+                    Map<Node, CauseOfBlockage> reasonMap = new HashMap<>();\n                     for (JobOffer j : parked.values()) {\n-                        CauseOfBlockage reason = j.getCauseOfBlockage(p);\n+                        Node offerNode = j.getNode();\n+                        CauseOfBlockage reason;\n+                        if (reasonMap.containsKey(offerNode)) {\n+                            reason = reasonMap.get(offerNode);\n+                        } else {\n+                            reason = j.getCauseOfBlockage(p);\n+                            reasonMap.put(offerNode, reason);\n+                        }", "originalCommit": "168fe1857799f10eef243d5996e894a71b980728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0NDc0Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/5082#discussion_r532044747", "bodyText": "Its ok to have nulls as values as the reason can be null so the suggested version will call getCauseOfBlockage more than once", "author": "res0nance", "createdAt": "2020-11-28T14:14:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc5NzI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI3NzEwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/5082#discussion_r546277102", "bodyText": "OK", "author": "oleg-nenashev", "createdAt": "2020-12-19T20:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc5NzI3Ng=="}], "type": "inlineReview", "revised_code": null}]}