{"pr_number": 4850, "pr_title": "[JENKINS-61687] Prevent concurrent build deletion", "pr_createdAt": "2020-07-17T09:26:00Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4850", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc4Mzg1NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4850#discussion_r456783854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (state == State.PENDING_DELETE)\n          \n          \n            \n                            return;\n          \n          \n            \n                        if (state == State.PENDING_DELETE) {\n          \n          \n            \n                            return;\n          \n          \n            \n                        }", "author": "stellargo", "createdAt": "2020-07-18T12:10:42Z", "path": "core/src/main/java/hudson/model/Run.java", "diffHunk": "@@ -1612,6 +1616,14 @@ public synchronized void deleteArtifacts() throws IOException {\n      *      if we fail to delete.\n      */\n     public void delete() throws IOException {\n+        synchronized (this) {\n+            // Avoid concurrent delete.\n+            if (state == State.PENDING_DELETE)\n+                return;", "originalCommit": "73a4211c7c5f974fa9f1a9b63a265cc67d08dbec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwNDA3NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4850#discussion_r457004074", "bodyText": "Fixed :)", "author": "gmshake", "createdAt": "2020-07-20T03:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc4Mzg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "a917583b3babb7ba745a20f33433e51c679901e7", "chunk": "diff --git a/core/src/main/java/hudson/model/Run.java b/core/src/main/java/hudson/model/Run.java\nindex ec2c9b1ba2..a19c3c076f 100644\n--- a/core/src/main/java/hudson/model/Run.java\n+++ b/core/src/main/java/hudson/model/Run.java\n\n@@ -1617,9 +1617,10 @@ public abstract class Run <JobT extends Job<JobT,RunT>,RunT extends Run<JobT,Run\n      */\n     public void delete() throws IOException {\n         synchronized (this) {\n-            // Avoid concurrent delete.\n-            if (state == State.PENDING_DELETE)\n+            // Avoid concurrent delete. See https://issues.jenkins-ci.org/browse/JENKINS-61687\n+            if (state == State.PENDING_DELETE) {\n                 return;\n+            }\n \n             state = State.PENDING_DELETE;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc4NDA2OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4850#discussion_r456784068", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Avoid concurrent delete.\n          \n          \n            \n                        // Avoid concurrent delete. See https://issues.jenkins-ci.org/browse/JENKINS-61687", "author": "stellargo", "createdAt": "2020-07-18T12:13:42Z", "path": "core/src/main/java/hudson/model/Run.java", "diffHunk": "@@ -1612,6 +1616,14 @@ public synchronized void deleteArtifacts() throws IOException {\n      *      if we fail to delete.\n      */\n     public void delete() throws IOException {\n+        synchronized (this) {\n+            // Avoid concurrent delete.", "originalCommit": "73a4211c7c5f974fa9f1a9b63a265cc67d08dbec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwNDE2NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4850#discussion_r457004165", "bodyText": "Fixed :)", "author": "gmshake", "createdAt": "2020-07-20T03:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc4NDA2OA=="}], "type": "inlineReview", "revised_code": {"commit": "a917583b3babb7ba745a20f33433e51c679901e7", "chunk": "diff --git a/core/src/main/java/hudson/model/Run.java b/core/src/main/java/hudson/model/Run.java\nindex ec2c9b1ba2..a19c3c076f 100644\n--- a/core/src/main/java/hudson/model/Run.java\n+++ b/core/src/main/java/hudson/model/Run.java\n\n@@ -1617,9 +1617,10 @@ public abstract class Run <JobT extends Job<JobT,RunT>,RunT extends Run<JobT,Run\n      */\n     public void delete() throws IOException {\n         synchronized (this) {\n-            // Avoid concurrent delete.\n-            if (state == State.PENDING_DELETE)\n+            // Avoid concurrent delete. See https://issues.jenkins-ci.org/browse/JENKINS-61687\n+            if (state == State.PENDING_DELETE) {\n                 return;\n+            }\n \n             state = State.PENDING_DELETE;\n         }\n"}}, {"oid": "a917583b3babb7ba745a20f33433e51c679901e7", "url": "https://github.com/jenkinsci/jenkins/commit/a917583b3babb7ba745a20f33433e51c679901e7", "message": "[JENKINS-61687] Prevent concurrent build deletion", "committedDate": "2020-07-20T02:50:43Z", "type": "forcePushed"}, {"oid": "90e6203b5f261ad886543525a390b26911875b2b", "url": "https://github.com/jenkinsci/jenkins/commit/90e6203b5f261ad886543525a390b26911875b2b", "message": "[JENKINS-61687] Prevent concurrent build deletion", "committedDate": "2020-07-20T08:48:43Z", "type": "commit"}, {"oid": "90e6203b5f261ad886543525a390b26911875b2b", "url": "https://github.com/jenkinsci/jenkins/commit/90e6203b5f261ad886543525a390b26911875b2b", "message": "[JENKINS-61687] Prevent concurrent build deletion", "committedDate": "2020-07-20T08:48:43Z", "type": "forcePushed"}]}