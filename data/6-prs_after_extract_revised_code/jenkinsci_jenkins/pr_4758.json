{"pr_number": 4758, "pr_title": "[JENKINS-62949] - Escape special characters from href attrib", "pr_createdAt": "2020-05-30T10:00:24Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4758", "timeline": [{"oid": "35b47be21414dd3587ff4acb7ede4f8f09af17dd", "url": "https://github.com/jenkinsci/jenkins/commit/35b47be21414dd3587ff4acb7ede4f8f09af17dd", "message": "escape special characters from href attrib", "committedDate": "2020-05-30T09:40:37Z", "type": "commit"}, {"oid": "0cb502530323363c9cefc8e97ddfc196dd19db13", "url": "https://github.com/jenkinsci/jenkins/commit/0cb502530323363c9cefc8e97ddfc196dd19db13", "message": "escape special character | adding test case", "committedDate": "2020-05-31T15:33:04Z", "type": "commit"}, {"oid": "0876951bb2aba5487e7cc011a24d2e4a703334a5", "url": "https://github.com/jenkinsci/jenkins/commit/0876951bb2aba5487e7cc011a24d2e4a703334a5", "message": "escape special character | adding test case", "committedDate": "2020-06-01T03:04:38Z", "type": "commit"}, {"oid": "4a9c3edf3347dac08b99643b87f7c8b1699287de", "url": "https://github.com/jenkinsci/jenkins/commit/4a9c3edf3347dac08b99643b87f7c8b1699287de", "message": "escape special character | adding test case", "committedDate": "2020-06-01T09:51:58Z", "type": "commit"}, {"oid": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "url": "https://github.com/jenkinsci/jenkins/commit/4e0e9c9e7ed772cf1887f56d2e856cf957655324", "message": "escape special character | adding test case", "committedDate": "2020-06-01T16:29:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NTk5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r433365994", "bodyText": "Please don't make this change.  The org.junit.Assert.assertThat is deprecated in JUnit 4.13 and was recently removed from all uses in Jenkins core.  This is adding a deprecated method that was already configured to use the preferred new method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static org.junit.Assert.assertThat;\n          \n          \n            \n            import static org.hamcrest.MatcherAssert.assertThat;", "author": "MarkEWaite", "createdAt": "2020-06-01T17:02:10Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -35,9 +39,13 @@\n import org.jvnet.hudson.test.Issue;\n import org.jvnet.hudson.test.JenkinsRule;\n \n+import com.gargoylesoftware.htmlunit.ElementNotFoundException;\n+import com.gargoylesoftware.htmlunit.html.HtmlAnchor;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+\n import static org.hamcrest.Matchers.allOf;\n import static org.hamcrest.Matchers.containsString;\n-import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.junit.Assert.assertThat;", "originalCommit": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 66177bacd7..78cf560ace 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -45,7 +45,7 @@ import com.gargoylesoftware.htmlunit.html.HtmlPage;\n \n import static org.hamcrest.Matchers.allOf;\n import static org.hamcrest.Matchers.containsString;\n-import static org.junit.Assert.assertThat;\n+import static org.hamcrest.MatcherAssert.assertThat;\n \n public class HyperlinkNoteTest {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NzQ0OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r433367448", "bodyText": "Please use consistent indentation when adding new code.  The changing indentation within this single method makes the pull request more difficult to read.\nMost integrated development environments (Netbeans, IntelliJ, Visual Studio Code) provide automatic formatting that can be applied to subsections (like this new block of code).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    r.waitUntilNoActivity();\n          \n          \n            \n                r.waitUntilNoActivity();", "author": "MarkEWaite", "createdAt": "2020-06-01T17:04:55Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,6 +80,28 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n+    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();", "originalCommit": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 66177bacd7..78cf560ace 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -81,28 +81,19 @@ public class HyperlinkNoteTest {\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n     \n+    \n     @Test\n     public void textWithSingleQuote() throws Exception {\n-    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n-    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n-    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n-    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n-        //This would fail if job name has `'`\n-        try {\n-        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n-        } catch(Exception enfe) {\n-        \tString str = \"str->\\n\";\n-\t\t\tstr += rsp.getWebResponse().getContentAsString()+\"\\n\\n\";\n-        \tfor(HtmlAnchor ha: rsp.getAnchors()) {\n-        \t\tstr += \"getNameAttribute: \" + ha.getNameAttribute() + \" getTextContent: \" + ha.getTextContent() + \"\\n\";\n-        \t}\n-        \tthrow new Exception(str);\n-        }\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n     }\n \n+    \n     private static String annotate(String text) throws IOException {\n         StringWriter writer = new StringWriter();\n         try (ConsoleAnnotationOutputStream out = new ConsoleAnnotationOutputStream(writer, null, null, StandardCharsets.UTF_8)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2Nzk0Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r433367947", "bodyText": "Debugging println statements are better expressed as assertions of an expectation or can be removed if their debugging purpose has been completed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");", "author": "MarkEWaite", "createdAt": "2020-06-01T17:05:56Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,6 +80,28 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n+    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");", "originalCommit": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 66177bacd7..78cf560ace 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -81,28 +81,19 @@ public class HyperlinkNoteTest {\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n     \n+    \n     @Test\n     public void textWithSingleQuote() throws Exception {\n-    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n-    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n-    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n-    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n-        //This would fail if job name has `'`\n-        try {\n-        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n-        } catch(Exception enfe) {\n-        \tString str = \"str->\\n\";\n-\t\t\tstr += rsp.getWebResponse().getContentAsString()+\"\\n\\n\";\n-        \tfor(HtmlAnchor ha: rsp.getAnchors()) {\n-        \t\tstr += \"getNameAttribute: \" + ha.getNameAttribute() + \" getTextContent: \" + ha.getTextContent() + \"\\n\";\n-        \t}\n-        \tthrow new Exception(str);\n-        }\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n     }\n \n+    \n     private static String annotate(String text) throws IOException {\n         StringWriter writer = new StringWriter();\n         try (ConsoleAnnotationOutputStream out = new ConsoleAnnotationOutputStream(writer, null, null, StandardCharsets.UTF_8)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2OTQ5Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r433369493", "bodyText": "Catching exceptions inside test code is often a sign that the test conditions are not clear.\nI believe that you expect this to always succeed.  When it fails, you want the failure message to provide enough information so that the failure can be diagnosed.  Since it is failing in CI, that likely indicates that you should add more assertions to check for additional cases.", "author": "MarkEWaite", "createdAt": "2020-06-01T17:09:02Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,6 +80,28 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n+    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n+        //This would fail if job name has `'`\n+        try {\n+        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));", "originalCommit": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 66177bacd7..78cf560ace 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -81,28 +81,19 @@ public class HyperlinkNoteTest {\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n     \n+    \n     @Test\n     public void textWithSingleQuote() throws Exception {\n-    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n-    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n-    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n-    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n-        //This would fail if job name has `'`\n-        try {\n-        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n-        } catch(Exception enfe) {\n-        \tString str = \"str->\\n\";\n-\t\t\tstr += rsp.getWebResponse().getContentAsString()+\"\\n\\n\";\n-        \tfor(HtmlAnchor ha: rsp.getAnchors()) {\n-        \t\tstr += \"getNameAttribute: \" + ha.getNameAttribute() + \" getTextContent: \" + ha.getTextContent() + \"\\n\";\n-        \t}\n-        \tthrow new Exception(str);\n-        }\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n     }\n \n+    \n     private static String annotate(String text) throws IOException {\n         StringWriter writer = new StringWriter();\n         try (ConsoleAnnotationOutputStream out = new ConsoleAnnotationOutputStream(writer, null, null, StandardCharsets.UTF_8)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM3MDQwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r433370409", "bodyText": "You could assert that the list of anchors returned by rsp.getAnchors() contains specific items, knowing that when the assertion fails, Hamcrest will print the contents of the list for diagnosis.", "author": "MarkEWaite", "createdAt": "2020-06-01T17:10:50Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,6 +80,28 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n+    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n+        //This would fail if job name has `'`\n+        try {\n+        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n+        } catch(Exception enfe) {\n+        \tString str = \"str->\\n\";\n+\t\t\tstr += rsp.getWebResponse().getContentAsString()+\"\\n\\n\";\n+        \tfor(HtmlAnchor ha: rsp.getAnchors()) {\n+        \t\tstr += \"getNameAttribute: \" + ha.getNameAttribute() + \" getTextContent: \" + ha.getTextContent() + \"\\n\";\n+        \t}\n+        \tthrow new Exception(str);\n+        }", "originalCommit": "4e0e9c9e7ed772cf1887f56d2e856cf957655324", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 66177bacd7..78cf560ace 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -81,28 +81,19 @@ public class HyperlinkNoteTest {\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n     \n+    \n     @Test\n     public void textWithSingleQuote() throws Exception {\n-    \tFreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n-    \tr.createFreeStyleProject(\"d0wnstr3'am\");\n-    \tupstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n-    \tFreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        System.out.println(\"Before:\\n\"+rsp.getWebResponse().getContentAsString()+\"\\n\\n\");\n-        //This would fail if job name has `'`\n-        try {\n-        \tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n-        } catch(Exception enfe) {\n-        \tString str = \"str->\\n\";\n-\t\t\tstr += rsp.getWebResponse().getContentAsString()+\"\\n\\n\";\n-        \tfor(HtmlAnchor ha: rsp.getAnchors()) {\n-        \t\tstr += \"getNameAttribute: \" + ha.getNameAttribute() + \" getTextContent: \" + ha.getTextContent() + \"\\n\";\n-        \t}\n-        \tthrow new Exception(str);\n-        }\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n     }\n \n+    \n     private static String annotate(String text) throws IOException {\n         StringWriter writer = new StringWriter();\n         try (ConsoleAnnotationOutputStream out = new ConsoleAnnotationOutputStream(writer, null, null, StandardCharsets.UTF_8)) {\n"}}, {"oid": "3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "url": "https://github.com/jenkinsci/jenkins/commit/3d244a2f1649fbfcb4630efeeb855a40d6ed83a4", "message": "escape special character | adding test case", "committedDate": "2020-06-02T09:05:43Z", "type": "commit"}, {"oid": "c649a46525301d5a0863b7ec1f25bd7a8c470c77", "url": "https://github.com/jenkinsci/jenkins/commit/c649a46525301d5a0863b7ec1f25bd7a8c470c77", "message": "escape special character | adding test case", "committedDate": "2020-06-02T09:07:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODAwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435128009", "bodyText": "So you want to verify the link to the downstream job exists and that by clicking it, you are able to launch it?", "author": "varyvol", "createdAt": "2020-06-04T09:45:42Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,7 +78,20 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));", "originalCommit": "c649a46525301d5a0863b7ec1f25bd7a8c470c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE3NzMyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435177324", "bodyText": "So you want to verify the link to the downstream job exists and that by clicking it, you are able to launch it?\n\nRight! and thats working fine on my system. But it seems that no downstream build is being triggered here.", "author": "Absh-Day", "createdAt": "2020-06-04T11:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4314ee48eff801c2024199e988c8a0d1d1bba528", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 3a0703c8bb..ced0be1b64 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -88,7 +88,7 @@ public class HyperlinkNoteTest {\n         FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n+        assertThat(rsp.querySelector(\".console-output\").asText(), containsString(\"Triggering a new build of\"));\n     }\n \n     \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435128652", "bodyText": "Also the test is failing because it's not able to look for the link. Maybe you need to use here the escaped text?", "author": "varyvol", "createdAt": "2020-06-04T09:46:42Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,7 +78,20 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));", "originalCommit": "c649a46525301d5a0863b7ec1f25bd7a8c470c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE3OTEzMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435179131", "bodyText": "Also the test is failing because it's not able to look for the link. Maybe you need to use here the escaped text?\n\nWhen I tried printing all anchors(getAnchors), there was no downstream project anchor here, but it did exist on my system.\nJust to show please see the Error section here:\nhttps://ci.jenkins.io/blue/organizations/jenkins/Core%2Fjenkins/detail/PR-4758/3/tests/", "author": "Absh-Day", "createdAt": "2020-06-04T11:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5MjIxNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435292215", "bodyText": "I'm not sure about why it works on your systme. Are you sure you commited and pushed all your changes?\nAbout the test itself, it's quite confusing to be honest. I believe you should split the sentence into two:\n\nCheck the button exists.\nClick and check the downstream job has been executed.", "author": "varyvol", "createdAt": "2020-06-04T14:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxMzIzNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r435313236", "bodyText": "I'm not sure about why it works on your systme. Are you sure you commited and pushed all your changes?\nAbout the test itself, it's quite confusing to be honest. I believe you should split the sentence into two:\n\nCheck the button exists.\nClick and check the downstream job has been executed.\n\n\nSure thing. I will update it with more clarity.", "author": "Absh-Day", "createdAt": "2020-06-04T14:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQyMzUzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r445423530", "bodyText": "@Absh-Day did you have some time to update this?", "author": "varyvol", "createdAt": "2020-06-25T09:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NTYxMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r446675611", "bodyText": "@Absh-Day did you have some time to update this?\n\nI have modified the test, I am trying finding the console output of the parent build and want to see if it triggered downstream build by checking the existence of text \"Triggering a new build of\".\nOn my system \"rsp.querySelector(\".console-output\").asText()\" prints:\n\"\nLegacy code started this job.  No cause information is available\nRunning as SYSTEM\nBuilding in workspace C:\\Users\\abhinavkumar.singh\\Desktop\\Useful\\jenkins\\test\\target\\j h8731051363356794503\\wxorkspace\\upstream\nTriggering a new build of d0wnstr3'am\nFinished: SUCCESS\"", "author": "Absh-Day", "createdAt": "2020-06-28T17:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NDYxNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r449184617", "bodyText": "@varyvol adding r.jenkins.rebuildDependencyGraph(); worked.", "author": "Absh-Day", "createdAt": "2020-07-02T18:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyODY1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4314ee48eff801c2024199e988c8a0d1d1bba528", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 3a0703c8bb..ced0be1b64 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -88,7 +88,7 @@ public class HyperlinkNoteTest {\n         FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n-        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n+        assertThat(rsp.querySelector(\".console-output\").asText(), containsString(\"Triggering a new build of\"));\n     }\n \n     \n"}}, {"oid": "4314ee48eff801c2024199e988c8a0d1d1bba528", "url": "https://github.com/jenkinsci/jenkins/commit/4314ee48eff801c2024199e988c8a0d1d1bba528", "message": "escape special character | adding test case", "committedDate": "2020-06-28T17:18:08Z", "type": "commit"}, {"oid": "96f8e151a8caa64124698515286afbafd312e876", "url": "https://github.com/jenkinsci/jenkins/commit/96f8e151a8caa64124698515286afbafd312e876", "message": "escape special character | adding test case", "committedDate": "2020-07-02T15:30:12Z", "type": "commit"}, {"oid": "e31fdc3483e51b8f8a952d668ca66e747e28bef1", "url": "https://github.com/jenkinsci/jenkins/commit/e31fdc3483e51b8f8a952d668ca66e747e28bef1", "message": "escape special character | adding test case", "committedDate": "2020-07-03T03:40:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMDEyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r450220121", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n          \n          \n            \n                    assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));", "author": "jglick", "createdAt": "2020-07-06T13:28:28Z", "path": "test/src/test/java/hudson/console/HyperlinkNoteTest.java", "diffHunk": "@@ -72,7 +78,22 @@ public void textWithNewlinesModelHyperlinkNote() throws Exception {\n                 containsString(new ModelHyperlinkNote(\"\", 0).extraAttributes()),\n                 containsString(\">\" + noteTextSanitized + \"</a>\")));\n     }\n+    \n+    \n+    @Test\n+    public void textWithSingleQuote() throws Exception {\n+        FreeStyleProject upstream = r.createFreeStyleProject(\"upstream\");\n+        r.createFreeStyleProject(\"d0wnstr3'am\");\n+        upstream.getPublishersList().add(new BuildTrigger(\"d0wnstr3'am\", Result.SUCCESS));\n+        r.jenkins.rebuildDependencyGraph();\n+        FreeStyleBuild b = r.buildAndAssertSuccess(upstream);\n+        r.waitUntilNoActivity();\n+        HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n+        assertThat(rsp.querySelector(\".console-output\").asText(), containsString(\"Triggering a new build of\"));\n+\t\tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));", "originalCommit": "e31fdc3483e51b8f8a952d668ca66e747e28bef1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fef4ae60c58af98ccf4e74fc2d31928ffdb27b11", "chunk": "diff --git a/test/src/test/java/hudson/console/HyperlinkNoteTest.java b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\nindex 893a952a88..b5ed59162c 100644\n--- a/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n+++ b/test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\n@@ -90,7 +90,7 @@ public class HyperlinkNoteTest {\n         r.waitUntilNoActivity();\n         HtmlPage rsp = r.createWebClient().goTo(b.getUrl()+\"console\");\n         assertThat(rsp.querySelector(\".console-output\").asText(), containsString(\"Triggering a new build of\"));\n-\t\tassertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n+        assertThat(String.valueOf(rsp.getAnchorByText(\"d0wnstr3'am\").click().getWebResponse().getStatusCode()), containsString(\"200\"));\n     }\n \n     \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIyMzk2Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4758#discussion_r450223962", "bodyText": "Note that this code is using ' where most generated markup uses \", though it should not make any difference (Util.escape will escape both if they happen to be present in the URL).", "author": "jglick", "createdAt": "2020-07-06T13:34:46Z", "path": "core/src/main/java/hudson/console/HyperlinkNote.java", "diffHunk": "@@ -69,7 +70,7 @@ public ConsoleAnnotator annotate(Object context, MarkupText text, int charPos) {\n                 url = Jenkins.get().getRootUrl()+url.substring(1);\n             }\n         }\n-        text.addMarkup(charPos, charPos + length, \"<a href='\" + url + \"'\"+extraAttributes()+\">\", \"</a>\");\n+        text.addMarkup(charPos, charPos + length, \"<a href='\" + Util.escape(url) + \"'\"+extraAttributes()+\">\", \"</a>\");", "originalCommit": "e31fdc3483e51b8f8a952d668ca66e747e28bef1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "fef4ae60c58af98ccf4e74fc2d31928ffdb27b11", "url": "https://github.com/jenkinsci/jenkins/commit/fef4ae60c58af98ccf4e74fc2d31928ffdb27b11", "message": "Update test/src/test/java/hudson/console/HyperlinkNoteTest.java\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-07-06T14:51:27Z", "type": "commit"}]}