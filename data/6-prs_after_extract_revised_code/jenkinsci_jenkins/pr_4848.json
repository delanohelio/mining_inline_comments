{"pr_number": 4848, "pr_title": "[JEP-227] Replace Acegi Security with Spring Security & upgrade Spring Framework", "pr_createdAt": "2020-07-15T23:03:29Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4848", "timeline": [{"oid": "d0a125a16902c33e93092184e3c4b1e1d6919410", "url": "https://github.com/jenkinsci/jenkins/commit/d0a125a16902c33e93092184e3c4b1e1d6919410", "message": "NPE from User.get", "committedDate": "2020-07-29T14:30:57Z", "type": "commit"}, {"oid": "697e5553f84bf5ae137ef2a42978060bdcdd6705", "url": "https://github.com/jenkinsci/jenkins/commit/697e5553f84bf5ae137ef2a42978060bdcdd6705", "message": "Need to implement setDetails in former subtypes of AbstractAuthenticationToken", "committedDate": "2020-07-29T15:48:53Z", "type": "commit"}, {"oid": "ffdf0397b89e2de8539471b187ae52c6b03bd100", "url": "https://github.com/jenkinsci/jenkins/commit/ffdf0397b89e2de8539471b187ae52c6b03bd100", "message": "Custom subtypes of UserDetails must be round-tripped", "committedDate": "2020-07-29T15:49:35Z", "type": "commit"}, {"oid": "a175d17519873fbf4b88f863e83eaf6b1e15b853", "url": "https://github.com/jenkinsci/jenkins/commit/a175d17519873fbf4b88f863e83eaf6b1e15b853", "message": "Need to translate UserDetails values for Authentication.principal", "committedDate": "2020-07-29T16:27:01Z", "type": "commit"}, {"oid": "a73186bec3297d4fa9c96a54b6d3c1bb28f6a5bd", "url": "https://github.com/jenkinsci/jenkins/commit/a73186bec3297d4fa9c96a54b6d3c1bb28f6a5bd", "message": "Align User.serialVersionUID with the Acegi Security version", "committedDate": "2020-07-31T20:34:48Z", "type": "commit"}, {"oid": "8711c7bd069d23a8400d175ff1320e3a0154c5d3", "url": "https://github.com/jenkinsci/jenkins/commit/8711c7bd069d23a8400d175ff1320e3a0154c5d3", "message": "Deprecated stub for WebAuthenticationDetails", "committedDate": "2020-07-31T21:30:40Z", "type": "commit"}, {"oid": "28ddf31ab104065cdbbd5121aa1c456c40612ae1", "url": "https://github.com/jenkinsci/jenkins/commit/28ddf31ab104065cdbbd5121aa1c456c40612ae1", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-31T21:41:03Z", "type": "commit"}, {"oid": "d5452423bf78387457f50d7bb5ee43fdf6f24d24", "url": "https://github.com/jenkinsci/jenkins/commit/d5452423bf78387457f50d7bb5ee43fdf6f24d24", "message": "Added AuthenticationProvider & AbstractUserDetailsAuthenticationProvider", "committedDate": "2020-07-31T22:17:09Z", "type": "commit"}, {"oid": "2f3a61e847b1b4231833fd16d82434a6b76b5e6a", "url": "https://github.com/jenkinsci/jenkins/commit/2f3a61e847b1b4231833fd16d82434a6b76b5e6a", "message": "Adding FieldUtils, used by tests in a few plugins", "committedDate": "2020-07-31T22:29:31Z", "type": "commit"}, {"oid": "f77173c4959e7db82541826fe34225310f8b613d", "url": "https://github.com/jenkinsci/jenkins/commit/f77173c4959e7db82541826fe34225310f8b613d", "message": "Binary compatibility for PrincipalSid and GrantedAuthoritySid constructors", "committedDate": "2020-08-03T17:30:15Z", "type": "commit"}, {"oid": "1abe5c628e8363ce2bb94632a7e436b2f91218bf", "url": "https://github.com/jenkinsci/jenkins/commit/1abe5c628e8363ce2bb94632a7e436b2f91218bf", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-03T17:30:20Z", "type": "commit"}, {"oid": "6851e326b279aa5e8061b126d7109af6c2181cad", "url": "https://github.com/jenkinsci/jenkins/commit/6851e326b279aa5e8061b126d7109af6c2181cad", "message": "Restoring some methods in AuthenticationException, called from AbstractAuthenticationManager in LDAPAuthenticationManager", "committedDate": "2020-08-03T19:27:55Z", "type": "commit"}, {"oid": "4731952f9c4654365b77ab2dce3c47852fe30f87", "url": "https://github.com/jenkinsci/jenkins/commit/4731952f9c4654365b77ab2dce3c47852fe30f87", "message": "Restoring serial form compatibility for GrantedAuthorityImpl", "committedDate": "2020-08-03T22:51:06Z", "type": "commit"}, {"oid": "e90cfa4cda26470e147b4958e8314ea10ef0afa1", "url": "https://github.com/jenkinsci/jenkins/commit/e90cfa4cda26470e147b4958e8314ea10ef0afa1", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-03T22:51:11Z", "type": "commit"}, {"oid": "50a470fe03a385b2248dbaca490c960f0db32b0b", "url": "https://github.com/jenkinsci/jenkins/commit/50a470fe03a385b2248dbaca490c960f0db32b0b", "message": "Restored SecurityContextImpl", "committedDate": "2020-08-04T13:24:25Z", "type": "commit"}, {"oid": "1ebb6a58aefea4089487af3d6beac69faac429a6", "url": "https://github.com/jenkinsci/jenkins/commit/1ebb6a58aefea4089487af3d6beac69faac429a6", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-04T13:24:29Z", "type": "commit"}, {"oid": "a67b0284a5530faec4ca54f522946c6e0830b100", "url": "https://github.com/jenkinsci/jenkins/commit/a67b0284a5530faec4ca54f522946c6e0830b100", "message": "To avoid Java serialization issues, HudsonPrivateSecurityRealm.Details no longer implements UserDetails", "committedDate": "2020-08-05T22:03:24Z", "type": "commit"}, {"oid": "d94651ed2ca78b6d72d1ae062437b22565a442c9", "url": "https://github.com/jenkinsci/jenkins/commit/d94651ed2ca78b6d72d1ae062437b22565a442c9", "message": "Update detached ldap to compatible version from https://github.com/jenkinsci/ldap-plugin/pull/48", "committedDate": "2020-08-05T23:39:48Z", "type": "commit"}, {"oid": "8f71d9142ecb08f05e72872603ea46dd55262c53", "url": "https://github.com/jenkinsci/jenkins/commit/8f71d9142ecb08f05e72872603ea46dd55262c53", "message": "AccessDeniedException2Test \u2192 AccessDeniedException3Test", "committedDate": "2020-08-06T20:24:04Z", "type": "commit"}, {"oid": "7a063db6e0dc738f990e581063fc8676e92d42a8", "url": "https://github.com/jenkinsci/jenkins/commit/7a063db6e0dc738f990e581063fc8676e92d42a8", "message": "Ensure ExceptionTranslationFilter still works if a plugin throws AccessDeniedException2", "committedDate": "2020-08-06T21:23:07Z", "type": "commit"}, {"oid": "1e41d5aa7cc446332faf82c9c47364928752c5b3", "url": "https://github.com/jenkinsci/jenkins/commit/1e41d5aa7cc446332faf82c9c47364928752c5b3", "message": "Binary compatibility for BasicHeaderAuthenticator", "committedDate": "2020-08-06T21:44:37Z", "type": "commit"}, {"oid": "cc029a3e09fba20907f535c32e5a820606d6454c", "url": "https://github.com/jenkinsci/jenkins/commit/cc029a3e09fba20907f535c32e5a820606d6454c", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-07T11:57:44Z", "type": "commit"}, {"oid": "7b87b217b526a5100c57f212ac505aab5e70e9ea", "url": "https://github.com/jenkinsci/jenkins/commit/7b87b217b526a5100c57f212ac505aab5e70e9ea", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-21T12:58:42Z", "type": "commit"}, {"oid": "b380b7832f4fc1fd40766c089e1268ece0c73ac2", "url": "https://github.com/jenkinsci/jenkins/commit/b380b7832f4fc1fd40766c089e1268ece0c73ac2", "message": "Restored AuthenticationServiceException", "committedDate": "2020-08-21T20:10:58Z", "type": "commit"}, {"oid": "64f820e47d1a53982121b111d566760cb0ad4104", "url": "https://github.com/jenkinsci/jenkins/commit/64f820e47d1a53982121b111d566760cb0ad4104", "message": "Binary compatibility for HudsonPrivateSecurityRealm.Details.getAuthorities", "committedDate": "2020-08-21T20:13:27Z", "type": "commit"}, {"oid": "b7ed6353cf83f6c8909fce9a5e4d3cdf2d8ec050", "url": "https://github.com/jenkinsci/jenkins/commit/b7ed6353cf83f6c8909fce9a5e4d3cdf2d8ec050", "message": "Restored User.setAuthorities", "committedDate": "2020-08-21T20:20:03Z", "type": "commit"}, {"oid": "5711c491d4301d72ee90252622479d71d55574ed", "url": "https://github.com/jenkinsci/jenkins/commit/5711c491d4301d72ee90252622479d71d55574ed", "message": "To be useful from ActiveDirectoryUserDetail, overridable setAuthorities needs to be called from the ctor (yes this is an antipattern)", "committedDate": "2020-08-21T20:25:50Z", "type": "commit"}, {"oid": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "url": "https://github.com/jenkinsci/jenkins/commit/7befcfdd773a0eccf7b6930f110ff7331410b0cf", "message": "INFRA-266 Adjust test for plugins over https", "committedDate": "2020-08-24T06:35:51Z", "type": "commit"}, {"oid": "80bcc26e39943c7beb793ca7a08f33678ef88c32", "url": "https://github.com/jenkinsci/jenkins/commit/80bcc26e39943c7beb793ca7a08f33678ef88c32", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-24T12:52:05Z", "type": "commit"}, {"oid": "a8785495294467d033625fdddbacad1b55d7a4d5", "url": "https://github.com/jenkinsci/jenkins/commit/a8785495294467d033625fdddbacad1b55d7a4d5", "message": "Merge branch 'UpdateCenter2Test.install' into spring-5303", "committedDate": "2020-08-24T12:53:22Z", "type": "commit"}, {"oid": "48459727d5bec54d254c40c98fce1d8cd61398a9", "url": "https://github.com/jenkinsci/jenkins/commit/48459727d5bec54d254c40c98fce1d8cd61398a9", "message": "Merge branch 'fix-test' of github.com:timja/jenkins into spring-5303", "committedDate": "2020-08-24T12:53:54Z", "type": "commit"}, {"oid": "e2b6ff930d708c1a53b748c1a597a4e7d03dcfa1", "url": "https://github.com/jenkinsci/jenkins/commit/e2b6ff930d708c1a53b748c1a597a4e7d03dcfa1", "message": "Round-tripping SecurityRealm.AUTHENTICATED_AUTHORITY as object identity: https://github.com/jenkinsci/saml-plugin/blob/351a0210a31c2368b5630c91316afe8bee3b0f5f/src/main/java/org/jenkinsci/plugins/saml/SamlUserDetailsService.java#L62", "committedDate": "2020-08-24T13:20:31Z", "type": "commit"}, {"oid": "1a90114a3b37574afbdb97f815a207924c4d7e26", "url": "https://github.com/jenkinsci/jenkins/commit/1a90114a3b37574afbdb97f815a207924c4d7e26", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-27T20:03:04Z", "type": "commit"}, {"oid": "929dcd38bcc88ff45b4ae999da0babbce42bfecb", "url": "https://github.com/jenkinsci/jenkins/commit/929dcd38bcc88ff45b4ae999da0babbce42bfecb", "message": "Catching and translating AuthenticationException & AcegiSecurityException more broadly.\nShould improve compatibility for code like: https://github.com/jenkinsci/matrix-auth-plugin/blob/9616b3877395aa1e8b0b403601a968fa7a461193/src/main/java/org/jenkinsci/plugins/matrixauth/AuthorizationContainerDescriptor.java#L139-L167", "committedDate": "2020-08-27T20:15:14Z", "type": "commit"}, {"oid": "5f119f5e01789910003989d34e4fd846c1e462a4", "url": "https://github.com/jenkinsci/jenkins/commit/5f119f5e01789910003989d34e4fd846c1e462a4", "message": "https://github.com/spring-projects/spring-security/releases/tag/5.3.4.RELEASE", "committedDate": "2020-08-28T13:30:20Z", "type": "commit"}, {"oid": "2f6380ca7fd52d0e01239c1070f2975573c13cbc", "url": "https://github.com/jenkinsci/jenkins/commit/2f6380ca7fd52d0e01239c1070f2975573c13cbc", "message": "Use JUnit 5", "committedDate": "2020-08-28T21:49:20Z", "type": "commit"}, {"oid": "fe269a9e0f37696fe3564251a3234792273953f0", "url": "https://github.com/jenkinsci/jenkins/commit/fe269a9e0f37696fe3564251a3234792273953f0", "message": "While UsernameNotFoundException extends BadCredentialsException in Acegi Security, in Spring Security it directly extends AuthenticationException", "committedDate": "2020-08-28T21:53:45Z", "type": "commit"}, {"oid": "5d87079ab0bb6bd92419700c141689f44406f6c3", "url": "https://github.com/jenkinsci/jenkins/commit/5d87079ab0bb6bd92419700c141689f44406f6c3", "message": "Documenting that Run.fromExternalizableId can throw AccessDeniedException", "committedDate": "2020-08-28T22:08:48Z", "type": "commit"}, {"oid": "4eaf8831d3e72f558405c6e14785d22459ee546f", "url": "https://github.com/jenkinsci/jenkins/commit/4eaf8831d3e72f558405c6e14785d22459ee546f", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-08-31T14:34:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481150697", "bodyText": "does this even need to be exposed (could be said that it is just a poilluting methid in the previous version) and the only legitimate use case is in close", "author": "jtnord", "createdAt": "2020-09-01T13:47:55Z", "path": "core/src/main/java/hudson/security/ACLContext.java", "diffHunk": "@@ -52,12 +52,21 @@\n     /**\n      * Accessor for the previous context.\n      * @return the previous context.\n+     * @since TODO\n      */\n     @NonNull\n-    public SecurityContext getPreviousContext() {\n+    public SecurityContext getPreviousContext2() {", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MjA0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481152045", "bodyText": "use case in https://github.com/jenkinsci/jenkins/pull/4848/files#diff-7703322191e82930e0d5d450dc9ba1adR322", "author": "jtnord", "createdAt": "2020-09-01T13:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MjA1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481152056", "bodyText": "Probably true, AFAIK it is unused.", "author": "jglick", "createdAt": "2020-09-01T13:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MzE5Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481153192", "bodyText": "Ah, not quite, used inside core at least: \n  \n    \n      jenkins/core/src/main/java/hudson/model/AbstractItem.java\n    \n    \n        Lines 316 to 327\n      in\n      7edfc71\n    \n    \n    \n    \n\n        \n          \n           try (ACLContext ctx = ACL.as(ACL.SYSTEM)) { \n        \n\n        \n          \n               item = getParent().getItem(newName); \n        \n\n        \n          \n               if (item != null) { \n        \n\n        \n          \n                   if (LOGGER.isLoggable(Level.FINE)) { \n        \n\n        \n          \n                       LOGGER.log(Level.FINE, \"Unable to rename the job {0}: name {1} is already in use. \" + \n        \n\n        \n          \n                               \"User {2} has no {3} permission for existing job with the same name\", \n        \n\n        \n          \n                               new Object[] {this.getFullName(), newName, ctx.getPreviousContext().getAuthentication().getName(), Item.DISCOVER.name} ); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n                   // Don't explicitly mention that there is another item with the same name. \n        \n\n        \n          \n                   throw new Failure(Messages.Jenkins_NotAllowedName(newName)); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "jglick", "createdAt": "2020-09-01T13:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MzkyNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481153925", "bodyText": "just that one occurrence in Jenkins.  basically backtracking authentication after elevation when an operation failed (was checking if an item existed, which needs to run as the system user).", "author": "jtnord", "createdAt": "2020-09-01T13:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1NTc5MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481155791", "bodyText": "Right. Anyway, I can mark this restricted, or just leave it as is\u2014harmless, reasonably intuitive getter.", "author": "jglick", "createdAt": "2020-09-01T13:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDY5Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzMzMxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481233316", "bodyText": "would it be possible to @Restrict(NoExternalUse.class) this (so that forces plugins to upgrade).\nperhaps that is a general question that should be asked higher up?", "author": "jtnord", "createdAt": "2020-09-01T15:31:11Z", "path": "core/src/main/java/org/acegisecurity/BadCredentialsException.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity;\n+\n+import org.acegisecurity.userdetails.UsernameNotFoundException;\n+\n+/**\n+ * @deprecated use {@link org.springframework.security.authentication.BadCredentialsException}\n+ */\n+@Deprecated", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0MzgyMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481243823", "bodyText": "That is a general question and my answer is emphatically no. @Deprecated means it will continue to work but you should switch to the new thing as soon as you can. That is exactly the case. Abuse of @Restricted has caused terrible headaches.", "author": "jglick", "createdAt": "2020-09-01T15:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzMzMxNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzNDMzNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481234337", "bodyText": "deprecated?  https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/acls/domain/GrantedAuthoritySid.html", "author": "jtnord", "createdAt": "2020-09-01T15:32:41Z", "path": "core/src/main/java/org/acegisecurity/acls/sid/GrantedAuthoritySid.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.acls.sid;\n+\n+import java.util.Objects;\n+import org.springframework.security.core.GrantedAuthority;\n+\n+public class GrantedAuthoritySid implements Sid {", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0NDQ1MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481244451", "bodyText": "See JEP. For now I am leaving these undeprecated because they are basically self-contained and harmless. It would be possible to deprecate them if SidAcl were also converted to work bidirectionally.", "author": "jglick", "createdAt": "2020-09-01T15:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzNDMzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzNzE5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481237196", "bodyText": "I was wondering why this does not extend org.springframework.security.acls.models.Sid", "author": "jtnord", "createdAt": "2020-09-01T15:37:04Z", "path": "core/src/main/java/org/acegisecurity/acls/sid/Sid.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.acls.sid;\n+\n+// TODO perhaps delegate to the org.springframework.security.acls package", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0NDgwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481244800", "bodyText": "See JEP. There is deliberately no subtype relationship between Acegi Security and Spring Security types.", "author": "jglick", "createdAt": "2020-09-01T15:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzNzE5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzODIzOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481238238", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public abstract class AbstractAuthenticationToken implements Authentication {\n          \n          \n            \n            @Deprecated\n          \n          \n            \n            public abstract class AbstractAuthenticationToken implements Authentication {", "author": "jtnord", "createdAt": "2020-09-01T15:38:41Z", "path": "core/src/main/java/org/acegisecurity/providers/AbstractAuthenticationToken.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.providers;\n+\n+import java.util.Arrays;\n+import java.util.Objects;\n+import org.acegisecurity.Authentication;\n+import org.acegisecurity.GrantedAuthority;\n+import org.acegisecurity.userdetails.UserDetails;\n+\n+/**\n+ * @deprecated use {@link org.springframework.security.authentication.AbstractAuthenticationToken}\n+ */\n+public abstract class AbstractAuthenticationToken implements Authentication {", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "17a7fcb7d50c2d459999857017a516fcaefc49a9", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/providers/AbstractAuthenticationToken.java b/core/src/main/java/org/acegisecurity/providers/AbstractAuthenticationToken.java\nindex 3a28d525c7..266e581e40 100644\n--- a/core/src/main/java/org/acegisecurity/providers/AbstractAuthenticationToken.java\n+++ b/core/src/main/java/org/acegisecurity/providers/AbstractAuthenticationToken.java\n\n@@ -33,6 +33,7 @@ import org.acegisecurity.userdetails.UserDetails;\n /**\n  * @deprecated use {@link org.springframework.security.authentication.AbstractAuthenticationToken}\n  */\n+@Deprecated\n public abstract class AbstractAuthenticationToken implements Authentication {\n \n     private final GrantedAuthority[] authorities;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzODc5MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481238790", "bodyText": "should be in addition not removing (based on my superb up to date legal skilz)\nor github is lying that this is a rename", "author": "jtnord", "createdAt": "2020-09-01T15:39:33Z", "path": "core/src/main/java/org/acegisecurity/providers/AuthenticationProvider.java", "diffHunk": "@@ -1,7 +1,7 @@\n /*\n  * The MIT License\n  *\n- * Copyright (c) 2004-2010, Oracle Corporation\n+ * Copyright 2020 CloudBees, Inc.", "originalCommit": "4eaf8831d3e72f558405c6e14785d22459ee546f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0NjkwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481246902", "bodyText": "Git\u2019s file rename detection is confused. Since, unlike say Mercurial, this happens at view time not commit time, I cannot force it to understand.", "author": "jglick", "createdAt": "2020-09-01T15:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzODc5MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "17a7fcb7d50c2d459999857017a516fcaefc49a9", "url": "https://github.com/jenkinsci/jenkins/commit/17a7fcb7d50c2d459999857017a516fcaefc49a9", "message": "AbstractAuthenticationToken should be @Deprecated\n\nCo-authored-by: James Nord <jtnord@users.noreply.github.com>", "committedDate": "2020-09-01T15:49:53Z", "type": "commit"}, {"oid": "b7d7d890c10bc0d0175532a916015767382ada14", "url": "https://github.com/jenkinsci/jenkins/commit/b7d7d890c10bc0d0175532a916015767382ada14", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-01T15:51:46Z", "type": "commit"}, {"oid": "fd744d2885967f1eb91e1f96166a195c838dc9aa", "url": "https://github.com/jenkinsci/jenkins/commit/fd744d2885967f1eb91e1f96166a195c838dc9aa", "message": "Apparently the ~2h of functional tests do not include the corner case that you mistyped your password", "committedDate": "2020-09-02T19:58:12Z", "type": "commit"}, {"oid": "7fa8a12c2fded5c9f14a0aac65a2d89a2496940e", "url": "https://github.com/jenkinsci/jenkins/commit/7fa8a12c2fded5c9f14a0aac65a2d89a2496940e", "message": "Reverting unintentional Javadoc change", "committedDate": "2020-09-02T23:00:41Z", "type": "commit"}, {"oid": "2be214610581d57ab9d79a72e7d3b93537df1396", "url": "https://github.com/jenkinsci/jenkins/commit/2be214610581d57ab9d79a72e7d3b93537df1396", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-14T19:07:03Z", "type": "commit"}, {"oid": "657338cf6acaef08fd83f7af942973e5f829cde0", "url": "https://github.com/jenkinsci/jenkins/commit/657338cf6acaef08fd83f7af942973e5f829cde0", "message": "Round-trip org.acegisecurity.Authentication, making LdapMultiEmbedded2Test.login pass in PCT", "committedDate": "2020-09-14T19:21:34Z", "type": "commit"}, {"oid": "4bb45a702b8d933e57dcba8707dd51bd41e3697e", "url": "https://github.com/jenkinsci/jenkins/commit/4bb45a702b8d933e57dcba8707dd51bd41e3697e", "message": "Round-trip DataAccessException, for PCT in LdapMultiEmbeddedTest", "committedDate": "2020-09-14T19:43:18Z", "type": "commit"}, {"oid": "862e4e51dd0518bb6d3d07afbf16cf96b6ecfc6d", "url": "https://github.com/jenkinsci/jenkins/commit/862e4e51dd0518bb6d3d07afbf16cf96b6ecfc6d", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-16T12:40:42Z", "type": "commit"}, {"oid": "2bf618557330d8bf9b16378cec4c8d5c713d9133", "url": "https://github.com/jenkinsci/jenkins/commit/2bf618557330d8bf9b16378cec4c8d5c713d9133", "message": "Bumping detached copy of ldap, for now to the release of https://github.com/jenkinsci/ldap-plugin/pull/48", "committedDate": "2020-09-16T12:42:18Z", "type": "commit"}, {"oid": "5b60ed0693685aa18ac64841c5d0fa87dca60ab2", "url": "https://github.com/jenkinsci/jenkins/commit/5b60ed0693685aa18ac64841c5d0fa87dca60ab2", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-17T17:29:59Z", "type": "commit"}, {"oid": "c020f8a3a7dd2108106d7fcbc7f81b8b6ff66a37", "url": "https://github.com/jenkinsci/jenkins/commit/c020f8a3a7dd2108106d7fcbc7f81b8b6ff66a37", "message": "org.acegisecurity.ui.remember \u2192 org.acegisecurity.ui.rememberme", "committedDate": "2020-09-18T18:03:05Z", "type": "commit"}, {"oid": "ba608c3c0b3671c139aff1b979e78a57c7859237", "url": "https://github.com/jenkinsci/jenkins/commit/ba608c3c0b3671c139aff1b979e78a57c7859237", "message": "TokenBasedRememberMeServices2 is not intended as an API", "committedDate": "2020-09-18T18:07:17Z", "type": "commit"}, {"oid": "dc589f12226ac7649d3714cbf9d9254863fe0545", "url": "https://github.com/jenkinsci/jenkins/commit/dc589f12226ac7649d3714cbf9d9254863fe0545", "message": "UserDetailsSpringImpl can be marked deprecated to avoid warnings about references", "committedDate": "2020-09-18T18:26:14Z", "type": "commit"}, {"oid": "1039b2bd5d028609662c7a925cceb017ca8e8151", "url": "https://github.com/jenkinsci/jenkins/commit/1039b2bd5d028609662c7a925cceb017ca8e8151", "message": "Round-trip RememberMeServices subtypes, expected by crowd2", "committedDate": "2020-09-18T18:28:33Z", "type": "commit"}, {"oid": "419e44e9f0f9ae80dacf2d7c4840b7f9b5cc9ccb", "url": "https://github.com/jenkinsci/jenkins/commit/419e44e9f0f9ae80dacf2d7c4840b7f9b5cc9ccb", "message": "TokenBasedRememberMeServices placeholder for CrowdServletFilter", "committedDate": "2020-09-18T19:01:43Z", "type": "commit"}, {"oid": "950666e37d7fe45110cc40e74806a485ecaaaef0", "url": "https://github.com/jenkinsci/jenkins/commit/950666e37d7fe45110cc40e74806a485ecaaaef0", "message": "crowd2 uses AccountExpiredException, CredentialsExpiredException, & InsufficientAuthenticationException", "committedDate": "2020-09-18T19:15:20Z", "type": "commit"}, {"oid": "14f20741579f22de7dd0e258394484f11610d498", "url": "https://github.com/jenkinsci/jenkins/commit/14f20741579f22de7dd0e258394484f11610d498", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-21T16:59:48Z", "type": "commit"}, {"oid": "df3ca87e7688cae5d1223dedd15316a619004d6d", "url": "https://github.com/jenkinsci/jenkins/commit/df3ca87e7688cae5d1223dedd15316a619004d6d", "message": "https://github.com/spring-projects/spring-security/releases/tag/5.4.0", "committedDate": "2020-09-21T17:02:48Z", "type": "commit"}, {"oid": "e69a339d6a66c74a717ab8209e47286af0b4ef11", "url": "https://github.com/jenkinsci/jenkins/commit/e69a339d6a66c74a717ab8209e47286af0b4ef11", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-28T16:19:53Z", "type": "commit"}, {"oid": "b6d5a6ee78c6bff991c6a527ca97d39f1b68d9ba", "url": "https://github.com/jenkinsci/jenkins/commit/b6d5a6ee78c6bff991c6a527ca97d39f1b68d9ba", "message": "Handle calls to super.getPostLogOutUrl without StackOverflowError", "committedDate": "2020-09-28T17:01:09Z", "type": "commit"}, {"oid": "4bed0db2fafe3129f03b04cff567e46b5e969de6", "url": "https://github.com/jenkinsci/jenkins/commit/4bed0db2fafe3129f03b04cff567e46b5e969de6", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-09-29T21:44:51Z", "type": "commit"}, {"oid": "6548efe6eb2f3f00da727909582df753c9c66e32", "url": "https://github.com/jenkinsci/jenkins/commit/6548efe6eb2f3f00da727909582df753c9c66e32", "message": "Compatibility for ProviderNotFoundException", "committedDate": "2020-09-29T21:54:14Z", "type": "commit"}, {"oid": "eb4e22d3c59610dd4843732e684d213a4362ccdd", "url": "https://github.com/jenkinsci/jenkins/commit/eb4e22d3c59610dd4843732e684d213a4362ccdd", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-10-06T15:14:59Z", "type": "commit"}, {"oid": "df7c2e982c0b1704a8b8633c0223ae35114948f2", "url": "https://github.com/jenkinsci/jenkins/commit/df7c2e982c0b1704a8b8633c0223ae35114948f2", "message": "Binary compatibility for ImpersonatingUserDetailsService, used by at least https://github.com/apefactory/cloudfoundry-uaa-oauth", "committedDate": "2020-10-06T15:29:36Z", "type": "commit"}, {"oid": "83e4fe9ba1bb19e2ff70213ed49347a6806420e5", "url": "https://github.com/jenkinsci/jenkins/commit/83e4fe9ba1bb19e2ff70213ed49347a6806420e5", "message": "Restoring SecurityRealm.createCliAuthenticator to minimize disruption", "committedDate": "2020-10-06T16:48:36Z", "type": "commit"}, {"oid": "da3d17b85f80c47cd227ba4ab169508e19271c41", "url": "https://github.com/jenkinsci/jenkins/commit/da3d17b85f80c47cd227ba4ab169508e19271c41", "message": "Restricted a lot of APIs which should not be used in plugins.\nGathered this list by looking at incompatible changes in japicmp.\nMost are in fact unused; collabnet plugin uses many, but seems to be a blind copy-paste from core.\nExceptionTranslationFilter now merely extended the Spring version, so may as well delete.", "committedDate": "2020-10-06T19:01:52Z", "type": "commit"}, {"oid": "7ff3ff57c6f7342c90d76a652f6cd7962ca7d872", "url": "https://github.com/jenkinsci/jenkins/commit/7ff3ff57c6f7342c90d76a652f6cd7962ca7d872", "message": "Suppress some doclint as in https://github.com/jenkinsci/plugin-pom/pull/356", "committedDate": "2020-10-06T21:59:19Z", "type": "commit"}, {"oid": "7646dfd127bfe3132b5b33b55dd5306a2b600902", "url": "https://github.com/jenkinsci/jenkins/commit/7646dfd127bfe3132b5b33b55dd5306a2b600902", "message": "Broken Javadoc reference after da3d17b85f80c47cd227ba4ab169508e19271c41", "committedDate": "2020-10-06T22:01:37Z", "type": "commit"}, {"oid": "d2ae6cadd44613af8d4f65650efe13baace2c36b", "url": "https://github.com/jenkinsci/jenkins/commit/d2ae6cadd44613af8d4f65650efe13baace2c36b", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-10-14T14:03:27Z", "type": "commit"}, {"oid": "3e3792d61ff6142700e61c6516b138e39d9087b9", "url": "https://github.com/jenkinsci/jenkins/commit/3e3792d61ff6142700e61c6516b138e39d9087b9", "message": "Merge branch 'master' of https://github.com/jenkinsci/jenkins into spring-5303", "committedDate": "2020-10-19T20:08:32Z", "type": "commit"}, {"oid": "3ce4ca341c7a447e7852d5af1650f58dfdb7e58d", "url": "https://github.com/jenkinsci/jenkins/commit/3ce4ca341c7a447e7852d5af1650f58dfdb7e58d", "message": "https://github.com/spring-projects/spring-security/releases/tag/5.4.1", "committedDate": "2020-10-19T20:11:20Z", "type": "commit"}, {"oid": "899773eb2383ce4971451d78a6b0504adc242c94", "url": "https://github.com/jenkinsci/jenkins/commit/899773eb2383ce4971451d78a6b0504adc242c94", "message": "Merge branch 'master' of https://github.com/jenkinsci/jenkins into spring-5303", "committedDate": "2020-10-20T14:55:58Z", "type": "commit"}, {"oid": "757e1a7eb5db21fc19aa6345e82f9499faa25665", "url": "https://github.com/jenkinsci/jenkins/commit/757e1a7eb5db21fc19aa6345e82f9499faa25665", "message": "DisabledException & LockedException referenced from https://github.com/jenkinsci/cas-plugin/blob/d17aa8583af17dfdb8e069c41f986f2d844a719c/src/main/java/org/jenkinsci/plugins/cas/spring/security/AcegiAuthenticationManager.java#L53-L56", "committedDate": "2020-10-20T15:21:49Z", "type": "commit"}, {"oid": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "url": "https://github.com/jenkinsci/jenkins/commit/ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "message": "HttpSessionContextIntegrationFilter2 is used by cas and collabnet plugins.\nUnrestricting it will not allow versions built on Acegi Security to work, since its signature is changing,\nbut will at least allow newer versions rewritten to Spring Security to retain this functionality.\nIdeally there would be some more opaque mechanism to make more pieces of SecurityRealm.createFilter reusable\n(this one is not in commonFilters shared with LegacySecurityRealm).", "committedDate": "2020-10-20T20:59:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MjYyMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510442622", "bodyText": "jenkinsci/lib-access-modifier#28 would be useful here and in a few other places.", "author": "jglick", "createdAt": "2020-10-22T20:39:10Z", "path": "core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java", "diffHunk": "@@ -87,15 +112,65 @@ private UserDetails doAuthenticate(String username, String password) throws Auth\n      * a query like this, just always throw {@link UsernameNotFoundException}.\n      */\n     @Override\n-    public abstract UserDetails loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException;\n+    public UserDetails loadUserByUsername2(String username) throws UsernameNotFoundException {\n+        if (Util.isOverridden(AbstractPasswordBasedSecurityRealm.class, getClass(), \"loadUserByUsername\", String.class)) {\n+            try {\n+                return loadUserByUsername(username).toSpring();\n+            } catch (org.acegisecurity.AcegiSecurityException x) {\n+                throw x.toSpring();\n+            } catch (org.springframework.dao.DataAccessException x) {\n+                throw x.toSpring();\n+            }\n+        } else {\n+            throw new AbstractMethodError(\"Implement loadUserByUsername2\");", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NDU5Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510444593", "bodyText": "Not sure what to do with this. Could deprecate fireFailedToLogIn, though some security realms might be able to support it. Could introduce an overload with no name, though that seems pretty useless. Not sure if anyone even listens to this event to begin with.", "author": "jglick", "createdAt": "2020-10-22T20:43:05Z", "path": "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java", "diffHunk": "@@ -100,26 +116,25 @@ protected void onSuccessfulAuthentication(HttpServletRequest request, HttpServle\n             newSession.setAttribute(UserSeedProperty.USER_SESSION_SEED, sessionSeed);\n         }\n \n-        // as the request comes from Acegi redirect, that's not a Stapler one\n+        // as the request comes from Spring Security redirect, that's not a Stapler one\n         // thus it's not possible to retrieve it in the SecurityListener in that case\n         // for that reason we need to keep the above code that apply quite the same logic as UserSeedSecurityListener\n         SecurityListener.fireLoggedIn(authResult.getName());\n     }\n \n     /**\n      * Leave the information about login failure.\n-     *\n-     * <p>\n-     * Otherwise it seems like Acegi doesn't really leave the detail of the failure anywhere.\n      */\n     @Override\n-    protected void onUnsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed) throws IOException {\n-        super.onUnsuccessfulAuthentication(request, response, failed);\n+    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed) throws IOException, ServletException {\n+        super.unsuccessfulAuthentication(request, response, failed);\n         LOGGER.log(Level.FINE, \"Login attempt failed\", failed);\n+        /* TODO this information appears to have been deliberately removed from Spring Security:\n         Authentication auth = failed.getAuthentication();\n         if (auth != null) {\n             SecurityListener.fireFailedToLogIn(auth.getName());", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2NzQ5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517467494", "bodyText": "I'd kind of like to get more data exposed in audit-log-plugin, though that doesn't appear to listen for this event yet. It is listening for login and logout events, though, so it would make sense to support.", "author": "jvz", "createdAt": "2020-11-04T16:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NDU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzMDgyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517530821", "bodyText": "Right. I spent a bit of time trying to figure out how to restore this, without success. If you find something, I guess it can be added later.\nIn terms of impact, I can find only https://github.com/jenkinsci/datadog-plugin/blob/6d327f9e6719ee01689e10410b627b39958c7fad/src/main/java/org/datadog/jenkins/plugins/datadog/listeners/DatadogSecurityListener.java#L131-L134 and \n  \n    \n      jenkins/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\n    \n    \n         Line 101\n      in\n      f04114c\n    \n    \n    \n    \n\n        \n          \n           SecurityListener.fireFailedToAuthenticate(username); \n        \n    \n  \n\n still fires that event.", "author": "jglick", "createdAt": "2020-11-04T17:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NDU5Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NTcxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510445716", "bodyText": "Was helpful during development, and seems harmless to leave in.", "author": "jglick", "createdAt": "2020-10-22T20:45:13Z", "path": "core/src/main/java/hudson/security/ChainedServletFilter.java", "diffHunk": "@@ -70,24 +73,41 @@ public void init(FilterConfig filterConfig) throws ServletException {\n             f.init(filterConfig);\n     }\n \n+    private static final Pattern UNINTERESTING_URIS = Pattern.compile(\"/(images|jsbundles|css|scripts|adjuncts)/|/favicon[.]ico|/ajax\");\n+    @Override\n     public void doFilter(ServletRequest request, ServletResponse response, final FilterChain chain) throws IOException, ServletException {\n-        LOGGER.entering(ChainedServletFilter.class.getName(), \"doFilter\");\n+        String uri = request instanceof HttpServletRequest ? ((HttpServletRequest) request).getRequestURI() : \"?\";\n+        Level level = UNINTERESTING_URIS.matcher(uri).find() ? Level.FINER : Level.FINE;\n+        LOGGER.log(level, () -> \"starting filter on \" + uri);", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NTkwMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510445901", "bodyText": "Was helpful during development, and seems harmless to leave in.", "author": "jglick", "createdAt": "2020-10-22T20:45:35Z", "path": "core/src/main/java/hudson/security/ChainedServletFilter.java", "diffHunk": "@@ -70,24 +73,41 @@ public void init(FilterConfig filterConfig) throws ServletException {\n             f.init(filterConfig);\n     }\n \n+    private static final Pattern UNINTERESTING_URIS = Pattern.compile(\"/(images|jsbundles|css|scripts|adjuncts)/|/favicon[.]ico|/ajax\");\n+    @Override\n     public void doFilter(ServletRequest request, ServletResponse response, final FilterChain chain) throws IOException, ServletException {\n-        LOGGER.entering(ChainedServletFilter.class.getName(), \"doFilter\");\n+        String uri = request instanceof HttpServletRequest ? ((HttpServletRequest) request).getRequestURI() : \"?\";\n+        Level level = UNINTERESTING_URIS.matcher(uri).find() ? Level.FINER : Level.FINE;\n+        LOGGER.log(level, () -> \"starting filter on \" + uri);", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0Njc3NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510446774", "bodyText": "Whatever it was all this did, it does not appear to have had any test coverage, and may well be obsolete given Spring Security implementation details.", "author": "jglick", "createdAt": "2020-10-22T20:47:13Z", "path": "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java", "diffHunk": "@@ -23,33 +23,46 @@\n  */\n package hudson.security;\n \n-import java.util.Properties;\n-import java.util.logging.Logger;\n-import java.util.logging.Level;\n+import hudson.model.User;\n import java.io.IOException;\n-\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n import javax.servlet.http.HttpSession;\n-\n-import hudson.Util;\n-import hudson.model.User;\n import jenkins.security.SecurityListener;\n import jenkins.security.seed.UserSeedProperty;\n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.AuthenticationException;\n-import org.acegisecurity.ui.webapp.AuthenticationProcessingFilter;\n+import org.kohsuke.accmod.Restricted;\n+import org.kohsuke.accmod.restrictions.NoExternalUse;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.AuthenticationException;\n+import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\n+import org.springframework.security.web.util.matcher.AntPathRequestMatcher;\n \n /**\n- * {@link AuthenticationProcessingFilter} with a change for Jenkins so that\n+ * Login filter with a change for Jenkins so that\n  * we can pick up the hidden \"from\" form field defined in {@code login.jelly}\n  * to send the user back to where he came from, after a successful authentication.\n  * \n  * @author Kohsuke Kawaguchi\n  */\n-public class AuthenticationProcessingFilter2 extends AuthenticationProcessingFilter {\n+@Restricted(NoExternalUse.class)\n+public final class AuthenticationProcessingFilter2 extends UsernamePasswordAuthenticationFilter {\n+\n+    public AuthenticationProcessingFilter2(String authenticationGatewayUrl) {\n+        setRequiresAuthenticationRequestMatcher(new AntPathRequestMatcher(\"/\" + authenticationGatewayUrl, \"POST\"));\n+        // Jenkins/login.jelly & SetupWizard/authenticate-security-token.jelly\n+        setUsernameParameter(\"j_username\");\n+        setPasswordParameter(\"j_password\");\n+    }\n+\n+    /* TODO none of this compiles against Spring Security; rewrite (try InteractiveAuthenticationSuccessEvent & SimpleUrlAuthenticationFailureHandler):", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0Nzc2MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510447761", "bodyText": "See deprecation Javadoc for InvalidatableUserDetails.", "author": "jglick", "createdAt": "2020-10-22T20:49:01Z", "path": "core/src/main/java/hudson/security/HttpSessionContextIntegrationFilter2.java", "diffHunk": "@@ -67,18 +62,6 @@ public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n         super.doFilter(req, res, chain);\n     }\n \n-    private boolean isAuthInvalidated(Authentication authentication) {\n-        if (authentication.getPrincipal() instanceof InvalidatableUserDetails) {", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MDY1MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510450651", "bodyText": "Was used with BeanBuilder.", "author": "jglick", "createdAt": "2020-10-22T20:54:12Z", "path": "core/src/main/java/hudson/security/SecurityRealm.java", "diffHunk": "@@ -455,26 +536,6 @@ protected final boolean validateCaptcha(String text) {\n         return true;\n     }\n \n-    /**\n-     * Picks up the instance of the given type from the spring context.\n-     * If there are multiple beans of the same type or if there are none,\n-     * this method treats that as an {@link IllegalArgumentException}.\n-     *\n-     * This method is intended to be used to pick up a Acegi object from\n-     * spring once the bean definition file is parsed.\n-     */\n-    public static <T> T findBean(Class<T> type, ApplicationContext context) {", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MTIzNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510451237", "bodyText": "If this did something, I am not sure what, and it is not covered by tests.", "author": "jglick", "createdAt": "2020-10-22T20:55:14Z", "path": "core/src/main/java/hudson/security/SecurityRealm.java", "diffHunk": "@@ -509,14 +570,46 @@ public synchronized SecurityComponents getSecurityComponents() {\n     public Filter createFilter(FilterConfig filterConfig) {\n         LOGGER.entering(SecurityRealm.class.getName(), \"createFilter\");\n         \n-        Binding binding = new Binding();\n         SecurityComponents sc = getSecurityComponents();\n-        binding.setVariable(\"securityComponents\", sc);\n-        binding.setVariable(\"securityRealm\",this);\n-        BeanBuilder builder = new BeanBuilder();\n-        builder.parse(filterConfig.getServletContext().getResourceAsStream(\"/WEB-INF/security/SecurityFilters.groovy\"),binding);\n-        WebApplicationContext context = builder.createApplicationContext();\n-        return (Filter) context.getBean(\"filter\");\n+        List<Filter> filters = new ArrayList<>();\n+        {\n+            HttpSessionSecurityContextRepository httpSessionSecurityContextRepository = new HttpSessionSecurityContextRepository();\n+            httpSessionSecurityContextRepository.setAllowSessionCreation(false);\n+            filters.add(new HttpSessionContextIntegrationFilter2(httpSessionSecurityContextRepository));\n+        }\n+        { // if any \"Authorization: Basic xxx:yyy\" is sent this is the filter that processes it\n+            BasicHeaderProcessor bhp = new BasicHeaderProcessor();\n+            // if basic authentication fails (which only happens incorrect basic auth credential is sent),\n+            // respond with 401 with basic auth request, instead of redirecting the user to the login page,\n+            // since users of basic auth tends to be a program and won't see the redirection to the form\n+            // page as a failure\n+            BasicAuthenticationEntryPoint basicAuthenticationEntryPoint = new BasicAuthenticationEntryPoint();\n+            basicAuthenticationEntryPoint.setRealmName(\"Jenkins\");\n+            bhp.setAuthenticationEntryPoint(basicAuthenticationEntryPoint);\n+            bhp.setRememberMeServices(sc.rememberMe2);\n+            filters.add(bhp);\n+        }\n+        {\n+            AuthenticationProcessingFilter2 apf = new AuthenticationProcessingFilter2(getAuthenticationGatewayUrl());\n+            apf.setAuthenticationManager(sc.manager2);\n+            apf.setRememberMeServices(sc.rememberMe2);\n+            apf.setAuthenticationFailureHandler(new SimpleUrlAuthenticationFailureHandler(\"/loginError\"));\n+            // TODO apf.defaultTargetUrl = \"/\" try SavedRequestAwareAuthenticationSuccessHandler", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MjEwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510452109", "bodyText": "Spring Security changed a number of things that in Acegi Security were setters into constructor arguments plus final fields.", "author": "jglick", "createdAt": "2020-10-22T20:56:52Z", "path": "core/src/main/java/hudson/security/SecurityRealm.java", "diffHunk": "@@ -633,49 +726,96 @@ public SecurityRealm newInstance(StaplerRequest req, JSONObject formData) throws\n      * @see SecurityRealm#createSecurityComponents() \n      */\n     public static final class SecurityComponents {\n-        public final AuthenticationManager manager;\n-        public final UserDetailsService userDetails;\n-        public final RememberMeServices rememberMe;\n+        /**\n+         * @since TODO\n+         */\n+        public final AuthenticationManager manager2;\n+        /**\n+         * @deprecated use {@link #manager2}\n+         */\n+        @Deprecated\n+        public final org.acegisecurity.AuthenticationManager manager;\n+        /**\n+         * @since TODO\n+         */\n+        public final UserDetailsService userDetails2;\n+        /**\n+         * @deprecated use {@link #userDetails2}\n+         */\n+        @Deprecated\n+        public final org.acegisecurity.userdetails.UserDetailsService userDetails;\n+        /**\n+         * @since TODO\n+         */\n+        public final RememberMeServices rememberMe2;\n+        /**\n+         * @deprecated use {@link #rememberMe2}\n+         */\n+        @Deprecated\n+        public final org.acegisecurity.ui.rememberme.RememberMeServices rememberMe;\n \n         public SecurityComponents() {\n             // we use AuthenticationManagerProxy here just as an implementation that fails all the time,\n             // not as a proxy. No one is supposed to use this as a proxy.\n             this(new AuthenticationManagerProxy());\n         }\n \n+        /**\n+         * @since TODO\n+         */\n         public SecurityComponents(AuthenticationManager manager) {\n             // we use UserDetailsServiceProxy here just as an implementation that fails all the time,\n             // not as a proxy. No one is supposed to use this as a proxy.\n             this(manager,new UserDetailsServiceProxy());\n         }\n \n+        /**\n+         * @deprecated use {@link #SecurityComponents(AuthenticationManager)}\n+         */\n+        @Deprecated\n+        public SecurityComponents(org.acegisecurity.AuthenticationManager manager) {\n+            this(manager.toSpring());\n+        }\n+\n+        /**\n+         * @since TODO\n+         */\n         public SecurityComponents(AuthenticationManager manager, UserDetailsService userDetails) {\n             this(manager,userDetails,createRememberMeService(userDetails));\n         }\n \n+        /**\n+         * @deprecated use {@link #SecurityComponents(AuthenticationManager, UserDetailsService)}\n+         */\n+        @Deprecated\n+        public SecurityComponents(org.acegisecurity.AuthenticationManager manager, org.acegisecurity.userdetails.UserDetailsService userDetails) {\n+            this(manager.toSpring(), userDetails.toSpring());\n+        }\n+\n+        /**\n+         * @since TODO\n+         */\n         public SecurityComponents(AuthenticationManager manager, UserDetailsService userDetails, RememberMeServices rememberMe) {\n             assert manager!=null && userDetails!=null && rememberMe!=null;\n-            this.manager = manager;\n-            this.userDetails = userDetails;\n-            this.rememberMe = rememberMe;\n+            this.manager2 = manager;\n+            this.userDetails2 = userDetails;\n+            this.rememberMe2 = rememberMe;\n+            this.manager = org.acegisecurity.AuthenticationManager.fromSpring(manager);\n+            this.userDetails = org.acegisecurity.userdetails.UserDetailsService.fromSpring(userDetails);\n+            this.rememberMe = org.acegisecurity.ui.rememberme.RememberMeServices.fromSpring(rememberMe);\n+        }\n+\n+        /**\n+         * @deprecated use {@link #SecurityComponents(AuthenticationManager, UserDetailsService, RememberMeServices)}\n+         */\n+        @Deprecated\n+        public SecurityComponents(org.acegisecurity.AuthenticationManager manager, org.acegisecurity.userdetails.UserDetailsService userDetails, org.acegisecurity.ui.rememberme.RememberMeServices rememberMe) {\n+            this(manager.toSpring(), userDetails.toSpring(), rememberMe.toSpring());\n         }\n \n-        @SuppressWarnings(\"deprecation\")\n         private static RememberMeServices createRememberMeService(UserDetailsService uds) {\n             // create our default TokenBasedRememberMeServices, which depends on the availability of the secret key\n-            TokenBasedRememberMeServices2 rms = new TokenBasedRememberMeServices2();\n-            rms.setUserDetailsService(uds);\n-            /*\n-                TokenBasedRememberMeServices needs to be used in conjunction with RememberMeAuthenticationProvider,\n-                and both needs to use the same key (this is a reflection of a poor design in AcegiSecurity, if you ask me)\n-                and various security plugins have its own groovy script that configures them.\n-\n-                So if we change this, it creates a painful situation for those plugins by forcing them to choose\n-                to work with earlier version of Jenkins or newer version of Jenkins, and not both.\n-\n-                So we keep this here.\n-             */\n-            rms.setKey(Jenkins.get().getSecretKey());\n+            TokenBasedRememberMeServices2 rms = new TokenBasedRememberMeServices2(uds);", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1NDkwOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510454908", "bodyText": "No particular reason to switch to the Spring Security version of this package, which would require pulling in the spring-security-acl module as well as disruption to existing AuthorizationStrategys: so long as you stick to the String-based constructors, there is no conflict with usage of other Spring Security types.", "author": "jglick", "createdAt": "2020-10-22T21:02:06Z", "path": "core/src/main/java/hudson/security/SidACL.java", "diffHunk": "@@ -23,16 +23,15 @@\n  */\n package hudson.security;\n \n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.GrantedAuthority;\n-import org.acegisecurity.acls.sid.PrincipalSid;\n-import org.acegisecurity.acls.sid.GrantedAuthoritySid;\n-import org.acegisecurity.acls.sid.Sid;\n-\n import edu.umd.cs.findbugs.annotations.NonNull;\n-import java.util.logging.Logger;\n import static java.util.logging.Level.FINE;\n import static java.util.logging.Level.FINER;\n+import java.util.logging.Logger;\n+import org.acegisecurity.acls.sid.GrantedAuthoritySid;\n+import org.acegisecurity.acls.sid.PrincipalSid;\n+import org.acegisecurity.acls.sid.Sid;", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MzkwNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517473904", "bodyText": "Should spring-security-acl be blocked as a dependency then?", "author": "jvz", "createdAt": "2020-11-04T16:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1NDkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyNzY0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517527645", "bodyText": "What do you mean? It is not included as a dependency by this PR.", "author": "jglick", "createdAt": "2020-11-04T17:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1NDkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5NjkzMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517596931", "bodyText": "I meant as a precautionary measure so that downstream plugins don't think they should switch to that library just because of the rest of the Spring Security upgrade. I don't know if there's anything worth preventing, though, beyond confusion.", "author": "jvz", "createdAt": "2020-11-04T19:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1NDkwOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ2MjY2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510462667", "bodyText": "Only striving to retain compatibility for plugins referring to this constant, not the rest of the class.", "author": "jglick", "createdAt": "2020-10-22T21:16:47Z", "path": "core/src/main/java/org/acegisecurity/ui/rememberme/TokenBasedRememberMeServices.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.ui.rememberme;\n+\n+import org.springframework.security.web.authentication.rememberme.AbstractRememberMeServices;\n+\n+/**\n+ * @deprecated use {@link org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices}\n+ */\n+@Deprecated\n+public class TokenBasedRememberMeServices {\n+\n+    public static final String ACEGI_SECURITY_HASHED_REMEMBER_ME_COOKIE_KEY = AbstractRememberMeServices.SPRING_SECURITY_REMEMBER_ME_COOKIE_KEY;", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ2MzE2Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510463162", "bodyText": "Weak typing here.", "author": "jglick", "createdAt": "2020-10-22T21:17:36Z", "path": "core/src/main/java/org/acegisecurity/userdetails/UserDetails.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.userdetails;\n+\n+import edu.umd.cs.findbugs.annotations.CheckForNull;\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import edu.umd.cs.findbugs.annotations.Nullable;\n+import java.io.Serializable;\n+import org.acegisecurity.GrantedAuthority;\n+\n+/**\n+ * @deprecated use {@link org.springframework.security.core.userdetails.UserDetails} instead\n+ */\n+@Deprecated\n+public interface UserDetails extends Serializable {\n+\n+    GrantedAuthority[] getAuthorities();\n+\n+    String getPassword();\n+\n+    String getUsername();\n+\n+    boolean isAccountNonExpired();\n+\n+    boolean isAccountNonLocked();\n+\n+    boolean isCredentialsNonExpired();\n+\n+    boolean isEnabled();\n+\n+    default @NonNull org.springframework.security.core.userdetails.UserDetails toSpring() {\n+        return new UserDetailsSpringImpl(this);\n+    }\n+\n+    static @NonNull UserDetails fromSpring(@NonNull org.springframework.security.core.userdetails.UserDetails ud) {\n+        if (ud instanceof UserDetailsSpringImpl) {\n+            return ((UserDetailsSpringImpl) ud).delegate;\n+        }\n+        return new UserDetails() {\n+            @Override\n+            public GrantedAuthority[] getAuthorities() {\n+                return GrantedAuthority.fromSpring(ud.getAuthorities());\n+            }\n+            @Override\n+            public String getPassword() {\n+                return ud.getPassword();\n+            }\n+            @Override\n+            public String getUsername() {\n+                return ud.getUsername();\n+            }\n+            @Override\n+            public boolean isAccountNonExpired() {\n+                return ud.isAccountNonExpired();\n+            }\n+            @Override\n+            public boolean isAccountNonLocked() {\n+                return ud.isAccountNonLocked();\n+            }\n+            @Override\n+            public boolean isCredentialsNonExpired() {\n+                return ud.isCredentialsNonExpired();\n+            }\n+            @Override\n+            public boolean isEnabled() {\n+                return ud.isEnabled();\n+            }\n+        };\n+    }\n+\n+    static @Nullable Object toSpringPrincipal(@CheckForNull Object acegiPrincipal) {\n+        if (acegiPrincipal instanceof UserDetails) {\n+            return ((UserDetails) acegiPrincipal).toSpring();\n+        } else {\n+            return acegiPrincipal;", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ2MzQ2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510463467", "bodyText": "Just retained the methods I actually saw being used in test code.", "author": "jglick", "createdAt": "2020-10-22T21:18:16Z", "path": "core/src/main/java/org/acegisecurity/util/FieldUtils.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.util;\n+\n+/**\n+ * @deprecated use {@link org.apache.commons.lang.reflect.FieldUtils}\n+ */\n+@Deprecated\n+public final class FieldUtils {\n+\n+    public static Object getProtectedFieldValue(String protectedField, Object object) {\n+        try {\n+            return org.apache.commons.lang.reflect.FieldUtils.readField(object, protectedField, true);\n+        } catch (IllegalAccessException x) {\n+            throw new RuntimeException(x);\n+        }\n+    }\n+\n+    public static void setProtectedFieldValue(String protectedField, Object object, Object newValue) {\n+        try {\n+            org.apache.commons.lang.reflect.FieldUtils.writeField(object, protectedField, newValue, true);\n+        } catch (IllegalAccessException x) {\n+            throw new RuntimeException(x);\n+        }\n+    }\n+\n+    // TODO other methods as needed", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ2NTA3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r510465078", "bodyText": "Was using the super-old password hashes.", "author": "jglick", "createdAt": "2020-10-22T21:21:35Z", "path": "test/src/test/java/hudson/model/JobTest.java", "diffHunk": "@@ -205,12 +207,16 @@ public String getDisplayName() {\n         }\n     }\n \n-    @LocalData", "originalCommit": "ffe273a43a61c29e3dcb5340c4971cb4a63b10c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a8295086430452b72e4d61ee885cd536d973b7ee", "url": "https://github.com/jenkinsci/jenkins/commit/a8295086430452b72e4d61ee885cd536d973b7ee", "message": "Merge branch 'master' of https://github.com/jenkinsci/jenkins into spring-5303", "committedDate": "2020-10-26T12:43:28Z", "type": "commit"}, {"oid": "f04114c0f813501da9a072b984a6cf2f2f0a2180", "url": "https://github.com/jenkinsci/jenkins/commit/f04114c0f813501da9a072b984a6cf2f2f0a2180", "message": "Merge branch 'master' into spring-5303", "committedDate": "2020-11-01T09:21:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517471283", "bodyText": "I think so. BouncyCastle provides BCrypt, too, so it's not like a separate library was needed in the first place.", "author": "jvz", "createdAt": "2020-11-04T16:28:18Z", "path": "core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java", "diffHunk": "@@ -804,56 +860,7 @@ public Category getCategory() {\n         }\n     }\n \n-    /**\n-     * {@link PasswordEncoder} based on SHA-256 and random salt generation.\n-     *\n-     * <p>\n-     * The salt is prepended to the hashed password and returned. So the encoded password is of the form\n-     * {@code SALT ':' hash(PASSWORD,SALT)}.\n-     *\n-     * <p>\n-     * This abbreviates the need to store the salt separately, which in turn allows us to hide the salt handling\n-     * in this little class. The rest of the Acegi thinks that we are not using salt.\n-     */\n-    /*package*/ static final PasswordEncoder CLASSIC = new PasswordEncoder() {\n-        private final PasswordEncoder passwordEncoder = new ShaPasswordEncoder(256);\n-\n-        public String encodePassword(String rawPass, Object obj) throws DataAccessException {\n-            return hash(rawPass);\n-        }\n-\n-        public boolean isPasswordValid(String encPass, String rawPass, Object obj) throws DataAccessException {\n-            // pull out the sale from the encoded password\n-            int i = encPass.indexOf(':');\n-            if(i<0) return false;\n-            String salt = encPass.substring(0,i);\n-            return encPass.substring(i+1).equals(passwordEncoder.encodePassword(rawPass,salt));\n-        }\n-\n-        /**\n-         * Creates a hashed password by generating a random salt.\n-         */\n-        private String hash(String password) {\n-            String salt = generateSalt();\n-            return salt+':'+passwordEncoder.encodePassword(password,salt);\n-        }\n-\n-        /**\n-         * Generates random salt.\n-         */\n-        private String generateSalt() {\n-            StringBuilder buf = new StringBuilder();\n-            SecureRandom sr = new SecureRandom();\n-            for( int i=0; i<6; i++ ) {// log2(52^6)=34.20... so, this is about 32bit strong.\n-                boolean upper = sr.nextBoolean();\n-                char ch = (char)(sr.nextInt(26) + 'a');\n-                if(upper)   ch=Character.toUpperCase(ch);\n-                buf.append(ch);\n-            }\n-            return buf.toString();\n-        }\n-    };\n-\n+    // TODO can we instead use BCryptPasswordEncoder from Spring Security, which has its own copy of BCrypt so we could drop the special library?", "originalCommit": "f04114c0f813501da9a072b984a6cf2f2f0a2180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyNjkyNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517526927", "bodyText": "We cannot use BouncyCastle from core, though.", "author": "jglick", "createdAt": "2020-11-04T17:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyODgwNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517528807", "bodyText": "I suppose it shouldn't matter for this case, then, since Spring Security already includes a BCrypt implementation in its own dependencies like you mentioned in the comment here. Does this limitation include for remoting? That'd be annoying if the only way to support TLS 1.3 connections there is to use Java 11 or customizing your classpath manually.", "author": "jvz", "createdAt": "2020-11-04T17:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNTQ3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517535478", "bodyText": "Not sure what you are talking about. BouncyCastle is bundled only in a wrapper plugin for use by other plugins.", "author": "jglick", "createdAt": "2020-11-04T18:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5NTk4OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517595988", "bodyText": "BouncyCastle has JSSE glue to support TLS 1.3 in older JDKs than 11. Classes like SSLContext call into that which is the usual class for handling TLS code in Java.", "author": "jvz", "createdAt": "2020-11-04T19:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMTIzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r517601230", "bodyText": "Sorry, do not know anything about it. Off topic I suppose. The point here is that for now I kept the existing behavior of using our own bundled jBCrypt, but now that Spring Security also bundles their own copy, we could consider switching to that and dropping our dep. I did not attempt to do so here because the format uses by BCryptPasswordEncoder does not match that of existing saved passwords in Jenkins, so we would need to do more work.", "author": "jglick", "createdAt": "2020-11-04T20:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTI4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUzOTM2NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r539539365", "bodyText": "see #5105", "author": "jglick", "createdAt": "2020-12-09T18:19:47Z", "path": "core/src/main/java/org/acegisecurity/util/FieldUtils.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.util;\n+\n+/**\n+ * @deprecated use {@link org.apache.commons.lang.reflect.FieldUtils}\n+ */\n+@Deprecated\n+public final class FieldUtils {\n+\n+    public static Object getProtectedFieldValue(String protectedField, Object object) {\n+        try {\n+            return org.apache.commons.lang.reflect.FieldUtils.readField(object, protectedField, true);\n+        } catch (IllegalAccessException x) {\n+            throw new RuntimeException(x);\n+        }\n+    }\n+\n+    public static void setProtectedFieldValue(String protectedField, Object object, Object newValue) {\n+        try {\n+            org.apache.commons.lang.reflect.FieldUtils.writeField(object, protectedField, newValue, true);", "originalCommit": "f04114c0f813501da9a072b984a6cf2f2f0a2180", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjgyODkyMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r566828922", "bodyText": "noting regression https://issues.jenkins-ci.org/browse/JENKINS-64746 addressed in #5216", "author": "jtnord", "createdAt": "2021-01-29T13:41:02Z", "path": "core/src/main/java/hudson/model/UpdateCenter.java", "diffHunk": "@@ -67,7 +67,6 @@\n import jenkins.util.io.OnMaster;\n import net.sf.json.JSONObject;\n \n-import org.acegisecurity.Authentication;", "originalCommit": "f04114c0f813501da9a072b984a6cf2f2f0a2180", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "2caf0750292c8fadcee87372d419510250acdc35", "url": "https://github.com/jenkinsci/jenkins/commit/2caf0750292c8fadcee87372d419510250acdc35", "message": "Replacing Acegi Security with Spring Security", "committedDate": "2020-07-15T22:59:12Z", "type": "commit"}, {"oid": "82522cf52dee8289340bbf1a8cc65073ce9ed724", "url": "https://github.com/jenkinsci/jenkins/commit/82522cf52dee8289340bbf1a8cc65073ce9ed724", "message": "more", "committedDate": "2020-07-17T18:39:14Z", "type": "commit"}, {"oid": "62eba9c10485ad85b3a6ee1cab414177e4b792fd", "url": "https://github.com/jenkinsci/jenkins/commit/62eba9c10485ad85b3a6ee1cab414177e4b792fd", "message": "Change of approach: completely deprecating org.acegisecurity types", "committedDate": "2020-07-19T14:22:35Z", "type": "commit"}, {"oid": "0c02c446d84584945f26bf5526428ec64e368071", "url": "https://github.com/jenkinsci/jenkins/commit/0c02c446d84584945f26bf5526428ec64e368071", "message": "More conversion", "committedDate": "2020-07-19T14:43:56Z", "type": "commit"}, {"oid": "d898b35357805d87ad2115e851f1cd7d52272816", "url": "https://github.com/jenkinsci/jenkins/commit/d898b35357805d87ad2115e851f1cd7d52272816", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-20T20:14:53Z", "type": "commit"}, {"oid": "f5730525c5f0e24c2c28dec489ad3d6f9af40df3", "url": "https://github.com/jenkinsci/jenkins/commit/f5730525c5f0e24c2c28dec489ad3d6f9af40df3", "message": "More", "committedDate": "2020-07-20T20:57:52Z", "type": "commit"}, {"oid": "07412a9a15dc10b56390c151f85f93b2ec137032", "url": "https://github.com/jenkinsci/jenkins/commit/07412a9a15dc10b56390c151f85f93b2ec137032", "message": "Progress", "committedDate": "2020-07-20T22:54:13Z", "type": "commit"}, {"oid": "0613a19a7968c4f6174f7a22ca12b518cda469b2", "url": "https://github.com/jenkinsci/jenkins/commit/0613a19a7968c4f6174f7a22ca12b518cda469b2", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-21T00:59:24Z", "type": "commit"}, {"oid": "6af8f1c5a19fa38b30cb90689bc4a4458dfeb551", "url": "https://github.com/jenkinsci/jenkins/commit/6af8f1c5a19fa38b30cb90689bc4a4458dfeb551", "message": "Seems that everything except uses of BeanBuilder now compiles", "committedDate": "2020-07-21T02:06:47Z", "type": "commit"}, {"oid": "91110579cc2c57b2d1192e6b144932d9a1345785", "url": "https://github.com/jenkinsci/jenkins/commit/91110579cc2c57b2d1192e6b144932d9a1345785", "message": "Rewrite BeanBuilder configuration of security to plain old Java", "committedDate": "2020-07-21T02:49:25Z", "type": "commit"}, {"oid": "6601d98e3d9d031c4a4d72987e1db8c245d5fe59", "url": "https://github.com/jenkinsci/jenkins/commit/6601d98e3d9d031c4a4d72987e1db8c245d5fe59", "message": "core module now at least compiles", "committedDate": "2020-07-21T02:55:39Z", "type": "commit"}, {"oid": "b85c0d9ba38d761935b68730bb5da8fb1eb61c3d", "url": "https://github.com/jenkinsci/jenkins/commit/b85c0d9ba38d761935b68730bb5da8fb1eb61c3d", "message": "Starting to make tests compilable; will require changes to jenkins-test-harness", "committedDate": "2020-07-21T03:10:54Z", "type": "commit"}, {"oid": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "url": "https://github.com/jenkinsci/jenkins/commit/cfd98319f38ea8f9e2560351a068a1e5905b8208", "message": "Tweaking AuthenticationProcessingFilter2", "committedDate": "2020-07-21T11:14:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyMDk4OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458020989", "bodyText": "There is no replacement for AcegiSecurityException. AFAIK the purpose of this class is to nicely handle 403s, so this should be good enough.", "author": "jglick", "createdAt": "2020-07-21T11:17:54Z", "path": "core/src/main/java/hudson/ExpressionFactory2.java", "diffHunk": "@@ -72,7 +72,7 @@ public Object evaluate(JellyContext context) {\n                 CURRENT_CONTEXT.set(context);\n                 JexlContext jexlContext = new JellyJexlContext( context );\n                 return expression.evaluate(jexlContext);\n-            } catch (AcegiSecurityException e) {\n+            } catch (AccessDeniedException2 e) {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/ExpressionFactory2.java b/core/src/main/java/hudson/ExpressionFactory2.java\nindex ccf18a77d8..e372218249 100644\n--- a/core/src/main/java/hudson/ExpressionFactory2.java\n+++ b/core/src/main/java/hudson/ExpressionFactory2.java\n\n@@ -72,7 +72,7 @@ final class ExpressionFactory2 implements ExpressionFactory {\n                 CURRENT_CONTEXT.set(context);\n                 JexlContext jexlContext = new JellyJexlContext( context );\n                 return expression.evaluate(jexlContext);\n-            } catch (AccessDeniedException2 e) {\n+            } catch (AccessDeniedException e) {\n                 // let the security exception pass through\n                 throw e;\n             } catch (Exception e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyMTA3NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458021075", "bodyText": "Just a signature change in Spring.", "author": "jglick", "createdAt": "2020-07-21T11:18:05Z", "path": "core/src/main/java/hudson/ExtensionFinder.java", "diffHunk": "@@ -578,7 +578,7 @@ public Object get() {\n                 // so that we invoke them before derived class one. This isn't specified in JSR-250 but implemented\n                 // this way in Spring and what most developers would expect to happen.\n \n-                final Set<Class> interfaces = ClassUtils.getAllInterfacesAsSet(instance);\n+                final Set<Class<?>> interfaces = ClassUtils.getAllInterfacesAsSet(instance);", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/ExtensionFinder.java b/core/src/main/java/hudson/ExtensionFinder.java\nindex 4ac88b9d8d..ed4e3581b2 100644\n--- a/core/src/main/java/hudson/ExtensionFinder.java\n+++ b/core/src/main/java/hudson/ExtensionFinder.java\n\n@@ -578,7 +578,7 @@ public abstract class ExtensionFinder implements ExtensionPoint {\n                 // so that we invoke them before derived class one. This isn't specified in JSR-250 but implemented\n                 // this way in Spring and what most developers would expect to happen.\n \n-                final Set<Class<?>> interfaces = ClassUtils.getAllInterfacesAsSet(instance);\n+                final Set<Class> interfaces = ClassUtils.getAllInterfacesAsSet(instance);\n \n                 while (c != Object.class) {\n                     Arrays.stream(c.getDeclaredMethods())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyMjY3Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458022672", "bodyText": "Just translating the Groovy into equivalent Java.", "author": "jglick", "createdAt": "2020-07-21T11:21:17Z", "path": "core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java", "diffHunk": "@@ -31,14 +30,17 @@\n public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm implements UserDetailsService {\n     @Override\n     public SecurityComponents createSecurityComponents() {\n-        Binding binding = new Binding();\n-        binding.setVariable(\"authenticator\", new Authenticator());\n-\n-        BeanBuilder builder = new BeanBuilder();\n-        builder.parse(Jenkins.get().servletContext.getResourceAsStream(\"/WEB-INF/security/AbstractPasswordBasedSecurityRealm.groovy\"),binding);\n-        WebApplicationContext context = builder.createApplicationContext();\n+        // this does all the hard work.\n+        Authenticator authenticator = new Authenticator();\n+        // these providers apply everywhere\n+        RememberMeAuthenticationProvider rmap = new RememberMeAuthenticationProvider(Jenkins.get().getSecretKey());\n+        // this doesn't mean we allow anonymous access.\n+        // we just authenticate anonymous users as such,\n+        // so that later authorization can reject them if so configured\n+        AnonymousAuthenticationProvider aap = new AnonymousAuthenticationProvider(\"anonymous\");\n+        AuthenticationManager authenticationManager = new ProviderManager(authenticator, rmap, aap);", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java b/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\nindex f3cf6e7d73..bc1da9130e 100644\n--- a/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\n+++ b/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\n\n@@ -27,7 +27,7 @@ import org.springframework.security.core.userdetails.UsernameNotFoundException;\n  * @author Kohsuke Kawaguchi\n  * @since 1.317\n  */\n-public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm implements UserDetailsService {\n+public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm {\n     @Override\n     public SecurityComponents createSecurityComponents() {\n         // this does all the hard work.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyMzEwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458023109", "bodyText": "Deriving from the Acegi Security version in hopes of offering some compatibility, but untested.", "author": "jglick", "createdAt": "2020-07-21T11:22:14Z", "path": "core/src/main/java/hudson/security/AccessDeniedException2.java", "diffHunk": "@@ -1,50 +1,75 @@\n package hudson.security;\n \n-import org.acegisecurity.AccessDeniedException;\n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.GrantedAuthority;\n-\n import javax.servlet.http.HttpServletResponse;\n import java.io.PrintWriter;\n import jenkins.util.SystemProperties;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.GrantedAuthority;\n \n /**\n- * {@link AccessDeniedException} with more information.\n+ * {@link org.acegisecurity.AccessDeniedException} with more information.\n  * @author Kohsuke Kawaguchi\n  */\n-public class AccessDeniedException2 extends AccessDeniedException {\n+public class AccessDeniedException2 extends org.acegisecurity.AccessDeniedException {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/AccessDeniedException2.java b/core/src/main/java/hudson/security/AccessDeniedException2.java\nindex b99fec6d9d..c824babfbd 100644\n--- a/core/src/main/java/hudson/security/AccessDeniedException2.java\n+++ b/core/src/main/java/hudson/security/AccessDeniedException2.java\n\n@@ -1,56 +1,34 @@\n package hudson.security;\n \n+import org.acegisecurity.AccessDeniedException;\n+import org.acegisecurity.Authentication;\n+import org.acegisecurity.GrantedAuthority;\n+\n import javax.servlet.http.HttpServletResponse;\n import java.io.PrintWriter;\n import jenkins.util.SystemProperties;\n-import org.springframework.security.core.Authentication;\n-import org.springframework.security.core.GrantedAuthority;\n \n /**\n- * {@link org.acegisecurity.AccessDeniedException} with more information.\n+ * {@link AccessDeniedException} with more information.\n  * @author Kohsuke Kawaguchi\n+ * @deprecated use {@link AccessDeniedException3}\n  */\n-public class AccessDeniedException2 extends org.acegisecurity.AccessDeniedException {\n+@Deprecated\n+public class AccessDeniedException2 extends AccessDeniedException {\n \n     /** If true, report {@code X-You-Are-In-Group} headers. Disabled due to JENKINS-39402; use {@code /whoAmI} etc. to diagnose permission issues. */\n     private static /* not final */ boolean REPORT_GROUP_HEADERS = SystemProperties.getBoolean(AccessDeniedException2.class.getName() + \".REPORT_GROUP_HEADERS\");\n \n-    /**\n-     * @deprecated do not use\n-     */\n-    @Deprecated\n-    public final org.acegisecurity.Authentication authentication;\n-\n     /**\n      * This object represents the user being authenticated.\n      */\n-    private final Authentication springAuthentication;\n+    public final Authentication authentication;\n \n     /**\n      * This object represents the permission that the user needed.\n      */\n     public final Permission permission;\n \n-    /**\n-     * @deprecated use {@link #AccessDeniedException2(Authentication, Permission)}\n-     */\n-    @Deprecated\n-    public AccessDeniedException2(org.acegisecurity.Authentication authentication, Permission permission) {\n-        this(null, authentication, permission);\n-    }\n-\n-    /**\n-     * @deprecated use {@link #AccessDeniedException2(Throwable, Authentication, Permission)}\n-     */\n-    @Deprecated\n-    public AccessDeniedException2(Throwable t, org.acegisecurity.Authentication authentication, Permission permission) {\n-        super(Messages.AccessDeniedException2_MissingPermission(authentication.getName(),\n-                permission.group.title+\"/\"+permission.name), t);\n-        this.authentication = authentication;\n-        this.springAuthentication = authentication.toSpring();\n-        this.permission = permission;\n-    }\n-\n     public AccessDeniedException2(Authentication authentication, Permission permission) {\n         this(null,authentication,permission);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNDQzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458024433", "bodyText": "InvalidatableUserDetails was deprecated, so deleting this filter and hoping it was in fact unnecessary.", "author": "jglick", "createdAt": "2020-07-21T11:24:52Z", "path": "core/src/main/java/hudson/security/HttpSessionContextIntegrationFilter2.java", "diffHunk": "@@ -1,121 +0,0 @@\n-/*\n- * The MIT License\n- * \n- * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n- * \n- * Permission is hereby granted, free of charge, to any person obtaining a copy\n- * of this software and associated documentation files (the \"Software\"), to deal\n- * in the Software without restriction, including without limitation the rights\n- * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n- * copies of the Software, and to permit persons to whom the Software is\n- * furnished to do so, subject to the following conditions:\n- * \n- * The above copyright notice and this permission notice shall be included in\n- * all copies or substantial portions of the Software.\n- * \n- * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n- * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n- * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n- * THE SOFTWARE.\n- */\n-package hudson.security;\n-\n-import hudson.model.User;\n-import jenkins.security.NonSerializableSecurityContext;\n-import jenkins.security.seed.UserSeedProperty;\n-import org.acegisecurity.context.HttpSessionContextIntegrationFilter;\n-import org.acegisecurity.context.SecurityContext;\n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.providers.anonymous.AnonymousAuthenticationToken;\n-\n-import javax.servlet.ServletException;\n-import javax.servlet.ServletRequest;\n-import javax.servlet.ServletResponse;\n-import javax.servlet.FilterChain;\n-import javax.servlet.http.HttpServletRequest;\n-import javax.servlet.http.HttpSession;\n-import java.io.IOException;\n-\n-/**\n- * Erases the {@link SecurityContext} persisted in {@link HttpSession}\n- * if {@link InvalidatableUserDetails#isInvalid()} returns true.\n- *\n- * @see InvalidatableUserDetails", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/HttpSessionContextIntegrationFilter2.java b/core/src/main/java/hudson/security/HttpSessionContextIntegrationFilter2.java\nnew file mode 100644\nindex 0000000000..35baa6659f\n--- /dev/null\n+++ b/core/src/main/java/hudson/security/HttpSessionContextIntegrationFilter2.java\n\n@@ -0,0 +1,104 @@\n+/*\n+ * The MIT License\n+ * \n+ * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n+ * \n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ * \n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ * \n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package hudson.security;\n+\n+import hudson.model.User;\n+import jenkins.security.seed.UserSeedProperty;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.FilterChain;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpSession;\n+import java.io.IOException;\n+import org.springframework.security.authentication.AnonymousAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.context.SecurityContext;\n+import org.springframework.security.web.context.HttpSessionSecurityContextRepository;\n+import org.springframework.security.web.context.SecurityContextPersistenceFilter;\n+import org.springframework.security.web.context.SecurityContextRepository;\n+\n+public class HttpSessionContextIntegrationFilter2 extends SecurityContextPersistenceFilter {\n+    public HttpSessionContextIntegrationFilter2(SecurityContextRepository securityContextRepository) {\n+        super(securityContextRepository);\n+    }\n+\n+    @Override\n+    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {\n+        HttpSession session = ((HttpServletRequest) req).getSession(false);\n+        if (session != null) {\n+            SecurityContext o = (SecurityContext) session.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY);\n+            if (o != null) {\n+                Authentication a = o.getAuthentication();\n+                if (a != null) {\n+                    if (hasInvalidSessionSeed(a, session)) {\n+                        session.setAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY, null);\n+                    }\n+                }\n+            }\n+        }\n+\n+        super.doFilter(req, res, chain);\n+    }\n+\n+    private boolean hasInvalidSessionSeed(Authentication authentication, HttpSession session) {\n+        if (UserSeedProperty.DISABLE_USER_SEED || authentication instanceof AnonymousAuthenticationToken) {\n+            return false;\n+        }\n+\n+        User userFromSession;\n+        try {\n+            userFromSession = User.getById(authentication.getName(), false);\n+        } catch (IllegalStateException ise) {\n+            logger.warn(\"Encountered IllegalStateException trying to get a user. System init may not have completed yet. Invalidating user session.\");\n+            return false;\n+        }\n+        if (userFromSession == null) {\n+            // no requirement for further test as there is no user inside\n+            return false;\n+        }\n+\n+        // for case like recovering backup or other corner cases when the session was not populated by this version\n+        Object userSessionSeedObject = session.getAttribute(UserSeedProperty.USER_SESSION_SEED);\n+        String actualUserSessionSeed;\n+        if (userSessionSeedObject instanceof String) {\n+            actualUserSessionSeed = (String) userSessionSeedObject;\n+        } else {\n+            // the seed must be present AND be a string in the session\n+            return true;\n+        }\n+\n+        UserSeedProperty userSeedProperty = userFromSession.getProperty(UserSeedProperty.class);\n+        if (userSeedProperty == null) {\n+            // if you want to filter out the user seed property, you should consider using the DISABLE_USER_SEED instead\n+            return true;\n+        }\n+        // no need to do a time-constant test here because all the information come from the server\n+        // in other words, there is no way for a user to brute-force those values\n+        boolean validSeed = actualUserSessionSeed.equals(userSeedProperty.getSeed());\n+\n+        // if the authentication is no longer valid we need to remove it from the session\n+        return !validSeed;\n+    }\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNzg1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458027856", "bodyText": "Did not see an easy way to translate this to Spring Security. There is a StandardPasswordEncoder and a MessageDigestPasswordEncoder but these are deprecated and considered insecure. Since this password format was last stored eight years ago, it does not seem worth saving.", "author": "jglick", "createdAt": "2020-07-21T11:31:33Z", "path": "core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java", "diffHunk": "@@ -804,56 +797,7 @@ public Category getCategory() {\n         }\n     }\n \n-    /**\n-     * {@link PasswordEncoder} based on SHA-256 and random salt generation.\n-     *\n-     * <p>\n-     * The salt is prepended to the hashed password and returned. So the encoded password is of the form\n-     * {@code SALT ':' hash(PASSWORD,SALT)}.", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java b/core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java\nindex ae82cb5d13..fcdfcf03cd 100644\n--- a/core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java\n+++ b/core/src/main/java/hudson/security/HudsonPrivateSecurityRealm.java\n\n@@ -797,7 +804,56 @@ public class HudsonPrivateSecurityRealm extends AbstractPasswordBasedSecurityRea\n         }\n     }\n \n-    // TODO can we instead use BCryptPasswordEncoder from Spring Security, which has its own copy of BCrypt so we could drop the special library?\n+    /**\n+     * {@link PasswordEncoder} based on SHA-256 and random salt generation.\n+     *\n+     * <p>\n+     * The salt is prepended to the hashed password and returned. So the encoded password is of the form\n+     * {@code SALT ':' hash(PASSWORD,SALT)}.\n+     *\n+     * <p>\n+     * This abbreviates the need to store the salt separately, which in turn allows us to hide the salt handling\n+     * in this little class. The rest of the Acegi thinks that we are not using salt.\n+     */\n+    /*package*/ static final PasswordEncoder CLASSIC = new PasswordEncoder() {\n+        private final PasswordEncoder passwordEncoder = new ShaPasswordEncoder(256);\n+\n+        public String encodePassword(String rawPass, Object obj) throws DataAccessException {\n+            return hash(rawPass);\n+        }\n+\n+        public boolean isPasswordValid(String encPass, String rawPass, Object obj) throws DataAccessException {\n+            // pull out the sale from the encoded password\n+            int i = encPass.indexOf(':');\n+            if(i<0) return false;\n+            String salt = encPass.substring(0,i);\n+            return encPass.substring(i+1).equals(passwordEncoder.encodePassword(rawPass,salt));\n+        }\n+\n+        /**\n+         * Creates a hashed password by generating a random salt.\n+         */\n+        private String hash(String password) {\n+            String salt = generateSalt();\n+            return salt+':'+passwordEncoder.encodePassword(password,salt);\n+        }\n+\n+        /**\n+         * Generates random salt.\n+         */\n+        private String generateSalt() {\n+            StringBuilder buf = new StringBuilder();\n+            SecureRandom sr = new SecureRandom();\n+            for( int i=0; i<6; i++ ) {// log2(52^6)=34.20... so, this is about 32bit strong.\n+                boolean upper = sr.nextBoolean();\n+                char ch = (char)(sr.nextInt(26) + 'a');\n+                if(upper)   ch=Character.toUpperCase(ch);\n+                buf.append(ch);\n+            }\n+            return buf.toString();\n+        }\n+    };\n+\n     /**\n      * {@link PasswordEncoder} that uses jBCrypt.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyOTg3NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458029875", "bodyText": "Seems to be obsolete: https://github.com/spring-projects/spring-security/blob/56928f61f0f0dbba8dc5c7c6a99746abc39f8230/web/src/main/java/org/springframework/security/web/authentication/rememberme/AbstractRememberMeServices.java#L422-L429", "author": "jglick", "createdAt": "2020-07-21T11:35:54Z", "path": "core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java", "diffHunk": "@@ -303,39 +307,7 @@ private String findRememberMeCookieValue(HttpServletRequest request, HttpServlet\n             return null;\n         }\n     }\n-\n-    @Override\n-    protected Cookie makeValidCookie(String tokenValueBase64, HttpServletRequest request, long maxAge) {\n-        Cookie cookie = super.makeValidCookie(tokenValueBase64, request, maxAge);\n-        secureCookie(cookie, request);\n-        return cookie;\n-    }\n-\n-    @Override \n-    protected Cookie makeCancelCookie(HttpServletRequest request) {\n-        Cookie cookie = super.makeCancelCookie(request);\n-        secureCookie(cookie, request);\n-        return cookie;\n-    }\n-    \n-    /**\n-     * Force always the http-only flag and depending on the request, put also the secure flag.\n-     */\n-    private void secureCookie(Cookie cookie, HttpServletRequest request){\n-        // if we can mark the cookie HTTP only, do so to protect this cookie even in case of XSS vulnerability.\n-        if (SET_HTTP_ONLY!=null) {\n-            try {\n-                SET_HTTP_ONLY.invoke(cookie,true);\n-            } catch (IllegalAccessException | InvocationTargetException e) {\n-                // ignore\n-            }\n-        }\n-\n-        // if the user is running Jenkins over HTTPS, we also want to prevent the cookie from leaking in HTTP.\n-        // whether the login is done over HTTPS or not would be a good enough approximation of whether Jenkins runs in\n-        // HTTPS or not, so use that.\n-        cookie.setSecure(request.isSecure());", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4Nzg1OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r459387859", "bodyText": "IIRC setHttpOnly reflection was due to previous Tomcat version, with the current one supported by Jenkins, it's no longer necessary as we are using Servlet 3.0+.", "author": "Wadeck", "createdAt": "2020-07-23T11:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyOTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java b/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\nindex 9036c3d485..3266dc30b1 100644\n--- a/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\n+++ b/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\n\n@@ -289,26 +182,6 @@ public class TokenBasedRememberMeServices2 extends TokenBasedRememberMeServices\n         return auth;\n     }\n \n-    /**\n-     * @return the decoded base64 of the cookie or {@code null} if the value was not correctly encoded\n-     * /\n-    private @CheckForNull String decodeCookieBase64(@NonNull String base64EncodedValue){\n-        StringBuilder base64EncodedValueBuilder = new StringBuilder(base64EncodedValue);\n-        for (int j = 0; j < base64EncodedValueBuilder.length() % 4; j++) {\n-            base64EncodedValueBuilder.append(\"=\");\n-        }\n-        base64EncodedValue = base64EncodedValueBuilder.toString();\n-\n-        try {\n-            // any charset should be fine but better safe than sorry\n-            byte[] decodedPlainValue = Base64.getDecoder().decode(base64EncodedValue.getBytes(StandardCharsets.UTF_8));\n-            return new String(decodedPlainValue, StandardCharsets.UTF_8);\n-        } catch (IllegalArgumentException e) {\n-            return null;\n-        }\n-    }\n-    */\n-\n     /**\n      * In addition to the expiration requested by the super class, we also check the expiration is not too far in the future.\n      * Especially to detect maliciously crafted cookie.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMTI0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458031245", "bodyText": "Deleting this whole package; now constructing security objects directly in Java code. This means dropping support for the dubious feature of overriding Jenkins\u2019 security architecture by replacing a file in the WAR; you would now have to use supported configuration settings only.", "author": "jglick", "createdAt": "2020-07-21T11:38:45Z", "path": "core/src/main/java/hudson/util/spring/BeanBuilder.java", "diffHunk": "@@ -1,652 +0,0 @@\n-/*\n- * Copyright 2004-2005 the original author or authors.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package hudson.util.spring;\n-\n-import groovy.lang.Binding;\n-import groovy.lang.Closure;\n-import groovy.lang.GString;\n-import groovy.lang.GroovyObject;\n-import groovy.lang.GroovyObjectSupport;\n-import groovy.lang.GroovyShell;\n-import groovy.lang.MetaClass;\n-import groovy.lang.MissingMethodException;\n-import org.apache.commons.lang.ArrayUtils;\n-import org.codehaus.groovy.control.CompilerConfiguration;\n-import org.codehaus.groovy.runtime.DefaultGroovyMethods;\n-import org.codehaus.groovy.runtime.InvokerHelper;\n-import org.springframework.beans.factory.config.BeanDefinition;\n-import org.springframework.beans.factory.config.RuntimeBeanReference;\n-import org.springframework.beans.factory.support.ManagedList;\n-import org.springframework.beans.factory.support.ManagedMap;\n-import org.springframework.context.ApplicationContext;\n-import org.springframework.context.support.StaticApplicationContext;\n-import org.springframework.core.io.Resource;\n-import org.springframework.core.io.support.PathMatchingResourcePatternResolver;\n-import org.springframework.web.context.WebApplicationContext;\n-\n-import java.io.IOException;\n-import java.io.InputStream;\n-import java.io.InputStreamReader;\n-import java.util.Arrays;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-import java.util.Map.Entry;\n-\n-/**\n- * <p>Runtime bean configuration wrapper. Like a Groovy builder, but more of a DSL for\n- * Spring configuration. Allows syntax like:</p>\n- *\n- * <pre>\n- * import org.hibernate.SessionFactory\n- * import org.apache.commons.dbcp.BasicDataSource\n- *\n- * BeanBuilder builder = new BeanBuilder()\n- * builder.beans {\n- *   dataSource(BasicDataSource) {                  // \u2190 invokeMethod\n- *      driverClassName = \"org.hsqldb.jdbcDriver\"\n- *      url = \"jdbc:hsqldb:mem:grailsDB\"\n- *      username = \"sa\"                            // \u2190 setProperty\n- *      password = \"\"\n- *      settings = [mynew:\"setting\"]\n- *  }\n- *  sessionFactory(SessionFactory) {\n- *  \t   dataSource = dataSource                 // \u2190 getProperty for retrieving refs\n- *  }\n- *  myService(MyService) {\n- *      nestedBean = { AnotherBean bean-&gt;          // \u2190 setProperty with closure for nested bean\n- *      \t\tdataSource = dataSource\n- *      }\n- *  }\n- * }\n- * </pre>\n- * <p>\n- *   You can also use the Spring IO API to load resources containing beans defined as a Groovy\n- *   script using either the constructors or the loadBeans(Resource[] resources) method\n- * </p>\n- *\n- * @author Graeme Rocher\n- * @since 0.4\n- *\n- */\n-public class BeanBuilder extends GroovyObjectSupport {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/util/spring/BeanBuilder.java b/core/src/main/java/hudson/util/spring/BeanBuilder.java\nnew file mode 100644\nindex 0000000000..33c6e1d98e\n--- /dev/null\n+++ b/core/src/main/java/hudson/util/spring/BeanBuilder.java\n\n@@ -0,0 +1,652 @@\n+/*\n+ * Copyright 2004-2005 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package hudson.util.spring;\n+\n+import groovy.lang.Binding;\n+import groovy.lang.Closure;\n+import groovy.lang.GString;\n+import groovy.lang.GroovyObject;\n+import groovy.lang.GroovyObjectSupport;\n+import groovy.lang.GroovyShell;\n+import groovy.lang.MetaClass;\n+import groovy.lang.MissingMethodException;\n+import org.apache.commons.lang.ArrayUtils;\n+import org.codehaus.groovy.control.CompilerConfiguration;\n+import org.codehaus.groovy.runtime.DefaultGroovyMethods;\n+import org.codehaus.groovy.runtime.InvokerHelper;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.config.RuntimeBeanReference;\n+import org.springframework.beans.factory.support.ManagedList;\n+import org.springframework.beans.factory.support.ManagedMap;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.context.support.StaticApplicationContext;\n+import org.springframework.core.io.Resource;\n+import org.springframework.core.io.support.PathMatchingResourcePatternResolver;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+/**\n+ * <p>Runtime bean configuration wrapper. Like a Groovy builder, but more of a DSL for\n+ * Spring configuration. Allows syntax like:</p>\n+ *\n+ * <pre>\n+ * import org.hibernate.SessionFactory\n+ * import org.apache.commons.dbcp.BasicDataSource\n+ *\n+ * BeanBuilder builder = new BeanBuilder()\n+ * builder.beans {\n+ *   dataSource(BasicDataSource) {                  // \u2190 invokeMethod\n+ *      driverClassName = \"org.hsqldb.jdbcDriver\"\n+ *      url = \"jdbc:hsqldb:mem:grailsDB\"\n+ *      username = \"sa\"                            // \u2190 setProperty\n+ *      password = \"\"\n+ *      settings = [mynew:\"setting\"]\n+ *  }\n+ *  sessionFactory(SessionFactory) {\n+ *  \t   dataSource = dataSource                 // \u2190 getProperty for retrieving refs\n+ *  }\n+ *  myService(MyService) {\n+ *      nestedBean = { AnotherBean bean-&gt;          // \u2190 setProperty with closure for nested bean\n+ *      \t\tdataSource = dataSource\n+ *      }\n+ *  }\n+ * }\n+ * </pre>\n+ * <p>\n+ *   You can also use the Spring IO API to load resources containing beans defined as a Groovy\n+ *   script using either the constructors or the loadBeans(Resource[] resources) method\n+ * </p>\n+ *\n+ * @author Graeme Rocher\n+ * @since 0.4\n+ *\n+ */\n+public class BeanBuilder extends GroovyObjectSupport {\n+    private static final String ANONYMOUS_BEAN = \"bean\";\n+    private RuntimeSpringConfiguration springConfig = new DefaultRuntimeSpringConfiguration();\n+    private BeanConfiguration currentBeanConfig;\n+    private Map<String,DeferredProperty> deferredProperties = new HashMap<>();\n+    private ApplicationContext parentCtx;\n+    private Map binding = new HashMap();\n+    private ClassLoader classLoader = null;\n+\n+\n+    public BeanBuilder() {\n+\t\tsuper();\n+\t}\n+\n+    public BeanBuilder(ClassLoader classLoader) {\n+\t\tsuper();\n+\t\tthis.classLoader = classLoader;\n+\t}\n+\n+\tpublic BeanBuilder(ApplicationContext parent) {\n+\t\tsuper();\n+\t\tthis.parentCtx = parent;\n+\t\tthis.springConfig = new DefaultRuntimeSpringConfiguration(parent);\n+\t}\n+\n+\tpublic BeanBuilder(ApplicationContext parent,ClassLoader classLoader) {\n+\t\tsuper();\n+\t\tthis.parentCtx = parent;\n+\t\tthis.springConfig = new DefaultRuntimeSpringConfiguration(parent);\n+\t\tthis.classLoader = classLoader;\n+\t}\n+\n+    /**\n+     * Parses the bean definition groovy script.\n+     */\n+    public void parse(InputStream script) {\n+        parse(script,new Binding());\n+    }\n+\n+    /**\n+     * Parses the bean definition groovy script by first exporting the given {@link Binding}. \n+     */\n+    public void parse(InputStream script, Binding binding) {\n+        if (script==null)\n+            throw new IllegalArgumentException(\"No script is provided\");\n+        setBinding(binding);\n+        CompilerConfiguration cc = new CompilerConfiguration();\n+        cc.setScriptBaseClass(ClosureScript.class.getName());\n+        GroovyShell shell = new GroovyShell(classLoader,binding,cc);\n+\n+        ClosureScript s = (ClosureScript)shell.parse(new InputStreamReader(script));\n+        s.setDelegate(this);\n+        s.run();\n+    }\n+\n+    /**\n+\t * Retrieves the parent ApplicationContext\n+\t * @return The parent ApplicationContext\n+\t */\n+\tpublic ApplicationContext getParentCtx() {\n+\t\treturn parentCtx;\n+\t}\n+\n+\t/**\n+\t * Retrieves the RuntimeSpringConfiguration instance used by the BeanBuilder\n+\t * @return The RuntimeSpringConfiguration instance\n+\t */\n+\tpublic RuntimeSpringConfiguration getSpringConfig() {\n+\t\treturn springConfig;\n+\t}\n+\n+\t/**\n+\t * Retrieves a BeanDefinition for the given name\n+\t * @param name The bean definition\n+\t * @return The BeanDefinition instance\n+\t */\n+\tpublic BeanDefinition getBeanDefinition(String name) {\n+\t\tif(!getSpringConfig().containsBean(name))\n+\t\t\treturn null;\n+\t\treturn getSpringConfig().getBeanConfig(name).getBeanDefinition();\n+\t}\n+\n+    /**\n+     * Retrieves all BeanDefinitions for this BeanBuilder\n+     *\n+     * @return A map of BeanDefinition instances with the bean id as the key\n+     */\n+    public Map<String,BeanDefinition> getBeanDefinitions() {\n+\n+        Map<String,BeanDefinition> beanDefinitions = new HashMap<>();\n+        for (String beanName : getSpringConfig().getBeanNames()) {\n+            BeanDefinition bd = getSpringConfig()\n+                    .getBeanConfig(beanName)\n+                    .getBeanDefinition();\n+            beanDefinitions.put(beanName, bd);\n+        }\n+        return beanDefinitions;\n+    }\n+\n+    /**\n+\t * Sets the runtime Spring configuration instance to use. This is not necessary to set\n+\t * and is configured to default value if not, but is useful for integrating with other\n+\t * spring configuration mechanisms @see org.codehaus.groovy.grails.commons.spring.GrailsRuntimeConfigurator\n+\t *\n+\t * @param springConfig The spring config\n+\t */\n+\tpublic void setSpringConfig(RuntimeSpringConfiguration springConfig) {\n+\t\tthis.springConfig = springConfig;\n+\t}\n+\n+\n+\n+\t/**\n+\t * This class is used to defer the adding of a property to a bean definition until later\n+\t * This is for a case where you assign a property to a list that may not contain bean references at\n+\t * that point of assignment, but may later hence it would need to be managed\n+\t *\n+\t * @author Graeme Rocher\n+\t */\n+\tprivate static class DeferredProperty {\n+\t\tprivate BeanConfiguration config;\n+\t\tprivate String name;\n+\t\tprivate Object value;\n+\n+\t\tDeferredProperty(BeanConfiguration config, String name, Object value) {\n+\t\t\tthis.config = config;\n+\t\t\tthis.name = name;\n+\t\t\tthis.value = value;\n+\t\t}\n+\n+\t\tpublic void setInBeanConfig() {\n+\t\t\tthis.config.addProperty(name, value);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * A RuntimeBeanReference that takes care of adding new properties to runtime references\n+\t *\n+\t * @author Graeme Rocher\n+\t * @since 0.4\n+\t *\n+\t */\n+\tprivate class ConfigurableRuntimeBeanReference extends RuntimeBeanReference implements GroovyObject {\n+\n+\t\tprivate MetaClass metaClass;\n+\t\tprivate BeanConfiguration beanConfig;\n+\n+\t\tpublic ConfigurableRuntimeBeanReference(String beanName, BeanConfiguration beanConfig) {\n+\t\t\tthis(beanName, beanConfig, false);\n+\t\t}\n+\n+\t\tpublic ConfigurableRuntimeBeanReference(String beanName, BeanConfiguration beanConfig, boolean toParent) {\n+\t\t\tsuper(beanName, toParent);\n+\t\t\tthis.beanConfig = beanConfig;\n+\t\t\tif(beanConfig == null)\n+\t\t\t\tthrow new IllegalArgumentException(\"Argument [beanConfig] cannot be null\");\n+\t\t\tthis.metaClass = InvokerHelper.getMetaClass(this);\n+\t\t}\n+\n+\t\tpublic MetaClass getMetaClass() {\n+\t\t\treturn this.metaClass;\n+\t\t}\n+\n+\t\tpublic Object getProperty(String property) {\n+\t\t\tif(property.equals(\"beanName\"))\n+\t\t\t\treturn getBeanName();\n+\t\t\telse if(property.equals(\"source\"))\n+\t\t\t\treturn getSource();\n+\t\t\telse if(this.beanConfig != null) {\n+\t\t\t\treturn new WrappedPropertyValue(property,beanConfig.getPropertyValue(property));\n+\t\t\t}\n+\t\t\telse\n+\t\t\t\treturn this.metaClass.getProperty(this, property);\n+\t\t}\n+\n+\n+\n+        /**\n+\t\t * Wraps a BeanConfiguration property an ensures that any RuntimeReference additions to it are\n+\t\t * deferred for resolution later\n+\t\t *\n+\t\t * @author Graeme Rocher\n+\t\t * @since 0.4\n+\t\t *\n+\t\t */\n+\t\tprivate class WrappedPropertyValue extends GroovyObjectSupport {\n+\t\t\tprivate Object propertyValue;\n+\t\t\tprivate String propertyName;\n+\t\t\tpublic WrappedPropertyValue(String propertyName, Object propertyValue) {\n+\t\t\t\tthis.propertyValue = propertyValue;\n+\t\t\t\tthis.propertyName = propertyName;\n+\t\t\t}\n+\n+\t\t\tpublic void leftShift(Object value) {\n+\t\t\t\tInvokerHelper.invokeMethod(propertyValue, \"leftShift\", value);\n+\t\t\t\tif(value instanceof RuntimeBeanReference) {\n+\t\t\t\t\tdeferredProperties.put(beanConfig.getName(), new DeferredProperty(beanConfig, propertyName, propertyValue));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tpublic Object invokeMethod(String name, Object args) {\n+\t\t\treturn this.metaClass.invokeMethod(this, name, args);\n+\t\t}\n+\n+\t\tpublic void setMetaClass(MetaClass metaClass) {\n+\t\t\tthis.metaClass = metaClass;\n+\t\t}\n+\n+\t\tpublic void setProperty(String property, Object newValue) {\n+            if(!addToDeferred(beanConfig,property, newValue)) {\n+                beanConfig.setPropertyValue(property, newValue);\n+            }\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Loads a single Resource into the bean builder\n+\t *\n+\t * @param resource The resource to load\n+\t * @throws IOException When an error occurs\n+\t */\n+\tpublic void loadBeans(Resource resource) throws IOException {\n+\t\tloadBeans(new Resource[]{resource});\n+\t}\n+\n+\t/**\n+\t * Loads a set of given beans\n+\t * @param resources The resources to load\n+\t * @throws IOException\n+\t */\n+\tpublic void loadBeans(Resource[] resources) throws IOException {\n+\t\tClosure beans = new Closure(this){\n+\t\t\t@Override\n+\t\t\tpublic Object call(Object... args) {\n+\t\t\t\treturn beans((Closure)args[0]);\n+\t\t\t}\n+\t\t};\n+\t\tBinding b = new Binding();\n+\t\tb.setVariable(\"beans\", beans);\n+\n+\t\tGroovyShell shell = classLoader != null ? new GroovyShell(classLoader,b) : new GroovyShell(b);\n+        for (Resource resource : resources) {\n+            shell.evaluate(new InputStreamReader(resource.getInputStream()));\n+        }\n+\t}\n+\n+    public void registerBeans(StaticApplicationContext ctx) {\n+        finalizeDeferredProperties();\n+        springConfig.registerBeansWithContext(ctx);\n+    }\n+\n+    public RuntimeBeanReference ref(String refName) {\n+        return ref(refName,false);\n+    }\n+\n+    public RuntimeBeanReference parentRef(String refName) {\n+        return ref(refName,true);\n+    }\n+\n+    public RuntimeBeanReference ref(String refName, boolean parentRef) {\n+        return new RuntimeBeanReference(refName, parentRef);\n+    }\n+\n+    /**\n+\t * This method is invoked by Groovy when a method that's not defined in Java is invoked.\n+     * We use that as a syntax for bean definition. \n+\t */\n+\tpublic Object methodMissing(String name, Object arg) {\n+        Object[] args = (Object[])arg;\n+\n+        if(args.length == 0)\n+\t\t\tthrow new MissingMethodException(name,getClass(),args);\n+\n+\t\tif(args[0] instanceof Closure) {\n+            // abstract bean definition\n+            return invokeBeanDefiningMethod(name, args);\n+\t\t}\n+\t\telse if(args[0] instanceof Class || args[0] instanceof RuntimeBeanReference || args[0] instanceof Map) {\n+\t\t\treturn invokeBeanDefiningMethod(name, args);\n+\t\t}\n+\t\telse if (args.length > 1 && args[args.length -1] instanceof Closure) {\n+\t\t\treturn invokeBeanDefiningMethod(name, args);\n+\t\t}\n+        WebApplicationContext ctx = springConfig.getUnrefreshedApplicationContext();\n+        MetaClass mc = DefaultGroovyMethods.getMetaClass(ctx);\n+        if(!mc.respondsTo(ctx, name, args).isEmpty()){\n+            return mc.invokeMethod(ctx,name, args);\n+        }\n+        return this;\n+\t}\n+\n+    public WebApplicationContext createApplicationContext() {\n+        finalizeDeferredProperties();\n+        return springConfig.getApplicationContext();\n+    }\n+\n+    private void finalizeDeferredProperties() {\n+        for (DeferredProperty dp : deferredProperties.values()) {\n+            if (dp.value instanceof List) {\n+                dp.value = manageListIfNecessary((List)dp.value);\n+            } else if (dp.value instanceof Map) {\n+                dp.value = manageMapIfNecessary((Map)dp.value);\n+            }\n+            dp.setInBeanConfig();\n+        }\n+\t\tdeferredProperties.clear();\n+\t}\n+\n+\tprivate boolean addToDeferred(BeanConfiguration beanConfig,String property, Object newValue) {\n+\t\tif(newValue instanceof List) {\n+\t\t\tdeferredProperties.put(currentBeanConfig.getName()+property,new DeferredProperty(currentBeanConfig, property, newValue));\n+\t\t\treturn true;\n+\t\t}\n+\t\telse if(newValue instanceof Map) {\n+\t\t\tdeferredProperties.put(currentBeanConfig.getName()+property,new DeferredProperty(currentBeanConfig, property, newValue));\n+\t\t\treturn true;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\t/**\n+\t * This method is called when a bean definition node is called\n+\t *\n+\t * @param name The name of the bean to define\n+\t * @param args The arguments to the bean. The first argument is the class name, the last argument is sometimes a closure. All\n+\t * the arguments in between are constructor arguments\n+\t * @return The bean configuration instance\n+\t */\n+\tprivate BeanConfiguration invokeBeanDefiningMethod(String name, Object[] args) {\n+        BeanConfiguration old = currentBeanConfig;\n+        try {\n+            if(args[0] instanceof Class) {\n+                Class beanClass = args[0] instanceof Class ? (Class)args[0] : args[0].getClass();\n+\n+                if(args.length >= 1) {\n+                    if(args[args.length-1] instanceof Closure) {\n+                        if(args.length-1 != 1) {\n+                            Object[] constructorArgs = ArrayUtils.subarray(args, 1, args.length-1);\n+                            filterGStringReferences(constructorArgs);\n+                            if(name.equals(ANONYMOUS_BEAN))\n+                                currentBeanConfig = springConfig.createSingletonBean(beanClass,Arrays.asList(constructorArgs));\n+                            else\n+                                currentBeanConfig = springConfig.addSingletonBean(name, beanClass, Arrays.asList(constructorArgs));\n+                        }\n+                        else {\n+                            if(name.equals(ANONYMOUS_BEAN))\n+                                currentBeanConfig = springConfig.createSingletonBean(beanClass);\n+                            else\n+                                currentBeanConfig = springConfig.addSingletonBean(name, beanClass);\n+                        }\n+                    }\n+                    else  {\n+                        Object[] constructorArgs = ArrayUtils.subarray(args, 1, args.length);\n+                        filterGStringReferences(constructorArgs);\n+                        if(name.equals(ANONYMOUS_BEAN))\n+                            currentBeanConfig = springConfig.createSingletonBean(beanClass,Arrays.asList(constructorArgs));\n+                        else\n+                            currentBeanConfig = springConfig.addSingletonBean(name, beanClass, Arrays.asList(constructorArgs));\n+                    }\n+\n+                }\n+            }\n+            else if(args[0] instanceof RuntimeBeanReference) {\n+                currentBeanConfig = springConfig.addSingletonBean(name);\n+                currentBeanConfig.setFactoryBean(((RuntimeBeanReference)args[0]).getBeanName());\n+            }\n+            else if(args[0] instanceof Map) {\n+                currentBeanConfig = springConfig.addSingletonBean(name);\n+                Map.Entry factoryBeanEntry = (Map.Entry)((Map)args[0]).entrySet().iterator().next();\n+                currentBeanConfig.setFactoryBean(factoryBeanEntry.getKey().toString());\n+                currentBeanConfig.setFactoryMethod(factoryBeanEntry.getValue().toString());\n+            }\n+            else if(args[0] instanceof Closure) {\n+                currentBeanConfig = springConfig.addAbstractBean(name);\n+            }\n+            else {\n+                Object[] constructorArgs;\n+                if(args[args.length-1] instanceof Closure) {\n+                    constructorArgs= ArrayUtils.subarray(args, 0, args.length-1);\n+                }\n+                else {\n+                    constructorArgs= ArrayUtils.subarray(args, 0, args.length);\n+                }\n+                filterGStringReferences(constructorArgs);\n+                currentBeanConfig = new DefaultBeanConfiguration(name, null, Arrays.asList(constructorArgs));\n+                springConfig.addBeanConfiguration(name,currentBeanConfig);\n+            }\n+            if(args[args.length-1] instanceof Closure) {\n+                Closure callable = (Closure)args[args.length-1];\n+                callable.setDelegate(this);\n+                callable.setResolveStrategy(Closure.DELEGATE_FIRST);\n+                callable.call(new Object[]{currentBeanConfig});\n+\n+            }\n+\n+            return currentBeanConfig;\n+        } finally {\n+            currentBeanConfig = old;\n+        }\n+    }\n+\n+    private void filterGStringReferences(Object[] constructorArgs) {\n+        for (int i = 0; i < constructorArgs.length; i++) {\n+            Object constructorArg = constructorArgs[i];\n+            if(constructorArg instanceof GString) constructorArgs[i] = constructorArg.toString();\n+        }\n+    }\n+\n+    /**\n+\t * When an methods argument is only a closure it is a set of bean definitions\n+\t *\n+\t * @param callable The closure argument\n+\t */\n+\tpublic BeanBuilder beans(Closure callable) {\n+\t\tcallable.setDelegate(this);\n+  //      callable.setResolveStrategy(Closure.DELEGATE_FIRST);\n+        callable.call();\n+\t\tfinalizeDeferredProperties();\n+\n+        return this;\n+    }\n+\n+    /**\n+\t * This method overrides property setting in the scope of the BeanBuilder to set\n+\t * properties on the current BeanConfiguration\n+\t */\n+\t@Override\n+\tpublic void setProperty(String name, Object value) {\n+\t\tif(currentBeanConfig != null) {\n+\t\t\tif(value instanceof GString)value = value.toString();\n+\t\t\tif(addToDeferred(currentBeanConfig, name, value)) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t\telse if(value instanceof Closure) {\n+\t\t\t\tBeanConfiguration current = currentBeanConfig;\n+\t\t\t\ttry {\n+\t\t\t\t\tClosure callable = (Closure)value;\n+\n+\t\t\t\t\tClass parameterType = callable.getParameterTypes()[0];\n+\t\t\t\t\tif(parameterType.equals(Object.class)) {\n+\t\t\t\t\t\tcurrentBeanConfig = springConfig.createSingletonBean(\"\");\n+\t\t\t\t\t\tcallable.call(new Object[]{currentBeanConfig});\n+\t\t\t\t\t}\n+\t\t\t\t\telse {\n+\t\t\t\t\t\tcurrentBeanConfig = springConfig.createSingletonBean(parameterType);\n+\t\t\t\t\t\tcallable.call(null);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tvalue = currentBeanConfig.getBeanDefinition();\n+\t\t\t\t}\n+\t\t\t\tfinally {\n+\t\t\t\t\tcurrentBeanConfig = current;\n+\t\t\t\t}\n+\t\t\t}\n+            currentBeanConfig.addProperty(name, value);\n+\t\t} else {\n+            binding.put(name,value);\n+        }\n+\t}\n+\n+\t/**\n+\t * Checks whether there are any runtime refs inside a Map and converts\n+\t * it to a ManagedMap if necessary\n+\t *\n+\t * @param value The current map\n+\t * @return A ManagedMap or a normal map\n+\t */\n+\tprivate Object manageMapIfNecessary(Map<Object, Object> value) {\n+\t\tboolean containsRuntimeRefs = false;\n+        for (Entry<Object, Object> e : value.entrySet()) {\n+            Object v = e.getValue();\n+            if (v instanceof RuntimeBeanReference) {\n+                containsRuntimeRefs = true;\n+            }\n+            if (v instanceof BeanConfiguration) {\n+                BeanConfiguration c = (BeanConfiguration) v;\n+                e.setValue(c.getBeanDefinition());\n+                containsRuntimeRefs = true;\n+            }\n+        }\n+\t\tif(containsRuntimeRefs) {\n+//\t\t\treturn new ManagedMap(map);\n+            ManagedMap m = new ManagedMap();\n+            m.putAll(value);\n+            return m;\n+        }\n+\t\treturn value;\n+\t}\n+\n+\t/**\n+\t * Checks whether there are any runtime refs inside the list and\n+\t * converts it to a ManagedList if necessary\n+\t *\n+\t * @param value The object that represents the list\n+\t * @return Either a new list or a managed one\n+\t */\n+\tprivate Object manageListIfNecessary(List<Object> value) {\n+\t\tboolean containsRuntimeRefs = false;\n+\t\tfor (ListIterator<Object> i = value.listIterator(); i.hasNext();) {\n+\t\t\tObject e = i.next();\n+\t\t\tif(e instanceof RuntimeBeanReference) {\n+\t\t\t\tcontainsRuntimeRefs = true;\n+\t\t\t}\n+            if (e instanceof BeanConfiguration) {\n+                BeanConfiguration c = (BeanConfiguration) e;\n+                i.set(c.getBeanDefinition());\n+                containsRuntimeRefs = true;\n+            }\n+        }\n+\t\tif(containsRuntimeRefs) {\n+\t\t\tList tmp = new ManagedList();\n+\t\t\ttmp.addAll(value);\n+\t\t\tvalue = tmp;\n+\t\t}\n+\t\treturn value;\n+\t}\n+\n+\t/**\n+\t * This method overrides property retrieval in the scope of the BeanBuilder to either:\n+\t *\n+\t * a) Retrieve a variable from the bean builder's binding if it exits\n+\t * b) Retrieve a RuntimeBeanReference for a specific bean if it exists\n+\t * c) Otherwise just delegate to super.getProperty which will resolve properties from the BeanBuilder itself\n+\t */\n+\t@Override\n+\tpublic Object getProperty(String name) {\n+\t\tif(binding.containsKey(name)) {\n+\t\t\treturn binding.get(name);\n+\t\t}\n+\t\telse {\n+\t\t\tif(springConfig.containsBean(name)) {\n+\t\t\t\tBeanConfiguration beanConfig = springConfig.getBeanConfig(name);\n+\t\t\t\tif(beanConfig != null) {\n+\t\t\t\t\treturn new ConfigurableRuntimeBeanReference(name, springConfig.getBeanConfig(name) ,false);\n+\t\t\t\t}\n+\t\t\t\telse\n+\t\t\t\t\treturn new RuntimeBeanReference(name,false);\n+\t\t\t}\n+\t\t\t// this is to deal with the case where the property setter is the last\n+\t\t\t// statement in a closure (hence the return value)\n+\t\t\telse if(currentBeanConfig != null) {\n+\t\t\t\tif(currentBeanConfig.hasProperty(name))\n+\t\t\t\t\treturn currentBeanConfig.getPropertyValue(name);\n+\t\t\t\telse {\n+\t\t\t\t\tDeferredProperty dp = deferredProperties.get(currentBeanConfig.getName()+name);\n+\t\t\t\t\tif(dp!=null) {\n+\t\t\t\t\t\treturn dp.value;\n+\t\t\t\t\t}\n+\t\t\t\t\telse {\n+\t\t\t\t\t\treturn super.getProperty(name);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\telse {\n+\t\t\t\treturn super.getProperty(name);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Sets the binding (the variables available in the scope of the BeanBuilder)\n+\t * @param b The Binding instance\n+\t */\n+\tpublic void setBinding(Binding b) {\n+\t\tthis.binding = b.getVariables();\n+\t}\n+\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMjUwMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458032501", "bodyText": "Git trying to be too clever. Deleting long-deprecated typo NotSerilizableSecurityContext (not used by plugins); and adding a fa\u00e7ade for AccessDeniedException.", "author": "jglick", "createdAt": "2020-07-21T11:41:28Z", "path": "core/src/main/java/org/acegisecurity/AccessDeniedException.java", "diffHunk": "@@ -22,21 +22,22 @@\n  * THE SOFTWARE.\n  */\n \n-package hudson.security;\n+package org.acegisecurity;\n \n-import jenkins.security.NonSerializableSecurityContext;\n-import org.acegisecurity.Authentication;\n+import hudson.security.AccessDeniedException2;\n \n /**\n- * @deprecated use {@link NonSerializableSecurityContext} instead\n+ * @deprecated use {@link AccessDeniedException2}\n  */\n @Deprecated\n-public class NotSerilizableSecurityContext extends NonSerializableSecurityContext {\n+public class AccessDeniedException extends org.springframework.security.access.AccessDeniedException {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/AccessDeniedException.java b/core/src/main/java/org/acegisecurity/AccessDeniedException.java\nindex ecc85e47a9..ac5d250ac9 100644\n--- a/core/src/main/java/org/acegisecurity/AccessDeniedException.java\n+++ b/core/src/main/java/org/acegisecurity/AccessDeniedException.java\n\n@@ -24,13 +24,11 @@\n \n package org.acegisecurity;\n \n-import hudson.security.AccessDeniedException2;\n-\n /**\n- * @deprecated use {@link AccessDeniedException2}\n+ * @deprecated use {@link org.springframework.security.access.AccessDeniedException}\n  */\n @Deprecated\n-public class AccessDeniedException extends org.springframework.security.access.AccessDeniedException {\n+public class AccessDeniedException extends AcegiSecurityException {\n \n     public AccessDeniedException(String msg) {\n         super(msg);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMzAxNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458033014", "bodyText": "Might wind up deleting this, not sure if it could even potentially still be used by plugins.", "author": "jglick", "createdAt": "2020-07-21T11:42:31Z", "path": "core/src/main/java/org/acegisecurity/AuthenticationManager.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity;\n+\n+/**\n+ * @deprecated TODO replacement\n+ */\n+@Deprecated\n+public interface AuthenticationManager {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/AuthenticationManager.java b/core/src/main/java/org/acegisecurity/AuthenticationManager.java\nindex c281745882..bdbdf574cb 100644\n--- a/core/src/main/java/org/acegisecurity/AuthenticationManager.java\n+++ b/core/src/main/java/org/acegisecurity/AuthenticationManager.java\n\n@@ -25,11 +25,31 @@\n package org.acegisecurity;\n \n /**\n- * @deprecated TODO replacement\n+ * @deprecated use {@link org.springframework.security.authentication.AuthenticationManager}\n  */\n @Deprecated\n public interface AuthenticationManager {\n \n     Authentication authenticate(Authentication authentication) throws AuthenticationException;\n \n+    static AuthenticationManager fromSpring(org.springframework.security.authentication.AuthenticationManager am) {\n+        return authentication -> {\n+            try {\n+                return Authentication.fromSpring(am.authenticate(authentication.toSpring()));\n+            } catch (org.springframework.security.core.AuthenticationException x) {\n+                throw AuthenticationException.fromSpring(x);\n+            }\n+        };\n+    }\n+\n+    default org.springframework.security.authentication.AuthenticationManager toSpring() {\n+        return authentication -> {\n+            try {\n+                return authenticate(Authentication.fromSpring(authentication)).toSpring();\n+            } catch (AuthenticationException x) {\n+                throw x.toSpring();\n+            }\n+        };\n+    }\n+\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMzQ2Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458033463", "bodyText": "Reimplementing these from scratch. Only used from SidAcl.", "author": "jglick", "createdAt": "2020-07-21T11:43:21Z", "path": "core/src/main/java/org/acegisecurity/acls/sid/PrincipalSid.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.acls.sid;\n+\n+import java.util.Objects;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.userdetails.UserDetails;\n+\n+public class PrincipalSid implements Sid {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NDIxNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481254215", "bodyText": "and cloudbees/bluesteel -> TeamSecurity.java (which is not using SidACL in that class but underlying more it it is).  (not sure you saw that or not)", "author": "jtnord", "createdAt": "2020-09-01T16:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMzQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI2MjAzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r481262030", "bodyText": "Ought to be compatible AFAICT.", "author": "jglick", "createdAt": "2020-09-01T16:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMzQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f77173c4959e7db82541826fe34225310f8b613d", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/acls/sid/PrincipalSid.java b/core/src/main/java/org/acegisecurity/acls/sid/PrincipalSid.java\nindex 6af2d9a51c..9f620b1364 100644\n--- a/core/src/main/java/org/acegisecurity/acls/sid/PrincipalSid.java\n+++ b/core/src/main/java/org/acegisecurity/acls/sid/PrincipalSid.java\n\n@@ -36,10 +36,21 @@ public class PrincipalSid implements Sid {\n         this.principal = principal;\n     }\n \n+    /**\n+     * @since TODO\n+     */\n     public PrincipalSid(Authentication a) {\n         Object p = a.getPrincipal();\n         this.principal = p instanceof UserDetails ? ((UserDetails) p).getUsername() : p.toString();\n     }\n+\n+    /**\n+     * @deprecated use {@link #PrincipalSid(Authentication)}\n+     */\n+    @Deprecated\n+    public PrincipalSid(org.acegisecurity.Authentication a) {\n+        this(a.toSpring());\n+    }\n     \n     public String getPrincipal() {\n         return principal;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzNDA4MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458034080", "bodyText": "Seems to have been unused, and I do not want to depend on Spring Security modules for LDAP here; belongs in the ldap plugin only.", "author": "jglick", "createdAt": "2020-07-21T11:44:34Z", "path": "core/src/main/java/org/acegisecurity/providers/ldap/authenticator/BindAuthenticator2.java", "diffHunk": "@@ -1,62 +0,0 @@\n-/*\n- * The MIT License\n- * \n- * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n- * \n- * Permission is hereby granted, free of charge, to any person obtaining a copy\n- * of this software and associated documentation files (the \"Software\"), to deal\n- * in the Software without restriction, including without limitation the rights\n- * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n- * copies of the Software, and to permit persons to whom the Software is\n- * furnished to do so, subject to the following conditions:\n- * \n- * The above copyright notice and this permission notice shall be included in\n- * all copies or substantial portions of the Software.\n- * \n- * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n- * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n- * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n- * THE SOFTWARE.\n- */\n-package org.acegisecurity.providers.ldap.authenticator;\n-\n-import org.acegisecurity.ldap.InitialDirContextFactory;\n-import org.acegisecurity.userdetails.ldap.LdapUserDetails;\n-\n-import java.util.logging.Logger;\n-import java.util.logging.Level;\n-\n-/**\n- * {@link BindAuthenticator} with improved diagnostics.\n- * \n- * @author Kohsuke Kawaguchi\n- */\n-public class BindAuthenticator2 extends BindAuthenticator {", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzOTk4NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r462339985", "bodyText": "Correction: was used by the ldap plugin, and should have been there all along (see 9b4cd99 & 32cba8f). Correcting in jenkinsci/ldap-plugin@a5267e6.", "author": "jglick", "createdAt": "2020-07-29T14:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzNDA4MA=="}], "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/providers/ldap/authenticator/BindAuthenticator2.java b/core/src/main/java/org/acegisecurity/providers/ldap/authenticator/BindAuthenticator2.java\nnew file mode 100644\nindex 0000000000..49370935bc\n--- /dev/null\n+++ b/core/src/main/java/org/acegisecurity/providers/ldap/authenticator/BindAuthenticator2.java\n\n@@ -0,0 +1,62 @@\n+/*\n+ * The MIT License\n+ * \n+ * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n+ * \n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ * \n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ * \n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.acegisecurity.providers.ldap.authenticator;\n+\n+import org.acegisecurity.ldap.InitialDirContextFactory;\n+import org.acegisecurity.userdetails.ldap.LdapUserDetails;\n+\n+import java.util.logging.Logger;\n+import java.util.logging.Level;\n+\n+/**\n+ * {@link BindAuthenticator} with improved diagnostics.\n+ * \n+ * @author Kohsuke Kawaguchi\n+ */\n+public class BindAuthenticator2 extends BindAuthenticator {\n+    /**\n+     * If we ever had a successful authentication, \n+     */\n+    private boolean hadSuccessfulAuthentication;\n+\n+    public BindAuthenticator2(InitialDirContextFactory initialDirContextFactory) {\n+        super(initialDirContextFactory);\n+    }\n+\n+    @Override\n+    public LdapUserDetails authenticate(String username, String password) {\n+        LdapUserDetails user = super.authenticate(username, password);\n+        hadSuccessfulAuthentication = true;\n+        return user;\n+    }\n+\n+    @Override\n+    void handleBindException(String userDn, String username, Throwable cause) {\n+        LOGGER.log(hadSuccessfulAuthentication? Level.FINE : Level.WARNING,\n+            \"Failed to bind to LDAP: userDn\"+userDn+\"  username=\"+username,cause);\n+        super.handleBindException(userDn, username, cause);\n+    }\n+\n+    private static final Logger LOGGER = Logger.getLogger(BindAuthenticator2.class.getName());\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzNDMyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458034321", "bodyText": "Might just get deleted, TBD.", "author": "jglick", "createdAt": "2020-07-21T11:44:58Z", "path": "core/src/main/java/org/acegisecurity/userdetails/UserDetailsService.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright 2020 CloudBees, Inc.\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package org.acegisecurity.userdetails;\n+\n+/**\n+ * @deprecated TODO replacement\n+ */\n+@Deprecated\n+public interface UserDetailsService extends org.springframework.security.core.userdetails.UserDetailsService {}", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/userdetails/UserDetailsService.java b/core/src/main/java/org/acegisecurity/userdetails/UserDetailsService.java\nindex d81c03f1d4..69691301e3 100644\n--- a/core/src/main/java/org/acegisecurity/userdetails/UserDetailsService.java\n+++ b/core/src/main/java/org/acegisecurity/userdetails/UserDetailsService.java\n\n@@ -24,8 +24,36 @@\n \n package org.acegisecurity.userdetails;\n \n+import org.springframework.dao.DataAccessException;\n+\n /**\n- * @deprecated TODO replacement\n+ * @deprecated use {@link org.springframework.security.core.userdetails.UserDetailsService}\n  */\n @Deprecated\n-public interface UserDetailsService extends org.springframework.security.core.userdetails.UserDetailsService {}\n+public interface UserDetailsService {\n+\n+    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException;\n+\n+    static UserDetailsService fromSpring(org.springframework.security.core.userdetails.UserDetailsService uds) {\n+        return username -> {\n+            try {\n+                return UserDetails.fromSpring(uds.loadUserByUsername(username));\n+            } catch (org.springframework.security.core.userdetails.UsernameNotFoundException x) {\n+                throw UsernameNotFoundException.fromSpring(x);\n+            }\n+        };\n+    }\n+\n+    default org.springframework.security.core.userdetails.UserDetailsService toSpring() {\n+        return username -> {\n+            try {\n+                return loadUserByUsername(username).toSpring();\n+            } catch (UsernameNotFoundException x) {\n+                throw x.toSpring();\n+            } catch (DataAccessException x) {\n+                throw x.toSpring();\n+            }\n+        };\n+    }\n+\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzNTU0Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r458035547", "bodyText": "Overaggressive rename detection. Deleted AbstractPasswordBasedSecurityRealm.groovy, created AuthenticationException.java fa\u00e7ade.", "author": "jglick", "createdAt": "2020-07-21T11:47:25Z", "path": "core/src/main/java/org/acegisecurity/AuthenticationException.java", "diffHunk": "@@ -21,29 +21,21 @@\n  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n  * THE SOFTWARE.\n  */\n-/*\n-    Configure Hudson's own user database as the authentication realm.\n-*/\n-import org.acegisecurity.providers.ProviderManager\n-import org.acegisecurity.providers.anonymous.AnonymousAuthenticationProvider\n-import org.acegisecurity.providers.rememberme.RememberMeAuthenticationProvider\n-import jenkins.model.Jenkins\n \n-authenticationManager(ProviderManager) {\n-    providers = [\n-        // this does all the hard work.\n-        // injected by the parsing code\n-        authenticator,\n+package org.acegisecurity;", "originalCommit": "cfd98319f38ea8f9e2560351a068a1e5905b8208", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/AuthenticationException.java b/core/src/main/java/org/acegisecurity/AuthenticationException.java\nindex 77c33b68a8..565762d213 100644\n--- a/core/src/main/java/org/acegisecurity/AuthenticationException.java\n+++ b/core/src/main/java/org/acegisecurity/AuthenticationException.java\n\n@@ -25,17 +25,46 @@\n package org.acegisecurity;\n \n /**\n- * @deprecated TODO replacement\n+ * @deprecated use {@link org.springframework.security.core.AuthenticationException}\n  */\n @Deprecated\n-public class AuthenticationException extends org.springframework.security.core.AuthenticationException {\n+public abstract class AuthenticationException extends AcegiSecurityException {\n+\n+    private final Object extraInformation;\n \n     public AuthenticationException(String msg) {\n         super(msg);\n+        extraInformation = null;\n+    }\n+\n+    public AuthenticationException(String msg, Object extraInformation) {\n+        super(msg);\n+        this.extraInformation = extraInformation;\n     }\n \n     public AuthenticationException(String msg, Throwable t) {\n         super(msg, t);\n+        extraInformation = null;\n+    }\n+\n+    public Authentication getAuthentication() {\n+        return null; // TODO in the real thing, there is a setter, but who calls it?\n+    }\n+\n+    public Object getExtraInformation() {\n+        return extraInformation;\n+    }\n+\n+    public org.springframework.security.core.AuthenticationException toSpring() {\n+        return new org.springframework.security.core.AuthenticationException(toString(), this) {};\n+    }\n+\n+    public static AuthenticationException fromSpring(org.springframework.security.core.AuthenticationException x) {\n+        if (x instanceof org.springframework.security.authentication.BadCredentialsException) {\n+            return BadCredentialsException.fromSpring((org.springframework.security.authentication.BadCredentialsException) x);\n+        } else {\n+            return new AuthenticationException(x.toString(), x) {};\n+        }\n     }\n \n }\n"}}, {"oid": "085f525a1431b007a625d305a63624ded7aeb9bf", "url": "https://github.com/jenkinsci/jenkins/commit/085f525a1431b007a625d305a63624ded7aeb9bf", "message": "Comments", "committedDate": "2020-07-21T11:48:13Z", "type": "commit"}, {"oid": "26060aa91ee43a5422a017f9a4d6d1339bb5cba6", "url": "https://github.com/jenkinsci/jenkins/commit/26060aa91ee43a5422a017f9a4d6d1339bb5cba6", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-21T11:51:08Z", "type": "commit"}, {"oid": "c6f0e12012dc9b3dfd81eb7cdc7c8f07b0e703aa", "url": "https://github.com/jenkinsci/jenkins/commit/c6f0e12012dc9b3dfd81eb7cdc7c8f07b0e703aa", "message": "Merge branch 'support-log-formatter' into spring-5303", "committedDate": "2020-07-21T15:03:06Z", "type": "commit"}, {"oid": "c3f9efd5e2c79adbeeebe474b2ab034fc69c37f1", "url": "https://github.com/jenkinsci/jenkins/commit/c3f9efd5e2c79adbeeebe474b2ab034fc69c37f1", "message": "Better logging for ChainedServletFilter", "committedDate": "2020-07-21T15:25:28Z", "type": "commit"}, {"oid": "a8a661e8fa3bee524fe6e9f016eee84c21d711e6", "url": "https://github.com/jenkinsci/jenkins/commit/a8a661e8fa3bee524fe6e9f016eee84c21d711e6", "message": "Can now log in; crumbs are broken though", "committedDate": "2020-07-21T15:36:51Z", "type": "commit"}, {"oid": "76b0885af1b65f3c6bf7c9f6dce386039db1bc1b", "url": "https://github.com/jenkinsci/jenkins/commit/76b0885af1b65f3c6bf7c9f6dce386039db1bc1b", "message": "Searched more extensively for references to Acegi Security", "committedDate": "2020-07-21T16:03:17Z", "type": "commit"}, {"oid": "12598a7e4a2ab44a932825db59447f7c26fe31ba", "url": "https://github.com/jenkinsci/jenkins/commit/12598a7e4a2ab44a932825db59447f7c26fe31ba", "message": "HttpSessionContextIntegrationFilter2 was critical after all; just took me a while to find that HttpSessionContextIntegrationFilter is now SecurityContextPersistenceFilter", "committedDate": "2020-07-21T19:27:09Z", "type": "commit"}, {"oid": "a985a501bcc381d20f7972abaea2672235cf15c4", "url": "https://github.com/jenkinsci/jenkins/commit/a985a501bcc381d20f7972abaea2672235cf15c4", "message": "Comment", "committedDate": "2020-07-21T19:27:24Z", "type": "commit"}, {"oid": "4201baa4be828cdcc3bfbbc1c068ef29b6d8549c", "url": "https://github.com/jenkinsci/jenkins/commit/4201baa4be828cdcc3bfbbc1c068ef29b6d8549c", "message": "Fixing UserSeedProperty so that login works at last", "committedDate": "2020-07-21T19:47:47Z", "type": "commit"}, {"oid": "a36f41007e82c5b6a16a8e7c33284079e47fabad", "url": "https://github.com/jenkinsci/jenkins/commit/a36f41007e82c5b6a16a8e7c33284079e47fabad", "message": "Binary compatibility for QueueItemAuthenticator", "committedDate": "2020-07-21T20:14:19Z", "type": "commit"}, {"oid": "ae31edd5a9d6c24d17665f4391ef4f7a4f84ada9", "url": "https://github.com/jenkinsci/jenkins/commit/ae31edd5a9d6c24d17665f4391ef4f7a4f84ada9", "message": "Fixing up QueueItemAuthenticator Javadoc", "committedDate": "2020-07-21T20:19:06Z", "type": "commit"}, {"oid": "64341787683cde9f3e069057d6f185f715d77fa7", "url": "https://github.com/jenkinsci/jenkins/commit/64341787683cde9f3e069057d6f185f715d77fa7", "message": "Binary compatibility for SecurityRealm.AUTHENTICATED_AUTHORITY", "committedDate": "2020-07-21T20:37:03Z", "type": "commit"}, {"oid": "da40e4adfb7cff67a834a3bc7c0e84fe0819e48b", "url": "https://github.com/jenkinsci/jenkins/commit/da40e4adfb7cff67a834a3bc7c0e84fe0819e48b", "message": "Binary compatibility for key methods of SecurityRealm and AbstractPasswordBasedSecurityRealm", "committedDate": "2020-07-21T21:26:15Z", "type": "commit"}, {"oid": "1ed7887281196f186d63bdaafaef4b17909b9405", "url": "https://github.com/jenkinsci/jenkins/commit/1ed7887281196f186d63bdaafaef4b17909b9405", "message": "Even trying to compile at this stage is a waste of CI resources", "committedDate": "2020-07-22T13:07:24Z", "type": "commit"}, {"oid": "3f163d8c99ddab2b371d82f1a8af5412894c2d34", "url": "https://github.com/jenkinsci/jenkins/commit/3f163d8c99ddab2b371d82f1a8af5412894c2d34", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-22T16:26:57Z", "type": "commit"}, {"oid": "abb439d0ae972c79c037be2466d056758f9dba8a", "url": "https://github.com/jenkinsci/jenkins/commit/abb439d0ae972c79c037be2466d056758f9dba8a", "message": "Binary compatibility for User.impersonate and Jenkins.ANONYMOUS", "committedDate": "2020-07-22T20:10:39Z", "type": "commit"}, {"oid": "100ca911e549eba9bbd52dcaa8c257300ea962aa", "url": "https://github.com/jenkinsci/jenkins/commit/100ca911e549eba9bbd52dcaa8c257300ea962aa", "message": "Binary compatibility for ACL.{SYSTEM,impersonate,as}", "committedDate": "2020-07-22T20:38:49Z", "type": "commit"}, {"oid": "58364c23526b5fdf2c87ad950e63dd3d26749e8c", "url": "https://github.com/jenkinsci/jenkins/commit/58364c23526b5fdf2c87ad950e63dd3d26749e8c", "message": "Tests compile", "committedDate": "2020-07-22T20:42:46Z", "type": "commit"}, {"oid": "29e1b959ad57b20b69e22d50a97dcc8596a2b1ed", "url": "https://github.com/jenkinsci/jenkins/commit/29e1b959ad57b20b69e22d50a97dcc8596a2b1ed", "message": "Giving up on subtyping relationships even for exceptions", "committedDate": "2020-07-22T21:25:27Z", "type": "commit"}, {"oid": "0ad56da5d3f8adc2886bbb80f550421d1bed576c", "url": "https://github.com/jenkinsci/jenkins/commit/0ad56da5d3f8adc2886bbb80f550421d1bed576c", "message": "Implementing SecurityContext.to/fromSpring allows some functional tests to pass", "committedDate": "2020-07-22T21:32:46Z", "type": "commit"}, {"oid": "a4475c4044788e6b2383b6f559785924f82ab8e7", "url": "https://github.com/jenkinsci/jenkins/commit/a4475c4044788e6b2383b6f559785924f82ab8e7", "message": "Do not want spring-jcl as it clashes with the commons-logging we bundle", "committedDate": "2020-07-22T21:35:16Z", "type": "commit"}, {"oid": "6dad321f809b3c303b96788483b502a5c95c9668", "url": "https://github.com/jenkinsci/jenkins/commit/6dad321f809b3c303b96788483b502a5c95c9668", "message": "Some progress on tests using Authentication", "committedDate": "2020-07-22T22:57:32Z", "type": "commit"}, {"oid": "62e73df29a17b0afe2aff9ad897b98efa50f143d", "url": "https://github.com/jenkinsci/jenkins/commit/62e73df29a17b0afe2aff9ad897b98efa50f143d", "message": "org.acegisecurity.userdetails.User must be defined for JenkinsRule.DummySecurityRealm to work", "committedDate": "2020-07-22T23:06:23Z", "type": "commit"}, {"oid": "998d6732027393a3dbf869bd5acb841cacd1b9da", "url": "https://github.com/jenkinsci/jenkins/commit/998d6732027393a3dbf869bd5acb841cacd1b9da", "message": "Some tests are passing; may as well start trying CI", "committedDate": "2020-07-22T23:08:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzNDU0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r459134545", "bodyText": "There is no replacement for AcegiSecurityException. AFAIK the purpose of this class is to nicely handle 403s, so this should be good enough.", "author": "jglick", "createdAt": "2020-07-22T23:12:04Z", "path": "core/src/main/java/hudson/ExpressionFactory2.java", "diffHunk": "@@ -72,7 +72,7 @@ public Object evaluate(JellyContext context) {\n                 CURRENT_CONTEXT.set(context);\n                 JexlContext jexlContext = new JellyJexlContext( context );\n                 return expression.evaluate(jexlContext);\n-            } catch (AcegiSecurityException e) {\n+            } catch (AccessDeniedException e) {", "originalCommit": "998d6732027393a3dbf869bd5acb841cacd1b9da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/ExpressionFactory2.java b/core/src/main/java/hudson/ExpressionFactory2.java\nindex e372218249..c8704fccfd 100644\n--- a/core/src/main/java/hudson/ExpressionFactory2.java\n+++ b/core/src/main/java/hudson/ExpressionFactory2.java\n\n@@ -72,7 +72,7 @@ final class ExpressionFactory2 implements ExpressionFactory {\n                 CURRENT_CONTEXT.set(context);\n                 JexlContext jexlContext = new JellyJexlContext( context );\n                 return expression.evaluate(jexlContext);\n-            } catch (AccessDeniedException e) {\n+            } catch (AcegiSecurityException e) {\n                 // let the security exception pass through\n                 throw e;\n             } catch (Exception e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4Mzg1Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r459383853", "bodyText": "IIRC this class is no longer maintained / outdated as it's preferable for plugins to implement commands directly.", "author": "Wadeck", "createdAt": "2020-07-23T11:32:41Z", "path": "core/src/main/java/hudson/cli/declarative/CLIRegisterer.java", "diffHunk": "@@ -202,6 +200,7 @@ public int main(List<String> args, Locale locale, InputStream stdin, PrintStream\n \n                             CmdLineParser parser = bindMethod(binders);\n                             try {\n+                                // TODO this could probably use ACL.as; why is it calling SecurityContext.setAuthentication rather than SecurityContextHolder.setContext?", "originalCommit": "998d6732027393a3dbf869bd5acb841cacd1b9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxMjk1OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r459412959", "bodyText": "It is not currently deprecated, but yes I would recommend CLICommand in all cases.", "author": "jglick", "createdAt": "2020-07-23T12:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4Mzg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/cli/declarative/CLIRegisterer.java b/core/src/main/java/hudson/cli/declarative/CLIRegisterer.java\nindex e6b1047045..1f5adddc51 100644\n--- a/core/src/main/java/hudson/cli/declarative/CLIRegisterer.java\n+++ b/core/src/main/java/hudson/cli/declarative/CLIRegisterer.java\n\n@@ -207,7 +207,7 @@ public class CLIRegisterer extends ExtensionFinder {\n                                     // fill up all the binders\n                                     parser.parseArgument(args);\n \n-                                    Authentication auth = getTransportAuthentication();\n+                                    Authentication auth = getTransportAuthentication2();\n                                     sc.setAuthentication(auth); // run the CLI with the right credential\n                                     jenkins.checkPermission(Jenkins.READ);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5MjMyOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r459392329", "bodyText": "I don't understand your question about the signature. You have the variable just above, derived from the expiryTime and username.\nIt was verified by our current version in TokenBasedRememberMeServices2.java#L256-L266 but in recent version of Spring Security, they have corrected the flaw with the equality and so it's verified (correctly) in TokenBasedRememberMeServices.java#L95.", "author": "Wadeck", "createdAt": "2020-07-23T11:51:07Z", "path": "core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java", "diffHunk": "@@ -142,23 +140,29 @@ public void loginSuccess(HttpServletRequest request, HttpServletResponse respons\n \t\t}\n \n \t\tAssert.notNull(successfulAuthentication.getPrincipal());\n-\t\tAssert.notNull(successfulAuthentication.getCredentials());\n \t\tAssert.isInstanceOf(UserDetails.class, successfulAuthentication.getPrincipal());\n \n-\t\tlong expiryTime = System.currentTimeMillis() + TimeUnit.SECONDS.toMillis(tokenValiditySeconds);\n+\t\tlong expiryTime = System.currentTimeMillis() + TimeUnit.SECONDS.toMillis(getTokenValiditySeconds());\n \t\tString username = ((UserDetails) successfulAuthentication.getPrincipal()).getUsername();\n \n-\t\tString signatureValue = makeTokenSignature(expiryTime, (UserDetails)successfulAuthentication.getPrincipal());\n+\t\tString signatureValue = makeTokenSignature(expiryTime, username, ((UserDetails) successfulAuthentication.getPrincipal()).getPassword());\n \t\tString tokenValue = username + \":\" + expiryTime + \":\" + signatureValue;\n \t\tString tokenValueBase64 = Base64.getEncoder().encodeToString(tokenValue.getBytes());\n-\t\tresponse.addCookie(makeValidCookie(tokenValueBase64, request, tokenValiditySeconds));\n+\t\tint tokenLifetime = calculateLoginLifetime(request, successfulAuthentication);\n+        /* TODO unclear what the Spring Security equivalent to this is:\n+\t\tresponse.addCookie(makeValidCookie(tokenValueBase64, request, getTokenValiditySeconds()));\n+        // something like this, but where is the token signature?", "originalCommit": "998d6732027393a3dbf869bd5acb841cacd1b9da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java b/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\nindex 07d2481a45..3266dc30b1 100644\n--- a/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\n+++ b/core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java\n\n@@ -139,22 +133,18 @@ public class TokenBasedRememberMeServices2 extends TokenBasedRememberMeServices\n \t\t\treturn;\n \t\t}\n \n-\t\tAssert.notNull(successfulAuthentication.getPrincipal());\n-\t\tAssert.isInstanceOf(UserDetails.class, successfulAuthentication.getPrincipal());\n+        // TODO is it really still necessary to reimplement all of the below, or could we simply override rememberMeRequested?\n+\n+        Objects.requireNonNull(successfulAuthentication.getPrincipal());\n+        UserDetails.class.cast(successfulAuthentication.getPrincipal());\n \n \t\tlong expiryTime = System.currentTimeMillis() + TimeUnit.SECONDS.toMillis(getTokenValiditySeconds());\n \t\tString username = ((UserDetails) successfulAuthentication.getPrincipal()).getUsername();\n \n \t\tString signatureValue = makeTokenSignature(expiryTime, username, ((UserDetails) successfulAuthentication.getPrincipal()).getPassword());\n-\t\tString tokenValue = username + \":\" + expiryTime + \":\" + signatureValue;\n-\t\tString tokenValueBase64 = Base64.getEncoder().encodeToString(tokenValue.getBytes());\n \t\tint tokenLifetime = calculateLoginLifetime(request, successfulAuthentication);\n-        /* TODO unclear what the Spring Security equivalent to this is:\n-\t\tresponse.addCookie(makeValidCookie(tokenValueBase64, request, getTokenValiditySeconds()));\n-        // something like this, but where is the token signature?\n \t\tsetCookie(new String[] { username, Long.toString(expiryTime), signatureValue },\n \t\t\t\ttokenLifetime, request, response);\n-        */\n \n \t\tif (logger.isDebugEnabled()) {\n \t\t\tlogger.debug(\"Added remember-me cookie for user '\" + username + \"', expiry: '\" + new Date(expiryTime)\n"}}, {"oid": "aa73f2014ed4ce06bb8472c80a19fffebc1df812", "url": "https://github.com/jenkinsci/jenkins/commit/aa73f2014ed4ce06bb8472c80a19fffebc1df812", "message": "@Wadeck helped me with TokenBasedRememberMeServices2", "committedDate": "2020-07-23T13:52:16Z", "type": "commit"}, {"oid": "d052fb80bbce47ec1bbf52b371b61358d853f889", "url": "https://github.com/jenkinsci/jenkins/commit/d052fb80bbce47ec1bbf52b371b61358d853f889", "message": "TokenBasedRememberMeServices2Test.rememberMeAutoLoginFailure was asserting some debug message removed in Spring Security", "committedDate": "2020-07-23T14:02:09Z", "type": "commit"}, {"oid": "1f14f3c6d5d2de54929cfbe60db436d1888f1d31", "url": "https://github.com/jenkinsci/jenkins/commit/1f14f3c6d5d2de54929cfbe60db436d1888f1d31", "message": "Tracked down why WebClient.withBasicApiToken was not working in tests", "committedDate": "2020-07-23T14:31:21Z", "type": "commit"}, {"oid": "044c42c7e4b7f493ba944e111324b6b64e06b4b5", "url": "https://github.com/jenkinsci/jenkins/commit/044c42c7e4b7f493ba944e111324b6b64e06b4b5", "message": "Binary compatibility for CLICommand.{getTransportAuthentication,setTransportAuth}", "committedDate": "2020-07-23T15:38:57Z", "type": "commit"}, {"oid": "0609eafc80f6d5302cc03d762d1a868a8b6bc934", "url": "https://github.com/jenkinsci/jenkins/commit/0609eafc80f6d5302cc03d762d1a868a8b6bc934", "message": "ClassFilterImplSanityTest", "committedDate": "2020-07-23T15:42:03Z", "type": "commit"}, {"oid": "5354321bdab43dc8c8b37e30424409c6a2704201", "url": "https://github.com/jenkinsci/jenkins/commit/5354321bdab43dc8c8b37e30424409c6a2704201", "message": "Rewrote Authentication.to/fromSpring, fixing two tests in QueueTest", "committedDate": "2020-07-23T17:30:10Z", "type": "commit"}, {"oid": "091d0cac37056f063fc030254ea1395fd73f57a0", "url": "https://github.com/jenkinsci/jenkins/commit/091d0cac37056f063fc030254ea1395fd73f57a0", "message": "Binary compatibility for Jenkins.getAuthentication", "committedDate": "2020-07-23T17:36:17Z", "type": "commit"}, {"oid": "11ec923d2a5fd53f431393e9039a1c3c3a86a361", "url": "https://github.com/jenkinsci/jenkins/commit/11ec923d2a5fd53f431393e9039a1c3c3a86a361", "message": "Some more sanity checks around ACL.isAnonymous", "committedDate": "2020-07-23T17:39:30Z", "type": "commit"}, {"oid": "4bdec8341b0d75ff80c980eea70a590df70d6dc7", "url": "https://github.com/jenkinsci/jenkins/commit/4bdec8341b0d75ff80c980eea70a590df70d6dc7", "message": "Binary compatibility for remaining ACL methods", "committedDate": "2020-07-23T18:06:24Z", "type": "commit"}, {"oid": "d8e6bea179b1de568ec516d0caab32ac7a0c21d9", "url": "https://github.com/jenkinsci/jenkins/commit/d8e6bea179b1de568ec516d0caab32ac7a0c21d9", "message": "Special round-trip handling for ACL.SYSTEM for compatibility", "committedDate": "2020-07-23T18:17:19Z", "type": "commit"}, {"oid": "84cb57b2f38b11d2e7ab3dd51865fd695e1da0e6", "url": "https://github.com/jenkinsci/jenkins/commit/84cb57b2f38b11d2e7ab3dd51865fd695e1da0e6", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-23T20:00:07Z", "type": "commit"}, {"oid": "cdf2e4611cf5753b8e5bd23573381f2a37808642", "url": "https://github.com/jenkinsci/jenkins/commit/cdf2e4611cf5753b8e5bd23573381f2a37808642", "message": "JobTest.readPermission failed because its @LocalData used a pre-jBCrypt password hash", "committedDate": "2020-07-23T21:29:44Z", "type": "commit"}, {"oid": "c95b4761ebad82570f68d70b82740d170e221ba4", "url": "https://github.com/jenkinsci/jenkins/commit/c95b4761ebad82570f68d70b82740d170e221ba4", "message": "Binary compatibility for User.getUserDetailsForImpersonation", "committedDate": "2020-07-23T21:54:29Z", "type": "commit"}, {"oid": "3910ebf3df32118506ee8c9a4532d8739370b58b", "url": "https://github.com/jenkinsci/jenkins/commit/3910ebf3df32118506ee8c9a4532d8739370b58b", "message": "Binary compatibility for SecurityListener", "committedDate": "2020-07-23T22:02:54Z", "type": "commit"}, {"oid": "8a5bdf20ada28bdc55158d8d29e090a2504b91dd", "url": "https://github.com/jenkinsci/jenkins/commit/8a5bdf20ada28bdc55158d8d29e090a2504b91dd", "message": "ExtendedReadPermissionTest failed because its @LocalData used a pre-jBCrypt password hash", "committedDate": "2020-07-23T22:22:21Z", "type": "commit"}, {"oid": "7ca54e4b1257a5211d2d43e4c04b77b10826d6c6", "url": "https://github.com/jenkinsci/jenkins/commit/7ca54e4b1257a5211d2d43e4c04b77b10826d6c6", "message": "NPE in QueueItemAuthenticator", "committedDate": "2020-07-23T22:28:59Z", "type": "commit"}, {"oid": "091bc2317ce35fa0c8080f06139c351aecfcfc8c", "url": "https://github.com/jenkinsci/jenkins/commit/091bc2317ce35fa0c8080f06139c351aecfcfc8c", "message": "LastGrantedAuthoritiesPropertyTest was reliant on the sort order of authorities", "committedDate": "2020-07-23T22:32:57Z", "type": "commit"}, {"oid": "43e8d297cb96f72ceaaf476672919fbdb7539c17", "url": "https://github.com/jenkinsci/jenkins/commit/43e8d297cb96f72ceaaf476672919fbdb7539c17", "message": "StopBuildsCommandTest", "committedDate": "2020-07-23T22:34:57Z", "type": "commit"}, {"oid": "2aec3cb908a89c33e6ac5c1050e82e504db81c21", "url": "https://github.com/jenkinsci/jenkins/commit/2aec3cb908a89c33e6ac5c1050e82e504db81c21", "message": "Javadoc updates in TokenBasedRememberMeServices2", "committedDate": "2020-07-23T22:46:18Z", "type": "commit"}, {"oid": "4c7b6b3652dbb8f26eda1b027d564d2cfa81413a", "url": "https://github.com/jenkinsci/jenkins/commit/4c7b6b3652dbb8f26eda1b027d564d2cfa81413a", "message": "Accidentally removed code which added sessionSeed", "committedDate": "2020-07-23T23:09:20Z", "type": "commit"}, {"oid": "3a2d8570f3200a61bda4fd994b3676d5da711919", "url": "https://github.com/jenkinsci/jenkins/commit/3a2d8570f3200a61bda4fd994b3676d5da711919", "message": "makeTokenSignature can be called when a User is not yet in memory; need to force creation (authentication was already successful at this point)", "committedDate": "2020-07-23T23:09:55Z", "type": "commit"}, {"oid": "736bca448921411a76f574bbc76515da526cc730", "url": "https://github.com/jenkinsci/jenkins/commit/736bca448921411a76f574bbc76515da526cc730", "message": "Also accidentally deleted some code necessary to handle disableRememberMe (SECURITY-996)", "committedDate": "2020-07-23T23:22:29Z", "type": "commit"}, {"oid": "990233849f205bb7c30aeb9f33e57218335e0a10", "url": "https://github.com/jenkinsci/jenkins/commit/990233849f205bb7c30aeb9f33e57218335e0a10", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-23T23:23:24Z", "type": "commit"}, {"oid": "061e10642e412b96906d7adce11af0857ffdf991", "url": "https://github.com/jenkinsci/jenkins/commit/061e10642e412b96906d7adce11af0857ffdf991", "message": "Rename refactoring missed a couple of overrides", "committedDate": "2020-07-24T11:26:43Z", "type": "commit"}, {"oid": "06d4b16f30f789add4da2fff50448b37d8991c67", "url": "https://github.com/jenkinsci/jenkins/commit/06d4b16f30f789add4da2fff50448b37d8991c67", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-24T11:29:18Z", "type": "commit"}, {"oid": "5adba3eb57657361afec80199b427685cba1703f", "url": "https://github.com/jenkinsci/jenkins/commit/5adba3eb57657361afec80199b427685cba1703f", "message": "Binary compatibility for AccessControlled.hasPermission", "committedDate": "2020-07-24T13:52:15Z", "type": "commit"}, {"oid": "a5d60e41d15d93b47f351fa41737df93cfe0e436", "url": "https://github.com/jenkinsci/jenkins/commit/a5d60e41d15d93b47f351fa41737df93cfe0e436", "message": "Added back DataAccessResourceFailureException & DataRetrievalFailureException", "committedDate": "2020-07-24T13:58:25Z", "type": "commit"}, {"oid": "7fdb8db1103ae1bbfe3f7d5fed00484edda048b1", "url": "https://github.com/jenkinsci/jenkins/commit/7fdb8db1103ae1bbfe3f7d5fed00484edda048b1", "message": "Binary compatibility for Queue.Item.authenticate and affiliated methods", "committedDate": "2020-07-24T14:14:15Z", "type": "commit"}, {"oid": "54c65edd3acf0c845a83d0a11b305e729186bd47", "url": "https://github.com/jenkinsci/jenkins/commit/54c65edd3acf0c845a83d0a11b305e729186bd47", "message": "RememberMeServicesProxy is apparently unused by plugins, do not need to care about compatibility", "committedDate": "2020-07-24T14:55:18Z", "type": "commit"}, {"oid": "3094ae57734aef598c6f4401627153f4ea086869", "url": "https://github.com/jenkinsci/jenkins/commit/3094ae57734aef598c6f4401627153f4ea086869", "message": "Javadoc fixes", "committedDate": "2020-07-24T15:17:31Z", "type": "commit"}, {"oid": "30b0079f79f91e5271ccac1d019101e8f9faee3a", "url": "https://github.com/jenkinsci/jenkins/commit/30b0079f79f91e5271ccac1d019101e8f9faee3a", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-24T15:18:46Z", "type": "commit"}, {"oid": "b1fcbc699bdf2c8c34a1938eadb9f278d1c98636", "url": "https://github.com/jenkinsci/jenkins/commit/b1fcbc699bdf2c8c34a1938eadb9f278d1c98636", "message": "Compilation error in test", "committedDate": "2020-07-24T15:21:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEyNTA2MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r460125061", "bodyText": "Code wasn't changed accordingly?", "author": "daniel-beck", "createdAt": "2020-07-24T15:27:25Z", "path": "core/src/main/java/hudson/security/AccessControlled.java", "diffHunk": "@@ -58,7 +58,7 @@ default void checkAnyPermission(@NonNull Permission... permission) throws Access\n     }\n \n     /**\n-     * Convenient short-cut for {@code getACL().hasPermission(permission)}\n+     * Convenient short-cut for {@code getACL().hasPermission2(permission)}", "originalCommit": "b1fcbc699bdf2c8c34a1938eadb9f278d1c98636", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzNDAwNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r460134007", "bodyText": "Oops, this was wrong, will revert.", "author": "jglick", "createdAt": "2020-07-24T15:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEyNTA2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0a125a16902c33e93092184e3c4b1e1d6919410", "chunk": "diff --git a/core/src/main/java/hudson/security/AccessControlled.java b/core/src/main/java/hudson/security/AccessControlled.java\nindex a774ebc86e..694744996b 100644\n--- a/core/src/main/java/hudson/security/AccessControlled.java\n+++ b/core/src/main/java/hudson/security/AccessControlled.java\n\n@@ -58,7 +58,7 @@ public interface AccessControlled {\n     }\n \n     /**\n-     * Convenient short-cut for {@code getACL().hasPermission2(permission)}\n+     * Convenient short-cut for {@code getACL().hasPermission(permission)}\n      */\n     default boolean hasPermission(@NonNull Permission permission) {\n         return getACL().hasPermission(permission);\n"}}, {"oid": "6d9622834bd0ebd5a53e605234579b9614e63be6", "url": "https://github.com/jenkinsci/jenkins/commit/6d9622834bd0ebd5a53e605234579b9614e63be6", "message": "Incorrect code sample", "committedDate": "2020-07-24T15:43:04Z", "type": "commit"}, {"oid": "f3e6c04f46962b4150d614d836b0c43f9cd0a802", "url": "https://github.com/jenkinsci/jenkins/commit/f3e6c04f46962b4150d614d836b0c43f9cd0a802", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-28T12:11:26Z", "type": "commit"}, {"oid": "f69be2ca1dffb94ed6e3bcc52009f53cc08a8d2a", "url": "https://github.com/jenkinsci/jenkins/commit/f69be2ca1dffb94ed6e3bcc52009f53cc08a8d2a", "message": "SecurityRealm.createFilter more legible with blocks", "committedDate": "2020-07-28T12:19:23Z", "type": "commit"}, {"oid": "ecf3acc6d8a938852803928bbf9f2ec5c8e0813d", "url": "https://github.com/jenkinsci/jenkins/commit/ecf3acc6d8a938852803928bbf9f2ec5c8e0813d", "message": "Minor cleanups in TokenBasedRememberMeServices2", "committedDate": "2020-07-28T15:27:47Z", "type": "commit"}, {"oid": "c3827334e5a4746a6cdc8b5ec17c721f3f61c719", "url": "https://github.com/jenkinsci/jenkins/commit/c3827334e5a4746a6cdc8b5ec17c721f3f61c719", "message": "toSpring/fromSpring pattern for selected exception types", "committedDate": "2020-07-28T16:16:21Z", "type": "commit"}, {"oid": "4d7f00d0a3bfc097cdc4a76fa24b60a3a40346b5", "url": "https://github.com/jenkinsci/jenkins/commit/4d7f00d0a3bfc097cdc4a76fa24b60a3a40346b5", "message": "Apparently org.acegisecurity.Authentication.getAuthorities() could return null", "committedDate": "2020-07-28T17:00:58Z", "type": "commit"}, {"oid": "abf82513c16a51adae3221fca68611e2dfb1da19", "url": "https://github.com/jenkinsci/jenkins/commit/abf82513c16a51adae3221fca68611e2dfb1da19", "message": "NPE from SecurityContext", "committedDate": "2020-07-28T17:07:41Z", "type": "commit"}, {"oid": "7c5ce69fd314d3c89c20de5745153c73a57b909f", "url": "https://github.com/jenkinsci/jenkins/commit/7c5ce69fd314d3c89c20de5745153c73a57b909f", "message": "Added back AbstractAuthenticationToken (supertype e.g. of GithubAuthenticationToken)", "committedDate": "2020-07-28T17:16:45Z", "type": "commit"}, {"oid": "0ae2aaabeed1d78e713ee2a81db90a4787d53862", "url": "https://github.com/jenkinsci/jenkins/commit/0ae2aaabeed1d78e713ee2a81db90a4787d53862", "message": "Binary compatibility for SecurityComponents", "committedDate": "2020-07-28T17:18:21Z", "type": "commit"}, {"oid": "bd53bea1c3692c1bad0033d274417f18d244e044", "url": "https://github.com/jenkinsci/jenkins/commit/bd53bea1c3692c1bad0033d274417f18d244e044", "message": "Merge branch 'master' of github.com:jenkinsci/jenkins into spring-5303", "committedDate": "2020-07-28T17:18:25Z", "type": "commit"}, {"oid": "034ecff3d513502f3640273a5474fed8d2520f64", "url": "https://github.com/jenkinsci/jenkins/commit/034ecff3d513502f3640273a5474fed8d2520f64", "message": "Test compilation error", "committedDate": "2020-07-28T17:20:16Z", "type": "commit"}, {"oid": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "url": "https://github.com/jenkinsci/jenkins/commit/b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "message": "Run japicmp", "committedDate": "2020-07-28T21:49:57Z", "type": "commit"}, {"oid": "f32ed4f22ee98ae63d7d8c3a606d9a7093d4d137", "url": "https://github.com/jenkinsci/jenkins/commit/f32ed4f22ee98ae63d7d8c3a606d9a7093d4d137", "message": "Binary compatibility for Items.all and .allItems", "committedDate": "2020-07-28T22:14:42Z", "type": "commit"}, {"oid": "232194d956c0d648d8a2c9f3127525ab0b157a3a", "url": "https://github.com/jenkinsci/jenkins/commit/232194d956c0d648d8a2c9f3127525ab0b157a3a", "message": "Binary compatibility for User.get", "committedDate": "2020-07-28T22:17:09Z", "type": "commit"}, {"oid": "530455c2d29ecd0f155e51b2ff8e3aed3de7e1e2", "url": "https://github.com/jenkinsci/jenkins/commit/530455c2d29ecd0f155e51b2ff8e3aed3de7e1e2", "message": "Binary compatibility for ACL.isAnonymous", "committedDate": "2020-07-28T22:23:09Z", "type": "commit"}, {"oid": "545e347bf34c72b01dd9cf58e76474f2a81ca1d6", "url": "https://github.com/jenkinsci/jenkins/commit/545e347bf34c72b01dd9cf58e76474f2a81ca1d6", "message": "Binary compatibility for ACLContext.getPreviousContext", "committedDate": "2020-07-28T22:24:52Z", "type": "commit"}, {"oid": "e27ec10f258d6c855d6d3cb31827f025cbc59961", "url": "https://github.com/jenkinsci/jenkins/commit/e27ec10f258d6c855d6d3cb31827f025cbc59961", "message": "Adding @Restricted(NoExternalUse.class) to a couple of classes which never seem to have been used from plugins", "committedDate": "2020-07-28T22:37:22Z", "type": "commit"}, {"oid": "0a326509c32a68ee3f4656b74136ae6b626e2045", "url": "https://github.com/jenkinsci/jenkins/commit/0a326509c32a68ee3f4656b74136ae6b626e2045", "message": "Binary compatibility for SecurityRealm.getPostLogOutUrl", "committedDate": "2020-07-28T22:39:38Z", "type": "commit"}, {"oid": "c9662fb0d8e319e1efb9cc74c995d780384abdd5", "url": "https://github.com/jenkinsci/jenkins/commit/c9662fb0d8e319e1efb9cc74c995d780384abdd5", "message": "ImpersonatingUserDetailsService does not seem to have ever been used from plugins", "committedDate": "2020-07-28T22:44:23Z", "type": "commit"}, {"oid": "19cb4adfa0f42b1f92c2a340230a3496eb41cffb", "url": "https://github.com/jenkinsci/jenkins/commit/19cb4adfa0f42b1f92c2a340230a3496eb41cffb", "message": "Binary compatibility for ImpersonatingExecutorService and ImpersonatingScheduledExecutorService constructors", "committedDate": "2020-07-28T22:46:55Z", "type": "commit"}, {"oid": "f49afdf1d7a6a2e270dc13d033283963b6bc8378", "url": "https://github.com/jenkinsci/jenkins/commit/f49afdf1d7a6a2e270dc13d033283963b6bc8378", "message": "Binary compatibility for LastGrantedAuthoritiesProperty.getAuthorities", "committedDate": "2020-07-28T22:52:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkxNzgwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461917800", "bodyText": "Deliberately deleted without replacement.", "author": "jglick", "createdAt": "2020-07-28T22:08:00Z", "path": "core/src/main/java/hudson/cli/CLICommand.java", "diffHunk": "@@ -316,28 +316,6 @@ public Channel checkChannel() throws AbortException {\n         throw new AbortException(\"This command is requesting the -remoting mode which is no longer supported. See https://jenkins.io/redirect/cli-command-requires-channel\");\n     }\n \n-    /**\n-     * Determines if the user authentication is attempted through CLI before running this command.\n-     *\n-     * <p>\n-     * If your command doesn't require any authentication whatsoever, and if you don't even want to let the user\n-     * authenticate, then override this method to always return false &mdash; doing so will result in all the commands\n-     * running as anonymous user credential.\n-     *\n-     * <p>\n-     * Note that even if this method returns true, the user can still skip aut \n-     *\n-     * @param auth\n-     *      Always non-null.\n-     *      If the underlying transport had already performed authentication, this object is something other than\n-     *      {@link jenkins.model.Jenkins#ANONYMOUS}.\n-     * @deprecated Unused.\n-     */\n-    @Deprecated\n-    protected boolean shouldPerformAuthentication(Authentication auth) {", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/cli/CLICommand.java b/core/src/main/java/hudson/cli/CLICommand.java\nindex 77440d3e89..a1f11658cd 100644\n--- a/core/src/main/java/hudson/cli/CLICommand.java\n+++ b/core/src/main/java/hudson/cli/CLICommand.java\n\n@@ -316,6 +316,28 @@ public abstract class CLICommand implements ExtensionPoint, Cloneable {\n         throw new AbortException(\"This command is requesting the -remoting mode which is no longer supported. See https://jenkins.io/redirect/cli-command-requires-channel\");\n     }\n \n+    /**\n+     * Determines if the user authentication is attempted through CLI before running this command.\n+     *\n+     * <p>\n+     * If your command doesn't require any authentication whatsoever, and if you don't even want to let the user\n+     * authenticate, then override this method to always return false &mdash; doing so will result in all the commands\n+     * running as anonymous user credential.\n+     *\n+     * <p>\n+     * Note that even if this method returns true, the user can still skip aut \n+     *\n+     * @param auth\n+     *      Always non-null.\n+     *      If the underlying transport had already performed authentication, this object is something other than\n+     *      {@link jenkins.model.Jenkins#ANONYMOUS}.\n+     * @deprecated Unused.\n+     */\n+    @Deprecated\n+    protected boolean shouldPerformAuthentication(Authentication auth) {\n+        return auth== Jenkins.ANONYMOUS;\n+    }\n+\n     /**\n      * Returns the identity of the client as determined at the CLI transport level.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyNTcxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461925716", "bodyText": "Because implements UserDetailsService was removed from the signature.", "author": "jglick", "createdAt": "2020-07-28T22:19:08Z", "path": "core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java", "diffHunk": "@@ -28,18 +27,21 @@\n  * @author Kohsuke Kawaguchi\n  * @since 1.317\n  */\n-public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm implements UserDetailsService {\n+public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm {\n     @Override\n     public SecurityComponents createSecurityComponents() {\n-        Binding binding = new Binding();\n-        binding.setVariable(\"authenticator\", new Authenticator());\n-\n-        BeanBuilder builder = new BeanBuilder();\n-        builder.parse(Jenkins.get().servletContext.getResourceAsStream(\"/WEB-INF/security/AbstractPasswordBasedSecurityRealm.groovy\"),binding);\n-        WebApplicationContext context = builder.createApplicationContext();\n+        // this does all the hard work.\n+        Authenticator authenticator = new Authenticator();\n+        // these providers apply everywhere\n+        RememberMeAuthenticationProvider rmap = new RememberMeAuthenticationProvider(Jenkins.get().getSecretKey());\n+        // this doesn't mean we allow anonymous access.\n+        // we just authenticate2 anonymous users as such,\n+        // so that later authorization can reject them if so configured\n+        AnonymousAuthenticationProvider aap = new AnonymousAuthenticationProvider(\"anonymous\");\n+        AuthenticationManager authenticationManager = new ProviderManager(authenticator, rmap, aap);\n         return new SecurityComponents(\n-                findBean(AuthenticationManager.class, context),\n-                new ImpersonatingUserDetailsService(this));\n+                authenticationManager,\n+                new ImpersonatingUserDetailsService(this::loadUserByUsername2));", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java b/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\nindex 72f8c35e76..fa72720272 100644\n--- a/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\n+++ b/core/src/main/java/hudson/security/AbstractPasswordBasedSecurityRealm.java\n\n@@ -27,21 +28,18 @@ import org.springframework.security.core.userdetails.UsernameNotFoundException;\n  * @author Kohsuke Kawaguchi\n  * @since 1.317\n  */\n-public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm {\n+public abstract class AbstractPasswordBasedSecurityRealm extends SecurityRealm implements UserDetailsService {\n     @Override\n     public SecurityComponents createSecurityComponents() {\n-        // this does all the hard work.\n-        Authenticator authenticator = new Authenticator();\n-        // these providers apply everywhere\n-        RememberMeAuthenticationProvider rmap = new RememberMeAuthenticationProvider(Jenkins.get().getSecretKey());\n-        // this doesn't mean we allow anonymous access.\n-        // we just authenticate2 anonymous users as such,\n-        // so that later authorization can reject them if so configured\n-        AnonymousAuthenticationProvider aap = new AnonymousAuthenticationProvider(\"anonymous\");\n-        AuthenticationManager authenticationManager = new ProviderManager(authenticator, rmap, aap);\n+        Binding binding = new Binding();\n+        binding.setVariable(\"authenticator\", new Authenticator());\n+\n+        BeanBuilder builder = new BeanBuilder();\n+        builder.parse(Jenkins.get().servletContext.getResourceAsStream(\"/WEB-INF/security/AbstractPasswordBasedSecurityRealm.groovy\"),binding);\n+        WebApplicationContext context = builder.createApplicationContext();\n         return new SecurityComponents(\n-                authenticationManager,\n-                new ImpersonatingUserDetailsService(this::loadUserByUsername2));\n+                findBean(AuthenticationManager.class, context),\n+                new ImpersonatingUserDetailsService(this));\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyODcxMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461928710", "bodyText": "CliAuthenticator is deleted without replacement. Git\u2019s rename detection is being too aggressive here.", "author": "jglick", "createdAt": "2020-07-28T22:26:53Z", "path": "core/src/main/java/org/acegisecurity/AccessDeniedException.java", "diffHunk": "@@ -21,17 +21,21 @@\n  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n  * THE SOFTWARE.\n  */\n-package hudson.security;\n \n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.AuthenticationException;\n-\n-import java.io.IOException;\n+package org.acegisecurity;\n \n /**\n- * @deprecated No longer used.\n+ * @deprecated use {@link org.springframework.security.access.AccessDeniedException}\n  */\n @Deprecated\n-public abstract class CliAuthenticator {", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a063db6e0dc738f990e581063fc8676e92d42a8", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/AccessDeniedException.java b/core/src/main/java/org/acegisecurity/AccessDeniedException.java\nindex ac5d250ac9..210bcf8de4 100644\n--- a/core/src/main/java/org/acegisecurity/AccessDeniedException.java\n+++ b/core/src/main/java/org/acegisecurity/AccessDeniedException.java\n\n@@ -38,4 +38,9 @@ public class AccessDeniedException extends AcegiSecurityException {\n         super(msg, t);\n     }\n \n+    @Override\n+    public org.springframework.security.access.AccessDeniedException toSpring() {\n+        return new org.springframework.security.access.AccessDeniedException(toString(), this);\n+    }\n+\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyOTQ4Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461929487", "bodyText": "Long obsolete I think.", "author": "jglick", "createdAt": "2020-07-28T22:29:05Z", "path": "core/src/main/java/hudson/security/DeferredCreationLdapAuthoritiesPopulator.java", "diffHunk": "@@ -1,155 +0,0 @@\n-/*\n- * The MIT License\n- * \n- * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n- * \n- * Permission is hereby granted, free of charge, to any person obtaining a copy\n- * of this software and associated documentation files (the \"Software\"), to deal\n- * in the Software without restriction, including without limitation the rights\n- * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n- * copies of the Software, and to permit persons to whom the Software is\n- * furnished to do so, subject to the following conditions:\n- * \n- * The above copyright notice and this permission notice shall be included in\n- * all copies or substantial portions of the Software.\n- * \n- * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n- * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n- * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n- * THE SOFTWARE.\n- */\n-package hudson.security;\n-\n-import org.acegisecurity.GrantedAuthority;\n-import org.acegisecurity.ldap.InitialDirContextFactory;\n-import org.acegisecurity.ldap.LdapDataAccessException;\n-import org.acegisecurity.providers.ldap.LdapAuthoritiesPopulator;\n-import org.acegisecurity.providers.ldap.populator.DefaultLdapAuthoritiesPopulator;\n-import org.acegisecurity.userdetails.ldap.LdapUserDetails;\n-import hudson.security.SecurityRealm.SecurityComponents;\n-\n-/**\n- * Implementation of {@link LdapAuthoritiesPopulator} that defers creation of a\n- * {@link DefaultLdapAuthoritiesPopulator} until one is needed. This is done to\n- * ensure that the groupSearchBase property can be set.\n- * \n- * @author justinedelson\n- * @deprecated as of 1.280\n- *      {@link SecurityComponents} are now created after {@link SecurityRealm} is created, so\n- *      the initialization order issue that this code was trying to address no longer exists.\n- */\n-@Deprecated\n-public class DeferredCreationLdapAuthoritiesPopulator implements LdapAuthoritiesPopulator {", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/security/DeferredCreationLdapAuthoritiesPopulator.java b/core/src/main/java/hudson/security/DeferredCreationLdapAuthoritiesPopulator.java\nnew file mode 100644\nindex 0000000000..ac3a228b57\n--- /dev/null\n+++ b/core/src/main/java/hudson/security/DeferredCreationLdapAuthoritiesPopulator.java\n\n@@ -0,0 +1,155 @@\n+/*\n+ * The MIT License\n+ * \n+ * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n+ * \n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ * \n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ * \n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package hudson.security;\n+\n+import org.acegisecurity.GrantedAuthority;\n+import org.acegisecurity.ldap.InitialDirContextFactory;\n+import org.acegisecurity.ldap.LdapDataAccessException;\n+import org.acegisecurity.providers.ldap.LdapAuthoritiesPopulator;\n+import org.acegisecurity.providers.ldap.populator.DefaultLdapAuthoritiesPopulator;\n+import org.acegisecurity.userdetails.ldap.LdapUserDetails;\n+import hudson.security.SecurityRealm.SecurityComponents;\n+\n+/**\n+ * Implementation of {@link LdapAuthoritiesPopulator} that defers creation of a\n+ * {@link DefaultLdapAuthoritiesPopulator} until one is needed. This is done to\n+ * ensure that the groupSearchBase property can be set.\n+ * \n+ * @author justinedelson\n+ * @deprecated as of 1.280\n+ *      {@link SecurityComponents} are now created after {@link SecurityRealm} is created, so\n+ *      the initialization order issue that this code was trying to address no longer exists.\n+ */\n+@Deprecated\n+public class DeferredCreationLdapAuthoritiesPopulator implements LdapAuthoritiesPopulator {\n+\n+    /**\n+     * A default role which will be assigned to all authenticated users if set.\n+     */\n+    private String defaultRole = null;\n+\n+    /**\n+     * An initial context factory is only required if searching for groups is\n+     * required.\n+     */\n+    private InitialDirContextFactory initialDirContextFactory = null;\n+\n+    /**\n+     * Controls used to determine whether group searches should be performed\n+     * over the full sub-tree from the base DN.\n+     */\n+    private boolean searchSubtree = false;\n+\n+    /**\n+     * The ID of the attribute which contains the role name for a group\n+     */\n+    private String groupRoleAttribute = \"cn\";\n+\n+    /**\n+     * The base DN from which the search for group membership should be\n+     * performed\n+     */\n+    private String groupSearchBase = null;\n+\n+    /**\n+     * The pattern to be used for the user search. {0} is the user's DN\n+     */\n+    private String groupSearchFilter = \"(| (member={0}) (uniqueMember={0}) (memberUid={0}))\";\n+\n+    private String rolePrefix = \"ROLE_\";\n+\n+    private boolean convertToUpperCase = true;\n+\n+    /**\n+     * Constructor.\n+     * \n+     * @param initialDirContextFactory\n+     *            supplies the contexts used to search for user roles.\n+     * @param groupSearchBase\n+     *            if this is an empty string the search will be performed from\n+     *            the root DN of the context factory.\n+     */\n+    public DeferredCreationLdapAuthoritiesPopulator(\n+            InitialDirContextFactory initialDirContextFactory, String groupSearchBase) {\n+        this.setInitialDirContextFactory(initialDirContextFactory);\n+        this.setGroupSearchBase(groupSearchBase);\n+    }\n+\n+    public GrantedAuthority[] getGrantedAuthorities(LdapUserDetails userDetails)\n+            throws LdapDataAccessException {\n+        return create().getGrantedAuthorities(userDetails);\n+    }\n+\n+    public void setConvertToUpperCase(boolean convertToUpperCase) {\n+        this.convertToUpperCase = convertToUpperCase;\n+    }\n+\n+    public void setDefaultRole(String defaultRole) {\n+        this.defaultRole = defaultRole;\n+    }\n+\n+    public void setGroupRoleAttribute(String groupRoleAttribute) {\n+        this.groupRoleAttribute = groupRoleAttribute;\n+    }\n+\n+    public void setGroupSearchBase(String groupSearchBase) {\n+        this.groupSearchBase = groupSearchBase;\n+    }\n+\n+    public void setGroupSearchFilter(String groupSearchFilter) {\n+        this.groupSearchFilter = groupSearchFilter;\n+    }\n+\n+    public void setInitialDirContextFactory(InitialDirContextFactory initialDirContextFactory) {\n+        this.initialDirContextFactory = initialDirContextFactory;\n+    }\n+\n+    public void setRolePrefix(String rolePrefix) {\n+        this.rolePrefix = rolePrefix;\n+    }\n+\n+    public void setSearchSubtree(boolean searchSubtree) {\n+        this.searchSubtree = searchSubtree;\n+    }\n+\n+    /**\n+     * Create a new DefaultLdapAuthoritiesPopulator object.\n+     * \n+     * @return a DefaultLdapAuthoritiesPopulator.\n+     */\n+    private DefaultLdapAuthoritiesPopulator create() {\n+        DefaultLdapAuthoritiesPopulator populator = new DefaultLdapAuthoritiesPopulator(\n+                initialDirContextFactory, groupSearchBase);\n+        populator.setConvertToUpperCase(convertToUpperCase);\n+        if (defaultRole != null) {\n+            populator.setDefaultRole(defaultRole);\n+        }\n+        populator.setGroupRoleAttribute(groupRoleAttribute);\n+        populator.setGroupSearchFilter(groupSearchFilter);\n+        populator.setRolePrefix(rolePrefix);\n+        populator.setSearchSubtree(searchSubtree);\n+        return populator;\n+    }\n+\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkzMTE3Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461931172", "bodyText": "Deleted without replacement.", "author": "jglick", "createdAt": "2020-07-28T22:33:35Z", "path": "core/src/main/java/hudson/security/InvalidatableUserDetails.java", "diffHunk": "@@ -1,60 +0,0 @@\n-/*\n- * The MIT License\n- * \n- * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n- * \n- * Permission is hereby granted, free of charge, to any person obtaining a copy\n- * of this software and associated documentation files (the \"Software\"), to deal\n- * in the Software without restriction, including without limitation the rights\n- * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n- * copies of the Software, and to permit persons to whom the Software is\n- * furnished to do so, subject to the following conditions:\n- * \n- * The above copyright notice and this permission notice shall be included in\n- * all copies or substantial portions of the Software.\n- * \n- * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n- * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n- * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n- * THE SOFTWARE.\n- */\n-package hudson.security;\n-\n-import org.acegisecurity.Authentication;\n-import org.acegisecurity.context.SecurityContext;\n-import org.acegisecurity.userdetails.UserDetails;\n-\n-import javax.servlet.http.HttpSession;\n-import jenkins.security.NonSerializableSecurityContext;\n-\n-/**\n- * {@link UserDetails} that can mark {@link Authentication} invalid.\n- *\n- * <p>\n- * Tomcat persists sessions by using Java serialization (and\n- * that includes the security token created by Acegi, which includes this object)\n- * and when that happens, the next time the server comes back\n- * it will try to deserialize {@link SecurityContext} that Acegi\n- * puts into {@link HttpSession} (which transitively includes {@link UserDetails}\n- * that can be implemented by Hudson.\n- *\n- * <p>\n- * Such {@link UserDetails} implementation can override the {@link #isInvalid()}\n- * method and return false, so that such {@link SecurityContext} will be\n- * dropped before the rest of Acegi sees it.\n- *\n- * <p>\n- * See JENKINS-1482\n- * \n- * @author Kohsuke Kawaguchi\n- * @deprecated\n- *      Starting 1.285, Hudson stops persisting {@link Authentication} altogether\n- *      (see {@link NonSerializableSecurityContext}), so there's no need to use this mechanism.\n- */\n-@Deprecated\n-public interface InvalidatableUserDetails extends UserDetails {", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7befcfdd773a0eccf7b6930f110ff7331410b0cf", "chunk": "diff --git a/core/src/main/java/hudson/security/InvalidatableUserDetails.java b/core/src/main/java/hudson/security/InvalidatableUserDetails.java\nnew file mode 100644\nindex 0000000000..8f59170c01\n--- /dev/null\n+++ b/core/src/main/java/hudson/security/InvalidatableUserDetails.java\n\n@@ -0,0 +1,60 @@\n+/*\n+ * The MIT License\n+ * \n+ * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi\n+ * \n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ * \n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ * \n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package hudson.security;\n+\n+import org.acegisecurity.Authentication;\n+import org.acegisecurity.context.SecurityContext;\n+import org.acegisecurity.userdetails.UserDetails;\n+\n+import javax.servlet.http.HttpSession;\n+import jenkins.security.NonSerializableSecurityContext;\n+\n+/**\n+ * {@link UserDetails} that can mark {@link Authentication} invalid.\n+ *\n+ * <p>\n+ * Tomcat persists sessions by using Java serialization (and\n+ * that includes the security token created by Acegi, which includes this object)\n+ * and when that happens, the next time the server comes back\n+ * it will try to deserialize {@link SecurityContext} that Acegi\n+ * puts into {@link HttpSession} (which transitively includes {@link UserDetails}\n+ * that can be implemented by Hudson.\n+ *\n+ * <p>\n+ * Such {@link UserDetails} implementation can override the {@link #isInvalid()}\n+ * method and return false, so that such {@link SecurityContext} will be\n+ * dropped before the rest of Acegi sees it.\n+ *\n+ * <p>\n+ * See JENKINS-1482\n+ * \n+ * @author Kohsuke Kawaguchi\n+ * @deprecated\n+ *      Starting 1.285, Hudson stops persisting {@link Authentication} altogether\n+ *      (see {@link NonSerializableSecurityContext}), so there's no need to use this mechanism.\n+ */\n+@Deprecated\n+public interface InvalidatableUserDetails extends UserDetails {\n+    boolean isInvalid();\n+}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkzMTQ2MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4848#discussion_r461931460", "bodyText": "NotSerilizableSecurityContext long obsolete and deleted. Beware rename detection here.", "author": "jglick", "createdAt": "2020-07-28T22:34:18Z", "path": "core/src/main/java/org/acegisecurity/AcegiSecurityException.java", "diffHunk": "@@ -22,21 +22,22 @@\n  * THE SOFTWARE.\n  */\n \n-package hudson.security;\n+package org.acegisecurity;\n \n-import jenkins.security.NonSerializableSecurityContext;\n-import org.acegisecurity.Authentication;\n+import org.springframework.core.NestedRuntimeException;\n \n /**\n- * @deprecated use {@link NonSerializableSecurityContext} instead\n+ * @deprecated use {@link RuntimeException}\n  */\n @Deprecated\n-public class NotSerilizableSecurityContext extends NonSerializableSecurityContext {", "originalCommit": "b11f3e4bdb87d7643a4123a425e6929f0bf2f396", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a063db6e0dc738f990e581063fc8676e92d42a8", "chunk": "diff --git a/core/src/main/java/org/acegisecurity/AcegiSecurityException.java b/core/src/main/java/org/acegisecurity/AcegiSecurityException.java\nindex a70860c6b0..bfc529de38 100644\n--- a/core/src/main/java/org/acegisecurity/AcegiSecurityException.java\n+++ b/core/src/main/java/org/acegisecurity/AcegiSecurityException.java\n\n@@ -40,4 +40,10 @@ public abstract class AcegiSecurityException extends NestedRuntimeException {\n         super(msg, cause);\n     }\n \n+    public RuntimeException toSpring() {\n+        return new RuntimeException(toString(), this);\n+    }\n+\n+    // TODO fromSpring as needed, delegating to AccessDeniedException or AuthenticationException\n+\n }\n"}}, {"oid": "09feb27b4ee0ce2a91793512752118f21936603a", "url": "https://github.com/jenkinsci/jenkins/commit/09feb27b4ee0ce2a91793512752118f21936603a", "message": "Wrong access modifier for AbstractPasswordBasedSecurityRealm.authenticate", "committedDate": "2020-07-29T00:49:18Z", "type": "commit"}, {"oid": "b7f1accceaece0b2247e358f59022f6bfe82c745", "url": "https://github.com/jenkinsci/jenkins/commit/b7f1accceaece0b2247e358f59022f6bfe82c745", "message": "SecurityRealm.findBean was only used in conjunction with BeanBuilder", "committedDate": "2020-07-29T00:51:46Z", "type": "commit"}, {"oid": "340e0f9c3afa82cef2888616dcdc4c2a1c68db1f", "url": "https://github.com/jenkinsci/jenkins/commit/340e0f9c3afa82cef2888616dcdc4c2a1c68db1f", "message": "Javadoc error", "committedDate": "2020-07-29T00:53:20Z", "type": "commit"}]}