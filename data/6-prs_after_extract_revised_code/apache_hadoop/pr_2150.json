{"pr_number": 2150, "pr_title": "Hadoop 17132. ABFS: Fix Rename and Delete Idempotency check trigger", "pr_createdAt": "2020-07-17T13:38:20Z", "pr_url": "https://github.com/apache/hadoop/pull/2150", "timeline": [{"oid": "f1dad3de7622c2bf992bd4081f36aa69a4626849", "url": "https://github.com/apache/hadoop/commit/f1dad3de7622c2bf992bd4081f36aa69a4626849", "message": "Fix idempotency pre-check", "committedDate": "2020-07-16T06:26:06Z", "type": "commit"}, {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "url": "https://github.com/apache/hadoop/commit/0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "message": "Fix for idempotency fix", "committedDate": "2020-07-17T07:19:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2NzkwNA==", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457667904", "bodyText": "tag this as @VisibleForTesting too", "author": "steveloughran", "createdAt": "2020-07-20T20:19:32Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -170,7 +170,7 @@ String getSasToken() {\n    * Executes the REST operation with retry, by issuing one or more\n    * HTTP operations.\n    */\n-  void execute() throws AzureBlobFileSystemException {\n+   public void execute() throws AzureBlobFileSystemException {", "originalCommit": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MjQ5Nw==", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457682497", "bodyText": "Done", "author": "snvijaya", "createdAt": "2020-07-20T20:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2NzkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "7bf8fcdb22701e0042d802a43124a74e13a7935f", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java\nindex 8d7bd828f3c..936267aa507 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java\n\n@@ -170,6 +171,7 @@ String getSasToken() {\n    * Executes the REST operation with retry, by issuing one or more\n    * HTTP operations.\n    */\n+   @VisibleForTesting\n    public void execute() throws AzureBlobFileSystemException {\n     // see if we have latency reports from the previous requests\n     String latencyHeader = this.client.getAbfsPerfTracker().getClientLatency();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2ODQwNQ==", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457668405", "bodyText": "check spelling of mimic", "author": "steveloughran", "createdAt": "2020-07-20T20:20:39Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -181,6 +186,64 @@ public void testDeleteIdempotency() throws Exception {\n         .describedAs(\n             \"Delete is considered idempotent by default and should return success.\")\n         .isEqualTo(HTTP_OK);\n+\n+    // Case 2: Mock instance of Http Operation response. This will return\n+    // HTTP:Bad Request\n+    AbfsHttpOperation http400Op = mock(AbfsHttpOperation.class);\n+    when(http400Op.getStatusCode()).thenReturn(HTTP_BAD_REQUEST);\n+\n+    // Mock delete response to 400\n+    when(op.getResult()).thenReturn(http400Op);\n+\n+    Assertions.assertThat(testClient.deleteIdempotencyCheckOp(op)\n+        .getResult()\n+        .getStatusCode())\n+        .describedAs(\n+            \"Idempotency check to happen only for HTTP 404 response.\")\n+        .isEqualTo(HTTP_BAD_REQUEST);\n+\n+  }\n+\n+  @Test\n+  public void testDeleteIdempotencyTriggerHttp404() throws Exception {\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient client = TestAbfsClient.createTestClientFromCurrentContext(\n+        fs.getAbfsStore().getClient(),\n+        this.getConfiguration());\n+\n+    // Case 1: Not a retried case should throw error back\n+    intercept(AbfsRestOperationException.class,\n+        () -> client.deletePath(\n+        \"/NonExistingPath\",\n+        false,\n+        null));\n+\n+    // mock idempotency check to mimick retried case", "originalCommit": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MzQxMw==", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457683413", "bodyText": "Done", "author": "snvijaya", "createdAt": "2020-07-20T20:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2ODQwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "7bf8fcdb22701e0042d802a43124a74e13a7935f", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java b/hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java\nindex 446d108a208..2f2a6191ed4 100644\n--- a/hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java\n+++ b/hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java\n\n@@ -219,7 +219,7 @@ public void testDeleteIdempotencyTriggerHttp404() throws Exception {\n         false,\n         null));\n \n-    // mock idempotency check to mimick retried case\n+    // mock idempotency check to mimic retried case\n     AbfsClient mockClient = TestAbfsClient.getMockAbfsClient(\n         fs.getAbfsStore().getClient(),\n         this.getConfiguration());\n"}}, {"oid": "7bf8fcdb22701e0042d802a43124a74e13a7935f", "url": "https://github.com/apache/hadoop/commit/7bf8fcdb22701e0042d802a43124a74e13a7935f", "message": "Review comments", "committedDate": "2020-07-20T20:46:23Z", "type": "commit"}]}