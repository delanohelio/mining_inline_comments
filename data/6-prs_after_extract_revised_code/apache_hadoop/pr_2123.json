{"pr_number": 2123, "pr_title": "HADOOP-17092. ABFS: Making AzureADAuthenticator.getToken() throw HttpException if a\u2026", "pr_createdAt": "2020-07-06T11:37:21Z", "pr_url": "https://github.com/apache/hadoop/pull/2123", "timeline": [{"oid": "dc0a35fd6c21e3dace82506d5aa6569ad9dd5ef7", "url": "https://github.com/apache/hadoop/commit/dc0a35fd6c21e3dace82506d5aa6569ad9dd5ef7", "message": "ABFS: Making AzureADAuthenticator.getToken() throw HttpException if all the retries are failed. This is to indiacate no retry is required at AbfsRestOperation.executeHttpOperation(). Introduced delay inbetween retries.", "committedDate": "2020-07-06T10:01:39Z", "type": "commit"}, {"oid": "090410c2eb674c4ec68ab4949a9f46282d9fdc5a", "url": "https://github.com/apache/hadoop/commit/090410c2eb674c4ec68ab4949a9f46282d9fdc5a", "message": "Made the retry policy configuarable", "committedDate": "2020-07-07T14:28:41Z", "type": "commit"}, {"oid": "5911314ad2817e816f4eac379a03f8cfc8e18b17", "url": "https://github.com/apache/hadoop/commit/5911314ad2817e816f4eac379a03f8cfc8e18b17", "message": "Fixing checkstyle issues", "committedDate": "2020-07-07T16:46:03Z", "type": "commit"}, {"oid": "62d1f90399a7e1aae11db2a743697c3b317e4a1c", "url": "https://github.com/apache/hadoop/commit/62d1f90399a7e1aae11db2a743697c3b317e4a1c", "message": "Fixing retry logic", "committedDate": "2020-07-08T18:43:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDU3OQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r453584579", "bodyText": "Indentation.", "author": "snvijaya", "createdAt": "2020-07-13T11:31:16Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java", "diffHunk": "@@ -77,11 +77,14 @@ private AzureADAuthenticator() {\n    * @param clientId     the client ID (GUID) of the client web app\n    *                     btained from Azure Active Directory configuration\n    * @param clientSecret the secret key of the client web app\n+   * @param tokenFetchRetryPolicy retry policy to be used for token fetch AAD\n+   *                             calls.\n    * @return {@link AzureADToken} obtained using the creds\n    * @throws IOException throws IOException if there is a failure in connecting to Azure AD\n    */\n   public static AzureADToken getTokenUsingClientCreds(String authEndpoint,\n-                                                      String clientId, String clientSecret)\n+                                                      String clientId,\n+      String clientSecret, ExponentialRetryPolicy tokenFetchRetryPolicy)", "originalCommit": "62d1f90399a7e1aae11db2a743697c3b317e4a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2OTk3OQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r454469979", "bodyText": "Done", "author": "bilaharith", "createdAt": "2020-07-14T16:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6ac3ef808b5d7a421eb74378f17c184bcf37c7ea", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\nindex 8d1b936848f..a2d4638e474 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n\n@@ -83,9 +83,8 @@ private AzureADAuthenticator() {\n    * @throws IOException throws IOException if there is a failure in connecting to Azure AD\n    */\n   public static AzureADToken getTokenUsingClientCreds(String authEndpoint,\n-                                                      String clientId,\n-      String clientSecret, ExponentialRetryPolicy tokenFetchRetryPolicy)\n-          throws IOException {\n+      String clientId, String clientSecret,\n+      ExponentialRetryPolicy tokenFetchRetryPolicy) throws IOException {\n     Preconditions.checkNotNull(authEndpoint, \"authEndpoint\");\n     Preconditions.checkNotNull(clientId, \"clientId\");\n     Preconditions.checkNotNull(clientSecret, \"clientSecret\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTI2NQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r453585265", "bodyText": "Make this a trace level log.", "author": "snvijaya", "createdAt": "2020-07-13T11:32:37Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java", "diffHunk": "@@ -275,21 +287,24 @@ public UnexpectedResponseException(final int httpErrorCode,\n   }\n \n   private static AzureADToken getTokenCall(String authEndpoint, String body,\n-      Hashtable<String, String> headers, String httpMethod) throws IOException {\n-    return getTokenCall(authEndpoint, body, headers, httpMethod, false);\n+      Hashtable<String, String> headers, String httpMethod,\n+      ExponentialRetryPolicy tokenFetchRetryPolicy) throws IOException {\n+    return getTokenCall(authEndpoint, body, headers, httpMethod, false,\n+        tokenFetchRetryPolicy);\n   }\n \n   private static AzureADToken getTokenCall(String authEndpoint, String body,\n-      Hashtable<String, String> headers, String httpMethod, boolean isMsi)\n+      Hashtable<String, String> headers, String httpMethod, boolean isMsi,\n+      ExponentialRetryPolicy tokenFetchRetryPolicy)\n       throws IOException {\n     AzureADToken token = null;\n-    ExponentialRetryPolicy retryPolicy\n-            = new ExponentialRetryPolicy(3, 0, 1000, 2);\n \n     int httperror = 0;\n     IOException ex = null;\n     boolean succeeded = false;\n     int retryCount = 0;\n+    boolean shouldRetry;\n+    LOG.debug(\"First execution of REST operation getTokenSingleCall\");", "originalCommit": "62d1f90399a7e1aae11db2a743697c3b317e4a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MDA0MQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r454470041", "bodyText": "Done", "author": "bilaharith", "createdAt": "2020-07-14T16:06:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTI2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6ac3ef808b5d7a421eb74378f17c184bcf37c7ea", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\nindex 8d1b936848f..a2d4638e474 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n\n@@ -304,7 +303,7 @@ private static AzureADToken getTokenCall(String authEndpoint, String body,\n     boolean succeeded = false;\n     int retryCount = 0;\n     boolean shouldRetry;\n-    LOG.debug(\"First execution of REST operation getTokenSingleCall\");\n+    LOG.trace(\"First execution of REST operation getTokenSingleCall\");\n     do {\n       httperror = 0;\n       ex = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5MTM2Ng==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r453591366", "bodyText": "As every OAuth token provider eventually calls this method to get token, you will just need to create an instance of exponential retry right here with the configured values ?\nIs there any benefit creating and passing down exponential retry instance from each of the token provider ?", "author": "snvijaya", "createdAt": "2020-07-13T11:44:41Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java", "diffHunk": "@@ -275,21 +287,24 @@ public UnexpectedResponseException(final int httpErrorCode,\n   }\n \n   private static AzureADToken getTokenCall(String authEndpoint, String body,\n-      Hashtable<String, String> headers, String httpMethod) throws IOException {\n-    return getTokenCall(authEndpoint, body, headers, httpMethod, false);\n+      Hashtable<String, String> headers, String httpMethod,\n+      ExponentialRetryPolicy tokenFetchRetryPolicy) throws IOException {\n+    return getTokenCall(authEndpoint, body, headers, httpMethod, false,\n+        tokenFetchRetryPolicy);\n   }\n \n   private static AzureADToken getTokenCall(String authEndpoint, String body,\n-      Hashtable<String, String> headers, String httpMethod, boolean isMsi)\n+      Hashtable<String, String> headers, String httpMethod, boolean isMsi,\n+      ExponentialRetryPolicy tokenFetchRetryPolicy)\n       throws IOException {\n     AzureADToken token = null;\n-    ExponentialRetryPolicy retryPolicy", "originalCommit": "62d1f90399a7e1aae11db2a743697c3b317e4a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2OTI0OQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r454469249", "bodyText": "Done", "author": "bilaharith", "createdAt": "2020-07-14T16:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5MTM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MDE2MQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r454470161", "bodyText": "Done", "author": "bilaharith", "createdAt": "2020-07-14T16:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5MTM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6ac3ef808b5d7a421eb74378f17c184bcf37c7ea", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\nindex 8d1b936848f..a2d4638e474 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java\n\n@@ -304,7 +303,7 @@ private static AzureADToken getTokenCall(String authEndpoint, String body,\n     boolean succeeded = false;\n     int retryCount = 0;\n     boolean shouldRetry;\n-    LOG.debug(\"First execution of REST operation getTokenSingleCall\");\n+    LOG.trace(\"First execution of REST operation getTokenSingleCall\");\n     do {\n       httperror = 0;\n       ex = null;\n"}}, {"oid": "6ac3ef808b5d7a421eb74378f17c184bcf37c7ea", "url": "https://github.com/apache/hadoop/commit/6ac3ef808b5d7a421eb74378f17c184bcf37c7ea", "message": "Review comments incorporated", "committedDate": "2020-07-14T12:33:42Z", "type": "commit"}, {"oid": "6ea50f05084e647515514b5b7da248fd52603d66", "url": "https://github.com/apache/hadoop/commit/6ea50f05084e647515514b5b7da248fd52603d66", "message": "Addressing review comments", "committedDate": "2020-07-14T15:44:58Z", "type": "commit"}, {"oid": "c72183f30e92a3cc385780a60016afd3162c2f11", "url": "https://github.com/apache/hadoop/commit/c72183f30e92a3cc385780a60016afd3162c2f11", "message": "Removing unnecessary formattings", "committedDate": "2020-07-14T16:03:11Z", "type": "commit"}, {"oid": "a6bc587db555028bbb9317e81bb11e49ae314a1f", "url": "https://github.com/apache/hadoop/commit/a6bc587db555028bbb9317e81bb11e49ae314a1f", "message": "Incorporating changes for HADOOP-17093, prevents retries for unrecoverable failures", "committedDate": "2020-07-15T12:04:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAzMjgxMw==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r456032813", "bodyText": "order", "author": "DadanielZ", "createdAt": "2020-07-16T19:42:27Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "diffHunk": "@@ -50,6 +50,7 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Preconditions;\n import com.google.common.base.Strings;\n+import org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator;", "originalCommit": "5f59493770ac3d748dd099e382e24b0cc7a44d4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyMjc3MQ==", "url": "https://github.com/apache/hadoop/pull/2123#discussion_r456522771", "bodyText": "done", "author": "bilaharith", "createdAt": "2020-07-17T15:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAzMjgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "2b1886bbf27d0f34eedd2715b427bd176266a855", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java\nindex e5ec24e7d2b..eac06e6d761 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java\n\n@@ -50,7 +50,6 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Preconditions;\n import com.google.common.base.Strings;\n-import org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n"}}, {"oid": "2b1886bbf27d0f34eedd2715b427bd176266a855", "url": "https://github.com/apache/hadoop/commit/2b1886bbf27d0f34eedd2715b427bd176266a855", "message": "Checkstyle fixes\nFixing import order", "committedDate": "2020-07-19T13:16:15Z", "type": "commit"}, {"oid": "2b1886bbf27d0f34eedd2715b427bd176266a855", "url": "https://github.com/apache/hadoop/commit/2b1886bbf27d0f34eedd2715b427bd176266a855", "message": "Checkstyle fixes\nFixing import order", "committedDate": "2020-07-19T13:16:15Z", "type": "forcePushed"}, {"oid": "0682b22ab902cda16b586abde2fe74e112cd0d62", "url": "https://github.com/apache/hadoop/commit/0682b22ab902cda16b586abde2fe74e112cd0d62", "message": "Merge branch 'trunk' into HADOOP-17092-gettokenretry", "committedDate": "2020-07-21T09:58:17Z", "type": "commit"}]}