{"pr_number": 2240, "pr_title": "HADOOP-17165. Implement service-user feature in DecayRPCScheduler.", "pr_createdAt": "2020-08-24T08:39:51Z", "pr_url": "https://github.com/apache/hadoop/pull/2240", "timeline": [{"oid": "6e10c6881c4cab27a42a6f404d002c1ca82e6852", "url": "https://github.com/apache/hadoop/commit/6e10c6881c4cab27a42a6f404d002c1ca82e6852", "message": "HADOOP-17165. Implement service-user feature in DecayRPCScheduler.", "committedDate": "2020-08-24T08:17:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r475635387", "bodyText": "@tasanuma Thanks for your proposal. I am concerned any corner case here if put service users's request to the priority forever rather than flow controls. Such as user hdfs is one service user, and submit one big job which involve massive RPC request to NameNode, other normal users' request may postpone serious.", "author": "Hexiaoqiao", "createdAt": "2020-08-24T14:02:03Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java", "diffHunk": "@@ -483,6 +501,12 @@ private void recomputeScheduleCache() {\n \n     for (Map.Entry<Object, List<AtomicLong>> entry : callCosts.entrySet()) {\n       Object id = entry.getKey();\n+      // The priority for service users is always 0\n+      if (isServiceUser((String)id)) {", "originalCommit": "6e10c6881c4cab27a42a6f404d002c1ca82e6852", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4MTIyMg==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r475681222", "bodyText": "Thanks for your comment, @Hexiaoqiao.\nI think you can adjust the existing FairCallQueue settings to deal with that case to a certain extent. You could consider increasing the weight of the highest priority queue, or extending the length of the highest priority queue. However, this simple feature is not a feature that can be used in all cases. If more fairness is needed among service users, then I believe that HADOOP-15016 would be required.\nThe case where I think this feature would be useful is when you have service users who are regularly running critical ETL jobs. A user who can make huge RPC requests at a moment may not be suite for a service user.", "author": "tasanuma", "createdAt": "2020-08-24T15:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI3NTg5OQ==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r482275899", "bodyText": "@tasanuma curious why you choose to do it here and cachedOrComputedPriorityLevel instead of getPriorityLevel in the previous patch.", "author": "sunchao", "createdAt": "2020-09-02T18:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYwNzQzNQ==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r482607435", "bodyText": "@sunchao Thanks for your review.\n\nWhen DecayRpcScheduler decays, it calls recomputeScheduleCache to recalculate the priority of all users, including service users, and put them in the cache. So we had to do this in recomputeScheduleCache as well. Lines 415-421 of the unit test cover this case.\nI moved it from getPriorityLevel to cachedOrComputedPriorityLevel because I thought it would be a little more efficient to determine if a user is a service user after looking at the cache information.", "author": "tasanuma", "createdAt": "2020-09-02T23:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk5OTU3OA==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r483999578", "bodyText": "Gotcha. Thanks @tasanuma . This looks most good for me. One minor nit is that the logic for handling service users now is separated into two places. Another way perhaps is to add this in computePriorityLevel which is called by recomputeScheduleCache and cacheOrComputePriorityLevel. We need to add an extra parameter for this method though. What do you think?", "author": "sunchao", "createdAt": "2020-09-05T23:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE0NTE1NA==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r484145154", "bodyText": "Thanks for your review, @sunchao! I agreed. Updated the PR addressing it.", "author": "tasanuma", "createdAt": "2020-09-07T01:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNTM4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9b00671fd669a9277fa77c1f1760999fd6c1c040", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\nindex e6a296b8956..0336855c925 100644\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\n\n@@ -501,16 +501,10 @@ private void recomputeScheduleCache() {\n \n     for (Map.Entry<Object, List<AtomicLong>> entry : callCosts.entrySet()) {\n       Object id = entry.getKey();\n-      // The priority for service users is always 0\n-      if (isServiceUser((String)id)) {\n-        nextCache.put(id, 0);\n-        continue;\n-      }\n-\n       AtomicLong value = entry.getValue().get(0);\n \n       long snapshot = value.get();\n-      int computedLevel = computePriorityLevel(snapshot);\n+      int computedLevel = computePriorityLevel(snapshot, id);\n \n       nextCache.put(id, computedLevel);\n     }\n"}}, {"oid": "9b00671fd669a9277fa77c1f1760999fd6c1c040", "url": "https://github.com/apache/hadoop/commit/9b00671fd669a9277fa77c1f1760999fd6c1c040", "message": "Move the method call to computePriorityLevel", "committedDate": "2020-09-07T01:32:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2ODE1MA==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r485068150", "bodyText": "nit nit: usually it is UserName instead of Username, so better follow that pattern.", "author": "sunchao", "createdAt": "2020-09-08T17:00:51Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java", "diffHunk": "@@ -178,6 +188,7 @@\n   private static final double PRECISION = 0.0001;\n   private MetricsProxy metricsProxy;\n   private final CostProvider costProvider;\n+  private Set<String> serviceUsernames;", "originalCommit": "9b00671fd669a9277fa77c1f1760999fd6c1c040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM0NTE3MQ==", "url": "https://github.com/apache/hadoop/pull/2240#discussion_r485345171", "bodyText": "Thanks for your review. Updated PR following UserName.", "author": "tasanuma", "createdAt": "2020-09-09T05:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2ODE1MA=="}], "type": "inlineReview", "revised_code": {"commit": "c4cc5e0fcec768d6a20fbd0ade1711e579c9f4ee", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\nindex 0336855c925..dcfa62a0bc8 100644\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/DecayRpcScheduler.java\n\n@@ -188,7 +188,7 @@\n   private static final double PRECISION = 0.0001;\n   private MetricsProxy metricsProxy;\n   private final CostProvider costProvider;\n-  private Set<String> serviceUsernames;\n+  private Set<String> serviceUserNames;\n \n   /**\n    * This TimerTask will call decayCurrentCosts until\n"}}, {"oid": "c4cc5e0fcec768d6a20fbd0ade1711e579c9f4ee", "url": "https://github.com/apache/hadoop/commit/c4cc5e0fcec768d6a20fbd0ade1711e579c9f4ee", "message": "Use UserName instead of Username", "committedDate": "2020-09-09T04:59:29Z", "type": "commit"}]}