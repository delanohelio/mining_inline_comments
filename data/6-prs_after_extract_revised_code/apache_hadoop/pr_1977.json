{"pr_number": 1977, "pr_title": "HADOOP-17010. Add queue capacity support for FairCallQueue", "pr_createdAt": "2020-04-24T23:55:25Z", "pr_url": "https://github.com/apache/hadoop/pull/1977", "timeline": [{"oid": "28f94e468f3751bccac770474ccf70d987217ea7", "url": "https://github.com/apache/hadoop/commit/28f94e468f3751bccac770474ccf70d987217ea7", "message": "Add queue capacity support for FairCallQueue", "committedDate": "2020-04-24T23:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMTIxNw==", "url": "https://github.com/apache/hadoop/pull/1977#discussion_r416001217", "bodyText": "what if user passes in negative numbers as weights? should we add a safe guard against that?", "author": "sunchao", "createdAt": "2020-04-27T17:20:36Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/FairCallQueue.java", "diffHunk": "@@ -101,11 +111,18 @@ public FairCallQueue(int priorityLevels, int capacity, String ns,\n \n     this.queues = new ArrayList<BlockingQueue<E>>(numQueues);\n     this.overflowedCalls = new ArrayList<AtomicLong>(numQueues);\n-    int queueCapacity = capacity / numQueues;\n-    int capacityForFirstQueue = queueCapacity + (capacity % numQueues);\n+    int totalWeights = 0;\n+    for (int i = 0; i < capacityWeights.length; i++) {", "originalCommit": "28f94e468f3751bccac770474ccf70d987217ea7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMTY1OQ==", "url": "https://github.com/apache/hadoop/pull/1977#discussion_r416001659", "bodyText": "nit: add a blank line between this and the first parameter line.", "author": "sunchao", "createdAt": "2020-04-27T17:21:14Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java", "diffHunk": "@@ -343,6 +347,36 @@ private static int parseNumLevels(String ns, Configuration conf) {\n     return retval;\n   }\n \n+  /**\n+   * Read the weights of capacity in callqueue and pass the value to\n+   * callqueue constructions.\n+   */\n+  private static int[] parseCapacityWeights(\n+      int priorityLevels, String ns, Configuration conf) {\n+    int[] weights = conf.getInts(ns + \".\" +\n+      CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY);\n+    if (weights.length == 0) {\n+      weights = getDefaultQueueCapacityWeights(priorityLevels);\n+    } else if (weights.length != priorityLevels) {\n+      throw new IllegalArgumentException(\n+          CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY + \" must \"\n+              + \"specify \" + priorityLevels + \" capacity weights: one for each \"\n+              + \"priority level\");\n+    }\n+    return weights;\n+  }\n+\n+  /**\n+   * By default, queue capacity is the same for all priority levels.", "originalCommit": "28f94e468f3751bccac770474ccf70d987217ea7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eefb949ba2f2164cff25d5bdf410485eb0862aa7", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java\nindex 6f2396fc7e1..53ac34b6127 100644\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java\n\n@@ -362,12 +362,23 @@ private static int parseNumLevels(String ns, Configuration conf) {\n           CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY + \" must \"\n               + \"specify \" + priorityLevels + \" capacity weights: one for each \"\n               + \"priority level\");\n+    } else {\n+      // only allow positive numbers\n+      for (int w : weights) {\n+        if (w <= 0) {\n+          throw new IllegalArgumentException(\n+              CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY +\n+                  \" only takes positive weights. \" + w + \" capacity weight \" +\n+                  \"found\");\n+        }\n+      }\n     }\n     return weights;\n   }\n \n   /**\n    * By default, queue capacity is the same for all priority levels.\n+   *\n    * @param priorityLevels number of levels\n    * @return default weights\n    */\n"}}, {"oid": "eefb949ba2f2164cff25d5bdf410485eb0862aa7", "url": "https://github.com/apache/hadoop/commit/eefb949ba2f2164cff25d5bdf410485eb0862aa7", "message": "Add positive weight limit", "committedDate": "2020-04-27T20:51:36Z", "type": "commit"}]}