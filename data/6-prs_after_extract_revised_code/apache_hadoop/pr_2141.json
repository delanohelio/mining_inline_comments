{"pr_number": 2141, "pr_title": "HADOOP-17129. Validating storage keys in ABFS correctly", "pr_createdAt": "2020-07-15T12:37:25Z", "pr_url": "https://github.com/apache/hadoop/pull/2141", "timeline": [{"oid": "d3b5c4033e9beac0f905286f172afefc85c009bf", "url": "https://github.com/apache/hadoop/commit/d3b5c4033e9beac0f905286f172afefc85c009bf", "message": "HADOOP-17129. Validating storage keys in ABFS correctly", "committedDate": "2020-07-15T12:34:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455038055", "bodyText": "Throw it; we want to fail fast rather than wait for auth failures talking to the far end.", "author": "steveloughran", "createdAt": "2020-07-15T13:10:08Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java", "diffHunk": "@@ -49,6 +51,27 @@ public String getStorageAccountKey(String accountName, Configuration rawConfig)\n       LOG.warn(\"Unable to get key from credential providers. {}\", ioe);\n     }\n \n+    // Validating the key.\n+    try {\n+      validateStorageAccountKey(key);\n+    } catch (InvalidConfigurationValueException e) {\n+      e.printStackTrace();", "originalCommit": "d3b5c4033e9beac0f905286f172afefc85c009bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA2MjIxMw==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455062213", "bodyText": "Will it be fine to surround the throw new InvalidConfigurationValueException() with one more try-catch block? Since adding an exception to the method would break a test already present.\nAlso, inside validateStorageAccountKey() we are throwing an InvalidConfigurationValueException() in the validate() method.", "author": "mehakmeet", "createdAt": "2020-07-15T13:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMzUyMw==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455103523", "bodyText": "Just throw KeyProviderException like it is done in line 49. Or better to call validateStorageAccountKey() just after L48 only so that you don't have to try and catch separately.", "author": "mukund-thakur", "createdAt": "2020-07-15T14:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyMDQ0NA==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455120444", "bodyText": "I tried to place at L48 as well in the beginning but a test was getting broken, I found at that it expects a certain exception, it passes a null key, which makes the validate() method throw a different error. I think by adding a condition in the catch to throw that particular error if the key is null might solve this. So, I'll be changing it in the next commit.", "author": "mehakmeet", "createdAt": "2020-07-15T14:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MDE5Nw==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455180197", "bodyText": "don't worry about breaking the test, we've moved the vaildation and should expect it. Instead the test will need to handle the way invalid configurations are raised.\nOr go with mukund -just make sure that the wrapping exception uses the message of the caught exception and adds it as the cause", "author": "steveloughran", "createdAt": "2020-07-15T16:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzQ4Mw==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455187483", "bodyText": "Yes, I think the test is fine, I just needed to throw this specific exception when the config value is null which this test is trying to achieve, so I'll throw the exception when it is null else, it'll be like it always has been.", "author": "mehakmeet", "createdAt": "2020-07-15T16:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzODA1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d21076af7eeafd397a9b228d2136549dae0f4c89", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\nindex a8a8874dea1..4c5fbd89b94 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\n\n@@ -39,25 +39,24 @@\n \n   @Override\n   public String getStorageAccountKey(String accountName, Configuration rawConfig)\n-      throws KeyProviderException {\n+      throws KeyProviderException, ConfigurationPropertyNotFoundException {\n     String key = null;\n \n     try {\n       AbfsConfiguration abfsConfig = new AbfsConfiguration(rawConfig, accountName);\n       key = abfsConfig.getPasswordString(ConfigurationKeys.FS_AZURE_ACCOUNT_KEY_PROPERTY_NAME);\n-    } catch(IllegalAccessException | InvalidConfigurationValueException e) {\n+\n+      // Validating the key.\n+      validateStorageAccountKey(key);\n+    } catch (IllegalAccessException | InvalidConfigurationValueException e) {\n+      if (key == null) {\n+        throw new ConfigurationPropertyNotFoundException(accountName);\n+      }\n       throw new KeyProviderException(\"Failure to initialize configuration\", e);\n     } catch(IOException ioe) {\n       LOG.warn(\"Unable to get key from credential providers. {}\", ioe);\n     }\n \n-    // Validating the key.\n-    try {\n-      validateStorageAccountKey(key);\n-    } catch (InvalidConfigurationValueException e) {\n-      e.printStackTrace();\n-    }\n-\n     return key;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzOTIyMQ==", "url": "https://github.com/apache/hadoop/pull/2141#discussion_r455039221", "bodyText": "leave imports alone once they are in; otherwise backporting is a mess", "author": "steveloughran", "createdAt": "2020-07-15T13:11:57Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java", "diffHunk": "@@ -20,13 +20,15 @@\n \n import java.io.IOException;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.fs.azurebfs.AbfsConfiguration;\n import org.apache.hadoop.fs.azurebfs.constants.ConfigurationKeys;\n import org.apache.hadoop.fs.azurebfs.contracts.exceptions.KeyProviderException;\n import org.apache.hadoop.fs.azurebfs.contracts.exceptions.InvalidConfigurationValueException;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;", "originalCommit": "d3b5c4033e9beac0f905286f172afefc85c009bf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d21076af7eeafd397a9b228d2136549dae0f4c89", "chunk": "diff --git a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\nindex a8a8874dea1..4c5fbd89b94 100644\n--- a/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\n+++ b/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/SimpleKeyProvider.java\n\n@@ -20,15 +20,15 @@\n \n import java.io.IOException;\n \n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.fs.azurebfs.AbfsConfiguration;\n import org.apache.hadoop.fs.azurebfs.constants.ConfigurationKeys;\n+import org.apache.hadoop.fs.azurebfs.contracts.exceptions.ConfigurationPropertyNotFoundException;\n import org.apache.hadoop.fs.azurebfs.contracts.exceptions.KeyProviderException;\n import org.apache.hadoop.fs.azurebfs.contracts.exceptions.InvalidConfigurationValueException;\n import org.apache.hadoop.fs.azurebfs.diagnostics.Base64StringConfigurationBasicValidator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n /**\n  * Key provider that simply returns the storage account key from the\n"}}, {"oid": "d21076af7eeafd397a9b228d2136549dae0f4c89", "url": "https://github.com/apache/hadoop/commit/d21076af7eeafd397a9b228d2136549dae0f4c89", "message": "HADOOP-17129. Fixing review comments", "committedDate": "2020-07-15T15:43:42Z", "type": "commit"}, {"oid": "c5ab869069958e6e7032f30e39b01d73a32b0cc4", "url": "https://github.com/apache/hadoop/commit/c5ab869069958e6e7032f30e39b01d73a32b0cc4", "message": "HADOOP-17129. Fixing test", "committedDate": "2020-07-15T17:41:07Z", "type": "commit"}]}