{"pr_number": 2113, "pr_title": "HADOOP-17105: S3AFS - Do not attempt to resolve symlinks in globStatus", "pr_createdAt": "2020-06-30T21:14:55Z", "pr_url": "https://github.com/apache/hadoop/pull/2113", "timeline": [{"oid": "a9ec88847f441e51ae06d4de9bbbf0feaa706a1b", "url": "https://github.com/apache/hadoop/commit/a9ec88847f441e51ae06d4de9bbbf0feaa706a1b", "message": "S3AFS - Do not attempt to resolve symlinks in globStatus\n\nS3AFS does not support symlinks, so attempting to resolve\nsymlinks in globStatus causes wasted S3 calls and worse\nperformance. Removing it will speed up some calls to\nglobStatus.\n\nJIRA link: https://issues.apache.org/jira/browse/HADOOP-17105", "committedDate": "2020-07-01T18:07:33Z", "type": "commit"}, {"oid": "a9ec88847f441e51ae06d4de9bbbf0feaa706a1b", "url": "https://github.com/apache/hadoop/commit/a9ec88847f441e51ae06d4de9bbbf0feaa706a1b", "message": "S3AFS - Do not attempt to resolve symlinks in globStatus\n\nS3AFS does not support symlinks, so attempting to resolve\nsymlinks in globStatus causes wasted S3 calls and worse\nperformance. Removing it will speed up some calls to\nglobStatus.\n\nJIRA link: https://issues.apache.org/jira/browse/HADOOP-17105", "committedDate": "2020-07-01T18:07:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNjc4Nw==", "url": "https://github.com/apache/hadoop/pull/2113#discussion_r450016787", "bodyText": "Both these tests look almost the same in terms operation counts and also the symlink resolution is always disabled.\nCan you please tell me why do we need two tests here? Thanks.", "author": "mukund-thakur", "createdAt": "2020-07-06T06:52:14Z", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/ITestS3AFileOperationCost.java", "diffHunk": "@@ -574,4 +574,48 @@ public void testCreateCost() throws Throwable {\n     }\n \n   }\n+\n+  @Test\n+  public void testCostOfGlobStatus() throws Throwable {\n+    describe(\"Test globStatus has expected cost\");\n+    S3AFileSystem fs = getFileSystem();\n+    assume(\"Unguarded FS only\", !fs.hasMetadataStore());\n+\n+    Path basePath = path(\"testCostOfGlobStatus/nextFolder/\");\n+\n+    // create a bunch of files\n+    int filesToCreate = 10;\n+    for (int i = 0; i < filesToCreate; i++) {\n+      try (FSDataOutputStream out = fs.create(basePath.suffix(\"/\" + i))) {\n+        verifyOperationCount(1, 1);\n+      }\n+    }\n+\n+    fs.globStatus(basePath.suffix(\"/*\"));\n+    // 2 head + 1 list from getFileStatus on path,\n+    // plus 1 list to match the glob pattern\n+    verifyOperationCount(2, 2);\n+  }\n+\n+  @Test\n+  public void testCostOfGlobStatusNoSymlinkResolution() throws Throwable {", "originalCommit": "a9ec88847f441e51ae06d4de9bbbf0feaa706a1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MDg1Nw==", "url": "https://github.com/apache/hadoop/pull/2113#discussion_r450360857", "bodyText": "So these tests two different things, a directory with multiple objects and a directory with one object. The directory with a single object is the special case that triggers attempted symlink resolution, so I wanted to carve out that special case in its own test.\nThe multiple-objects-in-a-directory test is a general test that it felt like globStatus should have, whereas the second one was specifically made to catch the regression.\nIf you don't think that the multiple objects test is justified, I can remove it. Thoughts?", "author": "jimmy-zuber-amzn", "createdAt": "2020-07-06T17:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNTg1Ng==", "url": "https://github.com/apache/hadoop/pull/2113#discussion_r450705856", "bodyText": "I got it it. \n  \n    \n      hadoop/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java\n    \n    \n         Line 292\n      in\n      f77bbc2\n    \n    \n    \n    \n\n        \n          \n           if (children.length == 1) { \n        \n    \n  \n\n\nThanks.", "author": "mukund-thakur", "createdAt": "2020-07-07T08:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNjc4Nw=="}], "type": "inlineReview", "revised_code": null}]}