{"pr_number": 2473, "pr_title": "HADOOP-17385. ITestS3ADeleteCost.testDirMarkersFileCreation failure", "pr_createdAt": "2020-11-18T19:03:20Z", "pr_url": "https://github.com/apache/hadoop/pull/2473", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQxMDQ4MA==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r527410480", "bodyText": "Looks like jira id is wrong.", "author": "mukund-thakur", "createdAt": "2020-11-20T05:28:51Z", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java", "diffHunk": "@@ -60,6 +60,9 @@ public void setup() throws Exception {\n     // filesystems which add default configuration resources to do it before\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n+    // instantiate an S3A FS here here to force deprecated key load through the\n+    // static initializers. See: HADOOP-17835", "originalCommit": "ebd8242f9b2068b4dd81d4e310db6eee67e31737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc4NDE3NA==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r528784174", "bodyText": "thanks", "author": "steveloughran", "createdAt": "2020-11-23T15:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQxMDQ4MA=="}], "type": "inlineReview", "revised_code": {"commit": "57f30e3df348086aa9a0525638f8145206c2431c", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\nindex f1ef209ae52..da044043366 100644\n--- a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n+++ b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n\n@@ -61,7 +61,7 @@ public void setup() throws Exception {\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n     // instantiate an S3A FS here here to force deprecated key load through the\n-    // static initializers. See: HADOOP-17835\n+    // static initializers. See: HADOOP-17385\n     new S3AFileSystem();\n     super.setup();\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQxMzA5MA==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r527413090", "bodyText": "typo: two here.", "author": "mukund-thakur", "createdAt": "2020-11-20T05:31:41Z", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java", "diffHunk": "@@ -60,6 +60,9 @@ public void setup() throws Exception {\n     // filesystems which add default configuration resources to do it before\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n+    // instantiate an S3A FS here here to force deprecated key load through the", "originalCommit": "ebd8242f9b2068b4dd81d4e310db6eee67e31737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwNDY4MA==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r527604680", "bodyText": "thx", "author": "steveloughran", "createdAt": "2020-11-20T10:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQxMzA5MA=="}], "type": "inlineReview", "revised_code": {"commit": "57f30e3df348086aa9a0525638f8145206c2431c", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\nindex f1ef209ae52..da044043366 100644\n--- a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n+++ b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n\n@@ -61,7 +61,7 @@ public void setup() throws Exception {\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n     // instantiate an S3A FS here here to force deprecated key load through the\n-    // static initializers. See: HADOOP-17835\n+    // static initializers. See: HADOOP-17385\n     new S3AFileSystem();\n     super.setup();\n   }\n"}}, {"oid": "54c1cd31c2ca02c2073c3de4bad503aab8b209f3", "url": "https://github.com/apache/hadoop/commit/54c1cd31c2ca02c2073c3de4bad503aab8b209f3", "message": "HADOOP-17385. ITestS3ADeleteCost.testDirMarkersFileCreation failure\n\nThe addition of deprecated S3A configuration options in HADOOP-17318\ntriggered a reload of default (xml resource) configurations, which breaks\ntests which fail if there's a per-bucket setting inconsistent with test\nsetup.\n\nCreating an S3AFS instance before creating the Configuration() instance\nfor test runs gets that reload out the way before test setup takes\nplace.\n\nAlong with the fix, extra changes in the failing test suite to fail\nfast when marker policy isn't as expected, and to log FS state better.\n\nChange-Id: I9f58cf0d42c5ac98962b4a9fed9f3ff93ef182ac", "committedDate": "2020-11-23T14:45:53Z", "type": "commit"}, {"oid": "5da48dd42332e5edf62b6884297d7245779f0ce8", "url": "https://github.com/apache/hadoop/commit/5da48dd42332e5edf62b6884297d7245779f0ce8", "message": "HADOOP-17385. fix import\n\nChange-Id: Ic48f762aea7552ec1d204298326ad3f2c2b749ea", "committedDate": "2020-11-23T14:45:53Z", "type": "commit"}, {"oid": "57f30e3df348086aa9a0525638f8145206c2431c", "url": "https://github.com/apache/hadoop/commit/57f30e3df348086aa9a0525638f8145206c2431c", "message": "HADOOP-17385. ITestS3ADeleteCost -fix nits.\n\n+Rebase to trunk to get rid of the license warnings\n\nChange-Id: I679ea2711ce832700ef4aae0ce16008483ff40bc", "committedDate": "2020-11-23T15:31:18Z", "type": "commit"}, {"oid": "57f30e3df348086aa9a0525638f8145206c2431c", "url": "https://github.com/apache/hadoop/commit/57f30e3df348086aa9a0525638f8145206c2431c", "message": "HADOOP-17385. ITestS3ADeleteCost -fix nits.\n\n+Rebase to trunk to get rid of the license warnings\n\nChange-Id: I679ea2711ce832700ef4aae0ce16008483ff40bc", "committedDate": "2020-11-23T15:31:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NjU5Mg==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r530276592", "bodyText": "I think it would be cleaner if we could run the static initializers instead of creating an object without storing the reference. I know that there's a comment there stating that this is required because of a jira, but I don't see the point why would we create an object just to trigger side effects.", "author": "bgaborg", "createdAt": "2020-11-25T10:45:40Z", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java", "diffHunk": "@@ -60,6 +60,9 @@ public void setup() throws Exception {\n     // filesystems which add default configuration resources to do it before\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n+    // instantiate an S3A FS here here to force deprecated key load through the\n+    // static initializers. See: HADOOP-17385\n+    new S3AFileSystem();", "originalCommit": "57f30e3df348086aa9a0525638f8145206c2431c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MDc1MQ==", "url": "https://github.com/apache/hadoop/pull/2473#discussion_r530360751", "bodyText": "I was about to say I don't know a way to trigger instantiation of static class initializers except by a new() call, but actually we can invoke any static method. How about I add a new static initializeClass() call and load it.\nFWIW, what I'd really like is to be able to disable forced reload of configs, but I can't see a way to do that which wouldn't run the risk of damage", "author": "steveloughran", "createdAt": "2020-11-25T13:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3NjU5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "36524ff183243c976682134aa947e75f0be4e450", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\nindex da044043366..73a503ace49 100644\n--- a/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n+++ b/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java\n\n@@ -60,9 +60,9 @@ public void setup() throws Exception {\n     // filesystems which add default configuration resources to do it before\n     // our tests start adding/removing options. See HADOOP-16626.\n     FileSystem.getLocal(new Configuration());\n-    // instantiate an S3A FS here here to force deprecated key load through the\n+    // Force deprecated key load through the\n     // static initializers. See: HADOOP-17385\n-    new S3AFileSystem();\n+    S3AFileSystem.initializeClass();\n     super.setup();\n   }\n \n"}}, {"oid": "36524ff183243c976682134aa947e75f0be4e450", "url": "https://github.com/apache/hadoop/commit/36524ff183243c976682134aa947e75f0be4e450", "message": "HADOOP-17385. Add and use explicit S3AFileSystem.initializeClass()\n\nRather than create and discard an instance, add a new static method\nto S3AFS and invoke it in test setup. This forces the load\n\nChange-Id: Id52b1c46912c6fedd2ae270e2b1eb2222a360329", "committedDate": "2020-11-25T13:30:40Z", "type": "commit"}]}