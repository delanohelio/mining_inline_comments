{"pr_number": 2148, "pr_title": "HADOOP-17131. Refactor S3A Listing code for better isolation.", "pr_createdAt": "2020-07-16T12:32:06Z", "pr_url": "https://github.com/apache/hadoop/pull/2148", "timeline": [{"oid": "315aa43153eade6bba44288b493b843d4dbf7540", "url": "https://github.com/apache/hadoop/commit/315aa43153eade6bba44288b493b843d4dbf7540", "message": "HADOOP-17131 Moving listing to use operation callback", "committedDate": "2020-07-16T09:51:13Z", "type": "commit"}, {"oid": "3a70b6507650f63fb7e5f5330283a4018c68a5ec", "url": "https://github.com/apache/hadoop/commit/3a70b6507650f63fb7e5f5330283a4018c68a5ec", "message": "Moving listing methods to Listing class for better abstraction", "committedDate": "2020-07-17T09:38:45Z", "type": "commit"}, {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "url": "https://github.com/apache/hadoop/commit/bda8f84040fd81aa54485441d40b108f8e46d6ed", "message": "Adding ListingOperationCallbacks interface for list ops", "committedDate": "2020-07-20T14:49:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NDE1NQ==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462484155", "bodyText": "not true any more though, not now there's a new listing interface, right?", "author": "steveloughran", "createdAt": "2020-07-29T17:57:55Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java", "diffHunk": "@@ -40,7 +40,8 @@\n import org.apache.hadoop.fs.s3a.s3guard.BulkOperationState;\n \n /**\n- * These are all the callbacks which the {@link RenameOperation}\n+ * These are all the callbacks which the {@link RenameOperation},", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0MjI2NA==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462842264", "bodyText": "Ah.. I updated the doc in the start. Will fix. Thanks", "author": "mukund-thakur", "createdAt": "2020-07-30T08:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NDE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java\nindex b8cdd88975a..0fcf6454c11 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java\n\n@@ -40,8 +40,7 @@\n import org.apache.hadoop.fs.s3a.s3guard.BulkOperationState;\n \n /**\n- * These are all the callbacks which the {@link RenameOperation},\n- * {@link org.apache.hadoop.fs.s3a.Listing }\n+ * These are all the callbacks which the {@link RenameOperation}\n  * and {@link DeleteOperation } operations need,\n  * derived from the appropriate S3AFileSystem methods.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NTEzNA==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462485134", "bodyText": "I'd rather these were left out of the context and only explicitly passed to those classes which explicitly needed the operations. That helps us stay in control of what operations specific modules can perform", "author": "steveloughran", "createdAt": "2020-07-29T17:59:36Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java", "diffHunk": "@@ -116,6 +116,16 @@\n    */\n   private ITtlTimeProvider timeProvider;\n \n+  /**", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java\nindex eec0b52630b..cafa22fdec8 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java\n\n@@ -116,16 +116,6 @@\n    */\n   private ITtlTimeProvider timeProvider;\n \n-  /**\n-   * Specific operations used by rename, delete operations.\n-   */\n-  private OperationCallbacks operationCallbacks;\n-\n-  /**\n-   * Specific operations used by list operations.\n-   */\n-  private ListingOperationCallbacks listingOperationCallbacks;\n-\n   /**\n    * Instantiate.\n    * @deprecated as public method: use {@link StoreContextBuilder}.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NjI2MA==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462486260", "bodyText": "have this take the context and the ListingOperationCallbacks, add a method in S3AFS createListing() which can be used there and in DumpS3GuardDynamoTable...that avoids having to extend the store context", "author": "steveloughran", "createdAt": "2020-07-29T18:01:24Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "diffHunk": "@@ -46,25 +56,27 @@\n import java.util.Set;\n \n import static org.apache.hadoop.fs.s3a.Constants.S3N_FOLDER_SUFFIX;\n+import static org.apache.hadoop.fs.s3a.S3AUtils.ACCEPT_ALL;\n import static org.apache.hadoop.fs.s3a.S3AUtils.createFileStatus;\n+import static org.apache.hadoop.fs.s3a.S3AUtils.maybeAddTrailingSlash;\n import static org.apache.hadoop.fs.s3a.S3AUtils.objectRepresentsDirectory;\n import static org.apache.hadoop.fs.s3a.S3AUtils.stringify;\n import static org.apache.hadoop.fs.s3a.S3AUtils.translateException;\n+import static org.apache.hadoop.fs.s3a.auth.RoleModel.pathToKey;\n \n /**\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing {\n+public class Listing extends AbstractStoreOperation {\n \n-  private final S3AFileSystem owner;\n   private static final Logger LOG = S3AFileSystem.LOG;\n \n   static final FileStatusAcceptor ACCEPT_ALL_BUT_S3N =\n       new AcceptAllButS3nDirs();\n \n-  public Listing(S3AFileSystem owner) {\n-    this.owner = owner;\n+  public Listing(StoreContext storeContext) {", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\nindex 6a89e7fef1d..920a336d3e9 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\n\n@@ -68,15 +68,21 @@\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing extends AbstractStoreOperation {\n+public class Listing {\n \n   private static final Logger LOG = S3AFileSystem.LOG;\n \n   static final FileStatusAcceptor ACCEPT_ALL_BUT_S3N =\n       new AcceptAllButS3nDirs();\n \n-  public Listing(StoreContext storeContext) {\n-    super(storeContext);\n+  private final ListingOperationCallbacks listingOperationCallbacks;\n+\n+  private final StoreContext storeContext;\n+\n+  public Listing(ListingOperationCallbacks listingOperationCallbacks,\n+                 StoreContext storeContext) {\n+    this.listingOperationCallbacks = listingOperationCallbacks;\n+    this.storeContext = storeContext;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NzEzOQ==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462487139", "bodyText": "Make the type of this field the interface for strictness", "author": "steveloughran", "createdAt": "2020-07-29T18:02:59Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -293,6 +294,9 @@\n   private final S3AFileSystem.OperationCallbacksImpl\n       operationCallbacks = new OperationCallbacksImpl();\n \n+  private final S3AFileSystem.ListingOperationCallbacksImpl", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\nindex 5d6ddb26eb6..0f82192f6be 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n\n@@ -294,8 +293,8 @@\n   private final S3AFileSystem.OperationCallbacksImpl\n       operationCallbacks = new OperationCallbacksImpl();\n \n-  private final S3AFileSystem.ListingOperationCallbacksImpl\n-      listingOperationCallbacks = new ListingOperationCallbacksImpl();\n+  private final ListingOperationCallbacks listingOperationCallbacks =\n+          new ListingOperationCallbacksImpl();\n \n   /** Add any deprecated keys. */\n   @SuppressWarnings(\"deprecation\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NzYyMA==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462487620", "bodyText": "nice touch", "author": "steveloughran", "createdAt": "2020-07-29T18:03:53Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -1599,6 +1603,36 @@ public boolean allowAuthoritative(final Path p) {\n     }\n   }\n \n+  protected class ListingOperationCallbacksImpl implements ListingOperationCallbacks {\n+\n+    @Override\n+    @Retries.RetryRaw\n+    public S3ListResult listObjects(\n+            S3ListRequest request)\n+            throws IOException {\n+      return S3AFileSystem.this.listObjects(request);\n+    }\n+\n+    @Override\n+    @Retries.RetryRaw", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\nindex 5d6ddb26eb6..0f82192f6be 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n\n@@ -1631,6 +1638,26 @@ public S3ALocatedFileStatus toLocatedFileStatus(S3AFileStatus status) throws IOE\n     public S3ListRequest createListObjectsRequest(String key, String delimiter) {\n       return S3AFileSystem.this.createListObjectsRequest(key, delimiter);\n     }\n+\n+    @Override\n+    public long getDefaultBlockSize(Path path) {\n+      return S3AFileSystem.this.getDefaultBlockSize(path);\n+    }\n+\n+    @Override\n+    public int getMaxKeys() {\n+      return S3AFileSystem.this.getMaxKeys();\n+    }\n+\n+    @Override\n+    public ITtlTimeProvider getUpdatedTtlTimeProvider() {\n+      return S3AFileSystem.this.ttlTimeProvider;\n+    }\n+\n+    @Override\n+    public boolean allowAuthoritative(final Path p) {\n+      return S3AFileSystem.this.allowAuthoritative(p);\n+    }\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4ODI1Mw==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462488253", "bodyText": "Add to the ListingOperationCallbacks", "author": "steveloughran", "createdAt": "2020-07-29T18:04:58Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -4847,5 +4800,20 @@ public String getBucketLocation() throws IOException {\n     public Path makeQualified(final Path path) {\n       return S3AFileSystem.this.makeQualified(path);\n     }\n+", "originalCommit": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0MTEyNg==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462841126", "bodyText": "Felt like below three methods are generic for context so I added here such that if required in future it can be used by other operations as well. I think the reason you are saying to add in ListingOperationCallbacks is because these are currently only used in Listing Operations.\nI can put in Listing as well.", "author": "mukund-thakur", "createdAt": "2020-07-30T08:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4ODI1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\nindex 5d6ddb26eb6..0f82192f6be 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java\n\n@@ -4801,19 +4826,5 @@ public Path makeQualified(final Path path) {\n       return S3AFileSystem.this.makeQualified(path);\n     }\n \n-    @Override\n-    public long getDefaultBlockSize(Path path) {\n-      return S3AFileSystem.this.getDefaultBlockSize(path);\n-    }\n-\n-    @Override\n-    public int getMaxKeys() {\n-      return S3AFileSystem.this.getMaxKeys();\n-    }\n-\n-    @Override\n-    public ITtlTimeProvider getUpdatedTtlTimeProvider() {\n-      return S3AFileSystem.this.ttlTimeProvider;\n-    }\n   }\n }\n"}}, {"oid": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "url": "https://github.com/apache/hadoop/commit/cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "message": "Review comments", "committedDate": "2020-07-31T13:59:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1NDMyMQ==", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r463954321", "bodyText": "I'd keep it as a subclass of AbstractStoreOperation.\nwe may want to declare it as Closeable, and in tests and S3AFS call close()/closeQuietly() on it. Gives us the option of doing more with it later\n\nWhat I don't want -and which you have done in this commit, is add the new list commands into the OperationCallbacks interface", "author": "steveloughran", "createdAt": "2020-08-01T11:44:45Z", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "diffHunk": "@@ -68,15 +68,21 @@\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing extends AbstractStoreOperation {\n+public class Listing {", "originalCommit": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2d5b331e8911ebc171bfa1bce163d04830b7fce4", "chunk": "diff --git a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\nindex 920a336d3e9..fcb492857e6 100644\n--- a/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\n+++ b/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java\n\n@@ -68,7 +69,7 @@\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing {\n+public class Listing extends AbstractStoreOperation {\n \n   private static final Logger LOG = S3AFileSystem.LOG;\n \n"}}, {"oid": "2d5b331e8911ebc171bfa1bce163d04830b7fce4", "url": "https://github.com/apache/hadoop/commit/2d5b331e8911ebc171bfa1bce163d04830b7fce4", "message": "Final touch and checkstyle", "committedDate": "2020-08-03T08:18:22Z", "type": "commit"}, {"oid": "d625e94dad30bb2d38909d7e60cfc82c84b37e07", "url": "https://github.com/apache/hadoop/commit/d625e94dad30bb2d38909d7e60cfc82c84b37e07", "message": "license and findbugs", "committedDate": "2020-08-04T07:29:50Z", "type": "commit"}]}