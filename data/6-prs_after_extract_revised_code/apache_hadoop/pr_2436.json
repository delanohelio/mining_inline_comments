{"pr_number": 2436, "pr_title": "HADOOP-17358. Improve excessive reloading of Configurations", "pr_createdAt": "2020-11-04T21:28:23Z", "pr_url": "https://github.com/apache/hadoop/pull/2436", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MDA4MQ==", "url": "https://github.com/apache/hadoop/pull/2436#discussion_r518270081", "bodyText": "I would really appreciate if you rewrite this so it doesn't use -1 as startIdx. A year from now I won't remember why we want to load from position -1.", "author": "jojochuang", "createdAt": "2020-11-05T18:26:08Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java", "diffHunk": "@@ -2876,10 +2876,17 @@ public Reader getConfResourceAsReader(String name) {\n   protected synchronized Properties getProps() {\n     if (properties == null) {\n       properties = new Properties();\n+      loadProps(properties, -1);", "originalCommit": "cd816f3fd4fc2c3e16f219928d8d245c8123e602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3ODA3Mg==", "url": "https://github.com/apache/hadoop/pull/2436#discussion_r518278072", "bodyText": "Good point @jojochuang .I will think about something. or maybe addd a comment.", "author": "amahussein", "createdAt": "2020-11-05T18:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MDA4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d6e55262424634531a5256e717e9b1e1d44ad2f8", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\nindex 1e14a0401da..3c4d41797fc 100755\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n\n@@ -2876,19 +2876,28 @@ public Reader getConfResourceAsReader(String name) {\n   protected synchronized Properties getProps() {\n     if (properties == null) {\n       properties = new Properties();\n-      loadProps(properties, -1);\n+      loadProps(properties, 0, true);\n     }\n     return properties;\n   }\n \n-  private synchronized Properties loadProps(Properties properties,\n-      int startIdx) {\n-    if (properties != null) {\n-      Map<String, String[]> backup = updatingResource != null ?\n-          new ConcurrentHashMap<String, String[]>(updatingResource) : null;\n-      loadResources(properties, resources, startIdx, quietmode);\n+  /**\n+   * Loads the resource at a given index into the properties.\n+   * @param props the object containing the loaded properties.\n+   * @param startIdx the index where the new resource has been added.\n+   * @param fullReload flag whether we do complete reload of the conf instead\n+   *                   of just loading the new resource.\n+   * @return the properties loaded from the resource.\n+   */\n+  private synchronized Properties loadProps(final Properties props,\n+      final int startIdx, final boolean fullReload) {\n+    if (props != null) {\n+      Map<String, String[]> backup =\n+          updatingResource != null\n+              ? new ConcurrentHashMap<>(updatingResource) : null;\n+      loadResources(props, resources, startIdx, fullReload, quietmode);\n       if (overlay != null) {\n-        properties.putAll(overlay);\n+        props.putAll(overlay);\n         if (backup != null) {\n           for (Map.Entry<Object, Object> item : overlay.entrySet()) {\n             String key = (String) item.getKey();\n"}}, {"oid": "d6e55262424634531a5256e717e9b1e1d44ad2f8", "url": "https://github.com/apache/hadoop/commit/d6e55262424634531a5256e717e9b1e1d44ad2f8", "message": "HADOOP-17358. Improve excessive reloading of Configurations", "committedDate": "2020-11-05T19:19:36Z", "type": "commit"}, {"oid": "d6e55262424634531a5256e717e9b1e1d44ad2f8", "url": "https://github.com/apache/hadoop/commit/d6e55262424634531a5256e717e9b1e1d44ad2f8", "message": "HADOOP-17358. Improve excessive reloading of Configurations", "committedDate": "2020-11-05T19:19:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyNzg5MA==", "url": "https://github.com/apache/hadoop/pull/2436#discussion_r520727890", "bodyText": "(I thought I posted a comment here, but somehow it got lost in github comments)\nreturning this object isn't necessary, and obviously the callers don't use the return value.", "author": "jojochuang", "createdAt": "2020-11-10T17:09:40Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java", "diffHunk": "@@ -2893,7 +2909,7 @@ protected synchronized Properties getProps() {\n         }\n       }\n     }\n-    return properties;\n+    return props;", "originalCommit": "d6e55262424634531a5256e717e9b1e1d44ad2f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d3087c2c1956f5eba6dc2cca26e4cfa93fa4b2d2", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\nindex 3c4d41797fc..4d4c58d188e 100755\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n\n@@ -2909,7 +2909,6 @@ private synchronized Properties loadProps(final Properties props,\n         }\n       }\n     }\n-    return props;\n   }\n \n   /**\n"}}, {"oid": "d3087c2c1956f5eba6dc2cca26e4cfa93fa4b2d2", "url": "https://github.com/apache/hadoop/commit/d3087c2c1956f5eba6dc2cca26e4cfa93fa4b2d2", "message": "HADOOP-17358. address reviews", "committedDate": "2020-11-10T20:57:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NzYzMg==", "url": "https://github.com/apache/hadoop/pull/2436#discussion_r520947632", "bodyText": "Could you also remove this @return? I am +1 once this is updated.", "author": "jojochuang", "createdAt": "2020-11-10T23:50:37Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java", "diffHunk": "@@ -2876,12 +2876,28 @@ public Reader getConfResourceAsReader(String name) {\n   protected synchronized Properties getProps() {\n     if (properties == null) {\n       properties = new Properties();\n-      Map<String, String[]> backup = updatingResource != null ?\n-          new ConcurrentHashMap<String, String[]>(updatingResource) : null;\n-      loadResources(properties, resources, quietmode);\n+      loadProps(properties, 0, true);\n+    }\n+    return properties;\n+  }\n \n+  /**\n+   * Loads the resource at a given index into the properties.\n+   * @param props the object containing the loaded properties.\n+   * @param startIdx the index where the new resource has been added.\n+   * @param fullReload flag whether we do complete reload of the conf instead\n+   *                   of just loading the new resource.\n+   * @return the properties loaded from the resource.", "originalCommit": "d3087c2c1956f5eba6dc2cca26e4cfa93fa4b2d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0OTU2Mw==", "url": "https://github.com/apache/hadoop/pull/2436#discussion_r520949563", "bodyText": "Sorry . I overlooked that.\nI added a new commit.", "author": "amahussein", "createdAt": "2020-11-10T23:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NzYzMg=="}], "type": "inlineReview", "revised_code": {"commit": "3b5256509a0894779d2b7b09f86aa64431538900", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\nindex 4d4c58d188e..e0e7ac39604 100755\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java\n\n@@ -2887,7 +2887,6 @@ protected synchronized Properties getProps() {\n    * @param startIdx the index where the new resource has been added.\n    * @param fullReload flag whether we do complete reload of the conf instead\n    *                   of just loading the new resource.\n-   * @return the properties loaded from the resource.\n    */\n   private synchronized void loadProps(final Properties props,\n       final int startIdx, final boolean fullReload) {\n"}}, {"oid": "3b5256509a0894779d2b7b09f86aa64431538900", "url": "https://github.com/apache/hadoop/commit/3b5256509a0894779d2b7b09f86aa64431538900", "message": "HADOOP-1353. remove return from javadoc", "committedDate": "2020-11-10T23:54:55Z", "type": "commit"}]}