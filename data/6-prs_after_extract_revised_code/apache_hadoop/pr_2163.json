{"pr_number": 2163, "pr_title": "HDFS-15480. Ordered snapshot deletion: record snapshot deletion in XAttr", "pr_createdAt": "2020-07-21T10:21:22Z", "pr_url": "https://github.com/apache/hadoop/pull/2163", "timeline": [{"oid": "cba7c00c3fc82991815228122718fd55d9cc5a13", "url": "https://github.com/apache/hadoop/commit/cba7c00c3fc82991815228122718fd55d9cc5a13", "message": "HDFS-15480. Ordered snapshot deletion: record snapshot deletion in XAttr.", "committedDate": "2020-07-21T10:18:17Z", "type": "commit"}, {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1", "url": "https://github.com/apache/hadoop/commit/f7dfa8dc5ba55eecf59862c867812234112589e1", "message": "Addressed review comments.", "committedDate": "2020-07-21T11:09:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIwNDgyNQ==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458204825", "bodyText": "Expand the wildcard imports", "author": "mukul1987", "createdAt": "2020-07-21T15:52:02Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -41,10 +41,7 @@\n import java.util.List;\n import java.util.ListIterator;\n \n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_ENCRYPTION_ZONE;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SECURITY_XATTR_UNREADABLE_BY_SUPERUSER;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.XATTR_SATISFY_STORAGE_POLICY;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_FILE_ENCRYPTION_INFO;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.*;", "originalCommit": "f7dfa8dc5ba55eecf59862c867812234112589e1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4f2efde88eade660d22c4dee3b6038d63f9870aa", "chunk": "diff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\nindex 082b0329d79..dc3d000480f 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\n\n@@ -41,7 +41,11 @@\n import java.util.List;\n import java.util.ListIterator;\n \n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.*;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SECURITY_XATTR_UNREADABLE_BY_SUPERUSER;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.XATTR_SATISFY_STORAGE_POLICY;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_FILE_ENCRYPTION_INFO;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SNAPSHOT_XATTR_NAME;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_ENCRYPTION_ZONE;\n \n class FSDirXAttrOp {\n   private static final XAttr KEYID_XATTR =\n"}}, {"oid": "4f2efde88eade660d22c4dee3b6038d63f9870aa", "url": "https://github.com/apache/hadoop/commit/4f2efde88eade660d22c4dee3b6038d63f9870aa", "message": "Addressed checkstyle and review comments.", "committedDate": "2020-07-21T17:05:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MTkyOA==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458261928", "bodyText": "We cannot return null since it will skip the fsd.getEditLog().logDeleteSnapshot(..).", "author": "szetszwo", "createdAt": "2020-07-21T17:19:14Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java", "diffHunk": "@@ -263,11 +269,18 @@ static SnapshotDiffReportListing getSnapshotDiffReportListing(FSDirectory fsd,\n       final int earliest = snapshottable.getDiffs().iterator().next()\n           .getSnapshotId();\n       if (snapshot.getId() != earliest) {\n-        throw new SnapshotException(\"Failed to delete snapshot \" + snapshotName\n-            + \" from directory \" + srcRoot.getFullPathName()\n-            + \": \" + snapshot + \" is not the earliest snapshot id=\" + earliest\n-            + \" (\" + DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED\n-            + \" is \" + fsd.isSnapshotDeletionOrdered() + \")\");\n+        final XAttr snapshotXAttr = buildXAttr(snapshotName);\n+        final List<XAttr> xattrs = Lists.newArrayListWithCapacity(1);\n+        xattrs.add(snapshotXAttr);\n+\n+        // The snapshot to be deleted is just marked for deletion in the xAttr.\n+        // Same snaphot delete call can happen multiple times until annd unless\n+        // the very 1st instance of a snapshot delete hides it/remove it from\n+        // snapshot list. XAttrSetFlag.REPLACE needs to be set to here in order\n+        // to address this.\n+        FSDirXAttrOp.unprotectedSetXAttrs(fsd, iip, xattrs,\n+            EnumSet.of(XAttrSetFlag.CREATE, XAttrSetFlag.REPLACE));\n+        return null;", "originalCommit": "f7dfa8dc5ba55eecf59862c867812234112589e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU3MTk3Mw==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458571973", "bodyText": "Addressed in the current patch.", "author": "bshashikant", "createdAt": "2020-07-22T06:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MTkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "chunk": "diff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java\nindex f101a72f287..2b772bfe8ba 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java\n\n@@ -269,7 +269,7 @@ static SnapshotDiffReportListing getSnapshotDiffReportListing(FSDirectory fsd,\n       final int earliest = snapshottable.getDiffs().iterator().next()\n           .getSnapshotId();\n       if (snapshot.getId() != earliest) {\n-        final XAttr snapshotXAttr = buildXAttr(snapshotName);\n+        final XAttr snapshotXAttr = buildXAttr();\n         final List<XAttr> xattrs = Lists.newArrayListWithCapacity(1);\n         xattrs.add(snapshotXAttr);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDE3MQ==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458264171", "bodyText": "To be consistent with SECURITY_XATTR_UNREADABLE_BY_SUPERUSER, should we throw IOException?", "author": "szetszwo", "createdAt": "2020-07-21T17:22:54Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -326,6 +323,11 @@ static INode unprotectedSetXAttrs(\n         throw new IOException(\"Can only set '\" +\n             SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + \"' on a file.\");\n       }\n+\n+      if (xaName.contains(SNAPSHOT_XATTR_NAME)) {\n+        Preconditions.checkArgument(inode.isDirectory() &&", "originalCommit": "f7dfa8dc5ba55eecf59862c867812234112589e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU3MTg2MQ==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458571861", "bodyText": "Addressed in the current patch.", "author": "bshashikant", "createdAt": "2020-07-22T06:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDE3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "chunk": "diff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\nindex 082b0329d79..2ed8207c602 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java\n\n@@ -324,9 +328,10 @@ static INode unprotectedSetXAttrs(\n             SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + \"' on a file.\");\n       }\n \n-      if (xaName.contains(SNAPSHOT_XATTR_NAME)) {\n-        Preconditions.checkArgument(inode.isDirectory() &&\n-            inode.asDirectory().isSnapshottable());\n+      if (xaName.equals(SNAPSHOT_XATTR_NAME) && !(inode.isDirectory() &&\n+          inode.getParent().isSnapshottable())) {\n+        throw new IOException(\"Can only set '\" +\n+            SNAPSHOT_XATTR_NAME + \"' on a snapshot root.\");\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDU1OA==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458264558", "bodyText": "Why removing the check?", "author": "szetszwo", "createdAt": "2020-07-21T17:23:32Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java", "diffHunk": "@@ -359,14 +359,6 @@ public int getListLimit() {\n             DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED_DEFAULT);\n     LOG.info(\"{} = {}\", DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED,\n         snapshotDeletionOrdered);\n-    if (snapshotDeletionOrdered && !xattrsEnabled) {", "originalCommit": "f7dfa8dc5ba55eecf59862c867812234112589e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU3MTY4MQ==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458571681", "bodyText": "Not required as xattrsEnabled flag is only for user enabled XAttrs. Added a unit test to verify this as well.", "author": "bshashikant", "createdAt": "2020-07-22T06:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDU1OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "url": "https://github.com/apache/hadoop/commit/e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "message": "Addressed review comments.", "committedDate": "2020-07-22T06:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNzk3MA==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458707970", "bodyText": "lets set the xattrs to be disabled in this unit test ?", "author": "mukul1987", "createdAt": "2020-07-22T10:56:07Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestOrderedSnapshotDeletion.java", "diffHunk": "@@ -67,7 +70,7 @@ public void tearDown() throws Exception {\n     }\n   }\n \n-  @Test (timeout=60000)\n+  @Test(timeout = 60000)", "originalCommit": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwODk4Mw==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458708983", "bodyText": "My bad, didn't see that there is  test already.", "author": "mukul1987", "createdAt": "2020-07-22T10:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNzk3MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad", "url": "https://github.com/apache/hadoop/commit/918026c2bc484e37770802e8ed2ccb922aa75aad", "message": "Addressed checkstyle and findbug issues.", "committedDate": "2020-07-22T16:12:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTI1MA==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458951250", "bodyText": "The xattr name should contain \"deleted\".  How about \"system.hdfs.snapshot.deleted\"?", "author": "szetszwo", "createdAt": "2020-07-22T17:11:26Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java", "diffHunk": "@@ -366,6 +366,7 @@ public void write(DataOutput out) throws IOException {\n       \"security.hdfs.unreadable.by.superuser\";\n   String XATTR_ERASURECODING_POLICY =\n       \"system.hdfs.erasurecoding.policy\";\n+  String SNAPSHOT_XATTR_NAME = \"system.hdfs.snapshot\";", "originalCommit": "918026c2bc484e37770802e8ed2ccb922aa75aad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7613161ac163a2ff441a3909b01845a7e4723ae8", "chunk": "diff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java\nindex b881fa16d17..a55985edffc 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java\n\n@@ -366,7 +366,7 @@ public void write(DataOutput out) throws IOException {\n       \"security.hdfs.unreadable.by.superuser\";\n   String XATTR_ERASURECODING_POLICY =\n       \"system.hdfs.erasurecoding.policy\";\n-  String SNAPSHOT_XATTR_NAME = \"system.hdfs.snapshot\";\n+  String SNAPSHOT_XATTR_NAME = \"system.hdfs.snapshot.deleted\";\n \n   String XATTR_SATISFY_STORAGE_POLICY = \"user.hdfs.sps\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MzExOA==", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458953118", "bodyText": "Let's check \"!(inode instanceof of Snapshot.Root)\" instead of \"!(inode.isDirectory() && inode.getParent().isSnapshottable())?", "author": "szetszwo", "createdAt": "2020-07-22T17:14:35Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -326,6 +327,12 @@ static INode unprotectedSetXAttrs(\n         throw new IOException(\"Can only set '\" +\n             SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + \"' on a file.\");\n       }\n+\n+      if (xaName.equals(SNAPSHOT_XATTR_NAME) && !(inode.isDirectory() &&", "originalCommit": "918026c2bc484e37770802e8ed2ccb922aa75aad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "7613161ac163a2ff441a3909b01845a7e4723ae8", "url": "https://github.com/apache/hadoop/commit/7613161ac163a2ff441a3909b01845a7e4723ae8", "message": "Fixed a bug while replaying edits and addressed review comments.", "committedDate": "2020-07-22T19:30:18Z", "type": "commit"}]}