{"pr_number": 2178, "pr_title": "HADOOP-17164. UGI loginUserFromKeytab doesn't set the last login time", "pr_createdAt": "2020-07-30T08:38:43Z", "pr_url": "https://github.com/apache/hadoop/pull/2178", "timeline": [{"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5", "url": "https://github.com/apache/hadoop/commit/31386063d9935c058ba4812e7e2c88f44c42f4d5", "message": "HADOOP-17164 UGI loginUserFromKeytab doesn't set the last login time", "committedDate": "2020-07-30T08:37:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDc2Nw==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463230767", "bodyText": "error text should include the values at fault, so we can debug better from nothing but a junit report", "author": "steveloughran", "createdAt": "2020-07-30T19:46:02Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -100,13 +101,34 @@ public void stopMiniKdc() {\n       executor.shutdownNow();\n     }\n   }\n+  \n+  /**\n+   * Login from keytab using the MiniKDC\n+   */\n+  @Test\n+  public void testUGILoginFromKeytab() throws Exception {\n+    long beforeLogin = Time.now();\n+    String principal = \"foo\";\n+    File keytab = new File(workDir, \"foo.keytab\");\n+    kdc.createPrincipal(keytab, principal);\n+\n+    UserGroupInformation.loginUserFromKeytab(principal, keytab.getPath());\n+    UserGroupInformation ugi = UserGroupInformation.getLoginUser();\n+    Assert.assertTrue(\"UGI should be configured to login from keytab\",\n+        ugi.isFromKeytab());\n+\n+    User user = getUser(ugi.getSubject());\n+    Assert.assertNotNull(user.getLogin());\n+    Assert.assertTrue(\"User last login time is not set correctly\",", "originalCommit": "31386063d9935c058ba4812e7e2c88f44c42f4d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTE1MA==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345150", "bodyText": "Agreed, updated the code", "author": "sguggilam", "createdAt": "2020-07-31T00:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDc2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java b/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\nindex b3d716ae2ce..1dddd778e1e 100644\n--- a/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\n+++ b/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\n\n@@ -119,7 +119,9 @@ public void testUGILoginFromKeytab() throws Exception {\n \n     User user = getUser(ugi.getSubject());\n     Assert.assertNotNull(user.getLogin());\n-    Assert.assertTrue(\"User last login time is not set correctly\",\n+ \n+    Assert.assertTrue(\"User login time is less than before login time, \"\n+        + \"beforeLoginTime:\" + beforeLogin + \" userLoginTime:\" + user.getLastLogin(),\n \t    user.getLastLogin() > beforeLogin);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTcyOQ==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463231729", "bodyText": "if you really want >1s of interval, make it a 2s, delay. There's too much risk of clock/sleep granularity issues", "author": "steveloughran", "createdAt": "2020-07-30T19:47:44Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -121,6 +143,9 @@ public void testUGILoginFromKeytab() throws Exception {\n     final long firstLogin = user.getLastLogin();\n     final LoginContext login1 = user.getLogin();\n     Assert.assertNotNull(login1);\n+    \n+    // Sleep for 1 sec to have a difference between first and second login\n+    Thread.sleep(1000);", "originalCommit": "31386063d9935c058ba4812e7e2c88f44c42f4d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTE4NA==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345184", "bodyText": "Makes sense, changed it to 2 sec", "author": "sguggilam", "createdAt": "2020-07-31T00:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java b/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\nindex b3d716ae2ce..1dddd778e1e 100644\n--- a/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\n+++ b/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java\n\n@@ -143,9 +145,9 @@ public void testUGIReLoginFromKeytab() throws Exception {\n     final long firstLogin = user.getLastLogin();\n     final LoginContext login1 = user.getLogin();\n     Assert.assertNotNull(login1);\n-    \n-    // Sleep for 1 sec to have a difference between first and second login\n-    Thread.sleep(1000);\n+\n+    // Sleep for 2 secs to have a difference between first and second login\n+    Thread.sleep(2000);\n \n     ugi.reloginFromKeytab();\n     final long secondLogin = user.getLastLogin();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463232170", "bodyText": "add javadoc, note unit of time. Milliseconds, right?", "author": "steveloughran", "createdAt": "2020-07-30T19:48:34Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -528,6 +528,10 @@ private HadoopLoginContext getLogin() {\n   private void setLogin(LoginContext login) {\n     user.setLogin(login);\n   }\n+  \n+  private void setLastLogin(long now) {", "originalCommit": "31386063d9935c058ba4812e7e2c88f44c42f4d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwNDA4Nw==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463304087", "bodyText": "Make @param time and long now the same variable name? e.g. name it loginTime", "author": "liuml07", "createdAt": "2020-07-30T22:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTI0OA==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345248", "bodyText": "Yes agreed, made the change", "author": "sguggilam", "createdAt": "2020-07-31T00:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA=="}], "type": "inlineReview", "revised_code": {"commit": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "chunk": "diff --git a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java\nindex cc25c99e9d6..c40fee60241 100644\n--- a/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java\n+++ b/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java\n\n@@ -529,6 +529,10 @@ private void setLogin(LoginContext login) {\n     user.setLogin(login);\n   }\n   \n+  /**\n+   * Set the last login time for logged in user\n+   * @param time the number of milliseconds since the beginning of time\n+   */\n   private void setLastLogin(long now) {\n     user.setLastLogin(now);\n   }\n"}}, {"oid": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "url": "https://github.com/apache/hadoop/commit/43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "message": "Incorporate review comments", "committedDate": "2020-07-30T20:49:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwODM2NA==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463308364", "bodyText": "the user::lastLogin was the last attempt to login. I'm not sure if we should put this before the try clause (aka before new L1969)?\nCC: @steveloughran", "author": "liuml07", "createdAt": "2020-07-30T22:32:06Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -1968,6 +1976,7 @@ private static UserGroupInformation doSubjectLogin(\n       if (subject == null) {\n         params.put(LoginParam.PRINCIPAL, ugi.getUserName());\n         ugi.setLogin(login);\n+        ugi.setLastLogin(Time.now());", "originalCommit": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMxMjc3Nw==", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463312777", "bodyText": "@liuml07 We should set this only after the login is successful right ? If we add it before the try, then we might update it even in case of unsuccessful login in which case a retry should be permitted immediately. Please let me know your thoughts", "author": "sguggilam", "createdAt": "2020-07-30T22:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwODM2NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7fb5c8f7b75208b0726b16fbdd4db13b52a19703", "url": "https://github.com/apache/hadoop/commit/7fb5c8f7b75208b0726b16fbdd4db13b52a19703", "message": "Review comments", "committedDate": "2020-07-31T00:36:18Z", "type": "commit"}]}