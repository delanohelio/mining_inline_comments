{"pr_number": 2274, "pr_title": "HDFS-15557. Log the reason why a storage log file can't be deleted", "pr_createdAt": "2020-09-03T19:12:25Z", "pr_url": "https://github.com/apache/hadoop/pull/2274", "timeline": [{"oid": "4f49e82267fa2f089e0eacebb96a2a24ed512a80", "url": "https://github.com/apache/hadoop/commit/4f49e82267fa2f089e0eacebb96a2a24ed512a80", "message": "Update AtomicFileOutputStream.java", "committedDate": "2020-09-03T19:11:34Z", "type": "commit"}, {"oid": "7acb01abcdc80bdd1caf3a8e8abe0501d11b3a5c", "url": "https://github.com/apache/hadoop/commit/7acb01abcdc80bdd1caf3a8e8abe0501d11b3a5c", "message": "Update AtomicFileOutputStream.java", "committedDate": "2020-09-03T22:23:04Z", "type": "commit"}, {"oid": "fb74537da26389bcb3a3f1dc74d50c4be378c6b3", "url": "https://github.com/apache/hadoop/commit/fb74537da26389bcb3a3f1dc74d50c4be378c6b3", "message": "Update AtomicFileOutputStream.java", "committedDate": "2020-09-04T00:31:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NzEwNQ==", "url": "https://github.com/apache/hadoop/pull/2274#discussion_r483377105", "bodyText": "Is it simpler\nthrow new IOException(\"Could not delete original file \" + origFile, e);\n\nOther than that, +1", "author": "liuml07", "createdAt": "2020-09-04T04:20:56Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/util/AtomicFileOutputStream.java", "diffHunk": "@@ -75,8 +76,13 @@ public void close() throws IOException {\n         boolean renamed = tmpFile.renameTo(origFile);\n         if (!renamed) {\n           // On windows, renameTo does not replace.\n-          if (origFile.exists() && !origFile.delete()) {\n-            throw new IOException(\"Could not delete original file \" + origFile);\n+          if (origFile.exists()) {\n+            try {\n+              Files.delete(origFile.toPath());\n+            } catch (IOException e) {\n+              throw new IOException(\"Could not delete original file \" + origFile", "originalCommit": "fb74537da26389bcb3a3f1dc74d50c4be378c6b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc5NzE1Mg==", "url": "https://github.com/apache/hadoop/pull/2274#discussion_r491797152", "bodyText": "Fixed. Thanks.", "author": "NickyYe", "createdAt": "2020-09-21T05:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NzEwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "2a247b7435d2c5c108e86c6369d9a94be17cd0df", "chunk": "diff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/util/AtomicFileOutputStream.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/util/AtomicFileOutputStream.java\nindex 7a7bac50b41..c6003e8b9a3 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/util/AtomicFileOutputStream.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/util/AtomicFileOutputStream.java\n\n@@ -80,8 +80,7 @@ public void close() throws IOException {\n             try {\n               Files.delete(origFile.toPath());\n             } catch (IOException e) {\n-              throw new IOException(\"Could not delete original file \" + origFile\n-                  + \" due to: \" + e);\n+              throw new IOException(\"Could not delete original file \" + origFile, e);\n             }\n           }\n           try {\n"}}, {"oid": "2a247b7435d2c5c108e86c6369d9a94be17cd0df", "url": "https://github.com/apache/hadoop/commit/2a247b7435d2c5c108e86c6369d9a94be17cd0df", "message": "Update AtomicFileOutputStream.java", "committedDate": "2020-09-21T05:15:42Z", "type": "commit"}]}