{"pr_number": 2568, "pr_title": "YARN-10541. capture the performance metrics of ZKRMStateStore", "pr_createdAt": "2020-12-21T08:46:25Z", "pr_url": "https://github.com/apache/hadoop/pull/2568", "timeline": [{"oid": "c70444766030f639362f09abae63be6295a1ab46", "url": "https://github.com/apache/hadoop/commit/c70444766030f639362f09abae63be6295a1ab46", "message": "add ZKRMStateStoreOpDurations & add testMetricsInited", "committedDate": "2020-12-21T08:03:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgwNDgzMA==", "url": "https://github.com/apache/hadoop/pull/2568#discussion_r546804830", "bodyText": "Not familiar with YARN code. The production code looks fine to me. The test code should add more coverage for each of the methods in ZKRMStateStoreOpDurations.", "author": "jojochuang", "createdAt": "2020-12-21T16:31:35Z", "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/recovery/TestZKRMStateStore.java", "diffHunk": "@@ -1567,4 +1568,16 @@ public void testAppSubmissionContextIsPrunedInFinalApplicationState()\n         Collections.emptyMap(), ctx.getApplicationSchedulingPropertiesMap());\n     store.close();\n   }\n+\n+  @Test", "originalCommit": "c70444766030f639362f09abae63be6295a1ab46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyMTAwNw==", "url": "https://github.com/apache/hadoop/pull/2568#discussion_r547921007", "bodyText": "done.  add more test in testMetricsInited to cover each of the methods in ZKRMStateStoreOpDurations.", "author": "Neilxzn", "createdAt": "2020-12-23T11:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgwNDgzMA=="}], "type": "inlineReview", "revised_code": {"commit": "252c94d90d703bb2bc8200584eee8a616f80e9bc", "chunk": "diff --git a/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/recovery/TestZKRMStateStore.java b/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/recovery/TestZKRMStateStore.java\nindex 77f8105d64c..ebc7d6edb39 100644\n--- a/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/recovery/TestZKRMStateStore.java\n+++ b/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/recovery/TestZKRMStateStore.java\n\n@@ -1573,11 +1575,30 @@ public void testAppSubmissionContextIsPrunedInFinalApplicationState()\n   public void testMetricsInited() throws Exception  {\n     TestZKRMStateStoreTester zkTester = new TestZKRMStateStoreTester();\n     Configuration conf = createConfForDelegationTokenNodeSplit(1);\n-    ZKRMStateStore store = (ZKRMStateStore)zkTester.getRMStateStore(conf);\n     MetricsCollectorImpl collector = new MetricsCollectorImpl();\n-    store.zkRMStateStoreOpDurations.getMetrics(collector, true);\n+    ZKRMStateStoreOpDurations opDurations = ((ZKRMStateStore)zkTester.getRMStateStore(conf))\n+        .zkRMStateStoreOpDurations;\n+\n+    long anyDuration = 10;\n+    opDurations.addLoadStateCallDuration(anyDuration);\n+    opDurations.addStoreApplicationStateCallDuration(anyDuration);\n+    opDurations.addUpdateApplicationStateCallDuration(anyDuration);\n+    opDurations.addRemoveApplicationStateCallDuration(anyDuration);\n+\n+    Thread.sleep(110);\n+\n+    opDurations.getMetrics(collector, true);\n     assertEquals(\"Incorrect number of perf metrics\", 1,\n         collector.getRecords().size());\n+    MetricsRecord record = collector.getRecords().get(0);\n+    MetricsRecords.assertTag(record, ZKRMStateStoreOpDurations.RECORD_INFO.name(),\n+        \"ZKRMStateStoreOpDurations\");\n+\n+    double expectAvgTime = anyDuration;\n+    MetricsRecords.assertMetric(record, \"LoadStateCallAvgTime\",  expectAvgTime);\n+    MetricsRecords.assertMetric(record, \"StoreApplicationStateCallAvgTime\", expectAvgTime);\n+    MetricsRecords.assertMetric(record, \"UpdateApplicationStateCallAvgTime\", expectAvgTime);\n+    MetricsRecords.assertMetric(record, \"RemoveApplicationStateCallAvgTime\", expectAvgTime);\n   }\n \n }\n"}}, {"oid": "252c94d90d703bb2bc8200584eee8a616f80e9bc", "url": "https://github.com/apache/hadoop/commit/252c94d90d703bb2bc8200584eee8a616f80e9bc", "message": "add more test in  testMetricsInited\n\nZKRMStateStoreOpDurations.addLoadStateCallDuration\nZKRMStateStoreOpDurations.addStoreApplicationStateCallDuration\nZKRMStateStoreOpDurations.addUpdateApplicationStateCallDuration\nZKRMStateStoreOpDurations.addRemoveApplicationStateCallDuration", "committedDate": "2020-12-23T11:48:00Z", "type": "commit"}, {"oid": "b4907897e7aca8acd2564ed4610ad4867fc3e82b", "url": "https://github.com/apache/hadoop/commit/b4907897e7aca8acd2564ed4610ad4867fc3e82b", "message": "fix some checkstyle", "committedDate": "2020-12-24T03:07:55Z", "type": "commit"}]}