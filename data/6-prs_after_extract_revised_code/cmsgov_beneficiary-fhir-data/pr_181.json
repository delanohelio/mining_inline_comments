{"pr_number": 181, "pr_title": "BLUEBUTTON-1573: Configure tracing and transaction names in New Relic", "pr_createdAt": "2020-01-02T04:21:15Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181", "timeline": [{"oid": "e87c28a5b12cb54b55bde8ae4d8c9486e7000fd4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e87c28a5b12cb54b55bde8ae4d8c9486e7000fd4", "message": "Set operation canonical name in logs and New Relic.\n\nParticularly for New Relic, this should allow us to make meaningful\nmeasurements and comparisons of the performance of various operations.\n\nBLUEBUTTON-1573", "committedDate": "2020-01-02T04:15:17Z", "type": "commit"}, {"oid": "168bbecbb6b55653ac13a83f60b312ff72bf7b54", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/168bbecbb6b55653ac13a83f60b312ff72bf7b54", "message": "Configure detailed New Relic tracing.\n\nThis tells New Relic to break out transaction traces in more detail,\nallowing us a better picture of what time is actually being spent on.\n\nBLUEBUTTON-1573", "committedDate": "2020-01-02T04:15:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAzOTI2Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r369039263", "bodyText": "I like this class. I suggest that it may be improved by defining common options like \"id\". To avoid inconsistency for in calls to setOption(\"id\", ...) or setOption(\"Id\", ...) etc. This thinking is similar to the reason for an Endpoint enumeration.", "author": "RickHawesUSDS", "createdAt": "2020-01-21T14:40:48Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/Operation.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package gov.cms.bfd.server.war;\n+\n+import com.codahale.metrics.servlets.HealthCheckServlet;\n+import com.codahale.metrics.servlets.MetricsServlet;\n+import com.codahale.metrics.servlets.PingServlet;\n+import com.codahale.metrics.servlets.ThreadDumpServlet;\n+import com.newrelic.api.agent.NewRelic;\n+import gov.cms.bfd.server.war.stu3.providers.CoverageResourceProvider;\n+import gov.cms.bfd.server.war.stu3.providers.ExplanationOfBenefitResourceProvider;\n+import gov.cms.bfd.server.war.stu3.providers.PatientResourceProvider;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import javax.servlet.http.HttpServletRequest;\n+import org.hl7.fhir.dstu3.hapi.rest.server.ServerCapabilityStatementProvider;\n+import org.slf4j.MDC;\n+\n+/**\n+ * Models the canonical \"operations\" supported by this application, such that each meaningfully\n+ * distinct operation can be assigned a unique canonical name, for use in monitoring systems.\n+ *\n+ * <p>Also handles the publishing of those canonical names to the places they need to be published,\n+ * via the {@link #publishOperationName()} method.\n+ */\n+public final class Operation {", "originalCommit": "168bbecbb6b55653ac13a83f60b312ff72bf7b54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjQxNw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r376746417", "bodyText": "Thought about doing that but decided that, if I wanted to go there, it'd be better to create types or subtypes for every operation. Decided that wasn't worth the effort right now.", "author": "karlmdavis", "createdAt": "2020-02-09T01:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAzOTI2Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "264f0afd19c515c991466a7557664e8e8c67149d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/264f0afd19c515c991466a7557664e8e8c67149d", "message": "Merge branch 'master' into BLUEBUTTON-1573-new-relic-config", "committedDate": "2020-02-09T01:05:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEzOTQyMg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r377139422", "bodyText": "Can't request in request.header. be omitted from the computeMdcRequestKey function call?", "author": "njdister", "createdAt": "2020-02-10T15:38:39Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java", "diffHunk": "@@ -60,29 +60,37 @@ private static void handleRequest(ServletRequest request) {\n     // Record the request type.\n     MDC.put(computeMdcKey(\"request_type\"), request.getClass().getName());\n \n+    // Set the default Operation (will hopefully be customized further in specific handler methods).\n+    Operation operation = new Operation(Operation.Endpoint.OTHER);\n+\n     if (request instanceof HttpServletRequest) {\n       HttpServletRequest servletRequest = (HttpServletRequest) request;\n \n       // Record the basic request components.\n-      MDC.put(computeMdcKey(\"request.http_method\"), servletRequest.getMethod());\n-      MDC.put(computeMdcKey(\"request.url\"), servletRequest.getRequestURL().toString());\n-      MDC.put(computeMdcKey(\"request.uri\"), servletRequest.getRequestURI());\n-      MDC.put(computeMdcKey(\"request.query_string\"), servletRequest.getQueryString());\n+      operation = new Operation(Operation.Endpoint.matchByHttpUri(servletRequest));\n+      MDC.put(computeMdcRequestKey(\"http_method\"), servletRequest.getMethod());\n+      MDC.put(computeMdcRequestKey(\"url\"), servletRequest.getRequestURL().toString());\n+      MDC.put(computeMdcRequestKey(\"uri\"), servletRequest.getRequestURI());\n+      MDC.put(computeMdcRequestKey(\"query_string\"), servletRequest.getQueryString());\n       MDC.put(\n-          computeMdcKey(\"request.clientSSL.DN\"),\n+          computeMdcRequestKey(\"clientSSL.DN\"),\n           getClientSslPrincipalDistinguishedName(servletRequest));\n \n       // Record the request headers.\n       Enumeration<String> headerNames = servletRequest.getHeaderNames();\n       while (headerNames.hasMoreElements()) {\n         String headerName = headerNames.nextElement();\n         List<String> headerValues = Collections.list(servletRequest.getHeaders(headerName));\n-        if (headerValues.isEmpty()) MDC.put(computeMdcKey(\"request.header.\" + headerName), \"\");\n+        if (headerValues.isEmpty())\n+          MDC.put(computeMdcRequestKey(\"request.header.\" + headerName), \"\");", "originalCommit": "264f0afd19c515c991466a7557664e8e8c67149d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NzAxMA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r377747010", "bodyText": "Yup -- thanks! Fixed.", "author": "karlmdavis", "createdAt": "2020-02-11T16:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEzOTQyMg=="}], "type": "inlineReview", "revised_code": {"commit": "c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "chunk": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\nindex c5aaab157..27f207729 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\n\n@@ -82,7 +82,7 @@ public final class RequestResponseLoggingFilter implements Filter {\n         String headerName = headerNames.nextElement();\n         List<String> headerValues = Collections.list(servletRequest.getHeaders(headerName));\n         if (headerValues.isEmpty())\n-          MDC.put(computeMdcRequestKey(\"request.header.\" + headerName), \"\");\n+          MDC.put(computeMdcRequestKey(\"header.\" + headerName), \"\");\n         else if (headerValues.size() == 1)\n           MDC.put(computeMdcRequestKey(\"header.\" + headerName), headerValues.get(0));\n         else MDC.put(computeMdcRequestKey(\"header.\" + headerName), headerValues.toString());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NjM5MQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r377746391", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      MDC.put(computeMdcRequestKey(\"request.header.\" + headerName), \"\");\n          \n          \n            \n                      MDC.put(computeMdcRequestKey(\"header.\" + headerName), \"\");", "author": "karlmdavis", "createdAt": "2020-02-11T16:25:47Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java", "diffHunk": "@@ -60,29 +60,37 @@ private static void handleRequest(ServletRequest request) {\n     // Record the request type.\n     MDC.put(computeMdcKey(\"request_type\"), request.getClass().getName());\n \n+    // Set the default Operation (will hopefully be customized further in specific handler methods).\n+    Operation operation = new Operation(Operation.Endpoint.OTHER);\n+\n     if (request instanceof HttpServletRequest) {\n       HttpServletRequest servletRequest = (HttpServletRequest) request;\n \n       // Record the basic request components.\n-      MDC.put(computeMdcKey(\"request.http_method\"), servletRequest.getMethod());\n-      MDC.put(computeMdcKey(\"request.url\"), servletRequest.getRequestURL().toString());\n-      MDC.put(computeMdcKey(\"request.uri\"), servletRequest.getRequestURI());\n-      MDC.put(computeMdcKey(\"request.query_string\"), servletRequest.getQueryString());\n+      operation = new Operation(Operation.Endpoint.matchByHttpUri(servletRequest));\n+      MDC.put(computeMdcRequestKey(\"http_method\"), servletRequest.getMethod());\n+      MDC.put(computeMdcRequestKey(\"url\"), servletRequest.getRequestURL().toString());\n+      MDC.put(computeMdcRequestKey(\"uri\"), servletRequest.getRequestURI());\n+      MDC.put(computeMdcRequestKey(\"query_string\"), servletRequest.getQueryString());\n       MDC.put(\n-          computeMdcKey(\"request.clientSSL.DN\"),\n+          computeMdcRequestKey(\"clientSSL.DN\"),\n           getClientSslPrincipalDistinguishedName(servletRequest));\n \n       // Record the request headers.\n       Enumeration<String> headerNames = servletRequest.getHeaderNames();\n       while (headerNames.hasMoreElements()) {\n         String headerName = headerNames.nextElement();\n         List<String> headerValues = Collections.list(servletRequest.getHeaders(headerName));\n-        if (headerValues.isEmpty()) MDC.put(computeMdcKey(\"request.header.\" + headerName), \"\");\n+        if (headerValues.isEmpty())\n+          MDC.put(computeMdcRequestKey(\"request.header.\" + headerName), \"\");", "originalCommit": "264f0afd19c515c991466a7557664e8e8c67149d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "chunk": "diff --git a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\nindex c5aaab157..27f207729 100644\n--- a/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\n+++ b/apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\n\n@@ -82,7 +82,7 @@ public final class RequestResponseLoggingFilter implements Filter {\n         String headerName = headerNames.nextElement();\n         List<String> headerValues = Collections.list(servletRequest.getHeaders(headerName));\n         if (headerValues.isEmpty())\n-          MDC.put(computeMdcRequestKey(\"request.header.\" + headerName), \"\");\n+          MDC.put(computeMdcRequestKey(\"header.\" + headerName), \"\");\n         else if (headerValues.size() == 1)\n           MDC.put(computeMdcRequestKey(\"header.\" + headerName), headerValues.get(0));\n         else MDC.put(computeMdcRequestKey(\"header.\" + headerName), headerValues.toString());\n"}}, {"oid": "c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "message": "Update apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/RequestResponseLoggingFilter.java\r\n\r\nFixed, per @njdister's comment.", "committedDate": "2020-02-11T16:26:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MTE0MA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r378881140", "bodyText": "To check my understanding this will log an operation of V1_COVERAGE twice. Once here and once in RequestResponseLoggingFilter", "author": "whytheplatypus", "createdAt": "2020-02-13T14:07:57Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/CoverageResourceProvider.java", "diffHunk": "@@ -83,6 +86,10 @@ public Coverage read(@IdParam IdType coverageId) {\n     if (coverageIdText == null || coverageIdText.trim().isEmpty())\n       throw new IllegalArgumentException();\n \n+    Operation operation = new Operation(Operation.Endpoint.V1_COVERAGE);", "originalCommit": "c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzNzY4Mg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r378937682", "bodyText": "Sort of. The RequestResponseLoggingFilter sets the default operation name at the start of each request to new Operation(Operation.Endpoint.OTHER). That gets set in the MDC, which is a single-valued Map.\nAny handler/endpoint that wants to customize that can override it by creating a more specific Operation and calling publishOperationName() on it. That publish call overrides the default value in the MDC.\nThat make sense?", "author": "karlmdavis", "createdAt": "2020-02-13T15:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MTE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0NDkxMw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r378944913", "bodyText": "it's using matchByHttpUri in the default, so I'd expect that to return V1_COVERAGE since it's a listed endpoint?\nThe default logic goes from requestHttpUri -> Endpoint enum -> requestHttpUri", "author": "whytheplatypus", "createdAt": "2020-02-13T15:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MTE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA4MzMyNw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r379083327", "bodyText": "Ahh, yes -- had forgotten about the matching. That's correct, though it won't have the params -- just the operation name.\nRegardless, it won't get logged twice -- the access log is only written to once per response, in gov.cms.bfd.server.war.RequestResponseLoggingFilter.addToHttpAccessLog().\n(Being pedantic: note that I said it only gets logged to the access log once. The other message/event log will also include whichever values the MDC happens to have at the time of any logging event. It doesn't particularly matter and there's not a lot we can do about it, given SLF4J's API -- short of replacing the MDC entirely, ourselves, which feels like a bad idea.)", "author": "karlmdavis", "createdAt": "2020-02-13T19:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MTE0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4Mjg0NA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r378882844", "bodyText": "These look like they're custom versions of the query params and headers sent to the system. It looks like these are also tracked in RequestResponseLoggingFilter.", "author": "whytheplatypus", "createdAt": "2020-02-13T14:10:53Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -105,6 +108,11 @@ public Patient read(@IdParam IdType patientId, RequestDetails requestDetails) {\n \n     List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n \n+    Operation operation = new Operation(Operation.Endpoint.V1_PATIENT);\n+    operation.setOption(\"by\", \"id\");\n+    operation.setOption(\"IncludeIdentifiers\", includeIdentifiersValues.toString());", "originalCommit": "c3d60a13a05a5b603b18b0b81fda68abaefe52b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzNTE3OQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/181#discussion_r378935179", "bodyText": "Correct, but separated out to make NDJSON searches/filtering easier.", "author": "karlmdavis", "createdAt": "2020-02-13T15:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4Mjg0NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "71890e92c56bcfe5c6e54db91887c16fdaa725b1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/71890e92c56bcfe5c6e54db91887c16fdaa725b1", "message": "Merge branch 'master' into BLUEBUTTON-1573-new-relic-config\n\nHad to fix it to cope with _since changes.", "committedDate": "2020-02-13T16:04:11Z", "type": "commit"}]}