{"pr_number": 3062, "pr_title": "SONARJAVA-3426 Rule S5868: Unicode Grapheme Clusters should be avoided inside regex character classes", "pr_createdAt": "2020-06-29T11:20:11Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3062", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNjYzNA==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446916634", "bodyText": "The rule description proposes a more precise message when the regex is \"simple enough\", however, I'm not sure to get what are the benefits. If you feel that it would be useful, let's discuss it!", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-06-29T12:02:30Z", "path": "java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks.regex;\n+\n+import java.text.Normalizer;\n+import java.util.Collections;\n+import javax.annotation.Nullable;\n+import org.sonar.check.Rule;\n+import org.sonar.java.regex.RegexParseResult;\n+import org.sonar.java.regex.ast.CharacterClassTree;\n+import org.sonar.java.regex.ast.CharacterClassUnionTree;\n+import org.sonar.java.regex.ast.JavaCharacter;\n+import org.sonar.java.regex.ast.PlainCharacterTree;\n+import org.sonar.java.regex.ast.RegexBaseVisitor;\n+import org.sonar.java.regex.ast.RegexTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+\n+@Rule(key = \"S5868\")\n+public class GraphemeClustersInClassesCheck extends AbstractRegexCheck {\n+\n+  private static final String MESSAGE = \"Extract these Grapheme Clusters from the character class.\";", "originalCommit": "af5e86ce5915c0cc2110151ce78b9d0dbef1c486", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NTMxMQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446975311", "bodyText": "I think it would be valuable to use at least a singular/plural form if not using the simpler case.", "author": "m-g-sonar", "createdAt": "2020-06-29T13:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNjYzNA=="}], "type": "inlineReview", "revised_code": {"commit": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "chunk": "diff --git a/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java b/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\nindex b2f1e6cf4..bd87fcd63 100644\n--- a/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\n+++ b/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\n\n@@ -19,8 +19,9 @@\n  */\n package org.sonar.java.checks.regex;\n \n-import java.text.Normalizer;\n-import java.util.Collections;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.regex.Pattern;\n import javax.annotation.Nullable;\n import org.sonar.check.Rule;\n import org.sonar.java.regex.RegexParseResult;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MjU5Nw==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446972597", "bodyText": "Not sure 'r' is before 'e'", "author": "m-g-sonar", "createdAt": "2020-06-29T13:30:38Z", "path": "java-checks/src/main/java/org/sonar/java/checks/CheckList.java", "diffHunk": "@@ -398,6 +399,7 @@ private CheckList() {\n       ForLoopUsedAsWhileLoopCheck.class,\n       ForLoopVariableTypeCheck.class,\n       GarbageCollectorCalledCheck.class,\n+      GraphemeClustersInClassesCheck.class,", "originalCommit": "af5e86ce5915c0cc2110151ce78b9d0dbef1c486", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "chunk": "diff --git a/java-checks/src/main/java/org/sonar/java/checks/CheckList.java b/java-checks/src/main/java/org/sonar/java/checks/CheckList.java\nindex 236945ffa..d1118a8e0 100644\n--- a/java-checks/src/main/java/org/sonar/java/checks/CheckList.java\n+++ b/java-checks/src/main/java/org/sonar/java/checks/CheckList.java\n\n@@ -399,10 +402,10 @@ public final class CheckList {\n       ForLoopUsedAsWhileLoopCheck.class,\n       ForLoopVariableTypeCheck.class,\n       GarbageCollectorCalledCheck.class,\n-      GraphemeClustersInClassesCheck.class,\n       GetClassLoaderCheck.class,\n       GetRequestedSessionIdCheck.class,\n       GettersSettersOnRightFieldCheck.class,\n+      GraphemeClustersInClassesCheck.class,\n       HardCodedCredentialsCheck.class,\n       HardcodedIpCheck.class,\n       HardcodedURICheck.class,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MzQxNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446973416", "bodyText": "The issue message is in the plural, while there is apparently only one cluster, I feel it is strange\nWhy not reporting directly on it and use a singular form?", "author": "m-g-sonar", "createdAt": "2020-06-29T13:31:47Z", "path": "java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package checks.regex;\n+\n+import java.util.regex.Pattern;\n+\n+public class GraphemeClustersInClassesCheck {\n+\n+  void noncompliant(String str) {\n+    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant [[sc=25;ec=29]] {{Extract these Grapheme Clusters from the character class.}}", "originalCommit": "af5e86ce5915c0cc2110151ce78b9d0dbef1c486", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "chunk": "diff --git a/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java b/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\nindex a2c0b403e..5de3e492e 100644\n--- a/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\n+++ b/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\n\n@@ -5,24 +5,30 @@ import java.util.regex.Pattern;\n public class GraphemeClustersInClassesCheck {\n \n   void noncompliant(String str) {\n-    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant [[sc=25;ec=29]] {{Extract these Grapheme Clusters from the character class.}}\n-    Pattern.compile(\"[e\u0300a-de\u0300]\"); // Noncompliant [[sc=22;ec=31]] {{Extract these Grapheme Clusters from the character class.}}\n-    // Noncompliant@+1\n-    Pattern.compile(\"[e\u0300a]aaa[de\u0300]\"); // Noncompliant\n+    Pattern.compile(\"[aaae\u0300aaa]\"); // Noncompliant [[sc=22;ec=32;secondary=8]] {{Extract 1 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"[0S\u0323\u03070]\"); // Noncompliant [[sc=22;ec=29;secondary=9]] {{Extract 1 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant\n+    // two secondary per line: one for the regex location, and one for the cluster location\n+    Pattern.compile(\"[e\u0300ae\u0300ae\u0300]\"); // Noncompliant [[sc=22;ec=32;secondary=12,12,12]] {{Extract 3 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"[e\u0300a-da\u0308]\"); // Noncompliant\n+    Pattern.compile(\"[e\u0300a]\" +     // Noncompliant\n+      \"aaa\" +\n+      \"[de\u0300]\"); // Noncompliant\n \n     \"abc\".replaceFirst(\"[a\u0308]\", \"A\"); // Noncompliant\n+    Pattern.compile(\"[c\u0308]\"); // Noncompliant\n+    Pattern.compile(\"[e\u20dd]\"); // Noncompliant\n   }\n \n   void compliant(String str) {\n     Pattern.compile(\"[\u00e9]\"); // Compliant, a single char\n-    Pattern.compile(\"[c\u0308]\"); // Compliant, can not be combined\n-    Pattern.compile(\"[e\u20dd]\"); // Compliant, can not be combined\n     Pattern.compile(\"[e\\u0300]\"); // Compliant, escaped unicode\n     Pattern.compile(\"[e\\u20DD\u0300]\"); // Compliant, (letter, escaped unicode, mark) can not be combined\n     Pattern.compile(\"[\\u0300e]\"); // Compliant, escaped unicode, letter\n     Pattern.compile(\"[\u0300\u0300]\"); // Compliant, two marks\n+    Pattern.compile(\"[\u0300\u0300]\"); // Compliant, one mark\n \n-    Pattern.compile(\"a\u0308\"); // Compliant,not in a class\n+    Pattern.compile(\"a\u0308\"); // Compliant, not in a class\n   }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDAwNw==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446974007", "bodyText": "instead of using this, you can use a String concatenation and a different line", "author": "m-g-sonar", "createdAt": "2020-06-29T13:32:35Z", "path": "java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package checks.regex;\n+\n+import java.util.regex.Pattern;\n+\n+public class GraphemeClustersInClassesCheck {\n+\n+  void noncompliant(String str) {\n+    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant [[sc=25;ec=29]] {{Extract these Grapheme Clusters from the character class.}}\n+    Pattern.compile(\"[e\u0300a-de\u0300]\"); // Noncompliant [[sc=22;ec=31]] {{Extract these Grapheme Clusters from the character class.}}\n+    // Noncompliant@+1", "originalCommit": "af5e86ce5915c0cc2110151ce78b9d0dbef1c486", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "chunk": "diff --git a/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java b/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\nindex a2c0b403e..5de3e492e 100644\n--- a/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\n+++ b/java-checks-test-sources/src/main/java/checks/regex/GraphemeClustersInClassesCheck.java\n\n@@ -5,24 +5,30 @@ import java.util.regex.Pattern;\n public class GraphemeClustersInClassesCheck {\n \n   void noncompliant(String str) {\n-    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant [[sc=25;ec=29]] {{Extract these Grapheme Clusters from the character class.}}\n-    Pattern.compile(\"[e\u0300a-de\u0300]\"); // Noncompliant [[sc=22;ec=31]] {{Extract these Grapheme Clusters from the character class.}}\n-    // Noncompliant@+1\n-    Pattern.compile(\"[e\u0300a]aaa[de\u0300]\"); // Noncompliant\n+    Pattern.compile(\"[aaae\u0300aaa]\"); // Noncompliant [[sc=22;ec=32;secondary=8]] {{Extract 1 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"[0S\u0323\u03070]\"); // Noncompliant [[sc=22;ec=29;secondary=9]] {{Extract 1 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"aaa[e\u0300]aaa\"); // Noncompliant\n+    // two secondary per line: one for the regex location, and one for the cluster location\n+    Pattern.compile(\"[e\u0300ae\u0300ae\u0300]\"); // Noncompliant [[sc=22;ec=32;secondary=12,12,12]] {{Extract 3 Grapheme Cluster(s) from this character class.}}\n+    Pattern.compile(\"[e\u0300a-da\u0308]\"); // Noncompliant\n+    Pattern.compile(\"[e\u0300a]\" +     // Noncompliant\n+      \"aaa\" +\n+      \"[de\u0300]\"); // Noncompliant\n \n     \"abc\".replaceFirst(\"[a\u0308]\", \"A\"); // Noncompliant\n+    Pattern.compile(\"[c\u0308]\"); // Noncompliant\n+    Pattern.compile(\"[e\u20dd]\"); // Noncompliant\n   }\n \n   void compliant(String str) {\n     Pattern.compile(\"[\u00e9]\"); // Compliant, a single char\n-    Pattern.compile(\"[c\u0308]\"); // Compliant, can not be combined\n-    Pattern.compile(\"[e\u20dd]\"); // Compliant, can not be combined\n     Pattern.compile(\"[e\\u0300]\"); // Compliant, escaped unicode\n     Pattern.compile(\"[e\\u20DD\u0300]\"); // Compliant, (letter, escaped unicode, mark) can not be combined\n     Pattern.compile(\"[\\u0300e]\"); // Compliant, escaped unicode, letter\n     Pattern.compile(\"[\u0300\u0300]\"); // Compliant, two marks\n+    Pattern.compile(\"[\u0300\u0300]\"); // Compliant, one mark\n \n-    Pattern.compile(\"a\u0308\"); // Compliant,not in a class\n+    Pattern.compile(\"a\u0308\"); // Compliant, not in a class\n   }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NDIwNQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3062#discussion_r446984205", "bodyText": "I feel it is not enough.\nI was surprised to see that a simpler version of the test case from the Noncompliant part of the RSPEC was marked as Compliant, while it shouldn't. The following code, when executed:\n\"cc\u0308c\".replaceAll(\"[c\u0308]\", \"X\");\n\nwould print XXXX, instead of cXc, and it should be reported!", "author": "m-g-sonar", "createdAt": "2020-06-29T13:47:02Z", "path": "java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks.regex;\n+\n+import java.text.Normalizer;\n+import java.util.Collections;\n+import javax.annotation.Nullable;\n+import org.sonar.check.Rule;\n+import org.sonar.java.regex.RegexParseResult;\n+import org.sonar.java.regex.ast.CharacterClassTree;\n+import org.sonar.java.regex.ast.CharacterClassUnionTree;\n+import org.sonar.java.regex.ast.JavaCharacter;\n+import org.sonar.java.regex.ast.PlainCharacterTree;\n+import org.sonar.java.regex.ast.RegexBaseVisitor;\n+import org.sonar.java.regex.ast.RegexTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+\n+@Rule(key = \"S5868\")\n+public class GraphemeClustersInClassesCheck extends AbstractRegexCheck {\n+\n+  private static final String MESSAGE = \"Extract these Grapheme Clusters from the character class.\";\n+\n+  @Override\n+  public void checkRegex(RegexParseResult regexForLiterals, MethodInvocationTree mit) {\n+    new GraphemeInClassVisitor().visit(regexForLiterals);\n+  }\n+\n+  private class GraphemeInClassVisitor extends RegexBaseVisitor {\n+\n+    boolean containGrapheme = false;\n+\n+    @Override\n+    public void visitCharacterClass(CharacterClassTree tree) {\n+      super.visitCharacterClass(tree);\n+      if (containGrapheme) {\n+        reportIssue(tree, MESSAGE, null, Collections.emptyList());\n+      }\n+      containGrapheme = false;\n+    }\n+\n+    @Override\n+    public void visitCharacterClassUnion(CharacterClassUnionTree tree) {\n+      JavaCharacter previousChar = null;\n+      for (RegexTree child : tree.getCharacterClasses()) {\n+        if (child.is(RegexTree.Kind.PLAIN_CHARACTER)) {\n+          JavaCharacter currentCharacter = ((PlainCharacterTree) child).getContents();\n+          if (!currentCharacter.isEscapedUnicode()) {\n+            char currentChar = currentCharacter.getCharacter();\n+            if (canCanonicallyCombine(previousChar, currentChar)) {\n+              containGrapheme = true;\n+            }\n+            previousChar = currentCharacter;\n+            continue;\n+          }\n+        }\n+        previousChar = null;\n+      }\n+\n+      super.visitCharacterClassUnion(tree);\n+    }\n+\n+    private boolean canCanonicallyCombine(@Nullable JavaCharacter previousChar, char currentChar) {\n+      return previousChar != null\n+        && Normalizer.normalize(new StringBuilder().append(previousChar.getCharacter()).append(currentChar), Normalizer.Form.NFC).length() == 1;", "originalCommit": "af5e86ce5915c0cc2110151ce78b9d0dbef1c486", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "chunk": "diff --git a/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java b/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\nindex b2f1e6cf4..bd87fcd63 100644\n--- a/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\n+++ b/java-checks/src/main/java/org/sonar/java/checks/regex/GraphemeClustersInClassesCheck.java\n\n@@ -19,8 +19,9 @@\n  */\n package org.sonar.java.checks.regex;\n \n-import java.text.Normalizer;\n-import java.util.Collections;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.regex.Pattern;\n import javax.annotation.Nullable;\n import org.sonar.check.Rule;\n import org.sonar.java.regex.RegexParseResult;\n"}}, {"oid": "e631ecd4a745f2975529b5d2155f47ca333a39cc", "url": "https://github.com/SonarSource/sonar-java/commit/e631ecd4a745f2975529b5d2155f47ca333a39cc", "message": "Increase enforced plugin size", "committedDate": "2020-06-30T12:59:40Z", "type": "forcePushed"}, {"oid": "a3949fe4f79469037288dc35c3b235ec8a400e33", "url": "https://github.com/SonarSource/sonar-java/commit/a3949fe4f79469037288dc35c3b235ec8a400e33", "message": "SONARJAVA-3426 Rule S5868: Unicode Grapheme Clusters should be avoided inside regex character classes", "committedDate": "2020-06-30T13:49:50Z", "type": "commit"}, {"oid": "3b3cbfdeff83cb8ad73299acd424f49be4c25202", "url": "https://github.com/SonarSource/sonar-java/commit/3b3cbfdeff83cb8ad73299acd424f49be4c25202", "message": "Increase enforced plugin size", "committedDate": "2020-06-30T13:49:50Z", "type": "commit"}, {"oid": "3b3cbfdeff83cb8ad73299acd424f49be4c25202", "url": "https://github.com/SonarSource/sonar-java/commit/3b3cbfdeff83cb8ad73299acd424f49be4c25202", "message": "Increase enforced plugin size", "committedDate": "2020-06-30T13:49:50Z", "type": "forcePushed"}]}