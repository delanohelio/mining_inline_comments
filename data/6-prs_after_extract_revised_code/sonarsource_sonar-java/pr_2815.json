{"pr_number": 2815, "pr_title": "SONARJAVA-3290 S3457 should allow to use 'toString()' on exceptions to force usage of sl4j Logger(String, Object...)", "pr_createdAt": "2020-02-13T15:55:24Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/2815", "timeline": [{"oid": "857d32c7f4e50493001b9ced3c13a5a7623f3076", "url": "https://github.com/SonarSource/sonar-java/commit/857d32c7f4e50493001b9ced3c13a5a7623f3076", "message": "SONARJAVA-3290 S3457 should allow to use 'toString()' on exceptions to force usage of sl4j Logger(String, Object...)", "committedDate": "2020-02-13T16:53:46Z", "type": "forcePushed"}, {"oid": "7a5a1b88dffec6966b069a80ce0f899037f84b74", "url": "https://github.com/SonarSource/sonar-java/commit/7a5a1b88dffec6966b069a80ce0f899037f84b74", "message": "SONARJAVA-3290 S3457 should allow to use 'toString()' on exceptions to force usage of sl4j Logger(String, Object...)", "committedDate": "2020-02-13T17:23:03Z", "type": "forcePushed"}, {"oid": "0b4e9d9730653337b57236a5c2424c4b538d7eb4", "url": "https://github.com/SonarSource/sonar-java/commit/0b4e9d9730653337b57236a5c2424c4b538d7eb4", "message": "SONARJAVA-3290 S3457 should allow to use 'toString()' on exceptions to force usage of sl4j Logger(String, Object...)", "committedDate": "2020-02-14T08:25:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA3MTQyOQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2815#discussion_r380071429", "bodyText": "to me the error message is wrong here. It should be something like Remove this argument formatter because it won't be consumed.", "author": "m-g-sonar", "createdAt": "2020-02-17T09:36:00Z", "path": "java-checks/src/test/files/checks/PrintfMisuseCheck.java", "diffHunk": "@@ -182,13 +185,18 @@ void foo(Calendar c){\n     slf4jLog.debug(\"message {} {}\", new Object[]{1, 2, 3}); // Noncompliant\n     slf4jLog.debug(\"message {} {} {}\", new Object[]{1, 2, 3}); // compliant\n     slf4jLog.debug(\"message \", new Exception());\n-    slf4jLog.debug(\"message {}\", new Exception());\n+    slf4jLog.debug(\"message {}\", new Exception()); // Noncompliant {{Missing argument for the first parameter.}}\n \n-    slf4jLog.error(\"message {}\");\n+    slf4jLog.error(\"message {}\"); // Noncompliant {{Missing argument for the first parameter.}}\n+    slf4jLog.error(\"message {}\", new Exception()); // Noncompliant {{Missing argument for the first parameter.}}", "originalCommit": "0b4e9d9730653337b57236a5c2424c4b538d7eb4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7d1db1b9f3bb2d044734208967e4a16f5dae4098", "chunk": "diff --git a/java-checks/src/test/files/checks/PrintfMisuseCheck.java b/java-checks/src/test/files/checks/PrintfMisuseCheck.java\nindex 4bfb4125a..362a2a4a3 100644\n--- a/java-checks/src/test/files/checks/PrintfMisuseCheck.java\n+++ b/java-checks/src/test/files/checks/PrintfMisuseCheck.java\n\n@@ -185,18 +185,20 @@ class A {\n     slf4jLog.debug(\"message {} {}\", new Object[]{1, 2, 3}); // Noncompliant\n     slf4jLog.debug(\"message {} {} {}\", new Object[]{1, 2, 3}); // compliant\n     slf4jLog.debug(\"message \", new Exception());\n-    slf4jLog.debug(\"message {}\", new Exception()); // Noncompliant {{Missing argument for the first parameter.}}\n+    slf4jLog.debug(\"message {}\", new Exception()); // Compliant, detected by S2275 \"Not enough arguments.\"\n \n-    slf4jLog.error(\"message {}\"); // Noncompliant {{Missing argument for the first parameter.}}\n-    slf4jLog.error(\"message {}\", new Exception()); // Noncompliant {{Missing argument for the first parameter.}}\n+    slf4jLog.error(\"message {}\");  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    slf4jLog.error(\"message {}\", new Exception());  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    slf4jLog.error(\"message {}\", new Exception().toString());\n     slf4jLog.error(\"message \", 1); // Noncompliant {{String contains no format specifiers.}}\n     slf4jLog.error(\"message {}\", 1);\n+    slf4jLog.error(\"message {}\", 1, 2); // Noncompliant {{2nd argument is not used.}}\n     slf4jLog.error(\"message \", new Exception());\n-    slf4jLog.error(\"message {}\", new Exception()); // Noncompliant {{Missing argument for the first parameter.}}\n-    slf4jLog.error(\"message {}\", new Exception().toString());\n-    slf4jLog.error(\"message {} {}\", 1); // Noncompliant {{Missing argument for the 2nd parameter.}}\n-    slf4jLog.error(\"message {} {}\", 1, new Exception()); // Noncompliant {{Missing argument for the 2nd parameter.}}\n+    slf4jLog.error(\"message {} {}\", 1); // Compliant, detected by S2275 \"Not enough arguments.\"\n+    slf4jLog.error(\"message {} {}\", 1, new Exception()); // Compliant, detected by S2275 \"Not enough arguments.\"\n     slf4jLog.error(\"message {} {}\", 1, new Exception().toString());\n+    slf4jLog.error(\"message {} {}\", 1, 2, 3); // Noncompliant {{3rd argument is not used.}}\n+    slf4jLog.error(\"message {} {}\", 1, 2, new Exception().toString()); // Noncompliant {{3rd argument is not used.}}\n \n     try {\n     } catch (Exception e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA3MTk0Mw==", "url": "https://github.com/SonarSource/sonar-java/pull/2815#discussion_r380071943", "bodyText": "this is a FP to me. You don't have the choice to use concatenation if you want to use the \"Throwable\" method.", "author": "m-g-sonar", "createdAt": "2020-02-17T09:37:00Z", "path": "java-checks/src/test/files/checks/PrintfMisuseCheck.java", "diffHunk": "@@ -224,6 +232,9 @@ void foo(Calendar c){\n     java.util.logging.Logger logger4 = getLog();\n     logger4.log(java.util.logging.Level.WARNING, \"som.foo.errorcode\", 404); // Noncompliant\n     this.loggerField.log(java.util.logging.Level.WARNING, \"som.foo.errorcode\", 404);\n+    String additionalMessage = \"...\";\n+    logger4.log(java.util.logging.Level.WARNING, \"message \" + additionalMessage, new Exception());  // Noncompliant {{Format specifiers should be used instead of string concatenation.}}", "originalCommit": "0b4e9d9730653337b57236a5c2424c4b538d7eb4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7d1db1b9f3bb2d044734208967e4a16f5dae4098", "chunk": "diff --git a/java-checks/src/test/files/checks/PrintfMisuseCheck.java b/java-checks/src/test/files/checks/PrintfMisuseCheck.java\nindex 4bfb4125a..362a2a4a3 100644\n--- a/java-checks/src/test/files/checks/PrintfMisuseCheck.java\n+++ b/java-checks/src/test/files/checks/PrintfMisuseCheck.java\n\n@@ -232,17 +234,38 @@ class A {\n     java.util.logging.Logger logger4 = getLog();\n     logger4.log(java.util.logging.Level.WARNING, \"som.foo.errorcode\", 404); // Noncompliant\n     this.loggerField.log(java.util.logging.Level.WARNING, \"som.foo.errorcode\", 404);\n-    String additionalMessage = \"...\";\n-    logger4.log(java.util.logging.Level.WARNING, \"message \" + additionalMessage, new Exception());  // Noncompliant {{Format specifiers should be used instead of string concatenation.}}\n-    logger4.log(java.util.logging.Level.WARNING, \"message \" + \"...\", new Exception());\n+    String param1 = \"p1\";\n+    String param2 = \"p2\";\n+    String param3 = \"p3\";\n+    java.util.logging.Level level = java.util.logging.Level.WARNING;\n+    logger4.log(level, () -> \"message 01 \" + param);\n+    logger4.log(level, new Exception(), () -> \"message 02 \" + param);\n+    logger4.log(level, \"message \");\n+    logger4.log(level, \"message \", new Exception());\n+    logger4.log(level, \"message {0}\");  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    logger4.log(level, \"message {1}\");  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    logger4.log(level, \"message {0}\", param1);\n+    logger4.log(level, \"message {1}\", param1);  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    logger4.log(level, \"message {0}\", new Exception());  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    logger4.log(level, \"message {0}\", new Object[] {param1});\n+    logger4.log(level, \"message {0}\", new Object[] {new Exception()}); // Compliant, exceptions are not removed from argument list\n+    logger4.log(level, \"message {1}\", new Object[] {param1});  // Compliant, detected by S2275 \"Not enough arguments.\"\n+    logger4.log(level, \"message {0}\", new Object[] {param1, new Exception()}); // Noncompliant {{2nd argument is not used.}}\n+    logger4.log(level, \"message {0} {1}\", new Object[] {param1, param2});\n+    logger4.log(level, \"message {0} {1}\", new Object[] {param1, param2, param3}); // Noncompliant {{3rd argument is not used.}}\n+    logger4.log(level, \"message \" + param1); // Noncompliant {{Format specifiers or lambda should be used instead of string concatenation.}}\n+    logger4.log(level, \"message \" + \"...\");\n+    logger4.log(level, \"message \" + param1, new Exception()); // Noncompliant {{Lambda should be used to differ string concatenation.}}\n \n     org.apache.logging.log4j.Logger log4j = org.apache.logging.log4j.LogManager.getLogger();\n+    org.apache.logging.log4j.Logger formatterLogger = LogManager.getFormatterLogger();\n+\n     log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message\");  // Compliant\n     log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message\", 1);  // Noncompliant {{String contains no format specifiers.}}\n     log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message {}\", 1);  // Compliant\n     log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message {}\", 1, \"hello\");  // Noncompliant\n-    log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message %d\", 1);  // Compliant\n-    log4j.log(org.apache.logging.log4j.Level.DEBUG, \"message %d\", 1, \"hello\");  // Noncompliant\n+    formatterLogger.log(org.apache.logging.log4j.Level.DEBUG, \"message %d\", 1);  // Compliant\n+    formatterLogger.log(org.apache.logging.log4j.Level.DEBUG, \"message %d\", 1, \"hello\");  // Noncompliant\n \n     log4j.debug(\"message\"); // Compliant\n     log4j.debug(\"message\", 1); // Noncompliant\n"}}, {"oid": "7d1db1b9f3bb2d044734208967e4a16f5dae4098", "url": "https://github.com/SonarSource/sonar-java/commit/7d1db1b9f3bb2d044734208967e4a16f5dae4098", "message": "Fix from review", "committedDate": "2020-02-20T15:07:05Z", "type": "forcePushed"}, {"oid": "bf17a39e70ed86a2e2faeb94edb31f2a6973ec8b", "url": "https://github.com/SonarSource/sonar-java/commit/bf17a39e70ed86a2e2faeb94edb31f2a6973ec8b", "message": "Move unit test in java-checks-test-sources", "committedDate": "2020-02-20T16:26:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwNDE3NQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2815#discussion_r382504175", "bodyText": "useless parenthesis", "author": "m-g-sonar", "createdAt": "2020-02-21T10:22:11Z", "path": "java-checks/src/main/java/org/sonar/java/checks/AbstractPrintfChecker.java", "diffHunk": "@@ -120,25 +133,29 @@ protected final void checkFormatting(MethodInvocationTree mit, boolean isMessage\n     }\n     if (formatTree.is(Tree.Kind.STRING_LITERAL)) {\n       String formatString = LiteralUtils.trimQuotes(((LiteralTree) formatTree).value());\n-      if (mit.symbol().owner().type().is(ORG_APACHE_LOGGING_LOG4J_LOGGER)) {\n-        // Log4J supports both approaches\n-        isMessageFormat = formatString.contains(\"{}\");\n+      if (isMessageFormat && isProbablyLog4jFormatterLogger(mit, formatString)) {\n+        isMessageFormat = false;\n       }\n       if (isMessageFormat) {\n         handleMessageFormat(mit, formatString, args);\n       } else {\n         handlePrintfFormat(mit, formatString, args);\n       }\n     } else {\n-      handleOtherFormatTree(mit, formatTree);\n+      handleOtherFormatTree(mit, formatTree, args);\n     }\n   }\n \n+  private static boolean isProbablyLog4jFormatterLogger(MethodInvocationTree mit, String formatString) {\n+    return mit.symbol().owner().type().is(ORG_APACHE_LOGGING_LOG4J_LOGGER) &&\n+          (!formatString.contains(\"{}\") && formatString.contains(\"%\"));", "originalCommit": "bf17a39e70ed86a2e2faeb94edb31f2a6973ec8b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bac6cf3cf0a3d5aabae948d5ea56876d52b172b4", "chunk": "diff --git a/java-checks/src/main/java/org/sonar/java/checks/AbstractPrintfChecker.java b/java-checks/src/main/java/org/sonar/java/checks/AbstractPrintfChecker.java\nindex 2f06d57f5..f7f52dcd1 100644\n--- a/java-checks/src/main/java/org/sonar/java/checks/AbstractPrintfChecker.java\n+++ b/java-checks/src/main/java/org/sonar/java/checks/AbstractPrintfChecker.java\n\n@@ -133,8 +121,9 @@ public abstract class AbstractPrintfChecker extends AbstractMethodDetection {\n     }\n     if (formatTree.is(Tree.Kind.STRING_LITERAL)) {\n       String formatString = LiteralUtils.trimQuotes(((LiteralTree) formatTree).value());\n-      if (isMessageFormat && isProbablyLog4jFormatterLogger(mit, formatString)) {\n-        isMessageFormat = false;\n+      if (mit.symbol().owner().type().is(ORG_APACHE_LOGGING_LOG4J_LOGGER)) {\n+        // Log4J supports both approaches\n+        isMessageFormat = formatString.contains(\"{}\");\n       }\n       if (isMessageFormat) {\n         handleMessageFormat(mit, formatString, args);\n"}}, {"oid": "bac6cf3cf0a3d5aabae948d5ea56876d52b172b4", "url": "https://github.com/SonarSource/sonar-java/commit/bac6cf3cf0a3d5aabae948d5ea56876d52b172b4", "message": "SONARJAVA-3290 S3457 should allow to use 'toString()' on exceptions to force usage of sl4j Logger(String, Object...)", "committedDate": "2020-02-21T13:34:24Z", "type": "commit"}, {"oid": "2c0bd7c65eed277879fcd293c57c0a9a663ebc8e", "url": "https://github.com/SonarSource/sonar-java/commit/2c0bd7c65eed277879fcd293c57c0a9a663ebc8e", "message": "Fix from review", "committedDate": "2020-02-21T13:34:24Z", "type": "commit"}, {"oid": "1cbf80a48805a1798f1f870b0381bfd16e441cbd", "url": "https://github.com/SonarSource/sonar-java/commit/1cbf80a48805a1798f1f870b0381bfd16e441cbd", "message": "Move unit test in java-checks-test-sources", "committedDate": "2020-02-21T13:34:24Z", "type": "commit"}, {"oid": "841c3243fce9f4b76f6c90b180338938a3a7ead0", "url": "https://github.com/SonarSource/sonar-java/commit/841c3243fce9f4b76f6c90b180338938a3a7ead0", "message": "Fix from review 2", "committedDate": "2020-02-21T13:34:24Z", "type": "commit"}, {"oid": "841c3243fce9f4b76f6c90b180338938a3a7ead0", "url": "https://github.com/SonarSource/sonar-java/commit/841c3243fce9f4b76f6c90b180338938a3a7ead0", "message": "Fix from review 2", "committedDate": "2020-02-21T13:34:24Z", "type": "forcePushed"}]}