{"pr_number": 3292, "pr_title": "SONARJAVA-3482 Support character classes as operand to reluctant quantifier in rule S5857", "pr_createdAt": "2020-11-20T12:22:55Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3292", "timeline": [{"oid": "78064b2f24272ac65f97f60c01f333d1e7cdb55b", "url": "https://github.com/SonarSource/sonar-java/commit/78064b2f24272ac65f97f60c01f333d1e7cdb55b", "message": "SONARJAVA-3482 Support character classes as operand to reluctant quantifier in rule S5857", "committedDate": "2020-11-20T11:43:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzNTUzMw==", "url": "https://github.com/SonarSource/sonar-java/pull/3292#discussion_r527835533", "bodyText": "In these cases (and the later ones involving \\s, \\d and \\w), the suggested replacement is too complicated because those classes don't contain >, so there's no need to exclude it. This also means that there's no potential for catastrophic backtracking behavior here, so using the ? here is not really problematic, but also entirely unnecessary (the regex would behave the same without it and be somewhat more efficient).\nSo in cases like this there should either be no issue or the message should instead be something along the lines of \"Make this regex greedy\" or \"Remove this '?'\".\nTo check whether a character class overlaps with the character after it, new SimplifiedRegexCharacterClass(base).intersects(new SimplifiedRegexCharacterClass(escapedClass), false) can be used in the code.", "author": "sebastian-hungerecker-sonarsource", "createdAt": "2020-11-20T17:09:26Z", "path": "java-checks-test-sources/src/main/java/checks/regex/ReluctantQuantifierCheck.java", "diffHunk": "@@ -4,7 +4,21 @@\n \n   void noncompliant(String str) {\n     str.matches(\"<.+?>\"); // Noncompliant [[sc=19;ec=22]] {{Replace this use of a reluctant quantifier with \"[^>]++\".}}\n+    str.matches(\"<\\\\S+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\s]++\".}}\n+    str.matches(\"<\\\\D+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\d]++\".}}\n+    str.matches(\"<\\\\W+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\w]++\".}}\n+    str.matches(\"<\\\\s+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\S]++\".}}\n+    str.matches(\"<\\\\d+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\D]++\".}}\n+    str.matches(\"<\\\\w+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\W]++\".}}", "originalCommit": "78064b2f24272ac65f97f60c01f333d1e7cdb55b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8716d085712c0ef8dec878d0f70a9c50e0e0883c", "chunk": "diff --git a/java-checks-test-sources/src/main/java/checks/regex/ReluctantQuantifierCheck.java b/java-checks-test-sources/src/main/java/checks/regex/ReluctantQuantifierCheck.java\nindex 4d7ee1841..5e35cfa63 100644\n--- a/java-checks-test-sources/src/main/java/checks/regex/ReluctantQuantifierCheck.java\n+++ b/java-checks-test-sources/src/main/java/checks/regex/ReluctantQuantifierCheck.java\n\n@@ -7,17 +7,11 @@ public class ReluctantQuantifierCheck {\n     str.matches(\"<\\\\S+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\s]++\".}}\n     str.matches(\"<\\\\D+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\d]++\".}}\n     str.matches(\"<\\\\W+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\w]++\".}}\n-    str.matches(\"<\\\\s+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\S]++\".}}\n-    str.matches(\"<\\\\d+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\D]++\".}}\n-    str.matches(\"<\\\\w+?>\"); // Noncompliant [[sc=19;ec=24]] {{Replace this use of a reluctant quantifier with \"[^>\\\\W]++\".}}\n \n     str.matches(\"<.{2,5}?>\"); // Noncompliant [[sc=19;ec=26]] {{Replace this use of a reluctant quantifier with \"[^>]{2,5}+\".}}\n     str.matches(\"<\\\\S{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\s]{2,5}+\".}}\n     str.matches(\"<\\\\D{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\d]{2,5}+\".}}\n     str.matches(\"<\\\\W{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\w]{2,5}+\".}}\n-    str.matches(\"<\\\\s{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\S]{2,5}+\".}}\n-    str.matches(\"<\\\\d{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\D]{2,5}+\".}}\n-    str.matches(\"<\\\\w{2,5}?>\"); // Noncompliant [[sc=19;ec=28]] {{Replace this use of a reluctant quantifier with \"[^>\\\\W]{2,5}+\".}}\n \n     str.matches(\"<.{2,}?>\"); // Noncompliant [[sc=19;ec=25]] {{Replace this use of a reluctant quantifier with \"[^>]{2,}+\".}}\n     str.matches(\"\\\".*?\\\"\"); // Noncompliant [[sc=20;ec=23]] {{Replace this use of a reluctant quantifier with \"[^\\\"]*+\".}}\n"}}, {"oid": "8716d085712c0ef8dec878d0f70a9c50e0e0883c", "url": "https://github.com/SonarSource/sonar-java/commit/8716d085712c0ef8dec878d0f70a9c50e0e0883c", "message": "SONARJAVA-3482 Support character classes as operand to reluctant quantifier in rule S5857", "committedDate": "2020-11-23T09:55:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYzMTIyNQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3292#discussion_r528631225", "bodyText": "Instead of new FlagSet(), we should be calling getFlagSet() here. Otherwise it won't take flags into account for cases like \"(?i)[a-z]*?X\" or Pattern.compile(\"[a-z]*?X\", Pattern.CASE_INSENSITIVE).\nEven with that change we can still get wrong results if a flag is only enabled for part of the regex (e.g. (?i:[a-z]*?)X where the i flag would already be unset by the time we call getFlagSet), but that's actually pretty tricky to handle with the current API. @alban-auzeill  is currently working on a change that will make it easy to query the flags for a specific RegexTree, so it's best to just use getFlags() for now and then we can replace it with base.getFlags() and tree.getFlags() respectively afterwards once Alban adds that method.", "author": "sebastian-hungerecker-sonarsource", "createdAt": "2020-11-23T11:19:47Z", "path": "java-checks/src/main/java/org/sonar/java/checks/regex/ReluctantQuantifierCheck.java", "diffHunk": "@@ -104,9 +108,30 @@ private String makePossessive(Quantifier quantifier) {\n       return Optional.of(result);\n     }\n \n+    private boolean hasNoIntersection(CharacterClassElementTree tree, @Nullable CharacterClassElementTree base) {\n+      return base != null && !new SimplifiedRegexCharacterClass(base, new FlagSet()).intersects(new SimplifiedRegexCharacterClass(tree, new FlagSet()), false);", "originalCommit": "8716d085712c0ef8dec878d0f70a9c50e0e0883c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "56f05e2a9c5e3a92eda73074e7dfc7ba2a86d9cb", "chunk": "diff --git a/java-checks/src/main/java/org/sonar/java/checks/regex/ReluctantQuantifierCheck.java b/java-checks/src/main/java/org/sonar/java/checks/regex/ReluctantQuantifierCheck.java\nindex 8fd5afafd..6cf9e8284 100644\n--- a/java-checks/src/main/java/org/sonar/java/checks/regex/ReluctantQuantifierCheck.java\n+++ b/java-checks/src/main/java/org/sonar/java/checks/regex/ReluctantQuantifierCheck.java\n\n@@ -108,8 +108,18 @@ public class ReluctantQuantifierCheck extends AbstractRegexCheck {\n       return Optional.of(result);\n     }\n \n+    @Nullable\n+    private EscapedCharacterClassTree getBaseCharacter(RegexTree tree) {\n+      return tree.is(RegexTree.Kind.DOT) ? null : (EscapedCharacterClassTree) tree;\n+    }\n+\n     private boolean hasNoIntersection(CharacterClassElementTree tree, @Nullable CharacterClassElementTree base) {\n-      return base != null && !new SimplifiedRegexCharacterClass(base, new FlagSet()).intersects(new SimplifiedRegexCharacterClass(tree, new FlagSet()), false);\n+      if (base == null) {\n+        return false;\n+      }\n+      SimplifiedRegexCharacterClass baseSimplifiedCharacterClass = new SimplifiedRegexCharacterClass(base, getActiveFlagSet());\n+      SimplifiedRegexCharacterClass treeSimplifiedCharacterClass = new SimplifiedRegexCharacterClass(tree, getActiveFlagSet());\n+      return !baseSimplifiedCharacterClass.intersects(treeSimplifiedCharacterClass, false);\n     }\n \n     private String escapedCharacterFollowedByEscapedCharacter(EscapedCharacterClassTree escapedClass, String ignoredSymbol) {\n"}}, {"oid": "56f05e2a9c5e3a92eda73074e7dfc7ba2a86d9cb", "url": "https://github.com/SonarSource/sonar-java/commit/56f05e2a9c5e3a92eda73074e7dfc7ba2a86d9cb", "message": "Adjust review comments", "committedDate": "2020-11-23T13:01:04Z", "type": "commit"}]}