{"pr_number": 10218, "pr_title": "[#10176] Fix authentication-related problems from UAT", "pr_createdAt": "2020-06-22T01:08:33Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10218", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NDE0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443284148", "bodyText": "The url param should be in lowercase?", "author": "xpdavid", "createdAt": "2020-06-22T01:56:06Z", "path": "src/main/java/teammates/ui/webapi/action/GetAuthInfoAction.java", "diffHunk": "@@ -32,17 +32,26 @@ public void checkSpecificAccessControl() {\n     @Override\n     public ActionResult execute() {\n         String frontendUrl = getRequestParamValue(\"frontendUrl\");\n+        String nextUrl = getRequestParamValue(\"nextUrl\");", "originalCommit": "59c055bb7139d598da030e683943e98a1b9bc745", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4NzA0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443487048", "bodyText": "Look at the line before it.", "author": "wkurniawan07", "createdAt": "2020-06-22T11:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NzM5NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443767395", "bodyText": "I notice that but all (maybe) others actions use lowercase url params (see Const#ParamsNames)", "author": "xpdavid", "createdAt": "2020-06-22T19:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NDE0OA=="}], "type": "inlineReview", "revised_code": {"commit": "049934abc32a310ea92faebaeddea830145046ee", "chunk": "diff --git a/src/main/java/teammates/ui/webapi/action/GetAuthInfoAction.java b/src/main/java/teammates/ui/webapi/action/GetAuthInfoAction.java\nindex 622b5e8f93..79407de04d 100644\n--- a/src/main/java/teammates/ui/webapi/action/GetAuthInfoAction.java\n+++ b/src/main/java/teammates/ui/webapi/action/GetAuthInfoAction.java\n\n@@ -32,26 +32,17 @@ public class GetAuthInfoAction extends Action {\n     @Override\n     public ActionResult execute() {\n         String frontendUrl = getRequestParamValue(\"frontendUrl\");\n-        String nextUrl = getRequestParamValue(\"nextUrl\");\n         if (frontendUrl == null) {\n             frontendUrl = \"\";\n         }\n \n         AuthInfo output;\n         if (userInfo == null) {\n-            if (nextUrl == null) {\n-                output = new AuthInfo(\n-                        gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.STUDENT_HOME_PAGE),\n-                        gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.INSTRUCTOR_HOME_PAGE),\n-                        gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.ADMIN_HOME_PAGE)\n-                );\n-            } else {\n-                output = new AuthInfo(\n-                        gateKeeper.getLoginUrl(frontendUrl + nextUrl),\n-                        gateKeeper.getLoginUrl(frontendUrl + nextUrl),\n-                        gateKeeper.getLoginUrl(frontendUrl + nextUrl)\n-                );\n-            }\n+            output = new AuthInfo(\n+                    gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.STUDENT_HOME_PAGE),\n+                    gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.INSTRUCTOR_HOME_PAGE),\n+                    gateKeeper.getLoginUrl(frontendUrl + Const.WebPageURIs.ADMIN_HOME_PAGE)\n+            );\n         } else {\n             String googleId = userInfo.getId();\n             AccountAttributes accountInfo = logic.getAccount(googleId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MzEzMA==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443293130", "bodyText": "Might result in NPE when the regkey is not valid", "author": "xpdavid", "createdAt": "2020-06-22T02:46:05Z", "path": "src/main/java/teammates/ui/webapi/action/GetRegkeyValidityAction.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package teammates.ui.webapi.action;\n+\n+import teammates.common.datatransfer.attributes.StudentAttributes;\n+import teammates.common.util.Const;\n+import teammates.common.util.StringHelper;\n+import teammates.ui.webapi.output.RegkeyValidityData;\n+import teammates.ui.webapi.request.Intent;\n+\n+/**\n+ * Action: checks whether the provided registration key is valid for the logged in user.\n+ *\n+ * <p>This does not log in or log out the user.\n+ */\n+public class GetRegkeyValidityAction extends Action {\n+\n+    @Override\n+    public AuthType getMinAuthLevel() {\n+        return AuthType.PUBLIC;\n+    }\n+\n+    @Override\n+    public void checkSpecificAccessControl() {\n+        // Regkey information is available to everyone\n+    }\n+\n+    @Override\n+    public ActionResult execute() {\n+        Intent intent = Intent.valueOf(getNonNullRequestParamValue(Const.ParamsNames.INTENT));\n+        String regkey = getNonNullRequestParamValue(Const.ParamsNames.REGKEY);\n+\n+        boolean isValid = true;\n+        boolean isLoggedIn = userInfo != null;\n+\n+        if (intent == Intent.STUDENT_SUBMISSION || intent == Intent.STUDENT_RESULT) {\n+            StudentAttributes student = logic.getStudentForRegistrationKey(regkey);\n+\n+            if (!StringHelper.isEmpty(student.googleId)) {", "originalCommit": "3aae37bdda50ed8c247c7742b14ad7eb58d984b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e413a3fd8fe13e0f593bbd1ddc72f2173bb62f5", "chunk": "diff --git a/src/main/java/teammates/ui/webapi/action/GetRegkeyValidityAction.java b/src/main/java/teammates/ui/webapi/action/GetRegkeyValidityAction.java\nindex f0206842a8..03b9c505ff 100644\n--- a/src/main/java/teammates/ui/webapi/action/GetRegkeyValidityAction.java\n+++ b/src/main/java/teammates/ui/webapi/action/GetRegkeyValidityAction.java\n\n@@ -29,15 +29,16 @@ public class GetRegkeyValidityAction extends Action {\n         String regkey = getNonNullRequestParamValue(Const.ParamsNames.REGKEY);\n \n         boolean isValid = true;\n-        boolean isLoggedIn = userInfo != null;\n \n         if (intent == Intent.STUDENT_SUBMISSION || intent == Intent.STUDENT_RESULT) {\n             StudentAttributes student = logic.getStudentForRegistrationKey(regkey);\n \n-            if (!StringHelper.isEmpty(student.googleId)) {\n+            if (student == null) {\n+                isValid = false;\n+            } else if (!StringHelper.isEmpty(student.googleId)) {\n                 // If the registration key has been used to register, the logged in user needs to match\n                 // Block access to not logged in user and mismatched user\n-                if (isLoggedIn) {\n+                if (userInfo != null) {\n                     isValid = student.googleId.equals(userInfo.id);\n                 } else {\n                     isValid = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5Mzc5Mw==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443293793", "bodyText": "Is this field used in the frontend?", "author": "xpdavid", "createdAt": "2020-06-22T02:49:27Z", "path": "src/main/java/teammates/ui/webapi/output/RegkeyValidityData.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package teammates.ui.webapi.output;\n+\n+/**\n+ * The API output format to represent if the registration key is valid for the logged in user (or lack thereof).\n+ */\n+public class RegkeyValidityData extends ApiOutput {\n+    private final boolean isValid;\n+    private final boolean isLoggedIn;", "originalCommit": "3aae37bdda50ed8c247c7742b14ad7eb58d984b2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e413a3fd8fe13e0f593bbd1ddc72f2173bb62f5", "chunk": "diff --git a/src/main/java/teammates/ui/webapi/output/RegkeyValidityData.java b/src/main/java/teammates/ui/webapi/output/RegkeyValidityData.java\nindex 25f64da2f8..022f0afc41 100644\n--- a/src/main/java/teammates/ui/webapi/output/RegkeyValidityData.java\n+++ b/src/main/java/teammates/ui/webapi/output/RegkeyValidityData.java\n\n@@ -5,11 +5,9 @@ package teammates.ui.webapi.output;\n  */\n public class RegkeyValidityData extends ApiOutput {\n     private final boolean isValid;\n-    private final boolean isLoggedIn;\n \n-    public RegkeyValidityData(boolean isValid, boolean isLoggedIn) {\n+    public RegkeyValidityData(boolean isValid) {\n         this.isValid = isValid;\n-        this.isLoggedIn = isLoggedIn;\n     }\n \n     /**\n"}}, {"oid": "2e413a3fd8fe13e0f593bbd1ddc72f2173bb62f5", "url": "https://github.com/TEAMMATES/teammates/commit/2e413a3fd8fe13e0f593bbd1ddc72f2173bb62f5", "message": "Add redirect to login page for course join", "committedDate": "2020-06-22T11:40:08Z", "type": "forcePushed"}, {"oid": "049934abc32a310ea92faebaeddea830145046ee", "url": "https://github.com/TEAMMATES/teammates/commit/049934abc32a310ea92faebaeddea830145046ee", "message": "Fix submission and result URL in admin search page", "committedDate": "2020-06-22T22:21:47Z", "type": "commit"}, {"oid": "cd120d04cb53ce5b3181672b1bd205ac7e00ff63", "url": "https://github.com/TEAMMATES/teammates/commit/cd120d04cb53ce5b3181672b1bd205ac7e00ff63", "message": "Allow passing nextUrl to auth API", "committedDate": "2020-06-22T22:21:49Z", "type": "commit"}, {"oid": "04c69ad4ef08f3d638cad11ea6a7e0efc07fd0ba", "url": "https://github.com/TEAMMATES/teammates/commit/04c69ad4ef08f3d638cad11ea6a7e0efc07fd0ba", "message": "Add redirect to login page for course join", "committedDate": "2020-06-22T22:21:49Z", "type": "forcePushed"}, {"oid": "c1026d3da40fcfd2d73ecc60ae36556973170d0b", "url": "https://github.com/TEAMMATES/teammates/commit/c1026d3da40fcfd2d73ecc60ae36556973170d0b", "message": "Add endpoint to check regkey validity", "committedDate": "2020-06-22T22:42:13Z", "type": "commit"}, {"oid": "456c9aeb2c1dc33fcff864bca8c4e76bc44c387b", "url": "https://github.com/TEAMMATES/teammates/commit/456c9aeb2c1dc33fcff864bca8c4e76bc44c387b", "message": "Add auth flow for student submission page", "committedDate": "2020-06-22T22:42:13Z", "type": "commit"}, {"oid": "d7f6001b8b8926841285b17ad6c654ac412ab492", "url": "https://github.com/TEAMMATES/teammates/commit/d7f6001b8b8926841285b17ad6c654ac412ab492", "message": "Add auth flow for student session results page", "committedDate": "2020-06-22T22:42:13Z", "type": "commit"}, {"oid": "4c6e4eaf3880d654a9aa8cdd82a1d7078ca5c36c", "url": "https://github.com/TEAMMATES/teammates/commit/4c6e4eaf3880d654a9aa8cdd82a1d7078ca5c36c", "message": "Add redirect to login page for course join", "committedDate": "2020-06-22T22:42:13Z", "type": "commit"}, {"oid": "4c6e4eaf3880d654a9aa8cdd82a1d7078ca5c36c", "url": "https://github.com/TEAMMATES/teammates/commit/4c6e4eaf3880d654a9aa8cdd82a1d7078ca5c36c", "message": "Add redirect to login page for course join", "committedDate": "2020-06-22T22:42:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwMDQ4Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443900486", "bodyText": "I'm assuming that with the new auth flow you can't access the results page as an admin? Just confirming, because this guard clause is being fixed in #9994", "author": "madanalogy", "createdAt": "2020-06-23T00:48:03Z", "path": "src/main/java/teammates/ui/webapi/action/GetSessionResultsAction.java", "diffHunk": "@@ -25,10 +25,6 @@ protected AuthType getMinAuthLevel() {\n \n     @Override\n     public void checkSpecificAccessControl() {\n-        if (userInfo.isAdmin) {\n-            return;\n-        }\n-", "originalCommit": "d7f6001b8b8926841285b17ad6c654ac412ab492", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwMTk5Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10218#discussion_r443901997", "bodyText": "There is no reason for admin to have this elevated privilege.", "author": "wkurniawan07", "createdAt": "2020-06-23T00:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwMDQ4Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2ab731546d6f531dad555494b4ae47eee526c27c", "url": "https://github.com/TEAMMATES/teammates/commit/2ab731546d6f531dad555494b4ae47eee526c27c", "message": "Merge branch 'master' into uat-fixes-auth", "committedDate": "2020-06-23T01:05:40Z", "type": "commit"}]}