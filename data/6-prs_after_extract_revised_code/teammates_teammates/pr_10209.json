{"pr_number": 10209, "pr_title": "[#10176] Fix section-related problems in session results page", "pr_createdAt": "2020-06-18T23:55:47Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10209", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5OTY1NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442599655", "bodyText": "When I write the refactored version, I have considered the case for DEFAULT_SECTION.  To me, it looks like adding support for No specific section does not need to modify the backend. What happened if we do not modify the logic?\nActually, DEFAULT_SECTION does not mean it comes from Instructors. V6 actually allows default section for students if section is not provided (P.S. the behavior need to be changed in V6).", "author": "xpdavid", "createdAt": "2020-06-19T02:35:15Z", "path": "src/main/java/teammates/logic/core/FeedbackSessionsLogic.java", "diffHunk": "@@ -1521,20 +1522,46 @@ public SessionResultsBundle getSessionResultsForUser(\n             allQuestionsMap.put(qn.getId(), qn);\n         }\n \n+        List<FeedbackQuestionAttributes> questionsWithDefaultSections = new ArrayList<>();\n+        if (Const.DEFAULT_SECTION.equals(section)) {", "originalCommit": "b0c35d8d1d905c12c4eb58634bdba6e4d55c7fdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYyOTY0MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442629641", "bodyText": "Looks like you're right. For some reason I didn't manage to get it work before.", "author": "wkurniawan07", "createdAt": "2020-06-19T04:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5OTY1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fca99c818847a2dbfee777e6eac0acd9f3c624f8", "chunk": "diff --git a/src/main/java/teammates/logic/core/FeedbackSessionsLogic.java b/src/main/java/teammates/logic/core/FeedbackSessionsLogic.java\nindex 0e96471be4..41ce7c04a7 100644\n--- a/src/main/java/teammates/logic/core/FeedbackSessionsLogic.java\n+++ b/src/main/java/teammates/logic/core/FeedbackSessionsLogic.java\n\n@@ -1522,46 +1521,20 @@ public final class FeedbackSessionsLogic {\n             allQuestionsMap.put(qn.getId(), qn);\n         }\n \n-        List<FeedbackQuestionAttributes> questionsWithDefaultSections = new ArrayList<>();\n-        if (Const.DEFAULT_SECTION.equals(section)) {\n-            questionsWithDefaultSections = fqLogic.getFeedbackQuestionsForSession(feedbackSessionName, courseId)\n-                    .stream()\n-                    .filter(question -> question.giverType == FeedbackParticipantType.INSTRUCTORS\n-                            || question.recipientType == FeedbackParticipantType.INSTRUCTORS\n-                            || question.recipientType == FeedbackParticipantType.NONE\n-                    ).collect(Collectors.toList());\n-        }\n-\n         // load response(s)\n         List<FeedbackResponseAttributes> allResponses;\n-        if (Const.DEFAULT_SECTION.equals(section)) {\n-            allResponses = questionsWithDefaultSections.stream()\n-                    .filter(question -> questionId == null || question.getId() == questionId)\n-                    .map(question -> frLogic.getFeedbackResponsesForQuestion(question.getId()))\n-                    .flatMap(Collection::stream)\n-                    .collect(Collectors.toList());\n+        if (questionId == null) {\n+            allResponses = frLogic.getFeedbackResponsesForSessionInSection(feedbackSessionName, courseId, section);\n         } else {\n-            if (questionId == null) {\n-                allResponses = frLogic.getFeedbackResponsesForSessionInSection(feedbackSessionName, courseId, section);\n-            } else {\n-                allResponses = frLogic.getFeedbackResponsesForQuestionInSection(questionId, section, SectionDetail.EITHER);\n-            }\n+            allResponses = frLogic.getFeedbackResponsesForQuestionInSection(questionId, section, SectionDetail.EITHER);\n         }\n \n         // load comment(s)\n         List<FeedbackResponseCommentAttributes> allComments;\n-        if (Const.DEFAULT_SECTION.equals(section)) {\n-            allComments = questionsWithDefaultSections.stream()\n-                    .filter(question -> questionId == null || question.getId() == questionId)\n-                    .map(question -> frcLogic.getFeedbackResponseCommentForQuestionInSection(question.getId(), null))\n-                    .flatMap(Collection::stream)\n-                    .collect(Collectors.toList());\n+        if (questionId == null) {\n+            allComments = frcLogic.getFeedbackResponseCommentForSessionInSection(courseId, feedbackSessionName, section);\n         } else {\n-            if (questionId == null) {\n-                allComments = frcLogic.getFeedbackResponseCommentForSessionInSection(courseId, feedbackSessionName, section);\n-            } else {\n-                allComments = frcLogic.getFeedbackResponseCommentForQuestionInSection(questionId, section);\n-            }\n+            allComments = frcLogic.getFeedbackResponseCommentForQuestionInSection(questionId, section);\n         }\n \n         // related questions, responses, and comment\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442601060", "bodyText": "The logic should be in getRecipientSection? and we don't need to check intent?", "author": "xpdavid", "createdAt": "2020-06-19T02:41:08Z", "path": "src/main/java/teammates/ui/webapi/action/CreateFeedbackResponseAction.java", "diffHunk": "@@ -96,12 +96,17 @@ public ActionResult execute() {\n         }\n \n         FeedbackResponseCreateRequest createRequest = getAndValidateRequestBody(FeedbackResponseCreateRequest.class);\n+        String recipientSection = getRecipientSection(feedbackQuestion.getCourseId(),\n+                feedbackQuestion.getRecipientType(), createRequest.getRecipientIdentifier());\n+        if (intent == Intent.INSTRUCTOR_SUBMISSION && feedbackQuestion.giverType == FeedbackParticipantType.INSTRUCTORS", "originalCommit": "3c4810c586b93392ba1fcf68c0b6682b76ce490c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYyODYzOQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442628639", "bodyText": "SELF being mapped to Const.DEFAULT_SECTION is not right for student giver type.", "author": "wkurniawan07", "createdAt": "2020-06-19T04:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYyOTI2NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442629265", "bodyText": "I mean we should put the logic inside getRecipientSection :P", "author": "xpdavid", "createdAt": "2020-06-19T04:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzMTI5Mg==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442631292", "bodyText": "Intent is necessary to sieve out student-instructors.", "author": "wkurniawan07", "createdAt": "2020-06-19T04:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzNjY3MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442636671", "bodyText": "Actually if we don't remove the check for intent, the case you mention will cause exactly the problem you have fixed.\nFor student-instructor path, the recipient section should be 'None' rather than student's section.", "author": "xpdavid", "createdAt": "2020-06-19T05:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY0MjkyMQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442642921", "bodyText": "I meant it's to sieve out students and instructors for entities that are both. Student-instructor feedback path is common and doesn't belong here.", "author": "wkurniawan07", "createdAt": "2020-06-19T05:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwMTA2MA=="}], "type": "inlineReview", "revised_code": {"commit": "fca99c818847a2dbfee777e6eac0acd9f3c624f8", "chunk": "diff --git a/src/main/java/teammates/ui/webapi/action/CreateFeedbackResponseAction.java b/src/main/java/teammates/ui/webapi/action/CreateFeedbackResponseAction.java\nindex 46917d1140..31f2431e66 100644\n--- a/src/main/java/teammates/ui/webapi/action/CreateFeedbackResponseAction.java\n+++ b/src/main/java/teammates/ui/webapi/action/CreateFeedbackResponseAction.java\n\n@@ -96,17 +96,12 @@ public class CreateFeedbackResponseAction extends BasicFeedbackSubmissionAction\n         }\n \n         FeedbackResponseCreateRequest createRequest = getAndValidateRequestBody(FeedbackResponseCreateRequest.class);\n-        String recipientSection = getRecipientSection(feedbackQuestion.getCourseId(),\n-                feedbackQuestion.getRecipientType(), createRequest.getRecipientIdentifier());\n-        if (intent == Intent.INSTRUCTOR_SUBMISSION && feedbackQuestion.giverType == FeedbackParticipantType.INSTRUCTORS\n-                && feedbackQuestion.recipientType == FeedbackParticipantType.SELF) {\n-            recipientSection = Const.DEFAULT_SECTION;\n-        }\n         FeedbackResponseAttributes feedbackResponse =\n                 FeedbackResponseAttributes\n                         .builder(feedbackQuestion.getId(), giverIdentifier, createRequest.getRecipientIdentifier())\n                 .withGiverSection(giverSection)\n-                .withRecipientSection(recipientSection)\n+                .withRecipientSection(getRecipientSection(feedbackQuestion.getCourseId(),\n+                        feedbackQuestion.getRecipientType(), createRequest.getRecipientIdentifier()))\n                 .withCourseId(feedbackQuestion.getCourseId())\n                 .withFeedbackSessionName(feedbackQuestion.getFeedbackSessionName())\n                 .withResponseDetails(createRequest.getResponseDetails())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY0NzQyMg==", "url": "https://github.com/TEAMMATES/teammates/pull/10209#discussion_r442647422", "bodyText": "So Yup, I am proposing new solution here.\nBy right, when the recipientType is SELF, we should examine the giverType instead. If we didn't do this, it will work if an account is either student or instructor but will generate wrong section when the account is both student and instructor.\nThe fix will not only cover your if check but will also fix other problems (self (the self is feedback creator (instructor)) -> self, team -> self) (P.S. look like we found some bugs).", "author": "xpdavid", "createdAt": "2020-06-19T06:03:52Z", "path": "src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java", "diffHunk": "@@ -155,12 +155,12 @@ protected String getRecipientSection(\n             String courseId, FeedbackParticipantType recipientType, String recipientIdentifier) {\n         switch (recipientType) {\n         case INSTRUCTORS:\n-        case SELF:\n         case NONE:\n             return Const.DEFAULT_SECTION;\n         case TEAMS:\n         case OWN_TEAM:\n             return logic.getSectionForTeam(courseId, recipientIdentifier);\n+        case SELF:", "originalCommit": "3c4810c586b93392ba1fcf68c0b6682b76ce490c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fca99c818847a2dbfee777e6eac0acd9f3c624f8", "chunk": "diff --git a/src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java b/src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java\nindex c60dfec653..0ab2dce2d1 100644\n--- a/src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java\n+++ b/src/main/java/teammates/ui/webapi/action/BasicFeedbackSubmissionAction.java\n\n@@ -155,12 +155,12 @@ public abstract class BasicFeedbackSubmissionAction extends Action {\n             String courseId, FeedbackParticipantType recipientType, String recipientIdentifier) {\n         switch (recipientType) {\n         case INSTRUCTORS:\n+        case SELF:\n         case NONE:\n             return Const.DEFAULT_SECTION;\n         case TEAMS:\n         case OWN_TEAM:\n             return logic.getSectionForTeam(courseId, recipientIdentifier);\n-        case SELF:\n         case STUDENTS:\n         case OWN_TEAM_MEMBERS:\n         case OWN_TEAM_MEMBERS_INCLUDING_SELF:\n"}}, {"oid": "fca99c818847a2dbfee777e6eac0acd9f3c624f8", "url": "https://github.com/TEAMMATES/teammates/commit/fca99c818847a2dbfee777e6eac0acd9f3c624f8", "message": "Fix display logic for instructor questions", "committedDate": "2020-06-19T13:44:39Z", "type": "commit"}, {"oid": "45d5b9b537a20036697cba1a519d2ef585a4e812", "url": "https://github.com/TEAMMATES/teammates/commit/45d5b9b537a20036697cba1a519d2ef585a4e812", "message": "Fix logic for determining recipient section", "committedDate": "2020-06-19T13:58:40Z", "type": "commit"}, {"oid": "1cb67d8af5ec46e5f96423aee2d54f670226a980", "url": "https://github.com/TEAMMATES/teammates/commit/1cb67d8af5ec46e5f96423aee2d54f670226a980", "message": "Add filter for DEFAULT_SECTION", "committedDate": "2020-06-19T13:58:40Z", "type": "commit"}, {"oid": "1cb67d8af5ec46e5f96423aee2d54f670226a980", "url": "https://github.com/TEAMMATES/teammates/commit/1cb67d8af5ec46e5f96423aee2d54f670226a980", "message": "Add filter for DEFAULT_SECTION", "committedDate": "2020-06-19T13:58:40Z", "type": "forcePushed"}, {"oid": "a0b686c91181e76e8b0e3cf1a3791a27202204bb", "url": "https://github.com/TEAMMATES/teammates/commit/a0b686c91181e76e8b0e3cf1a3791a27202204bb", "message": "Merge branch 'master' into uat-fixes-section", "committedDate": "2020-06-19T17:21:12Z", "type": "commit"}]}