{"pr_number": 1091, "pr_title": "DPC-554 fix: Require `Accept` header", "pr_createdAt": "2020-10-16T15:39:43Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1091", "timeline": [{"oid": "403100a7866a0c8cf15d8fc62431bc14d7cf8c11", "url": "https://github.com/CMSgov/dpc-app/commit/403100a7866a0c8cf15d8fc62431bc14d7cf8c11", "message": "fix: make `Prefer` variable lowercase", "committedDate": "2020-10-16T14:19:53Z", "type": "commit"}, {"oid": "a556a6910dc24c9df346ff07ac9e61392f36ef1d", "url": "https://github.com/CMSgov/dpc-app/commit/a556a6910dc24c9df346ff07ac9e61392f36ef1d", "message": "fix: add test for required `Prefer` header", "committedDate": "2020-10-16T15:56:35Z", "type": "commit"}, {"oid": "3be1cfac7fa701246cbcc2738cce2d0f261b363e", "url": "https://github.com/CMSgov/dpc-app/commit/3be1cfac7fa701246cbcc2738cce2d0f261b363e", "message": "feat: add `Accept` header param", "committedDate": "2020-10-16T18:53:43Z", "type": "commit"}, {"oid": "cbfe60fff9766c38b78387cc1fb311ae687ae932", "url": "https://github.com/CMSgov/dpc-app/commit/cbfe60fff9766c38b78387cc1fb311ae687ae932", "message": "fix: mv/simplify test and check for accept header", "committedDate": "2020-10-16T18:54:21Z", "type": "commit"}, {"oid": "6d1424cade9534173ca603eed72097d65c9c3f3d", "url": "https://github.com/CMSgov/dpc-app/commit/6d1424cade9534173ca603eed72097d65c9c3f3d", "message": "fix: update test and make it pass", "committedDate": "2020-10-19T15:42:02Z", "type": "commit"}, {"oid": "6d1424cade9534173ca603eed72097d65c9c3f3d", "url": "https://github.com/CMSgov/dpc-app/commit/6d1424cade9534173ca603eed72097d65c9c3f3d", "message": "fix: update test and make it pass", "committedDate": "2020-10-19T15:42:02Z", "type": "forcePushed"}, {"oid": "ddb677d32fa9efba5ce93ec5664bc7698f5dca53", "url": "https://github.com/CMSgov/dpc-app/commit/ddb677d32fa9efba5ce93ec5664bc7698f5dca53", "message": "Merge branch 'master' into jkf/DPC-554-require-accept-header", "committedDate": "2020-10-19T17:55:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNjg0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/1091#discussion_r508216846", "bodyText": "I feel like this check should also be in the checkRequestHeaders method", "author": "MrBilnon", "createdAt": "2020-10-20T05:24:08Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -268,15 +273,25 @@ public Response export(@ApiParam(hidden = true)\n                            @PathParam(\"rosterID\") @NoHtml String rosterID,\n                            @ApiParam(value = \"List of FHIR resources to export\", allowableValues = \"ExplanationOfBenefits, Coverage, Patient\")\n                            @QueryParam(\"_type\") @NoHtml String resourceTypes,\n-                           @ApiParam(value = \"Output format of requested data\", allowableValues = FHIR_NDJSON , defaultValue = FHIR_NDJSON)\n+                           @ApiParam(value = \"Output format of requested data\", allowableValues = FHIR_NDJSON, defaultValue = FHIR_NDJSON)\n                            @QueryParam(\"_outputFormat\") @NoHtml String outputFormat,\n                            @ApiParam(value = \"Resources will be included in the response if their state has changed after the supplied time (e.g. if Resource.meta.lastUpdated is later than the supplied _since time).\")\n                            @QueryParam(\"_since\") @NoHtml String since,\n-                           @ApiParam(hidden = true) @HeaderParam(\"Prefer\")  @Valid String Prefer) {\n+                           @ApiParam(hidden = true) @HeaderParam(\"Prefer\") @Valid String prefer,\n+                           @ApiParam(hidden = true) @HeaderParam(\"Accept\") @Valid String accept) {\n         logger.info(\"Exporting data for provider: {} _since: {}\", rosterID, since);\n \n         // Check the parameters\n-        checkExportRequest(outputFormat, Prefer);\n+        Map<String, String> headers = Stream.of(Pair.of(\"Prefer\", prefer), Pair.of(\"Accept\", accept))\n+                .peek(header -> {\n+                    if (header.getRight() == null) {", "originalCommit": "ddb677d32fa9efba5ce93ec5664bc7698f5dca53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMTcxMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1091#discussion_r508501711", "bodyText": "Initially it was, but it needs to be here in order to get rid of any null values before creating the Map since the Map does not allow a null to be set as a value. The point of this line of code is to build up a map of headers that can be passed down to the verification methods instead of multiple strings.", "author": "jonfulk", "createdAt": "2020-10-20T13:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNjg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NjUwMA==", "url": "https://github.com/CMSgov/dpc-app/pull/1091#discussion_r508576500", "bodyText": "ah I see.. maybe filter out the nulls instead and then do a check on an empty map or missing key in the checkRequestHeaders?  Sorry, just seeing if there is a way to contain the BadRequestException to the check methods.", "author": "MrBilnon", "createdAt": "2020-10-20T14:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNjg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NDkwOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1091#discussion_r508644909", "bodyText": "I appreciate the suggestions. I'll look into that. I considered that approach as well, but I ran into the issue of losing track of which header value was for which header in the Map, which was necessary in order to give the proper error message.", "author": "jonfulk", "createdAt": "2020-10-20T15:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNjg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5MTY2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/1091#discussion_r508691663", "bodyText": "You can add @DefaultValue(\"\") to each header and that will handle any NPE, but you would still need to build the map.\nIt looks like there are only two headers at the moment, so we could just pass those two as arguments without a map.\nAnother option that we can use if we ever need more headers is to use @Context HttpHeaders headers,\nthis will give you a nice way to manage multiple headers without having to explicitly specify each header in the method signature.", "author": "MrMorie", "createdAt": "2020-10-20T16:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNjg0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "8b08a7a570dfdaf3f585d953f2100d115531d5c1", "chunk": "diff --git a/dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java b/dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java\nindex b4d4b301..e9153059 100644\n--- a/dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java\n+++ b/dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java\n\n@@ -282,16 +281,7 @@ public class GroupResource extends AbstractGroupResource {\n         logger.info(\"Exporting data for provider: {} _since: {}\", rosterID, since);\n \n         // Check the parameters\n-        Map<String, String> headers = Stream.of(Pair.of(\"Prefer\", prefer), Pair.of(\"Accept\", accept))\n-                .peek(header -> {\n-                    if (header.getRight() == null) {\n-                        throw new BadRequestException(\"The \" + header.getLeft() + \" header is required\");\n-                    }\n-                })\n-                .map(pair -> Map.entry(pair.getLeft(), pair.getRight()))\n-                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n-\n-        checkExportRequest(outputFormat, headers);\n+        checkExportRequest(outputFormat, List.of(Pair.of(\"Prefer\", prefer), Pair.of(\"Accept\", accept)));\n \n         // Get the attributed patients\n         final List<String> attributedPatients = fetchPatientMBIs(rosterID);\n"}}, {"oid": "8b08a7a570dfdaf3f585d953f2100d115531d5c1", "url": "https://github.com/CMSgov/dpc-app/commit/8b08a7a570dfdaf3f585d953f2100d115531d5c1", "message": "fix: move `BadRequestExceptions` into the `check...` methods", "committedDate": "2020-10-20T17:30:09Z", "type": "commit"}, {"oid": "8b08a7a570dfdaf3f585d953f2100d115531d5c1", "url": "https://github.com/CMSgov/dpc-app/commit/8b08a7a570dfdaf3f585d953f2100d115531d5c1", "message": "fix: move `BadRequestExceptions` into the `check...` methods", "committedDate": "2020-10-20T17:30:09Z", "type": "forcePushed"}]}