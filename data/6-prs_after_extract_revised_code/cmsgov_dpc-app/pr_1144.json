{"pr_number": 1144, "pr_title": "DPC-953 Prohibit orgs from adding another orgs patient to their group.", "pr_createdAt": "2020-12-16T15:36:24Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1144", "timeline": [{"oid": "93e0353bfbd1aa8ccd838faa6bdc4178cec83919", "url": "https://github.com/CMSgov/dpc-app/commit/93e0353bfbd1aa8ccd838faa6bdc4178cec83919", "message": "Checked if patient belongs to org before adding to group. Introduced Authorized annotation", "committedDate": "2020-12-16T15:32:17Z", "type": "commit"}, {"oid": "72a7a7e25a13fededde61c5afe097c796b61b5a0", "url": "https://github.com/CMSgov/dpc-app/commit/72a7a7e25a13fededde61c5afe097c796b61b5a0", "message": "Merge branch 'master' of https://github.com/CMSgov/dpc-app into sg/DPC-953-Prohibit-adding-another-orgs-patient-to-group", "committedDate": "2020-12-16T15:33:04Z", "type": "commit"}, {"oid": "be68ed02ecd90f06d450d6c79590a1147ac8fbea", "url": "https://github.com/CMSgov/dpc-app/commit/be68ed02ecd90f06d450d6c79590a1147ac8fbea", "message": "Reverted back annotation name to PathAuthorizer", "committedDate": "2020-12-16T16:22:06Z", "type": "commit"}, {"oid": "c80712cde702a70ab252ca5254075c5613b61ccc", "url": "https://github.com/CMSgov/dpc-app/commit/c80712cde702a70ab252ca5254075c5613b61ccc", "message": "Refactored integration tests.", "committedDate": "2020-12-16T19:32:35Z", "type": "commit"}, {"oid": "ed0544735c40e052c3bf553f2c30644198e4031d", "url": "https://github.com/CMSgov/dpc-app/commit/ed0544735c40e052c3bf553f2c30644198e4031d", "message": "fixed typo in patient resource test", "committedDate": "2020-12-16T19:51:36Z", "type": "commit"}, {"oid": "a436de2539f5cd8e5a73dcd7bc83af5a43ebc1c9", "url": "https://github.com/CMSgov/dpc-app/commit/a436de2539f5cd8e5a73dcd7bc83af5a43ebc1c9", "message": "refacored group resource", "committedDate": "2020-12-16T20:17:21Z", "type": "commit"}, {"oid": "684f4eeb9474b42134c69d7977f9b172f928d72c", "url": "https://github.com/CMSgov/dpc-app/commit/684f4eeb9474b42134c69d7977f9b172f928d72c", "message": "Merge branch 'master' into sg/DPC-953-Prohibit-adding-another-orgs-patient-to-group", "committedDate": "2020-12-16T20:17:50Z", "type": "commit"}, {"oid": "997246c51abf30b7dbb9c9af3fce290710caab40", "url": "https://github.com/CMSgov/dpc-app/commit/997246c51abf30b7dbb9c9af3fce290710caab40", "message": "Re-ordered anotations in AuthDynamicFeature", "committedDate": "2020-12-17T18:54:14Z", "type": "commit"}, {"oid": "c43f3e565185dd6b300a9bcff982db630486a64b", "url": "https://github.com/CMSgov/dpc-app/commit/c43f3e565185dd6b300a9bcff982db630486a64b", "message": "Removed unused code", "committedDate": "2020-12-17T18:57:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2MTk0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/1144#discussion_r545361946", "bodyText": "Should this be Authorizer and PathAuthorizer?", "author": "jonfulk", "createdAt": "2020-12-17T19:52:40Z", "path": "dpc-api/src/test/java/gov/cms/dpc/api/APIResourceAnnotationTest.java", "diffHunk": "@@ -82,28 +81,13 @@ void allResourcesHaveSecurityAnnotations() {\n \n     /**\n      * Asserts that the method has valid auth-annotations\n-     * To pass, the method must either have a parameter with an Auth or a PathAuthorizer or Public annotation on the method\n+     * To pass, the method must either have a parameter with an Authorized, PathAuthorized, or Public annotation on the method", "originalCommit": "c43f3e565185dd6b300a9bcff982db630486a64b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "75e3bc55d5c75ca27ef729009d37a985552eacc0", "url": "https://github.com/CMSgov/dpc-app/commit/75e3bc55d5c75ca27ef729009d37a985552eacc0", "message": "Added some unit tests for group resource.", "committedDate": "2020-12-18T08:34:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2NzQ5NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1144#discussion_r545867495", "bodyText": "You can try one of those regex to string generators https://github.com/curious-odd-man/RgxGen", "author": "MrBilnon", "createdAt": "2020-12-18T14:32:41Z", "path": "dpc-attribution/src/test/java/gov/cms/dpc/attribution/resources/v1/GroupResourceUnitTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package gov.cms.dpc.attribution.resources.v1;\n+\n+import com.google.common.collect.Maps;\n+import gov.cms.dpc.attribution.DPCAttributionConfiguration;\n+import gov.cms.dpc.attribution.jdbi.*;\n+import gov.cms.dpc.common.entities.PatientEntity;\n+import gov.cms.dpc.common.entities.ProviderEntity;\n+import gov.cms.dpc.common.entities.RosterEntity;\n+import gov.cms.dpc.common.utils.NPIUtil;\n+import gov.cms.dpc.fhir.converters.FHIREntityConverter;\n+import gov.cms.dpc.testing.factories.FHIRGroupBuilder;\n+import gov.cms.dpc.testing.factories.FHIRPatientBuilder;\n+import org.assertj.core.util.Lists;\n+import org.hl7.fhir.dstu3.model.Group;\n+import org.hl7.fhir.dstu3.model.Patient;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.*;\n+\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Response;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import static org.mockito.ArgumentMatchers.*;\n+\n+public class GroupResourceUnitTest {\n+\n+    private GroupResource groupResource;\n+\n+    @Mock\n+    OrganizationDAO mockOrganizationDao;\n+\n+    @Mock\n+    EndpointDAO mockEndpointDao;\n+\n+    @Mock\n+    ProviderDAO providerDAO;\n+\n+    @Mock\n+    PatientDAO patientDAO;\n+\n+    @Mock\n+    RosterDAO rosterDAO;\n+\n+    @Mock\n+    RelationshipDAO relationshipDAO;\n+\n+    private DPCAttributionConfiguration configuration;\n+\n+    private FHIREntityConverter converter = FHIREntityConverter.initialize();\n+\n+\n+    @BeforeEach\n+    public void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+        configuration = new DPCAttributionConfiguration();\n+        groupResource = new GroupResource(converter, providerDAO, rosterDAO, patientDAO, relationshipDAO, configuration);\n+    }\n+\n+\n+    @Test\n+    public void testCreateRosterHappyCase(){\n+        //Arrange\n+        final UUID orgId = UUID.randomUUID();\n+        final String providerNpi = NPIUtil.generateNPI();\n+\n+        final Map<UUID,Patient> patientBank = makeTestPatients(5, orgId);\n+\n+        final Group group = FHIRGroupBuilder\n+                .newBuild()\n+                .attributedTo(providerNpi)\n+                .withPatients(patientBank.keySet().toArray(UUID[]::new))\n+                .withOrgTag(orgId)\n+                .build();\n+\n+        configuration.setPatientLimit(10);\n+        configuration.setExpirationThreshold(10);\n+        Mockito.when(rosterDAO.findEntities(isNull(),eq(orgId), eq(providerNpi), isNull())).thenReturn(Lists.emptyList());\n+        Mockito.when(providerDAO.getProviders(isNull(),eq(providerNpi), eq(orgId))).thenReturn(List.of(new ProviderEntity()));\n+        patientBank.keySet().stream().forEach(patientId ->\n+                Mockito.when(patientDAO.patientSearch(eq(patientId), isNull(),eq(orgId))).thenReturn(List.of(new PatientEntity())));\n+\n+        Mockito.when(rosterDAO.persistEntity(any(RosterEntity.class))).thenAnswer(invocation -> invocation.getArguments()[0]);\n+\n+        //Act\n+        Response response = groupResource.createRoster(group);\n+\n+        //Assert\n+        assertEquals(Response.Status.CREATED.getStatusCode(), response.getStatus(), \"Response status should have been CREATED (201)\");\n+        assertNotNull(response.getEntity(), \"Response should have contained a body\");\n+        assertEquals(patientBank.keySet().size(),((Group) response.getEntity()).getMember().size(), \"Patients count should be the same as submitted\");\n+    }\n+\n+    @Test\n+    public void testCreateRosterWithInvalidPatient(){\n+        //Arrange\n+        final UUID orgId = UUID.randomUUID();\n+        final String providerNpi = NPIUtil.generateNPI();\n+\n+        final Map<UUID,Patient> patientBank = makeTestPatients(5, orgId);\n+\n+        final UUID badPatientUUID = UUID.randomUUID();\n+\n+        final Group group = FHIRGroupBuilder\n+                .newBuild()\n+                .attributedTo(providerNpi)\n+                .withPatients(patientBank.keySet().toArray(UUID[]::new))\n+                .withPatients(badPatientUUID)\n+                .withOrgTag(orgId)\n+                .build();\n+\n+        configuration.setPatientLimit(10);\n+        configuration.setExpirationThreshold(10);\n+        Mockito.when(rosterDAO.findEntities(isNull(),eq(orgId), eq(providerNpi), isNull())).thenReturn(Lists.emptyList());\n+        Mockito.when(providerDAO.getProviders(isNull(),eq(providerNpi), eq(orgId))).thenReturn(List.of(new ProviderEntity()));\n+        patientBank.keySet().stream().forEach(patientId ->\n+                Mockito.when(patientDAO.patientSearch(eq(patientId), isNull(),eq(orgId))).thenReturn(List.of(new PatientEntity())));\n+\n+        Mockito.when(patientDAO.patientSearch(eq(badPatientUUID), isNull(),eq(orgId))).thenReturn(List.of());\n+        Mockito.when(rosterDAO.persistEntity(any(RosterEntity.class))).thenAnswer(invocation -> invocation.getArguments()[0]);\n+\n+        //Act & Assert\n+        assertThrows(WebApplicationException.class, () -> groupResource.createRoster(group), \"Expected and exception if an invalid patient was added\");\n+    }\n+\n+    private Map<UUID,Patient> makeTestPatients(int count, UUID orgId){\n+        if(count>88){\n+            throw new IllegalStateException(\"Don't support building more than 88 patients..yet (need a better mbi generator)\");\n+        }\n+        final Map<UUID,Patient> patients = Maps.newHashMap();\n+        while(count>0){\n+            UUID id = UUID.randomUUID();\n+            Patient patient = FHIRPatientBuilder\n+                    .newBuild()\n+                    .withMbi(\"4S41C00AA\"+(count+10)) //makes MBI in range 4S41C00AA10 -> 4S41C00AA99", "originalCommit": "75e3bc55d5c75ca27ef729009d37a985552eacc0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "149dc0ac50409f1202b7d21d90a5beb4b5abf514", "url": "https://github.com/CMSgov/dpc-app/commit/149dc0ac50409f1202b7d21d90a5beb4b5abf514", "message": "Added unit tests for test helpers", "committedDate": "2020-12-18T18:58:41Z", "type": "commit"}]}