{"pr_number": 897, "pr_title": "DPC-518 log lookback stats, add jobid, batchid and patient mbi hash to mdc", "pr_createdAt": "2020-07-08T22:41:50Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/897", "timeline": [{"oid": "c946cfd3e5d22177a6f0c1a977ecc48d95141f21", "url": "https://github.com/CMSgov/dpc-app/commit/c946cfd3e5d22177a6f0c1a977ecc48d95141f21", "message": "log lookback stats, add jobid, batchid and patient mbi hash to mdc", "committedDate": "2020-07-08T22:39:50Z", "type": "commit"}, {"oid": "539e7ab69c26846201112275e96df2cbd5d75a95", "url": "https://github.com/CMSgov/dpc-app/commit/539e7ab69c26846201112275e96df2cbd5d75a95", "message": "Merge branch 'master' into wh/DPC-518-log-lookback", "committedDate": "2020-07-08T22:42:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3MTEwOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/897#discussion_r451871109", "bodyText": "Could you include some example log output in the PR description?  I'd like to be certain all these log statements can be correlated.", "author": "dhgreene", "createdAt": "2020-07-08T23:01:18Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -159,19 +163,21 @@ protected void processJobBatch(JobQueueBatch job) {\n                 nextPatientID = processPatient(job, patientId);\n             }\n \n+            //Clear last patient seen from MDC\n+            MDC.remove(MDCConstants.PATIENT_ID);\n             // Finish processing the batch\n             if (this.isRunning()) {\n-                logger.info(\"COMPLETED job {} batch {}\", job.getJobID(), job.getBatchID());\n+                logger.info(\"COMPLETED job\");\n                 // Calculate metadata for the file (length and checksum)\n                 calculateFileMetadata(job);\n                 this.queue.completeBatch(job, aggregatorID);\n             } else {\n-                logger.info(\"PAUSED job {} batch {}\", job.getJobID(), job.getBatchID());\n+                logger.info(\"PAUSED job\");\n                 this.queue.pauseBatch(job, aggregatorID);\n             }\n         } catch (Exception error) {\n             try {\n-                logger.error(\"FAILED job {} batch {}\", job.getJobID(), job.getBatchID(), error);\n+                logger.error(\"FAILED job\", error);", "originalCommit": "539e7ab69c26846201112275e96df2cbd5d75a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4OTU4NA==", "url": "https://github.com/CMSgov/dpc-app/pull/897#discussion_r452289584", "bodyText": "Could you include some example log output in the PR description? I'd like to be certain all these log statements can be correlated.\n\ndone", "author": "MrBilnon", "createdAt": "2020-07-09T15:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3MTEwOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkwMjcyOA==", "url": "https://github.com/CMSgov/dpc-app/pull/897#discussion_r451902728", "bodyText": "Call \"billingPeriod.isPresent()\" before accessing the value.", "author": "codeclimate", "createdAt": "2020-07-09T00:50:51Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/service/LookBackServiceImpl.java", "diffHunk": "@@ -57,12 +61,24 @@ public boolean hasClaimWithin(ExplanationOfBenefit explanationOfBenefit, UUID or\n \n         Set<String> eobProviderNPIs = extractPractionerNPIs(explanationOfBenefit);\n \n-        return billingPeriod.isPresent()\n-                && providerID.isPresent()\n-                && organizationID.isPresent() && eobOrganizationID.isPresent()\n-                && getMonthsDifference(billingPeriod.get(), operationsConfig.getLookBackDate()) < withinMonth\n-                && eobProviderNPIs.contains(providerID.get())\n-                && organizationID.get().equals(eobOrganizationID.get());\n+        if (billingPeriod.isEmpty() || providerID.isEmpty() || organizationID.isEmpty() || eobOrganizationID.isEmpty()) {\n+            LOGGER.info(\"eob BillingPeriod or job providerID or job organizationID or eob OrganizationID are null\");\n+            return false;\n+        }\n+\n+        long lookBackMonthsDifference = getMonthsDifference(billingPeriod.get(), operationsConfig.getLookBackDate());", "originalCommit": "539e7ab69c26846201112275e96df2cbd5d75a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4OTQwNw==", "url": "https://github.com/CMSgov/dpc-app/pull/897#discussion_r452289407", "bodyText": "Checking the present/absence of value here: https://github.com/CMSgov/dpc-app/pull/897/files/539e7ab69c26846201112275e96df2cbd5d75a95#diff-928f42d0deeb5304fb975977200c88e3R64\nNot sure what code climate is complaining about..", "author": "MrBilnon", "createdAt": "2020-07-09T15:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkwMjcyOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6d2cacb213965fa46d86bdc76da8be536a8ae09f", "url": "https://github.com/CMSgov/dpc-app/commit/6d2cacb213965fa46d86bdc76da8be536a8ae09f", "message": "Merge branch 'master' into wh/DPC-518-log-lookback", "committedDate": "2020-07-09T14:46:37Z", "type": "commit"}, {"oid": "57f179a0dd67e8ec20809d17a81c966dd50f51ee", "url": "https://github.com/CMSgov/dpc-app/commit/57f179a0dd67e8ec20809d17a81c966dd50f51ee", "message": "Merge branch 'master' into wh/DPC-518-log-lookback", "committedDate": "2020-07-09T15:48:58Z", "type": "commit"}]}