{"pr_number": 2909, "pr_title": "Fix Excel date import - Fixes #1908", "pr_createdAt": "2020-07-08T19:50:55Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2909", "timeline": [{"oid": "19b532b8f0131c8359f9730ba5988eed1d007ade", "url": "https://github.com/OpenRefine/OpenRefine/commit/19b532b8f0131c8359f9730ba5988eed1d007ade", "message": "Add utility functions to check/convert dates", "committedDate": "2020-07-08T18:50:50Z", "type": "commit"}, {"oid": "ab201509e7908bed70820fd8686ad8f20fbf0828", "url": "https://github.com/OpenRefine/OpenRefine/commit/ab201509e7908bed70820fd8686ad8f20fbf0828", "message": "Add date tests and refactor to DRY up", "committedDate": "2020-07-08T19:29:41Z", "type": "commit"}, {"oid": "c5aed370522182dc8cc821c5ba9d583e4aa8868d", "url": "https://github.com/OpenRefine/OpenRefine/commit/c5aed370522182dc8cc821c5ba9d583e4aa8868d", "message": "Fix date import - fixes #1908\n\nChange from java.util.Date to OpenRefine 3.0+'s OffsetDateTime\nFixes #1908", "committedDate": "2020-07-08T19:45:56Z", "type": "commit"}, {"oid": "872fd60cc7c85e63dc210774364548feda555c0a", "url": "https://github.com/OpenRefine/OpenRefine/commit/872fd60cc7c85e63dc210774364548feda555c0a", "message": "Centralize date conversion", "committedDate": "2020-07-08T19:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NTgwOA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2909#discussion_r451985808", "bodyText": "Should these things live in this class? This is the class for the GREL function, these methods look more like utility methods used throughout the code, so I would put them in a utility class.", "author": "wetneb", "createdAt": "2020-07-09T06:13:31Z", "path": "main/src/com/google/refine/expr/functions/ToDate.java", "diffHunk": "@@ -202,4 +203,16 @@ public String getParams() {\n     public String getReturns() {\n         return \"date\";\n     }\n+\n+    public static boolean isDate(Object o) {\n+        return o instanceof OffsetDateTime;\n+    }\n+\n+    public static OffsetDateTime toDate(Date date) {\n+        return date.toInstant().atOffset(ZoneOffset.UTC);\n+    }\n+\n+    public static OffsetDateTime toDate(Calendar date) {\n+        return date.toInstant().atOffset(ZoneOffset.UTC);\n+    }", "originalCommit": "872fd60cc7c85e63dc210774364548feda555c0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxNTU5Mg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2909#discussion_r452415592", "bodyText": "The \"right\" way to do this would probably be to have an OpenRefine Date class which encapsulates all the date handling and then the GREL ToDate could call com.google.refine...Date.parse() but the date handling is such a mess I didn't want to risk a big refactor when my goal was to get this fixed for 3.4 once I learned you were still considering adding stuff to the release.\nThe point of putting the methods here was to keep them co-located with at least some of the date handling code, so people couldn't easily change one without the other. The other date handling utility methods are in ParsingUtilities which isn't a great fit either.\nI can create a separate tiny DateUtility class to hold these for the time being.", "author": "tfmorris", "createdAt": "2020-07-09T18:38:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NTgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ0NjkzMQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2909#discussion_r452446931", "bodyText": "I decided having them colocated with the rest of the date handling was more important than the inappropriate name, so moved the to ParsingUtilities. Investigating the build failures now.", "author": "tfmorris", "createdAt": "2020-07-09T19:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NTgwOA=="}], "type": "inlineReview", "revised_code": {"commit": "cfead7ff0a6f379d1906a194cf8b4a989c88e7ee", "chunk": "diff --git a/main/src/com/google/refine/expr/functions/ToDate.java b/main/src/com/google/refine/expr/functions/ToDate.java\nindex ba49f9f84..543719eee 100644\n--- a/main/src/com/google/refine/expr/functions/ToDate.java\n+++ b/main/src/com/google/refine/expr/functions/ToDate.java\n\n@@ -204,15 +203,4 @@ public class ToDate implements Function {\n         return \"date\";\n     }\n \n-    public static boolean isDate(Object o) {\n-        return o instanceof OffsetDateTime;\n-    }\n-\n-    public static OffsetDateTime toDate(Date date) {\n-        return date.toInstant().atOffset(ZoneOffset.UTC);\n-    }\n-\n-    public static OffsetDateTime toDate(Calendar date) {\n-        return date.toInstant().atOffset(ZoneOffset.UTC);\n-    }\n }\n"}}, {"oid": "cfead7ff0a6f379d1906a194cf8b4a989c88e7ee", "url": "https://github.com/OpenRefine/OpenRefine/commit/cfead7ff0a6f379d1906a194cf8b4a989c88e7ee", "message": "Moving utility methods to ParsingUtilities", "committedDate": "2020-07-09T19:04:37Z", "type": "commit"}, {"oid": "4d84efa05a305b758cf131ad512fc09bf7370ed2", "url": "https://github.com/OpenRefine/OpenRefine/commit/4d84efa05a305b758cf131ad512fc09bf7370ed2", "message": "Fix tests", "committedDate": "2020-07-09T19:45:31Z", "type": "commit"}]}