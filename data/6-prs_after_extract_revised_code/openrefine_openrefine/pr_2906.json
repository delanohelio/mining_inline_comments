{"pr_number": 2906, "pr_title": "Migrate reconciliation calls to Apache HTTP client", "pr_createdAt": "2020-07-08T15:36:09Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2906", "timeline": [{"oid": "c4218ce0df91193e1ab8f731074cd9a29fb4900c", "url": "https://github.com/OpenRefine/OpenRefine/commit/c4218ce0df91193e1ab8f731074cd9a29fb4900c", "message": "Migrate reconciliation calls to OkHTTP, for #2903", "committedDate": "2020-07-08T15:29:58Z", "type": "commit"}, {"oid": "3c273418c8477fc7427568b33c046efd2805baf1", "url": "https://github.com/OpenRefine/OpenRefine/commit/3c273418c8477fc7427568b33c046efd2805baf1", "message": "Migrate to Apache HTTP Commons", "committedDate": "2020-07-09T09:50:48Z", "type": "commit"}, {"oid": "56ef3b4aa26f586a2a7327be7de8ebcbd81c2cb5", "url": "https://github.com/OpenRefine/OpenRefine/commit/56ef3b4aa26f586a2a7327be7de8ebcbd81c2cb5", "message": "Migrate data extension to Apache HTTP client", "committedDate": "2020-07-09T13:32:28Z", "type": "commit"}, {"oid": "13ac77ded2810604d28eef97a06259e870c5fce0", "url": "https://github.com/OpenRefine/OpenRefine/commit/13ac77ded2810604d28eef97a06259e870c5fce0", "message": "Deprecate HttpURLConnection in RefineServlet", "committedDate": "2020-07-09T13:36:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3MjI0MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452472240", "bodyText": "10 seconds should be fine for any reasonable service, but I wonder if it will be enough for Wikidata.", "author": "tfmorris", "createdAt": "2020-07-09T20:30:28Z", "path": "main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java", "diffHunk": "@@ -170,70 +183,66 @@ protected IndividualQuery(String query, int limit) {\n         \n         String queriesString = ParsingUtilities.defaultWriter.writeValueAsString(queryMap);\n         try {\n-            URL url = new URL(serviceUrl);\n-            HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n-            {\n-                connection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\");\n-                connection.setConnectTimeout(30000);\n-                connection.setDoOutput(true);\n-                \n-                DataOutputStream dos = new DataOutputStream(connection.getOutputStream());\n-                try {\n-                    String body = \"queries=\" + ParsingUtilities.encode(queriesString);\n-                    \n-                    dos.writeBytes(body);\n-                } finally {\n-                    dos.flush();\n-                    dos.close();\n+            RequestConfig defaultRequestConfig = RequestConfig.custom()\n+                    .setConnectTimeout(30 * 1000)\n+                    .setConnectionRequestTimeout(30 * 1000)\n+                    .setSocketTimeout(10 * 1000).build();", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5OTU2MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452499560", "bodyText": "10 seconds will indeed be too short for Wikidata, complex queries can take 1 sec so batches of 10 queries would be likely to overrun.", "author": "wetneb", "createdAt": "2020-07-09T21:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3MjI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\nindex afafd22cf..6ffb77764 100644\n--- a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n+++ b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n\n@@ -190,10 +188,7 @@ public class GuessTypesOfColumnCommand extends Command {\n \n             HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                     .setUserAgent(RefineServlet.getUserAgent())\n-                    .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n-                            HttpGet.METHOD_NAME,\n-                            HttpHead.METHOD_NAME,\n-                            HttpPost.METHOD_NAME }))\n+                    .setRedirectStrategy(new LaxRedirectStrategy())\n                     .setDefaultRequestConfig(defaultRequestConfig);\n             \n             CloseableHttpClient httpClient = httpClientBuilder.build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3NTcyNg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452475726", "bodyText": "Could you just use LaxRedirectStrategy here?\nThe docs only mention 301, 302, & 307. Is the lack of 308 a documentation oversight or a missing capability?", "author": "tfmorris", "createdAt": "2020-07-09T20:37:32Z", "path": "main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java", "diffHunk": "@@ -170,70 +183,66 @@ protected IndividualQuery(String query, int limit) {\n         \n         String queriesString = ParsingUtilities.defaultWriter.writeValueAsString(queryMap);\n         try {\n-            URL url = new URL(serviceUrl);\n-            HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n-            {\n-                connection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\");\n-                connection.setConnectTimeout(30000);\n-                connection.setDoOutput(true);\n-                \n-                DataOutputStream dos = new DataOutputStream(connection.getOutputStream());\n-                try {\n-                    String body = \"queries=\" + ParsingUtilities.encode(queriesString);\n-                    \n-                    dos.writeBytes(body);\n-                } finally {\n-                    dos.flush();\n-                    dos.close();\n+            RequestConfig defaultRequestConfig = RequestConfig.custom()\n+                    .setConnectTimeout(30 * 1000)\n+                    .setConnectionRequestTimeout(30 * 1000)\n+                    .setSocketTimeout(10 * 1000).build();\n+\n+            HttpClientBuilder httpClientBuilder = HttpClients.custom()\n+                    .setUserAgent(RefineServlet.getUserAgent())\n+                    .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMTM5Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452501393", "bodyText": "Thank you! The amazing thing is that I first defined my own subclass of DefaultRedirectStrategy and picked the same LaxRedirectStrategy name for it.\nAbout HTTP 308: all I know is that it works with the HTTP 308 that Wikidata serves at the moment. Where did you see the mention of these specific codes?", "author": "wetneb", "createdAt": "2020-07-09T21:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3NTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwODE0MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452508140", "bodyText": "308 is newer, so it's probably a doc oversight. Doc page is here: https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/impl/client/DefaultRedirectStrategy.html", "author": "tfmorris", "createdAt": "2020-07-09T21:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3NTcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\nindex afafd22cf..6ffb77764 100644\n--- a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n+++ b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n\n@@ -190,10 +188,7 @@ public class GuessTypesOfColumnCommand extends Command {\n \n             HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                     .setUserAgent(RefineServlet.getUserAgent())\n-                    .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n-                            HttpGet.METHOD_NAME,\n-                            HttpHead.METHOD_NAME,\n-                            HttpPost.METHOD_NAME }))\n+                    .setRedirectStrategy(new LaxRedirectStrategy())\n                     .setDefaultRequestConfig(defaultRequestConfig);\n             \n             CloseableHttpClient httpClient = httpClientBuilder.build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3ODg3Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452478876", "bodyText": "Old code used a connection timeout of 5 sec. I'm not sure if there was a reason and 30 sec seems fine to me, so just noting the difference.", "author": "tfmorris", "createdAt": "2020-07-09T20:43:55Z", "path": "main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java", "diffHunk": "@@ -206,29 +226,49 @@ public ReconciledDataExtensionJob(DataExtensionConfig obj, String endpoint) {\n         }\n     }\n \n+    /**\n+     * @todo this should be refactored to be unified with the HTTP querying code\n+     * from StandardReconConfig. We should ideally extract a library to query\n+     * reconciliation services and expose it as such for others to reuse.\n+     */\n+    \n     static protected InputStream performQuery(String endpoint, String query) throws IOException {\n-        URL url = new URL(endpoint);\n-\n-        URLConnection connection = url.openConnection();\n-        connection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n-        connection.setConnectTimeout(5000);\n-        connection.setDoOutput(true);\n-\n-        DataOutputStream dos = new DataOutputStream(connection.getOutputStream());\n-        try {\n-            String body = \"extend=\" + ParsingUtilities.encode(query);\n-\n-            dos.writeBytes(body);\n-        } finally {\n-            dos.flush();\n-            dos.close();\n+        HttpPost request = new HttpPost(endpoint);\n+        List<NameValuePair> body = Collections.singletonList(\n+                new BasicNameValuePair(\"queries\", query));\n+        request.setEntity(new UrlEncodedFormEntity(body, Consts.UTF_8));\n+        \n+        try (CloseableHttpResponse response = getHttpClient().execute(request)) {\n+            StatusLine statusLine = response.getStatusLine();\n+            if (statusLine.getStatusCode() >= 400) {\n+                throw new IOException(\"Data extension query failed - code: \"\n+                        + Integer.toString(statusLine.getStatusCode())\n+                        + \" message: \" + statusLine.getReasonPhrase());\n+            } else {\n+                return response.getEntity().getContent();\n+            }\n         }\n+    }\n \n-        connection.connect();\n+    private static CloseableHttpClient getHttpClient() {\n+        if (httpClient != null) {\n+            return httpClient;\n+        }\n+        RequestConfig defaultRequestConfig = RequestConfig.custom()\n+                .setConnectTimeout(30 * 1000)", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMjI3MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452502270", "bodyText": "Yes, I think it makes sense to use the same connection settings for reconciliation endpoints, and I anticipate this code being refactored to be shared.", "author": "wetneb", "createdAt": "2020-07-09T21:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3ODg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\nindex 0117bc923..acb2cb091 100644\n--- a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n+++ b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n\n@@ -261,10 +256,7 @@ public class ReconciledDataExtensionJob {\n \n         HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                 .setUserAgent(RefineServlet.getUserAgent())\n-                .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n-                        HttpGet.METHOD_NAME,\n-                        HttpHead.METHOD_NAME,\n-                        HttpPost.METHOD_NAME }))\n+                .setRedirectStrategy(new LaxRedirectStrategy())\n                 .setDefaultRequestConfig(defaultRequestConfig);\n         httpClient = httpClientBuilder.build();\n         return httpClient;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4MTg2MA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452481860", "bodyText": "Is this  (and CloseableHttpClient) thread-safe? I haven't traced how this is used, but it seems unusual and perhaps risky to be reusing it in multiple, perhaps simultaneous, performQuery() method calls.", "author": "tfmorris", "createdAt": "2020-07-09T20:50:05Z", "path": "main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java", "diffHunk": "@@ -206,29 +226,49 @@ public ReconciledDataExtensionJob(DataExtensionConfig obj, String endpoint) {\n         }\n     }\n \n+    /**\n+     * @todo this should be refactored to be unified with the HTTP querying code\n+     * from StandardReconConfig. We should ideally extract a library to query\n+     * reconciliation services and expose it as such for others to reuse.\n+     */\n+    \n     static protected InputStream performQuery(String endpoint, String query) throws IOException {\n-        URL url = new URL(endpoint);\n-\n-        URLConnection connection = url.openConnection();\n-        connection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n-        connection.setConnectTimeout(5000);\n-        connection.setDoOutput(true);\n-\n-        DataOutputStream dos = new DataOutputStream(connection.getOutputStream());\n-        try {\n-            String body = \"extend=\" + ParsingUtilities.encode(query);\n-\n-            dos.writeBytes(body);\n-        } finally {\n-            dos.flush();\n-            dos.close();\n+        HttpPost request = new HttpPost(endpoint);\n+        List<NameValuePair> body = Collections.singletonList(\n+                new BasicNameValuePair(\"queries\", query));\n+        request.setEntity(new UrlEncodedFormEntity(body, Consts.UTF_8));\n+        \n+        try (CloseableHttpResponse response = getHttpClient().execute(request)) {\n+            StatusLine statusLine = response.getStatusLine();\n+            if (statusLine.getStatusCode() >= 400) {\n+                throw new IOException(\"Data extension query failed - code: \"\n+                        + Integer.toString(statusLine.getStatusCode())\n+                        + \" message: \" + statusLine.getReasonPhrase());\n+            } else {\n+                return response.getEntity().getContent();\n+            }\n         }\n+    }\n \n-        connection.connect();\n+    private static CloseableHttpClient getHttpClient() {\n+        if (httpClient != null) {", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMzY3NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452503674", "bodyText": "In the current architecture it should not be used concurrently but for good measure I can instantiate it with\nMultiThreadedHttpConnectionManager (https://hc.apache.org/httpclient-3.x/threading.html)", "author": "wetneb", "createdAt": "2020-07-09T21:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4MTg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0MzM0Mg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r454843342", "bodyText": "This actually belongs to a different library, so let's keep it that way - a Job only gets executed in a single thread anyway, so no need to add this overhead anyway.", "author": "wetneb", "createdAt": "2020-07-15T07:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4MTg2MA=="}], "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\nindex 0117bc923..acb2cb091 100644\n--- a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n+++ b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n\n@@ -261,10 +256,7 @@ public class ReconciledDataExtensionJob {\n \n         HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                 .setUserAgent(RefineServlet.getUserAgent())\n-                .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n-                        HttpGet.METHOD_NAME,\n-                        HttpHead.METHOD_NAME,\n-                        HttpPost.METHOD_NAME }))\n+                .setRedirectStrategy(new LaxRedirectStrategy())\n                 .setDefaultRequestConfig(defaultRequestConfig);\n         httpClient = httpClientBuilder.build();\n         return httpClient;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4MjQzOQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452482439", "bodyText": "Unused imports should be removed", "author": "tfmorris", "createdAt": "2020-07-09T20:51:14Z", "path": "main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java", "diffHunk": "@@ -44,12 +44,28 @@\n import java.net.URL;", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\nindex 0117bc923..acb2cb091 100644\n--- a/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n+++ b/main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java\n\n@@ -36,13 +36,10 @@ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n package com.google.refine.model.recon;\n \n-import java.io.DataOutputStream;\n import java.io.IOException;\n import java.io.InputStream;\n import java.io.StringWriter;\n import java.io.Writer;\n-import java.net.URL;\n-import java.net.URLConnection;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.HashMap;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NDgxMg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452484812", "bodyText": "Since there's no issue with static access, can't this just be initialized in the constructor?", "author": "tfmorris", "createdAt": "2020-07-09T20:55:38Z", "path": "main/src/com/google/refine/model/recon/StandardReconConfig.java", "diffHunk": "@@ -154,6 +165,9 @@ public String toString() {\n     @JsonProperty(\"limit\")\n     final private int limit;\n \n+    // initialized lazily\n+    private CloseableHttpClient httpClient = null;", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwNDM1NQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452504355", "bodyText": "My intention was to try to avoid any overhead there, since this class is deserialized quite often (as soon as you have a reconciled column in the project, it will get saved / restored every time you save the ColumnModel)", "author": "wetneb", "createdAt": "2020-07-09T21:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NDgxMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4OTQxNw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452489417", "bodyText": "I have a feeling I may not want to know the answer to this, but why does an importer test have a dependency on reconciliation? That seems very odd.", "author": "tfmorris", "createdAt": "2020-07-09T21:04:52Z", "path": "main/tests/server/src/com/google/refine/importers/WikitextImporterTests.java", "diffHunk": "@@ -51,12 +53,16 @@\n import org.testng.annotations.BeforeTest;\n import org.testng.annotations.Test;\n \n-import com.google.refine.importers.WikitextImporter;\n+import com.google.refine.model.Recon;", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwNDU0OA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452504548", "bodyText": "Because the importer itself depends on reconciliation to create reconciled cells?", "author": "wetneb", "createdAt": "2020-07-09T21:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4OTQxNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MTQ1NQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452551455", "bodyText": "This needs to handle a JsonParseException either here or in the surrounding try/except block.", "author": "tfmorris", "createdAt": "2020-07-09T23:54:58Z", "path": "main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java", "diffHunk": "@@ -170,70 +183,66 @@ protected IndividualQuery(String query, int limit) {\n         \n         String queriesString = ParsingUtilities.defaultWriter.writeValueAsString(queryMap);\n         try {\n-            URL url = new URL(serviceUrl);\n-            HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n-            {\n-                connection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\");\n-                connection.setConnectTimeout(30000);\n-                connection.setDoOutput(true);\n-                \n-                DataOutputStream dos = new DataOutputStream(connection.getOutputStream());\n-                try {\n-                    String body = \"queries=\" + ParsingUtilities.encode(queriesString);\n-                    \n-                    dos.writeBytes(body);\n-                } finally {\n-                    dos.flush();\n-                    dos.close();\n+            RequestConfig defaultRequestConfig = RequestConfig.custom()\n+                    .setConnectTimeout(30 * 1000)\n+                    .setConnectionRequestTimeout(30 * 1000)\n+                    .setSocketTimeout(10 * 1000).build();\n+\n+            HttpClientBuilder httpClientBuilder = HttpClients.custom()\n+                    .setUserAgent(RefineServlet.getUserAgent())\n+                    .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n+                            HttpGet.METHOD_NAME,\n+                            HttpHead.METHOD_NAME,\n+                            HttpPost.METHOD_NAME }))\n+                    .setDefaultRequestConfig(defaultRequestConfig);\n+            \n+            CloseableHttpClient httpClient = httpClientBuilder.build();\n+            HttpPost request = new HttpPost(serviceUrl);\n+            List<NameValuePair> body = Collections.singletonList(\n+                    new BasicNameValuePair(\"queries\", queriesString));\n+            request.setEntity(new UrlEncodedFormEntity(body, Consts.UTF_8));\n+            \n+            try (CloseableHttpResponse response = httpClient.execute(request)) {\n+                StatusLine statusLine = response.getStatusLine();\n+                if (statusLine.getStatusCode() >= 400) {\n+                    throw new IOException(\"Failed  - code:\" \n+                            + Integer.toString(statusLine.getStatusCode()) \n+                            + \" message: \" + statusLine.getReasonPhrase());\n                 }\n                 \n-                connection.connect();\n-            }\n-\n-            if (connection.getResponseCode() >= 400) {\n-                InputStream is = connection.getErrorStream();\n-                throw new IOException(\"Failed  - code:\" \n-                        + Integer.toString(connection.getResponseCode()) \n-                        + \" message: \" + is == null ? \"\" : ParsingUtilities.inputStreamToString(is));\n-            } else {\n-                InputStream is = connection.getInputStream();\n-                try {\n-                    String s = ParsingUtilities.inputStreamToString(is);\n-                    ObjectNode o = ParsingUtilities.evaluateJsonStringToObjectNode(s);\n+                String s = ParsingUtilities.inputStreamToString(response.getEntity().getContent());\n+                ObjectNode o = ParsingUtilities.evaluateJsonStringToObjectNode(s);", "originalCommit": "13ac77ded2810604d28eef97a06259e870c5fce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2OTEwNQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452769105", "bodyText": "JsonException is a sublcass of IOException, so isn't the current handling of IOException enough? What specific action do you want to take when a JsonParseException is raised?", "author": "wetneb", "createdAt": "2020-07-10T10:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MTQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg5Mzg1Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2906#discussion_r452893857", "bodyText": "OK, there must be some other issue then. The goal is to have OpenRefine return an error to the user rather than just stay frozen with its spinner up as shown by the screen capture and server traceback in issue #2903.", "author": "tfmorris", "createdAt": "2020-07-10T14:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MTQ1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "chunk": "diff --git a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\nindex afafd22cf..6ffb77764 100644\n--- a/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n+++ b/main/src/com/google/refine/commands/recon/GuessTypesOfColumnCommand.java\n\n@@ -190,10 +188,7 @@ public class GuessTypesOfColumnCommand extends Command {\n \n             HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                     .setUserAgent(RefineServlet.getUserAgent())\n-                    .setRedirectStrategy(new DefaultRedirectStrategy(new String[] {\n-                            HttpGet.METHOD_NAME,\n-                            HttpHead.METHOD_NAME,\n-                            HttpPost.METHOD_NAME }))\n+                    .setRedirectStrategy(new LaxRedirectStrategy())\n                     .setDefaultRequestConfig(defaultRequestConfig);\n             \n             CloseableHttpClient httpClient = httpClientBuilder.build();\n"}}, {"oid": "d3960bd40d403b1f2123b04a3c93d251f67ea648", "url": "https://github.com/OpenRefine/OpenRefine/commit/d3960bd40d403b1f2123b04a3c93d251f67ea648", "message": "Use LaxRedirectStrategy, clean up imports", "committedDate": "2020-07-10T19:50:23Z", "type": "commit"}, {"oid": "94708f5ce95031ab6d452e4f4b919ecc5b4fd0ec", "url": "https://github.com/OpenRefine/OpenRefine/commit/94708f5ce95031ab6d452e4f4b919ecc5b4fd0ec", "message": "Remove read and pool timeouts, only keep the connection timeout", "committedDate": "2020-07-15T13:57:36Z", "type": "commit"}, {"oid": "d60c41a4979e9c5bbac7270bbd7b9b6e5c5d0bcf", "url": "https://github.com/OpenRefine/OpenRefine/commit/d60c41a4979e9c5bbac7270bbd7b9b6e5c5d0bcf", "message": "Adapt mocking of HTTP calls after migration", "committedDate": "2020-08-15T10:54:24Z", "type": "commit"}, {"oid": "da398b1c46a3877dfbecf3a23ce260ef78046e17", "url": "https://github.com/OpenRefine/OpenRefine/commit/da398b1c46a3877dfbecf3a23ce260ef78046e17", "message": "Merge branch 'master' into 2903-reconciliation-okhttp", "committedDate": "2020-08-20T07:25:11Z", "type": "commit"}, {"oid": "546fa5139ae8cd4041add0298ebac47c4b2fb387", "url": "https://github.com/OpenRefine/OpenRefine/commit/546fa5139ae8cd4041add0298ebac47c4b2fb387", "message": "Merge branch 'master' into 2903-reconciliation-okhttp", "committedDate": "2020-08-23T11:42:46Z", "type": "commit"}]}