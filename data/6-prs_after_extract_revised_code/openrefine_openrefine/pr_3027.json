{"pr_number": 3027, "pr_title": "Fix ToDate test failure & inefficiency - fixes #3026", "pr_createdAt": "2020-08-03T22:35:36Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/3027", "timeline": [{"oid": "a5cd443f7ce79379abca48052015a88b3feef089", "url": "https://github.com/OpenRefine/OpenRefine/commit/a5cd443f7ce79379abca48052015a88b3feef089", "message": "Don't add 160 copies of the same format string\n\nNot sure what this code is trying to do, but it's just\nwasting processing for no effect. I don't understand what\nit's attempting to do well enough to implement it properly.", "committedDate": "2020-08-03T22:38:01Z", "type": "forcePushed"}, {"oid": "d4849ea948c60c8978d78aa561d26c7084e02cc3", "url": "https://github.com/OpenRefine/OpenRefine/commit/d4849ea948c60c8978d78aa561d26c7084e02cc3", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restores a dropped test,\nands adds a ToDo/question about previous test behavior\nchange.", "committedDate": "2020-08-04T00:01:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1OTczNQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r466359735", "bodyText": "It is not clear to me that this new version is equivalent, for instance of datetime objects with precision down to the second. You are correct that the motivation for this .plusSeconds() was to preserve the date part across timezones but I think this code also handles timestamps with a higher precision than day.", "author": "wetneb", "createdAt": "2020-08-06T11:56:33Z", "path": "main/src/com/google/refine/expr/functions/ToDate.java", "diffHunk": "@@ -168,8 +167,7 @@ private OffsetDateTime parse(String o1, Locale locale, List<String> formats) {\n         } else {\n             try {\n                 return javax.xml.bind.DatatypeConverter.parseDateTime(o1).getTime().toInstant()\n-                \t\t.plusSeconds(ZonedDateTime.now().getOffset().getTotalSeconds())\n-                \t\t.atOffset(ZoneOffset.of(\"Z\"));\n+                        .truncatedTo(ChronoUnit.DAYS).atOffset(ZoneOffset.of(\"Z\"));", "originalCommit": "d4849ea948c60c8978d78aa561d26c7084e02cc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ4OTM3Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r466489373", "bodyText": "Can you add a (failing) test that demonstrates the problem? I'm not sure I follow what you're trying to say.\nMy understanding of the intent was to make sure that toDate(\"1984\") ends up pinned to midnight, rather than offset by the number of hours that local time is from UTC. The old code apparently doesn't account for summer time / Daylight Savings Time so, on my system, it ends up at 1 hour past midnight rather than at midnight. The new code fixes that. I'm open to other solutions, but I'm trying to resist having to learn all of the complexities of the new Java date/time system.", "author": "tfmorris", "createdAt": "2020-08-06T15:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1OTczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMjgxMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r466612813", "bodyText": "I've got a better understanding of what the original problem was and have a better fix. The issue occurred when the test date to be parsed was on one side of the Daylight Savings Time boundary and the current date was on the opposite side, resulting in the offset computed using now() to be incorrect. I switched the offset calculation to use the parsed date.\nSomehow, in the mean time, the default timezone for Java switched itself from \"EDT\" to \"UTC\" so I also changed the test to use a fixed, non-UTC timezone to hopefully catch any other UTC dependencies in the future (although it won't catch temporal shifts like DST).", "author": "tfmorris", "createdAt": "2020-08-06T18:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1OTczNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c61f48578d6ac678c2756a761a259df80fa184fc", "chunk": "diff --git a/main/src/com/google/refine/expr/functions/ToDate.java b/main/src/com/google/refine/expr/functions/ToDate.java\nindex 606cd75c7..12188b7b0 100644\n--- a/main/src/com/google/refine/expr/functions/ToDate.java\n+++ b/main/src/com/google/refine/expr/functions/ToDate.java\n\n@@ -166,8 +167,9 @@ public class ToDate implements Function {\n             return date;\n         } else {\n             try {\n-                return javax.xml.bind.DatatypeConverter.parseDateTime(o1).getTime().toInstant()\n-                        .truncatedTo(ChronoUnit.DAYS).atOffset(ZoneOffset.of(\"Z\"));\n+                Calendar parsedDate = javax.xml.bind.DatatypeConverter.parseDateTime(o1);\n+                int offsetMillis = parsedDate.getTimeZone().getOffset(parsedDate.getTimeInMillis());\n+                return parsedDate.toInstant().plusMillis(offsetMillis).atOffset(ZoneOffset.of(\"Z\"));\n             } catch (IllegalArgumentException e2) {\n                 return null;\n             }\n"}}, {"oid": "c61f48578d6ac678c2756a761a259df80fa184fc", "url": "https://github.com/OpenRefine/OpenRefine/commit/c61f48578d6ac678c2756a761a259df80fa184fc", "message": "Fix ToDate test failure - fixes #3026\n\nInstead of computing offset from UTC at current\npoint in time, use the offset from the parsed\ndate so that we're not affected by crossing\na daylight savings time boundary.", "committedDate": "2020-08-06T17:52:03Z", "type": "commit"}, {"oid": "c6ef7f06f796ccd196de1c0e7517e9765f899737", "url": "https://github.com/OpenRefine/OpenRefine/commit/c6ef7f06f796ccd196de1c0e7517e9765f899737", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restores a dropped test,\nands adds a ToDo/question about previous test behavior\nchange.", "committedDate": "2020-08-06T17:53:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NTc1Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r467345757", "bodyText": "@wetneb I think this test should pass, but it fails due to UTC timezone offset code that you added. Can you review and see if you agree?", "author": "tfmorris", "createdAt": "2020-08-08T01:39:28Z", "path": "main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java", "diffHunk": "@@ -167,12 +170,22 @@ public void testToDate() throws CalendarParserException {\n       // First string can be a locale identifier instead of a format string\n       Assert.assertEquals(invoke(\"toDate\", \"2013-06-01\",\"zh\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n       Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\",\"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\", \"MMM-dd-yyyy\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n \n       // If a long, convert to string\n       Assert.assertEquals(invoke(\"toDate\", (long) 2012), invoke(\"toDate\", \"2012-01-01\"));\n \n       // If already a date, leave it alone\n       Assert.assertEquals(invoke(\"toDate\", CalendarParser.parseAsOffsetDateTime(\"2012-03-01\")),CalendarParser.parseAsOffsetDateTime(\"2012-03-01\"));\n+\n+      // FIXME: Date/times without timezone info should be interpreted as local time, not UTC\n+//      Assert.assertEquals(invoke(\"toDate\", \"2013-06-01T13:12:11\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01 13:12:11\"));", "originalCommit": "3fd7ce92108aa4d57de6b024e87cc18e45a7fd4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1MjgwNQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r467352805", "bodyText": "@tfmorris I don't want to poke my eyes or mouth into this between both of you only to say this bit of history:\nI recall Jacky in a chat asking me about formatter expectations (GREL, cell values, etc.) because he was indeed having issues with correct parsing behavior based on what we expected or not.  That probably should have been a signal for me to ask Antonin or someone else (who was still newish to our team), but I think that discussion did eventually happen between him and Antonin in the contributing PRs and original issues for Java Date that he worked on.  I recall Instant and Locale being 2 terms he asked me about concerning expectations and I didn't have enough Java expertise.  I don't think an opportunity was missed regarding the new Java Date support, instead I just don't think we gave Jacky the right info about our expectations that he was asking of all of us at the time. :-(  After all, he did work for Citi at the time and maintained international date structures in databases and code for them.  So part of that was our fault.\nThe ISO_INSTANT would be UTC, yes? https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/time/format/DateTimeFormatter.html#ISO_INSTANT\nBut the ISO_LOCAL_DATE_TIME would be local, no? https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/time/format/DateTimeFormatter.html#ISO_LOCAL_DATE_TIME\nThis is all I recall of the conversations with him, sorry.  Hope it helps!", "author": "thadguidry", "createdAt": "2020-08-08T02:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1MzIxMA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r467353210", "bodyText": "Speaking of which...which Resolver style do we feel is most useful for regular OpenRefine users? https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/time/format/ResolverStyle.html#STRICT\nSince we consider ourselves a \"powertool\", perhaps STRICT to avoid surprises for our users?", "author": "thadguidry", "createdAt": "2020-08-08T03:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ3ODY3MQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r467478671", "bodyText": "@tfmorris that proposed test looks obviously sensible to me.\nBroadly speaking, my user-side requirements for this would be:\n\nif I parse a date string and then extract some date part from it, the value I get should be consistent with what was in the original string\nthe rendered version of the date should be consistent with the source string.\n\nI have not checked but that might require changes to datePart and cell rendering, to make sure these work correctly for local date times.", "author": "wetneb", "createdAt": "2020-08-08T16:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NTc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ef3d19f10dda63776569cbeb615dfc8b8f0262c0", "chunk": "diff --git a/main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java b/main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java\nindex 9906e5b77..f434512a1 100644\n--- a/main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java\n+++ b/main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java\n\n@@ -170,7 +164,10 @@ public class ToFromConversionTests extends RefineTest {\n       // First string can be a locale identifier instead of a format string\n       Assert.assertEquals(invoke(\"toDate\", \"2013-06-01\",\"zh\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n       Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\",\"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n-      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\", \"MMM-dd-yyyy\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\", \"zh-HK\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\", \"zh-TW\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\", \"zh-CN\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\", \"zh\", \"MMM-dd-yyyy\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n \n       // If a long, convert to string\n       Assert.assertEquals(invoke(\"toDate\", (long) 2012), invoke(\"toDate\", \"2012-01-01\"));\n"}}, {"oid": "ef3d19f10dda63776569cbeb615dfc8b8f0262c0", "url": "https://github.com/OpenRefine/OpenRefine/commit/ef3d19f10dda63776569cbeb615dfc8b8f0262c0", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local.", "committedDate": "2020-08-08T18:51:12Z", "type": "forcePushed"}, {"oid": "97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "url": "https://github.com/OpenRefine/OpenRefine/commit/97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local.", "committedDate": "2020-08-08T19:41:25Z", "type": "commit"}, {"oid": "97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "url": "https://github.com/OpenRefine/OpenRefine/commit/97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local.", "committedDate": "2020-08-08T19:41:25Z", "type": "forcePushed"}, {"oid": "ef60cf23c3fc1fa5dcfaa6f83e2fd630be01e8db", "url": "https://github.com/OpenRefine/OpenRefine/commit/ef60cf23c3fc1fa5dcfaa6f83e2fd630be01e8db", "message": "Restore error checking and messages", "committedDate": "2020-08-09T01:20:10Z", "type": "commit"}, {"oid": "21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "url": "https://github.com/OpenRefine/OpenRefine/commit/21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "message": "Save & restore default timezone for tests\n\nAlso add some ToDos for places where LocalDate is being misused.", "committedDate": "2020-08-09T01:58:11Z", "type": "commit"}, {"oid": "21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "url": "https://github.com/OpenRefine/OpenRefine/commit/21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "message": "Save & restore default timezone for tests\n\nAlso add some ToDos for places where LocalDate is being misused.", "committedDate": "2020-08-09T01:58:11Z", "type": "forcePushed"}]}