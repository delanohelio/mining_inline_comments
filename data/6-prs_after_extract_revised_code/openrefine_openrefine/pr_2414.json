{"pr_number": 2414, "pr_title": "Fix silent error in JSON/XML importers", "pr_createdAt": "2020-03-14T22:40:48Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2414", "timeline": [{"oid": "72ea8fa681220591cef36bfd802926aa1ca39200", "url": "https://github.com/OpenRefine/OpenRefine/commit/72ea8fa681220591cef36bfd802926aa1ca39200", "message": "Add error handler for parse error", "committedDate": "2020-03-14T21:49:35Z", "type": "commit"}, {"oid": "1728b4761508b57945bcd031999919445e9da018", "url": "https://github.com/OpenRefine/OpenRefine/commit/1728b4761508b57945bcd031999919445e9da018", "message": "Add test for parsing json with incorrect strecture", "committedDate": "2020-03-14T22:32:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODM1Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r392628353", "bodyText": "We should probably add 1 more new line to separate from the error itself more in the dialog and make it stand out.\nAlso, will this get localized properly for our translations support?", "author": "thadguidry", "createdAt": "2020-03-14T23:45:22Z", "path": "main/src/com/google/refine/importing/DefaultImportingController.java", "diffHunk": "@@ -290,7 +292,12 @@ static public void writeErrors(JsonGenerator writer, List<Exception> exceptions)\n             e.printStackTrace(new PrintWriter(sw));\n             \n             writer.writeStartObject();\n-            writer.writeStringField(\"message\", e.getLocalizedMessage());\n+            String errorMessage = e.getLocalizedMessage();\n+            if(e instanceof TreeReaderException) {\n+                errorMessage += \"\\nPlease correct the format of your input file, or choose another\" +", "originalCommit": "1728b4761508b57945bcd031999919445e9da018", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYzMTc3Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r392631777", "bodyText": "Sadly the whole error message is shown only in English under other languages.\nShould we only localized the latter part (\"Please correct your format ... \") and keep the error message unchanged ?", "author": "zengchu2", "createdAt": "2020-03-15T00:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYzMzk2OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r392633969", "bodyText": "Yes, please, if it's not too much trouble.", "author": "thadguidry", "createdAt": "2020-03-15T01:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY0MjE3Mg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r392642172", "bodyText": "Hi, I manged to fix this problem in front end .\nHere is my test result with incorrect json format input string:", "author": "zengchu2", "createdAt": "2020-03-15T05:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "1b0111271114309b8423cae89f23eee36638b8c6", "chunk": "diff --git a/main/src/com/google/refine/importing/DefaultImportingController.java b/main/src/com/google/refine/importing/DefaultImportingController.java\nindex 0bf56f7af..82b3a1edf 100644\n--- a/main/src/com/google/refine/importing/DefaultImportingController.java\n+++ b/main/src/com/google/refine/importing/DefaultImportingController.java\n\n@@ -292,12 +292,11 @@ public class DefaultImportingController implements ImportingController {\n             e.printStackTrace(new PrintWriter(sw));\n             \n             writer.writeStartObject();\n-            String errorMessage = e.getLocalizedMessage();\n+\n             if(e instanceof TreeReaderException) {\n-                errorMessage += \"\\nPlease correct the format of your input file, or choose another\" +\n-                        \" importer type such as Line-based\";\n+                writer.writeStringField(\"localizedMessage\", \"core-views/check-format\");\n             }\n-            writer.writeStringField(\"message\", errorMessage);\n+            writer.writeStringField(\"message\", e.getLocalizedMessage());\n             writer.writeStringField(\"stack\", sw.toString());\n             writer.writeEndObject();\n         }\n"}}, {"oid": "1b0111271114309b8423cae89f23eee36638b8c6", "url": "https://github.com/OpenRefine/OpenRefine/commit/1b0111271114309b8423cae89f23eee36638b8c6", "message": "Enable localization from front-end", "committedDate": "2020-03-15T04:52:08Z", "type": "commit"}, {"oid": "2f0b064f1bd6b97b2ac4f51657d572e4c9cbe70e", "url": "https://github.com/OpenRefine/OpenRefine/commit/2f0b064f1bd6b97b2ac4f51657d572e4c9cbe70e", "message": "Add methods to get localized error messages", "committedDate": "2020-03-15T05:03:43Z", "type": "commit"}, {"oid": "124874f5ae36b8983a0b748f9cfb0760452c1faa", "url": "https://github.com/OpenRefine/OpenRefine/commit/124874f5ae36b8983a0b748f9cfb0760452c1faa", "message": "Update returned exception message", "committedDate": "2020-03-15T22:27:35Z", "type": "commit"}, {"oid": "5cdbb39b164eeef0ceb68f394f1a6b7a9dc16a77", "url": "https://github.com/OpenRefine/OpenRefine/commit/5cdbb39b164eeef0ceb68f394f1a6b7a9dc16a77", "message": "Remove unused log and fix file diff issue", "committedDate": "2020-03-16T05:47:26Z", "type": "commit"}, {"oid": "5cdbb39b164eeef0ceb68f394f1a6b7a9dc16a77", "url": "https://github.com/OpenRefine/OpenRefine/commit/5cdbb39b164eeef0ceb68f394f1a6b7a9dc16a77", "message": "Remove unused log and fix file diff issue", "committedDate": "2020-03-16T05:47:26Z", "type": "forcePushed"}, {"oid": "be4c5d525cfeb632955aaaf39ae80c3cfa1a0380", "url": "https://github.com/OpenRefine/OpenRefine/commit/be4c5d525cfeb632955aaaf39ae80c3cfa1a0380", "message": "Test auto build", "committedDate": "2020-03-16T21:02:22Z", "type": "commit"}, {"oid": "f1aa73a440889e48f6e85be2f29687c65559436a", "url": "https://github.com/OpenRefine/OpenRefine/commit/f1aa73a440889e48f6e85be2f29687c65559436a", "message": "Refactor getOptions in newly created test", "committedDate": "2020-03-16T21:15:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwMjY0Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r395502643", "bodyText": "This code is specific to the JSON\u00a0importer, but it was added to a general purpose importing class. This is a problem: writing importers should not require making changes to generic classes like this.\nInstead, we should have a generic way to report parsing exceptions to the user. So I propose we do this:\n\nCatch the JsonParseException in the JSON importer;\nExtract the message as you are doing here;\nStore this message in a new exception, that we could introduce in this PR but could then be reused by other importers (we could call it ImportingParserException);\nThen we can still have your isImportingParserException logic with \"core-views/check-format\" as message that we concatenate.", "author": "wetneb", "createdAt": "2020-03-20T08:52:14Z", "path": "main/src/com/google/refine/importing/DefaultImportingController.java", "diffHunk": "@@ -290,7 +293,15 @@ static public void writeErrors(JsonGenerator writer, List<Exception> exceptions)\n             e.printStackTrace(new PrintWriter(sw));\n             \n             writer.writeStartObject();\n-            writer.writeStringField(\"message\", e.getLocalizedMessage());\n+            String message = e.getLocalizedMessage();\n+            \n+            if(e.getCause() instanceof JsonParseException) {", "originalCommit": "f1aa73a440889e48f6e85be2f29687c65559436a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e25752fe40909e662126b7b19c53e1e466a4a89", "chunk": "diff --git a/main/src/com/google/refine/importing/DefaultImportingController.java b/main/src/com/google/refine/importing/DefaultImportingController.java\nindex 9dd33fe68..0e83a5f73 100644\n--- a/main/src/com/google/refine/importing/DefaultImportingController.java\n+++ b/main/src/com/google/refine/importing/DefaultImportingController.java\n\n@@ -293,15 +293,7 @@ public class DefaultImportingController implements ImportingController {\n             e.printStackTrace(new PrintWriter(sw));\n             \n             writer.writeStartObject();\n-            String message = e.getLocalizedMessage();\n-            \n-            if(e.getCause() instanceof JsonParseException) {\n-                // Get message only \n-                writer.writeStringField(\"isJsonParseException\", \"true\");\n-                message = ((JsonParseException)e.getCause()).getOriginalMessage();\n-            }\n-\n-            writer.writeStringField(\"message\", message);\n+            writer.writeStringField(\"message\", e.getLocalizedMessage());\n             writer.writeStringField(\"stack\", sw.toString());\n             writer.writeEndObject();\n         }\n"}}, {"oid": "8e25752fe40909e662126b7b19c53e1e466a4a89", "url": "https://github.com/OpenRefine/OpenRefine/commit/8e25752fe40909e662126b7b19c53e1e466a4a89", "message": "Use new exception to unwrap original message", "committedDate": "2020-03-23T22:46:42Z", "type": "commit"}, {"oid": "929d5436122a69ee6f20e3df662c5fa448248e6d", "url": "https://github.com/OpenRefine/OpenRefine/commit/929d5436122a69ee6f20e3df662c5fa448248e6d", "message": "Undo unexpected fix", "committedDate": "2020-03-23T22:48:02Z", "type": "commit"}, {"oid": "04d85e962069ae3ccd39663f9a764d974f79fb32", "url": "https://github.com/OpenRefine/OpenRefine/commit/04d85e962069ae3ccd39663f9a764d974f79fb32", "message": "Remove unused lines", "committedDate": "2020-03-23T22:51:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0NDc3MQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r396944771", "bodyText": "I don't think we can assume that all TreeReaderException instances are JsonParseException\u2026 Especially since JsonParseException is not a subclass of TreeReaderException! It would be good to have a unit test to show how this works. (This sort of mistake should be caught by any unit test covering these lines)", "author": "wetneb", "createdAt": "2020-03-24T07:24:34Z", "path": "main/src/com/google/refine/importers/tree/XmlImportUtilities.java", "diffHunk": "@@ -265,13 +268,13 @@ static public void importTreeData(\n             }\n         } catch (TreeReaderException e) {\n             logger.error(\"Exception from XML parse\",e);\n-            throw e;\n+            throw new ImportingParserException(((JsonParseException)e.getCause()).getOriginalMessage());", "originalCommit": "8e25752fe40909e662126b7b19c53e1e466a4a89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49bc7e408bdd4d407e24f790724252dcb892a50a", "chunk": "diff --git a/main/src/com/google/refine/importers/tree/XmlImportUtilities.java b/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\nindex 6f6bce449..6902a5b62 100644\n--- a/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\n+++ b/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\n\n@@ -268,13 +267,13 @@ public class XmlImportUtilities extends TreeImportUtilities {\n             }\n         } catch (TreeReaderException e) {\n             logger.error(\"Exception from XML parse\",e);\n-            throw new ImportingParserException(((JsonParseException)e.getCause()).getOriginalMessage());\n+            throw e;\n         }\n     }\n \n     /**\n      *\n-     * @param pro\n+     * @param project\n      * @param parser\n      * @param recordPath\n      * @param pathIndex\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0NDkwMA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r396944900", "bodyText": "Why?", "author": "wetneb", "createdAt": "2020-03-24T07:24:57Z", "path": "main/src/com/google/refine/importers/tree/XmlImportUtilities.java", "diffHunk": "@@ -265,13 +268,13 @@ static public void importTreeData(\n             }\n         } catch (TreeReaderException e) {\n             logger.error(\"Exception from XML parse\",e);\n-            throw e;\n+            throw new ImportingParserException(((JsonParseException)e.getCause()).getOriginalMessage());\n         }\n     }\n \n     /**\n      *\n-     * @param project\n+     * @param pro", "originalCommit": "8e25752fe40909e662126b7b19c53e1e466a4a89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49bc7e408bdd4d407e24f790724252dcb892a50a", "chunk": "diff --git a/main/src/com/google/refine/importers/tree/XmlImportUtilities.java b/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\nindex 6f6bce449..6902a5b62 100644\n--- a/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\n+++ b/main/src/com/google/refine/importers/tree/XmlImportUtilities.java\n\n@@ -268,13 +267,13 @@ public class XmlImportUtilities extends TreeImportUtilities {\n             }\n         } catch (TreeReaderException e) {\n             logger.error(\"Exception from XML parse\",e);\n-            throw new ImportingParserException(((JsonParseException)e.getCause()).getOriginalMessage());\n+            throw e;\n         }\n     }\n \n     /**\n      *\n-     * @param pro\n+     * @param project\n      * @param parser\n      * @param recordPath\n      * @param pathIndex\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0NTkzOQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2414#discussion_r396945939", "bodyText": "\"This exception should contain\"\u2026 what?", "author": "wetneb", "createdAt": "2020-03-24T07:27:30Z", "path": "main/src/com/google/refine/importers/ImportingParserException.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.google.refine.importers;\n+\n+/**\n+ * Exception thrown by importers.  \n+ * This exception should contain ", "originalCommit": "04d85e962069ae3ccd39663f9a764d974f79fb32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "49bc7e408bdd4d407e24f790724252dcb892a50a", "chunk": "diff --git a/main/src/com/google/refine/importers/ImportingParserException.java b/main/src/com/google/refine/importers/ImportingParserException.java\ndeleted file mode 100644\nindex 3ce60e728..000000000\n--- a/main/src/com/google/refine/importers/ImportingParserException.java\n+++ /dev/null\n\n@@ -1,13 +0,0 @@\n-package com.google.refine.importers;\n-\n-/**\n- * Exception thrown by importers.  \n- * This exception should contain \n- */\n-public class ImportingParserException extends Exception {\n-\n-    public ImportingParserException(String message) {\n-        super(message);\n-    }\n-    \n-}\n\\ No newline at end of file\n"}}, {"oid": "49bc7e408bdd4d407e24f790724252dcb892a50a", "url": "https://github.com/OpenRefine/OpenRefine/commit/49bc7e408bdd4d407e24f790724252dcb892a50a", "message": "Fix exception logic", "committedDate": "2020-03-24T12:01:42Z", "type": "commit"}, {"oid": "4d725b2d3b6393c5c52d58a191b2c7a09f84513d", "url": "https://github.com/OpenRefine/OpenRefine/commit/4d725b2d3b6393c5c52d58a191b2c7a09f84513d", "message": "Fix typo", "committedDate": "2020-03-24T12:14:55Z", "type": "commit"}]}