{"pr_number": 356, "pr_title": "fix: Enabled automatic HTTP retries for FirebaseProjectManagement", "pr_createdAt": "2020-01-28T20:01:06Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/356", "timeline": [{"oid": "e260b9fd5d87024e09f3a376f183ae1fbdc741fb", "url": "https://github.com/firebase/firebase-admin-java/commit/e260b9fd5d87024e09f3a376f183ae1fbdc741fb", "message": "Enabled automatic HTTP retries for FirebaseProjectManagement", "committedDate": "2020-01-28T19:56:41Z", "type": "commit"}, {"oid": "fffdae80be973ce6e1243df9b8f5d29155d51802", "url": "https://github.com/firebase/firebase-admin-java/commit/fffdae80be973ce6e1243df9b8f5d29155d51802", "message": "Added some test cases", "committedDate": "2020-01-28T21:50:19Z", "type": "commit"}, {"oid": "78ff994ea3fbae34729a0c8d75f4d88fe9717dfe", "url": "https://github.com/firebase/firebase-admin-java/commit/78ff994ea3fbae34729a0c8d75f4d88fe9717dfe", "message": "Added helper function for disabling exponential backoff during tests", "committedDate": "2020-01-28T23:42:05Z", "type": "commit"}, {"oid": "8be0e06112a46920e0e8310b150f3397f6b0b24d", "url": "https://github.com/firebase/firebase-admin-java/commit/8be0e06112a46920e0e8310b150f3397f6b0b24d", "message": "Added util class for simplifying retry tests", "committedDate": "2020-01-29T00:31:35Z", "type": "commit"}, {"oid": "e7742c35b4e71cae1ba3072ee0fbfbabddacf092", "url": "https://github.com/firebase/firebase-admin-java/commit/e7742c35b4e71cae1ba3072ee0fbfbabddacf092", "message": "Simplified test cases", "committedDate": "2020-01-29T00:49:31Z", "type": "commit"}, {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841", "url": "https://github.com/firebase/firebase-admin-java/commit/666fa3cbd1412bfd0b4e3395433d72cbd49b2841", "message": "Removed unused method", "committedDate": "2020-01-29T00:52:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3NjIyMQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/356#discussion_r376676221", "bodyText": "At first I kind of want to say we should bake this assertion into the API infrastructure itself instead of directly verifying in a unit test that no one touched the code. But then the OO design I came up with to facilitate this turns out to be impossible due to various classes being final. I was hoping that we can write a subclass of HttpRequest called RetryingHttpRequest that declares at compile time that getUnsuccessfulResponseHandler will return RetryHandlerDecorator or a suitable base class, but alas, HttpRequest is final. (And so is HttpRequestFactory, which is the other class I wanted to subclass.)\nWithout the above OO structure, the only other way to structure the test to be more behavioural would be to treat the retrying mechanism completely like a black box, and empirically measure retry intervals and retry counts after forcing an unsuccessful response. This is going to be painfully flaky, so I think what you have is probably for the best.", "author": "weixifan", "createdAt": "2020-02-08T01:40:43Z", "path": "src/test/java/com/google/firebase/internal/TestApiClientUtils.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.internal;\n+\n+import static com.google.firebase.internal.ApiClientUtils.DEFAULT_RETRY_CONFIG;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpUnsuccessfulResponseHandler;\n+import com.google.api.client.testing.util.MockSleeper;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.internal.RetryInitializer.RetryHandlerDecorator;\n+import java.io.IOException;\n+\n+public class TestApiClientUtils {\n+\n+  private static final RetryConfig TEST_RETRY_CONFIG = RetryConfig.builder()\n+      .setMaxRetries(DEFAULT_RETRY_CONFIG.getMaxRetries())\n+      .setRetryStatusCodes(DEFAULT_RETRY_CONFIG.getRetryStatusCodes())\n+      .setMaxIntervalMillis(DEFAULT_RETRY_CONFIG.getMaxIntervalMillis())\n+      .setSleeper(new MockSleeper())\n+      .build();\n+\n+  private static final GenericUrl TEST_URL = new GenericUrl(\"https://firebase.google.com\");\n+\n+  /**\n+   * Creates a new {@code HttpRequestFactory} which provides authorization (OAuth2), timeouts and\n+   * automatic retries. Bypasses exponential backoff between consecutive retries for faster\n+   * execution during tests.\n+   *\n+   * @param app {@link FirebaseApp} from which to obtain authorization credentials.\n+   * @return A new {@code HttpRequestFactory} instance.\n+   */\n+  public static HttpRequestFactory delayBypassedRequestFactory(FirebaseApp app) {\n+    return ApiClientUtils.newAuthorizedRequestFactory(app, TEST_RETRY_CONFIG);\n+  }\n+\n+  /**\n+   * Creates a new {@code HttpRequestFactory} which provides authorization (OAuth2), timeouts but\n+   * no retries.\n+   *\n+   * @param app {@link FirebaseApp} from which to obtain authorization credentials.\n+   * @return A new {@code HttpRequestFactory} instance.\n+   */\n+  public static HttpRequestFactory retryDisabledRequestFactory(FirebaseApp app) {\n+    return ApiClientUtils.newAuthorizedRequestFactory(app, null);\n+  }\n+\n+  /**\n+   * Checks whther the given HttpRequestFactory has been configured for authorization and\n+   * automatic retries.\n+   *\n+   * @param requestFactory The HttpRequestFactory to check.\n+   */\n+  public static void assertAuthAndRetrySupport(HttpRequestFactory requestFactory) {\n+    assertTrue(requestFactory.getInitializer() instanceof FirebaseRequestInitializer);\n+    HttpRequest request;\n+    try {\n+      request = requestFactory.buildGetRequest(TEST_URL);\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Failed to initialize request\", e);\n+    }\n+\n+    // Verify authorization\n+    assertTrue(request.getHeaders().getAuthorization().startsWith(\"Bearer \"));\n+\n+    // Verify retry support\n+    HttpUnsuccessfulResponseHandler retryHandler = request.getUnsuccessfulResponseHandler();\n+    assertTrue(retryHandler instanceof RetryHandlerDecorator);", "originalCommit": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}