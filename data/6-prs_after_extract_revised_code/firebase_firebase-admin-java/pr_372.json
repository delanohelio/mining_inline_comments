{"pr_number": 372, "pr_title": "Add deleteTenant operation to TenantManager.", "pr_createdAt": "2020-02-20T21:37:55Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/372", "timeline": [{"oid": "a75bfbca9bc710562cfe7a89072e444d80ae244b", "url": "https://github.com/firebase/firebase-admin-java/commit/a75bfbca9bc710562cfe7a89072e444d80ae244b", "message": "Add deleteTenant operation to TenantManager.", "committedDate": "2020-02-20T21:35:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDEzMg==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r382314132", "bodyText": "Should use DELETE /tenants/{tenantId} URL format here.", "author": "hiranya911", "createdAt": "2020-02-20T23:21:29Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -226,6 +226,15 @@ UserImportResult importUsers(UserImportRequest request) throws FirebaseAuthExcep\n     return new UserImportResult(request.getUsersCount(), response);\n   }\n \n+  void deleteTenant(String tenantId) throws FirebaseAuthException {\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + \"/tenants:delete\");\n+    url.put(\"name\", tenantId);", "originalCommit": "a75bfbca9bc710562cfe7a89072e444d80ae244b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NDY4MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385244680", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-02-27T17:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDEzMg=="}], "type": "inlineReview", "revised_code": {"commit": "c03dd3627955d6d8316ea5ceca17902da7b899a1", "chunk": "diff --git a/src/main/java/com/google/firebase/auth/FirebaseUserManager.java b/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\nindex d1b83fe..808637f 100644\n--- a/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\n+++ b/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\n\n@@ -227,8 +227,7 @@ class FirebaseUserManager {\n   }\n \n   void deleteTenant(String tenantId) throws FirebaseAuthException {\n-    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + \"/tenants:delete\");\n-    url.put(\"name\", tenantId);\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + \"/tenants/\" + tenantId);\n     GenericJson response = sendRequest(\"DELETE\", url, null, GenericJson.class);\n     if (response == null) {\n       throw new FirebaseAuthException(INTERNAL_ERROR, \"Failed to delete tenant: \" + tenantId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDQwOA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r382314408", "bodyText": "Let's also assert the URL of the outgoing request and make sure TENANT_1 is being included in the request.", "author": "hiranya911", "createdAt": "2020-02-20T23:22:18Z", "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -476,6 +476,14 @@ public void testListZeroTenants() throws Exception {\n     checkRequestHeaders(interceptor);\n   }\n \n+  @Test\n+  public void testDeleteTenant() throws Exception {\n+    TestResponseInterceptor interceptor = initializeAppForUserManagement(\"{}\");\n+    // should not throw\n+    FirebaseAuth.getInstance().getTenantManager().deleteTenantAsync(\"TENANT_1\").get();\n+    checkRequestHeaders(interceptor);", "originalCommit": "a75bfbca9bc710562cfe7a89072e444d80ae244b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NDgzNw==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385244837", "bodyText": "Done. How do I assert that that it was a DELETE request?", "author": "micahstairs", "createdAt": "2020-02-27T17:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTU5OA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385315598", "bodyText": "Something like the following should work:\ninterceptor.getResponse().getRequest().getMethod()", "author": "hiranya911", "createdAt": "2020-02-27T19:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwMDE1MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385400150", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-02-27T22:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDQwOA=="}], "type": "inlineReview", "revised_code": {"commit": "c03dd3627955d6d8316ea5ceca17902da7b899a1", "chunk": "diff --git a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\nindex bea7650..50441cd 100644\n--- a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n+++ b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n\n@@ -482,6 +482,8 @@ public class FirebaseUserManagerTest {\n     // should not throw\n     FirebaseAuth.getInstance().getTenantManager().deleteTenantAsync(\"TENANT_1\").get();\n     checkRequestHeaders(interceptor);\n+    checkUrl(interceptor,\n+        \"https://identitytoolkit.googleapis.com/v2/projects/test-project-id/tenants/TENANT_1\");\n   }\n \n   @Test\n"}}, {"oid": "c03dd3627955d6d8316ea5ceca17902da7b899a1", "url": "https://github.com/firebase/firebase-admin-java/commit/c03dd3627955d6d8316ea5ceca17902da7b899a1", "message": "Address pull request feedback", "committedDate": "2020-02-27T17:03:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTEyNw==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385315127", "bodyText": "Why was the annotation removed?", "author": "hiranya911", "createdAt": "2020-02-27T19:12:08Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -287,7 +295,7 @@ String getEmailActionLink(EmailLinkType type, String email,\n \n   private <T> T sendRequest(\n           String method, GenericUrl url,\n-          @Nullable Object content, Class<T> clazz) throws FirebaseAuthException {\n+          Object content, Class<T> clazz) throws FirebaseAuthException {", "originalCommit": "c03dd3627955d6d8316ea5ceca17902da7b899a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzMjc5NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385332794", "bodyText": "I removed this because of the following line:\ncheckNotNull(clazz, \"response class must not be null\");", "author": "micahstairs", "createdAt": "2020-02-27T19:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzOTg3OQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385339879", "bodyText": "The annotation was on Object content, which is nullable?", "author": "hiranya911", "createdAt": "2020-02-27T19:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NDc2Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385394767", "bodyText": "Ah sorry, I was looking at the wrong variable. This will be fixed when I push my other changes.", "author": "micahstairs", "createdAt": "2020-02-27T21:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTEyNw=="}], "type": "inlineReview", "revised_code": {"commit": "aa2467b0a0ea84906d059d7df5b219f79292d82c", "chunk": "diff --git a/src/main/java/com/google/firebase/auth/FirebaseUserManager.java b/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\nindex 808637f..4bab926 100644\n--- a/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\n+++ b/src/main/java/com/google/firebase/auth/FirebaseUserManager.java\n\n@@ -295,7 +298,7 @@ class FirebaseUserManager {\n \n   private <T> T sendRequest(\n           String method, GenericUrl url,\n-          Object content, Class<T> clazz) throws FirebaseAuthException {\n+          @Nullable Object content, Class<T> clazz) throws FirebaseAuthException {\n \n     checkArgument(!Strings.isNullOrEmpty(method), \"method must not be null or empty\");\n     checkNotNull(url, \"url must not be null\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjI2Ng==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385316266", "bodyText": "Make sure the TENANT_NOT_FOUND is handled correctly (similar to getTenant)", "author": "hiranya911", "createdAt": "2020-02-27T19:14:24Z", "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -476,6 +476,16 @@ public void testListZeroTenants() throws Exception {\n     checkRequestHeaders(interceptor);\n   }\n \n+  @Test\n+  public void testDeleteTenant() throws Exception {", "originalCommit": "c03dd3627955d6d8316ea5ceca17902da7b899a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwMDIyOA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385400228", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-02-27T22:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c042c0fc0391c5a2f490ae7b28fe4cb41dbe3e95", "chunk": "diff --git a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\nindex 50441cd..f90777b 100644\n--- a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n+++ b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n\n@@ -479,11 +481,36 @@ public class FirebaseUserManagerTest {\n   @Test\n   public void testDeleteTenant() throws Exception {\n     TestResponseInterceptor interceptor = initializeAppForUserManagement(\"{}\");\n-    // should not throw\n+\n     FirebaseAuth.getInstance().getTenantManager().deleteTenantAsync(\"TENANT_1\").get();\n+\n     checkRequestHeaders(interceptor);\n-    checkUrl(interceptor,\n-        \"https://identitytoolkit.googleapis.com/v2/projects/test-project-id/tenants/TENANT_1\");\n+    checkUrl(interceptor, \"DELETE\", TENANTS_BASE_URL + \"/TENANT_1\");\n+  }\n+\n+  @Test\n+  public void testDeleteTenantWithNotFoundError() throws Exception {\n+    FirebaseApp.initializeApp(new FirebaseOptions.Builder()\n+        .setCredentials(credentials)\n+        .setHttpTransport(new MultiRequestMockHttpTransport(ImmutableList.of(\n+            new MockLowLevelHttpResponse()\n+                .setContent(\"{}\")\n+                .setStatusCode(404))))\n+        .setProjectId(\"test-project-id\")\n+        .build());\n+    TestResponseInterceptor interceptor = new TestResponseInterceptor();\n+    FirebaseAuth auth = FirebaseAuth.getInstance();\n+    auth.getUserManager().setInterceptor(interceptor);\n+\n+    try {\n+      auth.getTenantManager().deleteTenantAsync(\"UNKNOWN\").get();\n+      fail(\"No error thrown for invalid response\");\n+    } catch (ExecutionException e) {\n+      assertTrue(e.getCause() instanceof FirebaseAuthException);\n+      FirebaseAuthException authException = (FirebaseAuthException) e.getCause();\n+      assertEquals(FirebaseUserManager.TENANT_NOT_FOUND_ERROR, authException.getErrorCode());\n+    }\n+    checkUrl(interceptor, \"DELETE\", TENANTS_BASE_URL + \"/UNKNOWN\");\n   }\n \n   @Test\n"}}, {"oid": "c042c0fc0391c5a2f490ae7b28fe4cb41dbe3e95", "url": "https://github.com/firebase/firebase-admin-java/commit/c042c0fc0391c5a2f490ae7b28fe4cb41dbe3e95", "message": "Work on testing error handling of deleteTenant.", "committedDate": "2020-02-27T20:53:32Z", "type": "commit"}, {"oid": "aa2467b0a0ea84906d059d7df5b219f79292d82c", "url": "https://github.com/firebase/firebase-admin-java/commit/aa2467b0a0ea84906d059d7df5b219f79292d82c", "message": "Fix error handling test for deleteTenant and do some refactoring.", "committedDate": "2020-02-27T22:08:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwODA4NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/372#discussion_r385408084", "bodyText": "Nit: Introduce local variable for HttpRequest.", "author": "hiranya911", "createdAt": "2020-02-27T22:27:20Z", "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -1326,6 +1343,11 @@ private static void checkRequestHeaders(TestResponseInterceptor interceptor) {\n     assertEquals(clientVersion, headers.getFirstHeaderStringValue(\"X-Client-Version\"));\n   }\n \n+  private static void checkUrl(TestResponseInterceptor interceptor, String method, String url) {\n+    assertEquals(method, interceptor.getResponse().getRequest().getRequestMethod());", "originalCommit": "aa2467b0a0ea84906d059d7df5b219f79292d82c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d22031fe61042d7b37e3022b426b4f834f752fb5", "chunk": "diff --git a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\nindex 5a460de..c1ef26c 100644\n--- a/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n+++ b/src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java\n\n@@ -1344,8 +1344,9 @@ public class FirebaseUserManagerTest {\n   }\n \n   private static void checkUrl(TestResponseInterceptor interceptor, String method, String url) {\n-    assertEquals(method, interceptor.getResponse().getRequest().getRequestMethod());\n-    assertEquals(url, interceptor.getResponse().getRequest().getUrl().toString());\n+    HttpRequest request = interceptor.getResponse().getRequest();\n+    assertEquals(method, request.getRequestMethod());\n+    assertEquals(url, request.getUrl().toString());\n   }\n \n   private interface UserManagerOp {\n"}}, {"oid": "d22031fe61042d7b37e3022b426b4f834f752fb5", "url": "https://github.com/firebase/firebase-admin-java/commit/d22031fe61042d7b37e3022b426b4f834f752fb5", "message": "Introduce local variable for HttpRequest", "committedDate": "2020-02-27T23:05:46Z", "type": "commit"}]}