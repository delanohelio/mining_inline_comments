{"pr_number": 386, "pr_title": "Add firebase auth destroy check before tenant operations.", "pr_createdAt": "2020-04-01T00:44:54Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/386", "timeline": [{"oid": "2fe5d7d6005cd3c3cc8f6692f007564f709c59bb", "url": "https://github.com/firebase/firebase-admin-java/commit/2fe5d7d6005cd3c3cc8f6692f007564f709c59bb", "message": "Added firebase app destruction check before tenant operations", "committedDate": "2020-04-01T00:42:55Z", "type": "commit"}, {"oid": "f908691f9a064b889bb882d4eeca068be135f586", "url": "https://github.com/firebase/firebase-admin-java/commit/f908691f9a064b889bb882d4eeca068be135f586", "message": "Restructure destroy calls.", "committedDate": "2020-04-01T20:42:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzY4OA==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r401927688", "bodyText": "I think this can remain private now.", "author": "hiranya911", "createdAt": "2020-04-01T21:43:13Z", "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -1086,7 +1086,7 @@ public T get() {\n         });\n   }\n \n-  private void checkNotDestroyed() {\n+  void checkNotDestroyed() {", "originalCommit": "f908691f9a064b889bb882d4eeca068be135f586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3OTcyOA==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r402679728", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-03T01:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzY4OA=="}], "type": "inlineReview", "revised_code": {"commit": "eef821c5811b748717decc4de8f2798b301a86e1", "chunk": "diff --git a/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java b/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\nindex 5c6844c..901683c 100644\n--- a/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\n+++ b/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\n\n@@ -1086,7 +1086,7 @@ public abstract class AbstractFirebaseAuth {\n         });\n   }\n \n-  void checkNotDestroyed() {\n+  private void checkNotDestroyed() {\n     synchronized (lock) {\n       checkState(\n           !destroyed.get(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzk0Mg==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r401927942", "bodyText": "Make this just final void?", "author": "hiranya911", "createdAt": "2020-04-01T21:43:49Z", "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -1095,9 +1095,13 @@ private void checkNotDestroyed() {\n     }\n   }\n \n-  void destroy() {\n+  protected void destroy() {", "originalCommit": "f908691f9a064b889bb882d4eeca068be135f586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3OTY4NQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r402679685", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-03T00:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNzk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "eef821c5811b748717decc4de8f2798b301a86e1", "chunk": "diff --git a/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java b/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\nindex 5c6844c..901683c 100644\n--- a/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\n+++ b/src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java\n\n@@ -1095,7 +1095,7 @@ public abstract class AbstractFirebaseAuth {\n     }\n   }\n \n-  protected void destroy() {\n+  final void destroy() {\n     synchronized (lock) {\n       doDestroy();\n       destroyed.set(true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyOTg2Mg==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r401929862", "bodyText": "Set this to true in the Supplier.get() method (in the FirebaseAuth constructor). That method gets further wrapped in a threadSafeMemoize which provides the necessary locking around it.", "author": "hiranya911", "createdAt": "2020-04-01T21:47:48Z", "path": "src/main/java/com/google/firebase/auth/FirebaseAuth.java", "diffHunk": "@@ -53,7 +57,12 @@ public TenantManager get() {\n   }\n \n   public TenantManager getTenantManager() {\n-    return tenantManager.get();\n+    TenantManager suppliedTenantManager;\n+    synchronized (lock) {\n+      suppliedTenantManager = tenantManager.get();\n+      tenantManagerCreated.set(true);", "originalCommit": "f908691f9a064b889bb882d4eeca068be135f586", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3OTY1MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/386#discussion_r402679650", "bodyText": "Oh great idea! This looks much cleaner.", "author": "micahstairs", "createdAt": "2020-04-03T00:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyOTg2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "eef821c5811b748717decc4de8f2798b301a86e1", "chunk": "diff --git a/src/main/java/com/google/firebase/auth/FirebaseAuth.java b/src/main/java/com/google/firebase/auth/FirebaseAuth.java\nindex c926b2a..8c7f18d 100644\n--- a/src/main/java/com/google/firebase/auth/FirebaseAuth.java\n+++ b/src/main/java/com/google/firebase/auth/FirebaseAuth.java\n\n@@ -51,18 +49,14 @@ public class FirebaseAuth extends AbstractFirebaseAuth {\n     tenantManager = threadSafeMemoize(new Supplier<TenantManager>() {\n       @Override\n       public TenantManager get() {\n+        tenantManagerCreated.set(true);\n         return new TenantManager(builder.firebaseApp, getUserManager());\n       }\n     });\n   }\n \n   public TenantManager getTenantManager() {\n-    TenantManager suppliedTenantManager;\n-    synchronized (lock) {\n-      suppliedTenantManager = tenantManager.get();\n-      tenantManagerCreated.set(true);\n-    }\n-    return suppliedTenantManager;\n+    return tenantManager.get();\n   }\n \n   /**\n"}}, {"oid": "eef821c5811b748717decc4de8f2798b301a86e1", "url": "https://github.com/firebase/firebase-admin-java/commit/eef821c5811b748717decc4de8f2798b301a86e1", "message": "Address pull request feedback.", "committedDate": "2020-04-03T00:58:06Z", "type": "commit"}]}