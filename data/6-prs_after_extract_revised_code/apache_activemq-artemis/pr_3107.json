{"pr_number": 3107, "pr_title": "ARTEMIS-2648 - audit logging improvements", "pr_createdAt": "2020-04-30T13:29:46Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3107", "timeline": [{"oid": "3d40d581c08b6fb2ee8c778398327e35a9817ef6", "url": "https://github.com/apache/activemq-artemis/commit/3d40d581c08b6fb2ee8c778398327e35a9817ef6", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-04-30T13:39:54Z", "type": "forcePushed"}, {"oid": "a6647f2dd203aa16396b8cefeaf03c7151b9dc7b", "url": "https://github.com/apache/activemq-artemis/commit/a6647f2dd203aa16396b8cefeaf03c7151b9dc7b", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-01T10:20:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzNjQyNw==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418536427", "bodyText": "You don't need this. you're using AMQPConnection directly, no need to change to change EventHandler.\nCan you remove it?", "author": "clebertsuconic", "createdAt": "2020-05-01T13:17:32Z", "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/EventHandler.java", "diffHunk": "@@ -91,4 +91,7 @@ default boolean flowControl(ReadyListener readyListener) {\n       return true;\n    }\n \n+   default String getRemoteAddress() {", "originalCommit": "a6647f2dd203aa16396b8cefeaf03c7151b9dc7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzNzU2MA==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418537560", "bodyText": "actually, you do use it...\nBut you are calling this on every proton event. isn't there a better place to call that?", "author": "clebertsuconic", "createdAt": "2020-05-01T13:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzNjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MjQ4MQ==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418582481", "bodyText": "It is on every event so it is available to the Audit logger", "author": "andytaylor", "createdAt": "2020-05-01T15:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzNjQyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzOTgzOA==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418539838", "bodyText": "this won't work...\nopenWireActor.act() will transfer the execution to a different thread.\nyou will lose the ThreadLocal here.\nThe netty loop is reused for many connections.", "author": "clebertsuconic", "createdAt": "2020-05-01T13:26:46Z", "path": "artemis-protocols/artemis-openwire-protocol/src/main/java/org/apache/activemq/artemis/core/protocol/openwire/OpenWireConnection.java", "diffHunk": "@@ -287,6 +288,9 @@ public void bufferReceived(Object connectionID, ActiveMQBuffer buffer) {\n          if (logger.isTraceEnabled()) {\n             traceBufferReceived(connectionID, command);\n          }\n+         if (AuditLogger.isAnyLoggingEnabled()) {\n+            AuditLogger.setRemoteAddress(getRemoteAddress());", "originalCommit": "a6647f2dd203aa16396b8cefeaf03c7151b9dc7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0MTQwMg==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418541402", "bodyText": "this could eventually fail in other protocols as well. you would endup informing a wrong remote address for Audit Operations.", "author": "clebertsuconic", "createdAt": "2020-05-01T13:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzOTgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MjYyNQ==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418582625", "bodyText": "ok, I will address", "author": "andytaylor", "createdAt": "2020-05-01T15:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzOTgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NTc3MQ==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418595771", "bodyText": "Just an idea. We have OperationContext, which will hold operations to the Session, and it has a thread local already.\nWhy don't you somehow inject the session on the operation context and use the thread local from there. We recover it back whenever we do a new operation on the session. It is a reliable place.", "author": "clebertsuconic", "createdAt": "2020-05-01T15:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzOTgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NjA5MQ==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418596091", "bodyText": "I mean.. why don't you inject the data you need on the operation context.", "author": "clebertsuconic", "createdAt": "2020-05-01T15:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzOTgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "0f2e879c0407df43b7f88581fd99b9350ef04925", "chunk": "diff --git a/artemis-protocols/artemis-openwire-protocol/src/main/java/org/apache/activemq/artemis/core/protocol/openwire/OpenWireConnection.java b/artemis-protocols/artemis-openwire-protocol/src/main/java/org/apache/activemq/artemis/core/protocol/openwire/OpenWireConnection.java\nindex 90fab9d295..2fa60de087 100644\n--- a/artemis-protocols/artemis-openwire-protocol/src/main/java/org/apache/activemq/artemis/core/protocol/openwire/OpenWireConnection.java\n+++ b/artemis-protocols/artemis-openwire-protocol/src/main/java/org/apache/activemq/artemis/core/protocol/openwire/OpenWireConnection.java\n\n@@ -288,9 +288,6 @@ public class OpenWireConnection extends AbstractRemotingConnection implements Se\n          if (logger.isTraceEnabled()) {\n             traceBufferReceived(connectionID, command);\n          }\n-         if (AuditLogger.isAnyLoggingEnabled()) {\n-            AuditLogger.setRemoteAddress(getRemoteAddress());\n-         }\n \n          if (openWireActor != null) {\n             openWireActor.act(command);\n"}}, {"oid": "4a48fda6fdd5e334c225eb64831b9364f805465c", "url": "https://github.com/apache/activemq-artemis/commit/4a48fda6fdd5e334c225eb64831b9364f805465c", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-01T15:00:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwNjY2MQ==", "url": "https://github.com/apache/activemq-artemis/pull/3107#discussion_r418606661", "bodyText": "Do you need to do this for every event? It seems you only need to this only once.. so I think you could do this at the beggining of the method, before the loop starts.", "author": "clebertsuconic", "createdAt": "2020-05-01T15:59:37Z", "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/ProtonHandler.java", "diffHunk": "@@ -497,6 +498,9 @@ private void dispatch() {\n                if (log.isTraceEnabled()) {\n                   log.trace(\"Handling \" + ev + \" towards \" + h);\n                }\n+               if (AuditLogger.isAnyLoggingEnabled()) {", "originalCommit": "4a48fda6fdd5e334c225eb64831b9364f805465c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8a04ee07de8a7c863daf37a07a1176131151caa0", "chunk": "diff --git a/artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/ProtonHandler.java b/artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/ProtonHandler.java\nindex 8177d92a47..b693b91c01 100644\n--- a/artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/ProtonHandler.java\n+++ b/artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/handler/ProtonHandler.java\n\n@@ -493,14 +493,16 @@ public class ProtonHandler extends ProtonInitializable implements SaslListener {\n       }\n       try {\n          inDispatch = true;\n+         if (AuditLogger.isAnyLoggingEnabled()) {\n+            for (EventHandler h : handlers) {\n+               AuditLogger.setRemoteAddress(h.getRemoteAddress());\n+            }\n+         }\n          while ((ev = collector.peek()) != null) {\n             for (EventHandler h : handlers) {\n                if (log.isTraceEnabled()) {\n                   log.trace(\"Handling \" + ev + \" towards \" + h);\n                }\n-               if (AuditLogger.isAnyLoggingEnabled()) {\n-                  AuditLogger.setRemoteAddress(h.getRemoteAddress());\n-               }\n                try {\n                   Events.dispatch(ev, h);\n                } catch (ActiveMQSecurityException e) {\n"}}, {"oid": "0f2e879c0407df43b7f88581fd99b9350ef04925", "url": "https://github.com/apache/activemq-artemis/commit/0f2e879c0407df43b7f88581fd99b9350ef04925", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-02T09:51:45Z", "type": "forcePushed"}, {"oid": "ce68f2f60f65b8ca12a51f853fa99fac493feb4e", "url": "https://github.com/apache/activemq-artemis/commit/ce68f2f60f65b8ca12a51f853fa99fac493feb4e", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-04T10:26:10Z", "type": "forcePushed"}, {"oid": "179dab99cacff8668073c878a63d043e236a0d43", "url": "https://github.com/apache/activemq-artemis/commit/179dab99cacff8668073c878a63d043e236a0d43", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-04T14:07:06Z", "type": "forcePushed"}, {"oid": "8a04ee07de8a7c863daf37a07a1176131151caa0", "url": "https://github.com/apache/activemq-artemis/commit/8a04ee07de8a7c863daf37a07a1176131151caa0", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-04T14:19:08Z", "type": "commit"}, {"oid": "8a04ee07de8a7c863daf37a07a1176131151caa0", "url": "https://github.com/apache/activemq-artemis/commit/8a04ee07de8a7c863daf37a07a1176131151caa0", "message": "ARTEMIS-2648 - audit logging improvements\n\nhttps://issues.apache.org/jira/browse/ARTEMIS-2648", "committedDate": "2020-05-04T14:19:08Z", "type": "forcePushed"}]}