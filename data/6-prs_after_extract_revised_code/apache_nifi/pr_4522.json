{"pr_number": 4522, "pr_title": "NIFI-7796: Add Prometheus counters for total bytes sent/received", "pr_createdAt": "2020-09-11T16:33:40Z", "pr_url": "https://github.com/apache/nifi/pull/4522", "timeline": [{"oid": "2fdf64dc16c513180302e8392b64c62281778f0f", "url": "https://github.com/apache/nifi/commit/2fdf64dc16c513180302e8392b64c62281778f0f", "message": "NIFI-7796: Fixed copy-paste errors for Prometheus metrics", "committedDate": "2020-09-14T18:02:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzMDc4Nw==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r488230787", "bodyText": "@mattyb149 in this instance we'll need to keep the TOTAL_BYTES_READ and TOTAL_BYTES_WRITTEN (lines previously on 252 and 253 however the portStatus.getInputBytes() and portStatus.getOutputBytes() should be used respectively as in lines 250 and 251", "author": "YolandaMDavis", "createdAt": "2020-09-14T21:29:08Z", "path": "nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java", "diffHunk": "@@ -249,10 +249,8 @@ public static CollectorRegistry createNifiMetrics(NiFiMetricsRegistry nifiMetric\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesSent(), \"AMOUNT_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getInputBytes(), \"AMOUNT_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getOutputBytes(), \"AMOUNT_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesRead(), \"TOTAL_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesWritten(), \"TOTAL_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesReceived(), \"TOTAL_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesSent(), \"TOTAL_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getBytesReceived(), \"TOTAL_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getBytesSent(), \"TOTAL_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);", "originalCommit": "2fdf64dc16c513180302e8392b64c62281778f0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYzOTQ3Nw==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r488639477", "bodyText": "Good catch, I saw the behavior while doing some additional testing. Since the second commit isn't valid, I'll just correct the original and force-push", "author": "mattyb149", "createdAt": "2020-09-15T12:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzMDc4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a99f4f873e9a373ae6c9e7a9990361cd260f8895", "chunk": "diff --git a/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java b/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\nindex 5ff4e9acb8..087e5b895f 100644\n--- a/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\n+++ b/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\n\n@@ -249,6 +249,8 @@ public class PrometheusMetricsUtil {\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesSent(), \"AMOUNT_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getInputBytes(), \"AMOUNT_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getOutputBytes(), \"AMOUNT_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getInputBytes(), \"TOTAL_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getOutputBytes(), \"TOTAL_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.incrementCounter(portStatus.getBytesReceived(), \"TOTAL_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.incrementCounter(portStatus.getBytesSent(), \"TOTAL_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesReceived(), \"AMOUNT_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzMTM0OQ==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r488231349", "bodyText": "same as comment above", "author": "YolandaMDavis", "createdAt": "2020-09-14T21:30:18Z", "path": "nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java", "diffHunk": "@@ -277,10 +275,8 @@ public static CollectorRegistry createNifiMetrics(NiFiMetricsRegistry nifiMetric\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesSent(), \"AMOUNT_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getInputBytes(), \"AMOUNT_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getOutputBytes(), \"AMOUNT_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesRead(), \"TOTAL_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesWritten(), \"TOTAL_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n-                nifiMetricsRegistry.incrementCounter(status.getBytesReceived(), \"TOTAL_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);", "originalCommit": "2fdf64dc16c513180302e8392b64c62281778f0f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a99f4f873e9a373ae6c9e7a9990361cd260f8895", "chunk": "diff --git a/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java b/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\nindex 5ff4e9acb8..087e5b895f 100644\n--- a/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\n+++ b/nifi-nar-bundles/nifi-extension-utils/nifi-prometheus-utils/src/main/java/org/apache/nifi/prometheus/util/PrometheusMetricsUtil.java\n\n@@ -275,6 +277,8 @@ public class PrometheusMetricsUtil {\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesSent(), \"AMOUNT_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getInputBytes(), \"AMOUNT_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getOutputBytes(), \"AMOUNT_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getInputBytes(), \"TOTAL_BYTES_READ\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n+                nifiMetricsRegistry.incrementCounter(portStatus.getOutputBytes(), \"TOTAL_BYTES_WRITTEN\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.incrementCounter(portStatus.getBytesReceived(), \"TOTAL_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.incrementCounter(portStatus.getBytesSent(), \"TOTAL_BYTES_SENT\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n                 nifiMetricsRegistry.setDataPoint(portStatus.getBytesReceived(), \"AMOUNT_BYTES_RECEIVED\", instanceId, portComponentType, portComponentName, portComponentId, parentId);\n"}}, {"oid": "a99f4f873e9a373ae6c9e7a9990361cd260f8895", "url": "https://github.com/apache/nifi/commit/a99f4f873e9a373ae6c9e7a9990361cd260f8895", "message": "NIFI-7796: Add Prometheus counters for total bytes sent/received, fixed copy/paste errors", "committedDate": "2020-09-15T13:00:04Z", "type": "forcePushed"}, {"oid": "5b04fdd0237c2319a784a56bff7cd727c03c60cf", "url": "https://github.com/apache/nifi/commit/5b04fdd0237c2319a784a56bff7cd727c03c60cf", "message": "NIFI-7796: Add Prometheus counters for total bytes sent/received", "committedDate": "2020-09-23T20:27:09Z", "type": "forcePushed"}, {"oid": "f4f73b5b7155eddce23e278e2e2e52416fc87b93", "url": "https://github.com/apache/nifi/commit/f4f73b5b7155eddce23e278e2e2e52416fc87b93", "message": "NIFI-7796: Add Prometheus metrics for total bytes sent/received, fixed read/written metrics", "committedDate": "2020-09-23T21:22:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODE1NA==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r497558154", "bodyText": "@mattyb149 wondering if this interface can be simplified? In the implementation class (RingBufferEventRepository) the aggregatedValues object is used to produce these values by first converting that object to a flowFileEvent.  Can we  instead do a method like \"reportAggregatedEvents\" which returns a FlowFileEvent?  Then callers could just use that single FlowFileEvent to do getBytesRead/getBytesWritten etc.", "author": "YolandaMDavis", "createdAt": "2020-09-30T14:31:51Z", "path": "nifi-api/src/main/java/org/apache/nifi/reporting/EventAccess.java", "diffHunk": "@@ -63,4 +63,32 @@\n      */\n     List<Action> getFlowChanges(int firstActionId, final int maxActions);\n \n+    /**", "originalCommit": "f4f73b5b7155eddce23e278e2e2e52416fc87b93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4MTkzNw==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r497581937", "bodyText": "Makes sense, but FlowFileEvent is in nifi-framework-core-api, so we'd likely have to move that into nifi-api so everyone can use it. I'll look into the best way to do that.", "author": "mattyb149", "createdAt": "2020-09-30T15:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxNzE5MQ==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r497617191", "bodyText": "@mattyb149 my apologies I meant to mark my comment on the FlowFileEventRepository, not EventAccess.", "author": "YolandaMDavis", "createdAt": "2020-09-30T15:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1ODE1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxNzc4Mg==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r497617782", "bodyText": "@mattyb149 this is interface I meant to reference in my comments above.", "author": "YolandaMDavis", "createdAt": "2020-09-30T15:49:47Z", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-framework-core-api/src/main/java/org/apache/nifi/controller/repository/FlowFileEventRepository.java", "diffHunk": "@@ -51,4 +51,32 @@\n      * @param componentIdentifier Identifier of the component\n      */\n     void purgeTransferEvents(String componentIdentifier);\n+\n+    /**\n+     * Returns the total number of bytes read by this instance (at the root process group level) since the instance started", "originalCommit": "f4f73b5b7155eddce23e278e2e2e52416fc87b93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1NjAyMg==", "url": "https://github.com/apache/nifi/pull/4522#discussion_r497656022", "bodyText": "Sounds good, will update to return a FlowFileEvent", "author": "mattyb149", "createdAt": "2020-09-30T16:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxNzc4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b593bb03702c690aa753bd732b01c77017696252", "chunk": "diff --git a/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-framework-core-api/src/main/java/org/apache/nifi/controller/repository/FlowFileEventRepository.java b/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-framework-core-api/src/main/java/org/apache/nifi/controller/repository/FlowFileEventRepository.java\nindex 0dd4346b66..d3a04999f8 100644\n--- a/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-framework-core-api/src/main/java/org/apache/nifi/controller/repository/FlowFileEventRepository.java\n+++ b/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-framework-core-api/src/main/java/org/apache/nifi/controller/repository/FlowFileEventRepository.java\n\n@@ -53,30 +53,8 @@ public interface FlowFileEventRepository extends Closeable {\n     void purgeTransferEvents(String componentIdentifier);\n \n     /**\n-     * Returns the total number of bytes read by this instance (at the root process group level) since the instance started\n-     *\n-     * @return the total number of bytes read by this instance\n-     */\n-    long getTotalBytesRead();\n-\n-    /**\n-     * Returns the total number of bytes written by this instance (at the root process group level) since the instance started\n-     *\n-     * @return the total number of bytes written by this instance\n-     */\n-    long getTotalBytesWritten();\n-\n-    /**\n-     * Returns the total number of bytes sent by this instance (at the root process group level) since the instance started\n-     *\n-     * @return the total number of bytes sent by this instance\n-     */\n-    long getTotalBytesSent();\n-\n-    /**\n-     * Returns the total number of bytes received by this instance (at the root process group level) since the instance started\n-     *\n-     * @return the total number of bytes received by this instance\n+     * Reports aggregate metrics for all flowfile events\n+     * @return a report of processing activity\n      */\n-    long getTotalBytesReceived();\n+    FlowFileEvent reportAggregateEvent();\n }\n"}}, {"oid": "b593bb03702c690aa753bd732b01c77017696252", "url": "https://github.com/apache/nifi/commit/b593bb03702c690aa753bd732b01c77017696252", "message": "NIFI-7796: Incorporated review comments", "committedDate": "2020-09-30T16:47:56Z", "type": "forcePushed"}, {"oid": "9d499abecffe9ae78b3b9385209f911f9f6434cf", "url": "https://github.com/apache/nifi/commit/9d499abecffe9ae78b3b9385209f911f9f6434cf", "message": "NIFI-7796: Add Prometheus metrics for total bytes sent/received, fixed read/written metrics", "committedDate": "2020-10-01T12:48:53Z", "type": "commit"}, {"oid": "fa5faa073fd33df52cadcd0fa1226e9f18e54f5b", "url": "https://github.com/apache/nifi/commit/fa5faa073fd33df52cadcd0fa1226e9f18e54f5b", "message": "NIFI-7796: Incorporated review comments", "committedDate": "2020-10-01T12:48:53Z", "type": "commit"}, {"oid": "fa5faa073fd33df52cadcd0fa1226e9f18e54f5b", "url": "https://github.com/apache/nifi/commit/fa5faa073fd33df52cadcd0fa1226e9f18e54f5b", "message": "NIFI-7796: Incorporated review comments", "committedDate": "2020-10-01T12:48:53Z", "type": "forcePushed"}]}