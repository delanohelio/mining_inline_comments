{"pr_number": 6478, "pr_title": "6965 complete aleapp module", "pr_createdAt": "2020-11-20T14:56:02Z", "pr_url": "https://github.com/sleuthkit/autopsy/pull/6478", "timeline": [{"oid": "72991feb42f8430bf4496de57077b93ba317e59c", "url": "https://github.com/sleuthkit/autopsy/commit/72991feb42f8430bf4496de57077b93ba317e59c", "message": "Rename parent Directory\n\nRename parent directory to better fit both ileapp and aleapp programs", "committedDate": "2020-10-20T18:41:54Z", "type": "commit"}, {"oid": "2eb4c80204aee6ffa66989de7e68093f2913c0f6", "url": "https://github.com/sleuthkit/autopsy/commit/2eb4c80204aee6ffa66989de7e68093f2913c0f6", "message": "Add aLeapp executable and build script\n\nAdd aleapp executable and update build script", "committedDate": "2020-10-20T18:46:13Z", "type": "commit"}, {"oid": "a0bf54dc42cd4a7a8fc3a9dc9233cefca7d837f6", "url": "https://github.com/sleuthkit/autopsy/commit/a0bf54dc42cd4a7a8fc3a9dc9233cefca7d837f6", "message": "Update aleapp.exe\n\nExecutable iwth -p option", "committedDate": "2020-10-20T19:28:24Z", "type": "commit"}, {"oid": "2ebc4046556a7e4a38ecb0eabc75205b7131a5fc", "url": "https://github.com/sleuthkit/autopsy/commit/2ebc4046556a7e4a38ecb0eabc75205b7131a5fc", "message": "Create aleap-artifact-attribute-reference.xml\n\ninitial commit of artifact-attribute cross reference xml file", "committedDate": "2020-10-20T19:28:53Z", "type": "commit"}, {"oid": "618020b275961eee97fba39f990e5c86d76bb55f", "url": "https://github.com/sleuthkit/autopsy/commit/618020b275961eee97fba39f990e5c86d76bb55f", "message": "Added aLeapp Module\n\nAdded aLeapp module", "committedDate": "2020-10-20T19:29:30Z", "type": "commit"}, {"oid": "37eacd41da632606f5f50d70bd1cddbe8fd97530", "url": "https://github.com/sleuthkit/autopsy/commit/37eacd41da632606f5f50d70bd1cddbe8fd97530", "message": "Aleap additions\n\nMaking aLeapp work the same as iLeapp", "committedDate": "2020-10-23T14:27:44Z", "type": "commit"}, {"oid": "d74d76f428224e81755ea52b0456c18402c1e2d7", "url": "https://github.com/sleuthkit/autopsy/commit/d74d76f428224e81755ea52b0456c18402c1e2d7", "message": "Update aleap-artifact-attribute-reference.xml\n\nAdd more Artifacts to process", "committedDate": "2020-11-20T14:39:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0ODAyMQ==", "url": "https://github.com/sleuthkit/autopsy/pull/6478#discussion_r528948021", "bodyText": "Missing method header", "author": "kellykelly3", "createdAt": "2020-11-23T19:34:20Z", "path": "Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java", "diffHunk": "@@ -0,0 +1,468 @@\n+/*\n+ * Autopsy Forensic Browser\n+ *\n+ * Copyright 2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.modules.leappanalyzers;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.util.List;\n+import java.util.ArrayList;\n+import java.util.Locale;\n+import java.util.logging.Level;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.commons.io.FilenameUtils;\n+import org.openide.modules.InstalledFileLocator;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.casemodule.Case;\n+import static org.sleuthkit.autopsy.casemodule.Case.getCurrentCase;\n+import org.sleuthkit.autopsy.casemodule.NoCurrentCaseException;\n+import org.sleuthkit.autopsy.casemodule.services.FileManager;\n+import org.sleuthkit.autopsy.coreutils.ExecUtil;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+import org.sleuthkit.autopsy.coreutils.PlatformUtil;\n+import org.sleuthkit.autopsy.datamodel.ContentUtils;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModule;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModuleProcessTerminator;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModuleProgress;\n+import org.sleuthkit.autopsy.ingest.IngestJobContext;\n+import org.sleuthkit.autopsy.ingest.IngestMessage;\n+import org.sleuthkit.autopsy.ingest.IngestServices;\n+import org.sleuthkit.autopsy.ingest.IngestModule.IngestModuleException;\n+import org.sleuthkit.datamodel.AbstractFile;\n+import org.sleuthkit.datamodel.Content;\n+import org.sleuthkit.datamodel.LocalFilesDataSource;\n+import org.sleuthkit.datamodel.ReadContentInputStream;\n+import org.sleuthkit.datamodel.TskCoreException;\n+\n+/**\n+ * Data source ingest module that runs aLeapp against logical iOS files.\n+ */\n+public class ALeappAnalyzerIngestModule implements DataSourceIngestModule {\n+\n+    private static final Logger logger = Logger.getLogger(ALeappAnalyzerIngestModule.class.getName());\n+    private static final String MODULE_NAME = ALeappAnalyzerModuleFactory.getModuleName();\n+\n+    private static final String ALEAPP = \"aLeapp\"; //NON-NLS\n+    private static final String ALEAPP_FS = \"fs_\"; //NON-NLS\n+    private static final String ALEAPP_EXECUTABLE = \"aleapp.exe\";//NON-NLS\n+    private static final String ALEAPP_PATHS_FILE = \"aLeapp_paths.txt\"; //NON-NLS\n+    \n+    private static final String XMLFILE = \"aleap-artifact-attribute-reference.xml\"; //NON-NLS\n+\n+\n+    private File aLeappExecutable;\n+\n+    private IngestJobContext context;\n+\n+    private LeappFileProcessor aLeappFileProcessor;\n+\n+    ALeappAnalyzerIngestModule() {\n+        // This constructor is intentionally empty. Nothing special is needed here.     \n+    }\n+\n+    @NbBundle.Messages({\n+        \"ALeappAnalyzerIngestModule.executable.not.found=aLeapp Executable Not Found.\",\n+        \"ALeappAnalyzerIngestModule.requires.windows=aLeapp module requires windows.\",\n+        \"ALeappAnalyzerIngestModule.error.ileapp.file.processor.init=Failure to initialize aLeappProcessFile\"})\n+    @Override\n+    public void startUp(IngestJobContext context) throws IngestModuleException {\n+        this.context = context;\n+\n+        if (false == PlatformUtil.isWindowsOS()) {\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_requires_windows());\n+        }\n+\n+        try {\n+            aLeappFileProcessor = new LeappFileProcessor(XMLFILE);\n+        } catch (IOException | IngestModuleException | NoCurrentCaseException ex) {\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_error_ileapp_file_processor_init(), ex);\n+        }\n+\n+        try {\n+            aLeappExecutable = locateExecutable(ALEAPP_EXECUTABLE);\n+        } catch (FileNotFoundException exception) {\n+            logger.log(Level.WARNING, \"aLeapp executable not found.\", exception); //NON-NLS\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_executable_not_found(), exception);\n+        }\n+\n+    }\n+\n+    @NbBundle.Messages({\n+        \"ALeappAnalyzerIngestModule.error.running.aLeapp=Error running aLeapp, see log file.\",\n+        \"ALeappAnalyzerIngestModule.error.creating.output.dir=Error creating aLeapp module output directory.\",\n+        \"ALeappAnalyzerIngestModule.starting.aLeapp=Starting aLeapp\",\n+        \"ALeappAnalyzerIngestModule.running.aLeapp=Running aLeapp\",\n+        \"ALeappAnalyzerIngestModule.has.run=aLeapp\",\n+        \"ALeappAnalyzerIngestModule.aLeapp.cancelled=aLeapp run was canceled\",\n+        \"ALeappAnalyzerIngestModule.completed=aLeapp Processing Completed\",\n+        \"ALeappAnalyzerIngestModule.report.name=aLeapp Html Report\"})\n+    @Override\n+    public ProcessResult process(Content dataSource, DataSourceIngestModuleProgress statusHelper) {\n+\n+        Case currentCase = Case.getCurrentCase();\n+        Path tempOutputPath = Paths.get(currentCase.getTempDirectory(), ALEAPP, ALEAPP_FS + dataSource.getId());\n+        try {\n+            Files.createDirectories(tempOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error creating aLeapp output directory %s\", tempOutputPath.toString()), ex);\n+            return ProcessResult.ERROR;\n+        }\n+\n+        List<String> aLeappPathsToProcess = new ArrayList<>();\n+        ProcessBuilder aLeappCommand = buildaLeappListCommand(tempOutputPath);\n+        try {\n+            int result = ExecUtil.execute(aLeappCommand, new DataSourceIngestModuleProcessTerminator(context, true));\n+            if (result != 0) {\n+                logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program getting file paths to search for result is %d\", result));\n+                return ProcessResult.ERROR;\n+            }\n+            aLeappPathsToProcess = loadIleappPathFile(tempOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program getting file paths to search\"), ex);\n+            return ProcessResult.ERROR;\n+        }\n+\n+        statusHelper.progress(Bundle.ALeappAnalyzerIngestModule_starting_aLeapp(), 0);\n+\n+        List<AbstractFile> aLeappFilesToProcess = new ArrayList<>();\n+\n+        if (!(context.getDataSource() instanceof LocalFilesDataSource)) {\n+            extractFilesFromImage(dataSource, aLeappPathsToProcess, tempOutputPath);\n+            statusHelper.switchToDeterminate(aLeappFilesToProcess.size());\n+            processALeappFs(dataSource, currentCase, statusHelper, tempOutputPath.toString());\n+        } else {\n+            aLeappFilesToProcess = findaLeappFilesToProcess(dataSource);\n+            statusHelper.switchToDeterminate(aLeappFilesToProcess.size());\n+\n+            Integer filesProcessedCount = 0;\n+            for (AbstractFile aLeappFile : aLeappFilesToProcess) {\n+                processALeappFile(dataSource, currentCase, statusHelper, filesProcessedCount, aLeappFile);\n+                filesProcessedCount++;\n+            }\n+            // Process the logical image as a fs in aLeapp to make sure this is not a logical fs that was added\n+            extractFilesFromImage(dataSource, aLeappPathsToProcess, tempOutputPath);\n+            processALeappFs(dataSource, currentCase, statusHelper, tempOutputPath.toString());\n+        }\n+\n+        IngestMessage message = IngestMessage.createMessage(IngestMessage.MessageType.DATA,\n+                Bundle.ALeappAnalyzerIngestModule_has_run(),\n+                Bundle.ALeappAnalyzerIngestModule_completed());\n+        IngestServices.getInstance().postMessage(message);\n+        return ProcessResult.OK;\n+    }\n+\n+    private void processALeappFile(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, int filesProcessedCount,\n+            AbstractFile aLeappFile) {\n+        String currentTime = new SimpleDateFormat(\"yyyy-MM-dd HH-mm-ss z\", Locale.US).format(System.currentTimeMillis());//NON-NLS\n+        Path moduleOutputPath = Paths.get(currentCase.getModuleDirectory(), ALEAPP, currentTime);\n+        try {\n+            Files.createDirectories(moduleOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error creating aLeapp output directory %s\", moduleOutputPath.toString()), ex);\n+            return;\n+        }\n+\n+        statusHelper.progress(NbBundle.getMessage(this.getClass(), \"ALeappAnalyzerIngestModule.processing.file\", aLeappFile.getName()), filesProcessedCount);\n+        ProcessBuilder aLeappCommand = buildaLeappCommand(moduleOutputPath, aLeappFile.getLocalAbsPath(), aLeappFile.getNameExtension());\n+        try {\n+            int result = ExecUtil.execute(aLeappCommand, new DataSourceIngestModuleProcessTerminator(context, true));\n+            if (result != 0) {\n+                logger.log(Level.WARNING, String.format(\"Error when trying to execute aLeapp program getting file paths to search for result is %d\", result));\n+                return;\n+            }\n+\n+            addILeappReportToReports(moduleOutputPath, currentCase);\n+\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program against file %s\", aLeappFile.getLocalAbsPath()), ex);\n+            return;\n+        }\n+\n+        if (context.dataSourceIngestIsCancelled()) {\n+            logger.log(Level.INFO, \"ILeapp Analyser ingest module run was canceled\"); //NON-NLS\n+            return;\n+        }\n+\n+        ProcessResult fileProcessorResult = aLeappFileProcessor.processFiles(dataSource, moduleOutputPath, aLeappFile);\n+\n+        if (fileProcessorResult == ProcessResult.ERROR) {\n+            return;\n+        }\n+    }\n+\n+    private void processALeappFs(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, String directoryToProcess) {", "originalCommit": "d74d76f428224e81755ea52b0456c18402c1e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNjIyMg==", "url": "https://github.com/sleuthkit/autopsy/pull/6478#discussion_r535506222", "bodyText": "Added comments.", "author": "markmckinnon", "createdAt": "2020-12-03T19:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0ODAyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c50d86edf89b9731b40ced12bfd287a4f389bece", "chunk": "diff --git a/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java b/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\nindex 225d18c437..e82215a7de 100644\n--- a/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\n+++ b/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\n\n@@ -175,6 +175,14 @@ public ProcessResult process(Content dataSource, DataSourceIngestModuleProgress\n         return ProcessResult.OK;\n     }\n \n+    /**\n+     * Process a file from a logical image using the aLeapp program\n+     * @param dataSource datasource to process\n+     * @param currentCase current case that is being worked on\n+     * @param statusHelper show progress and update what is being processed\n+     * @param filesProcessedCount number of files that have been processed\n+     * @param aLeappFile the abstract file to process\n+     */\n     private void processALeappFile(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, int filesProcessedCount,\n             AbstractFile aLeappFile) {\n         String currentTime = new SimpleDateFormat(\"yyyy-MM-dd HH-mm-ss z\", Locale.US).format(System.currentTimeMillis());//NON-NLS\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0ODIxNw==", "url": "https://github.com/sleuthkit/autopsy/pull/6478#discussion_r528948217", "bodyText": "Missing method header", "author": "kellykelly3", "createdAt": "2020-11-23T19:34:39Z", "path": "Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java", "diffHunk": "@@ -0,0 +1,468 @@\n+/*\n+ * Autopsy Forensic Browser\n+ *\n+ * Copyright 2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.modules.leappanalyzers;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.text.SimpleDateFormat;\n+import java.util.List;\n+import java.util.ArrayList;\n+import java.util.Locale;\n+import java.util.logging.Level;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.commons.io.FilenameUtils;\n+import org.openide.modules.InstalledFileLocator;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.casemodule.Case;\n+import static org.sleuthkit.autopsy.casemodule.Case.getCurrentCase;\n+import org.sleuthkit.autopsy.casemodule.NoCurrentCaseException;\n+import org.sleuthkit.autopsy.casemodule.services.FileManager;\n+import org.sleuthkit.autopsy.coreutils.ExecUtil;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+import org.sleuthkit.autopsy.coreutils.PlatformUtil;\n+import org.sleuthkit.autopsy.datamodel.ContentUtils;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModule;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModuleProcessTerminator;\n+import org.sleuthkit.autopsy.ingest.DataSourceIngestModuleProgress;\n+import org.sleuthkit.autopsy.ingest.IngestJobContext;\n+import org.sleuthkit.autopsy.ingest.IngestMessage;\n+import org.sleuthkit.autopsy.ingest.IngestServices;\n+import org.sleuthkit.autopsy.ingest.IngestModule.IngestModuleException;\n+import org.sleuthkit.datamodel.AbstractFile;\n+import org.sleuthkit.datamodel.Content;\n+import org.sleuthkit.datamodel.LocalFilesDataSource;\n+import org.sleuthkit.datamodel.ReadContentInputStream;\n+import org.sleuthkit.datamodel.TskCoreException;\n+\n+/**\n+ * Data source ingest module that runs aLeapp against logical iOS files.\n+ */\n+public class ALeappAnalyzerIngestModule implements DataSourceIngestModule {\n+\n+    private static final Logger logger = Logger.getLogger(ALeappAnalyzerIngestModule.class.getName());\n+    private static final String MODULE_NAME = ALeappAnalyzerModuleFactory.getModuleName();\n+\n+    private static final String ALEAPP = \"aLeapp\"; //NON-NLS\n+    private static final String ALEAPP_FS = \"fs_\"; //NON-NLS\n+    private static final String ALEAPP_EXECUTABLE = \"aleapp.exe\";//NON-NLS\n+    private static final String ALEAPP_PATHS_FILE = \"aLeapp_paths.txt\"; //NON-NLS\n+    \n+    private static final String XMLFILE = \"aleap-artifact-attribute-reference.xml\"; //NON-NLS\n+\n+\n+    private File aLeappExecutable;\n+\n+    private IngestJobContext context;\n+\n+    private LeappFileProcessor aLeappFileProcessor;\n+\n+    ALeappAnalyzerIngestModule() {\n+        // This constructor is intentionally empty. Nothing special is needed here.     \n+    }\n+\n+    @NbBundle.Messages({\n+        \"ALeappAnalyzerIngestModule.executable.not.found=aLeapp Executable Not Found.\",\n+        \"ALeappAnalyzerIngestModule.requires.windows=aLeapp module requires windows.\",\n+        \"ALeappAnalyzerIngestModule.error.ileapp.file.processor.init=Failure to initialize aLeappProcessFile\"})\n+    @Override\n+    public void startUp(IngestJobContext context) throws IngestModuleException {\n+        this.context = context;\n+\n+        if (false == PlatformUtil.isWindowsOS()) {\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_requires_windows());\n+        }\n+\n+        try {\n+            aLeappFileProcessor = new LeappFileProcessor(XMLFILE);\n+        } catch (IOException | IngestModuleException | NoCurrentCaseException ex) {\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_error_ileapp_file_processor_init(), ex);\n+        }\n+\n+        try {\n+            aLeappExecutable = locateExecutable(ALEAPP_EXECUTABLE);\n+        } catch (FileNotFoundException exception) {\n+            logger.log(Level.WARNING, \"aLeapp executable not found.\", exception); //NON-NLS\n+            throw new IngestModuleException(Bundle.ALeappAnalyzerIngestModule_executable_not_found(), exception);\n+        }\n+\n+    }\n+\n+    @NbBundle.Messages({\n+        \"ALeappAnalyzerIngestModule.error.running.aLeapp=Error running aLeapp, see log file.\",\n+        \"ALeappAnalyzerIngestModule.error.creating.output.dir=Error creating aLeapp module output directory.\",\n+        \"ALeappAnalyzerIngestModule.starting.aLeapp=Starting aLeapp\",\n+        \"ALeappAnalyzerIngestModule.running.aLeapp=Running aLeapp\",\n+        \"ALeappAnalyzerIngestModule.has.run=aLeapp\",\n+        \"ALeappAnalyzerIngestModule.aLeapp.cancelled=aLeapp run was canceled\",\n+        \"ALeappAnalyzerIngestModule.completed=aLeapp Processing Completed\",\n+        \"ALeappAnalyzerIngestModule.report.name=aLeapp Html Report\"})\n+    @Override\n+    public ProcessResult process(Content dataSource, DataSourceIngestModuleProgress statusHelper) {\n+\n+        Case currentCase = Case.getCurrentCase();\n+        Path tempOutputPath = Paths.get(currentCase.getTempDirectory(), ALEAPP, ALEAPP_FS + dataSource.getId());\n+        try {\n+            Files.createDirectories(tempOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error creating aLeapp output directory %s\", tempOutputPath.toString()), ex);\n+            return ProcessResult.ERROR;\n+        }\n+\n+        List<String> aLeappPathsToProcess = new ArrayList<>();\n+        ProcessBuilder aLeappCommand = buildaLeappListCommand(tempOutputPath);\n+        try {\n+            int result = ExecUtil.execute(aLeappCommand, new DataSourceIngestModuleProcessTerminator(context, true));\n+            if (result != 0) {\n+                logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program getting file paths to search for result is %d\", result));\n+                return ProcessResult.ERROR;\n+            }\n+            aLeappPathsToProcess = loadIleappPathFile(tempOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program getting file paths to search\"), ex);\n+            return ProcessResult.ERROR;\n+        }\n+\n+        statusHelper.progress(Bundle.ALeappAnalyzerIngestModule_starting_aLeapp(), 0);\n+\n+        List<AbstractFile> aLeappFilesToProcess = new ArrayList<>();\n+\n+        if (!(context.getDataSource() instanceof LocalFilesDataSource)) {\n+            extractFilesFromImage(dataSource, aLeappPathsToProcess, tempOutputPath);\n+            statusHelper.switchToDeterminate(aLeappFilesToProcess.size());\n+            processALeappFs(dataSource, currentCase, statusHelper, tempOutputPath.toString());\n+        } else {\n+            aLeappFilesToProcess = findaLeappFilesToProcess(dataSource);\n+            statusHelper.switchToDeterminate(aLeappFilesToProcess.size());\n+\n+            Integer filesProcessedCount = 0;\n+            for (AbstractFile aLeappFile : aLeappFilesToProcess) {\n+                processALeappFile(dataSource, currentCase, statusHelper, filesProcessedCount, aLeappFile);\n+                filesProcessedCount++;\n+            }\n+            // Process the logical image as a fs in aLeapp to make sure this is not a logical fs that was added\n+            extractFilesFromImage(dataSource, aLeappPathsToProcess, tempOutputPath);\n+            processALeappFs(dataSource, currentCase, statusHelper, tempOutputPath.toString());\n+        }\n+\n+        IngestMessage message = IngestMessage.createMessage(IngestMessage.MessageType.DATA,\n+                Bundle.ALeappAnalyzerIngestModule_has_run(),\n+                Bundle.ALeappAnalyzerIngestModule_completed());\n+        IngestServices.getInstance().postMessage(message);\n+        return ProcessResult.OK;\n+    }\n+\n+    private void processALeappFile(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, int filesProcessedCount,\n+            AbstractFile aLeappFile) {\n+        String currentTime = new SimpleDateFormat(\"yyyy-MM-dd HH-mm-ss z\", Locale.US).format(System.currentTimeMillis());//NON-NLS\n+        Path moduleOutputPath = Paths.get(currentCase.getModuleDirectory(), ALEAPP, currentTime);\n+        try {\n+            Files.createDirectories(moduleOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error creating aLeapp output directory %s\", moduleOutputPath.toString()), ex);\n+            return;\n+        }\n+\n+        statusHelper.progress(NbBundle.getMessage(this.getClass(), \"ALeappAnalyzerIngestModule.processing.file\", aLeappFile.getName()), filesProcessedCount);\n+        ProcessBuilder aLeappCommand = buildaLeappCommand(moduleOutputPath, aLeappFile.getLocalAbsPath(), aLeappFile.getNameExtension());\n+        try {\n+            int result = ExecUtil.execute(aLeappCommand, new DataSourceIngestModuleProcessTerminator(context, true));\n+            if (result != 0) {\n+                logger.log(Level.WARNING, String.format(\"Error when trying to execute aLeapp program getting file paths to search for result is %d\", result));\n+                return;\n+            }\n+\n+            addILeappReportToReports(moduleOutputPath, currentCase);\n+\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program against file %s\", aLeappFile.getLocalAbsPath()), ex);\n+            return;\n+        }\n+\n+        if (context.dataSourceIngestIsCancelled()) {\n+            logger.log(Level.INFO, \"ILeapp Analyser ingest module run was canceled\"); //NON-NLS\n+            return;\n+        }\n+\n+        ProcessResult fileProcessorResult = aLeappFileProcessor.processFiles(dataSource, moduleOutputPath, aLeappFile);\n+\n+        if (fileProcessorResult == ProcessResult.ERROR) {\n+            return;\n+        }\n+    }\n+\n+    private void processALeappFs(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, String directoryToProcess) {\n+        String currentTime = new SimpleDateFormat(\"yyyy-MM-dd HH-mm-ss z\", Locale.US).format(System.currentTimeMillis());//NON-NLS\n+        Path moduleOutputPath = Paths.get(currentCase.getModuleDirectory(), ALEAPP, currentTime);\n+        try {\n+            Files.createDirectories(moduleOutputPath);\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error creating aLeapp output directory %s\", moduleOutputPath.toString()), ex);\n+            return;\n+        }\n+\n+        statusHelper.progress(NbBundle.getMessage(this.getClass(), \"ALeappAnalyzerIngestModule.processing.filesystem\"));\n+        ProcessBuilder aLeappCommand = buildaLeappCommand(moduleOutputPath, directoryToProcess, \"fs\");\n+        try {\n+            int result = ExecUtil.execute(aLeappCommand, new DataSourceIngestModuleProcessTerminator(context, true));\n+            if (result != 0) {\n+                logger.log(Level.WARNING, String.format(\"Error when trying to execute aLeapp program getting file paths to search for result is %d\", result));\n+                return;\n+            }\n+\n+            addILeappReportToReports(moduleOutputPath, currentCase);\n+\n+        } catch (IOException ex) {\n+            logger.log(Level.SEVERE, String.format(\"Error when trying to execute aLeapp program against file system\"), ex);\n+            return;\n+        }\n+\n+        if (context.dataSourceIngestIsCancelled()) {\n+            logger.log(Level.INFO, \"ILeapp Analyser ingest module run was canceled\"); //NON-NLS\n+            return;\n+        }\n+\n+        ProcessResult fileProcessorResult = aLeappFileProcessor.processFileSystem(dataSource, moduleOutputPath);\n+\n+        if (fileProcessorResult == ProcessResult.ERROR) {\n+            return;\n+        }\n+\n+    }\n+\n+    /**\n+     * Find the files that will be processed by the aLeapp program\n+     *\n+     * @param dataSource\n+     *\n+     * @return List of abstract files to process.\n+     */\n+    private List<AbstractFile> findaLeappFilesToProcess(Content dataSource) {\n+\n+        List<AbstractFile> aLeappFiles = new ArrayList<>();\n+\n+        FileManager fileManager = getCurrentCase().getServices().getFileManager();\n+\n+        // findFiles use the SQL wildcard % in the file name\n+        try {\n+            aLeappFiles = fileManager.findFiles(dataSource, \"%\", \"/\"); //NON-NLS\n+        } catch (TskCoreException ex) {\n+            logger.log(Level.WARNING, \"No files found to process\"); //NON-NLS\n+            return aLeappFiles;\n+        }\n+\n+        List<AbstractFile> aLeappFilesToProcess = new ArrayList<>();\n+        for (AbstractFile aLeappFile : aLeappFiles) {\n+            if (((aLeappFile.getLocalAbsPath() != null)\n+                    && (!aLeappFile.getNameExtension().isEmpty() && (!aLeappFile.isVirtual())))\n+                    && ((aLeappFile.getName().toLowerCase().contains(\".zip\") || (aLeappFile.getName().toLowerCase().contains(\".tar\")))\n+                    || aLeappFile.getName().toLowerCase().contains(\".tgz\"))) {\n+                aLeappFilesToProcess.add(aLeappFile);\n+\n+            }\n+        }\n+\n+        return aLeappFilesToProcess;\n+    }\n+\n+    private ProcessBuilder buildaLeappCommand(Path moduleOutputPath, String sourceFilePath, String aLeappFileSystemType) {", "originalCommit": "d74d76f428224e81755ea52b0456c18402c1e2d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNjM2OQ==", "url": "https://github.com/sleuthkit/autopsy/pull/6478#discussion_r535506369", "bodyText": "Added comments", "author": "markmckinnon", "createdAt": "2020-12-03T19:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0ODIxNw=="}], "type": "inlineReview", "revised_code": {"commit": "c50d86edf89b9731b40ced12bfd287a4f389bece", "chunk": "diff --git a/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java b/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\nindex 225d18c437..e82215a7de 100644\n--- a/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\n+++ b/Core/src/org/sleuthkit/autopsy/modules/leappanalyzers/ALeappAnalyzerIngestModule.java\n\n@@ -175,6 +175,14 @@ public ProcessResult process(Content dataSource, DataSourceIngestModuleProgress\n         return ProcessResult.OK;\n     }\n \n+    /**\n+     * Process a file from a logical image using the aLeapp program\n+     * @param dataSource datasource to process\n+     * @param currentCase current case that is being worked on\n+     * @param statusHelper show progress and update what is being processed\n+     * @param filesProcessedCount number of files that have been processed\n+     * @param aLeappFile the abstract file to process\n+     */\n     private void processALeappFile(Content dataSource, Case currentCase, DataSourceIngestModuleProgress statusHelper, int filesProcessedCount,\n             AbstractFile aLeappFile) {\n         String currentTime = new SimpleDateFormat(\"yyyy-MM-dd HH-mm-ss z\", Locale.US).format(System.currentTimeMillis());//NON-NLS\n"}}, {"oid": "c50d86edf89b9731b40ced12bfd287a4f389bece", "url": "https://github.com/sleuthkit/autopsy/commit/c50d86edf89b9731b40ced12bfd287a4f389bece", "message": "Update ALeappAnalyzerIngestModule.java\n\nAddress comments", "committedDate": "2020-12-03T19:07:47Z", "type": "commit"}, {"oid": "ffd2e1e719672a5bcc4d5850423fabb922781c5b", "url": "https://github.com/sleuthkit/autopsy/commit/ffd2e1e719672a5bcc4d5850423fabb922781c5b", "message": "Merge remote-tracking branch 'upstream/develop' into 6965-Complete-aLeapp-Module", "committedDate": "2020-12-03T19:11:48Z", "type": "commit"}]}