{"pr_number": 5954, "pr_title": "6390 Persona account search in Persona Manager", "pr_createdAt": "2020-06-08T22:25:48Z", "pr_url": "https://github.com/sleuthkit/autopsy/pull/5954", "timeline": [{"oid": "c8e60d55fa0dc6ef50428a8a0e24b8a106f7ec59", "url": "https://github.com/sleuthkit/autopsy/commit/c8e60d55fa0dc6ef50428a8a0e24b8a106f7ec59", "message": "6390 persona searching by account", "committedDate": "2020-06-08T22:24:55Z", "type": "commit"}, {"oid": "877a07667d6e91e9a8a1cb6f3d0f31d0119949f6", "url": "https://github.com/sleuthkit/autopsy/commit/877a07667d6e91e9a8a1cb6f3d0f31d0119949f6", "message": "6390 PR comment", "committedDate": "2020-06-08T22:55:58Z", "type": "commit"}, {"oid": "8b01f3b86b6c9c5eacc090c5982cf73c11e97cfe", "url": "https://github.com/sleuthkit/autopsy/commit/8b01f3b86b6c9c5eacc090c5982cf73c11e97cfe", "message": "6390 remove setPersonaName", "committedDate": "2020-06-09T14:30:53Z", "type": "commit"}, {"oid": "d84b8f47f855128d721077d473a1fab9b551e344", "url": "https://github.com/sleuthkit/autopsy/commit/d84b8f47f855128d721077d473a1fab9b551e344", "message": "Merge branch 'develop' into 6390_persona_search_account", "committedDate": "2020-06-09T18:46:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzgwNTkzMA==", "url": "https://github.com/sleuthkit/autopsy/pull/5954#discussion_r437805930", "bodyText": "There's a re-declaration error here, that got fixed on the parent branch. That needs to get merged in here.", "author": "raman-bt", "createdAt": "2020-06-10T01:14:14Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java", "diffHunk": "@@ -275,6 +275,9 @@ public void process(ResultSet rs) throws CentralRepoException, SQLException {\n      *                              persona_account.\n      */\n     public static Collection<PersonaAccount> getPersonaAccountsForAccount(long accountId) throws CentralRepoException {\n+        String queryClause = PERSONA_ACCOUNTS_QUERY_CALUSE\n+                + \" WHERE persona_accounts.account_id = \" + accountId\n+                + \"AND p.status_id != \" + Persona.PersonaStatus.DELETED.getStatusId();", "originalCommit": "d84b8f47f855128d721077d473a1fab9b551e344", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4bf048b1eaa742032fe424c39d87e0a5e188ffaa", "chunk": "diff --git a/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java b/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java\nindex d652708b18..d0322ddbca 100644\n--- a/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java\n+++ b/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/PersonaAccount.java\n\n@@ -282,9 +282,6 @@ public void process(ResultSet rs) throws CentralRepoException, SQLException {\n         CentralRepository cr = CentralRepository.getInstance();\n \n         if (cr != null) {\n-            String queryClause = PERSONA_ACCOUNTS_QUERY_CALUSE\n-                    + \" WHERE persona_accounts.account_id = \" + accountId;\n-\n             PersonaAccountsQueryCallback queryCallback = new PersonaAccountsQueryCallback();\n             cr.executeSelectSQL(queryClause, queryCallback);\n \n"}}, {"oid": "4bf048b1eaa742032fe424c39d87e0a5e188ffaa", "url": "https://github.com/sleuthkit/autopsy/commit/4bf048b1eaa742032fe424c39d87e0a5e188ffaa", "message": "6390 Fix merge", "committedDate": "2020-06-10T17:31:42Z", "type": "commit"}, {"oid": "4e73decf2407f63524940f0f68e35187734b4883", "url": "https://github.com/sleuthkit/autopsy/commit/4e73decf2407f63524940f0f68e35187734b4883", "message": "Merge remote-tracking branch 'sleuthkit/develop' into 6390_persona_search_account", "committedDate": "2020-06-10T17:32:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3NzAyOQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5954#discussion_r438877029", "bodyText": "check CentralRepository.getInstance() for  null", "author": "raman-bt", "createdAt": "2020-06-11T15:34:42Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -394,6 +394,34 @@ private static Persona getPersonaByUUID(String uuid) throws CentralRepoException\n         return queryCallback.getPersonas();\n     }\n     \n+    /**\n+     * Gets the rows from the Personas table where persona accounts' names are\n+     * similar to the given one. Persona marked as DELETED are not returned.\n+     *\n+     * @param partialName Name substring to match.\n+     * @return Collection of personas matching the given name substring, may be\n+     * empty if no match is found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Collection<Persona> getPersonaByAccountIdentifierLike(String partialName) throws CentralRepoException {\n+        String queryClause = \"SELECT DISTINCT accounts.id as a_id,\"\n+                + \"p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name\"\n+                + \" FROM accounts\"\n+                + \" JOIN persona_accounts as pa ON pa.account_id = accounts.id\"\n+                + \" JOIN personas as p ON p.id = pa.persona_id\"\n+                + \" JOIN examiners as e ON e.id = p.examiner_id\"\n+                + \" WHERE LOWER(accounts.account_unique_identifier) LIKE LOWER('%\" + partialName + \"%')\"\n+                + \" AND p.status_id != \" + Persona.PersonaStatus.DELETED.getStatusId()\n+                + \" GROUP BY p.id\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);", "originalCommit": "4e73decf2407f63524940f0f68e35187734b4883", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07319d764c4170b4e820dd44f4a221ffa6dd0e70", "chunk": "diff --git a/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java b/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java\nindex b0184e2991..52c7aef2d8 100644\n--- a/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java\n+++ b/Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java\n\n@@ -417,7 +417,10 @@ private static Persona getPersonaByUUID(String uuid) throws CentralRepoException\n                 + \" GROUP BY p.id\";\n \n         PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n-        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+        CentralRepository cr = CentralRepository.getInstance();\n+        if (cr != null) {\n+            cr.executeSelectSQL(queryClause, queryCallback);\n+        }\n \n         return queryCallback.getPersonas();\n     }\n"}}, {"oid": "07319d764c4170b4e820dd44f4a221ffa6dd0e70", "url": "https://github.com/sleuthkit/autopsy/commit/07319d764c4170b4e820dd44f4a221ffa6dd0e70", "message": "6390 PR suggestion", "committedDate": "2020-06-11T17:33:17Z", "type": "commit"}]}