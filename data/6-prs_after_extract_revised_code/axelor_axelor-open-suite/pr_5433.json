{"pr_number": 5433, "pr_title": "RM28107: Fix timesheet editor still being displayed with a disabled c\u2026", "pr_createdAt": "2020-05-13T08:20:20Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/5433", "timeline": [{"oid": "69d387285c0be9a1c6f8c9121a38ce39037dd08f", "url": "https://github.com/axelor/axelor-open-suite/commit/69d387285c0be9a1c6f8c9121a38ce39037dd08f", "message": "RM28107: Fix timesheet editor still being displayed with a disabled config", "committedDate": "2020-06-29T12:33:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMDYxOQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5433#discussion_r452810619", "bodyText": "Add an order by on the query. Currently this randomly will not update all timesheets.", "author": "ale-axelor", "createdAt": "2020-07-10T12:25:57Z", "path": "axelor-human-resource/src/main/java/com/axelor/apps/hr/service/app/AppTimesheetServiceImpl.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.axelor.apps.hr.service.app;\n+\n+import com.axelor.apps.base.service.administration.AbstractBatch;\n+import com.axelor.apps.hr.db.Timesheet;\n+import com.axelor.apps.hr.db.repo.TimesheetRepository;\n+import com.axelor.db.JPA;\n+import com.axelor.db.Query;\n+import com.google.inject.Inject;\n+import com.google.inject.persist.Transactional;\n+\n+import java.util.List;\n+\n+public class AppTimesheetServiceImpl implements AppTimesheetService {\n+    protected TimesheetRepository timesheetRepo;\n+\n+    @Inject\n+    public AppTimesheetServiceImpl(TimesheetRepository timesheetRepo) {\n+        this.timesheetRepo = timesheetRepo;\n+    }\n+\n+    @Override\n+    @Transactional(rollbackOn = {Exception.class})\n+    public void switchTimesheetEditors(Boolean state) {\n+        List<Timesheet> timesheets;\n+        Query<Timesheet> query = timesheetRepo.all();", "originalCommit": "98ad9b1e272c973ef6e07a765e2f716a3216252a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "chunk": "diff --git a/axelor-human-resource/src/main/java/com/axelor/apps/hr/service/app/AppTimesheetServiceImpl.java b/axelor-human-resource/src/main/java/com/axelor/apps/hr/service/app/AppTimesheetServiceImpl.java\nindex 51948c8853..85e711ebc9 100644\n--- a/axelor-human-resource/src/main/java/com/axelor/apps/hr/service/app/AppTimesheetServiceImpl.java\n+++ b/axelor-human-resource/src/main/java/com/axelor/apps/hr/service/app/AppTimesheetServiceImpl.java\n\n@@ -7,32 +7,31 @@ import com.axelor.db.JPA;\n import com.axelor.db.Query;\n import com.google.inject.Inject;\n import com.google.inject.persist.Transactional;\n-\n import java.util.List;\n \n public class AppTimesheetServiceImpl implements AppTimesheetService {\n-    protected TimesheetRepository timesheetRepo;\n+  protected TimesheetRepository timesheetRepo;\n \n-    @Inject\n-    public AppTimesheetServiceImpl(TimesheetRepository timesheetRepo) {\n-        this.timesheetRepo = timesheetRepo;\n-    }\n+  @Inject\n+  public AppTimesheetServiceImpl(TimesheetRepository timesheetRepo) {\n+    this.timesheetRepo = timesheetRepo;\n+  }\n \n-    @Override\n-    @Transactional(rollbackOn = {Exception.class})\n-    public void switchTimesheetEditors(Boolean state) {\n-        List<Timesheet> timesheets;\n-        Query<Timesheet> query = timesheetRepo.all();\n-        int offset = 0;\n-        while (!(timesheets = query.fetch(AbstractBatch.FETCH_LIMIT, offset)).isEmpty()) {\n-            for (Timesheet timesheet: timesheets) {\n-                offset++;\n-                if (timesheet.getShowEditor() != state) {\n-                    timesheet.setShowEditor(state);\n-                    timesheetRepo.save(timesheet);\n-                }\n-            }\n-            JPA.clear();\n+  @Override\n+  @Transactional(rollbackOn = {Exception.class})\n+  public void switchTimesheetEditors(Boolean state) {\n+    List<Timesheet> timesheets;\n+    Query<Timesheet> query = timesheetRepo.all().order(\"id\");\n+    int offset = 0;\n+    while (!(timesheets = query.fetch(AbstractBatch.FETCH_LIMIT, offset)).isEmpty()) {\n+      for (Timesheet timesheet : timesheets) {\n+        offset++;\n+        if (timesheet.getShowEditor() != state) {\n+          timesheet.setShowEditor(state);\n+          timesheetRepo.save(timesheet);\n         }\n+      }\n+      JPA.clear();\n     }\n+  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTgxNQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5433#discussion_r452811815", "bodyText": "This must be in a try catch block\ntry { \n//\n} catch(Exception e) { \n  TraceBackService.trace(response, e);\n}", "author": "ale-axelor", "createdAt": "2020-07-10T12:28:41Z", "path": "axelor-human-resource/src/main/java/com/axelor/apps/hr/web/AppTimesheetController.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package com.axelor.apps.hr.web;\n+\n+import com.axelor.apps.base.db.AppTimesheet;\n+import com.axelor.apps.hr.service.app.AppTimesheetService;\n+import com.axelor.inject.Beans;\n+import com.axelor.rpc.ActionRequest;\n+import com.axelor.rpc.ActionResponse;\n+\n+public class AppTimesheetController {\n+    public void switchTimesheetEditors(ActionRequest request, ActionResponse response) {\n+        AppTimesheet appTimesheet = request.getContext().asType(AppTimesheet.class);\n+        Beans.get(AppTimesheetService.class).switchTimesheetEditors(appTimesheet.getTimesheetEditor());", "originalCommit": "98ad9b1e272c973ef6e07a765e2f716a3216252a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "chunk": "diff --git a/axelor-human-resource/src/main/java/com/axelor/apps/hr/web/AppTimesheetController.java b/axelor-human-resource/src/main/java/com/axelor/apps/hr/web/AppTimesheetController.java\nindex 49f26044f3..74e90125e8 100644\n--- a/axelor-human-resource/src/main/java/com/axelor/apps/hr/web/AppTimesheetController.java\n+++ b/axelor-human-resource/src/main/java/com/axelor/apps/hr/web/AppTimesheetController.java\n\n@@ -7,8 +7,13 @@ import com.axelor.rpc.ActionRequest;\n import com.axelor.rpc.ActionResponse;\n \n public class AppTimesheetController {\n-    public void switchTimesheetEditors(ActionRequest request, ActionResponse response) {\n-        AppTimesheet appTimesheet = request.getContext().asType(AppTimesheet.class);\n-        Beans.get(AppTimesheetService.class).switchTimesheetEditors(appTimesheet.getTimesheetEditor());\n+  public void switchTimesheetEditors(ActionRequest request, ActionResponse response) {\n+    try {\n+      AppTimesheet appTimesheet = request.getContext().asType(AppTimesheet.class);\n+      Beans.get(AppTimesheetService.class)\n+          .switchTimesheetEditors(appTimesheet.getTimesheetEditor());\n+    } catch (Exception e) {\n+      TraceBackService.trace(response, e);\n     }\n+  }\n }\n"}}, {"oid": "b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "url": "https://github.com/axelor/axelor-open-suite/commit/b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "message": "RM28107: Fix timesheet editor still being displayed with a disabled config", "committedDate": "2020-07-10T13:06:27Z", "type": "commit"}, {"oid": "b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "url": "https://github.com/axelor/axelor-open-suite/commit/b6bf928ffbe705e6d7ae9ad1315736c9730ac05c", "message": "RM28107: Fix timesheet editor still being displayed with a disabled config", "committedDate": "2020-07-10T13:06:27Z", "type": "forcePushed"}, {"oid": "81cb9b394fb780adb93fbf77df0595678274757f", "url": "https://github.com/axelor/axelor-open-suite/commit/81cb9b394fb780adb93fbf77df0595678274757f", "message": "Merge branch 'dev' into dev-28107", "committedDate": "2020-07-10T13:14:05Z", "type": "commit"}, {"oid": "bff8fa2899653226c143011d7128bea880f92093", "url": "https://github.com/axelor/axelor-open-suite/commit/bff8fa2899653226c143011d7128bea880f92093", "message": "Update CHANGELOG.md", "committedDate": "2020-07-10T14:02:47Z", "type": "commit"}, {"oid": "692b56b6ddde2fee12f45a544906f396c54b63ff", "url": "https://github.com/axelor/axelor-open-suite/commit/692b56b6ddde2fee12f45a544906f396c54b63ff", "message": "Merge branch 'dev' into dev-28107", "committedDate": "2020-07-16T09:00:39Z", "type": "commit"}]}