{"pr_number": 5416, "pr_title": "Feature #17220: Pack / SaleOrder", "pr_createdAt": "2020-05-07T06:16:11Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/5416", "timeline": [{"oid": "a3af2a3aba0a1c04e6cce4b84443f83606ce9df9", "url": "https://github.com/axelor/axelor-open-suite/commit/a3af2a3aba0a1c04e6cce4b84443f83606ce9df9", "message": "Feature #17220: Pack / SaleOrder", "committedDate": "2020-05-07T12:31:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxMjkzOA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5416#discussion_r421512938", "bodyText": "Avoid use of injection inside loop", "author": "vbh-axelor", "createdAt": "2020-05-07T13:42:01Z", "path": "axelor-sale/src/main/java/com/axelor/apps/sale/service/saleorder/SaleOrderComputeServiceImpl.java", "diffHunk": "@@ -197,20 +199,26 @@ public void computePackTotal(SaleOrder saleOrder) {\n       boolean isShowTotal = false;\n       boolean isFirstTitleLine = true;\n       for (SaleOrderLine saleOrderLine : saleOrderLineList) {\n-        if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_TITLE) {\n-          if (isFirstTitleLine) {\n-            isFirstTitleLine = false;\n-            isShowTotal = saleOrderLine.getIsShowTotal();\n+        if (Boolean.TRUE.equals(\n+            Beans.get(AppSaleService.class).getAppSale().getEnablePackManagement())) {", "originalCommit": "a3af2a3aba0a1c04e6cce4b84443f83606ce9df9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24910f5faf9a887d3cb8adf6530032455f064e82", "chunk": "diff --git a/axelor-sale/src/main/java/com/axelor/apps/sale/service/saleorder/SaleOrderComputeServiceImpl.java b/axelor-sale/src/main/java/com/axelor/apps/sale/service/saleorder/SaleOrderComputeServiceImpl.java\nindex c6ae2f7949..5b1e342e36 100644\n--- a/axelor-sale/src/main/java/com/axelor/apps/sale/service/saleorder/SaleOrderComputeServiceImpl.java\n+++ b/axelor-sale/src/main/java/com/axelor/apps/sale/service/saleorder/SaleOrderComputeServiceImpl.java\n\n@@ -199,29 +197,35 @@ public class SaleOrderComputeServiceImpl implements SaleOrderComputeService {\n       boolean isShowTotal = false;\n       boolean isFirstTitleLine = true;\n       for (SaleOrderLine saleOrderLine : saleOrderLineList) {\n-        if (Boolean.TRUE.equals(\n-            Beans.get(AppSaleService.class).getAppSale().getEnablePackManagement())) {\n-          if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_TITLE) {\n-            if (isFirstTitleLine) {\n-              isFirstTitleLine = false;\n-              isShowTotal = saleOrderLine.getIsShowTotal();\n-            } else {\n-              isFirstTitleLine = true;\n-              saleOrderLine.setQty(BigDecimal.ZERO);\n-            }\n-            saleOrderLine.setExTaxTotal(\n-                isFirstTitleLine && isShowTotal ? totalAmount : BigDecimal.ZERO);\n-            totalAmount = BigDecimal.ZERO;\n+        if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_TITLE) {\n+          if (isFirstTitleLine) {\n+            isFirstTitleLine = false;\n+            isShowTotal = saleOrderLine.getIsShowTotal();\n           } else {\n-            totalAmount = totalAmount.add(saleOrderLine.getExTaxTotal());\n+            isFirstTitleLine = true;\n+            saleOrderLine.setQty(BigDecimal.ZERO);\n           }\n-        } else if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_TITLE) {\n-          saleOrderLine.setIsHideUnitAmounts(Boolean.FALSE);\n-          saleOrderLine.setIsShowTotal(Boolean.FALSE);\n-          saleOrderLine.setExTaxTotal(totalAmount);\n+          saleOrderLine.setExTaxTotal(\n+              isFirstTitleLine && isShowTotal ? totalAmount : BigDecimal.ZERO);\n+          totalAmount = BigDecimal.ZERO;\n+        }\n+        if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_NORMAL) {\n+          totalAmount = totalAmount.add(saleOrderLine.getExTaxTotal());\n         }\n       }\n     }\n     saleOrder.setSaleOrderLineList(saleOrderLineList);\n   }\n+\n+  @Override\n+  public void resetPackTotal(SaleOrder saleOrder) {\n+    List<SaleOrderLine> saleOrderLineList = saleOrder.getSaleOrderLineList();\n+    for (SaleOrderLine saleOrderLine : saleOrderLineList) {\n+      if (saleOrderLine.getTypeSelect() == SaleOrderLineRepository.TYPE_TITLE) {\n+        saleOrderLine.setIsHideUnitAmounts(Boolean.FALSE);\n+        saleOrderLine.setIsShowTotal(Boolean.FALSE);\n+        saleOrderLine.setExTaxTotal(BigDecimal.ZERO);\n+      }\n+    }\n+  }\n }\n"}}, {"oid": "24910f5faf9a887d3cb8adf6530032455f064e82", "url": "https://github.com/axelor/axelor-open-suite/commit/24910f5faf9a887d3cb8adf6530032455f064e82", "message": "Feature #17220: Pack / SaleOrder", "committedDate": "2020-05-08T05:46:59Z", "type": "forcePushed"}, {"oid": "5d161ce336ac5255d8674c7d811710781e68f32a", "url": "https://github.com/axelor/axelor-open-suite/commit/5d161ce336ac5255d8674c7d811710781e68f32a", "message": "Feature #17220: Pack / SaleOrder", "committedDate": "2020-05-08T12:38:25Z", "type": "commit"}, {"oid": "5d161ce336ac5255d8674c7d811710781e68f32a", "url": "https://github.com/axelor/axelor-open-suite/commit/5d161ce336ac5255d8674c7d811710781e68f32a", "message": "Feature #17220: Pack / SaleOrder", "committedDate": "2020-05-08T12:38:25Z", "type": "forcePushed"}]}