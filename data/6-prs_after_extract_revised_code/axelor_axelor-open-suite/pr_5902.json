{"pr_number": 5902, "pr_title": "#29776 - Modify appBaseService.getTodayDate()", "pr_createdAt": "2020-09-28T16:34:35Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/5902", "timeline": [{"oid": "970d6de4141a99826ac8ede0c83f7214091951db", "url": "https://github.com/axelor/axelor-open-suite/commit/970d6de4141a99826ac8ede0c83f7214091951db", "message": "Modify appBaseService.getTodayDate() method to take into account the\ngiven company's timezone", "committedDate": "2020-09-28T16:32:10Z", "type": "commit"}, {"oid": "8ca42e9cf7da841d29759f4b6446df034449ff0b", "url": "https://github.com/axelor/axelor-open-suite/commit/8ca42e9cf7da841d29759f4b6446df034449ff0b", "message": "Readd a deprecated getTodayDate() method without company for the client project's compatibility", "committedDate": "2020-09-28T16:41:52Z", "type": "commit"}, {"oid": "99bc001a9e0a67cff0cf24a26d6908b4cac01f15", "url": "https://github.com/axelor/axelor-open-suite/commit/99bc001a9e0a67cff0cf24a26d6908b4cac01f15", "message": "Apply spotless", "committedDate": "2020-09-29T08:01:23Z", "type": "commit"}, {"oid": "4c9e7bc86931dc2ce7105535401229cda5c4f6c4", "url": "https://github.com/axelor/axelor-open-suite/commit/4c9e7bc86931dc2ce7105535401229cda5c4f6c4", "message": "Fix DateTool's getTodayDateTime method when given timezone is null", "committedDate": "2020-09-29T10:39:50Z", "type": "commit"}, {"oid": "4c9e7bc86931dc2ce7105535401229cda5c4f6c4", "url": "https://github.com/axelor/axelor-open-suite/commit/4c9e7bc86931dc2ce7105535401229cda5c4f6c4", "message": "Fix DateTool's getTodayDateTime method when given timezone is null", "committedDate": "2020-09-29T10:39:50Z", "type": "forcePushed"}, {"oid": "eb67046ab8a31824758be6a75bd845ee2718e67e", "url": "https://github.com/axelor/axelor-open-suite/commit/eb67046ab8a31824758be6a75bd845ee2718e67e", "message": "Fix NPE in TemplateMessageServiceBaseImpl constructor in case connected user's activeCompany is null", "committedDate": "2020-09-30T13:14:45Z", "type": "commit"}, {"oid": "f79096d4f5256829a116d118832da88bf9f073b6", "url": "https://github.com/axelor/axelor-open-suite/commit/f79096d4f5256829a116d118832da88bf9f073b6", "message": "Fix AuthUtils.getUser().getActiveCompany() related potentials NPE", "committedDate": "2020-09-30T13:18:25Z", "type": "commit"}, {"oid": "23165378ce4319cd5f62049174c6a758643a2ede", "url": "https://github.com/axelor/axelor-open-suite/commit/23165378ce4319cd5f62049174c6a758643a2ede", "message": "Fix __user__.activeCompany related potentials NPE and apply spotless", "committedDate": "2020-09-30T13:28:57Z", "type": "commit"}, {"oid": "484039ea7f090f560f323734c21e656e9c444015", "url": "https://github.com/axelor/axelor-open-suite/commit/484039ea7f090f560f323734c21e656e9c444015", "message": "Fix NPE in computeAnalyticDistribution and createAnalyticDistributionWithTemplate of InvoiceLineServiceImpl if invoiceLine.getInvoice() is null", "committedDate": "2020-09-30T15:31:34Z", "type": "commit"}, {"oid": "de76e65bb2f4b037ca059238596932134d565f3a", "url": "https://github.com/axelor/axelor-open-suite/commit/de76e65bb2f4b037ca059238596932134d565f3a", "message": "Fix potentials NPE", "committedDate": "2020-09-30T16:24:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1Nzg3NA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498257874", "bodyText": "can values.get(\"endOfValidityDateShift\") return null here ?", "author": "ale-axelor", "createdAt": "2020-10-01T13:48:12Z", "path": "axelor-account/src/main/java/com/axelor/csv/script/ImportMoveTemplate.java", "diffHunk": "@@ -18,17 +18,27 @@\n package com.axelor.csv.script;\n \n import com.axelor.apps.account.db.MoveTemplate;\n+import com.axelor.apps.base.service.app.AppBaseService;\n+import com.axelor.common.StringUtils;\n+import com.axelor.inject.Beans;\n import java.io.IOException;\n import java.util.Map;\n \n public class ImportMoveTemplate {\n-  public Object setCompany(Object bean, Map<String, Object> values) throws IOException {\n+  public Object importMove(Object bean, Map<String, Object> values) throws IOException {\n     assert bean instanceof MoveTemplate;\n     MoveTemplate moveTemplate = (MoveTemplate) bean;\n \n     try {\n       if (moveTemplate.getJournal() != null) {\n         moveTemplate.setCompany(moveTemplate.getJournal().getCompany());\n+        String dateShift = values.get(\"endOfValidityDateShift\").toString();", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2OTUzMQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498669531", "bodyText": "No, an empty value in a csv always lead to an empty String in my tests.", "author": "lde-axelor", "createdAt": "2020-10-02T07:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1Nzg3NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2MTkxNA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498261914", "bodyText": "please translate javadoc to english", "author": "ale-axelor", "createdAt": "2020-10-01T13:53:37Z", "path": "axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java", "diffHunk": "@@ -36,21 +37,42 @@\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur\n-   * si existe, sinon r\u00e9cup\u00e8re celle de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n+   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n+   * g\u00e9n\u00e9rale, sinon date du jour. private", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8def22ab5100dcdcd2e1967ab1d9f30a964a05b9", "chunk": "diff --git a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\nindex f9640b2c42..cac37ed5a6 100644\n--- a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n+++ b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n\n@@ -37,18 +37,18 @@ public interface AppBaseService extends AppService {\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n-   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n-   * g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the server timezone. Returns the current date\n+   * set in the user if it exists, otherwise retrieves the one from the general administration,\n+   * otherwise the current date.\n    *\n    * @return\n    */\n   public ZonedDateTime getTodayDateTime();\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9\n-   * donn\u00e9e. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle\n-   * de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the timezone entered in the given company.\n+   * Returns the current date set in the user if it exists, otherwise retrieve the general\n+   * administration's one, otherwise current date.\n    *\n    * @return\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2MjE0NQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498262145", "bodyText": "please translate javadoc to english", "author": "ale-axelor", "createdAt": "2020-10-01T13:53:57Z", "path": "axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java", "diffHunk": "@@ -36,21 +37,42 @@\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur\n-   * si existe, sinon r\u00e9cup\u00e8re celle de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n+   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n+   * g\u00e9n\u00e9rale, sinon date du jour. private\n    *\n    * @return\n    */\n   public ZonedDateTime getTodayDateTime();\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe,\n-   * sinon r\u00e9cup\u00e8re celle de l'administration g\u00e9n\u00e9rale, sinon date du jour.\n+   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8def22ab5100dcdcd2e1967ab1d9f30a964a05b9", "chunk": "diff --git a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\nindex f9640b2c42..cac37ed5a6 100644\n--- a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n+++ b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n\n@@ -37,18 +37,18 @@ public interface AppBaseService extends AppService {\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n-   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n-   * g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the server timezone. Returns the current date\n+   * set in the user if it exists, otherwise retrieves the one from the general administration,\n+   * otherwise the current date.\n    *\n    * @return\n    */\n   public ZonedDateTime getTodayDateTime();\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9\n-   * donn\u00e9e. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle\n-   * de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the timezone entered in the given company.\n+   * Returns the current date set in the user if it exists, otherwise retrieve the general\n+   * administration's one, otherwise current date.\n    *\n    * @return\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2Mjk1OA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498262958", "bodyText": "see above", "author": "ale-axelor", "createdAt": "2020-10-01T13:54:59Z", "path": "axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java", "diffHunk": "@@ -36,21 +37,42 @@\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur\n-   * si existe, sinon r\u00e9cup\u00e8re celle de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n+   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n+   * g\u00e9n\u00e9rale, sinon date du jour. private\n    *\n    * @return\n    */\n   public ZonedDateTime getTodayDateTime();\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe,\n-   * sinon r\u00e9cup\u00e8re celle de l'administration g\u00e9n\u00e9rale, sinon date du jour.\n+   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9\n+   * donn\u00e9e. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle\n+   * de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n    *\n    * @return\n    */\n+  public ZonedDateTime getTodayDateTime(Company company);\n+\n+  /**\n+   * This method is deprecated. Please use the\n+   * com.axelor.apps.base.service.app.AppBaseService#getTodayDate(com.axelor.apps.base.db.Company)\n+   * method instead.\n+   *\n+   * @return\n+   */\n+  @Deprecated\n   public LocalDate getTodayDate();\n \n+  /**\n+   * R\u00e9cup\u00e9rer la date du jour en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9 donn\u00e9e.", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8def22ab5100dcdcd2e1967ab1d9f30a964a05b9", "chunk": "diff --git a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\nindex f9640b2c42..cac37ed5a6 100644\n--- a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n+++ b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseService.java\n\n@@ -37,18 +37,18 @@ public interface AppBaseService extends AppService {\n   // Date du jour\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone du serveur. Retourne la date\n-   * du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle de l'administration\n-   * g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the server timezone. Returns the current date\n+   * set in the user if it exists, otherwise retrieves the one from the general administration,\n+   * otherwise the current date.\n    *\n    * @return\n    */\n   public ZonedDateTime getTodayDateTime();\n \n   /**\n-   * R\u00e9cup\u00e9rer la date du jour avec l'heure en fonction de la timezone renseign\u00e9e dans la soci\u00e9t\u00e9\n-   * donn\u00e9e. Retourne la date du jour param\u00e9tr\u00e9 dans l'utilisateur si existe, sinon r\u00e9cup\u00e8re celle\n-   * de l'administration g\u00e9n\u00e9rale, sinon date du jour. private\n+   * Retrieve the current date and time according to the timezone entered in the given company.\n+   * Returns the current date set in the user if it exists, otherwise retrieve the general\n+   * administration's one, otherwise current date.\n    *\n    * @return\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3MDA1MQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498270051", "bodyText": "please do not use wildcards for import", "author": "ale-axelor", "createdAt": "2020-10-01T14:04:22Z", "path": "axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseServiceImpl.java", "diffHunk": "@@ -18,10 +18,8 @@\n package com.axelor.apps.base.service.app;\n \n import com.axelor.app.AppSettings;\n-import com.axelor.apps.base.db.AppBase;\n-import com.axelor.apps.base.db.CurrencyConversionLine;\n-import com.axelor.apps.base.db.Language;\n-import com.axelor.apps.base.db.Unit;\n+import com.axelor.apps.base.db.*;", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9cce9a3ec40e7765e9f21b76522a3b91f6284b24", "chunk": "diff --git a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseServiceImpl.java b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseServiceImpl.java\nindex 4b8b860128..8cc0b545c6 100644\n--- a/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseServiceImpl.java\n+++ b/axelor-base/src/main/java/com/axelor/apps/base/service/app/AppBaseServiceImpl.java\n\n@@ -18,7 +18,11 @@\n package com.axelor.apps.base.service.app;\n \n import com.axelor.app.AppSettings;\n-import com.axelor.apps.base.db.*;\n+import com.axelor.apps.base.db.AppBase;\n+import com.axelor.apps.base.db.Company;\n+import com.axelor.apps.base.db.CurrencyConversionLine;\n+import com.axelor.apps.base.db.Language;\n+import com.axelor.apps.base.db.Unit;\n import com.axelor.apps.tool.date.DateTool;\n import com.axelor.auth.AuthUtils;\n import com.axelor.auth.db.User;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3NDI2MA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5902#discussion_r498274260", "bodyText": "it would be safer to check for NPE (I think using optional.map will be useful here)", "author": "ale-axelor", "createdAt": "2020-10-01T14:10:09Z", "path": "axelor-contract/src/main/java/com/axelor/apps/contract/service/ConsumptionLineServiceImpl.java", "diffHunk": "@@ -37,7 +37,9 @@ public ConsumptionLineServiceImpl(AppBaseService appBaseService) {\n   @Override\n   public ConsumptionLine fill(ConsumptionLine line, Product product) {\n     Preconditions.checkNotNull(product, I18n.get(IExceptionMessage.CONTRACT_EMPTY_PRODUCT));\n-    line.setLineDate(appBaseService.getTodayDate());\n+    line.setLineDate(\n+        appBaseService.getTodayDate(\n+            line.getContractLine().getContractVersion().getContract().getCompany()));", "originalCommit": "de76e65bb2f4b037ca059238596932134d565f3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2ef7fd1d590183b5444cf50a755a968b2c3b050", "chunk": "diff --git a/axelor-contract/src/main/java/com/axelor/apps/contract/service/ConsumptionLineServiceImpl.java b/axelor-contract/src/main/java/com/axelor/apps/contract/service/ConsumptionLineServiceImpl.java\nindex c11310d2f2..ae50c5f048 100644\n--- a/axelor-contract/src/main/java/com/axelor/apps/contract/service/ConsumptionLineServiceImpl.java\n+++ b/axelor-contract/src/main/java/com/axelor/apps/contract/service/ConsumptionLineServiceImpl.java\n\n@@ -39,7 +44,11 @@ public class ConsumptionLineServiceImpl implements ConsumptionLineService {\n     Preconditions.checkNotNull(product, I18n.get(IExceptionMessage.CONTRACT_EMPTY_PRODUCT));\n     line.setLineDate(\n         appBaseService.getTodayDate(\n-            line.getContractLine().getContractVersion().getContract().getCompany()));\n+            Optional.ofNullable(line.getContractLine())\n+                .map(ContractLine::getContractVersion)\n+                .map(ContractVersion::getContract)\n+                .map(Contract::getCompany)\n+                .orElse(AuthUtils.getUser().getActiveCompany())));\n     line.setProduct(product);\n     line.setReference(product.getName());\n     line.setUnit(product.getUnit());\n"}}, {"oid": "8def22ab5100dcdcd2e1967ab1d9f30a964a05b9", "url": "https://github.com/axelor/axelor-open-suite/commit/8def22ab5100dcdcd2e1967ab1d9f30a964a05b9", "message": "Translate JavaDoc", "committedDate": "2020-10-02T08:09:30Z", "type": "commit"}, {"oid": "9cce9a3ec40e7765e9f21b76522a3b91f6284b24", "url": "https://github.com/axelor/axelor-open-suite/commit/9cce9a3ec40e7765e9f21b76522a3b91f6284b24", "message": "Fix wildcard import", "committedDate": "2020-10-02T08:09:58Z", "type": "commit"}, {"oid": "a2ef7fd1d590183b5444cf50a755a968b2c3b050", "url": "https://github.com/axelor/axelor-open-suite/commit/a2ef7fd1d590183b5444cf50a755a968b2c3b050", "message": "Use Optional.map to prevent NPE", "committedDate": "2020-10-02T08:13:49Z", "type": "commit"}, {"oid": "a2ef7fd1d590183b5444cf50a755a968b2c3b050", "url": "https://github.com/axelor/axelor-open-suite/commit/a2ef7fd1d590183b5444cf50a755a968b2c3b050", "message": "Use Optional.map to prevent NPE", "committedDate": "2020-10-02T08:13:49Z", "type": "forcePushed"}, {"oid": "e08df9d41cec808e9cb70b7c9c55752f08d03e9c", "url": "https://github.com/axelor/axelor-open-suite/commit/e08df9d41cec808e9cb70b7c9c55752f08d03e9c", "message": "Update CHANGELOG", "committedDate": "2020-10-02T08:30:51Z", "type": "commit"}, {"oid": "4de1d9ba5592d6db1aff4f1d36cc8ffef0c77d5b", "url": "https://github.com/axelor/axelor-open-suite/commit/4de1d9ba5592d6db1aff4f1d36cc8ffef0c77d5b", "message": "Merge branch 'dev' into zoned-gettodaydate", "committedDate": "2020-10-02T08:32:43Z", "type": "commit"}]}