{"pr_number": 5196, "pr_title": "RM#25172-25120: Fixed asset : add EU and US prorata temporis and corr\u2026", "pr_createdAt": "2020-03-23T20:16:36Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/5196", "timeline": [{"oid": "552b6235e7bc828e61aa6c729ff501c1efa6a731", "url": "https://github.com/axelor/axelor-open-suite/commit/552b6235e7bc828e61aa6c729ff501c1efa6a731", "message": "RM#25172-25120: Fixed asset : add EU and US prorata temporis and corrected calculation of amortization.", "committedDate": "2020-03-23T20:16:02Z", "type": "commit"}, {"oid": "16d41de6002db0a437b63c3f72ef7f2a3242c792", "url": "https://github.com/axelor/axelor-open-suite/commit/16d41de6002db0a437b63c3f72ef7f2a3242c792", "message": "RM#25172-25120: correction", "committedDate": "2020-03-24T12:39:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNDQ3Nw==", "url": "https://github.com/axelor/axelor-open-suite/pull/5196#discussion_r397124477", "bodyText": "you have to set a rounding method to avoid an exception", "author": "ale-axelor", "createdAt": "2020-03-24T12:46:18Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java", "diffHunk": "@@ -359,14 +406,17 @@ private FixedAssetLine generateProrataDepreciationLine(\n     FixedAssetLine fixedAssetLine = new FixedAssetLine();\n     fixedAssetLine.setDepreciationDate(disposalDate);\n     BigDecimal prorataTemporis =\n-        new BigDecimal(monthsBetweenDates / fixedAsset.getPeriodicityInMonth().floatValue());\n+        BigDecimal.valueOf(monthsBetweenDates)\n+            .divide(BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()))\n+            .setScale(6);\n \n     int scale = Beans.get(AppBaseService.class).getNbDecimalDigitForUnitPrice();\n     int numberOfDepreciation =\n         fixedAsset.getFixedAssetCategory().getIsProrataTemporis()\n             ? fixedAsset.getNumberOfDepreciation() - 1\n             : fixedAsset.getNumberOfDepreciation();\n-    float depreciationRate = 1f / numberOfDepreciation * 100f;\n+    BigDecimal depreciationRate =\n+        BigDecimal.ONE.divide(BigDecimal.valueOf(numberOfDepreciation * 100));", "originalCommit": "16d41de6002db0a437b63c3f72ef7f2a3242c792", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aac74a275c23ca701fc79822b1fe55839fd44b9e", "chunk": "diff --git a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\nindex a894f85016..e39a5c067e 100644\n--- a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n+++ b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n\n@@ -407,8 +414,9 @@ public class FixedAssetServiceImpl implements FixedAssetService {\n     fixedAssetLine.setDepreciationDate(disposalDate);\n     BigDecimal prorataTemporis =\n         BigDecimal.valueOf(monthsBetweenDates)\n-            .divide(BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()))\n-            .setScale(6);\n+            .divide(\n+                BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()), BigDecimal.ROUND_HALF_EVEN)\n+            .setScale(calculationScale);\n \n     int scale = Beans.get(AppBaseService.class).getNbDecimalDigitForUnitPrice();\n     int numberOfDepreciation =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNTE4NA==", "url": "https://github.com/axelor/axelor-open-suite/pull/5196#discussion_r397125184", "bodyText": "put 6 in a static variable in the class, since this is used multiple times", "author": "ale-axelor", "createdAt": "2020-03-24T12:47:31Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java", "diffHunk": "@@ -359,14 +406,17 @@ private FixedAssetLine generateProrataDepreciationLine(\n     FixedAssetLine fixedAssetLine = new FixedAssetLine();\n     fixedAssetLine.setDepreciationDate(disposalDate);\n     BigDecimal prorataTemporis =\n-        new BigDecimal(monthsBetweenDates / fixedAsset.getPeriodicityInMonth().floatValue());\n+        BigDecimal.valueOf(monthsBetweenDates)\n+            .divide(BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()))\n+            .setScale(6);", "originalCommit": "16d41de6002db0a437b63c3f72ef7f2a3242c792", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aac74a275c23ca701fc79822b1fe55839fd44b9e", "chunk": "diff --git a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\nindex a894f85016..e39a5c067e 100644\n--- a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n+++ b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n\n@@ -407,8 +414,9 @@ public class FixedAssetServiceImpl implements FixedAssetService {\n     fixedAssetLine.setDepreciationDate(disposalDate);\n     BigDecimal prorataTemporis =\n         BigDecimal.valueOf(monthsBetweenDates)\n-            .divide(BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()))\n-            .setScale(6);\n+            .divide(\n+                BigDecimal.valueOf(fixedAsset.getPeriodicityInMonth()), BigDecimal.ROUND_HALF_EVEN)\n+            .setScale(calculationScale);\n \n     int scale = Beans.get(AppBaseService.class).getNbDecimalDigitForUnitPrice();\n     int numberOfDepreciation =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTAwOQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5196#discussion_r397129009", "bodyText": "Use the Month enum instead of int.", "author": "ale-axelor", "createdAt": "2020-03-24T12:54:03Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java", "diffHunk": "@@ -168,44 +169,90 @@ private LocalDate addPeriodicity(\n     return depreciationDate;\n   }\n \n-  private BigDecimal computeDepreciationValue(FixedAsset fixedAsset, boolean isLinear) {\n+  protected BigDecimal computeDepreciationValue(FixedAsset fixedAsset, boolean isLinear) {\n     BigDecimal depreciationValue = BigDecimal.ZERO;\n     depreciationValue =\n         this.computeDepreciation(fixedAsset, fixedAsset.getGrossValue(), true, isLinear);\n     return depreciationValue;\n   }\n \n-  private BigDecimal computeProrataTemporis(FixedAsset fixedAsset, boolean isFirstYear) {\n-    float prorataTemporis = 1;\n+  protected BigDecimal computeProrataTemporis(FixedAsset fixedAsset, boolean isFirstYear) {\n+    BigDecimal prorataTemporis = BigDecimal.ONE;\n     if (isFirstYear\n         && fixedAsset.getFixedAssetCategory().getIsProrataTemporis()\n         && !fixedAsset.getAcquisitionDate().equals(fixedAsset.getFirstDepreciationDate())) {\n \n       LocalDate acquisitionDate = fixedAsset.getAcquisitionDate();\n       LocalDate depreciationDate = fixedAsset.getFirstDepreciationDate();\n \n-      long nbDaysOfPeriod =\n-          DateTool.daysBetween(\n-              DateTool.minusMonths(depreciationDate, fixedAsset.getPeriodicityInMonth()),\n-              depreciationDate,\n-              false);\n-      long nbDaysBetweenAcqAndFirstDepDate =\n-          DateTool.daysBetween(acquisitionDate, depreciationDate, false) + 1;\n+      int acquisitionYear = acquisitionDate.getYear();\n+      int acquisitionMonth = acquisitionDate.getMonthValue();", "originalCommit": "16d41de6002db0a437b63c3f72ef7f2a3242c792", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "aac74a275c23ca701fc79822b1fe55839fd44b9e", "chunk": "diff --git a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\nindex a894f85016..e39a5c067e 100644\n--- a/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n+++ b/axelor-account/src/main/java/com/axelor/apps/account/service/FixedAssetServiceImpl.java\n\n@@ -186,23 +189,24 @@ public class FixedAssetServiceImpl implements FixedAssetService {\n       LocalDate depreciationDate = fixedAsset.getFirstDepreciationDate();\n \n       int acquisitionYear = acquisitionDate.getYear();\n-      int acquisitionMonth = acquisitionDate.getMonthValue();\n+      Month acquisitionMonth = acquisitionDate.getMonth();\n       int acquisitionDay = acquisitionDate.getDayOfMonth();\n       int depreciationYear = depreciationDate.getYear();\n-      int depreciationMonth = depreciationDate.getMonthValue();\n+      Month depreciationMonth = depreciationDate.getMonth();\n       int depreciationDay = depreciationDate.getDayOfMonth();\n \n       // US way\n       if (fixedAsset.getFixedAssetCategory().getIsUSProrataTemporis()) {\n \n-        if (acquisitionMonth == 2\n-            && depreciationMonth == 2\n+        if (acquisitionMonth == Month.FEBRUARY\n+            && depreciationMonth == Month.FEBRUARY\n             && isLastDayOfFebruary(acquisitionYear, acquisitionDay)\n             && isLastDayOfFebruary(depreciationYear, depreciationDay)) {\n           depreciationDay = 30;\n         }\n \n-        if (acquisitionMonth == 2 && isLastDayOfFebruary(acquisitionYear, acquisitionDay)) {\n+        if (acquisitionMonth == Month.FEBRUARY\n+            && isLastDayOfFebruary(acquisitionYear, acquisitionDay)) {\n           acquisitionDay = 30;\n         }\n \n"}}, {"oid": "aac74a275c23ca701fc79822b1fe55839fd44b9e", "url": "https://github.com/axelor/axelor-open-suite/commit/aac74a275c23ca701fc79822b1fe55839fd44b9e", "message": "RM#25172-25120: correction", "committedDate": "2020-03-24T13:45:04Z", "type": "commit"}, {"oid": "32c81f780027208535a31aa4cc7939a702587ef1", "url": "https://github.com/axelor/axelor-open-suite/commit/32c81f780027208535a31aa4cc7939a702587ef1", "message": "Merge branch '5.2-dev' into dev52-25172-25120", "committedDate": "2020-03-25T14:14:38Z", "type": "commit"}]}