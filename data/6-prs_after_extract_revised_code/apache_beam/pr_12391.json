{"pr_number": 12391, "pr_title": "[BEAM-9839] OnTimerContext should not create a new one when processing each element/timer in FnApiDoFnRunner", "pr_createdAt": "2020-07-28T13:20:39Z", "pr_url": "https://github.com/apache/beam/pull/12391", "timeline": [{"oid": "e82396b2b4c78fcecfda481bab58b14a04d29917", "url": "https://github.com/apache/beam/commit/e82396b2b4c78fcecfda481bab58b14a04d29917", "message": "TimerContext fix", "committedDate": "2020-06-16T12:26:09Z", "type": "commit"}, {"oid": "eba5cec4e6f3987dfd050ce22f87734b70c8de06", "url": "https://github.com/apache/beam/commit/eba5cec4e6f3987dfd050ce22f87734b70c8de06", "message": "Merge branch 'master' into feature/BEAM-9839\n\n# Conflicts:\n#\tsdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "committedDate": "2020-07-28T11:40:35Z", "type": "commit"}, {"oid": "0d4b54d62113c6571776bfb94b9b6b81b0187cb7", "url": "https://github.com/apache/beam/commit/0d4b54d62113c6571776bfb94b9b6b81b0187cb7", "message": "OnTimerContext final", "committedDate": "2020-07-28T13:18:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MDU5NA==", "url": "https://github.com/apache/beam/pull/12391#discussion_r461870594", "bodyText": "It seems a regression to not return the typed key. Can OnTimerContext still be typed (necessitating perhaps a cast here)?", "author": "robertwb", "createdAt": "2020-07-28T20:50:49Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -2118,8 +2113,8 @@ public TimeDomain timeDomain(DoFn<InputT, OutputT> doFn) {\n     }\n \n     @Override\n-    public K key() {\n-      return key;\n+    public Object key() {", "originalCommit": "0d4b54d62113c6571776bfb94b9b6b81b0187cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MzM1Nw==", "url": "https://github.com/apache/beam/pull/12391#discussion_r462163357", "bodyText": "I think at the time of the initialization of OnTimerContext, we don't have information of Key type. @robertwb", "author": "rehmanmuradali", "createdAt": "2020-07-29T09:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MDU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzODM2Mg==", "url": "https://github.com/apache/beam/pull/12391#discussion_r464538362", "bodyText": "Due to type erasure, we don't have to know it at initialization time, but we do know it when passed to the user (and it'd be better to give them something properly typed.)", "author": "robertwb", "createdAt": "2020-08-03T16:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MDU5NA=="}], "type": "inlineReview", "revised_code": {"commit": "b414d71815e292a14882939b4f7916506d59ca22", "chunk": "diff --git a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\nindex 6204eff2b7..20e915cd35 100644\n--- a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\n+++ b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\n\n@@ -2113,8 +2113,8 @@ public class FnApiDoFnRunner<InputT, RestrictionT, PositionT, WatermarkEstimator\n     }\n \n     @Override\n-    public Object key() {\n-      return currentTimer.getUserKey();\n+    public K key() {\n+      return (K) currentTimer.getUserKey();\n     }\n \n     @Override\n"}}, {"oid": "b414d71815e292a14882939b4f7916506d59ca22", "url": "https://github.com/apache/beam/commit/b414d71815e292a14882939b4f7916506d59ca22", "message": "return typed key", "committedDate": "2020-08-03T18:38:35Z", "type": "commit"}]}