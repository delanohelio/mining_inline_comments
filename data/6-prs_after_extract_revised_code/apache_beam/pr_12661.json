{"pr_number": 12661, "pr_title": "Add export FHIR resources to GCS IO Connector", "pr_createdAt": "2020-08-21T17:27:07Z", "pr_url": "https://github.com/apache/beam/pull/12661", "timeline": [{"oid": "3b83cb47120e1fe6f8d5dff5a5873e4887a4d461", "url": "https://github.com/apache/beam/commit/3b83cb47120e1fe6f8d5dff5a5873e4887a4d461", "message": "Add export FHIR resources to GCS method for HealthcareApiClient.", "committedDate": "2020-08-21T17:17:12Z", "type": "commit"}, {"oid": "392627b091d633590ead97f5fa670ba68897a56d", "url": "https://github.com/apache/beam/commit/392627b091d633590ead97f5fa670ba68897a56d", "message": "Add export FHIR resources to GCS method for HealthcareApiClient.", "committedDate": "2020-08-21T18:01:36Z", "type": "commit"}, {"oid": "001773d32d6920e55bd71ccd13985efede92fbac", "url": "https://github.com/apache/beam/commit/001773d32d6920e55bd71ccd13985efede92fbac", "message": "Add export FHIR resources to GCS method for HealthcareApiClient.", "committedDate": "2020-08-21T21:06:13Z", "type": "commit"}, {"oid": "50444935a5b5f08c6c4bdcb472f42d962cb623f8", "url": "https://github.com/apache/beam/commit/50444935a5b5f08c6c4bdcb472f42d962cb623f8", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-24T17:36:55Z", "type": "commit"}, {"oid": "05b5dde38e62cc0f7785ee6fb57379f8d6c4c477", "url": "https://github.com/apache/beam/commit/05b5dde38e62cc0f7785ee6fb57379f8d6c4c477", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-24T17:47:45Z", "type": "commit"}, {"oid": "d74ef80d93e793c5b8bde1bbb21ad5bb9a2fd8d3", "url": "https://github.com/apache/beam/commit/d74ef80d93e793c5b8bde1bbb21ad5bb9a2fd8d3", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-24T17:56:14Z", "type": "commit"}, {"oid": "e76234f0021e20ccd64aa90470e66e187d1e2749", "url": "https://github.com/apache/beam/commit/e76234f0021e20ccd64aa90470e66e187d1e2749", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-25T15:32:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyNzAwMA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r476927000", "bodyText": "It's a little unorthodox to pass a configuration object to a PTransform rather than configure it directly via withXYZ calls.\nWhy did you choose to define ExportGcs.Options rather than make the ExportGcs class hold its own configuration?\nI can think of one benefit - It seems that you can define multiple ExportGCS.Options and pass them down a PTransform to execute multiple exports. Did you have this in mind?", "author": "pabloem", "createdAt": "2020-08-26T00:52:00Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -220,6 +230,26 @@ public static Import importResources(\n     return new Import(fhirStore, tempDir, deadLetterDir, contentStructure);\n   }\n \n+  /**\n+   * Export resources to GCS. Intended for use on non-empty FHIR stores\n+   *\n+   * @return the export\n+   * @see ExportGcs\n+   */\n+  public static ExportGcs exportResourcesToGcs(ExportGcs.Options exportOptions) {", "originalCommit": "d74ef80d93e793c5b8bde1bbb21ad5bb9a2fd8d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNzk5MQ==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477327991", "bodyText": "Export FHIR resources doesn't have many options like import so I moved those config into ExportGcs class.", "author": "trucleduc", "createdAt": "2020-08-26T14:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyNzAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "13144c8303023f7b27f5e881957ffa0a3c8b31be", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\nindex 8ea6a495a7..101da36bf1 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n\n@@ -233,21 +225,16 @@ public class FhirIO {\n   /**\n    * Export resources to GCS. Intended for use on non-empty FHIR stores\n    *\n+   * @param fhirStore the fhir store, in the format:\n+   *     projects/project_id/locations/location_id/datasets/dataset_id/fhirStores/fhir_store_id\n+   * @param exportGcsUriPrefix the destination GCS dir, in the format:\n+   *     gs://YOUR_BUCKET_NAME/path/to/a/dir\n    * @return the export\n    * @see ExportGcs\n    */\n-  public static ExportGcs exportResourcesToGcs(ExportGcs.Options exportOptions) {\n-    return new ExportGcs(StaticValueProvider.of(exportOptions));\n-  }\n-\n-  /**\n-   * Export resources to GCS. Intended for use on non-empty FHIR stores\n-   *\n-   * @return the export\n-   * @see ExportGcs\n-   */\n-  public static ExportGcs exportResourcesToGcs(ValueProvider<ExportGcs.Options> exportOptions) {\n-    return new ExportGcs(exportOptions);\n+  public static ExportGcs exportResourcesToGcs(String fhirStore, String exportGcsUriPrefix) {\n+    return new ExportGcs(\n+        StaticValueProvider.of(fhirStore), StaticValueProvider.of(exportGcsUriPrefix));\n   }\n \n   /** The type Read. */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjEzOA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477002138", "bodyText": "I think it's better to add a bit more details here, e.g. the format of an FHIR store name, and the GCS URI prefix etc.", "author": "lastomato", "createdAt": "2020-08-26T02:54:42Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -220,6 +222,19 @@ public static Import importResources(\n     return new Import(fhirStore, tempDir, deadLetterDir, contentStructure);\n   }\n \n+  /**\n+   * Export resources to GCS. Intended for use on non-empty FHIR stores\n+   *\n+   * @param fhirStore the fhir store", "originalCommit": "e76234f0021e20ccd64aa90470e66e187d1e2749", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyODEyNA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477328124", "bodyText": "Done.", "author": "trucleduc", "createdAt": "2020-08-26T14:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "13144c8303023f7b27f5e881957ffa0a3c8b31be", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\nindex a06550d3f9..101da36bf1 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n\n@@ -225,8 +225,10 @@ public class FhirIO {\n   /**\n    * Export resources to GCS. Intended for use on non-empty FHIR stores\n    *\n-   * @param fhirStore the fhir store\n-   * @param exportGcsUriPrefix the destination GCS dir\n+   * @param fhirStore the fhir store, in the format:\n+   *     projects/project_id/locations/location_id/datasets/dataset_id/fhirStores/fhir_store_id\n+   * @param exportGcsUriPrefix the destination GCS dir, in the format:\n+   *     gs://YOUR_BUCKET_NAME/path/to/a/dir\n    * @return the export\n    * @see ExportGcs\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjg2MA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477002860", "bodyText": "We might want to add some tests for this. You can find a few examples added by Jacob previously.", "author": "lastomato", "createdAt": "2020-08-26T02:57:22Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1175,4 +1190,94 @@ public void executeBundles(ProcessContext context) {\n       }\n     }\n   }\n+\n+  /** Export FHIR resources from a FHIR store to new line delimited json files on GCS. */\n+  public static class ExportGcs extends PTransform<PBegin, ExportGcs.Result> {", "originalCommit": "e76234f0021e20ccd64aa90470e66e187d1e2749", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyODk3OA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477328978", "bodyText": "Tests added. But I don't have permission on the testing project to run it. In the meantime, I wrote another script to test on my own project (not in this commit but identical to the test) and it worked fine.", "author": "trucleduc", "createdAt": "2020-08-26T14:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjg2MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "13144c8303023f7b27f5e881957ffa0a3c8b31be", "url": "https://github.com/apache/beam/commit/13144c8303023f7b27f5e881957ffa0a3c8b31be", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T14:03:55Z", "type": "commit"}, {"oid": "4561585b7c7422815d8b062261271b2b7517dc9f", "url": "https://github.com/apache/beam/commit/4561585b7c7422815d8b062261271b2b7517dc9f", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T15:29:43Z", "type": "commit"}, {"oid": "0280135b01d8e6a9dfe300c5347b9ddd47f65f30", "url": "https://github.com/apache/beam/commit/0280135b01d8e6a9dfe300c5347b9ddd47f65f30", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T15:34:00Z", "type": "commit"}, {"oid": "97adcceb58fdc49f2c5f0b075d80e019cdcb1909", "url": "https://github.com/apache/beam/commit/97adcceb58fdc49f2c5f0b075d80e019cdcb1909", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T19:30:30Z", "type": "commit"}, {"oid": "fd85f9c1c3f06e76806facc460db930c3afa559d", "url": "https://github.com/apache/beam/commit/fd85f9c1c3f06e76806facc460db930c3afa559d", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:06:12Z", "type": "commit"}, {"oid": "9829244963f46005435dc970d6b32dfc04806888", "url": "https://github.com/apache/beam/commit/9829244963f46005435dc970d6b32dfc04806888", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:07:12Z", "type": "commit"}, {"oid": "a9c73d7b0f983e84921f3664733cffbe2ebaf154", "url": "https://github.com/apache/beam/commit/a9c73d7b0f983e84921f3664733cffbe2ebaf154", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:07:41Z", "type": "commit"}, {"oid": "b0adce241f156bf6dff9c9f8bc395b32827b2509", "url": "https://github.com/apache/beam/commit/b0adce241f156bf6dff9c9f8bc395b32827b2509", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:11:34Z", "type": "commit"}, {"oid": "c934d0bd8e48fe3d615225a6920ca617c8c899ea", "url": "https://github.com/apache/beam/commit/c934d0bd8e48fe3d615225a6920ca617c8c899ea", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:32:03Z", "type": "commit"}, {"oid": "004113aa84a4a4888da4406216abae0a40bc06fa", "url": "https://github.com/apache/beam/commit/004113aa84a4a4888da4406216abae0a40bc06fa", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:32:18Z", "type": "commit"}, {"oid": "2c3016e2edaa0c6b5e49365e7d91073707149d3d", "url": "https://github.com/apache/beam/commit/2c3016e2edaa0c6b5e49365e7d91073707149d3d", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T20:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYzNjEzNA==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477636134", "bodyText": "If you support valueproviders internally, you can add another method exportResourcesToGcs that receives ValueProvider<String> types - this will enable users to use them with themplates", "author": "pabloem", "createdAt": "2020-08-26T22:50:07Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -220,6 +222,21 @@ public static Import importResources(\n     return new Import(fhirStore, tempDir, deadLetterDir, contentStructure);\n   }\n \n+  /**\n+   * Export resources to GCS. Intended for use on non-empty FHIR stores\n+   *\n+   * @param fhirStore the fhir store, in the format:\n+   *     projects/project_id/locations/location_id/datasets/dataset_id/fhirStores/fhir_store_id\n+   * @param exportGcsUriPrefix the destination GCS dir, in the format:\n+   *     gs://YOUR_BUCKET_NAME/path/to/a/dir\n+   * @return the export\n+   * @see ExportGcs\n+   */\n+  public static ExportGcs exportResourcesToGcs(String fhirStore, String exportGcsUriPrefix) {\n+    return new ExportGcs(\n+        StaticValueProvider.of(fhirStore), StaticValueProvider.of(exportGcsUriPrefix));\n+  }", "originalCommit": "2c3016e2edaa0c6b5e49365e7d91073707149d3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY1MDg0MQ==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477650841", "bodyText": "Nice. Thanks for catching. We indeed want to use this as a template :-)", "author": "trucleduc", "createdAt": "2020-08-26T23:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYzNjEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY1MDk5MQ==", "url": "https://github.com/apache/beam/pull/12661#discussion_r477650991", "bodyText": "Done.", "author": "trucleduc", "createdAt": "2020-08-26T23:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYzNjEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "dc973c4fd73502f088e4a9da40c1122338073eb8", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\nindex 101da36bf1..0c175e5bdd 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java\n\n@@ -237,6 +237,21 @@ public class FhirIO {\n         StaticValueProvider.of(fhirStore), StaticValueProvider.of(exportGcsUriPrefix));\n   }\n \n+  /**\n+   * Export resources to GCS. Intended for use on non-empty FHIR stores\n+   *\n+   * @param fhirStore the fhir store, in the format:\n+   *     projects/project_id/locations/location_id/datasets/dataset_id/fhirStores/fhir_store_id\n+   * @param exportGcsUriPrefix the destination GCS dir, in the format:\n+   *     gs://YOUR_BUCKET_NAME/path/to/a/dir\n+   * @return the export\n+   * @see ExportGcs\n+   */\n+  public static ExportGcs exportResourcesToGcs(\n+      ValueProvider<String> fhirStore, ValueProvider<String> exportGcsUriPrefix) {\n+    return new ExportGcs(fhirStore, exportGcsUriPrefix);\n+  }\n+\n   /** The type Read. */\n   public static class Read extends PTransform<PCollection<String>, FhirIO.Read.Result> {\n     private static final Logger LOG = LoggerFactory.getLogger(Read.class);\n"}}, {"oid": "dc973c4fd73502f088e4a9da40c1122338073eb8", "url": "https://github.com/apache/beam/commit/dc973c4fd73502f088e4a9da40c1122338073eb8", "message": "Add export FHIR resources to GCS IO connector.", "committedDate": "2020-08-26T23:08:27Z", "type": "commit"}]}