{"pr_number": 10535, "pr_title": "[BEAM-5605] Add support for executing pair with restriction, split restriction, split and size restriction, process element and restriction and process sized element and restriction within the Java SDK harness.", "pr_createdAt": "2020-01-08T21:59:01Z", "pr_url": "https://github.com/apache/beam/pull/10535", "timeline": [{"oid": "7738a87ff0297ab051f7d4acc13ceb4d907b77f8", "url": "https://github.com/apache/beam/commit/7738a87ff0297ab051f7d4acc13ceb4d907b77f8", "message": "[BEAM-5605] Add support for executing pair with restriction, split restriction, split and size restriction, process element and restriction and process sized element and restriction within the Java SDK harness.\n\nI removed the SplittableProcessElementsRunner and call the DoFnInvoker directly.\nI plan to have a follow-up change that removes the \"context\" object as it is no longer necessary.", "committedDate": "2020-01-08T21:57:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyNTMyNg==", "url": "https://github.com/apache/beam/pull/10535#discussion_r365025326", "bodyText": "Shouldn't this method also produce sizes, like the output method above?", "author": "youngoli", "createdAt": "2020-01-10T00:31:35Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -162,9 +475,127 @@ public void output(OutputT output, Instant timestamp, BoundedWindow window) {\n             outputTo(consumers, WindowedValue.of(output, timestamp, window, PaneInfo.NO_FIRING));\n           }\n         };\n+    switch (context.pTransform.getSpec().getUrn()) {\n+      case PTransformTranslation.SPLITTABLE_SPLIT_RESTRICTION_URN:\n+        this.outputSplitRestrictionReceiver =\n+            new OutputReceiver<RestrictionT>() {\n+\n+              @Override\n+              public void output(RestrictionT output) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        currentElement.withValue(KV.of(currentElement.getValue(), output)));\n+              }\n+\n+              @Override\n+              public void outputWithTimestamp(RestrictionT output, Instant timestamp) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        WindowedValue.of(\n+                            KV.of(currentElement.getValue(), output),\n+                            timestamp,\n+                            currentWindow,\n+                            currentElement.getPane()));\n+              }\n+            };\n+        break;\n+      case PTransformTranslation.SPLITTABLE_SPLIT_AND_SIZE_RESTRICTIONS_URN:\n+        this.outputSplitRestrictionReceiver =\n+            new OutputReceiver<RestrictionT>() {\n+\n+              @Override\n+              public void output(RestrictionT output) {\n+                RestrictionTracker<RestrictionT, PositionT> outputTracker =\n+                    doFnInvoker.invokeNewTracker(output);\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        currentElement.withValue(\n+                            KV.of(\n+                                KV.of(currentElement.getValue(), output),\n+                                outputTracker instanceof HasSize\n+                                    ? ((HasSize) outputTracker).getSize()\n+                                    : 1.0)));\n+              }\n+\n+              @Override\n+              public void outputWithTimestamp(RestrictionT output, Instant timestamp) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        WindowedValue.of(\n+                            KV.of(currentElement.getValue(), output),", "originalCommit": "7738a87ff0297ab051f7d4acc13ceb4d907b77f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MDI1Mw==", "url": "https://github.com/apache/beam/pull/10535#discussion_r365350253", "bodyText": "Yes, fixed in the version below.\nI'm relying on the migration to using SDF everywhere will catch the edge cases via the validates runner tests since unit testing the execution of a single instance is quite verbose.", "author": "lukecwik", "createdAt": "2020-01-10T17:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyNTMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "f4283e094957406ce13526965b92546db3279be3", "chunk": "diff --git a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\nindex 37e0cf80aa..633c533908 100644\n--- a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\n+++ b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java\n\n@@ -522,11 +522,17 @@ public class FnApiDoFnRunner<InputT, RestrictionT, PositionT, OutputT> {\n \n               @Override\n               public void outputWithTimestamp(RestrictionT output, Instant timestamp) {\n+                RestrictionTracker<RestrictionT, PositionT> outputTracker =\n+                    doFnInvoker.invokeNewTracker(output);\n                 outputTo(\n                     mainOutputConsumers,\n                     (WindowedValue<OutputT>)\n                         WindowedValue.of(\n-                            KV.of(currentElement.getValue(), output),\n+                            KV.of(\n+                                KV.of(currentElement.getValue(), output),\n+                                outputTracker instanceof HasSize\n+                                    ? ((HasSize) outputTracker).getSize()\n+                                    : 1.0),\n                             timestamp,\n                             currentWindow,\n                             currentElement.getPane()));\n"}}, {"oid": "f4283e094957406ce13526965b92546db3279be3", "url": "https://github.com/apache/beam/commit/f4283e094957406ce13526965b92546db3279be3", "message": "fixup!", "committedDate": "2020-01-10T17:37:23Z", "type": "commit"}]}