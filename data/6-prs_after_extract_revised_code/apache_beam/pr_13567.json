{"pr_number": 13567, "pr_title": "[BEAM-10114] Add partition increase handling to PubsubLiteIO", "pr_createdAt": "2020-12-16T18:25:06Z", "pr_url": "https://github.com/apache/beam/pull/13567", "timeline": [{"oid": "c9004b2a047e1b1cff3fe6ecc7cf24714c55ec45", "url": "https://github.com/apache/beam/commit/c9004b2a047e1b1cff3fe6ecc7cf24714c55ec45", "message": "feat: Add partition increase handling to PubsubLiteIO", "committedDate": "2020-12-16T17:55:15Z", "type": "commit"}, {"oid": "b109e21c700c1f726f8114f0a508935ce0acb095", "url": "https://github.com/apache/beam/commit/b109e21c700c1f726f8114f0a508935ce0acb095", "message": "fix: Ensure manually set partitions are not ignored.", "committedDate": "2020-12-16T18:32:08Z", "type": "commit"}, {"oid": "3ca43608eb0e43f944d48cf939fa772696a24d86", "url": "https://github.com/apache/beam/commit/3ca43608eb0e43f944d48cf939fa772696a24d86", "message": "fix: Format", "committedDate": "2020-12-16T18:33:21Z", "type": "commit"}, {"oid": "1db9ec33ba87be566f96b706097f61907b3ec879", "url": "https://github.com/apache/beam/commit/1db9ec33ba87be566f96b706097f61907b3ec879", "message": "fix: Format", "committedDate": "2020-12-16T18:43:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1ODE0OA==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556758148", "bodyText": "You may want to update the javadoc of public abstract Set<Partition> partitions();. Based on your code, whether the partitions is empty will lead to different behavior.", "author": "boyuanzz", "createdAt": "2021-01-13T18:58:26Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriberOptions.java", "diffHunk": "@@ -163,28 +161,6 @@ abstract Builder setBacklogReaderSupplier(\n     abstract Builder setOffsetReaderSupplier(\n         SerializableSupplier<InitialOffsetReader> offsetReaderSupplier);\n \n-    // Used for implementing build();\n-    abstract SubscriptionPath subscriptionPath();\n-\n-    abstract Set<Partition> partitions();\n-\n-    abstract SubscriberOptions autoBuild();\n-\n-    @SuppressWarnings(\"CheckReturnValue\")\n-    public SubscriberOptions build() throws ApiException {\n-      if (!partitions().isEmpty()) {\n-        return autoBuild();\n-      }\n-\n-      if (partitions().isEmpty()) {\n-        int partitionCount = PartitionLookupUtils.numPartitions(subscriptionPath());\n-        ImmutableSet.Builder<Partition> partitions = ImmutableSet.builder();\n-        for (int i = 0; i < partitionCount; i++) {\n-          partitions.add(Partition.of(i));\n-        }\n-        setPartitions(partitions.build());\n-      }\n-      return autoBuild();\n-    }\n+    public abstract SubscriberOptions build();", "originalCommit": "1db9ec33ba87be566f96b706097f61907b3ec879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3NDYyNg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556774626", "bodyText": "\"A set of partitions. If empty, retrieve the set of partitions using an admin client.\" is the comment there. I think that is still an accurate explanation?", "author": "dpcollins-google", "createdAt": "2021-01-13T19:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1ODE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAzOTA3MA==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557039070", "bodyText": "You may want to highlight the ability of watching partitions growth when partitions() is empty. This is the key information when users look into javadoc.", "author": "boyuanzz", "createdAt": "2021-01-14T04:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1ODE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxNDk2MA==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557614960", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2021-01-14T18:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc1ODE0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NDgxNg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556764816", "bodyText": "Even though the terminate will not be true in this PR, I'm wondering how is pollDuration.multipliedBy(10) computed?", "author": "boyuanzz", "createdAt": "2021-01-13T19:09:54Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.cloud.pubsublite.Partition;\n+import com.google.cloud.pubsublite.PartitionLookupUtils;\n+import com.google.cloud.pubsublite.SubscriptionPath;\n+import com.google.cloud.pubsublite.TopicPath;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+import org.apache.beam.sdk.transforms.Create;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.transforms.Watch;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollFn;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollResult;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PBegin;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+class SubscriptionPartitionLoader extends PTransform<PBegin, PCollection<SubscriptionPartition>> {\n+  private final TopicPath topic;\n+  private final SubscriptionPath subscription;\n+  private final SerializableFunction<TopicPath, Integer> getPartitionCount;\n+  private final Duration pollDuration;\n+  private final boolean terminate;\n+\n+  SubscriptionPartitionLoader(TopicPath topic, SubscriptionPath subscription) {\n+    this(\n+        topic,\n+        subscription,\n+        PartitionLookupUtils::numPartitions,\n+        Duration.standardMinutes(1),\n+        false);\n+  }\n+\n+  @VisibleForTesting\n+  SubscriptionPartitionLoader(\n+      TopicPath topic,\n+      SubscriptionPath subscription,\n+      SerializableFunction<TopicPath, Integer> getPartitionCount,\n+      Duration pollDuration,\n+      boolean terminate) {\n+    this.topic = topic;\n+    this.subscription = subscription;\n+    this.getPartitionCount = getPartitionCount;\n+    this.pollDuration = pollDuration;\n+    this.terminate = terminate;\n+  }\n+\n+  @Override\n+  public PCollection<SubscriptionPartition> expand(PBegin input) {\n+    PCollection<TopicPath> start = input.apply(Create.of(ImmutableList.of(topic)));\n+    PCollection<KV<TopicPath, Partition>> partitions =\n+        start.apply(\n+            Watch.growthOf(\n+                    new PollFn<TopicPath, Partition>() {\n+                      @Override\n+                      public PollResult<Partition> apply(TopicPath element, Context c) {\n+                        checkArgument(element.equals(topic));\n+                        int partitionCount = getPartitionCount.apply(element);\n+                        List<Partition> partitions =\n+                            IntStream.range(0, partitionCount)\n+                                .mapToObj(Partition::of)\n+                                .collect(Collectors.toList());\n+                        return PollResult.incomplete(Instant.EPOCH, partitions);\n+                      }\n+                    })\n+                .withPollInterval(pollDuration)\n+                .withTerminationPerInput(\n+                    terminate\n+                        ? Watch.Growth.afterTotalOf(pollDuration.multipliedBy(10))", "originalCommit": "1db9ec33ba87be566f96b706097f61907b3ec879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3Njc4OA==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556776788", "bodyText": "This is for unit testing purposes only. If set to true, it polls 10 times. I'm open to better testing methodologies if they exist.", "author": "dpcollins-google", "createdAt": "2021-01-13T19:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NDgxNg=="}], "type": "inlineReview", "revised_code": {"commit": "49c5ed0b0d7681bb080627c259b9cd17dfad0e5d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\nindex 966a1388b3..60789a18dd 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n\n@@ -23,7 +23,6 @@ import com.google.cloud.pubsublite.Partition;\n import com.google.cloud.pubsublite.PartitionLookupUtils;\n import com.google.cloud.pubsublite.SubscriptionPath;\n import com.google.cloud.pubsublite.TopicPath;\n-import com.google.common.annotations.VisibleForTesting;\n import java.util.List;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NTY2Mg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556765662", "bodyText": "pollDuration and terminate should be configurable from PubSubLiteIO with provided default values. What do you think?", "author": "boyuanzz", "createdAt": "2021-01-13T19:11:28Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.cloud.pubsublite.Partition;\n+import com.google.cloud.pubsublite.PartitionLookupUtils;\n+import com.google.cloud.pubsublite.SubscriptionPath;\n+import com.google.cloud.pubsublite.TopicPath;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+import org.apache.beam.sdk.transforms.Create;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.transforms.Watch;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollFn;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollResult;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PBegin;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+class SubscriptionPartitionLoader extends PTransform<PBegin, PCollection<SubscriptionPartition>> {", "originalCommit": "1db9ec33ba87be566f96b706097f61907b3ec879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NzY4Mg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556767682", "bodyText": "And for terminate, if you decide to use Watch.Growth.afterTotalOf as the termination condition, it would be better to have the time duration directly instead of a boolean. What do you think?", "author": "boyuanzz", "createdAt": "2021-01-13T19:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3NTkxOA==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556775918", "bodyText": "should be configurable from PubSubLiteIO\n\nI don't know why? I can't imagine a user would care how often they were polling for an event that is likely to be human triggered. I'd rather defer this until someone asks for it.\n\nif you decide to use Watch.Growth.afterTotalOf as the termination condition, it would be better to have the time duration directly instead of a boolean\n\nIt will never terminate. The boolean only exists for testing purposes, as testing unbounded transforms seems to be an unsolved problem as of yet? If you can think of a better way to test this let me know.", "author": "dpcollins-google", "createdAt": "2021-01-13T19:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzA0MjQwMg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557042402", "bodyText": "I don't know why? I can't imagine a user would care how often they were polling for an event that is likely to be human triggered. I'd rather defer this until someone asks for it.\n\nIf users have a good knowledge on the pattern on partitions growth, they can figure out a reasonable poll duration to be able to detect the new produced partitions as soon as possible, or to avoid doing polling so frequently.\n\nIt will never terminate. The boolean only exists for testing purposes, as testing unbounded transforms seems to be an unsolved problem as of yet? If you can think of a better way to test this let me know.\n\nHmmm that's a real problem for testing unbounded transform. I don't have a better idea now.", "author": "boyuanzz", "createdAt": "2021-01-14T04:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwMzgyMg==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557603822", "bodyText": "the pattern on partitions growth\n\nThis should be O(months) apart. I think the default frequency is fine.", "author": "dpcollins-google", "createdAt": "2021-01-14T18:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc2NTY2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "49c5ed0b0d7681bb080627c259b9cd17dfad0e5d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\nindex 966a1388b3..60789a18dd 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n\n@@ -23,7 +23,6 @@ import com.google.cloud.pubsublite.Partition;\n import com.google.cloud.pubsublite.PartitionLookupUtils;\n import com.google.cloud.pubsublite.SubscriptionPath;\n import com.google.cloud.pubsublite.TopicPath;\n-import com.google.common.annotations.VisibleForTesting;\n import java.util.List;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556771757", "bodyText": "Is it intended to always have the watermark as Instant.EPOCH? It will hold back the system watermark unnecessary and the worst case is that downstream operations will have to wait for this watch transform to complete to process.", "author": "boyuanzz", "createdAt": "2021-01-13T19:21:52Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.pubsublite;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.cloud.pubsublite.Partition;\n+import com.google.cloud.pubsublite.PartitionLookupUtils;\n+import com.google.cloud.pubsublite.SubscriptionPath;\n+import com.google.cloud.pubsublite.TopicPath;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+import org.apache.beam.sdk.transforms.Create;\n+import org.apache.beam.sdk.transforms.MapElements;\n+import org.apache.beam.sdk.transforms.PTransform;\n+import org.apache.beam.sdk.transforms.SerializableFunction;\n+import org.apache.beam.sdk.transforms.Watch;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollFn;\n+import org.apache.beam.sdk.transforms.Watch.Growth.PollResult;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PBegin;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.sdk.values.TypeDescriptor;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+class SubscriptionPartitionLoader extends PTransform<PBegin, PCollection<SubscriptionPartition>> {\n+  private final TopicPath topic;\n+  private final SubscriptionPath subscription;\n+  private final SerializableFunction<TopicPath, Integer> getPartitionCount;\n+  private final Duration pollDuration;\n+  private final boolean terminate;\n+\n+  SubscriptionPartitionLoader(TopicPath topic, SubscriptionPath subscription) {\n+    this(\n+        topic,\n+        subscription,\n+        PartitionLookupUtils::numPartitions,\n+        Duration.standardMinutes(1),\n+        false);\n+  }\n+\n+  @VisibleForTesting\n+  SubscriptionPartitionLoader(\n+      TopicPath topic,\n+      SubscriptionPath subscription,\n+      SerializableFunction<TopicPath, Integer> getPartitionCount,\n+      Duration pollDuration,\n+      boolean terminate) {\n+    this.topic = topic;\n+    this.subscription = subscription;\n+    this.getPartitionCount = getPartitionCount;\n+    this.pollDuration = pollDuration;\n+    this.terminate = terminate;\n+  }\n+\n+  @Override\n+  public PCollection<SubscriptionPartition> expand(PBegin input) {\n+    PCollection<TopicPath> start = input.apply(Create.of(ImmutableList.of(topic)));\n+    PCollection<KV<TopicPath, Partition>> partitions =\n+        start.apply(\n+            Watch.growthOf(\n+                    new PollFn<TopicPath, Partition>() {\n+                      @Override\n+                      public PollResult<Partition> apply(TopicPath element, Context c) {\n+                        checkArgument(element.equals(topic));\n+                        int partitionCount = getPartitionCount.apply(element);\n+                        List<Partition> partitions =\n+                            IntStream.range(0, partitionCount)\n+                                .mapToObj(Partition::of)\n+                                .collect(Collectors.toList());\n+                        return PollResult.incomplete(Instant.EPOCH, partitions);", "originalCommit": "1db9ec33ba87be566f96b706097f61907b3ec879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3NjM5OQ==", "url": "https://github.com/apache/beam/pull/13567#discussion_r556776399", "bodyText": "Is it intended to always have the watermark as Instant.EPOCH\n\nI don't care what the watermark is, so I used EPOCH as the default value. Should I use something like Instant.now()?", "author": "dpcollins-google", "createdAt": "2021-01-13T19:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzA0MDMyNQ==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557040325", "bodyText": "Instant.now() is better than Instant.EPOCH. You should care about the watermark here since the watermark here will affect the watermark of the whole pipeline.", "author": "boyuanzz", "createdAt": "2021-01-14T04:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwNDIyMQ==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557604221", "bodyText": "It shouldn't, since the next stage will overwrite the timestamps and watermarking IIUC. But I'll change to Instant.now().", "author": "dpcollins-google", "createdAt": "2021-01-14T18:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxNTI5NQ==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557615295", "bodyText": "Done.", "author": "dpcollins-google", "createdAt": "2021-01-14T18:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg2MTk2NQ==", "url": "https://github.com/apache/beam/pull/13567#discussion_r557861965", "bodyText": "It shouldn't, since the next stage will overwrite the timestamps and watermarking IIUC.\n\nAt least Dataflow will compute a global watermark, which is the minimal watermark of all stages. That's why you don't want to hold the watermark here.", "author": "boyuanzz", "createdAt": "2021-01-15T04:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3MTc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "49c5ed0b0d7681bb080627c259b9cd17dfad0e5d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\nindex 966a1388b3..60789a18dd 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/pubsublite/SubscriptionPartitionLoader.java\n\n@@ -23,7 +23,6 @@ import com.google.cloud.pubsublite.Partition;\n import com.google.cloud.pubsublite.PartitionLookupUtils;\n import com.google.cloud.pubsublite.SubscriptionPath;\n import com.google.cloud.pubsublite.TopicPath;\n-import com.google.common.annotations.VisibleForTesting;\n import java.util.List;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n"}}, {"oid": "49c5ed0b0d7681bb080627c259b9cd17dfad0e5d", "url": "https://github.com/apache/beam/commit/49c5ed0b0d7681bb080627c259b9cd17dfad0e5d", "message": "fix: Remove guava usage.", "committedDate": "2021-01-13T20:05:55Z", "type": "commit"}, {"oid": "6a700852a01d4409be24729f5271b7f75b69b02a", "url": "https://github.com/apache/beam/commit/6a700852a01d4409be24729f5271b7f75b69b02a", "message": "fix: docs", "committedDate": "2021-01-14T18:40:52Z", "type": "commit"}]}