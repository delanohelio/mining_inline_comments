{"pr_number": 13166, "pr_title": "[BEAM-11091] Allow to specify coder for HadoopFormatIO.Read", "pr_createdAt": "2020-10-22T09:51:51Z", "pr_url": "https://github.com/apache/beam/pull/13166", "timeline": [{"oid": "696ef3b13160df0f0a3478110f36873481ba6782", "url": "https://github.com/apache/beam/commit/696ef3b13160df0f0a3478110f36873481ba6782", "message": "[BEAM-11091] Allow to specify coder for HadoopFormatIO.Read", "committedDate": "2020-10-22T09:50:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzQ5Nw==", "url": "https://github.com/apache/beam/pull/13166#discussion_r510263497", "bodyText": "You need to clear the keyCoder/valueCoder in the non coder based variants otherwise we won't honor the typedescriptor when the user changes the translation function", "author": "lukecwik", "createdAt": "2020-10-22T15:39:45Z", "path": "sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java", "diffHunk": "@@ -437,6 +445,12 @@\n           .build();\n     }\n \n+    /** Transforms the keys read from the source using the given key translation function. */\n+    public Read<K, V> withKeyTranslation(SimpleFunction<?, K> function, Coder<K> coder) {", "originalCommit": "696ef3b13160df0f0a3478110f36873481ba6782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI1NTcwMQ==", "url": "https://github.com/apache/beam/pull/13166#discussion_r514255701", "bodyText": "Good catch. Fixed", "author": "JozoVilcek", "createdAt": "2020-10-29T13:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzQ5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "35d9b2ad710bb05731be87998705976ef37f120f", "chunk": "diff --git a/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java b/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\nindex 24e44285b6..864b2ca870 100644\n--- a/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\n+++ b/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\n\n@@ -442,11 +435,13 @@ public class HadoopFormatIO {\n       return toBuilder()\n           .setKeyTranslationFunction(function)\n           .setKeyTypeDescriptor(function.getOutputTypeDescriptor())\n+          .setValueCoder(null)\n           .build();\n     }\n \n     /** Transforms the keys read from the source using the given key translation function. */\n     public Read<K, V> withKeyTranslation(SimpleFunction<?, K> function, Coder<K> coder) {\n+      checkArgument(function != null, \"function can not be null\");\n       checkArgument(coder != null, \"coder can not be null\");\n       return withKeyTranslation(function).toBuilder().setKeyCoder(coder).build();\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NjM5MQ==", "url": "https://github.com/apache/beam/pull/13166#discussion_r510266391", "bodyText": "Since we don't need the type information anymore, we should use SerializableFunction instead of SimpleFunction. SimpleFunction implements SerializableFunction so this change enables using simpler lambdas.", "author": "lukecwik", "createdAt": "2020-10-22T15:43:41Z", "path": "sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java", "diffHunk": "@@ -437,6 +445,12 @@\n           .build();\n     }\n \n+    /** Transforms the keys read from the source using the given key translation function. */\n+    public Read<K, V> withKeyTranslation(SimpleFunction<?, K> function, Coder<K> coder) {", "originalCommit": "696ef3b13160df0f0a3478110f36873481ba6782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI1NzU4Ng==", "url": "https://github.com/apache/beam/pull/13166#discussion_r514257586", "bodyText": "I did try to pass in SerializableFunction but inner code of HadoopFormat does require input and output types for the function for validation, e.g. that input format value class does match translation function input class. I choose to stick with SimpleFunction but just allow to pass in the specific coder.", "author": "JozoVilcek", "createdAt": "2020-10-29T13:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NjM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "35d9b2ad710bb05731be87998705976ef37f120f", "chunk": "diff --git a/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java b/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\nindex 24e44285b6..864b2ca870 100644\n--- a/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\n+++ b/sdks/java/io/hadoop-format/src/main/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIO.java\n\n@@ -442,11 +435,13 @@ public class HadoopFormatIO {\n       return toBuilder()\n           .setKeyTranslationFunction(function)\n           .setKeyTypeDescriptor(function.getOutputTypeDescriptor())\n+          .setValueCoder(null)\n           .build();\n     }\n \n     /** Transforms the keys read from the source using the given key translation function. */\n     public Read<K, V> withKeyTranslation(SimpleFunction<?, K> function, Coder<K> coder) {\n+      checkArgument(function != null, \"function can not be null\");\n       checkArgument(coder != null, \"coder can not be null\");\n       return withKeyTranslation(function).toBuilder().setKeyCoder(coder).build();\n     }\n"}}, {"oid": "35d9b2ad710bb05731be87998705976ef37f120f", "url": "https://github.com/apache/beam/commit/35d9b2ad710bb05731be87998705976ef37f120f", "message": "[BEAM-11091] Allow reset back translation to not use coder", "committedDate": "2020-10-29T12:49:55Z", "type": "commit"}, {"oid": "875e90f2e9d03faac29ac9a09973ceaa230c3257", "url": "https://github.com/apache/beam/commit/875e90f2e9d03faac29ac9a09973ceaa230c3257", "message": "[BEAM-11091] Fix coder reset", "committedDate": "2020-10-29T13:45:14Z", "type": "commit"}, {"oid": "3f060fad8c8701e0eb07e2640edeccf7fb0b613d", "url": "https://github.com/apache/beam/commit/3f060fad8c8701e0eb07e2640edeccf7fb0b613d", "message": "[BEAM-11091] Fix checkstyle", "committedDate": "2020-10-29T16:14:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MDIzMQ==", "url": "https://github.com/apache/beam/pull/13166#discussion_r516840231", "bodyText": "nit: I guess the word Function is redundant here (like you called a similar key test testReadObjectCreationFailsIfKeyCoderIsNull )", "author": "aromanenko-dev", "createdAt": "2020-11-03T17:32:36Z", "path": "sdks/java/io/hadoop-format/src/test/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIOReadTest.java", "diffHunk": "@@ -229,6 +284,14 @@ public void testReadObjectCreationFailsIfValueTranslationFunctionIsNull() {\n     HadoopFormatIO.<Text, String>read().withConfiguration(serConf.get()).withValueTranslation(null);\n   }\n \n+  @Test\n+  public void testReadObjectCreationFailsIfValueCoderFunctionIsNull() {", "originalCommit": "3f060fad8c8701e0eb07e2640edeccf7fb0b613d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyNTQ0NA==", "url": "https://github.com/apache/beam/pull/13166#discussion_r516925444", "bodyText": "I agree. Improved by next commit", "author": "JozoVilcek", "createdAt": "2020-11-03T20:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MDIzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "21b3a701155b72971a8e5edd30e58d8ef6cf4bba", "chunk": "diff --git a/sdks/java/io/hadoop-format/src/test/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIOReadTest.java b/sdks/java/io/hadoop-format/src/test/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIOReadTest.java\nindex cbc615eb3e..7c30ef3b23 100644\n--- a/sdks/java/io/hadoop-format/src/test/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIOReadTest.java\n+++ b/sdks/java/io/hadoop-format/src/test/java/org/apache/beam/sdk/io/hadoop/format/HadoopFormatIOReadTest.java\n\n@@ -285,7 +285,7 @@ public class HadoopFormatIOReadTest {\n   }\n \n   @Test\n-  public void testReadObjectCreationFailsIfValueCoderFunctionIsNull() {\n+  public void testReadObjectCreationFailsIfValueCoderIsNull() {\n     thrown.expect(IllegalArgumentException.class);\n     HadoopFormatIO.<Text, String>read()\n         .withConfiguration(serConf.get())\n"}}, {"oid": "21b3a701155b72971a8e5edd30e58d8ef6cf4bba", "url": "https://github.com/apache/beam/commit/21b3a701155b72971a8e5edd30e58d8ef6cf4bba", "message": "[BEAM-11091] Improve test case name", "committedDate": "2020-11-03T20:00:48Z", "type": "commit"}]}