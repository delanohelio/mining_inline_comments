{"pr_number": 13588, "pr_title": "[BEAM-11533] Add logic to convert Beam schema to DataCatalog schema to SchemaUtils", "pr_createdAt": "2020-12-21T21:11:11Z", "pr_url": "https://github.com/apache/beam/pull/13588", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk3MTMwMQ==", "url": "https://github.com/apache/beam/pull/13588#discussion_r546971301", "bodyText": "Rather than making these functions public so our internal code can use them, could we try to move the internal code into Beam? I think it should be possible to move it into DataCatalogTableProvider", "author": "TheNeuralBit", "createdAt": "2020-12-21T22:55:14Z", "path": "sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java", "diffHunk": "@@ -53,7 +53,7 @@\n           .build();\n \n   /** Convert DataCatalog schema to Beam schema. */\n-  static Schema fromDataCatalog(com.google.cloud.datacatalog.v1beta1.Schema dcSchema) {\n+  public static Schema fromDataCatalog(com.google.cloud.datacatalog.v1beta1.Schema dcSchema) {", "originalCommit": "d56041e6c43db954810f76d605adb10e96cd3622", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUxNDU3NA==", "url": "https://github.com/apache/beam/pull/13588#discussion_r549514574", "bodyText": "Done. PTAL.", "author": "robinyqiu", "createdAt": "2020-12-28T23:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk3MTMwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "50eb4fc7f16a49b742f8ab77e79cd6f0d98bada6", "chunk": "diff --git a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\nindex e6c30f4b6b..3739512ae0 100644\n--- a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n+++ b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n\n@@ -53,7 +57,7 @@ class SchemaUtils {\n           .build();\n \n   /** Convert DataCatalog schema to Beam schema. */\n-  public static Schema fromDataCatalog(com.google.cloud.datacatalog.v1beta1.Schema dcSchema) {\n+  static Schema fromDataCatalog(com.google.cloud.datacatalog.v1beta1.Schema dcSchema) {\n     return fromColumnsList(dcSchema.getColumnsList());\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk3MTgyNw==", "url": "https://github.com/apache/beam/pull/13588#discussion_r546971827", "bodyText": "Could you add unit tests that convert to/from data catalog types?", "author": "TheNeuralBit", "createdAt": "2020-12-21T22:56:14Z", "path": "sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java", "diffHunk": "@@ -98,4 +98,91 @@ private static FieldType getBeamFieldType(ColumnSchema column) {\n     throw new UnsupportedOperationException(\n         \"Field type '\" + dcFieldType + \"' is not supported (field '\" + column.getColumn() + \"')\");\n   }\n+\n+  /** Convert Beam schema to DataCatalog schema. */\n+  public static com.google.cloud.datacatalog.v1beta1.Schema toDataCatalog(Schema schema) {\n+    com.google.cloud.datacatalog.v1beta1.Schema.Builder schemaBuilder =\n+        com.google.cloud.datacatalog.v1beta1.Schema.newBuilder();\n+    for (Schema.Field field : schema.getFields()) {\n+      schemaBuilder.addColumns(fromBeamField(field));\n+    }\n+    return schemaBuilder.build();\n+  }\n+\n+  private static ColumnSchema fromBeamField(Schema.Field field) {\n+    Schema.FieldType fieldType = field.getType();\n+    if (fieldType.getTypeName().equals(Schema.TypeName.ARRAY)) {\n+      if (fieldType.getNullable()) {\n+        throw new UnsupportedOperationException(\n+            \"Nullable array type is not supported in DataCatalog schemas: \" + fieldType);\n+      } else if (fieldType.getCollectionElementType().getNullable()) {\n+        throw new UnsupportedOperationException(\n+            \"Nullable array element type is not supported in DataCatalog schemas: \" + fieldType);\n+      } else if (fieldType.getCollectionElementType().getTypeName().equals(Schema.TypeName.ARRAY)) {\n+        throw new UnsupportedOperationException(\n+            \"Array of arrays not supported in DataCatalog schemas: \" + fieldType);\n+      }\n+      ColumnSchema column =\n+          fromBeamField(Field.of(field.getName(), fieldType.getCollectionElementType()));\n+      if (!column.getMode().isEmpty()) {\n+        // We should have bailed out earlier for any cases that would result in mode being set.\n+        throw new AssertionError(\n+            \"ColumnSchema for collection element type has non-empty mode: \" + fieldType);\n+      }\n+      return column.toBuilder().setMode(\"REPEATED\").build();\n+    } else { // struct or primitive type\n+      ColumnSchema.Builder colBuilder =\n+          ColumnSchema.newBuilder().setType(getDataCatalogType(fieldType));\n+\n+      if (fieldType.getNullable()) {\n+        colBuilder.setMode(\"NULLABLE\");\n+      }\n+\n+      // if this is a struct, add the child columns\n+      if (fieldType.getTypeName().equals(Schema.TypeName.ROW)) {\n+        for (Schema.Field subField : fieldType.getRowSchema().getFields()) {\n+          colBuilder.addSubcolumns(fromBeamField(subField));\n+        }\n+      }\n+\n+      return colBuilder.setColumn(field.getName()).build();\n+    }\n+  }\n+\n+  private static String getDataCatalogType(FieldType fieldType) {\n+    switch (fieldType.getTypeName()) {\n+      case INT32:\n+      case INT64:\n+      case BYTES:\n+      case DOUBLE:\n+      case STRING:\n+        return fieldType.getTypeName().name();\n+      case BOOLEAN:\n+        return \"BOOL\";\n+      case DATETIME:\n+        return \"TIMESTAMP\";\n+      case DECIMAL:\n+        return \"NUMERIC\";\n+      case LOGICAL_TYPE:\n+        Schema.LogicalType logical = fieldType.getLogicalType();\n+        if (SqlTypes.TIME.getIdentifier().equals(logical.getIdentifier())) {\n+          return \"TIME\";\n+        } else if (SqlTypes.DATE.getIdentifier().equals(logical.getIdentifier())) {\n+          return \"DATE\";\n+        } else if (SqlTypes.DATETIME.getIdentifier().equals(logical.getIdentifier())) {\n+          return \"DATETIME\";\n+        } else {\n+          throw new UnsupportedOperationException(\"Unsupported logical type: \" + logical);\n+        }\n+      case ROW:\n+        return \"STRUCT\";\n+      case MAP:\n+        return String.format(\n+            \"MAP<%s,%s>\",\n+            getDataCatalogType(fieldType.getMapKeyType()),\n+            getDataCatalogType(fieldType.getMapValueType()));\n+      default:\n+        throw new UnsupportedOperationException(\"Unsupported type: \" + fieldType);\n+    }\n+  }", "originalCommit": "d56041e6c43db954810f76d605adb10e96cd3622", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg4MjkxMA==", "url": "https://github.com/apache/beam/pull/13588#discussion_r549882910", "bodyText": "Tests added. While implementing the test I found a inconsistency in our implementation:\n\nIn fromDataCatalog we treat a DC field without any mode set as NULLABLE\nIn toDataCatalog we do not set any mode for a Beam field whose getNullable returns false, where I think we should set REQUIRED (fixed in the last commit, PTAL)", "author": "robinyqiu", "createdAt": "2020-12-29T23:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk3MTgyNw=="}], "type": "inlineReview", "revised_code": {"commit": "50eb4fc7f16a49b742f8ab77e79cd6f0d98bada6", "chunk": "diff --git a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\nindex e6c30f4b6b..3739512ae0 100644\n--- a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n+++ b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n\n@@ -100,7 +104,7 @@ class SchemaUtils {\n   }\n \n   /** Convert Beam schema to DataCatalog schema. */\n-  public static com.google.cloud.datacatalog.v1beta1.Schema toDataCatalog(Schema schema) {\n+  static com.google.cloud.datacatalog.v1beta1.Schema toDataCatalog(Schema schema) {\n     com.google.cloud.datacatalog.v1beta1.Schema.Builder schemaBuilder =\n         com.google.cloud.datacatalog.v1beta1.Schema.newBuilder();\n     for (Schema.Field field : schema.getFields()) {\n"}}, {"oid": "a4d6d99c0ed8709a8d481304265a7cbcfe9da794", "url": "https://github.com/apache/beam/commit/a4d6d99c0ed8709a8d481304265a7cbcfe9da794", "message": "Add logic to convert Beam schema to DataCatalog schema to SchemaUtils.java", "committedDate": "2020-12-21T23:25:00Z", "type": "commit"}, {"oid": "a4d6d99c0ed8709a8d481304265a7cbcfe9da794", "url": "https://github.com/apache/beam/commit/a4d6d99c0ed8709a8d481304265a7cbcfe9da794", "message": "Add logic to convert Beam schema to DataCatalog schema to SchemaUtils.java", "committedDate": "2020-12-21T23:25:00Z", "type": "forcePushed"}, {"oid": "50eb4fc7f16a49b742f8ab77e79cd6f0d98bada6", "url": "https://github.com/apache/beam/commit/50eb4fc7f16a49b742f8ab77e79cd6f0d98bada6", "message": "Move more internal code to DataCatalogTableProvider", "committedDate": "2020-12-28T23:17:44Z", "type": "forcePushed"}, {"oid": "e22abe994db3310ade53cb9131297383d6f66317", "url": "https://github.com/apache/beam/commit/e22abe994db3310ade53cb9131297383d6f66317", "message": "Move more internal code to DataCatalogTableProvider", "committedDate": "2020-12-28T23:30:24Z", "type": "commit"}, {"oid": "e22abe994db3310ade53cb9131297383d6f66317", "url": "https://github.com/apache/beam/commit/e22abe994db3310ade53cb9131297383d6f66317", "message": "Move more internal code to DataCatalogTableProvider", "committedDate": "2020-12-28T23:30:24Z", "type": "forcePushed"}, {"oid": "dde1023c1569ce6ecff0e20a65b33dc721d577a5", "url": "https://github.com/apache/beam/commit/dde1023c1569ce6ecff0e20a65b33dc721d577a5", "message": "Add unit tests and set REQUIRED mode for non-null field", "committedDate": "2020-12-29T23:07:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwMDg3OQ==", "url": "https://github.com/apache/beam/pull/13588#discussion_r549900879", "bodyText": "This really shouldn't be public either, it would be best if this functionality was exposed through the existing public API (probably DataCatalogTableProvider.createTable). If you'd rather just keep this as-is for now, lets mark this function @Internal so Beam users don't expect backwards compatibility.", "author": "TheNeuralBit", "createdAt": "2020-12-30T00:57:24Z", "path": "sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/DataCatalogTableProvider.java", "diffHunk": "@@ -178,6 +214,23 @@ private Table toCalciteTable(String tableName, Entry entry) {\n     return tableBuilder.get().schema(schema).name(tableName).build();\n   }\n \n+  public boolean setSchemaIfNotPresent(String resource, Schema schema) {", "originalCommit": "e22abe994db3310ade53cb9131297383d6f66317", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyMTkyMg==", "url": "https://github.com/apache/beam/pull/13588#discussion_r550321922", "bodyText": "Done.", "author": "robinyqiu", "createdAt": "2020-12-30T20:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwMDg3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d7b9c61f1c4f69593394421a5113d14f47d0b96a", "chunk": "diff --git a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/DataCatalogTableProvider.java b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/DataCatalogTableProvider.java\nindex 411c52960a..0105ab6b84 100644\n--- a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/DataCatalogTableProvider.java\n+++ b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/DataCatalogTableProvider.java\n\n@@ -214,6 +215,7 @@ public class DataCatalogTableProvider extends FullNameTableProvider implements A\n     return tableBuilder.get().schema(schema).name(tableName).build();\n   }\n \n+  @Internal\n   public boolean setSchemaIfNotPresent(String resource, Schema schema) {\n     com.google.cloud.datacatalog.v1beta1.Schema dcSchema = SchemaUtils.toDataCatalog(schema);\n     Entry entry =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwMTYwMw==", "url": "https://github.com/apache/beam/pull/13588#discussion_r549901603", "bodyText": "This assertion could still be there and change to column.getMode().equals(\"REQUIRED\")", "author": "TheNeuralBit", "createdAt": "2020-12-30T01:03:07Z", "path": "sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java", "diffHunk": "@@ -128,18 +128,15 @@ private static ColumnSchema fromBeamField(Schema.Field field) {\n       }\n       ColumnSchema column =\n           fromBeamField(Field.of(field.getName(), fieldType.getCollectionElementType()));\n-      if (!column.getMode().isEmpty()) {", "originalCommit": "dde1023c1569ce6ecff0e20a65b33dc721d577a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyMTkwOA==", "url": "https://github.com/apache/beam/pull/13588#discussion_r550321908", "bodyText": "Done.\nI think this check is redundant for now because the only place that sets mode is the else branch below that the array element check will surely enter, because we already checked array element is not ARRAY type. And we have also checked the array element is not nullable above so it is always REQUIRED. But I agree leaving this check here can prevent code change that breaks this in the future.", "author": "robinyqiu", "createdAt": "2020-12-30T20:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwMTYwMw=="}], "type": "inlineReview", "revised_code": {"commit": "d7b9c61f1c4f69593394421a5113d14f47d0b96a", "chunk": "diff --git a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\nindex 85fcf567c0..1ee0847bf5 100644\n--- a/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n+++ b/sdks/java/extensions/sql/datacatalog/src/main/java/org/apache/beam/sdk/extensions/sql/meta/provider/datacatalog/SchemaUtils.java\n\n@@ -128,6 +128,11 @@ class SchemaUtils {\n       }\n       ColumnSchema column =\n           fromBeamField(Field.of(field.getName(), fieldType.getCollectionElementType()));\n+      if (!column.getMode().equals(\"REQUIRED\")) {\n+        // We should have bailed out earlier for any cases that would result in mode being set.\n+        throw new AssertionError(\n+            \"ColumnSchema for collection element type has non-empty mode: \" + fieldType);\n+      }\n       return column.toBuilder().setMode(\"REPEATED\").build();\n     } else { // struct or primitive type\n       ColumnSchema.Builder colBuilder =\n"}}, {"oid": "d7b9c61f1c4f69593394421a5113d14f47d0b96a", "url": "https://github.com/apache/beam/commit/d7b9c61f1c4f69593394421a5113d14f47d0b96a", "message": "Address comments", "committedDate": "2020-12-30T20:43:49Z", "type": "commit"}]}