{"pr_number": 12063, "pr_title": "[BEAM-10294] using SparkMetricsContainerStepMap for readable metrics presentation in Spark history server UI", "pr_createdAt": "2020-06-23T08:58:24Z", "pr_url": "https://github.com/apache/beam/pull/12063", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3MTgxOQ==", "url": "https://github.com/apache/beam/pull/12063#discussion_r444071819", "bodyText": "I'm not sure about this - whether it's backward compatible", "author": "davidak09", "createdAt": "2020-06-23T08:59:45Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java", "diffHunk": "@@ -87,13 +86,13 @@ public static MetricsContainerStepMapAccumulator getInstance() {\n     }\n   }\n \n-  private static Optional<MetricsContainerStepMap> recoverValueFromCheckpoint(\n+  private static Optional<SparkMetricsContainerStepMap> recoverValueFromCheckpoint(\n       JavaSparkContext jsc, CheckpointDir checkpointDir) {\n     try {\n       Path beamCheckpointPath = checkpointDir.getBeamCheckpointDir();\n       checkpointFilePath = new Path(beamCheckpointPath, ACCUMULATOR_CHECKPOINT_FILENAME);\n       fileSystem = checkpointFilePath.getFileSystem(jsc.hadoopConfiguration());\n-      MetricsContainerStepMap recoveredValue =\n+      SparkMetricsContainerStepMap recoveredValue =", "originalCommit": "cc731cfb084c27b11449042223223753afd39758", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "chunk": "diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\nindex f36c5260c7..8cc3c7dddb 100644\n--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\n+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\n\n@@ -86,7 +87,7 @@ public class MetricsAccumulator {\n     }\n   }\n \n-  private static Optional<SparkMetricsContainerStepMap> recoverValueFromCheckpoint(\n+  private static Optional<MetricsContainerStepMap> recoverValueFromCheckpoint(\n       JavaSparkContext jsc, CheckpointDir checkpointDir) {\n     try {\n       Path beamCheckpointPath = checkpointDir.getBeamCheckpointDir();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NDI3MA==", "url": "https://github.com/apache/beam/pull/12063#discussion_r444074270", "bodyText": "I'd personally prefer single metric, possibly with .distribution suffix, which could include all 5 stats (count, sum, min, max, mean), it would definitely be more readable in Spark UI", "author": "davidak09", "createdAt": "2020-06-23T09:03:30Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkBeamMetric.java", "diffHunk": "@@ -51,11 +51,12 @@\n     }\n     for (MetricResult<DistributionResult> metricResult : metricQueryResults.getDistributions()) {\n       DistributionResult result = metricResult.getAttempted();\n-      metrics.put(renderName(metricResult) + \".count\", result.getCount());\n-      metrics.put(renderName(metricResult) + \".sum\", result.getSum());\n-      metrics.put(renderName(metricResult) + \".min\", result.getMin());\n-      metrics.put(renderName(metricResult) + \".max\", result.getMax());\n-      metrics.put(renderName(metricResult) + \".mean\", result.getMean());\n+      String name = renderName(metricResult);\n+      metrics.put(name + \".count\", result.getCount());\n+      metrics.put(name + \".sum\", result.getSum());\n+      metrics.put(name + \".min\", result.getMin());\n+      metrics.put(name + \".max\", result.getMax());\n+      metrics.put(name + \".mean\", result.getMean());", "originalCommit": "cc731cfb084c27b11449042223223753afd39758", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "chunk": "diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkBeamMetric.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkBeamMetric.java\nindex 345f78fb09..c43bb095e5 100644\n--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkBeamMetric.java\n+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkBeamMetric.java\n\n@@ -51,12 +51,11 @@ class SparkBeamMetric implements Metric {\n     }\n     for (MetricResult<DistributionResult> metricResult : metricQueryResults.getDistributions()) {\n       DistributionResult result = metricResult.getAttempted();\n-      String name = renderName(metricResult);\n-      metrics.put(name + \".count\", result.getCount());\n-      metrics.put(name + \".sum\", result.getSum());\n-      metrics.put(name + \".min\", result.getMin());\n-      metrics.put(name + \".max\", result.getMax());\n-      metrics.put(name + \".mean\", result.getMean());\n+      metrics.put(renderName(metricResult) + \".count\", result.getCount());\n+      metrics.put(renderName(metricResult) + \".sum\", result.getSum());\n+      metrics.put(renderName(metricResult) + \".min\", result.getMin());\n+      metrics.put(renderName(metricResult) + \".max\", result.getMax());\n+      metrics.put(renderName(metricResult) + \".mean\", result.getMean());\n     }\n     for (MetricResult<GaugeResult> metricResult : metricQueryResults.getGauges()) {\n       metrics.put(renderName(metricResult), metricResult.getAttempted().getValue());\n"}}, {"oid": "c5cd601c445b4d1443d5569c9272c866d7a9eb99", "url": "https://github.com/apache/beam/commit/c5cd601c445b4d1443d5569c9272c866d7a9eb99", "message": "[BEAM-10294] fixed SparkMetricsContainerStepMap class visibility", "committedDate": "2020-06-25T11:35:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDE0Nw==", "url": "https://github.com/apache/beam/pull/12063#discussion_r449044147", "bodyText": "Won't it be enough to just create new instance of SparkMetricsContainerStepMap here but keep the same interface of MetricsContainerStepMap everywhere as it was before get broken? Why do we need to change it everywhere since SparkMetricsContainerStepMap  just overrides toString()?\nAlso, it would be great to add a regression test for this fix.", "author": "aromanenko-dev", "createdAt": "2020-07-02T14:30:01Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java", "diffHunk": "@@ -58,13 +57,13 @@ public static void init(SparkPipelineOptions opts, JavaSparkContext jsc) {\n               opts.isStreaming()\n                   ? Optional.of(new CheckpointDir(opts.getCheckpointDir()))\n                   : Optional.absent();\n-          MetricsContainerStepMap metricsContainerStepMap = new MetricsContainerStepMap();\n+          SparkMetricsContainerStepMap metricsContainerStepMap = new SparkMetricsContainerStepMap();", "originalCommit": "c5cd601c445b4d1443d5569c9272c866d7a9eb99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxNjYwNA==", "url": "https://github.com/apache/beam/pull/12063#discussion_r452816604", "bodyText": "You're right, it's enough to change it just in initialization. I fixed it.\nI will try to add a regression test.", "author": "davidak09", "createdAt": "2020-07-10T12:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "chunk": "diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\nindex f36c5260c7..8cc3c7dddb 100644\n--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\n+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/MetricsAccumulator.java\n\n@@ -57,13 +58,13 @@ public class MetricsAccumulator {\n               opts.isStreaming()\n                   ? Optional.of(new CheckpointDir(opts.getCheckpointDir()))\n                   : Optional.absent();\n-          SparkMetricsContainerStepMap metricsContainerStepMap = new SparkMetricsContainerStepMap();\n+          MetricsContainerStepMap metricsContainerStepMap = new SparkMetricsContainerStepMap();\n           MetricsContainerStepMapAccumulator accumulator =\n               new MetricsContainerStepMapAccumulator(metricsContainerStepMap);\n           jsc.sc().register(accumulator, ACCUMULATOR_NAME);\n \n           if (maybeCheckpointDir.isPresent()) {\n-            Optional<SparkMetricsContainerStepMap> maybeRecoveredValue =\n+            Optional<MetricsContainerStepMap> maybeRecoveredValue =\n                 recoverValueFromCheckpoint(jsc, maybeCheckpointDir.get());\n             if (maybeRecoveredValue.isPresent()) {\n               accumulator = new MetricsContainerStepMapAccumulator(maybeRecoveredValue.get());\n"}}, {"oid": "c85534e630e6f1dbfc859f755ba109198ba55c08", "url": "https://github.com/apache/beam/commit/c85534e630e6f1dbfc859f755ba109198ba55c08", "message": "[BEAM-10294] using SparkMetricsContainerStepMap for readable metrics presentation in Spark history server UI", "committedDate": "2020-07-10T08:42:07Z", "type": "commit"}, {"oid": "f1949c1319aad47074f12c8e9000a145cddaa182", "url": "https://github.com/apache/beam/commit/f1949c1319aad47074f12c8e9000a145cddaa182", "message": "[BEAM-10294] fixed SparkMetricsContainerStepMap class visibility", "committedDate": "2020-07-10T08:42:07Z", "type": "commit"}, {"oid": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "url": "https://github.com/apache/beam/commit/68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "message": "[BEAM-10294] using SparkMetricsContainerStepMap only where needed", "committedDate": "2020-07-10T12:35:12Z", "type": "commit"}, {"oid": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "url": "https://github.com/apache/beam/commit/68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "message": "[BEAM-10294] using SparkMetricsContainerStepMap only where needed", "committedDate": "2020-07-10T12:35:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw==", "url": "https://github.com/apache/beam/pull/12063#discussion_r452823257", "bodyText": "We ran our application built with Beam 2.18.0 and the metrics are displayed correctly, with this fix Spark displays the same results.\nThe change that broke things up for Spark was part of BEAM-9600 - #11369 .", "author": "davidak09", "createdAt": "2020-07-10T12:51:58Z", "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/metrics/SparkMetricsContainerStepMap.java", "diffHunk": "@@ -27,7 +27,7 @@\n \n   @Override\n   public String toString() {\n-    return new SparkBeamMetric().renderAll().toString();\n+    return asAttemptedOnlyMetricResults(this).toString();", "originalCommit": "68dcc0beb7d46b457947374bb786a24dfa9d2cbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0MjA5NQ==", "url": "https://github.com/apache/beam/pull/12063#discussion_r457442095", "bodyText": "@ibzib fyi", "author": "aromanenko-dev", "createdAt": "2020-07-20T14:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0NDc2Ng==", "url": "https://github.com/apache/beam/pull/12063#discussion_r457644766", "bodyText": "Thanks for the heads up. My assumption in #11369 was that the result was meant to be consumed by code, not humans. After this change, metrics would remain not too readable for Flink. Ideally we could find a way to make the Flink metrics protos available to the Python client without toString, since toString should generally should be human-readable. The problem is that without a job server, there's nowhere to access job information like metrics outside of what Flink provides natively.", "author": "ibzib", "createdAt": "2020-07-20T19:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3MzAyNw==", "url": "https://github.com/apache/beam/pull/12063#discussion_r458073027", "bodyText": "@ibzib Thanks for details. I agree that we should not rely on toString() when it's going to be used by other program.\nI'm sorry but I'm not sure that I fully understand your last sentence - does it seem that it's only specific Flink-related issue?\nRegarding readable Flink metrics - would it be better to fix it on FlinkRunner side, like we do with SparkMetricsContainerStepMap for Spark Runner?", "author": "aromanenko-dev", "createdAt": "2020-07-21T12:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MzAxOA==", "url": "https://github.com/apache/beam/pull/12063#discussion_r458263018", "bodyText": "There are two ways of running Beam Python Flink/Spark. One way involves starting a Java job server, the other (newer) way does not require a Java job server and instead uses only Python. When using a Java job server, it's easy to get metrics, since the job server has access to the Flink/Spark context object. But in Python, we rely on the Flink REST API to get metrics, so the formatting of the results displayed there is important.\nThe reason metrics formatting isn't a problem for Spark is that spark_uber_jar_job_server.py just doesn't implement get_metrics yet.\nThe problem is that if we want to make MetricsContainerStepMap::toString human-readable, we'll need to make the protobuf-formatted metrics accessible somewhere else.\nPerhaps there is a compromise though if we can somehow format metrics so they are readable both by the proto parser and humans.", "author": "ibzib", "createdAt": "2020-07-21T17:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzNDQzMQ==", "url": "https://github.com/apache/beam/pull/12063#discussion_r460134431", "bodyText": "@ibzib Thanks for more details. I see the picture bit still not convinced why MetricsContainerStepMap::toString  is used for REST API (if I get it right) - dedicated way  to make the protobuf-formatted metrics accessible, as you said, should be better imho.\nAre you ok to merge this fix for Spark Runner metrics?", "author": "aromanenko-dev", "createdAt": "2020-07-24T15:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTgwMA==", "url": "https://github.com/apache/beam/pull/12063#discussion_r460179800", "bodyText": "@ibzib Thanks for more details. I see the picture bit still not convinced why MetricsContainerStepMap::toString is used for REST API (if I get it right) - dedicated way to make the protobuf-formatted metrics accessible, as you said, should be better imho.\n\nThe reason I used toString is because the Flink REST API displays accumulator values using toString. I simply wasn't able to come up with a dedicated way to make the protobuf-formatted metrics accessible.\n\nAre you ok to merge this fix for Spark Runner metrics?\n\nYes, this is fine for now. I might need to give Flink runner metrics another look to fix the equivalent problem there.", "author": "ibzib", "createdAt": "2020-07-24T17:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMzI1Nw=="}], "type": "inlineReview", "revised_code": null}]}