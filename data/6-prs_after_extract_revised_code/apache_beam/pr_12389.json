{"pr_number": 12389, "pr_title": "[BEAM-10587] Support Maps in BigQuery", "pr_createdAt": "2020-07-28T09:35:28Z", "pr_url": "https://github.com/apache/beam/pull/12389", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NTYxOA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r461975618", "bodyText": "I believe the type you want here is TableRow.", "author": "apilloud", "createdAt": "2020-07-29T00:53:28Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -442,6 +450,17 @@ private static Object fromBeamField(FieldType fieldType, Object fieldValue) {\n         }\n         return convertedItems;\n \n+      case MAP:\n+        Map<?, ?> pairs = (Map<?, ?>) fieldValue;\n+        convertedItems = Lists.newArrayListWithCapacity(pairs.size());\n+        for (Map.Entry<?, ?> pair : pairs.entrySet()) {\n+          HashMap<String, Object> item = new HashMap<>(2);", "originalCommit": "3bbf390c0d344a170e604ec140211cf09a5d2c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwNjU3Mw==", "url": "https://github.com/apache/beam/pull/12389#discussion_r462906573", "bodyText": "Ok, I will return a List of TableRows instead of Maps.", "author": "rworley-monster", "createdAt": "2020-07-30T10:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NTYxOA=="}], "type": "inlineReview", "revised_code": {"commit": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\nindex 1f60dfb348..15774193ce 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n\n@@ -443,8 +441,8 @@ public class BigQueryUtils {\n       case ARRAY:\n       case ITERABLE:\n         FieldType elementType = fieldType.getCollectionElementType();\n-        Iterable items = (Iterable) fieldValue;\n-        List convertedItems = Lists.newArrayListWithCapacity(Iterables.size(items));\n+        Iterable<?> items = (Iterable<?>) fieldValue;\n+        List<Object> convertedItems = Lists.newArrayListWithCapacity(Iterables.size(items));\n         for (Object item : items) {\n           convertedItems.add(fromBeamField(elementType, item));\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0MzExOA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r470743118", "bodyText": "You'll need to convert the types stored in the map as well. Something like fromBeamField(fieldType.getMapKeyType(), pair.getKey())", "author": "apilloud", "createdAt": "2020-08-14T16:57:43Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -443,6 +467,17 @@ public static TableRow toTableRow(Row row) {\n         }\n         return convertedItems;\n \n+      case MAP:\n+        Map<?, ?> pairs = (Map<?, ?>) fieldValue;\n+        convertedItems = Lists.newArrayListWithCapacity(pairs.size());\n+        for (Map.Entry<?, ?> pair : pairs.entrySet()) {\n+          convertedItems.add(\n+              new TableRow()\n+                  .set(BIGQUERY_MAP_KEY_FIELD_NAME, pair.getKey())", "originalCommit": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1OTE2OA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r471559168", "bodyText": "Nice catch.  I've updated it with that and tried to copy the above ITERABLE conversion as closely as possible.", "author": "rworley-monster", "createdAt": "2020-08-17T15:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0MzExOA=="}], "type": "inlineReview", "revised_code": {"commit": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\nindex 23c9e35833..15774193ce 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n\n@@ -471,10 +452,10 @@ public class BigQueryUtils {\n         Map<?, ?> pairs = (Map<?, ?>) fieldValue;\n         convertedItems = Lists.newArrayListWithCapacity(pairs.size());\n         for (Map.Entry<?, ?> pair : pairs.entrySet()) {\n-          convertedItems.add(\n-              new TableRow()\n-                  .set(BIGQUERY_MAP_KEY_FIELD_NAME, pair.getKey())\n-                  .set(BIGQUERY_MAP_VALUE_FIELD_NAME, pair.getValue()));\n+          HashMap<String, Object> item = new HashMap<>(2);\n+          item.put(\"key\", pair.getKey());\n+          item.put(\"value\", pair.getValue());\n+          convertedItems.add(item);\n         }\n         return convertedItems;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0OTkyOA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r470749928", "bodyText": "nit: The name might be a little confusing, this isn't actually converting an Avro Map type. Something like convertAvroRecordToMap might reduce that risk.", "author": "apilloud", "createdAt": "2020-08-14T17:11:18Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -679,6 +714,20 @@ private static Object convertAvroArray(\n     return ret;\n   }\n \n+  private static Object convertAvroMap(", "originalCommit": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MDE0Ng==", "url": "https://github.com/apache/beam/pull/12389#discussion_r471560146", "bodyText": "Agreed, that's a more accurate name and I have updated it to that.", "author": "rworley-monster", "createdAt": "2020-08-17T15:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0OTkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\nindex 23c9e35833..15774193ce 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n\n@@ -714,20 +695,6 @@ public class BigQueryUtils {\n     return ret;\n   }\n \n-  private static Object convertAvroMap(\n-      FieldType beamField, Object value, BigQueryUtils.ConversionOptions options) {\n-    List<GenericData.Record> records = (List<GenericData.Record>) value;\n-    HashMap<Object, Object> ret = new HashMap<>();\n-    FieldType keyElement = beamField.getMapKeyType();\n-    FieldType valueElement = beamField.getMapValueType();\n-    for (GenericData.Record record : records) {\n-      ret.put(\n-          convertAvroFormat(keyElement, record.get(0), options),\n-          convertAvroFormat(valueElement, record.get(1), options));\n-    }\n-    return ret;\n-  }\n-\n   private static Object convertAvroPrimitiveTypes(TypeName beamType, Object value) {\n     switch (beamType) {\n       case BYTE:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1MjAyOA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r470752028", "bodyText": "We prefer to use ImmutableMap when possible, there are examples in this file.", "author": "apilloud", "createdAt": "2020-08-14T17:15:14Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -679,6 +714,20 @@ private static Object convertAvroArray(\n     return ret;\n   }\n \n+  private static Object convertAvroMap(\n+      FieldType beamField, Object value, BigQueryUtils.ConversionOptions options) {\n+    List<GenericData.Record> records = (List<GenericData.Record>) value;\n+    HashMap<Object, Object> ret = new HashMap<>();", "originalCommit": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MDg5Nw==", "url": "https://github.com/apache/beam/pull/12389#discussion_r471560897", "bodyText": "Sure, I updated it to use ImmutableMap instead.", "author": "rworley-monster", "createdAt": "2020-08-17T15:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1MjAyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\nindex 23c9e35833..15774193ce 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n\n@@ -714,20 +695,6 @@ public class BigQueryUtils {\n     return ret;\n   }\n \n-  private static Object convertAvroMap(\n-      FieldType beamField, Object value, BigQueryUtils.ConversionOptions options) {\n-    List<GenericData.Record> records = (List<GenericData.Record>) value;\n-    HashMap<Object, Object> ret = new HashMap<>();\n-    FieldType keyElement = beamField.getMapKeyType();\n-    FieldType valueElement = beamField.getMapValueType();\n-    for (GenericData.Record record : records) {\n-      ret.put(\n-          convertAvroFormat(keyElement, record.get(0), options),\n-          convertAvroFormat(valueElement, record.get(1), options));\n-    }\n-    return ret;\n-  }\n-\n   private static Object convertAvroPrimitiveTypes(TypeName beamType, Object value) {\n     switch (beamType) {\n       case BYTE:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1NjAzNA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r470756034", "bodyText": "This is something that is going to need more discussion. I have two concerns:\n\nThe ZetaSQL dialect doesn't support map types, so this will break that use case.\nThe user might have a row matching this struct that isn't suppose to be a map.", "author": "apilloud", "createdAt": "2020-08-14T17:23:36Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -263,6 +267,18 @@ private static FieldType fromTableFieldSchemaType(\n                 \"SqlTimestampWithLocalTzType\", FieldType.STRING, \"\", FieldType.DATETIME) {});\n       case \"STRUCT\":\n       case \"RECORD\":\n+        // check if record represents a map entry", "originalCommit": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5OTI3MA==", "url": "https://github.com/apache/beam/pull/12389#discussion_r471599270", "bodyText": "Regarding the second concern, I wonder if a user with a { \"key\", \"value\" } struct would always be satisfied to work with the field as a Map in Beam.  If not, then I suppose we would need to somehow tag the field schema with a marker that a user would not reasonably collide with.  The options I see are:\n\nField names (could be something like \"beam_key\" or \"map_key\").  Personally, I'm not a fan of affecting schema names like this.\nExtra field (in addition to \"key\" and \"value\"), could be something like \"beam_map\" with all true or null values.  Similarly messy like above.\nTag in field description(s) with a warning for the user to not delete it.  Might be something like #beam-map-do-not-delete#.\n\nThough these options require that the fields are created via Beam and not by the user beforehand.  Or the user would need to know to use these special markers to enable the Beam map functionality.", "author": "rworley-monster", "createdAt": "2020-08-17T16:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1NjAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "chunk": "diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\nindex 23c9e35833..15774193ce 100644\n--- a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java\n\n@@ -267,18 +264,6 @@ public class BigQueryUtils {\n                 \"SqlTimestampWithLocalTzType\", FieldType.STRING, \"\", FieldType.DATETIME) {});\n       case \"STRUCT\":\n       case \"RECORD\":\n-        // check if record represents a map entry\n-        if (nestedFields.size() == 2) {\n-          TableFieldSchema key = nestedFields.get(0);\n-          TableFieldSchema value = nestedFields.get(1);\n-          if (BIGQUERY_MAP_KEY_FIELD_NAME.equals(key.getName())\n-              && BIGQUERY_MAP_VALUE_FIELD_NAME.equals(value.getName())) {\n-            return FieldType.map(\n-                fromTableFieldSchemaType(key.getType(), key.getFields()),\n-                fromTableFieldSchemaType(value.getType(), value.getFields()));\n-          }\n-        }\n-\n         Schema rowSchema = fromTableFieldSchema(nestedFields);\n         return FieldType.row(rowSchema);\n       default:\n"}}, {"oid": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "url": "https://github.com/apache/beam/commit/c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "message": "[BEAM-10587] Support Maps in BigQuery", "committedDate": "2020-08-17T15:27:15Z", "type": "commit"}, {"oid": "3c09006b2740f96d6549d89d3a5473dbd8b252b2", "url": "https://github.com/apache/beam/commit/3c09006b2740f96d6549d89d3a5473dbd8b252b2", "message": "Fix builder formatting", "committedDate": "2020-08-17T15:27:15Z", "type": "commit"}, {"oid": "9b620fc57fe2beabbe75319a2affdfd4df59f900", "url": "https://github.com/apache/beam/commit/9b620fc57fe2beabbe75319a2affdfd4df59f900", "message": "Read BigQuery maps into Beam Schema and Row", "committedDate": "2020-08-17T15:27:15Z", "type": "commit"}, {"oid": "4c95ec65503952100380ccebcf7e43a2a6954ad9", "url": "https://github.com/apache/beam/commit/4c95ec65503952100380ccebcf7e43a2a6954ad9", "message": "Convert map entries from Beam fields to TableRow values", "committedDate": "2020-08-17T15:27:15Z", "type": "commit"}, {"oid": "e8795b2449ca700aaba8badc747938c6ecd28a37", "url": "https://github.com/apache/beam/commit/e8795b2449ca700aaba8badc747938c6ecd28a37", "message": "Merge remote-tracking branch 'upstream/master' into schema-to-bigquery-map", "committedDate": "2020-09-18T08:36:08Z", "type": "commit"}, {"oid": "7f6c927f2c232564146eacf964534672d4671959", "url": "https://github.com/apache/beam/commit/7f6c927f2c232564146eacf964534672d4671959", "message": "Add map conversion tests", "committedDate": "2020-09-18T19:14:54Z", "type": "commit"}, {"oid": "ad00c61aeb09a6d747fdcd3da202c07ed996012b", "url": "https://github.com/apache/beam/commit/ad00c61aeb09a6d747fdcd3da202c07ed996012b", "message": "Switch to vendored Guava", "committedDate": "2020-09-18T20:47:14Z", "type": "commit"}, {"oid": "83333adcf056dfb01b31cb679b0a49f8285b8c33", "url": "https://github.com/apache/beam/commit/83333adcf056dfb01b31cb679b0a49f8285b8c33", "message": "Merge branch 'master' of https://github.com/apache/beam into schema-to-bigquery-map", "committedDate": "2020-10-09T12:23:11Z", "type": "commit"}, {"oid": "f4d3659179f2509cadebf602a4c6c293c23ccf60", "url": "https://github.com/apache/beam/commit/f4d3659179f2509cadebf602a4c6c293c23ccf60", "message": "Merge branch 'master' of https://github.com/apache/beam into schema-to-bigquery-map", "committedDate": "2020-10-14T08:33:40Z", "type": "commit"}, {"oid": "612a74b807e071fcf069f08edf7a2f127bed1f19", "url": "https://github.com/apache/beam/commit/612a74b807e071fcf069f08edf7a2f127bed1f19", "message": "Add SchemaConversionOptions, infer maps from BigQuery", "committedDate": "2020-10-14T11:44:57Z", "type": "commit"}]}