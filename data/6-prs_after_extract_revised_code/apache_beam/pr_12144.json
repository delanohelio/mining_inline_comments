{"pr_number": 12144, "pr_title": "[BEAM-10395] Deduplicate uploads by destinations before uploading", "pr_createdAt": "2020-07-01T01:47:53Z", "pr_url": "https://github.com/apache/beam/pull/12144", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452535839", "bodyText": "Should this throw an exception? IIUC, this would most likely mean that a user-specified file to upload would fail, right? (classpath JAR files with equal names should have equal contents as they usually include version in their name)\nWouldn't it be best to error out, and inform the use about that?", "author": "pabloem", "createdAt": "2020-07-09T23:03:09Z", "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java", "diffHunk": "@@ -311,8 +315,26 @@ public DataflowPackage stageToFile(\n       CompletionStage<StagingResult> stagingResult =\n           computePackageAttributes(source, hash, dest, stagingPath)\n               .thenComposeAsync(\n-                  packageAttributes ->\n-                      stagePackage(packageAttributes, retrySleeper, createOptions));\n+                  packageAttributes -> {\n+                    String destLocation = packageAttributes.getDestination().getLocation();\n+                    String existingHash =\n+                        distinctDestinations.putIfAbsent(destLocation, packageAttributes.getHash());\n+                    if (existingHash == null) {\n+                      return stagePackage(packageAttributes, retrySleeper, createOptions);\n+                    } else {\n+                      if (!existingHash.equals(packageAttributes.getHash())) {\n+                        LOG.warn(\n+                            \"Upload of {} would overwrite {} with different content\",\n+                            packageAttributes.getSource(),\n+                            destLocation);", "originalCommit": "c544cbac5c3d8edd372792648855348091ea6210", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNjI0Mg==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452536242", "bodyText": "I'm cool with either way.  I left it like this because in the past it wouldn't be an error, they'd just end up with possibly unexpected results.", "author": "steveniemitz", "createdAt": "2020-07-09T23:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0OTY3Ng==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452549676", "bodyText": "Two files should not have a same destination in the first place. They are deduplicated by postfixing hash when dependency information is created: https://github.com/apache/beam/blob/master/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Environments.java#L320", "author": "ihji", "createdAt": "2020-07-09T23:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MTYyMw==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452551623", "bodyText": "Regarding my previous comment, I prefer failing the job instead of just printing out warnings when two files have a same staging destination.", "author": "ihji", "createdAt": "2020-07-09T23:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1MzM1Mw==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452553353", "bodyText": "yeah good call, this can never be hit since the destination names will never be the same.  I'll just remove the dupe check completely.", "author": "steveniemitz", "createdAt": "2020-07-10T00:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2NTMxMA==", "url": "https://github.com/apache/beam/pull/12144#discussion_r452565310", "bodyText": "all set", "author": "steveniemitz", "createdAt": "2020-07-10T00:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "ddb851e893fdfe467379691cfc5d9fe25f908596", "chunk": "diff --git a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\nindex f4a2dfe13a..d28ad78195 100644\n--- a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\n+++ b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\n\n@@ -317,20 +317,11 @@ public class PackageUtil implements Closeable {\n               .thenComposeAsync(\n                   packageAttributes -> {\n                     String destLocation = packageAttributes.getDestination().getLocation();\n-                    String existingHash =\n-                        distinctDestinations.putIfAbsent(destLocation, packageAttributes.getHash());\n-                    if (existingHash == null) {\n+                    if (distinctDestinations.add(destLocation)) {\n                       return stagePackage(packageAttributes, retrySleeper, createOptions);\n                     } else {\n-                      if (!existingHash.equals(packageAttributes.getHash())) {\n-                        LOG.warn(\n-                            \"Upload of {} would overwrite {} with different content\",\n-                            packageAttributes.getSource(),\n-                            destLocation);\n-                      } else {\n-                        LOG.debug(\n-                            \"Upload of {} skipped because it was already queued\", destLocation);\n-                      }\n+                      LOG.debug(\"Upload of {} skipped because it was already queued\", destLocation);\n+\n                       return CompletableFuture.completedFuture(\n                           StagingResult.cached(packageAttributes));\n                     }\n"}}, {"oid": "ddb851e893fdfe467379691cfc5d9fe25f908596", "url": "https://github.com/apache/beam/commit/ddb851e893fdfe467379691cfc5d9fe25f908596", "message": "Deduplicate uploads by destinations before uploading", "committedDate": "2020-07-10T00:48:25Z", "type": "commit"}, {"oid": "ddb851e893fdfe467379691cfc5d9fe25f908596", "url": "https://github.com/apache/beam/commit/ddb851e893fdfe467379691cfc5d9fe25f908596", "message": "Deduplicate uploads by destinations before uploading", "committedDate": "2020-07-10T00:48:25Z", "type": "forcePushed"}]}