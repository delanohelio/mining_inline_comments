{"pr_number": 11122, "pr_title": "[BEAM-9346] Improve the efficiency of TFRecordIO", "pr_createdAt": "2020-03-13T13:42:55Z", "pr_url": "https://github.com/apache/beam/pull/11122", "timeline": [{"oid": "dfa0146a29a98ff926e01291f012abe4b58594be", "url": "https://github.com/apache/beam/commit/dfa0146a29a98ff926e01291f012abe4b58594be", "message": "[BEAM-9346] Improve the efficiency of TFRecordIO", "committedDate": "2020-03-13T13:36:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ==", "url": "https://github.com/apache/beam/pull/11122#discussion_r395391171", "bodyText": "Seems like this was applied to all file-based IO not just TFRecordIO as mentioned in the PR description. Have we done enough experiments to make sure this won't have unintended adverse performance consequences in batch/streaming ? For example, what if the list does not fit in memory ?\nApologies if this was already discussed in the dev list.\ncc: @robertwb @lukecwik @iemejia", "author": "chamikaramj", "createdAt": "2020-03-20T00:31:35Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/WriteFiles.java", "diffHunk": "@@ -410,13 +412,44 @@ private GatherResults(Coder<ResultT> resultCoder) {\n       } else {\n         // Pass results via a side input rather than reshuffle, because we need to get an empty\n         // iterable to finalize if there are no results.\n-        return input\n-            .getPipeline()\n-            .apply(Reify.viewInGlobalWindow(input.apply(View.asList()), ListCoder.of(resultCoder)));\n+        return input.apply(\"ToList\", Combine.globally(new ToListCombineFn<>()));", "originalCommit": "dfa0146a29a98ff926e01291f012abe4b58594be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxNDI4Ng==", "url": "https://github.com/apache/beam/pull/11122#discussion_r395414286", "bodyText": "I believe this could be a regression based upon the above comment a few lines higher then where the code was changed:\n// Pass results via a side input rather than reshuffle, because we need to get an empty\n// iterable to finalize if there are no results.\n\nThe combine globally in the global window will produce a default output in the global window but will throw an exception if used against non-global window PCollections.\nPerformance wise this is likely an improvement overall since runners typically do a better job with GBK then with side inputs. So we could keep this change as an optimization in the global window case and keep the existing behavior for non global windows.", "author": "lukecwik", "createdAt": "2020-03-20T02:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY1ODkzOA==", "url": "https://github.com/apache/beam/pull/11122#discussion_r395658938", "bodyText": "Thanks. Agree with Luke. Combine globally has shuffle (GBK) inside hence breaks above statements. This could be a regression at least for Dataflow when there are no outputs. We should try following cases.\n(1) Dataflow (and possibly other runners may have similar regressions ?) with an empty output.\n(2) Writing using a non-global window while WriteFiles.withWindowedWrites() not set.\nLuke, does that make sense ? Anything else to try out to make sure there's no regression here ?", "author": "chamikaramj", "createdAt": "2020-03-20T14:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3ODMzNA==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406478334", "bodyText": "What's the verdict here ? I suggest we revert this and introduce as an optional change since this is a potential regression for Dataflow runner.", "author": "chamikaramj", "createdAt": "2020-04-09T21:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3OTc3Mw==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406479773", "bodyText": "Created https://issues.apache.org/jira/browse/BEAM-9734 to make sure that this does not get into 2.21.0", "author": "chamikaramj", "createdAt": "2020-04-09T21:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2ODYzMg==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406668632", "bodyText": "Imo just a revert would be better - giving an option to something that is not validated and can have unexpected adverse effects would result in user's confusion", "author": "piotr-szuberski", "createdAt": "2020-04-10T08:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3Mjg3OA==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406672878", "bodyText": "I'm not sure what's the verdict right now. I think we should revert this and discuss further steps with repo free of regressions. Tagging @lukecwik for input about leaving the optimization for global windows. @chamikaramj how do you think the optional change could be applied? A runtime flag for the runner?", "author": "mwalenia", "createdAt": "2020-04-10T09:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3NTIzMg==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406875232", "bodyText": "You could always apply the trigger if it is guaranteed to produce output by checking what the trigger definition is. I don't think you need a flag.\nI'm not sure how much of a holistic picture of the whole WriteFiles transform was done to see if there is a better way to structure the transforms but that will likely be much harder because WriteFiles isn't a trivial transform.", "author": "lukecwik", "createdAt": "2020-04-10T18:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3NzYzMA==", "url": "https://github.com/apache/beam/pull/11122#discussion_r406877630", "bodyText": "Thanks for reverting.\nMy suggestion was to fork the transform expansion to use GlobalCombine when specifically requested through a transform parameter (for example see how we fork TextIO.Read expansion based on withHintMatchesManyFiles()).\nhttps://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/io/TextIO.java#L371\nhttps://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/io/TextIO.java#L401\nI agree that the more flags we add the more confusing it becomes for users. So we should make sure that there are significant advantages in adding this option through performance benchmarking.", "author": "chamikaramj", "createdAt": "2020-04-10T18:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MTE3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxNTc0Nw==", "url": "https://github.com/apache/beam/pull/11122#discussion_r395415747", "bodyText": "nit: This should have been private class since its an implementation detail and didn't need to expose this to users of the WriteFiles transform.", "author": "lukecwik", "createdAt": "2020-03-20T02:36:22Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/WriteFiles.java", "diffHunk": "@@ -410,13 +412,44 @@ private GatherResults(Coder<ResultT> resultCoder) {\n       } else {\n         // Pass results via a side input rather than reshuffle, because we need to get an empty\n         // iterable to finalize if there are no results.\n-        return input\n-            .getPipeline()\n-            .apply(Reify.viewInGlobalWindow(input.apply(View.asList()), ListCoder.of(resultCoder)));\n+        return input.apply(\"ToList\", Combine.globally(new ToListCombineFn<>()));\n       }\n     }\n   }\n \n+  public static class ToListCombineFn<ResultT>", "originalCommit": "dfa0146a29a98ff926e01291f012abe4b58594be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3NTAwOA==", "url": "https://github.com/apache/beam/pull/11122#discussion_r395475008", "bodyText": "You're right, I just copy pasted the code from Jira. It was my first PR in Beam and I wanted to get the workflow without digging the code proposed.", "author": "piotr-szuberski", "createdAt": "2020-03-20T07:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQxNTc0Nw=="}], "type": "inlineReview", "revised_code": null}]}