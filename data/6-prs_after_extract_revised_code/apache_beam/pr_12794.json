{"pr_number": 12794, "pr_title": "[BEAM-10865] Support for Kafka deserialization API with headers (since Kafka API 2.1.0)", "pr_createdAt": "2020-09-09T10:01:22Z", "pr_url": "https://github.com/apache/beam/pull/12794", "timeline": [{"oid": "a6bb41dd46d605e7b23e260c4f0e66b9a18f18bf", "url": "https://github.com/apache/beam/commit/a6bb41dd46d605e7b23e260c4f0e66b9a18f18bf", "message": "Support for Kafka deserialization API with headers (since Kafka API 2.1.0)", "committedDate": "2020-09-08T14:34:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3NzE1OQ==", "url": "https://github.com/apache/beam/pull/12794#discussion_r486477159", "bodyText": "Why does this matter that it is a default method?\nShouldn't we be setting this to true as long as the method exists?", "author": "lukecwik", "createdAt": "2020-09-10T16:28:27Z", "path": "sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/ConsumerSpEL.java", "diffHunk": "@@ -90,6 +98,16 @@ public ConsumerSpEL() {\n     } catch (NoSuchMethodException | SecurityException e) {\n       LOG.debug(\"OffsetsForTimes is not available.\");\n     }\n+\n+    try {\n+      // It is supported by Kafka Client 2.1.0 onwards.\n+      Method method =\n+          Deserializer.class.getDeclaredMethod(\n+              \"deserialize\", String.class, Headers.class, byte[].class);\n+      deserializerSupportsHeaders = method.isDefault();", "originalCommit": "a6bb41dd46d605e7b23e260c4f0e66b9a18f18bf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f79db7c188113dc2fb12d6e8324e9fe2bdc3bfd8", "chunk": "diff --git a/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/ConsumerSpEL.java b/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/ConsumerSpEL.java\nindex 12249b4d9f..9ca5bfc990 100644\n--- a/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/ConsumerSpEL.java\n+++ b/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/ConsumerSpEL.java\n\n@@ -101,10 +100,13 @@ class ConsumerSpEL {\n \n     try {\n       // It is supported by Kafka Client 2.1.0 onwards.\n-      Method method =\n-          Deserializer.class.getDeclaredMethod(\n-              \"deserialize\", String.class, Headers.class, byte[].class);\n-      deserializerSupportsHeaders = method.isDefault();\n+      deserializerSupportsHeaders =\n+          \"T\"\n+              .equals(\n+                  Deserializer.class\n+                      .getDeclaredMethod(\"deserialize\", String.class, Headers.class, byte[].class)\n+                      .getGenericReturnType()\n+                      .getTypeName());\n     } catch (NoSuchMethodException | SecurityException e) {\n       LOG.debug(\"Deserializer interface does not support Kafka headers\");\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3OTgzOQ==", "url": "https://github.com/apache/beam/pull/12794#discussion_r486479839", "bodyText": "In the build.gradle you'll want to setup a junit test run that uses Kafka 2.1.0 and executes these tests.\nThis is a pretty good example of how to get this going:\nhttps://docs.gradle.org/current/userguide/java_testing.html#sec:configuring_java_integration_tests\nYou shouldn't need any additional source sets but you'll want to add a configuration for kafka210 that adds the dependency and also the test task that uses it.", "author": "lukecwik", "createdAt": "2020-09-10T16:32:41Z", "path": "sdks/java/io/kafka/src/test/java/org/apache/beam/sdk/io/kafka/KafkaIOTest.java", "diffHunk": "@@ -501,6 +503,83 @@ public void testReadAvroSpecificRecordsWithConfluentSchemaRegistry() {\n     p.run();\n   }\n \n+  public static class IntegerDeserializerWithHeadersAssertor extends IntegerDeserializer\n+      implements Deserializer<Integer> {\n+    ConsumerSpEL consumerSpEL = null;\n+\n+    @Override\n+    public Integer deserialize(String topic, byte[] data) {\n+      StackTraceElement[] stackTraceElements = Thread.currentThread().getStackTrace();", "originalCommit": "a6bb41dd46d605e7b23e260c4f0e66b9a18f18bf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "f79db7c188113dc2fb12d6e8324e9fe2bdc3bfd8", "url": "https://github.com/apache/beam/commit/f79db7c188113dc2fb12d6e8324e9fe2bdc3bfd8", "message": "Assert the deserializer method with a Headers argument exists and disregard it being a default or not", "committedDate": "2020-09-10T20:09:28Z", "type": "commit"}, {"oid": "2bc407dc5491e967065adbb36b1aaf7725e72634", "url": "https://github.com/apache/beam/commit/2bc407dc5491e967065adbb36b1aaf7725e72634", "message": "Introduce a kafkaVersion210Test for testing KafkaIOTest against kafka-client 2.1.0", "committedDate": "2020-09-15T13:10:06Z", "type": "commit"}, {"oid": "b3bddff2f6b326d376914e0d315e53b97e12f729", "url": "https://github.com/apache/beam/commit/b3bddff2f6b326d376914e0d315e53b97e12f729", "message": "Let the kafkaVersion210 configuration use a resolution strategy to force Kafka clients API 2.1.0", "committedDate": "2020-09-20T01:47:55Z", "type": "commit"}]}