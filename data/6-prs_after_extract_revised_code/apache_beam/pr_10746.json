{"pr_number": 10746, "pr_title": "[BEAM-9241] Fix inconsistent proto nullability", "pr_createdAt": "2020-02-01T15:40:38Z", "pr_url": "https://github.com/apache/beam/pull/10746", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwNjEzMQ==", "url": "https://github.com/apache/beam/pull/10746#discussion_r373806131", "bodyText": "Are they? I didn't think that was true. What happens if you declare a submessage required in proto2?", "author": "reuvenlax", "createdAt": "2020-02-01T22:32:20Z", "path": "sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java", "diffHunk": "@@ -268,13 +287,12 @@ private static FieldType beamFieldTypeFromSingularProtoField(\n           default:\n             fieldType = FieldType.row(getSchema(protoFieldDescriptor.getMessageType()));\n         }\n+        // all messages are nullable in Proto", "originalCommit": "f7722a0bc4aa0305b3d27cfd8dcf5c82c7eb3f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgzMjcxNg==", "url": "https://github.com/apache/beam/pull/10746#discussion_r373832716", "bodyText": "You're right. I've corrected the Translator for messages and also added tests.", "author": "alexvanboxel", "createdAt": "2020-02-02T09:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwNjEzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "95bfaa6650cb627e8c3b5f65981a484e0261b4ae", "chunk": "diff --git a/sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java b/sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java\nindex 292a33eb2b..160271cfe7 100644\n--- a/sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java\n+++ b/sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java\n\n@@ -288,7 +289,9 @@ public class ProtoSchemaTranslator {\n             fieldType = FieldType.row(getSchema(protoFieldDescriptor.getMessageType()));\n         }\n         // all messages are nullable in Proto\n-        fieldType = fieldType.withNullable(true);\n+        if (protoFieldDescriptor.isOptional()) {\n+          fieldType = fieldType.withNullable(true);\n+        }\n         break;\n       default:\n         throw new RuntimeException(\"Field type not matched.\");\n"}}, {"oid": "95bfaa6650cb627e8c3b5f65981a484e0261b4ae", "url": "https://github.com/apache/beam/commit/95bfaa6650cb627e8c3b5f65981a484e0261b4ae", "message": "[BEAM-9241] Fix inconsistent proto nullability\n\nFix the nullability issues with protobuf to schema mapping\n\n* Proto3 primitive types should be not nullable.\n* Proto2 required types should be not nullable.\n* Proto2 optional should also be not nullable as having an optional value\n  doesn't mean it has not value. The spec states it has the optional\n  value.\n* Arrays should be not nullable, as proto arrays always have an empty\n  array when no value is set.\n* Maps should be not nullable, as proto maps always have an empty map when\n  no value is set.\n* Elements in an array should be not nullable, as nulls are not allowed in\n  an array.\n* Names and Values should be not nullable, as nulls are not allowed.\n* Messages, as well as Well Known Types are nullable, unless using\n  proto2 and the required label is specified.", "committedDate": "2020-02-10T07:52:09Z", "type": "forcePushed"}, {"oid": "aab5ae5fa8d8521a3d3e9273765a26a2c3632cb0", "url": "https://github.com/apache/beam/commit/aab5ae5fa8d8521a3d3e9273765a26a2c3632cb0", "message": "[BEAM-9241] Fix inconsistent proto nullability\n\nFix the nullability issues with protobuf to schema mapping\n\n* Proto3 primitive types should be not nullable.\n* Proto2 required types should be not nullable.\n* Proto2 optional should also be not nullable as having an optional value\n  doesn't mean it has not value. The spec states it has the optional\n  value.\n* Arrays should be not nullable, as proto arrays always have an empty\n  array when no value is set.\n* Maps should be not nullable, as proto maps always have an empty map when\n  no value is set.\n* Elements in an array should be not nullable, as nulls are not allowed in\n  an array.\n* Names and Values should be not nullable, as nulls are not allowed.\n* Messages, as well as Well Known Types are nullable, unless using\n  proto2 and the required label is specified.", "committedDate": "2020-02-10T12:11:02Z", "type": "commit"}, {"oid": "aab5ae5fa8d8521a3d3e9273765a26a2c3632cb0", "url": "https://github.com/apache/beam/commit/aab5ae5fa8d8521a3d3e9273765a26a2c3632cb0", "message": "[BEAM-9241] Fix inconsistent proto nullability\n\nFix the nullability issues with protobuf to schema mapping\n\n* Proto3 primitive types should be not nullable.\n* Proto2 required types should be not nullable.\n* Proto2 optional should also be not nullable as having an optional value\n  doesn't mean it has not value. The spec states it has the optional\n  value.\n* Arrays should be not nullable, as proto arrays always have an empty\n  array when no value is set.\n* Maps should be not nullable, as proto maps always have an empty map when\n  no value is set.\n* Elements in an array should be not nullable, as nulls are not allowed in\n  an array.\n* Names and Values should be not nullable, as nulls are not allowed.\n* Messages, as well as Well Known Types are nullable, unless using\n  proto2 and the required label is specified.", "committedDate": "2020-02-10T12:11:02Z", "type": "forcePushed"}]}