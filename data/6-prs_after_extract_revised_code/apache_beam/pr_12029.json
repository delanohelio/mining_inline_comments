{"pr_number": 12029, "pr_title": "[BEAM-10153] Fix VoidCoder with FnApiDoFnRunner", "pr_createdAt": "2020-06-18T04:20:48Z", "pr_url": "https://github.com/apache/beam/pull/12029", "timeline": [{"oid": "3b67e9eb60286009b3298a53942c55853b979a79", "url": "https://github.com/apache/beam/commit/3b67e9eb60286009b3298a53942c55853b979a79", "message": "[BEAM-10153] Fix VoidCoder with FnApiDoFnRunner", "committedDate": "2020-06-18T04:15:51Z", "type": "commit"}, {"oid": "9a86810434c09c4f79296c03874f03092d325776", "url": "https://github.com/apache/beam/commit/9a86810434c09c4f79296c03874f03092d325776", "message": "Add @Nullable to Timer getUserKey()", "committedDate": "2020-06-18T04:25:57Z", "type": "commit"}, {"oid": "e96646e04350b537df0e90941bd75b717e810875", "url": "https://github.com/apache/beam/commit/e96646e04350b537df0e90941bd75b717e810875", "message": "revert VoidCoder changes", "committedDate": "2020-06-18T04:53:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzM2Nw==", "url": "https://github.com/apache/beam/pull/12029#discussion_r442337367", "bodyText": "This will require calling the function everytime when it is null.\nYou should use a boolean and update the check to be something like: (currentArg != memoizedArg || !initialized).", "author": "lukecwik", "createdAt": "2020-06-18T16:03:31Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java", "diffHunk": "@@ -128,7 +128,7 @@ public FnApiStateAccessor(\n       @Override\n       public ResultT get() {\n         ArgT currentArg = arg.get();\n-        if (currentArg != memoizedArg) {\n+        if (currentArg != memoizedArg || currentArg == null) {", "originalCommit": "e96646e04350b537df0e90941bd75b717e810875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzOTk0OA==", "url": "https://github.com/apache/beam/pull/12029#discussion_r442339948", "bodyText": "For VoidCoder the arg.get() returns null, which means the currentArg != memoizedArg will evaluate to false.\nThis leaves the memoizedResult to null(underneath function never applied), and for VoidCoder key coder we need to set the key to ByteString.EMPTY instead of null(generated proto class doesn't allow setting to null) I believe.", "author": "y1chi", "createdAt": "2020-06-18T16:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM0MjY4OA==", "url": "https://github.com/apache/beam/pull/12029#discussion_r442342688", "bodyText": "I realized this and updated my comment just after posting to use a boolean.", "author": "lukecwik", "createdAt": "2020-06-18T16:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d4f17617e6cb17f014bb7a16bc831813b670ed15", "chunk": "diff --git a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\nindex 69f03cf68b..6a0ece3e9d 100644\n--- a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\n+++ b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\n\n@@ -124,12 +124,14 @@ public class FnApiStateAccessor<K> implements SideInputReader, StateBinder {\n     return new Supplier<ResultT>() {\n       private ArgT memoizedArg;\n       private ResultT memoizedResult;\n+      private boolean initialized;\n \n       @Override\n       public ResultT get() {\n         ArgT currentArg = arg.get();\n-        if (currentArg != memoizedArg || currentArg == null) {\n+        if (currentArg != memoizedArg || (currentArg == null && !initialized)) {\n           memoizedResult = f.apply(this.memoizedArg = currentArg);\n+          initialized = true;\n         }\n         return memoizedResult;\n       }\n"}}, {"oid": "d4f17617e6cb17f014bb7a16bc831813b670ed15", "url": "https://github.com/apache/beam/commit/d4f17617e6cb17f014bb7a16bc831813b670ed15", "message": "Add initialized flag", "committedDate": "2020-06-18T16:38:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2MzI3Mg==", "url": "https://github.com/apache/beam/pull/12029#discussion_r442363272", "bodyText": "The initialized will become true and will stay true so checking currentArg == null won't do anything.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (currentArg != memoizedArg || (currentArg == null && !initialized)) {\n          \n          \n            \n                    if (currentArg != memoizedArg || !initialized) {", "author": "lukecwik", "createdAt": "2020-06-18T16:44:22Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java", "diffHunk": "@@ -124,12 +124,14 @@ public FnApiStateAccessor(\n     return new Supplier<ResultT>() {\n       private ArgT memoizedArg;\n       private ResultT memoizedResult;\n+      private boolean initialized;\n \n       @Override\n       public ResultT get() {\n         ArgT currentArg = arg.get();\n-        if (currentArg != memoizedArg) {\n+        if (currentArg != memoizedArg || (currentArg == null && !initialized)) {", "originalCommit": "d4f17617e6cb17f014bb7a16bc831813b670ed15", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4de32148edb81ffee9f5493fd8f6e44ff23a32c", "chunk": "diff --git a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\nindex 6a0ece3e9d..8bb2ab659f 100644\n--- a/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\n+++ b/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\n\n@@ -129,7 +129,7 @@ public class FnApiStateAccessor<K> implements SideInputReader, StateBinder {\n       @Override\n       public ResultT get() {\n         ArgT currentArg = arg.get();\n-        if (currentArg != memoizedArg || (currentArg == null && !initialized)) {\n+        if (currentArg != memoizedArg || !initialized) {\n           memoizedResult = f.apply(this.memoizedArg = currentArg);\n           initialized = true;\n         }\n"}}, {"oid": "b4de32148edb81ffee9f5493fd8f6e44ff23a32c", "url": "https://github.com/apache/beam/commit/b4de32148edb81ffee9f5493fd8f6e44ff23a32c", "message": "Update sdks/java/harness/src/main/java/org/apache/beam/fn/harness/state/FnApiStateAccessor.java\n\nCo-authored-by: Lukasz Cwik <lcwik@google.com>", "committedDate": "2020-06-18T16:48:08Z", "type": "commit"}]}