{"pr_number": 11377, "pr_title": "[BEAM-9439] Return split instead of total backlog size in KinesisIO", "pr_createdAt": "2020-04-10T11:21:50Z", "pr_url": "https://github.com/apache/beam/pull/11377", "timeline": [{"oid": "1e182c6abc8e265f3e4b670747d448df70bb7bb0", "url": "https://github.com/apache/beam/commit/1e182c6abc8e265f3e4b670747d448df70bb7bb0", "message": "[BEAM-9439] Return split instead of total backlog size\n\nThe split backlog size can be over-estimated as it reports the size\nof the records across all shards (and also assumes that all shards\nin the split have the same progress).\nThis can lead to unnecessary decisions to scale up the number of workers\nbut will never fail to scale up when this is necessary.\n\nAlso the watermark policy of the reader is user configurable and we\ndon't have a control over it. The calculation of backlog bytes should\nalways take into account the time that the record was inserted into\nKinesis as this gives accurate results which are independent of\ncurrent processing time or any other conditions that reader watermark\ncan be using. Therefore a separate, fixed policy is used to track\nprocessed records for the backlog calculation.", "committedDate": "2020-04-10T11:19:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4ODY2Mg==", "url": "https://github.com/apache/beam/pull/11377#discussion_r421588662", "bodyText": "Why AtomicReference no more used here?", "author": "aromanenko-dev", "createdAt": "2020-05-07T15:20:40Z", "path": "sdks/java/io/kinesis/src/main/java/org/apache/beam/sdk/io/kinesis/ShardRecordsIterator.java", "diffHunk": "@@ -43,22 +42,23 @@\n   private final RecordFilter filter;\n   private final String streamName;\n   private final String shardId;\n-  private AtomicReference<ShardCheckpoint> checkpoint;\n+  private final AtomicReference<ShardCheckpoint> checkpoint;\n+  private final WatermarkPolicy watermarkPolicy;", "originalCommit": "1e182c6abc8e265f3e4b670747d448df70bb7bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc0MDM3Mw==", "url": "https://github.com/apache/beam/pull/11377#discussion_r421740373", "bodyText": "I don't know why it was used in the first place, maybe it was some leftover after some previous changes to the code. The value of watermarkPolicy is only set in constructor and then only accessed (never changed), so there's no need to have an AtomicReference for that. From the perspective of memory visiblity, making the field as final ensures that the value of the field is correctly published to other threads, so there's no difference also in that aspect.", "author": "sgraca", "createdAt": "2020-05-07T19:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4ODY2Mg=="}], "type": "inlineReview", "revised_code": null}]}