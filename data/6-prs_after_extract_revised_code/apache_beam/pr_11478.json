{"pr_number": 11478, "pr_title": "[BEAM-9794] Reduce state cells needed for BufferingDoFnRunner", "pr_createdAt": "2020-04-21T14:34:27Z", "pr_url": "https://github.com/apache/beam/pull/11478", "timeline": [{"oid": "5b4ca7be5de55c26a541c27f402e1d51b4e0d6ba", "url": "https://github.com/apache/beam/commit/5b4ca7be5de55c26a541c27f402e1d51b4e0d6ba", "message": "[BEAM-9794] Reduce state cells needed for BufferingDoFnRunner\n\nThe BufferingDoFnRunner create a new state cell for buffering data during each\ncheckpoint. This led to the number of state cells to reach Short.MAX_VALUE, the\nmaximum of supported Flink states.\n\nThis change keeps a fixed number of state cells depending on the maximum\nconfigured parallelism for checkpoints. The state cells are reused after the\ncheckpoint has been acknowledged.", "committedDate": "2020-04-21T14:29:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcxNDU0MA==", "url": "https://github.com/apache/beam/pull/11478#discussion_r412714540", "bodyText": "nit: @VisibleForTesting", "author": "dmvk", "createdAt": "2020-04-22T06:48:06Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/stableinput/BufferingDoFnRunner.java", "diffHunk": "@@ -170,44 +201,48 @@ public void checkpointCompleted(long checkpointId) throws Exception {\n     }\n   }\n \n-  private void addToBeAcknowledgedCheckpoint(long checkpointId, String internalId)\n-      throws Exception {\n+  private void addToBeAcknowledgedCheckpoint(long checkpointId, int internalId) throws Exception {\n     notYetAcknowledgedSnapshots.addAll(\n-        Collections.singletonList(new CheckpointElement(internalId, checkpointId)));\n+        Collections.singletonList(new CheckpointIdentifier(internalId, checkpointId)));\n   }\n \n-  private List<CheckpointElement> removeToBeAcknowledgedCheckpoints(long checkpointId)\n+  private List<CheckpointIdentifier> gatherToBeAcknowledgedCheckpoints(long checkpointId)\n       throws Exception {\n-    List<CheckpointElement> toBeAcknowledged = new ArrayList<>();\n-    List<CheckpointElement> checkpoints = new ArrayList<>();\n-    for (CheckpointElement element : notYetAcknowledgedSnapshots.get()) {\n+    List<CheckpointIdentifier> toBeAcknowledged = new ArrayList<>();\n+    List<CheckpointIdentifier> remaining = new ArrayList<>();\n+    for (CheckpointIdentifier element : notYetAcknowledgedSnapshots.get()) {\n       if (element.checkpointId <= checkpointId) {\n         toBeAcknowledged.add(element);\n       } else {\n-        checkpoints.add(element);\n+        remaining.add(element);\n       }\n     }\n-    notYetAcknowledgedSnapshots.update(checkpoints);\n+    notYetAcknowledgedSnapshots.update(remaining);\n     // Sort by checkpoint id to preserve order\n     toBeAcknowledged.sort(Comparator.comparingLong(o -> o.checkpointId));\n     return toBeAcknowledged;\n   }\n \n-  private static String generateNewId() {\n-    return UUID.randomUUID().toString();\n+  private int rotateAndGetStateIndex() {\n+    currentStateIndex = (currentStateIndex + 1) % numCheckpointBuffers;\n+    return currentStateIndex;\n+  }\n+\n+  private int getStateIndex() {\n+    return currentStateIndex;\n   }\n \n   /** Constructs a new instance of BufferingElementsHandler with a provided state namespace. */\n   private interface BufferingElementsHandlerFactory {\n-    BufferingElementsHandler get(String stateId) throws Exception;\n+    BufferingElementsHandler get(int stateIndex) throws Exception;\n   }\n \n-  private static class CheckpointElement {\n+  static class CheckpointIdentifier {", "originalCommit": "5b4ca7be5de55c26a541c27f402e1d51b4e0d6ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcyNjkwNg==", "url": "https://github.com/apache/beam/pull/11478#discussion_r412726906", "bodyText": "just to check if I understand this correctly:\n\nWe are guaranteed that checkpoints complete in sequential order.\nWe might get gaps in case of failed / expired checkpoints, so any completed checkpoint must complete all prior checkpoints.", "author": "dmvk", "createdAt": "2020-04-22T07:10:02Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/stableinput/BufferingDoFnRunner.java", "diffHunk": "@@ -143,15 +174,15 @@ public void checkpoint(long checkpointId) throws Exception {\n     // We are about to get checkpointed. The elements buffered thus far\n     // have to be added to the global CheckpointElement state which will\n     // be used to emit elements later when this checkpoint is acknowledged.\n-    addToBeAcknowledgedCheckpoint(checkpointId, currentStateId);\n-    currentStateId = generateNewId();\n-    currentBufferingElementsHandler = bufferingElementsHandlerFactory.get(currentStateId);\n+    addToBeAcknowledgedCheckpoint(checkpointId, getStateIndex());\n+    int newStateIndex = rotateAndGetStateIndex();\n+    currentBufferingElementsHandler = bufferingElementsHandlerFactory.get(newStateIndex);\n   }\n \n   /** Should be called when a checkpoint is completed. */\n   public void checkpointCompleted(long checkpointId) throws Exception {", "originalCommit": "5b4ca7be5de55c26a541c27f402e1d51b4e0d6ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc5NjY0MQ==", "url": "https://github.com/apache/beam/pull/11478#discussion_r412796641", "bodyText": "It's good that you bring this up because I wanted to add a comment to explain this. Since every checkpoint runs independently we are not guaranteed to complete in sequential order. In case a later checkpoint completes before an earlier one, we can safely process the elements of the earlier one. This method is guaranteed not to overlap because Flink uses a single thread to execute async task calls lie (a) triggering a checkpoint (b) completing a checkpoint. When an earlier checkpoint completes after a later one has already completed, we will do nothing here.", "author": "mxm", "createdAt": "2020-04-22T08:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcyNjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyMTkwMQ==", "url": "https://github.com/apache/beam/pull/11478#discussion_r412821901", "bodyText": "I wonder whether we should make the flushing backwards-compatible for users who want to migrate.", "author": "mxm", "createdAt": "2020-04-22T09:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcyNjkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0ODY2Mg==", "url": "https://github.com/apache/beam/pull/11478#discussion_r413848662", "bodyText": "I don't have strong opinions about this. In this case I'd incline to bw incompatible change.", "author": "dmvk", "createdAt": "2020-04-23T14:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcyNjkwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjczNzUyMQ==", "url": "https://github.com/apache/beam/pull/11478#discussion_r412737521", "bodyText": "\ud83d\udc4d", "author": "dmvk", "createdAt": "2020-04-22T07:26:36Z", "path": "runners/flink/src/test/java/org/apache/beam/runners/flink/translation/wrappers/streaming/stableinput/BufferingDoFnRunnerTest.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.runners.flink.translation.wrappers.streaming.stableinput;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.runners.core.DoFnRunner;\n+import org.apache.beam.sdk.coders.StringUtf8Coder;\n+import org.apache.beam.sdk.coders.VarIntCoder;\n+import org.apache.beam.sdk.transforms.windowing.GlobalWindow;\n+import org.apache.beam.sdk.util.WindowedValue;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;\n+import org.apache.flink.api.common.state.ListState;\n+import org.apache.flink.runtime.state.OperatorStateBackend;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+/**\n+ * Tests for {@link BufferingDoFnRunner}.\n+ *\n+ * <p>For more tests see:\n+ *\n+ * <p>- {@link org.apache.beam.runners.flink.FlinkRequiresStableInputTest}\n+ *\n+ * <p>-{@link org.apache.beam.runners.flink.translation.wrappers.streaming.DoFnOperatorTest}\n+ *\n+ * <p>- {@link BufferedElementsTest}\n+ */\n+public class BufferingDoFnRunnerTest {", "originalCommit": "5b4ca7be5de55c26a541c27f402e1d51b4e0d6ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}