{"pr_number": 11521, "pr_title": "[BEAM-9577] Update Java Runners to handle dependency-based artifact staging.", "pr_createdAt": "2020-04-24T23:12:51Z", "pr_url": "https://github.com/apache/beam/pull/11521", "timeline": [{"oid": "a5245ceab919ac6b966749bb35f9d755a6dd248b", "url": "https://github.com/apache/beam/commit/a5245ceab919ac6b966749bb35f9d755a6dd248b", "message": "[BEAM-9577] Update Java Runners to handle dependency-based artifact staging.", "committedDate": "2020-04-24T23:11:18Z", "type": "commit"}, {"oid": "d1fc7a30b7dfb4b868739cebba580842f457b19a", "url": "https://github.com/apache/beam/commit/d1fc7a30b7dfb4b868739cebba580842f457b19a", "message": "Fix flink test message.", "committedDate": "2020-04-27T21:53:34Z", "type": "commit"}, {"oid": "bbf84f7ae259667781aae2a7611554d5c08f2e2e", "url": "https://github.com/apache/beam/commit/bbf84f7ae259667781aae2a7611554d5c08f2e2e", "message": "Fix samza.", "committedDate": "2020-04-28T18:01:38Z", "type": "commit"}, {"oid": "de17dc2c81729abeb7e4db23ff6c4bfecb32e61f", "url": "https://github.com/apache/beam/commit/de17dc2c81729abeb7e4db23ff6c4bfecb32e61f", "message": "spotless", "committedDate": "2020-04-29T00:50:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NzQyNw==", "url": "https://github.com/apache/beam/pull/11521#discussion_r421047427", "bodyText": "Create {@link GrpcFnServer}s?", "author": "ihji", "createdAt": "2020-05-06T19:44:36Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java", "diffHunk": "@@ -39,6 +43,59 @@\n     return new GrpcFnServer<>(server, service, apiServiceDescriptor.build());\n   }\n \n+  /**\n+   * Create a {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary\n+   * port.\n+   */\n+  public static List<GrpcFnServer<? extends FnService>> allocatePortAndCreateFor(\n+      List<? extends FnService> services, ServerFactory factory) throws IOException {\n+    ApiServiceDescriptor.Builder apiServiceDescriptor = ApiServiceDescriptor.newBuilder();\n+    Server server =\n+        factory.allocateAddressAndCreate(\n+            Collections.unmodifiableList(services), apiServiceDescriptor);\n+    AtomicInteger countdown = new AtomicInteger(services.size());\n+    return Lists.transform(\n+        services,\n+        service ->\n+            new SharedGrpcFnServer<>(server, service, apiServiceDescriptor.build(), countdown));\n+  }\n+\n+  /**\n+   * Create a {@link GrpcFnServer}s for the provided {@link FnService}s running on a specified port.", "originalCommit": "de17dc2c81729abeb7e4db23ff6c4bfecb32e61f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d031905ca5a102e7565d9c010979200cfc742ff", "chunk": "diff --git a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\nindex 984b8f27f0..6e65a1b194 100644\n--- a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\n+++ b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\n\n@@ -44,7 +44,7 @@ public class GrpcFnServer<ServiceT extends FnService> implements AutoCloseable {\n   }\n \n   /**\n-   * Create a {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary\n+   * Create {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary\n    * port.\n    */\n   public static List<GrpcFnServer<? extends FnService>> allocatePortAndCreateFor(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0OTE0Ng==", "url": "https://github.com/apache/beam/pull/11521#discussion_r421049146", "bodyText": "Create {@link GrpcFnServer}s?", "author": "ihji", "createdAt": "2020-05-06T19:47:38Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java", "diffHunk": "@@ -39,6 +43,59 @@\n     return new GrpcFnServer<>(server, service, apiServiceDescriptor.build());\n   }\n \n+  /**\n+   * Create a {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary", "originalCommit": "de17dc2c81729abeb7e4db23ff6c4bfecb32e61f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d031905ca5a102e7565d9c010979200cfc742ff", "chunk": "diff --git a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\nindex 984b8f27f0..6e65a1b194 100644\n--- a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\n+++ b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/GrpcFnServer.java\n\n@@ -44,7 +44,7 @@ public class GrpcFnServer<ServiceT extends FnService> implements AutoCloseable {\n   }\n \n   /**\n-   * Create a {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary\n+   * Create {@link GrpcFnServer}s for the provided {@link FnService}s running on an arbitrary\n    * port.\n    */\n   public static List<GrpcFnServer<? extends FnService>> allocatePortAndCreateFor(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxNjkxOQ==", "url": "https://github.com/apache/beam/pull/11521#discussion_r421216919", "bodyText": "Shouldn't we also close retrievalServer?", "author": "ihji", "createdAt": "2020-05-07T03:25:32Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactory.java", "diffHunk": "@@ -613,7 +620,7 @@ public synchronized void close() {\n       // These will be closed in the reverse creation order:\n       try (AutoCloseable envCloser = environment;\n           AutoCloseable provisioningServer = serverInfo.getProvisioningServer();\n-          AutoCloseable retrievalServer = serverInfo.getRetrievalServer();\n+          AutoCloseable retrievalServer = serverInfo.getLegacyRetrievalServer();", "originalCommit": "de17dc2c81729abeb7e4db23ff6c4bfecb32e61f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDcxMA==", "url": "https://github.com/apache/beam/pull/11521#discussion_r421880710", "bodyText": "Yes, nice catch.", "author": "robertwb", "createdAt": "2020-05-08T01:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxNjkxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5d031905ca5a102e7565d9c010979200cfc742ff", "chunk": "diff --git a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactory.java b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactory.java\nindex 72b228da55..a1c9437843 100644\n--- a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactory.java\n+++ b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactory.java\n\n@@ -621,6 +621,7 @@ public class DefaultJobBundleFactory implements JobBundleFactory {\n       try (AutoCloseable envCloser = environment;\n           AutoCloseable provisioningServer = serverInfo.getProvisioningServer();\n           AutoCloseable retrievalServer = serverInfo.getLegacyRetrievalServer();\n+          AutoCloseable retrievalServer = serverInfo.getRetrievalServer();\n           AutoCloseable stateServer = serverInfo.getStateServer();\n           AutoCloseable dataServer = serverInfo.getDataServer();\n           AutoCloseable controlServer = serverInfo.getControlServer();\n"}}, {"oid": "5d031905ca5a102e7565d9c010979200cfc742ff", "url": "https://github.com/apache/beam/commit/5d031905ca5a102e7565d9c010979200cfc742ff", "message": "Reviewer comments.", "committedDate": "2020-05-08T01:14:39Z", "type": "commit"}, {"oid": "0a14f5926583aa369385fb9ce5215c5560f8c457", "url": "https://github.com/apache/beam/commit/0a14f5926583aa369385fb9ce5215c5560f8c457", "message": "spotless", "committedDate": "2020-05-08T01:20:35Z", "type": "commit"}, {"oid": "410ac9275d4af28401eaa058083504071ed290dd", "url": "https://github.com/apache/beam/commit/410ac9275d4af28401eaa058083504071ed290dd", "message": "fixup", "committedDate": "2020-05-08T16:06:17Z", "type": "commit"}, {"oid": "0c80cfbb6ecffcaa89680ead8769bb43c63e3c4f", "url": "https://github.com/apache/beam/commit/0c80cfbb6ecffcaa89680ead8769bb43c63e3c4f", "message": "Merge remote-tracking branch 'github/master' into artifact-v2-java-end-to-end", "committedDate": "2020-05-08T16:22:05Z", "type": "commit"}, {"oid": "7838ae84589c3072cab1b5ff22e32cd1bc2a2d25", "url": "https://github.com/apache/beam/commit/7838ae84589c3072cab1b5ff22e32cd1bc2a2d25", "message": "Set unused retrieval token.\n\nThis avoids NPEs when it's not needed.", "committedDate": "2020-05-08T23:33:54Z", "type": "commit"}]}