{"pr_number": 11578, "pr_title": "[BEAM-8025] Increase the number of retrials and retrial delay in case of load in CassandraIOTest", "pr_createdAt": "2020-04-30T10:38:02Z", "pr_url": "https://github.com/apache/beam/pull/11578", "timeline": [{"oid": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "url": "https://github.com/apache/beam/commit/561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "message": "[BEAM-8025] Increase the number of retrials en retrial delay in case of load", "committedDate": "2020-04-30T10:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzEzMw==", "url": "https://github.com/apache/beam/pull/11578#discussion_r418487133", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                int tried = 0;\n          \n          \n            \n                Exception exception = null;\n          \n          \n            \n                int tried = 0;", "author": "mxm", "createdAt": "2020-05-01T10:07:06Z", "path": "sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java", "diffHunk": "@@ -153,18 +153,22 @@ public static void beforeClass() throws Exception {\n \n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;", "originalCommit": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "chunk": "diff --git a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\nindex 9c68544059..0f91448ebe 100644\n--- a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n+++ b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n\n@@ -154,21 +154,31 @@ public class CassandraIOTest implements Serializable {\n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n     int delay = 5000;\n+    Exception exception = null;\n     while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n+        if (exception == null) {\n+          exception = e;\n+        } else {\n+          exception.addSuppressed(e);\n+        }\n         tried++;\n         try {\n           Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n+          Thread thread = Thread.currentThread();\n+          thread.interrupt();\n+          throw new RuntimeException(String.format(\"Thread %s was interrupted\", thread.getName()));\n         }\n       }\n     }\n     throw new RuntimeException(\n         String.format(\n             \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n-            tried, delay));\n+            tried, delay),\n+        exception);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzQwMg==", "url": "https://github.com/apache/beam/pull/11578#discussion_r418487402", "bodyText": "I couldn't find that this exception of type RuntimeException is thrown during cluster startup. We may want to catch all Exception here.", "author": "mxm", "createdAt": "2020-05-01T10:08:18Z", "path": "sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java", "diffHunk": "@@ -153,18 +153,22 @@ public static void beforeClass() throws Exception {\n \n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n-    while (tried < 3) {\n+    int delay = 5000;\n+    while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {", "originalCommit": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3MjA5Mg==", "url": "https://github.com/apache/beam/pull/11578#discussion_r419272092", "bodyText": "The Exception is thrown by ControlConnection.reconnectInternal() in the datastax driver component. It is thrown when the client has tried to connect to all newly created cassandra nodes. I'm not sure that all types of exceptions are suited for retrial upon load hence this single catch. WDYT ?", "author": "echauchot", "createdAt": "2020-05-04T08:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwMjU0Ng==", "url": "https://github.com/apache/beam/pull/11578#discussion_r419302546", "bodyText": "Seems fair.", "author": "mxm", "createdAt": "2020-05-04T09:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzQwMg=="}], "type": "inlineReview", "revised_code": {"commit": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "chunk": "diff --git a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\nindex 9c68544059..0f91448ebe 100644\n--- a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n+++ b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n\n@@ -154,21 +154,31 @@ public class CassandraIOTest implements Serializable {\n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n     int delay = 5000;\n+    Exception exception = null;\n     while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n+        if (exception == null) {\n+          exception = e;\n+        } else {\n+          exception.addSuppressed(e);\n+        }\n         tried++;\n         try {\n           Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n+          Thread thread = Thread.currentThread();\n+          thread.interrupt();\n+          throw new RuntimeException(String.format(\"Thread %s was interrupted\", thread.getName()));\n         }\n       }\n     }\n     throw new RuntimeException(\n         String.format(\n             \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n-            tried, delay));\n+            tried, delay),\n+        exception);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzYxMg==", "url": "https://github.com/apache/beam/pull/11578#discussion_r418487612", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tried++;\n          \n          \n            \n                    if (exception == null) {\n          \n          \n            \n                      exception = e;\n          \n          \n            \n                    } else {\n          \n          \n            \n                      exception.addSuppressed(e);\n          \n          \n            \n                    }\n          \n          \n            \n                    tried++;", "author": "mxm", "createdAt": "2020-05-01T10:08:57Z", "path": "sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java", "diffHunk": "@@ -153,18 +153,22 @@ public static void beforeClass() throws Exception {\n \n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n-    while (tried < 3) {\n+    int delay = 5000;\n+    while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n         tried++;", "originalCommit": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3MzYyOQ==", "url": "https://github.com/apache/beam/pull/11578#discussion_r419273629", "bodyText": "+1 thanks for the suggestion !", "author": "echauchot", "createdAt": "2020-05-04T08:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NzYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "chunk": "diff --git a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\nindex 9c68544059..0f91448ebe 100644\n--- a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n+++ b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n\n@@ -154,21 +154,31 @@ public class CassandraIOTest implements Serializable {\n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n     int delay = 5000;\n+    Exception exception = null;\n     while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n+        if (exception == null) {\n+          exception = e;\n+        } else {\n+          exception.addSuppressed(e);\n+        }\n         tried++;\n         try {\n           Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n+          Thread thread = Thread.currentThread();\n+          thread.interrupt();\n+          throw new RuntimeException(String.format(\"Thread %s was interrupted\", thread.getName()));\n         }\n       }\n     }\n     throw new RuntimeException(\n         String.format(\n             \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n-            tried, delay));\n+            tried, delay),\n+        exception);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4Nzg3MQ==", "url": "https://github.com/apache/beam/pull/11578#discussion_r418487871", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                throw new RuntimeException(\n          \n          \n            \n                    String.format(\n          \n          \n            \n                        \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n          \n          \n            \n                        tried, delay));\n          \n          \n            \n                throw new RuntimeException(\n          \n          \n            \n                    String.format(\n          \n          \n            \n                        \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n          \n          \n            \n                            tried, delay), \n          \n          \n            \n                        exception);", "author": "mxm", "createdAt": "2020-05-01T10:10:03Z", "path": "sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java", "diffHunk": "@@ -153,18 +153,22 @@ public static void beforeClass() throws Exception {\n \n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n-    while (tried < 3) {\n+    int delay = 5000;\n+    while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n         tried++;\n         try {\n-          Thread.sleep(1000L);\n+          Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n         }\n       }\n     }\n-    throw new RuntimeException(\"Unable to create embedded Cassandra cluster\");\n+    throw new RuntimeException(\n+        String.format(\n+            \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n+            tried, delay));", "originalCommit": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3Mzc2Nw==", "url": "https://github.com/apache/beam/pull/11578#discussion_r419273767", "bodyText": "+1 thanks for the suggestion !", "author": "echauchot", "createdAt": "2020-05-04T08:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4Nzg3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "chunk": "diff --git a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\nindex 9c68544059..0f91448ebe 100644\n--- a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n+++ b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n\n@@ -154,21 +154,31 @@ public class CassandraIOTest implements Serializable {\n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n     int delay = 5000;\n+    Exception exception = null;\n     while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n+        if (exception == null) {\n+          exception = e;\n+        } else {\n+          exception.addSuppressed(e);\n+        }\n         tried++;\n         try {\n           Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n+          Thread thread = Thread.currentThread();\n+          thread.interrupt();\n+          throw new RuntimeException(String.format(\"Thread %s was interrupted\", thread.getName()));\n         }\n       }\n     }\n     throw new RuntimeException(\n         String.format(\n             \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n-            tried, delay));\n+            tried, delay),\n+        exception);\n   }\n \n   @AfterClass\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4ODI5NQ==", "url": "https://github.com/apache/beam/pull/11578#discussion_r418488295", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (InterruptedException e1) {\n          \n          \n            \n                    } catch (InterruptedException e1) {\n          \n          \n            \n                      Thread.currentThread().interrupt();\n          \n          \n            \n                      throw new RuntimeException(\"interrupted\");\n          \n          \n            \n                    }", "author": "mxm", "createdAt": "2020-05-01T10:11:43Z", "path": "sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java", "diffHunk": "@@ -153,18 +153,22 @@ public static void beforeClass() throws Exception {\n \n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n-    while (tried < 3) {\n+    int delay = 5000;\n+    while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n         tried++;\n         try {\n-          Thread.sleep(1000L);\n+          Thread.sleep(delay);\n         } catch (InterruptedException e1) {", "originalCommit": "561b3688cd963c5c4bd6fb139f5bcf94bd2a43e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NDI1OQ==", "url": "https://github.com/apache/beam/pull/11578#discussion_r419274259", "bodyText": "Yeah, that was too quick of me to ignore the interrupted exception :)", "author": "echauchot", "createdAt": "2020-05-04T08:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4ODI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "chunk": "diff --git a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\nindex 9c68544059..0f91448ebe 100644\n--- a/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n+++ b/sdks/java/io/cassandra/src/test/java/org/apache/beam/sdk/io/cassandra/CassandraIOTest.java\n\n@@ -154,21 +154,31 @@ public class CassandraIOTest implements Serializable {\n   private static Cluster buildCluster(CassandraEmbeddedServerBuilder builder) {\n     int tried = 0;\n     int delay = 5000;\n+    Exception exception = null;\n     while (tried < 5) {\n       try {\n         return builder.buildNativeCluster();\n       } catch (NoHostAvailableException e) {\n+        if (exception == null) {\n+          exception = e;\n+        } else {\n+          exception.addSuppressed(e);\n+        }\n         tried++;\n         try {\n           Thread.sleep(delay);\n         } catch (InterruptedException e1) {\n+          Thread thread = Thread.currentThread();\n+          thread.interrupt();\n+          throw new RuntimeException(String.format(\"Thread %s was interrupted\", thread.getName()));\n         }\n       }\n     }\n     throw new RuntimeException(\n         String.format(\n             \"Unable to create embedded Cassandra cluster: tried %d times with %d delay\",\n-            tried, delay));\n+            tried, delay),\n+        exception);\n   }\n \n   @AfterClass\n"}}, {"oid": "0e93ccd2880728440490c38b90c6d48fcc736d1f", "url": "https://github.com/apache/beam/commit/0e93ccd2880728440490c38b90c6d48fcc736d1f", "message": "[BEAM-8025] Trace caught NoHostAvailableException and InterruptedException", "committedDate": "2020-05-04T08:45:46Z", "type": "commit"}]}