{"pr_number": 13345, "pr_title": "[BEAM-4136] Keep strong reference to loggers to avoid potential NPE", "pr_createdAt": "2020-11-13T23:34:31Z", "pr_url": "https://github.com/apache/beam/pull/13345", "timeline": [{"oid": "dd6898b8179cf6d8492207f390ef50149229590e", "url": "https://github.com/apache/beam/commit/dd6898b8179cf6d8492207f390ef50149229590e", "message": "Enable checker on BeamFnLoggingClient", "committedDate": "2020-11-13T23:27:47Z", "type": "commit"}, {"oid": "700ed4c65eabb9299e46a23e52fc6ce105808c93", "url": "https://github.com/apache/beam/commit/700ed4c65eabb9299e46a23e52fc6ce105808c93", "message": "keep a reference to loggers in BeamLoggingClientTest.testLogging", "committedDate": "2020-11-13T23:27:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMzNjEwNA==", "url": "https://github.com/apache/beam/pull/13345#discussion_r523336104", "bodyText": "Out of time for today, but I just noticed this can happen in other tests as well. For example in this run we see the same flake in testWhenServerHangsUpEarlyThatClientIsAbleCleanup\nLeaving a note here so I remember to fix it later", "author": "TheNeuralBit", "createdAt": "2020-11-14T01:44:05Z", "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java", "diffHunk": "@@ -146,20 +147,25 @@ public void testLogging() throws Exception {\n               apiServiceDescriptor,\n               (Endpoints.ApiServiceDescriptor descriptor) -> channel);\n \n+      // Keep a strong reference to the loggers in this block. Otherwise the call to client.close()\n+      // removes the only reference and the logger may get GC'd (BEAM-4136).\n+      Logger rootLogger = LogManager.getLogManager().getLogger(\"\");\n+      Logger configuredLogger = LogManager.getLogManager().getLogger(\"ConfiguredLogger\");\n+\n       // Ensure that log levels were correctly set.\n-      assertEquals(Level.OFF, LogManager.getLogManager().getLogger(\"\").getLevel());\n-      assertEquals(Level.FINE, LogManager.getLogManager().getLogger(\"ConfiguredLogger\").getLevel());\n+      assertEquals(Level.OFF, rootLogger.getLevel());\n+      assertEquals(Level.FINE, configuredLogger.getLevel());\n \n       // Should be filtered because the default log level override is OFF\n-      LogManager.getLogManager().getLogger(\"\").log(FILTERED_RECORD);\n+      rootLogger.log(FILTERED_RECORD);\n       // Should not be filtered because the default log level override for ConfiguredLogger is DEBUG\n-      LogManager.getLogManager().getLogger(\"ConfiguredLogger\").log(TEST_RECORD);\n-      LogManager.getLogManager().getLogger(\"ConfiguredLogger\").log(TEST_RECORD_WITH_EXCEPTION);\n+      configuredLogger.log(TEST_RECORD);\n+      configuredLogger.log(TEST_RECORD_WITH_EXCEPTION);\n       client.close();\n \n       // Verify that after close, log levels are reset.\n-      assertEquals(Level.INFO, LogManager.getLogManager().getLogger(\"\").getLevel());\n-      assertNull(LogManager.getLogManager().getLogger(\"ConfiguredLogger\").getLevel());\n+      assertEquals(Level.INFO, rootLogger.getLevel());\n+      assertNull(configuredLogger.getLevel());\n \n       assertTrue(clientClosedStream.get());\n       assertTrue(channel.isShutdown());", "originalCommit": "700ed4c65eabb9299e46a23e52fc6ce105808c93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQzMTEyNw==", "url": "https://github.com/apache/beam/pull/13345#discussion_r524431127", "bodyText": "ok I fixed the other tests as well, PTAL", "author": "TheNeuralBit", "createdAt": "2020-11-16T17:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMzNjEwNA=="}], "type": "inlineReview", "revised_code": {"commit": "eded3452042d6c4f306c00258121cd4ab579e8be", "chunk": "diff --git a/sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java b/sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java\nindex 3c3ec2dae2..93c1b3d0ef 100644\n--- a/sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java\n+++ b/sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java\n\n@@ -148,7 +149,7 @@ public class BeamFnLoggingClientTest {\n               (Endpoints.ApiServiceDescriptor descriptor) -> channel);\n \n       // Keep a strong reference to the loggers in this block. Otherwise the call to client.close()\n-      // removes the only reference and the logger may get GC'd (BEAM-4136).\n+      // removes the only reference and the logger may get GC'd before the assertions (BEAM-4136).\n       Logger rootLogger = LogManager.getLogManager().getLogger(\"\");\n       Logger configuredLogger = LogManager.getLogManager().getLogger(\"ConfiguredLogger\");\n \n"}}, {"oid": "eded3452042d6c4f306c00258121cd4ab579e8be", "url": "https://github.com/apache/beam/commit/eded3452042d6c4f306c00258121cd4ab579e8be", "message": "Fix other BeamFnLoggingClientTest tests", "committedDate": "2020-11-16T17:08:25Z", "type": "commit"}]}