{"pr_number": 11814, "pr_title": "[BEAM-10078] uniquify Dataflow specific jars when staging", "pr_createdAt": "2020-05-26T03:20:14Z", "pr_url": "https://github.com/apache/beam/pull/11814", "timeline": [{"oid": "04e8e095043e563059255edda7795c51a21d4bd6", "url": "https://github.com/apache/beam/commit/04e8e095043e563059255edda7795c51a21d4bd6", "message": "[BEAM-10078] uniquify Dataflow specific jars when staging", "committedDate": "2020-05-27T19:13:37Z", "type": "commit"}, {"oid": "04e8e095043e563059255edda7795c51a21d4bd6", "url": "https://github.com/apache/beam/commit/04e8e095043e563059255edda7795c51a21d4bd6", "message": "[BEAM-10078] uniquify Dataflow specific jars when staging", "committedDate": "2020-05-27T19:13:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NzA3OQ==", "url": "https://github.com/apache/beam/pull/11814#discussion_r431387079", "bodyText": "I'm not sure why we need special treatment for Dataflow jars here. Behavior for these jars should be similar for any other jars uploaded for Dataflow IMO.\n@lukecwik WDYT ?", "author": "chamikaramj", "createdAt": "2020-05-27T19:18:50Z", "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java", "diffHunk": "@@ -397,10 +397,21 @@ public static PackageAttributes forFileToStage(\n             String.format(\"Non-existent file to stage: %s\", file.getAbsolutePath()));\n       }\n       checkState(!file.isDirectory(), \"Source file must not be a directory.\");\n+      String target;\n+      switch (dest) {\n+        case \"dataflow-worker.jar\":", "originalCommit": "04e8e095043e563059255edda7795c51a21d4bd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNDQxOA==", "url": "https://github.com/apache/beam/pull/11814#discussion_r432014418", "bodyText": "Can we add a log statement describing why we need special treatment for these jars ? I see these jars being specifically being referenced to in Dataflow boot.go files.May be that's why ?", "author": "chamikaramj", "createdAt": "2020-05-28T17:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA5OTkzMw==", "url": "https://github.com/apache/beam/pull/11814#discussion_r432099933", "bodyText": "Put some comments and logging", "author": "ihji", "createdAt": "2020-05-28T20:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NzA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "dea793d9dae4f612dc15047c892f52147fe19b2a", "chunk": "diff --git a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\nindex e9804931f4..036d2dbf05 100644\n--- a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\n+++ b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java\n\n@@ -398,12 +398,18 @@ public class PackageUtil implements Closeable {\n       }\n       checkState(!file.isDirectory(), \"Source file must not be a directory.\");\n       String target;\n+      // Dataflow worker jar and windmill binary can be overridden by providing files with\n+      // predefined file names. Normally, we can use the artifact file name as same as\n+      // the last component of GCS object resource path. However, we need special handling\n+      // for those predefined names since they also need to be unique even in the same\n+      // staging directory.\n       switch (dest) {\n         case \"dataflow-worker.jar\":\n         case \"windmill_main\":\n           target =\n               Environments.createStagingFileName(\n                   file, Files.asByteSource(file).hash(Hashing.sha256()));\n+          LOG.info(\"Staging custom {} as {}\", dest, target);\n           break;\n         default:\n           target = dest;\n"}}, {"oid": "dea793d9dae4f612dc15047c892f52147fe19b2a", "url": "https://github.com/apache/beam/commit/dea793d9dae4f612dc15047c892f52147fe19b2a", "message": "add comments and logging", "committedDate": "2020-05-28T20:17:54Z", "type": "commit"}]}