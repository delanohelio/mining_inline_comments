{"pr_number": 12618, "pr_title": "[BEAM-10669] Add support for Dataflow Templates in SnowflakeIO", "pr_createdAt": "2020-08-18T19:13:39Z", "pr_url": "https://github.com/apache/beam/pull/12618", "timeline": [{"oid": "a79484e07a6a79b23df04bb7b63546ef9d5aee30", "url": "https://github.com/apache/beam/commit/a79484e07a6a79b23df04bb7b63546ef9d5aee30", "message": "[BEAM-10669] Changed SnowflakeIO parameters to ValueProvider<> and moved most of functionalities to expand methods", "committedDate": "2020-08-13T12:01:19Z", "type": "commit"}, {"oid": "2d033c0ec145facf9b5411f1b4f9a6d8ce504c23", "url": "https://github.com/apache/beam/commit/2d033c0ec145facf9b5411f1b4f9a6d8ce504c23", "message": "[BEAM-10669] Changed quotation mark to value provider variable", "committedDate": "2020-08-17T11:20:30Z", "type": "commit"}, {"oid": "adcbdea094a89857ad08757de6e30362c5d945b0", "url": "https://github.com/apache/beam/commit/adcbdea094a89857ad08757de6e30362c5d945b0", "message": "[BEAM-10669] Added required pipeline options", "committedDate": "2020-08-17T11:33:16Z", "type": "commit"}, {"oid": "6c7cadd9c3e012bb9cd6c37333093407381684af", "url": "https://github.com/apache/beam/commit/6c7cadd9c3e012bb9cd6c37333093407381684af", "message": "[BEAM-10669] Excluded test key in Snowflake resources in RAT task", "committedDate": "2020-08-19T11:05:16Z", "type": "commit"}, {"oid": "df488686ede295f009cfeebbb1bbec58d8cbe0f5", "url": "https://github.com/apache/beam/commit/df488686ede295f009cfeebbb1bbec58d8cbe0f5", "message": "Merge branch 'master' into support-templates-in-snowflakeio", "committedDate": "2020-08-21T05:38:33Z", "type": "commit"}, {"oid": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "url": "https://github.com/apache/beam/commit/1b8fb4b691c068b97c9caf265d7410580a6a922b", "message": "[BEAM-10669] fixed dependencies in Snowflake streaming IOIT test", "committedDate": "2020-08-21T16:29:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MzczOQ==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481283739", "bodyText": "This should be setQuotationMark?", "author": "pabloem", "createdAt": "2020-09-01T16:38:44Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -390,6 +407,12 @@\n      * @return\n      */\n     public Read<T> withQuotationMark(String quotationMark) {\n+      return toBuilder()\n+          .setStorageIntegrationName(ValueProvider.StaticValueProvider.of(quotationMark))", "originalCommit": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0OTAyMw==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481949023", "bodyText": "Good catch, thanks :)", "author": "purbanow", "createdAt": "2020-09-02T09:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MzczOQ=="}], "type": "inlineReview", "revised_code": {"commit": "0d043840746e9025f7979a2c644ab7af11d28a2c", "chunk": "diff --git a/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java b/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\nindex 3bb90a6692..22e8c6dd50 100644\n--- a/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\n+++ b/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\n\n@@ -408,7 +408,7 @@ public class SnowflakeIO {\n      */\n     public Read<T> withQuotationMark(String quotationMark) {\n       return toBuilder()\n-          .setStorageIntegrationName(ValueProvider.StaticValueProvider.of(quotationMark))\n+          .setQuotationMark(ValueProvider.StaticValueProvider.of(quotationMark))\n           .build();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5MDQyMg==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481290422", "bodyText": "In this case, the key comes from a file path in the local machine at pipeline construction time. Is that right?", "author": "pabloem", "createdAt": "2020-09-01T16:49:48Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -1302,123 +1381,249 @@ public void finishBundle() throws Exception {\n     }\n   }\n \n-  private static String getValueOrNull(ValueProvider<String> valueProvider) {\n-    return valueProvider != null ? valueProvider.get() : null;\n-  }\n-\n   /**\n    * A POJO describing a {@link DataSource}, providing all properties allowing to create a {@link\n    * DataSource}.\n    */\n   @AutoValue\n   public abstract static class DataSourceConfiguration implements Serializable {\n+    @Nullable\n+    public abstract String getUrl();\n \n-    public abstract @Nullable String getUrl();\n+    @Nullable\n+    public abstract ValueProvider<String> getUsername();\n \n-    public abstract @Nullable String getUsername();\n+    @Nullable\n+    public abstract ValueProvider<String> getPassword();\n \n-    public abstract @Nullable String getPassword();\n+    @Nullable\n+    public abstract PrivateKey getPrivateKey();\n \n-    public abstract @Nullable PrivateKey getPrivateKey();\n+    @Nullable\n+    public abstract String getPrivateKeyPath();\n \n-    public abstract @Nullable String getOauthToken();\n+    @Nullable\n+    public abstract ValueProvider<String> getRawPrivateKey();\n \n-    public abstract @Nullable String getDatabase();\n+    @Nullable\n+    public abstract ValueProvider<String> getPrivateKeyPassphrase();\n \n-    public abstract @Nullable String getWarehouse();\n+    @Nullable\n+    public abstract ValueProvider<String> getOauthToken();\n \n-    public abstract @Nullable String getSchema();\n+    @Nullable\n+    public abstract ValueProvider<String> getDatabase();\n \n-    public abstract @Nullable String getServerName();\n+    @Nullable\n+    public abstract ValueProvider<String> getWarehouse();\n \n-    public abstract @Nullable Integer getPortNumber();\n+    @Nullable\n+    public abstract ValueProvider<String> getSchema();\n \n-    public abstract @Nullable String getRole();\n+    @Nullable\n+    public abstract ValueProvider<String> getServerName();\n \n-    public abstract @Nullable Integer getLoginTimeout();\n+    @Nullable\n+    public abstract Integer getPortNumber();\n \n-    public abstract @Nullable Boolean getSsl();\n+    @Nullable\n+    public abstract ValueProvider<String> getRole();\n \n-    public abstract @Nullable Boolean getValidate();\n+    @Nullable\n+    public abstract String getAuthenticator();\n \n-    public abstract @Nullable DataSource getDataSource();\n+    @Nullable\n+    public abstract Integer getLoginTimeout();\n+\n+    @Nullable\n+    public abstract Boolean getSsl();\n+\n+    @Nullable\n+    public abstract DataSource getDataSource();\n \n     abstract Builder builder();\n \n     @AutoValue.Builder\n     abstract static class Builder {\n       abstract Builder setUrl(String url);\n \n-      abstract Builder setUsername(String username);\n+      abstract Builder setUsername(ValueProvider<String> username);\n \n-      abstract Builder setPassword(String password);\n+      abstract Builder setPassword(ValueProvider<String> password);\n \n       abstract Builder setPrivateKey(PrivateKey privateKey);\n \n-      abstract Builder setOauthToken(String oauthToken);\n+      abstract Builder setPrivateKeyPath(String privateKeyPath);\n+\n+      abstract Builder setRawPrivateKey(ValueProvider<String> rawPrivateKey);\n+\n+      abstract Builder setPrivateKeyPassphrase(ValueProvider<String> privateKeyPassphrase);\n \n-      abstract Builder setDatabase(String database);\n+      abstract Builder setOauthToken(ValueProvider<String> oauthToken);\n \n-      abstract Builder setWarehouse(String warehouse);\n+      abstract Builder setDatabase(ValueProvider<String> database);\n \n-      abstract Builder setSchema(String schema);\n+      abstract Builder setWarehouse(ValueProvider<String> warehouse);\n \n-      abstract Builder setServerName(String serverName);\n+      abstract Builder setSchema(ValueProvider<String> schema);\n+\n+      abstract Builder setServerName(ValueProvider<String> serverName);\n \n       abstract Builder setPortNumber(Integer portNumber);\n \n-      abstract Builder setRole(String role);\n+      abstract Builder setRole(ValueProvider<String> role);\n+\n+      abstract Builder setAuthenticator(String authenticator);\n \n       abstract Builder setLoginTimeout(Integer loginTimeout);\n \n       abstract Builder setSsl(Boolean ssl);\n \n-      abstract Builder setValidate(Boolean validate);\n-\n       abstract Builder setDataSource(DataSource dataSource);\n \n       abstract DataSourceConfiguration build();\n     }\n \n+    public static DataSourceConfiguration create() {\n+      return new AutoValue_SnowflakeIO_DataSourceConfiguration.Builder().build();\n+    }\n+\n     /**\n      * Creates {@link DataSourceConfiguration} from existing instance of {@link DataSource}.\n      *\n-     * @param dataSource an instance of {@link DataSource}.\n+     * @param dataSource - an instance of {@link DataSource}.\n      */\n     public static DataSourceConfiguration create(DataSource dataSource) {\n       checkArgument(dataSource instanceof Serializable, \"dataSource must be Serializable\");\n       return new AutoValue_SnowflakeIO_DataSourceConfiguration.Builder()\n-          .setValidate(true)\n           .setDataSource(dataSource)\n           .build();\n     }\n \n     /**\n-     * Creates {@link DataSourceConfiguration} from instance of {@link SnowflakeCredentials}.\n+     * Sets username/password authentication.\n      *\n-     * @param credentials an instance of {@link SnowflakeCredentials}.\n+     * @param username - Snowflake username.\n+     * @param password - Password for provided Snowflake username.\n      */\n-    public static DataSourceConfiguration create(SnowflakeCredentials credentials) {\n-      if (credentials instanceof UsernamePasswordSnowflakeCredentials) {\n-        return new AutoValue_SnowflakeIO_DataSourceConfiguration.Builder()\n-            .setValidate(true)\n-            .setUsername(((UsernamePasswordSnowflakeCredentials) credentials).getUsername())\n-            .setPassword(((UsernamePasswordSnowflakeCredentials) credentials).getPassword())\n-            .build();\n-      } else if (credentials instanceof OAuthTokenSnowflakeCredentials) {\n-        return new AutoValue_SnowflakeIO_DataSourceConfiguration.Builder()\n-            .setValidate(true)\n-            .setOauthToken(((OAuthTokenSnowflakeCredentials) credentials).getToken())\n-            .build();\n-      } else if (credentials instanceof KeyPairSnowflakeCredentials) {\n-        return new AutoValue_SnowflakeIO_DataSourceConfiguration.Builder()\n-            .setValidate(true)\n-            .setUsername(((KeyPairSnowflakeCredentials) credentials).getUsername())\n-            .setPrivateKey(((KeyPairSnowflakeCredentials) credentials).getPrivateKey())\n-            .build();\n-      }\n-      throw new IllegalArgumentException(\n-          \"Can't create DataSourceConfiguration from given credentials\");\n+    public DataSourceConfiguration withUsernamePasswordAuth(String username, String password) {\n+      return builder()\n+          .setUsername(ValueProvider.StaticValueProvider.of(username))\n+          .setPassword(ValueProvider.StaticValueProvider.of(password))\n+          .build();\n+    }\n+\n+    /**\n+     * Sets username/password authentication.\n+     *\n+     * @param username - Snowflake username.\n+     * @param password - Password for provided Snowflake username.\n+     */\n+    public DataSourceConfiguration withUsernamePasswordAuth(\n+        ValueProvider<String> username, ValueProvider<String> password) {\n+      return builder().setUsername(username).setPassword(password).build();\n+    }\n+\n+    /**\n+     * Sets OAuth authentication.\n+     *\n+     * @param token - OAuth token.\n+     */\n+    public DataSourceConfiguration withOAuth(String token) {\n+      return builder().setOauthToken(ValueProvider.StaticValueProvider.of(token)).build();\n+    }\n+\n+    /**\n+     * Sets OAuth authentication.\n+     *\n+     * @param token - OAuth token.\n+     */\n+    public DataSourceConfiguration withOAuth(ValueProvider<String> token) {\n+      return builder().setOauthToken(token).build();\n+    }\n+\n+    /**\n+     * Sets key pair authentication.\n+     *\n+     * @param username - Snowflake username.\n+     * @param privateKey - Private key.\n+     */\n+    public DataSourceConfiguration withKeyPairAuth(String username, PrivateKey privateKey) {\n+      return builder()\n+          .setUsername(ValueProvider.StaticValueProvider.of(username))\n+          .setPrivateKey(privateKey)\n+          .build();\n+    }\n+\n+    /**\n+     * Sets key pair authentication.\n+     *\n+     * @param username - Snowflake username.\n+     * @param privateKeyPath - Private key path.\n+     * @param privateKeyPassphrase - Passphrase for provided private key.\n+     */\n+    public DataSourceConfiguration withKeyPairPathAuth(\n+        ValueProvider<String> username,\n+        String privateKeyPath,\n+        ValueProvider<String> privateKeyPassphrase) {\n+      String privateKey = KeyPairUtils.readPrivateKeyFile(privateKeyPath);", "originalCommit": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk1Nzg0NA==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481957844", "bodyText": "Exactly :)", "author": "purbanow", "createdAt": "2020-09-02T10:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5MDQyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTEwOQ==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481295109", "bodyText": "These data are sensitive, so maybe we should not show them so readily. They are part of the create job request, and also visible in the UI (by anyone who has access to the job, including support engineers). (to be fair, PipelineOptions are also visible in the UI) - are you sure it makes sense to make them display data?\nI don't have strong opinions either way, but I think it makes sense to reflect what's the best approach.", "author": "pabloem", "createdAt": "2020-09-01T16:57:19Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -1532,26 +1767,47 @@ public DataSource buildDatasource() {\n         SnowflakeBasicDataSource basicDataSource = new SnowflakeBasicDataSource();\n         basicDataSource.setUrl(buildUrl());\n \n-        if (getUsername() != null) {\n-          basicDataSource.setUser(getUsername());\n+        if (isNotEmpty(getOauthToken())) {\n+          basicDataSource.setOauthToken(getOauthToken().get());\n+        } else if (isNotEmpty(getUsername()) && getPrivateKey() != null) {\n+          basicDataSource.setUser(getUsername().get());\n+          basicDataSource.setPrivateKey(getPrivateKey());\n+        } else if (isNotEmpty(getUsername())\n+            && isNotEmpty(getPrivateKeyPassphrase())\n+            && isNotEmpty(getRawPrivateKey())) {\n+          PrivateKey privateKey =\n+              KeyPairUtils.preparePrivateKey(\n+                  getRawPrivateKey().get(), getPrivateKeyPassphrase().get());\n+          basicDataSource.setPrivateKey(privateKey);\n+          basicDataSource.setUser(getUsername().get());\n+", "originalCommit": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4NTI5NA==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482085294", "bodyText": "It make sense to hide those options.\nI tried to hide those options but without success. Do you have any tips how to accomplish this ?", "author": "purbanow", "createdAt": "2020-09-02T13:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5OTU3MQ==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482399571", "bodyText": "The only way to 'hide' them would be to remove them from display data. It's up to you if you'd like to keep it in DD or remove it.", "author": "pabloem", "createdAt": "2020-09-02T20:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQwOTM2Ng==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482409366", "bodyText": "up to you. I am happy to merge as-is, or remove.", "author": "pabloem", "createdAt": "2020-09-02T20:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjczNDEwOA==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482734108", "bodyText": "Let's merge it for now and see the feedback from users.", "author": "purbanow", "createdAt": "2020-09-03T06:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5NTEwOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5ODU4Nw==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481298587", "bodyText": "populateDisplayData is called at pipeline construction time. Since you're adding support for ValueProviders, you're enabling users to fill in the data for their credentials AFTER construction time. Imagine you're building a template. In that case, none of the credentials will be known.\nTherefore, I think you likely don't want to throw this exception.", "author": "pabloem", "createdAt": "2020-09-01T17:03:16Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -1532,26 +1767,47 @@ public DataSource buildDatasource() {\n         SnowflakeBasicDataSource basicDataSource = new SnowflakeBasicDataSource();\n         basicDataSource.setUrl(buildUrl());\n \n-        if (getUsername() != null) {\n-          basicDataSource.setUser(getUsername());\n+        if (isNotEmpty(getOauthToken())) {\n+          basicDataSource.setOauthToken(getOauthToken().get());\n+        } else if (isNotEmpty(getUsername()) && getPrivateKey() != null) {\n+          basicDataSource.setUser(getUsername().get());\n+          basicDataSource.setPrivateKey(getPrivateKey());\n+        } else if (isNotEmpty(getUsername())\n+            && isNotEmpty(getPrivateKeyPassphrase())\n+            && isNotEmpty(getRawPrivateKey())) {\n+          PrivateKey privateKey =\n+              KeyPairUtils.preparePrivateKey(\n+                  getRawPrivateKey().get(), getPrivateKeyPassphrase().get());\n+          basicDataSource.setPrivateKey(privateKey);\n+          basicDataSource.setUser(getUsername().get());\n+\n+        } else if (isNotEmpty(getUsername()) && isNotEmpty(getPassword())) {\n+          basicDataSource.setUser(getUsername().get());\n+          basicDataSource.setPassword(getPassword().get());\n+        } else {\n+          throw new RuntimeException(\"Missing credentials values. Please check your credentials\");", "originalCommit": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk2MzE1MQ==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481963151", "bodyText": "Before using provided credentials we're checking them using isNotEmpty method.\nWe tested it with dataflow templates by providing credentials from Dataflow UI.", "author": "purbanow", "createdAt": "2020-09-02T10:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5ODU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5OTk5NA==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482399994", "bodyText": "LGTM then.", "author": "pabloem", "createdAt": "2020-09-02T20:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5ODU4Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwMTU3Mg==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481301572", "bodyText": "I see you're using this method at pipeline construction time. Note that for RuntimeValueProviders, they will throw an exception when you ccall get on them at construction time.\nThe documentation is poor, but it'll throw IllegalStateException - so you also need to call valueProvider.isAccessible() before calling get on it. - and if it's not yet accessible, then that does not mean it's empty or not. It just means that we'll know later whether it's empty.\nVP javadoc: https://beam.apache.org/releases/javadoc/2.23.0/org/apache/beam/sdk/options/ValueProvider.html\nI hope I did not confuse you more here : )", "author": "pabloem", "createdAt": "2020-09-01T17:08:36Z", "path": "sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java", "diffHunk": "@@ -1623,4 +1867,12 @@ public DataSourceConfiguration getConfig() {\n       return this.config;\n     }\n   }\n+\n+  private static String getValueOrNull(ValueProvider<String> valueProvider) {\n+    return valueProvider != null ? valueProvider.get() : null;\n+  }\n+\n+  private static boolean isNotEmpty(ValueProvider<String> valueProvider) {\n+    return valueProvider != null && valueProvider.get() != null && !valueProvider.get().isEmpty();", "originalCommit": "1b8fb4b691c068b97c9caf265d7410580a6a922b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk2NjgwNw==", "url": "https://github.com/apache/beam/pull/12618#discussion_r481966807", "bodyText": "No, it will not throw any exception. We tested it as simple jobs and as templates.\nJAVA syntax is working in the way that valueProvider.get() != null is never going to be call if valueProvider != null  returns false  + all options inside SnowflakePipelineOptionshave default value or required annotation.\nIn terms of using valueProvider.isAccessible(), I tried to use it but it didn't work as I wanted. Assuming user is going to pass username variable  as null, then valueProvider.isAccessible() is going to return true but calling valueProvider.get().isEmpty() will result in NullPointException  as valueProvider.get() is  returning null.", "author": "purbanow", "createdAt": "2020-09-02T10:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwMTU3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5ODc2Ng==", "url": "https://github.com/apache/beam/pull/12618#discussion_r482398766", "bodyText": "okay, if you've tested this, then it LGTM.", "author": "pabloem", "createdAt": "2020-09-02T20:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMwMTU3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0d043840746e9025f7979a2c644ab7af11d28a2c", "chunk": "diff --git a/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java b/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\nindex 3bb90a6692..22e8c6dd50 100644\n--- a/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\n+++ b/sdks/java/io/snowflake/src/main/java/org/apache/beam/sdk/io/snowflake/SnowflakeIO.java\n\n@@ -1873,6 +1873,6 @@ public class SnowflakeIO {\n   }\n \n   private static boolean isNotEmpty(ValueProvider<String> valueProvider) {\n-    return valueProvider != null && valueProvider.get() != null && !valueProvider.get().isEmpty();\n+    return valueProvider != null && valueProvider.isAccessible() && !valueProvider.get().isEmpty();\n   }\n }\n"}}, {"oid": "0d043840746e9025f7979a2c644ab7af11d28a2c", "url": "https://github.com/apache/beam/commit/0d043840746e9025f7979a2c644ab7af11d28a2c", "message": "refactor: isNotEmpty method", "committedDate": "2020-09-02T10:51:32Z", "type": "commit"}, {"oid": "9828997a5192eba7a721cee8beb958ef70fe5018", "url": "https://github.com/apache/beam/commit/9828997a5192eba7a721cee8beb958ef70fe5018", "message": "Merge branch 'master' of https://github.com/apache/beam into support-templates-in-snowflakeio", "committedDate": "2020-09-02T12:46:22Z", "type": "commit"}, {"oid": "9828997a5192eba7a721cee8beb958ef70fe5018", "url": "https://github.com/apache/beam/commit/9828997a5192eba7a721cee8beb958ef70fe5018", "message": "Merge branch 'master' of https://github.com/apache/beam into support-templates-in-snowflakeio", "committedDate": "2020-09-02T12:46:22Z", "type": "forcePushed"}]}