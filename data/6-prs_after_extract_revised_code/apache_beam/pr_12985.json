{"pr_number": 12985, "pr_title": "[BEAM-10994] Adds ability to log literal hot key in Batch Dataflow", "pr_createdAt": "2020-10-01T00:12:19Z", "pr_url": "https://github.com/apache/beam/pull/12985", "timeline": [{"oid": "e10b82307ebd12eebc3683c054742e988e44ab9b", "url": "https://github.com/apache/beam/commit/e10b82307ebd12eebc3683c054742e988e44ab9b", "message": "Implement the BatchDataflowWorker hot key logging", "committedDate": "2020-10-07T20:10:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NTc1Mw==", "url": "https://github.com/apache/beam/pull/12985#discussion_r504145753", "bodyText": "See my earlier comment on #12984 about assuming that key == null is the same thing as not present.", "author": "lukecwik", "createdAt": "2020-10-13T17:49:49Z", "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowWorkProgressUpdater.java", "diffHunk": "@@ -103,9 +112,17 @@ protected void reportProgressHelper() throws Exception {\n       if (result.getHotKeyDetection() != null\n           && result.getHotKeyDetection().getUserStepName() != null) {\n         HotKeyDetection hotKeyDetection = result.getHotKeyDetection();\n+\n+        // The key set the in BatchModeExecutionContext is only set in the GroupingShuffleReader\n+        // which is the correct key. The key is also translated into a Java object in the reader.\n+        Object hotkey =\n+            options.isHotKeyLoggingEnabled()\n+                ? workItemStatusClient.getExecutionContext().getKey()\n+                : null;", "originalCommit": "e10b82307ebd12eebc3683c054742e988e44ab9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4MzIxOQ==", "url": "https://github.com/apache/beam/pull/12985#discussion_r504183219", "bodyText": "In the BatchModeExecutionContext the getKey method's comment states \"If there is not a currently defined key, returns null.\" Is this an error? Do you want me to update the comment?", "author": "rohdesamuel", "createdAt": "2020-10-13T18:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMjYwNA==", "url": "https://github.com/apache/beam/pull/12985#discussion_r504302604", "bodyText": "That is a bug.", "author": "lukecwik", "createdAt": "2020-10-13T22:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTgwNw==", "url": "https://github.com/apache/beam/pull/12985#discussion_r504869807", "bodyText": "Gotcha, I changed the logging", "author": "rohdesamuel", "createdAt": "2020-10-14T18:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NTc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7d0b711c5fdc712dd0b6caccab889172cbde7f8e", "chunk": "diff --git a/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowWorkProgressUpdater.java b/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowWorkProgressUpdater.java\nindex 9e8e61da50..fef59f4ca7 100644\n--- a/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowWorkProgressUpdater.java\n+++ b/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowWorkProgressUpdater.java\n\n@@ -104,11 +106,23 @@ public class DataflowWorkProgressUpdater extends WorkProgressUpdater {\n \n   @Override\n   protected void reportProgressHelper() throws Exception {\n+    if (wasAskedToAbort) {\n+      LOG.info(\"Service already asked to abort work item, not reporting ignored progress.\");\n+      return;\n+    }\n     WorkItemServiceState result =\n         workItemStatusClient.reportUpdate(\n             dynamicSplitResultToReport, Duration.millis(requestedLeaseDurationMs));\n \n     if (result != null) {\n+      if (result.getCompleteWorkStatus() != null\n+          && result.getCompleteWorkStatus().getCode() != com.google.rpc.Code.OK.getNumber()) {\n+        LOG.info(\"Service asked worker to abort with status: {}\", result.getCompleteWorkStatus());\n+        wasAskedToAbort = true;\n+        worker.abort();\n+        return;\n+      }\n+\n       if (result.getHotKeyDetection() != null\n           && result.getHotKeyDetection().getUserStepName() != null) {\n         HotKeyDetection hotKeyDetection = result.getHotKeyDetection();\n"}}, {"oid": "7d0b711c5fdc712dd0b6caccab889172cbde7f8e", "url": "https://github.com/apache/beam/commit/7d0b711c5fdc712dd0b6caccab889172cbde7f8e", "message": "Implement the BatchDataflowWorker hot key logging", "committedDate": "2020-10-14T00:32:17Z", "type": "commit"}, {"oid": "c70d8c46b84ce4dd9a9958b312adfbce59058809", "url": "https://github.com/apache/beam/commit/c70d8c46b84ce4dd9a9958b312adfbce59058809", "message": "Change key logging to allow for null keys", "committedDate": "2020-10-14T17:58:21Z", "type": "commit"}, {"oid": "c70d8c46b84ce4dd9a9958b312adfbce59058809", "url": "https://github.com/apache/beam/commit/c70d8c46b84ce4dd9a9958b312adfbce59058809", "message": "Change key logging to allow for null keys", "committedDate": "2020-10-14T17:58:21Z", "type": "forcePushed"}]}