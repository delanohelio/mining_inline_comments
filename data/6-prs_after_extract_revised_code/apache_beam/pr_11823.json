{"pr_number": 11823, "pr_title": "[BEAM-7568] Avoid re-encoding value state cells each commit", "pr_createdAt": "2020-05-27T02:07:45Z", "pr_url": "https://github.com/apache/beam/pull/11823", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzNjQ3NA==", "url": "https://github.com/apache/beam/pull/11823#discussion_r430836474", "bodyText": "This logic is really frustrating that we are encoding because we aren't returning the size of what we read as part of the state future from WindmillStateReader.\nThis could be better but this is definitely an improvement to not re-encode the value needlessly.", "author": "lukecwik", "createdAt": "2020-05-27T03:24:59Z", "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/WindmillStateInternals.java", "diffHunk": "@@ -410,14 +416,18 @@ protected WorkItemCommitRequest persistDirectly(WindmillStateCache.ForKey cache)\n         return WorkItemCommitRequest.newBuilder().buildPartial();\n       }\n \n-      ByteString.Output stream = ByteString.newOutput();\n-      if (value != null) {\n-        coder.encode(value, stream, Coder.Context.OUTER);\n+      ByteString encoded = null;\n+      if (cachedSize == -1 || modified) {", "originalCommit": "47651b5dafd62944f545e3632ff70dd15dfceb99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzNzQ4MQ==", "url": "https://github.com/apache/beam/pull/11823#discussion_r430837481", "bodyText": "agreed, it took me awhile to reason this out w/ the different code paths that can affect the values here.  I'm reasonably sure you don't need the cachedSize == -1 branch but, it's been working like this for ~1 year so I didn't want to tempt fate.\nThere's also the case where this is the first write, but valueIsKnown = false (because isNewKey = false), so we end up with a read that doesn't return anything.\nThanks for the quick reviews!", "author": "steveniemitz", "createdAt": "2020-05-27T03:29:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzNjQ3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "210e9e284cf7d08406094d1ab06f7edb168f89c4", "url": "https://github.com/apache/beam/commit/210e9e284cf7d08406094d1ab06f7edb168f89c4", "message": "Avoid re-encoding value state cells each commit", "committedDate": "2020-05-27T13:13:02Z", "type": "commit"}, {"oid": "210e9e284cf7d08406094d1ab06f7edb168f89c4", "url": "https://github.com/apache/beam/commit/210e9e284cf7d08406094d1ab06f7edb168f89c4", "message": "Avoid re-encoding value state cells each commit", "committedDate": "2020-05-27T13:13:02Z", "type": "forcePushed"}]}