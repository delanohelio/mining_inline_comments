{"pr_number": 1505, "pr_title": "Hive: Make HiveCatalog based tables automatically readable from Hive", "pr_createdAt": "2020-09-24T13:39:29Z", "pr_url": "https://github.com/apache/iceberg/pull/1505", "timeline": [{"oid": "b9a330b95b511549a7d2c9dd6982d28087d6172d", "url": "https://github.com/apache/iceberg/commit/b9a330b95b511549a7d2c9dd6982d28087d6172d", "message": "Hive: Make HiveCatalog based tables automatically readable from Hive", "committedDate": "2020-09-24T13:36:41Z", "type": "commit"}, {"oid": "74c6c1652f6fbd1b5ecd37798f78a33a125d56aa", "url": "https://github.com/apache/iceberg/commit/74c6c1652f6fbd1b5ecd37798f78a33a125d56aa", "message": "Fixing checkstyle error", "committedDate": "2020-09-24T15:53:06Z", "type": "commit"}, {"oid": "ba1a1e44b2df9b35f9ffa9debc576a93868bbd53", "url": "https://github.com/apache/iceberg/commit/ba1a1e44b2df9b35f9ffa9debc576a93868bbd53", "message": "Added a table configuration to enable/disable hive access", "committedDate": "2020-09-25T09:57:30Z", "type": "commit"}, {"oid": "7f1b3724fc5d711af0849c932ee9d124fff791f1", "url": "https://github.com/apache/iceberg/commit/7f1b3724fc5d711af0849c932ee9d124fff791f1", "message": "Added the possibility to use hive-site.xml for configuring the hive engine related properties", "committedDate": "2020-09-25T10:26:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzODMwMQ==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495138301", "bodyText": "I think this should be in the storageDescriptor method instead of here in the commit.", "author": "rdblue", "createdAt": "2020-09-25T17:40:55Z", "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java", "diffHunk": "@@ -169,6 +171,15 @@ protected void doCommit(TableMetadata base, TableMetadata metadata) {\n         tbl.getParameters().put(\"EXTERNAL\", \"TRUE\"); // using the external table type also requires this\n       }\n \n+      // If  needed set the required properties on the table to be able to query from Hive\n+      if (hiveEngineEnabled(metadata, conf)) {", "originalCommit": "7f1b3724fc5d711af0849c932ee9d124fff791f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc4OQ==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495426789", "bodyText": "Done", "author": "pvary", "createdAt": "2020-09-26T07:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzODMwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a36a0ad5f1ff6796909c86a52420f6702e8f20bc", "chunk": "diff --git a/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java b/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\nindex 8dc0ef326..c46c74519 100644\n--- a/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\n+++ b/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\n\n@@ -171,13 +173,10 @@ public class HiveTableOperations extends BaseMetastoreTableOperations {\n         tbl.getParameters().put(\"EXTERNAL\", \"TRUE\"); // using the external table type also requires this\n       }\n \n-      // If  needed set the required properties on the table to be able to query from Hive\n-      if (hiveEngineEnabled(metadata, conf)) {\n+      // If needed set the 'storate_handler' property to enable query from Hive\n+      if (hiveEngineEnabled) {\n         tbl.getParameters().put(hive_metastoreConstants.META_TABLE_STORAGE,\n             \"org.apache.iceberg.mr.hive.HiveIcebergStorageHandler\");\n-        tbl.getSd().getSerdeInfo().setSerializationLib(\"org.apache.iceberg.mr.hive.HiveIcebergSerDe\");\n-        tbl.getSd().setInputFormat(null);\n-        tbl.getSd().setOutputFormat(null);\n       }\n \n       String metadataLocation = tbl.getParameters().get(METADATA_LOCATION_PROP);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzOTExMw==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495139113", "bodyText": "Could we move this to a class for Hadoop configuration properties, like org.apache.iceberg.hadoop.ConfigProperties?", "author": "rdblue", "createdAt": "2020-09-25T17:42:37Z", "path": "core/src/main/java/org/apache/iceberg/TableProperties.java", "diffHunk": "@@ -126,4 +126,8 @@ private TableProperties() {\n \n   public static final String SNAPSHOT_ID_INHERITANCE_ENABLED = \"compatibility.snapshot-id-inheritance.enabled\";\n   public static final boolean SNAPSHOT_ID_INHERITANCE_ENABLED_DEFAULT = false;\n+\n+  public static final String ENGINE_HIVE_ENABLED = \"engine.hive.enabled\";\n+  public static final String ENGINE_HIVE_ENABLED_HIVE_CONF = \"iceberg.engine.hive.enabled\";", "originalCommit": "7f1b3724fc5d711af0849c932ee9d124fff791f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjcxMw==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495426713", "bodyText": "Done", "author": "pvary", "createdAt": "2020-09-26T07:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzOTExMw=="}], "type": "inlineReview", "revised_code": {"commit": "a36a0ad5f1ff6796909c86a52420f6702e8f20bc", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/TableProperties.java b/core/src/main/java/org/apache/iceberg/TableProperties.java\nindex 536f75444..6193b0c6c 100644\n--- a/core/src/main/java/org/apache/iceberg/TableProperties.java\n+++ b/core/src/main/java/org/apache/iceberg/TableProperties.java\n\n@@ -128,6 +128,5 @@ public class TableProperties {\n   public static final boolean SNAPSHOT_ID_INHERITANCE_ENABLED_DEFAULT = false;\n \n   public static final String ENGINE_HIVE_ENABLED = \"engine.hive.enabled\";\n-  public static final String ENGINE_HIVE_ENABLED_HIVE_CONF = \"iceberg.engine.hive.enabled\";\n   public static final boolean ENGINE_HIVE_ENABLED_DEFAULT = false;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0MDQ0MQ==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495140441", "bodyText": "It looks like a lot of test cases are mixed together in this method, but separated by comments. I think it would be better to make these separate test methods because then they are run independently, so you can see all of the failures at once, instead of just one failure per run that potentially hides the others.", "author": "rdblue", "createdAt": "2020-09-25T17:45:21Z", "path": "hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java", "diffHunk": "@@ -325,4 +329,71 @@ public void testNonDefaultDatabaseLocation() throws IOException, TException {\n     metastoreClient.dropDatabase(NON_DEFAULT_DATABASE, true, true, true);\n   }\n \n+  @Test\n+  public void testEngineHiveEnabled() throws TException {\n+    // Default already created\n+    org.apache.hadoop.hive.metastore.api.Table hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n+\n+    assertHiveEnabled(hmsTable, false);\n+\n+    catalog.dropTable(TABLE_IDENTIFIER);\n+\n+    // Enable by hive-conf", "originalCommit": "7f1b3724fc5d711af0849c932ee9d124fff791f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc4MA==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r495426780", "bodyText": "Done (kept true/false tests in a single test case, but separated on config source)", "author": "pvary", "createdAt": "2020-09-26T07:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0MDQ0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a36a0ad5f1ff6796909c86a52420f6702e8f20bc", "chunk": "diff --git a/hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java b/hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java\nindex 2e0c81a24..2557c67cd 100644\n--- a/hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java\n+++ b/hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java\n\n@@ -330,41 +331,49 @@ public class HiveTableTest extends HiveTableBaseTest {\n   }\n \n   @Test\n-  public void testEngineHiveEnabled() throws TException {\n+  public void testEngineHiveEnabledDefault() throws TException {\n     // Default already created\n     org.apache.hadoop.hive.metastore.api.Table hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n \n     assertHiveEnabled(hmsTable, false);\n+  }\n \n+  @Test\n+  public void testEngineHiveEnabledConfig() throws TException {\n+    // Drop the previously created table to make place for the new one\n     catalog.dropTable(TABLE_IDENTIFIER);\n \n     // Enable by hive-conf\n-    hiveConf.set(TableProperties.ENGINE_HIVE_ENABLED_HIVE_CONF, \"true\");\n+    hiveConf.set(ConfigProperties.ENGINE_HIVE_ENABLED, \"true\");\n \n     catalog.createTable(TABLE_IDENTIFIER, schema, PartitionSpec.unpartitioned());\n-    hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n+    org.apache.hadoop.hive.metastore.api.Table hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n \n     assertHiveEnabled(hmsTable, true);\n \n     catalog.dropTable(TABLE_IDENTIFIER);\n \n     // Disable by hive-conf\n-    hiveConf.set(TableProperties.ENGINE_HIVE_ENABLED_HIVE_CONF, \"false\");\n+    hiveConf.set(ConfigProperties.ENGINE_HIVE_ENABLED, \"false\");\n \n     catalog.createTable(TABLE_IDENTIFIER, schema, PartitionSpec.unpartitioned());\n     hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n \n     assertHiveEnabled(hmsTable, false);\n+  }\n \n+  @Test\n+  public void testEngineHiveEnabledTableProperty() throws TException {\n+    // Drop the previously created table to make place for the new one\n     catalog.dropTable(TABLE_IDENTIFIER);\n \n     // Enabled by table property - also check that the hive-conf is ignored\n     Map<String, String> tableProperties = new HashMap<>();\n     tableProperties.put(TableProperties.ENGINE_HIVE_ENABLED, \"true\");\n-    hiveConf.set(TableProperties.ENGINE_HIVE_ENABLED_HIVE_CONF, \"false\");\n+    hiveConf.set(ConfigProperties.ENGINE_HIVE_ENABLED, \"false\");\n \n     catalog.createTable(TABLE_IDENTIFIER, schema, PartitionSpec.unpartitioned(), tableProperties);\n-    hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n+    org.apache.hadoop.hive.metastore.api.Table hmsTable = metastoreClient.getTable(DB_NAME, TABLE_NAME);\n \n     assertHiveEnabled(hmsTable, true);\n \n"}}, {"oid": "a36a0ad5f1ff6796909c86a52420f6702e8f20bc", "url": "https://github.com/apache/iceberg/commit/a36a0ad5f1ff6796909c86a52420f6702e8f20bc", "message": "Addressed review comments:\n- New ConfigProperties class\n- Split up test cases\n- Moved SD config changes", "committedDate": "2020-09-26T07:20:19Z", "type": "commit"}, {"oid": "29be98ddbff08f377d3f0c3eb704d1b149bd3bca", "url": "https://github.com/apache/iceberg/commit/29be98ddbff08f377d3f0c3eb704d1b149bd3bca", "message": "Unset the conf value (IntelliJ does not need this, but command line somehow sets the value to true)", "committedDate": "2020-09-26T07:58:26Z", "type": "commit"}, {"oid": "cc6c7e17831962933db89c3ef8d7502a490a5202", "url": "https://github.com/apache/iceberg/commit/cc6c7e17831962933db89c3ef8d7502a490a5202", "message": "Remove the new dependencies", "committedDate": "2020-09-30T14:18:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5MDg3MA==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r497790870", "bodyText": "Should this be removed if the engine is not enabled? Because this is a table property, I don't think it would be automatically removed at any point.", "author": "rdblue", "createdAt": "2020-09-30T20:48:15Z", "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java", "diffHunk": "@@ -169,6 +173,12 @@ protected void doCommit(TableMetadata base, TableMetadata metadata) {\n         tbl.getParameters().put(\"EXTERNAL\", \"TRUE\"); // using the external table type also requires this\n       }\n \n+      // If needed set the 'storate_handler' property to enable query from Hive\n+      if (hiveEngineEnabled) {\n+        tbl.getParameters().put(hive_metastoreConstants.META_TABLE_STORAGE,\n+            \"org.apache.iceberg.mr.hive.HiveIcebergStorageHandler\");", "originalCommit": "cc6c7e17831962933db89c3ef8d7502a490a5202", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5NTUwNA==", "url": "https://github.com/apache/iceberg/pull/1505#discussion_r497795504", "bodyText": "Good catch!\nDone", "author": "pvary", "createdAt": "2020-09-30T20:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5MDg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "83bf91b61f9d6b1e4186121e6160871de363b3e9", "chunk": "diff --git a/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java b/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\nindex c46c74519..ed3c96eca 100644\n--- a/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\n+++ b/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java\n\n@@ -177,6 +177,8 @@ public class HiveTableOperations extends BaseMetastoreTableOperations {\n       if (hiveEngineEnabled) {\n         tbl.getParameters().put(hive_metastoreConstants.META_TABLE_STORAGE,\n             \"org.apache.iceberg.mr.hive.HiveIcebergStorageHandler\");\n+      } else {\n+        tbl.getParameters().remove(hive_metastoreConstants.META_TABLE_STORAGE);\n       }\n \n       String metadataLocation = tbl.getParameters().get(METADATA_LOCATION_PROP);\n"}}, {"oid": "83bf91b61f9d6b1e4186121e6160871de363b3e9", "url": "https://github.com/apache/iceberg/commit/83bf91b61f9d6b1e4186121e6160871de363b3e9", "message": "Removing StorageHandler if defined so", "committedDate": "2020-09-30T20:52:19Z", "type": "commit"}]}