{"pr_number": 1011, "pr_title": "Introduce a CloseableIterator to remove the consfusing currentCloseable in BaseDataReader", "pr_createdAt": "2020-05-07T13:16:06Z", "pr_url": "https://github.com/apache/iceberg/pull/1011", "timeline": [{"oid": "9046d189541310affdd79bf4cf2e22f11a7597b3", "url": "https://github.com/apache/iceberg/commit/9046d189541310affdd79bf4cf2e22f11a7597b3", "message": "Introduce a CloseableIterator to remove the consfusing currentCloseable in BaseDataReader", "committedDate": "2020-05-07T13:18:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjEzOA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r421616138", "bodyText": "This isn't correct. CloseableIterable#close will close all open iterators created by the Iterable. The purpose is to enable try-with-resources instead of relying on callers to remember to close:\ntry (CloseableIterable<T> iterable = open(...)) {\n  for (T item : iterable) {\n    process(item);\n  }\n}\nIf an iterator closed the iterable, then it would close other iterators that may be still used in other threads.\nInstead, this should check whether iterator is Closeable and call close on it.", "author": "rdblue", "createdAt": "2020-05-07T15:58:41Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterable.java", "diffHunk": "@@ -32,6 +32,27 @@\n import org.apache.iceberg.exceptions.RuntimeIOException;\n \n public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n+\n+  default CloseableIterator<T> closeableIterator() {\n+    Iterator<T> iterator = iterator();\n+    return new CloseableIterator<T>() {\n+      @Override\n+      public void close() throws IOException {\n+        CloseableIterable.this.close();", "originalCommit": "bae4917de65f739d1094e3162127f45620c465f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxODI2MQ==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r421918261", "bodyText": "Thanks for pointing this out, I've fixed this in the new patch.", "author": "openinx", "createdAt": "2020-05-08T03:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "8393933822410c3bbcd1e487892bd8236c742959", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\nindex 18ab0fa32..88af76d3b 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n\n@@ -38,7 +38,11 @@ public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n     return new CloseableIterator<T>() {\n       @Override\n       public void close() throws IOException {\n-        CloseableIterable.this.close();\n+        // Notice that the CloseableIterable#close will close all open iterators created by Iterable.\n+        // Here we only need to close the current iterator instead of all the created iterators.\n+        if (iterator instanceof Closeable) {\n+          ((Closeable) iterator).close();\n+        }\n       }\n \n       @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNzY0Mg==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r421617642", "bodyText": "Even if this is correct style, I don't think it is worth changing because it can cause commit conflicts.", "author": "rdblue", "createdAt": "2020-05-07T16:00:45Z", "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -359,25 +357,26 @@ public void close() throws IOException {\n       return nameToPos;\n     }\n \n-    private Iterator<T> open(FileScanTask currentTask) {\n+    private CloseableIterator<T> open(FileScanTask currentTask) {\n       DataFile file = currentTask.file();\n       // schema of rows returned by readers\n       PartitionSpec spec = currentTask.spec();\n-      Set<Integer> idColumns =  Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));\n+      Set<Integer> idColumns = Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));", "originalCommit": "bae4917de65f739d1094e3162127f45620c465f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8393933822410c3bbcd1e487892bd8236c742959", "chunk": "diff --git a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\nindex ad27fb1de..3f7fe08fb 100644\n--- a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n+++ b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n\n@@ -361,7 +361,7 @@ public class IcebergInputFormat<T> extends InputFormat<Void, T> {\n       DataFile file = currentTask.file();\n       // schema of rows returned by readers\n       PartitionSpec spec = currentTask.spec();\n-      Set<Integer> idColumns = Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));\n+      Set<Integer> idColumns =  Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));\n       boolean hasJoinedPartitionColumns = !idColumns.isEmpty();\n \n       CloseableIterable<T> iterable;\n"}}, {"oid": "8393933822410c3bbcd1e487892bd8236c742959", "url": "https://github.com/apache/iceberg/commit/8393933822410c3bbcd1e487892bd8236c742959", "message": "Only close the current iterator in CloseableIterator instead of closing all the iteraters", "committedDate": "2020-05-08T03:41:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5NTYzMg==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r423195632", "bodyText": "Why doesn't this update iterator to return a CloseableIterator? I don't think it is a good idea to have two methods that do basically the same thing, but one provides a closeable version. Then we need to remember to call this variant.", "author": "rdblue", "createdAt": "2020-05-11T17:18:41Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterable.java", "diffHunk": "@@ -32,6 +32,31 @@\n import org.apache.iceberg.exceptions.RuntimeIOException;\n \n public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n+\n+  default CloseableIterator<T> closeableIterator() {", "originalCommit": "8393933822410c3bbcd1e487892bd8236c742959", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzODU3Nw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r423438577", "bodyText": "Well,  sounds good to unify the closeableIterator and iterator methods into one, let me update the patch. Thanks.", "author": "openinx", "createdAt": "2020-05-12T03:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5NTYzMg=="}], "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\nindex 88af76d3b..18ab0fa32 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n\n@@ -38,11 +38,7 @@ public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n     return new CloseableIterator<T>() {\n       @Override\n       public void close() throws IOException {\n-        // Notice that the CloseableIterable#close will close all open iterators created by Iterable.\n-        // Here we only need to close the current iterator instead of all the created iterators.\n-        if (iterator instanceof Closeable) {\n-          ((Closeable) iterator).close();\n-        }\n+        CloseableIterable.this.close();\n       }\n \n       @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjI5NA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424102294", "bodyText": "This changes the semantics of the iterator. Before, the iterators returned by this could be Closeable, but the Iterable itself was not Closeable. I think it would be unlikely to have an Iterable without a close operation that produced an Iterator that could be closed (since it should be a CloseableGroup) but I still think it makes sense to preserve whether the Iterator is Closeable here.\nHow about using CloseableIterator.wrap that calls close on the wrapped Iterator if it is Closeable?", "author": "rdblue", "createdAt": "2020-05-13T00:08:30Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterable.java", "diffHunk": "@@ -43,8 +52,8 @@ public void close() {\n       }\n \n       @Override\n-      public Iterator<E> iterator() {\n-        return iterable.iterator();\n+      public CloseableIterator<E> iterator() {\n+        return CloseableIterator.withNoopClose(iterable.iterator());", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjU4Nw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424102587", "bodyText": "Actually, it looks like that's what withClose does. We should use that instead.", "author": "rdblue", "createdAt": "2020-05-13T00:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNzEzMw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424127133", "bodyText": "OK, I misunderstood that the Iterable without a close operation would never create a closeable iterator (sounds a bit strange here but seems possible to have a closeable iterator).", "author": "openinx", "createdAt": "2020-05-13T01:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\nindex f0db43903..18ab0fa32 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n\n@@ -52,8 +64,8 @@ public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n       }\n \n       @Override\n-      public CloseableIterator<E> iterator() {\n-        return CloseableIterator.withNoopClose(iterable.iterator());\n+      public Iterator<E> iterator() {\n+        return iterable.iterator();\n       }\n     };\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjk5Ng==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424102996", "bodyText": "Nit: could you add this line back to avoid commit conflicts?", "author": "rdblue", "createdAt": "2020-05-13T00:11:24Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterable.java", "diffHunk": "@@ -192,5 +206,4 @@ public E next() {\n       }\n     }\n   }\n-", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNzU5Mw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424127593", "bodyText": "OK", "author": "openinx", "createdAt": "2020-05-13T01:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjk5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\nindex f0db43903..18ab0fa32 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterable.java\n\n@@ -206,4 +213,5 @@ public interface CloseableIterable<T> extends Iterable<T>, Closeable {\n       }\n     }\n   }\n+\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzEwOQ==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424103109", "bodyText": "Nit: Can you add a newline after this if block?", "author": "rdblue", "createdAt": "2020-05-13T00:11:53Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterator.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.io;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.Iterator;\n+\n+public interface CloseableIterator<T> extends Iterator<T>, Closeable {\n+\n+  static <E> CloseableIterator<E> withNoopClose(Iterator<E> iterator) {\n+    if (iterator instanceof CloseableIterator) {\n+      return (CloseableIterator<E>) iterator;\n+    }\n+    return new CloseableIterator<E>() {\n+      @Override\n+      public void close() throws IOException {\n+        // do nothing.\n+      }\n+\n+      @Override\n+      public boolean hasNext() {\n+        return iterator.hasNext();\n+      }\n+\n+      @Override\n+      public E next() {\n+        return iterator.next();\n+      }\n+    };\n+  }\n+\n+  static <E> CloseableIterator<E> withClose(Iterator<E> iterator) {\n+    if (iterator instanceof CloseableIterator) {\n+      return (CloseableIterator<E>) iterator;\n+    }", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\nindex 138f03101..5010f51c5 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\n\n@@ -20,54 +20,7 @@\n package org.apache.iceberg.io;\n \n import java.io.Closeable;\n-import java.io.IOException;\n import java.util.Iterator;\n \n public interface CloseableIterator<T> extends Iterator<T>, Closeable {\n-\n-  static <E> CloseableIterator<E> withNoopClose(Iterator<E> iterator) {\n-    if (iterator instanceof CloseableIterator) {\n-      return (CloseableIterator<E>) iterator;\n-    }\n-    return new CloseableIterator<E>() {\n-      @Override\n-      public void close() throws IOException {\n-        // do nothing.\n-      }\n-\n-      @Override\n-      public boolean hasNext() {\n-        return iterator.hasNext();\n-      }\n-\n-      @Override\n-      public E next() {\n-        return iterator.next();\n-      }\n-    };\n-  }\n-\n-  static <E> CloseableIterator<E> withClose(Iterator<E> iterator) {\n-    if (iterator instanceof CloseableIterator) {\n-      return (CloseableIterator<E>) iterator;\n-    }\n-    return new CloseableIterator<E>() {\n-      @Override\n-      public void close() throws IOException {\n-        if (iterator instanceof Closeable) {\n-          ((Closeable) iterator).close();\n-        }\n-      }\n-\n-      @Override\n-      public boolean hasNext() {\n-        return iterator.hasNext();\n-      }\n-\n-      @Override\n-      public E next() {\n-        return iterator.next();\n-      }\n-    };\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzE2OA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424103168", "bodyText": "I don't think this is needed after removing it above. The other class will work fine because it won't call close if the Iterator doesn't implement Closeable.", "author": "rdblue", "createdAt": "2020-05-13T00:12:05Z", "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterator.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.io;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.Iterator;\n+\n+public interface CloseableIterator<T> extends Iterator<T>, Closeable {\n+\n+  static <E> CloseableIterator<E> withNoopClose(Iterator<E> iterator) {", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyODYwNg==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424128606", "bodyText": "+1", "author": "openinx", "createdAt": "2020-05-13T01:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzE2OA=="}], "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java b/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\nindex 138f03101..5010f51c5 100644\n--- a/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\n+++ b/api/src/main/java/org/apache/iceberg/io/CloseableIterator.java\n\n@@ -20,54 +20,7 @@\n package org.apache.iceberg.io;\n \n import java.io.Closeable;\n-import java.io.IOException;\n import java.util.Iterator;\n \n public interface CloseableIterator<T> extends Iterator<T>, Closeable {\n-\n-  static <E> CloseableIterator<E> withNoopClose(Iterator<E> iterator) {\n-    if (iterator instanceof CloseableIterator) {\n-      return (CloseableIterator<E>) iterator;\n-    }\n-    return new CloseableIterator<E>() {\n-      @Override\n-      public void close() throws IOException {\n-        // do nothing.\n-      }\n-\n-      @Override\n-      public boolean hasNext() {\n-        return iterator.hasNext();\n-      }\n-\n-      @Override\n-      public E next() {\n-        return iterator.next();\n-      }\n-    };\n-  }\n-\n-  static <E> CloseableIterator<E> withClose(Iterator<E> iterator) {\n-    if (iterator instanceof CloseableIterator) {\n-      return (CloseableIterator<E>) iterator;\n-    }\n-    return new CloseableIterator<E>() {\n-      @Override\n-      public void close() throws IOException {\n-        if (iterator instanceof Closeable) {\n-          ((Closeable) iterator).close();\n-        }\n-      }\n-\n-      @Override\n-      public boolean hasNext() {\n-        return iterator.hasNext();\n-      }\n-\n-      @Override\n-      public E next() {\n-        return iterator.next();\n-      }\n-    };\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzcwNQ==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424103705", "bodyText": "Can you add a newline after the control flow block above?", "author": "rdblue", "createdAt": "2020-05-13T00:14:14Z", "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -359,25 +357,26 @@ public void close() throws IOException {\n       return nameToPos;\n     }\n \n-    private Iterator<T> open(FileScanTask currentTask) {\n+    private CloseableIterator<T> open(FileScanTask currentTask) {\n       DataFile file = currentTask.file();\n       // schema of rows returned by readers\n       PartitionSpec spec = currentTask.spec();\n       Set<Integer> idColumns =  Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));\n       boolean hasJoinedPartitionColumns = !idColumns.isEmpty();\n \n+      CloseableIterable<T> iterable;\n       if (hasJoinedPartitionColumns) {\n         Schema readDataSchema = TypeUtil.selectNot(expectedSchema, idColumns);\n         Schema identityPartitionSchema = TypeUtil.select(expectedSchema, idColumns);\n-        return Iterators.transform(\n-            open(currentTask, readDataSchema),\n+        iterable = CloseableIterable.transform(open(currentTask, readDataSchema),\n             row -> withIdentityPartitionColumns(row, identityPartitionSchema, spec, file.partition()));\n       } else {\n-        return open(currentTask, expectedSchema);\n+        iterable = open(currentTask, expectedSchema);\n       }\n+      return iterable.iterator();", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\nindex ef4c2499a..0d35644ab 100644\n--- a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n+++ b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n\n@@ -357,26 +359,25 @@ public class IcebergInputFormat<T> extends InputFormat<Void, T> {\n       return nameToPos;\n     }\n \n-    private CloseableIterator<T> open(FileScanTask currentTask) {\n+    private Iterator<T> open(FileScanTask currentTask) {\n       DataFile file = currentTask.file();\n       // schema of rows returned by readers\n       PartitionSpec spec = currentTask.spec();\n       Set<Integer> idColumns =  Sets.intersection(spec.identitySourceIds(), TypeUtil.getProjectedIds(expectedSchema));\n       boolean hasJoinedPartitionColumns = !idColumns.isEmpty();\n \n-      CloseableIterable<T> iterable;\n       if (hasJoinedPartitionColumns) {\n         Schema readDataSchema = TypeUtil.selectNot(expectedSchema, idColumns);\n         Schema identityPartitionSchema = TypeUtil.select(expectedSchema, idColumns);\n-        iterable = CloseableIterable.transform(open(currentTask, readDataSchema),\n+        return Iterators.transform(\n+            open(currentTask, readDataSchema),\n             row -> withIdentityPartitionColumns(row, identityPartitionSchema, spec, file.partition()));\n       } else {\n-        iterable = open(currentTask, expectedSchema);\n+        return open(currentTask, expectedSchema);\n       }\n-      return iterable.iterator();\n     }\n \n-    private CloseableIterable<T> open(FileScanTask currentTask, Schema readSchema) {\n+    private Iterator<T> open(FileScanTask currentTask, Schema readSchema) {\n       DataFile file = currentTask.file();\n       // TODO we should make use of FileIO to create inputFile\n       InputFile inputFile = HadoopInputFile.fromLocation(file.path(), context.getConfiguration());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzc3OA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424103778", "bodyText": "Same here. Could you add a newline after the control flow block?", "author": "rdblue", "createdAt": "2020-05-13T00:14:30Z", "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -396,8 +395,7 @@ public void close() throws IOException {\n           throw new UnsupportedOperationException(\n               String.format(\"Cannot read %s file: %s\", file.format().name(), file.path()));\n       }\n-      currentCloseable = iterable;\n-      return iterable.iterator();\n+      return iterable;", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzMDM0Nw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424130347", "bodyText": "Do we have some guide/document say that when it will be better to have a newline ?  Or could we put it in the checkstyle so that we contributors can notice that :-) .", "author": "openinx", "createdAt": "2020-05-13T01:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyNjQxNw==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r425426417", "bodyText": "We follow the general style of Hadoop projects that I think is based on a Google style doc somewhere. We also add the rules to checkstyle when it can enforce them.", "author": "rdblue", "createdAt": "2020-05-14T20:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\nindex ef4c2499a..0d35644ab 100644\n--- a/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n+++ b/mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java\n\n@@ -395,7 +396,8 @@ public class IcebergInputFormat<T> extends InputFormat<Void, T> {\n           throw new UnsupportedOperationException(\n               String.format(\"Cannot read %s file: %s\", file.format().name(), file.path()));\n       }\n-      return iterable;\n+      currentCloseable = iterable;\n+      return iterable.iterator();\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNDA4MA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424104080", "bodyText": "What about adding CloseableIterator.empty() to avoid this?", "author": "rdblue", "createdAt": "2020-05-13T00:15:29Z", "path": "spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java", "diffHunk": "@@ -64,8 +61,7 @@\n     ImmutableMap.Builder<String, InputFile> inputFileBuilder = ImmutableMap.builder();\n     decryptedFiles.forEach(decrypted -> inputFileBuilder.put(decrypted.location(), decrypted));\n     this.inputFiles = inputFileBuilder.build();\n-    this.currentCloseable = CloseableIterable.empty();\n-    this.currentIterator = Collections.emptyIterator();\n+    this.currentIterator = CloseableIterable.<T>empty().iterator();", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "chunk": "diff --git a/spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java b/spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java\nindex c5afeab30..cae4697a3 100644\n--- a/spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java\n+++ b/spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java\n\n@@ -61,7 +61,7 @@ abstract class BaseDataReader<T> implements InputPartitionReader<T> {\n     ImmutableMap.Builder<String, InputFile> inputFileBuilder = ImmutableMap.builder();\n     decryptedFiles.forEach(decrypted -> inputFileBuilder.put(decrypted.location(), decrypted));\n     this.inputFiles = inputFileBuilder.build();\n-    this.currentIterator = CloseableIterable.<T>empty().iterator();\n+    this.currentIterator = CloseableIterable.<T>empty().closeableIterator();\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNDIxOA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424104218", "bodyText": "Here as well, it would be more readable to have a newline after the if/else block.", "author": "rdblue", "createdAt": "2020-05-13T00:16:04Z", "path": "spark/src/main/java/org/apache/iceberg/spark/source/RowDataReader.java", "diffHunk": "@@ -150,10 +151,7 @@\n               \"Cannot read unknown format: \" + task.file().format());\n       }\n     }\n-\n-    this.currentCloseable = iter;\n-\n-    return iter.iterator();\n+    return iter;", "originalCommit": "272a019b327124bb400500d56335632190fefe0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzMDgyOA==", "url": "https://github.com/apache/iceberg/pull/1011#discussion_r424130828", "bodyText": "OK", "author": "openinx", "createdAt": "2020-05-13T02:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNDIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "494db3bf459708c39a4fcfaf03d83e07ec052c5e", "chunk": "diff --git a/spark/src/main/java/org/apache/iceberg/spark/source/RowDataReader.java b/spark/src/main/java/org/apache/iceberg/spark/source/RowDataReader.java\nindex 634bcd64a..f4ea6c7ee 100644\n--- a/spark/src/main/java/org/apache/iceberg/spark/source/RowDataReader.java\n+++ b/spark/src/main/java/org/apache/iceberg/spark/source/RowDataReader.java\n\n@@ -151,6 +151,7 @@ class RowDataReader extends BaseDataReader<InternalRow> {\n               \"Cannot read unknown format: \" + task.file().format());\n       }\n     }\n+\n     return iter;\n   }\n \n"}}, {"oid": "ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "url": "https://github.com/apache/iceberg/commit/ade88aa83392bd56e2b04c1a679e32bad1c7ed0f", "message": "Introduce a CloseableIterator to remove the consfusing currentCloseable in BaseDataReader", "committedDate": "2020-05-15T10:30:10Z", "type": "commit"}, {"oid": "0cb2deb6f2a8117a0453e55cd90e14efbf06501e", "url": "https://github.com/apache/iceberg/commit/0cb2deb6f2a8117a0453e55cd90e14efbf06501e", "message": "Address the similiar issues in mr module", "committedDate": "2020-05-15T10:30:10Z", "type": "commit"}, {"oid": "badfedcd222dba8b8e0828f29ee487be35c9bc52", "url": "https://github.com/apache/iceberg/commit/badfedcd222dba8b8e0828f29ee487be35c9bc52", "message": "Only close the current iterator in CloseableIterator instead of closing all the iteraters", "committedDate": "2020-05-15T10:30:10Z", "type": "commit"}, {"oid": "99e587ff997c918a1c81bfce313ae7a5d7512df6", "url": "https://github.com/apache/iceberg/commit/99e587ff997c918a1c81bfce313ae7a5d7512df6", "message": "Unified the closeableIterator and iterator into one", "committedDate": "2020-05-15T10:38:53Z", "type": "commit"}, {"oid": "73060b4fafe91492079f82939f14c3bd5c0cb10a", "url": "https://github.com/apache/iceberg/commit/73060b4fafe91492079f82939f14c3bd5c0cb10a", "message": "Minor fix", "committedDate": "2020-05-15T10:38:53Z", "type": "commit"}, {"oid": "494db3bf459708c39a4fcfaf03d83e07ec052c5e", "url": "https://github.com/apache/iceberg/commit/494db3bf459708c39a4fcfaf03d83e07ec052c5e", "message": "Addressing the comments from ryan blue", "committedDate": "2020-05-15T10:38:53Z", "type": "commit"}, {"oid": "132afe5c3d59c2146254289e5f76fecb828017a1", "url": "https://github.com/apache/iceberg/commit/132afe5c3d59c2146254289e5f76fecb828017a1", "message": "Resolve the conflicts", "committedDate": "2020-05-15T10:40:58Z", "type": "commit"}, {"oid": "132afe5c3d59c2146254289e5f76fecb828017a1", "url": "https://github.com/apache/iceberg/commit/132afe5c3d59c2146254289e5f76fecb828017a1", "message": "Resolve the conflicts", "committedDate": "2020-05-15T10:40:58Z", "type": "forcePushed"}]}