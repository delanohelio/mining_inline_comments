{"pr_number": 1169, "pr_title": "Remove thread local objects and use new visitors", "pr_createdAt": "2020-07-05T07:11:25Z", "pr_url": "https://github.com/apache/iceberg/pull/1169", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDAxNQ==", "url": "https://github.com/apache/iceberg/pull/1169#discussion_r449850015", "bodyText": "I think this is subtle and hard to understand on why this is needed. I prefer the the new visitor approach as you guys discussed in #1139.", "author": "rdsr", "createdAt": "2020-07-05T08:25:49Z", "path": "api/src/main/java/org/apache/iceberg/expressions/InclusiveMetricsEvaluator.java", "diffHunk": "@@ -102,7 +102,15 @@ private boolean eval(ContentFile<?> file) {\n       this.lowerBounds = file.lowerBounds();\n       this.upperBounds = file.upperBounds();\n \n-      return ExpressionVisitors.visitEvaluator(expr, this);\n+      try {\n+        return ExpressionVisitors.visitEvaluator(expr, this);\n+      } finally {\n+        // allow temporary state to be collected because this is in a thread-local\n+        this.valueCounts = null;", "originalCommit": "f657254b71fa90f9c5f9090c8e411067e2642fff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNzM2NA==", "url": "https://github.com/apache/iceberg/pull/1169#discussion_r449917364", "bodyText": "That sounds good to me.", "author": "rdblue", "createdAt": "2020-07-05T20:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAwODg5OA==", "url": "https://github.com/apache/iceberg/pull/1169#discussion_r450008898", "bodyText": "Thanks @rdsr and @rdblue for the comments. Updated the PR accordingly to remove the thread local objects and use new visitors to keep the code straightforward.", "author": "jun-he", "createdAt": "2020-07-06T06:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDAxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "0b9a891b4e17a220a9a496d009ca28aa6c0e4632", "chunk": "diff --git a/api/src/main/java/org/apache/iceberg/expressions/InclusiveMetricsEvaluator.java b/api/src/main/java/org/apache/iceberg/expressions/InclusiveMetricsEvaluator.java\nindex e6cf3ff8c..7bad98ccc 100644\n--- a/api/src/main/java/org/apache/iceberg/expressions/InclusiveMetricsEvaluator.java\n+++ b/api/src/main/java/org/apache/iceberg/expressions/InclusiveMetricsEvaluator.java\n\n@@ -102,15 +94,7 @@ public class InclusiveMetricsEvaluator {\n       this.lowerBounds = file.lowerBounds();\n       this.upperBounds = file.upperBounds();\n \n-      try {\n-        return ExpressionVisitors.visitEvaluator(expr, this);\n-      } finally {\n-        // allow temporary state to be collected because this is in a thread-local\n-        this.valueCounts = null;\n-        this.nullCounts = null;\n-        this.lowerBounds = null;\n-        this.upperBounds = null;\n-      }\n+      return ExpressionVisitors.visitEvaluator(expr, this);\n     }\n \n     @Override\n"}}, {"oid": "0b9a891b4e17a220a9a496d009ca28aa6c0e4632", "url": "https://github.com/apache/iceberg/commit/0b9a891b4e17a220a9a496d009ca28aa6c0e4632", "message": "remove thread local objects and use new vistors to keep the code straightforward", "committedDate": "2020-07-06T06:21:58Z", "type": "forcePushed"}, {"oid": "8317b72e8b4a383288b64f9687257abd3268c6c4", "url": "https://github.com/apache/iceberg/commit/8317b72e8b4a383288b64f9687257abd3268c6c4", "message": "remove thread local objects and use new visitors to keep the code straightforward", "committedDate": "2020-07-06T06:29:00Z", "type": "commit"}, {"oid": "8317b72e8b4a383288b64f9687257abd3268c6c4", "url": "https://github.com/apache/iceberg/commit/8317b72e8b4a383288b64f9687257abd3268c6c4", "message": "remove thread local objects and use new visitors to keep the code straightforward", "committedDate": "2020-07-06T06:29:00Z", "type": "forcePushed"}]}