{"pr_number": 1579, "pr_title": "Remove time-zone dependent call when casting a date via toLocalDate in HiveIcebergFilterFactory", "pr_createdAt": "2020-10-11T00:11:17Z", "pr_url": "https://github.com/apache/iceberg/pull/1579", "timeline": [{"oid": "3c10990402c7ba4fe8b43d6b811ae74da3db5520", "url": "https://github.com/apache/iceberg/commit/3c10990402c7ba4fe8b43d6b811ae74da3db5520", "message": "Fix off by one error in TestHiveIcebergFilterFactory#testDateType so the gmtDate is 2015-11-12 instead of 2015-11-11", "committedDate": "2020-10-11T00:00:36Z", "type": "commit"}, {"oid": "50f29cd0895e57670dc696cb389e5f2044231e4a", "url": "https://github.com/apache/iceberg/commit/50f29cd0895e57670dc696cb389e5f2044231e4a", "message": "Use Date.valueOf instead of the confusing 2015-11-13 with start of day changes etc", "committedDate": "2020-10-11T00:03:43Z", "type": "commit"}, {"oid": "02ea287e288ea8c0752e04e0154b48e9a953ef07", "url": "https://github.com/apache/iceberg/commit/02ea287e288ea8c0752e04e0154b48e9a953ef07", "message": "Use the dateString as a named parameter, so that hopefully these tests could be parameterized one day", "committedDate": "2020-10-11T00:12:18Z", "type": "commit"}, {"oid": "52150964c696af20db98953d791e064601d017d5", "url": "https://github.com/apache/iceberg/commit/52150964c696af20db98953d791e064601d017d5", "message": "Fix unused import error", "committedDate": "2020-10-11T00:34:13Z", "type": "commit"}, {"oid": "0a42de42d500ab342d8c727ab8d22c0f471f3198", "url": "https://github.com/apache/iceberg/commit/0a42de42d500ab342d8c727ab8d22c0f471f3198", "message": "remove the named date string", "committedDate": "2020-10-11T06:24:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NDc2NQ==", "url": "https://github.com/apache/iceberg/pull/1579#discussion_r503394765", "bodyText": "We need to avoid using classes that will change behavior based on time zone to parse the value of a date or timestamp. This method was purposely not used. The problem here is probably that although the instant value is correct, the Date uses the JVM time zone somehow.", "author": "rdblue", "createdAt": "2020-10-12T16:06:17Z", "path": "mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergFilterFactory.java", "diffHunk": "@@ -207,8 +206,8 @@ public void testBooleanType() {\n   @Test\n   public void testDateType() {\n     SearchArgument.Builder builder = SearchArgumentFactory.newBuilder();\n-    Date gmtDate = new Date(LocalDate.of(2015, 11, 12).atStartOfDay(ZoneOffset.UTC).toInstant().toEpochMilli());\n-    SearchArgument arg = builder.startAnd().equals(\"date\", PredicateLeaf.Type.DATE, gmtDate).end().build();\n+    Date date = Date.valueOf(\"2015-11-12\");", "originalCommit": "0a42de42d500ab342d8c727ab8d22c0f471f3198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MzE0Nw==", "url": "https://github.com/apache/iceberg/pull/1579#discussion_r503483147", "bodyText": "I had a feeling this method was purposely not used, but I wasn't sure of a better option so I figured I'd open the PR and then let somebody point it out. I also figured that the flakey test was indicative of more than just a flakey test. I'll apply your suggestions this evening after work.", "author": "kbendick", "createdAt": "2020-10-12T19:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NDc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxMjYzNQ==", "url": "https://github.com/apache/iceberg/pull/1579#discussion_r503512635", "bodyText": "I reverted this to the previous code. It's running on my local now with the patch for daysFromDate.", "author": "kbendick", "createdAt": "2020-10-12T20:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NDc2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "62c083b838e8a31a3081755ecd29f86c5063e002", "chunk": "diff --git a/mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergFilterFactory.java b/mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergFilterFactory.java\nindex 1e6d3855e..2d6b63275 100644\n--- a/mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergFilterFactory.java\n+++ b/mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergFilterFactory.java\n\n@@ -206,8 +207,8 @@ public class TestHiveIcebergFilterFactory {\n   @Test\n   public void testDateType() {\n     SearchArgument.Builder builder = SearchArgumentFactory.newBuilder();\n-    Date date = Date.valueOf(\"2015-11-12\");\n-    SearchArgument arg = builder.startAnd().equals(\"date\", PredicateLeaf.Type.DATE, date).end().build();\n+    Date gmtDate = new Date(LocalDate.of(2015, 11, 12).atStartOfDay(ZoneOffset.UTC).toInstant().toEpochMilli());\n+    SearchArgument arg = builder.startAnd().equals(\"date\", PredicateLeaf.Type.DATE, gmtDate).end().build();\n \n     UnboundPredicate expected = Expressions.equal(\"date\", Literal.of(\"2015-11-12\").to(Types.DateType.get()).value());\n     UnboundPredicate actual = (UnboundPredicate) HiveIcebergFilterFactory.generateFilterExpression(arg);\n"}}, {"oid": "91637ff4df26fda85423758ac1ee9096924979a8", "url": "https://github.com/apache/iceberg/commit/91637ff4df26fda85423758ac1ee9096924979a8", "message": "Update daysFromDate function", "committedDate": "2020-10-12T20:04:57Z", "type": "commit"}, {"oid": "62c083b838e8a31a3081755ecd29f86c5063e002", "url": "https://github.com/apache/iceberg/commit/62c083b838e8a31a3081755ecd29f86c5063e002", "message": "Revert changes to unit tests as we've updated the HiveIcebergFilterFactory code instead", "committedDate": "2020-10-12T20:16:40Z", "type": "commit"}, {"oid": "62c083b838e8a31a3081755ecd29f86c5063e002", "url": "https://github.com/apache/iceberg/commit/62c083b838e8a31a3081755ecd29f86c5063e002", "message": "Revert changes to unit tests as we've updated the HiveIcebergFilterFactory code instead", "committedDate": "2020-10-12T20:16:40Z", "type": "forcePushed"}]}