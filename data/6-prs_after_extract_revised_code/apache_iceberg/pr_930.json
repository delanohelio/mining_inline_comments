{"pr_number": 930, "pr_title": "Spark: limit the listing depth in RemoveOrphanFilesAction", "pr_createdAt": "2020-04-16T00:04:04Z", "pr_url": "https://github.com/apache/iceberg/pull/930", "timeline": [{"oid": "7cf583938608121792f81826569ed628498c6068", "url": "https://github.com/apache/iceberg/commit/7cf583938608121792f81826569ed628498c6068", "message": "Spark: limit the listing depth in RemoveOrphanFilesAction", "committedDate": "2020-04-16T00:02:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMDk0Mw==", "url": "https://github.com/apache/iceberg/pull/930#discussion_r409210943", "bodyText": "Can we use a better message here? I think this will only happen when the maximum depth is reached, so we could state that's what happened: \"Could not list location %s, reached maximum subdirectory depth %s\", tableLocation, maxDepth", "author": "rdblue", "createdAt": "2020-04-16T00:29:33Z", "path": "spark/src/main/java/org/apache/iceberg/actions/RemoveOrphanFilesAction.java", "diffHunk": "@@ -272,13 +272,17 @@ private String metadataTableName(MetadataTableType type) {\n \n       Predicate<FileStatus> predicate = file -> file.getModificationTime() < olderThanTimestamp;\n \n-      int maxDepth = Integer.MAX_VALUE;\n+      int maxDepth = 2000;\n       int maxDirectSubDirs = Integer.MAX_VALUE;\n \n       dirs.forEachRemaining(dir -> {\n         listDirRecursively(dir, predicate, conf.value().value(), maxDepth, maxDirectSubDirs, subDirs, files);\n       });\n \n+      if (!subDirs.isEmpty()) {\n+        throw new RuntimeException(\"Could not list dirs: \" + subDirs);", "originalCommit": "7cf583938608121792f81826569ed628498c6068", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc1Njc4NA==", "url": "https://github.com/apache/iceberg/pull/930#discussion_r409756784", "bodyText": "Updated. Unfortunately, we don't have tableLocation here as it is called for subdirs on executors.", "author": "aokolnychyi", "createdAt": "2020-04-16T18:16:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMDk0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "58e85fe434e21d7855ee1bca97c8805fa46311ab", "chunk": "diff --git a/spark/src/main/java/org/apache/iceberg/actions/RemoveOrphanFilesAction.java b/spark/src/main/java/org/apache/iceberg/actions/RemoveOrphanFilesAction.java\nindex 7b8327fa..aff62efb 100644\n--- a/spark/src/main/java/org/apache/iceberg/actions/RemoveOrphanFilesAction.java\n+++ b/spark/src/main/java/org/apache/iceberg/actions/RemoveOrphanFilesAction.java\n\n@@ -280,7 +280,7 @@ public class RemoveOrphanFilesAction implements Action<List<String>> {\n       });\n \n       if (!subDirs.isEmpty()) {\n-        throw new RuntimeException(\"Could not list dirs: \" + subDirs);\n+        throw new RuntimeException(\"Could not list subdirectories, reached maximum subdirectory depth: \" + maxDepth);\n       }\n \n       return files.iterator();\n"}}, {"oid": "58e85fe434e21d7855ee1bca97c8805fa46311ab", "url": "https://github.com/apache/iceberg/commit/58e85fe434e21d7855ee1bca97c8805fa46311ab", "message": "Update error message", "committedDate": "2020-04-16T18:14:28Z", "type": "commit"}]}