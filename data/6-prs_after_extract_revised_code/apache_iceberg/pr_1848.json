{"pr_number": 1848, "pr_title": "Add support for converting avro schemas containing timestamps without the adjust-to-utc annotations", "pr_createdAt": "2020-11-29T22:43:59Z", "pr_url": "https://github.com/apache/iceberg/pull/1848", "timeline": [{"oid": "acd8b2c076d6a8916663dbf183cde49faa8e4909", "url": "https://github.com/apache/iceberg/commit/acd8b2c076d6a8916663dbf183cde49faa8e4909", "message": "Add support for converting avro schemas containing timestamps without the adjust-to-utc property\n\nDefault avro timestamps to the timestamp iceberg type to follow avro timestamp semantics", "committedDate": "2020-11-29T22:38:35Z", "type": "commit"}, {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91", "url": "https://github.com/apache/iceberg/commit/5a764afb8c2b00b9905f657054cbc9948829ce91", "message": "Fix checkstyle violations", "committedDate": "2020-11-29T23:01:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTY3Nw==", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532765677", "bodyText": "How about \"default to timestamp\" or \"default to timestamp without time zone\"?", "author": "rdblue", "createdAt": "2020-11-30T17:20:17Z", "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz", "originalCommit": "5a764afb8c2b00b9905f657054cbc9948829ce91", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "07eba7b67402f3fd399d6373298e82dff4b63ff1", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java b/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\nindex 770e0deb2..929fb5f14 100644\n--- a/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\n+++ b/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\n\n@@ -112,7 +112,7 @@ public class AvroSchemaUtil {\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n \n       if (value == null) {\n-        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to timestamp without timezone\n         return false;\n       } else if (value instanceof Boolean) {\n         return (Boolean) value;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg==", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532766772", "bodyText": "This is the same behavior as before because null would not pass either instanceof check. Do we need to update this other than to add instanceof TimestampMillis above?", "author": "rdblue", "createdAt": "2020-11-30T17:21:55Z", "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        return false;", "originalCommit": "5a764afb8c2b00b9905f657054cbc9948829ce91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwNjcwNQ==", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532806705", "bodyText": "WRT adding instanceof TimestampMillis that was an unrelated bug it seems.\nThere were two places a similar check was done AvroSchemaUtil.isTimestamptz (used by datareader/datawriters) and SchemaToType.primitive but the two places were not consistent. I am just making those two checks both use the same utility function.", "author": "grantatspothero", "createdAt": "2020-11-30T18:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMDkyNw==", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532810927", "bodyText": "You are totally right this instanceof change is not strictly necessary, just makes it more explicit.\nThe bit that is important is the change in this file which before failed: core/src/main/java/org/apache/iceberg/avro/SchemaToType.java", "author": "grantatspothero", "createdAt": "2020-11-30T18:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "07eba7b67402f3fd399d6373298e82dff4b63ff1", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java b/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\nindex 770e0deb2..929fb5f14 100644\n--- a/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\n+++ b/core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java\n\n@@ -112,7 +112,7 @@ public class AvroSchemaUtil {\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n \n       if (value == null) {\n-        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to timestamp without timezone\n         return false;\n       } else if (value instanceof Boolean) {\n         return (Boolean) value;\n"}}, {"oid": "07eba7b67402f3fd399d6373298e82dff4b63ff1", "url": "https://github.com/apache/iceberg/commit/07eba7b67402f3fd399d6373298e82dff4b63ff1", "message": "Better comment message", "committedDate": "2020-11-30T18:28:17Z", "type": "commit"}]}