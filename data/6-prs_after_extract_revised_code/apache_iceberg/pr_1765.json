{"pr_number": 1765, "pr_title": "Flink: Refactor SimpleDataUtil#assertTableRecords method", "pr_createdAt": "2020-11-13T06:00:06Z", "pr_url": "https://github.com/apache/iceberg/pull/1765", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r522830903", "bodyText": "Using hashCode to sort this list is correct if we only want to check wether the two list is equal or not.  But it may not friend to debug the root cause when two list is not equal because those elements are disordered. I'd prefer to compare the fields in lexicographical order if possible.", "author": "openinx", "createdAt": "2020-11-13T09:32:38Z", "path": "flink/src/test/java/org/apache/iceberg/flink/SimpleDataUtil.java", "diffHunk": "@@ -129,11 +129,25 @@ public static void assertTableRows(String tablePath, List<RowData> expected) thr\n   public static void assertTableRecords(Table table, List<Record> expected) throws IOException {\n     table.refresh();\n     try (CloseableIterable<Record> iterable = IcebergGenerics.read(table).build()) {\n-      Assert.assertEquals(\"Should produce the expected record\",\n-          Sets.newHashSet(expected), Sets.newHashSet(iterable));\n+      List<Record> iterList = Lists.newArrayList(iterable.iterator());\n+      sortRecordList(iterList);\n+      sortRecordList(expected);\n+      Assert.assertEquals(\"Should produce the expected record\", expected, iterList);\n     }\n   }\n \n+  private static void sortRecordList(List<Record> list) {\n+    Collections.sort(list, (o1, o2) -> {", "originalCommit": "e52aaa82372779b176c620e4104125ccf6f1ad41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg2NzYzOA==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r522867638", "bodyText": "will there be some unknown data type in the Record that does not implement the compareTo interface?", "author": "zhangjun0x01", "createdAt": "2020-11-13T10:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NzgwNA==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r523297804", "bodyText": "Yeah, if this is just for comparing two lists, then it would be better to use a set.", "author": "rdblue", "createdAt": "2020-11-14T00:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NTM4Mw==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r523855383", "bodyText": "The assertTableRecords method provides a List parameter. For a new user  to  use this method, he may not know to use set when comparing data.\nWhether there is such a situation: the original data is (1,'a'),(1,'a'), but the actual running result is (1,'a'). This test case passed, but it is wrong.", "author": "zhangjun0x01", "createdAt": "2020-11-16T01:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUxNTk0Mg==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r525515942", "bodyText": "Maybe we should remove the duplicate records from tests so that we can use a set?", "author": "rdblue", "createdAt": "2020-11-17T20:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg4NTA1Mg==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r525885052", "bodyText": "We can generate non-repetitive test data when writing test cases, but there must be duplicate data in the production environment. Will there be test cases that pass but the production environment is incorrect?", "author": "zhangjun0x01", "createdAt": "2020-11-18T08:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4Mjc2NQ==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r526582765", "bodyText": "In this SimpleDataUtil, all Record should have the same schema (id and data  column), so  I think we could just compare those two fields directly.  Don't have to compare the hashCode.\nAbout using set to compare lists,  I'd prefer to compare sorted lists.  Because in future equality-delete test cases,  we may delete the same row several times to make sure that we've gurantteed the correct semantics.", "author": "openinx", "createdAt": "2020-11-19T04:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxMDE2OA==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r526610168", "bodyText": "In order to test the multi-level partition filter, I constructed a 2-level partition in this method : TestRewriteDataFilesAction#testRewriteDataFilesWithFilter , so each record has three fields. I don\u2019t know if there will be similar test cases in the future.", "author": "zhangjun0x01", "createdAt": "2020-11-19T05:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyNjA0Mg==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r526626042", "bodyText": "Well,  how about using the com.google.common.collect.Multiset  to assert those lists with duplicated records  ? Don't have to sort based on hashCode,  and it also allow to use more fields.", "author": "openinx", "createdAt": "2020-11-19T06:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5MzAyMg==", "url": "https://github.com/apache/iceberg/pull/1765#discussion_r526693022", "bodyText": "Yes,it is great ,I update the pr.", "author": "zhangjun0x01", "createdAt": "2020-11-19T08:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzMDkwMw=="}], "type": "inlineReview", "revised_code": {"commit": "b32919f16f6374dae56a44bd399deadb2ebc5786", "chunk": "diff --git a/flink/src/test/java/org/apache/iceberg/flink/SimpleDataUtil.java b/flink/src/test/java/org/apache/iceberg/flink/SimpleDataUtil.java\nindex 0e545b675..dc14fb683 100644\n--- a/flink/src/test/java/org/apache/iceberg/flink/SimpleDataUtil.java\n+++ b/flink/src/test/java/org/apache/iceberg/flink/SimpleDataUtil.java\n\n@@ -129,25 +129,11 @@ public class SimpleDataUtil {\n   public static void assertTableRecords(Table table, List<Record> expected) throws IOException {\n     table.refresh();\n     try (CloseableIterable<Record> iterable = IcebergGenerics.read(table).build()) {\n-      List<Record> iterList = Lists.newArrayList(iterable.iterator());\n-      sortRecordList(iterList);\n-      sortRecordList(expected);\n-      Assert.assertEquals(\"Should produce the expected record\", expected, iterList);\n+      Assert.assertEquals(\"Should produce the expected record\",\n+          HashMultiset.create(expected), HashMultiset.create(iterable));\n     }\n   }\n \n-  private static void sortRecordList(List<Record> list) {\n-    Collections.sort(list, (o1, o2) -> {\n-      if (o1.hashCode() > o2.hashCode()) {\n-        return 1;\n-      } else if (o1.hashCode() == o2.hashCode()) {\n-        return 0;\n-      } else {\n-        return -1;\n-      }\n-    });\n-  }\n-\n   public static void assertTableRecords(String tablePath, List<Record> expected) throws IOException {\n     Preconditions.checkArgument(expected != null, \"expected records shouldn't be null\");\n     assertTableRecords(new HadoopTables().load(tablePath), expected);\n"}}, {"oid": "168b53f1660e8a3197e39d0ffc0e5e1b3c43cc5a", "url": "https://github.com/apache/iceberg/commit/168b53f1660e8a3197e39d0ffc0e5e1b3c43cc5a", "message": "refactor assertTableRows methods", "committedDate": "2020-11-19T07:09:58Z", "type": "commit"}, {"oid": "b32919f16f6374dae56a44bd399deadb2ebc5786", "url": "https://github.com/apache/iceberg/commit/b32919f16f6374dae56a44bd399deadb2ebc5786", "message": " HashMultiset instread of set", "committedDate": "2020-11-19T07:09:58Z", "type": "commit"}, {"oid": "b32919f16f6374dae56a44bd399deadb2ebc5786", "url": "https://github.com/apache/iceberg/commit/b32919f16f6374dae56a44bd399deadb2ebc5786", "message": " HashMultiset instread of set", "committedDate": "2020-11-19T07:09:58Z", "type": "forcePushed"}]}