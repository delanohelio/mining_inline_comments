{"pr_number": 908, "pr_title": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "pr_createdAt": "2020-04-09T19:35:28Z", "pr_url": "https://github.com/apache/iceberg/pull/908", "timeline": [{"oid": "c66dcdb1df1e64176076ab506324ef0826dc1a14", "url": "https://github.com/apache/iceberg/commit/c66dcdb1df1e64176076ab506324ef0826dc1a14", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T04:50:02Z", "type": "forcePushed"}, {"oid": "623e874bdd9e2f23fc67a12b2124a47f187c1be9", "url": "https://github.com/apache/iceberg/commit/623e874bdd9e2f23fc67a12b2124a47f187c1be9", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T04:57:45Z", "type": "forcePushed"}, {"oid": "9b0135fbadf300094902bfab7aab2ab0a9e664f1", "url": "https://github.com/apache/iceberg/commit/9b0135fbadf300094902bfab7aab2ab0a9e664f1", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T05:01:22Z", "type": "forcePushed"}, {"oid": "0bc6beaa6e0c2fbb7029094c5ead5b7b6809a76b", "url": "https://github.com/apache/iceberg/commit/0bc6beaa6e0c2fbb7029094c5ead5b7b6809a76b", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T05:03:44Z", "type": "forcePushed"}, {"oid": "a6fae6ed5413c0472677b849257dde562b4e0eb2", "url": "https://github.com/apache/iceberg/commit/a6fae6ed5413c0472677b849257dde562b4e0eb2", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T05:16:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYxOTk1Nw==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406619957", "bodyText": "Why comment this out?", "author": "chenjunjiedada", "createdAt": "2020-04-10T06:19:37Z", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -342,7 +345,7 @@ public void testAllDataFilesTable() throws Exception {\n         .save(loadLocation(tableIdentifier));\n \n     // delete the first file to test that not only live files are listed\n-    table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit();\n+ //   table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit(); //\u8fd9\u91cc\u4f1a\u5f71\u54cdWAP \u8868", "originalCommit": "a6fae6ed5413c0472677b849257dde562b4e0eb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "574d0ad1896133a1a63211fdd3e576f60d123134", "chunk": "diff --git a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\nindex 20e894bf1..fc27ea887 100644\n--- a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n+++ b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n\n@@ -345,7 +342,7 @@ public abstract class TestIcebergSourceTablesBase {\n         .save(loadLocation(tableIdentifier));\n \n     // delete the first file to test that not only live files are listed\n- //   table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit(); //\u8fd9\u91cc\u4f1a\u5f71\u54cdWAP \u8868\n+    table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit();\n \n     // add a second file\n     df2.select(\"id\", \"data\").write()\n"}}, {"oid": "574d0ad1896133a1a63211fdd3e576f60d123134", "url": "https://github.com/apache/iceberg/commit/574d0ad1896133a1a63211fdd3e576f60d123134", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T07:23:17Z", "type": "commit"}, {"oid": "574d0ad1896133a1a63211fdd3e576f60d123134", "url": "https://github.com/apache/iceberg/commit/574d0ad1896133a1a63211fdd3e576f60d123134", "message": "[ISSUE #905] report data for WAP snapshots when currentSnapshot is null", "committedDate": "2020-04-10T07:23:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1MTU5OQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406851599", "bodyText": "Why do we need to duplicate these abstract methods here too?", "author": "aokolnychyi", "createdAt": "2020-04-10T17:08:57Z", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+\n+  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected MetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  protected abstract long targetSplitSize(TableOperations ops);", "originalCommit": "574d0ad1896133a1a63211fdd3e576f60d123134", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nsimilarity index 52%\nrename from core/src/main/java/org/apache/iceberg/MetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nindex a7a75b1cd..7515f6273 100644\n--- a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n\n@@ -28,49 +28,25 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class MetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n \n-  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected MetadataTableScan(\n+  protected AggregatedMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n     super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n   }\n \n-  @Override\n-  protected abstract long targetSplitSize(TableOperations ops);\n-\n-  @Override\n-  protected abstract TableScan newRefinedScan(\n-      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter, boolean caseSensitive,\n-      boolean colStats, Collection<String> selectedColumns, ImmutableMap<String, String> options);\n-\n-  @Override\n-  protected abstract CloseableIterable<FileScanTask> planFiles(\n-      TableOperations ops, Snapshot snapshot, Expression rowFilter, boolean caseSensitive, boolean colStats);\n-\n   @Override\n   public CloseableIterable<FileScanTask> planFiles() {\n-    Snapshot snapshot = snapshot();\n-    if (snapshot != null) {\n-      LOG.info(\"Scanning table {} snapshot {} created at {} with filter {}\", table(),\n-          snapshot.snapshotId(), formatTimestampMillis(snapshot.timestampMillis()),\n-          filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), snapshot.snapshotId(), filter(), schema()));\n-    } else {\n-      LOG.info(\"Scanning table {} snapshot is NULL with filter {}\", table(), filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), 0L, filter(), schema()));\n-    }\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());\n+    Listeners.notifyAll(new ScanEvent(table().toString(), 0L, filter(), schema()));\n \n-    return planFiles(tableOps(), snapshot, filter(), isCaseSensitive(), colStats());\n+    return planFiles(tableOps(), snapshot(), filter(), isCaseSensitive(), colStats());\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1Mzc3NQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406853775", "bodyText": "The name MetadataTableScan is very generic but it is actually used only in aggregated metadata tables like all_data_files and all_manifests. I think we either need to change the naming or just override planFiles() in each individually. We can, for example, simply check if there is any snapshot at all and if yes, call an overloaded version of planFiles.", "author": "aokolnychyi", "createdAt": "2020-04-10T17:14:07Z", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {", "originalCommit": "574d0ad1896133a1a63211fdd3e576f60d123134", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nsimilarity index 52%\nrename from core/src/main/java/org/apache/iceberg/MetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nindex a7a75b1cd..7515f6273 100644\n--- a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n\n@@ -28,49 +28,25 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class MetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n \n-  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected MetadataTableScan(\n+  protected AggregatedMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n     super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n   }\n \n-  @Override\n-  protected abstract long targetSplitSize(TableOperations ops);\n-\n-  @Override\n-  protected abstract TableScan newRefinedScan(\n-      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter, boolean caseSensitive,\n-      boolean colStats, Collection<String> selectedColumns, ImmutableMap<String, String> options);\n-\n-  @Override\n-  protected abstract CloseableIterable<FileScanTask> planFiles(\n-      TableOperations ops, Snapshot snapshot, Expression rowFilter, boolean caseSensitive, boolean colStats);\n-\n   @Override\n   public CloseableIterable<FileScanTask> planFiles() {\n-    Snapshot snapshot = snapshot();\n-    if (snapshot != null) {\n-      LOG.info(\"Scanning table {} snapshot {} created at {} with filter {}\", table(),\n-          snapshot.snapshotId(), formatTimestampMillis(snapshot.timestampMillis()),\n-          filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), snapshot.snapshotId(), filter(), schema()));\n-    } else {\n-      LOG.info(\"Scanning table {} snapshot is NULL with filter {}\", table(), filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), 0L, filter(), schema()));\n-    }\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());\n+    Listeners.notifyAll(new ScanEvent(table().toString(), 0L, filter(), schema()));\n \n-    return planFiles(tableOps(), snapshot, filter(), isCaseSensitive(), colStats());\n+    return planFiles(tableOps(), snapshot(), filter(), isCaseSensitive(), colStats());\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NDk1NA==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406854954", "bodyText": "We don't have to analyze the current snapshot for all_data_files and all_manifests.", "author": "aokolnychyi", "createdAt": "2020-04-10T17:16:51Z", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+\n+  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected MetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  protected abstract long targetSplitSize(TableOperations ops);\n+\n+  @Override\n+  protected abstract TableScan newRefinedScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter, boolean caseSensitive,\n+      boolean colStats, Collection<String> selectedColumns, ImmutableMap<String, String> options);\n+\n+  @Override\n+  protected abstract CloseableIterable<FileScanTask> planFiles(\n+      TableOperations ops, Snapshot snapshot, Expression rowFilter, boolean caseSensitive, boolean colStats);\n+\n+  @Override\n+  public CloseableIterable<FileScanTask> planFiles() {\n+    Snapshot snapshot = snapshot();", "originalCommit": "574d0ad1896133a1a63211fdd3e576f60d123134", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nsimilarity index 52%\nrename from core/src/main/java/org/apache/iceberg/MetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nindex a7a75b1cd..7515f6273 100644\n--- a/core/src/main/java/org/apache/iceberg/MetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n\n@@ -28,49 +28,25 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class MetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n \n-  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected MetadataTableScan(\n+  protected AggregatedMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n     super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n   }\n \n-  @Override\n-  protected abstract long targetSplitSize(TableOperations ops);\n-\n-  @Override\n-  protected abstract TableScan newRefinedScan(\n-      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter, boolean caseSensitive,\n-      boolean colStats, Collection<String> selectedColumns, ImmutableMap<String, String> options);\n-\n-  @Override\n-  protected abstract CloseableIterable<FileScanTask> planFiles(\n-      TableOperations ops, Snapshot snapshot, Expression rowFilter, boolean caseSensitive, boolean colStats);\n-\n   @Override\n   public CloseableIterable<FileScanTask> planFiles() {\n-    Snapshot snapshot = snapshot();\n-    if (snapshot != null) {\n-      LOG.info(\"Scanning table {} snapshot {} created at {} with filter {}\", table(),\n-          snapshot.snapshotId(), formatTimestampMillis(snapshot.timestampMillis()),\n-          filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), snapshot.snapshotId(), filter(), schema()));\n-    } else {\n-      LOG.info(\"Scanning table {} snapshot is NULL with filter {}\", table(), filter());\n-\n-      Listeners.notifyAll(\n-          new ScanEvent(table().toString(), 0L, filter(), schema()));\n-    }\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());\n+    Listeners.notifyAll(new ScanEvent(table().toString(), 0L, filter(), schema()));\n \n-    return planFiles(tableOps(), snapshot, filter(), isCaseSensitive(), colStats());\n+    return planFiles(tableOps(), snapshot(), filter(), isCaseSensitive(), colStats());\n   }\n }\n"}}, {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "url": "https://github.com/apache/iceberg/commit/859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "message": "[ISSUE #905] Alter class file name and add testUtil for stage table", "committedDate": "2020-04-12T05:40:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjczOA==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407566738", "bodyText": "Tale -> Table?", "author": "rdblue", "createdAt": "2020-04-13T16:20:42Z", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTaleInStage() throws Exception {", "originalCommit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjUyOA==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826528", "bodyText": "fixed", "author": "XiaokunDing", "createdAt": "2020-04-14T02:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjczOA=="}], "type": "inlineReview", "revised_code": {"commit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "chunk": "diff --git a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\nindex f8d65119b..6803e5214 100644\n--- a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n+++ b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n\n@@ -327,7 +327,7 @@ public abstract class TestIcebergSourceTablesBase {\n   }\n \n   @Test\n-  public void testAggregatedMetadataTaleInStage() throws Exception {\n+  public void testAggregatedMetadataTableInStage() throws Exception {\n     TableIdentifier tableIdentifier = TableIdentifier.of(\"db\", \"stage_aggregate_table_test\");\n     Table table = createTable(tableIdentifier, SCHEMA, PartitionSpec.builderFor(SCHEMA).identity(\"id\").build());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567132", "bodyText": "Why is this public?", "author": "rdblue", "createdAt": "2020-04-13T16:21:28Z", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {", "originalCommit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2Nzg4NA==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567884", "bodyText": "These tables aren't aggregates. In fact, some of them produce duplicates (like all_manifests) when a file appears twice. Can we use a better name here? What about BaseAllMetadataTableScan?", "author": "rdblue", "createdAt": "2020-04-13T16:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjQ4OQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826489", "bodyText": "fixed", "author": "XiaokunDing", "createdAt": "2020-04-14T02:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg=="}], "type": "inlineReview", "revised_code": {"commit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nsimilarity index 82%\nrename from core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nindex 7515f6273..3cda65400 100644\n--- a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\n\n@@ -28,14 +28,14 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+abstract class BaseAllMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(BaseAllMetadataTableScan.class);\n \n-  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  BaseAllMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected AggregatedMetadataTableScan(\n+  BaseAllMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzIwNA==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567204", "bodyText": "This can be protected or package-private.", "author": "rdblue", "createdAt": "2020-04-13T16:21:36Z", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {", "originalCommit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI1Ng==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826256", "bodyText": "OK", "author": "XiaokunDing", "createdAt": "2020-04-14T02:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzIwNA=="}], "type": "inlineReview", "revised_code": {"commit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nsimilarity index 82%\nrename from core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nindex 7515f6273..3cda65400 100644\n--- a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\n\n@@ -28,14 +28,14 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+abstract class BaseAllMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(BaseAllMetadataTableScan.class);\n \n-  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  BaseAllMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected AggregatedMetadataTableScan(\n+  BaseAllMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTE2Ng==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407569166", "bodyText": "I don't think it's necessary to use \"in all snapshots\" because a snapshot doesn't make sense for these tables. It's not that this is scanning the manifests table across all snapshots, it is scanning the all_manifests table that is not specific to a snapshot by definition. Let's change this to Scanning metadata table {} with filter {}.", "author": "rdblue", "createdAt": "2020-04-13T16:25:17Z", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected AggregatedMetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  public CloseableIterable<FileScanTask> planFiles() {\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());", "originalCommit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjE3OQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826179", "bodyText": "fixed", "author": "XiaokunDing", "createdAt": "2020-04-14T02:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nsimilarity index 82%\nrename from core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\nrename to core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\nindex 7515f6273..3cda65400 100644\n--- a/core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/BaseAllMetadataTableScan.java\n\n@@ -28,14 +28,14 @@ import org.apache.iceberg.io.CloseableIterable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n-  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+abstract class BaseAllMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(BaseAllMetadataTableScan.class);\n \n-  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+  BaseAllMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n     super(ops, table, fileSchema);\n   }\n \n-  protected AggregatedMetadataTableScan(\n+  BaseAllMetadataTableScan(\n       TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n       boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n       ImmutableMap<String, String> options) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTUwMQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407569501", "bodyText": "This isn't used. Could you revert this change?", "author": "rdblue", "createdAt": "2020-04-13T16:25:54Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -318,7 +318,7 @@ private Schema lazyColumnProjection() {\n     return schema;\n   }\n \n-  private static String formatTimestampMillis(long millis) {\n+  protected static String formatTimestampMillis(long millis) {", "originalCommit": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyMjU0Nw==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407822547", "bodyText": "OK", "author": "XiaokunDing", "createdAt": "2020-04-14T02:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/BaseTableScan.java b/core/src/main/java/org/apache/iceberg/BaseTableScan.java\nindex c634f657a..fb0e5f7dc 100644\n--- a/core/src/main/java/org/apache/iceberg/BaseTableScan.java\n+++ b/core/src/main/java/org/apache/iceberg/BaseTableScan.java\n\n@@ -318,7 +318,7 @@ abstract class BaseTableScan implements TableScan {\n     return schema;\n   }\n \n-  protected static String formatTimestampMillis(long millis) {\n+  private static String formatTimestampMillis(long millis) {\n     return DATE_FORMAT.format(LocalDateTime.ofInstant(Instant.ofEpochMilli(millis), ZoneId.systemDefault()));\n   }\n }\n"}}, {"oid": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "url": "https://github.com/apache/iceberg/commit/1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "message": "[ISSUE #905] Fix the code address comments by Ryan Blue", "committedDate": "2020-04-14T02:08:32Z", "type": "commit"}, {"oid": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "url": "https://github.com/apache/iceberg/commit/1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "message": "[ISSUE #905] Fix the code address comments by Ryan Blue", "committedDate": "2020-04-14T02:08:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NjM1NQ==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r408276355", "bodyText": "This test name is incorrect. Can you please update it to testAllMetadataTablesWithStagedCommits()?", "author": "rdblue", "createdAt": "2020-04-14T16:34:26Z", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTableInStage() throws Exception {", "originalCommit": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNjE1Mw==", "url": "https://github.com/apache/iceberg/pull/908#discussion_r408536153", "bodyText": "OK", "author": "XiaokunDing", "createdAt": "2020-04-15T01:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NjM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "104fe30379103b27a48cbc5e09d3f408361300d4", "chunk": "diff --git a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\nindex 6803e5214..2204d3578 100644\n--- a/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n+++ b/spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java\n\n@@ -327,7 +327,7 @@ public abstract class TestIcebergSourceTablesBase {\n   }\n \n   @Test\n-  public void testAggregatedMetadataTableInStage() throws Exception {\n+  public void testAllTablesWithStagedCommits() throws Exception {\n     TableIdentifier tableIdentifier = TableIdentifier.of(\"db\", \"stage_aggregate_table_test\");\n     Table table = createTable(tableIdentifier, SCHEMA, PartitionSpec.builderFor(SCHEMA).identity(\"id\").build());\n \n"}}, {"oid": "104fe30379103b27a48cbc5e09d3f408361300d4", "url": "https://github.com/apache/iceberg/commit/104fe30379103b27a48cbc5e09d3f408361300d4", "message": "Update TestIcebergSourceTablesBase.java", "committedDate": "2020-04-14T16:35:52Z", "type": "commit"}, {"oid": "799b148bf5b9ac0bc5b4c0345cef643a14b92e19", "url": "https://github.com/apache/iceberg/commit/799b148bf5b9ac0bc5b4c0345cef643a14b92e19", "message": "[ISSUE #905] Fix the code address comments by Ryan Blue", "committedDate": "2020-04-15T02:20:46Z", "type": "commit"}]}