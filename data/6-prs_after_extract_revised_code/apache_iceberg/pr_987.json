{"pr_number": 987, "pr_title": "Suppress exceptions while unlocking tables in HiveTableOperations", "pr_createdAt": "2020-04-29T21:49:10Z", "pr_url": "https://github.com/apache/iceberg/pull/987", "timeline": [{"oid": "2f9810fab510b40a08c31116c17fe47b5ee2aa46", "url": "https://github.com/apache/iceberg/commit/2f9810fab510b40a08c31116c17fe47b5ee2aa46", "message": "Suppress exceptions while unlocking tables in HiveTableOperations", "committedDate": "2020-04-29T21:04:09Z", "type": "commit"}, {"oid": "9079f35d5714a860c8218b683ab02a72a431323f", "url": "https://github.com/apache/iceberg/commit/9079f35d5714a860c8218b683ab02a72a431323f", "message": "Fix the test", "committedDate": "2020-04-30T00:15:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4MTQwNA==", "url": "https://github.com/apache/iceberg/pull/987#discussion_r417681404", "bodyText": "nit: this itself gives the TableMetadataV2, no?", "author": "rdsr", "createdAt": "2020-04-30T00:02:43Z", "path": "hive/src/test/java/org/apache/iceberg/hive/TestHiveCommits.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.hive;\n+\n+import org.apache.iceberg.HasTableOperations;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.TableMetadata;\n+import org.apache.iceberg.types.Types;\n+import org.apache.thrift.TException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import static org.mockito.Matchers.anyLong;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.spy;\n+\n+public class TestHiveCommits extends HiveTableBaseTest {\n+\n+  @Test\n+  public void testSuppressUnlockExceptions() throws TException, InterruptedException {\n+    Table table = catalog.loadTable(TABLE_IDENTIFIER);\n+    HiveTableOperations ops = (HiveTableOperations) ((HasTableOperations) table).operations();\n+\n+    TableMetadata metadataV1 = ops.current();\n+\n+    table.updateSchema()\n+        .addColumn(\"n\", Types.IntegerType.get())\n+        .commit();\n+\n+    ops.refresh();", "originalCommit": "2f9810fab510b40a08c31116c17fe47b5ee2aa46", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9079f35d5714a860c8218b683ab02a72a431323f", "chunk": "diff --git a/hive/src/test/java/org/apache/iceberg/hive/TestHiveCommits.java b/hive/src/test/java/org/apache/iceberg/hive/TestHiveCommits.java\nindex 4b85fb251..81ac5043a 100644\n--- a/hive/src/test/java/org/apache/iceberg/hive/TestHiveCommits.java\n+++ b/hive/src/test/java/org/apache/iceberg/hive/TestHiveCommits.java\n\n@@ -26,8 +26,8 @@ import org.apache.iceberg.types.Types;\n import org.apache.thrift.TException;\n import org.junit.Assert;\n import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n \n-import static org.mockito.Matchers.anyLong;\n import static org.mockito.Mockito.doThrow;\n import static org.mockito.Mockito.spy;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjQ2Mg==", "url": "https://github.com/apache/iceberg/pull/987#discussion_r417686462", "bodyText": "I'm generally ok, but what's the behavior you've seen on the server side? Can new locks still be acquired by other clients or the table is left in a locked state forever?", "author": "rdsr", "createdAt": "2020-04-30T00:20:12Z", "path": "hive/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java", "diffHunk": "@@ -296,13 +296,18 @@ private long acquireLock() throws UnknownHostException, TException, InterruptedE\n   private void unlock(Optional<Long> lockId) {\n     if (lockId.isPresent()) {\n       try {\n-        metaClients.run(client -> {\n-          client.unlock(lockId.get());\n-          return null;\n-        });\n+        doUnlock(lockId.get());\n       } catch (Exception e) {\n-        throw new RuntimeException(String.format(\"Failed to unlock %s.%s\", database, tableName), e);\n+        LOG.warn(\"Failed to unlock {}.{}\", database, tableName, e);", "originalCommit": "2f9810fab510b40a08c31116c17fe47b5ee2aa46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4OTc4MA==", "url": "https://github.com/apache/iceberg/pull/987#discussion_r417689780", "bodyText": "If an update succeeds, then this method must return success.\nIf it doesn't return successfully but did update, then the caller will delete the metadata file that was attempted. But that metadata file was actually commited. In that case, the table is broken.\nAlso note that Iceberg must delete the metadata file that was attempted if the commit fails. If not, then the situation where an attempt succeeds but the method throws an exception can result in a retry, which could succeed because the table is fine. In that case, the table has silently committed the same data twice. It is better to break the table than to corrupt the data.", "author": "rdblue", "createdAt": "2020-04-30T00:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjQ2Mg=="}], "type": "inlineReview", "revised_code": null}]}