{"pr_number": 1796, "pr_title": "Core: Add table property to disable garbage collection", "pr_createdAt": "2020-11-20T17:35:21Z", "pr_url": "https://github.com/apache/iceberg/pull/1796", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg2Nzg2MQ==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527867861", "bodyText": "I like this. We can also add a property to require the action is used instead of the table operation to ensure that we use reachability instead of incremental changes.", "author": "rdblue", "createdAt": "2020-11-20T17:49:14Z", "path": "core/src/main/java/org/apache/iceberg/TableProperties.java", "diffHunk": "@@ -134,4 +134,7 @@ private TableProperties() {\n \n   public static final String ENGINE_HIVE_ENABLED = \"engine.hive.enabled\";\n   public static final boolean ENGINE_HIVE_ENABLED_DEFAULT = false;\n+\n+  public static final String GC_ENABLED = \"gc.enabled\";\n+  public static final boolean GC_ENABLED_DEFAULT = true;", "originalCommit": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527874919", "bodyText": "I think it's still ok to put in instructions for disabling this parameter as a workaround. Just helps a user to know how to unblock themselves just in case. Also nit: \"Cannot expire snapshots\" would follow our pattern for errors in other places", "author": "RussellSpitzer", "createdAt": "2020-11-20T17:57:36Z", "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -78,6 +81,13 @@ public void accept(String file) {\n   RemoveSnapshots(TableOperations ops) {\n     this.ops = ops;\n     this.base = ops.current();\n+\n+    ValidationException.check(\n+        PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n+        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +\n+        \"Make sure this table is the exclusive owner of its data files before allowing garbage collection. \" +\n+        \"If the table was created using the SNAPSHOT operation, it is not safe to expire snapshots in it since \" +\n+        \"this may remove files in the original table.\");", "originalCommit": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkwMjY2MQ==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527902661", "bodyText": "Hmm... I'm struggling a bit with someone being allowed to update this in certain cases. It seems like a very sharp edge to expose/suggest.", "author": "jacques-n", "createdAt": "2020-11-20T18:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkzNjExMg==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527936112", "bodyText": "I think it is reasonable to allow people to update it. Having properties that can only be set by the library itself seems like we're asking for people to go edit files by hand when they have a need. That said, I think it would be fine to not suggest that this can be changed. If they want to track it down by going to the code and reading this check, then fine. But we can change this to \"Cannot expire snapshots: GC is disabled (deleting files may corrupt other tables)\"", "author": "rdblue", "createdAt": "2020-11-20T19:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkzNzM4MQ==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527937381", "bodyText": "I agree that suggesting is dangerous but letting do this should be fine.", "author": "aokolnychyi", "createdAt": "2020-11-20T19:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java b/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\nindex 73be42026..e283b2c42 100644\n--- a/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\n+++ b/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\n\n@@ -84,10 +84,7 @@ class RemoveSnapshots implements ExpireSnapshots {\n \n     ValidationException.check(\n         PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n-        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +\n-        \"Make sure this table is the exclusive owner of its data files before allowing garbage collection. \" +\n-        \"If the table was created using the SNAPSHOT operation, it is not safe to expire snapshots in it since \" +\n-        \"this may remove files in the original table.\");\n+        \"Cannot expire snapshots: GC is disabled (deleting files may corrupt other tables)\");\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NjEzMA==", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527876130", "bodyText": "nit 'the' not needed: Not allowed to expire snapshots as garbage collection is disabled for this table.", "author": "RussellSpitzer", "createdAt": "2020-11-20T17:59:09Z", "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -78,6 +81,13 @@ public void accept(String file) {\n   RemoveSnapshots(TableOperations ops) {\n     this.ops = ops;\n     this.base = ops.current();\n+\n+    ValidationException.check(\n+        PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n+        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +", "originalCommit": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java b/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\nindex 73be42026..e283b2c42 100644\n--- a/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\n+++ b/core/src/main/java/org/apache/iceberg/RemoveSnapshots.java\n\n@@ -84,10 +84,7 @@ class RemoveSnapshots implements ExpireSnapshots {\n \n     ValidationException.check(\n         PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n-        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +\n-        \"Make sure this table is the exclusive owner of its data files before allowing garbage collection. \" +\n-        \"If the table was created using the SNAPSHOT operation, it is not safe to expire snapshots in it since \" +\n-        \"this may remove files in the original table.\");\n+        \"Cannot expire snapshots: GC is disabled (deleting files may corrupt other tables)\");\n   }\n \n   @Override\n"}}, {"oid": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "url": "https://github.com/apache/iceberg/commit/bd96e51f6863d04523fb48f4630f2f3309df9d11", "message": "Core: Add table property to disable garbage collection", "committedDate": "2020-11-20T20:09:46Z", "type": "commit"}, {"oid": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "url": "https://github.com/apache/iceberg/commit/bd96e51f6863d04523fb48f4630f2f3309df9d11", "message": "Core: Add table property to disable garbage collection", "committedDate": "2020-11-20T20:09:46Z", "type": "forcePushed"}, {"oid": "7219b184b9f4f780ef79e481411488bb811fd77b", "url": "https://github.com/apache/iceberg/commit/7219b184b9f4f780ef79e481411488bb811fd77b", "message": "Fix test", "committedDate": "2020-11-20T20:12:45Z", "type": "commit"}, {"oid": "593930576b55c2360542b81f2a3e49a06765805b", "url": "https://github.com/apache/iceberg/commit/593930576b55c2360542b81f2a3e49a06765805b", "message": "Fix check description", "committedDate": "2020-11-20T20:14:47Z", "type": "commit"}]}