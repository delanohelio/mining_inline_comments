{"pr_number": 1080, "pr_title": "Split Snapshot.manifests into dataManifests and deleteManifests", "pr_createdAt": "2020-05-30T00:29:19Z", "pr_url": "https://github.com/apache/iceberg/pull/1080", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MTgzMA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432791830", "bodyText": "This is no longer needed. It was used to find all manifest entries for a file to help debug changes. Now that can be handled in parallel by the all_entries metadata table.", "author": "rdblue", "createdAt": "2020-05-30T00:34:35Z", "path": "core/src/main/java/org/apache/iceberg/FileHistory.java", "diffHunk": "@@ -1,119 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.iceberg;\n-\n-import java.io.IOException;\n-import java.util.List;\n-import java.util.Set;\n-import org.apache.iceberg.exceptions.RuntimeIOException;\n-import org.apache.iceberg.expressions.Literal;\n-import org.apache.iceberg.io.CloseableIterable;\n-import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n-import org.apache.iceberg.relocated.com.google.common.collect.Iterables;\n-import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n-import org.apache.iceberg.relocated.com.google.common.collect.Sets;\n-import org.apache.iceberg.types.Types;\n-import org.apache.iceberg.util.CharSequenceWrapper;\n-\n-public class FileHistory {", "originalCommit": "411bd27253cd707a1e92f2e58c382dd9558dadde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjEzNA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792134", "bodyText": "The contract for this class is to return matching data files, not splits. We use it in some cases to avoid newScan that will return either FileScanTask or CombinedScanTask and will emit a scan event. I think we may be able to remove it, or update it to return both data and delete files. For now, this uses dataManifests to mimic the current behavior.", "author": "rdblue", "createdAt": "2020-05-30T00:36:47Z", "path": "core/src/main/java/org/apache/iceberg/FindFiles.java", "diffHunk": "@@ -197,7 +197,7 @@ public Builder inPartitions(PartitionSpec spec, List<StructLike> partitions) {\n       }\n \n       // when snapshot is not null\n-      CloseableIterable<ManifestEntry<DataFile>> entries = new ManifestGroup(ops.io(), snapshot.manifests())\n+      CloseableIterable<ManifestEntry<DataFile>> entries = new ManifestGroup(ops.io(), snapshot.dataManifests())", "originalCommit": "411bd27253cd707a1e92f2e58c382dd9558dadde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjE5MA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792190", "bodyText": "For now, scans continue to ignore delete manifests and delete files.", "author": "rdblue", "createdAt": "2020-05-30T00:37:13Z", "path": "core/src/main/java/org/apache/iceberg/IncrementalDataTableScan.java", "diffHunk": "@@ -84,7 +84,7 @@ public TableScan appendsAfter(long newFromSnapshotId) {\n     Set<Long> snapshotIds = Sets.newHashSet(Iterables.transform(snapshots, Snapshot::snapshotId));\n     Set<ManifestFile> manifests = FluentIterable\n         .from(snapshots)\n-        .transformAndConcat(s -> s.manifests())\n+        .transformAndConcat(s -> s.dataManifests())", "originalCommit": "411bd27253cd707a1e92f2e58c382dd9558dadde", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjM2Ng==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792366", "bodyText": "Carry forward delete manifests, if present.", "author": "rdblue", "createdAt": "2020-05-30T00:38:17Z", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -297,6 +297,9 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n       Set<CharSequenceWrapper> deletedFiles = deletedFiles(unmergedManifests);\n \n       List<ManifestFile> manifests = Lists.newArrayList();\n+      if (current != null) {\n+        manifests.addAll(current.deleteManifests());\n+      }", "originalCommit": "411bd27253cd707a1e92f2e58c382dd9558dadde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MjkzMA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434052930", "bodyText": "Moved to the end of the manifest list.", "author": "rdblue", "createdAt": "2020-06-02T17:34:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e565075882ff3691bf6dc6ba315094c046ed7bda", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java b/core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java\nindex 6d106e06a..7a6ab8fa8 100644\n--- a/core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java\n+++ b/core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java\n\n@@ -297,9 +297,6 @@ abstract class MergingSnapshotProducer<ThisT> extends SnapshotProducer<ThisT> {\n       Set<CharSequenceWrapper> deletedFiles = deletedFiles(unmergedManifests);\n \n       List<ManifestFile> manifests = Lists.newArrayList();\n-      if (current != null) {\n-        manifests.addAll(current.deleteManifests());\n-      }\n       if (mergeEnabled) {\n         groupManifestsByPartitionSpec(groups, unmergedManifests);\n         for (Map.Entry<Integer, List<ManifestFile>> entry : groups.entrySet()) {\n"}}, {"oid": "7f3dfce5c89b4ca0a5bafba524953605efbb5d33", "url": "https://github.com/apache/iceberg/commit/7f3dfce5c89b4ca0a5bafba524953605efbb5d33", "message": "Split Snapshot.manifests into dataManifests and deleteManifests.", "committedDate": "2020-05-30T00:52:55Z", "type": "commit"}, {"oid": "7f3dfce5c89b4ca0a5bafba524953605efbb5d33", "url": "https://github.com/apache/iceberg/commit/7f3dfce5c89b4ca0a5bafba524953605efbb5d33", "message": "Split Snapshot.manifests into dataManifests and deleteManifests.", "committedDate": "2020-05-30T00:52:55Z", "type": "forcePushed"}, {"oid": "8342d26ae815753c4cf26c63e73c6df0500037af", "url": "https://github.com/apache/iceberg/commit/8342d26ae815753c4cf26c63e73c6df0500037af", "message": "Fix checkstyle.", "committedDate": "2020-06-01T17:04:48Z", "type": "commit"}, {"oid": "bc082c5cc0c3b2098855531d2c2a5dc462773fac", "url": "https://github.com/apache/iceberg/commit/bc082c5cc0c3b2098855531d2c2a5dc462773fac", "message": "Fix test failures.", "committedDate": "2020-06-01T19:15:29Z", "type": "commit"}, {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "url": "https://github.com/apache/iceberg/commit/3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "message": "Fix manifest caching.", "committedDate": "2020-06-01T20:29:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433753006", "bodyText": "This and two other tests use dataManifests() where all other tests have been changed to allManifests(). Is this intentional?\nOther tests:\nTestRemoveSnapshots\nRewriteManifestsAction", "author": "rymurr", "createdAt": "2020-06-02T09:44:46Z", "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "diffHunk": "@@ -224,10 +224,10 @@ void validateSnapshot(Snapshot old, Snapshot snap, long sequenceNumber, DataFile\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n-    List<ManifestFile> oldManifests = old != null ? old.manifests() : ImmutableList.of();\n+    List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMDYzOQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434000639", "bodyText": "My reasoning was that the signature of this method is DataFile... newFiles, so callers can't pass DeleteFile. But, I could add an assertion that deleteManifests() is empty.", "author": "rdblue", "createdAt": "2020-06-02T16:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMTI1OQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434011259", "bodyText": "I think adding an assertion is a good idea. Will it keep it safe for future use.", "author": "aokolnychyi", "createdAt": "2020-06-02T16:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1NDQ3NA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434054474", "bodyText": "Adding an assertion that the set of delete manifests has not changed from old to new.", "author": "rdblue", "createdAt": "2020-06-02T17:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e565075882ff3691bf6dc6ba315094c046ed7bda", "chunk": "diff --git a/core/src/test/java/org/apache/iceberg/TableTestBase.java b/core/src/test/java/org/apache/iceberg/TableTestBase.java\nindex 4b7d8b5e9..e11567529 100644\n--- a/core/src/test/java/org/apache/iceberg/TableTestBase.java\n+++ b/core/src/test/java/org/apache/iceberg/TableTestBase.java\n\n@@ -224,6 +225,9 @@ public class TableTestBase {\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n+    Assert.assertEquals(\"Should not change delete manifests\",\n+        old != null ? Sets.newHashSet(old.deleteManifests()) : ImmutableSet.of(),\n+        Sets.newHashSet(snap.deleteManifests()));\n     List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();\n \n     // copy the manifests to a modifiable list and remove the existing manifests\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1NTY0Mw==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433755643", "bodyText": "Is this explicitly ignoring the effect of deleted rows on partition metrics or is it just that you are short circuiting any delete files (as we can't use them anyways)", "author": "rymurr", "createdAt": "2020-06-02T09:49:23Z", "path": "core/src/main/java/org/apache/iceberg/ScanSummary.java", "diffHunk": "@@ -159,7 +159,7 @@ private void removeTimeFilters(List<Expression> expressions, Expression expressi\n       removeTimeFilters(filters, Expressions.rewriteNot(scan.filter()));\n       Expression rowFilter = joinFilters(filters);\n \n-      Iterable<ManifestFile> manifests = table.currentSnapshot().manifests();\n+      Iterable<ManifestFile> manifests = table.currentSnapshot().dataManifests();", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTgwMw==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434001803", "bodyText": "This whole class will need to be updated to support detecting changes in delete files, so I just did the minimum to update it safely. Since it uses ManifestFiles.read later instead of ManifestFiles.readDeletes, it made sense to only use data manifests. This is one that we should plan to update in a separate PR, if anyone is using it.", "author": "rdblue", "createdAt": "2020-06-02T16:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1NTY0Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433758578", "bodyText": "The addition of delete files in newManifests far above the addition of data files threw me a bit. Is it intentional to ensure the delete files are at the front of the list?", "author": "rymurr", "createdAt": "2020-06-02T09:54:36Z", "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -122,6 +122,10 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n   public List<ManifestFile> apply(TableMetadata base) {\n     List<ManifestFile> newManifests = Lists.newArrayList();\n \n+    if (base.currentSnapshot() != null) {\n+      newManifests.addAll(base.currentSnapshot().deleteManifests());\n+    }", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMjM5Ng==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434002396", "bodyText": "Yes, the idea is to keep delete manifests at the front of the list.", "author": "rdblue", "createdAt": "2020-06-02T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MTQzOA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434051438", "bodyText": "Updated to move delete manifests to the end.", "author": "rdblue", "createdAt": "2020-06-02T17:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "e565075882ff3691bf6dc6ba315094c046ed7bda", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/FastAppend.java b/core/src/main/java/org/apache/iceberg/FastAppend.java\nindex 6c2c2063d..b370a180e 100644\n--- a/core/src/main/java/org/apache/iceberg/FastAppend.java\n+++ b/core/src/main/java/org/apache/iceberg/FastAppend.java\n\n@@ -122,10 +122,6 @@ class FastAppend extends SnapshotProducer<AppendFiles> implements AppendFiles {\n   public List<ManifestFile> apply(TableMetadata base) {\n     List<ManifestFile> newManifests = Lists.newArrayList();\n \n-    if (base.currentSnapshot() != null) {\n-      newManifests.addAll(base.currentSnapshot().deleteManifests());\n-    }\n-\n     try {\n       ManifestFile manifest = writeManifest();\n       if (manifest != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433760146", "bodyText": "Here data manifests are (potentially) rewritten while keeping deletes the same. Again with deletes at the front. Do I understand correctly? The comment is a bit misleading as immediately below it old delete manifests are added to the list.", "author": "rymurr", "createdAt": "2020-06-02T09:57:23Z", "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -174,13 +173,13 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n \n     validateFilesCounts();\n \n-    // TODO: add sequence numbers here\n     Iterable<ManifestFile> newManifestsWithMetadata = Iterables.transform(\n         Iterables.concat(newManifests, addedManifests, rewrittenAddedManifests),\n         manifest -> GenericManifestFile.copyOf(manifest).withSnapshotId(snapshotId()).build());\n \n     // put new manifests at the beginning\n-    List<ManifestFile> apply = new ArrayList<>();\n+    List<ManifestFile> apply = Lists.newArrayList();\n+    apply.addAll(base.currentSnapshot().deleteManifests());", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNDU3OQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434004579", "bodyText": "We should probably update the comment to include delete handling. We put new manifests at the front of the list because those are the ones most likely to have data for a query when writes align with reads (recent hours are read more often than data that's months old).\nI guess we don't really need the delete manifests at the start of the list. We could put those at the end since they get split out into a separate list. The one that matters is scanning the recent manifests first when planning jobs to get data faster in engines like Presto that run the query and planning concurrently.", "author": "rdblue", "createdAt": "2020-06-02T16:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNTIxMA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434015210", "bodyText": "To me, putting delete manifests at the end would be more natural.", "author": "aokolnychyi", "createdAt": "2020-06-02T16:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0NzI3OA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434047278", "bodyText": "Moving manifests to the end.", "author": "rdblue", "createdAt": "2020-06-02T17:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e565075882ff3691bf6dc6ba315094c046ed7bda", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java b/core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java\nindex 1b9d85cd0..1993c7952 100644\n--- a/core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java\n+++ b/core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java\n\n@@ -179,9 +179,9 @@ public class BaseRewriteManifests extends SnapshotProducer<RewriteManifests> imp\n \n     // put new manifests at the beginning\n     List<ManifestFile> apply = Lists.newArrayList();\n-    apply.addAll(base.currentSnapshot().deleteManifests());\n     Iterables.addAll(apply, newManifestsWithMetadata);\n     apply.addAll(keptManifests);\n+    apply.addAll(base.currentSnapshot().deleteManifests());\n \n     return apply;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433760536", "bodyText": "I am not sure I understand the comment here or why dataManifests is used instead of allManifests", "author": "rymurr", "createdAt": "2020-06-02T09:58:03Z", "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "diffHunk": "@@ -136,7 +136,7 @@ protected long targetSplitSize(TableOperations ops) {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.manifests(),\n+              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNTExOQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434005119", "bodyText": "Shouldn't this table return all manifests?", "author": "aokolnychyi", "createdAt": "2020-06-02T16:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNTU4MA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434005580", "bodyText": "This else block is taken when manifests aren't kept in a file and are embedded in table metadata. That's not allowed in v2, so delete manifests and this code path will not happen at the same time.\nWe could be more explicit and use allManifests, so that this fails if a delete manifest is found. That's probably easier to understand and safer.", "author": "rdblue", "createdAt": "2020-06-02T16:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0NjU5NQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434046595", "bodyText": "Updated to use allManifests.", "author": "rdblue", "createdAt": "2020-06-02T17:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "e565075882ff3691bf6dc6ba315094c046ed7bda", "chunk": "diff --git a/core/src/main/java/org/apache/iceberg/AllManifestsTable.java b/core/src/main/java/org/apache/iceberg/AllManifestsTable.java\nindex ed0a98aa5..e337ebd25 100644\n--- a/core/src/main/java/org/apache/iceberg/AllManifestsTable.java\n+++ b/core/src/main/java/org/apache/iceberg/AllManifestsTable.java\n\n@@ -136,7 +136,7 @@ public class AllManifestsTable extends BaseMetadataTable {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests\n+              snap.allManifests(),\n               manifest -> ManifestsTable.manifestFileToRow(table().spec(), manifest));\n         }\n       }));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4Nzc0MQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433987741", "bodyText": "This seem like a breaking change to the public API. Technically, the old description already assumed a list of all manifests. Do we think it is better to change it now to avoid confusion and misuse?", "author": "aokolnychyi", "createdAt": "2020-06-02T15:55:09Z", "path": "api/src/main/java/org/apache/iceberg/Snapshot.java", "diffHunk": "@@ -64,13 +64,25 @@\n   long timestampMillis();\n \n   /**\n-   * Return the location of all manifests in this snapshot.\n-   * <p>\n-   * The current table is made of the union of the data files in these manifests.\n+   * Return all {@link ManifestFile} instances for either data or delete manifests in this snapshot.\n+   *\n+   * @return a list of ManifestFile\n+   */\n+  List<ManifestFile> allManifests();", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNzUyNQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434007525", "bodyText": "The question is where we want to make the breaking changes. The format can't be read correctly without support for deletes, so to support v2 we will be making some breaking changes. If we do it with API changes then clients will need to update.\nIf we just return manifest files for deletes through the old manifests method, then older clients will appear to work until they encounter a delete manifest.", "author": "rdblue", "createdAt": "2020-06-02T16:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4Nzc0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNjY3MQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434006671", "bodyText": "The list of manifests can contain 1-2k entries, will iterating through that list twice here have an impact on performance?", "author": "aokolnychyi", "createdAt": "2020-06-02T16:19:00Z", "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {\n+    if (allManifests == null) {\n       // if manifests isn't set, then the snapshotFile is set and should be read to get the list\n-      this.manifests = ManifestLists.read(manifestList);\n+      this.allManifests = ManifestLists.read(manifestList);\n+    }\n+\n+    if (dataManifests == null) {\n+      this.dataManifests = ImmutableList.copyOf(Iterables.filter(allManifests,", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNzk4Nw==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434007987", "bodyText": "No, this would be pretty quick.", "author": "rdblue", "createdAt": "2020-06-02T16:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNjY3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434008506", "bodyText": "Do we have to reason about thread safety like we do in PartitionSpec, for example?", "author": "aokolnychyi", "createdAt": "2020-06-02T16:21:48Z", "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {", "originalCommit": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MTEyMA==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434051120", "bodyText": "No. The main problem in #219 was that the lazy value was set before it was completely initialized. Here, allManifests is set to a list that will not change.\nIn that PR, we also added double checking and a lock to prevent two threads from building the same value. We could do that here as well, but it doesn't affect correctness. There is just a race condition to produce the same sets of manifests.", "author": "rdblue", "createdAt": "2020-06-02T17:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMTQzNQ==", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434131435", "bodyText": "I think it would make sense to prevent the race condition later on. I'll submit a PR.", "author": "aokolnychyi", "createdAt": "2020-06-02T19:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e565075882ff3691bf6dc6ba315094c046ed7bda", "url": "https://github.com/apache/iceberg/commit/e565075882ff3691bf6dc6ba315094c046ed7bda", "message": "Update after reviews.", "committedDate": "2020-06-02T17:38:25Z", "type": "commit"}]}