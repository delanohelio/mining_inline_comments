{"pr_number": 1743, "pr_title": "Spark: Add stored procedure API", "pr_createdAt": "2020-11-09T17:33:12Z", "pr_url": "https://github.com/apache/iceberg/pull/1743", "timeline": [{"oid": "5d23e76c259f8d500347863e1b72938c794e03b4", "url": "https://github.com/apache/iceberg/commit/5d23e76c259f8d500347863e1b72938c794e03b4", "message": "Spark: Add stored procedure API", "committedDate": "2020-11-09T17:32:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5ODM3OA==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r519998378", "bodyText": "Presto uses method handles for stored procedures too.", "author": "aokolnychyi", "createdAt": "2020-11-09T17:41:27Z", "path": "spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.spark.sql.connector.catalog;\n+\n+import java.lang.invoke.MethodHandle;\n+import org.apache.spark.sql.types.StructType;\n+\n+public interface Procedure {\n+  ProcedureParameter[] parameters();\n+  StructType outputType();\n+  MethodHandle methodHandle();", "originalCommit": "5d23e76c259f8d500347863e1b72938c794e03b4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "588a116401751f3d59ed46aae74a38aa54947367", "chunk": "diff --git a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\nindex e5f6bec51..c55d661a9 100644\n--- a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n+++ b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n\n@@ -19,11 +19,11 @@\n \n package org.apache.spark.sql.connector.catalog;\n \n-import java.lang.invoke.MethodHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n import org.apache.spark.sql.types.StructType;\n \n public interface Procedure {\n   ProcedureParameter[] parameters();\n   StructType outputType();\n-  MethodHandle methodHandle();\n+  InternalRow[] call(InternalRow input);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMTg2OA==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r520131868", "bodyText": "Does this need to be a struct?", "author": "rdblue", "createdAt": "2020-11-09T21:29:11Z", "path": "spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.spark.sql.connector.catalog;\n+\n+import java.lang.invoke.MethodHandle;\n+import org.apache.spark.sql.types.StructType;\n+\n+public interface Procedure {\n+  ProcedureParameter[] parameters();\n+  StructType outputType();", "originalCommit": "5d23e76c259f8d500347863e1b72938c794e03b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1MzU5NQ==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r520953595", "bodyText": "Procedures are supposed to return Spark rows that will be reported as output. So it is the type of those rows.", "author": "aokolnychyi", "createdAt": "2020-11-11T00:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMTg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "588a116401751f3d59ed46aae74a38aa54947367", "chunk": "diff --git a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\nindex e5f6bec51..c55d661a9 100644\n--- a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n+++ b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n\n@@ -19,11 +19,11 @@\n \n package org.apache.spark.sql.connector.catalog;\n \n-import java.lang.invoke.MethodHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n import org.apache.spark.sql.types.StructType;\n \n public interface Procedure {\n   ProcedureParameter[] parameters();\n   StructType outputType();\n-  MethodHandle methodHandle();\n+  InternalRow[] call(InternalRow input);\n }\n"}}, {"oid": "588a116401751f3d59ed46aae74a38aa54947367", "url": "https://github.com/apache/iceberg/commit/588a116401751f3d59ed46aae74a38aa54947367", "message": "Get rid of MethodHandle & minor fixes", "committedDate": "2020-11-11T00:02:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2ODI1Nw==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r520968257", "bodyText": "I think for all of the connector interfaces, we should add clear Javadoc.", "author": "rdblue", "createdAt": "2020-11-11T00:49:19Z", "path": "spark3/src/main/java/org/apache/spark/sql/connector/catalog/ProcedureParameter.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.spark.sql.connector.catalog;\n+\n+import org.apache.spark.sql.types.DataType;\n+\n+public interface ProcedureParameter {", "originalCommit": "588a116401751f3d59ed46aae74a38aa54947367", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ4MTE1Ng==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r521481156", "bodyText": "I'll add Javadoc in a follow-up PR. I need to document other places like IcebergSparkSessionExtensions. I want to have at least one procedure to be merged using these APIs.", "author": "aokolnychyi", "createdAt": "2020-11-11T16:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2ODI1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2OTg3NQ==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r520969875", "bodyText": "One more thing: we should also add a describe method so that we can show these correctly in plans.", "author": "rdblue", "createdAt": "2020-11-11T00:53:11Z", "path": "spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.spark.sql.connector.catalog;\n+\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.types.StructType;\n+\n+public interface Procedure {", "originalCommit": "588a116401751f3d59ed46aae74a38aa54947367", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ3OTc5Mw==", "url": "https://github.com/apache/iceberg/pull/1743#discussion_r521479793", "bodyText": "Done.", "author": "aokolnychyi", "createdAt": "2020-11-11T16:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2OTg3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6ade274936b6fb810d3999a8c95efb83cba6520", "chunk": "diff --git a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\nindex c55d661a9..0c254f7b7 100644\n--- a/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n+++ b/spark3/src/main/java/org/apache/spark/sql/connector/catalog/Procedure.java\n\n@@ -24,6 +24,12 @@ import org.apache.spark.sql.types.StructType;\n \n public interface Procedure {\n   ProcedureParameter[] parameters();\n+\n   StructType outputType();\n+\n   InternalRow[] call(InternalRow input);\n+\n+  default String description() {\n+    return this.getClass().toString();\n+  }\n }\n"}}, {"oid": "b6ade274936b6fb810d3999a8c95efb83cba6520", "url": "https://github.com/apache/iceberg/commit/b6ade274936b6fb810d3999a8c95efb83cba6520", "message": "Lazy val & description", "committedDate": "2020-11-11T16:25:16Z", "type": "commit"}]}