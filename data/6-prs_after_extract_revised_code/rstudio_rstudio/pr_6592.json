{"pr_number": 6592, "pr_title": "Implement custom fonts for RStudio Server", "pr_createdAt": "2020-04-04T03:34:04Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6592", "timeline": [{"oid": "e83eb0b91225a4ee013e1722d3f3b5a4fad0d9a1", "url": "https://github.com/rstudio/rstudio/commit/e83eb0b91225a4ee013e1722d3f3b5a4fad0d9a1", "message": "implement scanning for installed fonts and CSS gen", "committedDate": "2020-04-02T23:56:26Z", "type": "commit"}, {"oid": "d47e46ab8db52736d3698cde674c92e5c9eb61f7", "url": "https://github.com/rstudio/rstudio/commit/d47e46ab8db52736d3698cde674c92e5c9eb61f7", "message": "get installed fonts via RPC", "committedDate": "2020-04-03T00:49:54Z", "type": "commit"}, {"oid": "2048ae94ea20bfc8f1f1611528bff709e640a399", "url": "https://github.com/rstudio/rstudio/commit/2048ae94ea20bfc8f1f1611528bff709e640a399", "message": "add pref for server font", "committedDate": "2020-04-03T18:59:56Z", "type": "commit"}, {"oid": "9e2feda0c2ec881be03550adaad43bfcedd7b556", "url": "https://github.com/rstudio/rstudio/commit/9e2feda0c2ec881be03550adaad43bfcedd7b556", "message": "implement font preview in prefs pane", "committedDate": "2020-04-03T19:00:21Z", "type": "commit"}, {"oid": "48fb19ae1441d19dc7b190957c43dfcf9756aa8e", "url": "https://github.com/rstudio/rstudio/commit/48fb19ae1441d19dc7b190957c43dfcf9756aa8e", "message": "add font loading element to document root", "committedDate": "2020-04-03T20:04:06Z", "type": "commit"}, {"oid": "e931c6e4d7eaa55b834decfd37d820a337e2550a", "url": "https://github.com/rstudio/rstudio/commit/e931c6e4d7eaa55b834decfd37d820a337e2550a", "message": "load auxiliary styles in font CSS", "committedDate": "2020-04-03T22:36:13Z", "type": "commit"}, {"oid": "cadae8ad97fa39fc4ea0ab7d85ed7e3f9cccacd8", "url": "https://github.com/rstudio/rstudio/commit/cadae8ad97fa39fc4ea0ab7d85ed7e3f9cccacd8", "message": "allow for fonts defined by the browser", "committedDate": "2020-04-03T23:49:35Z", "type": "commit"}, {"oid": "397c74340081357f381504e5a42e9ba441ad24d6", "url": "https://github.com/rstudio/rstudio/commit/397c74340081357f381504e5a42e9ba441ad24d6", "message": "add some more choices for browser fonts", "committedDate": "2020-04-03T23:57:31Z", "type": "commit"}, {"oid": "81255eab3b0244e9bc4a68e241f859176dbbcbaf", "url": "https://github.com/rstudio/rstudio/commit/81255eab3b0244e9bc4a68e241f859176dbbcbaf", "message": "set web font in initial preview", "committedDate": "2020-04-04T00:04:41Z", "type": "commit"}, {"oid": "b41647c2e847271a1d3d866c6deffb7b79a89599", "url": "https://github.com/rstudio/rstudio/commit/b41647c2e847271a1d3d866c6deffb7b79a89599", "message": "install a README", "committedDate": "2020-04-04T02:37:21Z", "type": "commit"}, {"oid": "a4916c8d0438e41c7ed0457689eee88b6295ece0", "url": "https://github.com/rstudio/rstudio/commit/a4916c8d0438e41c7ed0457689eee88b6295ece0", "message": "allow fallback to previous behavior", "committedDate": "2020-04-04T03:04:17Z", "type": "commit"}, {"oid": "30015d99ca812c698d1cf9c4a045c9da56dff22f", "url": "https://github.com/rstudio/rstudio/commit/30015d99ca812c698d1cf9c4a045c9da56dff22f", "message": "clean up comments", "committedDate": "2020-04-04T03:18:25Z", "type": "commit"}, {"oid": "908763be85065ed01a28c9de9b0b17e235422ab2", "url": "https://github.com/rstudio/rstudio/commit/908763be85065ed01a28c9de9b0b17e235422ab2", "message": "add OS-specific fallback fonts", "committedDate": "2020-04-06T16:54:45Z", "type": "commit"}, {"oid": "78f7ad07c72be4eb64610ff94300d76ec9be6768", "url": "https://github.com/rstudio/rstudio/commit/78f7ad07c72be4eb64610ff94300d76ec9be6768", "message": "update NEWS", "committedDate": "2020-04-06T17:30:01Z", "type": "commit"}, {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e", "url": "https://github.com/rstudio/rstudio/commit/f30c294e4e083e2ced06934272e84c107fd8db5e", "message": "Merge remote-tracking branch 'origin/master' into feature/server-web-fonts", "committedDate": "2020-04-06T18:31:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzMxNg==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404397316", "bodyText": "nit, update copyright year in header", "author": "gtritchie", "createdAt": "2020-04-06T21:24:00Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -28,6 +28,7 @@\n ", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5ODI3NA==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404398274", "bodyText": "Might as well move this down to line 89 where it is first used (and only used inside that block as far as I can see).", "author": "gtritchie", "createdAt": "2020-04-06T21:25:54Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -74,6 +78,33 @@ private void applyTheme(Document document, final AceTheme theme)\n       currentStyleEl.setRel(\"stylesheet\");\n       currentStyleEl.setId(linkId_);\n       currentStyleEl.setHref(themeUrl.toString());\n+      \n+      // In server mode, augment the theme with a font if we have one\n+      LinkElement fontEl = null;", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66edabe481b12e6a61987eb40b47343e79726adc", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\nindex 34ba2e0701..86dac137ed 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\n\n@@ -76,25 +78,25 @@ public class AceThemes\n       LinkElement currentStyleEl = document.createLinkElement();\n       currentStyleEl.setType(\"text/css\");\n       currentStyleEl.setRel(\"stylesheet\");\n-      currentStyleEl.setId(linkId_);\n+      currentStyleEl.setId(linkId);\n       currentStyleEl.setHref(themeUrl.toString());\n       \n       // In server mode, augment the theme with a font if we have one\n-      LinkElement fontEl = null;\n       if (!Desktop.isDesktop() && prefs_.get().serverEditorFontEnabled().getValue())\n       {\n          String font = prefs_.get().serverEditorFont().getValue();\n          if (!StringUtil.isNullOrEmpty(font))\n          {\n-            fontEl = document.createLinkElement();\n+            final String fontId = \"rstudio-fontelement\";\n+            LinkElement fontEl = document.createLinkElement();\n             fontEl.setType(\"text/css\");\n             fontEl.setRel(\"stylesheet\");\n-            fontEl.setId(fontId_);\n+            fontEl.setId(fontId);\n             fontEl.setHref(\n                   GWT.getHostPageBaseURL() + \n                   \"fonts/css/\" + \n                   font + \".css\");\n-            Element oldFontEl = document.getElementById(fontId_);\n+            Element oldFontEl = document.getElementById(fontId);\n             if (null != oldFontEl)\n             {\n               document.getBody().replaceChild(fontEl, oldFontEl);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5OTM4OQ==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404399389", "bodyText": "fontId_ (and, actually, linkId_) could be local variables inside applyTheme().", "author": "gtritchie", "createdAt": "2020-04-06T21:28:08Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -249,6 +280,8 @@ public void onError(ServerError error)\n    private ThemeServerOperations themeServerOperations_;\n    private final EventBus events_;\n    private final Provider<UserState> state_;\n+   private final Provider<UserPrefs> prefs_;\n    private final String linkId_ = \"rstudio-acethemes-linkelement\";\n+   private final String fontId_ = \"rstudio-fontelement\";", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66edabe481b12e6a61987eb40b47343e79726adc", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\nindex 34ba2e0701..86dac137ed 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java\n\n@@ -281,7 +283,5 @@ public class AceThemes\n    private final EventBus events_;\n    private final Provider<UserState> state_;\n    private final Provider<UserPrefs> prefs_;\n-   private final String linkId_ = \"rstudio-acethemes-linkelement\";\n-   private final String fontId_ = \"rstudio-fontelement\";\n    private HashMap<String, AceTheme> themes_;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMDA4Ng==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404400086", "bodyText": "Don't think this is used.", "author": "gtritchie", "createdAt": "2020-04-06T21:29:28Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java", "diffHunk": "@@ -40,13 +43,19 @@\n import org.rstudio.studio.client.common.FileDialogs;\n import org.rstudio.studio.client.common.GlobalDisplay;\n import org.rstudio.studio.client.common.dependencies.DependencyManager;\n+import org.rstudio.studio.client.server.ServerError;\n+import org.rstudio.studio.client.server.ServerRequestCallback;\n import org.rstudio.studio.client.workbench.WorkbenchContext;\n import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;\n import org.rstudio.studio.client.workbench.prefs.model.UserState;\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;\n+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.model.ThemeServerOperations;\n \n+import java.util.ArrayList;", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66edabe481b12e6a61987eb40b47343e79726adc", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java b/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\nindex 0c459225f9..0a13a2f6bd 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\n\n@@ -52,7 +52,6 @@ import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceT\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.model.ThemeServerOperations;\n \n-import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.Set;\n import java.util.TreeSet;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMTUwNg==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404401506", "bodyText": "Can leave out String  in new, i.e. new TreeSet<>();", "author": "gtritchie", "createdAt": "2020-04-06T21:32:30Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java", "diffHunk": "@@ -617,16 +672,77 @@ public boolean execute()\n                return true;\n          \n             String[] fontList = fonts.split(\"\\\\n\");\n-            String value = fontFace_.getValue();\n-            value = value.replaceAll(\"\\\\\\\"\", \"\");\n-            fontFace_.setLabel(\"Editor font:\");\n-            fontFace_.setChoices(fontList, fontList);\n-            fontFace_.setValue(value);\n+            populateFontList(fontList);\n             return false;\n          }\n          \n       }, 100);\n    }\n+   \n+   private void getInstalledFontList()\n+   {\n+      // Search for installed fixed-width fonts on this web browser.\n+      final Set<String> browserFonts = new TreeSet<String>();", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66edabe481b12e6a61987eb40b47343e79726adc", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java b/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\nindex 0c459225f9..0a13a2f6bd 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java\n\n@@ -682,7 +681,7 @@ public class AppearancePreferencesPane extends PreferencesPane\n    private void getInstalledFontList()\n    {\n       // Search for installed fixed-width fonts on this web browser.\n-      final Set<String> browserFonts = new TreeSet<String>();\n+      final Set<String> browserFonts = new TreeSet<>();\n       JsArrayString candidates = userPrefs_.browserFixedWidthFonts().getGlobalValue();\n       for (String candidate: JsUtil.asIterable(candidates))\n       {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMjI0OA==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404402248", "bodyText": "nit, update copyright in header", "author": "gtritchie", "createdAt": "2020-04-06T21:33:43Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java", "diffHunk": "@@ -26,6 +26,7 @@\n import org.rstudio.core.client.theme.ThemeFonts;", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwNDA4MA==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404404080", "bodyText": "nit, copyright year in header", "author": "gtritchie", "createdAt": "2020-04-06T21:37:36Z", "path": "src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java", "diffHunk": "@@ -6154,6 +6154,12 @@ public void pandocListExtensions(String format, ServerRequestCallback<String> ca\n       sendRequest(RPC_SCOPE, PANDOC_LIST_EXTENSIONS, format, callback);", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwNDQyMQ==", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404404421", "bodyText": "nit, copyright year in header", "author": "gtritchie", "createdAt": "2020-04-06T21:38:21Z", "path": "src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java", "diffHunk": "@@ -19,6 +19,7 @@\n import org.rstudio.core.client.CodeNavigationTarget;", "originalCommit": "f30c294e4e083e2ced06934272e84c107fd8db5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "66edabe481b12e6a61987eb40b47343e79726adc", "url": "https://github.com/rstudio/rstudio/commit/66edabe481b12e6a61987eb40b47343e79726adc", "message": "code review feedback", "committedDate": "2020-04-06T22:30:28Z", "type": "commit"}]}