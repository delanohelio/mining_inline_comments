{"pr_number": 7823, "pr_title": "Retry open file operations when attempting to save source files / source database files", "pr_createdAt": "2020-09-17T20:08:37Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7823", "timeline": [{"oid": "371297c527c9d73118e8129fd8b1b169960f460a", "url": "https://github.com/rstudio/rstudio/commit/371297c527c9d73118e8129fd8b1b169960f460a", "message": "Retry open file operations when attempting to save source files / source database files.\n\nWhen dropbox or other file syncing solutions are present and attempting to sync source files that are active in the editor, save operations on said files can fail due to the inability to open the file (as it is being read in exclusive mode by the backup software).\n\nThis change makes it so that now we retry these operations up to a certain amount of seconds, specified by a new user preference save_retry_timeout.", "committedDate": "2020-09-17T20:01:26Z", "type": "commit"}, {"oid": "d967772c85371c727c4e919b953d951e51b6b1c5", "url": "https://github.com/rstudio/rstudio/commit/d967772c85371c727c4e919b953d951e51b6b1c5", "message": "Fix while loop condition", "committedDate": "2020-09-17T21:15:59Z", "type": "commit"}, {"oid": "ececfe5b911202dda97384babc1205e46ca9ab7f", "url": "https://github.com/rstudio/rstudio/commit/ececfe5b911202dda97384babc1205e46ca9ab7f", "message": "WIP: Only attempt to retry write operation if it was a user specified action. Do not retry writes for autosaves / lints. If not retrying the operation (because of autosave semantics), supress errors indicating that another process is using the file (as it is a transient issue).", "committedDate": "2020-09-18T22:13:59Z", "type": "commit"}, {"oid": "3972327cf580f16d402a6ee8d860c834d02e327e", "url": "https://github.com/rstudio/rstudio/commit/3972327cf580f16d402a6ee8d860c834d02e327e", "message": "Merge branch 'bugfix/google-drive-dropbox-save-enhancements' of https://github.com/rstudio/rstudio into bugfix/google-drive-dropbox-save-enhancements", "committedDate": "2020-09-18T22:15:09Z", "type": "commit"}, {"oid": "f9d09b29878d67343a47c125acd5b7dc0bb6b411", "url": "https://github.com/rstudio/rstudio/commit/f9d09b29878d67343a47c125acd5b7dc0bb6b411", "message": "Fix issue where lastKnownFileTime would be dropped if the file was successfully saved by the source database file properties were not. This would cause annoying prompts asking the user to reload the file as it hasd changed on disk, even though it really had not.", "committedDate": "2020-09-21T20:52:40Z", "type": "commit"}, {"oid": "ba77c20dff937e2d7705b71d9b3b99d68ddcee41", "url": "https://github.com/rstudio/rstudio/commit/ba77c20dff937e2d7705b71d9b3b99d68ddcee41", "message": "Hide autosave error dialog (when doing autosave backups) if the error is a transient exclusive access issue", "committedDate": "2020-09-21T21:29:06Z", "type": "commit"}, {"oid": "11ce679c326f04d8907c70f97418ae0830e7f5f8", "url": "https://github.com/rstudio/rstudio/commit/11ce679c326f04d8907c70f97418ae0830e7f5f8", "message": "Restart autosave if it fails silently", "committedDate": "2020-09-21T21:56:12Z", "type": "commit"}, {"oid": "6596af405a49117ba68f1ca9dd1a9a46db879961", "url": "https://github.com/rstudio/rstudio/commit/6596af405a49117ba68f1ca9dd1a9a46db879961", "message": "Update src/cpp/core/include/core/FileSerializer.hpp\n\nCo-authored-by: Jonathan <jonathan@rstudio.com>", "committedDate": "2020-09-25T20:35:42Z", "type": "commit"}, {"oid": "a2af7f3d7d001f8c609aed0cbbf736c46943e7fb", "url": "https://github.com/rstudio/rstudio/commit/a2af7f3d7d001f8c609aed0cbbf736c46943e7fb", "message": "Code review feedback - log error and count number of failed open attempts", "committedDate": "2020-09-28T14:56:25Z", "type": "commit"}, {"oid": "31a9668d6756e62638a9c884058b11d39c3a83bc", "url": "https://github.com/rstudio/rstudio/commit/31a9668d6756e62638a9c884058b11d39c3a83bc", "message": "Merge branch 'bugfix/google-drive-dropbox-save-enhancements' of https://github.com/rstudio/rstudio into bugfix/google-drive-dropbox-save-enhancements", "committedDate": "2020-09-28T14:57:16Z", "type": "commit"}, {"oid": "fbd569814b3417b681771452adeaef77d0e38515", "url": "https://github.com/rstudio/rstudio/commit/fbd569814b3417b681771452adeaef77d0e38515", "message": "Code review feedback - prevent manual saves from queueing up while in-flight", "committedDate": "2020-09-28T14:58:26Z", "type": "commit"}, {"oid": "011eb11501950dd1c245656585880cef43b764e3", "url": "https://github.com/rstudio/rstudio/commit/011eb11501950dd1c245656585880cef43b764e3", "message": "Update TextEditingTarget.java\n\nFix whitespace issues", "committedDate": "2020-09-28T15:00:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MDg4OA==", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496070888", "bodyText": "Checking this based on the message rather than an error property or code seems fragile. Would it be feasible for us to send a proper error object (e.g. with an error code) that we could check here or something similar?", "author": "kevinushey", "createdAt": "2020-09-28T16:13:05Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -376,8 +391,17 @@ public void onError(final String message)\n             @Override\n             public void execute()\n             {\n-               globalDisplay_.showErrorMessage(\"Error Saving File\",\n-                                               message);\n+               // do not show the error if it is a transient autosave related issue - this can occur fairly frequently\n+               // when attempting to save files that are being backed up by external software\n+               if (message.contains(\"The process cannot access the file because it is being used by another process\") && suppressFileLockError_)", "originalCommit": "011eb11501950dd1c245656585880cef43b764e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzkzNA==", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496077934", "bodyText": "I decided against that because we are using the ProgressIndicator interface here which is tied to error messages and is a very fundamental interface in the code. I didn't think extending this interface was worth it to propagate this one error code here as this would affect a sizable portion of the code base.", "author": "kfeinauer", "createdAt": "2020-09-28T16:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MDg4OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MTU5NQ==", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496071595", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  new SaveProgressIndicator(path, type, false,null).onCompleted();\n          \n          \n            \n                  new SaveProgressIndicator(path, type, false, null).onCompleted();", "author": "kevinushey", "createdAt": "2020-09-28T16:14:12Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -7708,7 +7760,7 @@ public void setPath(FileSystemItem path)\n       TextFileType type = fileTypeRegistry_.getTextTypeForFile(path);\n \n       // Simulate a completed save of the new path\n-      new SaveProgressIndicator(path, type, null).onCompleted();\n+      new SaveProgressIndicator(path, type, false,null).onCompleted();", "originalCommit": "011eb11501950dd1c245656585880cef43b764e3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f3b7745bbba2aeb2e723f261d88a2515c386ad3e", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java\nindex a3690ede3f..3a1d41deeb 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java\n\n@@ -7760,7 +7760,7 @@ public class TextEditingTarget implements\n       TextFileType type = fileTypeRegistry_.getTextTypeForFile(path);\n \n       // Simulate a completed save of the new path\n-      new SaveProgressIndicator(path, type, false,null).onCompleted();\n+      new SaveProgressIndicator(path, type, false, null).onCompleted();\n    }\n \n    private void setRMarkdownBehaviorEnabled(boolean enabled)\n"}}, {"oid": "f3b7745bbba2aeb2e723f261d88a2515c386ad3e", "url": "https://github.com/rstudio/rstudio/commit/f3b7745bbba2aeb2e723f261d88a2515c386ad3e", "message": "Update src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java\n\nCo-authored-by: Kevin Ushey <kevin@rstudio.com>", "committedDate": "2020-09-28T16:21:46Z", "type": "commit"}, {"oid": "3257c2cbb242e4f2ca6f72e69d2fbdf9038e5577", "url": "https://github.com/rstudio/rstudio/commit/3257c2cbb242e4f2ca6f72e69d2fbdf9038e5577", "message": "Update NEWS", "committedDate": "2020-09-29T18:33:25Z", "type": "commit"}, {"oid": "dc9763906aa55411ef7b414ddbf51261ea06114c", "url": "https://github.com/rstudio/rstudio/commit/dc9763906aa55411ef7b414ddbf51261ea06114c", "message": "Merge branch 'master' into bugfix/google-drive-dropbox-save-enhancements", "committedDate": "2020-09-29T18:34:31Z", "type": "commit"}]}