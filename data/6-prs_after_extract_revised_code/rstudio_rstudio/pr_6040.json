{"pr_number": 6040, "pr_title": "Add Package Source to Find In Files include options", "pr_createdAt": "2020-01-16T22:16:49Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6040", "timeline": [{"oid": "7803a4ddae43b2883f67c182e49fbe561a9bf002", "url": "https://github.com/rstudio/rstudio/commit/7803a4ddae43b2883f67c182e49fbe561a9bf002", "message": "update the UI so a user cannot input file patterns when using git exclusions\nas git grep doesn't have an equivalent to grep's --include", "committedDate": "2020-01-08T22:59:15Z", "type": "commit"}, {"oid": "2d7059c81c36c388ef67ecffd4533b63d13d5581", "url": "https://github.com/rstudio/rstudio/commit/2d7059c81c36c388ef67ecffd4533b63d13d5581", "message": "add include option for R packages (R/ src/ tests/)", "committedDate": "2020-01-09T02:06:09Z", "type": "commit"}, {"oid": "23c69b18ec6a9104853731e0c4b50c1b18c9161f", "url": "https://github.com/rstudio/rstudio/commit/23c69b18ec6a9104853731e0c4b50c1b18c9161f", "message": "fix spacing and add error checking for when a user tries to search a package while not in a\npackage session", "committedDate": "2020-01-09T20:17:09Z", "type": "commit"}, {"oid": "9ee1ca83af5561bbc2ebd1dcf479d9b79adb4bd3", "url": "https://github.com/rstudio/rstudio/commit/9ee1ca83af5561bbc2ebd1dcf479d9b79adb4bd3", "message": "update state name", "committedDate": "2020-01-10T01:49:03Z", "type": "commit"}, {"oid": "cac983631da2f51d35b5cfe5568c6e4cb5f1b8c4", "url": "https://github.com/rstudio/rstudio/commit/cac983631da2f51d35b5cfe5568c6e4cb5f1b8c4", "message": "update the UI so a user cannot input file patterns when using git exclusions\nas git grep doesn't have an equivalent to grep's --include", "committedDate": "2020-01-14T00:02:30Z", "type": "commit"}, {"oid": "b446c85fe3bc8c31ddf7611f5343bafb219960af", "url": "https://github.com/rstudio/rstudio/commit/b446c85fe3bc8c31ddf7611f5343bafb219960af", "message": "rename functions using retrieve because we are not fetching\nupdate include/exclude file patterns to use enums for readability\ndisable the Git option when git is not installed", "committedDate": "2020-01-14T00:03:50Z", "type": "commit"}, {"oid": "b02744c1a5292e0403f0a32965f4dbde8535c629", "url": "https://github.com/rstudio/rstudio/commit/b02744c1a5292e0403f0a32965f4dbde8535c629", "message": "fix issue where in rare cases ReplaceOperationEndedEvent wasn't getting called and the progress bar\nwas visible after the replace had completed\n- removed code unnsuccesfully trying to fix this", "committedDate": "2020-01-14T00:03:50Z", "type": "commit"}, {"oid": "8988227b65a5ac2f92cadbaaccdfd84887c02a29", "url": "https://github.com/rstudio/rstudio/commit/8988227b65a5ac2f92cadbaaccdfd84887c02a29", "message": "disable Standard Git Exclusions selection when git is not installed or a git repo isn't selected\nadd value change handler to Find In Files directory chooser, on changes check if the new directory\nis a git repository and if git is installed\nadd new Files Server operation to check if a directory is a git directory", "committedDate": "2020-01-14T00:03:50Z", "type": "commit"}, {"oid": "4da19f30bc83bba7f492781e0c9aefafb450c028", "url": "https://github.com/rstudio/rstudio/commit/4da19f30bc83bba7f492781e0c9aefafb450c028", "message": "add include option for user to filter by package source code\nadd new RPC to check if a directory is a package, only display the package source option for package\ndirectories", "committedDate": "2020-01-14T00:03:50Z", "type": "commit"}, {"oid": "1c158214d1b7cb337026bed8baeedf2ec2d92da4", "url": "https://github.com/rstudio/rstudio/commit/1c158214d1b7cb337026bed8baeedf2ec2d92da4", "message": "only allow includes that don't require the grep --include parameter when filtering with git", "committedDate": "2020-01-14T21:32:54Z", "type": "commit"}, {"oid": "ceb218b2a0b36ad4fd47aa3863e6226b2d166f7a", "url": "https://github.com/rstudio/rstudio/commit/ceb218b2a0b36ad4fd47aa3863e6226b2d166f7a", "message": "allow user to filter by package source and follow standard git exclusions", "committedDate": "2020-01-15T00:38:38Z", "type": "commit"}, {"oid": "0d277db4376dd4c482af64f88967829db017b46b", "url": "https://github.com/rstudio/rstudio/commit/0d277db4376dd4c482af64f88967829db017b46b", "message": "Merge branch 'feature/replace-git-ignore' of https://github.com/rstudio/rstudio into feature/find-in-package-src", "committedDate": "2020-01-16T00:00:05Z", "type": "commit"}, {"oid": "852c6e6d5c7b731110d97e3345240b2a68efc2ae", "url": "https://github.com/rstudio/rstudio/commit/852c6e6d5c7b731110d97e3345240b2a68efc2ae", "message": "rename enums for readability\nfix issue where Git and Package states weren't preserved", "committedDate": "2020-01-16T00:51:42Z", "type": "commit"}, {"oid": "285a581ac72308a9a0ac541889b2a4d84324568d", "url": "https://github.com/rstudio/rstudio/commit/285a581ac72308a9a0ac541889b2a4d84324568d", "message": "Merge branch 'master' of https://github.com/rstudio/rstudio into feature/find-in-package-src", "committedDate": "2020-01-16T20:55:22Z", "type": "commit"}, {"oid": "26bf1c7db70f8685b96ab5675632b3dbd25a2448", "url": "https://github.com/rstudio/rstudio/commit/26bf1c7db70f8685b96ab5675632b3dbd25a2448", "message": "add include options to GrepOptions class", "committedDate": "2020-01-16T22:02:08Z", "type": "commit"}, {"oid": "e2054d70781b71d76ff46d659f70987b3c0c3c5b", "url": "https://github.com/rstudio/rstudio/commit/e2054d70781b71d76ff46d659f70987b3c0c3c5b", "message": "change warning to debug messages since they should be prevented by the frontend\nrefactor addDirectories function to avoid repeating code", "committedDate": "2020-01-17T22:22:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI3ODAyMw==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r370278023", "bodyText": "Here and elsewhere: this is verbose and somewhat difficult to read. How about adding something like DomUtils.setOptionDisabled(element, ordinal, disabled)?", "author": "jmcphers", "createdAt": "2020-01-23T18:17:41Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java", "diffHunk": "@@ -249,32 +265,58 @@ private void manageExcludeFilePattern()\n       if (!gitStatus_ ||\n           !session_.getSessionInfo().isVcsAvailable(VCSConstants.GIT_ID))\n       {\n-         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(1))\n+         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(\n+               Exclude.StandardGit.ordinal()))\n             .setAttribute(\"disabled\", \"disabled\");\n          if (listPresetExcludeFilePatterns_.getSelectedIndex() ==\n-             ExcludeFilePatterns.StandardGit.ordinal())\n-            listPresetExcludeFilePatterns_.setSelectedIndex(ExcludeFilePatterns.None.ordinal());\n+             Exclude.StandardGit.ordinal())\n+            listPresetExcludeFilePatterns_.setSelectedIndex(Exclude.None.ordinal());\n       }\n       else\n-         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(1))\n-            .removeAttribute(\"disabled\");\n-\n+         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(\n+            Exclude.StandardGit.ordinal())).removeAttribute(\"disabled\");\n \n       // disable custom filter text box when 'Custom Filter' is not selected\n       divExcludeCustomFilter_.getStyle().setDisplay(\n             listPresetExcludeFilePatterns_.getSelectedIndex() == \n-            ExcludeFilePatterns.CustomFilter.ordinal()\n+            Exclude.CustomFilter.ordinal()\n             ? Style.Display.BLOCK\n             : Style.Display.NONE);\n \n       // user cannot specify include patterns when using git grep\n       if (listPresetExcludeFilePatterns_.getSelectedIndex() != \n-          ExcludeFilePatterns.StandardGit.ordinal())\n-         listPresetFilePatterns_.setEnabled(true);\n+          Exclude.StandardGit.ordinal())\n+      {\n+         ((Element) listPresetFilePatterns_.getElement().getChild(\n+            Include.CommonRSourceFiles.ordinal())).removeAttribute(\"disabled\");\n+         ((Element) listPresetFilePatterns_.getElement().getChild(\n+            Include.RScripts.ordinal())).removeAttribute(\"disabled\");\n+         ((Element) listPresetFilePatterns_.getElement().getChild(\n+            Include.CustomFilter.ordinal())).removeAttribute(\"disabled\");\n+      }\n       else\n       {\n-         listPresetFilePatterns_.setEnabled(false);\n-         listPresetFilePatterns_.setSelectedIndex(IncludeFilePatterns.AllFiles.ordinal());\n+         // when using standard git exclusions we don't have the option to search recursively and\n+         // specify file types\n+         ((Element) listPresetFilePatterns_.getElement().getChild(", "originalCommit": "e2054d70781b71d76ff46d659f70987b3c0c3c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM4MDc3Ng==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r370380776", "bodyText": "done!", "author": "melissa-barca", "createdAt": "2020-01-23T22:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI3ODAyMw=="}], "type": "inlineReview", "revised_code": {"commit": "5f301b22a1a8d2cb1d7d761b244e82397ea2c410", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java b/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\nindex 4a97f89489..a77960ae0c 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\n\n@@ -265,16 +266,19 @@ public class FindInFilesDialog extends ModalDialog<FindInFilesDialog.State>\n       if (!gitStatus_ ||\n           !session_.getSessionInfo().isVcsAvailable(VCSConstants.GIT_ID))\n       {\n-         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(\n-               Exclude.StandardGit.ordinal()))\n-            .setAttribute(\"disabled\", \"disabled\");\n+         DomUtils.setOptionDisabled(\n+            listPresetExcludeFilePatterns_.getElement(),\n+            Exclude.StandardGit.ordinal(),\n+            true);\n          if (listPresetExcludeFilePatterns_.getSelectedIndex() ==\n              Exclude.StandardGit.ordinal())\n             listPresetExcludeFilePatterns_.setSelectedIndex(Exclude.None.ordinal());\n       }\n       else\n-         ((Element) listPresetExcludeFilePatterns_.getElement().getChild(\n-            Exclude.StandardGit.ordinal())).removeAttribute(\"disabled\");\n+         DomUtils.setOptionDisabled(\n+            listPresetExcludeFilePatterns_.getElement(),\n+            Exclude.StandardGit.ordinal(),\n+            false);\n \n       // disable custom filter text box when 'Custom Filter' is not selected\n       divExcludeCustomFilter_.getStyle().setDisplay(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4MTI4MQ==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r370281281", "bodyText": "This is also very verbose. I think all that's needed to simplify this is a method to select the index with the given value. I feel like we already have something like this (and if we don't it should be pretty easy to add!)", "author": "jmcphers", "createdAt": "2020-01-23T18:24:32Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java", "diffHunk": "@@ -374,28 +416,41 @@ public void setState(State dialogState)\n       checkboxRegex_.setValue(dialogState.isRegex());\n       dirChooser_.setText(dialogState.getPath());\n \n-      // indexes refer to corresponding enums, but left as ints for readability\n       String includeFilePatterns = StringUtil.join(\n             Arrays.asList(dialogState.getFilePatterns()), \", \");\n-      if (listPresetFilePatterns_.getValue(0) == includeFilePatterns)\n-         listPresetFilePatterns_.setSelectedIndex(0);\n-      else if (listPresetFilePatterns_.getValue(1) == includeFilePatterns)\n-         listPresetFilePatterns_.setSelectedIndex(1);\n-      else if (listPresetFilePatterns_.getValue(2) == includeFilePatterns)\n-         listPresetFilePatterns_.setSelectedIndex(2);\n+      if (includeFilePatterns == \n+          listPresetFilePatterns_.getValue(Include.AllFiles.ordinal()))", "originalCommit": "e2054d70781b71d76ff46d659f70987b3c0c3c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM3MzAyOA==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r370373028", "bodyText": "AFAIK there is no existing method to handle this. Where do you think would be the best place to add this function? listPresetFilePatterns_ is a gwt ListBox object - we currently have one object that inherits from it -- FormListBox that only has one method void setElementId(id) - would this be a good place?", "author": "melissa-barca", "createdAt": "2020-01-23T21:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4MTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MDI2Nw==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r371490267", "bodyText": "Yes, I think that'd be a good spot!", "author": "jmcphers", "createdAt": "2020-01-27T21:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4MTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNzE1MQ==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r371517151", "bodyText": "Alright, ready for review again \ud83d\udc4d", "author": "melissa-barca", "createdAt": "2020-01-27T22:24:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4MTI4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5f301b22a1a8d2cb1d7d761b244e82397ea2c410", "chunk": "diff --git a/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java b/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\nindex 4a97f89489..a77960ae0c 100644\n--- a/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\n+++ b/src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java\n\n@@ -418,39 +426,25 @@ public class FindInFilesDialog extends ModalDialog<FindInFilesDialog.State>\n \n       String includeFilePatterns = StringUtil.join(\n             Arrays.asList(dialogState.getFilePatterns()), \", \");\n-      if (includeFilePatterns == \n-          listPresetFilePatterns_.getValue(Include.AllFiles.ordinal()))\n-         listPresetFilePatterns_.setSelectedIndex(Include.AllFiles.ordinal());\n-      else if (includeFilePatterns ==\n-               listPresetFilePatterns_.getValue(Include.CommonRSourceFiles.ordinal()))\n-         listPresetFilePatterns_.setSelectedIndex(Include.CommonRSourceFiles.ordinal());\n-      else if (includeFilePatterns ==\n-               listPresetFilePatterns_.getValue(Include.RScripts.ordinal()))\n-         listPresetFilePatterns_.setSelectedIndex(Include.RScripts.ordinal());\n-      else if (includeFilePatterns ==\n-               listPresetFilePatterns_.getValue(Include.Package.ordinal()))\n-      {\n-         listPresetFilePatterns_.setSelectedIndex(Include.Package.ordinal());\n-         packageStatus_ = true;\n-      }\n+      int index = getIndexFromValue(listPresetFilePatterns_, includeFilePatterns);\n+      if (index >= 0)\n+         listPresetFilePatterns_.setSelectedIndex(index);\n       else\n          listPresetFilePatterns_.setSelectedIndex(Include.CustomFilter.ordinal());\n+      if (index == Include.Package.ordinal())\n+         packageStatus_ = true;\n       txtFilePattern_.setText(includeFilePatterns);\n       manageFilePattern();\n \n       String excludeFilePatterns = StringUtil.join(\n          Arrays.asList(dialogState.getExcludeFilePatterns()), \",\");\n-      if (excludeFilePatterns ==\n-          listPresetExcludeFilePatterns_.getValue(Exclude.None.ordinal()))\n-         listPresetExcludeFilePatterns_.setSelectedIndex(Exclude.None.ordinal());\n-      else if (excludeFilePatterns ==\n-               listPresetExcludeFilePatterns_.getValue(Exclude.StandardGit.ordinal()))\n-      {\n-         listPresetExcludeFilePatterns_.setSelectedIndex(Exclude.StandardGit.ordinal());\n-         gitStatus_ = true;\n-      }\n+      index = getIndexFromValue(listPresetExcludeFilePatterns_, excludeFilePatterns);\n+      if (index >= 0)\n+         listPresetExcludeFilePatterns_.setSelectedIndex(index);\n       else\n          listPresetExcludeFilePatterns_.setSelectedIndex(Exclude.CustomFilter.ordinal());\n+      if (index == Exclude.StandardGit.ordinal())\n+         gitStatus_ = true;\n       txtExcludeFilePattern_.setText(excludeFilePatterns);\n       manageExcludeFilePattern();\n    }\n"}}, {"oid": "5f301b22a1a8d2cb1d7d761b244e82397ea2c410", "url": "https://github.com/rstudio/rstudio/commit/5f301b22a1a8d2cb1d7d761b244e82397ea2c410", "message": "clean up warning message\nimplement and use dom utility to disable or an enable an option", "committedDate": "2020-01-23T22:07:25Z", "type": "commit"}, {"oid": "5a2d90e7930a464661cfe6ffdc7a1638dfd11245", "url": "https://github.com/rstudio/rstudio/commit/5a2d90e7930a464661cfe6ffdc7a1638dfd11245", "message": "add specifics to debug message", "committedDate": "2020-01-23T22:15:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MTkwOA==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r371491908", "bodyText": "Doxygen style params should be either documented (i.e. explain what each one is) or omitted.", "author": "jmcphers", "createdAt": "2020-01-27T21:27:54Z", "path": "src/gwt/src/org/rstudio/core/client/dom/DomUtils.java", "diffHunk": "@@ -1152,6 +1152,21 @@ public static void setPlaceholder(TextBox w, String placeholder)\n       setPlaceholder(w.getElement(), placeholder);\n    }\n \n+   /**\n+    * Set disabled attribute on an element's child\n+    * @param element\n+    * @param ordinal\n+    * @param disable", "originalCommit": "5a2d90e7930a464661cfe6ffdc7a1638dfd11245", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNzIzMg==", "url": "https://github.com/rstudio/rstudio/pull/6040#discussion_r371517232", "bodyText": "Updated", "author": "melissa-barca", "createdAt": "2020-01-27T22:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5MTkwOA=="}], "type": "inlineReview", "revised_code": {"commit": "bdcf2da42727e147f7535ab2ab55208d7ceaec81", "chunk": "diff --git a/src/gwt/src/org/rstudio/core/client/dom/DomUtils.java b/src/gwt/src/org/rstudio/core/client/dom/DomUtils.java\nindex 5e3bcbac5b..a8b3a13713 100644\n--- a/src/gwt/src/org/rstudio/core/client/dom/DomUtils.java\n+++ b/src/gwt/src/org/rstudio/core/client/dom/DomUtils.java\n\n@@ -1154,9 +1154,9 @@ public class DomUtils\n \n    /**\n     * Set disabled attribute on an element's child\n-    * @param element\n-    * @param ordinal\n-    * @param disable\n+    * @param element The parent element\n+    * @param ordinal The index representing the child to disable\n+    * @param disable Whether we are adding or removing the disable attribute\n     */\n    public static void setOptionDisabled(Element element, int ordinal, boolean disable)\n    {\n"}}, {"oid": "ce40ab9d46b2dfec6143eaf33610d18646b3b27e", "url": "https://github.com/rstudio/rstudio/commit/ce40ab9d46b2dfec6143eaf33610d18646b3b27e", "message": "move getIndexFromValue to FormListBox and switch find in files dialog to use FormListBox.\nWhen Package Source is selected and the user selects a non-package directory,\nswitch include option to All Files", "committedDate": "2020-01-27T22:16:50Z", "type": "commit"}, {"oid": "bdcf2da42727e147f7535ab2ab55208d7ceaec81", "url": "https://github.com/rstudio/rstudio/commit/bdcf2da42727e147f7535ab2ab55208d7ceaec81", "message": "comment the parameters in function", "committedDate": "2020-01-27T22:22:07Z", "type": "commit"}, {"oid": "3f0982867404b8f22f0fd19fe9cc8aaea7d3005d", "url": "https://github.com/rstudio/rstudio/commit/3f0982867404b8f22f0fd19fe9cc8aaea7d3005d", "message": "change TODO to normal comment", "committedDate": "2020-01-27T22:24:08Z", "type": "commit"}, {"oid": "1599f4506b6a863995b08eb870f6e1465c58854b", "url": "https://github.com/rstudio/rstudio/commit/1599f4506b6a863995b08eb870f6e1465c58854b", "message": "simplify comment", "committedDate": "2020-01-27T22:53:34Z", "type": "commit"}]}