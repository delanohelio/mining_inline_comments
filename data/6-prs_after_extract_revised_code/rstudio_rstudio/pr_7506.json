{"pr_number": 7506, "pr_title": "delegate focus requests to panmirror when visual mode active", "pr_createdAt": "2020-07-31T21:51:57Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7506", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzQ4Mw==", "url": "https://github.com/rstudio/rstudio/pull/7506#discussion_r463873483", "bodyText": "isVisualModeActivated() is a logical state (should it be active) whereas the actual load state (and presence of the panmirror_ member variable that you access in focus()) is different (i.e. it could be logically \"activated\" but still in the process of loading, so panmirror_ is null). I think you probably want to wrap this call in ensureVisualModeActive().", "author": "jjallaire", "createdAt": "2020-07-31T22:33:34Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -2456,7 +2471,14 @@ public void execute() {\n \n    public void focus()\n    {\n-      view_.editorContainer().focus();\n+      if (isVisualModeActivated())", "originalCommit": "66cec22c35f0eee23e53d908ae93d1975076d007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NDA0OQ==", "url": "https://github.com/rstudio/rstudio/pull/7506#discussion_r463874049", "bodyText": "Actually, I don't even know if that would be correct. Here is another effort I made to get focus working when a visual mode document is opened as part of navigation: \n  \n    \n      rstudio/src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java\n    \n    \n        Lines 628 to 640\n      in\n      66cec22\n    \n    \n    \n    \n\n        \n          \n           // when interactively adding a visual mode doc, make sure we set the focus \n        \n\n        \n          \n           // (special handling required b/c initialization of visual mode docs is \n        \n\n        \n          \n           // async so can miss the normal setting of focus) \n        \n\n        \n          \n           if (e.getMode() == Source.OPEN_INTERACTIVE &&  isActivated() && target_.isActiveDocument()) \n        \n\n        \n          \n           { \n        \n\n        \n          \n              if (panmirror_ != null)  \n        \n\n        \n          \n              { \n        \n\n        \n          \n                 panmirror_.focus(); \n        \n\n        \n          \n              } \n        \n\n        \n          \n              else if (isLoading_) \n        \n\n        \n          \n              { \n        \n\n        \n          \n                 onReadyHandlers_.add(() -> panmirror_.focus()); \n        \n\n        \n          \n              }", "author": "jjallaire", "createdAt": "2020-07-31T22:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NDExNg==", "url": "https://github.com/rstudio/rstudio/pull/7506#discussion_r463874116", "bodyText": "I think we should talk realtime about all of this on Monday. I'll send a schedule item.", "author": "jjallaire", "createdAt": "2020-07-31T22:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTk0MQ==", "url": "https://github.com/rstudio/rstudio/pull/7506#discussion_r463875941", "bodyText": "Would it make sense to first check isActivated() and then next ensureVisualModeActivated() so the command is properly registered if we are indeed still loading?", "author": "kevinushey", "createdAt": "2020-07-31T22:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzQ4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "07d321f3ba90dfc59c1201761c8c45023fd25719", "url": "https://github.com/rstudio/rstudio/commit/07d321f3ba90dfc59c1201761c8c45023fd25719", "message": "delegate focus requests to panmirror when visual mode active", "committedDate": "2020-08-03T17:04:10Z", "type": "commit"}, {"oid": "07d321f3ba90dfc59c1201761c8c45023fd25719", "url": "https://github.com/rstudio/rstudio/commit/07d321f3ba90dfc59c1201761c8c45023fd25719", "message": "delegate focus requests to panmirror when visual mode active", "committedDate": "2020-08-03T17:04:10Z", "type": "forcePushed"}, {"oid": "95d2aa8ec62b793db66b4a831dcc8041c1c9d8dc", "url": "https://github.com/rstudio/rstudio/commit/95d2aa8ec62b793db66b4a831dcc8041c1c9d8dc", "message": "add 'withActivatedVisualEditor()' helper for focus", "committedDate": "2020-08-03T17:25:04Z", "type": "commit"}, {"oid": "95d2aa8ec62b793db66b4a831dcc8041c1c9d8dc", "url": "https://github.com/rstudio/rstudio/commit/95d2aa8ec62b793db66b4a831dcc8041c1c9d8dc", "message": "add 'withActivatedVisualEditor()' helper for focus", "committedDate": "2020-08-03T17:25:04Z", "type": "forcePushed"}, {"oid": "f5816b3f3960106962b76b68f2ea3e201509a4ea", "url": "https://github.com/rstudio/rstudio/commit/f5816b3f3960106962b76b68f2ea3e201509a4ea", "message": "re-use existing helpers", "committedDate": "2020-08-03T17:30:03Z", "type": "commit"}]}