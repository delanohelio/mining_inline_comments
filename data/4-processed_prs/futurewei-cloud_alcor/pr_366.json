{"pr_number": 366, "pr_title": "[Port Manager] Support L2 and L3 Type Neighbors", "pr_createdAt": "2020-08-28T08:06:17Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/366", "timeline": [{"oid": "b591796240905b76603b8f21da3970e56fe6af7f", "url": "https://github.com/futurewei-cloud/alcor/commit/b591796240905b76603b8f21da3970e56fe6af7f", "message": "Update PM-DPM contract", "committedDate": "2020-08-31T08:01:51Z", "type": "forcePushed"}, {"oid": "57d058633948ed1c8c7ae987153e2142fbd3605c", "url": "https://github.com/futurewei-cloud/alcor/commit/57d058633948ed1c8c7ae987153e2142fbd3605c", "message": "Update PM-DPM contract", "committedDate": "2020-08-31T08:04:15Z", "type": "forcePushed"}, {"oid": "10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "url": "https://github.com/futurewei-cloud/alcor/commit/10cbf00ea7de8c3fed647216f41b5ade399ccbe5", "message": "Update PM-DPM contract", "committedDate": "2020-08-31T08:10:37Z", "type": "forcePushed"}, {"oid": "6d4037753129dbabfa83f24b06eacc1e10a21d30", "url": "https://github.com/futurewei-cloud/alcor/commit/6d4037753129dbabfa83f24b06eacc1e10a21d30", "message": "Update PM-DPM contract", "committedDate": "2020-08-31T08:12:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUzODI3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r480538275", "bodyText": "I suggest that using PUT for this api, then it will become /project/{project_id}/update-l3-neighbors/{new_subnet_id}.\nThe BODY becomes {operation_type, vpcid, [old_subnet_ids]}", "author": "cj-chung", "createdAt": "2020-09-01T01:15:15Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -203,4 +205,22 @@ public PortWebBulkJson listPort(@PathVariable(\"project_id\") String projectId) th\n \n         return new PortWebBulkJson(portsList);\n     }\n+\n+    /**\n+     * Update neighbor tables and send them to DPM when adding or deleting gateway port\n+     * @param projectId Project Id\n+     * @param routerSubnetUpdateInfo Router's latest subnet information\n+     * @return RouterSubnetUpdateInfo\n+     * @throws Exception Db operation exception\n+     */\n+    @Rbac(resource =\"port\")\n+    @PostMapping({\"/project/{project_id}/update-l3-neighbors\", \"v4/{project_id}/update-l3-neighbors\"})\n+    @ResponseBody\n+    @ResponseStatus(HttpStatus.CREATED)\n+    @DurationStatistics\n+    public RouterSubnetUpdateInfo updateL3Neighbors(@PathVariable(\"project_id\") String projectId,\n+                                                    @RequestBody RouterSubnetUpdateInfo routerSubnetUpdateInfo) throws Exception {\n+        checkRouterSubnetUpdateInfo(routerSubnetUpdateInfo);\n+        return portService.updateL3Neighbors(projectId, routerSubnetUpdateInfo);\n+    }\n }", "originalCommit": "6d4037753129dbabfa83f24b06eacc1e10a21d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU2ODkzNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r480568936", "bodyText": "ok", "author": "chenpiaoping", "createdAt": "2020-09-01T01:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUzODI3NQ=="}], "type": "inlineReview"}, {"oid": "9c4d8143c2b740a8141d0e927641daad34e5e1c6", "url": "https://github.com/futurewei-cloud/alcor/commit/9c4d8143c2b740a8141d0e927641daad34e5e1c6", "message": "Get connected subnets from router manager", "committedDate": "2020-09-17T03:11:15Z", "type": "commit"}, {"oid": "a8878e961b30af52b999e0110762b68f1fcdf05e", "url": "https://github.com/futurewei-cloud/alcor/commit/a8878e961b30af52b999e0110762b68f1fcdf05e", "message": "Interact with RM to obtain connected subnets and updating neighbor information when gateway port add or delete", "committedDate": "2020-09-17T03:11:21Z", "type": "commit"}, {"oid": "467677f446edfab763ceb8abca65f8197d0deb8a", "url": "https://github.com/futurewei-cloud/alcor/commit/467677f446edfab763ceb8abca65f8197d0deb8a", "message": "Update PM-DPM contract", "committedDate": "2020-09-17T03:11:24Z", "type": "commit"}, {"oid": "96f38b3ebbd284934bb71910fcda0e90dc218fca", "url": "https://github.com/futurewei-cloud/alcor/commit/96f38b3ebbd284934bb71910fcda0e90dc218fca", "message": "DPM support pulsar", "committedDate": "2020-09-17T03:11:30Z", "type": "commit"}, {"oid": "2742ecd1e4487c6b82991128e87cb59b60b82bcc", "url": "https://github.com/futurewei-cloud/alcor/commit/2742ecd1e4487c6b82991128e87cb59b60b82bcc", "message": "update PM-RM contract", "committedDate": "2020-09-19T07:09:42Z", "type": "commit"}, {"oid": "2742ecd1e4487c6b82991128e87cb59b60b82bcc", "url": "https://github.com/futurewei-cloud/alcor/commit/2742ecd1e4487c6b82991128e87cb59b60b82bcc", "message": "update PM-RM contract", "committedDate": "2020-09-19T07:09:42Z", "type": "forcePushed"}, {"oid": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "url": "https://github.com/futurewei-cloud/alcor/commit/245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "message": "Turn off all UTs of DPM temporarily", "committedDate": "2020-09-19T07:22:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjc1Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462756", "bodyText": "Don't think this is going to work. We should use /project/%s", "author": "xieus", "createdAt": "2020-09-22T04:02:55Z", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);\n+        ConnectedSubnetsWebResponse routerSubnets = restTemplate.getForObject(url, ConnectedSubnetsWebResponse.class);\n+        if (routerSubnets == null) {\n+            throw new Exception(\"Get router connected subnets failed\");\n+        }\n+\n+        return routerSubnets;\n+    }\n+\n+    public void addRouterInterface(String routerId, PortEntity portEntity) {\n+        String url = String.format(\"/v2.0/routers/%s/add_router_interface\", routerId);", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjg1MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492462851", "bodyText": "This url doesn't include routeManagerUrl.", "author": "xieus", "createdAt": "2020-09-22T04:03:29Z", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/RouterManagerRestClient.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.restclient;\n+\n+import com.futurewei.alcor.web.entity.port.PortEntity;\n+import com.futurewei.alcor.web.entity.route.ConnectedSubnetsWebResponse;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class RouterManagerRestClient extends AbstractRestClient {\n+    @Value(\"${microservices.router.service.url:#{\\\"\\\"}}\")\n+    private String routerManagerUrl;\n+\n+    public ConnectedSubnetsWebResponse getRouterSubnets(String projectId, String vpcId, String subnetId) throws Exception {\n+        String url = String.format(\"/project/%s/vpcs/%s/subnets/%s/connected-subnets\", projectId, vpcId, subnetId);", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNDYzMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492504631", "bodyText": "Oh, yes, thanks", "author": "chenpiaoping", "createdAt": "2020-09-22T06:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Mjg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492487595", "bodyText": "Could you add a comment to show this is a mapping from vpc_id to a list of subnet ids?\nbtw, do we have more than one vpc that a port needs to worry about here?", "author": "xieus", "createdAt": "2020-09-22T05:52:37Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/PortContext.java", "diffHunk": "@@ -34,6 +37,8 @@\n     private List<PortEntity> portEntities; //For add and delete\n     private PortEntity oldPortEntity; //For update\n     private PortEntity newPortEntity; //For update\n+    private Map<String, List<String>> routerSubnetIds;", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNjY5NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492506694", "bodyText": "sure, I will add some comments here\nPortContext contains all the context information for port batch processing, where multiple vpc may be processed at the same time.", "author": "chenpiaoping", "createdAt": "2020-09-22T06:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNzMyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494717323", "bodyText": "Makes sense.", "author": "xieus", "createdAt": "2020-09-25T02:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4NzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4ODk5MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492488991", "bodyText": "Glad to see that PM starts supporting multiple IPs \ud83d\udc4d", "author": "xieus", "createdAt": "2020-09-22T05:57:51Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -44,16 +51,15 @@ void createProcess(PortContext context) throws Exception {\n         NetworkConfig networkConfig = context.getNetworkConfig();\n         List<InternalPortEntity> internalPortEntities = networkConfig.getPortEntities();\n         for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            NeighborInfo neighborInfo = buildNeighborInfo(internalPortEntity);\n-            if (neighborInfo == null) {\n+            List<NeighborInfo> neighborInfoList = buildNeighborInfos(internalPortEntity);", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492489693", "bodyText": "Does this TODO get implemented already?", "author": "xieus", "createdAt": "2020-09-22T06:00:29Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/DatabaseProcessor.java", "diffHunk": "@@ -22,19 +22,26 @@\n import java.util.*;\n \n public class DatabaseProcessor extends AbstractProcessor {\n-    private NeighborInfo buildNeighborInfo(InternalPortEntity internalPortEntity) {\n+    private List<NeighborInfo> buildNeighborInfos(InternalPortEntity internalPortEntity) {\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n         String bindingHostIp = internalPortEntity.getBindingHostIP();\n         if (bindingHostIp == null) {\n-            return null;\n+            return neighborInfos;\n         }\n \n-        NeighborInfo neighborInfo = new NeighborInfo(bindingHostIp,\n-                internalPortEntity.getBindingHostId(),\n-                internalPortEntity.getId(),\n-                internalPortEntity.getMacAddress(),\n-                internalPortEntity.getFixedIps().get(0).getIpAddress());\n+        //TODO: Support a port with multiple neighborInfos", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzA0MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492507040", "bodyText": "Not yet", "author": "chenpiaoping", "createdAt": "2020-09-22T06:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMTE0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494721144", "bodyText": "Correct me if I am wrong. neighborInfos itself is an array and could contain more than one items assuming that a port has multiple fixed ips.\nCan you elaborate a bit what multiple neighbors you refer to? Which scenario may not be supported as this time.", "author": "xieus", "createdAt": "2020-09-25T03:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNDE1Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494724157", "bodyText": "Oh, yes, neighborInfos itself is an array,  this comment is meaningless. Let me delete it.", "author": "chenpiaoping", "createdAt": "2020-09-25T03:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4OTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MTYzOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492491638", "bodyText": "What if neighborInfos contains some duplicated neighbors? Is it possible?", "author": "xieus", "createdAt": "2020-09-22T06:07:10Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/NeighborProcessor.java", "diffHunk": "@@ -18,34 +18,31 @@\n import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n import com.futurewei.alcor.portmanager.request.FetchPortNeighborRequest;\n import com.futurewei.alcor.portmanager.request.IRestRequest;\n-import com.futurewei.alcor.web.entity.dataplane.InternalPortEntity;\n import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Set;\n+import java.util.*;\n import java.util.stream.Collectors;\n \n public class NeighborProcessor extends AbstractProcessor {\n     private void fetchPortNeighborCallback(IRestRequest request) {\n         List<PortNeighbors> portNeighborsList = ((FetchPortNeighborRequest) request).getPortNeighborsList();\n-        List<InternalPortEntity> internalPortEntities =\n-                request.getContext().getNetworkConfig().getPortEntities();\n-\n-        for (InternalPortEntity internalPortEntity : internalPortEntities) {\n-            for (PortNeighbors portNeighbors: portNeighborsList) {\n-                if (portNeighbors.getNeighbors() == null) {\n-                    continue;\n-                }\n+        if (portNeighborsList == null || portNeighborsList.size() == 0) {\n+            return;\n+        }\n \n-                if (internalPortEntity.getVpcId().equals(portNeighbors.getVpcId())) {\n-                    List<NeighborInfo> neighborInfos = new ArrayList<>(portNeighbors.getNeighbors().values());\n-                    internalPortEntity.setNeighborInfos(neighborInfos);\n-                }\n+        List<NeighborInfo> neighborInfos = new ArrayList<>();\n+        for (PortNeighbors portNeighbors: portNeighborsList) {\n+            if (portNeighbors.getNeighbors() == null ||\n+                    portNeighbors.getNeighbors().size() == 0) {\n+                continue;\n             }\n+\n+            neighborInfos.addAll(portNeighbors.getNeighbors().values());", "originalCommit": "245c1ebcb14f8fd99b31482ee09b7d31ca6e460f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwODc4MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r492508780", "bodyText": "The portNeighbors is read from the DB, and the they are stored with port_id as key, so the neighbor is not duplicated.", "author": "chenpiaoping", "createdAt": "2020-09-22T06:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MTYzOA=="}], "type": "inlineReview"}, {"oid": "ce077dbb8a2873702981ba9e612fdab45917d2ae", "url": "https://github.com/futurewei-cloud/alcor/commit/ce077dbb8a2873702981ba9e612fdab45917d2ae", "message": "Correct the url of connected-subnets interface", "committedDate": "2020-09-22T07:08:48Z", "type": "commit"}, {"oid": "7dd1aeda09c727be089451465646c45c2a8b0dd4", "url": "https://github.com/futurewei-cloud/alcor/commit/7dd1aeda09c727be089451465646c45c2a8b0dd4", "message": "Add testcase for updateL3Neighbor interface", "committedDate": "2020-09-24T07:02:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494467175", "bodyText": "We would need a case-insensitive check.", "author": "xieus", "createdAt": "2020-09-24T16:50:51Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/util/RestParameterValidator.java", "diffHunk": "@@ -138,9 +138,9 @@ public static void checkRouterSubnetUpdateInfo(RouterUpdateInfo routerUpdateInfo\n             throw new SubnetIdInvalid();\n         }\n \n-        RouterUpdateInfo.OperationType operationType = routerUpdateInfo.getOperationType();\n-        if (!RouterUpdateInfo.OperationType.ADD.equals(operationType) &&\n-                !RouterUpdateInfo.OperationType.DELETE.equals(operationType)) {\n+        String operationType = routerUpdateInfo.getOperationType();\n+        if (!RouterUpdateInfo.OperationType.ADD.getType().equals(operationType) &&", "originalCommit": "7dd1aeda09c727be089451465646c45c2a8b0dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDczMDMyNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494730324", "bodyText": "@chenpiaoping Check if this is a problem. If not, we can go ahead to merge it.", "author": "xieus", "createdAt": "2020-09-25T03:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc3NzE2Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494777163", "bodyText": "Fixed.", "author": "chenpiaoping", "createdAt": "2020-09-25T06:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2NzE3NQ=="}], "type": "inlineReview"}, {"oid": "e5ffbfe2b464b115a0cf913c0bc70055652fe347", "url": "https://github.com/futurewei-cloud/alcor/commit/e5ffbfe2b464b115a0cf913c0bc70055652fe347", "message": "Use the annotation @AfterProcessor to control the order in which processor is executed", "committedDate": "2020-09-25T01:47:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494714119", "bodyText": "@chenpiaoping trying to understand whether this process relies on the new AfterProcessor annotation. How is the order determined?", "author": "xieus", "createdAt": "2020-09-25T02:38:44Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/ProcessorManager.java", "diffHunk": "@@ -27,41 +27,57 @@\n public class ProcessorManager {\n     private static final Logger LOG = LoggerFactory.getLogger(ProcessorManager.class);\n \n-    private static List<IProcessor> statelessProcessors = new ArrayList<>();\n-    private static Map<Class, IProcessor> allProcessors = new HashMap<>();\n-    private static IProcessor headProcessor;\n-    private static IProcessor dataPlaneProcessor;\n-    private static IProcessor databaseProcessor;\n+    private static List<IProcessor> processors = new ArrayList<>();\n+    private static Map<Class, IProcessor> processorMap = new HashMap<>();\n \n     private void buildProcessChain() {", "originalCommit": "e5ffbfe2b464b115a0cf913c0bc70055652fe347", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTQyMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494719421", "bodyText": "The order is determined in the instanceProcessor() method.", "author": "chenpiaoping", "createdAt": "2020-09-25T02:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMjA2MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494722060", "bodyText": "Got it. I think our current assumption for the chain is no more than 2, which should be satisficed in most of cases.", "author": "xieus", "createdAt": "2020-09-25T03:09:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494715926", "bodyText": "Could we make the TRY_TIMES and SLEEP_TIME configurable?", "author": "xieus", "createdAt": "2020-09-25T02:45:13Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/processor/RouterProcessor.java", "diffHunk": "@@ -36,13 +41,24 @@ private void getRouterSubnetIds(PortContext context, String vpcId, String subnet\n                 fetchRouterSubnetsRequest, this::fetchConnectedSubnetIdsCallback);\n     }\n \n-    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) {\n+    private void getRouterSubnetIds(PortContext context, List<PortEntity> portEntities) throws Exception {\n         Set<String> vpcIds = new HashSet<>();\n+        int tryTimes = TRY_TIMES;\n         for (PortEntity portEntity: portEntities) {\n             if (portEntity.getFixedIps() == null) {\n                 continue;\n             }\n \n+            //Waiting for random ip address to be assigned\n+            while (portEntity.getFixedIps() == null && tryTimes > 0) {\n+                Thread.sleep(SLEEP_TIME);", "originalCommit": "e5ffbfe2b464b115a0cf913c0bc70055652fe347", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxOTk2Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494719967", "bodyText": "This may be a temporary implementation, I am considering whether there is a better way to deal with request dependencies.", "author": "chenpiaoping", "createdAt": "2020-09-25T03:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMjQ1Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494722457", "bodyText": "I think we could have a generic retry mechanism across the processes, but each process could have its own set of configurations.", "author": "xieus", "createdAt": "2020-09-25T03:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNTMzNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494725337", "bodyText": "I'm thinking of solving this problem through the observer design pattern, instead of blocking and waiting for dependent process completion in an asynchronous way.", "author": "chenpiaoping", "createdAt": "2020-09-25T03:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyNTY2NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494725665", "bodyText": "these configurations may not be needed in the future..", "author": "chenpiaoping", "createdAt": "2020-09-25T03:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDczMDAzNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/366#discussion_r494730035", "bodyText": "Cool. Observer pattern is used in the case of one-to-many relationship between objects such as if one object is modified, its dependent objects are to be notified automatically. Does this apply to our scenario as you intend to use the asynchronous notification.\nThis temp configuration is fine for now. We can merge this PR of current form to master, and you can take the time to design and leverage some advanced design pattern \ud83d\udc4d", "author": "xieus", "createdAt": "2020-09-25T03:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcxNTkyNg=="}], "type": "inlineReview"}, {"oid": "6741f97fd2feb4cb329eb7623bfb2b41e4e869e0", "url": "https://github.com/futurewei-cloud/alcor/commit/6741f97fd2feb4cb329eb7623bfb2b41e4e869e0", "message": "Delete some unused comments", "committedDate": "2020-09-25T03:06:34Z", "type": "commit"}, {"oid": "4ccbe473788133d22fb657d1381ea1db620aa398", "url": "https://github.com/futurewei-cloud/alcor/commit/4ccbe473788133d22fb657d1381ea1db620aa398", "message": "Operation type use case-insensitive check", "committedDate": "2020-09-25T06:35:32Z", "type": "commit"}]}