{"pr_number": 481, "pr_title": "[Data Plane Mgr] Support Pulsar Publisher ", "pr_createdAt": "2020-11-18T10:33:07Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/481", "timeline": [{"oid": "301daa5adaafc1572d468f2da0b779465034b5cb", "url": "https://github.com/futurewei-cloud/alcor/commit/301daa5adaafc1572d468f2da0b779465034b5cb", "message": "Merge pulsar to dpm", "committedDate": "2020-11-18T10:31:06Z", "type": "commit"}, {"oid": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "url": "https://github.com/futurewei-cloud/alcor/commit/ddf8f06693f047aebd64f19903e5d765bfaa89e8", "message": "Merge pulsar to dpm", "committedDate": "2020-11-18T10:36:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526636030", "bodyText": "I remember we had an old issue in the new DPM when we enable gRPC client and pulsar client, DPM can't launch. Not sure if it has been fixed. @chenpiaoping @VanderChen", "author": "xieus", "createdAt": "2020-11-19T07:06:19Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/DataPlaneClientImpl.java", "diffHunk": "@@ -18,24 +18,151 @@\n import com.futurewei.alcor.dataplane.client.DataPlaneClient;\n import com.futurewei.alcor.dataplane.entity.MulticastGoalState;\n import com.futurewei.alcor.dataplane.entity.UnicastGoalState;\n+import com.futurewei.alcor.dataplane.exception.GroupTopicNotFound;\n+import com.futurewei.alcor.dataplane.exception.MulticastTopicNotFound;\n import com.futurewei.alcor.schema.Goalstate;\n import com.futurewei.alcor.schema.Goalstateprovisioner;\n+import com.futurewei.alcor.web.entity.dataplane.MulticastGoalStateByte;\n+import com.futurewei.alcor.web.entity.dataplane.UnicastGoalStateByte;\n+\n+import org.apache.pulsar.client.api.Producer;\n+import org.apache.pulsar.client.api.PulsarClient;\n+import org.apache.pulsar.client.impl.schema.JSONSchema;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n \n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n //@Component", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4NjMyNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526786325", "bodyText": "I don't know whether pulsar and gRPC should be enabled at the same time. If not, we plan to use a configuration file to decide which client.", "author": "VanderChen", "createdAt": "2020-11-19T11:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5NzQyNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526897426", "bodyText": "Configuration is one option which means that gRRC and Pulsar is exclusive to each other.\n@VanderChen, can you check how to allow two client coexist? Thank you.", "author": "xieus", "createdAt": "2020-11-19T13:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ2MDU5Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r527460597", "bodyText": "In the current implementation, there can only be one dataClient instance. Do we need two dataClient instances in one dpm at the same time? if so, which one should be used?", "author": "chenpiaoping", "createdAt": "2020-11-20T06:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ2OTEzNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r527469135", "bodyText": "The short answer is yes, we would love to have two clients coexist in one DPM instance. The gPRC client is for our fast path, and the pulsar or other MQ clients is for MQ scaling path.\nOn the service layer, we could develop an algorithm to decide which path to go. A simplest algorithm is purely based on the is_fast field in PortEntity but we could generate more sophisticated algorithm that considers the size of VPC (for the resource to be updated), scenarios ( port/sg/route/nacl update), and other parameters.", "author": "xieus", "createdAt": "2020-11-20T06:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMTI3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532821275", "bodyText": "Saw the change in grpc/DataPlaneClientImpl to make the client as a service.", "author": "xieus", "createdAt": "2020-11-30T18:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzOTA2Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526639066", "bodyText": "This is an OK short-term solution. Let us plan a long-term solution. One possibility to store the mapping in node metadata manager, as this is a host-level resource.\n@chenpiaoping @VanderChen what do you think of?", "author": "xieus", "createdAt": "2020-11-19T07:13:54Z", "path": "services/data_plane_manager/src/main/resources/application.properties", "diffHunk": "@@ -13,3 +13,10 @@ grpc.threads-pool-name = grpc-thread-pool\n #logging.level.root=INFO\n \n \n+mq.type=pulsar\n+#####Pulsar configuration#####\n+pulsar.url=pulsar://127.0.0.1:6650\n+pulsar.unicast.topic=unicast-topic1\n+host.ip.to.group.topic.map=group-topic1:192.168.131.131,10.10.10.11 group-topic2:192.168.131.131,11.11.11.12", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyODMzOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532828338", "bodyText": "Create a tracking issue #490\n@VanderChen If you can take this item, that would be great. Let us sync on Slack for more details.", "author": "xieus", "createdAt": "2020-11-30T19:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzOTA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzOTU2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526639569", "bodyText": "Like this config \ud83d\udc4d", "author": "xieus", "createdAt": "2020-11-19T07:15:04Z", "path": "services/data_plane_manager/src/main/resources/application.properties", "diffHunk": "@@ -13,3 +13,10 @@ grpc.threads-pool-name = grpc-thread-pool\n #logging.level.root=INFO\n \n \n+mq.type=pulsar", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MDk0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526640944", "bodyText": "Let us plan to build these mapping from node metadata manager and store it in the local cache under development.", "author": "xieus", "createdAt": "2020-11-19T07:18:23Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/TopicManager.java", "diffHunk": "@@ -15,9 +15,72 @@\n */\n package com.futurewei.alcor.dataplane.client.pulsar;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.util.*;\n+\n+@Configuration\n+@ConditionalOnProperty(prefix = \"mq\", name = \"type\", havingValue = \"pulsar\")\n public class TopicManager {\n+    private static final Logger LOG = LoggerFactory.getLogger(TopicManager.class);\n+\n+    @Autowired\n+    private PulsarConfiguration configuration;\n+\n+    private Map<String, String> hostIpToGroupTopic;", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MTk2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526641969", "bodyText": "We can define an explicit exception for this parsing error. Please find an example in https://github.com/futurewei-cloud/alcor/tree/master/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/exception\nThe idea is that we know every possible exception our own program may throw, and define it before hand. In each of the predefined exception, we can define its error code and message, and come to the debugging time, we can quickly locate where the exception is thrown and why based on the given error code and message.", "author": "xieus", "createdAt": "2020-11-19T07:20:46Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/TopicManager.java", "diffHunk": "@@ -15,9 +15,72 @@\n */\n package com.futurewei.alcor.dataplane.client.pulsar;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.util.*;\n+\n+@Configuration\n+@ConditionalOnProperty(prefix = \"mq\", name = \"type\", havingValue = \"pulsar\")\n public class TopicManager {\n+    private static final Logger LOG = LoggerFactory.getLogger(TopicManager.class);\n+\n+    @Autowired\n+    private PulsarConfiguration configuration;\n+\n+    private Map<String, String> hostIpToGroupTopic;\n+\n+    private Map<String, String> groupTopicToMulticastTopic;\n+\n+    private Set<String> groupTopics;\n+\n+    private Set<String> multicastTopics;\n+\n+    @PostConstruct\n+    public void init() throws Exception {\n+        try {\n+            this.hostIpToGroupTopic = parseTopicConfig(configuration.getHostIpToGroupTopicMap());\n+            this.groupTopicToMulticastTopic = parseTopicConfig(configuration.getGroupTopicToMulticastTopicMap());\n+        }catch (Exception e) {\n+            throw new Exception(\"Parse topic config error: \" + e);", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4OTY3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526789675", "bodyText": "I will add a predefined exception to solve this problem.", "author": "VanderChen", "createdAt": "2020-11-19T11:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MjM1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526642353", "bodyText": "Like this function implementation, which is neat.", "author": "xieus", "createdAt": "2020-11-19T07:21:49Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/UnicastFunction.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.dataplane.client.pulsar;\n+\n+import com.futurewei.alcor.web.entity.dataplane.UnicastGoalStateByte;\n+import org.apache.pulsar.client.api.Schema;\n+import org.apache.pulsar.functions.api.Context;\n+import org.apache.pulsar.functions.api.Function;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class UnicastFunction implements Function<UnicastGoalStateByte, UnicastGoalStateByte> {", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NDE3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526644170", "bodyText": "btw, where is this UnicastFunction used?", "author": "xieus", "createdAt": "2020-11-19T07:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc5NTgwNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526795807", "bodyText": "Both UnicastFunction and MulticastFuncation will be bundled as jar packages. These will be deployed to the Pulsar cluster as function workers by the Pulsar CLI tool.", "author": "VanderChen", "createdAt": "2020-11-19T11:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc5NzgxMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526797812", "bodyText": "I'm trying to use Java interface to deploy function workers. This will enable automatic deployment when the dpm service starts.", "author": "VanderChen", "createdAt": "2020-11-19T11:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5ODIyMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526898221", "bodyText": "Cool looking forward to it \ud83d\udc4d", "author": "xieus", "createdAt": "2020-11-19T13:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0MjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NTE4OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526645189", "bodyText": "we should use configuration here.\nCheck the thread pool configurations in application.properties\ngrpc.min-threads = 100\ngrpc.max-threads = 200", "author": "xieus", "createdAt": "2020-11-19T07:28:38Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/MulticastFunction.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.dataplane.client.pulsar;\n+\n+import com.futurewei.alcor.web.entity.dataplane.MulticastGoalStateByte;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import org.apache.pulsar.client.api.Schema;\n+import org.apache.pulsar.functions.api.Context;\n+import org.apache.pulsar.functions.api.Function;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MulticastFunction implements Function<MulticastGoalStateByte, MulticastGoalStateByte> {\n+    private static final Logger LOG = LoggerFactory.getLogger(MulticastFunction.class);\n+    public static final ThreadPoolExecutor executor = new ThreadPoolExecutor(\n+            20,", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc5ODQzMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526798431", "bodyText": "I'll fix this in the next commit.", "author": "VanderChen", "createdAt": "2020-11-19T11:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NjY3OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526646679", "bodyText": "In addition to JSONSchema, what does other schema Pulsar support?", "author": "xieus", "createdAt": "2020-11-19T07:32:05Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/DataPlaneClientImpl.java", "diffHunk": "@@ -18,24 +18,151 @@\n import com.futurewei.alcor.dataplane.client.DataPlaneClient;\n import com.futurewei.alcor.dataplane.entity.MulticastGoalState;\n import com.futurewei.alcor.dataplane.entity.UnicastGoalState;\n+import com.futurewei.alcor.dataplane.exception.GroupTopicNotFound;\n+import com.futurewei.alcor.dataplane.exception.MulticastTopicNotFound;\n import com.futurewei.alcor.schema.Goalstate;\n import com.futurewei.alcor.schema.Goalstateprovisioner;\n+import com.futurewei.alcor.web.entity.dataplane.MulticastGoalStateByte;\n+import com.futurewei.alcor.web.entity.dataplane.UnicastGoalStateByte;\n+\n+import org.apache.pulsar.client.api.Producer;\n+import org.apache.pulsar.client.api.PulsarClient;\n+import org.apache.pulsar.client.impl.schema.JSONSchema;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n \n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n //@Component\n public class DataPlaneClientImpl implements DataPlaneClient {\n+    private static final Logger LOG = LoggerFactory.getLogger(DataPlaneClientImpl.class);\n+\n+    @Autowired\n+    private PulsarClient pulsarClient;\n+\n+    @Autowired\n+    private TopicManager topicManager;\n \n     @Override\n     public Map<String, List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus>> createGoalStates(Goalstate.GoalState goalState, String hostIp) throws Exception {\n         return null;\n     }\n \n+    private UnicastGoalStateByte buildUnicastGoalStateByte(UnicastGoalState unicastGoalState) {\n+        UnicastGoalStateByte unicastGoalStateByte = new UnicastGoalStateByte();\n+        unicastGoalStateByte.setNextTopic(unicastGoalState.getNextTopic());\n+        unicastGoalStateByte.setGoalStateByte(unicastGoalState.getGoalState().toByteArray());\n+\n+        return unicastGoalStateByte;\n+    }\n+\n+    private List<String> getGroupTopics(List<String> hostIps) throws Exception {\n+        List<String> groupTopics = new ArrayList<>();\n+\n+        for (String hostIp: hostIps) {\n+            String groupTopic = topicManager.getGroupTopicByHostIp(hostIp);\n+            if (StringUtils.isEmpty(groupTopic)) {\n+                LOG.error(\"Can not find group topic by host ip:{}\", hostIp);\n+                throw new GroupTopicNotFound();\n+            }\n+\n+            groupTopics.add(groupTopic);\n+        }\n+\n+        return groupTopics;\n+    }\n+\n+    private Map<String, List<String>> getMulticastTopics(List<String> hostIps) throws Exception {\n+        Map<String, List<String>> multicastTopics = new HashMap<>();\n+\n+        List<String> groupTopics = this.getGroupTopics(hostIps);\n+        for (String groupTopic: groupTopics) {\n+            String multicastTopic = topicManager.getMulticastTopicByGroupTopic(groupTopic);\n+            if (StringUtils.isEmpty(multicastTopic)) {\n+                LOG.error(\"Can not find multicast topic by group topic:{}\", groupTopic);\n+                throw new MulticastTopicNotFound();\n+            }\n+\n+            if (!multicastTopics.containsKey(multicastTopic)) {\n+                multicastTopics.put(multicastTopic, new ArrayList<>());\n+            }\n+\n+            multicastTopics.get(multicastTopic).add(groupTopic);\n+        }\n+\n+        return multicastTopics;\n+    }\n+\n+    private MulticastGoalStateByte buildMulticastGoalStateByte(MulticastGoalState multicastGoalState) {\n+        MulticastGoalStateByte multicastGoalStateByte = new MulticastGoalStateByte();\n+        multicastGoalStateByte.setNextTopics(multicastGoalState.getNextTopics());\n+        multicastGoalStateByte.setGoalStateByte(multicastGoalState.getGoalState().toByteArray());\n+\n+        return multicastGoalStateByte;\n+    }\n+\n+    private void createGoalState(MulticastGoalState multicastGoalState) throws Exception {\n+        Map<String, List<String>> multicastTopics = getMulticastTopics(multicastGoalState.getHostIps());\n+\n+        for (Map.Entry<String, List<String>> entry: multicastTopics.entrySet()) {\n+            String multicastTopic = entry.getKey();\n+            List<String> groupTopics = entry.getValue();\n+\n+            multicastGoalState.setNextTopics(groupTopics);\n+\n+            Producer<MulticastGoalStateByte> producer = pulsarClient\n+                    .newProducer(JSONSchema.of(MulticastGoalStateByte.class))\n+                    .topic(multicastTopic)\n+                    .enableBatching(false)\n+                    .create();\n+\n+            producer.send(buildMulticastGoalStateByte(multicastGoalState));\n+\n+            LOG.info(\"Send multicastGoalState to topic:{} success, \" +\n+                            \"groupTopics: {}, unicastGoalStates: {}\",\n+                    multicastTopic, groupTopics, multicastGoalState);\n+        }\n+    }\n+\n     @Override\n     public List<Map<String, List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus>>> createGoalStates(List<UnicastGoalState> unicastGoalStates) throws Exception {\n-        return null;\n+        for (UnicastGoalState unicastGoalState: unicastGoalStates) {\n+            String nextTopic = topicManager.getGroupTopicByHostIp(unicastGoalState.getHostIp());\n+            if (StringUtils.isEmpty(nextTopic)) {\n+                LOG.error(\"Can not find next topic by host ip:{}\", unicastGoalState.getHostIp());\n+                throw new GroupTopicNotFound();\n+            }\n+\n+            String topic = nextTopic;\n+            String unicastTopic = topicManager.getUnicastTopic();\n+            if (!StringUtils.isEmpty(unicastTopic)) {\n+                unicastGoalState.setNextTopic(nextTopic);\n+                topic = unicastTopic;\n+            }\n+\n+            Producer<UnicastGoalStateByte> producer = pulsarClient\n+                    .newProducer(JSONSchema.of(UnicastGoalStateByte.class))", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NzMyMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526647320", "bodyText": "I know we don't have a response from MQ for now. @chenpiaoping Let us plan to design a feedback channel here: it would be ideal if we can reuse the same topic with different key.", "author": "xieus", "createdAt": "2020-11-19T07:33:42Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/DataPlaneClientImpl.java", "diffHunk": "@@ -18,24 +18,151 @@\n import com.futurewei.alcor.dataplane.client.DataPlaneClient;\n import com.futurewei.alcor.dataplane.entity.MulticastGoalState;\n import com.futurewei.alcor.dataplane.entity.UnicastGoalState;\n+import com.futurewei.alcor.dataplane.exception.GroupTopicNotFound;\n+import com.futurewei.alcor.dataplane.exception.MulticastTopicNotFound;\n import com.futurewei.alcor.schema.Goalstate;\n import com.futurewei.alcor.schema.Goalstateprovisioner;\n+import com.futurewei.alcor.web.entity.dataplane.MulticastGoalStateByte;\n+import com.futurewei.alcor.web.entity.dataplane.UnicastGoalStateByte;\n+\n+import org.apache.pulsar.client.api.Producer;\n+import org.apache.pulsar.client.api.PulsarClient;\n+import org.apache.pulsar.client.impl.schema.JSONSchema;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n \n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n //@Component\n public class DataPlaneClientImpl implements DataPlaneClient {\n+    private static final Logger LOG = LoggerFactory.getLogger(DataPlaneClientImpl.class);\n+\n+    @Autowired\n+    private PulsarClient pulsarClient;\n+\n+    @Autowired\n+    private TopicManager topicManager;\n \n     @Override\n     public Map<String, List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus>> createGoalStates(Goalstate.GoalState goalState, String hostIp) throws Exception {\n         return null;\n     }\n \n+    private UnicastGoalStateByte buildUnicastGoalStateByte(UnicastGoalState unicastGoalState) {\n+        UnicastGoalStateByte unicastGoalStateByte = new UnicastGoalStateByte();\n+        unicastGoalStateByte.setNextTopic(unicastGoalState.getNextTopic());\n+        unicastGoalStateByte.setGoalStateByte(unicastGoalState.getGoalState().toByteArray());\n+\n+        return unicastGoalStateByte;\n+    }\n+\n+    private List<String> getGroupTopics(List<String> hostIps) throws Exception {\n+        List<String> groupTopics = new ArrayList<>();\n+\n+        for (String hostIp: hostIps) {\n+            String groupTopic = topicManager.getGroupTopicByHostIp(hostIp);\n+            if (StringUtils.isEmpty(groupTopic)) {\n+                LOG.error(\"Can not find group topic by host ip:{}\", hostIp);\n+                throw new GroupTopicNotFound();\n+            }\n+\n+            groupTopics.add(groupTopic);\n+        }\n+\n+        return groupTopics;\n+    }\n+\n+    private Map<String, List<String>> getMulticastTopics(List<String> hostIps) throws Exception {\n+        Map<String, List<String>> multicastTopics = new HashMap<>();\n+\n+        List<String> groupTopics = this.getGroupTopics(hostIps);\n+        for (String groupTopic: groupTopics) {\n+            String multicastTopic = topicManager.getMulticastTopicByGroupTopic(groupTopic);\n+            if (StringUtils.isEmpty(multicastTopic)) {\n+                LOG.error(\"Can not find multicast topic by group topic:{}\", groupTopic);\n+                throw new MulticastTopicNotFound();\n+            }\n+\n+            if (!multicastTopics.containsKey(multicastTopic)) {\n+                multicastTopics.put(multicastTopic, new ArrayList<>());\n+            }\n+\n+            multicastTopics.get(multicastTopic).add(groupTopic);\n+        }\n+\n+        return multicastTopics;\n+    }\n+\n+    private MulticastGoalStateByte buildMulticastGoalStateByte(MulticastGoalState multicastGoalState) {\n+        MulticastGoalStateByte multicastGoalStateByte = new MulticastGoalStateByte();\n+        multicastGoalStateByte.setNextTopics(multicastGoalState.getNextTopics());\n+        multicastGoalStateByte.setGoalStateByte(multicastGoalState.getGoalState().toByteArray());\n+\n+        return multicastGoalStateByte;\n+    }\n+\n+    private void createGoalState(MulticastGoalState multicastGoalState) throws Exception {\n+        Map<String, List<String>> multicastTopics = getMulticastTopics(multicastGoalState.getHostIps());\n+\n+        for (Map.Entry<String, List<String>> entry: multicastTopics.entrySet()) {\n+            String multicastTopic = entry.getKey();\n+            List<String> groupTopics = entry.getValue();\n+\n+            multicastGoalState.setNextTopics(groupTopics);\n+\n+            Producer<MulticastGoalStateByte> producer = pulsarClient\n+                    .newProducer(JSONSchema.of(MulticastGoalStateByte.class))\n+                    .topic(multicastTopic)\n+                    .enableBatching(false)\n+                    .create();\n+\n+            producer.send(buildMulticastGoalStateByte(multicastGoalState));\n+\n+            LOG.info(\"Send multicastGoalState to topic:{} success, \" +\n+                            \"groupTopics: {}, unicastGoalStates: {}\",\n+                    multicastTopic, groupTopics, multicastGoalState);\n+        }\n+    }\n+\n     @Override\n     public List<Map<String, List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus>>> createGoalStates(List<UnicastGoalState> unicastGoalStates) throws Exception {\n-        return null;\n+        for (UnicastGoalState unicastGoalState: unicastGoalStates) {\n+            String nextTopic = topicManager.getGroupTopicByHostIp(unicastGoalState.getHostIp());\n+            if (StringUtils.isEmpty(nextTopic)) {\n+                LOG.error(\"Can not find next topic by host ip:{}\", unicastGoalState.getHostIp());\n+                throw new GroupTopicNotFound();\n+            }\n+\n+            String topic = nextTopic;\n+            String unicastTopic = topicManager.getUnicastTopic();\n+            if (!StringUtils.isEmpty(unicastTopic)) {\n+                unicastGoalState.setNextTopic(nextTopic);\n+                topic = unicastTopic;\n+            }\n+\n+            Producer<UnicastGoalStateByte> producer = pulsarClient\n+                    .newProducer(JSONSchema.of(UnicastGoalStateByte.class))\n+                    .topic(topic)\n+                    .enableBatching(false)\n+                    .create();\n+            producer.send(buildUnicastGoalStateByte(unicastGoalState));\n+\n+            LOG.info(\"Send unicastGoalStates to topic:{} success, \" +\n+                    \"unicastGoalStates: {}\", nextTopic, unicastGoalState);\n+        }\n+\n+        List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus> tempList = new ArrayList<>();", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMzcxMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532823713", "bodyText": "Create a tracking issue #489 @chenpiaoping", "author": "xieus", "createdAt": "2020-11-30T18:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NzMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0OTIyMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r526649222", "bodyText": "This basically converts UnicastGoalState to UnicastGoalStateByte. Can we define it inside the class of UnicastGoalState?", "author": "xieus", "createdAt": "2020-11-19T07:37:51Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/DataPlaneClientImpl.java", "diffHunk": "@@ -18,24 +18,151 @@\n import com.futurewei.alcor.dataplane.client.DataPlaneClient;\n import com.futurewei.alcor.dataplane.entity.MulticastGoalState;\n import com.futurewei.alcor.dataplane.entity.UnicastGoalState;\n+import com.futurewei.alcor.dataplane.exception.GroupTopicNotFound;\n+import com.futurewei.alcor.dataplane.exception.MulticastTopicNotFound;\n import com.futurewei.alcor.schema.Goalstate;\n import com.futurewei.alcor.schema.Goalstateprovisioner;\n+import com.futurewei.alcor.web.entity.dataplane.MulticastGoalStateByte;\n+import com.futurewei.alcor.web.entity.dataplane.UnicastGoalStateByte;\n+\n+import org.apache.pulsar.client.api.Producer;\n+import org.apache.pulsar.client.api.PulsarClient;\n+import org.apache.pulsar.client.impl.schema.JSONSchema;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n \n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n //@Component\n public class DataPlaneClientImpl implements DataPlaneClient {\n+    private static final Logger LOG = LoggerFactory.getLogger(DataPlaneClientImpl.class);\n+\n+    @Autowired\n+    private PulsarClient pulsarClient;\n+\n+    @Autowired\n+    private TopicManager topicManager;\n \n     @Override\n     public Map<String, List<Goalstateprovisioner.GoalStateOperationReply.GoalStateOperationStatus>> createGoalStates(Goalstate.GoalState goalState, String hostIp) throws Exception {\n         return null;\n     }\n \n+    private UnicastGoalStateByte buildUnicastGoalStateByte(UnicastGoalState unicastGoalState) {\n+        UnicastGoalStateByte unicastGoalStateByte = new UnicastGoalStateByte();\n+        unicastGoalStateByte.setNextTopic(unicastGoalState.getNextTopic());\n+        unicastGoalStateByte.setGoalStateByte(unicastGoalState.getGoalState().toByteArray());\n+\n+        return unicastGoalStateByte;\n+    }", "originalCommit": "ddf8f06693f047aebd64f19903e5d765bfaa89e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d59d4fc4e1260f10eb5c5b57af6b2a3124d41993", "url": "https://github.com/futurewei-cloud/alcor/commit/d59d4fc4e1260f10eb5c5b57af6b2a3124d41993", "message": "Enable gRPC and Pulsar client. Fix part of comments", "committedDate": "2020-11-26T13:36:49Z", "type": "commit"}, {"oid": "cebaba7ae415ed9ba71add1034eccf4bb6699004", "url": "https://github.com/futurewei-cloud/alcor/commit/cebaba7ae415ed9ba71add1034eccf4bb6699004", "message": "Add filed to decide client for createPort", "committedDate": "2020-11-27T02:07:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTc4OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r531361788", "bodyText": "I have a question about this. Will there be different isFastPath values in multiple portEntity? How to deal with this situation.", "author": "VanderChen", "createdAt": "2020-11-27T03:13:21Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java", "diffHunk": "@@ -557,12 +557,11 @@ private UnicastGoalState buildUnicastGoalState(NetworkConfiguration networkConfi\n         multicastGoalState.setGoalState(multicastGoalState.getGoalStateBuilder().build());\n         multicastGoalState.setGoalStateBuilder(null);\n \n-        // TODO: Find a field to decide client\n-        if (true){\n-            return pulsarDataPlaneClient.createGoalStates(unicastGoalStates, multicastGoalState);\n+        if (networkConfig.getPortEntities().get(0).isFastPath()){", "originalCommit": "cebaba7ae415ed9ba71add1034eccf4bb6699004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMDg1NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r531420854", "bodyText": "IsFastPath is a port-level config. Although we allow different values for multiple port entities for the sake of flexibility, we don't have such a scenario for now. In terms of implementation, we could make a port-level decision.", "author": "xieus", "createdAt": "2020-11-27T07:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyODk0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r531828945", "bodyText": "In this case, for the same NetworkConfiguration, we need to divide it into two groups to generate Goalstate based on whether it is fastpath. Am I following this logic to modify", "author": "VanderChen", "createdAt": "2020-11-28T03:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4MzIyNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532783224", "bodyText": "If a NetworkConfiguration includes multiple port entities, DPM will process each entity independently and likely send the corresponding GS to its target host.\nAt the moment of sending the GS, we need to use the isFastPath field to determine go with the fast path or MQ scaling path.", "author": "xieus", "createdAt": "2020-11-30T17:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTc4OA=="}], "type": "inlineReview"}, {"oid": "b92ec05eccb3fdf2f7284a466f2f12b64c1ada52", "url": "https://github.com/futurewei-cloud/alcor/commit/b92ec05eccb3fdf2f7284a466f2f12b64c1ada52", "message": "Add consumer in UT test. Fix comments.", "committedDate": "2020-11-27T13:09:06Z", "type": "commit"}, {"oid": "645608c7066c42dc5553cc868558633ecbda9605", "url": "https://github.com/futurewei-cloud/alcor/commit/645608c7066c42dc5553cc868558633ecbda9605", "message": "Enable port-level isFastPath client choice", "committedDate": "2020-11-29T08:22:36Z", "type": "commit"}, {"oid": "55a5ee27759124bee9664ef0973274089ed14d66", "url": "https://github.com/futurewei-cloud/alcor/commit/55a5ee27759124bee9664ef0973274089ed14d66", "message": "Encapsulate repeated code segments as a function", "committedDate": "2020-11-30T07:13:45Z", "type": "commit"}, {"oid": "d84f3db77cc453eea2412d4d6a929b0e0c752a38", "url": "https://github.com/futurewei-cloud/alcor/commit/d84f3db77cc453eea2412d4d6a929b0e0c752a38", "message": "Change function name", "committedDate": "2020-11-30T07:42:04Z", "type": "commit"}, {"oid": "e0882ced771d52990c5abaef53479906e109265a", "url": "https://github.com/futurewei-cloud/alcor/commit/e0882ced771d52990c5abaef53479906e109265a", "message": "Fix bugs", "committedDate": "2020-11-30T07:49:44Z", "type": "commit"}, {"oid": "3b1a466995636e0243d539e5bb0323a5d522a9d9", "url": "https://github.com/futurewei-cloud/alcor/commit/3b1a466995636e0243d539e5bb0323a5d522a9d9", "message": "Merge branch 'master' into dpm", "committedDate": "2020-11-30T07:53:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NjY0Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532786643", "bodyText": "Like this method abstraction and its renaming!", "author": "xieus", "createdAt": "2020-11-30T17:51:29Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java", "diffHunk": "@@ -517,24 +522,13 @@ private UnicastGoalState buildUnicastGoalState(NetworkConfiguration networkConfi\n         return unicastGoalState;\n     }\n \n-    private List<Map<String, List<GoalStateOperationStatus>>> createPortConfiguration(NetworkConfiguration networkConfig) throws Exception {\n+    private List<Map<String, List<GoalStateOperationStatus>>> doCreatePortConfiguration(NetworkConfiguration networkConfig,", "originalCommit": "3b1a466995636e0243d539e5bb0323a5d522a9d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxOTUyMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/481#discussion_r532819521", "bodyText": "@VanderChen I was wondering how the function-deploy.sh gets triggered.", "author": "xieus", "createdAt": "2020-11-30T18:45:31Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/pulsar/function/function-deploy.sh", "diffHunk": "@@ -0,0 +1,15 @@\n+pulsar-admin functions create \\\n+--jar target/dataplanemanager-0.1.0-SNAPSHOT.jar \\\n+--classname com.futurewei.alcor.dataplane.client.pulsar.function.UnicastFunction \\\n+--tenant public --namespace default \\\n+--name unicast-function \\\n+--inputs persistent://public/default/unicast-topic1 \\\n+--output persistent://public/default/group-topic1\n+\n+pulsar-admin functions create \\\n+--jar target/dataplanemanager-0.1.0-SNAPSHOT.jar \\\n+--classname com.futurewei.alcor.dataplane.client.pulsar.MulticastFunction \\\n+--tenant public --namespace default \\\n+--name multicast-function \\\n+--inputs persistent://public/default/multicast-topic1 \\\n+--output persistent://public/default/group-topic1", "originalCommit": "3b1a466995636e0243d539e5bb0323a5d522a9d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}