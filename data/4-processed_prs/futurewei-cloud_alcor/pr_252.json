{"pr_number": 252, "pr_title": "[AlcorLib] Support Multi-Params Query", "pr_createdAt": "2020-06-16T11:53:04Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/252", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDE2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r440800169", "bodyText": "What is the difference of ignite.Ignite and ignite.client.IgniteClient? Is it Ignite some sort of client?", "author": "xieus", "createdAt": "2020-06-16T12:09:11Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteCacheFactory.java", "diffHunk": "@@ -18,33 +18,35 @@\n \n import com.futurewei.alcor.common.db.ICache;\n import com.futurewei.alcor.common.db.ICacheFactory;\n-import org.apache.ignite.client.IgniteClient;\n+import org.apache.ignite.Ignite;\n+\n import javax.cache.expiry.CreatedExpiryPolicy;\n import javax.cache.expiry.Duration;\n import javax.cache.expiry.ExpiryPolicy;\n import java.util.concurrent.TimeUnit;\n \n public class IgniteCacheFactory implements ICacheFactory {\n \n-    private IgniteClient igniteClient;\n+    private Ignite ignite;", "originalCommit": "98436060d7b04dc990854daca20740d57537d1e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxNTIwNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r441315204", "bodyText": "@Gzure Could you think of renaming the class \"ignite.Ignite\" with more specific meaning, for example, IgniteXYZClient?", "author": "xieus", "createdAt": "2020-06-17T06:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5MzQ1Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r441393452", "bodyText": "Ignite.client.IgniteClient is a thin ignite client, about thin client https://www.gridgain.com/docs/latest/developers-guide/thin-clients/getting-started-with-thin-clients. A ignite. Ignite as an Ignite cluster node in client mode can support more functions than IgniteClient class, but it does not store data.", "author": "Gzure", "createdAt": "2020-06-17T09:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNzA4MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447417080", "bodyText": "Okay. Thanks.\nWe might need to consider:\n\nSlow client handling (ref: https://apacheignite.readme.io/docs/clients-vs-servers#managing-slow-clients).\nClient reconnect handling (ref: https://apacheignite.readme.io/docs/clients-vs-servers#reconnecting-a-client). This requires adding a special exception handling in the catch block.\nNumber of Ignite nodes in client mode. If the number goes large, it could affect the performance on the server side.", "author": "xieus", "createdAt": "2020-06-30T05:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDE2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3MTMwNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447471305", "bodyText": "ok", "author": "Gzure", "createdAt": "2020-06-30T07:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDE2OQ=="}], "type": "inlineReview"}, {"oid": "fa769da8a38285649cc0453e26337cca6a44ae17", "url": "https://github.com/futurewei-cloud/alcor/commit/fa769da8a38285649cc0453e26337cca6a44ae17", "message": "add multi params query support\nadd field filter support\nadd UTs skip init ignite client bean", "committedDate": "2020-06-22T02:58:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU5MzM3Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r446593377", "bodyText": "Since we have used Ignite instead of IgniteClient, the exceptions of cache operations should be modified accordingly.", "author": "chenpiaoping", "createdAt": "2020-06-28T03:06:43Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteDbCache.java", "diffHunk": "@@ -19,63 +19,64 @@\n import com.futurewei.alcor.common.db.CacheException;\n import com.futurewei.alcor.common.db.ICache;\n import com.futurewei.alcor.common.db.Transaction;\n+import com.futurewei.alcor.common.db.query.CachePredicate;\n+import com.futurewei.alcor.common.db.query.ScanQueryBuilder;\n+import com.futurewei.alcor.common.db.query.impl.MapPredicate;\n import com.futurewei.alcor.common.logging.Logger;\n import com.futurewei.alcor.common.logging.LoggerFactory;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.binary.BinaryObject;\n import org.apache.ignite.cache.query.Query;\n import org.apache.ignite.cache.query.QueryCursor;\n import org.apache.ignite.cache.query.ScanQuery;\n-import org.apache.ignite.client.ClientCache;\n-import org.apache.ignite.client.ClientCacheConfiguration;\n import org.apache.ignite.client.ClientException;\n-import org.apache.ignite.client.IgniteClient;\n import org.springframework.util.Assert;\n \n import javax.cache.Cache;\n import javax.cache.expiry.ExpiryPolicy;\n+import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n import java.util.logging.Level;\n import java.util.stream.Collectors;\n \n \n-public class IgniteCache<K, V> implements ICache<K, V> {\n+public class IgniteDbCache<K, V> implements ICache<K, V> {\n     private static final Logger logger = LoggerFactory.getLogger();\n-    private ClientCache<K, V> cache;\n-    private IgniteClient igniteClient;\n+\n+    private static final int RESULT_THRESHOLD_SIZE = 100000;\n+    private IgniteCache<K, V> cache;\n     private IgniteTransaction transaction;\n \n-    public IgniteCache(IgniteClient igniteClient, String name) {\n-        this.igniteClient = igniteClient;\n+    public IgniteDbCache(Ignite ignite, String name) {\n \n         try {\n-            cache = igniteClient.getOrCreateCache(name);\n+            cache = ignite.getOrCreateCache(name);\n         } catch (ClientException e) {", "originalCommit": "fa769da8a38285649cc0453e26337cca6a44ae17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU5NDk4OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r446594988", "bodyText": "How to ensure that there is only one result of the query? if so, is the getAll (CachePredicate < E1, E2 > cachePredicate) interface sufficient?", "author": "chenpiaoping", "createdAt": "2020-06-28T03:30:16Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteDbCache.java", "diffHunk": "@@ -142,6 +143,61 @@ public boolean remove(K key) throws CacheException {\n         }\n     }\n \n+    @Override\n+    public V get(Map<String, Object[]> filterParams) throws CacheException {\n+        CachePredicate<String, BinaryObject> predicate = MapPredicate.getInstance(filterParams);\n+        return get(predicate);\n+    }\n+\n+    @Override\n+    public <E1, E2> V get(CachePredicate<E1, E2> cachePredicate) throws CacheException {\n+        QueryCursor<Cache.Entry<E1, E2>> cursor =\n+                cache.withKeepBinary().query(ScanQueryBuilder.newScanQuery(cachePredicate));\n+        List<Cache.Entry<E1, E2>> result = cursor.getAll();\n+        if(result.size() > 1){\n+            throw new CacheException(\"more than one rows found!\");\n+        }\n+\n+        if(result.isEmpty()){\n+            return null;\n+        }\n+\n+        E2 obj = result.get(0).getValue();", "originalCommit": "fa769da8a38285649cc0453e26337cca6a44ae17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU5NTA5OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r446595099", "bodyText": "Let's delete useless import.", "author": "chenpiaoping", "createdAt": "2020-06-28T03:32:07Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/query/impl/MapPredicate.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.db.query.impl;\n+\n+import com.futurewei.alcor.common.db.query.CachePredicate;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.ignite.binary.BinaryObject;\n+import org.apache.ignite.cache.query.ScanQuery;", "originalCommit": "fa769da8a38285649cc0453e26337cca6a44ae17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7bf67abdc2e3ed4f451297dee78a353b7fddfc69", "url": "https://github.com/futurewei-cloud/alcor/commit/7bf67abdc2e3ed4f451297dee78a353b7fddfc69", "message": "fix vpc and subnet create post problem\nmake some api return value meet neutron api", "committedDate": "2020-06-29T07:49:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNjE5NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447406195", "bodyText": "Seems that we need to update the comments here.", "author": "xieus", "createdAt": "2020-06-30T04:45:07Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ICache.java", "diffHunk": "@@ -17,17 +17,57 @@\n package com.futurewei.alcor.common.db;\n \n \n+import com.futurewei.alcor.common.db.query.CachePredicate;\n+\n import java.util.Map;\n \n public interface ICache<K, V> {\n     V get(K var1) throws CacheException;\n \n+    /**\n+     * Get Cache value from cache db by multi params\n+     *\n+     * @param var1 the cache key", "originalCommit": "7bf67abdc2e3ed4f451297dee78a353b7fddfc69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzI1OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447407259", "bodyText": "Like it.", "author": "xieus", "createdAt": "2020-06-30T04:49:10Z", "path": "lib/src/test/java/com/futurewei/alcor/common/cache/ControllerUtilTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.cache;\n+\n+import com.futurewei.alcor.common.cache.entity.TestEntity;\n+import com.futurewei.alcor.common.exception.QueryParamTypeNotSupportException;\n+import com.futurewei.alcor.common.utils.ControllerUtil;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.annotation.Annotation;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class ControllerUtilTest {\n+\n+    @Test\n+    public void transformUrlPathParamsTest() throws QueryParamTypeNotSupportException {", "originalCommit": "7bf67abdc2e3ed4f451297dee78a353b7fddfc69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzY3Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447407676", "bodyText": "duplicated issue or merge issue?", "author": "xieus", "createdAt": "2020-06-30T04:50:34Z", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/filter/KeystoneConfiguration.java", "diffHunk": "@@ -34,14 +34,22 @@\n     @Autowired\n     private CacheFactory cacheFactory;\n \n-    @Bean\n+    //@Bean\n     public KeystoneAuthWebFilter keystoneAuthWebFilter(){\n         if(!keystoneEnable){\n             return null;\n         }\n         return new KeystoneAuthWebFilter();\n     }\n \n+    @Bean\n+    public KeystoneAuthGwFilter keystoneAuthGwFilter(){\n+        if(!keystoneEnable){\n+            return null;\n+        }\n+        return new KeystoneAuthGwFilter();\n+    }", "originalCommit": "7bf67abdc2e3ed4f451297dee78a353b7fddfc69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzMzk5NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447433995", "bodyText": "They are different filter. KeystoneAuthGwFilter is used for Spring Gateway. KeystoneAuthWebFilter is used for Webflux filter.\nSince webflux is now replaced with spring gateway, KeystoneAuthWebFilteris no longer useful\u3002", "author": "Gzure", "createdAt": "2020-06-30T06:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzY3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxNjU0MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r447716541", "bodyText": "I see. Thanks for the clarification.", "author": "xieus", "createdAt": "2020-06-30T14:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQwNzY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MDU3MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448070571", "bodyText": "This class depends on ignite.\nShould it be put in the ignite directory?", "author": "chenpiaoping", "createdAt": "2020-07-01T01:46:44Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/query/ScanQueryBuilder.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.db.query;\n+\n+import org.apache.ignite.cache.query.ScanQuery;\n+\n+public class ScanQueryBuilder {", "originalCommit": "6dd6d31c98c5d64b7d5573efa5061b1837bb2eda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MDg2Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448070867", "bodyText": "This class depends on ignite. should it be put in the ignite directory?", "author": "chenpiaoping", "createdAt": "2020-07-01T01:48:01Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/query/impl/MapPredicate.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.db.query.impl;\n+\n+import com.futurewei.alcor.common.db.query.CachePredicate;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.ignite.binary.BinaryObject;\n+import org.apache.ignite.cache.query.ScanQuery;\n+\n+import java.util.Map;\n+\n+\n+public class MapPredicate implements CachePredicate<String, BinaryObject> {", "originalCommit": "6dd6d31c98c5d64b7d5573efa5061b1837bb2eda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NDYxNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448074614", "bodyText": "There is still ClientException in the constructor.", "author": "chenpiaoping", "createdAt": "2020-07-01T02:03:00Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteDbCache.java", "diffHunk": "@@ -83,7 +85,7 @@ public IgniteDbCache(Ignite client, String name, ExpiryPolicy ep) {\n     public V get(K key) throws CacheException {\n         try {\n             return cache.get(key);\n-        } catch (ClientException e) {\n+        } catch (IgniteException e) {", "originalCommit": "1918bd9657b223c1c7f43ece2cd4be950ded0679", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3Nzc5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448077792", "bodyText": "If an exception is not thrown here, subsequent cache operations (for example: cache.put()) may cause null pointer exceptions. This Modification may cause all microservices to be changed, and the priority can be lowered.", "author": "chenpiaoping", "createdAt": "2020-07-01T02:15:38Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteDbCache.java", "diffHunk": "@@ -19,63 +19,64 @@\n import com.futurewei.alcor.common.db.CacheException;\n import com.futurewei.alcor.common.db.ICache;\n import com.futurewei.alcor.common.db.Transaction;\n+import com.futurewei.alcor.common.db.query.CachePredicate;\n+import com.futurewei.alcor.common.db.query.ScanQueryBuilder;\n+import com.futurewei.alcor.common.db.query.impl.MapPredicate;\n import com.futurewei.alcor.common.logging.Logger;\n import com.futurewei.alcor.common.logging.LoggerFactory;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.binary.BinaryObject;\n import org.apache.ignite.cache.query.Query;\n import org.apache.ignite.cache.query.QueryCursor;\n import org.apache.ignite.cache.query.ScanQuery;\n-import org.apache.ignite.client.ClientCache;\n-import org.apache.ignite.client.ClientCacheConfiguration;\n import org.apache.ignite.client.ClientException;\n-import org.apache.ignite.client.IgniteClient;\n import org.springframework.util.Assert;\n \n import javax.cache.Cache;\n import javax.cache.expiry.ExpiryPolicy;\n+import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n import java.util.logging.Level;\n import java.util.stream.Collectors;\n \n \n-public class IgniteCache<K, V> implements ICache<K, V> {\n+public class IgniteDbCache<K, V> implements ICache<K, V> {\n     private static final Logger logger = LoggerFactory.getLogger();\n-    private ClientCache<K, V> cache;\n-    private IgniteClient igniteClient;\n+\n+    private static final int RESULT_THRESHOLD_SIZE = 100000;\n+    private IgniteCache<K, V> cache;\n     private IgniteTransaction transaction;\n \n-    public IgniteCache(IgniteClient igniteClient, String name) {\n-        this.igniteClient = igniteClient;\n+    public IgniteDbCache(Ignite ignite, String name) {\n \n         try {\n-            cache = igniteClient.getOrCreateCache(name);\n+            cache = ignite.getOrCreateCache(name);\n         } catch (ClientException e) {\n             logger.log(Level.WARNING, \"Create cache for client \" + name + \" failed:\" + e.getMessage());\n         } catch (Exception e) {\n             logger.log(Level.WARNING, \"Unexpected failure:\" + e.getMessage());", "originalCommit": "6dd6d31c98c5d64b7d5573efa5061b1837bb2eda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c14d746fb5826f2e54d182f7efa863a98a6316c3", "url": "https://github.com/futurewei-cloud/alcor/commit/c14d746fb5826f2e54d182f7efa863a98a6316c3", "message": "add ignite thin client and rewrite some db interfaces", "committedDate": "2020-07-02T01:36:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MjEwMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448782103", "bodyText": "Do we still need throws CacheException here?", "author": "chenpiaoping", "createdAt": "2020-07-02T06:45:08Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteTransaction.java", "diffHunk": "@@ -33,55 +31,43 @@\n public class IgniteTransaction implements Transaction {\n     private static final Logger logger = LoggerFactory.getLogger();\n \n-    private IgniteClient igniteClient;\n-    private ClientTransaction clientTransaction;\n+    private final Ignite client;\n+    private org.apache.ignite.transactions.Transaction transaction;\n \n-    public IgniteTransaction(IgniteClient igniteClient) {\n-        this.igniteClient = igniteClient;\n+    public IgniteTransaction(Ignite client) {\n+        this.client = client;\n     }\n \n+    @Override\n     public Transaction start() throws CacheException {", "originalCommit": "c14d746fb5826f2e54d182f7efa863a98a6316c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgxMDQ3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448810473", "bodyText": "IgniteClienTransaction need", "author": "Gzure", "createdAt": "2020-07-02T07:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MjEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MjY2Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448782663", "bodyText": "May need to catch IgniteException here.", "author": "chenpiaoping", "createdAt": "2020-07-02T06:46:25Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteTransaction.java", "diffHunk": "@@ -33,55 +31,43 @@\n public class IgniteTransaction implements Transaction {\n     private static final Logger logger = LoggerFactory.getLogger();\n \n-    private IgniteClient igniteClient;\n-    private ClientTransaction clientTransaction;\n+    private final Ignite client;\n+    private org.apache.ignite.transactions.Transaction transaction;\n \n-    public IgniteTransaction(IgniteClient igniteClient) {\n-        this.igniteClient = igniteClient;\n+    public IgniteTransaction(Ignite client) {\n+        this.client = client;\n     }\n \n+    @Override\n     public Transaction start() throws CacheException {\n-        try {\n-            clientTransaction = igniteClient.transactions().txStart(PESSIMISTIC, SERIALIZABLE);\n-        } catch (ClientServerError e) {\n-            logger.log(Level.WARNING, \"IgniteTransaction start error:\" + e.getMessage());\n-            throw new CacheException(e.getMessage());\n-        } catch (ClientException e) {\n-            logger.log(Level.WARNING, \"IgniteTransaction start error:\" + e.getMessage());\n-            throw new CacheException(e.getMessage());\n-        }\n-\n+        transaction = client.transactions().txStart(PESSIMISTIC, SERIALIZABLE);\n         return this;\n     }\n \n+    @Override\n     public void commit() throws CacheException {\n         try {\n-            clientTransaction.commit();\n-        } catch (ClientServerError e) {\n-            logger.log(Level.WARNING, \"IgniteTransaction commit error:\" + e.getMessage());\n-            throw new CacheException(e.getMessage());\n-        } catch (ClientException e) {\n+            transaction.commit();\n+        } catch (IgniteException e) {\n             logger.log(Level.WARNING, \"IgniteTransaction commit error:\" + e.getMessage());\n             throw new CacheException(e.getMessage());\n         }\n     }\n \n+    @Override\n     public void rollback() throws CacheException {\n         try {\n-            clientTransaction.rollback();\n-        } catch (ClientServerError e) {\n-            logger.log(Level.WARNING, \"IgniteTransaction rollback error:\" + e.getMessage());\n-            throw new CacheException(e.getMessage());\n-        } catch (ClientException e) {\n+            transaction.rollback();\n+        } catch (IgniteException e) {\n             logger.log(Level.WARNING, \"IgniteTransaction rollback error:\" + e.getMessage());\n             throw new CacheException(e.getMessage());\n         }\n     }\n \n     @Override\n     public void close() {\n-        if (clientTransaction != null) {\n-            clientTransaction.close();\n+        if (transaction != null) {\n+            transaction.close();", "originalCommit": "c14d746fb5826f2e54d182f7efa863a98a6316c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NDk3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r448784975", "bodyText": "Should there be no iginte-related information in redis?", "author": "chenpiaoping", "createdAt": "2020-07-02T06:51:39Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/redis/RedisExpireCache.java", "diffHunk": "@@ -113,6 +114,26 @@ public boolean remove(K key) throws CacheException {\n         }\n     }\n \n+    @Override\n+    public V get(Map<String, Object[]> filterParams) throws CacheException {\n+        return null;\n+    }\n+\n+    @Override\n+    public <E1, E2> V get(IgniteBiPredicate<E1, E2> igniteBiPredicate) throws CacheException {\n+        return null;\n+    }\n+\n+    @Override\n+    public <E1, E2> Map<K, V> getAll(Map<String, Object[]> filterParams) throws CacheException {\n+        return null;\n+    }\n+\n+    @Override\n+    public <E1, E2> Map<K, V> getAll(IgniteBiPredicate<E1, E2> igniteBiPredicate) throws CacheException {", "originalCommit": "c14d746fb5826f2e54d182f7efa863a98a6316c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyNzgxOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r449327818", "bodyText": "@Gzure Should Ignitetransaction also support IgniteClient based on the setting?\nThis is non-blocking. If we do need that, we can do it next PR.", "author": "xieus", "createdAt": "2020-07-03T01:00:42Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteTransaction.java", "diffHunk": "@@ -33,55 +31,48 @@\n public class IgniteTransaction implements Transaction {\n     private static final Logger logger = LoggerFactory.getLogger();\n \n-    private IgniteClient igniteClient;\n-    private ClientTransaction clientTransaction;\n+    private final Ignite client;", "originalCommit": "de99e62709d42f996eae5d9a64fcde19d7aab57d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMzMjk0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r449332944", "bodyText": "@Gzure Should Ignitetransaction also support IgniteClient based on the setting?\nThis is non-blocking. If we do need that, we can do it next PR.\n\nI had added a IgniteClientTransaction which according to Ignite thin client", "author": "Gzure", "createdAt": "2020-07-03T01:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyNzgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyODM4NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r449328385", "bodyText": "In our MockIgniteServer, do we need to test both IgniteClient and Ignite?", "author": "xieus", "createdAt": "2020-07-03T01:03:26Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/MockIgniteServer.java", "diffHunk": "@@ -16,26 +16,45 @@\n package com.futurewei.alcor.common.db.ignite;\n \n import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.Ignition;\n-import org.apache.ignite.configuration.ClientConnectorConfiguration;\n+import org.apache.ignite.internal.IgniteKernal;\n+import org.apache.ignite.internal.processors.cache.IgniteCacheProxyImpl;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n import org.junit.AfterClass;\n import org.junit.BeforeClass;\n \n+import java.util.Collections;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+\n \n public class MockIgniteServer {\n+\n+    private static final String LOCAL_ADDRESS = \"127.0.0.1\";\n+    private static final int LISTEN_PORT = 11801;\n+    private static final int LISTEN_PORT_RANGE = 10;\n+\n     private static Ignite igniteServer = null;\n-    private static int ListenPort = 10801;\n \n     @BeforeClass\n     public static void init() {\n         if (igniteServer == null) {\n             try {\n-                ClientConnectorConfiguration clientConfig = new ClientConnectorConfiguration();\n-                clientConfig.setPort(ListenPort);\n-\n                 org.apache.ignite.configuration.IgniteConfiguration cfg = new org.apache.ignite.configuration.IgniteConfiguration();", "originalCommit": "de99e62709d42f996eae5d9a64fcde19d7aab57d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMzMDQyNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/252#discussion_r449330425", "bodyText": "If not that in use anyway, we can consider deprecate then remove them", "author": "xieus", "createdAt": "2020-07-03T01:13:08Z", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/proxies/SubnetManagerServiceProxy.java", "diffHunk": "@@ -28,7 +28,7 @@\n \n import java.util.UUID;\n \n-@Service\n+//@Service", "originalCommit": "de99e62709d42f996eae5d9a64fcde19d7aab57d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90d19e42a375751898b25fb667ad6515ddf5ea9d", "url": "https://github.com/futurewei-cloud/alcor/commit/90d19e42a375751898b25fb667ad6515ddf5ea9d", "message": "add multi params query support\nadd field filter support\nadd UTs skip init ignite client bean", "committedDate": "2020-07-03T02:12:12Z", "type": "commit"}, {"oid": "f02e022199cb73c403de410ef0f8c92cf3099d59", "url": "https://github.com/futurewei-cloud/alcor/commit/f02e022199cb73c403de410ef0f8c92cf3099d59", "message": "add handle default value handle", "committedDate": "2020-07-03T02:12:12Z", "type": "commit"}, {"oid": "a9da2521addd2aa7c25d98f2a16d849f172b0575", "url": "https://github.com/futurewei-cloud/alcor/commit/a9da2521addd2aa7c25d98f2a16d849f172b0575", "message": "rename dhcp_enable to enable_dhcp", "committedDate": "2020-07-03T02:12:12Z", "type": "commit"}, {"oid": "ddc3f668a0d3aa75bbe8c1acdc475e7533825865", "url": "https://github.com/futurewei-cloud/alcor/commit/ddc3f668a0d3aa75bbe8c1acdc475e7533825865", "message": "remove some check in update subnet", "committedDate": "2020-07-03T02:12:12Z", "type": "commit"}, {"oid": "c2ee7733a69a7ea4eddcc179b4d82bd9e1202874", "url": "https://github.com/futurewei-cloud/alcor/commit/c2ee7733a69a7ea4eddcc179b4d82bd9e1202874", "message": "change return type to PortWebBulkJson", "committedDate": "2020-07-03T02:12:12Z", "type": "commit"}, {"oid": "35a0b2fbb9fabdbc39d903f5a5036d77280d7994", "url": "https://github.com/futurewei-cloud/alcor/commit/35a0b2fbb9fabdbc39d903f5a5036d77280d7994", "message": "change return type to VpcsWebJson", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "9f59fcc1b0a257bb69dc628068ba50648577bf3c", "url": "https://github.com/futurewei-cloud/alcor/commit/9f59fcc1b0a257bb69dc628068ba50648577bf3c", "message": "change vpcs to networks", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "a43bd28fc5ab20522df89fc7cd42164e43741544", "url": "https://github.com/futurewei-cloud/alcor/commit/a43bd28fc5ab20522df89fc7cd42164e43741544", "message": "change webflux to spring gateway and add port route defines", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "0044a1feb058a6283ab91b496f9946c6faea3876", "url": "https://github.com/futurewei-cloud/alcor/commit/0044a1feb058a6283ab91b496f9946c6faea3876", "message": "change ClientException to IgniteException", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "60cd4df20820e387c7e6045efc96e45ef7107b64", "url": "https://github.com/futurewei-cloud/alcor/commit/60cd4df20820e387c7e6045efc96e45ef7107b64", "message": "rewrite test unit and remove some beans", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "f1426628c07f612a9350b13c0a29b1f25f1edb20", "url": "https://github.com/futurewei-cloud/alcor/commit/f1426628c07f612a9350b13c0a29b1f25f1edb20", "message": "fix vpc and subnet create post problem\nmake some api return value meet neutron api", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "2f81529010c96cec998956cdf210221deb6be104", "url": "https://github.com/futurewei-cloud/alcor/commit/2f81529010c96cec998956cdf210221deb6be104", "message": "add securityGroup route in API Gateway", "committedDate": "2020-07-03T02:12:13Z", "type": "commit"}, {"oid": "1df69df0851cbadb297ce66c4edfc65ba94794f1", "url": "https://github.com/futurewei-cloud/alcor/commit/1df69df0851cbadb297ce66c4edfc65ba94794f1", "message": "support return both project_id and tenant_id", "committedDate": "2020-07-03T02:14:23Z", "type": "commit"}, {"oid": "2296ca2eca38ef1381d9c339127043e5a4b6d160", "url": "https://github.com/futurewei-cloud/alcor/commit/2296ca2eca38ef1381d9c339127043e5a4b6d160", "message": "add ignite thin client and rewrite some db interfaces", "committedDate": "2020-07-03T02:14:29Z", "type": "commit"}, {"oid": "ca8a57a8ea99748de3f5a0f2642c9aadaa6d887e", "url": "https://github.com/futurewei-cloud/alcor/commit/ca8a57a8ea99748de3f5a0f2642c9aadaa6d887e", "message": "add new interface IgniteICache extends ICache", "committedDate": "2020-07-03T02:14:29Z", "type": "commit"}, {"oid": "bc42ef24afe7486aa4da13c04bacf5edd3cdee31", "url": "https://github.com/futurewei-cloud/alcor/commit/bc42ef24afe7486aa4da13c04bacf5edd3cdee31", "message": "add some Exception handle in ignite Transaction class", "committedDate": "2020-07-03T02:14:29Z", "type": "commit"}, {"oid": "bc42ef24afe7486aa4da13c04bacf5edd3cdee31", "url": "https://github.com/futurewei-cloud/alcor/commit/bc42ef24afe7486aa4da13c04bacf5edd3cdee31", "message": "add some Exception handle in ignite Transaction class", "committedDate": "2020-07-03T02:14:29Z", "type": "forcePushed"}, {"oid": "0af4b61eca68635a6ca5a0dd1b242c40bbd22939", "url": "https://github.com/futurewei-cloud/alcor/commit/0af4b61eca68635a6ca5a0dd1b242c40bbd22939", "message": "merge with master", "committedDate": "2020-07-03T02:31:38Z", "type": "commit"}]}