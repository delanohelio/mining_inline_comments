{"pr_number": 340, "pr_title": "[Node Mgr] Support Bulk Node Registration and Fix Upload API", "pr_createdAt": "2020-08-04T00:42:22Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/340", "timeline": [{"oid": "d7994849a780cc720859cc22e2381cbc4640e676", "url": "https://github.com/futurewei-cloud/alcor/commit/d7994849a780cc720859cc22e2381cbc4640e676", "message": "add bulk node create", "committedDate": "2020-08-04T00:41:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczNTI1Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r464735256", "bodyText": "upload?", "author": "xieus", "createdAt": "2020-08-04T00:44:12Z", "path": "services/node_manager/src/main/java/com/futurewei/alcor/nodemanager/controller/NodeController.java", "diffHunk": "@@ -49,7 +54,22 @@\n \n     @RequestMapping(\n             method = POST,\n-            value = {\"/nodes/upload\", \"/v4/nodes/upload\"})\n+            value = {\"/bulk/nodes\", \"/v4/bulk/nodes\"})", "originalCommit": "d7994849a780cc720859cc22e2381cbc4640e676", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0Mjg0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r464742844", "bodyText": "changed in ac81684", "author": "haboy52581", "createdAt": "2020-08-04T01:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczNTI1Ng=="}], "type": "inlineReview"}, {"oid": "ac816841a996400233480dc329debf09b660d3e5", "url": "https://github.com/futurewei-cloud/alcor/commit/ac816841a996400233480dc329debf09b660d3e5", "message": "change method declaration", "committedDate": "2020-08-04T00:54:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5ODE2MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r464798161", "bodyText": "Why do we want to throw an exception about \"empty file\" here?", "author": "xieus", "createdAt": "2020-08-04T04:53:03Z", "path": "services/node_manager/src/main/java/com/futurewei/alcor/nodemanager/controller/NodeController.java", "diffHunk": "@@ -24,29 +24,49 @@\n import com.futurewei.alcor.nodemanager.service.NodeService;\n import com.futurewei.alcor.nodemanager.utils.NodeManagerConstant;\n import com.futurewei.alcor.common.utils.RestPreconditionsUtil;\n+import com.futurewei.alcor.web.entity.node.BulkNodeInfoJson;\n import com.futurewei.alcor.web.json.annotation.FieldFilter;\n import io.swagger.annotations.ApiParam;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpStatus;\n import org.springframework.web.bind.annotation.*;\n import org.springframework.web.multipart.MultipartFile;\n+import com.futurewei.alcor.common.logging.Logger;\n+import com.futurewei.alcor.common.logging.LoggerFactory;\n \n import javax.servlet.http.HttpServletRequest;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n+import java.util.logging.Level;\n \n import static org.springframework.web.bind.annotation.RequestMethod.*;\n \n @RestController\n public class NodeController {\n+    private static final Logger LOG = LoggerFactory.getLogger();\n \n     @Autowired\n     private NodeService service;\n \n     @Autowired\n     private HttpServletRequest request;\n \n+    @RequestMapping(\n+            method = POST,\n+            value = {\"/bulk/nodes\", \"/v4/bulk/nodes\"})\n+    public List<NodeInfo> registerNodesInfoBulk(@RequestBody BulkNodeInfoJson resource) throws Exception {\n+        if (resource == null) {\n+            throw new ParameterNullOrEmptyException(NodeManagerConstant.NODE_EXCEPTION_FILE_EMPTY);", "originalCommit": "ac816841a996400233480dc329debf09b660d3e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5ODkwOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r464798908", "bodyText": "The bulk creation chooses a key \"host_infos\", which is different from the /upload API, it is for our own benefits to choose the same key for both APIs, either \"host_infos\" or \"Hosts\".", "author": "xieus", "createdAt": "2020-08-04T04:55:45Z", "path": "web/src/main/java/com/futurewei/alcor/web/entity/node/BulkNodeInfoJson.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package com.futurewei.alcor.web.entity.node;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.futurewei.alcor.web.entity.NodeInfo;\n+\n+import java.util.List;\n+\n+public class BulkNodeInfoJson {\n+  @JsonProperty(\"host_infos\")", "originalCommit": "ac816841a996400233480dc329debf09b660d3e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzY4MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r466067681", "bodyText": "Checking this comment", "author": "xieus", "createdAt": "2020-08-05T23:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5ODkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI0NjE2OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468246168", "bodyText": "fixed in 339c752", "author": "haboy52581", "createdAt": "2020-08-10T23:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5ODkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyNzI1MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r464827250", "bodyText": "Can you add a UT to cover the new /bulk/nodes API? Also, the /upload appears to be problematic. It will be nice to fix them all together.", "author": "xieus", "createdAt": "2020-08-04T06:28:27Z", "path": "services/node_manager/src/main/java/com/futurewei/alcor/nodemanager/controller/NodeController.java", "diffHunk": "@@ -24,29 +24,49 @@\n import com.futurewei.alcor.nodemanager.service.NodeService;\n import com.futurewei.alcor.nodemanager.utils.NodeManagerConstant;\n import com.futurewei.alcor.common.utils.RestPreconditionsUtil;\n+import com.futurewei.alcor.web.entity.node.BulkNodeInfoJson;\n import com.futurewei.alcor.web.json.annotation.FieldFilter;\n import io.swagger.annotations.ApiParam;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpStatus;\n import org.springframework.web.bind.annotation.*;\n import org.springframework.web.multipart.MultipartFile;\n+import com.futurewei.alcor.common.logging.Logger;\n+import com.futurewei.alcor.common.logging.LoggerFactory;\n \n import javax.servlet.http.HttpServletRequest;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n+import java.util.logging.Level;\n \n import static org.springframework.web.bind.annotation.RequestMethod.*;\n \n @RestController\n public class NodeController {\n+    private static final Logger LOG = LoggerFactory.getLogger();\n \n     @Autowired\n     private NodeService service;\n \n     @Autowired\n     private HttpServletRequest request;\n \n+    @RequestMapping(\n+            method = POST,\n+            value = {\"/bulk/nodes\", \"/v4/bulk/nodes\"})\n+    public List<NodeInfo> registerNodesInfoBulk(@RequestBody BulkNodeInfoJson resource) throws Exception {\n+        if (resource == null) {\n+            throw new ParameterNullOrEmptyException(NodeManagerConstant.NODE_EXCEPTION_FILE_EMPTY);\n+        }\n+        try {\n+            return service.createNodeInfoBulk(resource.getNodeInfos());\n+        } catch (Exception e) {\n+            LOG.log(Level.SEVERE,e.getMessage());\n+            throw e;\n+        }\n+    }\n+\n     @RequestMapping(", "originalCommit": "ac816841a996400233480dc329debf09b660d3e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMDczNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r466030736", "bodyText": "fixed in 72508 for adding UT", "author": "haboy52581", "createdAt": "2020-08-05T22:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyNzI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MDc4Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r466060782", "bodyText": "Thanks. Can you please check the /upload UT and fix it if needed?", "author": "xieus", "createdAt": "2020-08-05T23:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyNzI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI0NjA1OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468246058", "bodyText": "fixed in 339c752", "author": "haboy52581", "createdAt": "2020-08-10T23:46:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyNzI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk2MTMxNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r465961314", "bodyText": "Could you please check API name?  \"/bulk/nodes\"? or \"/nodes/bulk\"\nAPI naming convention was:\n/module_name (e.g. \"nodes\" for node manage\")/api_name (\"bulk\")", "author": "kimeunju108", "createdAt": "2020-08-05T19:43:51Z", "path": "services/node_manager/src/main/java/com/futurewei/alcor/nodemanager/controller/NodeController.java", "diffHunk": "@@ -49,7 +54,22 @@\n \n     @RequestMapping(\n             method = POST,\n-            value = {\"/nodes/upload\", \"/v4/nodes/upload\"})\n+            value = {\"/bulk/nodes\", \"/v4/bulk/nodes\"})\n+    public List<NodeInfo> registerNodesInfoBulk(@RequestBody BulkNodeInfoJson resource) throws Exception {\n+        if (resource == null) {\n+            throw new ParameterNullOrEmptyException(NodeManagerConstant.NODE_EXCEPTION_FILE_EMPTY);\n+        }\n+        try {\n+            return service.createNodeInfoBulk(resource.getNodeInfos());\n+        } catch (Exception e) {\n+            LOG.log(Level.SEVERE,e.getMessage());\n+            throw e;\n+        }\n+    }\n+\n+    @RequestMapping(\n+            method = POST,\n+            value = {\"/bulk/nodes\", \"/v4/bulk/nodes\"})", "originalCommit": "d7994849a780cc720859cc22e2381cbc4640e676", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "725081fa19340150514d578e9a751f4d07f0dcf0", "url": "https://github.com/futurewei-cloud/alcor/commit/725081fa19340150514d578e9a751f4d07f0dcf0", "message": "address points in pr340", "committedDate": "2020-08-05T22:02:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzAxMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r466067013", "bodyText": "Assertion to ensure the same size is necessary.\nWe also need to check other fields, including the key and value.", "author": "xieus", "createdAt": "2020-08-05T23:54:23Z", "path": "services/node_manager/src/test/java/com/futurewei/alcor/nodemanager/controller/NodeControllerTest.java", "diffHunk": "@@ -275,4 +281,16 @@ public void deleteNodeInfo_invalidId() throws Exception {\n             assertTrue(e.getCause().getClass().getSimpleName().contains(\"ParameterNullOrEmptyException\"));\n         }\n     }\n+\n+    @Test\n+    public void testNodeBulkRegistration() throws Exception {\n+        Gson gson=new Gson();\n+        String input =\n+        \"{\\\"nodeInfos\\\":[{\\\"id\\\":\\\"c2b79aca-316e-4ce8-a8ac-815e2de1f129\\\",\\\"name\\\":\\\"compute9\\\",\\\"localIp\\\":\\\"10.213.43.150\\\",\\\"macAddress\\\":\\\"90:17:ac:c1:34:5d\\\",\\\"veth\\\":\\\"eth1\\\",\\\"gRPCServerPort\\\":8080},{\\\"id\\\":\\\"c2b79aca-316e-4ce8-a8ac-815e2de1f120\\\",\\\"name\\\":\\\"compute10\\\",\\\"localIp\\\":\\\"10.213.43.151\\\",\\\"macAddress\\\":\\\"90:17:ac:c1:34:5e\\\",\\\"veth\\\":\\\"eth1\\\",\\\"gRPCServerPort\\\":8080}]}\";\n+        BulkNodeInfoJson bulkNodeInfoJson = gson.fromJson(input, BulkNodeInfoJson.class);\n+\n+        assertEquals(", "originalCommit": "725081fa19340150514d578e9a751f4d07f0dcf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI0NTk5NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468245994", "bodyText": "fixed in 339c752", "author": "haboy52581", "createdAt": "2020-08-10T23:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzM0MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r466067341", "bodyText": "should the key be \"host_infos\" or \"nodeInfos\"?", "author": "xieus", "createdAt": "2020-08-05T23:55:29Z", "path": "services/node_manager/src/test/java/com/futurewei/alcor/nodemanager/controller/NodeControllerTest.java", "diffHunk": "@@ -275,4 +281,16 @@ public void deleteNodeInfo_invalidId() throws Exception {\n             assertTrue(e.getCause().getClass().getSimpleName().contains(\"ParameterNullOrEmptyException\"));\n         }\n     }\n+\n+    @Test\n+    public void testNodeBulkRegistration() throws Exception {\n+        Gson gson=new Gson();\n+        String input =\n+        \"{\\\"nodeInfos\\\":[{\\\"id\\\":\\\"c2b79aca-316e-4ce8-a8ac-815e2de1f129\\\",\\\"name\\\":\\\"compute9\\\",\\\"localIp\\\":\\\"10.213.43.150\\\",\\\"macAddress\\\":\\\"90:17:ac:c1:34:5d\\\",\\\"veth\\\":\\\"eth1\\\",\\\"gRPCServerPort\\\":8080},{\\\"id\\\":\\\"c2b79aca-316e-4ce8-a8ac-815e2de1f120\\\",\\\"name\\\":\\\"compute10\\\",\\\"localIp\\\":\\\"10.213.43.151\\\",\\\"macAddress\\\":\\\"90:17:ac:c1:34:5e\\\",\\\"veth\\\":\\\"eth1\\\",\\\"gRPCServerPort\\\":8080}]}\";", "originalCommit": "725081fa19340150514d578e9a751f4d07f0dcf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI0NTg0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468245845", "bodyText": "use former one, fixed in 339c752", "author": "haboy52581", "createdAt": "2020-08-10T23:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzM0MQ=="}], "type": "inlineReview"}, {"oid": "17a1705112ea20d89b901d1e47afacc1a09cf015", "url": "https://github.com/futurewei-cloud/alcor/commit/17a1705112ea20d89b901d1e47afacc1a09cf015", "message": "fix issue 349 and 303", "committedDate": "2020-08-10T23:35:45Z", "type": "commit"}, {"oid": "339c752874e1e1d3ca22bbe04a3d6a83141231f0", "url": "https://github.com/futurewei-cloud/alcor/commit/339c752874e1e1d3ca22bbe04a3d6a83141231f0", "message": "comment out failure tests", "committedDate": "2020-08-10T23:44:59Z", "type": "commit"}, {"oid": "99d2497c0df65ce97211936ab8f3d3cf4e9bdb9e", "url": "https://github.com/futurewei-cloud/alcor/commit/99d2497c0df65ce97211936ab8f3d3cf4e9bdb9e", "message": "fix all test case failures", "committedDate": "2020-08-11T03:09:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMwODQ3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468308475", "bodyText": "Pls remove two extra lines.", "author": "xieus", "createdAt": "2020-08-11T03:42:18Z", "path": "services/node_manager/src/main/java/com/futurewei/alcor/nodemanager/service/implement/NodeServiceImpl.java", "diffHunk": "@@ -42,6 +42,8 @@\n     @Autowired\n     private NodeRepository nodeRepository;\n \n+", "originalCommit": "99d2497c0df65ce97211936ab8f3d3cf4e9bdb9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM0NjQ3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/340#discussion_r468346473", "bodyText": "fixed in 533e6", "author": "haboy52581", "createdAt": "2020-08-11T06:06:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMwODQ3NQ=="}], "type": "inlineReview"}, {"oid": "7960e54039bca2e5d3d8cd98ea98b7674a377542", "url": "https://github.com/futurewei-cloud/alcor/commit/7960e54039bca2e5d3d8cd98ea98b7674a377542", "message": "fix mac issue", "committedDate": "2020-08-11T05:38:23Z", "type": "commit"}, {"oid": "daa5bddd96d05b36da854e1585ae3d8c1e93f90c", "url": "https://github.com/futurewei-cloud/alcor/commit/daa5bddd96d05b36da854e1585ae3d8c1e93f90c", "message": "fix conflict", "committedDate": "2020-08-11T05:40:08Z", "type": "commit"}, {"oid": "533e69251e1791f34cb33362e51c517dc86e85cb", "url": "https://github.com/futurewei-cloud/alcor/commit/533e69251e1791f34cb33362e51c517dc86e85cb", "message": "fix compilation issue", "committedDate": "2020-08-11T06:06:16Z", "type": "commit"}, {"oid": "2d8ea2d668b2ebe7e48b99e5f7a558b8dfdf2022", "url": "https://github.com/futurewei-cloud/alcor/commit/2d8ea2d668b2ebe7e48b99e5f7a558b8dfdf2022", "message": "merge master and fix conflicts", "committedDate": "2020-08-11T06:19:10Z", "type": "commit"}, {"oid": "377d162b5688f90eb77583a186784036129152a6", "url": "https://github.com/futurewei-cloud/alcor/commit/377d162b5688f90eb77583a186784036129152a6", "message": "fix conflicts", "committedDate": "2020-08-11T06:23:55Z", "type": "commit"}, {"oid": "07d1d9311d1e580e556ebdaa211cd087860793d9", "url": "https://github.com/futurewei-cloud/alcor/commit/07d1d9311d1e580e556ebdaa211cd087860793d9", "message": "remove useless", "committedDate": "2020-08-11T08:11:58Z", "type": "commit"}, {"oid": "0ce069df62a734a18da0dbf54a10354ac58d946f", "url": "https://github.com/futurewei-cloud/alcor/commit/0ce069df62a734a18da0dbf54a10354ac58d946f", "message": "fix the CI timeout issue", "committedDate": "2020-08-11T22:23:18Z", "type": "commit"}]}