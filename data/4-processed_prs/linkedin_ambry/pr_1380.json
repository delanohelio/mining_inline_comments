{"pr_number": 1380, "pr_title": "Add precondition to metadata updates to fail on conflicts", "pr_createdAt": "2020-02-10T21:41:26Z", "pr_url": "https://github.com/linkedin/ambry/pull/1380", "timeline": [{"oid": "0ed22a5d7e558c783f6de6607f5fb3d4cc925abb", "url": "https://github.com/linkedin/ambry/commit/0ed22a5d7e558c783f6de6607f5fb3d4cc925abb", "message": "Add precondition to metadata updates to fail on conflicts", "committedDate": "2020-02-10T21:26:36Z", "type": "commit"}, {"oid": "f55f2ea56e4e82df4d5d1fc6c8c071f629b4e1cb", "url": "https://github.com/linkedin/ambry/commit/f55f2ea56e4e82df4d5d1fc6c8c071f629b4e1cb", "message": "Merge branch 'master' of github.com:linkedin/ambry into azure-update-precondition", "committedDate": "2020-02-18T18:53:31Z", "type": "commit"}, {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c", "url": "https://github.com/linkedin/ambry/commit/6c36f8fed8487d4b1bca059cb87476c3a996566c", "message": "remove accidentally committed code", "committedDate": "2020-02-18T19:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzA1OQ==", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953059", "bodyText": "log exception?", "author": "cgtz", "createdAt": "2020-02-23T00:39:44Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureBlobDataAccessor.java", "diffHunk": "@@ -295,7 +301,13 @@ public boolean updateBlobMetadata(BlobId blobId, String fieldName, Object value)\n         String textValue = String.valueOf(value);\n         if (!textValue.equals(metadata.get(fieldName))) {\n           metadata.put(fieldName, textValue);\n-          // Set condition to ensure we don't clobber another update\n+          if (updateCallback != null) {\n+            try {\n+              updateCallback.call();\n+            } catch (Exception ex) {", "originalCommit": "6c36f8fed8487d4b1bca059cb87476c3a996566c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzE5MA==", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953190", "bodyText": "use generics in both the member variable and method arg. If the return type of call doesn't matter, you can use Callable<?> in both places.", "author": "cgtz", "createdAt": "2020-02-23T00:42:32Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureBlobDataAccessor.java", "diffHunk": "@@ -120,6 +121,11 @@\n     this.purgeBatchSize = AzureCloudConfig.DEFAULT_PURGE_BATCH_SIZE;\n   }\n \n+  /** Visible for testing */\n+  void setUpdateCallback(Callable callback) {", "originalCommit": "6c36f8fed8487d4b1bca059cb87476c3a996566c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzI2OA==", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953268", "bodyText": "same comments for CosmosDataAccessor as AzureBlobDataAccessor.", "author": "cgtz", "createdAt": "2020-02-23T00:44:59Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/CosmosDataAccessor.java", "diffHunk": "@@ -58,6 +61,11 @@\n     this.azureMetrics = azureMetrics;\n   }\n \n+  /** Visible for testing */\n+  void setUpdateCallback(Callable callback) {\n+    this.updateCallback = callback;", "originalCommit": "6c36f8fed8487d4b1bca059cb87476c3a996566c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "786f5382082d593db39525a0bc54746e33cba72f", "url": "https://github.com/linkedin/ambry/commit/786f5382082d593db39525a0bc54746e33cba72f", "message": "Address Casey's review comments", "committedDate": "2020-02-27T01:02:47Z", "type": "commit"}, {"oid": "5d00f9d604996f45f2b13a95001cba03ffe677ed", "url": "https://github.com/linkedin/ambry/commit/5d00f9d604996f45f2b13a95001cba03ffe677ed", "message": "Merge branch 'master' of github.com:linkedin/ambry into azure-update-precondition", "committedDate": "2020-02-27T01:12:52Z", "type": "commit"}]}