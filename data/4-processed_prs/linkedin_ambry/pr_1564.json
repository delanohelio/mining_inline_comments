{"pr_number": 1564, "pr_title": "Check the size of vcr node list before finding one to assign as cloud peer.", "pr_createdAt": "2020-06-15T19:16:39Z", "pr_url": "https://github.com/linkedin/ambry/pull/1564", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTkzNQ==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440489935", "bodyText": "isEmpty() is simpler.", "author": "lightningrob", "createdAt": "2020-06-15T22:52:34Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {", "originalCommit": "bbde88b8c1f4b442107277c0f717022743d3adbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIyMjY5Mw==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441222693", "bodyText": "done.", "author": "ankagrawal", "createdAt": "2020-06-17T01:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTk0OQ==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440489949", "bodyText": "No need to log if the same message is passed to exception.  Also say VCR.", "author": "lightningrob", "createdAt": "2020-06-15T22:52:37Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {\n+      logger.error(\"No vcr node found to replicate partition from cloud.\");", "originalCommit": "bbde88b8c1f4b442107277c0f717022743d3adbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIyMjc5MA==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441222790", "bodyText": "fixed.", "author": "ankagrawal", "createdAt": "2020-06-17T01:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5MzcxMA==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440493710", "bodyText": "I realize this isn't new code, but it seems inefficient for a getter method to have to copy a collection to an array every time it needs to get an element from it.  It makes me wonder if the concurrent set is really the optimal data structure for this.", "author": "lightningrob", "createdAt": "2020-06-15T23:04:28Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {\n+      logger.error(\"No vcr node found to replicate partition from cloud.\");\n+      throw new ReplicationException(\"No vcr node found to replicate partition from cloud.\");\n+    }\n     return vcrNodes.get().toArray(new CloudDataNode[0])[Utils.getRandomShort(new Random()) % vcrNodes.get().size()];", "originalCommit": "bbde88b8c1f4b442107277c0f717022743d3adbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5NDAzMg==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440494032", "bodyText": "It's fine to address last comment in a future PR.", "author": "lightningrob", "createdAt": "2020-06-15T23:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5MzcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIyODc1Nw==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441228757", "bodyText": "You are right. It makes sense to make it a list. We modify it only in the CloudToStoreReplicationManager::handleChangeInVcrNodes() method and access it only in the CloudToStoreReplicationManager::getCloudDataNode(). And it makes sense to modify the atomic reference directly.  Have made the change.", "author": "ankagrawal", "createdAt": "2020-06-17T01:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5MzcxMA=="}], "type": "inlineReview"}, {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "url": "https://github.com/linkedin/ambry/commit/600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "message": "Make list of vcr nodes a list instead of set.\nAddress review comments.", "committedDate": "2020-06-17T01:30:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkxNDkwOA==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441914908", "bodyText": "I didn't notice it before, but I think initializing a new Random() each time will result in the same value each time.  At least that's how it used to behave, not sure if it's still the case.  Either way, I would initialize the Random statically and reuse.  I recommend adding a test case that calls this method consecutive times and verifies different results are returned.  And one to test the no-nodes exception case.", "author": "lightningrob", "createdAt": "2020-06-18T01:15:12Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,9 +240,14 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n-    return vcrNodes.get().toArray(new CloudDataNode[0])[Utils.getRandomShort(new Random()) % vcrNodes.get().size()];\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    List<CloudDataNode> nodes = vcrNodes.get();\n+    if (nodes.isEmpty()) {\n+      throw new ReplicationException(\"No VCR node found to replicate partition from cloud.\");\n+    }\n+    return nodes.get(Utils.getRandomShort(new Random()) % nodes.size());", "originalCommit": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NzkxNg==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441977916", "bodyText": "Sure, I will change the Random to static, and add the tests.\nNote that ideally, in a perfect random setting, I assume it could be possible for a few calls to getNextInt() to return same value (Maybe this will happen rarely, but this is a possibility). So in my test I am just checking that multiple calls return more than one value.\nAs for the behavior of Random, from the constructor of Random it seems like every instantiation gets a unique seed. Below code snippet is from java.util.Random class.\n    /**\n     * Creates a new random number generator. This constructor sets\n     * the seed of the random number generator to a value very likely\n     * to be distinct from any other invocation of this constructor.\n     */\n    public Random() {\n        this(seedUniquifier() ^ System.nanoTime());\n    }\n\nAlso I wrote an independent test that sort of proves this.\npublic class RandomTest {\n\tpublic static void main(String[] args) {\n\t\tfor(int i = 0; i < 10; i++) {\n\t\t\tSystem.out.println(new Random().nextInt()%17);\n\t\t}\n\t}\n}", "author": "ankagrawal", "createdAt": "2020-06-18T05:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkxNDkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMjU0OQ==", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r442432549", "bodyText": "My information was from at least 10 years ago, so they likely changed it since then.", "author": "lightningrob", "createdAt": "2020-06-18T18:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkxNDkwOA=="}], "type": "inlineReview"}, {"oid": "09f4a436d85ffbb82a5d3887804b0e0a1492f3b3", "url": "https://github.com/linkedin/ambry/commit/09f4a436d85ffbb82a5d3887804b0e0a1492f3b3", "message": "Check the size of vcr node list before finding on to assign as cloud peer.", "committedDate": "2020-06-18T05:38:54Z", "type": "commit"}, {"oid": "9356de8926c2e1bb34e2f203e19d1db5f6d28268", "url": "https://github.com/linkedin/ambry/commit/9356de8926c2e1bb34e2f203e19d1db5f6d28268", "message": "Make list of vcr nodes a list instead of set.\nAddress review comments.", "committedDate": "2020-06-18T05:38:54Z", "type": "commit"}, {"oid": "567ddd08eda9de99aaeee3ee275dd30dd28133c5", "url": "https://github.com/linkedin/ambry/commit/567ddd08eda9de99aaeee3ee275dd30dd28133c5", "message": "Add unit test", "committedDate": "2020-06-18T05:38:54Z", "type": "commit"}, {"oid": "567ddd08eda9de99aaeee3ee275dd30dd28133c5", "url": "https://github.com/linkedin/ambry/commit/567ddd08eda9de99aaeee3ee275dd30dd28133c5", "message": "Add unit test", "committedDate": "2020-06-18T05:38:54Z", "type": "forcePushed"}, {"oid": "fb95619dd37639174b2753b99c67406c881988da", "url": "https://github.com/linkedin/ambry/commit/fb95619dd37639174b2753b99c67406c881988da", "message": "Fix error message", "committedDate": "2020-06-18T05:42:35Z", "type": "commit"}]}