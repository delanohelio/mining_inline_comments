{"pr_number": 1703, "pr_title": "Changes to allow batch inserts/updates of accounts/container operations.", "pr_createdAt": "2020-11-24T03:29:11Z", "pr_url": "https://github.com/linkedin/ambry/pull/1703", "timeline": [{"oid": "77edda60616731a1348244af4f9d4e36bff235e9", "url": "https://github.com/linkedin/ambry/commit/77edda60616731a1348244af4f9d4e36bff235e9", "message": "Code changes to allow batch inserts/updates of accounts/container changes.", "committedDate": "2020-11-24T03:22:48Z", "type": "commit"}, {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "url": "https://github.com/linkedin/ambry/commit/b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "message": "Add couple of unit tests for batch updates", "committedDate": "2020-11-25T17:45:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2NjY5NQ==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533066695", "bodyText": "minor: add accounts to database in batches", "author": "jsjtzyy", "createdAt": "2020-12-01T04:32:57Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjgyNg==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533096826", "bodyText": "I wonder what will happen if first batch execution succeeds but second batch fails?", "author": "jsjtzyy", "createdAt": "2020-12-01T06:19:01Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.\n+   * @param accounts the account to insert.\n+   * @param batchSize number of statements to be executed in one batch\n    * @throws SQLException\n    */\n-  public List<Account> getNewAccounts(long updatedSince) throws SQLException {\n-    long startTimeMs = System.currentTimeMillis();\n-    Timestamp sinceTime = new Timestamp(updatedSince);\n-    PreparedStatement getSinceStatement = dataAccessor.getPreparedStatement(getSinceSql, false);\n-    getSinceStatement.setTimestamp(1, sinceTime);\n-    try (ResultSet rs = getSinceStatement.executeQuery()) {\n-      List<Account> accounts = convertResultSet(rs);\n-      dataAccessor.onSuccess(Read, System.currentTimeMillis() - startTimeMs);\n-      return accounts;\n+  public void addAccounts(Collection<Account> accounts, int batchSize) throws SQLException {\n+    try {\n+      long startTimeMs = System.currentTimeMillis();\n+      PreparedStatement insertStatement = dataAccessor.getPreparedStatement(insertSql, true);\n+      int count = 0;\n+      for (Account account : accounts) {\n+        insertStatement.setString(1, AccountCollectionSerde.accountToJsonNoContainers(account).toString());\n+        insertStatement.setInt(2, account.getSnapshotVersion());\n+        insertStatement.addBatch();\n+        if (++count % batchSize == 0) {\n+          insertStatement.executeBatch();\n+        }\n+      }\n+      insertStatement.executeBatch();\n+      dataAccessor.onSuccess(Write, System.currentTimeMillis() - startTimeMs);\n     } catch (SQLException e) {\n-      dataAccessor.onException(e, Read);\n+      dataAccessor.onException(e, Write);", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0MTA0Mg==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533741042", "bodyText": "For large updates, it can be in an incomplete state if not retried.  Up to a batch threshold, we plan to add transactions for atomicity.  But we don't want transactions to get too big.", "author": "lightningrob", "createdAt": "2020-12-01T21:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NzI5MA==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533097290", "bodyText": "minor: Updates a collection of accounts in the database.", "author": "jsjtzyy", "createdAt": "2020-12-01T06:20:18Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -117,6 +124,55 @@ public void updateAccount(Account account) throws SQLException {\n     }\n   }\n \n+  /**\n+   * Updates an existing account in the database.", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODM1Mg==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533098352", "bodyText": "nit:\n\nAdd containers from given account to database in batches\ncontainers'", "author": "jsjtzyy", "createdAt": "2020-12-01T06:23:43Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/ContainerDao.java", "diffHunk": "@@ -83,6 +84,36 @@ public void addContainer(int accountId, Container container) throws SQLException\n     }\n   }\n \n+  /**\n+   * Add a containers to the database.\n+   * @param accountId the containers's parent account id.", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODgxMA==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533098810", "bodyText": "same here", "author": "jsjtzyy", "createdAt": "2020-12-01T06:25:03Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/ContainerDao.java", "diffHunk": "@@ -106,6 +137,37 @@ public void updateContainer(int accountId, Container container) throws SQLExcept\n     }\n   }\n \n+  /**\n+   * Updates a container in the database.\n+   * @param accountId the container's parent account id.", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwMDA0OQ==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533100049", "bodyText": "minor: add java doc for localDatacenter and config", "author": "jsjtzyy", "createdAt": "2020-12-01T06:29:04Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/MySqlAccountStore.java", "diffHunk": "@@ -31,17 +32,20 @@\n   private final AccountDao accountDao;\n   private final ContainerDao containerDao;\n   private final MySqlDataAccessor mySqlDataAccessor;\n+  private final MySqlAccountServiceConfig config;\n \n   /**\n    * Constructor.\n    * @param dbEndpoints MySql DB end points\n    * @param metrics metrics to track mysql operations\n    * @throws SQLException\n    */\n-  public MySqlAccountStore(List<MySqlUtils.DbEndpoint> dbEndpoints, String localDatacenter, MySqlMetrics metrics) throws SQLException {\n+  public MySqlAccountStore(List<MySqlUtils.DbEndpoint> dbEndpoints, String localDatacenter, MySqlMetrics metrics,\n+      MySqlAccountServiceConfig config) throws SQLException {", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwMjU0OQ==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533102549", "bodyText": "if count % batchSize = 0,  will line 99 execute an empty batch ?  I guess this is OK for database?", "author": "jsjtzyy", "createdAt": "2020-12-01T06:36:18Z", "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.\n+   * @param accounts the account to insert.\n+   * @param batchSize number of statements to be executed in one batch\n    * @throws SQLException\n    */\n-  public List<Account> getNewAccounts(long updatedSince) throws SQLException {\n-    long startTimeMs = System.currentTimeMillis();\n-    Timestamp sinceTime = new Timestamp(updatedSince);\n-    PreparedStatement getSinceStatement = dataAccessor.getPreparedStatement(getSinceSql, false);\n-    getSinceStatement.setTimestamp(1, sinceTime);\n-    try (ResultSet rs = getSinceStatement.executeQuery()) {\n-      List<Account> accounts = convertResultSet(rs);\n-      dataAccessor.onSuccess(Read, System.currentTimeMillis() - startTimeMs);\n-      return accounts;\n+  public void addAccounts(Collection<Account> accounts, int batchSize) throws SQLException {\n+    try {\n+      long startTimeMs = System.currentTimeMillis();\n+      PreparedStatement insertStatement = dataAccessor.getPreparedStatement(insertSql, true);\n+      int count = 0;\n+      for (Account account : accounts) {\n+        insertStatement.setString(1, AccountCollectionSerde.accountToJsonNoContainers(account).toString());\n+        insertStatement.setInt(2, account.getSnapshotVersion());\n+        insertStatement.addBatch();\n+        if (++count % batchSize == 0) {\n+          insertStatement.executeBatch();\n+        }\n+      }\n+      insertStatement.executeBatch();", "originalCommit": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0Mjk1OQ==", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533742959", "bodyText": "It would be better to check for empty batch.", "author": "lightningrob", "createdAt": "2020-12-01T21:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwMjU0OQ=="}], "type": "inlineReview"}, {"oid": "69276caa92d72be979f90e779a24ad3b19c6ef4c", "url": "https://github.com/linkedin/ambry/commit/69276caa92d72be979f90e779a24ad3b19c6ef4c", "message": "Fix MySql int tests and address Rob/Yingyi's comments", "committedDate": "2020-12-02T01:34:30Z", "type": "commit"}]}