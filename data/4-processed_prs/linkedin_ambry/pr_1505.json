{"pr_number": 1505, "pr_title": "Improving POST request failure handling", "pr_createdAt": "2020-05-06T05:52:45Z", "pr_url": "https://github.com/linkedin/ambry/pull/1505", "timeline": [{"oid": "276aa67133a33f8b6bee2b26f68eacb1c31cd1a9", "url": "https://github.com/linkedin/ambry/commit/276aa67133a33f8b6bee2b26f68eacb1c31cd1a9", "message": "Introducing a delay in closing the netty channel when a POST request fails due to any reason.\nAdding a config to enable this behaviour. By default this is disabled.\nAlso adding a metric to keep a count of such delayed close event.\nFix for some existing UT and and new UT to test the new code flow.", "committedDate": "2020-05-05T20:05:26Z", "type": "commit"}, {"oid": "5a54e259a79c65a0ec53bf4b55dce9e043d5c4af", "url": "https://github.com/linkedin/ambry/commit/5a54e259a79c65a0ec53bf4b55dce9e043d5c4af", "message": "Merge branch 'master' into ambry6804", "committedDate": "2020-05-05T20:39:35Z", "type": "commit"}, {"oid": "c875af4d0596d18c05bbc138cd066ba5629a957c", "url": "https://github.com/linkedin/ambry/commit/c875af4d0596d18c05bbc138cd066ba5629a957c", "message": "rename the variable", "committedDate": "2020-05-06T05:43:18Z", "type": "commit"}, {"oid": "327a6a95372c56d28332cab88809db267ae5feb2", "url": "https://github.com/linkedin/ambry/commit/327a6a95372c56d28332cab88809db267ae5feb2", "message": "removing the sleep", "committedDate": "2020-05-06T05:50:42Z", "type": "commit"}, {"oid": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "url": "https://github.com/linkedin/ambry/commit/00dc8e661333eba2c64213f1c79d176ecbf9d135", "message": "adding another metrics to keep track of delayed close execution", "committedDate": "2020-05-06T15:33:25Z", "type": "commit"}, {"oid": "d98df91792d8d343b7f3fe58964f4c8e66c0b09f", "url": "https://github.com/linkedin/ambry/commit/d98df91792d8d343b7f3fe58964f4c8e66c0b09f", "message": "Merge branch 'master' of github.com:linkedin/ambry into ambry6804", "committedDate": "2020-05-06T18:55:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjYyMQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421032621", "bodyText": "closure", "author": "lightningrob", "createdAt": "2020-05-06T19:18:00Z", "path": "ambry-rest/src/main/java/com/github/ambry/rest/NettyResponseChannel.java", "diffHunk": "@@ -110,16 +114,37 @@\n   // was successfully sent\n   private ResponseStatus errorResponseStatus = null;\n \n+  /**\n+   * A {@link ChannelFutureListener} that closes the {@link Channel} which is\n+   * associated with the specified {@link ChannelFuture} after certain delay which is configured through {@link NettyConfig}.\n+   */\n+  public final ChannelFutureListener DELAYED_CLOSE = new ChannelFutureListener() {\n+    @Override\n+    public void operationComplete(ChannelFuture future) {\n+      logger.trace(\"scheduling closeure of channel {}\", future.channel());", "originalCommit": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3MjExNg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421072116", "bodyText": "Done.", "author": "ssen-li", "createdAt": "2020-05-06T20:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzNTg2Mw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421035863", "bodyText": "Need to format this class for line wrapping.  In LI Intellij, do Code/Reformat Code or key shortcut Cmd-Alt-L", "author": "lightningrob", "createdAt": "2020-05-06T19:23:38Z", "path": "ambry-rest/src/main/java/com/github/ambry/rest/NettyResponseChannel.java", "diffHunk": "@@ -681,10 +706,16 @@ private HttpResponseStatus getHttpResponseStatus(ResponseStatus responseStatus)\n    * </p>\n    * May also close the channel if the class internally is forcing a close (i.e. if {@link #close()} is called.\n    * @param closeNetworkChannel network channel is closed if {@code true}.\n+   * @param shouldDelay network channel may be closed after certain delay if {@code true}.\n    */\n-  private void completeRequest(boolean closeNetworkChannel) {\n+  private void completeRequest(boolean closeNetworkChannel, boolean shouldDelay) {\n     if ((closeNetworkChannel || forceClose) && ctx.channel().isOpen()) {\n-      writeFuture.addListener(ChannelFutureListener.CLOSE);\n+      if (!shouldDelay || (request != null && !request.getRestMethod().equals(RestMethod.POST)) || (this.nettyConfig.nettyServerCloseDelayTimeoutMs == 0)) {", "originalCommit": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzNzU4Mw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421037583", "bodyText": "also it's a bit hard to read the line, I suggest reversing this line and changing the OR's to AND's and removing NOT's (meaning we do want to delay the close).", "author": "lightningrob", "createdAt": "2020-05-06T19:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzNTg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3MjY3OA==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421072678", "bodyText": "Done. Thanks much for the formatting help.", "author": "ssen-li", "createdAt": "2020-05-06T20:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzNTg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MDQzMQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421040431", "bodyText": "Minor: please create VerifiableProperties once since it's being used multiple times.", "author": "lightningrob", "createdAt": "2020-05-06T19:31:43Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -658,7 +659,8 @@ public void channelInactiveTest() {\n     EmbeddedChannel channel = new EmbeddedChannel(chunkedWriteHandler);\n     NettyResponseChannel nettyResponseChannel =\n         new NettyResponseChannel(new MockChannelHandlerContext(channel), new NettyMetrics(new MetricRegistry()),\n-            new PerformanceConfig(new VerifiableProperties(new Properties())));\n+            new PerformanceConfig(new VerifiableProperties(new Properties())),\n+            new NettyConfig(new VerifiableProperties(new Properties())));", "originalCommit": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3Mjc3Ng==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421072776", "bodyText": "Done.", "author": "ssen-li", "createdAt": "2020-05-06T20:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MDQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MTc5Nw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421041797", "bodyText": "Line formatting", "author": "lightningrob", "createdAt": "2020-05-06T19:34:11Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1591,7 +1626,7 @@ private void setNullHeaders() throws RestServiceException {\n    */\n   private void setRequestTest() throws RestServiceException {\n     ResponseStatus status = ResponseStatus.Accepted;\n-    restResponseChannel = new NettyResponseChannel(ctx, new NettyMetrics(new MetricRegistry()), PERFORMANCE_CONFIG);\n+    restResponseChannel = new NettyResponseChannel(ctx, new NettyMetrics(new MetricRegistry()), PERFORMANCE_CONFIG, this.nettyConfig);", "originalCommit": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3Mjg1NA==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421072854", "bodyText": "Done.", "author": "ssen-li", "createdAt": "2020-05-06T20:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3ODc1MA==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421578750", "bodyText": "actually this line is within the 120 char limit. no change needed.", "author": "ssen-li", "createdAt": "2020-05-07T15:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjQ5Nw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421042497", "bodyText": "Can also wait 500ms and verify that it does get closed.  Also check the counters were incremented.", "author": "lightningrob", "createdAt": "2020-05-06T19:35:25Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1082,6 +1084,33 @@ private void sendRequestAndEvaluateResponsePerformance(HttpRequest httpRequest,\n       assertFalse(httpRequest.method() + \" request should be unsatisfied\", MockNettyRequest.mockTracker.isSatisfied());\n     }\n   }\n+\n+  /**\n+   * Tests the invocation of DELAYED_CLOSE when post failures happen in {@link NettyResponseChannel}.\n+   */\n+  @Test\n+  public void completeRequestWithDelayedCloseTest() throws Exception {\n+    Properties properties = new Properties();\n+    properties.setProperty(NettyConfig.NETTY_SERVER_CLOSE_DELAY_TIMEOUT_MS, \"500\");\n+    NettyConfig nettyConfig  = new NettyConfig(new VerifiableProperties(properties));\n+    MockNettyMessageProcessor processor = new MockNettyMessageProcessor();\n+    processor.setNettyConfig(nettyConfig);\n+    ChunkedWriteHandler chunkedWriteHandler = new ChunkedWriteHandler();\n+    EmbeddedChannel channel = new EmbeddedChannel(chunkedWriteHandler, processor);\n+\n+    RestServiceErrorCode REST_ERROR_CODE = RestServiceErrorCode.BadRequest;\n+    String content = \"@@randomContent@@@\";\n+    HttpHeaders httpHeaders = new DefaultHttpHeaders();\n+    httpHeaders.set(MockNettyMessageProcessor.REST_SERVICE_ERROR_CODE_HEADER_NAME, REST_ERROR_CODE);\n+    httpHeaders.set(MockNettyMessageProcessor.INCLUDE_EXCEPTION_MESSAGE_IN_RESPONSE_HEADER_NAME, \"true\");\n+    HttpRequest httpRequest = RestTestUtils.createFullRequest(HttpMethod.POST,\n+        TestingUri.OnResponseCompleteWithRestException.toString(), httpHeaders, content.getBytes());\n+    channel.writeInbound(httpRequest);\n+    HttpResponse response = (HttpResponse) channel.readOutbound();\n+    assertEquals(\"Unexpected response status\", getExpectedHttpResponseStatus(REST_ERROR_CODE), response.status());\n+    //channel should not be closed right away.\n+    assertTrue(\"Channel closed on the server\", channel.isActive());", "originalCommit": "00dc8e661333eba2c64213f1c79d176ecbf9d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4MDI0Ng==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421080246", "bodyText": "I actually tried waiting but it did not work. There is no dedicated threads running the netty channel handlers here.  Everything is getting executed in a single Junit test runner thread. The netty eventloop.scheduler() task never gets executed because netty does not have any real threads to schedule this task. Even if i add a Thread.sleep() here, after the sleep is over the the test runner thread simply exits. I could not find any other way of verifying this. Let me know if there is any way to test this.\nI added check for the metrics. This is fine.", "author": "ssen-li", "createdAt": "2020-05-06T20:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1Nzk0Mw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421957943", "bodyText": "I'm kind of surprised by this.  Looking at the code, I see EmbeddedChannel uses EmbeddedEventLoop which extends AbstractScheduledEventExecutor and I would have thought the runScheduledTasks() method would get the scheduled task and run it.  Did you try stepping through with the debugger to see where the task ends up?  I see that Yingyi @jsjtzyy has worked on this test class, he might have suggestions on how to trigger it.", "author": "lightningrob", "createdAt": "2020-05-08T06:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1Njk0Mg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r422456942", "bodyText": "Thanks so much @lightningrob for the pointers. Since EmbeddedChannel does not have its own thread pool the UT thread has to call the runPendingTask() api to fire the scheduled tasks on this channel. This is very different from the NioSocketChannel. I was not aware that the api has to be explicitly triggered. I have enhanced the UT to do all the validations now. Please take a look. Thanks.", "author": "ssen-li", "createdAt": "2020-05-09T05:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjQ5Nw=="}], "type": "inlineReview"}, {"oid": "e732dca1afd644576825f18dd54e49b919d97615", "url": "https://github.com/linkedin/ambry/commit/e732dca1afd644576825f18dd54e49b919d97615", "message": "addressing the review comments", "committedDate": "2020-05-06T20:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ0OQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421609449", "bodyText": "I wonder if we need to only do this on post requests? It is probably less likely to experience this issue on non-POST requests since those don't usually have a body and closeNetworkChannel is rarely true, but I don't see an issue with doing the delayed close on all types of requests where closeNetworkChannel is true", "author": "cgtz", "createdAt": "2020-05-07T15:49:19Z", "path": "ambry-rest/src/main/java/com/github/ambry/rest/NettyResponseChannel.java", "diffHunk": "@@ -681,10 +706,17 @@ private HttpResponseStatus getHttpResponseStatus(ResponseStatus responseStatus)\n    * </p>\n    * May also close the channel if the class internally is forcing a close (i.e. if {@link #close()} is called.\n    * @param closeNetworkChannel network channel is closed if {@code true}.\n+   * @param shouldDelay network channel may be closed after certain delay if {@code true}.\n    */\n-  private void completeRequest(boolean closeNetworkChannel) {\n+  private void completeRequest(boolean closeNetworkChannel, boolean shouldDelay) {\n     if ((closeNetworkChannel || forceClose) && ctx.channel().isOpen()) {\n-      writeFuture.addListener(ChannelFutureListener.CLOSE);\n+      if (shouldDelay && (request != null && request.getRestMethod().equals(RestMethod.POST))", "originalCommit": "e732dca1afd644576825f18dd54e49b919d97615", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDA3Ng==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421654076", "bodyText": "Thanks @cgtz for the comment. Later I was thinking about doing this for all http method as well but since the ticket specifically talks about to solve it for POST method I made it like so. Please let me know if this fine or should i remove the request method check?", "author": "ssen-li", "createdAt": "2020-05-07T16:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzUxMQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421657511", "bodyText": "Thanks @cgtz for the comment. Later I was thinking about doing this for all http method as well but since the ticket specifically talks about to solve it for POST method I made it like so. Please let me know if this fine or should i remove the request method check?", "author": "ssen-li", "createdAt": "2020-05-07T17:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3MjEwMg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421672102", "bodyText": "I guess it is fine to keep it as is, since this issue probably happens when there is more request data to send, which is only posts for now. We can revisit this if we support other operations that contain request bodies in the future.", "author": "cgtz", "createdAt": "2020-05-07T17:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NDcyMg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r421674722", "bodyText": "Thanks for the confirmation. So will keep it as it is for now.", "author": "ssen-li", "createdAt": "2020-05-07T17:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ0OQ=="}], "type": "inlineReview"}, {"oid": "d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "url": "https://github.com/linkedin/ambry/commit/d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "message": "enhancing the UT to test the channel close after the delay.:wq", "committedDate": "2020-05-09T05:44:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4NDU1Nw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r422784557", "bodyText": "minor: I think this could be removed, we can directly give nettyConfig an initial value at line 1286.", "author": "jsjtzyy", "createdAt": "2020-05-11T05:13:13Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1234,6 +1273,7 @@ public static TestingUri getTestingURI(String uri) {\n   static final byte[] CHUNK = TestUtils.getRandomBytes(1024);\n   static final String CHUNK_COUNT_HEADER_NAME = \"chunkCount\";\n   static PerformanceConfig PERFORMANCE_CONFIG = new PerformanceConfig(new VerifiableProperties(new Properties()));\n+  static NettyConfig NETTY_CONFIG = new NettyConfig(new VerifiableProperties(new Properties()));", "originalCommit": "d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MTUwMA==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423191500", "bodyText": "Done", "author": "ssen-li", "createdAt": "2020-05-11T17:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4NDU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4NTUzOQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r422785539", "bodyText": "Minor: Could you move this test to line 674 (ahead of helper methods)?", "author": "jsjtzyy", "createdAt": "2020-05-11T05:16:58Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1082,6 +1084,43 @@ private void sendRequestAndEvaluateResponsePerformance(HttpRequest httpRequest,\n       assertFalse(httpRequest.method() + \" request should be unsatisfied\", MockNettyRequest.mockTracker.isSatisfied());\n     }\n   }\n+\n+  /**\n+   * Tests the invocation of DELAYED_CLOSE when post failures happen in {@link NettyResponseChannel}.\n+   */\n+  @Test\n+  public void completeRequestWithDelayedCloseTest() throws Exception {", "originalCommit": "d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MTU2Mw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423191563", "bodyText": "Done", "author": "ssen-li", "createdAt": "2020-05-11T17:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4NTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5MDcxNw==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r422790717", "bodyText": "nit: redundant cast, (HttpResponse) can be removed", "author": "jsjtzyy", "createdAt": "2020-05-11T05:34:36Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1082,6 +1084,43 @@ private void sendRequestAndEvaluateResponsePerformance(HttpRequest httpRequest,\n       assertFalse(httpRequest.method() + \" request should be unsatisfied\", MockNettyRequest.mockTracker.isSatisfied());\n     }\n   }\n+\n+  /**\n+   * Tests the invocation of DELAYED_CLOSE when post failures happen in {@link NettyResponseChannel}.\n+   */\n+  @Test\n+  public void completeRequestWithDelayedCloseTest() throws Exception {\n+    Properties properties = new Properties();\n+    long delayMs = 500;\n+    properties.setProperty(NettyConfig.NETTY_SERVER_CLOSE_DELAY_TIMEOUT_MS, String.valueOf(delayMs));\n+    NettyConfig nettyConfig = new NettyConfig(new VerifiableProperties(properties));\n+    MockNettyMessageProcessor processor = new MockNettyMessageProcessor();\n+    processor.setNettyConfig(nettyConfig);\n+    ChunkedWriteHandler chunkedWriteHandler = new ChunkedWriteHandler();\n+    EmbeddedChannel channel = new EmbeddedChannel(chunkedWriteHandler, processor);\n+\n+    RestServiceErrorCode REST_ERROR_CODE = RestServiceErrorCode.BadRequest;\n+    String content = \"@@randomContent@@@\";\n+    HttpHeaders httpHeaders = new DefaultHttpHeaders();\n+    httpHeaders.set(MockNettyMessageProcessor.REST_SERVICE_ERROR_CODE_HEADER_NAME, REST_ERROR_CODE);\n+    httpHeaders.set(MockNettyMessageProcessor.INCLUDE_EXCEPTION_MESSAGE_IN_RESPONSE_HEADER_NAME, \"true\");\n+    HttpRequest httpRequest =\n+        RestTestUtils.createFullRequest(HttpMethod.POST, TestingUri.OnResponseCompleteWithRestException.toString(),\n+            httpHeaders, content.getBytes());\n+    channel.writeInbound(httpRequest);\n+    HttpResponse response = (HttpResponse) channel.readOutbound();", "originalCommit": "d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MTYzMg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423191632", "bodyText": "Done", "author": "ssen-li", "createdAt": "2020-05-11T17:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5MDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5OTk3MQ==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r422799971", "bodyText": "feel like channel.runPendingTasks(); can be called before Thread.sleep", "author": "jsjtzyy", "createdAt": "2020-05-11T06:03:42Z", "path": "ambry-rest/src/test/java/com/github/ambry/rest/NettyResponseChannelTest.java", "diffHunk": "@@ -1082,6 +1084,43 @@ private void sendRequestAndEvaluateResponsePerformance(HttpRequest httpRequest,\n       assertFalse(httpRequest.method() + \" request should be unsatisfied\", MockNettyRequest.mockTracker.isSatisfied());\n     }\n   }\n+\n+  /**\n+   * Tests the invocation of DELAYED_CLOSE when post failures happen in {@link NettyResponseChannel}.\n+   */\n+  @Test\n+  public void completeRequestWithDelayedCloseTest() throws Exception {\n+    Properties properties = new Properties();\n+    long delayMs = 500;\n+    properties.setProperty(NettyConfig.NETTY_SERVER_CLOSE_DELAY_TIMEOUT_MS, String.valueOf(delayMs));\n+    NettyConfig nettyConfig = new NettyConfig(new VerifiableProperties(properties));\n+    MockNettyMessageProcessor processor = new MockNettyMessageProcessor();\n+    processor.setNettyConfig(nettyConfig);\n+    ChunkedWriteHandler chunkedWriteHandler = new ChunkedWriteHandler();\n+    EmbeddedChannel channel = new EmbeddedChannel(chunkedWriteHandler, processor);\n+\n+    RestServiceErrorCode REST_ERROR_CODE = RestServiceErrorCode.BadRequest;\n+    String content = \"@@randomContent@@@\";\n+    HttpHeaders httpHeaders = new DefaultHttpHeaders();\n+    httpHeaders.set(MockNettyMessageProcessor.REST_SERVICE_ERROR_CODE_HEADER_NAME, REST_ERROR_CODE);\n+    httpHeaders.set(MockNettyMessageProcessor.INCLUDE_EXCEPTION_MESSAGE_IN_RESPONSE_HEADER_NAME, \"true\");\n+    HttpRequest httpRequest =\n+        RestTestUtils.createFullRequest(HttpMethod.POST, TestingUri.OnResponseCompleteWithRestException.toString(),\n+            httpHeaders, content.getBytes());\n+    channel.writeInbound(httpRequest);\n+    HttpResponse response = (HttpResponse) channel.readOutbound();\n+    assertEquals(\"Unexpected response status\", getExpectedHttpResponseStatus(REST_ERROR_CODE), response.status());\n+    //channel should not be closed right away.\n+    assertTrue(\"Channel closed on the server\", channel.isActive());\n+    //wait for delayed time * 2 times (to rule out timing out on border) and then check again.\n+    Thread.sleep(delayMs * 2);\n+    channel.runPendingTasks();", "originalCommit": "d83cf4dfca4c72af7b1b5a072cf5b7f87df6250c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE2MjY3Ng==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423162676", "bodyText": "Since the task is delayed, I would feel that it should be called after, otherwise the task wouldn't be ready to run.", "author": "cgtz", "createdAt": "2020-05-11T16:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5OTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE2Nzc0Mg==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423167742", "bodyText": "make sense, feel free to ignore this comment.", "author": "jsjtzyy", "createdAt": "2020-05-11T16:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5OTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MjM5NA==", "url": "https://github.com/linkedin/ambry/pull/1505#discussion_r423192394", "bodyText": "No problem, Yeah we have to trigger the runPendingTasks() after sleeping for the delay time. Otherwise the task will not be fired.", "author": "ssen-li", "createdAt": "2020-05-11T17:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5OTk3MQ=="}], "type": "inlineReview"}, {"oid": "a08fda5d0b77d61d1aaf82927ec9bcd8fa0eb119", "url": "https://github.com/linkedin/ambry/commit/a08fda5d0b77d61d1aaf82927ec9bcd8fa0eb119", "message": "addressing more review comments", "committedDate": "2020-05-11T17:10:53Z", "type": "commit"}]}