{"pr_number": 1734, "pr_title": "Encode user metadata value if it contains non-ascii character", "pr_createdAt": "2020-12-19T07:09:51Z", "pr_url": "https://github.com/linkedin/ambry/pull/1734", "timeline": [{"oid": "81effe140431718ecf9fd339e4645b2d9aa20eba", "url": "https://github.com/linkedin/ambry/commit/81effe140431718ecf9fd339e4645b2d9aa20eba", "message": "Encode user metadata value if it contains non-ascii character\n\nUser metadata now supports UTF-8 charset. However, when setting header that includes non-ascii characters, underlying netty replaces these characters with\nquestion mark without throwing any exception. This PR explicitly checks if header value contains non-ascii characters. If yes, it encodes the string and put\nit to a special header which will be identified and decoded by client.", "committedDate": "2020-12-19T07:03:45Z", "type": "commit"}, {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "url": "https://github.com/linkedin/ambry/commit/7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "message": "minor clean up in tests", "committedDate": "2020-12-21T18:04:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2MTIyMg==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546861222", "bodyText": "Changes in this file are some cleanup and not related to user metadata change. (there was a travis failure, although this doesn't really fix the intermittent test error, it removes redundant code)", "author": "jsjtzyy", "createdAt": "2020-12-21T18:26:48Z", "path": "ambry-protocol/src/test/java/com/github/ambry/protocol/RequestResponseTest.java", "diffHunk": "@@ -369,14 +364,12 @@ public void putRequestResponseTest() throws IOException {\n         blob, blobSize, blobKey);\n \n     // Response test\n-    for (boolean useByteBufContent : new boolean[]{true, false}) {", "originalCommit": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546868172", "bodyText": "What happens if the value contains non ascii characters and you pass it to setHeader() as before?  Does it not throw IllegalArgumentException?", "author": "lightningrob", "createdAt": "2020-12-21T18:43:02Z", "path": "ambry-api/src/main/java/com/github/ambry/rest/RestUtils.java", "diffHunk": "@@ -910,21 +908,16 @@ public static void setUserMetadataHeaders(Map<String, String> userMetadataMap,\n       if (!headerName.startsWith(Headers.USER_META_DATA_HEADER_PREFIX)) {\n         headerName = Headers.USER_META_DATA_HEADER_PREFIX + headerName;\n       }\n-      try {\n-        restResponseChannel.setHeader(headerName, headerValue);\n-      } catch (IllegalArgumentException iae) {\n+      if (StandardCharsets.US_ASCII.newEncoder().canEncode(headerValue)) {", "originalCommit": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg3MTcwOA==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546871708", "bodyText": "It's hard to say, I would prefer merging @cgtz 's ambry-client change and verify. If it doesn't work (not able to display foreign language characters), we can use this piece of code to explicitly and proactively encode the head value.", "author": "jsjtzyy", "createdAt": "2020-12-21T18:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4ODI0Ng==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546888246", "bodyText": "Before, setHeader() would convert the value into valid ASCII by replacing any non-ascii characters with \"?\" symbols. If , after this step, this ascii encoded string did not contain any characters prohibited in headers but still valid ascii (like newline), the setHeader() call will succeed. However, if it did contain something like a newline, it would throw an exception.\nEdit: I may be slightly wrong about this. It seems like the utf-8 string is still maintained in the in-memory map, but may get replaced with ? somewhere else", "author": "cgtz", "createdAt": "2020-12-21T19:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkwNDY3OA==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546904678", "bodyText": "Here is the actual behavior. The conversion from unicode to question mark happens in the HttpResponseEncoder:\n  @Test\n  public void headerBehavior() {\n    HttpResponse response = new DefaultHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);\n\n    String nonASCIIStr = \"\u00e5\u222b \\uD83D\\uDE1D\\uD83D\\uDE31abcd\";\n    response.headers().set(\"non-ascii\", nonASCIIStr);\n\n    try {\n      response.headers().set(\"ascii-with-non-header-chars\", \"word word \\n\\r next line\");\n    } catch (Exception exception) {\n      System.out.println(\"Got exception while setting \\n\\r in httpheaders:  \" + exception);\n    }\n\n    System.out.println(\"HttpHeaders object\" + response.headers());\n\n    EmbeddedChannel channel = new EmbeddedChannel(new HttpResponseEncoder());\n    assertTrue(channel.writeOutbound(response));\n    channel.flushOutbound();\n    System.out.println(\"Actual HTTP response buffer:\");\n    ByteBuf buffer = channel.readOutbound();\n    System.out.println(buffer.toString(Charset.defaultCharset()));\n  }\nGot exception while setting \n in httpheaders:  java.lang.IllegalArgumentException: only ' ' and '\\t' are allowed after '\\n': word word \n next line\nHttpHeaders objectDefaultHttpHeaders[non-ascii: \u00e5\u222b \ud83d\ude1d\ud83d\ude31abcd]\nActual HTTP response buffer:\nHTTP/1.1 200 OK\nnon-ascii: \ufffd? ????abcd", "author": "cgtz", "createdAt": "2020-12-21T20:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMDkxMA==", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546930910", "bodyText": "Good find! Thanks for writing a unit test to narrow down the root cause. So, we can conclude that if head value has non-ascii but no new line character, setHeader() doesn't throw exception and non-ascii characters will be silently replaced with question mark in HttpResponseEncoder.", "author": "jsjtzyy", "createdAt": "2020-12-21T21:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg=="}], "type": "inlineReview"}]}