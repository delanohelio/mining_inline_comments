{"pr_number": 1387, "pr_title": "Enabled automated, sequenced releases from Travis CI", "pr_createdAt": "2020-02-14T21:52:16Z", "pr_url": "https://github.com/linkedin/ambry/pull/1387", "timeline": [{"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "url": "https://github.com/linkedin/ambry/commit/97551763f8e633e1b2657a736ff43bdce9d43ef1", "message": "Enabled continuous releases from Travis CI", "committedDate": "2020-02-14T06:43:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTcyMg==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379849722", "bodyText": "this should be linkedin/ambry", "author": "cgtz", "createdAt": "2020-02-15T19:05:38Z", "path": "gradle/git-push.sh", "diffHunk": "@@ -0,0 +1,11 @@\n+#!/bin/sh\n+\n+#Git push is implemented in the script to make sure we are not leaking GH key to the output\n+#Expects 'GIT_SECRET' env variable to be in format: user:github_access_token, \n+#for example: mockitoguy:qq43234xc23x23d24d\n+\n+echo \"Running git push without output for security. If it fails make sure that GIT_SECRET env variable is set.\"\n+git push --quiet https://$GIT_SECRET@github.com/mockitoguy/ambry.git --tags > /dev/null 2>&1", "originalCommit": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1ODIwOA==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r380958208", "bodyText": "Fixed! Nice catch!", "author": "mockitoguy", "createdAt": "2020-02-18T21:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTc3MQ==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379849771", "bodyText": "add newlines at the end of the newly added files", "author": "cgtz", "createdAt": "2020-02-15T19:06:16Z", "path": "gradle/ci-release.gradle", "diffHunk": "@@ -0,0 +1,37 @@\n+task bintrayUploadAll {\n+    description = \"Runs 'bintrayUpload' tasks from all projects\"\n+    mustRunAfter \"gitPush\" //git push is easier to rollback so we run it first\n+}\n+\n+allprojects {\n+    tasks.matching { it.name == \"bintrayUpload\" }.all {\n+        bintrayUploadAll.dependsOn it\n+    }\n+}\n+\n+task ciPerformRelease {\n+    description = \"Performs the release, intended to be ran on CI\"\n+    dependsOn \"gitTag\", \"gitPush\", \"bintrayUploadAll\"    \n+}\n+\n+task gitTag {\n+    description = \"Creates annotated tag 'v$version'\"\n+\n+    doLast {\n+        println \"Setting Git user and email to Travis CI\"\n+        exec { commandLine \"git\", \"config\", \"user.email\", \"travis@travis-ci.org\" }\n+        exec { commandLine \"git\", \"config\", \"user.name\", \"Travis CI\" }\n+        println \"Creating tag v$version\"\n+        exec { commandLine \"git\", \"tag\", \"-a\", \"-m\", \"Release $version\", \"v$version\" }\n+        println \"Created tag v$version\"\n+    }\n+}\n+\n+task gitPush(type: Exec) {\n+    description = \"Pushes tags by running 'git push --tags'. Hides secret key from git push output.\"\n+    mustRunAfter \"gitTag\" //tag first, push later\n+    \n+    doFirst { println \"Pushing tag v$version\" }\n+    commandLine \"./gradle/git-push.sh\", \"v$version\"\n+    doLast { println \"Pushed tag v$version\" }\n+}", "originalCommit": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1ODA5NQ==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r380958095", "bodyText": "Fixed!", "author": "mockitoguy", "createdAt": "2020-02-18T21:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg1MTA2Mg==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379851062", "bodyText": "some extra spaces here", "author": "cgtz", "createdAt": "2020-02-15T19:29:23Z", "path": "build.gradle", "diffHunk": "@@ -11,23 +11,22 @@\n buildscript {\n     repositories {\n         mavenCentral()\n+        mavenLocal()\n     }\n     apply from: file('gradle/buildscript.gradle'), to: buildscript\n }\n \n-plugins {\n-    id 'org.shipkit.java' version '2.2.5' apply false\n-}\n-if (!project.hasProperty('disableShipkit')) {\n-    apply plugin: 'org.shipkit.java'\n-}\n+apply plugin: 'org.shipkit.shipkit-auto-version'\n+println \"Building version $version\"\n \n apply from: file('gradle/license.gradle')\n apply from: file('gradle/environment.gradle')\n apply from: file(\"gradle/dependency-versions.gradle\")\n+apply from: file(\"gradle/ci-release.gradle\")\n \n-allprojects {\n+allprojects {    ", "originalCommit": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1ODAyOA==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r380958028", "bodyText": "Fixed!", "author": "mockitoguy", "createdAt": "2020-02-18T21:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg1MTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MDkxNA==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379860914", "bodyText": "It seems like travis-ci reorganized the docs lately, so this link should be https://docs.travis-ci.com/user/job-lifecycle/#skipping-the-installation-phase\nThe docs also suggest install: skip", "author": "cgtz", "createdAt": "2020-02-15T22:45:18Z", "path": ".travis.yml", "diffHunk": "@@ -15,11 +15,12 @@ addons:\n     packages:\n       - oracle-java8-installer\n       - oracle-java8-unlimited-jce-policy\n-#don't build tags\n branches:\n-  except:\n+  except: # don't build tags\n     - /^v\\d/\n+install:\n+ - true # skips unnecessary ./gradlew assemble (https://docs.travis-ci.com/user/customizing-the-build/#Skipping-the-Installation-Step) ", "originalCommit": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Nzg4Mw==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r380957883", "bodyText": "Fixed! Great feedback!", "author": "mockitoguy", "createdAt": "2020-02-18T21:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MDkxNA=="}], "type": "inlineReview"}, {"oid": "4047cd146218d7476f8ace5e5118563b4e5a7f0d", "url": "https://github.com/linkedin/ambry/commit/4047cd146218d7476f8ace5e5118563b4e5a7f0d", "message": "Updated based on review", "committedDate": "2020-02-18T21:53:02Z", "type": "commit"}, {"oid": "08e5d1049bc8586bfda62d18292162cde25a70a3", "url": "https://github.com/linkedin/ambry/commit/08e5d1049bc8586bfda62d18292162cde25a70a3", "message": "Merge branch 'master' into master", "committedDate": "2020-02-18T21:56:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU2MDYwMw==", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r381560603", "bodyText": "Could you remove the -i option from this command? Since we have logging enabled for our tests, this can produce a ton of output.\nI think it should be okay to use -i on lines 10 and 17 though.", "author": "cgtz", "createdAt": "2020-02-19T21:40:19Z", "path": "travis-build.sh", "diffHunk": "@@ -0,0 +1,18 @@\n+#!/bin/sh\n+\n+# exit when any command fails\n+set -e\n+\n+echo \"Building and testing artifacts, and creating pom files\"\n+./gradlew -s -i --scan build publishToMavenLocal codeCoverageReport", "originalCommit": "08e5d1049bc8586bfda62d18292162cde25a70a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "017d055f5c91aa27cdc3d08e47260a4e93e7b400", "url": "https://github.com/linkedin/ambry/commit/017d055f5c91aa27cdc3d08e47260a4e93e7b400", "message": "Remove -i option to reduce log volumes\n\nOur tests have noisy logging, and travis can't show all of the output.", "committedDate": "2020-02-20T18:42:59Z", "type": "commit"}]}