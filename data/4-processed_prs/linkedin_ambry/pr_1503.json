{"pr_number": 1503, "pr_title": "Filter out INACTIVE/DELETE_IN_PROGRESS containers during compaction", "pr_createdAt": "2020-05-05T07:25:28Z", "pr_url": "https://github.com/linkedin/ambry/pull/1503", "timeline": [{"oid": "8179608017e0441715b6a45ddd18cc590097d156", "url": "https://github.com/linkedin/ambry/commit/8179608017e0441715b6a45ddd18cc590097d156", "message": "remove precondition check", "committedDate": "2020-05-07T22:13:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MzQ5OQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423193499", "bodyText": "Feel like we can make the argument a Collection or Set, which allows us to use EnumSet.of to specify multiple Status we are looking at.", "author": "jsjtzyy", "createdAt": "2020-05-11T17:15:17Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,19 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllContainersByStatus(Container.ContainerStatus containerStatus) {", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgyNjMyMA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423826320", "bodyText": "Thanks for the suggestion. Updated.", "author": "SophieGuo410", "createdAt": "2020-05-12T15:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE5MzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTIyNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423221225", "bodyText": "How about renaming the method to isFromDeletedContainer?", "author": "jsjtzyy", "createdAt": "2020-05-11T18:02:47Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -557,6 +575,16 @@ private boolean copyDataByIndexSegment(LogSegment logSegmentToCopy, IndexSegment\n     return copiedAll;\n   }\n \n+  /**\n+   * Determines if {@code copyCandidate} belongs to the DELETED_IN_PROGRESS {@link Container}s.\n+   * @param copyCandidate the {@link IndexEntry} to check\n+   * @param selectedContainerPairSet the collection of AccountId and ContainerId pairs in the given status.\n+   */\n+  private boolean isDeleteRequested(IndexEntry copyCandidate, Set<Pair<Short,Short>> selectedContainerPairSet) {", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgyNjQ1NQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423826455", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-12T15:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTUyNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423221525", "bodyText": "Can we combine this with line 1052-1053?", "author": "jsjtzyy", "createdAt": "2020-05-11T18:03:22Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -1024,6 +1052,8 @@ private void endCompaction() {\n       copyCandidates.removeIf(\n           copyCandidate -> isDuplicate(copyCandidate, duplicateSearchSpan, indexSegment.getStartOffset(),\n               checkAlreadyCopied));\n+      copyCandidates.removeIf(\n+          copyCandidate -> isDeleteRequested(copyCandidate, selectedContainers));", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgyNjU5NA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423826594", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-12T15:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTYxOQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423221619", "bodyText": "same here", "author": "jsjtzyy", "createdAt": "2020-05-11T18:03:32Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -1311,6 +1341,8 @@ public boolean alreadyExists(PersistentIndex idx, FileSpan searchSpan, StoreKey\n       copyCandidates.removeIf(\n           copyCandidate -> isDuplicate(copyCandidate, duplicateSearchSpan, indexSegment.getStartOffset(),\n               checkAlreadyCopied));\n+      copyCandidates.removeIf(\n+          copyCandidate -> isDeleteRequested(copyCandidate, selectedContainers));", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyNDYyMg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423224622", "bodyText": "The logic here is to remove blob that belongs to containers being deleted. I would suggest considering edge case where the obsolete container has been removed from Helix account metadata ZNode, however, blobs from that container haven't been cleaned up on certain node (perhaps this node is down for a long time).", "author": "jsjtzyy", "createdAt": "2020-05-11T18:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwODAwOQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423908009", "bodyText": "Merged the duplicate code. And currently we've decided not to remove obsolete container metadata from Zookeeper. But will keep in mind if we change our decision.", "author": "SophieGuo410", "createdAt": "2020-05-12T17:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMjQwMw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423222403", "bodyText": "minor: make this private final, then remove line 136", "author": "jsjtzyy", "createdAt": "2020-05-11T18:04:58Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -85,6 +86,7 @@ public boolean accept(File dir, String name) {\n   private final AccountService accountService;\n   private volatile boolean isActive = false;\n   private PersistentIndex srcIndex;\n+  private Set<Pair<Short,Short>> selectedContainers;", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNTIwNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423905205", "bodyText": "Updated to add final. May I know why I need to remove line 136? The selectedContainers still need to be initialized right?", "author": "SophieGuo410", "createdAt": "2020-05-12T17:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIyMjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MjA2OA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423382068", "bodyText": "a bit of syntax suger:\n      accountService.getContainersByStatus(containerStatus).forEach(\n          (container) -> {\n            selectedContainers.add(new Pair<>(container.getParentAccountId(), container.getId()));\n          })", "author": "justinlin-linkedin", "createdAt": "2020-05-11T23:45:57Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,19 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllContainersByStatus(Container.ContainerStatus containerStatus) {\n+    Set<Pair<Short, Short>> selectedContainerPairSet = new HashSet<>();\n+    if (accountService != null) {\n+      for (Container container : accountService.getContainersByStatus(containerStatus)) {\n+        selectedContainerPairSet.add(new Pair<>(container.getParentAccountId(), container.getId()));\n+      }\n+    }\n+    selectedContainers.addAll(selectedContainerPairSet);", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgzMDU2Nw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423830567", "bodyText": "Thanks. Updated.", "author": "SophieGuo410", "createdAt": "2020-05-12T15:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MjA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MjI5OA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423382298", "bodyText": "should clear selectedcContainers before adding item to it since we are doing for every compaction.", "author": "justinlin-linkedin", "createdAt": "2020-05-11T23:46:45Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,19 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllContainersByStatus(Container.ContainerStatus containerStatus) {\n+    Set<Pair<Short, Short>> selectedContainerPairSet = new HashSet<>();\n+    if (accountService != null) {\n+      for (Container container : accountService.getContainersByStatus(containerStatus)) {\n+        selectedContainerPairSet.add(new Pair<>(container.getParentAccountId(), container.getId()));\n+      }\n+    }\n+    selectedContainers.addAll(selectedContainerPairSet);", "originalCommit": "8179608017e0441715b6a45ddd18cc590097d156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgzMDY4OQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r423830689", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-12T15:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MjI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MzkxNg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424043916", "bodyText": "why adding a switch case here? In this method we shouldn't really care about the container status, rather than just return all the container with the given status.", "author": "justinlin-linkedin", "createdAt": "2020-05-12T21:27:30Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,28 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllContainersByStatus(EnumSet<Container.ContainerStatus> containerStatusSet) {\n+    Set<Pair<Short, Short>> selectedContainerPairSet = new HashSet<>();\n+    if (accountService != null) {\n+      for (Container.ContainerStatus containerStatus : containerStatusSet) {\n+        switch (containerStatus) {\n+          case INACTIVE:\n+          case DELETE_IN_PROGRESS:\n+            accountService.getContainersByStatus(containerStatus).forEach((container) -> {\n+              selectedContainers.add(new Pair<>(container.getParentAccountId(), container.getId()));\n+            });\n+            break;\n+          default:\n+            logger.error(\"Invalid container status: {}\", containerStatus);\n+        }", "originalCommit": "95e3c29781bbae47aeed3f102acf6dd27ac4214f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MjM0OQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424072349", "bodyText": "It's due to I need to separately handle the INACTIVE and DELETE_IN_PROGRESS status for the future. To support the ACLs during compaction, I need to filter out the DELETE_IN_PROGRESS container which not qualify with the retention time, so only all Inactive containers and qualified Delete_in_progress containers can be remove during that compaction cycle. Does that make sense to you?", "author": "SophieGuo410", "createdAt": "2020-05-12T22:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MzkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NzA1NQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424087055", "bodyText": "it's weird that in line 251 we already specified the status set, but here we have to deal with it again. If this is the case, I encourage you to just ignore status in line 251, by changing this method to something like getAllFilteredContainers.", "author": "justinlin-linkedin", "createdAt": "2020-05-12T23:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MzkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MjgxNw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424552817", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T16:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MzkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0NDUzNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424044535", "bodyText": "Can you log the selectedContainers as info log before running into compaction?", "author": "justinlin-linkedin", "createdAt": "2020-05-12T21:28:51Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -222,6 +247,8 @@ A single compaction job could be performed across multiple compaction cycles (if\n     logger.trace(\"resumeCompaction() started for {}\", storeId);\n     runningLatch = new CountDownLatch(1);\n     compactionInProgress.set(true);\n+    selectedContainers.clear();\n+    getAllContainersByStatus(EnumSet.of(Container.ContainerStatus.INACTIVE, Container.ContainerStatus.DELETE_IN_PROGRESS));", "originalCommit": "95e3c29781bbae47aeed3f102acf6dd27ac4214f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1Mjk5Ng==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424552996", "bodyText": "Updated", "author": "SophieGuo410", "createdAt": "2020-05-13T16:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0NDUzNQ=="}], "type": "inlineReview"}, {"oid": "4896703ebf56fbe24d55efad80de5e210ad90ef1", "url": "https://github.com/linkedin/ambry/commit/4896703ebf56fbe24d55efad80de5e210ad90ef1", "message": "log the selectedContainers as info log", "committedDate": "2020-05-12T23:08:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTM3Mw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424175373", "bodyText": "Minor comments about comment and naming.\n\nComment its main functionality first and then describe what does it do.\nThere is actually not Converts here. It's filter.\ngetAllFilteredContainers() -> getNotActiveContainers() and comment what is not active: DELETE_IN_PROGRESS and INACTIVE", "author": "zzmao", "createdAt": "2020-05-13T05:08:51Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,22 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllFilteredContainers() {", "originalCommit": "e73b9ad7513e6553fd172b277c4c87a89aa3a3b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2ODAxMw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424768013", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T22:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTUwNA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424175504", "bodyText": "selectedContainers -> notActiveContainers", "author": "zzmao", "createdAt": "2020-05-13T05:09:19Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,22 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Converts the set of {@link Container}s to the set of accountId & ContainerId pairs for easy detection.\n+   */\n+  private void getAllFilteredContainers() {\n+    Set<Pair<Short, Short>> selectedContainerPairSet = new HashSet<>();\n+    if (accountService != null) {\n+      accountService.getContainersByStatus(Container.ContainerStatus.DELETE_IN_PROGRESS).forEach((container) -> {\n+        selectedContainers.add(new Pair<>(container.getParentAccountId(), container.getId()));", "originalCommit": "e73b9ad7513e6553fd172b277c4c87a89aa3a3b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1Mzc0NQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424553745", "bodyText": "Updated", "author": "SophieGuo410", "createdAt": "2020-05-13T16:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTg5Mg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424175892", "bodyText": "how about move this line into getAllFilteredContainers ?", "author": "zzmao", "createdAt": "2020-05-13T05:10:41Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -222,6 +241,9 @@ A single compaction job could be performed across multiple compaction cycles (if\n     logger.trace(\"resumeCompaction() started for {}\", storeId);\n     runningLatch = new CountDownLatch(1);\n     compactionInProgress.set(true);\n+    selectedContainers.clear();", "originalCommit": "e73b9ad7513e6553fd172b277c4c87a89aa3a3b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NDAwNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424554005", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T16:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NjQ2Ng==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424176466", "bodyText": "Determines if {@code copyCandidate} container in the status of  DELETED_IN_PROGRESS or INACTIVE.", "author": "zzmao", "createdAt": "2020-05-13T05:12:49Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -557,6 +579,16 @@ private boolean copyDataByIndexSegment(LogSegment logSegmentToCopy, IndexSegment\n     return copiedAll;\n   }\n \n+  /**\n+   * Determines if {@code copyCandidate} belongs to the DELETED_IN_PROGRESS {@link Container}s.", "originalCommit": "e73b9ad7513e6553fd172b277c4c87a89aa3a3b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1NDE2NQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424554165", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T16:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NjQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTk4OA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424729988", "bodyText": "nit: we don't need this new variable, you can just add the pair of account id and container id to the notActiveContainers set.", "author": "justinlin-linkedin", "createdAt": "2020-05-13T21:04:17Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,24 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Filters not active {@link Container}s for compaction purpose. Not active status include DELETE_IN_PROGRESS and INACTIVE.\n+   * @return the not active {@link Container}s' accountId & containerId pairs.\n+   */\n+  private void getNotActiveContainers() {\n+    notActiveContainers.clear();\n+    Set<Pair<Short, Short>> selectedContainerPairSet = new HashSet<>();", "originalCommit": "4e69ea0504a5e73257c1dbb8b0821816c3e6f2f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MDcxMA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424740710", "bodyText": "+1", "author": "zzmao", "createdAt": "2020-05-13T21:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2ODEzNQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424768135", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T22:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MTQ4Mg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424741482", "bodyText": "selectedContainerPairSet is a class member, do we need to pass it as argument?", "author": "zzmao", "createdAt": "2020-05-13T21:27:52Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -557,6 +580,16 @@ private boolean copyDataByIndexSegment(LogSegment logSegmentToCopy, IndexSegment\n     return copiedAll;\n   }\n \n+  /**\n+   * Determines if {@code copyCandidate} container in the status of DELETED_IN_PROGRESS or INACTIVE.\n+   * @param copyCandidate the {@link IndexEntry} to check\n+   * @param selectedContainerPairSet the collection of AccountId and ContainerId pairs in the given status.\n+   */\n+  private boolean isFromDeletedContainer(IndexEntry copyCandidate, Set<Pair<Short,Short>> selectedContainerPairSet) {", "originalCommit": "4e69ea0504a5e73257c1dbb8b0821816c3e6f2f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2ODkxMg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r424768912", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-05-13T22:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MTQ4Mg=="}], "type": "inlineReview"}, {"oid": "eb5d7ae242ab828acac07e329eea712f8cc5885f", "url": "https://github.com/linkedin/ambry/commit/eb5d7ae242ab828acac07e329eea712f8cc5885f", "message": "minor change", "committedDate": "2020-05-13T22:32:45Z", "type": "forcePushed"}, {"oid": "5f48ecce6d432dfa8379e6ce5c109abf7ac2e02f", "url": "https://github.com/linkedin/ambry/commit/5f48ecce6d432dfa8379e6ce5c109abf7ac2e02f", "message": "minor change", "committedDate": "2020-05-13T23:06:09Z", "type": "forcePushed"}, {"oid": "c382aef35a5ba4ff522e64a3e1659f73007f0f5e", "url": "https://github.com/linkedin/ambry/commit/c382aef35a5ba4ff522e64a3e1659f73007f0f5e", "message": "minor change", "committedDate": "2020-05-14T04:30:47Z", "type": "forcePushed"}, {"oid": "777dbb35cfb429592436949641c162991cd53a7b", "url": "https://github.com/linkedin/ambry/commit/777dbb35cfb429592436949641c162991cd53a7b", "message": "minor change", "committedDate": "2020-05-14T17:04:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0ODg2MA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425448860", "bodyText": "Sorry, two additional minor questions:\n\naccountService is not initialized in this PR, is it?\nI think HelixAccountService may fail to fetch account metadata (i.e.disconnected from ZK), I think the accountService will get containers from local backup file, right?", "author": "jsjtzyy", "createdAt": "2020-05-14T21:45:00Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,22 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Filters not active {@link Container}s for compaction purpose. Not active status include DELETE_IN_PROGRESS and INACTIVE.\n+   * @return the not active {@link Container}s' accountId & containerId pairs.\n+   */\n+  private void getNotActiveContainers() {\n+    notActiveContainers.clear();\n+    if (accountService != null) {\n+      accountService.getContainersByStatus(Container.ContainerStatus.DELETE_IN_PROGRESS).forEach((container) -> {", "originalCommit": "777dbb35cfb429592436949641c162991cd53a7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1ODg4Nw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425558887", "bodyText": "No, it's in previous PR initialized inside Ambry Server.\nYes, the account metadata will be cached locally, so serving an Account query will not incur any calls to remote Zookeeper.", "author": "SophieGuo410", "createdAt": "2020-05-15T04:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0ODg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4Nzk0Ng==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425487946", "bodyText": "minor and optional: I feel like deprecatedContainers sounds a better name.", "author": "jsjtzyy", "createdAt": "2020-05-14T23:39:28Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -85,6 +86,7 @@ public boolean accept(File dir, String name) {\n   private final AccountService accountService;\n   private volatile boolean isActive = false;\n   private PersistentIndex srcIndex;\n+  private final Set<Pair<Short,Short>> notActiveContainers;", "originalCommit": "777dbb35cfb429592436949641c162991cd53a7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5MjI3NQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425492275", "bodyText": "deprecatedContainers  also looks good to me.", "author": "zzmao", "createdAt": "2020-05-14T23:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4Nzk0Ng=="}], "type": "inlineReview"}, {"oid": "f1d31fd21803e7c38d8e9b7c611b253c4004e83c", "url": "https://github.com/linkedin/ambry/commit/f1d31fd21803e7c38d8e9b7c611b253c4004e83c", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T00:41:02Z", "type": "forcePushed"}, {"oid": "38ff4733c99092cc90066899a2b3242622816cb2", "url": "https://github.com/linkedin/ambry/commit/38ff4733c99092cc90066899a2b3242622816cb2", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T00:45:04Z", "type": "forcePushed"}, {"oid": "36f673e670226f8bda4de881ae034c89a69a7fa7", "url": "https://github.com/linkedin/ambry/commit/36f673e670226f8bda4de881ae034c89a69a7fa7", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T00:58:35Z", "type": "forcePushed"}, {"oid": "d50b63ca48fe1f629e3c46dde915ff57a805b00f", "url": "https://github.com/linkedin/ambry/commit/d50b63ca48fe1f629e3c46dde915ff57a805b00f", "message": "Filter out index entries belongs to the INACTIVE/DELETE_IN_PROGRESS containers during compaction", "committedDate": "2020-05-15T01:26:39Z", "type": "commit"}, {"oid": "6ccd9c2895765b89fb15e8e8dd07173e40132751", "url": "https://github.com/linkedin/ambry/commit/6ccd9c2895765b89fb15e8e8dd07173e40132751", "message": "fix precondition check error", "committedDate": "2020-05-15T01:26:39Z", "type": "commit"}, {"oid": "c5ddd2ff9a7cb010b629ef05cfe65d805129078c", "url": "https://github.com/linkedin/ambry/commit/c5ddd2ff9a7cb010b629ef05cfe65d805129078c", "message": "remove precondition check", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "89c426e0014da53d43b71f977128a137b161cce2", "url": "https://github.com/linkedin/ambry/commit/89c426e0014da53d43b71f977128a137b161cce2", "message": "address comments", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "4fe9ba0537684180eb41b92610f070b0f62cbcc3", "url": "https://github.com/linkedin/ambry/commit/4fe9ba0537684180eb41b92610f070b0f62cbcc3", "message": "log the selectedContainers as info log", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "fc59e8866170cced8de03162627b51265513ec0a", "url": "https://github.com/linkedin/ambry/commit/fc59e8866170cced8de03162627b51265513ec0a", "message": "remove switch", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "9bd3a6835e7143f62358b937448716cc1b893091", "url": "https://github.com/linkedin/ambry/commit/9bd3a6835e7143f62358b937448716cc1b893091", "message": "fix minor comments", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "621166707a72412e6fdc0b6cde9fc9ef14d117af", "url": "https://github.com/linkedin/ambry/commit/621166707a72412e6fdc0b6cde9fc9ef14d117af", "message": "minor change", "committedDate": "2020-05-15T01:26:40Z", "type": "commit"}, {"oid": "220d4ef86f6e608b743f1314263801e67274fb49", "url": "https://github.com/linkedin/ambry/commit/220d4ef86f6e608b743f1314263801e67274fb49", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T01:28:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDE1MQ==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425544151", "bodyText": "nit: {} in store {} is from deprecated container.\noptional: may change this to debug level", "author": "jsjtzyy", "createdAt": "2020-05-15T03:20:14Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -557,6 +580,21 @@ private boolean copyDataByIndexSegment(LogSegment logSegmentToCopy, IndexSegment\n     return copiedAll;\n   }\n \n+  /**\n+   * Determines if {@code copyCandidate} container in the status of DELETED_IN_PROGRESS or INACTIVE.\n+   * @param copyCandidate the {@link IndexEntry} to check\n+   */\n+  private boolean isFromDeprecatedContainer(IndexEntry copyCandidate) {\n+    IndexValue copyCandidateValue = copyCandidate.getValue();\n+    boolean isFromDeprecatedContainer = false;\n+    if (deprecatedContainers.contains(\n+        new Pair<>(copyCandidateValue.getAccountId(), copyCandidateValue.getContainerId()))) {\n+      logger.trace(\"{} in segment in {} is from deleted container\", copyCandidate, storeId);", "originalCommit": "220d4ef86f6e608b743f1314263801e67274fb49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1OTQxNg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425559416", "bodyText": "Done.", "author": "SophieGuo410", "createdAt": "2020-05-15T04:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDM4Mg==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425544382", "bodyText": "nit: Filters deprecated", "author": "jsjtzyy", "createdAt": "2020-05-15T03:21:12Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,22 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Filters not active {@link Container}s for compaction purpose. Deprecated status include DELETE_IN_PROGRESS and INACTIVE.", "originalCommit": "220d4ef86f6e608b743f1314263801e67274fb49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1OTM1Mw==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425559353", "bodyText": "Done!", "author": "SophieGuo410", "createdAt": "2020-05-15T04:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDQ5Ng==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425544496", "bodyText": "nit: @return the deprecated", "author": "jsjtzyy", "createdAt": "2020-05-15T03:21:48Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -194,6 +197,22 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n     resumeCompaction(bundleReadBuffer);\n   }\n \n+  /**\n+   * Filters not active {@link Container}s for compaction purpose. Deprecated status include DELETE_IN_PROGRESS and INACTIVE.\n+   * @return the not active {@link Container}s' accountId & containerId pairs.", "originalCommit": "220d4ef86f6e608b743f1314263801e67274fb49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1OTQ1OA==", "url": "https://github.com/linkedin/ambry/pull/1503#discussion_r425559458", "bodyText": "Done.", "author": "SophieGuo410", "createdAt": "2020-05-15T04:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDQ5Ng=="}], "type": "inlineReview"}, {"oid": "a336fe682ac3fcb4ca35b19a2d7ae0a65624b937", "url": "https://github.com/linkedin/ambry/commit/a336fe682ac3fcb4ca35b19a2d7ae0a65624b937", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T03:53:20Z", "type": "forcePushed"}, {"oid": "7c957bdf438a259e6307ad53ebabf7001ab0dc3c", "url": "https://github.com/linkedin/ambry/commit/7c957bdf438a259e6307ad53ebabf7001ab0dc3c", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T04:49:06Z", "type": "forcePushed"}, {"oid": "3b05e4f86d6504295483ffcbe4c501353feda9af", "url": "https://github.com/linkedin/ambry/commit/3b05e4f86d6504295483ffcbe4c501353feda9af", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T05:38:24Z", "type": "commit"}, {"oid": "3b05e4f86d6504295483ffcbe4c501353feda9af", "url": "https://github.com/linkedin/ambry/commit/3b05e4f86d6504295483ffcbe4c501353feda9af", "message": "adding config to make container deletion optional", "committedDate": "2020-05-15T05:38:24Z", "type": "forcePushed"}]}