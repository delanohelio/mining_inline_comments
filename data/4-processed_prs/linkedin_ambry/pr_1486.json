{"pr_number": 1486, "pr_title": "Make partition class more permissive for migrations", "pr_createdAt": "2020-04-24T16:31:40Z", "pr_url": "https://github.com/linkedin/ambry/pull/1486", "timeline": [{"oid": "5aa281555736335c633675eba2faeab26722b527", "url": "https://github.com/linkedin/ambry/commit/5aa281555736335c633675eba2faeab26722b527", "message": "Make partition class more permissive for migrations\n\nIf a user is migrating between ambry clusters where the partition classes\nare different, they may run into a situation where they either change\nreplicationPolicy on their container first, leading to puts in the\noriginal cluster fail, or change the cluster used first, which leads to\nputs in the new cluster failing. To aid in migration, this PR changes\nthe partition class selection behavior to fall back to the default\npartition class. In this case, a metric will be emitted and a warn log\nmessage will be written.\n\nAdditionally, this PR treats an empty string in replicationPolicy the\nsame as a null string, as this case was ambiguous before.", "committedDate": "2020-04-24T16:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg1MTQxNg==", "url": "https://github.com/linkedin/ambry/pull/1486#discussion_r416851416", "bodyText": "minor: \"No partitions for partition class = '\" + partitionClass + \"' and default partition class = '\" + defaultPartitionClass + \"' found\"", "author": "jsjtzyy", "createdAt": "2020-04-28T19:00:56Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -548,22 +551,26 @@ private boolean areAllLocalReplicasForPartitionUp(PartitionId partitionId) {\n       try {\n         if (partitionClass == null) {\n           toReturn.addAll(allPartitions);\n-        } else if (partitionIdsByClassAndLocalReplicaCount.containsKey(partitionClass)) {\n+        } else {\n           SortedMap<Integer, List<PartitionId>> partitionsByReplicaCount =\n               partitionIdsByClassAndLocalReplicaCount.get(partitionClass);\n+          if (partitionsByReplicaCount == null) {\n+            partitionsByReplicaCount = partitionIdsByClassAndLocalReplicaCount.get(defaultPartitionClass);\n+          }\n+          if (partitionsByReplicaCount == null) {\n+            throw new IllegalArgumentException(\n+                \"No partitions for default partition class \" + partitionClass + \" found\");", "originalCommit": "5aa281555736335c633675eba2faeab26722b527", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2MDQzMA==", "url": "https://github.com/linkedin/ambry/pull/1486#discussion_r416860430", "bodyText": "good catch", "author": "jsjtzyy", "createdAt": "2020-04-28T19:16:28Z", "path": "ambry-router/src/main/java/com/github/ambry/router/PutManager.java", "diffHunk": "@@ -176,7 +176,7 @@ private String getPartitionClass(BlobProperties blobProperties) {\n     Account account = accountService.getAccountById(blobProperties.getAccountId());\n     if (account != null) {\n       Container container = account.getContainerById(blobProperties.getContainerId());\n-      if (container != null && container.getReplicationPolicy() != null) {\n+      if (container != null && !Utils.isNullOrEmpty(container.getReplicationPolicy())) {", "originalCommit": "5aa281555736335c633675eba2faeab26722b527", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4cf5e0f4c705988f61305f4b8eb33ec4e1693e71", "url": "https://github.com/linkedin/ambry/commit/4cf5e0f4c705988f61305f4b8eb33ec4e1693e71", "message": "Address Yingyi's comment", "committedDate": "2020-04-29T21:24:40Z", "type": "commit"}]}