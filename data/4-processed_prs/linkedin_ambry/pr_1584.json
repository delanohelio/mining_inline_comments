{"pr_number": 1584, "pr_title": "Avoid concurrent modification on InstanceConfig when disabling partitions", "pr_createdAt": "2020-07-08T21:17:51Z", "pr_url": "https://github.com/linkedin/ambry/pull/1584", "timeline": [{"oid": "e2f43491fb1e744d93de335136776f21ef879d1f", "url": "https://github.com/linkedin/ambry/commit/e2f43491fb1e744d93de335136776f21ef879d1f", "message": "fixed test failure and made minor change", "committedDate": "2020-07-14T16:58:44Z", "type": "forcePushed"}, {"oid": "809753d410750f06c2ba9af9ab407427acd93b23", "url": "https://github.com/linkedin/ambry/commit/809753d410750f06c2ba9af9ab407427acd93b23", "message": "Avoid concurrent modification on InstanceConfig when disabling partitions\n\nSince both Ambry and Helix can update InstanceConfig, there is a race condition where\nAmbry server is removing replica entry from InstanceConfig(move replica case) and meanwhile\nHelix is adding the disabled partition into same InstanceConfig. It's possible that ambry\nserver updates InstanceConfig with an old version view, which may override the latest change\nfrom Helix. This usually happens when we use HelixBootstrapTool to remove multiple replicas\nand it may take some time to complete. Before it's done, some replicas have finished decommission\nand start to update InstanceConfig, which causes concurrent modification.\nThis PR ensures HelixBbootstrapTool creates a ZNode for specific server only when disabling partitions\non that node has fully completed. The decommission process of replicas will be blocked until\nthe ZNode is generated. Thus, concurrent modification can be avoided.", "committedDate": "2020-07-16T00:07:27Z", "type": "commit"}, {"oid": "3ff3e5450da1ac91253730fdab581990d44a9157", "url": "https://github.com/linkedin/ambry/commit/3ff3e5450da1ac91253730fdab581990d44a9157", "message": "fix test failure", "committedDate": "2020-07-16T00:07:30Z", "type": "commit"}, {"oid": "19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "url": "https://github.com/linkedin/ambry/commit/19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "message": "fixed test failure and made minor change", "committedDate": "2020-07-16T00:07:30Z", "type": "commit"}, {"oid": "19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "url": "https://github.com/linkedin/ambry/commit/19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "message": "fixed test failure and made minor change", "committedDate": "2020-07-16T00:07:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4MTM4MA==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455481380", "bodyText": "Do we have to call the helixPropertyStore.stop() and close() methods after we are done using the property store? Same comment for its usage in HelixParticipant.", "author": "cgtz", "createdAt": "2020-07-16T03:03:07Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixBootstrapUpgradeUtil.java", "diffHunk": "@@ -1072,6 +1074,24 @@ private void addUpdateResources(String dcName, Map<String, Set<String>> partitio\n         }\n       }\n     }\n+    // if there are some partitions are disabled, mark whole disabling process complete in Helix PropertyStore\n+    if (helixAdminOperation == HelixAdminOperation.DisablePartition && !instancesWithDisabledPartition.isEmpty()) {\n+      // create znode under admin configs\n+      Properties storeProps = new Properties();\n+      storeProps.setProperty(\"helix.property.store.root.path\", \"/\" + clusterName + \"/\" + PROPERTYSTORE_STR);\n+      HelixPropertyStoreConfig propertyStoreConfig = new HelixPropertyStoreConfig(new VerifiableProperties(storeProps));\n+      String zkConnectStr = dataCenterToZkAddress.get(dcName).getZkConnectStrs().get(0);\n+      HelixPropertyStore<ZNRecord> helixPropertyStore =\n+          CommonUtils.createHelixPropertyStore(zkConnectStr, propertyStoreConfig, null);", "originalCommit": "19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5MDE3Mg==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455490172", "bodyText": "Good point. Since this is one-off change, we should close it after updating the property store in Helix.", "author": "jsjtzyy", "createdAt": "2020-07-16T03:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4MTM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4MzE0NQ==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455483145", "bodyText": "Do these paths have to be manually removed using a zookeeper client after the decommission is complete and all replicas have called removeOldReplicaInfo()?\nWhat if, instead, HelixBootStrapUpgradeTool created a znode before it begins updating using HelixAdmin and then deletes it after it is finished? Than, this loop could wait for the znode to stop existing.", "author": "cgtz", "createdAt": "2020-07-16T03:09:45Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipant.java", "diffHunk": "@@ -415,6 +437,27 @@ private boolean removeOldReplicaInfo(ReplicaId replicaId, InstanceConfig instanc\n     return removalResult;\n   }\n \n+  /**\n+   * Wait until disabling partition process has completed. This is to avoid race condition where server and Helix may\n+   * modify same InstanceConfig.\n+   * TODO remove this method after migrating ambry to PropertyStore (in Helix).\n+   * @throws InterruptedException\n+   */\n+  private void awaitDisablingPartition() throws InterruptedException {\n+    Properties properties = new Properties();\n+    properties.setProperty(\"helix.property.store.root.path\", \"/\" + clusterName + \"/\" + PROPERTYSTORE_STR);\n+    HelixPropertyStoreConfig propertyStoreConfig = new HelixPropertyStoreConfig(new VerifiableProperties(properties));\n+    HelixPropertyStore<ZNRecord> helixPropertyStore =\n+        CommonUtils.createHelixPropertyStore(zkConnectStr, propertyStoreConfig, null);\n+    String path = PARTITION_DISABLED_ZNODE_PATH + instanceName;\n+    int count = 1;\n+    while (!helixPropertyStore.exists(path, AccessOption.PERSISTENT)) {", "originalCommit": "19a300d5fa2d14d93dd4e5db4f77add61e52cb20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5NDQ5Mw==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455494493", "bodyText": "Yeah, I was thinking to remove those ZNodes after decommission is done (by using HelixBootstrapTool). However, you suggestion is even better, I will take it.", "author": "jsjtzyy", "createdAt": "2020-07-16T03:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ4MzE0NQ=="}], "type": "inlineReview"}, {"oid": "dd2d7b70dfb5c40f141a0d22e8d12a99071dfb4d", "url": "https://github.com/linkedin/ambry/commit/dd2d7b70dfb5c40f141a0d22e8d12a99071dfb4d", "message": "address Casey's comments", "committedDate": "2020-07-16T05:56:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg2MDUxNQ==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455860515", "bodyText": "one weird thing I noticed was that the stop() method in ZkCacheBaseDataAccessor does more than the close() method. It also stops the background event handling thread in addition to shutting down the zkClient. We may want to call stop() instead", "author": "cgtz", "createdAt": "2020-07-16T15:09:15Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipant.java", "diffHunk": "@@ -451,11 +451,12 @@ private void awaitDisablingPartition() throws InterruptedException {\n         CommonUtils.createHelixPropertyStore(zkConnectStr, propertyStoreConfig, null);\n     String path = PARTITION_DISABLED_ZNODE_PATH + instanceName;\n     int count = 1;\n-    while (!helixPropertyStore.exists(path, AccessOption.PERSISTENT)) {\n+    while (helixPropertyStore.exists(path, AccessOption.PERSISTENT)) {\n       // Thread.sleep() pauses the current thread but does not release any locks\n       Thread.sleep(clusterMapConfig.clustermapRetryDisablePartitionCompletionBackoffMs);\n       logger.info(\"{} th attempt on checking the completion of disabling partition.\", ++count);\n     }\n+    helixPropertyStore.close();", "originalCommit": "dd2d7b70dfb5c40f141a0d22e8d12a99071dfb4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkwNTMxMQ==", "url": "https://github.com/linkedin/ambry/pull/1584#discussion_r455905311", "bodyText": "sure, let me update the method.", "author": "jsjtzyy", "createdAt": "2020-07-16T16:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg2MDUxNQ=="}], "type": "inlineReview"}, {"oid": "69295970160e497e015560e1f9bdc812bbe5b779", "url": "https://github.com/linkedin/ambry/commit/69295970160e497e015560e1f9bdc812bbe5b779", "message": "minor change", "committedDate": "2020-07-16T16:15:46Z", "type": "commit"}]}