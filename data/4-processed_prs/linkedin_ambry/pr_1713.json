{"pr_number": 1713, "pr_title": "[CLOUD_CONTAINER_DELETION] Add logs and metrics for container deletion.", "pr_createdAt": "2020-12-03T01:12:36Z", "pr_url": "https://github.com/linkedin/ambry/pull/1713", "timeline": [{"oid": "ba948ceebffc3bc3c240f8d39f63de278348e5f4", "url": "https://github.com/linkedin/ambry/commit/ba948ceebffc3bc3c240f8d39f63de278348e5f4", "message": "Add logs and metrics for container deletion.", "committedDate": "2020-12-03T01:09:32Z", "type": "commit"}, {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "url": "https://github.com/linkedin/ambry/commit/919e75fb0bf98e710c6d4808c451a454d2a845bc", "message": "Fix unit test", "committedDate": "2020-12-03T08:30:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjkzOA==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535816938", "bodyText": "Minor: Don't need String..format in logger call, use {} instead.", "author": "lightningrob", "createdAt": "2020-12-04T03:53:09Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/DeprecatedContainerCloudSyncTask.java", "diffHunk": "@@ -40,20 +42,29 @@\n    * @param cloudDestination the {@link CloudDestination} object where deprecated container information will be updated.\n    */\n   public DeprecatedContainerCloudSyncTask(AccountService accountService, long containerDeletionRetentionDays,\n-      CloudDestination cloudDestination) {\n+      CloudDestination cloudDestination, VcrMetrics vcrMetrics) {\n     this.accountService = accountService;\n     this.containerDeletionRetentionDays = containerDeletionRetentionDays;\n     this.cloudDestination = cloudDestination;\n+    this.vcrMetrics = vcrMetrics;\n   }\n \n   @Override\n   public TaskResult run() {\n+    Timer.Context deprecationTaskRunTimer = vcrMetrics.deprecationTaskRunTime.time();\n     try {\n+      logger.info(\"DeprecatedContainerCloudSyncTask run started.\");\n+      Timer.Context accountServiceFetchTimer = vcrMetrics.accountServiceFetchTime.time();\n       Set<Container> deprecatedContainers =\n           AccountUtils.getDeprecatedContainers(accountService, containerDeletionRetentionDays);\n+      accountServiceFetchTimer.stop();\n+      logger.info(String.format(\"Attempting deprecation of %d containers.\", deprecatedContainers.size()));", "originalCommit": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkxOTE0NA==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535919144", "bodyText": "fixed.", "author": "ankagrawal", "createdAt": "2020-12-04T08:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODI5OQ==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535818299", "bodyText": "What's the effect of the failure?  Is it safe to just log and continue?  I guess container deprecation isn't fail fast situation, but how will we know something is wrong if we don't see the log message?", "author": "lightningrob", "createdAt": "2020-12-04T03:57:26Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/HelixVcrCluster.java", "diffHunk": "@@ -181,12 +184,16 @@ private void registerContainerDeletionSyncTask(StateMachineEngine engine) {\n         @Override\n         public Task createNewTask(TaskCallbackContext context) {\n           return new DeprecatedContainerCloudSyncTask(accountService, storeConfig.storeContainerDeletionRetentionDays,\n-              cloudDestination);\n+              cloudDestination, vcrMetrics);\n         }\n       });\n       if (!taskFactoryMap.isEmpty()) {\n-        engine.registerStateModelFactory(TaskConstants.STATE_MODEL_NAME,\n-            new TaskStateModelFactory(manager, taskFactoryMap));\n+        if (engine.registerStateModelFactory(TaskConstants.STATE_MODEL_NAME,\n+            new TaskStateModelFactory(manager, taskFactoryMap))) {\n+          logger.info(\"Container deletion sync task registered with helix.\");\n+        } else {\n+          logger.error(\"Container deletion sync task registration with helix failed.\");", "originalCommit": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyNDM3MQ==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535924371", "bodyText": "The sync task will fail if the registration fails. In this case no new containers will be deprecated in cloud.\nAdded a metrics to track task registration failures. We can create an alert on this metric.", "author": "ankagrawal", "createdAt": "2020-12-04T08:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODk1NA==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535818954", "bodyText": "Same here.", "author": "lightningrob", "createdAt": "2020-12-04T03:59:46Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -122,9 +132,14 @@ public void compactAssignedDeprecatedContainers(Collection<? extends PartitionId\n         containerDeletionEntrySet.remove(containerDeletionEntry);\n         for (String partitionId : containerDeletionEntry.getDeletePendingPartitions()) {\n           try {\n+            logger.info(String.format(\"Starting compaction of container %d, account %d in partition %s\",", "originalCommit": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzMjg1MQ==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535932851", "bodyText": "fixed.", "author": "ankagrawal", "createdAt": "2020-12-04T08:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyMDY1MA==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535820650", "bodyText": "When does this throw CloudStorageException?", "author": "lightningrob", "createdAt": "2020-12-04T04:05:31Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -67,16 +68,20 @@\n    * @param cloudConfig {@link CloudConfig} object.\n    * @param vcrMetrics {@link VcrMetrics} object.\n    * @param azureMetrics {@link AzureMetrics} object.\n+   * @throws CloudStorageException if case of any error.\n    */\n   public AzureContainerCompactor(AzureBlobDataAccessor azureBlobDataAccessor, CosmosDataAccessor cosmosDataAccessor,\n-      CloudConfig cloudConfig, AzureCloudConfig azureCloudConfig, VcrMetrics vcrMetrics, AzureMetrics azureMetrics) {\n+      CloudConfig cloudConfig, AzureCloudConfig azureCloudConfig, VcrMetrics vcrMetrics, AzureMetrics azureMetrics)\n+      throws CloudStorageException {", "originalCommit": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyODE1Ng==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535928156", "bodyText": "It throws CloudStorageException due to this.latestContainerDeletionTimestamp = getLatestContainerDeletionTime() at line 83. This fetches the last timestamp upto which cosmos db container deprecation table is in sync with account service.", "author": "ankagrawal", "createdAt": "2020-12-04T08:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyMDY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NTQxNw==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535855417", "bodyText": "minor: will this be used in the future pr?", "author": "SophieGuo410", "createdAt": "2020-12-04T05:57:33Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -139,6 +154,13 @@ public void compactAssignedDeprecatedContainers(Collection<? extends PartitionId\n     }\n   }\n \n+  /**\n+   * @return the latest container deletion timestamp.\n+   */\n+  public long getLatestContainerDeletionTimestamp() {", "originalCommit": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzMzQ0MA==", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535933440", "bodyText": "Its being used in AzureMetrics class.", "author": "ankagrawal", "createdAt": "2020-12-04T08:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NTQxNw=="}], "type": "inlineReview"}, {"oid": "b7ec1879efe1d12c90f7d82666b0084e3778d7e6", "url": "https://github.com/linkedin/ambry/commit/b7ec1879efe1d12c90f7d82666b0084e3778d7e6", "message": "Address review comments.", "committedDate": "2020-12-04T09:08:21Z", "type": "commit"}]}