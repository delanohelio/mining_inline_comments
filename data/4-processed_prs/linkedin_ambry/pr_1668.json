{"pr_number": 1668, "pr_title": "Upgrade metrics to 4.1.2, allow custom configuration for JmxReporter", "pr_createdAt": "2020-10-22T16:24:51Z", "pr_url": "https://github.com/linkedin/ambry/pull/1668", "timeline": [{"oid": "922d2723b05515c25f88a5c197feb771e419486e", "url": "https://github.com/linkedin/ambry/commit/922d2723b05515c25f88a5c197feb771e419486e", "message": "Upgrade metrics to 4.1.2, allow custom configuration for JmxReporter\n\n- Upgrade dropwizard metrics to 4.1.2\n- Upgrading to 4.1.2 brings some changes in MBean naming in JmxReporter,\n  which can effect users that query these MBeans based on naming patterns.\n- To address this, add an optional argument to each \"server\" class to\n  allow users to pass in a factory that produces a JmxReporter with\n  non-default configs.", "committedDate": "2020-10-22T16:19:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyODYzNQ==", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510428635", "bodyText": "nit, complete the comment", "author": "jsjtzyy", "createdAt": "2020-10-22T20:12:25Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrServer.java", "diffHunk": "@@ -98,10 +103,12 @@ public VcrServer(VerifiableProperties properties, ClusterAgentsFactory clusterAg\n    * @param clusterAgentsFactory the {@link ClusterAgentsFactory} to use.\n    * @param notificationSystem the {@link NotificationSystem} to use.\n    * @param cloudDestinationFactory the {@link CloudDestinationFactory} to use.\n+   * @param reporterFactory", "originalCommit": "922d2723b05515c25f88a5c197feb771e419486e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4796e902ae1f747b4c255a8463d9b22f90117d97", "url": "https://github.com/linkedin/ambry/commit/4796e902ae1f747b4c255a8463d9b22f90117d97", "message": "fix doc", "committedDate": "2020-10-22T22:54:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDkyOQ==", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510514929", "bodyText": "I like this Function usage.  It's inconsistent with the other factory interfaces we use, but it seems like a sensible shortcut.", "author": "lightningrob", "createdAt": "2020-10-22T23:36:18Z", "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrServer.java", "diffHunk": "@@ -74,6 +75,7 @@\n   private JmxReporter reporter = null;\n   private ConnectionPool connectionPool = null;\n   private final NotificationSystem notificationSystem;\n+  private final Function<MetricRegistry, JmxReporter> reporterFactory;", "originalCommit": "4796e902ae1f747b4c255a8463d9b22f90117d97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MTA3MQ==", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510981071", "bodyText": "I was going to add a Factory instance but putting it in a place where all 3 entry points (server, frontend, vcr) could share it without adding a dependency on metrics-jmx to a package became a problem (metrics-jmx is where the JmxReporter class is defined)", "author": "cgtz", "createdAt": "2020-10-23T15:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNjEyMg==", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510516122", "bodyText": "Ideally we should have a test case that passes a non-null reporterFactory.", "author": "lightningrob", "createdAt": "2020-10-22T23:40:27Z", "path": "ambry-rest/src/main/java/com/github/ambry/rest/RestServer.java", "diffHunk": "@@ -171,17 +172,20 @@ public RestServer(VerifiableProperties verifiableProperties, ClusterMap clusterM\n    * @param sslFactory the {@link SSLFactory} to be used. This can be {@code null} if no components require SSL support.\n    * @param addedChannelHandlers a list of {@link ChannelHandler} to add to the {@link io.netty.channel.ChannelInitializer} before\n    *                             the final handler.\n+   * @param reporterFactory if non-null, use this function to set up a {@link JmxReporter} with custom settings. If this\n+   *                        option is null the default settings for the reporter will be used.\n    * @throws InstantiationException if there is any error instantiating an instance of RestServer.\n    */\n   public RestServer(VerifiableProperties verifiableProperties, ClusterMap clusterMap,\n-      NotificationSystem notificationSystem, SSLFactory sslFactory, List<ChannelHandler> addedChannelHandlers)\n-      throws Exception {\n+      NotificationSystem notificationSystem, SSLFactory sslFactory, List<ChannelHandler> addedChannelHandlers,\n+      Function<MetricRegistry, JmxReporter> reporterFactory) throws Exception {\n     if (verifiableProperties == null || clusterMap == null || notificationSystem == null) {\n       throw new IllegalArgumentException(\"Null arg(s) received during instantiation of RestServer\");\n     }\n     MetricRegistry metricRegistry = clusterMap.getMetricRegistry();\n     RestServerConfig restServerConfig = new RestServerConfig(verifiableProperties);\n-    reporter = JmxReporter.forRegistry(metricRegistry).build();\n+    reporter = reporterFactory != null ? reporterFactory.apply(metricRegistry)", "originalCommit": "4796e902ae1f747b4c255a8463d9b22f90117d97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzODE0NA==", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r511038144", "bodyText": "added cases for each server class", "author": "cgtz", "createdAt": "2020-10-23T17:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNjEyMg=="}], "type": "inlineReview"}, {"oid": "f35debc562b97b138f26aadbd76c5a13a3e3a920", "url": "https://github.com/linkedin/ambry/commit/f35debc562b97b138f26aadbd76c5a13a3e3a920", "message": "Add test cases", "committedDate": "2020-10-23T17:37:35Z", "type": "commit"}]}