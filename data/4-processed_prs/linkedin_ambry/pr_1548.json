{"pr_number": 1548, "pr_title": "Fix a concurrency bug caused by offset comparison", "pr_createdAt": "2020-06-03T00:05:50Z", "pr_url": "https://github.com/linkedin/ambry/pull/1548", "timeline": [{"oid": "80adfceffc1cd3e1f5451f51af9933cca84ed2f4", "url": "https://github.com/linkedin/ambry/commit/80adfceffc1cd3e1f5451f51af9933cca84ed2f4", "message": "Fix a concurrency bug caused by offset comparison", "committedDate": "2020-06-02T23:56:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwODAxOQ==", "url": "https://github.com/linkedin/ambry/pull/1548#discussion_r434308019", "bodyText": "Why not idToDelete = liveKeys.iterator().next(); ?", "author": "jsjtzyy", "createdAt": "2020-06-03T04:58:29Z", "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreTest.java", "diffHunk": "@@ -643,6 +643,59 @@ public void concurrentDeleteTest() throws Exception {\n     verifyDeleteFutures(deleters, futures);\n   }\n \n+  /**\n+   * Test when deleting the same blob at the same time. Only one delete can go through and only one log and index\n+   * record should be persisted.\n+   * @throws Exception\n+   */\n+  @Test\n+  public void concurrentDeleteTestOnSameBlob() throws Exception {\n+    MockId idToDelete = null;\n+    for (MockId id : liveKeys) {\n+      idToDelete = id;\n+      break;\n+    }", "originalCommit": "80adfceffc1cd3e1f5451f51af9933cca84ed2f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwOTMzMA==", "url": "https://github.com/linkedin/ambry/pull/1548#discussion_r434309330", "bodyText": "same here", "author": "jsjtzyy", "createdAt": "2020-06-03T05:03:36Z", "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreTest.java", "diffHunk": "@@ -678,6 +731,59 @@ public void concurrentUndeleteTest() throws Exception {\n     verifyUndeleteFutures(undeleters, futures);\n   }\n \n+  /**\n+   * Test when undeleting the same blob at the same time. Only one undelete can go through and only one log and index\n+   * record should be persisted.\n+   * @throws Exception\n+   */\n+  @Test\n+  public void concurrentUndeleteTestOnSameBlob() throws Exception {\n+    MockId idToUndelete = null;\n+    for (MockId id : deletedKeys) {\n+      idToUndelete = id;\n+      break;\n+    }", "originalCommit": "80adfceffc1cd3e1f5451f51af9933cca84ed2f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6c6cc713a07a45bcc976b8b1ff930c54c1e6965", "url": "https://github.com/linkedin/ambry/commit/e6c6cc713a07a45bcc976b8b1ff930c54c1e6965", "message": "Comments", "committedDate": "2020-06-03T06:09:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NjMxMQ==", "url": "https://github.com/linkedin/ambry/pull/1548#discussion_r434696311", "bodyText": "Sleep indeed can mock the situation but the time seems a little bit long here. Can we use latch instead?", "author": "jsjtzyy", "createdAt": "2020-06-03T16:24:00Z", "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreTest.java", "diffHunk": "@@ -643,6 +643,61 @@ public void concurrentDeleteTest() throws Exception {\n     verifyDeleteFutures(deleters, futures);\n   }\n \n+  /**\n+   * Test when deleting the same blob at the same time. Only one delete can go through and only one log and index\n+   * record should be persisted.\n+   * @throws Exception\n+   */\n+  @Test\n+  public void concurrentDeleteTestOnSameBlob() throws Exception {\n+    final MockId idToDelete = liveKeys.iterator().next();\n+    assertNotNull(idToDelete);\n+    ((MockBlobStore) store).setOperationBeforeSynchronizationFunc(() -> {\n+      try {\n+        Thread.sleep(1000);", "originalCommit": "e6c6cc713a07a45bcc976b8b1ff930c54c1e6965", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a68615e6af404bed0859faa2a1bcffb12aa8a97", "url": "https://github.com/linkedin/ambry/commit/4a68615e6af404bed0859faa2a1bcffb12aa8a97", "message": "Address comments", "committedDate": "2020-06-03T17:15:50Z", "type": "commit"}, {"oid": "d0e2cbbbf00f43cbc6d517fa8dddb6564be47a5a", "url": "https://github.com/linkedin/ambry/commit/d0e2cbbbf00f43cbc6d517fa8dddb6564be47a5a", "message": "Fix test failure", "committedDate": "2020-06-03T18:15:25Z", "type": "commit"}]}