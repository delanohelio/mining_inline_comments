{"pr_number": 3899, "pr_title": "[Sharding Scaling]Refactor to support PostgreSQL", "pr_createdAt": "2020-01-08T08:34:23Z", "pr_url": "https://github.com/apache/shardingsphere/pull/3899", "timeline": [{"oid": "8c41a51fbf53218b2e22eb62c4c11af26f31c652", "url": "https://github.com/apache/shardingsphere/commit/8c41a51fbf53218b2e22eb62c4c11af26f31c652", "message": "Refactor AbstractJdbcReader & Fix stream resultset", "committedDate": "2020-01-07T13:54:26Z", "type": "commit"}, {"oid": "072f4f6ee077f78898ea5e6c7a5c4d1ac3302190", "url": "https://github.com/apache/shardingsphere/commit/072f4f6ee077f78898ea5e6c7a5c4d1ac3302190", "message": "Support PostgreSQL identifier quote string", "committedDate": "2020-01-07T13:55:00Z", "type": "commit"}, {"oid": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "url": "https://github.com/apache/shardingsphere/commit/41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "message": "Refactor DistributionChannel, avoid deadlock", "committedDate": "2020-01-07T13:55:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExODMzMg==", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364118332", "bodyText": "Abstract class should not perceive the specific type, it can use abstract method replace, and let subClass to implement.", "author": "KomachiSion", "createdAt": "2020-01-08T08:49:13Z", "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/reader/AbstractJdbcReader.java", "diffHunk": "@@ -48,46 +48,44 @@\n  */\n @Slf4j\n public abstract class AbstractJdbcReader extends AbstractSyncRunner implements JdbcReader {\n-\n+    \n     @Getter(AccessLevel.PROTECTED)\n     private final RdbmsConfiguration rdbmsConfiguration;\n     \n     private final DataSourceFactory dataSourceFactory;\n-\n+    \n     @Setter\n     private Channel channel;\n-\n+    \n     public AbstractJdbcReader(final RdbmsConfiguration rdbmsConfiguration, final DataSourceFactory dataSourceFactory) {\n         if (!JdbcDataSourceConfiguration.class.equals(rdbmsConfiguration.getDataSourceConfiguration().getClass())) {\n             throw new UnsupportedOperationException(\"AbstractJdbcReader only support JdbcDataSourceConfiguration\");\n         }\n         this.rdbmsConfiguration = rdbmsConfiguration;\n         this.dataSourceFactory = dataSourceFactory;\n     }\n-\n+    \n     @Override\n     public final void run() {\n         start();\n         read(channel);\n     }\n-\n+    \n     @Override\n     public final void read(final Channel channel) {\n         try (Connection conn = dataSourceFactory.getDataSource(rdbmsConfiguration.getDataSourceConfiguration()).getConnection()) {\n             String sql = String.format(\"select * from %s %s\", rdbmsConfiguration.getTableName(), rdbmsConfiguration.getWhereCondition());\n             PreparedStatement ps = conn.prepareStatement(sql, java.sql.ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);\n-            ps.setFetchSize(100);\n-            ps.setFetchDirection(ResultSet.FETCH_REVERSE);\n+            ps.setFetchSize(Integer.MIN_VALUE);\n             ResultSet rs = ps.executeQuery();\n             ResultSetMetaData metaData = rs.getMetaData();\n             while (isRunning() && rs.next()) {\n                 DataRecord record = new DataRecord(new NopLogPosition(), metaData.getColumnCount());\n                 record.setType(\"bootstrap-insert\");\n                 record.setTableName(rdbmsConfiguration.getTableNameMap().get(rdbmsConfiguration.getTableName()));\n                 for (int i = 1; i <= metaData.getColumnCount(); i++) {\n-                    if (Types.TIME == rs.getMetaData().getColumnType(i)\n-                            || Types.DATE == rs.getMetaData().getColumnType(i)\n-                            || Types.TIMESTAMP == rs.getMetaData().getColumnType(i)) {\n+                    if (\"MySQL\".equals(rdbmsConfiguration.getDataSourceConfiguration().getDatabaseType().getName())\n+                            && isDateTimeValue(rs.getMetaData().getColumnType(i))) {", "originalCommit": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExOTExNg==", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364119116", "bodyText": "Similar problem as AbstractJdbcReader.\nThis can abstract a protect method, and let subClass to implement.\nOr create a new interface to handle this situation.\neach type database has implement, SQLBuilder only call interface.", "author": "KomachiSion", "createdAt": "2020-01-08T08:51:03Z", "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -66,6 +66,23 @@ public String load(final String key) {\n                     }\n                 });\n     }\n+    \n+    private void initIdentifierQuoteString(final String databaseType) {\n+        switch (databaseType) {\n+            case \"MySQL\":\n+                leftIdentifierQuoteString = \"`\";\n+                rightIdentifierQuoteString = \"`\";\n+                break;\n+            case \"PostgreSQL\":\n+                leftIdentifierQuoteString = \"\\\"\";\n+                rightIdentifierQuoteString = \"\\\"\";\n+                break;\n+            default:\n+                leftIdentifierQuoteString = \"\";\n+                rightIdentifierQuoteString = \"\";\n+                break;\n+        }\n+    }", "originalCommit": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "url": "https://github.com/apache/shardingsphere/commit/eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "message": "Refactor AbstractJdbcReader", "committedDate": "2020-01-08T13:15:19Z", "type": "commit"}, {"oid": "eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "url": "https://github.com/apache/shardingsphere/commit/eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "message": "Refactor AbstractJdbcReader", "committedDate": "2020-01-08T13:15:19Z", "type": "forcePushed"}, {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f", "url": "https://github.com/apache/shardingsphere/commit/afa5224364259e2c4675fc48e6355b4ccb73c73f", "message": "Refactor SqlBuilder", "committedDate": "2020-01-08T13:44:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxODU2OA==", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364518568", "bodyText": "protected may be enough.", "author": "KomachiSion", "createdAt": "2020-01-09T01:06:51Z", "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/reader/AbstractJdbcReader.java", "diffHunk": "@@ -102,7 +93,19 @@ public final void read(final Channel channel) {\n             pushRecord(new FinishedRecord(new NopLogPosition()));\n         }\n     }\n-\n+    \n+    /**\n+     * Read value from {@code ResultSet}.\n+     *\n+     * @param resultSet result set\n+     * @param index of read column\n+     * @return value\n+     * @throws SQLException sql exception\n+     */\n+    public Object readValue(final ResultSet resultSet, final int index) throws SQLException {", "originalCommit": "afa5224364259e2c4675fc48e6355b4ccb73c73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxOTAwNQ==", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364519005", "bodyText": "Should we rename the class?", "author": "KomachiSion", "createdAt": "2020-01-09T01:08:42Z", "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -20,33 +20,28 @@\n import com.google.common.cache.CacheBuilder;\n import com.google.common.cache.CacheLoader;\n import com.google.common.cache.LoadingCache;\n+import org.apache.shardingsphere.shardingscaling.core.metadata.ColumnMetaData;\n+import org.apache.shardingsphere.shardingscaling.core.util.DbMetaDataUtil;\n \n import javax.sql.DataSource;\n import java.util.List;\n import java.util.concurrent.ExecutionException;\n \n-import org.apache.shardingsphere.shardingscaling.core.util.DbMetaDataUtil;\n-import org.apache.shardingsphere.shardingscaling.core.metadata.ColumnMetaData;\n-\n /**\n  * Sql builder.\n  *\n  * @author avalon566\n  */\n-public final class SqlBuilder {\n-    \n-    private static final String LEFT_ESCAPE_QUOTE = \"`\";\n-\n-    private static final String RIGHT_ESCAPE_QUOTE = \"`\";\n+public abstract class SqlBuilder {", "originalCommit": "afa5224364259e2c4675fc48e6355b4ccb73c73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyMDM0NA==", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364520344", "bodyText": "protected may be enough.", "author": "KomachiSion", "createdAt": "2020-01-09T01:14:44Z", "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -66,6 +61,20 @@ public String load(final String key) {\n                     }\n                 });\n     }\n+    \n+    /**\n+     * Get left identifier quote string.\n+     *\n+     * @return string\n+     */\n+    public abstract String getLeftIdentifierQuoteString();", "originalCommit": "afa5224364259e2c4675fc48e6355b4ccb73c73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1078f6b81f75f73963816678f7e6f6989b77fba5", "url": "https://github.com/apache/shardingsphere/commit/1078f6b81f75f73963816678f7e6f6989b77fba5", "message": "Refactor", "committedDate": "2020-01-09T03:56:34Z", "type": "commit"}]}