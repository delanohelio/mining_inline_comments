{"pr_number": 4502, "pr_title": "#4501, Identify MySQL syntax allowed in Prepared Statements", "pr_createdAt": "2020-02-27T10:52:45Z", "pr_url": "https://github.com/apache/shardingsphere/pull/4502", "timeline": [{"oid": "4a7af2e3115fbe38ffdeb0d38035e16f05d92404", "url": "https://github.com/apache/shardingsphere/commit/4a7af2e3115fbe38ffdeb0d38035e16f05d92404", "message": "#4501, Identify MySQL syntax allowed in Prepared Statements", "committedDate": "2020-02-27T10:48:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4OTMzMw==", "url": "https://github.com/apache/shardingsphere/pull/4502#discussion_r385089333", "bodyText": "Can we move the SQL parser logic into parser module?", "author": "terrymanu", "createdAt": "2020-02-27T12:14:38Z", "path": "sharding-proxy/sharding-proxy-frontend/sharding-proxy-frontend-mysql/src/main/java/org/apache/shardingsphere/shardingproxy/frontend/mysql/command/query/binary/prepare/MySQLComStmtPrepareExecutor.java", "diffHunk": "@@ -17,38 +17,79 @@\n \n package org.apache.shardingsphere.shardingproxy.frontend.mysql.command.query.binary.prepare;\n \n-import org.apache.shardingsphere.sql.parser.sql.statement.SQLStatement;\n import org.apache.shardingsphere.shardingproxy.backend.communication.jdbc.connection.BackendConnection;\n import org.apache.shardingsphere.shardingproxy.backend.schema.LogicSchema;\n import org.apache.shardingsphere.shardingproxy.frontend.api.CommandExecutor;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.constant.MySQLColumnType;\n+import org.apache.shardingsphere.shardingproxy.transport.mysql.constant.MySQLServerErrorCode;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.MySQLColumnDefinition41Packet;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.MySQLBinaryStatementRegistry;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.prepare.MySQLComStmtPrepareOKPacket;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.prepare.MySQLComStmtPreparePacket;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.generic.MySQLEofPacket;\n+import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.generic.MySQLErrPacket;\n import org.apache.shardingsphere.shardingproxy.transport.packet.DatabasePacket;\n+import org.apache.shardingsphere.sql.parser.sql.statement.SQLStatement;\n import org.apache.shardingsphere.sql.parser.sql.statement.dml.SelectStatement;\n \n+import java.util.Arrays;\n import java.util.Collection;\n+import java.util.HashSet;\n import java.util.LinkedList;\n+import java.util.Set;\n \n /**\n  * COM_STMT_PREPARE command executor for MySQL.\n+ *\n+ * @see <a href=\"https://dev.mysql.com/doc/refman/5.7/en/sql-prepared-statements.html\">SQL Syntax Allowed in Prepared Statements</a>\n  */\n public final class MySQLComStmtPrepareExecutor implements CommandExecutor {\n     \n+    private static final Set<String> SQL_SYNTAX_ALLOWED = new HashSet<>();\n+    \n+    private static final int MAX_CHECK_TOKENS = \"FLUSH TABLES WITH READ LOCK\".split(\"\\\\W+\").length;\n+    \n     private static final MySQLBinaryStatementRegistry PREPARED_STATEMENT_REGISTRY = MySQLBinaryStatementRegistry.getInstance();\n     \n     private final MySQLComStmtPreparePacket packet;\n     \n     private final LogicSchema logicSchema;\n     \n+    static {\n+        SQL_SYNTAX_ALLOWED.addAll(Arrays.asList(\"ALTER\" + \"TABLE\", \"ALTER\" + \"USER\", \"ANALYZE\" + \"TABLE\",\n+            \"CACHE\" + \"INDEX\", \"CALL\", \"CHANGE\" + \"MASTER\", \"CHECKSUM\" + \"TABLE\", \"CHECKSUM\" + \"TABLES\",\n+            \"COMMIT\", \"CREATE\" + \"INDEX\", \"DROP\" + \"INDEX\", \"CREATE\" + \"DATABASE\", \"RENAME\" + \"DATABASE\",\n+            \"DROP\" + \"DATABASE\", \"CREATE\" + \"TABLE\", \"DROP\" + \"TABLE\", \"CREATE\" + \"USER\", \"RENAME\" + \"USER\",\n+            \"DROP\" + \"USER\", \"CREATE\" + \"VIEW\", \"DROP\" + \"VIEW\", \"DELETE\", \"DO\", \"FLUSH\" + \"TABLE\",\n+            \"FLUSH\" + \"TABLES\", \"FLUSH\" + \"TABLES\" + \"WITH\" + \"READ\" + \"LOCK\", \"FLUSH\" + \"HOSTS\",\n+            \"FLUSH\" + \"PRIVILEGES\", \"FLUSH\" + \"LOGS\", \"FLUSH\" + \"STATUS\", \"FLUSH\" + \"MASTER\", \"FLUSH\" + \"SLAVE\",\n+            \"FLUSH\" + \"DES_KEY_FILE\", \"FLUSH\" + \"USER\" + \"RESOURCES\", \"GRANT\", \"INSERT\", \"INSTALL\" + \"PLUGIN\",\n+            \"KILL\", \"LOAD\" + \"INDEX\" + \"INTO\" + \"CACHE\", \"OPTIMIZE\" + \"TABLE\", \"RENAME\" + \"TABLE\",\n+            \"REPAIR\" + \"TABLE\", \"REPLACE\", \"RESET\" + \"MASTER\", \"RESET\" + \"SLAVE\", \"RESET\" + \"QUERY CACHE\",", "originalCommit": "4a7af2e3115fbe38ffdeb0d38035e16f05d92404", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwODU3Ng==", "url": "https://github.com/apache/shardingsphere/pull/4502#discussion_r385508576", "bodyText": "Yes, the logic should be moved to parser module.", "author": "tuohai666", "createdAt": "2020-02-28T05:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4OTMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MDE0NA==", "url": "https://github.com/apache/shardingsphere/pull/4502#discussion_r386960144", "bodyText": "Finish.", "author": "tuohai666", "createdAt": "2020-03-03T11:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4OTMzMw=="}], "type": "inlineReview"}, {"oid": "1475d18fe238909fa83d01c1040aeedb8f54d53e", "url": "https://github.com/apache/shardingsphere/commit/1475d18fe238909fa83d01c1040aeedb8f54d53e", "message": "#4501, revert", "committedDate": "2020-02-28T07:19:37Z", "type": "commit"}, {"oid": "463108e791ac8d1e52aab6c91334e62f80b4d616", "url": "https://github.com/apache/shardingsphere/commit/463108e791ac8d1e52aab6c91334e62f80b4d616", "message": "#4501, add Statements", "committedDate": "2020-02-28T09:51:22Z", "type": "commit"}, {"oid": "82ebcf3552c81ff79ed010d3a65408f06dd01198", "url": "https://github.com/apache/shardingsphere/commit/82ebcf3552c81ff79ed010d3a65408f06dd01198", "message": "Merge branch 'master' of https://github.com/apache/incubator-shardingsphere into issue4501", "committedDate": "2020-03-01T13:50:59Z", "type": "commit"}, {"oid": "ac2f51f4dfebe93aa7a9adc6e2f824c2a702c65b", "url": "https://github.com/apache/shardingsphere/commit/ac2f51f4dfebe93aa7a9adc6e2f824c2a702c65b", "message": "#4501, add Statements", "committedDate": "2020-03-03T05:21:59Z", "type": "commit"}, {"oid": "8ae037dd57f5165b1d5e72e091d7eb74af09064e", "url": "https://github.com/apache/shardingsphere/commit/8ae037dd57f5165b1d5e72e091d7eb74af09064e", "message": "#4501, add Statements", "committedDate": "2020-03-03T07:02:58Z", "type": "commit"}, {"oid": "5044f5d7bcfe5292b8669a1025d68f6a5e3e5ebf", "url": "https://github.com/apache/shardingsphere/commit/5044f5d7bcfe5292b8669a1025d68f6a5e3e5ebf", "message": "#4501, add Statements", "committedDate": "2020-03-03T08:30:35Z", "type": "commit"}, {"oid": "456b1861c81bb801f460876c57258adf17f89590", "url": "https://github.com/apache/shardingsphere/commit/456b1861c81bb801f460876c57258adf17f89590", "message": "#4501, add Statements", "committedDate": "2020-03-03T08:34:34Z", "type": "commit"}, {"oid": "0fb3a3f1196c0e0fb943f100d7501b050a4d8422", "url": "https://github.com/apache/shardingsphere/commit/0fb3a3f1196c0e0fb943f100d7501b050a4d8422", "message": "Merge branch 'master' of https://github.com/apache/incubator-shardingsphere into issue4501", "committedDate": "2020-03-03T08:36:04Z", "type": "commit"}, {"oid": "1b893524b037f60f07b42ca87a340f830f4050c4", "url": "https://github.com/apache/shardingsphere/commit/1b893524b037f60f07b42ca87a340f830f4050c4", "message": "#4501, add Statements", "committedDate": "2020-03-03T09:38:56Z", "type": "commit"}, {"oid": "9eff8ebb2235d20fcb62417eca3688bd859c51b1", "url": "https://github.com/apache/shardingsphere/commit/9eff8ebb2235d20fcb62417eca3688bd859c51b1", "message": "#4501, add Statements", "committedDate": "2020-03-03T09:57:58Z", "type": "commit"}, {"oid": "555794b6e12b543d5a3ccd98c4d173c0307a857b", "url": "https://github.com/apache/shardingsphere/commit/555794b6e12b543d5a3ccd98c4d173c0307a857b", "message": "#4501, add MySQLComStmtPrepareChecker", "committedDate": "2020-03-03T10:08:02Z", "type": "commit"}, {"oid": "602b521e712235a6a6d63c0d0fa401d73a32935b", "url": "https://github.com/apache/shardingsphere/commit/602b521e712235a6a6d63c0d0fa401d73a32935b", "message": "#4501, for checkstyle", "committedDate": "2020-03-03T10:30:15Z", "type": "commit"}, {"oid": "bcd9ef884a802ef0bcd2460e01d6bac6158c0478", "url": "https://github.com/apache/shardingsphere/commit/bcd9ef884a802ef0bcd2460e01d6bac6158c0478", "message": "#4501, for checkstyle", "committedDate": "2020-03-03T10:30:49Z", "type": "commit"}, {"oid": "da69dac501abfaff1d665f114121b2cee3984b3d", "url": "https://github.com/apache/shardingsphere/commit/da69dac501abfaff1d665f114121b2cee3984b3d", "message": "#4501, refine", "committedDate": "2020-03-03T10:40:25Z", "type": "commit"}]}