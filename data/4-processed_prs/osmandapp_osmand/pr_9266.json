{"pr_number": 9266, "pr_title": "Add Wikipedia Banner in search for free app version", "pr_createdAt": "2020-06-18T06:03:48Z", "pr_url": "https://github.com/osmandapp/OsmAnd/pull/9266", "timeline": [{"oid": "7346e272be5591822540d1ea087d39c4100382b6", "url": "https://github.com/osmandapp/OsmAnd/commit/7346e272be5591822540d1ea087d39c4100382b6", "message": "Add Wikipedia Banner in search for free app version\nAdd \"Download Wikipedia maps\" in search when no results and wiki maps for region available", "committedDate": "2020-06-18T06:02:10Z", "type": "commit"}, {"oid": "28247397caff355639f21b9ecd5e69c7aba9ee81", "url": "https://github.com/osmandapp/OsmAnd/commit/28247397caff355639f21b9ecd5e69c7aba9ee81", "message": "Show wikipedia articles in chosen language", "committedDate": "2020-06-18T08:44:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc3OTQ5OA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r442779498", "bodyText": "Static method and only used in different class? Doesn't look good", "author": "vshcherb", "createdAt": "2020-06-19T11:10:06Z", "path": "OsmAnd/src/net/osmand/plus/wikipedia/WikipediaPoiMenu.java", "diffHunk": "@@ -357,4 +360,38 @@ public static String getWikiArticleLanguage(@NonNull OsmandApplication app,\n \t\t}\n \t\treturn preferredLanguage;\n \t}\n+\n+\tpublic static void showDownloadWikiScreen(MapActivity mapActivity) {\n+\t\tOsmandMapTileView mv = mapActivity.getMapView();\n+\t\tDownloadedRegionsLayer dl = mv.getLayerByClass(DownloadedRegionsLayer.class);\n+\t\tString filter = dl.getFilter(new StringBuilder());\n+\t\tfinal Intent intent = new Intent(mapActivity,\n+\t\t\t\tmapActivity.getMyApplication().getAppCustomization().getDownloadIndexActivity());\n+\t\tintent.putExtra(DownloadActivity.FILTER_KEY, filter);\n+\t\tintent.putExtra(DownloadActivity.FILTER_CAT, DownloadActivityType.WIKIPEDIA_FILE.getTag());\n+\t\tintent.putExtra(DownloadActivity.TAB_TO_OPEN, DownloadActivity.DOWNLOAD_TAB);\n+\t\tmapActivity.startActivity(intent);\n+\t}\n+\n+\tpublic static boolean hasWikiMapsToDownload(MapActivity ma) {\n+\t\ttry {\n+\t\t\treturn DownloadResources.findIndexItemsAt(ma.getMyApplication(), ma.getMapLocation(),\n+\t\t\t\t\tDownloadActivityType.WIKIPEDIA_FILE, false, 1).size() > 0;\n+\t\t} catch (IOException e) {\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\tpublic static boolean isWikiSearch(SearchPhrase phrase) {", "originalCommit": "28247397caff355639f21b9ecd5e69c7aba9ee81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cd3d2e33a194425a4b7284a3cf0dacf352b150cc", "url": "https://github.com/osmandapp/OsmAnd/commit/cd3d2e33a194425a4b7284a3cf0dacf352b150cc", "message": "add WikipediaPlugin", "committedDate": "2020-06-22T06:55:09Z", "type": "commit"}, {"oid": "63e2f5bbb2c971b86ef95e45113e2cce8b6eef5c", "url": "https://github.com/osmandapp/OsmAnd/commit/63e2f5bbb2c971b86ef95e45113e2cce8b6eef5c", "message": "small fixes", "committedDate": "2020-06-22T07:06:00Z", "type": "commit"}, {"oid": "2357fb9bfbfaa3e34489eadcf84dccc71a9829be", "url": "https://github.com/osmandapp/OsmAnd/commit/2357fb9bfbfaa3e34489eadcf84dccc71a9829be", "message": "add icon and name to WikipediaPlugin", "committedDate": "2020-06-22T09:42:46Z", "type": "commit"}, {"oid": "9fa3c0f31346190d4b2239d51b5c3791fee26b91", "url": "https://github.com/osmandapp/OsmAnd/commit/9fa3c0f31346190d4b2239d51b5c3791fee26b91", "message": "add description to WikipediaPlugin", "committedDate": "2020-06-22T09:55:15Z", "type": "commit"}, {"oid": "6aa58257fe72bb4d83e82741dad845788735e0a8", "url": "https://github.com/osmandapp/OsmAnd/commit/6aa58257fe72bb4d83e82741dad845788735e0a8", "message": "refactor SearchMoreListItem", "committedDate": "2020-06-24T05:30:17Z", "type": "commit"}, {"oid": "2ffb95568dda193e0cdffa4e471f180208517bf3", "url": "https://github.com/osmandapp/OsmAnd/commit/2ffb95568dda193e0cdffa4e471f180208517bf3", "message": "fixes", "committedDate": "2020-06-24T12:39:15Z", "type": "commit"}, {"oid": "c4214d0afcfc8e10dc074b2eb757dd45f45b20c2", "url": "https://github.com/osmandapp/OsmAnd/commit/c4214d0afcfc8e10dc074b2eb757dd45f45b20c2", "message": "Move check in Search to Wikipedia Plugin", "committedDate": "2020-06-26T06:42:53Z", "type": "commit"}, {"oid": "a1215c9a0c26d71931145f54ab1c3200d1591b67", "url": "https://github.com/osmandapp/OsmAnd/commit/a1215c9a0c26d71931145f54ab1c3200d1591b67", "message": "small fixes", "committedDate": "2020-06-26T06:52:43Z", "type": "commit"}, {"oid": "a3b5419b7a7cd935deb1d4816d070290269752d8", "url": "https://github.com/osmandapp/OsmAnd/commit/a3b5419b7a7cd935deb1d4816d070290269752d8", "message": "don't use ListView", "committedDate": "2020-06-27T10:15:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODA5NA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446888094", "bodyText": "Bad import by design", "author": "vshcherb", "createdAt": "2020-06-29T11:08:41Z", "path": "OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/AmenityMenuController.java", "diffHunk": "@@ -22,7 +22,7 @@\n import net.osmand.plus.render.RenderingIcons;\n import net.osmand.plus.transport.TransportStopRoute;\n import net.osmand.plus.wikipedia.WikipediaDialogFragment;\n-import net.osmand.plus.wikipedia.WikipediaPoiMenu;\n+import net.osmand.plus.wikipedia.WikipediaPlugin;", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODU3MA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446888570", "bodyText": "We need to do it via OsmAndPlugin.prepareExtraTopPoiFilters and there specify all what we need for this feature.", "author": "vshcherb", "createdAt": "2020-06-29T11:09:42Z", "path": "OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/AmenityMenuController.java", "diffHunk": "@@ -160,10 +160,9 @@ public boolean displayDistanceDirection() {\n \tpublic String getNameStr() {\n \t\tString preferredLang = getPreferredMapLang();\n \t\tif (amenity.getType().isWiki()) {\n-\t\t\tMapActivity mapActivity = getMapActivity();\n-\t\t\tif (mapActivity != null) {\n-\t\t\t\tOsmandApplication app = mapActivity.getMyApplication();\n-\t\t\t\tpreferredLang = WikipediaPoiMenu.getWikiArticleLanguage(app,\n+\t\t\tWikipediaPlugin wikiPlugin = OsmandPlugin.getPlugin(WikipediaPlugin.class);", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODY2MA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446888660", "bodyText": "We need to do it via OsmAndPlugin.prepareExtraTopPoiFilters and there specify all what we need for this feature.", "author": "vshcherb", "createdAt": "2020-06-29T11:09:52Z", "path": "OsmAnd/src/net/osmand/plus/poi/PoiFiltersHelper.java", "diffHunk": "@@ -121,23 +116,18 @@ public PoiUIFilter getCustomPOIFilter() {\n \n \tpublic void prepareTopWikiFilter(@NonNull PoiUIFilter wiki) {", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODc3Nw==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446888777", "bodyText": "Bad import by design, should be done via OsmandPlugin", "author": "vshcherb", "createdAt": "2020-06-29T11:10:08Z", "path": "OsmAnd/src/net/osmand/plus/poi/PoiFiltersHelper.java", "diffHunk": "@@ -10,16 +10,15 @@\n import net.osmand.osm.AbstractPoiType;\n import net.osmand.osm.MapPoiTypes;\n import net.osmand.osm.PoiCategory;\n-import net.osmand.osm.PoiType;\n import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.OsmandPlugin;\n import net.osmand.plus.R;\n import net.osmand.plus.api.SQLiteAPI;\n import net.osmand.plus.api.SQLiteAPI.SQLiteConnection;\n import net.osmand.plus.api.SQLiteAPI.SQLiteCursor;\n import net.osmand.plus.api.SQLiteAPI.SQLiteStatement;\n import net.osmand.plus.settings.backend.ApplicationMode;\n-import net.osmand.plus.wikipedia.WikipediaPoiMenu;\n-import net.osmand.util.Algorithms;\n+import net.osmand.plus.wikipedia.WikipediaPlugin;", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODg2OQ==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446888869", "bodyText": "Good!", "author": "vshcherb", "createdAt": "2020-06-29T11:10:20Z", "path": "OsmAnd/src/net/osmand/plus/search/QuickSearchDialogFragment.java", "diffHunk": "@@ -1969,21 +1971,23 @@ public void clearLastWord() {\n \t\t}\n \t}\n \n+\tprivate void onNothingFound(SearchPhrase phrase) {", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4OTM3NQ==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446889375", "bodyText": "Bad import by design, should be done via OsmandPlugin", "author": "vshcherb", "createdAt": "2020-06-29T11:11:27Z", "path": "OsmAnd/src/net/osmand/plus/views/POIMapLayer.java", "diffHunk": "@@ -36,16 +36,16 @@\n import net.osmand.data.RotatedTileBox;\n import net.osmand.osm.PoiType;\n import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.OsmandPlugin;\n import net.osmand.plus.R;\n import net.osmand.plus.activities.MapActivity;\n import net.osmand.plus.helpers.WaypointHelper;\n-import net.osmand.plus.poi.PoiFiltersHelper;\n import net.osmand.plus.poi.PoiUIFilter;\n import net.osmand.plus.render.RenderingIcons;\n import net.osmand.plus.routing.IRouteInformationListener;\n import net.osmand.plus.routing.RoutingHelper;\n import net.osmand.plus.views.MapTextLayer.MapTextProvider;\n-import net.osmand.plus.wikipedia.WikipediaPoiMenu;\n+import net.osmand.plus.wikipedia.WikipediaPlugin;", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg5MDE2NQ==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r446890165", "bodyText": "Bad import by design, should be done via OsmandPlugin", "author": "vshcherb", "createdAt": "2020-06-29T11:13:09Z", "path": "OsmAnd/src/net/osmand/plus/mapcontextmenu/builders/AmenityMenuBuilder.java", "diffHunk": "@@ -44,6 +44,7 @@\n import net.osmand.plus.wikipedia.WikiArticleHelper;\n import net.osmand.plus.wikipedia.WikipediaArticleWikiLinkFragment;\n import net.osmand.plus.wikipedia.WikipediaDialogFragment;\n+import net.osmand.plus.wikipedia.WikipediaPlugin;", "originalCommit": "a3b5419b7a7cd935deb1d4816d070290269752d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93ae98625bf04351ffb546728df8920ddde2f7fe", "url": "https://github.com/osmandapp/OsmAnd/commit/93ae98625bf04351ffb546728df8920ddde2f7fe", "message": "Fix Wikipedia empty banner", "committedDate": "2020-06-30T07:21:54Z", "type": "commit"}, {"oid": "a5ce9587c0ee3dd7e8d8c1da1a76311c5449d9f3", "url": "https://github.com/osmandapp/OsmAnd/commit/a5ce9587c0ee3dd7e8d8c1da1a76311c5449d9f3", "message": "small fixes", "committedDate": "2020-06-30T07:30:27Z", "type": "commit"}, {"oid": "49b329257466768405654a4e716d92c88972bc60", "url": "https://github.com/osmandapp/OsmAnd/commit/49b329257466768405654a4e716d92c88972bc60", "message": "refactor WikipediaPlugin imports", "committedDate": "2020-06-30T14:51:04Z", "type": "commit"}, {"oid": "352c038ee9df0f1a2c2baf1468a494ec4760f74e", "url": "https://github.com/osmandapp/OsmAnd/commit/352c038ee9df0f1a2c2baf1468a494ec4760f74e", "message": "Merge branch 'master' into WikipediaSearchBanner", "committedDate": "2020-06-30T14:58:54Z", "type": "commit"}, {"oid": "f42a81c74fc9bc058d4a4888a1248b6193434a9c", "url": "https://github.com/osmandapp/OsmAnd/commit/f42a81c74fc9bc058d4a4888a1248b6193434a9c", "message": "small fix", "committedDate": "2020-06-30T15:16:25Z", "type": "commit"}, {"oid": "f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "url": "https://github.com/osmandapp/OsmAnd/commit/f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "message": "check local Wikipedia in search", "committedDate": "2020-06-30T15:29:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NTU3Mg==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r448895572", "bodyText": "should be method\nOsmandPlugin.onGetMapObjectsLocale(Amienity, preferredLang)\nSo each plugin can deal with different object types", "author": "vshcherb", "createdAt": "2020-07-02T10:09:39Z", "path": "OsmAnd/src/net/osmand/plus/views/POIMapLayer.java", "diffHunk": "@@ -339,7 +339,7 @@ public PointDescription getObjectName(Object o) {\n \t\t\t\tif (Algorithms.isEmpty(preferredLang)) {\n \t\t\t\t\tpreferredLang = app.getLanguage();\n \t\t\t\t}\n-\t\t\t\tpreferredLang = WikipediaPoiMenu.getWikiArticleLanguage(app,\n+\t\t\t\tpreferredLang = OsmandPlugin.onGetMapObjectsLocale(", "originalCommit": "f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NTcxOA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r448895718", "bodyText": "Plugin is not needed here cause we know it's wiki", "author": "vshcherb", "createdAt": "2020-07-02T10:09:58Z", "path": "OsmAnd/src/net/osmand/plus/wikipedia/WikipediaDialogFragment.java", "diffHunk": "@@ -282,8 +282,9 @@ public static boolean showInstance(@NonNull FragmentActivity activity, @NonNull\n \n \t\t\tWikipediaDialogFragment wikipediaDialogFragment = new WikipediaDialogFragment();\n \t\t\twikipediaDialogFragment.setAmenity(amenity);\n-\t\t\tlang = lang != null ? lang : WikipediaPoiMenu.getWikiArticleLanguage(app,\n-\t\t\t\t\tamenity.getSupportedContentLocales(), app.getSettings().MAP_PREFERRED_LOCALE.get());\n+\t\t\tlang = lang != null ? lang : OsmandPlugin.onGetMapObjectsLocale(", "originalCommit": "f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NzIxNw==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r448897217", "bodyText": "Wiki is here?", "author": "vshcherb", "createdAt": "2020-07-02T10:12:49Z", "path": "OsmAnd/src/net/osmand/plus/poi/PoiFiltersHelper.java", "diffHunk": "@@ -486,7 +460,7 @@ public boolean editPoiFilter(PoiUIFilter filter) {\n \n \tpublic void addSelectedPoiFilter(PoiUIFilter filter) {\n \t\tif (filter.isTopWikiFilter()) {", "originalCommit": "f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwMjcyOA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r448902728", "bodyText": "Remove wikipedia top filter in poi_types.xml\nAdd plugin method - Register custom POI Filter. In wikipedia plugin add Top Wiki Filter", "author": "vshcherb", "createdAt": "2020-07-02T10:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5NzIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwMTM0NA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r448901344", "bodyText": "this line should be inside\nOsmandPlugin.getMapObjectPreferredLang(MapObject object, String defaultLanguage)", "author": "vshcherb", "createdAt": "2020-07-02T10:20:30Z", "path": "OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/AmenityMenuController.java", "diffHunk": "@@ -160,12 +159,8 @@ public boolean displayDistanceDirection() {\n \tpublic String getNameStr() {\n \t\tString preferredLang = getPreferredMapLang();\n \t\tif (amenity.getType().isWiki()) {", "originalCommit": "f5f3d28ed6561b1a0e59edf6ee9d6ee903ebca9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d9f0c3cf959b40f9cd3a3be6b0ec6addfc598c7", "url": "https://github.com/osmandapp/OsmAnd/commit/9d9f0c3cf959b40f9cd3a3be6b0ec6addfc598c7", "message": "small fixes", "committedDate": "2020-07-02T11:26:46Z", "type": "commit"}, {"oid": "414ce3f2768361d7ad27a80002ae781f6909f0c8", "url": "https://github.com/osmandapp/OsmAnd/commit/414ce3f2768361d7ad27a80002ae781f6909f0c8", "message": "Fixes first part", "committedDate": "2020-07-02T12:25:40Z", "type": "commit"}, {"oid": "15a964f4bdd5b1cf4819f81fb36c93ca5293563a", "url": "https://github.com/osmandapp/OsmAnd/commit/15a964f4bdd5b1cf4819f81fb36c93ca5293563a", "message": "Merge branch 'master' into WikipediaSearchBanner", "committedDate": "2020-07-02T13:52:48Z", "type": "commit"}, {"oid": "ba5bb6dc9c0d88b34a2263826b430444447e1d24", "url": "https://github.com/osmandapp/OsmAnd/commit/ba5bb6dc9c0d88b34a2263826b430444447e1d24", "message": "Move custom poi filters to plugin", "committedDate": "2020-07-02T14:09:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwNTM5OA==", "url": "https://github.com/osmandapp/OsmAnd/pull/9266#discussion_r449705398", "bodyText": "no check for type is needed here", "author": "vshcherb", "createdAt": "2020-07-03T21:17:06Z", "path": "OsmAnd/src/net/osmand/plus/views/POIMapLayer.java", "diffHunk": "@@ -331,20 +331,19 @@ public void onClick(final View v) {\n \t@Override\n \tpublic PointDescription getObjectName(Object o) {\n \t\tif (o instanceof Amenity) {\n-\t\t\tAmenity a = (Amenity) o;\n+\t\t\tAmenity amenity = (Amenity) o;\n \t\t\tString preferredLang = app.getSettings().MAP_PREFERRED_LOCALE.get();\n \t\t\tboolean transliterateNames = app.getSettings().MAP_TRANSLITERATE_NAMES.get();\n \n-\t\t\tif (a.getType().isWiki()) {\n+\t\t\tif (amenity.getType().isWiki()) {", "originalCommit": "ba5bb6dc9c0d88b34a2263826b430444447e1d24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "69958481aa5f10e229b72e4e95b580ca08e2d920", "url": "https://github.com/osmandapp/OsmAnd/commit/69958481aa5f10e229b72e4e95b580ca08e2d920", "message": "Merge branch 'master' into WikipediaSearchBanner", "committedDate": "2020-07-03T21:18:36Z", "type": "commit"}]}