{"pr_number": 6658, "pr_title": "KEYCLOAK-12125 Introduce SameSite attribute in cookies", "pr_createdAt": "2020-01-15T10:04:31Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6658", "timeline": [{"oid": "16302ca08fa20eeb2f739907db306196b0156fd2", "url": "https://github.com/keycloak/keycloak/commit/16302ca08fa20eeb2f739907db306196b0156fd2", "message": "KEYCLOAK-12125 Introduce SameSite attribute in cookies\n\nCo-authored-by: mhajas <mhajas@redhat.com>\nCo-authored-by: Peter Skopek <pskopek@redhat.com>", "committedDate": "2020-01-16T12:48:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367409871", "bodyText": "There is no need to re-assign cookie here, instead the result of getCookieByName('KEYCLOAK_SESSION_LEGACY') can be returned immediately.", "author": "jonkoops", "createdAt": "2020-01-16T13:15:18Z", "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "originalCommit": "16302ca08fa20eeb2f739907db306196b0156fd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyNjk3NA==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367426974", "bodyText": "@jonkoops The legacy cookie is basically the same cookie as we set before this PR, i.e. it doesn't have the SameSite attribute. Chrome >80 won't send cookies in iframes that have no SameSite attribute set (which defaults to SameSite=Lax). In other words Chrome won't see the legacy cookie and at the same time some other browsers \u2013 especially older Apple browsers \u2013 reject the non-legacy cookie, so they see only the legacy cookie.", "author": "vmuzikar", "createdAt": "2020-01-16T13:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyOTA3OA==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367429078", "bodyText": "Yes, that I understand. I meant that this code could be written as follows:\nvar cookie = getCookieByName('KEYCLOAK_SESSION');\n\nif (cookie === null) {\n  return getCookieByName('KEYCLOAK_SESSION_LEGACY');\n}\n\nreturn cookie;", "author": "jonkoops", "createdAt": "2020-01-16T13:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1ODExMQ==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367458111", "bodyText": "@jonkoops I'm sorry, I got it wrong the first time. You're correct, technically there's no need to re-assign the variable. But to me it seems more clear to have only one return but I don't really insist on it. Do you think this impacts performance?", "author": "vmuzikar", "createdAt": "2020-01-16T14:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MjEzMA==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367462130", "bodyText": "No apology needed, hahah. It's a code-style thing, so I would not worry about it too much.\nIn the JavaScript community early returns are generally preferred over re-assigning a variable. This is emphasised by the preferred usage of const over var and  let in modern codebases, which is inherently not able to be re-assigned.", "author": "jonkoops", "createdAt": "2020-01-16T14:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3NTcxMw==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367475713", "bodyText": "Ok, fair enough. ;) Updated per your suggestion.", "author": "vmuzikar", "createdAt": "2020-01-16T15:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODA2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367438066", "bodyText": "If we only support NONE at the moment, I'd rather to make it a constant and not advertise LAX or STRICT in the code.", "author": "abstractj", "createdAt": "2020-01-16T14:12:22Z", "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -32,6 +32,22 @@\n     private static final String tspecials = \",; \";\n     private static final String tspecials2 = \"()<>@,;:\\\\\\\"/[]?={} \\t\";\n \n+    public enum SameSiteAttributeValue {\n+        NONE(\"None\"), // we currently support only SameSite=None; this might change in the future\n+        STRICT(\"Strict\"),", "originalCommit": "16302ca08fa20eeb2f739907db306196b0156fd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTAyNg==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367441026", "bodyText": "@abstractj Done. (We actually had only the NONE value there at some point during the development. ;))", "author": "vmuzikar", "createdAt": "2020-01-16T14:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODA2Ng=="}], "type": "inlineReview"}, {"oid": "492c5c1348102ce04bd6ee83ec22e261bf629893", "url": "https://github.com/keycloak/keycloak/commit/492c5c1348102ce04bd6ee83ec22e261bf629893", "message": "KEYCLOAK-12125 Introduce SameSite attribute in cookies\n\nCo-authored-by: mhajas <mhajas@redhat.com>\nCo-authored-by: Peter Skopek <pskopek@redhat.com>", "committedDate": "2020-01-16T14:16:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367445926", "bodyText": "A minor nitpick, but StringBuilder is faster than StringBuffer, plus it seems that's our preferred choice into the codebase.", "author": "abstractj", "createdAt": "2020-01-16T14:26:41Z", "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -173,7 +187,8 @@ public static void appendCookieValue(StringBuffer headerBuf,\n                                          String comment,\n                                          int maxAge,\n                                          boolean isSecure,\n-                                         boolean httpOnly) {\n+                                         boolean httpOnly,\n+                                         SameSiteAttributeValue sameSite) {\n         StringBuffer buf = new StringBuffer();", "originalCommit": "492c5c1348102ce04bd6ee83ec22e261bf629893", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0Njk3Ng==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367446976", "bodyText": "@abstractj It was like this before, I wanted to change as little things as possible so I haven't touched this. Do you want me to switch it for StringBuilder?", "author": "vmuzikar", "createdAt": "2020-01-16T14:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MDI2Nw==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367460267", "bodyText": "@vmuzikar I overlooked this. That's not a deal breaker, we can leave it as is.", "author": "abstractj", "createdAt": "2020-01-16T14:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367428466", "bodyText": "Where does this value end up being used? Are we sure this separator doesn't accidentally break other code that depends on the structure of the value somewhere else?", "author": "jonkoops", "createdAt": "2020-01-16T13:54:01Z", "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');\n+        }\n+        return cookie;\n+    }\n+\n+    function getCookieByName(name)\n+    {\n+        name = name + '=';", "originalCommit": "16302ca08fa20eeb2f739907db306196b0156fd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NTA1MA==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367455050", "bodyText": "If you mean the separator =, we used that before so I didn't want to change that.\n\n  \n    \n      keycloak/adapters/oidc/js/src/main/resources/login-status-iframe.html\n    \n    \n         Line 84\n      in\n      05c428f\n    \n    \n    \n    \n\n        \n          \n           var name = 'KEYCLOAK_SESSION=';", "author": "vmuzikar", "createdAt": "2020-01-16T14:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NjUxNg==", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367456516", "bodyText": "Ah, yes I see now. My diff was messed up, thanks for clarifying.", "author": "jonkoops", "createdAt": "2020-01-16T14:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng=="}], "type": "inlineReview"}, {"oid": "6b658283da86f5f1cf53b555fca649ade2b9a789", "url": "https://github.com/keycloak/keycloak/commit/6b658283da86f5f1cf53b555fca649ade2b9a789", "message": "KEYCLOAK-12125 Introduce SameSite attribute in cookies\n\nCo-authored-by: mhajas <mhajas@redhat.com>\nCo-authored-by: Peter Skopek <pskopek@redhat.com>", "committedDate": "2020-01-16T15:15:03Z", "type": "commit"}, {"oid": "6b658283da86f5f1cf53b555fca649ade2b9a789", "url": "https://github.com/keycloak/keycloak/commit/6b658283da86f5f1cf53b555fca649ade2b9a789", "message": "KEYCLOAK-12125 Introduce SameSite attribute in cookies\n\nCo-authored-by: mhajas <mhajas@redhat.com>\nCo-authored-by: Peter Skopek <pskopek@redhat.com>", "committedDate": "2020-01-16T15:15:03Z", "type": "forcePushed"}]}