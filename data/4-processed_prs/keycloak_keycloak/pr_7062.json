{"pr_number": 7062, "pr_title": "[KEYCLOAK-11784] - Hibermate ORM Extension and Improvements to JPA and LiquiBase", "pr_createdAt": "2020-05-12T14:38:18Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7062", "timeline": [{"oid": "455659937a23c5fdc5b8091d3e5c0da080791fde", "url": "https://github.com/keycloak/keycloak/commit/455659937a23c5fdc5b8091d3e5c0da080791fde", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase", "committedDate": "2020-05-12T14:42:46Z", "type": "forcePushed"}, {"oid": "8cd3422802c43be355720ab33a3a4c3617605549", "url": "https://github.com/keycloak/keycloak/commit/8cd3422802c43be355720ab33a3a4c3617605549", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase", "committedDate": "2020-05-12T14:56:15Z", "type": "forcePushed"}, {"oid": "bf516e8e14e1a869ebfad60dd9c038c03b97911c", "url": "https://github.com/keycloak/keycloak/commit/bf516e8e14e1a869ebfad60dd9c038c03b97911c", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase", "committedDate": "2020-05-12T15:22:23Z", "type": "forcePushed"}, {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "url": "https://github.com/keycloak/keycloak/commit/2078b46a7dafe3a503e6b1f86949ede31cddff93", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase", "committedDate": "2020-05-12T16:28:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDQzMA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424320430", "bodyText": "Introducing yet another \"connection provider\" is not the correct approach here. Looking at this PR a lot of changes/refactoring are done to the WF distribution, while if this wasn't introduced and the \"copy\" of DefaultJpaConnectionProviderFactory kept the WF distribution would have been more or less untouched by these changes and it would have been a lot easier and safer to review/merge this PR", "author": "stianst", "createdAt": "2020-05-13T10:01:02Z", "path": "model/jpa/src/main/java/org/keycloak/connections/jpa/EntityManagerFactoryProvider.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package org.keycloak.connections.jpa;\n+\n+import javax.persistence.EntityManagerFactory;\n+\n+public interface EntityManagerFactoryProvider {", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNTIwNg==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424405206", "bodyText": "The changes do improve WF dist too. Test runs seem to be OK.\nReplicating them is not ideal, but I understand your point about first trying this change in Quarkus, isolated. I'll close this PR and have both JPA and Liquibase providers duplicated.\nIt is kind of easy to check the impact of these changes in WF dist if you want too, just run the server using these changes.", "author": "pedroigor", "createdAt": "2020-05-13T12:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDY2NQ==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424320665", "bodyText": "Why the need to introduce verifyAndRunMasterChangelog? What does it do?", "author": "stianst", "createdAt": "2020-05-13T10:01:25Z", "path": "model/jpa/src/main/java/org/keycloak/connections/jpa/updater/JpaUpdaterProvider.java", "diffHunk": "@@ -49,23 +49,26 @@\n      * Updates the Keycloak database\n      * @param connection DB connection\n      * @param defaultSchema DB connection\n+     * @param verifyAndRunMasterChangelog if master changelog should be verified and run \n      */\n-    void update(Connection connection, String defaultSchema);\n+    void update(Connection connection, String defaultSchema, boolean verifyAndRunMasterChangelog);", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNzA5MA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424407090", "bodyText": "We tell the updater whether or not we should validate/execute the master changelog.\nRunning validation and checking the \"unrun\" changesets during startup is one of the main parts that affect startup, as well as footprint. This is especially true if the database is already initialized.\nNote that this does not affect custom providers, as their changelogs are still validated/executed regardless. This is only for the master changelog.", "author": "pedroigor", "createdAt": "2020-05-13T12:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTU2Mw==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424321563", "bodyText": "?", "author": "stianst", "createdAt": "2020-05-13T10:03:01Z", "path": "model/jpa/src/main/resources/META-INF/persistence.xml", "diffHunk": "@@ -85,8 +85,11 @@\n         \n         <exclude-unlisted-classes>true</exclude-unlisted-classes>\n \n+        <!-- These properties are overridden when Keycloak is managing the persistence unit by itself -->\n         <properties>\n             <property name=\"jboss.as.jpa.managed\" value=\"false\"/>\n+            <property name=\"hibernate.dialect\" value=\"org.hibernate.dialect.H2Dialect\"/>", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwOTExNA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424409114", "bodyText": "This is temporary and does not really matter of WF dist. As you know, we manually create the EMF.\nThe reason for this is that when using a persistence.xml, Quarkus does not allow you to define hibernate configuration via properties file. One or another. See their docs for more details.\nThe idea is to also review that once we have a final solution for supporting multiple databases when using Quarkus.", "author": "pedroigor", "createdAt": "2020-05-13T12:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTYzNw==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424321637", "bodyText": "?", "author": "stianst", "createdAt": "2020-05-13T10:03:08Z", "path": "model/jpa/src/main/resources/META-INF/persistence.xml", "diffHunk": "@@ -85,8 +85,11 @@\n         \n         <exclude-unlisted-classes>true</exclude-unlisted-classes>\n \n+        <!-- These properties are overridden when Keycloak is managing the persistence unit by itself -->\n         <properties>\n             <property name=\"jboss.as.jpa.managed\" value=\"false\"/>\n+            <property name=\"hibernate.dialect\" value=\"org.hibernate.dialect.H2Dialect\"/>\n+            <property name=\"hibernate.query.startup_check\" value=\"false\"/>", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxMDIzNg==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424410236", "bodyText": "I can make the hibernate.query.startup_check configurable. This also saves some time during startup given that validating named queries is expensive for us.", "author": "pedroigor", "createdAt": "2020-05-13T12:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjA3MA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322070", "bodyText": "This is used by the config test that Dmitry added, not sure why it doesn't fail without it. Kinda not related to this PR though?", "author": "stianst", "createdAt": "2020-05-13T10:03:57Z", "path": "quarkus/extensions/pom.xml", "diffHunk": "@@ -89,15 +112,6 @@\n                     </execution>\n                 </executions>\n             </plugin>\n-            <plugin>\n-                <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-surefire-plugin</artifactId>\n-                <configuration>\n-                    <environmentVariables>\n-                        <KEYCLOAK_CAMEL_CASE_SCOPE_CAMEL_CASE_PROP>foobar</KEYCLOAK_CAMEL_CASE_SCOPE_CAMEL_CASE_PROP>", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxMDc5OA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424410798", "bodyText": "It is not, but I did see any difference after removing it. So I just removed it.", "author": "pedroigor", "createdAt": "2020-05-13T12:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjI3Mw==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322273", "bodyText": "I noticed beans.xml earlier, I think we should use a consistent approach shouldn't we? Either use beans.xml or use jandex plugin?", "author": "stianst", "createdAt": "2020-05-13T10:04:21Z", "path": "quarkus/extensions/pom.xml", "diffHunk": "@@ -79,7 +103,6 @@\n             <plugin>\n                 <groupId>org.jboss.jandex</groupId>\n                 <artifactId>jandex-maven-plugin</artifactId>", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxMTk1Ng==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424411956", "bodyText": "I'm not sure if this declaration is making any difference. But yeah, we should have a consistent approach and we basically need beans.xml to make Hibernate work.", "author": "pedroigor", "createdAt": "2020-05-13T12:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjU2NQ==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322565", "bodyText": "Does this have anything to do with JPA or Liquibase?", "author": "stianst", "createdAt": "2020-05-13T10:04:51Z", "path": "quarkus/extensions/src/main/java/org/keycloak/provider/quarkus/QuarkusCacheManagerProvider.java", "diffHunk": "@@ -44,12 +44,13 @@\n         try {\n             InputStream configurationStream = loadConfiguration(config);\n             ConfigurationBuilderHolder builder = new ParserRegistry().parse(configurationStream);\n+            boolean isClustered = builder.getNamedConfigurationBuilders().get(\"sessions\").clustering().cacheMode().isClustered();\n \n-            if (builder.getNamedConfigurationBuilders().get(\"sessions\").clustering().cacheMode().isClustered()) {\n+            if (isClustered) {\n                 configureTransportStack(config, builder);\n             }\n \n-            return (C) new DefaultCacheManager(builder, true);\n+            return (C) new DefaultCacheManager(builder, isClustered);\n         } catch (Exception e) {", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxMjc2Ng==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424412766", "bodyText": "No. But I also changed that to avoid starting the cache beforehand if running a local cache. Sorry for including it.", "author": "pedroigor", "createdAt": "2020-05-13T12:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzAyNg==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323026", "bodyText": "I'm confused here. Don't we need at least a transaction manager dummy or something? Otherwise session.getTransactionManager won't work", "author": "stianst", "createdAt": "2020-05-13T10:05:41Z", "path": "quarkus/extensions/src/main/java/org/keycloak/transaction/QuarkusJtaTransactionManagerLookup.java", "diffHunk": "@@ -32,16 +32,20 @@\n \n     @Override\n     public TransactionManager getTransactionManager() {\n-        return tm;\n+        if (tm == null) {\n+//            tm = CDI.current().select(TransactionManager.class).get();\n+//            logger.tracev(\"TransactionManager = {0}\", tm);\n+//            if (tm == null) {\n+//                logger.debug(\"could not locate transactionmanager\");\n+//            }\n+        }\n+        // we need to check whether or not the datasource supports XA as well as if configuration tells that\n+        return null;\n     }\n \n     @Override\n     public void init(Config.Scope config) {\n-        tm = CDI.current().select(TransactionManager.class).get();\n-        logger.tracev(\"TransactionManager = {0}\", tm);\n-        if (tm == null) {\n-            logger.debug(\"Could not locate TransactionManager\");\n-        }\n+        ", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxNjEwNg==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424416106", "bodyText": "This is something I was expecting to investigate more once I have these changes in. It is not clear to me if we always need to run using JTA. Looks like it is not.", "author": "pedroigor", "createdAt": "2020-05-13T12:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzM0OQ==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323349", "bodyText": "Don't think we should require folks to build their own Quarkus to use Keycloak should we?", "author": "stianst", "createdAt": "2020-05-13T10:06:12Z", "path": "quarkus/pom.xml", "diffHunk": "@@ -31,10 +31,11 @@\n     <packaging>pom</packaging>\n \n     <properties>\n-        <quarkus.version>1.2.1.Final</quarkus.version>\n+        <quarkus.version>999-SNAPSHOT</quarkus.version>", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzU3NA==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323574", "bodyText": "??", "author": "stianst", "createdAt": "2020-05-13T10:06:38Z", "path": "quarkus/server/src/main/java/org/keycloak/services/resources/NoopResource.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.keycloak.services.resources;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManagerFactory;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.UriBuilder;\n+\n+/**\n+ * Quarkus doesn't pick up the Application if there's no JAX-RS endpoints\n+ */\n+@Singleton\n+@Path(\"/noop\")\n+public class NoopResource {\n+\n+    @Inject\n+    EntityManagerFactory entityManagerFactory;\n+\n+    @GET\n+    public Response redirect() {\n+        return Response.seeOther(UriBuilder.fromResource(WelcomeResource.class).build()).build();\n+    }\n+\n+}", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxNjc3OQ==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424416779", "bodyText": "Not related. But better than have a Hello World :) Although this endpoint is not really exposed.", "author": "pedroigor", "createdAt": "2020-05-13T12:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzgwNw==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323807", "bodyText": "Why move this?", "author": "stianst", "createdAt": "2020-05-13T10:07:03Z", "path": "services/src/main/java/org/keycloak/services/resources/KeycloakApplication.java", "diffHunk": "@@ -182,7 +182,6 @@ protected void shutdown() {\n     protected ExportImportManager migrateAndBootstrap() {\n         ExportImportManager exportImportManager;\n         logger.debug(\"Calling migrateModel\");\n-        migrateModel();", "originalCommit": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxNzU2OQ==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424417569", "bodyText": "And I can ask, why not have model migration together with persistence bootstrap? Why have part in JPA layer and other bits outside. It just better, IMO, to have them where persistence is initialized.", "author": "pedroigor", "createdAt": "2020-05-13T13:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzgwNw=="}], "type": "inlineReview"}, {"oid": "bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "url": "https://github.com/keycloak/keycloak/commit/bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "message": "[KEYCLOAK-11784] - Using Hibernate Extension", "committedDate": "2020-05-13T19:56:09Z", "type": "forcePushed"}, {"oid": "9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "url": "https://github.com/keycloak/keycloak/commit/9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "message": "[KEYCLOAK-11784] - Using Hibernate Extension", "committedDate": "2020-05-13T20:13:41Z", "type": "forcePushed"}, {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43", "url": "https://github.com/keycloak/keycloak/commit/6fdef7a9291d993952af6d2c665422ff94a70e43", "message": "[KEYCLOAK-11784] - Using Hibernate Extension", "committedDate": "2020-05-13T20:49:20Z", "type": "commit"}, {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43", "url": "https://github.com/keycloak/keycloak/commit/6fdef7a9291d993952af6d2c665422ff94a70e43", "message": "[KEYCLOAK-11784] - Using Hibernate Extension", "committedDate": "2020-05-13T20:49:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2ODQyNw==", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424968427", "bodyText": "??", "author": "stianst", "createdAt": "2020-05-14T08:42:04Z", "path": "quarkus/server/src/main/java/org/keycloak/services/resources/Dummy.java", "diffHunk": "@@ -9,6 +11,9 @@\n @Path(\"/dummy\")\n public class Dummy {\n \n+    @Inject", "originalCommit": "6fdef7a9291d993952af6d2c665422ff94a70e43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}