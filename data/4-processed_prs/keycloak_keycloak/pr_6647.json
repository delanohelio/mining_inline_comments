{"pr_number": 6647, "pr_title": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "pr_createdAt": "2020-01-09T09:01:06Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6647", "timeline": [{"oid": "d50a8ddece821c1840bda24dc12b33bfc8761492", "url": "https://github.com/keycloak/keycloak/commit/d50a8ddece821c1840bda24dc12b33bfc8761492", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "committedDate": "2020-01-13T10:56:59Z", "type": "forcePushed"}, {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee", "url": "https://github.com/keycloak/keycloak/commit/edcbd407f146e0ce04284dc4762413798cf496ee", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "committedDate": "2020-01-13T11:01:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAwOQ==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531009", "bodyText": "Should be final\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static AtomicBoolean skipSNIApplication = new AtomicBoolean(false);\n          \n          \n            \n                private static final AtomicBoolean skipSNIApplicationToSslSocket = new AtomicBoolean(false);", "author": "hmlnarik", "createdAt": "2020-01-14T19:31:11Z", "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -46,7 +50,8 @@\n  */\n public class SniSSLSocketFactory extends SSLSocketFactory {\n \n-    private static Logger log = Logger.getLogger(SniSSLSocketFactory.class.getName());\n+    private static final Logger LOG = Logger.getLogger(SniSSLSocketFactory.class.getName());\n+    private static AtomicBoolean skipSNIApplication = new AtomicBoolean(false);", "originalCommit": "edcbd407f146e0ce04284dc4762413798cf496ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTI2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531266", "bodyText": "This is not necessarily only IBM JDK, please improve the message.", "author": "hmlnarik", "createdAt": "2020-01-14T19:31:43Z", "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");", "originalCommit": "edcbd407f146e0ce04284dc4762413798cf496ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTUzMA==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531530", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (e.getCause() instanceof NoSuchMethodException && Environment.IS_IBM_JAVA) {\n          \n          \n            \n                            if (e.getCause() instanceof NoSuchMethodException) {", "author": "hmlnarik", "createdAt": "2020-01-14T19:32:14Z", "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");\n+            return socket;\n+        }\n+\n         if (socket instanceof SSLSocket) {\n             try {\n                 Method setHostMethod = AccessController.doPrivileged(new PrivilegedExceptionAction<Method>() {\n+                    @Override\n                     public Method run() throws NoSuchMethodException {\n                         return socket.getClass().getMethod(\"setHost\", String.class);\n                     }\n                 });\n \n                 setHostMethod.invoke(socket, hostname);\n-                log.finest(\"Applied SNI to socket for: \" + hostname);\n-            } catch (Exception e) {\n-                log.log(Level.WARNING, \"Failed to apply SNI to SSLSocket\", e);\n+                LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);\n+            } catch (PrivilegedActionException e) {\n+                if (e.getCause() instanceof NoSuchMethodException && Environment.IS_IBM_JAVA) {", "originalCommit": "edcbd407f146e0ce04284dc4762413798cf496ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA4NTM5OA==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r370085398", "bodyText": "@hmlnarik I am not sure we want this. I agree we should set skipSNIApplication to true for all JDKs in case the exception is NoSuchMethod, but we don't want to set log level to FINE for each JDK as for now we know only for IBM JDK that it is ok to skip SNI application. Does it make sense?", "author": "mhajas", "createdAt": "2020-01-23T12:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2OTU3Nw==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r372869577", "bodyText": "Ok, let's leave this as is.", "author": "hmlnarik", "createdAt": "2020-01-30T10:28:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMjQ2OA==", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366532468", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);\n          \n          \n            \n                            LOG.log(Level.FINE, \"Applied SNI to socket for host {0}\", hostname);", "author": "hmlnarik", "createdAt": "2020-01-14T19:34:16Z", "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");\n+            return socket;\n+        }\n+\n         if (socket instanceof SSLSocket) {\n             try {\n                 Method setHostMethod = AccessController.doPrivileged(new PrivilegedExceptionAction<Method>() {\n+                    @Override\n                     public Method run() throws NoSuchMethodException {\n                         return socket.getClass().getMethod(\"setHost\", String.class);\n                     }\n                 });\n \n                 setHostMethod.invoke(socket, hostname);\n-                log.finest(\"Applied SNI to socket for: \" + hostname);\n-            } catch (Exception e) {\n-                log.log(Level.WARNING, \"Failed to apply SNI to SSLSocket\", e);\n+                LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);", "originalCommit": "edcbd407f146e0ce04284dc4762413798cf496ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278", "url": "https://github.com/keycloak/keycloak/commit/ecf35d9d6d7feb07a15740bdb03a640938c54278", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "committedDate": "2020-01-30T10:53:13Z", "type": "commit"}, {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278", "url": "https://github.com/keycloak/keycloak/commit/ecf35d9d6d7feb07a15740bdb03a640938c54278", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "committedDate": "2020-01-30T10:53:13Z", "type": "forcePushed"}]}