{"pr_number": 6987, "pr_title": "KEYCLOAK-12936 only change the locale in the AccountPage.", "pr_createdAt": "2020-04-20T13:03:06Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6987", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwMDY0MA==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414500640", "bodyText": "I don't think this is a correct label but we'll address accessibility in another task, so it's ok I think.", "author": "vmuzikar", "createdAt": "2020-04-24T11:24:31Z", "path": "themes/src/main/resources/theme/keycloak-preview/account/resources/app/widgets/LocaleSelectors.tsx", "diffHunk": "@@ -13,122 +13,44 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-\n import * as React from 'react';\n-import {withRouter, RouteComponentProps} from 'react-router-dom';\n-\n-import {Msg} from './Msg';\n \n import {\n-    Dropdown,\n-    DropdownItem,\n-    DropdownToggle,\n-    Nav,\n-    NavExpandable,\n-    NavItem,\n-    NavList\n+    FormSelect,\n+    FormSelectOption,\n+    FormSelectProps\n } from '@patternfly/react-core';\n \n-declare const locale: string;\n-declare const baseUrl: string;\n-declare const referrer: string;\n-declare const referrerUri: string;\n-\n interface AvailableLocale {\n     locale: string; \n     label: string;\n };\n declare const availableLocales: [AvailableLocale];\n-// remove entry for current locale\n-const availLocales = availableLocales.filter((availableLocale: AvailableLocale) => availableLocale.locale !== locale);\n \n-let referrerFragment = '';\n-if ((typeof referrer !== 'undefined') && \n-    (typeof referrerUri !== 'undefined')) {\n-    referrerFragment = '&referrer=' + referrer + '&referrer_uri=' + encodeURIComponent(referrerUri);\n-}\n+interface LocaleSelectorProps extends FormSelectProps { }\n+interface LocaleSelectorState { }\n+export class LocaleSelector extends React.Component<LocaleSelectorProps, LocaleSelectorState> {\n     \n-interface LocaleKebabItemProps extends RouteComponentProps {}\n-interface LocaleKebabItemState {activeGroup: string; activeItem: string}\n-class LocaleKebabItem extends React.Component<LocaleKebabItemProps, LocaleKebabItemState> {\n-    public constructor(props: LocaleKebabItemProps) {\n-        super(props);\n-        this.state = {\n-            activeGroup: 'locale-group',\n-            activeItem: ''\n-        };\n-    }\n-     \n-    public render(): React.ReactNode {        \n-        const appPath = this.props.location.pathname;\n-        const localeNavItems = availLocales.map((availableLocale: AvailableLocale) => {\n-            const url = baseUrl + '?kc_locale=' + availableLocale.locale + referrerFragment + '#' + appPath;\n-            return (<NavItem\n-                        id={`mobile-locale-${availableLocale.locale}`}\n-                        key={availableLocale.locale}\n-                        to={url}>\n-                            {availableLocale.label}\n-                    </NavItem> );\n-        });\n-        \n-        return (\n-            <Nav>\n-                <NavList>\n-                    <NavExpandable id=\"mobile-locale\" title={Msg.localize('locale_' + locale)} isActive={false} groupId=\"locale-group\">\n-                    {localeNavItems}\n-                  </NavExpandable>\n-                </NavList>\n-            </Nav>\n-        );\n-    }\n-};\n-\n-interface LocaleDropdownComponentProps extends RouteComponentProps {}\n-interface LocaleDropdownComponentState {isDropdownOpen: boolean}\n-class LocaleDropdownComponent extends React.Component<LocaleDropdownComponentProps, LocaleDropdownComponentState> {\n-    public constructor(props: LocaleDropdownComponentProps) {\n+    constructor(props: LocaleSelectorProps) {\n         super(props);\n-        this.state = {isDropdownOpen: false};\n     }\n-     \n-    private onDropdownToggle = (isDropdownOpen: boolean) => {\n-        this.setState({\n-            isDropdownOpen\n-        });\n-    };\n-\n-    private onDropdownSelect = () => {\n-        this.setState({\n-            isDropdownOpen: !this.state.isDropdownOpen\n-        });\n-    };\n \n-    public render(): React.ReactNode {\n-        const appPath = this.props.location.pathname;\n-        const localeDropdownItems = availLocales.map((availableLocale: AvailableLocale) => {\n-            const url = baseUrl + '?kc_locale=' + availableLocale.locale + referrerFragment + '#' + appPath;\n-            return (<DropdownItem\n-                        id={`locale-${availableLocale.locale}`}\n-                        key={availableLocale.locale}\n-                        href={url}>\n-                            {availableLocale.label}\n-                    </DropdownItem> );\n-        });\n-\n-        if (localeDropdownItems.length < 2) return (<React.Fragment/>);\n-        \n+    render(): React.ReactNode {\n         return (\n-            <Dropdown\n-                isPlain\n-                position=\"right\"\n-                onSelect={this.onDropdownSelect}\n-                isOpen={this.state.isDropdownOpen}\n-                toggle={<DropdownToggle id=\"locale-dropdown-toggle\" onToggle={this.onDropdownToggle}><Msg msgKey={'locale_' + locale}/></DropdownToggle>}\n-                dropdownItems={localeDropdownItems}\n-            />\n+            <FormSelect\n+                id=\"locale-select\"\n+                value={this.props.value}\n+                onChange={(value, event) => { if (this.props.onChange) this.props.onChange(value, event) }}\n+                aria-label=\"Select Runtime\"", "originalCommit": "dde1c310499f328b899e43e11f4f0dc1969145bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwMjgzNA==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414502834", "bodyText": "It seems this condition doesn't work. The whole page is reloaded every time when the form is saved, regardless if the locale changed.", "author": "vmuzikar", "createdAt": "2020-04-24T11:28:29Z", "path": "themes/src/main/resources/theme/keycloak-preview/account/resources/app/content/account-page/AccountPage.tsx", "diffHunk": "@@ -100,6 +108,9 @@ export class AccountPage extends React.Component<AccountPageProps, AccountPageSt\n             AccountServiceClient.Instance.doPost(\"/\", { data: reqData })\n                 .then(() => { // to use response, say ((response: AxiosResponse<FormFields>) => {\n                     ContentAlert.success('accountUpdatedMessage');\n+                    if (locale !== this.state.formFields.attributes!.locale) {", "originalCommit": "dde1c310499f328b899e43e11f4f0dc1969145bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MTY0OQ==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414571649", "bodyText": "it doesn't reload the page always it only worked the first time! Fixed it now the locale is a array apparently", "author": "edewit", "createdAt": "2020-04-24T13:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwMjgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NjI3MQ==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414576271", "bodyText": "The test was failing because of this as well, new build: https://keycloak-jenkins.com/job/keycloak-account2-matrix/868/", "author": "edewit", "createdAt": "2020-04-24T13:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwMjgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNDgxMw==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414534813", "bodyText": "Please us this instead:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    WaitUtils.pause(1000);\n          \n          \n            \n                    WaitUtils.waitForPageToLoad();", "author": "vmuzikar", "createdAt": "2020-04-24T12:24:16Z", "path": "testsuite/integration-arquillian/tests/other/base-ui/src/test/java/org/keycloak/testsuite/ui/account2/InternationalizationTest.java", "diffHunk": "@@ -53,29 +52,17 @@ public void addTestRealms(List<RealmRepresentation> testRealms) {\n     @Before\n     public void beforeI18nTest() {\n         assertTestUserLocale(null);\n-        assertEquals(DEFAULT_LOCALE_NAME, welcomeScreen.header().getCurrentLocaleName());\n-    }\n-\n-    @Test\n-    public void welcomeScreenTest() {\n-        welcomeScreen.header().selectLocale(CUSTOM_LOCALE);\n-        assertCustomLocaleWelcomeScreen();\n-\n-        // check if selected locale is preserved\n-        welcomeScreen.clickPersonalInfoLink();\n-        assertCustomLocaleLoginPage();\n-        loginToAccount();\n-        assertTestUserLocale(CUSTOM_LOCALE);\n-        assertCustomLocalePersonalInfo();\n     }\n \n     @Test\n     public void loggedInPageTest() {\n         personalInfoPage.navigateTo();\n         loginToAccount();\n         assertTestUserLocale(null);\n-        assertEquals(DEFAULT_LOCALE_NAME, personalInfoPage.header().getCurrentLocaleName());\n-        personalInfoPage.header().selectLocale(CUSTOM_LOCALE);\n+        personalInfoPage.selectLocale(CUSTOM_LOCALE);\n+        personalInfoPage.clickSave(false);\n+        WaitUtils.pause(1000);", "originalCommit": "dde1c310499f328b899e43e11f4f0dc1969145bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjMxMg==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414536312", "bodyText": "Could you please extend the test a bit? We need to be sure i18n works on the Welcome Screen as well.", "author": "vmuzikar", "createdAt": "2020-04-24T12:26:46Z", "path": "testsuite/integration-arquillian/tests/other/base-ui/src/test/java/org/keycloak/testsuite/ui/account2/InternationalizationTest.java", "diffHunk": "@@ -53,29 +52,17 @@ public void addTestRealms(List<RealmRepresentation> testRealms) {\n     @Before\n     public void beforeI18nTest() {\n         assertTestUserLocale(null);\n-        assertEquals(DEFAULT_LOCALE_NAME, welcomeScreen.header().getCurrentLocaleName());\n-    }\n-\n-    @Test\n-    public void welcomeScreenTest() {\n-        welcomeScreen.header().selectLocale(CUSTOM_LOCALE);\n-        assertCustomLocaleWelcomeScreen();\n-\n-        // check if selected locale is preserved\n-        welcomeScreen.clickPersonalInfoLink();\n-        assertCustomLocaleLoginPage();\n-        loginToAccount();\n-        assertTestUserLocale(CUSTOM_LOCALE);\n-        assertCustomLocalePersonalInfo();\n     }\n \n     @Test\n     public void loggedInPageTest() {\n         personalInfoPage.navigateTo();\n         loginToAccount();\n         assertTestUserLocale(null);\n-        assertEquals(DEFAULT_LOCALE_NAME, personalInfoPage.header().getCurrentLocaleName());\n-        personalInfoPage.header().selectLocale(CUSTOM_LOCALE);\n+        personalInfoPage.selectLocale(CUSTOM_LOCALE);\n+        personalInfoPage.clickSave(false);\n+        WaitUtils.pause(1000);\n+", "originalCommit": "dde1c310499f328b899e43e11f4f0dc1969145bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NDU3Mg==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414574572", "bodyText": "well there is the assertCustomLocaleWelcomeScreen there isn't much more to test I'm afraid.", "author": "edewit", "createdAt": "2020-04-24T13:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU5NTAzMw==", "url": "https://github.com/keycloak/keycloak/pull/6987#discussion_r414595033", "bodyText": "You're correct, scratch this. I missed the last line (assertCustomLocaleWelcomeScreen();) in this test.", "author": "vmuzikar", "createdAt": "2020-04-24T13:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjMxMg=="}], "type": "inlineReview"}, {"oid": "2f2530a5452c3a9f0ec7e6221d3bfeade31146cc", "url": "https://github.com/keycloak/keycloak/commit/2f2530a5452c3a9f0ec7e6221d3bfeade31146cc", "message": "KEYCLOAK-12936 only change the locale in the AccountPage.", "committedDate": "2020-04-24T13:19:42Z", "type": "forcePushed"}, {"oid": "4b2d2fdc58d520b3a0cc5251686045068451e70d", "url": "https://github.com/keycloak/keycloak/commit/4b2d2fdc58d520b3a0cc5251686045068451e70d", "message": "KEYCLOAK-12936 only change the locale in the AccountPage.", "committedDate": "2020-04-24T13:26:55Z", "type": "forcePushed"}, {"oid": "015ddc4158b2ffb1aeb1f0c2bee04b37d6a9869c", "url": "https://github.com/keycloak/keycloak/commit/015ddc4158b2ffb1aeb1f0c2bee04b37d6a9869c", "message": "KEYCLOAK-12936 only change the locale in the AccountPage.", "committedDate": "2020-04-24T13:51:47Z", "type": "commit"}, {"oid": "015ddc4158b2ffb1aeb1f0c2bee04b37d6a9869c", "url": "https://github.com/keycloak/keycloak/commit/015ddc4158b2ffb1aeb1f0c2bee04b37d6a9869c", "message": "KEYCLOAK-12936 only change the locale in the AccountPage.", "committedDate": "2020-04-24T13:51:47Z", "type": "forcePushed"}]}