{"pr_number": 7153, "pr_title": "[KEYCLOAK-11330] - Quarkus clustering tests", "pr_createdAt": "2020-06-08T20:58:46Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7153", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NzI4MQ==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437347281", "bodyText": "@mposolda or @hmlnarik can you comment if this is okay?", "author": "stianst", "createdAt": "2020-06-09T11:49:35Z", "path": "model/infinispan/src/main/java/org/keycloak/connections/infinispan/TopologyInfo.java", "diffHunk": "@@ -63,7 +63,7 @@ public TopologyInfo(EmbeddedCacheManager cacheManager, Config.Scope config, bool\n         if (!embedded) {\n             Transport transport = cacheManager.getTransport();\n             if (transport != null) {\n-                nodeName = transport.getAddress().toString();\n+                nodeName = cacheManager.getCacheManagerConfiguration().transport().nodeName();", "originalCommit": "f0d777354f8019b5ab8f2c3755c784090c15ee92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MjkxOQ==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437462919", "bodyText": "I am not sure from the top of my head. Will be good to try to run server with/without property \"-Djboss.node.name=mynode1\" for the cluster/non-cluster configuration and check it behaves as expected. Also check the cluster/cross-dc tests are not broken by this change :)", "author": "mposolda", "createdAt": "2020-06-09T14:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NzI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4OTM0Ng==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437489346", "bodyText": "Cluster tests using the main dist are passing for me locally except for the AuthenticationSessionFailoverClusterTest, which is the one that makes more use of this change.\nI'm testing now without this change to see how it goes and try to find another approach to the problem if that is causing issues.\nBut CI is failing with \"failed to update database\", which is quite weird as this changeset is not supposed to cause that. Also investigating.", "author": "pedroigor", "createdAt": "2020-06-09T14:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NzI4MQ=="}], "type": "inlineReview"}, {"oid": "2d45917d090e3bc83c6bff92080e4df251c512d9", "url": "https://github.com/keycloak/keycloak/commit/2d45917d090e3bc83c6bff92080e4df251c512d9", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-09T12:30:07Z", "type": "forcePushed"}, {"oid": "44856ccb99175e2e6b9fecabd5742614b59324fa", "url": "https://github.com/keycloak/keycloak/commit/44856ccb99175e2e6b9fecabd5742614b59324fa", "message": "[KEYCLOAK-11330] - Database docker wait using port", "committedDate": "2020-06-09T16:29:44Z", "type": "forcePushed"}, {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "url": "https://github.com/keycloak/keycloak/commit/8a2703b3b5912c1f1528003071ffa11b2d612ff5", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-09T16:29:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887342", "bodyText": "Shouldn't we rather ignore this test for now and fix the problem properly instead of adding a work around to the test?", "author": "stianst", "createdAt": "2020-06-10T06:28:24Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/AuthenticationSessionFailoverClusterTest.java", "diffHunk": "@@ -83,8 +84,17 @@ public void setup() {\n                 .build();\n \n         userId = ApiUtil.createUserAndResetPasswordWithAdminClient(adminClient.realm(\"test\"), user, \"password\");\n-        getCleanup().addUserId(userId);\n+        \n+        //TODO: weird behavior when doing Quarkus where only one of the required actions above are persisted, so we workaround by forcing an update to the user with the 2 actions we want\n+        UserResource userResource = adminClient.realm(testRealm.getRealm()).users().get(userId);\n+        UserRepresentation userRepresentation = userResource.toRepresentation();\n+        \n+        if (userRepresentation.getRequiredActions().size() < 2) {\n+            userRepresentation.setRequiredActions(user.getRequiredActions());\n+            userResource.update(userRepresentation);\n+        }\n \n+        getCleanup().addUserId(userId);", "originalCommit": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0MjE1OQ==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438042159", "bodyText": "We could. But I would like to have this test running even though we didn't investigate further yet the reason for that issue. That is why I left that there.", "author": "pedroigor", "createdAt": "2020-06-10T11:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMzkzMw==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438233933", "bodyText": "Not sure it is related, but it looks that AuthenticationSessionFailoverClusterTest is currently failing in master even for the default Wildfly distribution. Details in https://issues.redhat.com/browse/KEYCLOAK-14441", "author": "mposolda", "createdAt": "2020-06-10T15:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0Njk2Mw==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438246963", "bodyText": "Humm ... The same line and assertion. It seems to be related.\nWe had some related issues in Quarkus but they were fixed. So I was thinking it was Quarkus specific, but it seems to be a common issue.\nWe do have similar tests that perform the same initialization steps using required actions, so I'm pretty sure it is not an issue on the server.\nDo you have an idea when this issue started to happen? Or you just caught it?\nIt might be related to some changes I sent to the JPA model, although not sure because, as I said, some other tests perform the same steps and are working fine.", "author": "pedroigor", "createdAt": "2020-06-10T16:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0MTg3Nw==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438341877", "bodyText": "@mposolda Found what the issue was. The test is creating the user from representation and resetting the password so that the UPDATE_PASSWORD RA is removed from the user.\nI've changed to set the password when creating the representation and avoid the reset password on create.\nDefinitely, not an issue on the server. But I'm not sure if something changed on the server that now has impacted this test in particular (or any other doing the same steps). Looks reasonable to me to remove required action if a reset password was done. So, the test is probably wrong.\nThis should also fixe https://issues.redhat.com/browse/KEYCLOAK-14441.", "author": "pedroigor", "createdAt": "2020-06-10T18:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1NjMxNA==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438356314", "bodyText": "+1 to remove required action from user after reset password was done. But it is strange that it didn't work like this before... Cool you figured where the issue is.", "author": "mposolda", "createdAt": "2020-06-10T19:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887649", "bodyText": "Not convinced about this change. Doesn't it suggest perhaps different behaviour on Quarkus?", "author": "stianst", "createdAt": "2020-06-10T06:29:07Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/ClientInvalidationClusterTest.java", "diffHunk": "@@ -58,24 +59,38 @@ protected ClientRepresentation createEntity(ClientRepresentation client, Contain\n \n     @Override\n     protected ClientRepresentation readEntity(ClientRepresentation client, ContainerInfo node) {\n-        ClientRepresentation u = null;\n-        try {\n-            u = entityResource(client, node).toRepresentation();\n-        } catch (NotFoundException nfe) {\n-            // expected when client doesn't exist\n-        }\n+        ClientRepresentation u = Retry.call(new Retry.Supplier<ClientRepresentation>() {\n+            @Override\n+            public ClientRepresentation get(int iteration) {\n+                try {\n+                    return entityResource(client, node).toRepresentation();\n+                } catch (NotFoundException nfe) {\n+                    return null;\n+                }\n+            }\n+        }, 3, 5000);", "originalCommit": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4Nzk3MA==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887970", "bodyText": "Could it be as simple as async vs sync replication in Infinispan?", "author": "stianst", "createdAt": "2020-06-10T06:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0MjU5Nw==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438042597", "bodyText": "Yes, SYNC seems to be better but yet not 100% stable.\nThis retry is not different than the pauses that are already there to wait for the cluster to rebalance.\nI can remove, but IMO it gives more stability.", "author": "pedroigor", "createdAt": "2020-06-10T11:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTIxNQ==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438245215", "bodyText": "I think this change is fine. When there is some CRUD change of client on node1, it may take some small amount of time until the invalidation message arrives to node2 and hence for some small amount of time (few ms or so), the node2 can still contain the \"stale\" value.\nA bit related thing: when consider invalidation tests, the failover is not needed in them at all IMO. For the invalidation, you usually want to test that when you do some CRUD action on client (or other entity) on cluster node1, then you want to see that this change is visible on node2. Which means that cache was invalidated etc. This can be tested by directly accessing the nodes (node1 and node2) and don't use loadbalancer at all. In that case, failover of the nodes (killing/restarting etc) won't be needed at all. This approach is used in the cross-dc invalidation test InvalidationCrossDCTest and my vote would be to change cluster tests to alighn with this too. However this is likely out-of-scope of this PR and should be discussed elsewhere?", "author": "mposolda", "createdAt": "2020-06-10T16:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0OTkwMg==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438249902", "bodyText": "I think so. I do like the way the test works because it is kind of reproducing a real-world scenario where you have an LB. Like most people are doing clustering, without cross-dc.", "author": "pedroigor", "createdAt": "2020-06-10T16:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1OTM3MA==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r438359370", "bodyText": "Well, for the invalidation you usually need to test that when you change something on node1, then the change is visible on node2 as the stuff was invalidated from the global cache.\nFor example when admin updates realm on node1, the other users connected in node2 should immediately see this update. This is real-world scenario and it doesn't use any failover (restart of the cluster nodes).\nIn general, I think the restart of server nodes is needed just when testing failover scenarios. For invalidation scenarios, restarting servers is uneccessary overhead, which increases the time of the test.", "author": "mposolda", "createdAt": "2020-06-10T19:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyNzI4OA==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r440127288", "bodyText": "I see that. My point is that it is related to HA and as such, you usually have an LB even though you don't need it to actually check invalidation.\nPlease, let me know if you want to remove it here or in a separate PR.", "author": "pedroigor", "createdAt": "2020-06-15T12:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDgxNA==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r440360814", "bodyText": "I think your change in this PR is fine.\nThe point I made is not directly related to your PR, but to the cluster invalidation tests in general - I think they don't need so much server restarts as they currently have. I would address this eventually in separate PR.", "author": "mposolda", "createdAt": "2020-06-15T18:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxNDQwMw==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r440414403", "bodyText": "Cool. @stianst I think we have now a blessing from @mposolda !\nCreated https://issues.redhat.com/browse/KEYCLOAK-14480.", "author": "pedroigor", "createdAt": "2020-06-15T20:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4Nzc2Ng==", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887766", "bodyText": "Same as above - this seems to indicate some strange behaviour on Quarkus", "author": "stianst", "createdAt": "2020-06-10T06:29:30Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/GroupInvalidationClusterTest.java", "diffHunk": "@@ -66,24 +67,38 @@ protected GroupRepresentation createEntity(GroupRepresentation group, ContainerI\n \n     @Override\n     protected GroupRepresentation readEntity(GroupRepresentation group, ContainerInfo node) {\n-        GroupRepresentation u = null;\n-        try {\n-            u = entityResource(group, node).toRepresentation();\n-        } catch (NotFoundException nfe) {\n-            // expected when group doesn't exist\n-        }\n+        GroupRepresentation u = Retry.call(new Retry.Supplier<GroupRepresentation>() {\n+            @Override\n+            public GroupRepresentation get(int iteration) {\n+                try {\n+                    return entityResource(group, node).toRepresentation();\n+                } catch (NotFoundException nfe) {\n+                    return null;\n+                }\n+            }\n+        }, 3, 5000);", "originalCommit": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "url": "https://github.com/keycloak/keycloak/commit/ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-10T13:06:56Z", "type": "forcePushed"}, {"oid": "6c4d4a5b9cb5f6eafe527111332a893661828343", "url": "https://github.com/keycloak/keycloak/commit/6c4d4a5b9cb5f6eafe527111332a893661828343", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-10T18:57:08Z", "type": "forcePushed"}, {"oid": "16f171fe1f8e88c93cc745c33991c61cd2399386", "url": "https://github.com/keycloak/keycloak/commit/16f171fe1f8e88c93cc745c33991c61cd2399386", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-10T18:58:53Z", "type": "commit"}, {"oid": "16f171fe1f8e88c93cc745c33991c61cd2399386", "url": "https://github.com/keycloak/keycloak/commit/16f171fe1f8e88c93cc745c33991c61cd2399386", "message": "[KEYCLOAK-11330] - Quarkus clustering tests", "committedDate": "2020-06-10T18:58:53Z", "type": "forcePushed"}]}