{"pr_number": 7246, "pr_title": "KEYCLOAK-14698 Support complex SAML Attribute Values (e.g. XUA++)", "pr_createdAt": "2020-07-08T14:50:57Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7246", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxNjY0Mg==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452016642", "bodyText": "Currently it is expected that attributeValue starts with AttributeValue element. Yet for the sake of consistency with the rest of the values and enforcing schema compliance, the attribute value should only be the value without AttributeValue. In other words, introduce a writeElementAttributeValue(Element attributeValue) method similar to e.g. writeNameIDTypeAttributeValue", "author": "hmlnarik", "createdAt": "2020-07-09T07:26:15Z", "path": "saml-core/src/main/java/org/keycloak/saml/processing/core/saml/v2/writers/BaseWriter.java", "diffHunk": "@@ -174,6 +175,8 @@ public void writeAttributeTypeWithoutRootTag(AttributeType attributeType) throws\n                     \twriteNameIDTypeAttributeValue((NameIDType) attributeValue);\n                     } else if (attributeValue instanceof XMLGregorianCalendar) {\n                         writeDateAttributeValue((XMLGregorianCalendar) attributeValue);\n+                    } else if (attributeValue instanceof Element) {\n+                        StaxUtil.writeDOMElement(writer, (Element) attributeValue);", "originalCommit": "74f1f43990d88ed904d198f24ca803eae5ffdc4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NTI4NQ==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452055285", "bodyText": "Thanks for the suggestions - I changed the code in the proposed way. Because the type of the AttributeValue is variable, I created a new AttributeValueElementType class to contain both the type and the element.", "author": "mwalliczek", "createdAt": "2020-07-09T08:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxNjY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxNjk3Nw==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452016977", "bodyText": "This element should be removed.", "author": "hmlnarik", "createdAt": "2020-07-09T07:26:52Z", "path": "saml-core/src/test/java/org/keycloak/saml/processing/core/saml/v2/writers/XUATokenWriterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.keycloak.saml.processing.core.saml.v2.writers;\n+\n+import java.io.ByteArrayOutputStream;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.keycloak.dom.saml.v2.assertion.AttributeStatementType;\n+import org.keycloak.dom.saml.v2.assertion.AttributeType;\n+import org.keycloak.saml.common.constants.GeneralConstants;\n+import org.keycloak.saml.common.constants.JBossSAMLURIConstants;\n+import org.keycloak.saml.common.exceptions.ConfigurationException;\n+import org.keycloak.saml.common.exceptions.ProcessingException;\n+import org.keycloak.saml.common.util.DocumentUtil;\n+import org.keycloak.saml.common.util.StaxUtil;\n+import org.w3c.dom.Attr;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+\n+public class XUATokenWriterTest {\n+\n+    @Test\n+    public void testXUAToken() throws ConfigurationException, ProcessingException {\n+        Document document = DocumentUtil.createDocument();\n+\n+        AttributeType roleAttr = new AttributeType(\"urn:oasis:names:tc:xacml:2.0:subject:role\");\n+        Element attributeValue =", "originalCommit": "74f1f43990d88ed904d198f24ca803eae5ffdc4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxODUyNA==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452018524", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    attributeValue.appendChild(role);\n          \n          \n            \n                    roleAttr.addAttributeValue(attributeValue);\n          \n          \n            \n                    roleAttr.addAttributeValue(role);", "author": "hmlnarik", "createdAt": "2020-07-09T07:29:51Z", "path": "saml-core/src/test/java/org/keycloak/saml/processing/core/saml/v2/writers/XUATokenWriterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.keycloak.saml.processing.core.saml.v2.writers;\n+\n+import java.io.ByteArrayOutputStream;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.keycloak.dom.saml.v2.assertion.AttributeStatementType;\n+import org.keycloak.dom.saml.v2.assertion.AttributeType;\n+import org.keycloak.saml.common.constants.GeneralConstants;\n+import org.keycloak.saml.common.constants.JBossSAMLURIConstants;\n+import org.keycloak.saml.common.exceptions.ConfigurationException;\n+import org.keycloak.saml.common.exceptions.ProcessingException;\n+import org.keycloak.saml.common.util.DocumentUtil;\n+import org.keycloak.saml.common.util.StaxUtil;\n+import org.w3c.dom.Attr;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+\n+public class XUATokenWriterTest {\n+\n+    @Test\n+    public void testXUAToken() throws ConfigurationException, ProcessingException {\n+        Document document = DocumentUtil.createDocument();\n+\n+        AttributeType roleAttr = new AttributeType(\"urn:oasis:names:tc:xacml:2.0:subject:role\");\n+        Element attributeValue =\n+                document.createElementNS(JBossSAMLURIConstants.ASSERTION_NSURI.get(), \"AttributeValue\");\n+        Attr attrRoleType = document.createAttributeNS(JBossSAMLURIConstants.XSI_NSURI.get(), \"type\");\n+        attrRoleType.setValue(\"Role\");\n+        attrRoleType.setPrefix(\"xsi\");\n+        attributeValue.setAttributeNodeNS(attrRoleType);\n+        Element role = document.createElementNS(\"urn:hl7-org:v3\", \"Role\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"code\", \"46255001\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"codeSystem\", \"2.16.840.1.113883.6.96\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"codeSystemName\", \"SNOMED_CT\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"displayName\", \"Pharmacist\");\n+        Attr attrCEType = document.createAttributeNS(JBossSAMLURIConstants.XSI_NSURI.get(), \"type\");\n+        attrCEType.setValue(\"CE\");\n+        attrCEType.setPrefix(\"xsi\");\n+        role.setAttributeNodeNS(attrCEType);\n+        attributeValue.appendChild(role);\n+        roleAttr.addAttributeValue(attributeValue);", "originalCommit": "74f1f43990d88ed904d198f24ca803eae5ffdc4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxOTI5NA==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452019294", "bodyText": "extra attribute in AttributeValue does not conform with SAML schema\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    + \"xsi:type=\\\"Role\\\"><Role xmlns=\\\"urn:hl7-org:v3\\\" code=\\\"46255001\\\" \"\n          \n          \n            \n                                    + \"><Role xmlns=\\\"urn:hl7-org:v3\\\" code=\\\"46255001\\\" \"", "author": "hmlnarik", "createdAt": "2020-07-09T07:31:12Z", "path": "saml-core/src/test/java/org/keycloak/saml/processing/core/saml/v2/writers/XUATokenWriterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.keycloak.saml.processing.core.saml.v2.writers;\n+\n+import java.io.ByteArrayOutputStream;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.keycloak.dom.saml.v2.assertion.AttributeStatementType;\n+import org.keycloak.dom.saml.v2.assertion.AttributeType;\n+import org.keycloak.saml.common.constants.GeneralConstants;\n+import org.keycloak.saml.common.constants.JBossSAMLURIConstants;\n+import org.keycloak.saml.common.exceptions.ConfigurationException;\n+import org.keycloak.saml.common.exceptions.ProcessingException;\n+import org.keycloak.saml.common.util.DocumentUtil;\n+import org.keycloak.saml.common.util.StaxUtil;\n+import org.w3c.dom.Attr;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+\n+public class XUATokenWriterTest {\n+\n+    @Test\n+    public void testXUAToken() throws ConfigurationException, ProcessingException {\n+        Document document = DocumentUtil.createDocument();\n+\n+        AttributeType roleAttr = new AttributeType(\"urn:oasis:names:tc:xacml:2.0:subject:role\");\n+        Element attributeValue =\n+                document.createElementNS(JBossSAMLURIConstants.ASSERTION_NSURI.get(), \"AttributeValue\");\n+        Attr attrRoleType = document.createAttributeNS(JBossSAMLURIConstants.XSI_NSURI.get(), \"type\");\n+        attrRoleType.setValue(\"Role\");\n+        attrRoleType.setPrefix(\"xsi\");\n+        attributeValue.setAttributeNodeNS(attrRoleType);\n+        Element role = document.createElementNS(\"urn:hl7-org:v3\", \"Role\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"code\", \"46255001\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"codeSystem\", \"2.16.840.1.113883.6.96\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"codeSystemName\", \"SNOMED_CT\");\n+        role.setAttributeNS(\"urn:hl7-org:v3\", \"displayName\", \"Pharmacist\");\n+        Attr attrCEType = document.createAttributeNS(JBossSAMLURIConstants.XSI_NSURI.get(), \"type\");\n+        attrCEType.setValue(\"CE\");\n+        attrCEType.setPrefix(\"xsi\");\n+        role.setAttributeNodeNS(attrCEType);\n+        attributeValue.appendChild(role);\n+        roleAttr.addAttributeValue(attributeValue);\n+\n+        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+        SAMLAssertionWriter samlAssertionWriter =\n+                new SAMLAssertionWriter(StaxUtil.getXMLStreamWriter(byteArrayOutputStream));\n+\n+        AttributeStatementType attributeStatementType = new AttributeStatementType();\n+        attributeStatementType.addAttribute(new AttributeStatementType.ASTChoiceType(roleAttr));\n+\n+        samlAssertionWriter.write(attributeStatementType);\n+\n+        String serializedAssertion = new String(byteArrayOutputStream.toByteArray(), GeneralConstants.SAML_CHARSET);\n+        Assert.assertEquals(\"<saml:AttributeStatement><saml:Attribute Name=\\\"urn:oasis:names:tc:xacml:2\"\n+                        + \".0:subject:role\\\"><AttributeValue xmlns=\\\"urn:oasis:names:tc:SAML:2.0:assertion\\\" \"\n+                        + \"xsi:type=\\\"Role\\\"><Role xmlns=\\\"urn:hl7-org:v3\\\" code=\\\"46255001\\\" \"", "originalCommit": "74f1f43990d88ed904d198f24ca803eae5ffdc4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NjQ0Mg==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r452056442", "bodyText": "I think it does conform - because for String values xsi:type=\"xs:string\" is written.", "author": "mwalliczek", "createdAt": "2020-07-09T08:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxOTI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIxMDk1Mg==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r453210952", "bodyText": "The type should be a QName to include namespace definition, to allow for schema validation (see xs or ns in the following example):\n        <saml:AttributeValue xsi:type=\"xs:string\">value</saml:AttributeValue>\n        <saml:AttributeValue xsi:type=\"ns:Role\" xmlns:ns=\"urn:my:resource:type\">value</saml:AttributeValue>\nIn the case of serialization of the type, if the namespace part of QName is defined, in needs to be declared in the AttributeValue attribute. If it is not, it would allow declarations from the PR like:\n        <saml:AttributeValue xsi:type=\"Role\">value</saml:AttributeValue>\nYet the namespace-less variants do not allow schema validation so should be not used.", "author": "hmlnarik", "createdAt": "2020-07-11T16:28:03Z", "path": "saml-core-api/src/main/java/org/keycloak/dom/saml/v2/assertion/AttributeValueElementType.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.keycloak.dom.saml.v2.assertion;\n+\n+import java.io.Serializable;\n+\n+import org.w3c.dom.Element;\n+\n+public class AttributeValueElementType implements Serializable {\n+\n+    private String type;", "originalCommit": "429bf337fbcd76e998a2ef2a7b563b403500008c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ2NTM5OQ==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r453465399", "bodyText": "I implemented the changes as suggested.", "author": "mwalliczek", "createdAt": "2020-07-13T06:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIxMDk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3MjYxMA==", "url": "https://github.com/keycloak/keycloak/pull/7246#discussion_r453472610", "bodyText": "I just read the specification one more time and I think you were right with the first comment: The type attribute at attributeValue is obsolete, when the child is an element with its own type and namespace declaration.\nThe type is only necessary at simple elements like string and date, but not at complex elements.\nSo I removed the type and the AttributeValueType completly.\nSorry for the confusion.", "author": "mwalliczek", "createdAt": "2020-07-13T08:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIxMDk1Mg=="}], "type": "inlineReview"}, {"oid": "3b8c935a4bed019c8908e05ba1cff98497964a02", "url": "https://github.com/keycloak/keycloak/commit/3b8c935a4bed019c8908e05ba1cff98497964a02", "message": "KEYCLOAK-14698 Support complex SAML Attribute Values (e.g. XUA++)", "committedDate": "2020-07-15T04:49:39Z", "type": "commit"}]}