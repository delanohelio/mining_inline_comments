{"pr_number": 7554, "pr_title": "KEYCLOAK-15841 Upgrade rest of the minor forms to PF4", "pr_createdAt": "2020-10-30T09:38:57Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7554", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyNjY0NA==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517226644", "bodyText": "Why to make this change in this PR? Shouldn't it belong to #7516 which addresses migration of this file?", "author": "vmuzikar", "createdAt": "2020-11-04T10:01:10Z", "path": "themes/src/main/resources/theme/base/login/login-otp.ftl", "diffHunk": "@@ -1,5 +1,5 @@\n <#import \"template.ftl\" as layout>\n-    <@layout.registrationLayout; section>\n+    <@layout.registrationLayout displayMessage=!messagesPerField.existsError('totp'); section>", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4MTg3MA==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517281870", "bodyText": "@vmuzikar I think that this is related to the fact that @mabartos was working on the error alerts in general - across all the login screens. Therefore he made the change at once. @mabartos correct me if I'm wrong.", "author": "Pepo48", "createdAt": "2020-11-04T11:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM2ODYxNg==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517368616", "bodyText": "@Pepo48 Yes, you're right. This follow-up task was made a while after the main task, which turn on the PF4 and we were working on these issues mostly separately. And yes, we could connected it. But at this time, I think, it's only minor thing and it'll take some time to remade it. Unfortunately, we want it to merge ASAP. WDYT @vmuzikar ?", "author": "mabartos", "createdAt": "2020-11-04T14:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3Mjc2NQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517372765", "bodyText": "Ok, I'm fine with that. I'm just starting to be a little bit concerned because there are too many parallel PRs, all touching similar thing, all need to work together, sometimes even touch the same files. So let's hope it'll all work together well once merged. :)", "author": "vmuzikar", "createdAt": "2020-11-04T14:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyNjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0MzUwMw==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517243503", "bodyText": "This PO represents a page in the old Account Console, not the login page. It shouldn't be modified.", "author": "vmuzikar", "createdAt": "2020-11-04T10:28:29Z", "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/pages/AccountUpdateProfilePage.java", "diffHunk": "@@ -180,8 +184,16 @@ public String getSuccess(){\n         return successMessage.getText();\n     }\n \n-    public String getError() {\n-        return errorMessage.getText();\n+    public String getAlertError() {\n+        try {\n+            return errorMessage.getText();\n+        } catch (NoSuchElementException e) {\n+            return null;\n+        }\n+    }\n+\n+    public UpdateProfileErrors getInputErrors() {\n+        return errorsPage;", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0NjExNw==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517446117", "bodyText": "Ok", "author": "mabartos", "createdAt": "2020-11-04T15:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0MzUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NzA5OQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517247099", "bodyText": "Why to make this change in this PR? Shouldn't it belong to #7516 which addresses migration of this file?", "author": "vmuzikar", "createdAt": "2020-11-04T10:34:17Z", "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/pages/LoginTotpPage.java", "diffHunk": "@@ -45,15 +45,30 @@\n     @FindBy(className = \"alert-error\")\n     private WebElement loginErrorMessage;\n \n+    @FindBy(id = \"input-error-otp-code\")\n+    private WebElement totpInputCodeError;\n+\n     public void login(String totp) {\n         otpInput.clear();\n         if (totp != null) otpInput.sendKeys(totp);\n \n         submitButton.click();\n     }\n \n-    public String getError() {\n-        return loginErrorMessage != null ? loginErrorMessage.getText() : null;\n+    public String getAlertError() {\n+        try {\n+            return UIUtils.getTextFromElement(loginErrorMessage);\n+        } catch (NoSuchElementException e) {\n+            return null;\n+        }\n+    }\n+\n+    public String getInputError(){\n+        try {\n+            return UIUtils.getTextFromElement(totpInputCodeError);\n+        } catch (NoSuchElementException e) {\n+            return null;\n+        }", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM2OTUzNQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517369535", "bodyText": "Commented above.", "author": "mabartos", "createdAt": "2020-11-04T14:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NzA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0OTI0Ng==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517249246", "bodyText": "Why to have this as a separate PO (or in fact a page fragment)? I believe it won't be used anywhere but in LoginUpdateProfilePage, correct?", "author": "vmuzikar", "createdAt": "2020-11-04T10:37:46Z", "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/pages/UpdateProfileErrors.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.testsuite.pages;\n+\n+import org.openqa.selenium.NoSuchElementException;\n+import org.openqa.selenium.WebElement;\n+import org.openqa.selenium.support.FindBy;\n+\n+import static org.keycloak.testsuite.util.UIUtils.getTextFromElement;\n+\n+/**\n+ * @author <a href=\"mailto:mabartos@redhat.com\">Martin Bartos</a>\n+ */\n+public class UpdateProfileErrors {", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3MTc0Mw==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517371743", "bodyText": "I didn't want to hide main components in LoginUpdateProfilePage by a lot of error fields. So, IMO, it's nicer to separate errors from the other components. WDYT @vmuzikar ?", "author": "mabartos", "createdAt": "2020-11-04T14:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0OTI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3NDc0OQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517374749", "bodyText": "If you really want to put it inside a separate class, I'd make it a nested class inside LoginUpdateProfilePage as it really belongs to it. ;)", "author": "vmuzikar", "createdAt": "2020-11-04T14:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0OTI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1MDEwMQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517250101", "bodyText": "This is an old Account Console test. It shouldn't be modified at all.", "author": "vmuzikar", "createdAt": "2020-11-04T10:39:16Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java", "diffHunk": "@@ -265,11 +265,11 @@ public void changePassword() {\n         String userId = event.getUserId();\n \n         changePasswordPage.changePassword(\"\", \"new-password\", \"new-password\");\n-        Assert.assertEquals(\"Please specify password.\", profilePage.getError());\n+        Assert.assertEquals(\"Please specify password.\", profilePage.getAlertError());", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3MTgzMA==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517371830", "bodyText": "Ok", "author": "mabartos", "createdAt": "2020-11-04T14:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1MDEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1NDg1NQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517254855", "bodyText": "Did you try to run the SSSD tests? I believe they are excluded by default.", "author": "vmuzikar", "createdAt": "2020-11-04T10:47:18Z", "path": "testsuite/integration-arquillian/tests/other/sssd/src/test/java/org/keycloak/testsuite/sssd/SSSDTest.java", "diffHunk": "@@ -188,7 +185,7 @@ public void changeReadOnlyProfile() throws Exception {\n \n         profilePage.updateProfile(\"New first\", \"New last\", \"new@email.com\");\n \n-        Assert.assertEquals(\"You can't update your account as it is read-only.\", profilePage.getError());", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3NTk2NA==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517375964", "bodyText": "I'm not sure, I'll take a look at this. Thanks!", "author": "mabartos", "createdAt": "2020-11-04T14:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1NDg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3MDYzMQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517270631", "bodyText": "This is a general comment, not related only to this particular line. In the IE the exclamation mark is missing when a field is invalid. This probably affects all the related PRs and @Pepo48 already mentioned it in some other PR, so it doesn't need to be fixed in this particular PR.", "author": "vmuzikar", "createdAt": "2020-11-04T11:15:32Z", "path": "themes/src/main/resources/theme/base/login/login-update-profile.ftl", "diffHunk": "@@ -1,43 +1,79 @@\n <#import \"template.ftl\" as layout>\n-<@layout.registrationLayout; section>\n+<@layout.registrationLayout displayMessage=!messagesPerField.existsError('username','email','firstName','lastName'); section>\n     <#if section = \"header\">\n         ${msg(\"loginProfileTitle\")}\n     <#elseif section = \"form\">\n         <form id=\"kc-update-profile-form\" class=\"${properties.kcFormClass!}\" action=\"${url.loginAction}\" method=\"post\">\n             <#if user.editUsernameAllowed>\n-                <div class=\"${properties.kcFormGroupClass!} ${messagesPerField.printIfExists('username',properties.kcFormGroupErrorClass!)}\">\n+                <div class=\"${properties.kcFormGroupClass!}\">\n                     <div class=\"${properties.kcLabelWrapperClass!}\">\n                         <label for=\"username\" class=\"${properties.kcLabelClass!}\">${msg(\"username\")}</label>\n                     </div>\n                     <div class=\"${properties.kcInputWrapperClass!}\">\n-                        <input type=\"text\" id=\"username\" name=\"username\" value=\"${(user.username!'')}\" class=\"${properties.kcInputClass!}\"/>\n+                        <input type=\"text\" id=\"username\" name=\"username\" value=\"${(user.username!'')}\"\n+                               class=\"${properties.kcInputClass!}\"\n+                               aria-invalid=\"<#if messagesPerField.existsError('username')>true</#if>\"\n+                        />\n+\n+                        <#if messagesPerField.existsError('username')>\n+                            <span id=\"input-error-username\" class=\"${properties.kcInputErrorMessageClass!}\" aria-live=\"polite\">\n+                                ${kcSanitize(messagesPerField.get('username'))?no_esc}\n+                            </span>\n+                        </#if>\n                     </div>\n                 </div>\n             </#if>\n-            <div class=\"${properties.kcFormGroupClass!} ${messagesPerField.printIfExists('email',properties.kcFormGroupErrorClass!)}\">\n+            <div class=\"${properties.kcFormGroupClass!}\">\n                 <div class=\"${properties.kcLabelWrapperClass!}\">\n                     <label for=\"email\" class=\"${properties.kcLabelClass!}\">${msg(\"email\")}</label>\n                 </div>\n                 <div class=\"${properties.kcInputWrapperClass!}\">\n-                    <input type=\"text\" id=\"email\" name=\"email\" value=\"${(user.email!'')}\" class=\"${properties.kcInputClass!}\" />\n+                    <input type=\"text\" id=\"email\" name=\"email\" value=\"${(user.email!'')}\"\n+                           class=\"${properties.kcInputClass!}\"\n+                           aria-invalid=\"<#if messagesPerField.existsError('email')>true</#if>\"\n+                    />\n+\n+                    <#if messagesPerField.existsError('email')>\n+                        <span id=\"input-error-email\" class=\"${properties.kcInputErrorMessageClass!}\" aria-live=\"polite\">\n+                            ${kcSanitize(messagesPerField.get('email'))?no_esc}\n+                        </span>\n+                    </#if>\n                 </div>\n             </div>\n \n-            <div class=\"${properties.kcFormGroupClass!} ${messagesPerField.printIfExists('firstName',properties.kcFormGroupErrorClass!)}\">\n+            <div class=\"${properties.kcFormGroupClass!}\">\n                 <div class=\"${properties.kcLabelWrapperClass!}\">\n                     <label for=\"firstName\" class=\"${properties.kcLabelClass!}\">${msg(\"firstName\")}</label>\n                 </div>\n                 <div class=\"${properties.kcInputWrapperClass!}\">\n-                    <input type=\"text\" id=\"firstName\" name=\"firstName\" value=\"${(user.firstName!'')}\" class=\"${properties.kcInputClass!}\" />\n+                    <input type=\"text\" id=\"firstName\" name=\"firstName\" value=\"${(user.firstName!'')}\"\n+                           class=\"${properties.kcInputClass!}\"\n+                           aria-invalid=\"<#if messagesPerField.existsError('firstName')>true</#if>\"\n+                    />\n+\n+                    <#if messagesPerField.existsError('firstName')>\n+                        <span id=\"input-error-firstname\" class=\"${properties.kcInputErrorMessageClass!}\" aria-live=\"polite\">\n+                            ${kcSanitize(messagesPerField.get('firstName'))?no_esc}\n+                        </span>\n+                    </#if>\n                 </div>\n             </div>\n \n-            <div class=\"${properties.kcFormGroupClass!} ${messagesPerField.printIfExists('lastName',properties.kcFormGroupErrorClass!)}\">\n+            <div class=\"${properties.kcFormGroupClass!}\">\n                 <div class=\"${properties.kcLabelWrapperClass!}\">\n                     <label for=\"lastName\" class=\"${properties.kcLabelClass!}\">${msg(\"lastName\")}</label>\n                 </div>\n                 <div class=\"${properties.kcInputWrapperClass!}\">\n-                    <input type=\"text\" id=\"lastName\" name=\"lastName\" value=\"${(user.lastName!'')}\" class=\"${properties.kcInputClass!}\" />\n+                    <input type=\"text\" id=\"lastName\" name=\"lastName\" value=\"${(user.lastName!'')}\"\n+                           class=\"${properties.kcInputClass!}\"\n+                           aria-invalid=\"<#if messagesPerField.existsError('lastName')>true</#if>\"", "originalCommit": "9ad14856e4c8b43cbb0122d40dd6993fb94bd886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3NTU5OQ==", "url": "https://github.com/keycloak/keycloak/pull/7554#discussion_r517375599", "bodyText": "AFAIK It's not actually fixed in this PR. There were a lot of work to provide exclamation mark in IE.So, I think, the error message under the input box and red bottom border is sufficient to show to user that there is some error. And the 'aria-invalid' just change the color of the input box. @vmuzikar Or do you mean something different?", "author": "mabartos", "createdAt": "2020-11-04T14:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3MDYzMQ=="}], "type": "inlineReview"}, {"oid": "2e2f584b2695e4bc1791b8eb55e5d566374549c8", "url": "https://github.com/keycloak/keycloak/commit/2e2f584b2695e4bc1791b8eb55e5d566374549c8", "message": "Remove separate error class", "committedDate": "2020-11-04T15:59:40Z", "type": "forcePushed"}, {"oid": "e32fb16b1c9a401f685ac5a11f2336cec5e227c5", "url": "https://github.com/keycloak/keycloak/commit/e32fb16b1c9a401f685ac5a11f2336cec5e227c5", "message": "KEYCLOAK-15841 Upgrade rest of the minor forms to PF4", "committedDate": "2020-11-05T10:23:25Z", "type": "commit"}, {"oid": "e32fb16b1c9a401f685ac5a11f2336cec5e227c5", "url": "https://github.com/keycloak/keycloak/commit/e32fb16b1c9a401f685ac5a11f2336cec5e227c5", "message": "KEYCLOAK-15841 Upgrade rest of the minor forms to PF4", "committedDate": "2020-11-05T10:23:25Z", "type": "forcePushed"}]}