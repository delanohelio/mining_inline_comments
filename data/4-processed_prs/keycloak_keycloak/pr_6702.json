{"pr_number": 6702, "pr_title": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "pr_createdAt": "2020-01-29T17:13:16Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6702", "timeline": [{"oid": "90583f72ab84dba7bd6509d422eb340af4fe3653", "url": "https://github.com/keycloak/keycloak/commit/90583f72ab84dba7bd6509d422eb340af4fe3653", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-01-30T11:45:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374155066", "bodyText": "Should we use https://github.com/keycloak/keycloak/blob/master/server-spi-private/src/main/java/org/keycloak/models/utils/KeycloakModelUtils.java#L81 instead of UUID? SecureRandom seems more appropriate for a nonce than an UUID", "author": "stianst", "createdAt": "2020-02-03T15:08:11Z", "path": "services/src/main/java/org/keycloak/broker/oidc/OIDCIdentityProvider.java", "diffHunk": "@@ -715,4 +721,32 @@ protected BrokeredIdentityContext exchangeExternalImpl(EventBuilder event, Multi\n             throw new ErrorResponseException(OAuthErrorException.INVALID_TOKEN, \"invalid token type\", Response.Status.BAD_REQUEST);\n         }\n     }\n+\n+    @Override\n+    protected UriBuilder createAuthorizationUrl(AuthenticationRequest request) {\n+        UriBuilder uriBuilder = super.createAuthorizationUrl(request);\n+        String nonce = UUID.randomUUID().toString();", "originalCommit": "90583f72ab84dba7bd6509d422eb340af4fe3653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1Njg2OQ==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374156869", "bodyText": "UUID uses SecureRandom behind the scenes. But I can change to reuse the same code from model utils.", "author": "pedroigor", "createdAt": "2020-02-03T15:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NzMwOA==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374157308", "bodyText": "And that was the code we had previously, so I did not change this specific part.", "author": "pedroigor", "createdAt": "2020-02-03T15:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUxMTc4Nw==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374511787", "bodyText": "UUID is more expensive to generate than a SecureRandom, and since it doesn't have to be unique, just secure, there's no need to use UUID. Why not just use KeycloakModelUtils directly? It's what we use for example to generate client secrets.", "author": "stianst", "createdAt": "2020-02-04T07:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjk0NQ==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374622945", "bodyText": "@stianst done", "author": "pedroigor", "createdAt": "2020-02-04T11:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1MDc4OA==", "url": "https://github.com/keycloak/keycloak/pull/6702#discussion_r374650788", "bodyText": "Created https://issues.redhat.com/browse/KEYCLOAK-12891.", "author": "pedroigor", "createdAt": "2020-02-04T12:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE1NTA2Ng=="}], "type": "inlineReview"}, {"oid": "dd3ced4a63bbf498cd709da64c3f758b8a8403b9", "url": "https://github.com/keycloak/keycloak/commit/dd3ced4a63bbf498cd709da64c3f758b8a8403b9", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-02-04T11:18:39Z", "type": "forcePushed"}, {"oid": "83c8ca7f0c8f7287e16f4f3f015b3eec77492b14", "url": "https://github.com/keycloak/keycloak/commit/83c8ca7f0c8f7287e16f4f3f015b3eec77492b14", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-02-05T11:46:07Z", "type": "forcePushed"}, {"oid": "ac504b203d962be89173681a67eee703cc8496a0", "url": "https://github.com/keycloak/keycloak/commit/ac504b203d962be89173681a67eee703cc8496a0", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-02-05T14:19:51Z", "type": "forcePushed"}, {"oid": "01df59b06bab3af1c469a1ecc9b9f71951f6c183", "url": "https://github.com/keycloak/keycloak/commit/01df59b06bab3af1c469a1ecc9b9f71951f6c183", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-02-05T15:52:43Z", "type": "commit"}, {"oid": "01df59b06bab3af1c469a1ecc9b9f71951f6c183", "url": "https://github.com/keycloak/keycloak/commit/01df59b06bab3af1c469a1ecc9b9f71951f6c183", "message": "[KEYCLOAK-12792] - Invalid nonce handling in OIDC identity brokering", "committedDate": "2020-02-05T15:52:43Z", "type": "forcePushed"}]}