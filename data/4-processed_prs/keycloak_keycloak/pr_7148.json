{"pr_number": 7148, "pr_title": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "pr_createdAt": "2020-06-08T13:11:16Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7148", "timeline": [{"oid": "ee6d153c819fe2b5bbb1858d3b82c1c29b7a7935", "url": "https://github.com/keycloak/keycloak/commit/ee6d153c819fe2b5bbb1858d3b82c1c29b7a7935", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-08T13:14:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4ODEzMA==", "url": "https://github.com/keycloak/keycloak/pull/7148#discussion_r436688130", "bodyText": "I'm not sure if this is intended behavior. @mposolda Could you please double check this?", "author": "vmuzikar", "createdAt": "2020-06-08T13:14:37Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/broker/AbstractFirstBrokerLoginTest.java", "diffHunk": "@@ -286,14 +288,19 @@ public void testLinkAccountByLogInAsUserUsingBrowserButtons() {\n         // Click browser 'back' and then 'forward' and then continue\n         driver.navigate().back();\n         assertTrue(driver.getPageSource().contains(\"You are already logged in.\"));\n-        driver.navigate().forward();\n+        driver.navigate().forward(); // here a new execution ID is added to the URL using JS, see below\n         idpConfirmLinkPage.assertCurrent();\n \n         // Click browser 'back' on review profile page\n         idpConfirmLinkPage.clickReviewProfile();\n         waitForPage(driver, \"update account information\", false);\n         updateAccountInformationPage.assertCurrent();\n         driver.navigate().back();\n+        // JS-capable browsers (i.e. all except HtmlUnit) add a new execution ID to the URL which then causes the login expire page to appear (because the old ID and new ID don't match)\n+        if (!(driver instanceof HtmlUnitDriver)) {\n+            loginExpiredPage.assertCurrent();\n+            loginExpiredPage.clickLoginContinueLink();\n+        }", "originalCommit": "ee6d153c819fe2b5bbb1858d3b82c1c29b7a7935", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NjY5Mw==", "url": "https://github.com/keycloak/keycloak/pull/7148#discussion_r436886693", "bodyText": "@vmuzikar Yes, this is expected behaviour. IMO this change is fine", "author": "mposolda", "createdAt": "2020-06-08T17:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4ODEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4Nzc1MQ==", "url": "https://github.com/keycloak/keycloak/pull/7148#discussion_r436887751", "bodyText": "Thanks!", "author": "vmuzikar", "createdAt": "2020-06-08T17:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4ODEzMA=="}], "type": "inlineReview"}, {"oid": "4d6757b305a3ed2147f192fa5bb8b7170c459bce", "url": "https://github.com/keycloak/keycloak/commit/4d6757b305a3ed2147f192fa5bb8b7170c459bce", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-08T13:57:21Z", "type": "forcePushed"}, {"oid": "be97910ceb1aab529ab1e2d360ba4a4912815353", "url": "https://github.com/keycloak/keycloak/commit/be97910ceb1aab529ab1e2d360ba4a4912815353", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-09T14:08:50Z", "type": "forcePushed"}, {"oid": "c52a7d0d268b4b40d20ee238a26d23fd8ed27f3e", "url": "https://github.com/keycloak/keycloak/commit/c52a7d0d268b4b40d20ee238a26d23fd8ed27f3e", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-09T14:13:19Z", "type": "forcePushed"}, {"oid": "edef4443ae54e6eaf03e17edd9bf0b25affaca18", "url": "https://github.com/keycloak/keycloak/commit/edef4443ae54e6eaf03e17edd9bf0b25affaca18", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-10T13:48:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAxODA1OA==", "url": "https://github.com/keycloak/keycloak/pull/7148#discussion_r440018058", "bodyText": "By default with this profile, firefox is running in headless mode. Could you please add some info about firefoxHeadless property here?", "author": "mhajas", "createdAt": "2020-06-15T08:40:06Z", "path": "testsuite/integration-arquillian/HOW-TO-RUN.md", "diffHunk": "@@ -925,3 +925,19 @@ Then, just run tests using the `auth-server-quarkus` profile:\n \n     mvn -f testsuite/integration-arquillian/tests/base/pom.xml clean install -Pauth-server-quarkus\n \n+## Cookies testing\n+In order to reproduce some specific cookies behaviour in browsers (like SameSite policies or 3rd party cookie blocking),\n+some subset of tests needs to be ran with different hosts for auth server and app/IdP server in order to simulate third\n+party contexts. Those hosts must be different from localhost as that host has some special treatment from browsers. At\n+the same time both hosts must use different domains to be considered cross-origin, e.g. `127.0.0.1.nip.io` and\n+`127.0.0.1.xip.io`. NOT `app1.127.0.0.1.nip.io` and `app2.127.0.0.1.nip.io`!!\n+\n+Also, those new cookies policies are currently not yet enabled by default (which will change in the near future). To test\n+those policies, you need the latest stable Firefox and use `firefox-strict-cookies` profile.", "originalCommit": "edef4443ae54e6eaf03e17edd9bf0b25affaca18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1NjYyOQ==", "url": "https://github.com/keycloak/keycloak/pull/7148#discussion_r440056629", "bodyText": "Thanks for the review! I've updated the docs.", "author": "vmuzikar", "createdAt": "2020-06-15T09:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAxODA1OA=="}], "type": "inlineReview"}, {"oid": "ff5b4875dbbae8a22415eadc3ab98446839f9b67", "url": "https://github.com/keycloak/keycloak/commit/ff5b4875dbbae8a22415eadc3ab98446839f9b67", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-15T09:44:40Z", "type": "forcePushed"}, {"oid": "f96929efa116cf63b39c2e0f2fdab87a4e99673d", "url": "https://github.com/keycloak/keycloak/commit/f96929efa116cf63b39c2e0f2fdab87a4e99673d", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-15T16:15:36Z", "type": "forcePushed"}, {"oid": "8d7fef3977930ef649e7d6e72f473e9c57333fd2", "url": "https://github.com/keycloak/keycloak/commit/8d7fef3977930ef649e7d6e72f473e9c57333fd2", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-17T07:00:12Z", "type": "commit"}, {"oid": "8d7fef3977930ef649e7d6e72f473e9c57333fd2", "url": "https://github.com/keycloak/keycloak/commit/8d7fef3977930ef649e7d6e72f473e9c57333fd2", "message": "KEYCLOAK-14235 Support for running broker tests with different hostnames for auth server and IdP", "committedDate": "2020-06-17T07:00:12Z", "type": "forcePushed"}]}