{"pr_number": 6809, "pr_title": "[KEYCLOAK-13044] Fix owner name representations of UMA tickets for client-owned resources", "pr_createdAt": "2020-02-19T18:54:10Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6809", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc2MQ==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446341761", "bodyText": "Tests should pass if you use a method reference here as follows \n  \n    \n      keycloak/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/AuthzCleanupTest.java\n    \n    \n         Line 102\n      in\n      419d9c6\n    \n    \n    \n    \n\n        \n          \n           testingClient.server().run(AuthzCleanupTest::setup); \n        \n    \n  \n\n.", "author": "pedroigor", "createdAt": "2020-06-26T18:22:43Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/authz/UmaRepresentationTest.java", "diffHunk": "@@ -0,0 +1,173 @@\n+package org.keycloak.testsuite.authz;\n+\n+import org.jboss.resteasy.mock.MockHttpRequest;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.keycloak.admin.client.resource.RealmResource;\n+import org.keycloak.authorization.AuthorizationProvider;\n+import org.keycloak.authorization.client.resource.PermissionResource;\n+import org.keycloak.forms.account.freemarker.model.AuthorizationBean;\n+import org.keycloak.forms.account.freemarker.model.AuthorizationBean.ResourceBean;\n+import org.keycloak.representations.idm.UserRepresentation;\n+import org.keycloak.representations.idm.authorization.*;\n+import org.keycloak.testsuite.arquillian.annotation.AuthServerContainerExclude;\n+import org.keycloak.testsuite.arquillian.annotation.AuthServerContainerExclude.AuthServer;\n+\n+import java.net.URISyntaxException;\n+import java.util.List;\n+\n+@AuthServerContainerExclude(AuthServer.REMOTE)\n+public class UmaRepresentationTest extends AbstractResourceServerTest {\n+    private ResourceRepresentation resource;\n+    private PermissionResource permission;\n+\n+    private void createPermissionTicket() {\n+        PermissionTicketRepresentation ticket = new PermissionTicketRepresentation();\n+        ticket.setOwner(resource.getOwner().getId());\n+        ticket.setResource(resource.getId());\n+        ticket.setRequesterName(\"kolo\");\n+        ticket.setScopeName(\"ScopeA\");\n+        ticket.setGranted(true);\n+        permission.create(ticket);\n+    }\n+\n+    @Test\n+    public void testCanRepresentPermissionTicketWithNamesOfResourceOwnedByUser() throws Exception {\n+        resource = addResource(\"Resource A\", \"marta\", true, \"ScopeA\");\n+        permission = getAuthzClient().protection(\"marta\", \"password\").permission();\n+        createPermissionTicket();\n+\n+        List<PermissionTicketRepresentation> permissionTickets = permission.find(resource.getId(), null, null, null, null, true, null, null);\n+        Assert.assertFalse(permissionTickets.isEmpty());\n+        Assert.assertEquals(1, permissionTickets.size());\n+\n+        PermissionTicketRepresentation ticket = permissionTickets.get(0);\n+        Assert.assertEquals(ticket.getOwnerName(), \"marta\");\n+        Assert.assertEquals(ticket.getRequesterName(), \"kolo\");\n+        Assert.assertEquals(ticket.getResourceName(), \"Resource A\");\n+        Assert.assertEquals(ticket.getScopeName(), \"ScopeA\");\n+        Assert.assertTrue(ticket.isGranted());\n+    }\n+\n+    @Test\n+    public void testCanRepresentPermissionTicketWithNamesOfResourceOwnedByClient() throws Exception {\n+        resource = addResource(\"Resource A\", getClient(getRealm()).toRepresentation().getId(), true, \"ScopeA\");\n+        permission = getAuthzClient().protection().permission();\n+        createPermissionTicket();\n+\n+        List<PermissionTicketRepresentation> permissionTickets = permission.find(resource.getId(), null, null, null, null, true, null, null);\n+        Assert.assertFalse(permissionTickets.isEmpty());\n+        Assert.assertEquals(1, permissionTickets.size());\n+\n+        PermissionTicketRepresentation ticket = permissionTickets.get(0);\n+        Assert.assertEquals(ticket.getOwnerName(), \"resource-server-test\");\n+        Assert.assertEquals(ticket.getRequesterName(), \"kolo\");\n+        Assert.assertEquals(ticket.getResourceName(), \"Resource A\");\n+        Assert.assertEquals(ticket.getScopeName(), \"ScopeA\");\n+        Assert.assertTrue(ticket.isGranted());\n+    }\n+\n+    @Test\n+    public void testCanRepresentPolicyResultGrantOfResourceOwnedByUser() throws Exception {\n+        resource = addResource(\"Resource A\", \"marta\", true, \"ScopeA\");\n+        permission = getAuthzClient().protection(\"marta\", \"password\").permission();\n+        createPermissionTicket();\n+\n+        RealmResource realm = getRealm();\n+        String resourceServerId = getClient(realm).toRepresentation().getId();\n+        UserRepresentation user = realm.users().search(\"kolo\").get(0);\n+\n+        PolicyEvaluationRequest request = new PolicyEvaluationRequest();\n+        request.setUserId(user.getId());\n+        request.setClientId(resourceServerId);\n+        request.addResource(\"Resource A\", \"ScopeA\");\n+        PolicyEvaluationResponse result = getClient(realm).authorization().policies().evaluate(request);\n+        Assert.assertEquals(result.getStatus(), DecisionEffect.PERMIT);\n+\n+        List<PolicyEvaluationResponse.EvaluationResultRepresentation> evaluations = result.getResults();\n+        Assert.assertFalse(evaluations.isEmpty());\n+        Assert.assertEquals(1, evaluations.size());\n+\n+        List<PolicyEvaluationResponse.PolicyResultRepresentation> policies = evaluations.get(0).getPolicies();\n+        Assert.assertFalse(evaluations.isEmpty());\n+        Assert.assertEquals(1, evaluations.size());\n+\n+        String description = policies.get(0).getPolicy().getDescription();\n+        Assert.assertTrue(description.startsWith(\"Resource owner (marta) grants access\"));\n+    }\n+\n+    @Test\n+    public void testCanRepresentPolicyResultGrantOfResourceOwnedByClient() throws Exception {\n+        resource = addResource(\"Resource A\", getClient(getRealm()).toRepresentation().getId(), true, \"ScopeA\");\n+        permission = getAuthzClient().protection().permission();\n+        createPermissionTicket();\n+\n+        RealmResource realm = getRealm();\n+        String resourceServerId = getClient(realm).toRepresentation().getId();\n+        UserRepresentation user = realm.users().search(\"kolo\").get(0);\n+\n+        PolicyEvaluationRequest request = new PolicyEvaluationRequest();\n+        request.setUserId(user.getId());\n+        request.setClientId(resourceServerId);\n+        request.addResource(\"Resource A\", \"ScopeA\");\n+        PolicyEvaluationResponse result = getClient(realm).authorization().policies().evaluate(request);\n+        Assert.assertEquals(result.getStatus(), DecisionEffect.PERMIT);\n+\n+        List<PolicyEvaluationResponse.EvaluationResultRepresentation> evaluations = result.getResults();\n+        Assert.assertFalse(evaluations.isEmpty());\n+        Assert.assertEquals(1, evaluations.size());\n+\n+        List<PolicyEvaluationResponse.PolicyResultRepresentation> policies = evaluations.get(0).getPolicies();\n+        Assert.assertFalse(evaluations.isEmpty());\n+        Assert.assertEquals(1, evaluations.size());\n+\n+        String description = policies.get(0).getPolicy().getDescription();\n+        Assert.assertTrue(description.startsWith(\"Resource owner (resource-server-test) grants access\"));\n+    }\n+\n+    @Test\n+    public void testCanRepresentResourceBeanOfResourceOwnedByUser() throws Exception {\n+        resource = addResource(\"Resource A\", \"marta\", true, \"ScopeA\");\n+\n+        testingClient.server().run(session -> {", "originalCommit": "474f60dfbaa0ca58b5ca1eba2cd4771754ea235f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1Njk1Ng==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446356956", "bodyText": "I was stuck on how to pass the resource ID, since the reference has to be a static method. But finding the resource by name instead should work fine.", "author": "EpicEric", "createdAt": "2020-06-26T18:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MzcyNw==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446343727", "bodyText": "You should get the client from the realm. For instance, using org.keycloak.models.RealmModel#getClientById.", "author": "pedroigor", "createdAt": "2020-06-26T18:27:17Z", "path": "server-spi-private/src/main/java/org/keycloak/models/utils/ModelToRepresentation.java", "diffHunk": "@@ -1018,10 +1018,15 @@ public static PermissionTicketRepresentation toRepresentation(PermissionTicket t\n             representation.setResourceName(resource.getName());\n             KeycloakSession keycloakSession = authorization.getKeycloakSession();\n             RealmModel realm = authorization.getRealm();\n-            UserModel owner = keycloakSession.users().getUserById(ticket.getOwner(), realm);\n+            UserModel userOwner = keycloakSession.users().getUserById(ticket.getOwner(), realm);\n             UserModel requester = keycloakSession.users().getUserById(ticket.getRequester(), realm);\n             representation.setRequesterName(requester.getUsername());\n-            representation.setOwnerName(owner.getUsername());\n+            if (userOwner != null) {\n+                representation.setOwnerName(userOwner.getUsername());\n+            } else {\n+                ClientModel clientOwner = keycloakSession.clientStorageManager().getClientById(ticket.getOwner(), realm);", "originalCommit": "474f60dfbaa0ca58b5ca1eba2cd4771754ea235f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0Mzk0MA==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446343940", "bodyText": "Same here", "author": "pedroigor", "createdAt": "2020-06-26T18:27:45Z", "path": "services/src/main/java/org/keycloak/authorization/admin/representation/PolicyEvaluationResponseBuilder.java", "diffHunk": "@@ -196,11 +197,19 @@ public static PolicyEvaluationResponse build(PolicyEvaluationService.EvaluationD\n \n             if (!tickets.isEmpty()) {\n                 KeycloakSession keycloakSession = authorization.getKeycloakSession();\n+                RealmModel realm = authorization.getRealm();\n                 PermissionTicket ticket = tickets.get(0);\n-                UserModel owner = keycloakSession.users().getUserById(ticket.getOwner(), authorization.getRealm());\n-                UserModel requester = keycloakSession.users().getUserById(ticket.getRequester(), authorization.getRealm());\n+                UserModel userOwner = keycloakSession.users().getUserById(ticket.getOwner(), realm);\n+                UserModel requester = keycloakSession.users().getUserById(ticket.getRequester(), realm);\n+                String resourceOwner;\n+                if (userOwner != null) {\n+                    resourceOwner = getUserEmailOrUserName(userOwner);\n+                } else {\n+                    ClientModel clientOwner = keycloakSession.clientStorageManager().getClientById(ticket.getOwner(), realm);", "originalCommit": "474f60dfbaa0ca58b5ca1eba2cd4771754ea235f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NDE2Nw==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446344167", "bodyText": "Same here", "author": "pedroigor", "createdAt": "2020-06-26T18:28:16Z", "path": "services/src/main/java/org/keycloak/forms/account/freemarker/model/AuthorizationBean.java", "diffHunk": "@@ -234,7 +236,17 @@ public ResourceBean(Resource resource) {\n             RealmModel realm = authorization.getRealm();\n             resourceServer = new ResourceServerBean(realm.getClientById(resource.getResourceServer().getId()));\n             this.resource = resource;\n-            owner = authorization.getKeycloakSession().users().getUserById(resource.getOwner(), realm);\n+            userOwner = authorization.getKeycloakSession().users().getUserById(resource.getOwner(), realm);\n+            if (userOwner == null) {\n+                clientOwner = authorization.getKeycloakSession().clientStorageManager().getClientById(resource.getOwner(), realm);", "originalCommit": "474f60dfbaa0ca58b5ca1eba2cd4771754ea235f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NTA2NA==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446345064", "bodyText": "Do you really need to set this to null?", "author": "pedroigor", "createdAt": "2020-06-26T18:30:20Z", "path": "services/src/main/java/org/keycloak/forms/account/freemarker/model/AuthorizationBean.java", "diffHunk": "@@ -234,7 +236,17 @@ public ResourceBean(Resource resource) {\n             RealmModel realm = authorization.getRealm();\n             resourceServer = new ResourceServerBean(realm.getClientById(resource.getResourceServer().getId()));\n             this.resource = resource;\n-            owner = authorization.getKeycloakSession().users().getUserById(resource.getOwner(), realm);\n+            userOwner = authorization.getKeycloakSession().users().getUserById(resource.getOwner(), realm);\n+            if (userOwner == null) {\n+                clientOwner = authorization.getKeycloakSession().clientStorageManager().getClientById(resource.getOwner(), realm);\n+                ownerName = clientOwner.getClientId();\n+            } else if (userOwner.getEmail() != null) {\n+                clientOwner = null;", "originalCommit": "474f60dfbaa0ca58b5ca1eba2cd4771754ea235f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1Njk4OA==", "url": "https://github.com/keycloak/keycloak/pull/6809#discussion_r446356988", "bodyText": "If clientOwner has to be final, yes. But since that should be unnecessary, I'll remove the keyword.", "author": "EpicEric", "createdAt": "2020-06-26T18:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NTA2NA=="}], "type": "inlineReview"}, {"oid": "603f5188a3ac3f920c38043c63c0b9a2450df1f7", "url": "https://github.com/keycloak/keycloak/commit/603f5188a3ac3f920c38043c63c0b9a2450df1f7", "message": "[KEYCLOAK-13044] Fix owner name representations of UMA tickets for client-owned resources", "committedDate": "2020-07-01T19:21:09Z", "type": "commit"}]}