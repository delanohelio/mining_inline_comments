{"pr_number": 6728, "pr_title": "KEYCLOAK-7969 - SAML users should not be identified by SAML:NameID", "pr_createdAt": "2020-02-04T23:43:46Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6728", "timeline": [{"oid": "b9b7769950255b9e3cac33a800a6ac787133dcbd", "url": "https://github.com/keycloak/keycloak/commit/b9b7769950255b9e3cac33a800a6ac787133dcbd", "message": "KEYCLOAK-7969 (tests)", "committedDate": "2020-02-05T01:04:54Z", "type": "forcePushed"}, {"oid": "951e0fcc1a6196242008820e68b347921253fd8e", "url": "https://github.com/keycloak/keycloak/commit/951e0fcc1a6196242008820e68b347921253fd8e", "message": "KEYCLOAK-7969 (tests)", "committedDate": "2020-02-05T01:53:25Z", "type": "forcePushed"}, {"oid": "b69b5c3492cca97531301d421776330dd91426ef", "url": "https://github.com/keycloak/keycloak/commit/b69b5c3492cca97531301d421776330dd91426ef", "message": "KEYCLOAK-7969 (tests)", "committedDate": "2020-02-05T02:50:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA4MzM4NQ==", "url": "https://github.com/keycloak/keycloak/pull/6728#discussion_r375083385", "bodyText": "ensure that attribute is not null to prevent NPE", "author": "hmlnarik", "createdAt": "2020-02-05T06:48:59Z", "path": "saml-core/src/main/java/org/keycloak/saml/processing/core/saml/v2/constants/X500SAMLProfileConstants.java", "diffHunk": "@@ -147,6 +150,10 @@ public String getFriendlyName() {\n         return friendlyName;\n     }\n \n+    public boolean correspondsTo(AttributeType attribute) {\n+        return Objects.equals(this.uri, attribute.getName()) || Objects.equals(this.friendlyName, attribute.getFriendlyName());", "originalCommit": "b69b5c3492cca97531301d421776330dd91426ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNDY0OA==", "url": "https://github.com/keycloak/keycloak/pull/6728#discussion_r375134648", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            saml.principal-type=Principal\n          \n          \n            \n            saml.principal-type=Principal Type", "author": "hmlnarik", "createdAt": "2020-02-05T09:11:52Z", "path": "themes/src/main/resources/theme/base/admin/messages/admin-messages_en.properties", "diffHunk": "@@ -643,6 +643,10 @@ single-logout-service-url=Single Logout Service URL\n saml.single-logout-service-url.tooltip=The Url that must be used to send logout requests.\n nameid-policy-format=NameID Policy Format\n nameid-policy-format.tooltip=Specifies the URI reference corresponding to a name identifier format. Defaults to urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.\n+saml.principal-type=Principal", "originalCommit": "b69b5c3492cca97531301d421776330dd91426ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNzI5Mw==", "url": "https://github.com/keycloak/keycloak/pull/6728#discussion_r375137293", "bodyText": "No opinions please, just pure description.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            saml.principal-type.tooltip=Specifies how Keycloak should identify and track external users. Default is using Subject NameID, though it is recommended to set up identifying attribute which is more reliable.\n          \n          \n            \n            saml.principal-type.tooltip=Way to identify and track external users from the assertion. Default is using Subject NameID, alternatively you can set up identifying attribute.", "author": "hmlnarik", "createdAt": "2020-02-05T09:17:25Z", "path": "themes/src/main/resources/theme/base/admin/messages/admin-messages_en.properties", "diffHunk": "@@ -643,6 +643,10 @@ single-logout-service-url=Single Logout Service URL\n saml.single-logout-service-url.tooltip=The Url that must be used to send logout requests.\n nameid-policy-format=NameID Policy Format\n nameid-policy-format.tooltip=Specifies the URI reference corresponding to a name identifier format. Defaults to urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.\n+saml.principal-type=Principal\n+saml.principal-type.tooltip=Specifies how Keycloak should identify and track external users. Default is using Subject NameID, though it is recommended to set up identifying attribute which is more reliable.", "originalCommit": "b69b5c3492cca97531301d421776330dd91426ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNzg1OQ==", "url": "https://github.com/keycloak/keycloak/pull/6728#discussion_r375137859", "bodyText": "Please address the comments from en version in this translation as well", "author": "hmlnarik", "createdAt": "2020-02-05T09:18:31Z", "path": "themes/src/main/resources-community/theme/base/admin/messages/admin-messages_ru.properties", "diffHunk": "@@ -527,6 +527,10 @@ single-logout-service-url=\u0410\u0434\u0440\u0435\u0441\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u0435\u0434\u0438\u043d\u043e\u0433\u043e \u0432\u044b\u0445\u043e\u0434\n saml.single-logout-service-url.tooltip=Url, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d \u0434\u043b\u044f \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043d\u044b\u0445 \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0432\u044b\u0445\u043e\u0434.\n nameid-policy-format=\u0424\u043e\u0440\u043c\u0430\u0442 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0438 NameID\n nameid-policy-format.tooltip=\u041e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442 \u0441\u0441\u044b\u043b\u043a\u0443 URI, \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u044e\u0449\u0443\u044e \u0444\u043e\u0440\u043c\u0430\u0442\u0443 \u0438\u0434\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440\u0430 \u0438\u043c\u0435\u043d\u0438. \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.\n+saml.principal-type=\u0418\u0434\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f", "originalCommit": "b69b5c3492cca97531301d421776330dd91426ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MDQ1NQ==", "url": "https://github.com/keycloak/keycloak/pull/6728#discussion_r375140455", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                logger.error(\"no principal in assertion; expected: \" + expectedPrincipalType());\n          \n          \n            \n                                logger.errorf(\"no principal in assertion; expected: %s\", expectedPrincipalType());", "author": "hmlnarik", "createdAt": "2020-02-05T09:23:34Z", "path": "services/src/main/java/org/keycloak/broker/saml/SAMLEndpoint.java", "diffHunk": "@@ -414,15 +416,24 @@ protected Response handleLoginResponse(String samlResponse, SAMLDocumentHolder h\n                 SubjectType subject = assertion.getSubject();\n                 SubjectType.STSubType subType = subject.getSubType();\n                 NameIDType subjectNameID = (NameIDType) subType.getBaseID();\n+                String principal = getPrincipal(assertion);\n+\n+                if (principal == null) {\n+                    logger.error(\"no principal in assertion; expected: \" + expectedPrincipalType());", "originalCommit": "b69b5c3492cca97531301d421776330dd91426ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fc0fccfd5115b3ef0a44750b30bfc674e568798", "url": "https://github.com/keycloak/keycloak/commit/5fc0fccfd5115b3ef0a44750b30bfc674e568798", "message": "KEYCLOAK-7969 - SAML users should not be identified by SAML:NameID", "committedDate": "2020-02-05T14:13:14Z", "type": "commit"}, {"oid": "5fc0fccfd5115b3ef0a44750b30bfc674e568798", "url": "https://github.com/keycloak/keycloak/commit/5fc0fccfd5115b3ef0a44750b30bfc674e568798", "message": "KEYCLOAK-7969 - SAML users should not be identified by SAML:NameID", "committedDate": "2020-02-05T14:13:14Z", "type": "forcePushed"}]}