{"pr_number": 25, "pr_title": "Adding support for connection pooling in TPCC.", "pr_createdAt": "2020-06-11T02:07:27Z", "pr_url": "https://github.com/yugabyte/tpcc/pull/25", "timeline": [{"oid": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "url": "https://github.com/yugabyte/tpcc/commit/b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "message": "Adding support for connection pooling in TPCC.\n\nSummary:\nWe need 10X the number of terminals with respect to the number of\nwarehouses to get a good TPM-C number. Each terminal gets its own\nconnection to perform transactions. This is fine for smaller number of\nwarehouses. But as the number increases, we reach the limit of the max\nnumber of connections supported by the DB.\n\nGiven that each terminal spends most of its time waiting for keying or\nfor thinking, we could reuse the connections across the terminals.\n\nThis change creates a Hikari pool one per endpoint and each worker gets\na reference to the pool rather than an actual connection. When the\nworker executes a transaction, it gets a connection from the pool and\n gives the connection back to the pool once the transaction is done.\n\nEach worker prepares a statement every time it executes a transaction.\nThis is fine since the driver has a cache of PreparedStatements per\nconnection of size 256. The number of unique statements in the\napplication is 33. Hence we don't send the PrepareStatement requests to\nthe server every time.\n\nReviewers:\nNeha, Mikhail, Karthik", "committedDate": "2020-06-11T01:59:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjI4OA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438512288", "bodyText": "Fix this comment as well or remove it.", "author": "mbautin", "createdAt": "2020-06-11T02:45:56Z", "path": "config/workload_all.xml", "diffHunk": "@@ -2,11 +2,13 @@\n <parameters>\r\n     <dbtype>postgres</dbtype>\r\n     <driver>org.postgresql.Driver</driver>\r\n-    <DBUrls>\r\n+    <nodes>\r\n       <!-- Add as many DBUrl as the number of nodes present.  -->\r", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNjcwNg==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439106706", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-06-11T22:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzQxMg==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438537412", "bodyText": "I don't agree with catching and ignoring exceptions. There must be a better way to get an element from an XML file. Or, if you must catch and ignore this particular exception, encapsulate that logic in a helper function taking an xml config and a key and do not wrap additional code in these exception-suppressing blocks.", "author": "mbautin", "createdAt": "2020-06-11T04:34:35Z", "path": "src/com/oltpbenchmark/DBWorkload.java", "diffHunk": "@@ -264,6 +264,26 @@ public static void main(String[] args) throws Exception {\n                 // Nothing to do here !\n             }\n \n+            try {\n+                wrkld.setPort(xmlConfig.getInt(\"port\"));\n+            } catch(NoSuchElementException nse) {\n+                // Nothing to do here !\n+            }\n+\n+            try {\n+                wrkld.setNumDBConnections(xmlConfig.getInt(\"numDBConnections\"));\n+            } catch(NoSuchElementException nse) {\n+                // Nothing to do here !\n+            }", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwOTY5MQ==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439109691", "bodyText": "Done", "author": "psudheer21", "createdAt": "2020-06-11T22:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzY4MA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438537680", "bodyText": "Fix indentation", "author": "mbautin", "createdAt": "2020-06-11T04:35:45Z", "path": "src/com/oltpbenchmark/WorkloadConfiguration.java", "diffHunk": "@@ -103,12 +105,12 @@ public DatabaseType getDBType() {\n         return db_type;\n     }\n \n-\tpublic void setDBConnections(List<String> connections) {\n-      this.dbConnections = connections;\n+\tpublic void setNodes(List<String> nodes) {\n+      this.nodes = nodes;", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwOTczNA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439109734", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-06-11T22:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzcxMw==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438537713", "bodyText": "Fix indentation", "author": "mbautin", "createdAt": "2020-06-11T04:35:54Z", "path": "src/com/oltpbenchmark/WorkloadConfiguration.java", "diffHunk": "@@ -103,12 +105,12 @@ public DatabaseType getDBType() {\n         return db_type;\n     }\n \n-\tpublic void setDBConnections(List<String> connections) {\n-      this.dbConnections = connections;\n+\tpublic void setNodes(List<String> nodes) {\n+      this.nodes = nodes;\n \t}\n \n-\tpublic List<String> getDBConnections() {\n-\t\treturn dbConnections;\n+\tpublic List<String> getNodes() {\n+\t\treturn nodes;", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzkyOA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438537928", "bodyText": "Why are we just logging an exception and proceeding here? Wouldn't it be better to let the workload crash at this point? (E.g. wrap and re-throw the exception as a RuntimeException if necessary.)", "author": "mbautin", "createdAt": "2020-06-11T04:36:49Z", "path": "src/com/oltpbenchmark/api/BenchmarkModule.java", "diffHunk": "@@ -95,28 +99,37 @@ public BenchmarkModule(String benchmarkName, WorkloadConfiguration workConf, boo\n         this.catalog = (withCatalog ? new Catalog(this) : null);\n         File xmlFile = this.getSQLDialect();\n         this.dialects = new StatementDialects(this.workConf.getDBType(), xmlFile);\n+\n+        try {\n+            createDataSource();\n+        } catch (Exception e) {\n+            LOG.error(\"Failed to create Data source\", e);\n+        }", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExMDQ2NA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439110464", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-06-11T22:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNzkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzODMwMQ==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438538301", "bodyText": "This should probably be a \"ceiling\" value, i.e. (totalConnections + numNodes - 1) / numNodes.", "author": "mbautin", "createdAt": "2020-06-11T04:38:21Z", "path": "src/com/oltpbenchmark/api/BenchmarkModule.java", "diffHunk": "@@ -95,28 +99,37 @@ public BenchmarkModule(String benchmarkName, WorkloadConfiguration workConf, boo\n         this.catalog = (withCatalog ? new Catalog(this) : null);\n         File xmlFile = this.getSQLDialect();\n         this.dialects = new StatementDialects(this.workConf.getDBType(), xmlFile);\n+\n+        try {\n+            createDataSource();\n+        } catch (Exception e) {\n+            LOG.error(\"Failed to create Data source\", e);\n+        }\n     }\n \n-    // --------------------------------------------------------------------------\n-    // DATABASE CONNETION\n-    // --------------------------------------------------------------------------\n+    private List<HikariDataSource> listDataSource = new ArrayList<>();\n+\n+    public void createDataSource() throws SQLException {\n+        int numConnections = workConf.getNumDBConnections() / workConf.getNodes().size();", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMzMzNg==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439123336", "bodyText": "Makes sense.", "author": "psudheer21", "createdAt": "2020-06-11T23:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzODMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzODQyMg==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r438538422", "bodyText": "Add a space after the comma", "author": "mbautin", "createdAt": "2020-06-11T04:38:51Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCWorker.java", "diffHunk": "@@ -67,7 +68,7 @@ public TPCCWorker(TPCCBenchmark benchmarkModule, int id,\n \t * Executes a single TPCC transaction of type transactionType.\n \t */\n \t@Override\n-    protected TransactionStatus executeWork(TransactionType nextTransaction) throws UserAbortException, SQLException {\n+    protected TransactionStatus executeWork(Connection conn,TransactionType nextTransaction) throws UserAbortException, SQLException {", "originalCommit": "b474698deaa8f916e6b50cee2f2a3d2ecf3d8234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMzIyMw==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439123223", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-06-11T23:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzODQyMg=="}], "type": "inlineReview"}, {"oid": "593c92326cccbf74baa84c2344c096c47541c843", "url": "https://github.com/yugabyte/tpcc/commit/593c92326cccbf74baa84c2344c096c47541c843", "message": "Addressed comments.", "committedDate": "2020-06-11T23:40:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMzUxOA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439133518", "bodyText": "Nit: indentation seems inconsistent in this file.", "author": "mbautin", "createdAt": "2020-06-12T00:01:56Z", "path": "src/com/oltpbenchmark/WorkloadConfiguration.java", "diffHunk": "@@ -43,14 +43,16 @@ public void setBenchmarkName(String benchmarkName) {\n         this.benchmarkName = benchmarkName;\n     }\n \n-    private List<String> dbConnections;\n+    private List<String> nodes;\n \tprivate String db_name;", "originalCommit": "593c92326cccbf74baa84c2344c096c47541c843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0MzAzNA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439243034", "bodyText": "Reformatted the entire code...", "author": "psudheer21", "createdAt": "2020-06-12T07:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMzUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMzY2OA==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439133668", "bodyText": "Nit: remove an extra space after r", "author": "mbautin", "createdAt": "2020-06-12T00:02:33Z", "path": "src/com/oltpbenchmark/api/BenchmarkModule.java", "diffHunk": "@@ -87,36 +91,47 @@\n      */\n     private final Random rng = new Random();\n \n-    public BenchmarkModule(String benchmarkName, WorkloadConfiguration workConf, boolean withCatalog) {\n+    public BenchmarkModule(String benchmarkName, WorkloadConfiguration workConf, boolean withCatalog) throws Exception {\n         assert (workConf != null) : \"The WorkloadConfiguration instance is null.\";\n \n         this.benchmarkName = benchmarkName;\n         this.workConf = workConf;\n         this.catalog = (withCatalog ? new Catalog(this) : null);\n         File xmlFile = this.getSQLDialect();\n         this.dialects = new StatementDialects(this.workConf.getDBType(), xmlFile);\n+\n+        try {\n+            createDataSource();\n+        } catch (Exception e) {\n+            LOG.error(\"Failed to create Data source\", e);\n+            throw e;\n+        }\n     }\n \n-    // --------------------------------------------------------------------------\n-    // DATABASE CONNETION\n-    // --------------------------------------------------------------------------\n+    private List<HikariDataSource> listDataSource = new ArrayList<>();\n+\n+    public void createDataSource() throws SQLException {\n+        int numConnections =\n+            (workConf.getNumDBConnections() + workConf.getNodes().size() - 1) / workConf.getNodes().size();\n+        for (String ip : workConf.getNodes()) {\n+            Properties props = new Properties();\n+            props.setProperty(\"dataSourceClassName\", \"org.postgresql.ds.PGSimpleDataSource\");\n+            props.setProperty(\"dataSource.serverName\", ip);\n+            props.setProperty(\"dataSource.portNumber\", Integer.toString(workConf.getPort()));\n+            props.setProperty(\"dataSource.user\", workConf.getDBUsername());\n+            props.setProperty(\"dataSource.password\", workConf.getDBPassword());\n+            props.setProperty(\"dataSource.databaseName\", workConf.getDBName());\n+            props.setProperty(\"maximumPoolSize\", Integer.toString(numConnections));\n+\n+            HikariConfig config = new HikariConfig(props);\n+            listDataSource.add(new HikariDataSource(config));\n+        }\n+    }\n \n-    /**\n-     *\n-     * @return\n-     * @throws SQLException\n-     */\n-    public final Connection makeConnection() throws SQLException {\n-        java.util.Properties props = new java.util.Properties();\n-        props.put(\"user\", workConf.getDBUsername());\n-        props.put(\"password\", workConf.getDBPassword());\n-        props.put(\"reWriteBatchedInserts\", \"true\");\n-\n-        List<String> dbConnections = workConf.getDBConnections();\n-        int r = (int)TPCCUtil.randomNumber(0, dbConnections.size() - 1, rng);\n-        Connection conn = DriverManager.getConnection(dbConnections.get(r), props);\n-        Catalog.setSeparator(conn);\n-        return (conn);\n+    private static AtomicInteger dataSourceCounter = new AtomicInteger(0);\n+    public final HikariDataSource getDataSource() {\n+        int r =  dataSourceCounter.getAndIncrement() % workConf.getNodes().size();", "originalCommit": "593c92326cccbf74baa84c2344c096c47541c843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0NTMxMg==", "url": "https://github.com/yugabyte/tpcc/pull/25#discussion_r439245312", "bodyText": "Done", "author": "psudheer21", "createdAt": "2020-06-12T07:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMzY2OA=="}], "type": "inlineReview"}, {"oid": "c6af2378b505889c9f0c281267627b7a46d70c5d", "url": "https://github.com/yugabyte/tpcc/commit/c6af2378b505889c9f0c281267627b7a46d70c5d", "message": "Reformat code", "committedDate": "2020-06-12T07:07:09Z", "type": "commit"}, {"oid": "c6af2378b505889c9f0c281267627b7a46d70c5d", "url": "https://github.com/yugabyte/tpcc/commit/c6af2378b505889c9f0c281267627b7a46d70c5d", "message": "Reformat code", "committedDate": "2020-06-12T07:07:09Z", "type": "forcePushed"}]}