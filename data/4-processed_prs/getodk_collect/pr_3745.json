{"pr_number": 3745, "pr_title": "Support calculations in field-lists", "pr_createdAt": "2020-03-25T10:43:55Z", "pr_url": "https://github.com/getodk/collect/pull/3745", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkwNTg1OA==", "url": "https://github.com/getodk/collect/pull/3745#discussion_r398905858", "bodyText": "I think it's ok to overload saveAnswersForCurrentScreen instead of having a long name. You could add a comment to differentiate them.", "author": "lognaturel", "createdAt": "2020-03-26T21:32:47Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2888,6 +2886,34 @@ private void updateFieldListQuestions(FormIndex lastChangedIndex) {\n         }\n     }\n \n+    private void saveAnswersForCurrentScreenOneByOneToSupportCalculations(FormEntryPrompt[] mutableQuestionsBeforeSave, List<ImmutableDisplayableQuestion> immutableQuestionsBeforeSave) {", "originalCommit": "4f43493be2111775ed8a5ab50fbc93186ee80c9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzOTg2MA==", "url": "https://github.com/getodk/collect/pull/3745#discussion_r399139860", "bodyText": "Fixed.", "author": "grzesiek2010", "createdAt": "2020-03-27T09:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkwNTg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNzU4OQ==", "url": "https://github.com/getodk/collect/pull/3745#discussion_r398917589", "bodyText": "I have a hard time with the negative in the method name. In fact, you could just use !Objects.equals here, right? I think that would make things easier to understand. Then you could have a comment above the condition that says something like questions with calculates will have their answers updated as the questions they depend on are saved.", "author": "lognaturel", "createdAt": "2020-03-26T21:58:14Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2888,6 +2886,34 @@ private void updateFieldListQuestions(FormIndex lastChangedIndex) {\n         }\n     }\n \n+    private void saveAnswersForCurrentScreenOneByOneToSupportCalculations(FormEntryPrompt[] mutableQuestionsBeforeSave, List<ImmutableDisplayableQuestion> immutableQuestionsBeforeSave) {\n+        FormController formController = getFormController();\n+        ODKView currentView = getCurrentViewIfODKView();\n+        if (formController == null || currentView == null) {\n+            return;\n+        }\n+\n+        int index = 0;\n+        for (Map.Entry<FormIndex, IAnswerData> answer : currentView.getAnswers().entrySet()) {\n+            if (isQuestionNotRecalculated(mutableQuestionsBeforeSave[index], immutableQuestionsBeforeSave.get(index))) {", "originalCommit": "4f43493be2111775ed8a5ab50fbc93186ee80c9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzOTkyMw==", "url": "https://github.com/getodk/collect/pull/3745#discussion_r399139923", "bodyText": "Fixed.", "author": "grzesiek2010", "createdAt": "2020-03-27T09:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNzU4OQ=="}], "type": "inlineReview"}, {"oid": "123e4f3c683851532fc1301d243bcd24c63dc004", "url": "https://github.com/getodk/collect/commit/123e4f3c683851532fc1301d243bcd24c63dc004", "message": "Code improvements", "committedDate": "2020-03-27T09:45:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NTY2NA==", "url": "https://github.com/getodk/collect/pull/3745#discussion_r399555664", "bodyText": "This is exactly what Objects.equals does, right? I was suggesting not even introducing a custom method. I don't feel strongly about it, though, if you like this better.", "author": "lognaturel", "createdAt": "2020-03-27T21:53:51Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2888,6 +2908,12 @@ private void updateFieldListQuestions(FormIndex lastChangedIndex) {\n         }\n     }\n \n+    // If an answer has changed after saving one of previous answers that means it has been recalculated automatically\n+    private boolean isQuestionRecalculated(FormEntryPrompt mutableQuestionBeforeSave, ImmutableDisplayableQuestion immutableQuestionBeforeSave) {\n+        return !(mutableQuestionBeforeSave.getAnswerText() == null && immutableQuestionBeforeSave.getAnswerText() == null", "originalCommit": "123e4f3c683851532fc1301d243bcd24c63dc004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab75e280521535cc5f5c3d14025968a592a8f4de", "url": "https://github.com/getodk/collect/commit/ab75e280521535cc5f5c3d14025968a592a8f4de", "message": "Support calculations in field-lists", "committedDate": "2020-04-03T14:56:11Z", "type": "commit"}, {"oid": "fbab0a13fc6cfe43de39320ffb73267aa59292aa", "url": "https://github.com/getodk/collect/commit/fbab0a13fc6cfe43de39320ffb73267aa59292aa", "message": "Fixed the commented test", "committedDate": "2020-04-03T14:56:11Z", "type": "commit"}, {"oid": "bea21dd363f79b95c5e7f96f856f6e09072108e0", "url": "https://github.com/getodk/collect/commit/bea21dd363f79b95c5e7f96f856f6e09072108e0", "message": "Code improvements", "committedDate": "2020-04-03T14:56:11Z", "type": "commit"}, {"oid": "085777f5fdf10c0a9bac2f8cfb79cb848e6fd259", "url": "https://github.com/getodk/collect/commit/085777f5fdf10c0a9bac2f8cfb79cb848e6fd259", "message": "Code improvements", "committedDate": "2020-04-03T14:56:11Z", "type": "commit"}, {"oid": "085777f5fdf10c0a9bac2f8cfb79cb848e6fd259", "url": "https://github.com/getodk/collect/commit/085777f5fdf10c0a9bac2f8cfb79cb848e6fd259", "message": "Code improvements", "committedDate": "2020-04-03T14:56:11Z", "type": "forcePushed"}]}