{"pr_number": 3992, "pr_title": "Allow forms to be edited after blank form deletion", "pr_createdAt": "2020-07-29T11:54:28Z", "pr_url": "https://github.com/getodk/collect/pull/3992", "timeline": [{"oid": "2bf4c423197e82b3a045a3b5f37e724d02c26785", "url": "https://github.com/getodk/collect/commit/2bf4c423197e82b3a045a3b5f37e724d02c26785", "message": "Remove debugging code", "committedDate": "2020-07-29T13:08:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTE0NA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462741144", "bodyText": "Oops, I already merged Saumia's change for this. Probably should have assigned it to you in the first place.", "author": "lognaturel", "createdAt": "2020-07-30T05:19:06Z", "path": "collect_app/src/main/res/xml/form_management_preferences.xml", "diffHunk": "@@ -14,7 +14,8 @@\n             android:entries=\"@array/form_update_mode_entries\"\n             android:entryValues=\"@array/form_update_mode_values\"\n             android:key=\"form_update_mode\"\n-            android:title=\"@string/form_update_mode_title\" />\n+            android:title=\"@string/form_update_mode_title\"\n+            app:iconSpaceReserved=\"false\" />", "originalCommit": "e0dceabf39e0714da5eb077b043b9973c3721427", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2MjAxMw==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462862013", "bodyText": "No worries!", "author": "seadowg", "createdAt": "2020-07-30T09:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTU4OQ==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462741589", "bodyText": "I don't understand this.", "author": "lognaturel", "createdAt": "2020-07-30T05:20:41Z", "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationResult.java", "diffHunk": "@@ -6,19 +6,16 @@\n \n public enum StorageMigrationResult {\n     SUCCESS,\n-    FORM_UPLOADER_IS_RUNNING,\n-    FORM_DOWNLOADER_IS_RUNNING,\n     NOT_ENOUGH_SPACE,\n-    MOVING_FILES_FAILED;\n+    MOVING_FILES_FAILED,\n+    CHANGES_IN_PROGRESS;\n \n     public String getErrorResultMessage(Context context) {\n         String errorMessage = context.getString(R.string.error) + \" \";\n         switch (this) {\n             case NOT_ENOUGH_SPACE:\n                 return errorMessage + context.getString(R.string.storage_migration_not_enough_space);\n-            case FORM_UPLOADER_IS_RUNNING:", "originalCommit": "04a674efceaef3c833bba5838213a426eebabc79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2MzY5Mg==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462863692", "bodyText": "With the change lock we don't know which background service is running, but we know we shouldn't start the migration. I figured given these cases were rare it'd be ok to combine them into one error message?\nThe message should definitely change though. How about \"Automatic jobs are running. Please try again later.\"?", "author": "seadowg", "createdAt": "2020-07-30T09:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NjQ4Mw==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463146483", "bodyText": "Whoops, this was a note to self I meant to come back to! But luckily you knew why I was confused.\nOk, I agree a single message is sufficient. I don't think that users know what \"jobs\" means in that context. How about \"Automatic send or blank form download is running. Please try again later.\" You'll also need to change the resource name.", "author": "lognaturel", "createdAt": "2020-07-30T17:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MzU0MA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462743540", "bodyText": "Ah, I see. Given this, I'll merge #3986 so you can clear out those commits here and not deal with merge conflicts.", "author": "lognaturel", "createdAt": "2020-07-30T05:27:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/notifications/NotificationManagerNotifier.java", "diffHunk": "@@ -84,11 +84,10 @@ public void onUpdatesDownloaded(HashMap<ServerFormDetails, String> result) {\n     @Override\n     public void onSyncFailure(FormApiException exception) {\n         Intent intent = new Intent(application, FillBlankFormActivity.class);\n-        intent.putExtra(FillBlankFormActivity.EXTRA_AUTH_REQUIRED, true);\n \n-//        if (exception.getType() == FormApiException.Type.AUTH_REQUIRED) {\n-//\n-//        }\n+        if (exception.getType() == FormApiException.Type.AUTH_REQUIRED) {", "originalCommit": "2bf4c423197e82b3a045a3b5f37e724d02c26785", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3336a79c491d9653805c7aa4e54726045cae975d", "url": "https://github.com/getodk/collect/commit/3336a79c491d9653805c7aa4e54726045cae975d", "message": "Delete soft deleted forms when last instance deleted", "committedDate": "2020-07-29T13:08:22Z", "type": "forcePushed"}, {"oid": "92ea62158bbd65ebb95e2146521b5f8f3ef49bd1", "url": "https://github.com/getodk/collect/commit/92ea62158bbd65ebb95e2146521b5f8f3ef49bd1", "message": "Delete soft deleted forms when last instance deleted", "committedDate": "2020-07-30T09:17:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NjM1Mg==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463096352", "bodyText": "whenThereFillForms? When there are filled forms?", "author": "lognaturel", "createdAt": "2020-07-30T15:50:07Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formmanagement/DeleteBlankFormTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.odk.collect.android.feature.formmanagement;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.TestRuleChain;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeleteBlankFormTest {\n+\n+    public final CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public final RuleChain chain = TestRuleChain.chain()\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void deletingAForm_removesFormFromBlankFormList() {\n+        rule.mainMenu()\n+                .clickDeleteSavedForm()\n+                .clickBlankForms()\n+                .clickForm(\"One Question\")\n+                .clickDeleteSelected(1)\n+                .clickDeleteForms()\n+                .pressBack(new MainMenuPage(rule))\n+                .clickFillBlankForm()\n+                .assertTextDoesNotExist(\"One Question\");\n+    }\n+\n+    @Test\n+    public void deletingAForm_whenThereFillForms_allowsEditing() {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4Mzk3NQ==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463483975", "bodyText": "Good catch", "author": "seadowg", "createdAt": "2020-07-31T08:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzI5MQ==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463097291", "bodyText": "this should be filled form list?", "author": "lognaturel", "createdAt": "2020-07-30T15:51:27Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/instancemanagement/DeleteFilledFormTest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.odk.collect.android.feature.instancemanagement;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.TestRuleChain;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeleteFilledFormTest {\n+\n+    public final CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public final RuleChain chain = TestRuleChain.chain()\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void deletingAForm_removesFormFromBlankFormList() {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4NjI4MQ==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463486281", "bodyText": "Again nice. Catch I think I was too focused on getting ...FormFrom... right in these cases haha", "author": "seadowg", "createdAt": "2020-07-31T08:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwMTkxOA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463101918", "bodyText": "We should introduce an alias for this. I guess I only put in aliases for activities with intent-filters but it's entirely possible applications would use explicit intents.", "author": "lognaturel", "createdAt": "2020-07-30T15:57:59Z", "path": "collect_app/src/main/AndroidManifest.xml", "diffHunk": "@@ -116,7 +116,7 @@ the specific language governing permissions and limitations under the License.\n         <activity android:name=\".activities.FillBlankFormActivity\" />\n         <activity android:name=\".activities.FormDownloadListActivity\" />\n         <activity\n-            android:name=\".activities.FileManagerTabs\"\n+            android:name=\".activities.DeleteSavedFormActivity\"", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMjc3NA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463502774", "bodyText": "As far as I can see where ok as the Activity isn't exported. I checked the docs to remind myself but the default is false (docs here) so other apps shouldn't be able to launch this.", "author": "seadowg", "createdAt": "2020-07-31T09:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwMTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzNDgzNw==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463634837", "bodyText": "Ohhhh, yes. I convinced myself it was true by default but should just have looked it up.", "author": "lognaturel", "createdAt": "2020-07-31T14:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwMTkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwOTMwOA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463109308", "bodyText": "Just use getAllByJrFormIdAndJrVersion?", "author": "lognaturel", "createdAt": "2020-07-30T16:09:18Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/FormDeleter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.forms.FormsRepository;\n+import org.odk.collect.android.instances.Instance;\n+import org.odk.collect.android.instances.InstancesRepository;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class FormDeleter {\n+\n+    private final FormsRepository formsRepository;\n+    private final InstancesRepository instancesRepository;\n+\n+    public FormDeleter(FormsRepository formsRepository, InstancesRepository instancesRepository) {\n+        this.formsRepository = formsRepository;\n+        this.instancesRepository = instancesRepository;\n+    }\n+\n+    public void delete(Long id) {\n+        Form form = formsRepository.get(id);\n+        List<Instance> instances = instancesRepository.getAllByJrFormId(form.getJrFormId());\n+        long instancesForVersion = instances.stream().filter(instance -> Objects.equals(instance.getJrVersion(), form.getJrVersion())).count();", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNjEzMg==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463126132", "bodyText": "Why not use getFormsCursor(String formId, String formVersion)? I think you may need some @NonNull annotations if you just do this.", "author": "lognaturel", "createdAt": "2020-07-30T16:36:10Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormsRepository.java", "diffHunk": "@@ -34,6 +37,22 @@ public boolean contains(String jrFormId) {\n         }\n     }\n \n+    @Nullable\n+    @Override\n+    public Form get(Long id) {\n+        try (Cursor cursor = new FormsDao().getFormsCursor(_ID + \"=?\", new String[]{id.toString()})) {\n+            return getFormOrNull(cursor);\n+        }\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Form get(String jrFormId, String jrVersion) {\n+        try (Cursor cursor = new FormsDao().getFormsCursor(JR_FORM_ID + \"=? AND \" + JR_VERSION + \"=?\", new String[]{jrFormId, jrVersion})) {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5OTQzOA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463499438", "bodyText": "Totally missed this was a thing. On one hand it feels like it might make sense to start reducing the number of methods on FormsDao and just write queries as much as possible in our new repos. I'll see how used the getFormsCursor(String formId, String formVersion) is and think about inlining it.", "author": "seadowg", "createdAt": "2020-07-31T09:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNjEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMDM4OA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463500388", "bodyText": "Actually going to avoid that method as it adds sorting in which we don't need here.", "author": "seadowg", "createdAt": "2020-07-31T09:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNjEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyODA3NA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463128074", "bodyText": "These names are really reprehensible. Maybe another thing to note for v1.29 cleanup is going further down the line of the DeleteSavedFormActivity rename.", "author": "lognaturel", "createdAt": "2020-07-30T16:39:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/DataManagerList.java", "diffHunk": "@@ -56,8 +62,16 @@\n     private InstanceSyncTask instanceSyncTask;\n     private ProgressDialog progressDialog;\n \n-    public static DataManagerList newInstance() {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMTU1Nw==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463501557", "bodyText": "Agreed!", "author": "seadowg", "createdAt": "2020-07-31T09:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyODA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMjIwOQ==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463132209", "bodyText": "Why not use constructor params? Seems catastrophic to not call this so why even make it possible?", "author": "lognaturel", "createdAt": "2020-07-30T16:46:09Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DeleteInstancesTask.java", "diffHunk": "@@ -100,8 +97,9 @@ public void setDeleteListener(DeleteInstancesListener listener) {\n         deleteInstancesListener = listener;\n     }\n \n-    public void setContentResolver(ContentResolver resolver) {\n-        contentResolver = resolver;\n+    public void setRepositories(InstancesRepository instancesRepository, FormsRepository formsRepository) {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NDkzMA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463144930", "bodyText": "Typo?", "author": "lognaturel", "createdAt": "2020-07-30T17:07:19Z", "path": "collect_app/src/main/res/layout/main_menu.xml", "diffHunk": "@@ -102,7 +102,7 @@\n                         android:layout_width=\"match_parent\"\n                         android:layout_height=\"wrap_content\"\n                         android:layout_marginTop=\"@dimen/margin_extra_small\"\n-                        tools:text=\"@string/manage_files\" />", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4NjgzNA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463486834", "bodyText": "Oh whoops. Yup.", "author": "seadowg", "createdAt": "2020-07-31T08:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NDkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODAyMA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463148020", "bodyText": "Why not use parameter args to guarantee these are set? This seems dangerous.", "author": "lognaturel", "createdAt": "2020-07-30T17:13:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DeleteFormsTask.java", "diffHunk": "@@ -96,15 +95,16 @@ public void setDeleteListener(DeleteFormsListener listener) {\n         dl = listener;\n     }\n \n-    public void setContentResolver(ContentResolver resolver) {\n-        cr = resolver;\n-    }\n-\n     public int getDeleteCount() {\n         return successCount;\n     }\n \n     public int getToDeleteCount() {\n         return toDeleteCount;\n     }\n+\n+    public void setRepositories(FormsRepository formsRepository, InstancesRepository instancesRepository) {", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4OTg3Mg==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463489872", "bodyText": "I was following the original structure which used setters to get the dependencies in. You're right though that we should improve on that while we're here!", "author": "seadowg", "createdAt": "2020-07-31T08:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0OTQxOA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463149418", "bodyText": "Previously, all of the data in the forms table could be recreated from a form definition except for the last detected hash. Now delete adds more state that can't be recreated. Still, the consequences of \"undeleting\" forms on downgrade are not very dire and we don't expect downgrade to be common so let's stick with this and not worry about it. (This is just a note to make the decision explicit to our future selves)", "author": "lognaturel", "createdAt": "2020-07-30T17:15:32Z", "path": "collect_app/src/main/java/org/odk/collect/android/database/helpers/FormsDatabaseHelper.java", "diffHunk": "@@ -125,7 +128,7 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n     public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n         try {\n             SQLiteUtils.dropTable(db, FORMS_TABLE_NAME);\n-            createFormsTableV8(db);\n+            createFormsTableV9(db);", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NTk5Mg==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463155992", "bodyText": "I can't imagine how it would happen but technically this could throw a IllegalMonitorStateException. Maybe catch and ignore out of an abundance of caution?", "author": "lognaturel", "createdAt": "2020-07-30T17:26:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/ReentrantLockChangeLock.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.function.Function;\n+\n+public class ReentrantLockChangeLock implements ChangeLock {\n+\n+    private final ReentrantLock lock = new ReentrantLock();\n+\n+    @Override\n+    public <T> T withLock(Function<Boolean, T> function) {\n+        try {\n+            return function.apply(lock.tryLock());\n+        } finally {\n+            lock.unlock();", "originalCommit": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4Nzg2MA==", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463487860", "bodyText": "Yeah I missed that in the docs. Thanks for pointing it out. Will add that in.", "author": "seadowg", "createdAt": "2020-07-31T08:51:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NTk5Mg=="}], "type": "inlineReview"}, {"oid": "a037c8ed50c76efbe4e3cfbcbc73418907dc1413", "url": "https://github.com/getodk/collect/commit/a037c8ed50c76efbe4e3cfbcbc73418907dc1413", "message": "Add change lock to prevent background jobs or migrations running at the same time", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "9b526a9f9f2a7f35cb54d54e376d0526e24ab3c8", "url": "https://github.com/getodk/collect/commit/9b526a9f9f2a7f35cb54d54e376d0526e24ab3c8", "message": "Add test for deleting form", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "0292900ce807fe660f960189abaa1ad6e719e2d9", "url": "https://github.com/getodk/collect/commit/0292900ce807fe660f960189abaa1ad6e719e2d9", "message": "Only soft delete forms that still have instances on device", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "36a3b7e5cda26f098959bfacf20713bf4c043df3", "url": "https://github.com/getodk/collect/commit/36a3b7e5cda26f098959bfacf20713bf4c043df3", "message": "Only soft delete forms that have unsubmitted instances", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "9afdcf7f06cf18169498c61ed7f752e87fe23df3", "url": "https://github.com/getodk/collect/commit/9afdcf7f06cf18169498c61ed7f752e87fe23df3", "message": "Make sure form soft delete is aware of form versions", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "0940ea935c5b3c6b590d56329c17755f67467ff6", "url": "https://github.com/getodk/collect/commit/0940ea935c5b3c6b590d56329c17755f67467ff6", "message": "Handle null version cases for deleting forms", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "1ed87471cfbc3d673f465d2fb5eafbdfbda53551", "url": "https://github.com/getodk/collect/commit/1ed87471cfbc3d673f465d2fb5eafbdfbda53551", "message": "Use FormDeleter in match exactly sync", "committedDate": "2020-07-31T10:43:55Z", "type": "commit"}, {"oid": "dd6a6c3938ee340a66c5784a508feb4642c05448", "url": "https://github.com/getodk/collect/commit/dd6a6c3938ee340a66c5784a508feb4642c05448", "message": "Revise locks so that auto send can run at the same time as auto update and match exactly", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "ab565f2435b159430ebbe5f1a7f9342f5efc3fd6", "url": "https://github.com/getodk/collect/commit/ab565f2435b159430ebbe5f1a7f9342f5efc3fd6", "message": "Allow viewing delete form's instances", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "5773d701643e9b80fcede5d4fd66edc75eb4e46f", "url": "https://github.com/getodk/collect/commit/5773d701643e9b80fcede5d4fd66edc75eb4e46f", "message": "Add tests for deleting instances", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "766afa976b8e4a506eb0bb4613bc340509028ee7", "url": "https://github.com/getodk/collect/commit/766afa976b8e4a506eb0bb4613bc340509028ee7", "message": "Delete soft deleted forms when last instance deleted", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "7033c9213bf13647acb72f11a8571bae066dac70", "url": "https://github.com/getodk/collect/commit/7033c9213bf13647acb72f11a8571bae066dac70", "message": "Hide experimental prefs in release version", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "eea1de87cb32d9540633ee19a878df1f471c4fcc", "url": "https://github.com/getodk/collect/commit/eea1de87cb32d9540633ee19a878df1f471c4fcc", "message": "Correct typos", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "52d5602dc678c96c33a21d64572f5f5797b31449", "url": "https://github.com/getodk/collect/commit/52d5602dc678c96c33a21d64572f5f5797b31449", "message": "Ignore run time exception coming out of unlock()", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "fff1a549eabf565ebc0cea18661c50c0c86d5a43", "url": "https://github.com/getodk/collect/commit/fff1a549eabf565ebc0cea18661c50c0c86d5a43", "message": "Move repos to constructor args in tasks", "committedDate": "2020-07-31T10:43:56Z", "type": "commit"}, {"oid": "293fe813bfe76ef6bb04741bb2d4250859bae833", "url": "https://github.com/getodk/collect/commit/293fe813bfe76ef6bb04741bb2d4250859bae833", "message": "Optimize FormDeleter", "committedDate": "2020-07-31T10:43:57Z", "type": "commit"}, {"oid": "31dab95a631c3386560418a69f9718c3cf7d2b3d", "url": "https://github.com/getodk/collect/commit/31dab95a631c3386560418a69f9718c3cf7d2b3d", "message": "Bubble sorting up to method name", "committedDate": "2020-07-31T10:43:57Z", "type": "commit"}, {"oid": "aaf1b2e3a89d8d7076144263b58c31fd3f5367b9", "url": "https://github.com/getodk/collect/commit/aaf1b2e3a89d8d7076144263b58c31fd3f5367b9", "message": "Update background job error message", "committedDate": "2020-07-31T10:43:57Z", "type": "commit"}, {"oid": "c8fd43d04d021733f64c883374c2c0beb4bb9e22", "url": "https://github.com/getodk/collect/commit/c8fd43d04d021733f64c883374c2c0beb4bb9e22", "message": "Update test", "committedDate": "2020-07-31T10:43:57Z", "type": "commit"}, {"oid": "c8fd43d04d021733f64c883374c2c0beb4bb9e22", "url": "https://github.com/getodk/collect/commit/c8fd43d04d021733f64c883374c2c0beb4bb9e22", "message": "Update test", "committedDate": "2020-07-31T10:43:57Z", "type": "forcePushed"}, {"oid": "307925a6c1af38192ac6241afabe2374262c13d7", "url": "https://github.com/getodk/collect/commit/307925a6c1af38192ac6241afabe2374262c13d7", "message": "Allow null versions when querying instances", "committedDate": "2020-07-31T11:14:00Z", "type": "commit"}]}