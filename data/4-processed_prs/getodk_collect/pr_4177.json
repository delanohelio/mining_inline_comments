{"pr_number": 4177, "pr_title": "3780 restore exif data after rotate or resize", "pr_createdAt": "2020-10-20T11:31:57Z", "pr_url": "https://github.com/getodk/collect/pull/4177", "timeline": [{"oid": "a887bd99d895b55d22632a6b0990b98836bfe047", "url": "https://github.com/getodk/collect/commit/a887bd99d895b55d22632a6b0990b98836bfe047", "message": "issue #3780. Restore exif data after rotate or resize", "committedDate": "2020-10-20T11:08:08Z", "type": "commit"}, {"oid": "b9a63588fa40afb0703637dba76572426212346c", "url": "https://github.com/getodk/collect/commit/b9a63588fa40afb0703637dba76572426212346c", "message": "issue #3780. Add function comments", "committedDate": "2020-10-20T11:19:46Z", "type": "commit"}, {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828", "url": "https://github.com/getodk/collect/commit/7de0e3340344aeec4e9ba0bb06f66c2084e70828", "message": "issue_#3780. Restore Exif data after rotation and resizing", "committedDate": "2020-10-26T02:35:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMjM4Ng==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512522386", "bodyText": "This might cause NPE. Please add a null check here.", "author": "grzesiek2010", "createdAt": "2020-10-27T09:09:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {\n+        ExifInterface exif = null;\n+        try {\n+            exif = new ExifInterface(imagePath);\n+        } catch (IOException e) {\n+            Timber.w(e);\n+        }\n+\n         rotateImageIfNeeded(imagePath);\n         scaleDownImageIfNeeded(imagePath, questionWidget, context);\n+        \n+        try {\n+            exif.saveAttributes();", "originalCommit": "7de0e3340344aeec4e9ba0bb06f66c2084e70828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyOTExMA==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512529110", "bodyText": "Thank you, @grzesiek2010 ,\nI have updated the code to avoid NPE as you suggested.\nPlease kindly review", "author": "ItloMd9", "createdAt": "2020-10-27T09:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMjM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMzA1OQ==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512523059", "bodyText": "Should be: stored/restored (d missing).", "author": "grzesiek2010", "createdAt": "2020-10-27T09:10:33Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.", "originalCommit": "7de0e3340344aeec4e9ba0bb06f66c2084e70828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyOTM0Mw==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512529343", "bodyText": "Comment has been updated, please kindly review", "author": "ItloMd9", "createdAt": "2020-10-27T09:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMzA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyNDUzNA==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512524534", "bodyText": "Could this maybe align with how you named it in the comment above (store/restore)? I mean this could be in a separate method called storeExifAttributes() and the code below also could be in a separate method called restoreExifAttributes() then the code would be cleaner.", "author": "grzesiek2010", "createdAt": "2020-10-27T09:12:55Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {\n+        ExifInterface exif = null;", "originalCommit": "7de0e3340344aeec4e9ba0bb06f66c2084e70828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUzMjUwMw==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512532503", "bodyText": "For simplicity's sake, I would avoid extra unnecessary methods/functions' overhead which (in this case) only fetch exif from an image path via constructor and then save it back via built-in function (saveAttributes) to the same old path.", "author": "ItloMd9", "createdAt": "2020-10-27T09:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyNDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MjA3NQ==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514262075", "bodyText": "generally i like more my approach but I'm not going to insist let's keep it as is.", "author": "grzesiek2010", "createdAt": "2020-10-29T13:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyNDUzNA=="}], "type": "inlineReview"}, {"oid": "4bd30f527f12705e869e0056ed33208b8692345f", "url": "https://github.com/getodk/collect/commit/4bd30f527f12705e869e0056ed33208b8692345f", "message": "issue #3780 Update per peer review", "committedDate": "2020-10-27T09:17:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0MDM0NQ==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512540345", "bodyText": "Would you like to add a test? It should be straightforward because we have this function in ImageConverterTest:\n    private void saveTestBitmap(int width, int height, Integer orientation) {\n        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.RGB_565);\n        FileUtils.saveBitmapToFile(bitmap, TEST_IMAGE_PATH);\n\n        if (orientation != null) {\n            try {\n                ExifInterface exifInterface = new ExifInterface(TEST_IMAGE_PATH);\n                exifInterface.setAttribute(ExifInterface.TAG_ORIENTATION, String.valueOf(orientation));\n                exifInterface.saveAttributes();\n            } catch (IOException e) {\n                Timber.w(e);\n            }\n        }\n    }\n\nwhich we use for testing ImageConverter.", "author": "grzesiek2010", "createdAt": "2020-10-27T09:37:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,28 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is stored/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {", "originalCommit": "4bd30f527f12705e869e0056ed33208b8692345f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwMzc1MA==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512603750", "bodyText": "I have added 1 test to check if exif data is removed after ImageConvert.execute() is invoked.\nPlease kindly review.", "author": "ItloMd9", "createdAt": "2020-10-27T11:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0MDM0NQ=="}], "type": "inlineReview"}, {"oid": "905637b5eb84dec9bc92f13a1e6d4ba18511c216", "url": "https://github.com/getodk/collect/commit/905637b5eb84dec9bc92f13a1e6d4ba18511c216", "message": "issue #3780. Add test case", "committedDate": "2020-10-27T11:03:07Z", "type": "commit"}, {"oid": "a232cffca15e2e35815adc0c4f67b07672f67d6c", "url": "https://github.com/getodk/collect/commit/a232cffca15e2e35815adc0c4f67b07672f67d6c", "message": "issue #3780. Update checking code", "committedDate": "2020-10-27T11:54:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIxODg3NQ==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514218875", "bodyText": "Does this test work for you locally? I tried on various android versions and the result is:\njunit.framework.ComparisonFailure: expected:<ApertureValue_value> but was:<null>\nat junit.framework.Assert.assertEquals(Assert.java:85)\nat junit.framework.Assert.assertEquals(Assert.java:91)\nat org.odk.collect.android.instrumented.utilities.ImageConverterTest.keepExifTest1AfterScaleAndRotation(ImageConverterTest.java:426)\nat java.lang.reflect.Method.invoke(Native Method)\nat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\nat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\nat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\nat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\nat androidx.test.internal.runner.junit4.statement.RunBefores.evaluate(RunBefores.java:80)\nat org.odk.collect.android.support.ResetStateRule$ResetStateStatement.evaluate(ResetStateRule.java:71)", "author": "grzesiek2010", "createdAt": "2020-10-29T12:27:16Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/instrumented/utilities/ImageConverterTest.java", "diffHunk": "@@ -382,6 +383,51 @@ public void scaleImageToNewWidthTest() {\n         assertEquals(1250, image.getHeight());\n     }\n \n+    @Test\n+    public void keepExifTest1AfterScaleAndRotation() {", "originalCommit": "a232cffca15e2e35815adc0c4f67b07672f67d6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIyOTQyNQ==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514229425", "bodyText": "Not only locally I ran it on firebase test lab and the result is the same.", "author": "grzesiek2010", "createdAt": "2020-10-29T12:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIxODg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI0MzYwNA==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514243604", "bodyText": "I'll take a look at it unless you are already fixing the test.", "author": "grzesiek2010", "createdAt": "2020-10-29T13:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIxODg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MDU1Nw==", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514260557", "bodyText": "Ok I pushed one commit to your branch with fixes.", "author": "grzesiek2010", "createdAt": "2020-10-29T13:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIxODg3NQ=="}], "type": "inlineReview"}, {"oid": "5ebd56257c095abc87d70f2e1d2c00cc16dfe728", "url": "https://github.com/getodk/collect/commit/5ebd56257c095abc87d70f2e1d2c00cc16dfe728", "message": "Fixed and improved tests", "committedDate": "2020-10-29T13:30:06Z", "type": "commit"}]}