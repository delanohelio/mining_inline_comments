{"pr_number": 4013, "pr_title": "Make sure Automatic Download downloads updates that have already been notifiied", "pr_createdAt": "2020-08-05T15:17:50Z", "pr_url": "https://github.com/getodk/collect/pull/4013", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxNjQwNA==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r465816404", "bodyText": "I wanted to pull this out so we could have an object that was easier to setup and work with than the SQLiteOpenHelper implementations that need DatabaseContext.", "author": "seadowg", "createdAt": "2020-08-05T15:34:46Z", "path": "collect_app/src/main/java/org/odk/collect/android/database/FormDatabaseMigrator.java", "diffHunk": "@@ -45,97 +24,51 @@\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_FORM_ID;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_VERSION;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.LANGUAGE;\n-import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.LAST_DETECTED_FORM_VERSION_HASH;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.MD5_HASH;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.SUBMISSION_URI;\n \n-/**\n- * This class helps open, create, and upgrade the database file.\n- */\n-public class FormsDatabaseHelper extends SQLiteOpenHelper {\n-    private static final String DATABASE_NAME = \"forms.db\";\n-    public static final String FORMS_TABLE_NAME = \"forms\";\n-\n-    public static final int DATABASE_VERSION = 9;\n+public class FormDatabaseMigrator {", "originalCommit": "c04b011c62fecf8405bae770af12001153eb967d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxNzg2MA==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r465817860", "bodyText": "This is the key change here: switch away from using the database to record the versions the user is notified about and also making it more of a UI's (the Notifier) concern.", "author": "seadowg", "createdAt": "2020-08-05T15:36:54Z", "path": "collect_app/src/main/java/org/odk/collect/android/notifications/NotificationManagerNotifier.java", "diffHunk": "@@ -35,18 +42,26 @@\n \n     private final Application application;\n     private final NotificationManager notificationManager;\n+    private final PreferencesProvider preferencesProvider;\n \n     private static final int FORM_UPDATE_NOTIFICATION_ID = 0;\n     private static final int FORM_SYNC_NOTIFICATION_ID = 1;\n     private static final int AUTO_SEND_RESULT_NOTIFICATION_ID = 1328974928;\n \n-    public NotificationManagerNotifier(Application application) {\n+    public NotificationManagerNotifier(Application application, PreferencesProvider preferencesProvider) {\n         this.application = application;\n         notificationManager = (NotificationManager) application.getSystemService(NOTIFICATION_SERVICE);\n+        this.preferencesProvider = preferencesProvider;\n     }\n \n     @Override\n-    public void onUpdatesAvailable() {\n+    public void onUpdatesAvailable(List<ServerFormDetails> updates) {\n+        SharedPreferences metaPrefs = preferencesProvider.getMetaSharedPreferences();", "originalCommit": "c04b011c62fecf8405bae770af12001153eb967d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxODY4Mg==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r465818682", "bodyText": "There were tests for the database helper checking migrations, but they were out of date and Ignored. Interested to know if people think we need more coverage here.", "author": "seadowg", "createdAt": "2020-08-05T15:38:03Z", "path": "collect_app/src/test/java/org/odk/collect/android/database/FormDatabaseMigratorTest.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package org.odk.collect.android.database;\n+\n+import android.content.ContentValues;\n+import android.database.Cursor;\n+import android.database.sqlite.SQLiteDatabase;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.odk.collect.android.database.DatabaseConstants.FORMS_TABLE_NAME;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.AUTO_DELETE;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.AUTO_SEND;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.BASE64_RSA_PUBLIC_KEY;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.DATE;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.DESCRIPTION;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.DISPLAY_NAME;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_FILE_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_MEDIA_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.GEOMETRY_XPATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JRCACHE_FILE_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_FORM_ID;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_VERSION;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.LANGUAGE;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.MD5_HASH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.SUBMISSION_URI;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns._ID;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class FormDatabaseMigratorTest {", "originalCommit": "c04b011c62fecf8405bae770af12001153eb967d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4MjgzMg==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r466082832", "bodyText": "I know you've been trying to kill those tests for a long time. \ud83d\ude02 They were added after we had several significant bugs related to onDowngrade. I think the structure and test are good but that it would be good to also downgrade from a fictitious high version with an extra and missing column to avoid regressions there. We can assume we wouldn't touch onDowngrade anymore but it's hard to reason about and tempting to try to improve.", "author": "lognaturel", "createdAt": "2020-08-06T00:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxODY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI4MjU2Ng==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r466282566", "bodyText": "haha yeah totally happy to add more. The old tests were failing and needed rewritten anyway. I'll add a couple of downgrade tests (one with extra and one with missing columns).", "author": "seadowg", "createdAt": "2020-08-06T09:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxODY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3OTg2Mw==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r466079863", "bodyText": "Move break down to allow upgrades from versions other than 8.", "author": "lognaturel", "createdAt": "2020-08-06T00:40:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/database/FormDatabaseMigrator.java", "diffHunk": "@@ -45,97 +24,51 @@\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_FORM_ID;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JR_VERSION;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.LANGUAGE;\n-import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.LAST_DETECTED_FORM_VERSION_HASH;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.MD5_HASH;\n import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.SUBMISSION_URI;\n \n-/**\n- * This class helps open, create, and upgrade the database file.\n- */\n-public class FormsDatabaseHelper extends SQLiteOpenHelper {\n-    private static final String DATABASE_NAME = \"forms.db\";\n-    public static final String FORMS_TABLE_NAME = \"forms\";\n-\n-    public static final int DATABASE_VERSION = 9;\n+public class FormDatabaseMigrator {\n \n     private static final String[] COLUMN_NAMES_V7 = {_ID, DISPLAY_NAME, DESCRIPTION,\n             JR_FORM_ID, JR_VERSION, MD5_HASH, DATE, FORM_MEDIA_PATH, FORM_FILE_PATH, LANGUAGE,\n             SUBMISSION_URI, BASE64_RSA_PUBLIC_KEY, JRCACHE_FILE_PATH, AUTO_SEND, AUTO_DELETE,\n-            LAST_DETECTED_FORM_VERSION_HASH};\n-\n-    private static final String[] COLUMN_NAMES_V9 = {_ID, DISPLAY_NAME, DESCRIPTION,\n-            JR_FORM_ID, JR_VERSION, MD5_HASH, DATE, FORM_MEDIA_PATH, FORM_FILE_PATH, LANGUAGE,\n-            SUBMISSION_URI, BASE64_RSA_PUBLIC_KEY, JRCACHE_FILE_PATH, AUTO_SEND, AUTO_DELETE,\n-            LAST_DETECTED_FORM_VERSION_HASH, DELETED};\n-\n-    public static final String[] CURRENT_VERSION_COLUMN_NAMES = COLUMN_NAMES_V9;\n+            \"lastDetectedFormVersionHash\"};\n \n     // These exist in database versions 2 and 3, but not in 4...\n     private static final String TEMP_FORMS_TABLE_NAME = \"forms_v4\";\n     private static final String MODEL_VERSION = \"modelVersion\";\n \n-    private static boolean isDatabaseBeingMigrated;\n-\n-    public FormsDatabaseHelper() {\n-        super(new DatabaseContext(new StoragePathProvider().getDirPath(StorageSubdirectory.METADATA)), DATABASE_NAME, null, DATABASE_VERSION);\n-    }\n-\n-    public static String getDatabasePath() {\n-        return new StoragePathProvider().getDirPath(StorageSubdirectory.METADATA) + File.separator + DATABASE_NAME;\n-    }\n-\n-    @Override\n     public void onCreate(SQLiteDatabase db) {\n         createFormsTableV9(db);\n     }\n \n     @SuppressWarnings({\"checkstyle:FallThrough\"})\n-    @Override\n-    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n-        try {\n-            Timber.i(\"Upgrading database from version %d to %d\", oldVersion, newVersion);\n-\n-            switch (oldVersion) {\n-                case 1:\n-                    upgradeToVersion2(db);\n-                case 2:\n-                case 3:\n-                    upgradeToVersion4(db, oldVersion);\n-                case 4:\n-                    upgradeToVersion5(db);\n-                case 5:\n-                    upgradeToVersion6(db);\n-                case 6:\n-                    upgradeToVersion7(db);\n-                case 7:\n-                    upgradeToVersion8(db);\n-                    break;\n-                case 8:\n-                    upgradeToVersion9(db);\n-                default:\n-                    Timber.i(\"Unknown version %s\", oldVersion);\n-            }\n-\n-            Timber.i(\"Upgrading database from version %d to %d completed with success.\", oldVersion, newVersion);\n-            isDatabaseBeingMigrated = false;\n-        } catch (SQLException e) {\n-            isDatabaseBeingMigrated = false;\n-            throw e;\n+    public void onUpgrade(SQLiteDatabase db, int oldVersion) throws SQLException {\n+        switch (oldVersion) {\n+            case 1:\n+                upgradeToVersion2(db);\n+            case 2:\n+            case 3:\n+                upgradeToVersion4(db, oldVersion);\n+            case 4:\n+                upgradeToVersion5(db);\n+            case 5:\n+                upgradeToVersion6(db);\n+            case 6:\n+                upgradeToVersion7(db);\n+            case 7:\n+                upgradeToVersion8(db);\n+                break;", "originalCommit": "c04b011c62fecf8405bae770af12001153eb967d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI4MzA3OQ==", "url": "https://github.com/getodk/collect/pull/4013#discussion_r466283079", "bodyText": "Oh damn. Yes. I might try and add some tests to drive this out.", "author": "seadowg", "createdAt": "2020-08-06T09:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3OTg2Mw=="}], "type": "inlineReview"}, {"oid": "13fbd81e51df760f9cac516c38f247cad8159288", "url": "https://github.com/getodk/collect/commit/13fbd81e51df760f9cac516c38f247cad8159288", "message": "Move database repo implementations to database package", "committedDate": "2020-08-06T16:51:27Z", "type": "forcePushed"}, {"oid": "68d9137b61f921edcb176fc25afc36c8dececbdf", "url": "https://github.com/getodk/collect/commit/68d9137b61f921edcb176fc25afc36c8dececbdf", "message": "Make sure form updates are downloaded during auto updated", "committedDate": "2020-08-12T09:50:27Z", "type": "commit"}, {"oid": "ca1c827ef93629d23eedb6089c8d09112e108011", "url": "https://github.com/getodk/collect/commit/ca1c827ef93629d23eedb6089c8d09112e108011", "message": "Make sure notifications for updates aren't sent twice", "committedDate": "2020-08-12T09:53:32Z", "type": "commit"}, {"oid": "888802a9e31e4e350227f914d3b8ef8713ae899e", "url": "https://github.com/getodk/collect/commit/888802a9e31e4e350227f914d3b8ef8713ae899e", "message": "Remove last detected version hash from form domain", "committedDate": "2020-08-12T09:53:34Z", "type": "commit"}, {"oid": "933b2fb797e7629cd76a0ff8193405e2da462e41", "url": "https://github.com/getodk/collect/commit/933b2fb797e7629cd76a0ff8193405e2da462e41", "message": "Move AutoSendTest to correct package", "committedDate": "2020-08-12T09:53:34Z", "type": "commit"}, {"oid": "cc80434a817c0074cde3e0e9770e613e3055f927", "url": "https://github.com/getodk/collect/commit/cc80434a817c0074cde3e0e9770e613e3055f927", "message": "Move form database migration code to its own class", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "7a2c33f959f0a596441e1a017b335c7a0ee943ee", "url": "https://github.com/getodk/collect/commit/7a2c33f959f0a596441e1a017b335c7a0ee943ee", "message": "Add test for current version migration", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "dff35413c515c8061975e0c76867d9c93b0ba8a7", "url": "https://github.com/getodk/collect/commit/dff35413c515c8061975e0c76867d9c93b0ba8a7", "message": "Remove last detected form version column", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "2615240af958d068d17ed0f933b8a203348c0796", "url": "https://github.com/getodk/collect/commit/2615240af958d068d17ed0f933b8a203348c0796", "message": "Move database helpers to top level of package", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "d126af47c356a2bd540ce798a873c913a3f4fd39", "url": "https://github.com/getodk/collect/commit/d126af47c356a2bd540ce798a873c913a3f4fd39", "message": "Add tests for onDowngrade in migrator", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "c000cabf5e4a1eef7f2166f2d1069e95b34aeb8d", "url": "https://github.com/getodk/collect/commit/c000cabf5e4a1eef7f2166f2d1069e95b34aeb8d", "message": "Make sure upgrade from 7 to 9 database works", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "ea429054369f7e5ea57825b60111d6359f728561", "url": "https://github.com/getodk/collect/commit/ea429054369f7e5ea57825b60111d6359f728561", "message": "Remove Timber logging\n\nGiven this was just an `i` it didn't feel like it had much value", "committedDate": "2020-08-12T09:53:35Z", "type": "commit"}, {"oid": "be32f342d067ed12779230d9135c9cab2ca5f817", "url": "https://github.com/getodk/collect/commit/be32f342d067ed12779230d9135c9cab2ca5f817", "message": "Optimize imports", "committedDate": "2020-08-12T09:53:36Z", "type": "commit"}, {"oid": "12faec2ef8618930fadcf5e03b29aa7ddae92318", "url": "https://github.com/getodk/collect/commit/12faec2ef8618930fadcf5e03b29aa7ddae92318", "message": "Move database repo implementations to database package", "committedDate": "2020-08-12T09:53:36Z", "type": "commit"}, {"oid": "66f33e1ad4e46057c37df23677851fbb1594e848", "url": "https://github.com/getodk/collect/commit/66f33e1ad4e46057c37df23677851fbb1594e848", "message": "Fix test compilation", "committedDate": "2020-08-12T09:55:25Z", "type": "commit"}, {"oid": "ddc2f013e513756ca91efe6b0285079425e6f69c", "url": "https://github.com/getodk/collect/commit/ddc2f013e513756ca91efe6b0285079425e6f69c", "message": "Make sure dbs are closed after test runs", "committedDate": "2020-08-12T09:55:27Z", "type": "commit"}, {"oid": "ddc2f013e513756ca91efe6b0285079425e6f69c", "url": "https://github.com/getodk/collect/commit/ddc2f013e513756ca91efe6b0285079425e6f69c", "message": "Make sure dbs are closed after test runs", "committedDate": "2020-08-12T09:55:27Z", "type": "forcePushed"}]}