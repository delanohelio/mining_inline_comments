{"pr_number": 4241, "pr_title": "Show recording duration and waveform", "pr_createdAt": "2020-11-24T14:01:24Z", "pr_url": "https://github.com/getodk/collect/pull/4241", "timeline": [{"oid": "dd1248051c363bcf9b3e7f7b9ed12fee205edefd", "url": "https://github.com/getodk/collect/commit/dd1248051c363bcf9b3e7f7b9ed12fee205edefd", "message": "Show recording duration in notification", "committedDate": "2020-12-01T10:22:36Z", "type": "commit"}, {"oid": "433476731ff8c8580c063c212ce866ac85061caa", "url": "https://github.com/getodk/collect/commit/433476731ff8c8580c063c212ce866ac85061caa", "message": "Move notification code out of service", "committedDate": "2020-12-01T10:22:41Z", "type": "commit"}, {"oid": "0f530ac4dab9416c8f1bb47f653149f718c29c85", "url": "https://github.com/getodk/collect/commit/0f530ac4dab9416c8f1bb47f653149f718c29c85", "message": "Hook up duration but no updates yet", "committedDate": "2020-12-01T10:22:42Z", "type": "commit"}, {"oid": "abdd668c17db4d604935f98ae0afd42a69f7be40", "url": "https://github.com/getodk/collect/commit/abdd668c17db4d604935f98ae0afd42a69f7be40", "message": "Update duration every second", "committedDate": "2020-12-01T10:22:42Z", "type": "commit"}, {"oid": "be8204151c78fda5195b784fa8272f08e696f0b3", "url": "https://github.com/getodk/collect/commit/be8204151c78fda5195b784fa8272f08e696f0b3", "message": "Move all foreground service logic into notification class", "committedDate": "2020-12-01T10:22:42Z", "type": "commit"}, {"oid": "198c07129bb951daa1613a07d4c13c182001b141", "url": "https://github.com/getodk/collect/commit/198c07129bb951daa1613a07d4c13c182001b141", "message": "Visual tweaks based on mockups", "committedDate": "2020-12-01T10:22:42Z", "type": "commit"}, {"oid": "81d75ebcb5406bf6078929526000561cd5cd22b6", "url": "https://github.com/getodk/collect/commit/81d75ebcb5406bf6078929526000561cd5cd22b6", "message": "Move LengthFormatter to strings module", "committedDate": "2020-12-01T10:22:42Z", "type": "commit"}, {"oid": "8cbc842d09927b71b201042a6fa438c7a8e9eaf6", "url": "https://github.com/getodk/collect/commit/8cbc842d09927b71b201042a6fa438c7a8e9eaf6", "message": "Add strings to Circle config", "committedDate": "2020-12-01T10:22:43Z", "type": "commit"}, {"oid": "248a12f42b9726f690eeec0b78fff269dccc1ec7", "url": "https://github.com/getodk/collect/commit/248a12f42b9726f690eeec0b78fff269dccc1ec7", "message": "Simplify audio recorder interface", "committedDate": "2020-12-01T10:22:43Z", "type": "commit"}, {"oid": "788a0b8a51395b9ff2972f38f3227a04687854c4", "url": "https://github.com/getodk/collect/commit/788a0b8a51395b9ff2972f38f3227a04687854c4", "message": "Fix test missing scrolling", "committedDate": "2020-12-01T10:22:43Z", "type": "commit"}, {"oid": "ef1f27d631288644fe027d2dcccde728a97de763", "url": "https://github.com/getodk/collect/commit/ef1f27d631288644fe027d2dcccde728a97de763", "message": "Make sure notification doesn't show after recoring stops", "committedDate": "2020-12-01T10:22:43Z", "type": "commit"}, {"oid": "c70687c21c17e687090e60173fd86faeede4dae6", "url": "https://github.com/getodk/collect/commit/c70687c21c17e687090e60173fd86faeede4dae6", "message": "Generalize in progress recording API for widget", "committedDate": "2020-12-01T10:22:43Z", "type": "commit"}, {"oid": "d1506a467342ad971741585b1086e7f21e4c76a2", "url": "https://github.com/getodk/collect/commit/d1506a467342ad971741585b1086e7f21e4c76a2", "message": "Add waveform to AudioWidget", "committedDate": "2020-12-01T10:24:48Z", "type": "commit"}, {"oid": "007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "url": "https://github.com/getodk/collect/commit/007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "message": "Wrap AudioRecordView to make it testable and protect AudioWidget from it", "committedDate": "2020-12-01T10:25:15Z", "type": "commit"}, {"oid": "007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "url": "https://github.com/getodk/collect/commit/007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "message": "Wrap AudioRecordView to make it testable and protect AudioWidget from it", "committedDate": "2020-12-01T10:25:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MTEwMQ==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533381101", "bodyText": "Now that we have a test file in strings we should really be running it on CI.", "author": "seadowg", "createdAt": "2020-12-01T12:46:03Z", "path": ".circleci/config.yml", "diffHunk": "@@ -57,6 +57,9 @@ jobs:\n       - run:\n           name: Run async unit tests\n           command: ./gradlew -PdisablePreDex --no-daemon --max-workers=2 async:testDebug\n+      - run:", "originalCommit": "007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MTcwNQ==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533381705", "bodyText": "We won't always need deferred tasks so thought I'd split the implementations. I think long term it might make sense to split the interfaces but lets see how it evolves.", "author": "seadowg", "createdAt": "2020-12-01T12:46:59Z", "path": "async/src/main/java/org/odk/collect/async/CoroutineScheduler.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.odk.collect.async\n+\n+import kotlinx.coroutines.CoroutineScope\n+import kotlinx.coroutines.delay\n+import kotlinx.coroutines.isActive\n+import kotlinx.coroutines.launch\n+import kotlinx.coroutines.withContext\n+import java.util.function.Consumer\n+import java.util.function.Supplier\n+import kotlin.coroutines.CoroutineContext\n+\n+open class CoroutineScheduler(private val foregroundContext: CoroutineContext, private val backgroundContext: CoroutineContext) : Scheduler {", "originalCommit": "007b6e1b96971c95c9fbd3b8769e17fb2a108ffe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "url": "https://github.com/getodk/collect/commit/71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "message": "Remove unused dependency", "committedDate": "2020-12-01T12:48:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MzQzNw==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533383437", "bodyText": "I think we're now in a better place with this abstraction. Adding time/amplitude helped it make more sense as it forced the key data exposed to be the current \"session\" details.", "author": "seadowg", "createdAt": "2020-12-01T12:50:02Z", "path": "audiorecorder/src/main/java/org/odk/collect/audiorecorder/recording/AudioRecorderViewModel.kt", "diffHunk": "@@ -7,12 +7,12 @@ import java.io.File\n \n /**\n  * Interface for a ViewModel that records audio. Can only record once session", "originalCommit": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4NDcwNQ==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533384705", "bodyText": "This was the simplest waveform library I could find that still looked supported. I think we may want to improve this in the future or add our own flair.", "author": "seadowg", "createdAt": "2020-12-01T12:52:14Z", "path": "collect_app/build.gradle", "diffHunk": "@@ -320,6 +320,8 @@ dependencies {\n     // Better \"Subjects\" for Rx:\n     implementation \"com.jakewharton.rxrelay2:rxrelay:2.1.1\"\n \n+    implementation 'com.github.Armen101:AudioRecordView:1.0.2'", "originalCommit": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5MjcwNg==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533792706", "bodyText": "I see a size increase of .2mb from 1.28.4 to this branch. Not sure how much is from this lib but either way it seems ok.", "author": "lognaturel", "createdAt": "2020-12-01T23:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4NDcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4NTE4NA==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533385184", "bodyText": "These tests were failing due to the audio widget getting slightly taller and it forcing other items in the test to be scrolled off screen.", "author": "seadowg", "createdAt": "2020-12-01T12:53:09Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formentry/IntentGroupTest.java", "diffHunk": "@@ -128,7 +128,7 @@ public void externalApp_ShouldPopulateFields() throws IOException {\n         resultIntent.setClipData(clipData);\n         resultIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);\n         intending(not(isInternal())).respondWith(new Instrumentation.ActivityResult(Activity.RESULT_OK, resultIntent));\n-        onView(withText(\"This is buttonText\")).perform(click());\n+        onView(withText(\"This is buttonText\")).perform(nestedScrollTo(), click());", "originalCommit": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4NjIyMg==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533386222", "bodyText": "Could totally see others disagreeing with moving this here. For me, it makes sense to have formatters etc live in strings but could see an argument that they should live in a separate utils module.", "author": "seadowg", "createdAt": "2020-12-01T12:55:04Z", "path": "strings/src/main/java/org/odk/collect/strings/format/LengthFormatter.kt", "diffHunk": "@@ -0,0 +1,18 @@\n+package org.odk.collect.strings.format\n+\n+import java.util.Locale\n+\n+private const val ONE_HOUR = 3600000\n+private const val ONE_MINUTE = 60000\n+private const val ONE_SECOND = 1000\n+\n+fun formatLength(milliseconds: Long): String {", "originalCommit": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5NjU0OQ==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533796549", "bodyText": "Seems fine to me.", "author": "lognaturel", "createdAt": "2020-12-01T23:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4NjIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4Njk5MA==", "url": "https://github.com/getodk/collect/pull/4241#discussion_r533386990", "bodyText": "For some of the tests this needed to be a bit more advanced so it now actually keeps scheduled tasks in queues/lists so it runs them in the correct order and can run repeated tasks.", "author": "seadowg", "createdAt": "2020-12-01T12:56:24Z", "path": "testshared/src/main/java/org/odk/collect/testshared/FakeScheduler.kt", "diffHunk": "@@ -3,58 +3,72 @@ package org.odk.collect.testshared\n import org.odk.collect.async.Cancellable\n import org.odk.collect.async.Scheduler\n import org.odk.collect.async.TaskSpec\n+import java.util.LinkedList\n import java.util.function.Consumer\n import java.util.function.Supplier\n \n class FakeScheduler : Scheduler {", "originalCommit": "71fc627b45b57b370e1f186bb1bef07d4d22d5c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "74dca6c456a25bdf4c23667cbd8602eddf9392df", "url": "https://github.com/getodk/collect/commit/74dca6c456a25bdf4c23667cbd8602eddf9392df", "message": "Tweak waveform", "committedDate": "2020-12-01T18:04:04Z", "type": "commit"}, {"oid": "90a78f5277f536e526ee69ae8089123e6911948f", "url": "https://github.com/getodk/collect/commit/90a78f5277f536e526ee69ae8089123e6911948f", "message": "Fix rotation for waveform", "committedDate": "2020-12-02T10:39:20Z", "type": "commit"}, {"oid": "90a78f5277f536e526ee69ae8089123e6911948f", "url": "https://github.com/getodk/collect/commit/90a78f5277f536e526ee69ae8089123e6911948f", "message": "Fix rotation for waveform", "committedDate": "2020-12-02T10:39:20Z", "type": "forcePushed"}]}