{"pr_number": 3839, "pr_title": "Used Dialog Fragment to create Remove Group Dialog", "pr_createdAt": "2020-05-17T14:34:26Z", "pr_url": "https://github.com/getodk/collect/pull/3839", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NTI5Nw==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r435545297", "bodyText": "This should be deleteRepeat because it does not apply to general groups.", "author": "lognaturel", "createdAt": "2020-06-04T20:58:54Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/repeats/DeleteRepeatDialogFragment.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.odk.collect.android.formentry.repeats;\n+\n+import android.app.Dialog;\n+import android.content.Context;\n+import android.content.DialogInterface;\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.appcompat.app.AlertDialog;\n+import androidx.fragment.app.DialogFragment;\n+\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.javarosawrapper.FormController;\n+\n+import static android.content.DialogInterface.BUTTON_NEGATIVE;\n+import static android.content.DialogInterface.BUTTON_POSITIVE;\n+\n+public class DeleteRepeatDialogFragment extends DialogFragment {\n+\n+    protected FormController formController = Collect.getInstance().getFormController();\n+    protected DeleteRepeatDialogCallback callback;\n+\n+    @Override\n+    public void onAttach(@NonNull Context context) {\n+        super.onAttach(context);\n+\n+        if (context instanceof DeleteRepeatDialogCallback) {\n+            callback = (DeleteRepeatDialogCallback) context;\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Dialog onCreateDialog(@Nullable Bundle savedInstanceState) {\n+        super.onCreateDialog(savedInstanceState);\n+\n+        String name = formController.getLastRepeatedGroupName();\n+        int repeatcount = formController.getLastRepeatedGroupRepeatCount();\n+        if (repeatcount != -1) {\n+            name += \" (\" + (repeatcount + 1) + \")\";\n+        }\n+\n+        AlertDialog alertDialog = new AlertDialog.Builder(getActivity()).create();\n+        alertDialog.setTitle(getActivity().getString(R.string.delete_repeat_ask));\n+        alertDialog.setMessage(getActivity().getString(R.string.delete_repeat_confirm, name));\n+        DialogInterface.OnClickListener quitListener = (dialog, i) -> {\n+            switch (i) {\n+                case BUTTON_POSITIVE: // yes\n+                    callback.deleteGroup();\n+                    break;\n+\n+                case BUTTON_NEGATIVE: // no\n+                    callback.onCancelled();\n+                    break;\n+            }\n+            alertDialog.cancel();\n+            dismiss();\n+        };\n+        alertDialog.setCancelable(false);\n+        alertDialog.setButton(BUTTON_POSITIVE, getActivity().getString(R.string.discard_group), quitListener);\n+        alertDialog.setButton(BUTTON_NEGATIVE, getActivity().getString(R.string.delete_repeat_no), quitListener);\n+\n+        return alertDialog;\n+    }\n+\n+    public interface DeleteRepeatDialogCallback {\n+        void deleteGroup();", "originalCommit": "6edefe62419ede65abd147b6df5b3e72f2d50999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0ODg4Nw==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r435548887", "bodyText": "By the way, the delete_repeat string resource and other related ones are super confusing because they use the word \"Group\". I think we should change that but it's a separate thing.", "author": "lognaturel", "createdAt": "2020-06-04T21:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NTI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NzI5Nw==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r435547297", "bodyText": "I'm not loving this protected field pattern for testing and I see it shows up in #3792 as well. I think that again, using a ViewModel here would help address that.", "author": "lognaturel", "createdAt": "2020-06-04T21:03:04Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/repeats/DeleteRepeatDialogFragment.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.odk.collect.android.formentry.repeats;\n+\n+import android.app.Dialog;\n+import android.content.Context;\n+import android.content.DialogInterface;\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.appcompat.app.AlertDialog;\n+import androidx.fragment.app.DialogFragment;\n+\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.javarosawrapper.FormController;\n+\n+import static android.content.DialogInterface.BUTTON_NEGATIVE;\n+import static android.content.DialogInterface.BUTTON_POSITIVE;\n+\n+public class DeleteRepeatDialogFragment extends DialogFragment {\n+\n+    protected FormController formController = Collect.getInstance().getFormController();", "originalCommit": "6edefe62419ede65abd147b6df5b3e72f2d50999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU1MTc4OA==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r435551788", "bodyText": "I also feel now implementing a ViewModel would be better. I will do that.", "author": "SaumiaSinghal", "createdAt": "2020-06-04T21:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NzI5Nw=="}], "type": "inlineReview"}, {"oid": "f88d23aa61184b9d9d27796854ebde128bfd9758", "url": "https://github.com/getodk/collect/commit/f88d23aa61184b9d9d27796854ebde128bfd9758", "message": "add unit tests for FormEntryViewModel", "committedDate": "2020-06-08T15:52:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUyNjczNA==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r440526734", "bodyText": "I don't think this works because the ViewModel will have a reference to the Activity, causing a leak.\nI thought the callbacks you had before were fine. I was imagining the ViewModel only as a way for the dialog to get access to the FormController. Even better might be to give access only to the data that the dialog needs which I think is the last deleted repeat name and the last deleted repeat index.", "author": "lognaturel", "createdAt": "2020-06-16T00:58:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -1132,6 +1132,16 @@ public void onCreateContextMenu(ContextMenu menu, View v,\n     @Override\n     public boolean onContextItemSelected(MenuItem item) {\n         if (item.getItemId() == DELETE_REPEAT) {\n+            formEntryViewModel.setOnDeleted(() -> {", "originalCommit": "4c252dfb8527d199b30efb605a0400430fa4ff91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTY5NQ==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r441035695", "bodyText": "Sorry @ln I didn't realize this would cause activity leak.", "author": "SaumiaSinghal", "createdAt": "2020-06-16T17:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUyNjczNA=="}], "type": "inlineReview"}, {"oid": "19ac9d6c6658b2c54cb4fa2460a517678caaf101", "url": "https://github.com/getodk/collect/commit/19ac9d6c6658b2c54cb4fa2460a517678caaf101", "message": "create getLastRepeatedGroupName() and getLastRepeatedGroupRepeatCount() in formEntryViewModel", "committedDate": "2020-06-16T14:31:09Z", "type": "forcePushed"}, {"oid": "b9910e442222f1c8c5fc80f76cdce10ab121aa1e", "url": "https://github.com/getodk/collect/commit/b9910e442222f1c8c5fc80f76cdce10ab121aa1e", "message": "make dialogIsNotCancellable() test green", "committedDate": "2020-06-16T17:51:44Z", "type": "forcePushed"}, {"oid": "14005c453d5b1a851680fbc01b68b0484216958e", "url": "https://github.com/getodk/collect/commit/14005c453d5b1a851680fbc01b68b0484216958e", "message": "fix pmd", "committedDate": "2020-06-16T20:32:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NDA0MA==", "url": "https://github.com/getodk/collect/pull/3839#discussion_r444474040", "bodyText": "@lognaturel I changed the tests a little bit so as to avoid using protected scope for callback. I like this approach better than directly approaching the interface in the fragment.", "author": "SaumiaSinghal", "createdAt": "2020-06-23T20:01:34Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/repeats/DeleteRepeatDialogFragmentTest.java", "diffHunk": "@@ -0,0 +1,131 @@\n+package org.odk.collect.android.formentry.repeats;\n+\n+import android.content.DialogInterface;\n+import android.widget.TextView;\n+\n+import androidx.appcompat.app.AlertDialog;\n+import androidx.fragment.app.FragmentActivity;\n+import androidx.fragment.app.FragmentManager;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.formentry.FormEntryViewModel;\n+import org.odk.collect.android.support.RobolectricHelpers;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.RuntimeEnvironment;\n+import org.robolectric.shadows.ShadowDialog;\n+\n+import static junit.framework.TestCase.assertTrue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.junit.Assert.assertFalse;\n+import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.support.RobolectricHelpers.mockViewModelProvider;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class DeleteRepeatDialogFragmentTest {\n+\n+    private TestActivity activity;\n+    private FragmentManager fragmentManager;\n+    private DeleteRepeatDialogFragment dialogFragment;\n+    private FormEntryViewModel formEntryViewModel;\n+\n+    @Before\n+    public void setup() {\n+        activity = RobolectricHelpers.createThemedActivity(TestActivity.class);\n+        fragmentManager = activity.getSupportFragmentManager();\n+        dialogFragment = new DeleteRepeatDialogFragment();\n+\n+        formEntryViewModel = mockViewModelProvider(activity, FormEntryViewModel.class).get(FormEntryViewModel.class);\n+    }\n+\n+    @Test\n+    public void fragmentActivityShouldImplementDeleteRepeatDialogCallback() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        assertThat(dialogFragment.getActivity(), instanceOf(DeleteRepeatDialogFragment.DeleteRepeatDialogCallback.class));\n+    }\n+\n+    @Test\n+    public void dialogIsNotCancellable() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        assertThat(shadowOf(dialogFragment.getDialog()).isCancelable(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void shouldShowCorrectMessage() {\n+        when(formEntryViewModel.getLastRepeatedGroupName()).thenReturn(\"blah\");\n+        when(formEntryViewModel.getLastRepeatedGroupRepeatCount()).thenReturn(0);\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        AlertDialog dialog = (AlertDialog) ShadowDialog.getLatestDialog();\n+        String message = ((TextView) dialog.findViewById(android.R.id.message)).getText().toString();\n+\n+        assertThat(message, equalTo(RuntimeEnvironment.application.getString(R.string.delete_repeat_confirm, \"blah (1)\")));\n+    }\n+\n+    @Test\n+    public void clickingCancel_shouldDismissTheDialog() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        AlertDialog dialog = (AlertDialog) ShadowDialog.getLatestDialog();\n+        assertTrue(dialog.isShowing());\n+\n+        dialog.getButton(DialogInterface.BUTTON_NEGATIVE).performClick();\n+        assertFalse(dialog.isShowing());\n+        assertTrue(shadowOf(dialog).hasBeenDismissed());\n+    }\n+\n+    @Test\n+    public void clickingRemoveGroup_shouldDismissTheDialog() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        AlertDialog dialog = (AlertDialog) ShadowDialog.getLatestDialog();\n+        assertTrue(dialog.isShowing());\n+\n+        dialog.getButton(DialogInterface.BUTTON_POSITIVE).performClick();\n+        assertFalse(dialog.isShowing());\n+        assertTrue(shadowOf(dialog).hasBeenDismissed());\n+    }\n+\n+    @Test\n+    public void clickingRemoveGroup_callsDeleteGroup() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        AlertDialog dialog = (AlertDialog) ShadowDialog.getLatestDialog();\n+        assertThat(activity.deleteGroupCalled, equalTo(false));\n+\n+        dialog.getButton(DialogInterface.BUTTON_POSITIVE).performClick();\n+        assertThat(activity.deleteGroupCalled, equalTo(true));\n+    }\n+\n+    @Test\n+    public void clickingCancel_callsOnCancelled() {\n+        dialogFragment.show(fragmentManager, \"TAG\");\n+        AlertDialog dialog = (AlertDialog) ShadowDialog.getLatestDialog();\n+        assertThat(activity.onCancelledCalled, equalTo(false));\n+\n+        dialog.getButton(DialogInterface.BUTTON_NEGATIVE).performClick();\n+        assertThat(activity.onCancelledCalled, equalTo(true));\n+    }\n+\n+    public static class TestActivity extends FragmentActivity implements DeleteRepeatDialogFragment.DeleteRepeatDialogCallback {\n+", "originalCommit": "9b9c63174d636098f7665cfd5a300dae1f52c92c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bbdf2cd115157bd600783c19c898de76364ca068", "url": "https://github.com/getodk/collect/commit/bbdf2cd115157bd600783c19c898de76364ca068", "message": "defined unit tests", "committedDate": "2020-07-08T16:12:22Z", "type": "commit"}, {"oid": "0c9fe14170f2abc652722d34e458191feefdc863", "url": "https://github.com/getodk/collect/commit/0c9fe14170f2abc652722d34e458191feefdc863", "message": "created Alert Dialog in DeleteRepeatDailog fragment", "committedDate": "2020-07-08T16:12:22Z", "type": "commit"}, {"oid": "ae31539920c278ee081ebb8938e05cf1be86b61a", "url": "https://github.com/getodk/collect/commit/ae31539920c278ee081ebb8938e05cf1be86b61a", "message": "updated message in alert dialog", "committedDate": "2020-07-08T16:12:22Z", "type": "commit"}, {"oid": "f169b4c5ac040433dd4d5db81d781103cb90d0c6", "url": "https://github.com/getodk/collect/commit/f169b4c5ac040433dd4d5db81d781103cb90d0c6", "message": "added tests and code refactor", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "512710373b84dcb6a1bbd077d2eb1f97bae85322", "url": "https://github.com/getodk/collect/commit/512710373b84dcb6a1bbd077d2eb1f97bae85322", "message": "deleted createDeleteRepeatDialog method in DialogUtils", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "bfa785bd7fd61ee97de7d8f213e583e8d2414550", "url": "https://github.com/getodk/collect/commit/bfa785bd7fd61ee97de7d8f213e583e8d2414550", "message": "remove retainMessageOnScreenRotation() test", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "158bbc12c3b80e73aa1c54c8b1f34c71cce6c360", "url": "https://github.com/getodk/collect/commit/158bbc12c3b80e73aa1c54c8b1f34c71cce6c360", "message": "make dialogIsNotCancellable() test green", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "af3abe4beec78cc24774ebc30628c7d41f30ca26", "url": "https://github.com/getodk/collect/commit/af3abe4beec78cc24774ebc30628c7d41f30ca26", "message": "unit tests refactor", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "c59ce33f1fcabebc50bb7ac44e8603187135b339", "url": "https://github.com/getodk/collect/commit/c59ce33f1fcabebc50bb7ac44e8603187135b339", "message": "fix pmd", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "f870c9c701cd2c90266d9c1d32ab98da01641e56", "url": "https://github.com/getodk/collect/commit/f870c9c701cd2c90266d9c1d32ab98da01641e56", "message": "fix crash", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "248efd8024eb30b3c79066a22d0b2021ba7aa880", "url": "https://github.com/getodk/collect/commit/248efd8024eb30b3c79066a22d0b2021ba7aa880", "message": "add unit test to check the activity implemts dialog callback interface", "committedDate": "2020-07-08T16:12:23Z", "type": "commit"}, {"oid": "02f974f8a4c0026bae0056fb30d9878b9cc8d88f", "url": "https://github.com/getodk/collect/commit/02f974f8a4c0026bae0056fb30d9878b9cc8d88f", "message": "fix crash on minimizing app", "committedDate": "2020-07-08T17:27:18Z", "type": "commit"}, {"oid": "02f974f8a4c0026bae0056fb30d9878b9cc8d88f", "url": "https://github.com/getodk/collect/commit/02f974f8a4c0026bae0056fb30d9878b9cc8d88f", "message": "fix crash on minimizing app", "committedDate": "2020-07-08T17:27:18Z", "type": "forcePushed"}, {"oid": "84f57bccecf97a29c9f964bb1817f55fc50b8c30", "url": "https://github.com/getodk/collect/commit/84f57bccecf97a29c9f964bb1817f55fc50b8c30", "message": "fix deleteGroup() in FormEntryActivity", "committedDate": "2020-07-09T19:01:34Z", "type": "commit"}, {"oid": "9f52237810f4b9e5aba746c318ce5a4258487348", "url": "https://github.com/getodk/collect/commit/9f52237810f4b9e5aba746c318ce5a4258487348", "message": "remove FormEntryViewModel in DeleteRepeatDialogFramgent", "committedDate": "2020-07-14T15:28:25Z", "type": "commit"}, {"oid": "06e4ac811dcc316cf5b633ea3ca0f07da82f9e4a", "url": "https://github.com/getodk/collect/commit/06e4ac811dcc316cf5b633ea3ca0f07da82f9e4a", "message": "fix unit tests", "committedDate": "2020-07-14T16:00:26Z", "type": "commit"}, {"oid": "64853923c20e975e972a14a958c929766c430625", "url": "https://github.com/getodk/collect/commit/64853923c20e975e972a14a958c929766c430625", "message": "remove onCancelled()", "committedDate": "2020-07-14T16:12:36Z", "type": "commit"}]}