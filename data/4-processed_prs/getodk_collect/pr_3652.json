{"pr_number": 3652, "pr_title": "Fix the form map crash by waiting until the map fragment is initialized to save it in the map field", "pr_createdAt": "2020-02-25T20:11:59Z", "pr_url": "https://github.com/getodk/collect/pull/3652", "timeline": [{"oid": "6d41005cd0482d6fee9f7f1f7c23970064f63343", "url": "https://github.com/getodk/collect/commit/6d41005cd0482d6fee9f7f1f7c23970064f63343", "message": "Don't set the map field before initialization\n\nWhen onResume called updateInstanceGeometry, the map wasn't null so there was an attempt to map features even though the map fragment was not guaranteed to be fully initialized. We need the geometry update in onResume for the case where a user triggers form filling from this activity and then returns to it having added a new feature.", "committedDate": "2020-02-25T20:12:29Z", "type": "forcePushed"}, {"oid": "49e7ce61fd8df0149fe74f7f7e9ab9ebf5fc6f96", "url": "https://github.com/getodk/collect/commit/49e7ce61fd8df0149fe74f7f7e9ab9ebf5fc6f96", "message": "Don't set the map field before initialization\n\nWhen onResume called updateInstanceGeometry, the map wasn't null so there was an attempt to map features even though the map fragment was not guaranteed to be fully initialized. We need the geometry update in onResume for the case where a user triggers form filling from this activity and then returns to it having added a new feature.", "committedDate": "2020-02-25T20:19:48Z", "type": "commit"}, {"oid": "49e7ce61fd8df0149fe74f7f7e9ab9ebf5fc6f96", "url": "https://github.com/getodk/collect/commit/49e7ce61fd8df0149fe74f7f7e9ab9ebf5fc6f96", "message": "Don't set the map field before initialization\n\nWhen onResume called updateInstanceGeometry, the map wasn't null so there was an attempt to map features even though the map fragment was not guaranteed to be fully initialized. We need the geometry update in onResume for the case where a user triggers form filling from this activity and then returns to it having added a new feature.", "committedDate": "2020-02-25T20:19:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjA3Mg==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385252072", "bodyText": "Yeah I think we should use Dagger for this. It feels like we're adding machinery in to mimic what it would do for us here.", "author": "seadowg", "createdAt": "2020-02-27T17:15:56Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java", "diffHunk": "@@ -113,13 +112,14 @@\n         TextView titleView = findViewById(R.id.form_title);\n         titleView.setText(viewModel.getFormTitle());\n \n-        if (map == null) { // tests set their maps directly\n-            Context context = getApplicationContext();\n-            map = MapProvider.createMapFragment(context);\n+        MapFragment mapToAdd = map; // tests will have a value for the map field\n+\n+        if (mapToAdd == null) {\n+            mapToAdd = MapProvider.createMapFragment(getApplicationContext());", "originalCommit": "49e7ce61fd8df0149fe74f7f7e9ab9ebf5fc6f96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NjcyMw==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385266723", "bodyText": "Sigh, ok, will do. \ud83d\ude14", "author": "lognaturel", "createdAt": "2020-02-27T17:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwMTkwNQ==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385501905", "bodyText": "I should have referred back to #3552 (comment) before mentioning Dagger. We can't inject the MapFragment in onCreate for exactly the thing that this bug is related to -- we don't want to set the field until the asynchronous initialization has completed. Alternately, we could keep extra state to know whether the initialization has completed or not but I don't think that's very clean. So I went the route of injecting a MapProvider singleton. I hope you will find this reasonable, @seadowg. I had chosen not do that in the previous PR because it would touch every geo component but I suppose it's not particularly risky.", "author": "lognaturel", "createdAt": "2020-02-28T04:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNjcyNg==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385506726", "bodyText": "For the record and so that perhaps someone can push back on me, some things that upset me about Dagger/our Dagger setup:\n\nthe magic. We end up with a lot of generated code that feels brittle.\nthe mental overhead. I thought I could inject into BaseGeoMapActivity not realizing that I couldn't because it's abstract. I had to track down that I was getting a no-op inject method and find my way to google/dagger#489 since there's no warning. It might just be a familiarity thing but I feel like I end up with some kind of irritation like this every time I'm using Dagger.\nwe wax poetic about separation of concerns and then we have AppDependencyModule and AppDependencyComponent which feel like really ugly grab-bags of stuff. Part of that is that the app itself isn't currently divided up into modules.", "author": "lognaturel", "createdAt": "2020-02-28T04:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjA3Mg=="}], "type": "inlineReview"}, {"oid": "5453363b5a884307d8a6a70274637fd3ffcb87ec", "url": "https://github.com/getodk/collect/commit/5453363b5a884307d8a6a70274637fd3ffcb87ec", "message": "Inject a MapProvider singleton", "committedDate": "2020-02-28T04:40:50Z", "type": "forcePushed"}, {"oid": "6d05186f42f55ce5e61d1da1f550eeb621507d36", "url": "https://github.com/getodk/collect/commit/6d05186f42f55ce5e61d1da1f550eeb621507d36", "message": "Inject a MapProvider singleton", "committedDate": "2020-02-28T05:12:42Z", "type": "forcePushed"}, {"oid": "0c3da93a7633d4ad52a30822679b75057433d3af", "url": "https://github.com/getodk/collect/commit/0c3da93a7633d4ad52a30822679b75057433d3af", "message": "Inject a MapProvider singleton", "committedDate": "2020-02-28T05:18:11Z", "type": "commit"}, {"oid": "0c3da93a7633d4ad52a30822679b75057433d3af", "url": "https://github.com/getodk/collect/commit/0c3da93a7633d4ad52a30822679b75057433d3af", "message": "Inject a MapProvider singleton", "committedDate": "2020-02-28T05:18:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgzNQ==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385593835", "bodyText": "You don't need the @Singleton here as you have it on the provider. It can be useful as documentation but I'm not sure the class needs to know it's going to be used as a singleton in this case.", "author": "seadowg", "createdAt": "2020-02-28T09:36:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/geo/MapProvider.java", "diffHunk": "@@ -31,13 +33,12 @@\n import static org.odk.collect.android.preferences.GeneralKeys.KEY_USGS_MAP_STYLE;\n \n /**\n- * A static class that obtains a MapFragment according to the user's preferences.\n+ * Obtains a MapFragment according to the user's preferences.\n  * This is the top-level class that should be used by the rest of the application.\n  * The available options on the Maps preferences screen are also defined here.\n  */\n+@Singleton", "originalCommit": "0c3da93a7633d4ad52a30822679b75057433d3af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTczNzg3NQ==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385737875", "bodyText": "I went back and forth on this and it seemed helpful to identify that the map fields are an ongoing concern. How do you decide whether it\u2019s useful or not?", "author": "lognaturel", "createdAt": "2020-02-28T14:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc0NzcxOA==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385747718", "bodyText": "Hmmm. I guess for me I like that all the configuration around how a dependency is provided lives in the Dagger files (AppDependencyModule for instance) and thatt really the object itelf shouldn't need to know about it's own lifecycle.\nA more concrete criticism would be that having @Singleton in both places is confusing for newbies to Dagger (but then what about Dagger isn't confusing).", "author": "seadowg", "createdAt": "2020-02-28T15:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxNDQ3OA==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385814478", "bodyText": "thatt really the object itelf shouldn't need to know about it's own lifecycle.\n\nI see what you're getting at. I feel like singletons often have a pretty different structure and the assumption that a single instance exists is baked in but perhaps that shouldn't be the case. Here, like I wrote in the PR description, it could pretty easily be restructured to not be a singleton. Anyway, I don't feel strongly about it so I've removed it.\n\nhaving @singleton in both places is confusing for newbies to Dagger\n\nI do agree with that.", "author": "lognaturel", "createdAt": "2020-02-28T17:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5MzgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU5NDEwNw==", "url": "https://github.com/getodk/collect/pull/3652#discussion_r385594107", "bodyText": "Woh good catch!", "author": "seadowg", "createdAt": "2020-02-28T09:37:28Z", "path": "docs/CODE-GUIDELINES.md", "diffHunk": "@@ -78,10 +78,10 @@ While it's important to read the Dagger [documentation](https://google.github.io\n \n ### Providing dependencies\n \n-To declare a new dependency that objects can inject add a `@Provider` method to the `AppDepedencyModule`:\n+To declare a new dependency that objects can inject add a `@Provides` method to the `AppDependencyModule`:", "originalCommit": "0c3da93a7633d4ad52a30822679b75057433d3af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "289642bfbb55a2a346d76a8681cfc874212e59c1", "url": "https://github.com/getodk/collect/commit/289642bfbb55a2a346d76a8681cfc874212e59c1", "message": "Remove informational singleton annotation on class", "committedDate": "2020-02-28T17:09:15Z", "type": "commit"}, {"oid": "289642bfbb55a2a346d76a8681cfc874212e59c1", "url": "https://github.com/getodk/collect/commit/289642bfbb55a2a346d76a8681cfc874212e59c1", "message": "Remove informational singleton annotation on class", "committedDate": "2020-02-28T17:09:15Z", "type": "forcePushed"}, {"oid": "448423684c125fabc4ed291a4de91e0d3564389a", "url": "https://github.com/getodk/collect/commit/448423684c125fabc4ed291a4de91e0d3564389a", "message": "Merge remote-tracking branch 'upstream/master' into issue-3651", "committedDate": "2020-03-03T18:35:06Z", "type": "commit"}]}