{"pr_number": 4325, "pr_title": "Fix crash when media file download fails", "pr_createdAt": "2020-12-18T13:51:57Z", "pr_url": "https://github.com/getodk/collect/pull/4325", "timeline": [{"oid": "689085cbd3df655de2071fbe797517c152fd0b53", "url": "https://github.com/getodk/collect/commit/689085cbd3df655de2071fbe797517c152fd0b53", "message": "Annotate fetchForm", "committedDate": "2020-12-18T13:21:39Z", "type": "commit"}, {"oid": "df2f027766fdaaaed32b8b9d9029b0725a3624ac", "url": "https://github.com/getodk/collect/commit/df2f027766fdaaaed32b8b9d9029b0725a3624ac", "message": "Make sure FormSource can't return null for media file fetch", "committedDate": "2020-12-18T13:31:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDYxMg==", "url": "https://github.com/getodk/collect/pull/4325#discussion_r545860612", "bodyText": "Wouldn't it be better to check this in mapException and throw new FormSourceException(FETCH_ERROR) there? Then it would be in one place.", "author": "grzesiek2010", "createdAt": "2020-12-18T14:21:42Z", "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/OpenRosaFormSource.java", "diffHunk": "@@ -100,13 +100,27 @@ public ManifestFile fetchManifest(String manifestURL) throws FormSourceException\n     }\n \n     @Override\n-    public @NotNull InputStream fetchForm(String formURL) throws FormSourceException {\n-        return fetchFile(formURL);\n+    @NotNull\n+    public InputStream fetchForm(String formURL) throws FormSourceException {\n+        InputStream formFile = mapException(() -> openRosaXMLFetcher.getFile(formURL, null));\n+\n+        if (formFile != null) {\n+            return formFile;\n+        } else {\n+            throw new FormSourceException(FETCH_ERROR);\n+        }\n     }\n \n     @Override\n+    @NotNull\n     public InputStream fetchMediaFile(String mediaFileURL) throws FormSourceException {\n-        return mapException(() -> openRosaXMLFetcher.getFile(mediaFileURL, null));\n+        InputStream mediaFile = mapException(() -> openRosaXMLFetcher.getFile(mediaFileURL, null));\n+\n+        if (mediaFile != null) {", "originalCommit": "df2f027766fdaaaed32b8b9d9029b0725a3624ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NDg1Mw==", "url": "https://github.com/getodk/collect/pull/4325#discussion_r546364853", "bodyText": "Yeah, I think you're right. It feels like a good place for some defensive programming.", "author": "seadowg", "createdAt": "2020-12-20T11:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDYxMg=="}], "type": "inlineReview"}, {"oid": "1e5b5807226336f5c742ada7d95a30de1a4efc78", "url": "https://github.com/getodk/collect/commit/1e5b5807226336f5c742ada7d95a30de1a4efc78", "message": "Move null check into helper method", "committedDate": "2020-12-20T11:50:20Z", "type": "commit"}]}