{"pr_number": 4314, "pr_title": "Add logging", "pr_createdAt": "2020-12-16T00:09:09Z", "pr_url": "https://github.com/getodk/collect/pull/4314", "timeline": [{"oid": "a7239755c1c65022d33203bf6be72d816c226f4a", "url": "https://github.com/getodk/collect/commit/a7239755c1c65022d33203bf6be72d816c226f4a", "message": "Add logging for saveAnswer failure", "committedDate": "2020-12-16T00:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODgwMw==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r543798803", "bodyText": "This should not have been reusing the field as it's just used locally. One idea I have for why this crash happens is that somehow there is an instance that matches the path in the DB but the update fails. Then the else branch below is hit but the uri is set to the instance uri rather than the form uri as it should be. This feels like a really safe fix to me but it would be good to get confirmation.", "author": "lognaturel", "createdAt": "2020-12-16T00:59:54Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/SaveFormToDisk.java", "diffHunk": "@@ -212,9 +210,9 @@ private void updateInstanceDatabase(boolean incomplete, boolean canEditAfterComp\n             InstancesRepository instances = new DatabaseInstancesRepository();\n             Instance instance = instances.getOneByPath(instancePath);\n             if (instance != null) {\n-                uri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());\n+                Uri instanceUri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());", "originalCommit": "3b528a8948ed38c03f0c57dff87001c330bd1c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4Mzg0Ng==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544283846", "bodyText": "Ach I'm in two minds. I think your explanation makes sense, but I'm a little worried about merging this in during regression testing especially as it's not tested. How do you feel about this being pulled out as a separate change (we can potentially as an issue) so we can add tests around it and merge later?", "author": "seadowg", "createdAt": "2020-12-16T13:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NTA3Nw==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544455077", "bodyText": "Fair enough. Let me take it out and the logging will help us either confirm that's the issue or discard that hypothesis. Then we can either add the change in a point release or in v1.30.", "author": "lognaturel", "createdAt": "2020-12-16T16:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MDMwNg==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544280306", "bodyText": "Does this not need to be Timber.e?", "author": "seadowg", "createdAt": "2020-12-16T13:02:17Z", "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -516,6 +516,9 @@ public boolean saveAnswer(FormIndex index, IAnswerData data) throws JavaRosaExce\n         try {\n             return formEntryController.saveAnswer(index, data, true);\n         } catch (Exception e) {\n+            Timber.w(\"Error saving answer of type %s with ref %s for index %s\",", "originalCommit": "a7239755c1c65022d33203bf6be72d816c226f4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMyMjI2MA==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544322260", "bodyText": "Oh no looks like I'm wrong (looking at ApplicationInitializer). Ignore me. I see now what the diff is.", "author": "seadowg", "createdAt": "2020-12-16T14:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NDMxOQ==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544454319", "bodyText": "Right, it's a little weird. w is for things that we don't want as a top-level issue but that we want to show up in the logs we see in Firebase to provide context. It feels like a little bit of an abuse of w but I don't see another way. We definitely don't want to send lower log levels to Firebase.\nSide note, it's not totally clear to me whether the top-level \"non-fatal\" crashes we see from Firebase are from Timber.e or from Firebase automatically intercepting exceptions even if they're caught or possibly both.", "author": "lognaturel", "createdAt": "2020-12-16T16:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MDMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MTA0NQ==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544281045", "bodyText": "Again I thought these had to be Timber.e but I could be wrong.", "author": "seadowg", "createdAt": "2020-12-16T13:03:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/SaveFormToDisk.java", "diffHunk": "@@ -231,7 +229,11 @@ private void updateInstanceDatabase(boolean incomplete, boolean canEditAfterComp\n             } else {\n                 Timber.i(\"No instance found, creating\");\n                 try (Cursor c = Collect.getInstance().getContentResolver().query(uri, null, null, null, null)) {\n-                    // retrieve the form definition...\n+                    // retrieve the form definition\n+                    if (c.getCount() != 1) {\n+                        Timber.w(\"No matching form found for %s\", uri);", "originalCommit": "3b528a8948ed38c03f0c57dff87001c330bd1c81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9b78668c914c6ccd8223ad7d1f4c4ae4e1bfbea6", "url": "https://github.com/getodk/collect/commit/9b78668c914c6ccd8223ad7d1f4c4ae4e1bfbea6", "message": "Add logging for crash when saving new instance", "committedDate": "2020-12-16T16:51:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwMjMyNw==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544502327", "bodyText": "Ok sorry now I'm being really paranoid, but I think it'd be good to make that we account for null data or index so there is no risk of ending up with a NullPointerException here.", "author": "seadowg", "createdAt": "2020-12-16T17:52:08Z", "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -516,6 +516,9 @@ public boolean saveAnswer(FormIndex index, IAnswerData data) throws JavaRosaExce\n         try {\n             return formEntryController.saveAnswer(index, data, true);\n         } catch (Exception e) {\n+            Timber.w(\"Error saving answer of type %s with ref %s for index %s\",\n+                    data.getClass().toString(), index.getReference(), index);", "originalCommit": "3a8d9a599f1433b0113a4d8fb1050934571fd313", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a8224e4e0b522360916dfdab01472121f1f01a8", "url": "https://github.com/getodk/collect/commit/8a8224e4e0b522360916dfdab01472121f1f01a8", "message": "Add logging for crash when saving new instance", "committedDate": "2020-12-16T17:56:39Z", "type": "commit"}, {"oid": "4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "url": "https://github.com/getodk/collect/commit/4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "message": "Adjust log levels to reduce noise", "committedDate": "2020-12-16T17:56:42Z", "type": "forcePushed"}, {"oid": "40ef6277f15b8e99318ced52373d7ac162e88920", "url": "https://github.com/getodk/collect/commit/40ef6277f15b8e99318ced52373d7ac162e88920", "message": "Adjust log levels to reduce noise", "committedDate": "2020-12-16T18:14:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyMTYyMQ==", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544521621", "bodyText": "This is the top reporting issue in Firebase but it's expected because there could be an attempt to get the phone number before permissions were prompted for.", "author": "lognaturel", "createdAt": "2020-12-16T18:20:58Z", "path": "collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java", "diffHunk": "@@ -94,7 +94,7 @@ public PropertyManager reload() {\n             putProperty(PROPMGR_DEVICE_ID,     \"\",         deviceDetailsProvider.getDeviceId());\n             putProperty(PROPMGR_PHONE_NUMBER,  SCHEME_TEL,          deviceDetailsProvider.getLine1Number());\n         } catch (SecurityException e) {\n-            Timber.e(e);\n+            Timber.i(e);", "originalCommit": "40ef6277f15b8e99318ced52373d7ac162e88920", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "url": "https://github.com/getodk/collect/commit/a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "message": "Adjust log levels to reduce noise", "committedDate": "2020-12-16T22:00:08Z", "type": "commit"}, {"oid": "a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "url": "https://github.com/getodk/collect/commit/a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "message": "Adjust log levels to reduce noise", "committedDate": "2020-12-16T22:00:08Z", "type": "forcePushed"}]}