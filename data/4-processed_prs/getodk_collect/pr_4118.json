{"pr_number": 4118, "pr_title": "Prevent NPE in QuitFormDialogFragment", "pr_createdAt": "2020-09-24T09:50:39Z", "pr_url": "https://github.com/getodk/collect/pull/4118", "timeline": [{"oid": "f9f3442419cb905f15b8302a217d066ee6decce2", "url": "https://github.com/getodk/collect/commit/f9f3442419cb905f15b8302a217d066ee6decce2", "message": "Try to protect FormSaveViewModel from null FormController", "committedDate": "2020-09-24T09:41:48Z", "type": "commit"}, {"oid": "d8a120688a7be264065b404a606efde309b708e4", "url": "https://github.com/getodk/collect/commit/d8a120688a7be264065b404a606efde309b708e4", "message": "Pull ignore changes code into view model", "committedDate": "2020-09-24T09:46:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4NjE0Nw==", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494186147", "bodyText": "This is the one place where it seemed like we could pass a null to formLoaded as we are checking the singleton field isn't null and then calling the method again. Assigning it here means that we only deal with the one value (null or not).", "author": "seadowg", "createdAt": "2020-09-24T09:52:57Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -519,8 +520,9 @@ private void loadForm() {\n             formLoaderTask = (FormLoaderTask) data;\n         } else if (data == null) {\n             if (!newForm) {\n-                if (getFormController() != null) {", "originalCommit": "d8a120688a7be264065b404a606efde309b708e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8a120688a7be264065b404a606efde309b708e4", "url": "https://github.com/getodk/collect/commit/d8a120688a7be264065b404a606efde309b708e4", "message": "Pull ignore changes code into view model", "committedDate": "2020-09-24T09:46:14Z", "type": "forcePushed"}, {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "url": "https://github.com/getodk/collect/commit/7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "message": "Add test to ensure NPE is solved", "committedDate": "2020-09-24T13:45:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMTYxMw==", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494331613", "bodyText": "Much easier to protect form null in the view model", "author": "seadowg", "createdAt": "2020-09-24T13:46:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -127,8 +128,15 @@ public void saveForm(Uri instanceContentURI, boolean shouldFinalize, String upda\n     }\n \n     // Cleanup when user exits a form without saving\n-    public void removeTempInstance() {\n+    public void ignoreChanges() {\n+        ExternalDataManager manager = Collect.getInstance().getExternalDataManager();\n+        if (manager != null) {\n+            manager.close();\n+        }\n+\n         if (formController != null && formController.getInstanceFile() != null) {\n+            formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_EXIT, true, System.currentTimeMillis());", "originalCommit": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMzEwOQ==", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494333109", "bodyText": "Definitely could be expanded on but this is good enough to give us a harness to prevent a regression on this particular bug.", "author": "seadowg", "createdAt": "2020-09-24T13:47:46Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -411,6 +411,12 @@ public void replaceRecentFileForQuestion_whenQuestionIndexHasAnswer_onRecreating\n         verify(mediaUtils).deleteImageFileFromMediaProvider(\"blah\");\n     }\n \n+    @Test\n+    public void ignoreChanges_whenFormControllerNotSet_doesNothing() {\n+        FormSaveViewModel viewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        viewModel.ignoreChanges(); // Checks nothing explodes", "originalCommit": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzNTk5MA==", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494435990", "bodyText": "Haven't you shaken your fist in my general direction about tests without assertions before?! \ud83d\ude05\nMore seriously, I'm not really thinking of anything meaningful to assert and I do think it's ok.", "author": "lognaturel", "createdAt": "2020-09-24T16:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMzEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MzI5Mw==", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494443293", "bodyText": "Haha probably. Do as I say not as I do right...\nBut yeah I think this test would ideally check that calls aren't made but here it felt the real focus was just to make sure nothing exploded. There is a comment \ud83d\ude09", "author": "seadowg", "createdAt": "2020-09-24T16:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMzEwOQ=="}], "type": "inlineReview"}, {"oid": "7f3a801455d5e4fb3b07fe4a5b1c333031dc5b67", "url": "https://github.com/getodk/collect/commit/7f3a801455d5e4fb3b07fe4a5b1c333031dc5b67", "message": "Still log form exit if instanceFile is null", "committedDate": "2020-09-25T16:17:41Z", "type": "commit"}]}