{"pr_number": 3772, "pr_title": "Use fused location provider everywhere", "pr_createdAt": "2020-04-09T00:24:16Z", "pr_url": "https://github.com/getodk/collect/pull/3772", "timeline": [{"oid": "b001a97a9f375c9e4dea19c34ee2e4bc3eb89fe9", "url": "https://github.com/getodk/collect/commit/b001a97a9f375c9e4dea19c34ee2e4bc3eb89fe9", "message": "Separate location provider from accuracy", "committedDate": "2020-05-26T21:32:35Z", "type": "forcePushed"}, {"oid": "929dc4f8d0b531f243c4caa39903229f186ae59a", "url": "https://github.com/getodk/collect/commit/929dc4f8d0b531f243c4caa39903229f186ae59a", "message": "Always call onClientStop from stop, never from onConnectionSuspended\n\nAccording to the docs on LocationClientListener.onClientStop, it should always be called when stop() is called. This also matches the AndroidLocationClient implementation. onConnectionSuspended is called when the connection to Google Play Services is lost because, for example, the user stops it. According to the original author of the API, a reconnection attempt will be made: https://stackoverflow.com/a/26147518/137744. I don't think it's appropriate to consider the LocationClient stopped at that point.", "committedDate": "2020-06-02T00:09:54Z", "type": "forcePushed"}, {"oid": "a2d668e826a1e3f7059df5776449a6decf4e521e", "url": "https://github.com/getodk/collect/commit/a2d668e826a1e3f7059df5776449a6decf4e521e", "message": "Remove GPS from location description", "committedDate": "2020-06-02T02:32:13Z", "type": "forcePushed"}, {"oid": "7ac482252f1e67fb2686da18ba4e3819ff35776f", "url": "https://github.com/getodk/collect/commit/7ac482252f1e67fb2686da18ba4e3819ff35776f", "message": "Remove GPS from location description", "committedDate": "2020-06-02T04:02:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MDMwMw==", "url": "https://github.com/getodk/collect/pull/3772#discussion_r433840303", "bodyText": "I agree about not pulling in Play Services shadows. One potentially simple way to make this test a little nicer would be to pass a GoogleAPIClientLocationProvider interface to LocationClientProvider in someway so it could be mocked/faked and not actually call the play services code. That would also let us write tests for GoogleFusedLocationProvider without any extra Robolectric stuff.\nSo many interfaces though! It's frustrating not having any way to express lambdas in method signatures. #3886 adds a poly fill for Java 8's Supplier  (we could be using it as a general \"provider\" interface) which could make this all a bit simpler. You could think about introducing that here?", "author": "seadowg", "createdAt": "2020-06-02T12:34:50Z", "path": "collect_app/src/test/java/org/odk/collect/android/location/client/LocationClientProviderTest.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright (C) 2020 Nafundi\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.odk.collect.android.location.client;\n+\n+import android.content.Context;\n+import android.util.Log;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.odk.collect.android.utilities.PlayServicesChecker;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class LocationClientProviderTest {\n+    @Rule\n+    public MockitoRule rule = MockitoJUnit.rule();\n+\n+    @Mock\n+    public Context context;\n+\n+    @Mock\n+    public PlayServicesChecker playServicesChecker;\n+\n+    @Test\n+    public void fusedLocationClient_returnedWhenPlayServicesAvailable() {\n+        when(playServicesChecker.isGooglePlayServicesAvailable(any())).thenReturn(true);\n+\n+        // Could import Robolectric Shadows Play Services to actually build a GoogleFusedLocationClient", "originalCommit": "e09948cd7efb238549a18c327da5e65bf4fbae07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NTc3Nw==", "url": "https://github.com/getodk/collect/pull/3772#discussion_r434995777", "bodyText": "Hopefully 87439ff is roughly what you had in mind. There are so many levels of provider client client providers here it's feeling a little silly but I agree the test looks much better.", "author": "lognaturel", "createdAt": "2020-06-04T05:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MDMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MzkxMg==", "url": "https://github.com/getodk/collect/pull/3772#discussion_r433843912", "bodyText": "Might be easier to use Mockito for this listener verification?", "author": "seadowg", "createdAt": "2020-06-02T12:41:05Z", "path": "collect_app/src/test/java/org/odk/collect/android/location/client/GoogleFusedLocationClientTest.java", "diffHunk": "@@ -74,30 +76,29 @@ public void startShouldCallLocationClientOnConnected() {\n     }\n \n     @Test\n-    public void stopShouldDisconnectFromGoogleApiIfConnected() {\n-\n+    public void stopShouldDisconnectFromGoogleApiIfConnected_andAlwaysCallOnClientStopIfListenerSet() {\n         TestClientListener testClientListener = new TestClientListener();\n         client.setListener(testClientListener);\n \n-        // Call through to ApiClient.disconnect(), but don't do anything:\n+        // Previously connected, disconnection succeeds\n         when(googleApiClient.isConnected()).thenReturn(true);\n         client.stop();\n+        verify(googleApiClient).disconnect();\n+        assertThat(testClientListener.getOnClientStopCount(), is(1));", "originalCommit": "347112f1f93425ae4905f33409e932512031fdd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NTIxNw==", "url": "https://github.com/getodk/collect/pull/3772#discussion_r434995217", "bodyText": "Agreed and done. I made all the tests in that class consistent. I didn't touch AndroidLocationClientTest which still uses TestClientListener.", "author": "lognaturel", "createdAt": "2020-06-04T05:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MzkxMg=="}], "type": "inlineReview"}, {"oid": "87439ff3e3aec6846553c2feb1f0f88d277c033f", "url": "https://github.com/getodk/collect/commit/87439ff3e3aec6846553c2feb1f0f88d277c033f", "message": "Add provider for GoogleFusedLocationClient", "committedDate": "2020-06-04T05:04:13Z", "type": "forcePushed"}, {"oid": "9947fb658f3ddbce18941ed36f3888dad9600332", "url": "https://github.com/getodk/collect/commit/9947fb658f3ddbce18941ed36f3888dad9600332", "message": "Use supplier for GoogleFusedLocationClient", "committedDate": "2020-06-04T17:29:17Z", "type": "forcePushed"}, {"oid": "a5603d84f118bb22aa58c9d0d488019788c33b6c", "url": "https://github.com/getodk/collect/commit/a5603d84f118bb22aa58c9d0d488019788c33b6c", "message": "PlayServicesUtil cleanup: remove unused static member and clarify JavaDoc.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "f7ac9c10b7166885b69b0957e35a17873d8fec07", "url": "https://github.com/getodk/collect/commit/f7ac9c10b7166885b69b0957e35a17873d8fec07", "message": "Enable LocationClients to return the fused location provider.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "6c014a0550eb807ab795017b4711f48cbefa2127", "url": "https://github.com/getodk/collect/commit/6c014a0550eb807ab795017b4711f48cbefa2127", "message": "Rename GoogleLocationClient to GoogleFusedLocationClient for clarity.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "05d06f5e07cedadb565ead6f7c7513b4d0ebb992", "url": "https://github.com/getodk/collect/commit/05d06f5e07cedadb565ead6f7c7513b4d0ebb992", "message": "Rename LocationClients to LocationClientProvider to reflect its purpose.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "5b48529b71c81f3041941d358ff3e434cd3ca3da", "url": "https://github.com/getodk/collect/commit/5b48529b71c81f3041941d358ff3e434cd3ca3da", "message": "Fix PMD complaints.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "a9020465d24bea893ac26f61ab8e9826e6f7bea0", "url": "https://github.com/getodk/collect/commit/a9020465d24bea893ac26f61ab8e9826e6f7bea0", "message": "Fix CheckStyle complaints.", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "8c2d731682f7ca139c8febbb677deb1bc9733637", "url": "https://github.com/getodk/collect/commit/8c2d731682f7ca139c8febbb677deb1bc9733637", "message": "Explain usage of deprecated location API", "committedDate": "2020-06-10T22:54:08Z", "type": "commit"}, {"oid": "185fb950ed7bc1dc92285521c178738f558a150e", "url": "https://github.com/getodk/collect/commit/185fb950ed7bc1dc92285521c178738f558a150e", "message": "Test LocationClientProvider logic", "committedDate": "2020-06-10T23:04:17Z", "type": "commit"}, {"oid": "35ea5e189cb8338eb3cc337d3cc3aba17d062e5a", "url": "https://github.com/getodk/collect/commit/35ea5e189cb8338eb3cc337d3cc3aba17d062e5a", "message": "Separate location provider from accuracy", "committedDate": "2020-06-10T23:04:17Z", "type": "commit"}, {"oid": "80b79d8b390c92e3b09b7c1aff01f09b6b4d6a07", "url": "https://github.com/getodk/collect/commit/80b79d8b390c92e3b09b7c1aff01f09b6b4d6a07", "message": "Remove GPS status listener to avoid leak", "committedDate": "2020-06-10T23:04:17Z", "type": "commit"}, {"oid": "aebecd7b7c5843c7e71a3b9ee90c6a5ee9ba26ba", "url": "https://github.com/getodk/collect/commit/aebecd7b7c5843c7e71a3b9ee90c6a5ee9ba26ba", "message": "Always call onClientStop from stop, never from onConnectionSuspended\n\nAccording to the docs on LocationClientListener.onClientStop, it should always be called when stop() is called. This also matches the AndroidLocationClient implementation. onConnectionSuspended is called when the connection to Google Play Services is lost because, for example, the user stops it. According to the original author of the API, a reconnection attempt will be made: https://stackoverflow.com/a/26147518/137744. I don't think it's appropriate to consider the LocationClient stopped at that point.", "committedDate": "2020-06-10T23:04:17Z", "type": "commit"}, {"oid": "ff5b4e3cf4f4efd1b0467d24761b6bc408f52883", "url": "https://github.com/getodk/collect/commit/ff5b4e3cf4f4efd1b0467d24761b6bc408f52883", "message": "Balance listener setting and unsetting", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "7842edf8f067512ed321165146358f8635f6c6ef", "url": "https://github.com/getodk/collect/commit/7842edf8f067512ed321165146358f8635f6c6ef", "message": "Clear task queue on pause to avoid activity leaks\n\nBecause the timer task calls an activity instance method.", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "d3bb80c8019297c898c28987f7330a8372d49f0a", "url": "https://github.com/getodk/collect/commit/d3bb80c8019297c898c28987f7330a8372d49f0a", "message": "Use application context for GoogleApiClient to avoid leak\n\nThere doesn't seem to be any way to release the context: https://stackoverflow.com/a/36190198/137744", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "b8fc6ed32b1449a29a91ec1f1bcd679dc2935900", "url": "https://github.com/getodk/collect/commit/b8fc6ed32b1449a29a91ec1f1bcd679dc2935900", "message": "Remove GPS from location description", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "fe049fd8bbd09ea8c6137337af976114e57d2005", "url": "https://github.com/getodk/collect/commit/fe049fd8bbd09ea8c6137337af976114e57d2005", "message": "Use Mockito mock instead of test implementation", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "9f7dd64392a87c904c9d9552385c2059a839d7c9", "url": "https://github.com/getodk/collect/commit/9f7dd64392a87c904c9d9552385c2059a839d7c9", "message": "Use supplier for GoogleFusedLocationClient", "committedDate": "2020-06-10T23:04:18Z", "type": "commit"}, {"oid": "9f7dd64392a87c904c9d9552385c2059a839d7c9", "url": "https://github.com/getodk/collect/commit/9f7dd64392a87c904c9d9552385c2059a839d7c9", "message": "Use supplier for GoogleFusedLocationClient", "committedDate": "2020-06-10T23:04:18Z", "type": "forcePushed"}, {"oid": "c619cc7584fd019f49bd6c681351807b07f5c120", "url": "https://github.com/getodk/collect/commit/c619cc7584fd019f49bd6c681351807b07f5c120", "message": "Use LocationClient to get location for OSM Droid", "committedDate": "2020-06-16T20:19:13Z", "type": "commit"}, {"oid": "c619cc7584fd019f49bd6c681351807b07f5c120", "url": "https://github.com/getodk/collect/commit/c619cc7584fd019f49bd6c681351807b07f5c120", "message": "Use LocationClient to get location for OSM Droid", "committedDate": "2020-06-16T20:19:13Z", "type": "forcePushed"}, {"oid": "35c68fcf6703a8fffed1434555f3e0de55b4e1e9", "url": "https://github.com/getodk/collect/commit/35c68fcf6703a8fffed1434555f3e0de55b4e1e9", "message": "Forward location updates to OSM overlay", "committedDate": "2020-06-17T22:33:18Z", "type": "commit"}]}