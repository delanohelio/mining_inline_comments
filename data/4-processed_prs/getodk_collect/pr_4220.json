{"pr_number": 4220, "pr_title": "Allow external recording using `quality` parameter", "pr_createdAt": "2020-11-13T11:16:20Z", "pr_url": "https://github.com/getodk/collect/pull/4220", "timeline": [{"oid": "8beddf4b1600d2e90469672e2948bfc1aa146b0c", "url": "https://github.com/getodk/collect/commit/8beddf4b1600d2e90469672e2948bfc1aa146b0c", "message": "Default to in-app recording", "committedDate": "2020-11-13T11:13:51Z", "type": "commit"}, {"oid": "444f56c473ef7131a67f9f2f9733afc8d2407681", "url": "https://github.com/getodk/collect/commit/444f56c473ef7131a67f9f2f9733afc8d2407681", "message": "Use CollectTestRule", "committedDate": "2020-11-13T11:13:51Z", "type": "commit"}, {"oid": "9f32a8160b865be15a319b9dfeb281ebe474eae3", "url": "https://github.com/getodk/collect/commit/9f32a8160b865be15a319b9dfeb281ebe474eae3", "message": "Use external recording when specified in form", "committedDate": "2020-11-13T11:13:52Z", "type": "commit"}, {"oid": "895d5d86663a79e46540bf84c61656edae11dd28", "url": "https://github.com/getodk/collect/commit/895d5d86663a79e46540bf84c61656edae11dd28", "message": "Add helper for grabbing prompt attribute values", "committedDate": "2020-11-13T11:13:52Z", "type": "commit"}, {"oid": "21048d785da04e9e317c9c9150b35e6d22c5c285", "url": "https://github.com/getodk/collect/commit/21048d785da04e9e317c9c9150b35e6d22c5c285", "message": "Remove external app recording experimental preference", "committedDate": "2020-11-13T11:13:52Z", "type": "commit"}, {"oid": "a4135e1bd10edbe9e1eb8ec9d64ce4bd5bc11711", "url": "https://github.com/getodk/collect/commit/a4135e1bd10edbe9e1eb8ec9d64ce4bd5bc11711", "message": "Remove WaitingForDataRegistry from InternalRecordingRequester", "committedDate": "2020-11-13T11:13:52Z", "type": "commit"}, {"oid": "e310e2a9f176afbfc086b95370e92e821eaa0223", "url": "https://github.com/getodk/collect/commit/e310e2a9f176afbfc086b95370e92e821eaa0223", "message": "Allow enabling external recorder from settings", "committedDate": "2020-11-13T11:13:52Z", "type": "commit"}, {"oid": "7bce7e57344e0f4d203ccfcb98255dbe4445a19e", "url": "https://github.com/getodk/collect/commit/7bce7e57344e0f4d203ccfcb98255dbe4445a19e", "message": "Extract factory for RecordingRequester", "committedDate": "2020-11-13T11:15:41Z", "type": "commit"}, {"oid": "5c04a07ebd6dece5cf5a52fecde5dd266603c5fb", "url": "https://github.com/getodk/collect/commit/5c04a07ebd6dece5cf5a52fecde5dd266603c5fb", "message": "Change attribute name", "committedDate": "2020-11-13T11:15:43Z", "type": "commit"}, {"oid": "4853ea1c4205d775452fb88e688d040e1fc54762", "url": "https://github.com/getodk/collect/commit/4853ea1c4205d775452fb88e688d040e1fc54762", "message": "Make sure form quality param overrides setting", "committedDate": "2020-11-13T11:15:44Z", "type": "commit"}, {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "url": "https://github.com/getodk/collect/commit/7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "message": "Make WidgetFactory an instance in ODKView", "committedDate": "2020-11-13T11:15:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkxMzkzOA==", "url": "https://github.com/getodk/collect/pull/4220#discussion_r522913938", "bodyText": "It felt like it made sense to rearrange this relationship so the ODKView owns a WidgetFactory object. In my mind this makes the dependency clearer.", "author": "seadowg", "createdAt": "2020-11-13T12:16:01Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java", "diffHunk": "@@ -124,35 +127,27 @@\n     PreferencesProvider preferencesProvider;\n \n     @Inject\n-    AudioRecorderViewModelFactory audioRecorderViewModelFactory;\n+    ActivityAvailability activityAvailability;\n+\n+    private final WidgetFactory widgetFactory;", "originalCommit": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDc4Nw==", "url": "https://github.com/getodk/collect/pull/4220#discussion_r523240787", "bodyText": "We talked briefly about using optionals vs sticking to nulls. Are we diving into optionals?", "author": "lognaturel", "createdAt": "2020-11-13T21:26:03Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/FormEntryPromptUtils.java", "diffHunk": "@@ -124,4 +126,13 @@ public static String markQuestionIfIsRequired(String questionText, boolean isReq\n \n         return questionText;\n     }\n+\n+    public static Optional<String> getAttributeValue(FormEntryPrompt prompt, String attributeName) {", "originalCommit": "895d5d86663a79e46540bf84c61656edae11dd28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2NjY3Mw==", "url": "https://github.com/getodk/collect/pull/4220#discussion_r524066673", "bodyText": "Ah yeah good point. I'm in two minds. I think your point below is a good one. Java Optionals really don't add much as calling get is super easy. I think I'm happy to convert the Optional from the stream into a normal type and using Nullable.", "author": "seadowg", "createdAt": "2020-11-16T10:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MTA5Nw==", "url": "https://github.com/getodk/collect/pull/4220#discussion_r523251097", "bodyText": "This feels like a very null structure if you see what I mean. Not really much benefit to an Optional if you're not chaining, for example.", "author": "lognaturel", "createdAt": "2020-11-13T21:51:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/RecordingRequesterFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import androidx.activity.ComponentActivity;\n+import androidx.lifecycle.LifecycleOwner;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.utilities.ActivityAvailability;\n+import org.odk.collect.android.utilities.FormEntryPromptUtils;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.QuestionMediaManager;\n+import org.odk.collect.audiorecorder.recording.AudioRecorderViewModel;\n+\n+import java.util.Optional;\n+\n+public class RecordingRequesterFactory {\n+\n+    private final WaitingForDataRegistry waitingForDataRegistry;\n+    private final QuestionMediaManager questionMediaManager;\n+    private final ActivityAvailability activityAvailability;\n+    private final PermissionUtils permissionUtils;\n+    private final ComponentActivity activity;\n+    private final LifecycleOwner lifecycle;\n+    private final AudioRecorderViewModel audioRecorderViewModel;\n+\n+    public RecordingRequesterFactory(WaitingForDataRegistry waitingForDataRegistry, QuestionMediaManager questionMediaManager, ActivityAvailability activityAvailability, AudioRecorderViewModel audioRecorderViewModel, PermissionUtils permissionUtils, ComponentActivity activity, LifecycleOwner lifecycle) {\n+        this.waitingForDataRegistry = waitingForDataRegistry;\n+        this.questionMediaManager = questionMediaManager;\n+        this.activityAvailability = activityAvailability;\n+        this.audioRecorderViewModel = audioRecorderViewModel;\n+        this.permissionUtils = permissionUtils;\n+        this.activity = activity;\n+        this.lifecycle = lifecycle;\n+    }\n+\n+    public RecordingRequester create(FormEntryPrompt prompt, boolean externalRecorderPreferred) {\n+        Optional<String> audioQuality = FormEntryPromptUtils.getAttributeValue(prompt, \"quality\");\n+\n+        if (audioQuality.isPresent() && (audioQuality.get().equals(\"normal\") || audioQuality.get().equals(\"voice-only\"))) {", "originalCommit": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57d06c891dd0b5e8c802c9bc43f6f129d1dbcb2e", "url": "https://github.com/getodk/collect/commit/57d06c891dd0b5e8c802c9bc43f6f129d1dbcb2e", "message": "Use Nullable instead of Optional", "committedDate": "2020-11-16T10:17:50Z", "type": "commit"}]}