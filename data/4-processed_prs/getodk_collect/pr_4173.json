{"pr_number": 4173, "pr_title": "Add in-app recording", "pr_createdAt": "2020-10-16T13:01:45Z", "pr_url": "https://github.com/getodk/collect/pull/4173", "timeline": [{"oid": "3e869be550b65d5fcca2e15ef8e913f896f5ff7e", "url": "https://github.com/getodk/collect/commit/3e869be550b65d5fcca2e15ef8e913f896f5ff7e", "message": "Fix quality checks", "committedDate": "2020-10-19T12:13:27Z", "type": "forcePushed"}, {"oid": "6e1d311b248dfba63ab08453353878a66e7db4db", "url": "https://github.com/getodk/collect/commit/6e1d311b248dfba63ab08453353878a66e7db4db", "message": "Move strings to module", "committedDate": "2020-10-19T14:23:08Z", "type": "forcePushed"}, {"oid": "b8fbe26ebeccee6c90e33298eb9fdbd395fd3e0a", "url": "https://github.com/getodk/collect/commit/b8fbe26ebeccee6c90e33298eb9fdbd395fd3e0a", "message": "Move strings to module", "committedDate": "2020-10-19T17:05:37Z", "type": "forcePushed"}, {"oid": "c7ad39a171f972f9d02ccdf1331450108c4feb30", "url": "https://github.com/getodk/collect/commit/c7ad39a171f972f9d02ccdf1331450108c4feb30", "message": "Spike out recording", "committedDate": "2020-10-20T08:47:46Z", "type": "commit"}, {"oid": "eaca918f13c02c8836b1dae04da58267320ef9c4", "url": "https://github.com/getodk/collect/commit/eaca918f13c02c8836b1dae04da58267320ef9c4", "message": "Handle crash on clicking back while recording", "committedDate": "2020-10-20T08:47:51Z", "type": "commit"}, {"oid": "08b3290d47214eb0bd56a53a6d36a88e3c993926", "url": "https://github.com/getodk/collect/commit/08b3290d47214eb0bd56a53a6d36a88e3c993926", "message": "Add tests for MediaRecorderRecorder", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "025cc5516aeca34803d198e78d840431476586cc", "url": "https://github.com/getodk/collect/commit/025cc5516aeca34803d198e78d840431476586cc", "message": "Specify quality for recording", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "32aa607888dcb8183b39d46489bef4cb8375cd47", "url": "https://github.com/getodk/collect/commit/32aa607888dcb8183b39d46489bef4cb8375cd47", "message": "Style recording activity", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "4474dd286e7c515cf498d1af718261450d4b69fa", "url": "https://github.com/getodk/collect/commit/4474dd286e7c515cf498d1af718261450d4b69fa", "message": "Remove as much Collect specific code form PermissionUtils as possible\n\nWe're going to need to share this between feature modules", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "cc324a4a5bd18a042a48ceb75bbe97afac1803ca", "url": "https://github.com/getodk/collect/commit/cc324a4a5bd18a042a48ceb75bbe97afac1803ca", "message": "Revise dependency setup", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "47411bbe57f2495443b006ff742855cf22505829", "url": "https://github.com/getodk/collect/commit/47411bbe57f2495443b006ff742855cf22505829", "message": "Move packages around", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "4f02dd0e773f5f338d70b06347f024ea4e7cbec7", "url": "https://github.com/getodk/collect/commit/4f02dd0e773f5f338d70b06347f024ea4e7cbec7", "message": "Seperate out requesting audio file to prevent duplication", "committedDate": "2020-10-20T08:47:52Z", "type": "commit"}, {"oid": "802fb91c9ea0be83705dbbbf83328614ed42142c", "url": "https://github.com/getodk/collect/commit/802fb91c9ea0be83705dbbbf83328614ed42142c", "message": "Handle permissions for recording audio", "committedDate": "2020-10-20T08:47:53Z", "type": "commit"}, {"oid": "4bf4be14c2946bc448ad6a034bc4a5471bf41865", "url": "https://github.com/getodk/collect/commit/4bf4be14c2946bc448ad6a034bc4a5471bf41865", "message": "Extract ViewModel for recording", "committedDate": "2020-10-20T08:47:53Z", "type": "commit"}, {"oid": "23dde5ac42444e4949fdd250a44518b5f465e8b5", "url": "https://github.com/getodk/collect/commit/23dde5ac42444e4949fdd250a44518b5f465e8b5", "message": "Fix quality checks", "committedDate": "2020-10-20T08:47:53Z", "type": "commit"}, {"oid": "79185b126d27517d3c495668dc8d50812d9f7eb2", "url": "https://github.com/getodk/collect/commit/79185b126d27517d3c495668dc8d50812d9f7eb2", "message": "Move strings to module", "committedDate": "2020-10-20T08:47:53Z", "type": "commit"}, {"oid": "79185b126d27517d3c495668dc8d50812d9f7eb2", "url": "https://github.com/getodk/collect/commit/79185b126d27517d3c495668dc8d50812d9f7eb2", "message": "Move strings to module", "committedDate": "2020-10-20T08:47:53Z", "type": "forcePushed"}, {"oid": "879b9c6c34cb43a153b93ddb5ba8450f5e2544fa", "url": "https://github.com/getodk/collect/commit/879b9c6c34cb43a153b93ddb5ba8450f5e2544fa", "message": "Remove ProGuard config from library modules\n\n`collect_app` handles minification so libraries should not minify. The\n`consumer-rules.pro` is for downstream modules.", "committedDate": "2020-10-20T08:59:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzMTE5Mw==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508331193", "bodyText": "We don't need these for library modules", "author": "seadowg", "createdAt": "2020-10-20T09:01:49Z", "path": "audioclips/build.gradle", "diffHunk": "@@ -27,7 +27,6 @@ android {\n     buildTypes {\n         release {\n             minifyEnabled false\n-            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'", "originalCommit": "879b9c6c34cb43a153b93ddb5ba8450f5e2544fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNDY0MA==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508334640", "bodyText": "Let's deal with rotation later as, once we have a Foreground Service responsible for recording, it won't be as big a deal.", "author": "seadowg", "createdAt": "2020-10-20T09:06:49Z", "path": "audiorecorder/src/main/AndroidManifest.xml", "diffHunk": "@@ -0,0 +1,13 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    package=\"org.odk.collect.audiorecorder\">\n+\n+    <application>\n+        <activity\n+            android:name=\".recording.AudioRecorderActivity\"\n+            android:label=\"Audio Recorder\"\n+            android:screenOrientation=\"portrait\"", "originalCommit": "879b9c6c34cb43a153b93ddb5ba8450f5e2544fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "329d2dc2167c2ce2284323e71929493d35122bec", "url": "https://github.com/getodk/collect/commit/329d2dc2167c2ce2284323e71929493d35122bec", "message": "Add comment to explain dagger weirdness", "committedDate": "2020-10-20T16:26:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MjI1OA==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508672258", "bodyText": "This file provides a pretty minimal (for Dagger) DI setup. We could come up with something more complex to attach the component to the Application object which would mean we wouldn't run into static state problems (see the code comment below) but I don't think we need to go there yet.", "author": "seadowg", "createdAt": "2020-10-20T16:28:54Z", "path": "audiorecorder/src/main/java/org/odk/collect/audiorecorder/Config.kt", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.odk.collect.audiorecorder\n+\n+import android.app.Activity\n+import android.app.Application\n+import android.media.MediaRecorder\n+import dagger.BindsInstance\n+import dagger.Component\n+import dagger.Module\n+import dagger.Provides\n+import org.odk.collect.audiorecorder.recorder.MediaRecorderRecorder\n+import org.odk.collect.audiorecorder.recorder.RealMediaRecorderWrapper\n+import org.odk.collect.audiorecorder.recorder.Recorder\n+import org.odk.collect.audiorecorder.recording.AudioRecorderActivity\n+\n+private var _component: AudioRecorderDependencyComponent? = null", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3Mjc4Mg==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508672782", "bodyText": "This interface brought to you by a slightly funky looking ShadowMediaRecorder and the \"don't mock/fake/stub things you don't own\" rule.", "author": "seadowg", "createdAt": "2020-10-20T16:29:38Z", "path": "audiorecorder/src/main/java/org/odk/collect/audiorecorder/recorder/MediaRecorderWrapper.kt", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.odk.collect.audiorecorder.recorder\n+\n+import android.media.MediaRecorder\n+\n+/**\n+ * Allows faking/stubbing/mocking with our interactions with Android's MediaRecorder\n+ */\n+\n+interface MediaRecorderWrapper {", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3NDI0NQ==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508674245", "bodyText": "I went with a fake rather than a mock here as it lets me capture the importance of the method call order (prepare before start for example) without having to specify exactly what order things are called in.", "author": "seadowg", "createdAt": "2020-10-20T16:31:44Z", "path": "audiorecorder/src/test/java/org/odk/collect/audiorecorder/recording/MediaRecorderRecorderTest.kt", "diffHunk": "@@ -0,0 +1,224 @@\n+package org.odk.collect.audiorecorder.recording\n+\n+import android.media.MediaRecorder\n+import com.google.common.io.Files\n+import org.hamcrest.MatcherAssert.assertThat\n+import org.hamcrest.Matchers.equalTo\n+import org.hamcrest.Matchers.not\n+import org.junit.Test\n+import org.odk.collect.audiorecorder.recorder.MediaRecorderRecorder\n+import org.odk.collect.audiorecorder.recorder.MediaRecorderWrapper\n+import java.io.File\n+\n+class MediaRecorderRecorderTest {\n+\n+    private val cacheDir = Files.createTempDir()\n+    private val mediaRecorder = FakeMediaRecorderWrapper()\n+    private val recorder = MediaRecorderRecorder(cacheDir) { mediaRecorder }\n+\n+    @Test\n+    fun start_startsMediaRecorder() {\n+        recorder.start()\n+        assertThat(mediaRecorder.hasStarted(), equalTo(true))\n+    }\n+\n+    @Test\n+    fun start_setsUpAACRecordingFromMic() {\n+        recorder.start()\n+\n+        assertThat(mediaRecorder.getAudioEncoder(), equalTo(MediaRecorder.AudioEncoder.AAC))\n+        assertThat(mediaRecorder.getAudioEncodingSampleRate(), equalTo(32000))\n+        assertThat(mediaRecorder.getAudioEncodingBitRate(), equalTo(128000))\n+        assertThat(mediaRecorder.getOutputFormat(), equalTo(MediaRecorder.OutputFormat.MPEG_4))\n+\n+        assertThat(mediaRecorder.getAudioSource(), equalTo(MediaRecorder.AudioSource.MIC))\n+    }\n+\n+    @Test\n+    fun start_createsAndRecordsToFileInCacheDir() {\n+        recorder.start()\n+        assertThat(mediaRecorder.getOutputFile()!!.parent, equalTo(cacheDir.absolutePath))\n+    }\n+\n+    @Test\n+    fun recordingTwice_doesntUseSameOutputFile() {\n+        var mediaRecorder = FakeMediaRecorderWrapper()\n+        var recorder = MediaRecorderRecorder(cacheDir) { mediaRecorder }\n+        recorder.start()\n+        val outputFile1 = mediaRecorder.getOutputFile()\n+\n+        mediaRecorder = FakeMediaRecorderWrapper()\n+        recorder = MediaRecorderRecorder(cacheDir) { mediaRecorder }\n+        recorder.start()\n+        val outputFile2 = mediaRecorder.getOutputFile()\n+\n+        assertThat(outputFile1!!.absolutePath, not(equalTo(outputFile2!!.absolutePath)))\n+    }\n+\n+    @Test\n+    fun stop_releasesMediaRecorder() {\n+        recorder.start()\n+        recorder.stop()\n+        assertThat(mediaRecorder.isReleased(), equalTo(true))\n+    }\n+\n+    @Test\n+    fun stop_returnsOutputFile() {\n+        recorder.start()\n+        val file = recorder.stop()\n+        assertThat(file.absolutePath, equalTo(mediaRecorder.getOutputFile()!!.absolutePath))\n+    }\n+\n+    @Test\n+    fun cancel_releasesMediaRecorder() {\n+        recorder.start()\n+        recorder.cancel()\n+        assertThat(mediaRecorder.isReleased(), equalTo(true))\n+    }\n+\n+    @Test\n+    fun cancel_deletesOutputFile() {\n+        recorder.start()\n+        recorder.cancel()\n+        assertThat(mediaRecorder.getOutputFile()!!.exists(), equalTo(false))\n+    }\n+\n+    @Test\n+    fun cancel_beforeStart_works() {\n+        recorder.cancel()\n+    }\n+}\n+\n+private class FakeMediaRecorderWrapper : MediaRecorderWrapper {", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3NTg2NQ==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r508675865", "bodyText": "I didn't end up having to pull this out to its own module but I like the changes I made to it in preparation so kept them in.", "author": "seadowg", "createdAt": "2020-10-20T16:34:21Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/PermissionUtils.java", "diffHunk": "@@ -41,6 +33,12 @@\n \n public class PermissionUtils {", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg2Mzg1Ng==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r509863856", "bodyText": "Use var", "author": "lognaturel", "createdAt": "2020-10-22T03:51:48Z", "path": "audiorecorder/build.gradle", "diffHunk": "@@ -0,0 +1,54 @@\n+apply plugin: 'com.android.library'\n+apply plugin: 'kotlin-android'\n+apply plugin: 'kotlin-android-extensions'\n+apply plugin: 'kotlin-kapt'\n+\n+android {\n+    compileSdkVersion 30", "originalCommit": "c7ad39a171f972f9d02ccdf1331450108c4feb30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNDU1Mg==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r510134552", "bodyText": "Oops!", "author": "seadowg", "createdAt": "2020-10-22T12:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg2Mzg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg2OTk5Ng==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r509869996", "bodyText": "I don\u2019t get this. Might be good to talk through it and see if we can clarify.", "author": "lognaturel", "createdAt": "2020-10-22T04:17:25Z", "path": "audiorecorder/src/main/java/org/odk/collect/audiorecorder/Config.kt", "diffHunk": "@@ -14,6 +14,10 @@ import org.odk.collect.audiorecorder.recording.AudioRecorderActivity\n \n private var _component: AudioRecorderDependencyComponent? = null\n \n+/**", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3Njk1OA==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r509876958", "bodyText": "What do you think about flipping this and going with \"Use external app for audio recording\" (true by default)? That way it most likely won't need to be translated again. We can absolutely change the wording if we find we need to but at least we send something to translators that's likely to stick around.", "author": "lognaturel", "createdAt": "2020-10-22T04:46:23Z", "path": "strings/src/main/res/values/strings.xml", "diffHunk": "@@ -705,4 +705,7 @@\n     <string name=\"security_error\">Collect can\\'t connect securely to the server at %s. Did you enter the URL correctly?</string>\n     <string name=\"failure\">Failure</string>\n     <string name=\"form_update_succeeded\">Form update succeeded</string>\n+    <string name=\"in_app_recording\">Use in-app audio recording</string>", "originalCommit": "329d2dc2167c2ce2284323e71929493d35122bec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNjQ5Nw==", "url": "https://github.com/getodk/collect/pull/4173#discussion_r510136497", "bodyText": "Good idea!", "author": "seadowg", "createdAt": "2020-10-22T12:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3Njk1OA=="}], "type": "inlineReview"}, {"oid": "2ae1e20aed5e973615e7b57d6bef49f68e4162ad", "url": "https://github.com/getodk/collect/commit/2ae1e20aed5e973615e7b57d6bef49f68e4162ad", "message": "Use variables for SDK versions", "committedDate": "2020-10-22T12:53:50Z", "type": "commit"}, {"oid": "b4e7f0e9e8d445769dee66aa818017356a14c0fa", "url": "https://github.com/getodk/collect/commit/b4e7f0e9e8d445769dee66aa818017356a14c0fa", "message": "Flip experimental flag", "committedDate": "2020-10-22T13:08:14Z", "type": "commit"}, {"oid": "3d009b44f2003bca402a5489aae813335d6b6f7c", "url": "https://github.com/getodk/collect/commit/3d009b44f2003bca402a5489aae813335d6b6f7c", "message": "Try and improve comment", "committedDate": "2020-10-22T15:34:04Z", "type": "commit"}]}