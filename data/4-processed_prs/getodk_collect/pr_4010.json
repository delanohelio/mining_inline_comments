{"pr_number": 4010, "pr_title": "Fix deleting Instances of Forms without version", "pr_createdAt": "2020-08-04T11:20:17Z", "pr_url": "https://github.com/getodk/collect/pull/4010", "timeline": [{"oid": "6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed", "url": "https://github.com/getodk/collect/commit/6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed", "message": "Make sure forms instances without versions can be deleted", "committedDate": "2020-08-04T10:38:18Z", "type": "commit"}, {"oid": "ed3a4c75b4c5a575ead7a50e867bcc125558a970", "url": "https://github.com/getodk/collect/commit/ed3a4c75b4c5a575ead7a50e867bcc125558a970", "message": "Remove Robolectric from InMemFormsRepositoryTest", "committedDate": "2020-08-04T10:54:40Z", "type": "commit"}, {"oid": "b687fac1933878706b11c31b7819402c59d399c8", "url": "https://github.com/getodk/collect/commit/b687fac1933878706b11c31b7819402c59d399c8", "message": "Remove dependency on StoragePathProvider from Form.Builder", "committedDate": "2020-08-04T11:01:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNTAxNg==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465005016", "bodyText": "Given that the error here was the SQL query being constructed incorrectly it felt like the right time to start adding tests. Using a contract testing pattern like we're doing here lets us verify that our \"real\" (DatabaseFormsRepository) and \"fake\" (InMemFormsRepository) both pass the same set of tests. This lets us be more confident that we can switch the \"real\" object for the \"fake\" object in tests.", "author": "seadowg", "createdAt": "2020-08-04T12:13:35Z", "path": "collect_app/src/test/java/org/odk/collect/android/forms/FormsRepositoryTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.odk.collect.android.forms;\n+\n+import org.junit.Test;\n+import org.odk.collect.android.utilities.FileUtils;\n+\n+import java.io.File;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public abstract class FormsRepositoryTest {\n+\n+    public abstract FormsRepository buildSubject();\n+\n+    public abstract String getFormFilesPath();\n+\n+    @Test\n+    public void get_whenFormHasNullVersion_returnsForm() {", "originalCommit": "b687fac1933878706b11c31b7819402c59d399c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNzU3Nw==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465337577", "bodyText": "I think another option would be to let the dao layer deal with queries and do testing at that level.", "author": "lognaturel", "createdAt": "2020-08-04T21:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNTAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNjA5NQ==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465006095", "bodyText": "It felt wrong that the Form object should have to care about storage details, so I removed this dependency. This also made it simpler to write tests for the InMemFormsRepository (which was my clue that something could be improved).", "author": "seadowg", "createdAt": "2020-08-04T12:15:33Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/Form.java", "diffHunk": "@@ -136,7 +137,7 @@ public Builder jrVersion(String jrVersion) {\n         }\n \n         public Builder formFilePath(String formFilePath) {\n-            this.formFilePath = new StoragePathProvider().getFormDbPath(formFilePath);", "originalCommit": "b687fac1933878706b11c31b7819402c59d399c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNjYzMg==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465336632", "bodyText": "Feels too bad to have a mix of raw queries passed in to the dao layer and higher-level calls on the dao. Wouldn't getFormsCursorSortedByDateDesc do what you need here?", "author": "lognaturel", "createdAt": "2020-08-04T21:19:31Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormsRepository.java", "diffHunk": "@@ -40,16 +40,16 @@ public boolean contains(String jrFormId) {\n     @Nullable\n     @Override\n     public Form get(Long id) {\n-        try (Cursor cursor = new FormsDao().getFormsCursor(_ID + \"=?\", new String[]{id.toString()})) {\n-            return getFormOrNull(cursor);\n-        }\n+        return queryForForm(_ID + \"=?\", new String[]{id.toString()});\n     }\n \n     @Nullable\n     @Override\n-    public Form get(String jrFormId, String jrVersion) {\n-        try (Cursor cursor = new FormsDao().getFormsCursor(JR_FORM_ID + \"=? AND \" + JR_VERSION + \"=?\", new String[]{jrFormId, jrVersion})) {\n-            return getFormOrNull(cursor);\n+    public Form get(String jrFormId, @Nullable String jrVersion) {\n+        if (jrVersion != null) {", "originalCommit": "6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU3ODIzMA==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465578230", "bodyText": "You're right we should be clearer around which way we're going here: Are we wrapping the Dao or trying to remove it and wrapping the content provider? Personally I'm leaning towards the latter.\nTo your comment below (as it's related and I can't reply for some reason): I think I'd like to have testing around the repositories as I would envision us being able to create a new one (using Room for example) and we'd be able to just add another FormRepositoryTest to drive that out. Right now the actual test is completely divorced from the querying/storage.\nMaybe it makes sense to follow up with a PR trying to inline as much of the Dao as possible into the repo? That's conditional on us agreeing that's the direction we want to go of course!", "author": "seadowg", "createdAt": "2020-08-05T08:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNjYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2Njg5MQ==", "url": "https://github.com/getodk/collect/pull/4010#discussion_r466066891", "bodyText": "Ah yes, right, I forgot that we have too many layers going on. I agree that a goal would be to remove the existing DAO layer. I think that for now making the repositories use the content providers makes sense. If we were to switch to something like using Room, I think we'd flip that around. But doesn't matter for now.", "author": "lognaturel", "createdAt": "2020-08-05T23:54:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNjYzMg=="}], "type": "inlineReview"}]}