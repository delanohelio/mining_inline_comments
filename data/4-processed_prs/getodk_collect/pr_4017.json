{"pr_number": 4017, "pr_title": "Fixed auto-delete and auto-sent options", "pr_createdAt": "2020-08-07T14:16:40Z", "pr_url": "https://github.com/getodk/collect/pull/4017", "timeline": [{"oid": "f2f0317284716d2648ef9d232fc4f8f66bfac4cd", "url": "https://github.com/getodk/collect/commit/f2f0317284716d2648ef9d232fc4f8f66bfac4cd", "message": "Added tests", "committedDate": "2020-08-13T10:18:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r469955109", "bodyText": "Could this not just always call formSubmitMananer.scheduleSubmit() at this point? I might have missed something but I think the InstanceSubmitter (that the AutoSendTaskSpec will use will do the right thing and only send if it needs to.\nIf that's the case we could just test InstanceSubmitter rather than the static method (as it will be the only place we make that decision).", "author": "seadowg", "createdAt": "2020-08-13T13:34:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -1887,7 +1887,7 @@ private void handleSaveResult(FormSaveViewModel.SaveResult result) {\n                         // finalized specifies that it should always be auto-sent.\n                         String formId = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"id\");\n                         String formVersion = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"version\");\n-                        if (InstanceUploaderUtils.formShouldBeAutoSent(formsRepository, formId, formVersion, GeneralSharedPreferences.isAutoSendEnabled())) {\n+                        if (InstanceUploaderUtils.shouldFormBeSent(formsRepository, formId, formVersion, GeneralSharedPreferences.isAutoSendEnabled())) {", "originalCommit": "7ddfd2b3d5c92019c29fc55704ba1489abfcefd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNDgyOQ==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r471324829", "bodyText": "I was thinking about it as well. I didn't change it because I think it would change the default behavior a bit. Now autosend is triggered if we save a form that requires it, that's why we have that check (InstanceUploaderUtils.shouldFormBeSent()). If we get rid of it it will be triggered even if just one of already saved forms requires autosend.", "author": "grzesiek2010", "createdAt": "2020-08-17T08:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMyNjE0MA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r471326140", "bodyText": "I know it's misleading because if you save a form that requires autosend the app will also send other already saved forms that require it too but it doesn't work the other way around - even if all already saved forms require autosend but the one you save in this step doesn't it won't be triggered. Probably we should rethink it @lognaturel", "author": "grzesiek2010", "createdAt": "2020-08-17T08:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzODUxOQ==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r471838519", "bodyText": "I think (hope?) in most cases the distinction won't matter because the instance currently being saved will be the only one available for auto submission.\nOne extreme case is if there are multiple submissions that are hanging around and systematically fail AND there's a form in play that doesn't auto send. In that case there's some advantage to the existing check. That doesn't seem very likely to me so I'd be ok with the simpler implementation.", "author": "lognaturel", "createdAt": "2020-08-18T00:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5NjcxOA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r472996718", "bodyText": "Ok I removed that check and moved shouldFormBeSent() to InstanceSubmitter. However shouldFormBeDeleted() is still placed in InstanceUploaderUtils because it's used from different classes (InstanceUploaderTask). I noticed that the code between that InstanceUploaderTask and InstanceSubmitter is duplicated so probably it would be good to refactor it using InstanceSubmitter in InstanceUploaderTask maybe? Then both shouldFormBeSent() and shouldFormBeDeleted() would be placed in just one class (InstanceSubmitter). What do you think? Maybe as a separate pr if you agree?", "author": "grzesiek2010", "createdAt": "2020-08-19T12:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NzM1OQ==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r469957359", "bodyText": "Might be nice to have these static methods in a new InstanceUtils class in either instancemanagement or instances. I can see us pulling the other methods out at some point (maybe as part of #3988).", "author": "seadowg", "createdAt": "2020-08-13T13:38:04Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/InstanceUploaderUtils.java", "diffHunk": "@@ -154,7 +154,7 @@ public static boolean formShouldBeAutoSent(FormsRepository formsRepository, Stri\n      *\n      * If the form explicitly sets the auto-delete property, then it overrides the preference.\n      */\n-    public static boolean formShouldBeAutoDeleted(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoDeleteAppSettingEnabled) {\n+    public static boolean shouldFormBeDeleted(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoDeleteAppSettingEnabled) {", "originalCommit": "7ddfd2b3d5c92019c29fc55704ba1489abfcefd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ede48c7ef798dfe89d862bd2a8d045a4b68995d", "url": "https://github.com/getodk/collect/commit/4ede48c7ef798dfe89d862bd2a8d045a4b68995d", "message": "Improved getInstancesToAutoSend() method", "committedDate": "2020-08-19T10:13:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgxMTI3OA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r473811278", "bodyText": "I think this is meant to be private", "author": "seadowg", "createdAt": "2020-08-20T09:28:45Z", "path": "collect_app/src/main/java/org/odk/collect/android/instancemanagement/InstanceSubmitter.java", "diffHunk": "@@ -35,20 +35,26 @@\n import timber.log.Timber;\n \n import static org.odk.collect.android.analytics.AnalyticsEvents.SUBMISSION;\n-import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.AUTO_SEND;\n import static org.odk.collect.android.utilities.InstanceUploaderUtils.SPREADSHEET_UPLOADED_TO_GOOGLE_DRIVE;\n \n public class InstanceSubmitter {\n \n     private final Analytics analytics;\n+    private final FormsRepository formsRepository;\n+    private final InstancesRepository instancesRepository;\n \n-    public InstanceSubmitter(Analytics analytics) {\n+    public InstanceSubmitter(Analytics analytics, FormsRepository formsRepository, InstancesRepository instancesRepository) {\n         this.analytics = analytics;\n+        this.formsRepository = formsRepository;\n+        this.instancesRepository = instancesRepository;\n     }\n \n     public Pair<Boolean, String> submitUnsubmittedInstances() throws SubmitException {\n         List<Instance> toUpload = getInstancesToAutoSend(GeneralSharedPreferences.isAutoSendEnabled());\n+        return submitSelectedInstances(toUpload);\n+    }\n \n+    public Pair<Boolean, String> submitSelectedInstances(List<Instance> toUpload) throws SubmitException {", "originalCommit": "f79962e56fd5c4c7c65400c436e8968a67ed7448", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3Njk0NA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r474676944", "bodyText": "I thought about future and refactoring the code where we could use this method from InstanceUploaderTask because as I sad there are duplicated code here and in that class.", "author": "grzesiek2010", "createdAt": "2020-08-21T12:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgxMTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY5MjM2NA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r474692364", "bodyText": "Ah I see. I would tend to leave this private until then. It might be that when we make that change it would make sense for this logic to move to a different object that's responsible for submitting a single instance and then have this object use that which nicely separates collecting the instances to auto submit from the logic to actually submit one. Not a big deal for the moment though!", "author": "seadowg", "createdAt": "2020-08-21T13:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgxMTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyMDI4MA==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r473820280", "bodyText": "In my head this would ideally be a private method that is just an implementation detail of InstanceSubmitter. The InstanceSubmitter would then have tests around it that setup instances and check that they are sent in the right contexts. Looking at though there is a lot of dependencies on static calls we'd need to pull out to write that test (Collect.getInsance().getComponent() and GeneralSharedPreferences.isAutoSendEnabled() for example). This PR moves the needle forward so I don't think it makes sense to block it on that rework.\nCould you maybe just add a @Deprecated to this method and a @deprecated Javadoc explaining that really it should be a private method and that that requires refactoring InstanceSubmitter to make it testable/modular?", "author": "seadowg", "createdAt": "2020-08-20T09:39:28Z", "path": "collect_app/src/main/java/org/odk/collect/android/instancemanagement/InstanceSubmitter.java", "diffHunk": "@@ -147,19 +149,11 @@ public InstanceSubmitter(Analytics analytics) {\n      *\n      * @param isAutoSendAppSettingEnabled whether the auto-send option is enabled at the app level\n      */\n-    public static boolean formShouldBeAutoSent(String jrFormId, boolean isAutoSendAppSettingEnabled) {\n-        Cursor cursor = new FormsDao().getFormsCursorForFormId(jrFormId);\n-        String formLevelAutoSend = null;\n-        if (cursor != null && cursor.moveToFirst()) {\n-            try {\n-                int autoSendColumnIndex = cursor.getColumnIndex(AUTO_SEND);\n-                formLevelAutoSend = cursor.getString(autoSendColumnIndex);\n-            } finally {\n-                cursor.close();\n-            }\n+    public static boolean shouldFormBeSent(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoSendAppSettingEnabled) {", "originalCommit": "f79962e56fd5c4c7c65400c436e8968a67ed7448", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3OTM4Mw==", "url": "https://github.com/getodk/collect/pull/4017#discussion_r474679383", "bodyText": "Ok, done.", "author": "grzesiek2010", "createdAt": "2020-08-21T12:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyMDI4MA=="}], "type": "inlineReview"}, {"oid": "2457f502f3d48122ace612760d9693634dcff68f", "url": "https://github.com/getodk/collect/commit/2457f502f3d48122ace612760d9693634dcff68f", "message": "Fixed auto-delete functionality", "committedDate": "2020-09-03T13:12:11Z", "type": "commit"}, {"oid": "e38767f11062cc402ae5305a0c4e3c57e187e103", "url": "https://github.com/getodk/collect/commit/e38767f11062cc402ae5305a0c4e3c57e187e103", "message": "Fixed auto-sent functionality", "committedDate": "2020-09-03T13:12:11Z", "type": "commit"}, {"oid": "f478e3ea254ebf9b4666165c927498c61d928f63", "url": "https://github.com/getodk/collect/commit/f478e3ea254ebf9b4666165c927498c61d928f63", "message": "Code improvements", "committedDate": "2020-09-03T13:15:41Z", "type": "commit"}, {"oid": "3cc008570c036f216293de667023d4d16663b7a9", "url": "https://github.com/getodk/collect/commit/3cc008570c036f216293de667023d4d16663b7a9", "message": "Naming improvements", "committedDate": "2020-09-03T13:15:41Z", "type": "commit"}, {"oid": "d8b26c6c291301cde130d57b08b395ca39030798", "url": "https://github.com/getodk/collect/commit/d8b26c6c291301cde130d57b08b395ca39030798", "message": "Added tests", "committedDate": "2020-09-03T13:15:41Z", "type": "commit"}, {"oid": "f181bc7f181d557d3f44da4ca3cccb45e68cce6a", "url": "https://github.com/getodk/collect/commit/f181bc7f181d557d3f44da4ca3cccb45e68cce6a", "message": "improved the code responsible for generating UploadResultMessage and moved tests from android to unit", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "4524838c971a8c608716817df693525fad903a5c", "url": "https://github.com/getodk/collect/commit/4524838c971a8c608716817df693525fad903a5c", "message": "Code improvements", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "ef2b4e6aa74eb62ebd25f4f3c1ee7021319c392c", "url": "https://github.com/getodk/collect/commit/ef2b4e6aa74eb62ebd25f4f3c1ee7021319c392c", "message": "Fixed checkstyle", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "c9a7da39afc21f6e177f6f2d14e2402fb2f7ac1c", "url": "https://github.com/getodk/collect/commit/c9a7da39afc21f6e177f6f2d14e2402fb2f7ac1c", "message": "Fixed reading id and version from formController", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "1fc37547add48212f8da6b291a620f654caa257a", "url": "https://github.com/getodk/collect/commit/1fc37547add48212f8da6b291a620f654caa257a", "message": "Try to trigger autosend every time a form is saved", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "de91a2385cf6153b476cf04164950c7d9c73b705", "url": "https://github.com/getodk/collect/commit/de91a2385cf6153b476cf04164950c7d9c73b705", "message": "Added submitSelectedInstances() in InstanceSubmitter to use it in the future from uploader tasks", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "f79477472654a873044af4b68d8e9ee2a6543744", "url": "https://github.com/getodk/collect/commit/f79477472654a873044af4b68d8e9ee2a6543744", "message": "Improved getInstancesToAutoSend() method", "committedDate": "2020-09-03T13:19:09Z", "type": "commit"}, {"oid": "76223866fc49ae7df45ad86a1c45ef5c026db5d7", "url": "https://github.com/getodk/collect/commit/76223866fc49ae7df45ad86a1c45ef5c026db5d7", "message": "Moved shouldFormBeSent() to InstanceSubmitter", "committedDate": "2020-09-03T13:19:39Z", "type": "commit"}, {"oid": "a899c5f1e8ec901ec02224587afb45c9c0e96a0e", "url": "https://github.com/getodk/collect/commit/a899c5f1e8ec901ec02224587afb45c9c0e96a0e", "message": "removed redundant code", "committedDate": "2020-09-03T13:19:39Z", "type": "commit"}, {"oid": "1ff118f5022665d49ae06418139597404a9a42a8", "url": "https://github.com/getodk/collect/commit/1ff118f5022665d49ae06418139597404a9a42a8", "message": "Code improvements", "committedDate": "2020-09-03T13:19:39Z", "type": "commit"}, {"oid": "d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "url": "https://github.com/getodk/collect/commit/d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "message": "Fixed conflicts", "committedDate": "2020-09-03T13:34:27Z", "type": "forcePushed"}, {"oid": "8bc5dc50df75976b4d2bb565fedab7641a0e295d", "url": "https://github.com/getodk/collect/commit/8bc5dc50df75976b4d2bb565fedab7641a0e295d", "message": "Fixed conflicts", "committedDate": "2020-09-03T13:54:44Z", "type": "commit"}, {"oid": "8bc5dc50df75976b4d2bb565fedab7641a0e295d", "url": "https://github.com/getodk/collect/commit/8bc5dc50df75976b4d2bb565fedab7641a0e295d", "message": "Fixed conflicts", "committedDate": "2020-09-03T13:54:44Z", "type": "forcePushed"}]}