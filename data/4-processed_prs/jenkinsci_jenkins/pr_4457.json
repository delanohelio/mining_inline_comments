{"pr_number": 4457, "pr_title": "[JENKINS-60866] Un-inline restarts pages", "pr_createdAt": "2020-01-26T13:32:37Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4457", "timeline": [{"oid": "2f4803caf614427a5d7135753c068f6c92ad8818", "url": "https://github.com/jenkinsci/jenkins/commit/2f4803caf614427a5d7135753c068f6c92ad8818", "message": "[JENKINS-60866] Un-inline restarts pages", "committedDate": "2020-01-26T13:22:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNjg3Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r371426877", "bodyText": "The content-type, initialization of hudson.Functions, and this line, can all be replaced by using <l:view> around this view.", "author": "jvz", "createdAt": "2020-01-27T19:09:05Z", "path": "core/src/main/resources/hudson/lifecycle/WindowsInstallerLink/_restart.jelly", "diffHunk": "@@ -21,21 +21,44 @@ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n -->\n-\n <?jelly escape-by-default='true'?>\n-<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:d=\"jelly:define\" xmlns:l=\"/lib/layout\" xmlns:t=\"/lib/hudson\" xmlns:f=\"/lib/form\">\n-  <st:statusCode value=\"503\" /><!-- SERVICE NOT AVAILABLE -->\n-  <l:layout permission=\"${app.ADMINISTER}\">\n-    <st:include it=\"${app}\" page=\"sidepanel.jelly\" />\n-    <l:main-panel>\n-      <h1 style=\"margin-top:4em\">\n-        ${%Please wait while Jenkins is restarting}<span id=\"progress\">...</span>\n-      </h1>\n-      <p style=\"color:gray;\">\n-        ${%blurb}\n-      </p>\n-      \n-      <script>applySafeRedirector('${rootURL}/')</script>\n-    </l:main-panel>\n-  </l:layout>\n-</j:jelly>\n\\ No newline at end of file\n+<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:x=\"jelly:xml\">\n+    <j:new var=\"h\" className=\"hudson.Functions\" />\n+    <st:statusCode value=\"503\" /><!-- SERVICE NOT AVAILABLE -->\n+    <st:header name=\"Expires\" value=\"0\" />\n+    <st:header name=\"Cache-Control\" value=\"no-cache,no-store,must-revalidate\" />\n+    <!-- response contentType header -->\n+    <st:contentType value=\"text/html;charset=UTF-8\" />\n+    <!-- get default/common page variable -->\n+    ${h.initPageVariables(context)}", "originalCommit": "2f4803caf614427a5d7135753c068f6c92ad8818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTAzNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r376801035", "bodyText": "I will not take the risk to break something here as the goal is only to un-inline scripts / styles. It makes perfectly sense to follow-up with such changes", "author": "Wadeck", "createdAt": "2020-02-09T17:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNjg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNzI1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r371427256", "bodyText": "Same for this page; it should use <l:view> (not sure how this one got missed back when that tag was introduced).", "author": "jvz", "createdAt": "2020-01-27T19:09:58Z", "path": "core/src/main/resources/hudson/util/HudsonIsLoading/index.jelly", "diffHunk": "@@ -21,26 +21,24 @@ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n -->\n-\n <?jelly escape-by-default='true'?>\n-\n-<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:x=\"jelly:xml\" xmlns:f=\"/lib/form\">\n+<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:x=\"jelly:xml\">\n     <j:new var=\"h\" className=\"hudson.Functions\" />\n-    <st:statusCode value=\"503\"/><!-- SERVICE NOT AVAILABLE -->\n-    <st:setHeader name=\"Expires\" value=\"0\"/>\n-    <st:setHeader name=\"Cache-Control\" value=\"no-cache,no-store,must-revalidate\"/>\n+    <st:statusCode value=\"503\" /><!-- SERVICE NOT AVAILABLE -->\n+    <st:header name=\"Expires\" value=\"0\" />\n+    <st:header name=\"Cache-Control\" value=\"no-cache,no-store,must-revalidate\" />\n     <!-- response contentType header -->\n-    <st:contentType value=\"text/html;charset=UTF-8\"/>\n+    <st:contentType value=\"text/html;charset=UTF-8\" />", "originalCommit": "2f4803caf614427a5d7135753c068f6c92ad8818", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNzM3MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r371427370", "bodyText": "And here.", "author": "jvz", "createdAt": "2020-01-27T19:10:12Z", "path": "core/src/main/resources/hudson/util/HudsonIsRestarting/index.jelly", "diffHunk": "@@ -21,26 +21,24 @@ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n -->\n-\n <?jelly escape-by-default='true'?>\n-\n-<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:x=\"jelly:xml\" xmlns:f=\"/lib/form\">\n+<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:x=\"jelly:xml\">\n     <j:new var=\"h\" className=\"hudson.Functions\" />\n-    <st:statusCode value=\"503\"/><!-- SERVICE NOT AVAILABLE -->\n-    <st:setHeader name=\"Expires\" value=\"0\"/>\n-    <st:setHeader name=\"Cache-Control\" value=\"no-cache,no-store,must-revalidate\"/>\n+    <st:statusCode value=\"503\" /><!-- SERVICE NOT AVAILABLE -->\n+    <st:header name=\"Expires\" value=\"0\" />\n+    <st:header name=\"Cache-Control\" value=\"no-cache,no-store,must-revalidate\" />\n     <!-- response contentType header -->\n-    <st:contentType value=\"text/html;charset=UTF-8\"/>\n+    <st:contentType value=\"text/html;charset=UTF-8\" />", "originalCommit": "2f4803caf614427a5d7135753c068f6c92ad8818", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MDkzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r372850930", "bodyText": "@Wadeck last time I looked at self-closing script tag, it wasn't supported by all web browsers. I know, makes no sense (html != xml), but just to be sure, did you test it?\nFirst comment about that I can find is from 2013... but basically it would be because script can have a src and code in its body. So the closing tag seems to be mandatory.\nThis might also apply to div you have on line 50 as well.", "author": "alecharp", "createdAt": "2020-01-30T09:52:10Z", "path": "core/src/main/resources/hudson/util/HudsonIsRestarting/index.jelly", "diffHunk": "@@ -60,8 +58,7 @@ THE SOFTWARE.\n                     </div>\n                 </div>\n             </div>\n-            <script src=\"${resURL}/scripts/loading.js\" type=\"text/javascript\"></script>\n-            <script>safeRedirector(window.location.href);</script>\n+            <script src=\"${resURL}/scripts/loading.js\" type=\"text/javascript\" />", "originalCommit": "2f4803caf614427a5d7135753c068f6c92ad8818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAwMDE5NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r373000195", "bodyText": "It would be an invalid script tag in Jelly without a closing tag or self close. I'm not sure how Jelly outputs these types of tags in HTML, though.", "author": "jvz", "createdAt": "2020-01-30T15:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MDkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTY3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r376801678", "bodyText": "After your comment I looked for <script.*/> and found 18 matches in jenkins-core. If it was not working, the non-supporting browser will already have troubles :) (and +25 for div)\nI can change them if you're not confident with the existing code.", "author": "Wadeck", "createdAt": "2020-02-09T17:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MDkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTczODY5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r375738694", "bodyText": "Checking permissions is not necessary any more?", "author": "varyvol", "createdAt": "2020-02-06T09:58:21Z", "path": "core/src/main/resources/hudson/lifecycle/WindowsInstallerLink/_restart.jelly", "diffHunk": "@@ -21,21 +21,44 @@ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n -->\n-\n <?jelly escape-by-default='true'?>\n-<j:jelly xmlns:j=\"jelly:core\" xmlns:st=\"jelly:stapler\" xmlns:d=\"jelly:define\" xmlns:l=\"/lib/layout\" xmlns:t=\"/lib/hudson\" xmlns:f=\"/lib/form\">\n-  <st:statusCode value=\"503\" /><!-- SERVICE NOT AVAILABLE -->\n-  <l:layout permission=\"${app.ADMINISTER}\">", "originalCommit": "2f4803caf614427a5d7135753c068f6c92ad8818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTEwNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r376801105", "bodyText": "It's a restart page containing no information :) From my PoV it was a mistake to request ADMIN here.", "author": "Wadeck", "createdAt": "2020-02-09T17:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTczODY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4MzI3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r380483276", "bodyText": "@daniel-beck are there any use-cases we might be missing?", "author": "oleg-nenashev", "createdAt": "2020-02-18T06:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTczODY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzA5MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r382327091", "bodyText": "This view is intended to only be accessible to admins via \n  \n    \n      jenkins/core/src/main/java/hudson/lifecycle/WindowsInstallerLink.java\n    \n    \n        Lines 177 to 187\n      in\n      fdfcbc3\n    \n    \n    \n    \n\n        \n          \n           Jenkins.get().checkPermission(Jenkins.ADMINISTER); \n        \n\n        \n          \n            \n        \n\n        \n          \n           if(installationDir==null) { \n        \n\n        \n          \n               // if the user reloads the page after Hudson has restarted, \n        \n\n        \n          \n               // it comes back here. In such a case, don't let this restart Hudson. \n        \n\n        \n          \n               // so just send them back to the top page \n        \n\n        \n          \n               rsp.sendRedirect(req.getContextPath()+\"/\"); \n        \n\n        \n          \n               return; \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           rsp.forward(this,\"_restart\",req); \n        \n    \n  \n\n so it seems like just the default to apply here.\nOTOH, if there's nothing protection-worthy going on anyway?\nCould it confuse people into thinking Jenkins is down by linking to this URL or something along those lines?", "author": "daniel-beck", "createdAt": "2020-02-20T23:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTczODY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU3MTA5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4457#discussion_r382571094", "bodyText": "As the page automatically redirects to the rootURL, it could be difficult to \"stuck\" people there.", "author": "Wadeck", "createdAt": "2020-02-21T13:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTczODY5NA=="}], "type": "inlineReview"}]}