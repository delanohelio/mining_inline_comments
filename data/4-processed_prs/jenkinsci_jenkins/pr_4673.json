{"pr_number": 4673, "pr_title": "Add support for bearer tokens in Jenkins CLI", "pr_createdAt": "2020-04-19T21:25:52Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4673", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMTU2Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413721566", "bodyText": "Is it possible that the bearer token here is empty ?", "author": "sladyn98", "createdAt": "2020-04-23T11:03:06Z", "path": "cli/src/main/java/hudson/cli/CLIConnectionFactory.java", "diffHunk": "@@ -36,4 +36,19 @@ public CLIConnectionFactory basicAuth(String userInfo) {\n         return authorization(\"Basic \" + Base64.getEncoder().encodeToString(userInfo.getBytes()));\n     }\n \n+    /**\n+     * Convenience method to call {@link #authorization} with the HTTP bearer authentication.\n+     * Cf. {@code BasicHeaderApiTokenAuthenticator}.\n+     */\n+    public CLIConnectionFactory bearerAuth(String bearerToken) {\n+        return authorization(\"Bearer \" + bearerToken);", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MTQ3OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413951478", "bodyText": "From my understanding of CLI class, it can be an empty string but not null -- follows the semantics of basicAuth", "author": "sorend", "createdAt": "2020-04-23T16:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMTU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjIxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413722216", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CLIConnectionFactory sut;\n          \n          \n            \n                CLIConnectionFactory cliFactory;", "author": "sladyn98", "createdAt": "2020-04-23T11:04:17Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory sut;", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413722500", "bodyText": "Would it be better if we also include  an Empty Bearer Token test ?", "author": "sladyn98", "createdAt": "2020-04-23T11:04:50Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory sut;\n+\n+    @BeforeEach\n+    void setUp() {\n+        sut = new CLIConnectionFactory();\n+    }\n+\n+    @Test\n+    void testBearerFromToken() {\n+        Assert.assertEquals(\"Bearer some-token\", sut.of(\"some-token\").authorization);\n+    }\n+", "originalCommit": "df34c19eac41125ee65b7976cd4f496f7e2b39d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk1MjM2NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r413952364", "bodyText": "I can add the test, but the cli will behave in the same was as if empty auth is passed to basicAuth, semantics are the same. Suggest not to implement test, but open to your suggestion :-)", "author": "sorend", "createdAt": "2020-04-23T16:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNjk0OA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418926948", "bodyText": "Okay, I do not have a deep understanding of basicAuth here, if I understand correctly if empty token is passed it will be handled normally and therefore we do not need to test it. Might need some additional review\nCC @daniel-beck", "author": "sladyn98", "createdAt": "2020-05-02T07:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMjUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MDM2Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r417880367", "bodyText": "This is not empty when the test name suggests so?", "author": "varyvol", "createdAt": "2020-04-30T09:32:45Z", "path": "cli/src/test/java/hudson/cli/CLIConnectionFactoryTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package hudson.cli;\n+\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+class CLIConnectionFactoryTest {\n+\n+    CLIConnectionFactory cliFactory;\n+\n+    @BeforeEach\n+    void setUp() {\n+        cliFactory = new CLIConnectionFactory();\n+    }\n+\n+    @Test\n+    void testBearerFromToken() {\n+        Assert.assertEquals(\"Bearer some-token\", cliFactory.of(\"some-token\").authorization);\n+    }\n+\n+    @Test\n+    void testBearerFromEmptyToken() {\n+        Assert.assertEquals(\"Bearer some-token\", cliFactory.of(\"some-token\").authorization);", "originalCommit": "1ecafd520a7df7c7b0e0cd8c2f5fa0faaf08c42a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyOTIzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418529233", "bodyText": "Sorry a missing cleanup.", "author": "sorend", "createdAt": "2020-05-01T12:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MDM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNjY5NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418926695", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              \\                     : specify username and either password or API token (or load from them both from a file);\\n\\\n          \n          \n            \n              \\                     : specify username and  password or API token (or load from them both from a file);\\n\\", "author": "sladyn98", "createdAt": "2020-05-02T07:43:28Z", "path": "cli/src/main/resources/hudson/cli/client/Messages.properties", "diffHunk": "@@ -11,10 +11,12 @@ CLI.Usage=Jenkins CLI\\n\\\n   \\ -user               : specify user (for use with -ssh)\\n\\\n   \\ -strictHostKey      : request strict host key checking (for use with -ssh)\\n\\\n   \\ -logger FINE        : enable detailed logging from the client\\n\\\n-  \\ -auth [ USER:SECRET | @FILE ] : specify username and either password or API token (or load from them both from a file);\\n\\\n-  \\                                 for use with -http.\\n\\\n-  \\                                 Passing credentials by file is recommended.\\n\\\n-  \\                                 See https://jenkins.io/redirect/cli-http-connection-mode for more info and options.\\n\\\n+  \\ -auth [ USER:SECRET | TOKEN | @FILE ]\\n\\\n+  \\                     : specify username and either password or API token (or load from them both from a file);\\n\\", "originalCommit": "21c56db437c09d9e80c55da7e98b3fea36193a62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNzYxMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418927613", "bodyText": "I think this changes the meaning. I added the next line about bearer token. This is about that you can provide Jenkins API token or Jenkins password, so I think it should be left as is.", "author": "sorend", "createdAt": "2020-05-02T07:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNjY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyOTEzOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r418929138", "bodyText": "Okay thanks \ud83d\udc4d", "author": "sladyn98", "createdAt": "2020-05-02T08:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNjY5NQ=="}], "type": "inlineReview"}, {"oid": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "url": "https://github.com/jenkinsci/jenkins/commit/eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "message": "added -bearer argument to jenkins-cli", "committedDate": "2020-05-21T18:11:39Z", "type": "commit"}, {"oid": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "url": "https://github.com/jenkinsci/jenkins/commit/eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "message": "added -bearer argument to jenkins-cli", "committedDate": "2020-05-21T18:11:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzMjc3Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r428832773", "bodyText": "it is exclusive to -auth. Can we check it and say it explicitly on the help. Also -bearer is for -http I guess, and passing it with a file also applies.\nSorry for being picky, I was about to approve when you said it cannot have a \ud83d\ude04 but with the new way, I believe is worth to document it well.", "author": "MRamonLeon", "createdAt": "2020-05-21T18:24:45Z", "path": "cli/src/main/resources/hudson/cli/client/Messages.properties", "diffHunk": "@@ -15,6 +15,7 @@ CLI.Usage=Jenkins CLI\\n\\\n   \\                                 for use with -http.\\n\\\n   \\                                 Passing credentials by file is recommended.\\n\\\n   \\                                 See https://jenkins.io/redirect/cli-http-connection-mode for more info and options.\\n\\\n+  \\ -bearer [ TOKEN | @FILE ]     : specify authentication using a bearer token (or load the token from file)\\n\\", "originalCommit": "eef34bb1e99cbc48551c1ff7a620e9a0836d1490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1ODM4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4673#discussion_r429058383", "bodyText": "@MRamonLeon Thank you for the review \ud83d\udc4d  I have updated the message and added a warning when both are used (this is how -user and -auth exclusivity was handled already)", "author": "sorend", "createdAt": "2020-05-22T06:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzMjc3Mw=="}], "type": "inlineReview"}, {"oid": "81412e2c648d9c6eaa5a5be2ae845d1b1ba728cb", "url": "https://github.com/jenkinsci/jenkins/commit/81412e2c648d9c6eaa5a5be2ae845d1b1ba728cb", "message": "updated message related to bearer/auth. added warning when both are used anyway.", "committedDate": "2020-05-22T06:04:06Z", "type": "commit"}]}