{"pr_number": 4766, "pr_title": "JENKINS-29144: Enable proper environment access for build steps", "pr_createdAt": "2020-06-01T22:30:38Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4766", "timeline": [{"oid": "1db39f4a4f1f917fc7352cfc8b67b9aa18e9a4c5", "url": "https://github.com/jenkinsci/jenkins/commit/1db39f4a4f1f917fc7352cfc8b67b9aa18e9a4c5", "message": "[JENKINS-29144] Add perform() taking EnvVars to SimpleBuildStep\n\nProvides a default implementation for both overloads:\n- if the old method is called, it forwards to the new method, passing\n  the environment specified for the Run\n  - this means that when a new implementer (who has overridden the new\n    overload) gets called by an old client, they get the run\n    environment only (fine for freestyle, only the initial environment\n    in a pipeline)\n- if the new method is called, it forwards to the old method, ignoring\n  the passed environment\n  - in this case, the old method MUST be overridden\n  - this handles the case of an old implementer getting called by a\n    new client\n    - no change in functionality; implementer still gets the same\n      environment to work with (via the Run)\n\nBuildStepCompatibilityLayer has _not_ been changed yet to call the new\noverload, mainly because it would just get the environment to pass the\nsame way the default implementation in SimpleBuildStep does (i.e.\npassing the result of calling getEnvironment() on the Run).\n\nImplementers of SimpleBuildStep (like ArtifactArchiver and\nFingerprinter) similarly have _not_ been changed. This is mainly\nbecause they get Run's environment to apply substitution, and that\nshould not be done using an environment passed in from a pipeline\nstep. So if they switch to the new signature, their code should also\nbe adjusted to only expand environment variables when the Run is an\nAbstractBuild.\n\nWith this change, a PR can be made to workflow-basic-steps-plugin,\nto extend CoreStep to pass in the environment variables from the\nstep context. The combination of both PRs should then fix\nJENKINS-29144 and allow the creation of Builders that are\nautomatically available as pipeline steps with proper honoring of\nthings like withEnv and global tools.", "committedDate": "2020-06-01T22:03:20Z", "type": "commit"}, {"oid": "fbc5f5d7a1c0b045400a8ab4749d0b852072ad65", "url": "https://github.com/jenkinsci/jenkins/commit/fbc5f5d7a1c0b045400a8ab4749d0b852072ad65", "message": "[JENKINS-29144] Add a test for the SimpleBuildStep changes\n\nThis currently just checks for a slave-level environment variable;\nnot sure if that is enough.", "committedDate": "2020-06-01T22:03:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NTQ1Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r433545453", "bodyText": "There are a couple of implementations inside core which should be adapted, though they would ignore the EnvVars argument.", "author": "jglick", "createdAt": "2020-06-01T23:44:15Z", "path": "core/src/main/java/jenkins/tasks/SimpleBuildStep.java", "diffHunk": "@@ -80,9 +82,37 @@\n      * @param listener a place to send output\n      * @throws InterruptedException if the step is interrupted\n      * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @deprecated Use {@link #perform(Run, FilePath, EnvVars, Launcher, TaskListener) instead.}", "originalCommit": "fbc5f5d7a1c0b045400a8ab4749d0b852072ad65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MDcwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434160702", "bodyText": "I was more thinking of adapting them to better follow the substitution guidelines for steps, i.e. not even apply substitution based on the initial environment. But I left that out because it didn't seem directly related to the ticket at hand.\nBut I'll add a commit that adapts them to the new API.", "author": "Zastai", "createdAt": "2020-06-02T20:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NTQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2NzIxNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434167216", "bodyText": "I was more thinking of adapting them to better follow the substitution guidelines for steps, i.e. not even apply substitution based on the initial environment.\n\nOh maybe you are thinking about \n  \n    \n      jenkins/core/src/main/java/hudson/tasks/ArtifactArchiver.java\n    \n    \n         Line 248\n      in\n      449c5ac\n    \n    \n    \n    \n\n        \n          \n           String artifacts = build.getEnvironment(listener).expand(this.artifacts); \n        \n    \n  \n\n & \n  \n    \n      jenkins/core/src/main/java/hudson/tasks/Fingerprinter.java\n    \n    \n        Lines 177 to 179\n      in\n      d30edab\n    \n    \n    \n    \n\n        \n          \n           EnvVars environment = build.getEnvironment(listener); \n        \n\n        \n          \n           if(targets.length()!=0) { \n        \n\n        \n          \n               String expandedTargets = environment.expand(targets); \n        \n    \n  \n\n and are correct that they would use the EnvVars argument\u2014but you can do so only if build instanceof AbstractBuild, which will skip expansion for WorkflowRun like we want. See JENKINS-35671.", "author": "jglick", "createdAt": "2020-06-02T20:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0NTY1NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r433545654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    @TestExtension(\"jenkins29144\")\n          \n          \n            \n                    @TestExtension\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    @TestExtension(\"jenkins29144\")\n          \n          \n            \n                    @TestExtension(\"builderReceivesEnvVars\")", "author": "jglick", "createdAt": "2020-06-01T23:45:05Z", "path": "test/src/test/java/jenkins/tasks/SimpleBuildStepTest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package jenkins.tasks;\n+\n+import hudson.EnvVars;\n+import hudson.FilePath;\n+import hudson.Launcher;\n+import hudson.model.AbstractBuild;\n+import hudson.model.AbstractProject;\n+import hudson.model.Action;\n+import hudson.model.Build;\n+import hudson.model.BuildListener;\n+import hudson.model.FreeStyleBuild;\n+import hudson.model.FreeStyleProject;\n+import hudson.model.Label;\n+import hudson.model.ParametersAction;\n+import hudson.model.Project;\n+import hudson.model.Run;\n+import hudson.model.Slave;\n+import hudson.model.StringParameterValue;\n+import hudson.model.TaskListener;\n+import hudson.tasks.BuildStep;\n+import hudson.tasks.BuildStepDescriptor;\n+import hudson.tasks.Builder;\n+import java.io.IOException;\n+import javax.annotation.Nonnull;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.TestExtension;\n+\n+public class SimpleBuildStepTest {\n+\n+    private static class StepThatGetsEnvironmentContents extends Builder implements SimpleBuildStep {\n+\n+        @Override\n+        public void perform(@Nonnull Run<?, ?> run, @Nonnull FilePath workspace, @Nonnull EnvVars env, @Nonnull Launcher launcher, @Nonnull TaskListener listener) throws InterruptedException, IOException {\n+            // Check that the environment we get includes values from the slave\n+            Assert.assertEquals(\"JENKINS-29144\", env.get(\"TICKET\"));\n+            // FIXME: Should this test any other envvars? Or Parameters?\n+        }\n+\n+        @TestExtension(\"jenkins29144\")", "originalCommit": "fbc5f5d7a1c0b045400a8ab4749d0b852072ad65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "95c74696b1e6d404848f1113955c44c50af32c0c", "url": "https://github.com/jenkinsci/jenkins/commit/95c74696b1e6d404848f1113955c44c50af32c0c", "message": "Apply suggested code change\n\nCo-authored-by: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-06-02T20:37:30Z", "type": "commit"}, {"oid": "5e413c40d28a79828d089a1225468f3bd45eff9b", "url": "https://github.com/jenkinsci/jenkins/commit/5e413c40d28a79828d089a1225468f3bd45eff9b", "message": "[JENKINS-29144] Update BuildStepCompatibilityLayer to use the new SimpleBuildStep API", "committedDate": "2020-06-02T20:44:36Z", "type": "commit"}, {"oid": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "url": "https://github.com/jenkinsci/jenkins/commit/4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "message": "[JENKINS-29144] Update ArtifactArchiver and Fingerprinter to use the new SimpleBuildStep API\n\nBoth will only use the environment for substitution when the Run being passed is an AbstractBuild, following the guidelines that for pipelines, the user does their own substitution in Groovy.\nThis causes a small behaviour change; before, even in pipelines, substitution would be done by these steps using the (tiny) initial environment.", "committedDate": "2020-06-02T20:52:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MDk5Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434170993", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (build instanceof AbstractBuild) // no expansion in pipelines\n          \n          \n            \n                            artifacts = environment.expand(artifacts);\n          \n          \n            \n                        if (build instanceof AbstractBuild) { // no expansion in pipelines\n          \n          \n            \n                            artifacts = environment.expand(artifacts);\n          \n          \n            \n                        }", "author": "jglick", "createdAt": "2020-06-02T20:57:01Z", "path": "core/src/main/java/hudson/tasks/ArtifactArchiver.java", "diffHunk": "@@ -245,7 +247,9 @@ public void perform(Run<?,?> build, FilePath ws, Launcher launcher, TaskListener\n \n         listener.getLogger().println(Messages.ArtifactArchiver_ARCHIVING_ARTIFACTS());\n         try {\n-            String artifacts = build.getEnvironment(listener).expand(this.artifacts);\n+            String artifacts = this.artifacts;\n+            if (build instanceof AbstractBuild) // no expansion in pipelines\n+                artifacts = environment.expand(artifacts);", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MTI1Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434171252", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (build instanceof AbstractBuild) // no expansion for pipelines\n          \n          \n            \n                                expandedTargets = environment.expand(expandedTargets);\n          \n          \n            \n                            if (build instanceof AbstractBuild) { // no expansion for pipelines\n          \n          \n            \n                                expandedTargets = environment.expand(expandedTargets);\n          \n          \n            \n                            }", "author": "jglick", "createdAt": "2020-06-02T20:57:32Z", "path": "core/src/main/java/hudson/tasks/Fingerprinter.java", "diffHunk": "@@ -168,15 +168,16 @@ public boolean getRecordBuildArtifacts() {\n     }\n \n     @Override\n-    public void perform(Run<?,?> build, FilePath workspace, Launcher launcher, TaskListener listener) throws InterruptedException {\n+    public void perform(Run<?,?> build, FilePath workspace, EnvVars environment, Launcher launcher, TaskListener listener) throws InterruptedException {\n         try {\n             listener.getLogger().println(Messages.Fingerprinter_Recording());\n \n             Map<String,String> record = new HashMap<>();\n             \n-            EnvVars environment = build.getEnvironment(listener);\n             if(targets.length()!=0) {\n-                String expandedTargets = environment.expand(targets);\n+                String expandedTargets = targets;\n+                if (build instanceof AbstractBuild) // no expansion for pipelines\n+                    expandedTargets = environment.expand(expandedTargets);", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NDg1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434174856", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!Util.isOverridden(SimpleBuildStep.class, this.getClass(),\n          \n          \n            \n                            \"perform\", Run.class, FilePath.class, Launcher.class, TaskListener.class)) {\n          \n          \n            \n                        throw new AbstractMethodError();\n          \n          \n            \n                    }\n          \n          \n            \n                    this.perform(run, workspace, launcher, listener);\n          \n          \n            \n                    if (Util.isOverridden(SimpleBuildStep.class, this.getClass(),\n          \n          \n            \n                            \"perform\", Run.class, FilePath.class, Launcher.class, TaskListener.class)) {\n          \n          \n            \n                        this.perform(run, workspace, launcher, listener);\n          \n          \n            \n                    } else {\n          \n          \n            \n                        throw new AbstractMethodError();\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nmay be easier to follow", "author": "jglick", "createdAt": "2020-06-02T21:05:00Z", "path": "core/src/main/java/jenkins/tasks/SimpleBuildStep.java", "diffHunk": "@@ -80,9 +82,37 @@\n      * @param listener a place to send output\n      * @throws InterruptedException if the step is interrupted\n      * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @deprecated Use {@link #perform(Run, FilePath, EnvVars, Launcher, TaskListener) instead.}\n      */\n-    void perform(@NonNull Run<?,?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n-                 @NonNull TaskListener listener) throws InterruptedException, IOException;\n+    @Deprecated\n+    default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n+                         @NonNull TaskListener listener) throws InterruptedException, IOException {\n+        // No additional environment available; just use that from the Run.\n+        this.perform(run, workspace, run.getEnvironment(listener), launcher, listener);\n+    }\n+\n+    /**\n+     * Run this step.\n+     * @param run a build this is running as a part of\n+     * @param workspace a workspace to use for any file operations\n+     * @param env environment variables applicable to this step\n+     * @param launcher a way to start processes\n+     * @param listener a place to send output\n+     * @throws InterruptedException if the step is interrupted\n+     * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @since 2.2xx\n+     */\n+    default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNull EnvVars env, @NonNull Launcher launcher,\n+                         @NonNull TaskListener listener) throws InterruptedException, IOException {\n+        // If this is called, this must be an implementer of the previous API, in which case we call that, discarding\n+        // the environment we were given.\n+        // But for that to work, that API method must have been implemented.\n+        if (!Util.isOverridden(SimpleBuildStep.class, this.getClass(),\n+                \"perform\", Run.class, FilePath.class, Launcher.class, TaskListener.class)) {\n+            throw new AbstractMethodError();\n+        }\n+        this.perform(run, workspace, launcher, listener);", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTM3NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434175375", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // FIXME: Should this test any other envvars? Or Parameters?\n          \n      \n    \n    \n  \n\nI suggested ParametersAction as a somewhat simpler test setup, but I do not suppose it really matters.", "author": "jglick", "createdAt": "2020-06-02T21:06:06Z", "path": "test/src/test/java/jenkins/tasks/SimpleBuildStepTest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package jenkins.tasks;\n+\n+import hudson.EnvVars;\n+import hudson.FilePath;\n+import hudson.Launcher;\n+import hudson.model.AbstractBuild;\n+import hudson.model.AbstractProject;\n+import hudson.model.Action;\n+import hudson.model.Build;\n+import hudson.model.BuildListener;\n+import hudson.model.FreeStyleBuild;\n+import hudson.model.FreeStyleProject;\n+import hudson.model.Label;\n+import hudson.model.ParametersAction;\n+import hudson.model.Project;\n+import hudson.model.Run;\n+import hudson.model.Slave;\n+import hudson.model.StringParameterValue;\n+import hudson.model.TaskListener;\n+import hudson.tasks.BuildStep;\n+import hudson.tasks.BuildStepDescriptor;\n+import hudson.tasks.Builder;\n+import java.io.IOException;\n+import javax.annotation.Nonnull;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.TestExtension;\n+\n+public class SimpleBuildStepTest {\n+\n+    private static class StepThatGetsEnvironmentContents extends Builder implements SimpleBuildStep {\n+\n+        @Override\n+        public void perform(@Nonnull Run<?, ?> run, @Nonnull FilePath workspace, @Nonnull EnvVars env, @Nonnull Launcher launcher, @Nonnull TaskListener listener) throws InterruptedException, IOException {\n+            // Check that the environment we get includes values from the slave\n+            Assert.assertEquals(\"JENKINS-29144\", env.get(\"TICKET\"));\n+            // FIXME: Should this test any other envvars? Or Parameters?", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTU3Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434175572", "bodyText": "unused I think\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Rule\n          \n          \n            \n                public TemporaryFolder tmp = new TemporaryFolder();", "author": "jglick", "createdAt": "2020-06-02T21:06:32Z", "path": "test/src/test/java/jenkins/tasks/SimpleBuildStepTest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package jenkins.tasks;\n+\n+import hudson.EnvVars;\n+import hudson.FilePath;\n+import hudson.Launcher;\n+import hudson.model.AbstractBuild;\n+import hudson.model.AbstractProject;\n+import hudson.model.Action;\n+import hudson.model.Build;\n+import hudson.model.BuildListener;\n+import hudson.model.FreeStyleBuild;\n+import hudson.model.FreeStyleProject;\n+import hudson.model.Label;\n+import hudson.model.ParametersAction;\n+import hudson.model.Project;\n+import hudson.model.Run;\n+import hudson.model.Slave;\n+import hudson.model.StringParameterValue;\n+import hudson.model.TaskListener;\n+import hudson.tasks.BuildStep;\n+import hudson.tasks.BuildStepDescriptor;\n+import hudson.tasks.Builder;\n+import java.io.IOException;\n+import javax.annotation.Nonnull;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.TestExtension;\n+\n+public class SimpleBuildStepTest {\n+\n+    private static class StepThatGetsEnvironmentContents extends Builder implements SimpleBuildStep {\n+\n+        @Override\n+        public void perform(@Nonnull Run<?, ?> run, @Nonnull FilePath workspace, @Nonnull EnvVars env, @Nonnull Launcher launcher, @Nonnull TaskListener listener) throws InterruptedException, IOException {\n+            // Check that the environment we get includes values from the slave\n+            Assert.assertEquals(\"JENKINS-29144\", env.get(\"TICKET\"));\n+            // FIXME: Should this test any other envvars? Or Parameters?\n+        }\n+\n+        @TestExtension(\"builderReceivesEnvVars\")\n+        public static class DescriptorImpl extends BuildStepDescriptor<Builder> {\n+\n+            @Override\n+            public boolean isApplicable(Class<? extends AbstractProject> jobType) {\n+                return true;\n+            }\n+\n+        }\n+\n+    }\n+\n+    @Rule\n+    public TemporaryFolder tmp = new TemporaryFolder();", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTY2NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434175664", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.junit.rules.TemporaryFolder;\n          \n      \n    \n    \n  \n\nand fix imports generally", "author": "jglick", "createdAt": "2020-06-02T21:06:43Z", "path": "test/src/test/java/jenkins/tasks/SimpleBuildStepTest.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package jenkins.tasks;\n+\n+import hudson.EnvVars;\n+import hudson.FilePath;\n+import hudson.Launcher;\n+import hudson.model.AbstractBuild;\n+import hudson.model.AbstractProject;\n+import hudson.model.Action;\n+import hudson.model.Build;\n+import hudson.model.BuildListener;\n+import hudson.model.FreeStyleBuild;\n+import hudson.model.FreeStyleProject;\n+import hudson.model.Label;\n+import hudson.model.ParametersAction;\n+import hudson.model.Project;\n+import hudson.model.Run;\n+import hudson.model.Slave;\n+import hudson.model.StringParameterValue;\n+import hudson.model.TaskListener;\n+import hudson.tasks.BuildStep;\n+import hudson.tasks.BuildStepDescriptor;\n+import hudson.tasks.Builder;\n+import java.io.IOException;\n+import javax.annotation.Nonnull;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;", "originalCommit": "4d12c9cb7771e8a894c04b66bf81a94b60d2d67b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb1b00ab090f34ada505c53e8520918628c8cdc2", "url": "https://github.com/jenkinsci/jenkins/commit/bb1b00ab090f34ada505c53e8520918628c8cdc2", "message": "Code style: add missing braces to if statement.", "committedDate": "2020-06-02T21:10:04Z", "type": "commit"}, {"oid": "181251bc2ddab0d623c98e89f3853cd937a065e1", "url": "https://github.com/jenkinsci/jenkins/commit/181251bc2ddab0d623c98e89f3853cd937a065e1", "message": "Applied suggested code change.", "committedDate": "2020-06-02T21:31:03Z", "type": "commit"}, {"oid": "6791fa667050d0074b22b377cd2f0b4fa9f08404", "url": "https://github.com/jenkinsci/jenkins/commit/6791fa667050d0074b22b377cd2f0b4fa9f08404", "message": "Removed unused rule and imports.", "committedDate": "2020-06-02T21:31:38Z", "type": "commit"}, {"oid": "eda1a0ea5bc5eeb509903d8320d20d2d074b28e0", "url": "https://github.com/jenkinsci/jenkins/commit/eda1a0ea5bc5eeb509903d8320d20d2d074b28e0", "message": "[JENKINS-29144] Also test that a build parameter arrives in the step's environment.", "committedDate": "2020-06-02T21:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU4MjY2NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434582664", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @since 2.2xx\n          \n          \n            \n                 * @since FIXME\n          \n      \n    \n    \n  \n\n(gets patched up by a core committer after merge)", "author": "jglick", "createdAt": "2020-06-03T13:51:24Z", "path": "core/src/main/java/jenkins/tasks/SimpleBuildStep.java", "diffHunk": "@@ -80,9 +82,38 @@\n      * @param listener a place to send output\n      * @throws InterruptedException if the step is interrupted\n      * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @deprecated Use {@link #perform(Run, FilePath, EnvVars, Launcher, TaskListener) instead.}\n      */\n-    void perform(@NonNull Run<?,?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n-                 @NonNull TaskListener listener) throws InterruptedException, IOException;\n+    @Deprecated\n+    default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n+                         @NonNull TaskListener listener) throws InterruptedException, IOException {\n+        // No additional environment available; just use that from the Run.\n+        this.perform(run, workspace, run.getEnvironment(listener), launcher, listener);\n+    }\n+\n+    /**\n+     * Run this step.\n+     * @param run a build this is running as a part of\n+     * @param workspace a workspace to use for any file operations\n+     * @param env environment variables applicable to this step\n+     * @param launcher a way to start processes\n+     * @param listener a place to send output\n+     * @throws InterruptedException if the step is interrupted\n+     * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @since 2.2xx", "originalCommit": "eda1a0ea5bc5eeb509903d8320d20d2d074b28e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU4MzQzNQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r434583435", "bodyText": "BTW you can use TestBuilder to make things shorter (inner class) if you like.", "author": "jglick", "createdAt": "2020-06-03T13:52:24Z", "path": "test/src/test/java/jenkins/tasks/SimpleBuildStepTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package jenkins.tasks;\n+\n+import hudson.EnvVars;\n+import hudson.FilePath;\n+import hudson.Launcher;\n+import hudson.model.AbstractProject;\n+import hudson.model.FreeStyleProject;\n+import hudson.model.ParametersDefinitionProperty;\n+import hudson.model.Run;\n+import hudson.model.Slave;\n+import hudson.model.StringParameterDefinition;\n+import hudson.model.TaskListener;\n+import hudson.tasks.BuildStepDescriptor;\n+import hudson.tasks.Builder;\n+import java.io.IOException;\n+import javax.annotation.Nonnull;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+import org.jvnet.hudson.test.TestExtension;\n+\n+public class SimpleBuildStepTest {\n+\n+    private static class StepThatGetsEnvironmentContents extends Builder implements SimpleBuildStep {\n+\n+        @Override\n+        public void perform(@Nonnull Run<?, ?> run, @Nonnull FilePath workspace, @Nonnull EnvVars env, @Nonnull Launcher launcher, @Nonnull TaskListener listener) throws InterruptedException, IOException {\n+            // Check that the environment we get includes values from the slave\n+            Assert.assertEquals(\"JENKINS-29144\", env.get(\"TICKET\"));\n+            // And that parameters appear too\n+            Assert.assertEquals(\"WORLD\", env.get(\"HELLO\"));\n+        }\n+\n+        @TestExtension(\"builderReceivesEnvVars\")\n+        public static class DescriptorImpl extends BuildStepDescriptor<Builder> {", "originalCommit": "eda1a0ea5bc5eeb509903d8320d20d2d074b28e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16c928b46fc4125ce8406dbdfdd0b1b747a4202c", "url": "https://github.com/jenkinsci/jenkins/commit/16c928b46fc4125ce8406dbdfdd0b1b747a4202c", "message": "Merge branch 'master' into JENKINS-29144", "committedDate": "2020-06-03T21:20:55Z", "type": "commit"}, {"oid": "6b2492d9c96ff5ca22a3e1132fa0ee47048d30fd", "url": "https://github.com/jenkinsci/jenkins/commit/6b2492d9c96ff5ca22a3e1132fa0ee47048d30fd", "message": "Use FIXME for @since.", "committedDate": "2020-06-03T21:24:10Z", "type": "commit"}, {"oid": "0f59bbb0bf6a575be3ae4e5d79a7d08a1d4125b5", "url": "https://github.com/jenkinsci/jenkins/commit/0f59bbb0bf6a575be3ae4e5d79a7d08a1d4125b5", "message": "Merge branch 'master' into JENKINS-29144", "committedDate": "2020-06-06T13:51:51Z", "type": "commit"}, {"oid": "c9c9939aabb829dd53f34d546e08289f534718bd", "url": "https://github.com/jenkinsci/jenkins/commit/c9c9939aabb829dd53f34d546e08289f534718bd", "message": "Merge branch 'master' into JENKINS-29144", "committedDate": "2020-06-06T19:35:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5ODg5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r436298896", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @since FIXME\n          \n          \n            \n                 * @since TODO\n          \n      \n    \n    \n  \n\nper \n  \n    \n      jenkins/update-since-todo.sh\n    \n    \n         Line 13\n      in\n      2980940\n    \n    \n    \n    \n\n        \n          \n           for todo in $( git grep --line-number '@since TODO' | grep -v \"$me\" )", "author": "daniel-beck", "createdAt": "2020-06-06T20:37:06Z", "path": "core/src/main/java/jenkins/tasks/SimpleBuildStep.java", "diffHunk": "@@ -100,7 +100,7 @@ default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNu\n      * @param listener a place to send output\n      * @throws InterruptedException if the step is interrupted\n      * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n-     * @since 2.2xx\n+     * @since FIXME", "originalCommit": "6b2492d9c96ff5ca22a3e1132fa0ee47048d30fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5OTIwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r436299202", "bodyText": "Done. (Although it's annoying that GH turns @ since into a mention on the commit message.)", "author": "Zastai", "createdAt": "2020-06-06T20:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5ODg5Ng=="}], "type": "inlineReview"}, {"oid": "5a9c198e2a331a1a41684e58f1276a827a0048a2", "url": "https://github.com/jenkinsci/jenkins/commit/5a9c198e2a331a1a41684e58f1276a827a0048a2", "message": "Use TODO, not FIXME, for @since.", "committedDate": "2020-06-06T20:40:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NTUzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r450775530", "bodyText": "@jglick @oleg-nenashev this requires perform method not to be final and breaks backward compatibility with uber/phabricator-jenkins-plugin#344", "author": "KostyaSha", "createdAt": "2020-07-07T10:49:06Z", "path": "core/src/main/java/jenkins/tasks/SimpleBuildStep.java", "diffHunk": "@@ -80,9 +82,38 @@\n      * @param listener a place to send output\n      * @throws InterruptedException if the step is interrupted\n      * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @deprecated Use {@link #perform(Run, FilePath, EnvVars, Launcher, TaskListener) instead.}\n      */\n-    void perform(@NonNull Run<?,?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n-                 @NonNull TaskListener listener) throws InterruptedException, IOException;\n+    @Deprecated\n+    default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNull Launcher launcher,\n+                         @NonNull TaskListener listener) throws InterruptedException, IOException {\n+        // No additional environment available; just use that from the Run.\n+        this.perform(run, workspace, run.getEnvironment(listener), launcher, listener);\n+    }\n+\n+    /**\n+     * Run this step.\n+     * @param run a build this is running as a part of\n+     * @param workspace a workspace to use for any file operations\n+     * @param env environment variables applicable to this step\n+     * @param launcher a way to start processes\n+     * @param listener a place to send output\n+     * @throws InterruptedException if the step is interrupted\n+     * @throws IOException if something goes wrong; use {@link AbortException} for a polite error\n+     * @since TODO\n+     */\n+    default void perform(@NonNull Run<?, ?> run, @NonNull FilePath workspace, @NonNull EnvVars env, @NonNull Launcher launcher,\n+                         @NonNull TaskListener listener) throws InterruptedException, IOException {\n+        // If this is called, this must be an implementer of the previous API, in which case we call that, discarding\n+        // the environment we were given.\n+        // But for that to work, that API method must have been implemented.\n+        if (Util.isOverridden(SimpleBuildStep.class, this.getClass(),", "originalCommit": "5a9c198e2a331a1a41684e58f1276a827a0048a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Nzg2Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r450877863", "bodyText": "@Zastai certainly not intentional. JENKINS-62723", "author": "jglick", "createdAt": "2020-07-07T13:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NTUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg4ODM5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4766#discussion_r450888396", "bodyText": "I suspect #1804 was incorrect.", "author": "jglick", "createdAt": "2020-07-07T14:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3NTUzMA=="}], "type": "inlineReview"}]}