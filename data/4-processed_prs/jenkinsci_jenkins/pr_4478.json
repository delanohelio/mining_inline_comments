{"pr_number": 4478, "pr_title": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "pr_createdAt": "2020-02-06T20:39:12Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4478", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r376113724", "bodyText": "Will the tools that discover getters and setters (like Pipeline, Configuration as Code, etc.) recognize the prefix \"block\" and the prefix \"unblock\" as setters?  Are any of them ever expected to need to discover these?", "author": "MarkEWaite", "createdAt": "2020-02-06T22:17:52Z", "path": "core/src/main/java/jenkins/model/FingerprintFacet.java", "diffHunk": "@@ -103,6 +108,27 @@ public long getTimestamp() {\n         return timestamp;\n     }\n \n+    /**\n+     * Returns whether Fingerprint deletion has been blocked by this Facet.\n+     */\n+    public boolean isFingerprintDeletionBlocked() {\n+        return fingerprintDeletionBlocked;\n+    }\n+\n+    /**\n+     * Blocks deletion of Fingerprint associated with this Facet.\n+     */\n+    public void blockFingerprintDeletion() {", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI0MDE3MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r376240170", "bodyText": "IIUC, the plugins do need to be able to discover these setters (since they are the ones that create the facets), and would want to block the deletion of the facet.", "author": "stellargo", "createdAt": "2020-02-07T07:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3NTc0MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r378775740", "bodyText": "I'm with Mark here, better to use well-known names for setters and getter", "author": "MRamonLeon", "createdAt": "2020-02-13T10:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNjY1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r378836656", "bodyText": "Hi, I had misunderstood. I am happy to convert it to the Jenkins standards. It would be really helpful if you could point me to a code snippet which uses these standards.", "author": "stellargo", "createdAt": "2020-02-13T12:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTU5NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931595", "bodyText": "It would be a way to go (standard Java setter implemetation)\n    public void setFingerprintDeletionBlocked(boolean value) {", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTYyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931621", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns whether Fingerprint deletion has been blocked by this Facet.\n          \n          \n            \n                 * Returns whether Fingerprint deletion has been blocked by this Facet.\n          \n          \n            \n                 * @since TODO", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:39:50Z", "path": "core/src/main/java/jenkins/model/FingerprintFacet.java", "diffHunk": "@@ -103,6 +108,27 @@ public long getTimestamp() {\n         return timestamp;\n     }\n \n+    /**\n+     * Returns whether Fingerprint deletion has been blocked by this Facet.", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTYzMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931631", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Checks if any Facet of the Fingerprint is blocking its deletion.\n          \n          \n            \n                 * Checks if any Facet of the Fingerprint is blocking its deletion.\n          \n          \n            \n                 * @since TODO", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:40:04Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,17 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Checks if any Facet of the Fingerprint is blocking its deletion.", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTcwMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931701", "bodyText": "Might be great to add some logging later, but the current chance follows the convention", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:41:10Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,7 +107,7 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && !fp.isFingerprintDeletionBlocked()) ) {", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NjMzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379996330", "bodyText": "Thanks @oleg-nenashev , I added logging, let me know if it is fine.", "author": "stellargo", "createdAt": "2020-02-17T05:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTcwMQ=="}], "type": "inlineReview"}, {"oid": "25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "url": "https://github.com/jenkinsci/jenkins/commit/25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-17T05:36:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r380129737", "bodyText": "Would be great to reference the facet blocking it", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:31:12Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +107,13 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && !fp.isFingerprintDeletionBlocked()) ) {\n                 listener.getLogger().println(\"deleting obsolete \" + fingerprintFile);\n                 fingerprintFile.delete();\n                 return true;\n             } else {\n+                if (!fp.isAlive() && fp.isFingerprintDeletionBlocked())\n+                    listener.getLogger().println((\"Facet blocked deletion of \" + fingerprintFile));", "originalCommit": "25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNzg5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r380137896", "bodyText": "A facet by default IIUC only has timestamp and fingerprint attached with it. How would I reference the facet? Should I do it by timestamp? Or should i write a toString method for the facet class?", "author": "stellargo", "createdAt": "2020-02-17T11:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE2NzAyOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381167028", "bodyText": "What about just printing a className? It would at least give the user some idea which facet blocks it", "author": "oleg-nenashev", "createdAt": "2020-02-19T09:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ0MDQ5Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381440497", "bodyText": "@oleg-nenashev Done, I also added the timestamp of creation. Let me know if anything more is required", "author": "stellargo", "createdAt": "2020-02-19T17:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}], "type": "inlineReview"}, {"oid": "987bc66dee709d6a9da648a0f213ce398f4af2b9", "url": "https://github.com/jenkinsci/jenkins/commit/987bc66dee709d6a9da648a0f213ce398f4af2b9", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:33:25Z", "type": "forcePushed"}, {"oid": "8815fbc5636ea73124b452bad31a7421ae362c8b", "url": "https://github.com/jenkinsci/jenkins/commit/8815fbc5636ea73124b452bad31a7421ae362c8b", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:52:46Z", "type": "forcePushed"}, {"oid": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "url": "https://github.com/jenkinsci/jenkins/commit/50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:55:16Z", "type": "commit"}, {"oid": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "url": "https://github.com/jenkinsci/jenkins/commit/50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:55:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxMjI0OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381912249", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {\n          \n          \n            \n                        if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion() == null) ) {", "author": "alecharp", "createdAt": "2020-02-20T10:29:12Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +111,15 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxMzQwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381913402", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName()+\" created on \"+DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp())+\" blocked deletion of \" + fingerprintFile);\n          \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);", "author": "alecharp", "createdAt": "2020-02-20T10:31:31Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +111,15 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {\n                 listener.getLogger().println(\"deleting obsolete \" + fingerprintFile);\n                 fingerprintFile.delete();\n                 return true;\n             } else {\n+                if (!fp.isAlive()) {\n+                    FingerprintFacet deletionBlockerFacet = fp.facetBlockingDeletion();\n+                    listener.getLogger().println(deletionBlockerFacet.getClass().getName()+\" created on \"+DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp())+\" blocked deletion of \" + fingerprintFile);", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxNDg4MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381914880", "bodyText": "Shouldn't it be annotated with @CheckForNull?", "author": "alecharp", "createdAt": "2020-02-20T10:34:02Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,19 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Returns a facet that blocks the deletion of the fingerprint.\n+     * Returns null if no such facet.\n+     * @since TODO\n+     */\n+    public FingerprintFacet facetBlockingDeletion() {", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b77413b0b82d3529145076258fd98b957456dfa", "url": "https://github.com/jenkinsci/jenkins/commit/3b77413b0b82d3529145076258fd98b957456dfa", "message": "Syntax improvements + CheckForNull annotation", "committedDate": "2020-02-21T20:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc3NzU4MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r383777581", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @CheckForNull FingerprintFacet facetBlockingDeletion() {\n          \n          \n            \n                public @CheckForNull FingerprintFacet getFacetBlockingDeletion() {", "author": "oleg-nenashev", "createdAt": "2020-02-25T10:05:47Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,19 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Returns a facet that blocks the deletion of the fingerprint.\n+     * Returns null if no such facet.\n+     * @since TODO\n+     */\n+    public @CheckForNull FingerprintFacet facetBlockingDeletion() {", "originalCommit": "3b77413b0b82d3529145076258fd98b957456dfa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "url": "https://github.com/jenkinsci/jenkins/commit/7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "message": "Changed method name 'facetBlockingDeletion' -> 'getFacetBlockingDeletion'", "committedDate": "2020-02-25T12:31:00Z", "type": "commit"}, {"oid": "7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "url": "https://github.com/jenkinsci/jenkins/commit/7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "message": "Changed method name 'facetBlockingDeletion' -> 'getFacetBlockingDeletion'", "committedDate": "2020-02-25T12:31:00Z", "type": "forcePushed"}]}