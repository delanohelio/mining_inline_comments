{"pr_number": 2370, "pr_title": "GH-2366 fedx custom executor service", "pr_createdAt": "2020-07-18T05:22:13Z", "pr_url": "https://github.com/eclipse/rdf4j/pull/2370", "timeline": [{"oid": "7de2b0daefe7dbfe7b227a1a462d33c3f867df9d", "url": "https://github.com/eclipse/rdf4j/commit/7de2b0daefe7dbfe7b227a1a462d33c3f867df9d", "message": "GH-2366 optional custom ExecutorService injected via FedXConfig", "committedDate": "2020-07-18T05:25:50Z", "type": "forcePushed"}, {"oid": "60ab98f94ae59414d549fe94691d82d20bdded22", "url": "https://github.com/eclipse/rdf4j/commit/60ab98f94ae59414d549fe94691d82d20bdded22", "message": "GH-2366: support wrapping of background tasks in FedX\n\nThis change provides a configurable TaskWrapper infrastructure for\nwrapping background tasks.\n\nA TaskWrapper is a facility to wrap Runnable background tasks before\nthey are passed to the Executor. Use-cases include injection of\nthread-local context variables, or more fine-granular error handling.\n\nAll sub-queries sent by the federation engine that make use of the\nconcurrency infrastructure (e.g. ControlledWorkerScheduler) are passing\nthis wrapper.\n\nThe concrete implementation can be configured using\nFedXConfig.withTaskWrapper(TaskWrapper).\n\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-20T13:27:44Z", "type": "commit"}, {"oid": "60ab98f94ae59414d549fe94691d82d20bdded22", "url": "https://github.com/eclipse/rdf4j/commit/60ab98f94ae59414d549fe94691d82d20bdded22", "message": "GH-2366: support wrapping of background tasks in FedX\n\nThis change provides a configurable TaskWrapper infrastructure for\nwrapping background tasks.\n\nA TaskWrapper is a facility to wrap Runnable background tasks before\nthey are passed to the Executor. Use-cases include injection of\nthread-local context variables, or more fine-granular error handling.\n\nAll sub-queries sent by the federation engine that make use of the\nconcurrency infrastructure (e.g. ControlledWorkerScheduler) are passing\nthis wrapper.\n\nThe concrete implementation can be configured using\nFedXConfig.withTaskWrapper(TaskWrapper).\n\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-20T13:27:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTAxOA==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457575018", "bodyText": "...which takes care of properly handling...", "author": "jetztgradnet", "createdAt": "2020-07-20T17:28:51Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "diffHunk": "@@ -103,28 +104,43 @@ public void reset() {\n \t\t\tlog.debug(\"Scheduler for join and union are reset.\");\n \t\t}\n \n+\t\tTaskWrapper taskWrapper = federationContext.getConfig().getTaskWrapper();\n \t\tif (joinScheduler != null) {\n \t\t\tjoinScheduler.abort();\n \t\t}\n \t\tjoinScheduler = new ControlledWorkerScheduler<>(federationContext.getConfig().getJoinWorkerThreads(),\n-\t\t\t\t\"Join Scheduler\");\n+\t\t\t\t\"Join Scheduler\", taskWrapper);\n \n \t\tif (unionScheduler != null) {\n \t\t\tunionScheduler.abort();\n \t\t}\n \t\tunionScheduler = new ControlledWorkerScheduler<>(federationContext.getConfig().getUnionWorkerThreads(),\n-\t\t\t\t\"Union Scheduler\");\n+\t\t\t\t\"Union Scheduler\", taskWrapper);\n \n \t\tif (leftJoinScheduler != null) {\n \t\t\tleftJoinScheduler.abort();\n \t\t}\n \t\tleftJoinScheduler = new ControlledWorkerScheduler<>(federationContext.getConfig().getLeftJoinWorkerThreads(),\n-\t\t\t\t\"Left Join Scheduler\");\n+\t\t\t\t\"Left Join Scheduler\", taskWrapper);\n \n \t}\n \n+\t/**\n+\t * Returns the managed {@link Executor} which takes for properly handling any configured", "originalCommit": "60ab98f94ae59414d549fe94691d82d20bdded22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NjUwMQ==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457576501", "bodyText": "as a TaskWrapper might be a construct also used in other places and there are already quite some constructor parameters and constructor variants I suggest to rather create an interface TaskWrapperAware which allows setting  (and getting) a TaskWrapper and implement that here. This also allows usiing this in other places.", "author": "jetztgradnet", "createdAt": "2020-07-20T17:31:21Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/concurrent/ControlledWorkerScheduler.java", "diffHunk": "@@ -46,23 +46,41 @@\n \n \tprivate final int nWorkers;\n \tprivate final String name;\n+\tprivate final TaskWrapper taskWrapper;\n \n \t/**\n \t * Construct a new instance with 20 workers.\n+\t * \n+\t * @deprecated use {@link #ControlledWorkerScheduler(int, String, TaskWrapper)}. Scheduled to be removed in 4.0\n \t */\n+\t@Deprecated\n \tpublic ControlledWorkerScheduler() {\n-\t\tthis(20, \"FedX Worker\");\n+\t\tthis(20, \"FedX Worker\", DefaultTaskWrapper.INSTANCE);\n \t}\n \n \t/**\n \t * Construct a new instance with the specified number of workers and the given name.\n \t *\n \t * @param nWorkers\n \t * @param name\n+\t * @deprecated use {@link #ControlledWorkerScheduler(int, String, TaskWrapper)}. Scheduled to be removed in 4.0\n \t */\n+\t@Deprecated\n \tpublic ControlledWorkerScheduler(int nWorkers, String name) {\n+\t\tthis(nWorkers, name, DefaultTaskWrapper.INSTANCE);\n+\t}\n+\n+\t/**\n+\t * Construct a new instance with the specified number of workers, the given name and {@link TaskWrapper}.\n+\t *\n+\t * @param nWorkers\n+\t * @param name\n+\t * @param taskWrapper\n+\t */\n+\tpublic ControlledWorkerScheduler(int nWorkers, String name, TaskWrapper taskWrapper) {", "originalCommit": "60ab98f94ae59414d549fe94691d82d20bdded22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3Njg1OQ==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457576859", "bodyText": "I suggest adding a default method here which simply returns the provided runnable.", "author": "jetztgradnet", "createdAt": "2020-07-20T17:31:59Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/concurrent/TaskWrapper.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.federated.evaluation.concurrent;\n+\n+import java.util.concurrent.Executor;\n+\n+import org.eclipse.rdf4j.federated.FedXConfig;\n+\n+/**\n+ * A {@link TaskWrapper} is a facility to wrap {@link Runnable} background tasks before they are passed to the\n+ * {@link Executor}. Use-cases include injection of thread-local context variables, or more fine-granular error\n+ * handling.\n+ * \n+ * <p>\n+ * All sub-queries sent by the federation engine that make use of the concurrency infrastructure (e.g.\n+ * {@link ControlledWorkerScheduler}) are passing this wrapper.\n+ * </p>\n+ * \n+ * <p>\n+ * The concrete implementation can be configured using {@link FedXConfig#withTaskWrapper(TaskWrapper)}.\n+ * </p>\n+ * \n+ * @author Andreas Schwarte\n+ * @see DefaultTaskWrapper\n+ * @see ControlledWorkerScheduler\n+ * @see FedXConfig#withTaskWrapper(TaskWrapper)\n+ */\n+public interface TaskWrapper {\n+\n+\t/**\n+\t * Wrap the given {@link Runnable} and add custom logic.\n+\t * \n+\t * <p>\n+\t * Use cases include injection of state into the thread-local context, or more fine granular error handling.\n+\t * </p>\n+\t * \n+\t * <p>\n+\t * Note that when modifying state in {@link ThreadLocal} it must be reset properly in a try/finally block.\n+\t * </p>\n+\t * \n+\t * @param runnable the task as generated by the FedX engine\n+\t * @return the wrapped {@link Runnable}\n+\t */\n+\tpublic Runnable wrap(Runnable runnable);", "originalCommit": "60ab98f94ae59414d549fe94691d82d20bdded22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3OTMxNg==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457579316", "bodyText": "let's also add a variant for Callable<T> because depending on the type of tasks passed to an (Scheduled)Exectuor(Service) this is relevant when expecting results from that, e.g. using a Future.\nThis method should also have a default implementation returning the original callable. That way an implementer can still implement this using a lambda even though the interface has two methods and hence is strictly no SAM interface.", "author": "jetztgradnet", "createdAt": "2020-07-20T17:36:20Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/concurrent/TaskWrapper.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.federated.evaluation.concurrent;\n+\n+import java.util.concurrent.Executor;\n+\n+import org.eclipse.rdf4j.federated.FedXConfig;\n+\n+/**\n+ * A {@link TaskWrapper} is a facility to wrap {@link Runnable} background tasks before they are passed to the\n+ * {@link Executor}. Use-cases include injection of thread-local context variables, or more fine-granular error\n+ * handling.\n+ * \n+ * <p>\n+ * All sub-queries sent by the federation engine that make use of the concurrency infrastructure (e.g.\n+ * {@link ControlledWorkerScheduler}) are passing this wrapper.\n+ * </p>\n+ * \n+ * <p>\n+ * The concrete implementation can be configured using {@link FedXConfig#withTaskWrapper(TaskWrapper)}.\n+ * </p>\n+ * \n+ * @author Andreas Schwarte\n+ * @see DefaultTaskWrapper\n+ * @see ControlledWorkerScheduler\n+ * @see FedXConfig#withTaskWrapper(TaskWrapper)\n+ */\n+public interface TaskWrapper {\n+\n+\t/**\n+\t * Wrap the given {@link Runnable} and add custom logic.\n+\t * \n+\t * <p>\n+\t * Use cases include injection of state into the thread-local context, or more fine granular error handling.\n+\t * </p>\n+\t * \n+\t * <p>\n+\t * Note that when modifying state in {@link ThreadLocal} it must be reset properly in a try/finally block.\n+\t * </p>\n+\t * \n+\t * @param runnable the task as generated by the FedX engine\n+\t * @return the wrapped {@link Runnable}\n+\t */\n+\tpublic Runnable wrap(Runnable runnable);\n+", "originalCommit": "60ab98f94ae59414d549fe94691d82d20bdded22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MDczMg==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457580732", "bodyText": "when providing a default implementation of the methods this class could be avoided and the INSTANCE simpyl be moved into the interface.", "author": "jetztgradnet", "createdAt": "2020-07-20T17:38:42Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/concurrent/DefaultTaskWrapper.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.federated.evaluation.concurrent;\n+\n+/**\n+ * Default implementation of {@link TaskWrapper} which returns the unmodified original task\n+ * \n+ * @author Andreas Schwarte\n+ *\n+ */\n+public class DefaultTaskWrapper implements TaskWrapper {", "originalCommit": "60ab98f94ae59414d549fe94691d82d20bdded22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "37686de23d831d292a113c0248b8af0214b1bc7f", "url": "https://github.com/eclipse/rdf4j/commit/37686de23d831d292a113c0248b8af0214b1bc7f", "message": "GH-2366: address review feedback + configurability for FedX repo factory\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-20T20:04:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc3NjEyOA==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457776128", "bodyText": "Instead of adding a default no-op impl here (which automatically gets inherited by every implementation of TaskWrapper, imho a bit of a code smell) I suggest we instead allow TaskWrapper to be undefined (null or empty) and check for that in relevant places. Also removes the need for default implementations of methods in this interface (which makes discovering what methods to implement easier as well).", "author": "jeenbroekstra", "createdAt": "2020-07-21T01:07:14Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/evaluation/concurrent/TaskWrapper.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.federated.evaluation.concurrent;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.Executor;\n+\n+import org.eclipse.rdf4j.federated.FedXConfig;\n+\n+/**\n+ * A {@link TaskWrapper} is a facility to wrap {@link Runnable} background tasks before they are passed to the\n+ * {@link Executor}. Use-cases include injection of thread-local context variables, or more fine-granular error\n+ * handling.\n+ * \n+ * <p>\n+ * All sub-queries sent by the federation engine that make use of the concurrency infrastructure (e.g.\n+ * {@link ControlledWorkerScheduler}) are passing this wrapper.\n+ * </p>\n+ * \n+ * <p>\n+ * The concrete implementation can be configured using {@link FedXConfig#withTaskWrapper(TaskWrapper)}.\n+ * </p>\n+ * \n+ * @author Andreas Schwarte\n+ * @see ControlledWorkerScheduler\n+ * @see FedXConfig#withTaskWrapper(TaskWrapper)\n+ */\n+public interface TaskWrapper {\n+\n+\t/**\n+\t * Default implementation of {@link TaskWrapper} which returns the unmodified original task\n+\t */\n+\tstatic final TaskWrapper DEFAULT = new TaskWrapper() {\n+\t};", "originalCommit": "37686de23d831d292a113c0248b8af0214b1bc7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMTMyMw==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457831323", "bodyText": "Done, comment is addressed. Let me know if this works for you", "author": "aschwarte10", "createdAt": "2020-07-21T04:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc3NjEyOA=="}], "type": "inlineReview"}, {"oid": "7659cb7a96c46c294bda7a2e1384d829da63e6ed", "url": "https://github.com/eclipse/rdf4j/commit/7659cb7a96c46c294bda7a2e1384d829da63e6ed", "message": "GH-2366: refine interface definition\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-21T04:36:37Z", "type": "commit"}, {"oid": "de2e229b9ba1ad9eb517d6e75cffaea4a3de31fd", "url": "https://github.com/eclipse/rdf4j/commit/de2e229b9ba1ad9eb517d6e75cffaea4a3de31fd", "message": "GH-2366: formatting\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-21T04:42:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMjYyMQ==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457832621", "bodyText": "You're passing the Optional, rather than the TaskWrapper - will that work?", "author": "jeenbroekstra", "createdAt": "2020-07-21T04:43:59Z", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "diffHunk": "@@ -103,28 +105,46 @@ public void reset() {\n \t\t\tlog.debug(\"Scheduler for join and union are reset.\");\n \t\t}\n \n+\t\tOptional<TaskWrapper> taskWrapper = federationContext.getConfig().getTaskWrapper();\n \t\tif (joinScheduler != null) {\n \t\t\tjoinScheduler.abort();\n \t\t}\n \t\tjoinScheduler = new ControlledWorkerScheduler<>(federationContext.getConfig().getJoinWorkerThreads(),\n \t\t\t\t\"Join Scheduler\");\n+\t\tjoinScheduler.setTaskWrapper(taskWrapper);", "originalCommit": "de2e229b9ba1ad9eb517d6e75cffaea4a3de31fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMzI1OA==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457833258", "bodyText": "Ah never mind I see what you did - added an overloaded setter.\nI personally prefer handling the Optional at the point of message passing rather than inside the setter:\nfederationContext.getConfig().getTaskWrapper().ifPresent(joinScheduler::setTaskWrapper);\n\nbut YMMV.", "author": "jeenbroekstra", "createdAt": "2020-07-21T04:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMjYyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzNDY1MQ==", "url": "https://github.com/eclipse/rdf4j/pull/2370#discussion_r457834651", "bodyText": "That looks better, will change and remove the default implementation for optional. Thanks", "author": "aschwarte10", "createdAt": "2020-07-21T04:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMjYyMQ=="}], "type": "inlineReview"}, {"oid": "487f7e7da7f396f5a7505b7e3bf5e9a292b15fb6", "url": "https://github.com/eclipse/rdf4j/commit/487f7e7da7f396f5a7505b7e3bf5e9a292b15fb6", "message": "GH-2366: minor editorial call change\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>", "committedDate": "2020-07-21T04:55:28Z", "type": "commit"}]}