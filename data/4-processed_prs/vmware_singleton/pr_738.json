{"pr_number": 738, "pr_title": "[g11n-java-client] Fix for issue #717 - non-supported locales trigger a request to VIP service in a separate thread for every getMessage/getMessages request", "pr_createdAt": "2020-08-25T06:20:10Z", "pr_url": "https://github.com/vmware/singleton/pull/738", "timeline": [{"oid": "b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d", "url": "https://github.com/vmware/singleton/commit/b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d", "message": "Fix for bug 717", "committedDate": "2020-08-25T06:14:02Z", "type": "commit"}, {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8", "url": "https://github.com/vmware/singleton/commit/9935a6c9a2230700023edd56f9442c1adf12d4e8", "message": "Updating license headers", "committedDate": "2020-08-25T13:22:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r476483593", "bodyText": "Should add an 'else' before if?", "author": "Xiaochao8", "createdAt": "2020-08-25T14:16:00Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "originalCommit": "9935a6c9a2230700023edd56f9442c1adf12d4e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNjI0Nw==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r477436247", "bodyText": "No, we still want to refresh expired cacheItem even if it is for the fallback locale (returned in line 115).", "author": "jessiejuachon", "createdAt": "2020-08-26T16:36:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ1Mjg0Ng==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r477452846", "bodyText": "Lines 117-119 is actually not new. It is the fix for #664 and #662\nLines 108-116 is only a replacement for lines 113-115 of old code. See that in old code, there is also no \"else\", only 2 \"ifs\"", "author": "jessiejuachon", "createdAt": "2020-08-26T17:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk3NDExNw==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478974117", "bodyText": "I think it's necessary to add it because the cache of fallback locale will be refreshed in line 115 because of the call getMessages with default locale.\nIf no 'else', it will be refreshed twice, right?", "author": "Xiaochao8", "createdAt": "2020-08-28T08:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1NjYyOQ==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r480256629", "bodyText": "You are right. I have updated it.", "author": "jessiejuachon", "createdAt": "2020-08-31T16:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzY4Mw==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478953683", "bodyText": "For creating second time, it doesn't need to do fallback. How about using 'resreshCache' without locale fallback? This will improve performance.", "author": "Xiaochao8", "createdAt": "2020-08-28T08:42:54Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);", "originalCommit": "9935a6c9a2230700023edd56f9442c1adf12d4e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDM4MQ==", "url": "https://github.com/vmware/singleton/pull/738#discussion_r480390381", "bodyText": "Changed line 111 to this.createCacheItemTask(null); Passing null means locale fallback will not be applied.", "author": "jessiejuachon", "createdAt": "2020-08-31T20:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzY4Mw=="}], "type": "inlineReview"}, {"oid": "1341e72cb76fc48b59159e94bd69b138317484f6", "url": "https://github.com/vmware/singleton/commit/1341e72cb76fc48b59159e94bd69b138317484f6", "message": "Updates after code review - code optimization", "committedDate": "2020-08-31T20:59:46Z", "type": "commit"}]}