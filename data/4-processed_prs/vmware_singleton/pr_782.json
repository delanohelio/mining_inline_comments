{"pr_number": 782, "pr_title": "Fix for bug 781 - ComponentService.getMessages is not retrieving \"matchedLocale\" from cache properly", "pr_createdAt": "2020-09-14T19:35:14Z", "pr_url": "https://github.com/vmware/singleton/pull/782", "timeline": [{"oid": "b76346c41a944787e2b314b46c95c6900467676e", "url": "https://github.com/vmware/singleton/commit/b76346c41a944787e2b314b46c95c6900467676e", "message": "Fix for bug 781 - L3's CacheService.getSupportedLocalesFromCache is incorrectly using L2's data.", "committedDate": "2020-09-14T19:33:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMzMDE4MA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r488330180", "bodyText": "To make sure these 2 lines can be performed, above code should be in catch block.", "author": "Xiaochao8", "createdAt": "2020-09-15T01:37:12Z", "path": "src/test/java/com/vmware/vipclient/i18n/messages/service/CacheServiceTest.java", "diffHunk": "@@ -225,4 +229,26 @@ public void testExpireUsingCacheExpiredTimeConfig() throws InterruptedException\n         responseTime2 = cacheItem.getTimestamp();\n         assertTrue(responseTime2 > responseTime); \n     }\n+\n+    @Test\n+    public void testGetSupportedLocalesOfflineBundles() {\n+        //Enable offline mode\n+        String offlineResourcesBaseUrlOrig = cfg.getOfflineResourcesBaseUrl();\n+        cfg.setOfflineResourcesBaseUrl(\"offlineBundles/\");\n+        List<DataSourceEnum> msgOriginsQueueOrig = cfg.getMsgOriginsQueue();\n+        cfg.setMsgOriginsQueue(new LinkedList<>(Arrays.asList(DataSourceEnum.Bundle)));\n+\n+        cfg.createTranslationCache(MessageCache.class);\n+        cfg.initializeMessageCache();\n+\n+        CacheService cs = new CacheService(new MessagesDTO());\n+        List<Locale> supportedLocales = cs.getSupportedLocalesFromCache();\n+        assertTrue(supportedLocales.contains(Locale.forLanguageTag(\"fil\")));\n+        assertEquals(\"Filipino\", supportedLocales.get(\n+                supportedLocales.indexOf(Locale.forLanguageTag(\"fil\"))).getDisplayName());\n+\n+        // Disable offline mode off for next tests.\n+        cfg.setOfflineResourcesBaseUrl(offlineResourcesBaseUrlOrig);", "originalCommit": "b76346c41a944787e2b314b46c95c6900467676e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6aa09e4cdbcaef61b32385310acb75db46f8618", "url": "https://github.com/vmware/singleton/commit/a6aa09e4cdbcaef61b32385310acb75db46f8618", "message": "code clean up", "committedDate": "2020-09-15T02:22:14Z", "type": "commit"}, {"oid": "550de8c10adc68e50124a5be911f6cc15e5434fd", "url": "https://github.com/vmware/singleton/commit/550de8c10adc68e50124a5be911f6cc15e5434fd", "message": "code clean up", "committedDate": "2020-09-15T15:27:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwNjE4MQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489106181", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                    } finally {", "author": "Xiaochao8", "createdAt": "2020-09-16T01:23:25Z", "path": "src/test/java/com/vmware/vipclient/i18n/messages/service/CacheServiceTest.java", "diffHunk": "@@ -238,17 +238,19 @@ public void testGetSupportedLocalesOfflineBundles() {\n         List<DataSourceEnum> msgOriginsQueueOrig = cfg.getMsgOriginsQueue();\n         cfg.setMsgOriginsQueue(new LinkedList<>(Arrays.asList(DataSourceEnum.Bundle)));\n \n-        cfg.createTranslationCache(MessageCache.class);\n-        cfg.initializeMessageCache();\n-\n-        CacheService cs = new CacheService(new MessagesDTO());\n-        List<Locale> supportedLocales = cs.getCachedLocales();\n-        assertTrue(supportedLocales.contains(Locale.forLanguageTag(\"fil\")));\n-        assertEquals(\"Filipino\", supportedLocales.get(\n-                supportedLocales.indexOf(Locale.forLanguageTag(\"fil\"))).getDisplayName());\n+        try {\n+            cfg.createTranslationCache(MessageCache.class);\n+            cfg.initializeMessageCache();\n \n-        // Disable offline mode off for next tests.\n-        cfg.setOfflineResourcesBaseUrl(offlineResourcesBaseUrlOrig);\n-        cfg.setMsgOriginsQueue(msgOriginsQueueOrig);\n+            CacheService cs = new CacheService(new MessagesDTO());\n+            List<Locale> supportedLocales = cs.getCachedLocales();\n+            assertTrue(supportedLocales.contains(Locale.forLanguageTag(\"fil\")));\n+            assertEquals(\"Filipino\", supportedLocales.get(\n+                    supportedLocales.indexOf(Locale.forLanguageTag(\"fil\"))).getDisplayName());\n+        } catch (Exception e) {", "originalCommit": "550de8c10adc68e50124a5be911f6cc15e5434fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1599f5c616b65f1592e7d4590cfbe5380b1c1d09", "url": "https://github.com/vmware/singleton/commit/1599f5c616b65f1592e7d4590cfbe5380b1c1d09", "message": "Fix for issue 781: CacheService.getCacheOfComponent cannot get \"matchedLocale\" properly if L2 supported locale list cache is not yet populated.", "committedDate": "2020-09-17T01:09:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NTYyOA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489865628", "bodyText": "What's this change for?", "author": "Xiaochao8", "createdAt": "2020-09-17T01:45:01Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -25,19 +22,20 @@ public CacheService(MessagesDTO dto) {\n     }\n     \n     public MessageCacheItem getCacheOfComponent() {\n+        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n+        if (c == null)\n+            return null;\n         String cacheKey = dto.getCompositStrAsCacheKey();\n+        MessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n+        if (cacheItem != null)\n+            return cacheItem;\n         Locale matchedLocale = LocaleUtility.pickupLocaleFromList(\n-                this.getCachedLocales(),\n+                this.getSupportedLocalesFromCache(),\n                 this.getLocaleByCachedKey(cacheKey));\n         cacheKey = cacheKey.substring(0,\n                 cacheKey.indexOf(ConstantsKeys.UNDERLINE_POUND) + 2)\n                 + matchedLocale.toLanguageTag();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return null;\n-        } else {\n-            return (MessageCacheItem) c.get(cacheKey);\n-        }\n+        return (MessageCacheItem) c.get(cacheKey);", "originalCommit": "1599f5c616b65f1592e7d4590cfbe5380b1c1d09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk0OTI5Mw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489949293", "bodyText": "See issue 781 for description. #781", "author": "jessiejuachon", "createdAt": "2020-09-17T04:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NTYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NzI0MQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489867241", "bodyText": "Product service should consume cache service. But here cache service makes use of product service. It seems a design problem.", "author": "Xiaochao8", "createdAt": "2020-09-17T01:47:36Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -101,17 +99,14 @@ public void addCacheOfStatus(Map<String, String> dataMap) {\n         }\n     }\n \n-    public List<Locale> getCachedLocales() {\n-        List<Locale> locales = new ArrayList<>();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return locales;\n-        }\n-        Set<String> cacheKeys = c.keySet();\n-        for (String key: cacheKeys) {\n-            locales.add(getLocaleByCachedKey(key));\n+    public List<Locale> getSupportedLocalesFromCache() {\n+        List<Locale> result = new LinkedList<>();", "originalCommit": "1599f5c616b65f1592e7d4590cfbe5380b1c1d09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg4MTQwOQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489881409", "bodyText": "You have a point. Let me move things around.", "author": "jessiejuachon", "createdAt": "2020-09-17T02:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NzI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MTg0Mw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490251843", "bodyText": "@Xiaochao8 I think it's ok to call product service here, because it's reasonable for service classes to call each other.\nTo avoid this, I see Jessiely need make changes to multiple files,  I think it's unnecessary. How do you think?\n@jessiejuachon Not sure if it's easy for you to revert the change for this?", "author": "huihuiw01", "createdAt": "2020-09-17T13:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NzI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4ODYzOA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490588638", "bodyText": "Actually, I realized that what's needed in CacheService.isContainComponent and CacheService.getCacheOfComponent is not the actual list of supported locales. Instead, it only needs the list of locales of currently cached messages in L3. In other words, a locale may be supported in VIP service, but if its messages are not yet in client-side cache, it should not be included in the list to pick from.\nI have reverted back most changes. Please review again.", "author": "jessiejuachon", "createdAt": "2020-09-17T22:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2NzI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2ODA5OQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489868099", "bodyText": "Don't know how the locale are from cache. Does product service get data from cache?", "author": "Xiaochao8", "createdAt": "2020-09-17T01:48:51Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -101,17 +99,14 @@ public void addCacheOfStatus(Map<String, String> dataMap) {\n         }\n     }\n \n-    public List<Locale> getCachedLocales() {\n-        List<Locale> locales = new ArrayList<>();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return locales;\n-        }\n-        Set<String> cacheKeys = c.keySet();\n-        for (String key: cacheKeys) {\n-            locales.add(getLocaleByCachedKey(key));\n+    public List<Locale> getSupportedLocalesFromCache() {", "originalCommit": "1599f5c616b65f1592e7d4590cfbe5380b1c1d09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg3ODk4NQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489878985", "bodyText": "If you see in ProductService, it uses the cache, but also tries to fetch from data store if not found in cache and loads it in cache.", "author": "jessiejuachon", "createdAt": "2020-09-17T02:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2ODA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NDIyNg==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490754226", "bodyText": "If it is the cases. This method should belong to product service. This is the normal way to get locales. get locale request -> service -> cache-> data source.", "author": "Xiaochao8", "createdAt": "2020-09-18T07:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg2ODA5OQ=="}], "type": "inlineReview"}, {"oid": "8f0a9ddb949210dfb1b1bb4cdae68b476f2ec144", "url": "https://github.com/vmware/singleton/commit/8f0a9ddb949210dfb1b1bb4cdae68b476f2ec144", "message": "adding test", "committedDate": "2020-09-17T02:03:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkzMjk4Mw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489932983", "bodyText": "I think you needn't convert locale list to locale map, just add locale list to cache is enough.", "author": "huihuiw01", "createdAt": "2020-09-17T03:33:24Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -77,18 +73,31 @@ public ProductService(BaseDTO dto) {\n      *\n      * @return list of locales of the product specified in the dto object\n      */\n-    public List<String> getSupportedLocales(){\n-        List<String> locales = null;\n+    public Set<String> getSupportedLocales(){\n+        FormattingCacheService cacheService = new FormattingCacheService();\n+        Map<String, String> supportedLanguages = cacheService.getSupportedLanguages(dto);\n+        if (supportedLanguages != null && !supportedLanguages.isEmpty())\n+            return supportedLanguages.keySet();\n+\n+        Set<String> locales = new HashSet<>();\n         Iterator<DataSourceEnum> msgSourceQueueIter = VIPCfg.getInstance().getMsgOriginsQueue().iterator();\n-        while((locales == null || locales.isEmpty()) && msgSourceQueueIter.hasNext()){\n+        while(locales.isEmpty() && msgSourceQueueIter.hasNext()){\n             DataSourceEnum dataSource = msgSourceQueueIter.next();\n             ProductOpt opt = dataSource.createProductOpt(dto);\n-            locales = opt.getSupportedLocales();\n+            locales.addAll(opt.getSupportedLocales());\n             // If failed to get locales from the data source, log the error.\n-            if (locales == null || locales.isEmpty()) {\n+            if (locales.isEmpty()) {\n                 logger.error(ConstantsMsg.GET_LOCALES_FAILED, dataSource.toString());\n             }\n         }\n+\n+        // Add list of supported locales to cache\n+        Map<String, String> cacheMap = new HashMap<>();\n+        for (String locale : locales) {\n+            cacheMap.put(locale, \"\");", "originalCommit": "8f0a9ddb949210dfb1b1bb4cdae68b476f2ec144", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk0Nzk5NQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r489947995", "bodyText": "FormattingCacheItem has a Map<String,String> property. How do you add a list instead?", "author": "jessiejuachon", "createdAt": "2020-09-17T03:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkzMjk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzA4NA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490253084", "bodyText": "Get it, it make sense to convert it to a map for reusing cacheItem Object.", "author": "huihuiw01", "createdAt": "2020-09-17T13:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkzMjk4Mw=="}], "type": "inlineReview"}, {"oid": "24b8e3a075254feae7a9c35d6cbe406b3a14780e", "url": "https://github.com/vmware/singleton/commit/24b8e3a075254feae7a9c35d6cbe406b3a14780e", "message": "code clean up", "committedDate": "2020-09-17T03:55:27Z", "type": "commit"}, {"oid": "22b2159f01fc3311cb18b4ec93eb50e6b5545b7c", "url": "https://github.com/vmware/singleton/commit/22b2159f01fc3311cb18b4ec93eb50e6b5545b7c", "message": "code clean up", "committedDate": "2020-09-17T04:25:08Z", "type": "commit"}, {"oid": "4247c994d7edc94bab9f178f714ee779e9633ec8", "url": "https://github.com/vmware/singleton/commit/4247c994d7edc94bab9f178f714ee779e9633ec8", "message": "code clean up", "committedDate": "2020-09-17T21:18:16Z", "type": "commit"}, {"oid": "88a0a4c9252680a248be21158e361b1a6652c569", "url": "https://github.com/vmware/singleton/commit/88a0a4c9252680a248be21158e361b1a6652c569", "message": "code clean up", "committedDate": "2020-09-17T21:54:02Z", "type": "commit"}, {"oid": "3d82802c83348c7bad66f6b4c58521fa69a2e43d", "url": "https://github.com/vmware/singleton/commit/3d82802c83348c7bad66f6b4c58521fa69a2e43d", "message": "code clean up", "committedDate": "2020-09-17T22:01:09Z", "type": "commit"}, {"oid": "444b0bf7d50cd00a2b56f44ef947759fbb451efb", "url": "https://github.com/vmware/singleton/commit/444b0bf7d50cd00a2b56f44ef947759fbb451efb", "message": "code clean up", "committedDate": "2020-09-17T22:25:09Z", "type": "commit"}, {"oid": "d975d9796b68690d669d61685bec6e646bf610df", "url": "https://github.com/vmware/singleton/commit/d975d9796b68690d669d61685bec6e646bf610df", "message": "adding test", "committedDate": "2020-09-18T01:37:58Z", "type": "commit"}, {"oid": "d7a9a44184972db0266d45725a736db45ad0b94b", "url": "https://github.com/vmware/singleton/commit/d7a9a44184972db0266d45725a736db45ad0b94b", "message": "fixing test", "committedDate": "2020-09-18T01:52:45Z", "type": "commit"}, {"oid": "534137ac37d9d112ea0b90faf32f18b33a0843b5", "url": "https://github.com/vmware/singleton/commit/534137ac37d9d112ea0b90faf32f18b33a0843b5", "message": "fixing test", "committedDate": "2020-09-18T02:01:54Z", "type": "commit"}, {"oid": "7e540e9ad43cc82954d97a6516726f682172b11f", "url": "https://github.com/vmware/singleton/commit/7e540e9ad43cc82954d97a6516726f682172b11f", "message": "fixing test", "committedDate": "2020-09-18T02:07:33Z", "type": "commit"}, {"oid": "8899bfe6698c88d86bca1973bab3ce9dbbc4a2e4", "url": "https://github.com/vmware/singleton/commit/8899bfe6698c88d86bca1973bab3ce9dbbc4a2e4", "message": "fixing test", "committedDate": "2020-09-18T02:24:13Z", "type": "commit"}, {"oid": "5ce24535976e852325ecc330570b3fac50d81080", "url": "https://github.com/vmware/singleton/commit/5ce24535976e852325ecc330570b3fac50d81080", "message": "code clean up", "committedDate": "2020-09-18T02:27:12Z", "type": "commit"}, {"oid": "c5e9620db2a0af01c4226169b07beec90abee0b8", "url": "https://github.com/vmware/singleton/commit/c5e9620db2a0af01c4226169b07beec90abee0b8", "message": "code clean up", "committedDate": "2020-09-18T02:33:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3ODQ5OA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490778498", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    CacheItem cacheItem = c.get(key);\n          \n          \n            \n                    return cacheItem;\n          \n          \n            \n                    return c.get(key);", "author": "Xiaochao8", "createdAt": "2020-09-18T08:13:51Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -6,127 +6,101 @@\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n-import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.base.cache.CacheItem;\n import com.vmware.vipclient.i18n.base.cache.MessageCacheItem;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n import com.vmware.vipclient.i18n.util.ConstantsKeys;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n-import java.util.Set;\n+import java.util.*;\n \n public class CacheService {\n     private MessagesDTO dto;\n \n     public CacheService(MessagesDTO dto) {\n         this.dto = dto;\n     }\n-    \n+\n     public MessageCacheItem getCacheOfComponent() {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(\n-                this.getSupportedLocalesFromCache(),\n+        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(this.getLocalesOfCachedMsgs(),\n                 this.getLocaleByCachedKey(cacheKey));\n         cacheKey = cacheKey.substring(0,\n                 cacheKey.indexOf(ConstantsKeys.UNDERLINE_POUND) + 2)\n                 + matchedLocale.toLanguageTag();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return null;\n-        } else {\n-            return (MessageCacheItem) c.get(cacheKey);\n-        }\n+        return (MessageCacheItem) this.getCacheItem(cacheKey);\n     }\n \n     public void addCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            c.put(cacheKey, itemToCache);\n-        }\n+        this.addCacheItem(cacheKey, itemToCache);\n     }\n \n     public void updateCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            MessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n-            if (cacheItem == null) {\n-            \tcacheItem = new MessageCacheItem();\n-            \tc.put(cacheKey, cacheItem);\n-            }\n-            cacheItem.setCacheItem(itemToCache);\n+        MessageCacheItem cacheItem = (MessageCacheItem) this.getCacheItem(cacheKey);\n+        if (cacheItem == null) {\n+            cacheItem = new MessageCacheItem();\n+            this.addCacheItem(cacheKey, cacheItem);\n         }\n-    }\n-\n-    public boolean isContainComponent() {\n-        boolean f = false;\n-        String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            f = c.get(cacheKey) != null;\n-        }\n-        return f;\n+        cacheItem.setCacheItem(itemToCache);\n     }\n \n     public boolean isContainStatus() {\n-        boolean f = false;\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            f = c.keySet().contains(cacheKey);\n-        }\n-        return f;\n+        return this.getCacheItem(cacheKey) != null;\n     }\n \n     public Map<String, String> getCacheOfStatus() {\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-        \tMessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n-        \tif (cacheItem != null) {\n-        \t\treturn (Map<String, String>) cacheItem.getCachedData();\n-        \t}\n+        MessageCacheItem cacheItem = (MessageCacheItem) this.getCacheItem(cacheKey);\n+        if (cacheItem != null) {\n+            return cacheItem.getCachedData();\n         }\n         return null;\n     }\n \n     public void addCacheOfStatus(Map<String, String> dataMap) {\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            c.put(cacheKey, new MessageCacheItem(dataMap));\n-        }\n+        addCacheItem(cacheKey, new MessageCacheItem(dataMap));\n     }\n \n-    public List<Locale> getSupportedLocalesFromCache() {\n-        List<Locale> locales = new ArrayList<Locale>();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L2);\n-        if (c == null) {\n-            return locales;\n-        }\n-        Set<String> keySet = c.keySet();\n-       \n-        for (String key : keySet) {\n-        \tif (key.startsWith(ConstantsKeys.DISPNS_PREFIX)) {\n-        \t\tFormatCacheItem cacheItem = (FormatCacheItem) c.get(key);\n-        \t\tMap<String, String> langTagToDisplayNameMap = cacheItem.getCachedData();\n-        \t\tfor (String languageTag : langTagToDisplayNameMap.keySet()) {\n-        \t\t\tlocales.add(Locale.forLanguageTag(languageTag));\n-        \t\t}\n-        \t\tbreak;\n-        \t}\n+    public List<Locale> getLocalesOfCachedMsgs() {\n+        List<Locale> locales = new LinkedList<>();\n+        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n+        if (c != null) {\n+            Set<String> cacheKeys = c.keySet();\n+            for (String key : cacheKeys) {\n+                Locale locale = getLocaleByCachedKey(key);\n+                if (locale != null)\n+                    locales.add(locale);\n+            }\n         }\n         return locales;\n     }\n \n     private Locale getLocaleByCachedKey(String key) {\n+        if (key.startsWith(ConstantsKeys.DISPNS_PREFIX))\n+            return null;\n         String locale = key.substring(\n                 key.indexOf(ConstantsKeys.UNDERLINE_POUND) + 2, key.length());\n         return Locale.forLanguageTag(locale.replace(\"_\", \"-\"));\n     }\n-    \n+\n+    private void addCacheItem(String key, CacheItem cacheItem) {\n+        if (key != null && cacheItem != null) {\n+            Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n+            if (c != null) {\n+                c.put(key, cacheItem);\n+            }\n+        }\n+    }\n+\n+    private CacheItem getCacheItem(String key) {\n+        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n+        if (c == null)\n+            return null;\n+        CacheItem cacheItem = c.get(key);\n+        return cacheItem;", "originalCommit": "c5e9620db2a0af01c4226169b07beec90abee0b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3OTQxMQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490779411", "bodyText": "Please don't remove this method, this is to fix a bug about source collection. Need to store null objects to cache to avoid bugs.\nYou can confirm this with Colin.", "author": "Xiaochao8", "createdAt": "2020-09-18T08:15:20Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -6,127 +6,101 @@\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n-import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.base.cache.CacheItem;\n import com.vmware.vipclient.i18n.base.cache.MessageCacheItem;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n import com.vmware.vipclient.i18n.util.ConstantsKeys;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n-import java.util.Set;\n+import java.util.*;\n \n public class CacheService {\n     private MessagesDTO dto;\n \n     public CacheService(MessagesDTO dto) {\n         this.dto = dto;\n     }\n-    \n+\n     public MessageCacheItem getCacheOfComponent() {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(\n-                this.getSupportedLocalesFromCache(),\n+        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(this.getLocalesOfCachedMsgs(),\n                 this.getLocaleByCachedKey(cacheKey));\n         cacheKey = cacheKey.substring(0,\n                 cacheKey.indexOf(ConstantsKeys.UNDERLINE_POUND) + 2)\n                 + matchedLocale.toLanguageTag();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return null;\n-        } else {\n-            return (MessageCacheItem) c.get(cacheKey);\n-        }\n+        return (MessageCacheItem) this.getCacheItem(cacheKey);\n     }\n \n     public void addCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            c.put(cacheKey, itemToCache);\n-        }\n+        this.addCacheItem(cacheKey, itemToCache);\n     }\n \n     public void updateCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            MessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n-            if (cacheItem == null) {\n-            \tcacheItem = new MessageCacheItem();\n-            \tc.put(cacheKey, cacheItem);\n-            }\n-            cacheItem.setCacheItem(itemToCache);\n+        MessageCacheItem cacheItem = (MessageCacheItem) this.getCacheItem(cacheKey);\n+        if (cacheItem == null) {\n+            cacheItem = new MessageCacheItem();\n+            this.addCacheItem(cacheKey, cacheItem);\n         }\n-    }\n-\n-    public boolean isContainComponent() {", "originalCommit": "c5e9620db2a0af01c4226169b07beec90abee0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NzI0Mw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r491247243", "bodyText": "I put it back, but if you check the code, it is exactly the same as CacheService.getCacheOfComponent()!=null\nPlease review to double-check and let me know. It would be good to remove this method if it is not necessary.\nOn that note, we are not going to use the java client library for source collection anymore, even for existing products.\nAlso, if you check where CacheService.addCacheOfComponent is invoked, you will see that we do not store null in the cache. We do not even store a MessageCacheItem with an empty map.", "author": "jessiejuachon", "createdAt": "2020-09-19T00:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3OTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2NzAzOA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492167038", "bodyText": "@Xiaochao8 , did you check where this method is used? Do you agree that we can remove it to simplify code? We can replace\nMessageCacheItem cacheItem = null;\nif (cacheService.isContainComponent()) { // Item is in cache\ncacheItem = cacheService.getCacheOfComponent();\nwith\nMessageCacheItem cacheItem = cacheService.getCacheOfComponent();\nif (cacheItem != null) { // Item is in cache`\\", "author": "jessiejuachon", "createdAt": "2020-09-21T15:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3OTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxMDAxNg==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492510016", "bodyText": "After offline discussion, the conclusion is to remove this method.", "author": "jessiejuachon", "createdAt": "2020-09-22T06:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc3OTQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzgxNA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r490783814", "bodyText": "We should have a prefix for translation bundles. If not and  there is a new prefix added, this line needs to be changed.", "author": "Xiaochao8", "createdAt": "2020-09-18T08:23:24Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -6,127 +6,101 @@\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n-import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.base.cache.CacheItem;\n import com.vmware.vipclient.i18n.base.cache.MessageCacheItem;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n import com.vmware.vipclient.i18n.util.ConstantsKeys;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n-import java.util.Set;\n+import java.util.*;\n \n public class CacheService {\n     private MessagesDTO dto;\n \n     public CacheService(MessagesDTO dto) {\n         this.dto = dto;\n     }\n-    \n+\n     public MessageCacheItem getCacheOfComponent() {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(\n-                this.getSupportedLocalesFromCache(),\n+        Locale matchedLocale = LocaleUtility.pickupLocaleFromList(this.getLocalesOfCachedMsgs(),\n                 this.getLocaleByCachedKey(cacheKey));\n         cacheKey = cacheKey.substring(0,\n                 cacheKey.indexOf(ConstantsKeys.UNDERLINE_POUND) + 2)\n                 + matchedLocale.toLanguageTag();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c == null) {\n-            return null;\n-        } else {\n-            return (MessageCacheItem) c.get(cacheKey);\n-        }\n+        return (MessageCacheItem) this.getCacheItem(cacheKey);\n     }\n \n     public void addCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            c.put(cacheKey, itemToCache);\n-        }\n+        this.addCacheItem(cacheKey, itemToCache);\n     }\n \n     public void updateCacheOfComponent(MessageCacheItem itemToCache) {\n         String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            MessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n-            if (cacheItem == null) {\n-            \tcacheItem = new MessageCacheItem();\n-            \tc.put(cacheKey, cacheItem);\n-            }\n-            cacheItem.setCacheItem(itemToCache);\n+        MessageCacheItem cacheItem = (MessageCacheItem) this.getCacheItem(cacheKey);\n+        if (cacheItem == null) {\n+            cacheItem = new MessageCacheItem();\n+            this.addCacheItem(cacheKey, cacheItem);\n         }\n-    }\n-\n-    public boolean isContainComponent() {\n-        boolean f = false;\n-        String cacheKey = dto.getCompositStrAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            f = c.get(cacheKey) != null;\n-        }\n-        return f;\n+        cacheItem.setCacheItem(itemToCache);\n     }\n \n     public boolean isContainStatus() {\n-        boolean f = false;\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            f = c.keySet().contains(cacheKey);\n-        }\n-        return f;\n+        return this.getCacheItem(cacheKey) != null;\n     }\n \n     public Map<String, String> getCacheOfStatus() {\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-        \tMessageCacheItem cacheItem = (MessageCacheItem) c.get(cacheKey);\n-        \tif (cacheItem != null) {\n-        \t\treturn (Map<String, String>) cacheItem.getCachedData();\n-        \t}\n+        MessageCacheItem cacheItem = (MessageCacheItem) this.getCacheItem(cacheKey);\n+        if (cacheItem != null) {\n+            return cacheItem.getCachedData();\n         }\n         return null;\n     }\n \n     public void addCacheOfStatus(Map<String, String> dataMap) {\n         String cacheKey = dto.getTransStatusAsCacheKey();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n-        if (c != null) {\n-            c.put(cacheKey, new MessageCacheItem(dataMap));\n-        }\n+        addCacheItem(cacheKey, new MessageCacheItem(dataMap));\n     }\n \n-    public List<Locale> getSupportedLocalesFromCache() {\n-        List<Locale> locales = new ArrayList<Locale>();\n-        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L2);\n-        if (c == null) {\n-            return locales;\n-        }\n-        Set<String> keySet = c.keySet();\n-       \n-        for (String key : keySet) {\n-        \tif (key.startsWith(ConstantsKeys.DISPNS_PREFIX)) {\n-        \t\tFormatCacheItem cacheItem = (FormatCacheItem) c.get(key);\n-        \t\tMap<String, String> langTagToDisplayNameMap = cacheItem.getCachedData();\n-        \t\tfor (String languageTag : langTagToDisplayNameMap.keySet()) {\n-        \t\t\tlocales.add(Locale.forLanguageTag(languageTag));\n-        \t\t}\n-        \t\tbreak;\n-        \t}\n+    public List<Locale> getLocalesOfCachedMsgs() {\n+        List<Locale> locales = new LinkedList<>();\n+        Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n+        if (c != null) {\n+            Set<String> cacheKeys = c.keySet();\n+            for (String key : cacheKeys) {\n+                Locale locale = getLocaleByCachedKey(key);\n+                if (locale != null)\n+                    locales.add(locale);\n+            }\n         }\n         return locales;\n     }\n \n     private Locale getLocaleByCachedKey(String key) {\n+        if (key.startsWith(ConstantsKeys.DISPNS_PREFIX))", "originalCommit": "c5e9620db2a0af01c4226169b07beec90abee0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NjkyNw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r491246927", "bodyText": "This change is not related to this PR so I have removed it.", "author": "jessiejuachon", "createdAt": "2020-09-19T00:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzgxNA=="}], "type": "inlineReview"}, {"oid": "d2905e394b44b4dbca0b1f649553d8c18e0ac5b3", "url": "https://github.com/vmware/singleton/commit/d2905e394b44b4dbca0b1f649553d8c18e0ac5b3", "message": "code cleanup", "committedDate": "2020-09-18T19:13:45Z", "type": "commit"}, {"oid": "8b1e4e942eb38181e3a570181910b80d3d2467a3", "url": "https://github.com/vmware/singleton/commit/8b1e4e942eb38181e3a570181910b80d3d2467a3", "message": "code clean up", "committedDate": "2020-09-18T22:32:58Z", "type": "commit"}, {"oid": "303957ed1b264b5fdaa6b2b55f89ad5225565f14", "url": "https://github.com/vmware/singleton/commit/303957ed1b264b5fdaa6b2b55f89ad5225565f14", "message": "Update src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java\n\nCo-authored-by: Xiaochao Li <48587632+Xiaochao8@users.noreply.github.com>", "committedDate": "2020-09-18T22:51:17Z", "type": "commit"}, {"oid": "f238d95f5266b54feb7e585cad2138a8b3992be0", "url": "https://github.com/vmware/singleton/commit/f238d95f5266b54feb7e585cad2138a8b3992be0", "message": "adding comments to code", "committedDate": "2020-09-19T00:46:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzAwNQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r491863005", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Set<Locale> getSupportedLocales() {\n          \n          \n            \n                public Set<Locale> getSupportedLocaleSet() {", "author": "Xiaochao8", "createdAt": "2020-09-21T08:17:03Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -91,4 +87,18 @@ public ProductService(BaseDTO dto) {\n         }\n         return locales;\n     }\n+\n+    public Set<Locale> getSupportedLocales() {", "originalCommit": "303957ed1b264b5fdaa6b2b55f89ad5225565f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2OTM2OQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492169369", "bodyText": "We actually only need 1 method. I will use: public Set<Locale> getSupportedLocales() to replace the following 2 signatures:\n\npublic Set< Locale > getSupportedLocales()\npublic List< String > getSupportedLocales()", "author": "jessiejuachon", "createdAt": "2020-09-21T15:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzA5Nw==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r491863097", "bodyText": "Suggest not to change this method but to name new method to another name.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public List<String> getSupportedLanguageTags(){\n          \n          \n            \n                public List<String> getSupportedlocales(){", "author": "Xiaochao8", "createdAt": "2020-09-21T08:17:16Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -77,7 +73,7 @@ public ProductService(BaseDTO dto) {\n      *\n      * @return list of locales of the product specified in the dto object\n      */\n-    public List<String> getSupportedLocales(){\n+    public List<String> getSupportedLanguageTags(){", "originalCommit": "303957ed1b264b5fdaa6b2b55f89ad5225565f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE3MDA5NA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492170094", "bodyText": "See my comment above.", "author": "jessiejuachon", "createdAt": "2020-09-21T15:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzA5Nw=="}], "type": "inlineReview"}, {"oid": "d5dffd6d34f587752c26f625e22ecccb58bd4d06", "url": "https://github.com/vmware/singleton/commit/d5dffd6d34f587752c26f625e22ecccb58bd4d06", "message": "clean up code", "committedDate": "2020-09-21T15:58:49Z", "type": "commit"}, {"oid": "f09633098597875043343c72416e9f04f7984917", "url": "https://github.com/vmware/singleton/commit/f09633098597875043343c72416e9f04f7984917", "message": "Merge branch 'g11n-java-client-781' of github.com:jessiejuachon/singleton into g11n-java-client-781", "committedDate": "2020-09-21T16:00:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwOTYwNg==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492209606", "bodyText": "It looks a bit detour, how about move such logic to getMessages() method, and change getMessages() method like below?\npublic MessageCacheItem getMessages() {\nMessageCacheItem cacheItem = null;\nIterator fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\nProductService ps = new ProductService(dto);\nLocale matchedLocale = LocaleUtility.pickupLocaleFromList(new LinkedList<>(ps.getSupportedLocales()), Locale.forLanguageTag(dto.getLocale()));\nif (matchedLocale != null){//handle supported locales\nthis.dto.setLocale(matchedLocale.toLanguageTag());\nreturn this.getMessages(fallbackLocalesIter);\n}else{// handle non-supported locales\nwhile(fallbackLocalesIter.hasNext()){\nMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), fallbackLocalesIter.next().toLanguageTag(), dto.getProductID(), dto.getVersion());\ncacheItem = new ComponentService(fallbackLocaleDTO).getMessages(fallbackLocalesIter);\nif (!cacheItem.getCachedData().isEmpty())\nbreak;\n}\n}\nreturn cacheItem;\n}", "author": "huihuiw01", "createdAt": "2020-09-21T16:56:21Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -130,11 +131,23 @@ private MessageCacheItem createCacheItem(Iterator<Locale> fallbackLocalesIter) {\n \t\tCacheService cacheService = new CacheService(dto);\n \t\t// Create a new cacheItem object to be stored in cache\n \t\tMessageCacheItem cacheItem = new MessageCacheItem();\n-\t\trefreshCacheItem(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n \n+\t\tProductService ps = new ProductService(dto);\n+\t\tif (!ps.isSupportedLocale(Locale.forLanguageTag(dto.getLocale()))) {\n+\t\t\tLocale matchedLocale = LocaleUtility.pickupLocaleFromList(new LinkedList<>(ps.getSupportedLocales()), Locale.forLanguageTag(dto.getLocale()));\n+\t\t\tif (ps.isSupportedLocale(matchedLocale)) {\n+\t\t\t\tMessagesDTO matchedLocaleDTO = new MessagesDTO(dto.getComponent(), matchedLocale.toLanguageTag(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(matchedLocaleDTO).getMessages(null);\n+\t\t\t\tMessageCacheItem cacheItemCopy = new MessageCacheItem(matchedLocale.toLanguageTag(), null, null, System.currentTimeMillis(), cacheItem.getMaxAgeMillis());\n+\t\t\t\tcacheService.addCacheOfComponent(cacheItemCopy);\n+\t\t\t\treturn cacheItem;\n+\t\t\t}\n+\t\t}", "originalCommit": "303957ed1b264b5fdaa6b2b55f89ad5225565f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4MTE2NQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492481165", "bodyText": "@huihuiw01 , you are missing some use cases in your code suggestion above.\n\nWe need to fetch data from data store and create a new CacheItem if data is not found in cache (see line 119).\nWe need to check for expiry of MessageCacheItem objects and refresh the content accordingly. These are in lines 108-109, 116\nWe want fallbackLocalesIter to be a parameter of the method. If you trace getMessages, it eventually calls createCacheItem (if cacheItem is not yet in cache). In createCacheItem, if fallbackLocalesIter is null, no fallback is applied. We need this for use cases where fallback is not necessary.\nLocaleUtility.pickupLocaleFromList returns the second input parameter if no match was found from the first parameter, so your check if (matchedLocale != null){//handle supported locales does not work. My workaround for it is line 140.\n\nThat being said, yes we do not need to cache non-supported locales with an empty cacheData map anymore because we are now using ProductService.getSupportedLocales to identify which is supported and which is not. However, if you look at ProductService.getSupportedLocales, it is not yet using the cache, so each call to this method is expensive (as of now). Hence, I was planning to postpone code clean up to PR757.  What do you think?", "author": "jessiejuachon", "createdAt": "2020-09-22T05:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwOTYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MTc2NQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492471765", "bodyText": "Is this change related to the issue?", "author": "Xiaochao8", "createdAt": "2020-09-22T04:46:45Z", "path": "src/main/java/com/vmware/vipclient/i18n/base/cache/MessageCacheItem.java", "diffHunk": "@@ -21,6 +21,7 @@ public MessageCacheItem(Map<String, String> dataMap) {\n \t}\n \t\n \tpublic MessageCacheItem (String locale, Map<String, String> dataMap, String etag, long timestamp, Long maxAgeMillis) {\n+\t\tthis.maxAgeMillis = maxAgeMillis == null ? this.maxAgeMillis : maxAgeMillis;", "originalCommit": "f09633098597875043343c72416e9f04f7984917", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4MTQ2NQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492481465", "bodyText": "No, just code clean up. We do not want to override the default value with a null. Need separate PR?", "author": "jessiejuachon", "createdAt": "2020-09-22T05:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MTc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MjAxMQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492472011", "bodyText": "Are all the changes in this file related to the issue? It seems there are revisions.", "author": "Xiaochao8", "createdAt": "2020-09-22T04:47:50Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/CacheService.java", "diffHunk": "@@ -6,60 +6,37 @@\n ", "originalCommit": "f09633098597875043343c72416e9f04f7984917", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4MTk0MQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492481941", "bodyText": "It is just code clean up. The following were repeated everywhere so I put in 2 separate methods:\n` private void addCacheItem(String key, CacheItem cacheItem) {\nif (key != null && cacheItem != null) {\nCache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\nif (c != null) {\nc.put(key, cacheItem);\n}\n}\n}\nprivate CacheItem getCacheItem(String key) {\n    Cache c = VIPCfg.getInstance().getCacheManager().getCache(VIPCfg.CACHE_L3);\n    if (c == null)\n        return null;\n    return c.get(key);\n}`", "author": "jessiejuachon", "createdAt": "2020-09-22T05:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MjAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NDQyMQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492474421", "bodyText": "This is another kind of fallback, and this PR isn't related to #781. Could you describe the PR again?\nIntroducing another kind of fallback logic is a big change. We should have a design first.", "author": "Xiaochao8", "createdAt": "2020-09-22T04:59:02Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -130,11 +131,28 @@ private MessageCacheItem createCacheItem(Iterator<Locale> fallbackLocalesIter) {\n \t\tCacheService cacheService = new CacheService(dto);\n \t\t// Create a new cacheItem object to be stored in cache\n \t\tMessageCacheItem cacheItem = new MessageCacheItem();\n-\t\trefreshCacheItem(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n \n+\t\t// If the requested locale is not supported, but matches a supported locale (eg. requested locale \"fr_CA matches supported locale \"fr\"),\n+\t\t// return the messages of the supported locale that best matches the requested locale.\n+\t\tProductService ps = new ProductService(dto);\n+\t\tif (!ps.isSupportedLocale(Locale.forLanguageTag(dto.getLocale()))) {\n+\t\t\tLocale matchedLocale = LocaleUtility.pickupLocaleFromList(new LinkedList<>(ps.getSupportedLocales()), Locale.forLanguageTag(dto.getLocale()));\n+\t\t\tif (ps.isSupportedLocale(matchedLocale)) {\n+\t\t\t\tMessagesDTO matchedLocaleDTO = new MessagesDTO(dto.getComponent(), matchedLocale.toLanguageTag(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(matchedLocaleDTO).getMessages(null);\n+\t\t\t\tMessageCacheItem cacheItemCopy = new MessageCacheItem(matchedLocale.toLanguageTag(), null, null, System.currentTimeMillis(), cacheItem.getMaxAgeMillis());\n+\t\t\t\tcacheService.addCacheOfComponent(cacheItemCopy);\n+\t\t\t\treturn cacheItem;\n+\t\t\t}\n+\t\t}", "originalCommit": "f09633098597875043343c72416e9f04f7984917", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ4MjQzNg==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492482436", "bodyText": "There is no new fallback in this PR! Lines 137-139 is just plain old locale matching logic that was moved out of CacheService.getCacheOfCompnent to here.\nThe \"if\" in line 140 is there only because LocaleUtility.pickupLocaleFromList returns the second parameter if no match is found from the list of supported locales.\nLines 143-144 are there only because ProductService.getsupportedLocales currently does not use cache so every call so it is expensive, which I am planning to change in PR757 as I told Huihui above. I can remove 143-144 above from this PR to simplify.\nZoom call?", "author": "jessiejuachon", "createdAt": "2020-09-22T05:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NDQyMQ=="}], "type": "inlineReview"}, {"oid": "ef3c67f8a5295867ec53e93a4f755646b56469ed", "url": "https://github.com/vmware/singleton/commit/ef3c67f8a5295867ec53e93a4f755646b56469ed", "message": "code clean up", "committedDate": "2020-09-22T07:31:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NTM1MA==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492555350", "bodyText": "I think here still lack else logic, if block only handles scenario that there is matched locale;\nwhen there is no matched locale, you need get fallback locale's content for request(not matched) locale.\nfor example, only fr supported, when request for ru, match result is ru, right?\nru -> default locale (not found)-> source locale.", "author": "huihuiw01", "createdAt": "2020-09-22T08:22:15Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -130,11 +130,28 @@ private MessageCacheItem createCacheItem(Iterator<Locale> fallbackLocalesIter) {\n \t\tCacheService cacheService = new CacheService(dto);\n \t\t// Create a new cacheItem object to be stored in cache\n \t\tMessageCacheItem cacheItem = new MessageCacheItem();\n-\t\trefreshCacheItem(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n \n+\t\t// If the requested locale is not supported, but matches a supported locale (eg. requested locale \"fr_CA matches supported locale \"fr\"),\n+\t\t// return the messages of the supported locale that best matches the requested locale.\n+\t\tProductService ps = new ProductService(dto);\n+\t\tif (!ps.isSupportedLocale(Locale.forLanguageTag(dto.getLocale()))) {\n+\t\t\tLocale matchedLocale = LocaleUtility.pickupLocaleFromList(new LinkedList<>(ps.getSupportedLocales()), Locale.forLanguageTag(dto.getLocale()));\n+\t\t\tif (!matchedLocale.equals(Locale.forLanguageTag(dto.getLocale()))) {\n+\t\t\t\tMessagesDTO matchedLocaleDTO = new MessagesDTO(dto.getComponent(), matchedLocale.toLanguageTag(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(matchedLocaleDTO).getMessages(null);\n+\t\t\t\tMessageCacheItem cacheItemCopy = new MessageCacheItem(matchedLocale.toLanguageTag(), null, null, System.currentTimeMillis(), cacheItem.getMaxAgeMillis());\n+\t\t\t\tcacheService.addCacheOfComponent(cacheItemCopy);\n+\t\t\t\treturn cacheItem;\n+\t\t\t}\n+\t\t}", "originalCommit": "ef3c67f8a5295867ec53e93a4f755646b56469ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzkwOQ==", "url": "https://github.com/vmware/singleton/pull/782#discussion_r492577909", "bodyText": "That happens in line 151. It will continue there without entering the \"if\".", "author": "jessiejuachon", "createdAt": "2020-09-22T08:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NTM1MA=="}], "type": "inlineReview"}, {"oid": "0c6f313329c70155c876dd750365b3ece9df9147", "url": "https://github.com/vmware/singleton/commit/0c6f313329c70155c876dd750365b3ece9df9147", "message": "code clean up", "committedDate": "2020-09-22T09:03:34Z", "type": "commit"}]}