{"pr_number": 874, "pr_title": "Namedargs - built on top of Xiaochao's PR: #865", "pr_createdAt": "2020-11-13T09:30:27Z", "pr_url": "https://github.com/vmware/singleton/pull/874", "timeline": [{"oid": "431e6d35c1d5cbccf93921a3a03e83ef31009357", "url": "https://github.com/vmware/singleton/commit/431e6d35c1d5cbccf93921a3a03e83ef31009357", "message": "Add named arguments", "committedDate": "2020-11-05T03:04:28Z", "type": "commit"}, {"oid": "c72af8d3f242261b31282cb817c58d46954f19a6", "url": "https://github.com/vmware/singleton/commit/c72af8d3f242261b31282cb817c58d46954f19a6", "message": "Add test cases", "committedDate": "2020-11-05T03:06:37Z", "type": "commit"}, {"oid": "3a28850b2d2d31643f490e92e59db9c183cd1f83", "url": "https://github.com/vmware/singleton/commit/3a28850b2d2d31643f490e92e59db9c183cd1f83", "message": "ccc", "committedDate": "2020-11-06T01:59:06Z", "type": "commit"}, {"oid": "fe1fc98f0b311a7151c07e217465e7e6efa67f4f", "url": "https://github.com/vmware/singleton/commit/fe1fc98f0b311a7151c07e217465e7e6efa67f4f", "message": "Merge remote-tracking branch 'remotes/upstream/g11n-java-client' into namedargs", "committedDate": "2020-11-09T05:46:00Z", "type": "commit"}, {"oid": "173181bfa04825a8e4dbeac881ff4106ddb0cf45", "url": "https://github.com/vmware/singleton/commit/173181bfa04825a8e4dbeac881ff4106ddb0cf45", "message": "Change according to comments", "committedDate": "2020-11-09T06:03:11Z", "type": "commit"}, {"oid": "77ebef50f5b2c38072e644a7f83de5097f7b0717", "url": "https://github.com/vmware/singleton/commit/77ebef50f5b2c38072e644a7f83de5097f7b0717", "message": "Remove messages == null because messages is never null", "committedDate": "2020-11-09T07:34:12Z", "type": "commit"}, {"oid": "08ef7b6bc46ac5fb1bb03f3330117b1befcf3c05", "url": "https://github.com/vmware/singleton/commit/08ef7b6bc46ac5fb1bb03f3330117b1befcf3c05", "message": "Extract a method to make code clear", "committedDate": "2020-11-09T07:51:45Z", "type": "commit"}, {"oid": "8187824d81840672c66dc23ab8f77c4ed7c06c70", "url": "https://github.com/vmware/singleton/commit/8187824d81840672c66dc23ab8f77c4ed7c06c70", "message": "code suggestion", "committedDate": "2020-11-09T22:58:13Z", "type": "commit"}, {"oid": "bb76545e1fa33113b4e29c20f0f968e6b2085f12", "url": "https://github.com/vmware/singleton/commit/bb76545e1fa33113b4e29c20f0f968e6b2085f12", "message": "fix review comments", "committedDate": "2020-11-11T06:59:23Z", "type": "commit"}, {"oid": "a867d9dbae7d362bee85b6daddc6a74a91fae965", "url": "https://github.com/vmware/singleton/commit/a867d9dbae7d362bee85b6daddc6a74a91fae965", "message": "minor change", "committedDate": "2020-11-11T07:02:15Z", "type": "commit"}, {"oid": "8245cad7b348adb919d63417be9860888ea240f2", "url": "https://github.com/vmware/singleton/commit/8245cad7b348adb919d63417be9860888ea240f2", "message": "code clean up", "committedDate": "2020-11-13T02:45:09Z", "type": "commit"}, {"oid": "946c59511e73bb0e37178dd25a1f448564d8cd96", "url": "https://github.com/vmware/singleton/commit/946c59511e73bb0e37178dd25a1f448564d8cd96", "message": "Merge branch 'namedargs' into namedargs-jessie", "committedDate": "2020-11-13T02:49:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0NDgyOA==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r527344828", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private com.vmware.vipclient.i18n.messages.dto.MessagesDTO dto    = null;\n          \n          \n            \n                MessagesDTO dto = null;", "author": "Xiaochao8", "createdAt": "2020-11-20T01:56:58Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -23,7 +25,7 @@\n import org.slf4j.LoggerFactory;\n \n public class ComponentService {\n-    private MessagesDTO dto    = null;\n+    private com.vmware.vipclient.i18n.messages.dto.MessagesDTO dto    = null;", "originalCommit": "946c59511e73bb0e37178dd25a1f448564d8cd96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r553806731", "bodyText": "The premise for all codes after this line is source is not empty, so it's better use reverse judgment, suggest:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (source!=null && !source.isEmpty()) {\n          \n          \n            \n                    if (source==null || source.isEmpty()) {\n          \n          \n            \n                           return \"\";\n          \n          \n            \n                    }", "author": "huihuiw01", "createdAt": "2021-01-08T08:33:02Z", "path": "src/main/java/com/vmware/vipclient/i18n/base/instances/TranslationMessage.java", "diffHunk": "@@ -68,21 +56,48 @@ public TranslationMessage() {\n      * </ul>\n      */\n     public String getMessage(final Locale locale, final String component, final String key, final Object... args) {\n-    \t// Use source message if the message hasn't been collected/translated\n-    \tString source = getMessages(Locale.forLanguageTag(ConstantsKeys.SOURCE), component, false).get(key);\n-    \tString collectedSourceMsg = getMessages(LocaleUtility.getSourceLocale(), component, false).get(key);\n-    \tif (source!=null && !source.isEmpty() && !source.equals(collectedSourceMsg)) {\n-\t\t\treturn FormatUtils.format(source, LocaleUtility.getSourceLocale(), args);\n-\t\t}\n-    \t\n-    \tString message = FormatUtils.format(getMessages(locale, component).get(key), locale, args);\n-    \tif (message == null || message.isEmpty()) {\n-    \t\tthrow new VIPJavaClientException(FormatUtils.format(ConstantsMsg.GET_MESSAGE_FAILED, key, component, locale));\n-    \t}\n-    \t\n-    \treturn message;\n+    \treturn getMessageWithArgs(locale, component, key, args);\n     }\n-    \n+\n+    /**\n+     * Retrieves the localized message\n+     *\n+     * @param locale The locale in which the message is requested to be localized\n+     * @param component The Singleton component in which the message belongs\n+     * @param key The key that represents the message\n+     * @param args Named arguments to replace placeholders in the message with\n+     * @return One of the items in the following priority-ordered list:\n+     * @throws VIPJavaClientException If none from the list below is available\n+     * <ul>\n+     * \t\t<li>The source message, if source message hasn't been collected and translated</li>\n+     * \t\t<li>The message in the requested locale</li>\n+     * \t\t<li>The message in the next available fallback locale</li>\n+     * \t\t<li>The source message</li>\n+     * </ul>\n+     */\n+    public String getMessage(final Locale locale, final String component, final String key, final Map<String, Object> args) {\n+        return getMessageWithArgs(locale, component, key, args);\n+    }\n+\n+    private String getMessageWithArgs(final Locale locale, final String component, final String key, final Object args) {\n+        // Use source message if the message hasn't been collected/translated\n+        String source = getMessages(Locale.forLanguageTag(ConstantsKeys.SOURCE), component, false).getMessages().get(key);\n+        if (source!=null && !source.isEmpty()) {", "originalCommit": "946c59511e73bb0e37178dd25a1f448564d8cd96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE5NjIyOQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555196229", "bodyText": "It's the same logic, just different preference, so no need to change this for now. Feel free to update it in another PR.", "author": "jessiejuachon", "createdAt": "2021-01-11T16:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg2NjQyOQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555866429", "bodyText": "I mean line 92~98 should be in this if block, too. Since when source is empty there is no need to get translation.", "author": "huihuiw01", "createdAt": "2021-01-12T15:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg2OTY4Ng==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555869686", "bodyText": "It's also better surround line 84~98 with try-catch to avoid NullPointerException.", "author": "huihuiw01", "createdAt": "2021-01-12T15:40:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwNzY3OA==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555907678", "bodyText": "What you said is invalid. Even if source is empty/null, it should be able to proceed with getting the translation. An example of this is in microservices that do not carry the source bundle with them. such is the case for VCF and Atlas products. When source is null or empty, it just skips this \"if\" block, and proceeds. There is no reason to fail the entire thing.\nBy the way, this has been like this even before this PR.", "author": "jessiejuachon", "createdAt": "2021-01-12T16:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwOTcyMg==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555909722", "bodyText": "In TranslationMessage.java, it is most likely that we do not want to hide any NullPointerExceptions because we want the product dev teams to get the exception  and fix it. Which part of the code do you think will throw a NullPointerException and when? If it is something that has to be fixed by product devs, then let the exception be thrown. Do not hide it in a catch block.", "author": "jessiejuachon", "createdAt": "2021-01-12T16:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjYxMTI2OQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r556611269", "bodyText": "What you said is invalid. Even if source is empty/null, it should be able to proceed with getting the translation. An example of this is in microservices that do not carry the source bundle with them. such is the case for VCF and Atlas products. When source is null or empty, it just skips this \"if\" block, and proceeds. There is no reason to fail the entire thing.\nBy the way, this has been like this even before this PR.\n\nWith such detail case, I can understand the logic.\nBy the way, though some codes exist before this PR, but I may not review them before, so I may have questions and propose them and discuss with you here. Or I don't know when these code need be changed and at then I can have chance to propose my questions.", "author": "huihuiw01", "createdAt": "2021-01-13T15:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjYxNTQ0MQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r556615441", "bodyText": "In TranslationMessage.java, it is most likely that we do not want to hide any NullPointerExceptions because we want the product dev teams to get the exception and fix it. Which part of the code do you think will throw a NullPointerException and when? If it is something that has to be fixed by product devs, then let the exception be thrown. Do not hide it in a catch block.\n\nAt first sight line 84 and 86 mostly will throw NullPointerException, but after double check Service layer code, I know no such case will happen.", "author": "huihuiw01", "createdAt": "2021-01-13T15:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwNjczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwODcyNA==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r553808724", "bodyText": "How about adding 'locale' to MessageCacheItem instead of adding a new DTO object, and in that case you can avoid deprecating 'getMessages' methods and adding 'getTranslations' methods.", "author": "huihuiw01", "createdAt": "2021-01-08T08:37:44Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -71,36 +73,55 @@ private void refreshCacheItem(final MessageCacheItem cacheItem, Iterator<DataSou\n \t}\n \n \t/**\n-\t * Get MessageCacheItem from cache.\n-\t * The cache is refreshed if MessageCacheItem is expired or not found.\n-\t * Pre-configured locale fallback queue is used on failure.\n+\t * @deprecated Use {@link #getTranslations()}.\n+\t */\n+\tpublic MessageCacheItem getMessages() {\n+\t\tIterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+\t\treturn this.getMessages(fallbackLocalesIter);\n+\t}\n+\n+\t/**\n+\t * @deprecated Use {@link #getTranslations(Iterator)}.\n+\t */\n+\tpublic MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n+\t\treturn new MessageCacheItem(this.getMessageCacheItem(fallbackLocalesIter).getMessages());\n+\t}\n+\n+\t/**\n+\t * Calls {@link #getTranslations(Iterator)} using the pre-configured locale fallback queue.\n \t *\n-\t * @return A MessageCacheItem whose message map is one of the items in the following priority-ordered list:\n+\t * @return A TranslationsDTO whose message map is one of the items in the following priority-ordered list:\n \t * <ul>\n \t * \t\t<li>The messages in the requested locale</li>\n-\t * \t\t<li>The messages in a default locale</li>\n+\t * \t\t<li>The messages in a fallback locale</li>\n \t * \t\t<li>The source messages</li>\n \t * \t\t<li>An empty map</li>\n \t * </ul>\n \t */\n-\tpublic MessageCacheItem getMessages() {\n+\tpublic TranslationsDTO getTranslations() {", "originalCommit": "946c59511e73bb0e37178dd25a1f448564d8cd96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE5NTMyNw==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555195327", "bodyText": "2 reasons:\n\nIt's actually more appropriate to make MessageCacheItem objects private. Exposing it via public methods allows users of the API to directly change the contents of our cache by simply changing its properties. We do not want this to happen which is why we use a DTO (Data Transfer Object). DTOs are exactly for this purpose: to carry data between methods without allowing any business logic. In other words, even if consumers of the new API change the properties of TranslationDTO, the contents of our cache, and other related business logic should not be affected/changed.\nStoring locale in every MessageCacheItem increases memory consumption (of cache) unnecessarily. Even if it's just small, for some critical apps, it matters.", "author": "jessiejuachon", "createdAt": "2021-01-11T16:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgwODcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyODU5NQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r553828595", "bodyText": "It's better add message fallback cases.", "author": "huihuiw01", "createdAt": "2021-01-08T09:18:32Z", "path": "src/test/java/com/vmware/vip/i18n/TranslationMessageTest.java", "diffHunk": "@@ -553,4 +553,22 @@ public void testGetSourcesOfMCompAndMLoc() {\n         // more cases to test cache\n         // more cases to test the message sending to server\n     }\n+\n+    @Test\n+    public void testNamedArgs() {\n+        String component = \"JAVA\";\n+        String key = \"NamedArgs\";\n+        Locale locale_en = new Locale(\"en\", \"US\");\n+        Locale locale_de = Locale.forLanguageTag(\"de\");\n+        Map<String, Object> msgArgs = new HashMap<>();\n+        msgArgs.put(\"start\", 1);\n+        msgArgs.put(\"to\", 5);\n+        msgArgs.put(\"total\", 10);\n+\n+        String message_en = translation.getMessage(locale_en, component, key, msgArgs);\n+        Assert.assertEquals(\"1 - 5 of 10 customers\", message_en);\n+\n+        String message_de = translation.getMessage(locale_de, component, key, msgArgs);\n+        Assert.assertEquals(\"1 - 5 of 10 kunden\", message_de);\n+    }", "originalCommit": "946c59511e73bb0e37178dd25a1f448564d8cd96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwMDU3NQ==", "url": "https://github.com/vmware/singleton/pull/874#discussion_r555200575", "bodyText": "I agree so I have created #955 and assigned it to Xiaochao. I added you as assignee as well, so please fell free to pick it up if and when you can.", "author": "jessiejuachon", "createdAt": "2021-01-11T17:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyODU5NQ=="}], "type": "inlineReview"}, {"oid": "5e58479a57f9d0c95d833ec3d23af758ea250a69", "url": "https://github.com/vmware/singleton/commit/5e58479a57f9d0c95d833ec3d23af758ea250a69", "message": "Merge branch 'g11n-java-client' into namedargs-jessie", "committedDate": "2021-01-13T16:35:59Z", "type": "commit"}, {"oid": "66deb2e1b3a8f7ac37f4b0333e480f103a501918", "url": "https://github.com/vmware/singleton/commit/66deb2e1b3a8f7ac37f4b0333e480f103a501918", "message": "Merge branch 'g11n-java-client' of github.com:vmware/singleton into namedargs-jessie", "committedDate": "2021-01-13T16:38:24Z", "type": "commit"}, {"oid": "1cb00a0095bb73235a94920265000688059bc7f1", "url": "https://github.com/vmware/singleton/commit/1cb00a0095bb73235a94920265000688059bc7f1", "message": "Merge branch 'namedargs-jessie' of github.com:jessiejuachon/singleton into namedargs-jessie", "committedDate": "2021-01-13T16:38:41Z", "type": "commit"}]}