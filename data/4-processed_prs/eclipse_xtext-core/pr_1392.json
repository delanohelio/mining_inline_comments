{"pr_number": 1392, "pr_title": "[LS] support multiple workspace root folders", "pr_createdAt": "2020-02-19T14:05:17Z", "pr_url": "https://github.com/eclipse/xtext-core/pull/1392", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyMzc5Mw==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381323793", "bodyText": "should be 2.21", "author": "cdietrich", "createdAt": "2020-02-19T14:27:02Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/IMultiRootWorkspaceConfigFactory.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.server;\n+\n+import java.util.List;\n+\n+import org.eclipse.lsp4j.WorkspaceFolder;\n+import org.eclipse.xtext.workspace.IWorkspaceConfig;\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ * @since 2.11", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDEyOA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381344128", "bodyText": "Good catch.", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyMzc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNDQ3MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381324471", "bodyText": "missing @since", "author": "cdietrich", "createdAt": "2020-02-19T14:28:04Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/ProjectManager.java", "diffHunk": "@@ -215,4 +215,12 @@ public ProjectDescription getProjectDescription() {\n \tpublic IProjectConfig getProjectConfig() {\n \t\treturn projectConfig;\n \t}\n+\t\n+\tpublic void delete() {", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDE4NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381344185", "bodyText": "Thanks", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNDQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMxODQ1OA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381318458", "bodyText": "This does only work for empty directories.\nThe org.junit.rules.TemporaryFolder rule may be the better choice here.", "author": "szarnekow", "createdAt": "2020-02-19T14:18:56Z", "path": "org.eclipse.xtext.ide.tests/src/org/eclipse/xtext/ide/tests/server/WorkspaceFoldersTest.xtend", "diffHunk": "@@ -0,0 +1,123 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.tests.server\n+\n+import com.google.inject.AbstractModule\n+import com.google.inject.Inject\n+import com.google.inject.Module\n+import com.google.inject.Scopes\n+import java.io.File\n+import java.io.FileWriter\n+import java.util.concurrent.CompletableFuture\n+import org.eclipse.lsp4j.DidChangeWorkspaceFoldersParams\n+import org.eclipse.lsp4j.WorkspaceFolder\n+import org.eclipse.lsp4j.WorkspaceFoldersChangeEvent\n+import org.eclipse.xtext.ide.server.UriExtensions\n+import org.eclipse.xtext.ide.server.WorkspaceManager\n+import org.eclipse.xtext.util.Files\n+import org.eclipse.xtext.util.Modules2\n+import org.junit.Test\n+\n+import static org.junit.Assert.assertEquals\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ */\n+class WorkspaceFoldersTest extends AbstractTestLangLanguageServerTest {\n+\t\n+\t@Inject extension UriExtensions\n+\t\n+\t@Inject WorkspaceManager workspaceManager\n+\t\n+\t@Test\n+\tdef void testInitialize() {\n+\t\tval rootFolder1 = getRoot('root1') \n+\t\tval rootFolder2 = getRoot('root2') \n+\t\twriteFile(rootFolder1, \"one.testlang\", '''\n+\t\t\ttype Foo {\n+\t\t\t\tBar bar\n+\t\t\t}\n+\t\t''')\n+\t\tval twoUri = writeFile(rootFolder2, \"two.testlang\", '''\n+\t\t\ttype Bar {\n+\t\t\t\tFoo foo\n+\t\t\t}\n+\t\t''')\n+\t\tinitialize[ \n+\t\t\tworkspaceFolders = #[\n+\t\t\t\tnew WorkspaceFolder(rootFolder1.toURI.toUriString, 'root1'),\n+\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t]\n+\t\t]\n+\t\tassertEquals(2, diagnostics.size)\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tremoved = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(0, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tadded = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t}\n+\n+\tprotected def void withBuild(()=>void lambda) {\n+\t\tval future = new CompletableFuture<Void>()\n+\t\tworkspaceManager.addBuildListener[  \n+\t\t\tworkspaceManager.removeBuildListener(self)\n+\t\t\tfuture.complete(null)\t\t\t\n+\t\t]\n+\t\tlambda.apply\n+\t\tfuture.get\n+\t}\n+\n+    protected def getRoot(String path) {\n+        val root = new File(path)\n+        if (!root.mkdirs) {\n+            Files.cleanFolder(root, null, true, false)\n+        }\n+        root.deleteOnExit", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDM0Ng==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381344346", "bodyText": "Yes, I'll change that.", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMxODQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyMTc0NA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381321744", "bodyText": "Why did you decide to make this not a subtype of IWorkspaceConfigFactory ?", "author": "szarnekow", "createdAt": "2020-02-19T14:24:03Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/IMultiRootWorkspaceConfigFactory.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.server;\n+\n+import java.util.List;\n+\n+import org.eclipse.lsp4j.WorkspaceFolder;\n+import org.eclipse.xtext.workspace.IWorkspaceConfig;\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ * @since 2.11\n+ */\n+public interface IMultiRootWorkspaceConfigFactory {", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1MzgwMQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381353801", "bodyText": "I didn't because these interfaces have no methods in common.\nBut the API compatibilities you describe suggest to do so.", "author": "JanKoehnlein", "createdAt": "2020-02-19T15:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyMTc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNDc4Ng==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381324786", "bodyText": "The debugging experience would be improved if the workspaceFolder name would be used as a prefix here.", "author": "szarnekow", "createdAt": "2020-02-19T14:28:31Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/MultiRootWorkspaceConfigFactory.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.server;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.eclipse.emf.common.util.URI;\n+import org.eclipse.lsp4j.WorkspaceFolder;\n+import org.eclipse.xtext.workspace.FileProjectConfig;\n+import org.eclipse.xtext.workspace.IWorkspaceConfig;\n+import org.eclipse.xtext.workspace.WorkspaceConfig;\n+\n+import com.google.inject.Inject;\n+\n+/**\n+ * Creates one project per workspace root folder.\n+ * \n+ * @author koehnlein - Initial contribution and API\n+ * @since 2.21\n+ */\n+public class MultiRootWorkspaceConfigFactory implements IWorkspaceConfigFactory, IMultiRootWorkspaceConfigFactory {\n+\n+\t@Inject UriExtensions uriExtensions;\n+\t\n+\t@Override\n+\tpublic IWorkspaceConfig getWorkspaceConfig(List<WorkspaceFolder> workspaceFolders) {\n+\t\tWorkspaceConfig workspaceConfig = new WorkspaceConfig();\n+\t\tSet<String> existingProjectNames = new HashSet<>();\n+\t\tfor(WorkspaceFolder workspaceFolder: workspaceFolders) \n+\t\t\taddProjectsForWorkspaceFolder(workspaceConfig, workspaceFolder, existingProjectNames);\n+\t\treturn workspaceConfig;\n+\t}\n+\n+\t@Override\n+\tpublic IWorkspaceConfig getWorkspaceConfig(URI workspaceBaseURI) {\n+\t\tWorkspaceConfig workspaceConfig = new WorkspaceConfig();\n+\t\taddProjectsForWorkspaceFolder(workspaceConfig, new WorkspaceFolder(uriExtensions.toUriString(workspaceBaseURI), \"workspace\"), new HashSet<>());\n+\t\treturn workspaceConfig;\n+\t}\n+\n+\tprotected void addProjectsForWorkspaceFolder(WorkspaceConfig workspaceConfig, WorkspaceFolder workspaceFolder, Set<String> existingNames) {\n+\t\tif (workspaceFolder != null && workspaceFolder.getUri() != null) {\n+\t\t\tFileProjectConfig project = new FileProjectConfig(uriExtensions.toUri(workspaceFolder.getUri()), getUniqueProjectName(workspaceFolder.getName(), existingNames));\n+\t\t\tproject.addSourceFolder(\".\");\n+\t\t\tworkspaceConfig.addProject(project);\n+\t\t}\n+\t}\n+\t\n+\t/**\n+\t * Project names have to be unique, as the WorkspaceManager uses them as keys in a map.\n+\t */\n+\tprotected String getUniqueProjectName(String proposal, Set<String> existingNames){", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzNzY4NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381337685", "bodyText": "But it is passed in as the proposal, isn't it? So it's used as prefix. Maybe I missed your point.", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNDc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MDE5Mg==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381340192", "bodyText": "My bad - I misread the code. I was assuming that the list of workspaces folders is scanned for contained projects, but that's not the case here.", "author": "szarnekow", "createdAt": "2020-02-19T14:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNDc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNTk4OA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381325988", "bodyText": "I had another expectation from the method name delete.\nMaybe removeAllIssues or discardAllIssues?", "author": "szarnekow", "createdAt": "2020-02-19T14:30:09Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/ProjectManager.java", "diffHunk": "@@ -215,4 +215,12 @@ public ProjectDescription getProjectDescription() {\n \tpublic IProjectConfig getProjectConfig() {\n \t\treturn projectConfig;\n \t}\n+\t\n+\tpublic void delete() {", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzOTQ4OA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381339488", "bodyText": "Yes, I thought this more to be the hook to cleanup when the project is deleted from the workspace, but as long as it just discards issues, I can rename it.", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDU4MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381344581", "bodyText": "What do you think about aboutToDeleteFromWorkspace()?", "author": "szarnekow", "createdAt": "2020-02-19T14:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNjk3Nw==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381326977", "bodyText": "Clients that used to have bound ProjectWorkspaceConfigFactory to their special subtype would now be broken. If MultiRootWorkspaceConfigFactory was a subtype of ProjectWorkspaceConfigFactory, that could be mitigated.", "author": "szarnekow", "createdAt": "2020-02-19T14:31:32Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/ServerModule.xtend", "diffHunk": "@@ -28,9 +28,8 @@ class ServerModule extends AbstractModule {\n \t\t\n     \tbind(LanguageServer).to(LanguageServerImpl)\n         bind(IResourceServiceProvider.Registry).toProvider(ResourceServiceProviderServiceLoader)\n-        bind(IWorkspaceConfigFactory).to(ProjectWorkspaceConfigFactory)\n+        bind(IWorkspaceConfigFactory).to(MultiRootWorkspaceConfigFactory)", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1MzAwOA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381353008", "bodyText": "All right. Even though MultiRootWorkspaceConfigFactory will not use or expose any method of ProjectWorkspaceConfigFactory.", "author": "JanKoehnlein", "createdAt": "2020-02-19T15:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyNjk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyOTQ3Mg==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381329472", "bodyText": "Do I understand this correctly: this change here turns all the tests into MultiWorkspaceRootTests? Or are there still tests for \"old\" clients?", "author": "szarnekow", "createdAt": "2020-02-19T14:35:17Z", "path": "org.eclipse.xtext.testing/src/org/eclipse/xtext/testing/AbstractLanguageServerTest.xtend", "diffHunk": "@@ -190,6 +191,9 @@ abstract class AbstractLanguageServerTest implements Endpoint {\n \t\tval params = new InitializeParams => [\n \t\t\tprocessId = 1\n \t\t\trootUri = root.toURI.normalize.toUriString\n+\t\t\tworkspaceFolders = #[", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NTQ5MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381345491", "bodyText": "Yes it does. I consider the multi-roots the new default, as the single root is just a special case of it. Only those that bind their own workspaceconfigfactory won't use it", "author": "JanKoehnlein", "createdAt": "2020-02-19T14:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMyOTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzMDgwMA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381330800", "bodyText": "See question above on the interface IMultiRootWorkspaceConfigFactory - this code here suggests that the \"normal\" workspaceConfigFactory and the multi root incarnation of it are in an inheritance relationship.", "author": "szarnekow", "createdAt": "2020-02-19T14:37:10Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/WorkspaceManager.java", "diffHunk": "@@ -141,16 +149,68 @@ public void setBuildManager(BuildManager buildManager) {\n \t */\n \tpublic void initialize(URI baseDir, Procedure2<? super URI, ? super Iterable<Issue>> issueAcceptor,\n \t\t\tCancelIndicator cancelIndicator) {\n-\t\tthis.baseDir = baseDir;\n+\t\tif (isSupportsWorkspaceFolders()) {\n+\t\t\tWorkspaceFolder workspaceFolder = new WorkspaceFolder(uriExtensions.toUriString(baseDir), \"workspace\");\n+\t\t\tinitialize(Collections.singletonList(workspaceFolder), issueAcceptor, cancelIndicator);\t\t\t\n+\t\t} else {\n+\t\t\tthis.baseDir = baseDir;\n+\t\t\tthis.issueAcceptor = issueAcceptor;\n+\t\t\trefreshWorkspaceConfig(cancelIndicator);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Initialize a workspace with the given workspace folders.\n+\t *\n+\t * @param workspaceFolders\n+\t *            the list of workspace root folders\n+\t * @param issueAcceptor\n+\t *            the issue acceptor\n+\t * @param cancelIndicator\n+\t *            allows to cancel the initialization\n+\t * @since 2.21\n+\t */\n+\tpublic void initialize(List<WorkspaceFolder> workspaceFolders, Procedure2<? super URI, ? super Iterable<Issue>> issueAcceptor,\n+\t\t\tCancelIndicator cancelIndicator) {\n+\t\tthis.workspaceFolders = new ArrayList<>(workspaceFolders);\n \t\tthis.issueAcceptor = issueAcceptor;\n \t\trefreshWorkspaceConfig(cancelIndicator);\n \t}\n \n+\t/**\n+\t * @return whether this workspace manager supports multiple workspace root folders.\n+\t * @since 2.21\n+\t */\n+\tpublic boolean isSupportsWorkspaceFolders() {\n+\t\treturn workspaceConfigFactory instanceof IMultiRootWorkspaceConfigFactory;", "originalCommit": "52d115d152716577242a3d816affa28c12847d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1MzQzOQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381353439", "bodyText": "Changed it.", "author": "JanKoehnlein", "createdAt": "2020-02-19T15:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzMDgwMA=="}], "type": "inlineReview"}, {"oid": "193089fe0069579dabe0fad64f3ecee6dec34015", "url": "https://github.com/eclipse/xtext-core/commit/193089fe0069579dabe0fad64f3ecee6dec34015", "message": "[LS] support multiple workspace root folders\n\nFixes #1238", "committedDate": "2020-02-19T15:11:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyNTQ5OQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381525499", "bodyText": "Mixed whitespace", "author": "tivervac", "createdAt": "2020-02-19T20:28:28Z", "path": "org.eclipse.xtext.ide.tests/src/org/eclipse/xtext/ide/tests/server/WorkspaceFoldersTest.xtend", "diffHunk": "@@ -0,0 +1,126 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.tests.server\n+\n+import com.google.inject.AbstractModule\n+import com.google.inject.Inject\n+import com.google.inject.Module\n+import com.google.inject.Scopes\n+import java.io.File\n+import java.io.FileWriter\n+import java.util.concurrent.CompletableFuture\n+import org.eclipse.lsp4j.DidChangeWorkspaceFoldersParams\n+import org.eclipse.lsp4j.WorkspaceFolder\n+import org.eclipse.lsp4j.WorkspaceFoldersChangeEvent\n+import org.eclipse.xtext.ide.server.UriExtensions\n+import org.eclipse.xtext.ide.server.WorkspaceManager\n+import org.eclipse.xtext.util.Files\n+import org.eclipse.xtext.util.Modules2\n+import org.junit.Test\n+\n+import static org.junit.Assert.assertEquals\n+import org.junit.rules.TemporaryFolder\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ */\n+class WorkspaceFoldersTest extends AbstractTestLangLanguageServerTest {\n+\t\n+\t@Inject extension UriExtensions\n+\t\n+\t@Inject WorkspaceManager workspaceManager\n+\t\n+\t@Inject extension TemporaryFolder \n+\t\n+\t@Test\n+\tdef void testInitialize() {\n+\t\tval rootFolder1 = getRoot('root1') \n+\t\tval rootFolder2 = getRoot('root2') \n+\t\twriteFile(rootFolder1, \"one.testlang\", '''\n+\t\t\ttype Foo {\n+\t\t\t\tBar bar\n+\t\t\t}\n+\t\t''')\n+\t\tval twoUri = writeFile(rootFolder2, \"two.testlang\", '''\n+\t\t\ttype Bar {\n+\t\t\t\tFoo foo\n+\t\t\t}\n+\t\t''')\n+\t\tinitialize[ \n+\t\t\tworkspaceFolders = #[\n+\t\t\t\tnew WorkspaceFolder(rootFolder1.toURI.toUriString, 'root1'),\n+\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t]\n+\t\t]\n+\t\tassertEquals(2, diagnostics.size)\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tremoved = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(0, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tadded = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t}\n+\n+\tprotected def void withBuild(()=>void lambda) {\n+\t\tval future = new CompletableFuture<Void>()\n+\t\tworkspaceManager.addBuildListener[  \n+\t\t\tworkspaceManager.removeBuildListener(self)\n+\t\t\tfuture.complete(null)\t\t\t\n+\t\t]\n+\t\tlambda.apply\n+\t\tfuture.get\n+\t}\n+\n+    protected def getRoot(String path) {", "originalCommit": "193089fe0069579dabe0fad64f3ecee6dec34015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5ODgzMg==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381898832", "bodyText": "Fixed", "author": "JanKoehnlein", "createdAt": "2020-02-20T10:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyNTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyNzA3MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381527071", "bodyText": "Probably want your full name here", "author": "tivervac", "createdAt": "2020-02-19T20:31:34Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/MultiRootWorkspaceConfigFactory.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.server;\n+\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.eclipse.emf.common.util.URI;\n+import org.eclipse.lsp4j.WorkspaceFolder;\n+import org.eclipse.xtext.workspace.FileProjectConfig;\n+import org.eclipse.xtext.workspace.IWorkspaceConfig;\n+import org.eclipse.xtext.workspace.WorkspaceConfig;\n+\n+import com.google.inject.Inject;\n+\n+/**\n+ * Creates one project per workspace root folder.\n+ * \n+ * @author koehnlein - Initial contribution and API", "originalCommit": "193089fe0069579dabe0fad64f3ecee6dec34015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyOTA5OA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381529098", "bodyText": "Seems like a weird name to me. I'd prefer something like supportsWorkspaceFolders", "author": "tivervac", "createdAt": "2020-02-19T20:35:38Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/WorkspaceManager.java", "diffHunk": "@@ -141,16 +149,68 @@ public void setBuildManager(BuildManager buildManager) {\n \t */\n \tpublic void initialize(URI baseDir, Procedure2<? super URI, ? super Iterable<Issue>> issueAcceptor,\n \t\t\tCancelIndicator cancelIndicator) {\n-\t\tthis.baseDir = baseDir;\n+\t\tif (isSupportsWorkspaceFolders()) {\n+\t\t\tWorkspaceFolder workspaceFolder = new WorkspaceFolder(uriExtensions.toUriString(baseDir), \"workspace\");\n+\t\t\tinitialize(Collections.singletonList(workspaceFolder), issueAcceptor, cancelIndicator);\t\t\t\n+\t\t} else {\n+\t\t\tthis.baseDir = baseDir;\n+\t\t\tthis.issueAcceptor = issueAcceptor;\n+\t\t\trefreshWorkspaceConfig(cancelIndicator);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Initialize a workspace with the given workspace folders.\n+\t *\n+\t * @param workspaceFolders\n+\t *            the list of workspace root folders\n+\t * @param issueAcceptor\n+\t *            the issue acceptor\n+\t * @param cancelIndicator\n+\t *            allows to cancel the initialization\n+\t * @since 2.21\n+\t */\n+\tpublic void initialize(List<WorkspaceFolder> workspaceFolders, Procedure2<? super URI, ? super Iterable<Issue>> issueAcceptor,\n+\t\t\tCancelIndicator cancelIndicator) {\n+\t\tthis.workspaceFolders = new ArrayList<>(workspaceFolders);\n \t\tthis.issueAcceptor = issueAcceptor;\n \t\trefreshWorkspaceConfig(cancelIndicator);\n \t}\n \n+\t/**\n+\t * @return whether this workspace manager supports multiple workspace root folders.\n+\t * @since 2.21\n+\t */\n+\tpublic boolean isSupportsWorkspaceFolders() {", "originalCommit": "193089fe0069579dabe0fad64f3ecee6dec34015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5OTIxMA==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381899210", "bodyText": "It is Java-beans style. I'll leave that as is.", "author": "JanKoehnlein", "createdAt": "2020-02-20T10:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUyOTA5OA=="}], "type": "inlineReview"}, {"oid": "89e84bffa10683317e35a96903a9b4013298aa08", "url": "https://github.com/eclipse/xtext-core/commit/89e84bffa10683317e35a96903a9b4013298aa08", "message": "[LS] support multiple workspace root folders\n\nFixes #1238", "committedDate": "2020-02-20T10:04:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwMTU3NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381901575", "bodyText": "Must be a public field and annotated with @Rule to take effect.\nThe Javadoc of TemporaryFolder has an example.", "author": "szarnekow", "createdAt": "2020-02-20T10:10:00Z", "path": "org.eclipse.xtext.ide.tests/src/org/eclipse/xtext/ide/tests/server/WorkspaceFoldersTest.xtend", "diffHunk": "@@ -0,0 +1,126 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.tests.server\n+\n+import com.google.inject.AbstractModule\n+import com.google.inject.Inject\n+import com.google.inject.Module\n+import com.google.inject.Scopes\n+import java.io.File\n+import java.io.FileWriter\n+import java.util.concurrent.CompletableFuture\n+import org.eclipse.lsp4j.DidChangeWorkspaceFoldersParams\n+import org.eclipse.lsp4j.WorkspaceFolder\n+import org.eclipse.lsp4j.WorkspaceFoldersChangeEvent\n+import org.eclipse.xtext.ide.server.UriExtensions\n+import org.eclipse.xtext.ide.server.WorkspaceManager\n+import org.eclipse.xtext.util.Files\n+import org.eclipse.xtext.util.Modules2\n+import org.junit.Test\n+\n+import static org.junit.Assert.assertEquals\n+import org.junit.rules.TemporaryFolder\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ */\n+class WorkspaceFoldersTest extends AbstractTestLangLanguageServerTest {\n+\n+\t@Inject extension UriExtensions\n+\n+\t@Inject WorkspaceManager workspaceManager\n+\n+\t@Inject extension TemporaryFolder ", "originalCommit": "89e84bffa10683317e35a96903a9b4013298aa08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxMjA3Ng==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381912076", "bodyText": "Fixed. Thanks", "author": "JanKoehnlein", "createdAt": "2020-02-20T10:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwMTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwMTc3OQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381901779", "bodyText": "This shouldn't be necessary when working with the TemporaryFolder rule", "author": "szarnekow", "createdAt": "2020-02-20T10:10:22Z", "path": "org.eclipse.xtext.ide.tests/src/org/eclipse/xtext/ide/tests/server/WorkspaceFoldersTest.xtend", "diffHunk": "@@ -0,0 +1,126 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 TypeFox GmbH (http://www.typefox.io) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ide.tests.server\n+\n+import com.google.inject.AbstractModule\n+import com.google.inject.Inject\n+import com.google.inject.Module\n+import com.google.inject.Scopes\n+import java.io.File\n+import java.io.FileWriter\n+import java.util.concurrent.CompletableFuture\n+import org.eclipse.lsp4j.DidChangeWorkspaceFoldersParams\n+import org.eclipse.lsp4j.WorkspaceFolder\n+import org.eclipse.lsp4j.WorkspaceFoldersChangeEvent\n+import org.eclipse.xtext.ide.server.UriExtensions\n+import org.eclipse.xtext.ide.server.WorkspaceManager\n+import org.eclipse.xtext.util.Files\n+import org.eclipse.xtext.util.Modules2\n+import org.junit.Test\n+\n+import static org.junit.Assert.assertEquals\n+import org.junit.rules.TemporaryFolder\n+\n+/**\n+ * @author Jan Koehnlein - Initial contribution and API\n+ */\n+class WorkspaceFoldersTest extends AbstractTestLangLanguageServerTest {\n+\n+\t@Inject extension UriExtensions\n+\n+\t@Inject WorkspaceManager workspaceManager\n+\n+\t@Inject extension TemporaryFolder \n+\n+\t@Test\n+\tdef void testInitialize() {\n+\t\tval rootFolder1 = getRoot('root1') \n+\t\tval rootFolder2 = getRoot('root2') \n+\t\twriteFile(rootFolder1, \"one.testlang\", '''\n+\t\t\ttype Foo {\n+\t\t\t\tBar bar\n+\t\t\t}\n+\t\t''')\n+\t\tval twoUri = writeFile(rootFolder2, \"two.testlang\", '''\n+\t\t\ttype Bar {\n+\t\t\t\tFoo foo\n+\t\t\t}\n+\t\t''')\n+\t\tinitialize[ \n+\t\t\tworkspaceFolders = #[\n+\t\t\t\tnew WorkspaceFolder(rootFolder1.toURI.toUriString, 'root1'),\n+\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t]\n+\t\t]\n+\t\tassertEquals(2, diagnostics.size)\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tremoved = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(0, diagnostics.get(twoUri).size)\n+\t\twithBuild [\n+\t\t\tlanguageServer.didChangeWorkspaceFolders(new DidChangeWorkspaceFoldersParams => [\n+\t\t\t\tevent = new WorkspaceFoldersChangeEvent => [\n+\t\t\t\t\tadded = #[\n+\t\t\t\t\t\tnew WorkspaceFolder(rootFolder2.toURI.toUriString, 'root2')\n+\t\t\t\t\t]\n+\t\t\t\t]\n+\t\t\t])\n+\t\t]\t\n+\t\tassertEquals(1, diagnostics.get(twoUri).size)\n+\t}\n+\n+\tprotected def void withBuild(()=>void lambda) {\n+\t\tval future = new CompletableFuture<Void>()\n+\t\tworkspaceManager.addBuildListener[  \n+\t\t\tworkspaceManager.removeBuildListener(self)\n+\t\t\tfuture.complete(null)\t\t\t\n+\t\t]\n+\t\tlambda.apply\n+\t\tfuture.get\n+\t}\n+\n+\tprotected def getRoot(String path) {\n+\t\tval root = newFolder(path)\n+\t\tif (!root.mkdirs) {", "originalCommit": "89e84bffa10683317e35a96903a9b4013298aa08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwNTk3OQ==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381905979", "bodyText": "I've the feeling that baseDir should be removed and the list of workspaceFolders should always be used.\nIf isSupports..() is false, the baseDir could be unwrapped from the a single workspaceFolder.\nCan we add a protected getter for the workspaceFolders?", "author": "szarnekow", "createdAt": "2020-02-20T10:17:59Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/WorkspaceManager.java", "diffHunk": "@@ -60,11 +63,16 @@\n \n \t@Inject\n \tprivate IProjectDescriptionFactory projectDescriptionFactory;\n+\t\n+\t@Inject \n+\tprivate UriExtensions uriExtensions;\n \n \tprivate BuildManager buildManager;\n \n \tprivate URI baseDir;", "originalCommit": "89e84bffa10683317e35a96903a9b4013298aa08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkyNzkxNw==", "url": "https://github.com/eclipse/xtext-core/pull/1392#discussion_r381927917", "bodyText": "OK.", "author": "JanKoehnlein", "createdAt": "2020-02-20T10:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwNTk3OQ=="}], "type": "inlineReview"}, {"oid": "e2cd8edd53dc44f06f67aa733344ce2a335c4e8e", "url": "https://github.com/eclipse/xtext-core/commit/e2cd8edd53dc44f06f67aa733344ce2a335c4e8e", "message": "[LS] support multiple workspace root folders\n\nFixes #1238", "committedDate": "2020-02-20T10:58:38Z", "type": "commit"}, {"oid": "e2cd8edd53dc44f06f67aa733344ce2a335c4e8e", "url": "https://github.com/eclipse/xtext-core/commit/e2cd8edd53dc44f06f67aa733344ce2a335c4e8e", "message": "[LS] support multiple workspace root folders\n\nFixes #1238", "committedDate": "2020-02-20T10:58:38Z", "type": "forcePushed"}]}