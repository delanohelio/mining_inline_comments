{"pr_number": 1490, "pr_title": "[lsp] properly rename quoted identifiers", "pr_createdAt": "2020-05-11T18:39:03Z", "pr_url": "https://github.com/eclipse/xtext-core/pull/1490", "timeline": [{"oid": "afe2878506ea5e8ec2367401ab843130120bf1c6", "url": "https://github.com/eclipse/xtext-core/commit/afe2878506ea5e8ec2367401ab843130120bf1c6", "message": "[lsp] properly rename quoted identifiers\n\nFixes #1488", "committedDate": "2020-05-11T18:38:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0NzU1Mw==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423247553", "bodyText": "shouldt we consult linkingHelper.getRuleNameFrom(updatable.getCrossReference()) e.g. as in referenceupdater.getQualifiedName", "author": "cdietrich", "createdAt": "2020-05-11T18:50:35Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/rename/RenameService2.xtend", "diffHunk": "@@ -219,6 +222,14 @@ class RenameService2 implements IRenameService2 {\n \t\treturn null\n \t}\n \n+\tprotected def String getConvertedValue(EObject grammarElement, ILeafNode leaf) {\n+\t\tswitch (grammarElement) {\n+\t\t\tRuleCall: valueConverterService.toValue(leaf.text, grammarElement.rule.name, leaf).toString()\n+\t\t\tCrossReference: getConvertedValue(grammarElement.terminal, leaf)", "originalCommit": "afe2878506ea5e8ec2367401ab843130120bf1c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMDA5Mg==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423500092", "bodyText": "Maybe even use org.eclipse.xtext.linking.impl.LinkingHelper.getCrossRefNodeAsString(INode, boolean) and find a proper cross ref node starting at the leaf node.", "author": "szarnekow", "createdAt": "2020-05-12T06:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0NzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMTU1Mw==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423521553", "bodyText": "As you wish.", "author": "JanKoehnlein", "createdAt": "2020-05-12T07:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0NzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5NzE5OA==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423497198", "bodyText": "Probably beyond this small bugfix here, but the rename infrastructure appears to be based on the assumption that IDs are comprised of leaf nodes and ignores the fact that MyId: ID | 'someKeyword'; or VersionedId: ID '-''(' INT ')'; are valid identifiers, too.", "author": "szarnekow", "createdAt": "2020-05-12T06:44:20Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/rename/RenameService2.xtend", "diffHunk": "@@ -197,11 +200,11 @@ class RenameService2 implements IRenameService2 {\n \t\t\t\t\tif (element !== null && !element.eIsProxy) {\n \t\t\t\t\t\tval leaf = NodeModelUtils.findLeafNodeAtOffset(rootNode, candidateOffset)", "originalCommit": "afe2878506ea5e8ec2367401ab843130120bf1c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMTc4MA==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423521780", "bodyText": "The truth is, quoted IDs don't even work with qualified names (as a datatype rule), unless you have registered a special value converter. My goal was to cover the basic behavior of the default ID rule. I think the method doPrepareRename is small enough to be overridden for more specific use cases.", "author": "JanKoehnlein", "createdAt": "2020-05-12T07:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5NzE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5Nzc0NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423497745", "bodyText": "Given that this is already quite a bit of complexity in the logic, please change the variable name to better reflect what it is now.", "author": "szarnekow", "createdAt": "2020-05-12T06:45:33Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/rename/RenameService2.xtend", "diffHunk": "@@ -197,11 +200,11 @@ class RenameService2 implements IRenameService2 {\n \t\t\t\t\tif (element !== null && !element.eIsProxy) {\n \t\t\t\t\t\tval leaf = NodeModelUtils.findLeafNodeAtOffset(rootNode, candidateOffset)\n \t\t\t\t\t\tif (leaf !== null && leaf.isIdentifier) {\n-\t\t\t\t\t\t\tval leafText = NodeModelUtils.getTokenText(leaf)\n+\t\t\t\t\t\t\tval leafText = getConvertedValue(leaf.grammarElement, leaf)", "originalCommit": "afe2878506ea5e8ec2367401ab843130120bf1c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMTg0OA==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423521848", "bodyText": "Done_", "author": "JanKoehnlein", "createdAt": "2020-05-12T07:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5Nzc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTU3NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423499575", "bodyText": "toValue() on a leaf node could throw a value converter exception if the leaf node was used in a data type rule e.g.\nIntAsID: INT; with 999999999999999999.\nThe value converter exception is not caught / handled in doPrepareRename", "author": "szarnekow", "createdAt": "2020-05-12T06:49:42Z", "path": "org.eclipse.xtext.ide/src/org/eclipse/xtext/ide/server/rename/RenameService2.xtend", "diffHunk": "@@ -219,6 +222,14 @@ class RenameService2 implements IRenameService2 {\n \t\treturn null\n \t}\n \n+\tprotected def String getConvertedValue(EObject grammarElement, ILeafNode leaf) {\n+\t\tswitch (grammarElement) {\n+\t\t\tRuleCall: valueConverterService.toValue(leaf.text, grammarElement.rule.name, leaf).toString()", "originalCommit": "afe2878506ea5e8ec2367401ab843130120bf1c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTc5OQ==", "url": "https://github.com/eclipse/xtext-core/pull/1490#discussion_r423525799", "bodyText": "Would you really expect rename to work OOTB when integers are used as names?\nAnyway, I added some code to handle this.", "author": "JanKoehnlein", "createdAt": "2020-05-12T07:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5OTU3NQ=="}], "type": "inlineReview"}, {"oid": "95849c89c41a92803acf1129e4938556dbd92d2d", "url": "https://github.com/eclipse/xtext-core/commit/95849c89c41a92803acf1129e4938556dbd92d2d", "message": "[rename] applied feedback", "committedDate": "2020-05-12T07:42:19Z", "type": "commit"}]}