{"pr_number": 1576, "pr_title": "[eclipse/xtext#1851] Fixed regression with InjectionExtension", "pr_createdAt": "2020-09-21T10:09:10Z", "pr_url": "https://github.com/eclipse/xtext-core/pull/1576", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTM1Ng==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491929356", "bodyText": "no version range here?", "author": "cdietrich", "createdAt": "2020-09-21T10:11:17Z", "path": "org.eclipse.xtext.testing/META-INF/MANIFEST.MF", "diffHunk": "@@ -27,7 +27,9 @@ Require-Bundle: org.eclipse.xtext;visibility:=reexport,\n  org.eclipse.xtend.lib\n Import-Package: org.apache.log4j;version=\"1.2.15\",\n  org.apache.log4j.spi;version=\"1.2.15\",\n- org.junit.jupiter.api.extension;version=\"[5.0.0,6.0.0)\";resolution:=optional\n+ org.junit.jupiter.api.extension;version=\"[5.0.0,6.0.0)\";resolution:=optional,\n+ org.junit.platform.runner;resolution:=optional,", "originalCommit": "17a31b90059de1fc9b013ce45e348f0fd7de9ce5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzODMyNg==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491938326", "bodyText": "do we need to adapt targets in core, extras, eclipse, xtend & umbrella too?", "author": "cdietrich", "createdAt": "2020-09-21T10:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NTkzMA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491985930", "bodyText": "I don't think so since we use these only to run the Junit5 tests in testing.tests with a Junit4 runner", "author": "szarnekow", "createdAt": "2020-09-21T11:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTc3NA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491929774", "bodyText": "?", "author": "cdietrich", "createdAt": "2020-09-21T10:12:05Z", "path": "org.eclipse.xtext.testing/src/org/eclipse/xtext/testing/smoketest/internal/RunnerBuilder.java", "diffHunk": "@@ -72,6 +72,7 @@ public Runner runnerForClass(Class<?> testClass) throws Throwable {\n \t\tprivate final ProcessedBy processor;\n \t\tprivate final Scenario[] scenarios;\n \t\t\n+\t\t@SuppressWarnings(\"deprecation\")", "originalCommit": "17a31b90059de1fc9b013ce45e348f0fd7de9ce5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk0NTA3Ng==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491945076", "bodyText": "why was this not deprecated before?", "author": "cdietrich", "createdAt": "2020-09-21T10:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk0NTg2MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491945861", "bodyText": "is there a junit 4.13 thing that is pulled now?!?", "author": "cdietrich", "createdAt": "2020-09-21T10:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NTI1OA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491985258", "bodyText": "Let's schedule the upgrade to 4.13. I think @kthoms started to work on that", "author": "szarnekow", "createdAt": "2020-09-21T11:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjU4NA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491986584", "bodyText": "join eclipse/xtext#1645", "author": "cdietrich", "createdAt": "2020-09-21T11:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyOTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMDExNA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491930114", "bodyText": "what is this class good for?", "author": "cdietrich", "createdAt": "2020-09-21T10:12:47Z", "path": "org.eclipse.xtext.testing/tests/org/eclipse/xtext/testing/tests/junit5/RunJunit5Suite.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Sebastian Zarnekow and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.testing.tests.junit5;\n+\n+import org.junit.runner.RunWith;\n+import org.junit.platform.runner.JUnitPlatform;\n+import org.junit.platform.suite.api.SelectPackages;\n+\n+@RunWith(JUnitPlatform.class)\n+@SelectPackages(\"org.eclipse.xtext.testing.tests.junit5\")\n+public class RunJunit5Suite {", "originalCommit": "17a31b90059de1fc9b013ce45e348f0fd7de9ce5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzNDI2NQ==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491934265", "bodyText": "are tests executed in gradle at all? or twice?", "author": "cdietrich", "createdAt": "2020-09-21T10:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NDc2MQ==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491984761", "bodyText": "Doesn't look like these are being executed at all. I renamed the Suite to Tests. Let's see", "author": "szarnekow", "createdAt": "2020-09-21T11:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMDExNA=="}], "type": "inlineReview"}, {"oid": "c01ae557c7eb15b687765ddaace1359500d8644e", "url": "https://github.com/eclipse/xtext-core/commit/c01ae557c7eb15b687765ddaace1359500d8644e", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T10:14:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzODA0OQ==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491938049", "bodyText": "is this no longer an issue?\nwe dont package at umbrella", "author": "cdietrich", "createdAt": "2020-09-21T10:25:20Z", "path": "org.eclipse.xtext.testing/src/org/eclipse/xtext/testing/extensions/InjectionExtension.java", "diffHunk": "@@ -49,66 +52,85 @@\n \t * </p>\n \t */\n \tprivate static ClassToInstanceMap<IInjectorProvider> injectorProviderClassCache = MutableClassToInstanceMap.create();\n+\t\n+\t/**\n+\t * @since 2.24\n+\t */\n+\tprotected static class RegistryReset implements CloseableResource {\n+\t\tprotected IRegistryConfigurator resetter;\n+\n+\t\tpublic RegistryReset(IRegistryConfigurator resetter) {\n+\t\t\tthis.resetter = resetter;\n+\t\t\tresetter.setupRegistry();\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic void close() throws Throwable {\n+\t\t\tif (resetter != null) {\n+\t\t\t\tresetter.restoreRegistry();\n+\t\t\t\tresetter = null;\n+\t\t\t}\n+\t\t}\n+\t}\n \n+\t/**\n+\t * @since 2.24\n+\t */\n \t@Override\n-\tpublic void beforeEach(ExtensionContext context) throws Exception {\n+\tpublic void postProcessTestInstance(Object testInstance, ExtensionContext context) throws Exception {\n \t\tIInjectorProvider injectorProvider = getOrCreateInjectorProvider(context);\n-\t\tif (injectorProvider instanceof IRegistryConfigurator) {\n-\t\t\tfinal IRegistryConfigurator registryConfigurator = (IRegistryConfigurator) injectorProvider;\n-\t\t\tregistryConfigurator.setupRegistry();\n-\t\t}\n \t\tif (injectorProvider != null) {\n+\t\t\tsetupRegistry(injectorProvider, context);\n \t\t\tInjector injector = injectorProvider.getInjector();\n \t\t\tif (injector != null) {\n-\t\t\t\tObject testInstance = context.getRequiredTestInstance();\n \t\t\t\tinjector.injectMembers(testInstance);\n-\t\t\t\ttry {\n-\t\t\t\t\tTestInstances requiredTestInstances = context.getRequiredTestInstances();\n-\t\t\t\t\tfor (Object o : requiredTestInstances.getEnclosingInstances()) {\n-\t\t\t\t\t\tinjector.injectMembers(o);\n-\t\t\t\t\t}\n-\t\t\t\t} catch (NoSuchMethodError e) {\n-\t\t\t\t\tif (!Modifier.isStatic(testInstance.getClass().getModifiers())) {\n-\t\t\t\t\t\tif (testInstance.getClass().getDeclaringClass() != null) {\n-\t\t\t\t\t\t\tthrow new ExtensionConfigurationException(\"Injection of nested classes needs Junit5 >= 5.4\", e);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\t// OK, getRequiredTestInstances is not there in Junit5 < 5.4\n-\t\t\t\t}", "originalCommit": "c01ae557c7eb15b687765ddaace1359500d8644e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjY2Nw==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r491986667", "bodyText": "Should be fine since we only use 5.0 APIs now.", "author": "szarnekow", "createdAt": "2020-09-21T11:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzODA0OQ=="}], "type": "inlineReview"}, {"oid": "79ce19de91a44741b1a00189fca209809365812d", "url": "https://github.com/eclipse/xtext-core/commit/79ce19de91a44741b1a00189fca209809365812d", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T11:10:18Z", "type": "forcePushed"}, {"oid": "78e9f1c10fbd2f5a4500f2b0ecf64fc2a165510f", "url": "https://github.com/eclipse/xtext-core/commit/78e9f1c10fbd2f5a4500f2b0ecf64fc2a165510f", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T11:52:13Z", "type": "forcePushed"}, {"oid": "b7cb788f1dffc8cf692927a3f0e4eaff36b8dba7", "url": "https://github.com/eclipse/xtext-core/commit/b7cb788f1dffc8cf692927a3f0e4eaff36b8dba7", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T12:17:21Z", "type": "forcePushed"}, {"oid": "b7cb788f1dffc8cf692927a3f0e4eaff36b8dba7", "url": "https://github.com/eclipse/xtext-core/commit/b7cb788f1dffc8cf692927a3f0e4eaff36b8dba7", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T12:17:21Z", "type": "forcePushed"}, {"oid": "379b2d0422cdd69154e010ed87eb7a8ab593ceaf", "url": "https://github.com/eclipse/xtext-core/commit/379b2d0422cdd69154e010ed87eb7a8ab593ceaf", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T13:01:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMDA1OA==", "url": "https://github.com/eclipse/xtext-core/pull/1576#discussion_r492100058", "bodyText": "Not needed. I'll remove that since it's only required for tests and not for consumers of this bundle.", "author": "szarnekow", "createdAt": "2020-09-21T14:38:14Z", "path": "org.eclipse.xtext.testing/META-INF/MANIFEST.MF", "diffHunk": "@@ -27,7 +27,9 @@ Require-Bundle: org.eclipse.xtext;visibility:=reexport,\n  org.eclipse.xtend.lib\n Import-Package: org.apache.log4j;version=\"1.2.15\",\n  org.apache.log4j.spi;version=\"1.2.15\",\n- org.junit.jupiter.api.extension;version=\"[5.0.0,6.0.0)\";resolution:=optional\n+ org.junit.jupiter.api.extension;version=\"[5.0.0,6.0.0)\";resolution:=optional,\n+ org.junit.platform.runner;version=\"[1.0.0,2.0.0)\";resolution:=optional,", "originalCommit": "379b2d0422cdd69154e010ed87eb7a8ab593ceaf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e02e19a709f82677f1b7731a8cef635c326d5853", "url": "https://github.com/eclipse/xtext-core/commit/e02e19a709f82677f1b7731a8cef635c326d5853", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T14:51:39Z", "type": "commit"}, {"oid": "e02e19a709f82677f1b7731a8cef635c326d5853", "url": "https://github.com/eclipse/xtext-core/commit/e02e19a709f82677f1b7731a8cef635c326d5853", "message": "Fixed regression with InjectionExtension\n\n- Feature: Allow to use RegisterExtension along with injected fields.\n- Releng: Make sure that we run the testing.tests for Junit5 on Jenkins.\n\ncloses eclipse/xtext#1851", "committedDate": "2020-09-21T14:51:39Z", "type": "forcePushed"}]}