{"pr_number": 3047, "pr_title": "Improve extra key handling", "pr_createdAt": "2020-12-18T12:28:50Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/3047", "timeline": [{"oid": "0f38dcfb05e99b85acc67520911619242de4a3aa", "url": "https://github.com/uyuni-project/uyuni/commit/0f38dcfb05e99b85acc67520911619242de4a3aa", "message": "update changelog", "committedDate": "2020-12-21T16:53:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTQyMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179421", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                       LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n          \n          \n            \n                                LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name", "author": "moio", "createdAt": "2020-12-22T09:54:32Z", "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name", "originalCommit": "0f38dcfb05e99b85acc67520911619242de4a3aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTU3NA==", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179574", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        SELECT * from missing\n          \n          \n            \n                            SELECT * from missing", "author": "moio", "createdAt": "2020-12-22T09:54:51Z", "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n+               WHERE rhnPackageExtraTagKey.id IS NULL\n+            )\n+            INSERT INTO rhnPackageExtraTagKey (id, name)\n+            SELECT * from missing", "originalCommit": "0f38dcfb05e99b85acc67520911619242de4a3aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3OTY2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/3047#discussion_r547179668", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ON CONFLICT DO NOTHING\n          \n          \n            \n                            ON CONFLICT DO NOTHING", "author": "moio", "createdAt": "2020-12-22T09:55:02Z", "path": "backend/server/importlib/backend.py", "diffHunk": "@@ -299,40 +298,40 @@ def processCVEs(self, cveHash):\n         h.executemany(id=toinsert[0], name=toinsert[1])\n \n     def processExtraTags(self, extraTags):\n-        query_lookup = \"\"\"\n-            SELECT id\n-              FROM rhnPackageExtraTagKey\n-             WHERE name = :name\n+        if not extraTags:\n+            return\n+        sql = \"\"\"\n+            WITH wanted (name) AS (\n+              VALUES %s\n+            )\n+            missing AS (\n+              SELECT nextval('rhn_package_extra_tags_keys_id_seq') AS id, wanted.name\n+                FROM wanted\n+           LEFT JOIN rhnPackageExtraTagKey ON rhnPackageExtraTagKey.name = wanted.name\n+               WHERE rhnPackageExtraTagKey.id IS NULL\n+            )\n+            INSERT INTO rhnPackageExtraTagKey (id, name)\n+            SELECT * from missing\n+            ON CONFLICT DO NOTHING", "originalCommit": "0f38dcfb05e99b85acc67520911619242de4a3aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71792e766980fa8400a329131a2677cdcb52f6f9", "url": "https://github.com/uyuni-project/uyuni/commit/71792e766980fa8400a329131a2677cdcb52f6f9", "message": "do no raise unique constraint violation on conflicts", "committedDate": "2020-12-30T10:44:41Z", "type": "commit"}, {"oid": "467af5f8c4f45702eb57cd1419e856d11df87981", "url": "https://github.com/uyuni-project/uyuni/commit/467af5f8c4f45702eb57cd1419e856d11df87981", "message": "use execute_values for extra tag keys", "committedDate": "2020-12-30T10:44:41Z", "type": "commit"}, {"oid": "4ae30efd97508795496ba0f9c81574ba21db33ea", "url": "https://github.com/uyuni-project/uyuni/commit/4ae30efd97508795496ba0f9c81574ba21db33ea", "message": "update changelog", "committedDate": "2020-12-30T10:44:41Z", "type": "commit"}, {"oid": "02b2b473327817ee47b8fca7623cd0eb93cd4d64", "url": "https://github.com/uyuni-project/uyuni/commit/02b2b473327817ee47b8fca7623cd0eb93cd4d64", "message": "Update backend/server/importlib/backend.py\n\nCo-authored-by: Silvio Moioli <moio@suse.com>", "committedDate": "2020-12-30T10:45:01Z", "type": "commit"}, {"oid": "02b2b473327817ee47b8fca7623cd0eb93cd4d64", "url": "https://github.com/uyuni-project/uyuni/commit/02b2b473327817ee47b8fca7623cd0eb93cd4d64", "message": "Update backend/server/importlib/backend.py\n\nCo-authored-by: Silvio Moioli <moio@suse.com>", "committedDate": "2020-12-30T10:45:01Z", "type": "forcePushed"}]}