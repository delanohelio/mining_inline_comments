{"pr_number": 1983, "pr_title": "Virt pool definition", "pr_createdAt": "2020-03-05T11:43:47Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/1983", "timeline": [{"oid": "3ddf597601fe17c8ef0256b001bcb327824470bb", "url": "https://github.com/uyuni-project/uyuni/commit/3ddf597601fe17c8ef0256b001bcb327824470bb", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-05T16:13:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5Nzg4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388397884", "bodyText": "Nitpick: This code seems to repeat across your PRs. Maybe you can extract it to utility function after the PRs with similar code are merged.", "author": "mateiw", "createdAt": "2020-03-05T16:10:52Z", "path": "web/html/src/manager/virtualization/pools/virtualization-pool-definition-api.js", "diffHunk": "@@ -0,0 +1,39 @@\n+// @flow\n+import * as React from 'react';\n+import Network from 'utils/network';\n+import * as Messages from 'components/messages';\n+\n+type Props = {\n+  /** Virtual host server ID */\n+  hostid: string,\n+  /** Name of the pool for which to get the defintion*/\n+  poolName: string,\n+  /** Children function rendering the content depending on the request result */\n+  children: ({definition: Object, messages: React.Node}) => React.Node,\n+};\n+\n+/** Component calling the Uyuni REST API to get the XML definition of a virtual storage pool */\n+export function VirtualizationPoolDefinitionApi(props: Props) {\n+  const [messages, setMessages] = React.useState([]);\n+  const [definition, setDefinition] = React.useState(null);\n+\n+  React.useEffect(() => {\n+    Network.get(`/rhn/manager/api/systems/details/virtualization/pools/${props.hostid}/pool/${props.poolName}`,\n+      'application/json').promise\n+      .then((response) => {\n+        setDefinition(response);\n+      }, (xhr) => {\n+        const errMessages = xhr.status === 0", "originalCommit": "49ab21686e58ed1ac6c29dd081d535c195853473", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMDgxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388420818", "bodyText": "yes, I'll try to do that after the PRs are merged", "author": "cbosdo", "createdAt": "2020-03-05T16:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5Nzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDE2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388404169", "bodyText": "I think this can throw a NullPointerException if for some reason the parsing fails and pool is null.", "author": "mateiw", "createdAt": "2020-03-05T16:20:30Z", "path": "java/code/src/com/suse/manager/virtualization/VirtManager.java", "diffHunk": "@@ -80,6 +80,29 @@\n         return saltService.callSync(call, minionId);\n     }\n \n+    /**\n+     * Query virtual storage pool definition\n+     *\n+     * @param minionId the host minion ID\n+     * @param poolName the domain name to look for\n+     * @return the XML definition or an empty Optional\n+     */\n+    public static Optional<PoolDefinition> getPoolDefinition(String minionId, String poolName) {\n+        Map<String, JsonObject> infos = getPools(minionId);\n+\n+        Map<String, Object> args = new LinkedHashMap<>();\n+        args.put(\"name\", poolName);\n+        LocalCall<String> call =\n+                new LocalCall<>(\"virt.pool_get_xml\", Optional.empty(), Optional.of(args), new TypeToken<String>() { });\n+\n+        Optional<String> result = saltService.callSync(call, minionId);\n+        return result.filter(s -> !s.startsWith(\"ERROR\")).map(xml -> {\n+            PoolDefinition pool = PoolDefinition.parse(xml);\n+            pool.setAutostart(infos.get(poolName).get(\"autostart\").getAsInt() == 1);", "originalCommit": "3ddf597601fe17c8ef0256b001bcb327824470bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NDEwMg==", "url": "https://github.com/uyuni-project/uyuni/pull/1983#discussion_r388444102", "bodyText": "handled", "author": "cbosdo", "createdAt": "2020-03-05T17:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDE2OQ=="}], "type": "inlineReview"}, {"oid": "a277fe244c04c2f8e8717fedd45c66569a7d6aef", "url": "https://github.com/uyuni-project/uyuni/commit/a277fe244c04c2f8e8717fedd45c66569a7d6aef", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-05T17:18:59Z", "type": "forcePushed"}, {"oid": "599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "url": "https://github.com/uyuni-project/uyuni/commit/599bec39a543be219eb5e76f57dfb3a11bbd4cdf", "message": "Add virtual pool definition model", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "c82a03f3f219f6153e7b605dcc876306d86de5d5", "url": "https://github.com/uyuni-project/uyuni/commit/c82a03f3f219f6153e7b605dcc876306d86de5d5", "message": "VirtManager: expose API to get a pool definition\n\nIn order to edit an existing pool, we need to fetch and parse the\ndefinition from libvirt.", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-06T13:37:55Z", "type": "commit"}, {"oid": "9b8452433f0cee9c0bc434b58f6ffc670e186258", "url": "https://github.com/uyuni-project/uyuni/commit/9b8452433f0cee9c0bc434b58f6ffc670e186258", "message": "Expose REST API to provide the definition of a virtual storage pool.", "committedDate": "2020-03-06T13:37:55Z", "type": "forcePushed"}]}