{"pr_number": 2039, "pr_title": "Automatic db schema upgrade", "pr_createdAt": "2020-03-20T16:15:15Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2039", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NTcxMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396285712", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The changes will be applied automatically at the end\n          \n          \n            \n            The patch will be applied automatically at the end", "author": "keichwa", "createdAt": "2020-03-23T08:41:58Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end", "originalCommit": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjAxMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            In case of a failure, some services are stopped or cannot\n          \n          \n            \n            In case of a failure, spacewalk services are stopped and cannot", "author": "keichwa", "createdAt": "2020-03-23T08:42:29Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot", "originalCommit": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjI3Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286277", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            be started util the issue was fixed.\n          \n          \n            \n            be started until the issue is fixed.", "author": "keichwa", "createdAt": "2020-03-23T08:42:56Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.", "originalCommit": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4Njc0NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396286744", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            For more information about the failure call:\n          \n          \n            \n            For more information about the failure, enter:", "author": "keichwa", "createdAt": "2020-03-23T08:43:46Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure call:", "originalCommit": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NzI1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396287253", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the schema update was applied successfully, start the\n          \n          \n            \n            When the schema update is applied successfully, start the", "author": "keichwa", "createdAt": "2020-03-23T08:44:41Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The changes will be applied automatically at the end\n+of the update.\n+In case of a failure, some services are stopped or cannot\n+be started util the issue was fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure call:\n \n-2. Apply the patch.\n+systemctl status uyuni-check-database.service\n \n-3. If the SUSE Manager database is running on the same machine as\n-your SUSE Manager Server, take care that the database instance is\n-running\n+When the schema update was applied successfully, start the", "originalCommit": "fd4ad8955a4bb73821f75d204fee73c02a2f60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNTczNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396315734", "bodyText": "Shouldn't  it be spacewalk service as we had before?", "author": "juliogonzalez", "createdAt": "2020-03-23T09:33:34Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The patch will be applied automatically at the end\n+of the update.\n+In case of a failure, spacewalk services are stopped and cannot", "originalCommit": "7b9092e6ec88fa0878c2fe068813943d64cd2188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3NTI1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396375253", "bodyText": "Well, there not this one spacewalk service. spacewalk-service is a systemd target and contains multiple services.", "author": "mcalmer", "createdAt": "2020-03-23T11:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNTczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNjQ3Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396316476", "bodyText": "As I don't see this service here, I guess it was added in the past, right?\nThis looks good, the package will not break as we always return true, so there will be this error, but services will not start.", "author": "juliogonzalez", "createdAt": "2020-03-23T09:34:49Z", "path": "schema/spacewalk/susemanager-schema.spec", "diffHunk": "@@ -103,6 +103,9 @@ else\n fi\n %endif\n \n+%posttrans\n+systemctl try-restart uyuni-check-database.service ||:", "originalCommit": "7b9092e6ec88fa0878c2fe068813943d64cd2188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3NTczNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396375736", "bodyText": "yes, and there are now dependencies which turn tomcat, apache, etc. off if this fail.", "author": "mcalmer", "createdAt": "2020-03-23T11:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxNjQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxOTY4OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396319688", "bodyText": "service or services?", "author": "juliogonzalez", "createdAt": "2020-03-23T09:39:55Z", "path": "schema/spacewalk/update-messages.txt", "diffHunk": "@@ -2,19 +2,16 @@\n SUSE Manager Database Schema Update\n \n This patch updates the database schema.\n-Additional configuration steps are required.\n+The patch will be applied automatically at the end\n+of the update.\n+In case of a failure, spacewalk services are stopped and cannot\n+be started until the issue is fixed.\n \n-1. Stop the Spacewalk service before you apply this patch:\n-spacewalk-service stop\n+For more information about the failure, enter:\n \n-2. Apply the patch.\n+systemctl status uyuni-check-database.service\n \n-3. If the SUSE Manager database is running on the same machine as\n-your SUSE Manager Server, take care that the database instance is\n-running\n+When the schema update is applied successfully, start the\n+services again with:", "originalCommit": "7b9092e6ec88fa0878c2fe068813943d64cd2188", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODgwNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396348806", "bodyText": "Why do we need this change?", "author": "hustodemon", "createdAt": "2020-03-23T10:28:44Z", "path": "spacewalk/admin/spacewalk-admin.spec", "diffHunk": "@@ -86,6 +86,12 @@ ln -s spacewalk-service $RPM_BUILD_ROOT%{_sbindir}/rhn-satellite\n sed -i 's|#!/usr/bin/python|#!/usr/bin/python3|' $RPM_BUILD_ROOT/usr/bin/mgr-events-config.py\n %endif\n \n+%post", "originalCommit": "7b9092e6ec88fa0878c2fe068813943d64cd2188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3NzQwMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2039#discussion_r396377400", "bodyText": "This is a fix which would be good to have already now. when we change .service files or add new, we need to reload the systemd daemon. Otherwise it does not know about the changes.\nspacewalk-admin is not touched very often. So I think it is ok, to call a reload on every change.", "author": "mcalmer", "createdAt": "2020-03-23T11:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODgwNg=="}], "type": "inlineReview"}, {"oid": "24aa504e1b84e73a10225c51cafc5700ba06ce24", "url": "https://github.com/uyuni-project/uyuni/commit/24aa504e1b84e73a10225c51cafc5700ba06ce24", "message": "run database schema upgrade on startup", "committedDate": "2020-03-23T15:04:54Z", "type": "commit"}, {"oid": "eccd5fbfce35956f056063e2689f2e0de3535fc3", "url": "https://github.com/uyuni-project/uyuni/commit/eccd5fbfce35956f056063e2689f2e0de3535fc3", "message": "update changelog", "committedDate": "2020-03-23T15:04:54Z", "type": "commit"}, {"oid": "be06938711ddee0a782f77acaf4708c77c250308", "url": "https://github.com/uyuni-project/uyuni/commit/be06938711ddee0a782f77acaf4708c77c250308", "message": "reload systemd daemon on package install or update", "committedDate": "2020-03-23T15:04:54Z", "type": "commit"}, {"oid": "b43cb6ce07a90ce83dcdd370543c82de148f1220", "url": "https://github.com/uyuni-project/uyuni/commit/b43cb6ce07a90ce83dcdd370543c82de148f1220", "message": "change update message to reflect schema auto upgrade", "committedDate": "2020-03-23T15:04:54Z", "type": "commit"}, {"oid": "8c3f78653ce3f452867386e343c56fca61f1aead", "url": "https://github.com/uyuni-project/uyuni/commit/8c3f78653ce3f452867386e343c56fca61f1aead", "message": "try to restart database check to apply schema upgrade", "committedDate": "2020-03-23T15:04:54Z", "type": "commit"}, {"oid": "47312d3cc728257e9b3fe9295e084d4d43740982", "url": "https://github.com/uyuni-project/uyuni/commit/47312d3cc728257e9b3fe9295e084d4d43740982", "message": "update changelog", "committedDate": "2020-03-23T15:05:13Z", "type": "commit"}, {"oid": "21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "url": "https://github.com/uyuni-project/uyuni/commit/21dd3dc17cfa8fc1c4132965f9a6a5e191ae0729", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>", "committedDate": "2020-03-23T15:05:46Z", "type": "forcePushed"}, {"oid": "307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "url": "https://github.com/uyuni-project/uyuni/commit/307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>", "committedDate": "2020-03-23T15:32:25Z", "type": "commit"}, {"oid": "307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "url": "https://github.com/uyuni-project/uyuni/commit/307cb9eb0bf6ba18dd89ed9275d0ad08b9569a3f", "message": "Update update-messages.txt\n\nCo-Authored-By: Karl Eichwalder <ke@suse.de>", "committedDate": "2020-03-23T15:32:25Z", "type": "forcePushed"}]}