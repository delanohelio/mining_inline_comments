{"pr_number": 1929, "pr_title": "Clean stale Content Environment targets & Prevent users from trigerring Content Project build/promote when colliding operation is in progress", "pr_createdAt": "2020-02-19T13:23:40Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/1929", "timeline": [{"oid": "e57da92ccfb6f1c52d0047deaefee41c88aa03e8", "url": "https://github.com/uyuni-project/uyuni/commit/e57da92ccfb6f1c52d0047deaefee41c88aa03e8", "message": "Changelog", "committedDate": "2020-02-20T16:48:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4MDk2Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385180963", "bodyText": "IIUC those two conditions stand for:\n\nif the first environment is building from sources, I will not be able to Build because if I do that it would overwrite the current building\nif the second environment is building, I will not be able to Build because if I do that the current building from the  first environment to the second will be overwritten\n\nAre these correct? I'd say let's add one line comment for each, what do you think?", "author": "ncounter", "createdAt": "2020-02-27T15:21:43Z", "path": "web/html/src/manager/content-management/project/project.js", "diffHunk": "@@ -73,7 +73,11 @@ const Project = (props: Props) => {\n   }\n \n   const isProjectEdited = changesToBuild.length > 0;\n-  const isBuildDisabled = !hasEditingPermissions || _isEmpty(project.environments) || _isEmpty(project.softwareSources);\n+  const isBuildDisabled = !hasEditingPermissions\n+        || _isEmpty(project.environments)\n+        || _isEmpty(project.softwareSources)\n+        || project.environments[0].status === \"building\"\n+        || (project.environments[1] || {}).status === \"building\";", "originalCommit": "a954334cccbb0285042d0206ab9f0b30d88cc0dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDcwNg==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r390150706", "bodyText": "Just to elaborate on the 2nd point:\nIf the 2nd environment is building (in other words promotion from 1st to 2nd env is going on), channels are cloned from the 1st environment to the 2nd one. We want to prevent build, as it would change channels in the 1st environment, which are used by the ongoing promotion.\nAn example:\nInitial configuration (source + 2 environments):\nS -> 1 -> 2\n\nLets promote 1 to 2\nS -> [ 1 -> 2 ]\n\nLets  build the source at the same time! \nWait, we can't, since it's target (1) is already used as a source for promoting.\n[S -> [ 1 ]-> 2 ]\n\nI'll add some comments, that'd make sense.", "author": "hustodemon", "createdAt": "2020-03-10T08:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4MDk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4NTYzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385185639", "bodyText": "Good idea, I like the fact we give a hint in the UI, I'd also suggest to add a clear note in the documentation about the entire behavior. \ud83d\udc4d", "author": "ncounter", "createdAt": "2020-02-27T15:28:13Z", "path": "web/html/src/manager/content-management/shared/components/panels/promote/promote.js", "diffHunk": "@@ -37,13 +38,18 @@ const Promote = (props: Props) => {\n   }, [open]);\n \n   const modalNameId = `${props.environmentPromote.label}-cm-promote-env-modal`;\n+\n   const disabled =\n     !hasEditingPermissions\n     || !props.environmentPromote.version\n-    || props.environmentPromote.version <= props.environmentTarget.version;\n+    || props.environmentPromote.version <= props.environmentTarget.version\n+    || props.environmentPromote.status === \"building\"\n+    || props.environmentTarget.status === \"building\"\n+    || (props.environmentNextTarget || {}).status === \"building\";\n+\n   return (\n     <div\n-      {...(disabled ? {title: t(\"No version to promote\")} : {})}\n+      {...(disabled ? {title: t(\"No version to promote or colliding environment build in progress\")} : {})}", "originalCommit": "a954334cccbb0285042d0206ab9f0b30d88cc0dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NTUzNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385675535", "bodyText": "How many of these objects to we expect in worst case?\nIf it is more than, say, 100, I would suggest an UPDATE query instead of SELECTing, hydrating, updating and saving back (I would imagine at a later point in time).", "author": "moio", "createdAt": "2020-02-28T12:44:23Z", "path": "java/code/src/com/redhat/rhn/domain/contentmgmt/ContentProjectFactory.java", "diffHunk": "@@ -567,6 +567,22 @@ public static void remove(ContentProjectFilter filter) {\n         INSTANCE.removeObject(filter);\n     }\n \n+    /**\n+     * Set all BUILDING {@link EnvironmentTarget}s to FAILED state.\n+     *\n+     * @return the number of updated targets\n+     */\n+    public static int failStaleTargets() {\n+        List<EnvironmentTarget> targets = HibernateFactory.getSession()", "originalCommit": "2bf85e0a658c36cb2625284ab7683f4314061e50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NzI0Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385677246", "bodyText": "In typical scenarios, it shouldn't be more than tens of objects.\nBut your suggestion sounds like a most natural approach and I like it. Let me change it.", "author": "hustodemon", "createdAt": "2020-02-28T12:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NTUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NTk4Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385675987", "bodyText": "Most cleanups of this kind currently take place in Taskomatic. What would be the pros and cons in this specific case?", "author": "moio", "createdAt": "2020-02-28T12:45:23Z", "path": "java/code/src/com/redhat/rhn/manager/satellite/StartupTasksCommand.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package com.redhat.rhn.manager.satellite;\n+\n+import com.redhat.rhn.common.hibernate.HibernateFactory;\n+import com.redhat.rhn.domain.contentmgmt.ContentProjectFactory;\n+import com.redhat.rhn.manager.BaseTransactionCommand;\n+\n+import org.apache.log4j.Logger;\n+\n+/**\n+ * Tasks to be performed on the application startup\n+ */\n+public class StartupTasksCommand extends BaseTransactionCommand {", "originalCommit": "74f28e61e97077774a7f9d8205dc443dddc2c8e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY4MDU5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385680597", "bodyText": "Handling the problem in Tasko:\nPros: staying consistent with the most cleanup tasks ;)\nCons: Taskomatic doesn't know which tasks are stale, so it' impossible to flag those as failed: The tasks are run as asynchronous actions in tomcat. Each task has an attribute status (BUILDING, FAILED, COMPLETED,...). When the CLM build logic runs (in tomcat), the status is set based on the progress of the build. Taskomatic has no way to figure out if a task in BUILDING state is still doing something or if it's stale. OTOH, on Tomcat startup, we can safely say that all BUILDING tasks are stale.", "author": "hustodemon", "createdAt": "2020-02-28T12:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NTk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY4NTY1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/1929#discussion_r385685653", "bodyText": "Then I understand that a Taskomatic based approach has no chance.\nYou have my blessing for the approach.", "author": "moio", "createdAt": "2020-02-28T13:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NTk4Nw=="}], "type": "inlineReview"}, {"oid": "37c843fa7c875d844e5f67bf74b7b606ceff05be", "url": "https://github.com/uyuni-project/uyuni/commit/37c843fa7c875d844e5f67bf74b7b606ceff05be", "message": "Method for finding & cleaning stale Content Lifecycle targets", "committedDate": "2020-03-10T07:38:47Z", "type": "commit"}, {"oid": "004f9f3116df3bdd56149f6c5ac843f9c341208c", "url": "https://github.com/uyuni-project/uyuni/commit/004f9f3116df3bdd56149f6c5ac843f9c341208c", "message": "Clean stale Content Lifecycle targets on Tomcat startup", "committedDate": "2020-03-10T07:38:47Z", "type": "commit"}, {"oid": "cb65ed7ceafc1d120a08241d19578dba02fceca1", "url": "https://github.com/uyuni-project/uyuni/commit/cb65ed7ceafc1d120a08241d19578dba02fceca1", "message": "Backend: Prevent build/promote on Content Projects which have build/promote in progress", "committedDate": "2020-03-10T07:38:48Z", "type": "commit"}, {"oid": "24a6f42ba410a9677a356c604f799b6ac147f202", "url": "https://github.com/uyuni-project/uyuni/commit/24a6f42ba410a9677a356c604f799b6ac147f202", "message": "Tests: Prevent build/promote on Content Projects which have build/promote in progress", "committedDate": "2020-03-10T07:38:48Z", "type": "commit"}, {"oid": "71b5e8dff39c29754645ac92502af179ac9fe432", "url": "https://github.com/uyuni-project/uyuni/commit/71b5e8dff39c29754645ac92502af179ac9fe432", "message": "Tests: Complex scenario: Prevent build/promote on Content Projects which have build/promote in progress", "committedDate": "2020-03-10T07:38:48Z", "type": "commit"}, {"oid": "ee1d09c9643775b28beda52a1ef171d8bd84fe61", "url": "https://github.com/uyuni-project/uyuni/commit/ee1d09c9643775b28beda52a1ef171d8bd84fe61", "message": "Fix: Propagate the async flag correctly on Content Project promote", "committedDate": "2020-03-10T07:38:48Z", "type": "commit"}, {"oid": "43b78c025a2ce55edd6cd4847a291375dcea8b4b", "url": "https://github.com/uyuni-project/uyuni/commit/43b78c025a2ce55edd6cd4847a291375dcea8b4b", "message": "Frontend: Prevent build/promote on Content Projects which have colliding build/promote in progress", "committedDate": "2020-03-10T07:38:48Z", "type": "commit"}, {"oid": "b808fa4fdb6da8eba2fff922e24d643526e9f9a3", "url": "https://github.com/uyuni-project/uyuni/commit/b808fa4fdb6da8eba2fff922e24d643526e9f9a3", "message": "Changelog", "committedDate": "2020-03-10T07:39:06Z", "type": "commit"}, {"oid": "a4ff41063a84f3fb5aab1693118588f257dbfa66", "url": "https://github.com/uyuni-project/uyuni/commit/a4ff41063a84f3fb5aab1693118588f257dbfa66", "message": "Allow to re-promote an environment", "committedDate": "2020-03-10T07:39:06Z", "type": "commit"}, {"oid": "dd6fb5677de459feed253fe4ee6bd274ab3e7930", "url": "https://github.com/uyuni-project/uyuni/commit/dd6fb5677de459feed253fe4ee6bd274ab3e7930", "message": "Use 'UPDATE' to fail stale CLM tasks instead of iterating through them", "committedDate": "2020-03-10T08:03:01Z", "type": "commit"}, {"oid": "dd6fb5677de459feed253fe4ee6bd274ab3e7930", "url": "https://github.com/uyuni-project/uyuni/commit/dd6fb5677de459feed253fe4ee6bd274ab3e7930", "message": "Use 'UPDATE' to fail stale CLM tasks instead of iterating through them", "committedDate": "2020-03-10T08:03:01Z", "type": "forcePushed"}, {"oid": "c2e118239682123b1c272ea65be77c4b7069441a", "url": "https://github.com/uyuni-project/uyuni/commit/c2e118239682123b1c272ea65be77c4b7069441a", "message": "Frontend: Add comments to the code", "committedDate": "2020-03-10T08:26:25Z", "type": "commit"}]}