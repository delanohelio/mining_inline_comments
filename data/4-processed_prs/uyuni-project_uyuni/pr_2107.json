{"pr_number": 2107, "pr_title": "Testsuite: Add test for monitoring feature", "pr_createdAt": "2020-04-08T08:54:40Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2107", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3NDc3NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405374774", "bodyText": "It might be better to assure that the endpoint can be requested outside localhost.", "author": "srbarrios", "createdAt": "2020-04-08T09:10:12Z", "path": "testsuite/features/step_definitions/navigation_steps.rb", "diffHunk": "@@ -876,3 +876,17 @@\n When(/^I scroll to the top of the page$/) do\n   execute_script('window.scrollTo(0,0)')\n end\n+\n+# Navigate to a service endpoint\n+When(/^I visit \"([^\"]*)\" endpoint of this \"([^\"]*)\"$/) do |service, host|\n+  node = get_target(host)\n+  port, text = case service\n+                when 'Prometheus' then [9090, \"graph\"]\n+                when 'Prometheus node exporter' then [9100, \"Node Exporter\"]\n+                when 'Prometheus apache exporter' then [9117, \"Apache Exporter\"]\n+                when 'Prometheus postgres exporter' then [9187, \"Postgres Exporter\"]\n+                else raise \"Unknown port for service #{service}\"\n+                end\n+  _output, code = node.run(\"curl -s http://localhost:#{port} | grep -i '#{text}'\")", "originalCommit": "47d703246a62397385b46884268c0c59c3bd9c41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "url": "https://github.com/uyuni-project/uyuni/commit/61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "message": "Testsuite: Add test for monitoring feature\n\n- testsuite/features/secondary/min_monitoring.feature\n- testsuite/features/secondary/min_centos_monitoring.feature:\nNew feature files.\n- testsuite/features/step_definitions/navigation_steps.rb:\nAdd step to check Prometheus exporters endpoints.", "committedDate": "2020-04-08T13:15:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0MTk2Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405541966", "bodyText": "Typo: 'cenos' -> 'centos'.\nOtherwise looks good to me!", "author": "cavalheiro", "createdAt": "2020-04-08T13:52:51Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0NzkwOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405547909", "bodyText": "no, it's (ugly) conventional names", "author": "Bischoff", "createdAt": "2020-04-08T14:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0MTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0ODE1NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405548154", "bodyText": "And -> When", "author": "Bischoff", "createdAt": "2020-04-08T14:01:02Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0OTU0NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405549544", "bodyText": "Ideally, we don't use internals like HTML or javascript internals. We use some clear English name, and convert it to the internal inside the step definition.\nLook at we do for Retail formulas to have an example.", "author": "Bischoff", "createdAt": "2020-04-08T14:02:50Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"\n+\n+  Scenario: Apply Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I should see a \"Choose formulas:\" text\n+    And I should see a \"Monitoring\" text\n+    And I check the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Configure Prometheus exporter formula on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I follow \"Prometheus Exporters\" in the content area\n+    And I should see a \"Enable and configure Prometheus exporters for managed systems.\" text\n+    And I check \"node_exporter#enabled\"\n+    And I check \"apache_exporter#enabled\"\n+    And I check \"postgres_exporter#enabled\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0OTY0MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405549641", "bodyText": "When", "author": "Bischoff", "createdAt": "2020-04-08T14:03:00Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"\n+\n+  Scenario: Apply Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I should see a \"Choose formulas:\" text\n+    And I should see a \"Monitoring\" text\n+    And I check the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Configure Prometheus exporter formula on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I follow \"Prometheus Exporters\" in the content area\n+    And I should see a \"Enable and configure Prometheus exporters for managed systems.\" text\n+    And I check \"node_exporter#enabled\"\n+    And I check \"apache_exporter#enabled\"\n+    And I check \"postgres_exporter#enabled\"\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Apply highstate for Prometheus exporters on the CentOS minion\n+     Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+     And I follow \"States\" in the content area", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU0OTgzMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405549831", "bodyText": "When", "author": "Bischoff", "createdAt": "2020-04-08T14:03:17Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"\n+\n+  Scenario: Apply Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I should see a \"Choose formulas:\" text\n+    And I should see a \"Monitoring\" text\n+    And I check the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Configure Prometheus exporter formula on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I follow \"Prometheus Exporters\" in the content area\n+    And I should see a \"Enable and configure Prometheus exporters for managed systems.\" text\n+    And I check \"node_exporter#enabled\"\n+    And I check \"apache_exporter#enabled\"\n+    And I check \"postgres_exporter#enabled\"\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Apply highstate for Prometheus exporters on the CentOS minion\n+     Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+     And I follow \"States\" in the content area\n+     And I click on \"Apply Highstate\"\n+     Then I should see a \"Applying the highstate has been scheduled.\" text\n+     And I wait until event \"Apply highstate scheduled by admin\" is completed\n+\n+  Scenario: Visit monitoring endpoints on the CentOS minion\n+    And I visit \"Prometheus node exporter\" endpoint of this \"ceos_ssh_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1MDE5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405550197", "bodyText": "one less space (indentation)", "author": "Bischoff", "createdAt": "2020-04-08T14:03:44Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"\n+\n+  Scenario: Apply Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I should see a \"Choose formulas:\" text\n+    And I should see a \"Monitoring\" text\n+    And I check the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Configure Prometheus exporter formula on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I follow \"Prometheus Exporters\" in the content area\n+    And I should see a \"Enable and configure Prometheus exporters for managed systems.\" text\n+    And I check \"node_exporter#enabled\"\n+    And I check \"apache_exporter#enabled\"\n+    And I check \"postgres_exporter#enabled\"\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Apply highstate for Prometheus exporters on the CentOS minion\n+     Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+     And I follow \"States\" in the content area\n+     And I click on \"Apply Highstate\"\n+     Then I should see a \"Applying the highstate has been scheduled.\" text\n+     And I wait until event \"Apply highstate scheduled by admin\" is completed\n+\n+  Scenario: Visit monitoring endpoints on the CentOS minion\n+    And I visit \"Prometheus node exporter\" endpoint of this \"ceos_ssh_minion\"\n+    And I visit \"Prometheus apache exporter\" endpoint of this \"ceos_ssh_minion\"\n+    And I visit \"Prometheus postgres exporter\" endpoint of this \"ceos_ssh_minion\"\n+\n+  Scenario: Cleanup: undo Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I uncheck the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Cleanup: apply highstate after test monitoring on the CentOS minion\n+     Given I am on the Systems overview page of this \"ceos_ssh_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1MDUzMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405550530", "bodyText": "One less space (indentation)", "author": "Bischoff", "createdAt": "2020-04-08T14:04:11Z", "path": "testsuite/features/secondary/min_centos_monitoring.feature", "diffHunk": "@@ -0,0 +1,60 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@centos_minion\n+Feature: Monitor SUMA environment with Prometheus on a CentOS minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the CentOS minion\n+    And I enable repository \"tools_pool_repo\" on this \"ceos_ssh_minion\"\n+\n+  Scenario: Apply Prometheus exporter formulas on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I should see a \"Choose formulas:\" text\n+    And I should see a \"Monitoring\" text\n+    And I check the \"prometheus-exporters\" formula\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Configure Prometheus exporter formula on the CentOS minion\n+    Given I am on the Systems overview page of this \"ceos_ssh_minion\"\n+    When I follow \"Formulas\" in the content area\n+    And I follow \"Prometheus Exporters\" in the content area\n+    And I should see a \"Enable and configure Prometheus exporters for managed systems.\" text\n+    And I check \"node_exporter#enabled\"\n+    And I check \"apache_exporter#enabled\"\n+    And I check \"postgres_exporter#enabled\"\n+    And I click on \"Save\"\n+    Then I should see a \"Formula saved\" text\n+\n+  Scenario: Apply highstate for Prometheus exporters on the CentOS minion\n+     Given I am on the Systems overview page of this \"ceos_ssh_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1MDk3Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2107#discussion_r405550972", "bodyText": "Same remarks as for CentOS one.", "author": "Bischoff", "createdAt": "2020-04-08T14:04:52Z", "path": "testsuite/features/secondary/min_monitoring.feature", "diffHunk": "@@ -0,0 +1,73 @@\n+# Copyright (c) 2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+@sle_minion\n+Feature: Monitor SUMA environment with Prometheus on a normal minion\n+  In order to monitore SUSE Manager server\n+  As an authorized user\n+  I want to enable Prometheus exporters\n+\n+  Scenario: Pre-requisite: enable Prometheus exporters repository on the minion\n+    And I enable repository \"tools_additional_repo\" on this \"sle_minion\"", "originalCommit": "61a9af8cad7d9faf3416ad5f6044eee0525e43b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e43ca8c7afce3ab95c5b0d3782f51a3abc7f40a", "url": "https://github.com/uyuni-project/uyuni/commit/5e43ca8c7afce3ab95c5b0d3782f51a3abc7f40a", "message": "Testsuite: Add test for monitoring feature\n\n- testsuite/features/secondary/min_monitoring.feature\n- testsuite/features/secondary/min_centos_monitoring.feature:\nNew feature files.\n- testsuite/features/step_definitions/navigation_steps.rb:\nAdd step to check a Prometheus exporter inside a formula.\nAdd step to verify that a Prometheus exporter endpoint is accesible.\n\n- testsuite/run_sets/secondary.yml: List min_centos_monitoring.feature.\n- testsuite/run_sets/secondary_parallelizable.yml: List min_monitoring.feature.", "committedDate": "2020-04-08T20:53:09Z", "type": "forcePushed"}, {"oid": "f479c87a65ec7ee0814021496eb42d1cb6c5fdd9", "url": "https://github.com/uyuni-project/uyuni/commit/f479c87a65ec7ee0814021496eb42d1cb6c5fdd9", "message": "Testsuite: Add test for monitoring feature\n\n- testsuite/features/secondary/min_monitoring.feature\n- testsuite/features/secondary/min_centos_monitoring.feature:\nNew feature files.\n- testsuite/features/step_definitions/navigation_steps.rb:\nAdd step to check a Prometheus exporter inside a formula.\nAdd step to verify that a Prometheus exporter endpoint is accesible.\n\n- testsuite/run_sets/secondary.yml: List min_centos_monitoring.feature.\n- testsuite/run_sets/secondary_parallelizable.yml: List min_monitoring.feature.", "committedDate": "2020-04-09T06:07:50Z", "type": "forcePushed"}, {"oid": "a336c98ced5cd8d649640be0d0a9ec12faf1e38c", "url": "https://github.com/uyuni-project/uyuni/commit/a336c98ced5cd8d649640be0d0a9ec12faf1e38c", "message": "Testsuite: Add test for monitoring feature\n\n- testsuite/features/secondary/min_monitoring.feature\n- testsuite/features/secondary/min_centos_monitoring.feature:\nNew feature files.\n- testsuite/features/step_definitions/navigation_steps.rb:\nAdd step to check a Prometheus exporter inside a formula.\nAdd step to verify that a Prometheus exporter endpoint is accesible.\n\n- testsuite/run_sets/secondary_parallelizable.yml: List the new tests.", "committedDate": "2020-04-09T08:12:26Z", "type": "commit"}, {"oid": "a336c98ced5cd8d649640be0d0a9ec12faf1e38c", "url": "https://github.com/uyuni-project/uyuni/commit/a336c98ced5cd8d649640be0d0a9ec12faf1e38c", "message": "Testsuite: Add test for monitoring feature\n\n- testsuite/features/secondary/min_monitoring.feature\n- testsuite/features/secondary/min_centos_monitoring.feature:\nNew feature files.\n- testsuite/features/step_definitions/navigation_steps.rb:\nAdd step to check a Prometheus exporter inside a formula.\nAdd step to verify that a Prometheus exporter endpoint is accesible.\n\n- testsuite/run_sets/secondary_parallelizable.yml: List the new tests.", "committedDate": "2020-04-09T08:12:26Z", "type": "forcePushed"}]}