{"pr_number": 2767, "pr_title": "Feat: Implement a Debian package comparator", "pr_createdAt": "2020-10-28T09:33:50Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2767", "timeline": [{"oid": "e8a33da12199c23ce8ca98e89ffc440561e9da5a", "url": "https://github.com/uyuni-project/uyuni/commit/e8a33da12199c23ce8ca98e89ffc440561e9da5a", "message": "add type to evr", "committedDate": "2020-10-28T09:42:39Z", "type": "forcePushed"}, {"oid": "cd2fbb282f1a28ebbbd222de21e5301c48d7ee73", "url": "https://github.com/uyuni-project/uyuni/commit/cd2fbb282f1a28ebbbd222de21e5301c48d7ee73", "message": "fix deps file", "committedDate": "2020-10-28T14:29:01Z", "type": "forcePushed"}, {"oid": "4e7f1552ff66d8f347b846ed4d27579700a251fe", "url": "https://github.com/uyuni-project/uyuni/commit/4e7f1552ff66d8f347b846ed4d27579700a251fe", "message": "fix type attribute access", "committedDate": "2020-10-28T16:00:31Z", "type": "forcePushed"}, {"oid": "3334dad21f982db8134e80a1ee1f1b0030253f5c", "url": "https://github.com/uyuni-project/uyuni/commit/3334dad21f982db8134e80a1ee1f1b0030253f5c", "message": "adjust rhnpackageevr indices", "committedDate": "2020-10-29T15:18:02Z", "type": "forcePushed"}, {"oid": "9ad2693b9d16298f5e1ac6508e68b7c6e22a1501", "url": "https://github.com/uyuni-project/uyuni/commit/9ad2693b9d16298f5e1ac6508e68b7c6e22a1501", "message": "fix idempotency", "committedDate": "2020-11-04T10:27:03Z", "type": "forcePushed"}, {"oid": "43c93a0afcfa8b00e482dc776c8112995801f518", "url": "https://github.com/uyuni-project/uyuni/commit/43c93a0afcfa8b00e482dc776c8112995801f518", "message": "remove references to rpm.vercmp in queries", "committedDate": "2020-11-05T13:50:14Z", "type": "forcePushed"}, {"oid": "a54740b5e97e12c8a538d7c8dccc23a0270da430", "url": "https://github.com/uyuni-project/uyuni/commit/a54740b5e97e12c8a538d7c8dccc23a0270da430", "message": "remove references to rpm.vercmp in queries", "committedDate": "2020-11-05T14:26:57Z", "type": "forcePushed"}, {"oid": "5a7a3464468fd847866e1ea173814c3e3f3443e1", "url": "https://github.com/uyuni-project/uyuni/commit/5a7a3464468fd847866e1ea173814c3e3f3443e1", "message": "fix java unit test", "committedDate": "2020-11-07T15:33:27Z", "type": "forcePushed"}, {"oid": "2a77564e67b86c92a1c5a1e4c774fa223f9e4838", "url": "https://github.com/uyuni-project/uyuni/commit/2a77564e67b86c92a1c5a1e4c774fa223f9e4838", "message": "change deb/rpm comparison", "committedDate": "2020-11-09T12:58:01Z", "type": "forcePushed"}, {"oid": "5621a1f5a687bb5cca360af877fc06f0fc9ea263", "url": "https://github.com/uyuni-project/uyuni/commit/5621a1f5a687bb5cca360af877fc06f0fc9ea263", "message": "change deb/rpm comparison", "committedDate": "2020-11-09T17:50:53Z", "type": "forcePushed"}, {"oid": "f8c2ab9ad53608356164c661968291ad7ec340cb", "url": "https://github.com/uyuni-project/uyuni/commit/f8c2ab9ad53608356164c661968291ad7ec340cb", "message": "make version type an enum", "committedDate": "2020-11-10T14:47:29Z", "type": "forcePushed"}, {"oid": "bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "url": "https://github.com/uyuni-project/uyuni/commit/bd276e425802bcc6d34bcc2a42f4a766b0bfa991", "message": "renmae lookup_evr2 back to lookup_evr", "committedDate": "2020-11-10T09:58:51Z", "type": "forcePushed"}, {"oid": "ff95dabd38bbc53a17f747b901d293bcd4c185ab", "url": "https://github.com/uyuni-project/uyuni/commit/ff95dabd38bbc53a17f747b901d293bcd4c185ab", "message": "renmae lookup_evr2 back to lookup_evr", "committedDate": "2020-11-11T16:49:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1NzE3Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523757172", "bodyText": "This is not anymore the test for PackageUtils. Should we move these tests to PackageEvrTest?", "author": "mcalmer", "createdAt": "2020-11-15T13:14:23Z", "path": "java/code/src/com/suse/manager/utils/test/PackageUtilsTest.java", "diffHunk": "@@ -19,23 +19,21 @@\n import com.redhat.rhn.domain.rhnpackage.PackageFactory;\n import com.redhat.rhn.domain.rhnpackage.test.PackageTest;\n import com.redhat.rhn.testing.BaseTestCaseWithUser;\n-import com.suse.manager.utils.PackageUtils;", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5Nzk4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r524097984", "bodyText": "would make sense i did not do that the first time since i wanted to keep diff minimal but now we should do it.", "author": "lucidd", "createdAt": "2020-11-16T10:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1NzE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODEzMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523758130", "bodyText": "Why do we still store epoch, version and release as single values? Could we just change the getters to return packageEvr.getXXX() ?", "author": "mcalmer", "createdAt": "2020-11-15T13:22:35Z", "path": "java/code/src/com/suse/manager/webui/utils/gson/PackageStateJson.java", "diffHunk": "@@ -89,6 +92,7 @@ public PackageStateJson(String nameIn, PackageEvr evrIn, String archIn) {\n         this.arch = archIn;\n         this.packageStateId = Optional.empty();\n         this.versionConstraintId = Optional.empty();\n+        this.packageEvr = evrIn;", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2OTQ3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r524269478", "bodyText": "i reworked this again and removed the packageEvr again since i found a place that read PackageStateJson from json which would not have worked.", "author": "lucidd", "createdAt": "2020-11-16T13:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODM4NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523758385", "bodyText": "Is it sufficient to use packageEvr directly? It might not contain the DB ID when it was just initialized with new.\nDo we need the ID?", "author": "mcalmer", "createdAt": "2020-11-15T13:24:58Z", "path": "java/code/src/com/suse/manager/webui/utils/gson/PackageStateJson.java", "diffHunk": "@@ -164,8 +168,7 @@ public String getArch() {\n                     VersionConstraints vc = versionConstraint.get();\n                     if (!Arrays.asList(VersionConstraints.LATEST, VersionConstraints.ANY)\n                             .contains(vc)) {\n-                        packageState.setEvr(PackageEvrFactory.lookupOrCreatePackageEvr(\n-                                getEpoch(), getVersion(), getRelease()));\n+                        packageState.setEvr(packageEvr);", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2OTkxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r524269918", "bodyText": "This is now fixed in the reworked version going back to using the lookup function and taking the evr type as parameter to this function instead.", "author": "lucidd", "createdAt": "2020-11-16T13:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc1ODM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2MDEyNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523760127", "bodyText": "When a_in is null, this will create a EVR without type.\nThis function is used in backend with an explicit arch set to None.\nhttps://github.com/uyuni-project/uyuni/blob/debvercmp-uyuni/backend/server/rhnServer/server_kickstart.py#L172-L207", "author": "mcalmer", "createdAt": "2020-11-15T13:39:01Z", "path": "schema/spacewalk/postgres/procs/lookup_transaction_package.sql", "diffHunk": "@@ -40,13 +41,16 @@ begin\n     end if;\n \n     n_id := lookup_package_name(n_in);\n-    e_id := lookup_evr(e_in, v_in, r_in);\n     p_arch_id := null;\n \n     if a_in is not null then\n         p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n+         on t.id = pa.arch_type_id where pa.id = p_arch_id;\n     end if;\n \n+    e_id := lookup_evr(e_in, v_in, r_in, type);", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2MjA2Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523762067", "bodyText": "I think this will create a mess when we run it multiple times.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            update rhnpackageevr set evr.type = 'rpm';\n          \n          \n            \n            update rhnpackageevr set evr.type = 'rpm' where evr.type is NULL;", "author": "mcalmer", "createdAt": "2020-11-15T13:54:25Z", "path": "schema/spacewalk/upgrade/susemanager-schema-4.2.2-to-susemanager-schema-4.2.3/1000-debvercmp.sql", "diffHunk": "@@ -0,0 +1,506 @@\n+DO $$\n+BEGIN\n+    IF NOT EXISTS (\n+        SELECT 1\n+        FROM pg_type t\n+        JOIN pg_class c ON c.oid = t.typrelid\n+        JOIN pg_attribute a ON a.attrelid = c.oid\n+        WHERE t.typname = 'evr_t'\n+        AND a.attname = 'type'\n+        )\n+    THEN\n+        alter type evr_t add attribute type varchar(10);\n+    END IF;\n+END $$;\n+\n+drop index rhn_pe_v_r_e_uq;\n+create unique index rhn_pe_v_r_e_uq\n+    on rhnpackageevr (version, release, epoch, ((evr).type))\n+ where epoch is not null;\n+\n+drop index rhn_pe_v_r_uq;\n+create unique index rhn_pe_v_r_uq\n+    on rhnpackageevr (version, release, ((evr).type))\n+ where epoch is null;\n+\n+create or replace function evr_t(e varchar, v varchar, r varchar, t varchar)\n+returns evr_t as $$\n+select row($1,$2,$3,$4)::evr_t\n+$$ language sql;\n+\n+\n+-- update evr_t comparison function to take type into account.\n+create or replace function evr_t_compare( a evr_t, b evr_t )\n+returns int as $$\n+begin\n+  if a.type = b.type then\n+      if a.type = 'rpm' then\n+        return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      elsif a.type = 'deb' then\n+        return deb.debvercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      else\n+        raise EXCEPTION 'unknown evr type (using rpm) -> %', a.type;\n+      end if;\n+  else\n+     raise NOTICE 'comparing incompatible evr types. Using %', a.type;\n+     if a.type = 'deb' then\n+       return -1;\n+     else\n+       return 1;\n+     end if;\n+  end if;\n+end;\n+$$ language plpgsql immutable strict;\n+\n+\n+create or replace function evr_t_ne( a evr_t, b evr_t )\n+returns boolean as $$\n+begin\n+  return evr_t_compare( a, b ) != 0;\n+end;\n+$$ language plpgsql immutable strict;\n+\n+drop operator if exists <> (evr_t, evr_t);\n+create operator <> (\n+  leftarg = evr_t,\n+  rightarg = evr_t,\n+  procedure = evr_t_ne,\n+  commutator = <>,\n+  negator = =,\n+  restrict = eqsel,\n+  join = eqjoinsel\n+);\n+\n+\n+-- update insert_evr\n+create or replace function\n+insert_evr(e_in in varchar, v_in in varchar, r_in in varchar, t_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    evr_id  numeric;\n+begin\n+    evr_id := nextval('rhn_pkg_evr_seq');\n+\n+    insert into rhnPackageEVR(id, epoch, version, release, evr)\n+        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in, t_in))\n+        on conflict do nothing;\n+\n+    select id\n+        into strict evr_id\n+        from rhnPackageEVR\n+        where ((epoch is null and e_in is null) or (epoch = e_in)) and\n+           version = v_in and release = r_in and (evr).type = t_in;\n+\n+    return evr_id;\n+end;\n+$$ language plpgsql;\n+\n+\n+-- update lookup_evr\n+create or replace function\n+lookup_evr(e_in in varchar, v_in in varchar, r_in in varchar, t_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    evr_id  numeric;\n+begin\n+    select id\n+      into evr_id\n+      from rhnPackageEVR\n+     where ((epoch is null and e_in is null) or (epoch = e_in)) and\n+           version = v_in and\n+           release = r_in and\n+           (evr).type = t_in;\n+\n+    if not found then\n+        -- HACK: insert is isolated in own function in order to be able to declare this function immutable\n+        -- Postgres optimizes immutable functions calls but those are compatible with the contract of lookup_\\*\n+        -- see https://www.postgresql.org/docs/9.6/xfunc-volatility.html\n+        return insert_evr(e_in, v_in, r_in, t_in);\n+    end if;\n+\n+    return evr_id;\n+end;\n+$$ language plpgsql immutable;\n+\n+\n+create or replace function\n+lookup_transaction_package(\n+    o_in in varchar,\n+    n_in in varchar,\n+    e_in in varchar,\n+    v_in in varchar,\n+    r_in in varchar,\n+    a_in in varchar)\n+returns numeric\n+as\n+$$\n+declare\n+    o_id        numeric;\n+    n_id        numeric;\n+    e_id        numeric;\n+    p_arch_id   numeric;\n+    tp_id       numeric;\n+    type        varchar;\n+begin\n+    select id\n+      into o_id\n+      from rhnTransactionOperation\n+     where label = o_in;\n+\n+    if not found then\n+        perform rhn_exception.raise_exception('invalid_transaction_operation');\n+    end if;\n+\n+    n_id := lookup_package_name(n_in);\n+    p_arch_id := null;\n+\n+    if a_in is not null then\n+        p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n+         on t.id = pa.arch_type_id where pa.id = p_arch_id;\n+    end if;\n+\n+    e_id := lookup_evr(e_in, v_in, r_in, type);\n+\n+    select id\n+      into tp_id\n+      from rhnTransactionPackage\n+     where operation = o_id and\n+           name_id = n_id and\n+           evr_id = e_id and\n+           (package_arch_id = p_arch_id or (p_arch_id is null and package_arch_id is null));\n+\n+    if not found then\n+        -- HACK: insert is isolated in own function in order to be able to declare this function immutable\n+        -- Postgres optimizes immutable functions calls but those are compatible with the contract of lookup_\\*\n+        -- see https://www.postgresql.org/docs/9.6/xfunc-volatility.html\n+        return insert_transaction_package(o_id, n_id, e_id, p_arch_id);\n+    end if;\n+    return tp_id;\n+end;\n+$$ language plpgsql immutable;\n+\n+\n+ALTER TABLE rhnpackageevr DISABLE TRIGGER USER;\n+\n+-- set all existing rhnpackageevr to rpm\n+update rhnpackageevr set evr.type = 'rpm';", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2Mjc5Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r523762792", "bodyText": "Wouldn't it be better to use '{0}', '{1}' .... ?\nI think then you need to specify the variables in format only once.", "author": "mcalmer", "createdAt": "2020-11-15T14:00:36Z", "path": "schema/util/debian-versioncmp-database-testgenerator.py", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/usr/bin/python3\n+\n+OUTPUT_SQL_SCRIPT_FILENAME = 'debian_version_database_comparator_tests.sql'\n+\n+preamble = \"\"\"\n+-- launch me with spacewalk-sql -i < {}\n+DO\n+$$\n+declare\n+\tresult NUMERIC := 0;\n+begin\n+\n+\"\"\".format(OUTPUT_SQL_SCRIPT_FILENAME)\n+\n+conclusion = \"\"\"\n+end;\n+$$\n+\"\"\"\n+\n+# source: https://git.dpkg.org/cgit/dpkg/dpkg.git/tree/scripts/t/Dpkg_Version.t\n+tests = \"\"\"1.0-1 2.0-2 -1\n+2.2~rc-4 2.2-1 -1\n+2.2-1 2.2~rc-4 1\n+1.0000-1 1.0-1 0\n+0foo 0foo 0\n+0foo-0 0foo 0\n+0foo 0foo-0 0\n+0foo 0fo 1\n+0foo-0 0foo+ -1\n+0foo~1 0foo -1\n+0foo~foo+Bar 0foo~foo+bar -1\n+0foo~~ 0foo~ -1\n+1~ 1 -1\n+12345+that-really-is-some-ver-0 12345+that-really-is-some-ver-10 -1\n+0foo-0 0foo-01 -1\n+0foo.bar 0foobar 1\n+0foo.bar 0foo1bar 1\n+0foo.bar 0foo0bar 1\n+0foo1bar-1 0foobar-1 -1\n+0foo2.0 0foo2 1\n+0foo2.0.0 0foo2.10.0 -1\n+0foo2.0 0foo2.0.0 -1\n+0foo2.0 0foo2.10 -1\n+0foo2.1 0foo2.10 -1\n+1.09 1.9 0\n+1.0.8+nmu1 1.0.8 1\n+3.11 3.10+nmu1 1\n+0.9j-20080306-4 0.9i-20070324-2 1\n+1.2.0~b7-1 1.2.0~b6-1 1\n+1.011-1 1.06-2 1\n+0.0.9+dfsg1-1 0.0.8+dfsg1-3 1\n+4.6.99+svn6582-1 4.6.99+svn6496-1 1\n+53 52 1\n+0.9.9~pre122-1 0.9.9~pre111-1 1\n+1.0.1+gpl-1 1.0.1-2 1\n+1a 1000a -1\"\"\"\n+\n+with open(OUTPUT_SQL_SCRIPT_FILENAME, 'w') as f:\n+    f.write(preamble)\n+\n+    for test in tests.split('\\n'):\n+        operand1, operand2, expected_result = test.split(' ')\n+        statement = \"\"\"--\n+    select * into result from deb.debstrcmp('{}', '{}');", "originalCommit": "e0b2f881efc342d1eea8e5b1862fabfca06411a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4OTUxMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r524289510", "bodyText": "Yes, you are right. Fixed", "author": "mbologna", "createdAt": "2020-11-16T14:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2Mjc5Mg=="}], "type": "inlineReview"}, {"oid": "03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "url": "https://github.com/uyuni-project/uyuni/commit/03c5f67a930c8525a20874c1ecf7dfd20a4391ff", "message": "reorder migration scripts", "committedDate": "2020-11-17T11:38:59Z", "type": "forcePushed"}, {"oid": "3d985d475c087b5666c987f1de8a3d48ec6e60bb", "url": "https://github.com/uyuni-project/uyuni/commit/3d985d475c087b5666c987f1de8a3d48ec6e60bb", "message": "reorder migration scripts", "committedDate": "2020-11-17T16:16:14Z", "type": "forcePushed"}, {"oid": "829ef079f90def2181a4b7ed684c6714c7ee7f95", "url": "https://github.com/uyuni-project/uyuni/commit/829ef079f90def2181a4b7ed684c6714c7ee7f95", "message": "reorder migration scripts", "committedDate": "2020-11-17T16:27:46Z", "type": "forcePushed"}, {"oid": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "url": "https://github.com/uyuni-project/uyuni/commit/933085fab8e348b5583cfef1d2ba155a0a0d7632", "message": "reorder migration scripts", "committedDate": "2020-11-20T17:13:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwODMzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529308339", "bodyText": "Likely a C&P comment.", "author": "hustodemon", "createdAt": "2020-11-24T08:59:36Z", "path": "java/code/src/com/redhat/rhn/common/util/DebVersionComparator.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util;\n+\n+import java.util.Comparator;\n+\n+/**\n+ * DebVersionComparatorTest", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMxNzMzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529317333", "bodyText": "Nit (here and below): unsupported/unknown would be more fitting, IMHO. When we implement a new type, but forget to change this method, we will \"reach the unreachable\" in the log \ud83d\ude09", "author": "hustodemon", "createdAt": "2020-11-24T09:07:04Z", "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/PackageEvr.java", "diffHunk": "@@ -221,4 +293,100 @@ public String toUniversalEvrString() {\n \n         return builder.toString();\n     }\n+\n+    /**\n+     * Parses a Debian package version string to create a {@link PackageEvr} object.\n+     *\n+     * Debian package versioning policy format: [epoch:]upstream_version[-debian_revision]\n+     * Additional ':' and '-' characters are allowed in 'upstream_version'\n+     * https://www.debian.org/doc/debian-policy/ch-controlfields.html#version\n+     *\n+     * @param version the package version string\n+     * @return the package EVR\n+     */\n+    public static PackageEvr parseDebian(String version) {\n+\n+        // repo-sync replaces empty releases with 'X'. We copy the same behavior.\n+        String release = \"X\";\n+        String epoch = null;\n+\n+        int epochIndex = version.indexOf(':');\n+        if (epochIndex > 0) {\n+            // Strip away optional 'epoch'\n+            epoch = version.substring(0, epochIndex);\n+            version = version.substring(epochIndex + 1);\n+        }\n+\n+        int releaseIndex = version.lastIndexOf('-');\n+        if (releaseIndex > 0) {\n+            // Strip away optional 'release'\n+            release = version.substring(releaseIndex + 1);\n+            version = version.substring(0, releaseIndex);\n+        }\n+\n+        return new PackageEvr(epoch, version, release, \"deb\");\n+    }\n+\n+    /**\n+     * Parses a RPM package version string to create a {@link PackageEvr} object.\n+     *\n+     * RPM package version policy format: [epoch:]version[-release]\n+     *\n+     * @param version the package version string\n+     * @return the package EVR\n+     */\n+    public static PackageEvr parseRpm(String version) {\n+        String release = \"\";\n+        String epoch = null;\n+\n+        int epochIndex = version.indexOf(':');\n+        if (epochIndex > 0) {\n+            // Strip away optional 'epoch'\n+            epoch = version.substring(0, epochIndex);\n+            version = version.substring(epochIndex + 1);\n+        }\n+\n+        int releaseIndex = version.lastIndexOf('-');\n+        if (releaseIndex > 0) {\n+            // Strip away optional 'release'\n+            release = version.substring(releaseIndex + 1);\n+            version = version.substring(0, releaseIndex);\n+        }\n+\n+        return new PackageEvr(epoch, version, release, \"rpm\");\n+    }\n+\n+    /**\n+     * @return package type\n+     */\n+    public PackageType getPackageType() {\n+        if (type.equals(PackageType.DEB.getDbString())) {\n+            return PackageType.DEB;\n+        }\n+        else if (type.equals(PackageType.RPM.getDbString())) {\n+            return PackageType.RPM;\n+        }\n+        else {\n+            throw new RuntimeException(\"unreachable\");", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyMDQ4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r529320484", "bodyText": "Is there a reason for modifying existing tests instead of just writing new? Don't we support comparing evr in format 0-0-0 anymore?", "author": "hustodemon", "createdAt": "2020-11-24T09:09:37Z", "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/test/PackageEvrComparableTest.java", "diffHunk": "@@ -24,42 +24,51 @@\n \n /**\n  * Test the compare() method in PackageEvr\n- * @version $Rev$\n  */\n public class PackageEvrComparableTest extends RhnBaseTestCase {\n \n     public void testEquality() {\n-        compare(0, \"0-0-0\", \"0-0-0\");\n-        compare(0, \"null-0-0\", \"0-0-0\");\n-        compare(0, \"null-0-0\", \"null-0-0\");\n+        compare(0, \"0:0-0\", \"0:0-0\");", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NTU1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530285558", "bodyText": "This format was only used for the tests here. It had a special parser only used here.\nI think it is much better if we use the official format and the official parser.", "author": "mcalmer", "createdAt": "2020-11-25T10:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyMDQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg0NTQxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530845418", "bodyText": "ok!", "author": "hustodemon", "createdAt": "2020-11-26T08:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMyMDQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5Nzg0Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530197847", "bodyText": "Nice approach! IIUC, the type column is:\n\nread only\ngenerated on every insert\nre-generated on every evr update,\n\nwhich should make the data in the table consistent.", "author": "hustodemon", "createdAt": "2020-11-25T08:47:40Z", "path": "schema/spacewalk/common/tables/rhnPackageEVR.sql", "diffHunk": "@@ -21,7 +21,8 @@ CREATE TABLE rhnPackageEVR\n     epoch    VARCHAR(16),\n     version  VARCHAR(512) NOT NULL,\n     release  VARCHAR(512) NOT NULL,\n-    evr      EVR_T NOT NULL\n+    evr      EVR_T NOT NULL,\n+    type varchar(10) generated always as ((evr).type) stored", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM3NDg0MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r533374841", "bodyText": "yes in addition the whole table is insert only anyway. The idea was also to try not to use any extra space but it seems currently this is only available with the stored keyword which takes up space.", "author": "lucidd", "createdAt": "2020-12-01T12:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5Nzg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MzM4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530243384", "bodyText": "Please either fix this right away or create a github issue.", "author": "hustodemon", "createdAt": "2020-11-25T09:55:10Z", "path": "java/code/src/com/suse/manager/utils/SaltUtils.java", "diffHunk": "@@ -1593,7 +1594,10 @@ public static String packageToKey(String name, Pkg.Info info) {\n                 new PackageEvr(\n                         info.getEpoch().orElse(null),\n                         info.getVersion().get(),\n-                        info.getRelease().orElse(\"X\")\n+                        info.getRelease().orElse(\"X\"),\n+                        //TODO: this is not correct but does not effect toUniversalEvrString.\n+                        // we should still do this differently", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0Mzk5OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530243999", "bodyText": "Same as above.", "author": "hustodemon", "createdAt": "2020-11-25T09:56:02Z", "path": "java/code/src/com/suse/manager/webui/controllers/StatesAPI.java", "diffHunk": "@@ -585,7 +588,8 @@ private Date getScheduleDate(ServerApplyHighstateJson json) {\n             new PackageStateJson(\n                     state.getName().getName(),\n                     Optional.ofNullable(state.getEvr())\n-                            .orElse(new PackageEvr(\"\", \"\", \"\")),\n+                            //TODO: this should probably be rather null instead of a dummy value\n+                            .orElse(new PackageEvr(\"\", \"\", \"\", PackageType.RPM)),", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NjI1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r530246253", "bodyText": "Please do it now or create a new issue. Piling up TODOs in the code is not good.", "author": "hustodemon", "createdAt": "2020-11-25T09:59:15Z", "path": "java/code/src/com/redhat/rhn/domain/server/Server.java", "diffHunk": "@@ -2192,4 +2193,9 @@ public String getChannelHost() {\n         return this.getFirstServerPath().map(p -> p.getHostname())\n                 .orElseGet(() -> ConfigDefaults.get().getCobblerHost());\n     }\n+\n+    public PackageType getPackageType() {\n+        //TODO: consider moving this to getOs", "originalCommit": "933085fab8e348b5583cfef1d2ba155a0a0d7632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNDg1MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536034851", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))\n          \n          \n            \n                               AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (SELECT at.label FROM rhnArchType at JOIN rhnPackageArch pa ON pa.arch_type_id = at.id WHERE pa.id = p.package_arch_id))\n          \n      \n    \n    \n  \n\nNitpick: keep casing coherent with rest of query", "author": "moio", "createdAt": "2020-12-04T11:33:37Z", "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -2105,7 +2105,7 @@ def import_susedata(self, repo):\n                   JOIN rhnChecksumView c ON p.checksum_id = c.id\n                   JOIN rhnChannelPackage cp ON p.id = cp.package_id\n                  WHERE pn.name = :name\n-                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release)\n+                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536035851", "bodyText": "Question: can repo.get_susedata() return any package on non-RPM repos? When does that happen?", "author": "moio", "createdAt": "2020-12-04T11:35:22Z", "path": "backend/satellite_tools/reposync.py", "diffHunk": "@@ -2105,7 +2105,7 @@ def import_susedata(self, repo):\n                   JOIN rhnChecksumView c ON p.checksum_id = c.id\n                   JOIN rhnChannelPackage cp ON p.id = cp.package_id\n                  WHERE pn.name = :name\n-                   AND p.evr_id = LOOKUP_EVR(:epoch, :version, :release)", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM3MDk5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537370997", "bodyText": "No as \"susedata\" exists only for SUSE systems and all of them are RPM based.", "author": "mcalmer", "createdAt": "2020-12-07T09:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4ODgxNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543288814", "bodyText": "No as \"susedata\" exists only for SUSE systems and all of them are RPM based.\n\nIn that case shouldn't we rather hardcode the RPM type in the line below?", "author": "moio", "createdAt": "2020-12-15T12:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMDEyOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543510128", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-15T16:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNTg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzOTY2Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536039667", "bodyText": "I wonder whether running a subquery for each chunk (with a result for each package) is the right approach here.\nBy the time we hit this _diff_packages_process, satsync.py should know if we are talking about an rpm or a deb repo here - woudn't it be better if we just passed it as a parameter along with :epoch, :version and :release at this point?", "author": "moio", "createdAt": "2020-12-04T11:42:37Z", "path": "backend/satellite_tools/satsync.py", "diffHunk": "@@ -920,7 +920,7 @@ def processShortPackages(self):\n                TO_CHAR(p.last_modified, 'YYYYMMDDHH24MISS') last_modified\n           from rhnPackage p, rhnChecksumView c\n          where p.name_id = lookup_package_name(:name)\n-           and p.evr_id = lookup_evr(:epoch, :version, :release)\n+           and p.evr_id = lookup_evr(:epoch, :version, :release, (select at.label from rhnArchType at join rhnPackageArch pa ON pa.arch_type_id = at.id where pa.id = p.package_arch_id))", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5ODI4Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537598283", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-07T15:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzOTY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0MzA5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536043097", "bodyText": "I wonder whether running a subquery for each package is the right approach here.\nInput to this query comes from rhnLib.parseRPMFilename, which actually is a very bad function name as it can parse both RPM and DEB file names.\nI think it would be better to have that function return the package type as well, and to pipe it into the query along with :epoch, :version and :release.\nWe should also probably take the occasion and rename it to parsePackageFilename or similar.", "author": "moio", "createdAt": "2020-12-04T11:49:00Z", "path": "backend/satellite_exporter/handlers/non_auth_dumper.py", "diffHunk": "@@ -537,7 +537,7 @@ def _send_package_stream(self, package, channel, checksum):\n                and cp.channel_id = c.id\n                and cp.package_id = p.id\n                and p.name_id = LOOKUP_PACKAGE_NAME(:name)\n-               and p.evr_id = LOOKUP_EVR(:epoch, :version, :release)\n+               and p.evr_id = LOOKUP_EVR(:epoch, :version, :release, (select at.label from rhnArchType at where at.id = pa.arch_type_id))", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTEyMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537599122", "bodyText": "changed to provide type as parameter. I did not rename the function as ISS is not really working with debian packages anyway.", "author": "mcalmer", "createdAt": "2020-12-07T15:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0MzA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjExOTA2MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536119060", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SELECT t.label into type from rhnpackagearch pa join rhnarchtype t\n          \n          \n            \n                    select t.label into type from rhnpackagearch pa join rhnarchtype t\n          \n      \n    \n    \n  \n\nNitpick: stay coherent with surroundings", "author": "moio", "createdAt": "2020-12-04T14:00:01Z", "path": "schema/spacewalk/postgres/procs/lookup_transaction_package.sql", "diffHunk": "@@ -40,13 +41,19 @@ begin\n     end if;\n \n     n_id := lookup_package_name(n_in);\n-    e_id := lookup_evr(e_in, v_in, r_in);\n     p_arch_id := null;\n \n     if a_in is not null then\n         p_arch_id := lookup_package_arch(a_in);\n+        SELECT t.label into type from rhnpackagearch pa join rhnarchtype t", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTQxNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537599416", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-07T15:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjExOTA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMzc1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536123758", "bodyText": "Noob question: is there any particular reason to prefer an ad-hoc method name to toString here?", "author": "moio", "createdAt": "2020-12-04T14:07:11Z", "path": "java/code/src/com/redhat/rhn/domain/rhnpackage/PackageType.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.domain.rhnpackage;\n+\n+public enum PackageType {\n+    RPM(\"rpm\"),\n+    DEB(\"deb\");\n+\n+    private final String dbString;\n+\n+    PackageType(String dbStringIn) {\n+        dbString = dbStringIn;\n+    }\n+\n+    public String getDbString() {", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA1NTIzMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r540055232", "bodyText": "Its a left over from when i made the db representation only 1 character to safe space. I dropped the idea later in favor of maybe going the posrgres enum route at a later point. In short the difference between normal toString and the dbString is that the former should be human readable for showing logs/debugging while the latter can be a more obscure encoding for efficiency reasons. In the current implementation they are very similar so its not obvious.", "author": "lucidd", "createdAt": "2020-12-10T10:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMzc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MTExMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536141112", "bodyText": "It'd be nice to have a test over ISS, ideally with a deb channel. Do we have a plan to at least try it out manually?", "author": "moio", "createdAt": "2020-12-04T14:32:45Z", "path": "backend/server/importlib/errataImport.py", "diffHunk": "@@ -117,13 +119,16 @@ def fix(self):\n                 if eft not in self.file_types:\n                     raise Exception(\"Unknown file type %s\" % eft)\n                 ef['type'] = self.file_types[eft]\n+        for label, aid in self.package_arches.items():\n+            self.package_type = self.backend.lookupPackageArchType(aid)", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0NzU0OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537547549", "bodyText": "ISS and debian is not working. This is known. So we cannot test it.\nA normal ISS test was planned, but I have touble with my test hardware.", "author": "mcalmer", "createdAt": "2020-12-07T14:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MTExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5NzMxMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543297311", "bodyText": "Update: test passed. Resolving conversation", "author": "moio", "createdAt": "2020-12-15T12:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE0MTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NjMxMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536166310", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Feat: Debian package comparator\n          \n          \n            \n            - Fix Debian package version comparison\n          \n      \n    \n    \n  \n\nI feel a text like the above reflects the change better from a user's perspective. Maybe we should even have a bug number? Surely it can't be presented as a feature, as the PR description says,  \"this is targeting the internal version comparator. Transparent for the final user\"", "author": "moio", "createdAt": "2020-12-04T15:08:49Z", "path": "backend/spacewalk-backend.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NjkyNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536166925", "bodyText": "See comment in backend/spacewalk-backend.changes", "author": "moio", "createdAt": "2020-12-04T15:09:38Z", "path": "java/spacewalk-java.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTY5Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537599693", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-07T15:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NjkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzAxNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536167017", "bodyText": "See comment in backend/spacewalk-backend.changes", "author": "moio", "createdAt": "2020-12-04T15:09:47Z", "path": "schema/spacewalk/susemanager-schema.changes", "diffHunk": "@@ -1,3 +1,4 @@\n+- Feat: Debian package comparator", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTgyMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537599821", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-07T15:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE2NzAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536170124", "bodyText": "Can we have this (very useful IMO!) script running as part of our Python unit testsuite?", "author": "moio", "createdAt": "2020-12-04T15:14:09Z", "path": "schema/util/debian-versioncmp-database-testgenerator.py", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/usr/bin/python3\n+\n+OUTPUT_SQL_SCRIPT_FILENAME = 'debian_version_database_comparator_tests.sql'\n+\n+preamble = \"\"\"\n+-- launch me with spacewalk-sql -i < {}\n+DO\n+$$\n+declare\n+\tresult NUMERIC := 0;\n+begin\n+\n+\"\"\".format(OUTPUT_SQL_SCRIPT_FILENAME)\n+\n+conclusion = \"\"\"\n+end;\n+$$\n+\"\"\"\n+\n+# source: https://git.dpkg.org/cgit/dpkg/dpkg.git/tree/scripts/t/Dpkg_Version.t\n+tests = \"\"\"1.0-1 2.0-2 -1\n+2.2~rc-4 2.2-1 -1\n+2.2-1 2.2~rc-4 1\n+1.0000-1 1.0-1 0\n+0foo 0foo 0\n+0foo-0 0foo 0\n+0foo 0foo-0 0\n+0foo 0fo 1\n+0foo-0 0foo+ -1\n+0foo~1 0foo -1\n+0foo~foo+Bar 0foo~foo+bar -1\n+0foo~~ 0foo~ -1\n+1~ 1 -1\n+12345+that-really-is-some-ver-0 12345+that-really-is-some-ver-10 -1\n+0foo-0 0foo-01 -1\n+0foo.bar 0foobar 1\n+0foo.bar 0foo1bar 1\n+0foo.bar 0foo0bar 1\n+0foo1bar-1 0foobar-1 -1\n+0foo2.0 0foo2 1\n+0foo2.0.0 0foo2.10.0 -1\n+0foo2.0 0foo2.0.0 -1\n+0foo2.0 0foo2.10 -1\n+0foo2.1 0foo2.10 -1\n+1.09 1.9 0\n+1.0.8+nmu1 1.0.8 1\n+3.11 3.10+nmu1 1\n+0.9j-20080306-4 0.9i-20070324-2 1\n+1.2.0~b7-1 1.2.0~b6-1 1\n+1.011-1 1.06-2 1\n+0.0.9+dfsg1-1 0.0.8+dfsg1-3 1\n+4.6.99+svn6582-1 4.6.99+svn6496-1 1\n+53 52 1\n+0.9.9~pre122-1 0.9.9~pre111-1 1\n+1.0.1+gpl-1 1.0.1-2 1\n+1a 1000a -1\"\"\"\n+\n+with open(OUTPUT_SQL_SCRIPT_FILENAME, 'w') as f:", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyOTc1Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r539529756", "bodyText": "I think it would be a good idea: let's drag @juliogonzalez in the conversation.\nJulio, we want to create a Jenkins job that executes this script and checks for failures. Should we create a card?", "author": "mbologna", "createdAt": "2020-12-09T18:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5ODgyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543298824", "bodyText": "I was suggesting to just add this to the current Python tests, without a new job.\nCan it be done in the context of this PR?", "author": "moio", "createdAt": "2020-12-15T12:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUzOTkxNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543539914", "bodyText": "This file has been removed because the test has been moved to JUnit (see below)", "author": "mbologna", "createdAt": "2020-12-15T17:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MDEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536180083", "bodyText": "Hmmm, I'm unsure about this one.\nAre you sure no queries remain that look for rows in this table by version+release only, or by version+release+epoch only?\nIf the answer is yes, then we might consider adding an index instead of changing existing indexes.\nOr we could use partial indexes.", "author": "moio", "createdAt": "2020-12-04T15:27:43Z", "path": "schema/spacewalk/postgres/tables/rhnPackageEVR_index.sql", "diffHunk": "@@ -14,9 +14,9 @@\n --\n \n create unique index rhn_pe_v_r_e_uq\n-    on rhnpackageevr (version, release, epoch)\n+    on rhnpackageevr (version, release, epoch, ((evr).type))\n  where epoch is not null;\n \n create unique index rhn_pe_v_r_uq\n-    on rhnpackageevr (version, release)\n+    on rhnpackageevr (version, release, ((evr).type))", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5MTE2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537591168", "bodyText": "Well, we talk about an unique index here. The index is only unique with the type.", "author": "mcalmer", "createdAt": "2020-12-07T15:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMTA1NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543301055", "bodyText": "Well, we talk about an unique index here. The index is only unique with the type.\n\nI am OK from the constraint perspective.\nStill the question remains: do we have any remaining query that addresses V+R or E+V+R without any type? How many of them are left, if any? In which contexts?\nReason is that this index will not help these queries any longer, so if any remain, they might see slowdowns.", "author": "moio", "createdAt": "2020-12-15T12:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxNjM1Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543516356", "bodyText": "I think we have no queries which just ask for only version and/or release.\nAll are going to the full EVR type which has now also type.", "author": "mcalmer", "createdAt": "2020-12-15T16:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MTc1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r544281758", "bodyText": "Then we should be fine", "author": "moio", "createdAt": "2020-12-16T13:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4MDA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDI2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536184269", "bodyText": "I am probably missing something, what does (evr). mean here?", "author": "moio", "createdAt": "2020-12-04T15:33:42Z", "path": "schema/spacewalk/postgres/procs/lookup_evr.sql", "diffHunk": "@@ -25,13 +25,14 @@ begin\n       from rhnPackageEVR\n      where ((epoch is null and e_in is null) or (epoch = e_in)) and\n            version = v_in and\n-           release = r_in;\n+           release = r_in and\n+           (evr).type = t_in;", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5MjY0MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537592640", "bodyText": "\"evr\" is the column of type evt_t . In the first iterations we added type only in this type and not as extra column.\nLater we found out that hibernate is not working with the type only. So we had to add a column there as well.", "author": "mcalmer", "createdAt": "2020-12-07T15:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDc1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536184758", "bodyText": "I am probably missing something, what does (evr). mean here?", "author": "moio", "createdAt": "2020-12-04T15:34:25Z", "path": "schema/spacewalk/postgres/procs/insert_evr.sql", "diffHunk": "@@ -10,14 +10,14 @@ begin\n     evr_id := nextval('rhn_pkg_evr_seq');\n \n     insert into rhnPackageEVR(id, epoch, version, release, evr)\n-        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in))\n+        values (evr_id, e_in, v_in, r_in, evr_t(e_in, v_in, r_in, t_in))\n         on conflict do nothing;\n \n     select id\n         into strict evr_id\n         from rhnPackageEVR\n         where ((epoch is null and e_in is null) or (epoch = e_in)) and\n-           version = v_in and release = r_in;\n+           version = v_in and release = r_in and (evr).type = t_in;", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5Mjk2Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537592967", "bodyText": "it is just another column", "author": "mcalmer", "createdAt": "2020-12-07T15:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE4NDc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536193350", "bodyText": "More code below refers to the ~ character which to my understanding is Debian only.\nhttps://fedoraproject.org/wiki/Archive:Tools/RPM/VersionComparison\nhttps://www.debian.org/doc/debian-policy/ch-controlfields.html#version\nI guess those should be fixed as well?\nI also see references to the caret symbol ^ and I cannot find docs about it anywhere. Please double check.", "author": "moio", "createdAt": "2020-12-04T15:46:50Z", "path": "schema/spacewalk/postgres/packages/rpm.pkb", "diffHunk": "@@ -69,38 +65,6 @@ $$ language 'plpgsql';\n         then\n             return 0;\n         end if;\n-        if POSITION('+' in str1) <> 0 AND POSITION('+' in str2) <> 0 AND POSITION('~' in str1) = 0 AND POSITION('~' in str2) = 0 AND POSITION('.module' in str1) = 0 AND POSITION('.module' in str2) = 0", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5MzgwNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537593806", "bodyText": "I think not. ~ and ^ are also used in rpm. In fact RPM stole them from debian.", "author": "mcalmer", "createdAt": "2020-12-07T15:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0MDc3NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r539540775", "bodyText": "'~' is allowed in package version for rpm:\nsusemanager=# select distinct(ch.name) from rhnpackage p inner join rhnpackageevr evr on p.evr_id = evr.id inner join rhnpackagename name on p.name_id = name.id inner join rhnchannelpackage c on p.id = c.package_id inner join rhnchannel ch on c.channel_id = ch.id where evr.version like '%~%' and ch.name like 'SLE%Server%';\n                            name                             \n-------------------------------------------------------------\n SLE-Module-Server-Applications15-SP1-Pool for x86_64\n SLE-Module-Server-Applications15-SP1-Pool for x86_64 SAP\n SLE-Module-Server-Applications15-SP1-Updates for x86_64\n SLE-Module-Server-Applications15-SP1-Updates for x86_64 SAP\n SLE-Module-Server-Applications15-SP2-Pool for x86_64\n SLE-Module-Server-Applications15-SP2-Updates for x86_64\n SLE-Module-Server-Applications15-Updates for x86_64\n(7 rows)", "author": "mbologna", "createdAt": "2020-12-09T18:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2NzcyMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r540167722", "bodyText": "Both ~ and ^ are valid in rpm versions and have special meaning for sorting. I know at least ~ is used but ^ was new to me and since my version parser checks for valid chars and i have not encountered any error on suse repos so far i guess that means its not widely used.", "author": "lucidd", "createdAt": "2020-12-10T13:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNDk5OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543304999", "bodyText": "OK, I learnt something new again.\n@lucidd you might be aware of this data set: it contains a huge amount of versions in the correct order. It can be used to check a version comparison algorithm for correctness. HTH", "author": "moio", "createdAt": "2020-12-15T12:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5MzM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NDY2MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536194660", "bodyText": "It would be nice to add comments pointing to URLs defining the standard and/or existing implementations of the algorithm to check against.", "author": "moio", "createdAt": "2020-12-04T15:48:42Z", "path": "schema/spacewalk/postgres/packages/deb.pkb", "diffHunk": "@@ -0,0 +1,185 @@\n+-- oracle equivalent source sha1 539cb03eb177b7e87992701071488bbb32bb0624\n+create schema deb;\n+\n+--update pg_setting\n+update pg_settings set setting = 'deb,' || setting where name = 'search_path';\n+\n+CREATE OR REPLACE FUNCTION lastIndexOf(needle text, haystack text)\n+RETURNS integer AS $$\n+    DECLARE\n+        rc INTEGER;\n+    BEGIN\n+     rc := length(haystack) - position(needle in reverse(haystack));\n+     if rc = length(haystack) then rc = -1; end if;\n+     return rc;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace function isdigit(ch CHAR)\n+    RETURNS BOOLEAN as $$\n+    BEGIN\n+        if ascii(ch) between ascii('0') and ascii('9')\n+        then\n+            return TRUE;\n+        end if;\n+        return FALSE;\n+    END ;\n+$$ language 'plpgsql';\n+\n+\n+create or replace FUNCTION isalpha(ch CHAR)\n+    RETURNS BOOLEAN as $$\n+    BEGIN\n+        if ascii(ch) between ascii('a') and ascii('z') or\n+            ascii(ch) between ascii('A') and ascii('Z')\n+        then\n+            return TRUE;\n+        end if;\n+        return FALSE;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION charAt(str IN VARCHAR, pos IN INTEGER)\n+    RETURNS CHARACTER as $$\n+    BEGIN\n+        return SUBSTR(str, pos + 1, 1);\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace function deborder(c INTEGER)\n+    RETURNS INTEGER as $$\n+    BEGIN\n+        if deb.isdigit(chr(c)) then return 0; end if;\n+        if deb.isalpha(chr(c)) then return c; end if;\n+        if c = ascii('~') then return -1; end if;\n+        if c != 0 then return c + 256; end if;\n+        return 0;\n+    END ;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION verrevcmp(a1 IN VARCHAR, b1 IN VARCHAR)\n+    RETURNS INTEGER as $$\n+    DECLARE\n+        a VARCHAR;\n+        b VARCHAR;\n+        i INTEGER := 0;\n+        j INTEGER := 0;\n+    BEGIN\n+        IF a1 IS NULL then a := ''; end if;\n+        IF b1 IS NULL then b := ''; end if;\n+        a := a1;\n+        b := b1;\n+        WHILE (i < LENGTH(a)) or (j < LENGTH(b))\n+        LOOP\n+            DECLARE\n+                firstDiff INTEGER := 0;\n+            BEGIN\n+                while ((i < LENGTH(a)) and not deb.isdigit(deb.charAt(a,i))) or ((j < LENGTH(b)) and not deb.isdigit(deb.charAt(b,j)))\n+                LOOP\n+                DECLARE\n+                    ac INTEGER;\n+                    bc INTEGER;\n+                BEGIN\n+                    if i >= length(a)\n+                    then\n+                        ac := 0;\n+                    else\n+                        ac := deb.deborder(ascii(deb.charAt(a, i)));\n+                    end if;\n+                    if j >= length(b)\n+                    then\n+                        bc := 0;\n+                    else\n+                        bc := deb.deborder(ascii(deb.charAt(b, j)));\n+                    end if;\n+                    if ac != bc then return ac-bc; end if;\n+                    i := i + 1;\n+                    j := j + 1;\n+                END;\n+                END LOOP;\n+                while (i < length(a)) and (deb.charAt(a, i) = '0')\n+                LOOP\n+                    i := i + 1;\n+                END LOOP;\n+                while (j < length(b)) and (deb.charAt(b, j) = '0')\n+                LOOP\n+                    j := j + 1;\n+                END LOOP;\n+                WHILE (i < LENGTH(a)) and (j < LENGTH(b)) and (deb.isdigit(deb.charAt(a,i))) and (deb.isdigit(deb.charAt(b, j)))\n+                LOOP\n+                    if firstDiff = 0 then firstDiff := ascii(deb.charAt(a, i)) - ascii(deb.charAt(b, j)); end if;\n+                    i := i + 1;\n+                    j := j + 1;\n+                END LOOP;\n+                IF (i < LENGTH(a)) and (deb.isdigit(deb.charAt(a,i))) then return 1; end if;\n+                IF (j < LENGTH(b)) and (deb.isdigit(deb.charAt(b,j))) then return -1; end if;\n+                IF firstDiff != 0 then return firstDiff; end if;\n+            END;\n+        END LOOP;\n+        RETURN 0;\n+    END;\n+$$ language 'plpgsql';\n+\n+create or replace FUNCTION debstrcmp (o1 IN VARCHAR, o2 IN VARCHAR)", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0NjMzNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r539546336", "bodyText": "Fixed", "author": "mbologna", "createdAt": "2020-12-09T18:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NDY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NTUyNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536195526", "bodyText": "What would be pros/cons of using EXCEPTION here?", "author": "moio", "createdAt": "2020-12-04T15:49:53Z", "path": "schema/spacewalk/postgres/class/evr_t.sql", "diffHunk": "@@ -7,27 +7,43 @@\n -- FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n -- along with this software; if not, see\n -- http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n--- \n+--\n -- Red Hat trademarks are not licensed under GPLv2. No permission is\n -- granted to use or replicate Red Hat trademarks that are incorporated\n--- in this software or its documentation. \n+-- in this software or its documentation.\n --\n \n create type evr_t as (\n         epoch           varchar(16),\n         version         varchar(512),\n-        release         varchar(512)\n+        release         varchar(512),\n+        type            varchar(10)\n );\n \n-create or replace function evr_t(e varchar, v varchar, r varchar)\n+create or replace function evr_t(e varchar, v varchar, r varchar, t varchar)\n returns evr_t as $$\n-select row($1,$2,$3)::evr_t\n+select row($1,$2,$3,$4)::evr_t\n $$ language sql;\n \n create or replace function evr_t_compare( a evr_t, b evr_t )\n returns int as $$\n begin\n-  return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+  if a.type = b.type then\n+      if a.type = 'rpm' then\n+        return rpm.vercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      elsif a.type = 'deb' then\n+        return deb.debvercmp(a.epoch, a.version, a.release, b.epoch, b.version, b.release);\n+      else\n+        raise EXCEPTION 'unknown evr type (using rpm) -> %', a.type;\n+      end if;\n+  else\n+     raise NOTICE 'comparing incompatible evr types. Using %', a.type;", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NTU0OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537595548", "bodyText": "We tried with an exception, but when the DB run ANALYSE it calls the comperator with all rows in the table.\nThe result was, that ANALYSE failed as there were exceptions thrown.", "author": "mcalmer", "createdAt": "2020-12-07T15:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NTUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NzE3OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536197179", "bodyText": "What would be the pros/cons of not having this generated column?", "author": "moio", "createdAt": "2020-12-04T15:52:06Z", "path": "schema/spacewalk/common/tables/rhnPackageEVR.sql", "diffHunk": "@@ -21,7 +21,8 @@ CREATE TABLE rhnPackageEVR\n     epoch    VARCHAR(16),\n     version  VARCHAR(512) NOT NULL,\n     release  VARCHAR(512) NOT NULL,\n-    evr      EVR_T NOT NULL\n+    evr      EVR_T NOT NULL,\n+    type     varchar(10) generated always as ((evr).type) stored", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NjgzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r537596833", "bodyText": "evr is required to write compare operators for the database.\nHibernate cannot work with self created types. For this we need them as plain columns.", "author": "mcalmer", "createdAt": "2020-12-07T15:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NzE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwODEyOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543308128", "bodyText": "I always wonder whether creating a custom type was actually ever worth the trouble.\nIn any case, no discussion to be made now.", "author": "moio", "createdAt": "2020-12-15T12:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5NzE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE5ODcxNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r536198717", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            create schema deb;\n          \n          \n            \n            create schema if not exists deb;\n          \n      \n    \n    \n  \n\nNitpick: does not hurt to have this file identical to schema/spacewalk/upgrade/susemanager-schema-4.2.2-to-susemanager-schema-4.2.3/701-rpm.pkb.sql", "author": "moio", "createdAt": "2020-12-04T15:54:08Z", "path": "schema/spacewalk/postgres/packages/deb.pkb", "diffHunk": "@@ -0,0 +1,185 @@\n+-- oracle equivalent source sha1 539cb03eb177b7e87992701071488bbb32bb0624\n+create schema deb;", "originalCommit": "72d561e27e22e40a522e5b4838903a28e909f03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e2462b2016ece0db831c4816fdd72d4de0e97ec", "url": "https://github.com/uyuni-project/uyuni/commit/0e2462b2016ece0db831c4816fdd72d4de0e97ec", "message": "cleanup code and todos", "committedDate": "2020-12-07T15:48:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNjc4NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543326785", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @version $Rev$", "author": "moio", "createdAt": "2020-12-15T13:08:49Z", "path": "java/code/src/com/redhat/rhn/common/util/DebVersionComparator.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util;\n+\n+import java.util.Comparator;\n+\n+/**\n+ * DebVersionComparator\n+ * @version $Rev$", "originalCommit": "7cd0b4bbc31863ec140305581e3f75643c2e7055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMDY3Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543510677", "bodyText": "changed", "author": "mcalmer", "createdAt": "2020-12-15T16:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNjc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMzMDM0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543330343", "bodyText": "Could we re-use data in this method to also check the stored procedure implementation of the algorithm?\nOne way to do it could be to create a List of those versions and then sorting it with the Comparator, and inspecting the sorted result.", "author": "moio", "createdAt": "2020-12-15T13:14:05Z", "path": "java/code/src/com/redhat/rhn/common/util/test/DebVersionComparatorTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.common.util.test;\n+\n+import com.redhat.rhn.common.util.DebVersionComparator;\n+\n+import junit.framework.TestCase;\n+\n+/**\n+ * DebVersionComparatorTest\n+ */\n+public class DebVersionComparatorTest extends TestCase {\n+\n+    private DebVersionComparator cmp;\n+\n+    protected void setUp() throws Exception {\n+        super.setUp();\n+        cmp = new DebVersionComparator();\n+    }\n+\n+    protected void tearDown() throws Exception {\n+        cmp = null;\n+        super.tearDown();\n+    }\n+\n+    public void testDpkgTestCases() {", "originalCommit": "7cd0b4bbc31863ec140305581e3f75643c2e7055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU0MTgzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r543541839", "bodyText": "This made me think and with your suggestions we moved the database tests into JUnit!\nSo we have now one single point to test the versions: Java (for Debian, and for RPM - as a bonus track - too!)", "author": "mbologna", "createdAt": "2020-12-15T17:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMzMDM0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE0MDM2MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r544140360", "bodyText": "Nitpick: if these queries are only used for testing, they could be added to the test_queries.xml file", "author": "moio", "createdAt": "2020-12-16T09:25:20Z", "path": "java/code/src/com/redhat/rhn/common/db/datasource/xml/PackageEvr_queries.xml", "diffHunk": "@@ -0,0 +1,13 @@\n+<datasource_modes>", "originalCommit": "845cf71d2929f388f0b007a13025e1603d422080", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE2MDQwMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2767#discussion_r544160403", "bodyText": "Fixed", "author": "mbologna", "createdAt": "2020-12-16T09:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE0MDM2MA=="}], "type": "inlineReview"}, {"oid": "8e8021c163658f7595da5fbad66962c29025ae90", "url": "https://github.com/uyuni-project/uyuni/commit/8e8021c163658f7595da5fbad66962c29025ae90", "message": "bits and pieces", "committedDate": "2020-12-16T13:08:52Z", "type": "commit"}, {"oid": "ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "url": "https://github.com/uyuni-project/uyuni/commit/ef9a51cfa9c8e77abf9fdcdf69c0bfa39ee8e20c", "message": "Refactor: move mode queries to test queries", "committedDate": "2020-12-16T13:09:30Z", "type": "forcePushed"}, {"oid": "172c90f096b44a966be1714619ce67e48774f6cc", "url": "https://github.com/uyuni-project/uyuni/commit/172c90f096b44a966be1714619ce67e48774f6cc", "message": "Feat: Debian package version comparator - Java", "committedDate": "2020-12-16T13:20:12Z", "type": "commit"}, {"oid": "98f0452c7a690580a425ac4e1cc74c08e6d62e56", "url": "https://github.com/uyuni-project/uyuni/commit/98f0452c7a690580a425ac4e1cc74c08e6d62e56", "message": "Test: refactor tests for Debian vercmp - Java", "committedDate": "2020-12-16T13:20:14Z", "type": "commit"}, {"oid": "93a6e16b737eb5e6a60e53ae3dd38ab102fe7ade", "url": "https://github.com/uyuni-project/uyuni/commit/93a6e16b737eb5e6a60e53ae3dd38ab102fe7ade", "message": "Refactor: restore RPM version cmp pre-Debian - Java\n\nReference commit id: 74c79db537c7762360d3675b280c2257d71cb698", "committedDate": "2020-12-16T13:20:14Z", "type": "commit"}, {"oid": "3eb13c0bbacfc3d4afc4e91c58cd0b4abdee4c72", "url": "https://github.com/uyuni-project/uyuni/commit/3eb13c0bbacfc3d4afc4e91c58cd0b4abdee4c72", "message": "Feat: Debian package version comparator - PL/pgSQL", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "405381c1c17b6c7b3b7c3262e04f0556a7f994c4", "url": "https://github.com/uyuni-project/uyuni/commit/405381c1c17b6c7b3b7c3262e04f0556a7f994c4", "message": "Test: generator for Debian vercmp - PL/pgSQL", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "7c93ea7054b8c1791101ff456c02e107ae184c40", "url": "https://github.com/uyuni-project/uyuni/commit/7c93ea7054b8c1791101ff456c02e107ae184c40", "message": "Refactor: restore RPM version cmp pre-Debian cmp - PL/pgSQL\n\nReference commit id: e133ffeeb303b6a757dda9f5561e6d329e077ad3", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "c4bc1492d457a7c0bdb89582d77927da32c7bfe3", "url": "https://github.com/uyuni-project/uyuni/commit/c4bc1492d457a7c0bdb89582d77927da32c7bfe3", "message": "Feat: migration scripts - PL/pgSQL", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "cc27e84073ea9f8f7b0b645f0e94d6bf887dedb6", "url": "https://github.com/uyuni-project/uyuni/commit/cc27e84073ea9f8f7b0b645f0e94d6bf887dedb6", "message": "Feat: call Debian versioncmp in dispatcher", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "e5405536994bd4a4a6bedb39641102286ee9782f", "url": "https://github.com/uyuni-project/uyuni/commit/e5405536994bd4a4a6bedb39641102286ee9782f", "message": "cleanup unused code", "committedDate": "2020-12-16T13:20:15Z", "type": "commit"}, {"oid": "2f7f3fe5e4f4c5b99b99ff886fd5e63d8cd65a22", "url": "https://github.com/uyuni-project/uyuni/commit/2f7f3fe5e4f4c5b99b99ff886fd5e63d8cd65a22", "message": "add type to evr", "committedDate": "2020-12-16T13:20:50Z", "type": "commit"}, {"oid": "5d3e9d4e97a8bd7931124049bf6ebc0ff6b2d4dd", "url": "https://github.com/uyuni-project/uyuni/commit/5d3e9d4e97a8bd7931124049bf6ebc0ff6b2d4dd", "message": "import packages with evr package type", "committedDate": "2020-12-16T13:20:52Z", "type": "commit"}, {"oid": "20452be5c5965e619b82dc6fbb862f72046bd91f", "url": "https://github.com/uyuni-project/uyuni/commit/20452be5c5965e619b82dc6fbb862f72046bd91f", "message": "use new EVR lookup function", "committedDate": "2020-12-16T13:20:52Z", "type": "commit"}, {"oid": "6f3bbe29e0f01047f32a8e0ac136b58f206d3aef", "url": "https://github.com/uyuni-project/uyuni/commit/6f3bbe29e0f01047f32a8e0ac136b58f206d3aef", "message": "add potential solution for type dubpication", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "4355bd4aaea0ca584e73c648d47aaca5604a4879", "url": "https://github.com/uyuni-project/uyuni/commit/4355bd4aaea0ca584e73c648d47aaca5604a4879", "message": "dispatch compare based on packageevr type", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "5f76e1cbc5f7b2739912bff5eba480552037530b", "url": "https://github.com/uyuni-project/uyuni/commit/5f76e1cbc5f7b2739912bff5eba480552037530b", "message": "Fix: add call to Debian version comparator in dispatcher", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "d5a7593b29d7d847441210407c10183a114ff4a6", "url": "https://github.com/uyuni-project/uyuni/commit/d5a7593b29d7d847441210407c10183a114ff4a6", "message": "remove references to rpm.vercmp in queries", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "bfab1827bceb955763246772eefdb432a99e0858", "url": "https://github.com/uyuni-project/uyuni/commit/bfab1827bceb955763246772eefdb432a99e0858", "message": "type errors should be reported as exceptions", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "7f77b09179bcf01655e71e3b683c5a57cff287c4", "url": "https://github.com/uyuni-project/uyuni/commit/7f77b09179bcf01655e71e3b683c5a57cff287c4", "message": "limit compare to same EVR types", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "3614cbf96e3e5bedf1242877f2389f137844164d", "url": "https://github.com/uyuni-project/uyuni/commit/3614cbf96e3e5bedf1242877f2389f137844164d", "message": "java: limit compare to same EVR types", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "7ee5686792453e11b66c056a07c17aab7da14e6d", "url": "https://github.com/uyuni-project/uyuni/commit/7ee5686792453e11b66c056a07c17aab7da14e6d", "message": "declare operator <>", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "538ad4ca9271aeecf1aa268da2078d3c0c86b0d6", "url": "https://github.com/uyuni-project/uyuni/commit/538ad4ca9271aeecf1aa268da2078d3c0c86b0d6", "message": "change deb/rpm comparison", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "c3d652536caaa48191717aa76351a6c5ab11de13", "url": "https://github.com/uyuni-project/uyuni/commit/c3d652536caaa48191717aa76351a6c5ab11de13", "message": "Chore: announce changes", "committedDate": "2020-12-16T13:20:53Z", "type": "commit"}, {"oid": "d5a4c00cf5e1a747a50fea04dbb40d78d4ce41cb", "url": "https://github.com/uyuni-project/uyuni/commit/d5a4c00cf5e1a747a50fea04dbb40d78d4ce41cb", "message": "renmae lookup_evr2 back to lookup_evr", "committedDate": "2020-12-16T13:21:19Z", "type": "commit"}, {"oid": "f28998f96a70c9a01f0ef9a4a44e31ba9eb1e369", "url": "https://github.com/uyuni-project/uyuni/commit/f28998f96a70c9a01f0ef9a4a44e31ba9eb1e369", "message": "use standard EVR parser for unit tests", "committedDate": "2020-12-16T13:21:21Z", "type": "commit"}, {"oid": "0d2b87e1176ecf5476974267db3c429f3005d879", "url": "https://github.com/uyuni-project/uyuni/commit/0d2b87e1176ecf5476974267db3c429f3005d879", "message": "remove evr field in PackageStateJson", "committedDate": "2020-12-16T13:21:21Z", "type": "commit"}, {"oid": "53497c8c75fb137caaa9b3b0b4cc7033d5e188f2", "url": "https://github.com/uyuni-project/uyuni/commit/53497c8c75fb137caaa9b3b0b4cc7033d5e188f2", "message": "move PackageUtilsTest tests to fitting location", "committedDate": "2020-12-16T13:21:21Z", "type": "commit"}, {"oid": "c0298ad9f74b1d0b4c5c884876dfc3a79f606ce8", "url": "https://github.com/uyuni-project/uyuni/commit/c0298ad9f74b1d0b4c5c884876dfc3a79f606ce8", "message": "reorder migration scripts", "committedDate": "2020-12-16T13:21:21Z", "type": "commit"}, {"oid": "2922c9eba38e9b1ca33867cb872d82e3d514f0b9", "url": "https://github.com/uyuni-project/uyuni/commit/2922c9eba38e9b1ca33867cb872d82e3d514f0b9", "message": "cleanup code and todos", "committedDate": "2020-12-16T13:21:54Z", "type": "commit"}, {"oid": "07a9cb7058c605b89c14c7e4522baa3b1962e88f", "url": "https://github.com/uyuni-project/uyuni/commit/07a9cb7058c605b89c14c7e4522baa3b1962e88f", "message": "Refactor: Debian package version comparator Tests", "committedDate": "2020-12-16T13:25:37Z", "type": "commit"}, {"oid": "07a9cb7058c605b89c14c7e4522baa3b1962e88f", "url": "https://github.com/uyuni-project/uyuni/commit/07a9cb7058c605b89c14c7e4522baa3b1962e88f", "message": "Refactor: Debian package version comparator Tests", "committedDate": "2020-12-16T13:25:37Z", "type": "forcePushed"}]}