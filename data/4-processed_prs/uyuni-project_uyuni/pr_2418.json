{"pr_number": 2418, "pr_title": "Warn user when multiple group formulas are active", "pr_createdAt": "2020-07-15T13:39:54Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2418", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4ODM0NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455088345", "bodyText": "All messages should be localized like below:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    'Multiple Group formulas detected. Only one formula for \"'\n          \n          \n            \n                                        + capitalize(data.formula_name) + '\" can be used on each system!'\n          \n          \n            \n                                    t('Multiple Group formulas detected. Only one formula for \"{0}\" can be used on each system!', capitalize(data.formula_name))", "author": "cbbayburt", "createdAt": "2020-07-15T14:19:25Z", "path": "web/html/src/components/FormulaForm.js", "diffHunk": "@@ -73,6 +73,12 @@ class FormulaForm extends React.Component {\n                     metadata: {}\n                 });\n             else {\n+                if (data.formula_list.filter(formula => formula == data.formula_name).length > 1) {\n+                    this.state.errors.push(\n+                        'Multiple Group formulas detected. Only one formula for \"'\n+                            + capitalize(data.formula_name) + '\" can be used on each system!'", "originalCommit": "91e27f9dab7b5164e12f5a867fbb72fe0418b4f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0MzQ1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455143458", "bodyText": "Forgot about localization \ud83d\ude48, thanks!", "author": "agraul", "createdAt": "2020-07-15T15:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4ODM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455187110", "bodyText": "It is more like a question than a request for a fix: is this a real error the user should take some action to fix and we want to stop him, or is it just a warning message about something that can go wrong but unknown?", "author": "ncounter", "createdAt": "2020-07-15T16:43:57Z", "path": "web/html/src/components/FormulaForm.js", "diffHunk": "@@ -73,6 +73,11 @@ class FormulaForm extends React.Component {\n                     metadata: {}\n                 });\n             else {\n+                if (data.formula_list.filter(formula => formula == data.formula_name).length > 1) {\n+                    this.state.errors.push(", "originalCommit": "763b30ba3c293e7437428f5639f6c19d2b860aeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxMzE0Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455213142", "bodyText": "In current situation I consider it as an error. Merging data from multiple groups is silently disabled at the moment (see uyuni/suma_minion.py#L155 ), and furthermore there is not a stable way to tell what group formula will \"win\" and be loaded.\nHowever there is an exception for cluster-formula, @mbologna ?", "author": "aaannz", "createdAt": "2020-07-15T17:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0MDY4Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455240682", "bodyText": "Right, there is an exception for that. We need to change the condition to allow multiple cluster formulas.", "author": "agraul", "createdAt": "2020-07-15T18:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM1NzY5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455357697", "bodyText": "Great, thanks for the clarification. It's clearer to me. \ud83d\udc4d\n(Based on the fact I knowing pretty much nothing about the issue itself in detail, I will leave here just a suggestion but feel free to ignore if not relevant/needed). As it is an error that needs to be fixed in order to continue, I'd enhance a little bit more the message text with an additional sentence about what should be done by the user explicitly. I mean something like Please make sure to remove all but one \"Bind\" formula assigned to this system in order to...............", "author": "ncounter", "createdAt": "2020-07-15T21:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYzMTQ4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455631480", "bodyText": "@ncounter the user does not need to disable any formula, we just ignore all but the first when we build the pillar data. The context of this change is that we have a user (SUMA customer) that expects that all group formulas are taken into account. Since I couldn't easily add those capabilities (prioritization when keys conflict and an unified UI that shows the merged data), we instead decided to make the current situation visible to the user.\nIf this should be a warning or error is something I am not 100% sure though. For me either would be fine, but I want to be in line with the rest of Uyuni.", "author": "agraul", "createdAt": "2020-07-16T08:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3MTgwNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455671805", "bodyText": "I see. So generally speaking it should be:\na) warning = continue = working, but keep in mind = hey Mr.Customer, be aware of this behavior you may do not expect it. The product will continue to work, but will do something like this instead of that\nb) error = stop = not working = hey Mr.Customer, there is an error. You cannot continue until you fix this that and that\nand from your description it is 100% a warning. Okay that we will ignore other formulas, but we still let the feature go on and complete. It's not a problem that we don't have\nI'd rather use a warning message then, clarifying also the expected behavior: Multiple Group formulas detected. Only one formula for \"Bind\" can be used on each system! The first \"Bind\" formula will be used, others will be ignored..", "author": "ncounter", "createdAt": "2020-07-16T10:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3NjE1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455676158", "bodyText": "Okay, that makes sense. Thanks!", "author": "agraul", "createdAt": "2020-07-16T10:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NzA5Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455687093", "bodyText": "Are we sure we know what \"first\" formula is? From what I remember we don't sort group list and do not operate on ordered list. So is it first group assigned? Or is it first group alphabetically?\nWhen I look in retail terminal group membership I see:\n# cat pillar_sbranch1.Intel-Genuine-c557_group_memberships.yml\naddon_group_types:\n- salt_entitled\ngroup_ids:\n- 11\n- 9\n- 12\n\nWhere this machine was first assigned to group 11, then 12 and last 9. If I had the same formula for each group. Which one would be \"the first\"?", "author": "aaannz", "createdAt": "2020-07-16T10:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0NjY3OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455746679", "bodyText": "In current situation I consider it as an error. Merging data from multiple groups is silently disabled at the moment (see uyuni/suma_minion.py#L155 ), and furthermore there is not a stable way to tell what group formula will \"win\" and be loaded.\nHowever there is an exception for cluster-formula, @mbologna ?\n\nYes, that is correct: caasp-management-settings-formula has the type of cluster-formula", "author": "mbologna", "createdAt": "2020-07-16T12:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0OTM2Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2418#discussion_r455749366", "bodyText": "You are right  @aaannz, I would not put \"first\" either. Which group is parsed first is not really intuitive. In your case it would be group 11. Below is my observation:\nI just created three groups (1-3) on a fresh SUMA  4.1 Server. I added the groups in to a Client in the order 3, 2, 1 and then added bind formulas to 1, then to 2 and lastly to 3. In the end, the minion shows three \"Bind\" formulas, all with the data from 2. This is aligned with the order in pillar_minion-1.tf.local_group_memberships.yml, but not what a user would expect.\nI did not look into where the order is decided, why I the 2 group is the first in the yaml and if that process is deterministic. The \"good thing\" is that all formulas on /rhn/manager/systems/details/formula/ show the same content, so at least the user can see what is going to be applied.\nSo I think it is good enough to tell the user that multiple formulas are not taken into account. I don't think we have the correct group id easily available in the FormulaForm.js to show it.", "author": "agraul", "createdAt": "2020-07-16T12:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzExMA=="}], "type": "inlineReview"}, {"oid": "0ee57f6bdc84a701b731af0d1a60aeef632d1f74", "url": "https://github.com/uyuni-project/uyuni/commit/0ee57f6bdc84a701b731af0d1a60aeef632d1f74", "message": "Add changelog entry", "committedDate": "2020-07-27T09:58:55Z", "type": "forcePushed"}, {"oid": "34fbfc36264c2239e98924222e36d0725ab1b52b", "url": "https://github.com/uyuni-project/uyuni/commit/34fbfc36264c2239e98924222e36d0725ab1b52b", "message": "Add warning for multiple group formulas\n\nMultiple group formulas are not supported at this time. Only the formula\nfrom the group that is processed first is used.\n\nFixes https://github.com/SUSE/spacewalk/issues/11850\n\nCo-authored-by: Can Bulut Bayburt <1103552+cbbayburt@users.noreply.github.com>", "committedDate": "2020-07-27T10:14:06Z", "type": "commit"}, {"oid": "34fbfc36264c2239e98924222e36d0725ab1b52b", "url": "https://github.com/uyuni-project/uyuni/commit/34fbfc36264c2239e98924222e36d0725ab1b52b", "message": "Add warning for multiple group formulas\n\nMultiple group formulas are not supported at this time. Only the formula\nfrom the group that is processed first is used.\n\nFixes https://github.com/SUSE/spacewalk/issues/11850\n\nCo-authored-by: Can Bulut Bayburt <1103552+cbbayburt@users.noreply.github.com>", "committedDate": "2020-07-27T10:14:06Z", "type": "forcePushed"}]}