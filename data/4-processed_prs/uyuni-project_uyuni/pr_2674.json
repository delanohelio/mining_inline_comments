{"pr_number": 2674, "pr_title": "powermanagement xmlrpc api", "pr_createdAt": "2020-09-30T15:07:15Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2674", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4NjIzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498286239", "bodyText": "like discussed in the chat i think its a good idea to split it up into multiple functions each doing one thing", "author": "lucidd", "createdAt": "2020-10-01T14:25:31Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");\n+        return 1;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, String nameIn, String action) {", "originalCommit": "58300e734188dfc8374dba7c67ac032e4de62161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMjA4OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r499612088", "bodyText": "done", "author": "mcalmer", "createdAt": "2020-10-05T13:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4NjIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4OTc1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498289753", "bodyText": "in case doPowerManagement is split up this function would not be needed i guess.", "author": "lucidd", "createdAt": "2020-10-01T14:30:05Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {", "originalCommit": "58300e734188dfc8374dba7c67ac032e4de62161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMjI4OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r499612288", "bodyText": "yes, done", "author": "mcalmer", "createdAt": "2020-10-05T13:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4OTc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5MjA5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498292097", "bodyText": "its using PowerOn in all 3 cases right now. Same as above.", "author": "lucidd", "createdAt": "2020-10-01T14:33:09Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");\n+        return 1;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, String nameIn, String action) {\n+        ensureOrgAdmin(loggedInUser);\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();", "originalCommit": "58300e734188dfc8374dba7c67ac032e4de62161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5NDM3Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498294372", "bodyText": "Ups :-)", "author": "mcalmer", "createdAt": "2020-10-01T14:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5MjA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzODgxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498338818", "bodyText": "executePowerManagementAction?", "author": "mbologna", "createdAt": "2020-10-01T15:35:51Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...", "originalCommit": "c41ca2f1779b065a4be5f11e50dc36d9748d83e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMjU4Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r499612587", "bodyText": "I made single functions out of it.", "author": "mcalmer", "createdAt": "2020-10-05T13:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzODgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0MDQ2MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498340461", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\"Power management action \" + action + \"failed\");\n          \n          \n            \n                        log.error(\"Power management action \" + action + \" failed\");", "author": "mbologna", "createdAt": "2020-10-01T15:38:10Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOff).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.Reboot).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");\n+        return 1;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, String nameIn, String action) {\n+        ensureOrgAdmin(loggedInUser);\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");", "originalCommit": "c41ca2f1779b065a4be5f11e50dc36d9748d83e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0MDYyOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498340629", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.info(\"Power management action \" + action + \"succeeded\");\n          \n          \n            \n                    log.info(\"Power management action \" + action + \" succeeded\");", "author": "mbologna", "createdAt": "2020-10-01T15:38:23Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOff).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.Reboot).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");\n+        return 1;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, String nameIn, String action) {\n+        ensureOrgAdmin(loggedInUser);\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, nameIn,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");", "originalCommit": "c41ca2f1779b065a4be5f11e50dc36d9748d83e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0MDg2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498340868", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\"Power management action \" + action + \"failed\");\n          \n          \n            \n                        log.error(\"Power management action \" + action + \" failed\");", "author": "mbologna", "createdAt": "2020-10-01T15:38:41Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOff).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.Reboot).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");", "originalCommit": "c41ca2f1779b065a4be5f11e50dc36d9748d83e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0MTAzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r498341033", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    log.info(\"Power management action \" + action + \"succeeded\");\n          \n          \n            \n                    log.info(\"Power management action \" + action + \" succeeded\");", "author": "mbologna", "createdAt": "2020-10-01T15:38:56Z", "path": "java/code/src/com/redhat/rhn/frontend/xmlrpc/system/provisioning/powermanagement/PowerManagementHandler.java", "diffHunk": "@@ -0,0 +1,403 @@\n+/**\n+ * Copyright (c) 2020 SUSE LLC\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package com.redhat.rhn.frontend.xmlrpc.system.provisioning.powermanagement;\n+\n+import com.redhat.rhn.common.conf.ConfigDefaults;\n+import com.redhat.rhn.common.hibernate.LookupException;\n+import com.redhat.rhn.common.validator.ValidatorError;\n+import com.redhat.rhn.domain.server.Server;\n+import com.redhat.rhn.domain.user.User;\n+import com.redhat.rhn.frontend.action.kickstart.PowerManagementAction;\n+import com.redhat.rhn.frontend.xmlrpc.BaseHandler;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidArgsException;\n+import com.redhat.rhn.frontend.xmlrpc.InvalidParameterException;\n+import com.redhat.rhn.frontend.xmlrpc.NoSuchSystemException;\n+import com.redhat.rhn.frontend.xmlrpc.PowerManagementOperationFailedException;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerUnregisteredPowerSettingsUpdateCommand;\n+import com.redhat.rhn.manager.kickstart.cobbler.CobblerXMLRPCHelper;\n+import com.redhat.rhn.manager.system.SystemManager;\n+\n+import org.apache.log4j.Logger;\n+import org.cobbler.SystemRecord;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * PowerManagementHandler\n+ * @xmlrpc.namespace system.provisioning.powermanagement\n+ * @xmlrpc.doc Provides methods to access and modify power management for systems.\n+ * Some functions exist in 2 variants. Either with server id or with a name.\n+ * The function with server id is useful when a system exists with a full profile.\n+ * Everybody allowed to manage that system can execute these functions.\n+ * The variant with name expects a cobbler system name prefix. These functions\n+ * enhance the name by adding the org id of the user to limit access to systems\n+ * from the own organization. Additionally Org Admin permissions are required to\n+ * call these functions.\n+ */\n+public class PowerManagementHandler extends BaseHandler {\n+    private static Logger log = Logger.getLogger(PowerManagementHandler.class);\n+\n+    /**\n+     * Return a list of available power management types\n+     *\n+     * @param loggedInUser the user\n+     * @return a list of available power management types\n+     *\n+     * @xmlrpc.doc Return a list of available power management types\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management types\")\n+     */\n+    public List<String> listTypes(User loggedInUser) {\n+        String typeString = ConfigDefaults.get().getCobblerPowerTypes();\n+        if (typeString != null) {\n+            return Arrays.asList(typeString.split(\" *, *\"));\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, Integer serverId) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        SystemRecord record = SystemRecord.lookupById(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), server.getCobblerId());\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    /**\n+     * Get current power management settings of the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.returntype\n+     *  #struct_begin(\"powerManagementParameters\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     */\n+    public Map<String, String> getDetails(User loggedInUser, String nameIn) {\n+        ensureOrgAdmin(loggedInUser);\n+        SystemRecord record = lookupExistingCobblerRecord(loggedInUser, nameIn);\n+        return getDetails(loggedInUser, record);\n+    }\n+\n+    private Map<String, String> getDetails(User loggedInUser, SystemRecord record) {\n+        Map<String, String> result = new HashMap<>();\n+        List<String> types = listTypes(loggedInUser);\n+        if (record == null) {\n+            result.put(PowerManagementAction.POWER_TYPE, types.get(0));\n+        }\n+        else {\n+            result.put(PowerManagementAction.POWER_TYPE, record.getPowerType());\n+            result.put(PowerManagementAction.POWER_ADDRESS, record.getPowerAddress());\n+            result.put(PowerManagementAction.POWER_USERNAME, record.getPowerUsername());\n+            result.put(PowerManagementAction.POWER_PASSWORD, record.getPowerPassword());\n+            result.put(PowerManagementAction.POWER_ID, record.getPowerId());\n+        }\n+        return result;\n+    }\n+\n+    private SystemRecord lookupExistingCobblerRecord(User loggedInUser, String label) {\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        label = label.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        String name = label + sep + loggedInUser.getOrg().getId();\n+        SystemRecord rec = SystemRecord.lookupByName(\n+                CobblerXMLRPCHelper.getConnection(loggedInUser), name);\n+        if (rec == null) {\n+            log.error(\"System with cobbler name \" + name + \"not found.\");\n+        }\n+        return rec;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, Integer serverId, Map<String, String> data) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        CobblerPowerSettingsUpdateCommand cmd = new CobblerPowerSettingsUpdateCommand(\n+                loggedInUser, server,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Set power management settings for the given system\n+     *\n+     * @param loggedInUser the user\n+     * @param nameIn the cobbler name prefix\n+     * @param data power management parameters\n+     * @return current power management settings when available\n+     *\n+     * @xmlrpc.doc Get current power management settings of the given system\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"string\", \"name\")\n+     * @xmlrpc.param\n+     *  #struct_begin(\"data\")\n+     *    #prop_desc(\"string\", \"powerType\", \"Power management type\")\n+     *    #prop_desc(\"string\", \"powerAddress\", \"IP address for power management\")\n+     *    #prop_desc(\"string\", \"powerUsername\", \"The Username\")\n+     *    #prop_desc(\"string\", \"powerPassword\", \"The Password\")\n+     *    #prop_desc(\"string\", \"powerId\", \"Identifier\")\n+     *  #struct_end()\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    public int setDetails(User loggedInUser, String nameIn, Map<String, String> data) {\n+        ensureOrgAdmin(loggedInUser);\n+        CobblerUnregisteredPowerSettingsUpdateCommand cmd =\n+                new CobblerUnregisteredPowerSettingsUpdateCommand(\n+                loggedInUser, nameIn,\n+                data.get(PowerManagementAction.POWER_TYPE),\n+                data.get(PowerManagementAction.POWER_ADDRESS),\n+                data.get(PowerManagementAction.POWER_USERNAME),\n+                data.get(PowerManagementAction.POWER_PASSWORD),\n+                data.get(PowerManagementAction.POWER_ID));\n+        ValidatorError error = cmd.store();\n+        if (error != null) {\n+            throw new InvalidParameterException(error.getMessage());\n+        }\n+\n+        return 1;\n+    }\n+\n+    /**\n+     * Return a list of available power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @return list of action strings\n+     *\n+     * @xmlrpc.doc Return a list of available power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.returntype #array_single(\"string\", \"power management actions\")\n+     */\n+    public List<String> listActions(User loggedInUser) {\n+        List<String> result = new ArrayList<>();\n+        result.add(\"PowerOn\");\n+        result.add(\"PowerOff\");\n+        result.add(\"Reboot\");\n+        return result;\n+    }\n+\n+    /**\n+     * Execute power management actions\n+     *\n+     * @param loggedInUser the user\n+     * @param serverId the requested server id\n+     * @param action the action to execute\n+     * @return 1 on success\n+     *\n+     * @xmlrpc.doc Execute power management actions\n+     * @xmlrpc.param #param(\"string\", \"sessionKey\")\n+     * @xmlrpc.param #param(\"int\", \"serverId\")\n+     * @xmlrpc.param #param(\"string\", \"action\")\n+     * @xmlrpc.returntype #return_int_success()\n+     */\n+    // FIXME: and idea of a better name? executeAction(), ...\n+    public int doPowerManagement(User loggedInUser, Integer serverId, String action) {\n+        Server server = null;\n+        try {\n+            server = SystemManager.lookupByIdAndUser(serverId.longValue(), loggedInUser);\n+        }\n+        catch (LookupException e) {\n+            throw new NoSuchSystemException();\n+        }\n+        ValidatorError error = null;\n+        switch (action) {\n+        case \"PowerOn\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOn).store();\n+            break;\n+        case \"PowerOff\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.PowerOff).store();\n+            break;\n+        case \"Reboot\":\n+            error = new CobblerPowerCommand(loggedInUser, server,\n+                    CobblerPowerCommand.Operation.Reboot).store();\n+            break;\n+\n+        default:\n+            log.error(\"Invalid power management action: \" + action);\n+            throw new InvalidArgsException(\"Invalid power management action: \" + action);\n+        }\n+        if (error != null) {\n+            log.error(\"Power management action \" + action + \"failed\");\n+            throw new PowerManagementOperationFailedException(error.getMessage());\n+        }\n+        log.info(\"Power management action \" + action + \"succeeded\");", "originalCommit": "c41ca2f1779b065a4be5f11e50dc36d9748d83e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77103ff5160f409852ca97547d1ecdd7a1a18b48", "url": "https://github.com/uyuni-project/uyuni/commit/77103ff5160f409852ca97547d1ecdd7a1a18b48", "message": "cucumber tests for power management XMLRPC API", "committedDate": "2020-10-05T16:12:57Z", "type": "forcePushed"}, {"oid": "f0bab06992df8614da48b83b665a45b245c4b3c5", "url": "https://github.com/uyuni-project/uyuni/commit/f0bab06992df8614da48b83b665a45b245c4b3c5", "message": "cucumber tests for power management XMLRPC API", "committedDate": "2020-10-06T11:41:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI1OTAzNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r500259034", "bodyText": "Just a little nitpick. Can you make scenario name unique, please? Apart of this LGTM.", "author": "lkotek", "createdAt": "2020-10-06T13:05:43Z", "path": "testsuite/features/secondary/srv_power_management.feature", "diffHunk": "@@ -82,6 +82,17 @@ Feature: Power management\n     And I should see a \"Power Off\" button\n     And I should see a \"Reboot\" button\n \n+  Scenario: Cleanup: reset IPMI values", "originalCommit": "f0bab06992df8614da48b83b665a45b245c4b3c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxODg3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r500318878", "bodyText": "fixed", "author": "mcalmer", "createdAt": "2020-10-06T14:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI1OTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3OTY0NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2674#discussion_r500879644", "bodyText": "nitpick: stray line", "author": "mbologna", "createdAt": "2020-10-07T09:45:20Z", "path": "java/code/src/com/redhat/rhn/manager/kickstart/cobbler/CobblerPowerCommand.java", "diffHunk": "@@ -68,59 +72,92 @@ public CobblerPowerCommand(User userIn, Server serverIn, Operation operationIn)\n     }\n \n     /**\n-     * Attempts to power on, off or reboot the server.\n-     * @return any errors\n+     * Instantiates a new Cobbler power management command.\n+     * @param userIn the user running this command\n+     * @param nameIn the cobbler system name (prefix) to power on or off\n+     * @param operationIn the operation to run\n      */\n-    @Override\n-    public ValidatorError store() {\n+    public CobblerPowerCommand(User userIn, String nameIn, Operation operationIn) {\n+        super(userIn);\n+        operation = operationIn;\n+        String sep = ConfigDefaults.get().getCobblerNameSeparator();\n+        nameIn = nameIn.replace(' ', '_').replaceAll(\"[^a-zA-Z0-9_\\\\-\\\\.]\", \"\");\n+        name = nameIn + sep + user.getOrg().getId();\n+", "originalCommit": "ef46887e4ad24b18a30b920b128c0a5700664ba9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "865b3f141e01f83e8ea3fee3570367e51cbd81e1", "url": "https://github.com/uyuni-project/uyuni/commit/865b3f141e01f83e8ea3fee3570367e51cbd81e1", "message": "powermanagement xmlrpc api", "committedDate": "2020-10-07T10:59:20Z", "type": "commit"}, {"oid": "628f0226d83cd3ef026cd533c450c3691f902259", "url": "https://github.com/uyuni-project/uyuni/commit/628f0226d83cd3ef026cd533c450c3691f902259", "message": "update changelog", "committedDate": "2020-10-07T10:59:20Z", "type": "commit"}, {"oid": "3ca2885a525c4857313d9fbc391cbf0e519d1ba4", "url": "https://github.com/uyuni-project/uyuni/commit/3ca2885a525c4857313d9fbc391cbf0e519d1ba4", "message": "cucumber tests for power management XMLRPC API", "committedDate": "2020-10-07T10:59:20Z", "type": "commit"}, {"oid": "3ca2885a525c4857313d9fbc391cbf0e519d1ba4", "url": "https://github.com/uyuni-project/uyuni/commit/3ca2885a525c4857313d9fbc391cbf0e519d1ba4", "message": "cucumber tests for power management XMLRPC API", "committedDate": "2020-10-07T10:59:20Z", "type": "forcePushed"}]}