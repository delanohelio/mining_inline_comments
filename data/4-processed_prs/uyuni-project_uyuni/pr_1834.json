{"pr_number": 1834, "pr_title": "Fix tests of organization credentials", "pr_createdAt": "2020-01-27T12:46:39Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/1834", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0MjY0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371342643", "bodyText": "I suggest:\nscc_username, scc_password = ENV['SCC_CREDENTIALS'].split('|')", "author": "srbarrios", "createdAt": "2020-01-27T16:25:55Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]", "originalCommit": "7b18890575037786847e596b539b3997192e822c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NTU4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371345580", "bodyText": "does that work with arrays too?", "author": "Bischoff", "createdAt": "2020-01-27T16:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0MjY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0OTk1Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371349953", "bodyText": "it does:\nirb(main):002:0> a = [\"tomato\", \"apple\", \"orange\"]\n=> [\"tomato\", \"apple\", \"orange\"]\nirb(main):003:0> fruit1, fruit2, fruit3 = a\n=> [\"tomato\", \"apple\", \"orange\"]\nirb(main):004:0> puts fruit2\napple\n=> nil\nwill fix, thanks", "author": "Bischoff", "createdAt": "2020-01-27T16:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0MjY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NDE5MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371344191", "bodyText": "I would say we need to catch raise 'Star icon not found' unless find('i.fa-star-o'), without the click.\nOtherwise, if the element is not found and we try to click, it will raise an exception isn't it?", "author": "srbarrios", "createdAt": "2020-01-27T16:28:27Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  steps %(\n+    And I enter \"#{scc_username}\" as \"edit-user\"\n+    And I enter \"#{scc_password}\" as \"edit-password\"\n+  )\n+end\n+\n+Then(/^the SCC credentials should be valid$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  within(:xpath, \"//h3[contains(text(), '#{scc_username}')]/../..\") do\n+    raise 'Valid icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+Then(/^the credentials for \"([^\"]*)\" should be invalid$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Invalid icon not found' unless find('i.text-danger', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+When(/^I make the credentials for \"([^\"]*)\" primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not found' unless find('i.fa-star-o').click", "originalCommit": "7b18890575037786847e596b539b3997192e822c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Njc1MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371346751", "bodyText": "You're right. I stupidly copied the \"not found\" without asking myself any questions.\nI don't think it makes any importance which exception it raises. I will change the message to \"Unable to click on star icon\".", "author": "Bischoff", "createdAt": "2020-01-27T16:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NDE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0OTM0Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371349347", "bodyText": "I would store the element found by find in a variable and click after that check... to be in the safe side, but as you wish.", "author": "srbarrios", "createdAt": "2020-01-27T16:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NDE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2NjA0NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371366045", "bodyText": "I would store the element found by find in a variable and click after that check... to be in the safe side, but as you wish.\n\nThere's a zillion of those buggy constructs. This would deserve a big PR of its own.\nI'm not even sure it does not work... It could be capybara does some magic catching the exception inside of the expression if it fails during the find.", "author": "Bischoff", "createdAt": "2020-01-27T17:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NDE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NTk2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371345968", "bodyText": "We don't need to add the sleep method, the find will already have its default timeout.\nUhmmm in fact, what we can think to do here is to get rid of the repeat_until_timeout method, just taking the power of capybara and its wait parameter in find method. To make it work, instead of looking for 'i.fa-trash-o' you will need to create a xpath that includes the style also, and the desired \"not-allowed\" value", "author": "srbarrios", "createdAt": "2020-01-27T16:31:22Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,71 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'xpath: i.text-success not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n end\n \n-When(/^I delete the primary credentials$/) do\n-  raise 'xpath: i.fa-trash-o not found' unless find('i.fa-trash-o', match: :first).click\n-  step 'I click on \"Delete\"'\n+When(/^I enter the address of the HTTP proxy as \"([^\"]*)\"/) do |hostname|\n+  step %(I enter \"#{$server_http_proxy}\" as \"#{hostname}\")\n+end\n+\n+When(/^I ask to add new credentials$/) do\n+  raise 'xpath: i.fa-plus-circle not found' unless find('i.fa-plus-circle').click\n+end\n+\n+When(/^I enter the SCC credentials$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  steps %(\n+    And I enter \"#{scc_username}\" as \"edit-user\"\n+    And I enter \"#{scc_password}\" as \"edit-password\"\n+  )\n+end\n+\n+Then(/^the SCC credentials should be valid$/) do\n+  scc_username = ENV['SCC_CREDENTIALS'].split('|')[0]\n+  scc_password = ENV['SCC_CREDENTIALS'].split('|')[1]\n+  within(:xpath, \"//h3[contains(text(), '#{scc_username}')]/../..\") do\n+    raise 'Valid icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+Then(/^the credentials for \"([^\"]*)\" should be invalid$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Invalid icon not found' unless find('i.text-danger', wait: DEFAULT_TIMEOUT)\n+  end\n+end\n+\n+When(/^I make the credentials for \"([^\"]*)\" primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not found' unless find('i.fa-star-o').click\n+  end\n end\n \n-When(/^I view the primary subscription list$/) do\n-  raise 'xpath: i.fa-th-list not found' unless find('i.fa-th-list', match: :first).click\n+Then(/^the credentials for \"([^\"]*)\" should be primary$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    raise 'Star icon not selected' unless find('i.fa-star')\n+  end\n+end\n+\n+When(/^I wait for the trash icon to appear for \"([^\"]*)\"$/) do |user|\n+  within(:xpath, \"//h3[contains(text(), '#{user}')]/../..\") do\n+    repeat_until_timeout(message: 'Trash icon is still greyed out') do\n+      break unless find('i.fa-trash-o')[:style].include? \"not-allowed\"\n+      sleep 1", "originalCommit": "7b18890575037786847e596b539b3997192e822c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2MDAzNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371360035", "bodyText": "ok, but not now. This works, and I would need half a day to have a test bed again, and there are more urgent things.", "author": "Bischoff", "createdAt": "2020-01-27T16:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0NTk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371347963", "bodyText": "I think we should move that variable outside the method, we can have it with the rest of global variables which retrieves values from ENV", "author": "srbarrios", "createdAt": "2020-01-27T16:34:45Z", "path": "testsuite/features/step_definitions/navigation_steps.rb", "diffHunk": "@@ -781,12 +777,14 @@\n \n # Image-specific steps\n When(/^I enter \"([^\"]*)\" relative to profiles as \"([^\"]*)\"$/) do |path, field|\n-  step %(I enter \"#{$git_profiles}/#{path}\" as \"#{field}\")\n+  git_profiles = ENV['GITPROFILES']", "originalCommit": "7b18890575037786847e596b539b3997192e822c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2MDMxMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371360311", "bodyText": "the purpose is precisely to undo that! To have less global variables.", "author": "Bischoff", "createdAt": "2020-01-27T16:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNjk0Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371406942", "bodyText": "I don't see how that global variable can hurt \ud83e\udd37\u200d\u2642\ufe0f\nI only can see the benefit of not read it from the system every time. I see the purpose of reducing global variables if those can change its value, but when the value will never change, I see benefits.\nAnyway, fine to let it as it is.", "author": "srbarrios", "createdAt": "2020-01-27T18:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU3OTE1Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371579152", "bodyText": "We already have a global variable: ENV. It's as fast and as easy to use it as to copy it elsewhere with no point.\nWe don't have a $portus_profile either and it never shocked you...", "author": "Bischoff", "createdAt": "2020-01-28T02:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyNTAwMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371625001", "bodyText": "Ah! ENV is a global variable? Somehow in my mind I though it was accessing to the system to retrieve the variable using ENV. Then we are fine, we just read from our stack \ud83d\ude05\nBtw, I'm not familiar with that portus profile thing, someday you will need to explain me what's that :)", "author": "srbarrios", "createdAt": "2020-01-28T06:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Nzk2Mw=="}], "type": "inlineReview"}, {"oid": "23f69288f0261bc7320ef37e910fa61149a140ae", "url": "https://github.com/uyuni-project/uyuni/commit/23f69288f0261bc7320ef37e910fa61149a140ae", "message": "Fix tests of organization credentials", "committedDate": "2020-01-27T17:31:59Z", "type": "commit"}, {"oid": "687be61b93536e85f69d1925adf66d0e31f25221", "url": "https://github.com/uyuni-project/uyuni/commit/687be61b93536e85f69d1925adf66d0e31f25221", "message": "Don't run SCC credentials test if they are set to empty strings", "committedDate": "2020-01-27T17:33:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxMDEzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371410133", "bodyText": "I still confused every time I see DEFAULT_TIMEOUT specified somewhere xD\nBut, yes, it is different from `Capybara.default_max_wait_time = 10``:)", "author": "srbarrios", "createdAt": "2020-01-27T18:34:36Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -371,22 +371,69 @@\n \n # setup wizard\n \n-When(/^I make the credentials primary$/) do\n-  raise 'xpath: i.fa-star-o not found' unless find('i.fa-star-o').click\n+Then(/^HTTP proxy verification should have succeeded$/) do\n+  raise 'Success icon not found' unless find('i.text-success', wait: DEFAULT_TIMEOUT)", "originalCommit": "687be61b93536e85f69d1925adf66d0e31f25221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU3ODcwOA==", "url": "https://github.com/uyuni-project/uyuni/pull/1834#discussion_r371578708", "bodyText": "It has nothing to do with capybara, it is the default \"long\" timeout (4 minutes or such).", "author": "Bischoff", "createdAt": "2020-01-28T02:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxMDEzMw=="}], "type": "inlineReview"}]}