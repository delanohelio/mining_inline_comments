{"pr_number": 2020, "pr_title": "Add child product channel sync status visibility at parent level", "pr_createdAt": "2020-03-16T13:54:21Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2020", "timeline": [{"oid": "5f332c37e382c596d766ab81b5e05ee4f8378b02", "url": "https://github.com/uyuni-project/uyuni/commit/5f332c37e382c596d766ab81b5e05ee4f8378b02", "message": "Show separate info for syncing product channels and children", "committedDate": "2020-03-16T13:59:28Z", "type": "forcePushed"}, {"oid": "5528093bdb42a4b2a0cd541a3919fff937332248", "url": "https://github.com/uyuni-project/uyuni/commit/5528093bdb42a4b2a0cd541a3919fff937332248", "message": "Reintroduce button to schedule all channels product sync", "committedDate": "2020-03-20T22:43:12Z", "type": "forcePushed"}, {"oid": "29b23a355d2ee261b4ec6f32458110afbec9a806", "url": "https://github.com/uyuni-project/uyuni/commit/29b23a355d2ee261b4ec6f32458110afbec9a806", "message": "Fix checkstyle", "committedDate": "2020-03-25T20:05:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDA0OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r398454048", "bodyText": "I think this is too expensive and there is a better way to get the ID.\nCheck line 300: there is a map \"channelByLabel\" of all Channels. Please use that map to get the Channel and the ID.", "author": "mcalmer", "createdAt": "2020-03-26T10:10:17Z", "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -319,6 +318,10 @@ public static String data(Request request, Response response, User user) {\n                                             s.getStatus(),\n                                             s.getChannels().stream().map(c ->\n                                                     new ChannelJson(\n+                                                            s.getStatus().equals(MgrSyncStatus.INSTALLED) &&\n+                                                                    ChannelFactory.lookupByLabel(c.getLabel()) != null ?\n+                                                                    ChannelFactory.lookupByLabel(c.getLabel()).getId() :\n+                                                                    -1L,", "originalCommit": "29b23a355d2ee261b4ec6f32458110afbec9a806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYxMDI4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r398610280", "bodyText": "Thanks for the hint. Fixed", "author": "ncounter", "createdAt": "2020-03-26T14:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDIwOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r398454208", "bodyText": "Same as above", "author": "mcalmer", "createdAt": "2020-03-26T10:10:33Z", "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -365,6 +368,10 @@ public static String data(Request request, Response response, User user) {\n                         rootExtensions,\n                         syncProduct.getChannels().stream().map(c ->\n                                 new ChannelJson(\n+                                        syncProduct.getStatus().equals(MgrSyncStatus.INSTALLED) &&\n+                                                ChannelFactory.lookupByLabel(c.getLabel()) != null ?\n+                                                ChannelFactory.lookupByLabel(c.getLabel()).getId() :\n+                                                -1L,", "originalCommit": "29b23a355d2ee261b4ec6f32458110afbec9a806", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1MzI5NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399353294", "bodyText": "Nit: typo.", "author": "hustodemon", "createdAt": "2020-03-27T15:35:45Z", "path": "web/html/src/manager/admin/setup/products/products.js", "diffHunk": "@@ -706,6 +706,78 @@ class CheckListItem extends React.Component {\n     }\n     /*****/\n \n+    /** generate channel sync statys **/", "originalCommit": "bba4b644cbce9fc015c16201f429463e02d04ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399363380", "bodyText": "To me it seems this triple if-else does the same thing as the one above, but on a different data (childProductChannels vs. currentProductChannels). Could this be extracted to a separate function to reduce code duplication?", "author": "hustodemon", "createdAt": "2020-03-27T15:50:07Z", "path": "web/html/src/manager/admin/setup/products/products.js", "diffHunk": "@@ -735,49 +745,101 @@ class CheckListItem extends React.Component {\n     }\n     /*****/\n \n-    /** generate channel sync progress bar **/\n+    /** generate channel sync statys **/\n     let channelSyncContent;\n     if (this.isInstalled()) {\n-      const mandatoryChannelList = currentItem.channels.filter(c => !c.optional);\n+      let currentProductChannels = currentItem.channels.filter(c => c.status != _CHANNEL_STATUS.notSynced);\n \n       // if the product sync has just been scheduled\n-      if (this.props.bypassProps.scheduledItems.includes(currentItem.identifier)) {\n-        channelSyncContent = <span className=\"text-info\">{t('Sync scheduled')}</span>;\n+      if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-danger\" title={t('Product channels sync failed')}>\n+            <i className=\"fa fa-exclamation-circle fa-1-5x\"></i>\n+          </span>;\n       }\n-      // if any failed sync channel, show the error only\n-      else if (mandatoryChannelList.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n-        channelSyncContent = <span className=\"text-danger\">{t('Sync failed')}</span>;\n+      else if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.syncing).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-info\" title={t('Product channels sync in progress')}>\n+            <i className=\"fa fa-spinner fa-spin fa-1-5x\"></i>\n+          </span>;\n       }\n-      else {\n-        const syncedChannels = mandatoryChannelList.filter(c => c.status == _CHANNEL_STATUS.synced).length;\n-        const toBeSyncedChannels = mandatoryChannelList.length;\n-        const channelSyncProgress = Math.round(( syncedChannels / toBeSyncedChannels ) * 100);\n-        channelSyncContent = <ProgressBar progress={channelSyncProgress} title={t('Product sync status')} width='60%'/>;\n+      else if (currentProductChannels.filter(c => c.status == _CHANNEL_STATUS.synced).length > 0) {\n+        channelSyncContent =\n+          <span className=\"text-success\" title={t('Product channels synced')}>\n+            <i className=\"fa fa-check-circle fa-1-5x\"></i>\n+          </span>;\n+      }\n+    }\n+\n+    let childProductChannelSyncContent;\n+    if (this.isInstalled()) {\n+      // add all channels of the subtree\n+      let childProductChannels = [];\n+\n+      this.getChildrenTree(currentItem)\n+        .filter(product => product.status == _PRODUCT_STATUS.installed)\n+        .forEach(prod => {\n+          prod.channels.filter(channel => channel.status != _CHANNEL_STATUS.notSynced)\n+            .forEach(chan => { childProductChannels.push(chan) })\n+        });\n+      if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.failed).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-danger\" title={t('Child products channels sync failed')}>\n+            (<i className=\"fa fa-exclamation-circle\"></i>)\n+          </span>;\n+      }\n+      else if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.syncing).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-info\" title={t('Child products channels in progress')}>\n+            (<i className=\"fa fa-spinner fa-spin\"></i>)\n+          </span>;\n+      }\n+      else if (childProductChannels.filter(c => c.status == _CHANNEL_STATUS.synced).length > 0) {\n+        childProductChannelSyncContent =\n+          <span className=\"text-success\" title={t('Child products channels synced')}>\n+            (<i className=\"fa fa-check-circle\"></i>)\n+          </span>;\n       }", "originalCommit": "5aefa09e4ed072e24770a1dadf966e63d39f4409", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2ODYzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399568633", "bodyText": "Yeah, it is not exactly the same code, but with some small extracted differences I was able to make a single function to reuse the shared part. \ud83d\udc4d", "author": "ncounter", "createdAt": "2020-03-27T22:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MzUwOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399373508", "bodyText": "Nitpick: (this is totally matter of taste, so disregard it, if you don't like it.)\nI found an alternative syntax to be more readable:\nOptional.ofNullable(channelByLabel.get(c.getLabel()))\n    .map(chan -> chan.getId())\n    .orElse(-1L)", "author": "hustodemon", "createdAt": "2020-03-27T16:04:47Z", "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -319,6 +318,10 @@ public static String data(Request request, Response response, User user) {\n                                             s.getStatus(),\n                                             s.getChannels().stream().map(c ->\n                                                     new ChannelJson(\n+                                                            Opt.fold(Optional.ofNullable(\n+                                                                            channelByLabel.get(c.getLabel())),\n+                                                                    () -> -1L,\n+                                                                    x -> x.getId()),", "originalCommit": "5aefa09e4ed072e24770a1dadf966e63d39f4409", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NjkyNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399546926", "bodyText": "I am always undecided which is better actually.\nOpt.fold is more complex but Optional.ofNullable uses .map() and I don't like to map when I know it is just a single object that I have to work with, it is less intuitive in such a case. So either one way or the other in this case has pros and cons to me. And if you say the second one is clearer, I'm fine with it and I trust you more in the Java aspect. Changing accordingly \ud83d\udc4d", "author": "ncounter", "createdAt": "2020-03-27T21:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MzUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3Mzg3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2020#discussion_r399373878", "bodyText": "Same here, feel free not to agree \ud83d\ude09", "author": "hustodemon", "createdAt": "2020-03-27T16:05:20Z", "path": "java/code/src/com/suse/manager/webui/controllers/ProductsController.java", "diffHunk": "@@ -365,6 +368,9 @@ public static String data(Request request, Response response, User user) {\n                         rootExtensions,\n                         syncProduct.getChannels().stream().map(c ->\n                                 new ChannelJson(\n+                                        Opt.fold(Optional.ofNullable(channelByLabel.get(c.getLabel())),\n+                                                () -> -1L,\n+                                                x -> x.getId()),", "originalCommit": "5aefa09e4ed072e24770a1dadf966e63d39f4409", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90b7e695c20dde9a3707e16de1f0ae6ffaf5d1d3", "url": "https://github.com/uyuni-project/uyuni/commit/90b7e695c20dde9a3707e16de1f0ae6ffaf5d1d3", "message": "Print proper channel name in the channel list detail", "committedDate": "2020-03-27T21:32:39Z", "type": "commit"}, {"oid": "6be95e098b95daa6e68ca7ab1bb85b3b3feced46", "url": "https://github.com/uyuni-project/uyuni/commit/6be95e098b95daa6e68ca7ab1bb85b3b3feced46", "message": "Prevent reactjs warnings", "committedDate": "2020-03-27T21:32:39Z", "type": "commit"}, {"oid": "6f0e3a44035d2037761ab94c561f564434445e9f", "url": "https://github.com/uyuni-project/uyuni/commit/6f0e3a44035d2037761ab94c561f564434445e9f", "message": "Drop channel sync status info in the product page", "committedDate": "2020-03-27T21:32:40Z", "type": "commit"}, {"oid": "39cfffda9652bbbab216dbc50af255b68c9f0ab7", "url": "https://github.com/uyuni-project/uyuni/commit/39cfffda9652bbbab216dbc50af255b68c9f0ab7", "message": "Use normal disabled checkbox instead of icon", "committedDate": "2020-03-27T21:32:40Z", "type": "commit"}, {"oid": "9bdbb5334ec94136de61cdac71205f38d497053a", "url": "https://github.com/uyuni-project/uyuni/commit/9bdbb5334ec94136de61cdac71205f38d497053a", "message": "Fix products page alternate row color", "committedDate": "2020-03-27T21:32:40Z", "type": "commit"}, {"oid": "eecfaa744e6df4fa16e849c4847f0c29e12c373a", "url": "https://github.com/uyuni-project/uyuni/commit/eecfaa744e6df4fa16e849c4847f0c29e12c373a", "message": "Show separate info for syncing product channels and children", "committedDate": "2020-03-27T21:32:41Z", "type": "commit"}, {"oid": "afdc094340dda989021dcaf06fad36fd4aa9d716", "url": "https://github.com/uyuni-project/uyuni/commit/afdc094340dda989021dcaf06fad36fd4aa9d716", "message": "Link to the channel page from product if channel exists", "committedDate": "2020-03-27T21:32:41Z", "type": "commit"}, {"oid": "f018871dcc50f8f3d8319d48597278248c721376", "url": "https://github.com/uyuni-project/uyuni/commit/f018871dcc50f8f3d8319d48597278248c721376", "message": "Reintroduce button to schedule all channels product sync", "committedDate": "2020-03-27T21:32:41Z", "type": "commit"}, {"oid": "30b1115d84b69f7c83051f5aa99a095b4a592f4a", "url": "https://github.com/uyuni-project/uyuni/commit/30b1115d84b69f7c83051f5aa99a095b4a592f4a", "message": "Fix checkstyle", "committedDate": "2020-03-27T21:32:41Z", "type": "commit"}, {"oid": "9341fa8895fa477f6e06529f04f88c1c7467b517", "url": "https://github.com/uyuni-project/uyuni/commit/9341fa8895fa477f6e06529f04f88c1c7467b517", "message": "Better perfomance to get channel id if it exists", "committedDate": "2020-03-27T21:32:42Z", "type": "commit"}, {"oid": "25e3f5079890d18c088541d509f5bc12f2f6109e", "url": "https://github.com/uyuni-project/uyuni/commit/25e3f5079890d18c088541d509f5bc12f2f6109e", "message": "Extract and reuse the same code to generate icon sync status", "committedDate": "2020-03-27T22:34:51Z", "type": "commit"}, {"oid": "25e3f5079890d18c088541d509f5bc12f2f6109e", "url": "https://github.com/uyuni-project/uyuni/commit/25e3f5079890d18c088541d509f5bc12f2f6109e", "message": "Extract and reuse the same code to generate icon sync status", "committedDate": "2020-03-27T22:34:51Z", "type": "forcePushed"}]}