{"pr_number": 2157, "pr_title": "Reposync speedup part 2", "pr_createdAt": "2020-04-24T12:19:49Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2157", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU4MTg5NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r414581895", "bodyText": "Are you sure you want this script here?\nI think you instead need it at https://github.com/uyuni-project/uyuni/tree/master/schema/spacewalk/upgrade/susemanager-schema-4.1.6-to-susemanager-schema-4.1.7", "author": "juliogonzalez", "createdAt": "2020-04-24T13:37:10Z", "path": "schema/spacewalk/upgrade/susemanager-schema-4.1.4-to-susemanager-schema-4.1.5/003-rhnpackagecapability-name-index.sql", "diffHunk": "@@ -0,0 +1,2 @@\n+CREATE INDEX rhn_pkg_cap_name", "originalCommit": "0552d28a9a718b459c146a75e72541a22a870758", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4382b03e5a4176c1aecf9bf26009511c66b56ff", "url": "https://github.com/uyuni-project/uyuni/commit/a4382b03e5a4176c1aecf9bf26009511c66b56ff", "message": "Changelogs updated", "committedDate": "2020-04-24T14:13:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA1MTIzMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r415051230", "bodyText": "nit pick: normal index names use _idx as suffix. Maybe you can rename.", "author": "mcalmer", "createdAt": "2020-04-25T12:17:38Z", "path": "schema/spacewalk/postgres/tables/rhnPackageCapability_index.sql", "diffHunk": "@@ -20,3 +20,6 @@ CREATE UNIQUE INDEX rhn_pkg_cap_name_version_uq\n create unique index rhn_pkg_cap_name_uq\n     on rhnPackageCapability (name)\n  where version is null;\n+\n+CREATE INDEX rhn_pkg_cap_name", "originalCommit": "a4382b03e5a4176c1aecf9bf26009511c66b56ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA1MTI2Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2157#discussion_r415051263", "bodyText": "same as above", "author": "mcalmer", "createdAt": "2020-04-25T12:17:54Z", "path": "schema/spacewalk/upgrade/susemanager-schema-4.1.6-to-susemanager-schema-4.1.7/003-rhnpackagecapability-name-index.sql", "diffHunk": "@@ -0,0 +1,2 @@\n+CREATE INDEX IF NOT EXISTS rhn_pkg_cap_name\n+    ON rhnPackageCapability USING HASH (name);", "originalCommit": "a4382b03e5a4176c1aecf9bf26009511c66b56ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3873be7e27fb75ca7f143cefb549792837618471", "url": "https://github.com/uyuni-project/uyuni/commit/3873be7e27fb75ca7f143cefb549792837618471", "message": "Add support for psycopg's execute_many", "committedDate": "2020-04-25T12:24:04Z", "type": "commit"}, {"oid": "2cf53569eccc0f8839c3ca9fe2f234835ba2eaf4", "url": "https://github.com/uyuni-project/uyuni/commit/2cf53569eccc0f8839c3ca9fe2f234835ba2eaf4", "message": "reposync speedup: use execute_values for capabilities\n\nPrevious code called a stored procedure (lookup_capabilities) per\ncapability, per package. As packages can be thousands and capabilities\ncan be hundreds of thousands per package, the number of calls to the\ndatabase was very high.\n\nThe execute_values method of psycopg allows to insert rows in batches,\nthereby reducing the number of calls to one per package, for all of its\ncapabilities - indexes to find out if a capability already exists can\nthen be scanned once only.\n\nMoreover INSERT ... ON CONFLICT DO NOTHING is used instead of the\nprevious mechanism using a second connection to Postgres to make sure no\nfailures happen on unique key constraints. This is also much more\nlightweight than explicit locks.", "committedDate": "2020-04-25T12:24:04Z", "type": "commit"}, {"oid": "839861b83ca318f58d8492414871d924b248cd3a", "url": "https://github.com/uyuni-project/uyuni/commit/839861b83ca318f58d8492414871d924b248cd3a", "message": "Add INDEX to rhnPackageCapability.name", "committedDate": "2020-04-25T12:25:05Z", "type": "commit"}, {"oid": "82ee0130a08ce2f8dce9270b21aab7fd2d84b585", "url": "https://github.com/uyuni-project/uyuni/commit/82ee0130a08ce2f8dce9270b21aab7fd2d84b585", "message": "reposync speedup: use execute_values for checksums\n\nPrevious code called a stored procedure (lookup_checksum) per\nchecksum, per package. As packages can be thousands and have hundreds\nof files, each of which has a checksum, the number of calls to the\ndatabase was very high.\n\nThe execute_values method of psycopg allows to insert rows in batches,\nthereby reducing the number of calls to one per package, for all of its\nchecksums - indexes to find out if a checksum already exists can\nthen be scanned once only.\n\nMoreover INSERT ... ON CONFLICT DO NOTHING is used instead of the\nprevious mechanism using a second connection to Postgres to make sure no\nfailures happen on unique key constraints. This is also much more\nlightweight than explicit locks.", "committedDate": "2020-04-25T12:25:09Z", "type": "commit"}, {"oid": "cd580172fe9ccc0ba9ad2591ef6486b8f9ef4df0", "url": "https://github.com/uyuni-project/uyuni/commit/cd580172fe9ccc0ba9ad2591ef6486b8f9ef4df0", "message": "reposync speedup: use execute_values for changelogs", "committedDate": "2020-04-25T12:25:10Z", "type": "commit"}, {"oid": "a946827e9bb38afd836f71183e26eeffff41e463", "url": "https://github.com/uyuni-project/uyuni/commit/a946827e9bb38afd836f71183e26eeffff41e463", "message": "refactoring: dead code removal", "committedDate": "2020-04-25T12:25:10Z", "type": "commit"}, {"oid": "c9940beadd643bd08338dfb7ced941ed19733f71", "url": "https://github.com/uyuni-project/uyuni/commit/c9940beadd643bd08338dfb7ced941ed19733f71", "message": "Changelogs updated", "committedDate": "2020-04-25T12:25:10Z", "type": "commit"}, {"oid": "c9940beadd643bd08338dfb7ced941ed19733f71", "url": "https://github.com/uyuni-project/uyuni/commit/c9940beadd643bd08338dfb7ced941ed19733f71", "message": "Changelogs updated", "committedDate": "2020-04-25T12:25:10Z", "type": "forcePushed"}]}