{"pr_number": 2224, "pr_title": "Configure registry", "pr_createdAt": "2020-05-16T14:06:52Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2224", "timeline": [{"oid": "3e6217b129e6982cd539b77e2f9ec15acfcb03c6", "url": "https://github.com/uyuni-project/uyuni/commit/3e6217b129e6982cd539b77e2f9ec15acfcb03c6", "message": "test portus server with configured portus uri", "committedDate": "2020-05-16T14:29:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIyNzY4OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427227689", "bodyText": "English, not computese, please \ud83d\ude38\nAnd I enter the registry's URI as \"uri\"", "author": "Bischoff", "createdAt": "2020-05-19T11:26:34Z", "path": "testsuite/features/core/srv_docker.feature", "diffHunk": "@@ -40,7 +40,7 @@ Feature: Prepare server for using Docker\n     When I follow the left menu \"Images > Stores\"\n     And I follow \"Create\"\n     And I enter \"galaxy-registry\" as \"label\"\n-    And I enter \"registry.mgr.suse.de\" as \"uri\"\n+    And I enter the registry_uri as \"uri\"", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDc0NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264744", "bodyText": "resolved", "author": "mcalmer", "createdAt": "2020-05-22T14:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIyNzY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMDkzNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427230934", "bodyText": "What about making that filename independant of real host's hostname?\nPossible solution:\ntestsuite/features/profiles/Docker/internal_nue/authprofile/Dockerfile\nThat way, if it moves e.g. to docker.mgr.suse.de or docker.qa.suse.de or whatever else, we don't need to fix the test suite.", "author": "Bischoff", "createdAt": "2020-05-19T11:32:36Z", "path": "testsuite/features/profiles/mgr.suse.de/Docker/authprofile/Dockerfile", "diffHunk": "@@ -0,0 +1,20 @@\n+# Container used to test Content Management feature", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2Njc2MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429266761", "bodyText": "Well, mgr.suse.de and prv.suse.net are not the hostnames. They describe already an area where they run. Using \"internal_nue\", \"internal_prv\" and \"external_aws\" ... would be another way.\nI think about the suggestion from @juliogonzalez to configure a common hostname in /etc/hosts and use everywhere the same hostname.\nI will try this first", "author": "mcalmer", "createdAt": "2020-05-22T14:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMDkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMjAzNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427232036", "bodyText": "Same suggestion:\nmake mgr.suse.de something less implementation-dependant, for example internal_nue", "author": "Bischoff", "createdAt": "2020-05-19T11:34:35Z", "path": "testsuite/features/profiles/mgr.suse.de/Kiwi/POS_Image-JeOS6_32/config.sh", "diffHunk": "@@ -0,0 +1,142 @@\n+#!/bin/bash", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzNzkyMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r490837921", "bodyText": "done", "author": "mcalmer", "createdAt": "2020-09-18T09:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzMjAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNjU3Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427236577", "bodyText": "... and those ones would be internal_prv instead of prv.suse.net\n(or external_prv? not sure how this will be open to uyuni contributors)", "author": "Bischoff", "createdAt": "2020-05-19T11:42:47Z", "path": "testsuite/features/profiles/prv.suse.net/Docker/Dockerfile", "diffHunk": "@@ -0,0 +1,16 @@\n+FROM minima-mirror.prv.suse.net/toaster-sles12sp3-products", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzODM5MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r490838390", "bodyText": "prv is still internal SUSE network. so it is internal_prv", "author": "mcalmer", "createdAt": "2020-09-18T09:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNjU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODEzNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427238134", "bodyText": "English: the registry's URI", "author": "Bischoff", "createdAt": "2020-05-19T11:45:47Z", "path": "testsuite/features/secondary/srv_docker_advanced_content_management.feature", "diffHunk": "@@ -8,7 +8,7 @@ Feature: Advanced content management\n     When I follow the left menu \"Images > Stores\"\n     And I follow \"Create\"\n     And I enter \"docker_admin\" as \"label\"\n-    And I enter \"registry.mgr.suse.de\" as \"uri\"\n+    And I enter the registry_uri as \"uri\"", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDYwMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264601", "bodyText": "resolved", "author": "mcalmer", "createdAt": "2020-05-22T14:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODg0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427238843", "bodyText": "See my remarks on sumaform PR: an alternative would be to make this server non-mandatory. In that case, that variable could be empty, and those whole tests would be skipped.", "author": "Bischoff", "createdAt": "2020-05-19T11:47:16Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -56,7 +56,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://portus.mgr.suse.de:5000'\n+    portus_uri = ENV['PORTUS_URI']", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2MzkyNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429263927", "bodyText": "I made both registries now optional. I added tags to exclude the tests.", "author": "mcalmer", "createdAt": "2020-05-22T14:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzODg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzOTgzNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427239835", "bodyText": "That's what I suggested during standup: if we get a server in the Uyuni case,then this is not \"not implemented anymore\". In that case, just remove those lines (the whole \"uyuni\" case).", "author": "Bischoff", "createdAt": "2020-05-19T11:49:02Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -56,7 +56,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDA4Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264083", "bodyText": "done", "author": "mcalmer", "createdAt": "2020-05-22T14:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzOTgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MDQ2Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427240462", "bodyText": "Same remark: isn't that done now? If so, please remove this error message (the whole \"Uyuni\" case).", "author": "Bischoff", "createdAt": "2020-05-19T11:50:10Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDE5MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264190", "bodyText": "resolved", "author": "mcalmer", "createdAt": "2020-05-22T14:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MDQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTE4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241180", "bodyText": "Same remark: if we make it non-mandatory in sumaform, then it's possible this variable is just empty. If that's the case, we just skip the tests implying a registry.", "author": "Bischoff", "createdAt": "2020-05-19T11:51:24Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://registry.mgr.suse.de:443'\n+    registry_uri = ENV['REGISTRY_URI']", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDI5MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264291", "bodyText": "resolved", "author": "mcalmer", "createdAt": "2020-05-22T14:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTUxNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241514", "bodyText": "why not make https:// part of the variable's content?", "author": "Bischoff", "createdAt": "2020-05-19T11:51:59Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -66,7 +67,8 @@\n     # TODO: move that internal resource to some other external location\n     STDERR.puts 'Sanity check not implemented, move resource to external network first'\n   else\n-    url = 'https://registry.mgr.suse.de:443'\n+    registry_uri = ENV['REGISTRY_URI']\n+    url = \"https://#{registry_uri}\"", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0NTI5OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429245298", "bodyText": "It does not work in docker. That part is used directly for tagging and things like that.\nhttps:// would break it.", "author": "mcalmer", "createdAt": "2020-05-22T13:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTY5Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r427241697", "bodyText": "No technicalities in cucumber text :-) registry's URI", "author": "Bischoff", "createdAt": "2020-05-19T11:52:16Z", "path": "testsuite/features/step_definitions/navigation_steps.rb", "diffHunk": "@@ -163,6 +163,11 @@\n   end\n end\n \n+When(/^I enter the registry_uri as \"([^\"]*)\"$/) do |arg1|", "originalCommit": "5d0dd700224ad069a2ea2548a14f1393b6a05c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NDQ1OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r429264459", "bodyText": "resolved", "author": "mcalmer", "createdAt": "2020-05-22T14:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0MTY5Nw=="}], "type": "inlineReview"}, {"oid": "485fcb0c48fe14c67d0e59a8033ac48ac7b97967", "url": "https://github.com/uyuni-project/uyuni/commit/485fcb0c48fe14c67d0e59a8033ac48ac7b97967", "message": "fix syntax error", "committedDate": "2020-05-22T13:35:05Z", "type": "forcePushed"}, {"oid": "806d82810dd806b04dcd31d24ec3d5b942dd33ae", "url": "https://github.com/uyuni-project/uyuni/commit/806d82810dd806b04dcd31d24ec3d5b942dd33ae", "message": "make registries and image building optional", "committedDate": "2020-05-22T14:10:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNTUzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461605539", "bodyText": "When I configure, upper case \"I\"", "author": "Bischoff", "createdAt": "2020-07-28T14:04:05Z", "path": "testsuite/features/core/allcli_sanity.feature", "diffHunk": "@@ -56,5 +56,13 @@ Feature: Sanity checks\n     And it should be possible to reach the build sources\n     And it should be possible to reach the container profiles\n     And it should be possible to reach the test suite profiles\n-    And it should be possible to reach the portus registry\n-    And it should be possible to reach the other registry\n+\n+@auth_registry\n+  Scenario: The registry with authentication is healthy\n+    When i configure the global portus registry", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNTcyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461605724", "bodyText": "Upper case \"I\", please", "author": "Bischoff", "createdAt": "2020-07-28T14:04:21Z", "path": "testsuite/features/core/allcli_sanity.feature", "diffHunk": "@@ -56,5 +56,13 @@ Feature: Sanity checks\n     And it should be possible to reach the build sources\n     And it should be possible to reach the container profiles\n     And it should be possible to reach the test suite profiles\n-    And it should be possible to reach the portus registry\n-    And it should be possible to reach the other registry\n+\n+@auth_registry\n+  Scenario: The registry with authentication is healthy\n+    When i configure the global portus registry\n+    Then it should be possible to reach the portus registry\n+\n+@noauth_registry\n+  Scenario: The registry without authentication is healthy\n+    When i configure the global registry", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjAzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606039", "bodyText": "Upper case \"I\"", "author": "Bischoff", "createdAt": "2020-07-28T14:04:45Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjE3OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606179", "bodyText": "same", "author": "Bischoff", "createdAt": "2020-07-28T14:04:56Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjMzMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606333", "bodyText": "same", "author": "Bischoff", "createdAt": "2020-07-28T14:05:10Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNjQyNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461606424", "bodyText": "same", "author": "Bischoff", "createdAt": "2020-07-28T14:05:18Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwNzYxOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461607619", "bodyText": "same", "author": "Bischoff", "createdAt": "2020-07-28T14:06:56Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)\n+  $noauth_registry = $noauth_registry.sub(registry.to_s, \"registry.localnet\")\n+end\n+\n+When(/^i configure the \"([^\"]*)\" as \"([^\"]*)\" registry$/) do |registry, newname|", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwODIwMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461608200", "bodyText": "ok", "author": "Bischoff", "createdAt": "2020-07-28T14:07:41Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -51,24 +51,44 @@\n   $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n end\n \n-Then(/^it should be possible to reach the portus registry$/) do\n-  if $product == 'Uyuni'\n-    # TODO: move that internal resource to some other external location\n-    STDERR.puts 'Sanity check not implemented, move resource to external network first'\n-  else\n-    url = 'https://portus.mgr.suse.de:5000'\n-    $server.run(\"curl --insecure --location #{url} --output /dev/null\")\n+When(/^i configure the global portus registry$/) do\n+  registry, _extra = $auth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"portus.localnet\" registry)\n+  $auth_registry = $auth_registry.sub(registry.to_s, \"portus.localnet\")\n+end\n+\n+When(/^i configure the global registry$/) do\n+  registry, _extra = $noauth_registry.split(/[:\\/]/, 2)\n+  step %(i configure the \"#{registry}\" as \"registry.localnet\" registry)\n+  $noauth_registry = $noauth_registry.sub(registry.to_s, \"registry.localnet\")\n+end\n+\n+When(/^i configure the \"([^\"]*)\" as \"([^\"]*)\" registry$/) do |registry, newname|\n+  out = `host #{registry}`.split(\"\\n\")\n+  out.each do |line|\n+    match = line.match(\"#{registry} has address (.*)\")\n+    if match && match[1]\n+      ipv4 = match[1]\n+      if not File.foreach(\"/etc/hosts\").grep(/#{ipv4} #{newname}/).any?\n+        open('/etc/hosts', 'a') { |f|\n+          f.puts \"#{ipv4} #{newname}\"\n+        }\n+      end\n+      $minion.run(\"grep '#{ipv4} #{newname}' /etc/hosts || echo '#{ipv4} #{newname}' >> /etc/hosts\")\n+      $server.run(\"grep '#{ipv4} #{newname}' /etc/hosts || echo '#{ipv4} #{newname}' >> /etc/hosts\")", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMDAyMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r461610020", "bodyText": "We could consider renaming PORTUS_URI and REGISTER_URI variables accordingly (to AUTH_REGISTERY and NOAUTH_REGISTERY), but that would mean changes in sumaform", "author": "Bischoff", "createdAt": "2020-07-28T14:10:01Z", "path": "testsuite/features/support/twopence_init.rb", "diffHunk": "@@ -189,6 +189,8 @@ def file_inject(node, local_file, remote_file)\n $private_net = ENV['PRIVATENET'] if ENV['PRIVATENET']\n $mirror = ENV['MIRROR']\n $server_http_proxy = ENV['SERVER_HTTP_PROXY'] if ENV['SERVER_HTTP_PROXY']\n+$noauth_registry = ENV['REGISTRY_URI'] if ENV['REGISTRY_URI']\n+$auth_registry = ENV['PORTUS_URI'] if ENV['PORTUS_URI']", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkyMDcxNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r490920716", "bodyText": "Done", "author": "mcalmer", "createdAt": "2020-09-18T12:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NjYzMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r482866632", "bodyText": "Warning just in case, apparently we use sles12sp3 image, but then in the line number 13, we add sles12sp4 repo, all right?", "author": "srbarrios", "createdAt": "2020-09-03T10:12:30Z", "path": "testsuite/features/profiles/mgr.suse.de/Docker/Dockerfile", "diffHunk": "@@ -0,0 +1,16 @@\n+FROM registry.mgr.suse.de/toaster-sles12sp3-products", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgyNjY0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r487826643", "bodyText": "yes, all this is fake. We just want to see if we can build a container. We do not care if it is running.\nWhen there is time for refactoring, we can think about creating special containers for this test and special repos.\nI do not like so much, that we use toaster images.", "author": "mcalmer", "createdAt": "2020-09-14T11:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2NjYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2OTc2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r482869769", "bodyText": "Can I ask to use no_auth_registry instead?\nFrom my point of view, either we separate all the words with a _  either we don't separate them.", "author": "srbarrios", "createdAt": "2020-09-03T10:18:11Z", "path": "testsuite/features/support/env.rb", "diffHunk": "@@ -254,6 +254,16 @@ def enable_assertions\n   skip_this_scenario unless $server_http_proxy\n end\n \n+# do test only if the registry is available\n+Before('@noauth_registry') do", "originalCommit": "12dfbd3bef1ee9d9b95e6628b6bc92f264d66a52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3Mjc1NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r482872755", "bodyText": "+1", "author": "Bischoff", "createdAt": "2020-09-03T10:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2OTc2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNjMxOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2224#discussion_r490906319", "bodyText": "done", "author": "mcalmer", "createdAt": "2020-09-18T12:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2OTc2OQ=="}], "type": "inlineReview"}, {"oid": "b21df48671eaa37b9a0678feb5f52c0425c93baf", "url": "https://github.com/uyuni-project/uyuni/commit/b21df48671eaa37b9a0678feb5f52c0425c93baf", "message": "fixes", "committedDate": "2020-09-18T08:18:31Z", "type": "forcePushed"}, {"oid": "1a763d8a88dffcac3accebb1e606c30e45d10a41", "url": "https://github.com/uyuni-project/uyuni/commit/1a763d8a88dffcac3accebb1e606c30e45d10a41", "message": "change environment names and autogenerate profiles", "committedDate": "2020-09-18T09:31:45Z", "type": "forcePushed"}, {"oid": "60813c526548df2928cb606f3ce72a40a178606c", "url": "https://github.com/uyuni-project/uyuni/commit/60813c526548df2928cb606f3ce72a40a178606c", "message": "change environment names and autogenerate profiles", "committedDate": "2020-09-18T10:37:10Z", "type": "forcePushed"}, {"oid": "01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "url": "https://github.com/uyuni-project/uyuni/commit/01da7be2ca76e01282a5ebc1c1e594bc588ab9c1", "message": "rename registry variables", "committedDate": "2020-09-18T12:45:30Z", "type": "forcePushed"}, {"oid": "b8a853f64889d3801cbace0c4a97f8b5ba8529db", "url": "https://github.com/uyuni-project/uyuni/commit/b8a853f64889d3801cbace0c4a97f8b5ba8529db", "message": "define auth_registry and no_auth_registry and read them from env vars", "committedDate": "2020-09-19T09:08:00Z", "type": "commit"}, {"oid": "33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "url": "https://github.com/uyuni-project/uyuni/commit/33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "message": "generate test profiles for different environments", "committedDate": "2020-09-19T09:09:10Z", "type": "commit"}, {"oid": "33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "url": "https://github.com/uyuni-project/uyuni/commit/33e0cfcbfd5457dfeaf0b39af99df3bc1694b353", "message": "generate test profiles for different environments", "committedDate": "2020-09-19T09:09:10Z", "type": "forcePushed"}]}