{"pr_number": 2519, "pr_title": "Re-adds ability to download from local mirrors", "pr_createdAt": "2020-08-25T06:09:11Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2519", "timeline": [{"oid": "caec0420067f91f00c9807dd07d85a40dadb1a39", "url": "https://github.com/uyuni-project/uyuni/commit/caec0420067f91f00c9807dd07d85a40dadb1a39", "message": "Adds file adapter for requests\n\nrequests is per default not able to 'get' files from the local fs.\nWith this file adapter this can be done.", "committedDate": "2020-08-25T06:06:39Z", "type": "commit"}, {"oid": "1c32395afe9f93c16e60c445ad04bad137d806ff", "url": "https://github.com/uyuni-project/uyuni/commit/1c32395afe9f93c16e60c445ad04bad137d806ff", "message": "Switch to processing local files directly", "committedDate": "2020-08-26T15:06:31Z", "type": "commit"}, {"oid": "1980d3e85a8be90c773047c519f18acb87501181", "url": "https://github.com/uyuni-project/uyuni/commit/1980d3e85a8be90c773047c519f18acb87501181", "message": "Adds missing permission check\n\nos.access needs to know which permissions should be checked.", "committedDate": "2020-08-27T14:40:30Z", "type": "commit"}, {"oid": "9a0c0630c6be55c7a641d9ad9a8a1c847224846f", "url": "https://github.com/uyuni-project/uyuni/commit/9a0c0630c6be55c7a641d9ad9a8a1c847224846f", "message": "Seems like pkg index is expected to be a bytes string", "committedDate": "2020-08-28T15:07:47Z", "type": "commit"}, {"oid": "262c44e3b566666fd81bc164dc5bece5152b97fd", "url": "https://github.com/uyuni-project/uyuni/commit/262c44e3b566666fd81bc164dc5bece5152b97fd", "message": "Flat and non flat repo handling fixed", "committedDate": "2020-08-28T15:47:04Z", "type": "commit"}, {"oid": "0c767034a3587ce4b603896294cb6102e9f978ad", "url": "https://github.com/uyuni-project/uyuni/commit/0c767034a3587ce4b603896294cb6102e9f978ad", "message": "Fixes parameters", "committedDate": "2020-08-31T08:54:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3Mjk1MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r480972950", "bodyText": "There is an exception handling missing.", "author": "brejoc", "createdAt": "2020-09-01T08:43:24Z", "path": "backend/common/repo.py", "diffHunk": "@@ -110,11 +110,19 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n         if self._pkg_index[0] == \"\":\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n-                resp = requests.get(packages_url, proxies=self.proxies)\n-                if resp.status_code == http.HTTPStatus.OK:\n-                    self._pkg_index = cnt_fname, resp.content\n-                    break\n-                resp.close()\n+                if packages_url.startswith(\"file://\"):\n+                    try:\n+                        with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                            self._pkg_index = cnt_fname, f.read()\n+                            break\n+                    except:\n+                        pass", "originalCommit": "0c767034a3587ce4b603896294cb6102e9f978ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyMDAxOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r511820018", "bodyText": "We need to add logging in an other PR. \ud83e\udd37", "author": "brejoc", "createdAt": "2020-10-26T09:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3Mjk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAwODQ2MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r481008460", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    # Repo format is flat\n          \n          \n            \n                    if self.is_flat():\n          \n          \n            \n                    # Repo format is flat\n          \n          \n            \n                    else:", "author": "meaksh", "createdAt": "2020-09-01T09:43:49Z", "path": "backend/common/repo.py", "diffHunk": "@@ -232,7 +271,57 @@ def get_release_index(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntry\"]:\n         :raises GeneralRepoException if the Release file cannot be found or the GPG signature can't be verified.\n         :return: string\n         \"\"\"\n+        if self._url.startswith(\"file://\"):\n+            return self._get_release_index_from_file()\n+        else:\n+            return self._get_release_index_from_http()\n+\n+\n+    def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntry\"]:\n+        # InRelease files take precedence per uyuni-rfc 00057-deb-repo-sync-gpg-check\n+        local_path = self._url.replace(\"file://\", \"\")\n+        release_file = None\n+        if os.access(self._get_parent_url(local_path, 2, \"InRelease\"), os.R_OK):\n+            release_file = self._get_parent_url(local_path, 2, \"InRelease\")\n+            self._flat = False\n+        elif os.access(self._get_parent_url(local_path, 2, \"Release\"), os.R_OK):\n+            release_file = self._get_parent_url(local_path, 2, \"InRelease\")\n+            self._flat = False\n+        else:\n+            self._flat = True\n+        self._flat_checked = 1\n+\n+        # Repo format is not flat\n+        if not self.is_flat():\n+            if self.gpg_verify and not self._has_valid_gpg_signature(local_path):\n+                raise GeneralRepoException(\"GPG verfication failed: {}\".format(release_file))\n+            try:\n+                with open(release_file, \"rb\") as f:\n+                    self._release = self._parse_release_index(f.read().decode(\"utf-8\"))\n+            except IOError:\n+                raise GeneralRepoException(\"IOError while accessing file: {}\".format(release_file))\n+\n+        # Repo format is flat\n+        if self.is_flat():", "originalCommit": "0c767034a3587ce4b603896294cb6102e9f978ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "322586e223392205ff03e0aac28d03683fbe257d", "url": "https://github.com/uyuni-project/uyuni/commit/322586e223392205ff03e0aac28d03683fbe257d", "message": "Better if-else flow\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>", "committedDate": "2020-10-22T08:52:25Z", "type": "commit"}, {"oid": "95984f164675cf7851477ab615534f5b5420892c", "url": "https://github.com/uyuni-project/uyuni/commit/95984f164675cf7851477ab615534f5b5420892c", "message": "Adds test for local file repos", "committedDate": "2020-10-26T09:22:13Z", "type": "commit"}, {"oid": "f9fe32da3ca07e1c425ea3ebe1d939a6aa5cf334", "url": "https://github.com/uyuni-project/uyuni/commit/f9fe32da3ca07e1c425ea3ebe1d939a6aa5cf334", "message": "Removed error handling\n\nSince there is no logging currently error catching was removed. This has\nto fail, so that the user has a chance to see what's going on.", "committedDate": "2020-10-26T09:24:40Z", "type": "commit"}, {"oid": "b808660dc4231e58cbd634ae2d972ff5b62610dc", "url": "https://github.com/uyuni-project/uyuni/commit/b808660dc4231e58cbd634ae2d972ff5b62610dc", "message": "Adds changelog entry", "committedDate": "2020-10-26T13:49:22Z", "type": "commit"}, {"oid": "0bf35e2769da3389307c39484179d5cb92426d5b", "url": "https://github.com/uyuni-project/uyuni/commit/0bf35e2769da3389307c39484179d5cb92426d5b", "message": "Merge remote-tracking branch 'uyuni/master' into uyuni-master-local-file-for-requests", "committedDate": "2020-10-27T15:17:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzMzcyOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512833729", "bodyText": "Could we do the actual logging instead of having this TODO here?", "author": "meaksh", "createdAt": "2020-10-27T16:17:35Z", "path": "backend/common/repo.py", "diffHunk": "@@ -110,11 +110,17 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n         if self._pkg_index[0] == \"\":\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n-                resp = requests.get(packages_url, proxies=self.proxies)\n-                if resp.status_code == http.HTTPStatus.OK:\n-                    self._pkg_index = cnt_fname, resp.content\n-                    break\n-                resp.close()\n+                if packages_url.startswith(\"file://\"):\n+                    with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                        self._pkg_index = cnt_fname, f.read()\n+                        break\n+                    # TODO: Add logging in error case!", "originalCommit": "0bf35e2769da3389307c39484179d5cb92426d5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MjEzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512842139", "bodyText": "There is no logging at all. I'd rather do a second PR to introduce logging. Actually we need logging for several more cases here.", "author": "brejoc", "createdAt": "2020-10-27T16:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzMzcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzNTg4MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512835880", "bodyText": "We don't want to introduce this \ud83d\ude04\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            >>>>>>> uyuni/master", "author": "meaksh", "createdAt": "2020-10-27T16:20:20Z", "path": "backend/spacewalk-backend.changes", "diffHunk": "@@ -11,6 +12,7 @@ Fri Sep 18 12:13:40 CEST 2020 - jgonzalez@suse.com\n \n - version 4.2.1-1\n - Only regenerate bootstrap repositories when linking new packages (bsc#1174636)\n+>>>>>>> uyuni/master", "originalCommit": "0bf35e2769da3389307c39484179d5cb92426d5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MjMyMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2519#discussion_r512842320", "bodyText": "Outch! Thx!", "author": "brejoc", "createdAt": "2020-10-27T16:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzNTg4MA=="}], "type": "inlineReview"}, {"oid": "4b5fabb9249264aea01bb2cb8fc5183d834440df", "url": "https://github.com/uyuni-project/uyuni/commit/4b5fabb9249264aea01bb2cb8fc5183d834440df", "message": "Update backend/spacewalk-backend.changes\n\nCo-authored-by: Pablo Su\u00e1rez Hern\u00e1ndez <psuarezhernandez@suse.com>", "committedDate": "2020-10-27T16:26:26Z", "type": "commit"}]}