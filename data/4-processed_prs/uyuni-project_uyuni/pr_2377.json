{"pr_number": 2377, "pr_title": "Fix CentOS systems detection at bootstrap to properly set the bootstrap repo (bsc#1173556)", "pr_createdAt": "2020-07-01T12:07:04Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2377", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320127", "bodyText": "Does $FETCH print any value on screen?\nNot sure if you need &> /dev/null", "author": "juliogonzalez", "createdAt": "2020-07-01T12:12:29Z", "path": "spacewalk/certs-tools/rhn_bootstrap_strings.py", "diffHunk": "@@ -406,6 +406,11 @@ def getRegistrationStackSh(saltEnabled):\n     CLIENT_REPO_NAME=\"susemanager:bootstrap\"\n     CLIENT_REPO_FILE=\"/etc/yum.repos.d/$CLIENT_REPO_NAME.repo\"\n \n+    # In case of CentOS, check is centos bootstrap repository is available, if not, failback to res.\n+    if [[ \"$Y_CLIENT_CODE_BASE\" == centos && ! `$FETCH $CLIENT_REPO_URL/repodata/repomd.xml` ]]; then", "originalCommit": "927411aa2403ee1f118eb032345910529c897b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyOTA4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448329084", "bodyText": "The $FETCH is wrapping curl or wget with silent options: i.a. curl -ksSOf.\nThe only output we would see, in case the \"centos\" repo is not available would be something like this:\nhttps://my-suma-server/pub/repositories/centos/6/bootstrap/repodata/repomd.xml:\n2020-07-01 13:27:35 ERROR 404: Not Found.\n\nThen you will see yum trying to use the \"res\" repository.", "author": "meaksh", "createdAt": "2020-07-01T12:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMTExNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448331117", "bodyText": "Do we really want to show it if anyway the RES repo is going to be used?\nI think users can be alarmed if we they that.", "author": "juliogonzalez", "createdAt": "2020-07-01T12:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMjg1OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448332859", "bodyText": "If I may suggest a change:\nif [[ \"$Y_CLIENT_CODE_BASE\" == centos && ! `$FETCH $CLIENT_REPO_URL/repodata/repomd.xml &> /dev/null` ]]; then\n    echo \"CentOS${{Y_CLIENT_CODE_VERSION}} bootstrap repository not found, using RES${{Y_CLIENT_CODE_VERSION}} bootstrap repository instead\"\n    CLIENT_REPO_URL=\"${{CLIENT_REPOS_ROOT}}/res/${{Y_CLIENT_CODE_VERSION}}/bootstrap\"\nfi", "author": "juliogonzalez", "createdAt": "2020-07-01T12:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM0MDc3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448340778", "bodyText": "Do we really want to show it if anyway the RES repo is going to be used?\nI think users can be alarmed if we they that.\n\nThe only possible output from curl, when the \"centos\" repo does not exist, would be only showing \"centos\" and never mentining \"res\" (since curl always and only fetchs the \"centos\" repo).\nSo piping \"curl\" output to /dev/null here is not really helpful. Actually, I think it makes sense to keep the possible output so the users knows the bootstrap script initially tries to use the \"centos\" repos and then it goes with the \"res\" one, and not doing the magic completely silently.", "author": "meaksh", "createdAt": "2020-07-01T12:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM0ODAyMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448348021", "bodyText": "Ok. I didn't notice the echo you suggested! You're right. Changes are now pushed \ud83d\udc4d", "author": "meaksh", "createdAt": "2020-07-01T13:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDM3MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320370", "bodyText": "901? :-?", "author": "juliogonzalez", "createdAt": "2020-07-01T12:13:01Z", "path": "susemanager-utils/susemanager-sls/salt/bootstrap/init.sls", "diffHunk": "@@ -26,14 +26,31 @@ mgr_server_localhost_alias_absent:\n {%- else %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/' ~ os_base ~ '/' ~ grains['osrelease'] ~ '/0/bootstrap/' %}\n {%- endif %}\n+\n {%- elif grains['os_family'] == 'RedHat' %}\n-{%- if salt['file.file_exists' ]('/etc/oracle-release') %}\n+{%- if salt['file.file_exists']('/etc/oracle-release') %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/oracle/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n-{%- elif salt['file.file_exists' ]('/etc/redhat-release') %}\n+\n+{%- elif salt['file.file_exists']('/usr/share/doc/sles_es-release') %}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/res/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+\n+{%- elif salt['file.file_exists']('/etc/centos-release') %}\n+{# We try CentOS bootstrap repository first. Failback to RES #}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/centos/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+{% set bootstrap_repo_request = salt['http.query'](bootstrap_repo_url + 'repodata/repomd.xml', status=True, verify_ssl=False) %}\n+{%- if bootstrap_repo_request['status'] == 901 %}", "originalCommit": "927411aa2403ee1f118eb032345910529c897b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNTMxMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448325311", "bodyText": "Special SSL error. TLS 1.2 not available ... you know this beast :-)", "author": "mcalmer", "createdAt": "2020-07-01T12:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMDAzNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448330035", "bodyText": "This same code is reused in this SLS file. It actually fixes some scenario we already got a bug report.\nI think the status 901 is expected in cases you have a captive portal or something like that.", "author": "meaksh", "createdAt": "2020-07-01T12:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMDg0Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448330846", "bodyText": "ACK :-)", "author": "juliogonzalez", "createdAt": "2020-07-01T12:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDg2Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448320863", "bodyText": "This is so you can follow redirects? But if so, how do you know the target of a redirect is valid?", "author": "juliogonzalez", "createdAt": "2020-07-01T12:14:06Z", "path": "susemanager-utils/susemanager-sls/salt/bootstrap/init.sls", "diffHunk": "@@ -26,14 +26,31 @@ mgr_server_localhost_alias_absent:\n {%- else %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/' ~ os_base ~ '/' ~ grains['osrelease'] ~ '/0/bootstrap/' %}\n {%- endif %}\n+\n {%- elif grains['os_family'] == 'RedHat' %}\n-{%- if salt['file.file_exists' ]('/etc/oracle-release') %}\n+{%- if salt['file.file_exists']('/etc/oracle-release') %}\n {% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/oracle/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n-{%- elif salt['file.file_exists' ]('/etc/redhat-release') %}\n+\n+{%- elif salt['file.file_exists']('/usr/share/doc/sles_es-release') %}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/res/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+\n+{%- elif salt['file.file_exists']('/etc/centos-release') %}\n+{# We try CentOS bootstrap repository first. Failback to RES #}\n+{% set bootstrap_repo_url = 'https://' ~ salt['pillar.get']('mgr_server') ~ '/pub/repositories/centos/' ~ grains['osmajorrelease'] ~ '/bootstrap/' %}\n+{% set bootstrap_repo_request = salt['http.query'](bootstrap_repo_url + 'repodata/repomd.xml', status=True, verify_ssl=False) %}\n+{%- if bootstrap_repo_request['status'] == 901 %}\n+{{ raise(bootstrap_repo_request['error']) }}\n+{%- elif not (0 < bootstrap_repo_request['status'] < 300) %}", "originalCommit": "927411aa2403ee1f118eb032345910529c897b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNTAwNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448325007", "bodyText": "redirects are 301 or 302. So this is mainly checking 200 codes which are success codes", "author": "mcalmer", "createdAt": "2020-07-01T12:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMDUyOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448330528", "bodyText": "Same as above. I'm reusing the same code/logic we already have in this SLS file. We do the same with whatever bootstrap repo we set.", "author": "meaksh", "createdAt": "2020-07-01T12:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMDY4MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448330681", "bodyText": "$me stupid: < 300", "author": "juliogonzalez", "createdAt": "2020-07-01T12:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNDIwNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448324204", "bodyText": "failback does not exist. I think you mean fallback.\nThis exists also in some comments in the code.", "author": "mcalmer", "createdAt": "2020-07-01T12:20:45Z", "path": "spacewalk/certs-tools/spacewalk-certs-tools.changes", "diffHunk": "@@ -1,3 +1,5 @@\n+- Use RES bootstrap repository as failback repo when bootstrapping CentOS (bsc#1173556)", "originalCommit": "927411aa2403ee1f118eb032345910529c897b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzNjIyOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2377#discussion_r448336228", "bodyText": "Thanks for the comment! I'll fix this and double check the code comments as well", "author": "meaksh", "createdAt": "2020-07-01T12:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNDIwNA=="}], "type": "inlineReview"}, {"oid": "04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "url": "https://github.com/uyuni-project/uyuni/commit/04397a55aadeade7ab2d1d591c8a1d8cd35bdc33", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo", "committedDate": "2020-07-01T13:03:01Z", "type": "forcePushed"}, {"oid": "1f52bacc90c4f58c2922949177a515981f97df10", "url": "https://github.com/uyuni-project/uyuni/commit/1f52bacc90c4f58c2922949177a515981f97df10", "message": "Fix detection of CentOS systems to properly set bootstrap repo (bsc#1173556)", "committedDate": "2020-07-01T13:53:52Z", "type": "commit"}, {"oid": "41ab2a5d88806d3a00f72f6810fd26ad73e7a6c8", "url": "https://github.com/uyuni-project/uyuni/commit/41ab2a5d88806d3a00f72f6810fd26ad73e7a6c8", "message": "Update changelog for susemanager-sls", "committedDate": "2020-07-01T13:54:13Z", "type": "commit"}, {"oid": "928864cfa7e8f93f6e89f09525394309b6a00ab2", "url": "https://github.com/uyuni-project/uyuni/commit/928864cfa7e8f93f6e89f09525394309b6a00ab2", "message": "Add SLES_ES case to calculate bootstrap repo on boostrap SLS", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "1afb128a38b9d4cdfc39c6bb9feddbd007d4946d", "url": "https://github.com/uyuni-project/uyuni/commit/1afb128a38b9d4cdfc39c6bb9feddbd007d4946d", "message": "Remove unnecessary whitespaces", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "46f89b9113d9529df74158df1979d45b78284547", "url": "https://github.com/uyuni-project/uyuni/commit/46f89b9113d9529df74158df1979d45b78284547", "message": "Use RES bootstrap repository as failback repo when bootstrapping for CentOS (bsc#1173556)", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "7773fe5ce394fa7235db39e15052b381ce7723e7", "url": "https://github.com/uyuni-project/uyuni/commit/7773fe5ce394fa7235db39e15052b381ce7723e7", "message": "Update changelog for spacewalk-certs-tools", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "979be723d300c3e60434b5fbea210b840040137c", "url": "https://github.com/uyuni-project/uyuni/commit/979be723d300c3e60434b5fbea210b840040137c", "message": "Fix typo on comments and changelog", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "07291ef9589b79002a0776b45b51a3ec956dafc2", "url": "https://github.com/uyuni-project/uyuni/commit/07291ef9589b79002a0776b45b51a3ec956dafc2", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo", "committedDate": "2020-07-01T13:54:16Z", "type": "commit"}, {"oid": "07291ef9589b79002a0776b45b51a3ec956dafc2", "url": "https://github.com/uyuni-project/uyuni/commit/07291ef9589b79002a0776b45b51a3ec956dafc2", "message": "Use more friendly message when switching from CentOS to RES bootstrap repo", "committedDate": "2020-07-01T13:54:16Z", "type": "forcePushed"}, {"oid": "7d363b5c67221e73952775a8f46e388d1a3b7c90", "url": "https://github.com/uyuni-project/uyuni/commit/7d363b5c67221e73952775a8f46e388d1a3b7c90", "message": "Fix typo", "committedDate": "2020-07-01T13:55:49Z", "type": "commit"}]}