{"pr_number": 2100, "pr_title": "Testsuite - traditional clients bootstrapped by script", "pr_createdAt": "2020-04-06T12:57:25Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2100", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404181683", "bodyText": "Given that we are bootstrapping using the script, so not using the WebUI.\nIt would be awesome if we can stay like that during the whole scenario.\nWhat about check it using Then I should see \"sle_client\" in spacewalk as it was before?\nWe will also rid of the step of log in, which it use to be slow.", "author": "srbarrios", "createdAt": "2020-04-06T15:27:46Z", "path": "testsuite/features/init_clients/sle_client.feature", "diffHunk": "@@ -3,12 +3,13 @@\n \n Feature: Register a traditional client\n   In order to register a traditional client to the SUSE Manager server\n-  As the root user\n-  I want to call rhnreg_ks\n+  I want to create, parametrize and run boostrap script from proxy\n \n   Scenario: Register a traditional client\n-    When I register using \"1-SUSE-DEV-x86_64\" key\n-    Then I should see \"sle_client\" in spacewalk\n+    Given I am authorized\n+    When I bootstrap traditional client \"sle_client\" using bootstrap script with activation key \"1-SUSE-DEV-x86_64\" from the proxy\n+    And I follow the left menu \"Systems > Overview\"\n+    And I wait until I see the name of \"sle_client\", refreshing the page", "originalCommit": "35e738c9f7162e9f4f49d2fefd542e610731fd5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5MjkzOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404192938", "bodyText": "Isn't that exactly what I should see \"sle_client\" in spacewalk was doing?\nI think that \"in spacewalk\" is a poor way of saying \"in the web UI\".\nI did not check, I'm just guessing here.", "author": "Bischoff", "createdAt": "2020-04-06T15:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5MDI3OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404590279", "bodyText": "@Bischoff @srbarrios Good point, I moved away from I should see \"sle_client\" in spacewalk during some debuging phase, but it shouldn't get to the final code.\nI looked into code definition for this step and we are still in web UI:\nThen(/^I should see \"([^\"]*)\" in spacewalk$/) do |host|\n  steps %(\n    Given I am on the Systems page\n    Then I should see \"#{host}\" as link\n    )\nend\n\nBut I like the idea of staying in the CLI only. I will prepare solution with spacecmd command. According to my experience it could buy us a lot of time.", "author": "lkotek", "createdAt": "2020-04-07T07:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMjI1Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404612257", "bodyText": "Prepared, I am testing it now.\n\nBut I like the idea of staying in the CLI only. I will prepare solution with spacecmd\ncommand. According to my experience it could buy us a lot of time.\n\nSo the gain is 26 seconds (44 vs. 70 seconds) :-)", "author": "lkotek", "createdAt": "2020-04-07T08:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyNjI4OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404626288", "bodyText": "Cool. But I would suggest to go further and take profit of those changes to change in spacewalk with something else, or just remove it.\nRationale:\n\nof course it's spacewalk, we're not speaking about Microsoft Office \ud83d\ude04\nis it spacewalk, after all? Current name is Uyuni or SUSE Manager\nit's ultimately irrelevant, what is meant is \"in the UI\"\n\nI suggest to completely remove these two words, or replace them with something that makes sense, not forgetting the documentation.", "author": "Bischoff", "createdAt": "2020-04-07T08:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MDYwMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404640602", "bodyText": "@Bischoff It makes sense \ud83d\ude04  OK, so what about following suggestion?\nI should see \"([^\"]*)\" via spacecmd$\nWe already used similar naming in the past, for example:\nAnd I wait until package \"virgo-dummy\" is installed on \"ubuntu_ssh_minion\" via spacecmd", "author": "lkotek", "createdAt": "2020-04-07T08:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTUxMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404665511", "bodyText": "Absolutely.", "author": "Bischoff", "createdAt": "2020-04-07T09:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2OTU2Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404669567", "bodyText": "Perfect, let's prepare it :-)", "author": "lkotek", "createdAt": "2020-04-07T09:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDA3NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404194075", "bodyText": "If we remove I should see \"sle_client\" in spacewalkeverywhere, then maybe we should also remove it from the step definitions?", "author": "Bischoff", "createdAt": "2020-04-06T15:44:07Z", "path": "testsuite/features/secondary/trad_baremetal_discovery.feature", "diffHunk": "@@ -23,8 +23,10 @@ Feature: Bare metal discovery\n     And the PXE default profile should be enabled\n \n   Scenario: Register a client for bare metal discovery\n-    When I register using \"1-spacewalk-bootstrap-activation-key\" key\n-    Then I should see \"sle_client\" in spacewalk\n+    Given I am authorized as \"admin\" with password \"admin\"\n+    When I bootstrap traditional client \"sle_client\" using bootstrap script with activation key \"1-spacewalk-bootstrap-activation-key\" from the proxy", "originalCommit": "35e738c9f7162e9f4f49d2fefd542e610731fd5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5MDUyMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404590522", "bodyText": "Let's check :-)", "author": "lkotek", "createdAt": "2020-04-07T07:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMjA2Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404612062", "bodyText": "I replaced this step definition with solution suing spacecmd command instead.", "author": "lkotek", "createdAt": "2020-04-07T07:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyMjMxNA==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404622314", "bodyText": "Thanks", "author": "Bischoff", "createdAt": "2020-04-07T08:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDczNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404194735", "bodyText": "concatenate all these commands into one string and then run it only once (performance)", "author": "Bischoff", "createdAt": "2020-04-06T15:44:56Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -643,6 +643,26 @@\n   $server.run(\"salt-key -y --accept=pxeboot.example.org\")\n end\n \n+When(/^I bootstrap traditional client \"([^\"]*)\" using bootstrap script with activation key \"([^\"]*)\" from the proxy$/) do |host, key|\n+  # Preparation of bootstrap script for traditional client\n+  $proxy.run('mgr-bootstrap --traditional')\n+  $proxy.run('sed -i s\\'/^exit 1//\\' /srv/www/htdocs/pub/bootstrap/bootstrap.sh')\n+  $proxy.run(\"sed -i '/^ACTIVATION_KEYS=/c\\\\ACTIVATION_KEYS=#{key}' /srv/www/htdocs/pub/bootstrap/bootstrap.sh\")\n+  $proxy.run('chmod 644 /srv/www/htdocs/pub/RHN-ORG-TRUSTED-SSL-CERT')\n+  $proxy.run(\"sed -i '/^ORG_GPG_KEY=/c\\\\ORG_GPG_KEY=RHN-ORG-TRUSTED-SSL-CERT' /srv/www/htdocs/pub/bootstrap/bootstrap.sh\")\n+  output, code = $proxy.run('cat /srv/www/htdocs/pub/bootstrap/bootstrap.sh')", "originalCommit": "35e738c9f7162e9f4f49d2fefd542e610731fd5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5MDk2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404590969", "bodyText": "I agree I will prepare the change.", "author": "lkotek", "createdAt": "2020-04-07T07:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxMTQ4Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404611482", "bodyText": "Done.", "author": "lkotek", "createdAt": "2020-04-07T07:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyMTk5MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2100#discussion_r404621990", "bodyText": "Thank you", "author": "Bischoff", "createdAt": "2020-04-07T08:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE5NDczNQ=="}], "type": "inlineReview"}, {"oid": "ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "url": "https://github.com/uyuni-project/uyuni/commit/ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "message": "traditional clients bootstrapped by script", "committedDate": "2020-04-07T13:04:52Z", "type": "commit"}, {"oid": "ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "url": "https://github.com/uyuni-project/uyuni/commit/ca8bb75bc1119e3bafdd1d9e21d4aff380de9f22", "message": "traditional clients bootstrapped by script", "committedDate": "2020-04-07T13:04:52Z", "type": "forcePushed"}]}