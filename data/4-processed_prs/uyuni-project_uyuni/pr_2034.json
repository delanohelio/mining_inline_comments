{"pr_number": 2034, "pr_title": "Refactoring the validation of a package installed", "pr_createdAt": "2020-03-19T15:18:15Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2034", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzNzYwMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395137601", "bodyText": "If the command returns nonzero status, then there is no such a process running (thus we are all set):\nbreak if code.zero? -> break unless code.zero?", "author": "calancha", "createdAt": "2020-03-19T16:00:35Z", "path": "testsuite/features/support/lavanda.rb", "diffHunk": "@@ -65,4 +65,14 @@ def run_until_fail(cmd)\n       result\n     end\n   end\n+\n+  def wait_while_process_running(process)\n+    result = nil\n+    repeat_until_timeout(report_result: true) do\n+      result, code = run(\"pgrep -x #{process} >/dev/null\", false)\n+      break if code.zero?", "originalCommit": "9f0d5922c229218f5112b3b99f5c5f02998d64f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1NjU2NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395156565", "bodyText": "Right, my bad, thank you!", "author": "srbarrios", "createdAt": "2020-03-19T16:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzNzYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzODI5OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395138299", "bodyText": "Rather \"When\" (there's no \"should\" in step title, it's rather an action than a test...)", "author": "Bischoff", "createdAt": "2020-03-19T16:01:30Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|", "originalCommit": "9f0d5922c229218f5112b3b99f5c5f02998d64f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139208", "bodyText": "OK we go that way. Fine.", "author": "Bischoff", "createdAt": "2020-03-19T16:02:47Z", "path": "testsuite/features/step_definitions/command_steps.rb", "diffHunk": "@@ -60,6 +60,31 @@\n   node.run(\"rpm -q #{package}; test $? -ne 0\")\n end\n \n+Then(/^I wait for \"([^\"]*)\" to be (uninstalled|installed) on \"([^\"]*)\"$/) do |package, status, host|\n+  if package.include?(\"suma\") && $product == \"Uyuni\"\n+    package.gsub! \"suma\", \"uyuni\"\n+  end\n+  node = get_target(host)\n+  if host.include? 'ubuntu'\n+    node.wait_while_process_running('apt-get')\n+    pkg_version = package.split('-')[-1]\n+    pkg_name = package.delete_suffix(\"-#{pkg_version}\")\n+    pkg_version_regexp = pkg_version.gsub('.', '\\\\.')\n+    if status == 'installed'\n+      node.run_until_ok(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    else\n+      node.run_until_fail(\"dpkg -l | grep -E '^ii +#{pkg_name} +#{pkg_version_regexp} +'\")\n+    end\n+  else\n+    node.wait_while_process_running('zypper')", "originalCommit": "9f0d5922c229218f5112b3b99f5c5f02998d64f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE0OTA3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395149078", "bodyText": "Yep, but just because that step is strictly related to the action of installation so the command tool to install packages.\nSo here, we want to make sure that the installation process is fully completed.\nOtherwise, yes, as we discussed... if we do that somewhere else it will hide the issue and is not what we want.", "author": "srbarrios", "createdAt": "2020-03-19T16:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1MDIzMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395150232", "bodyText": "Exactly.", "author": "Bischoff", "createdAt": "2020-03-19T16:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEzOTYxNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2034#discussion_r395139615", "bodyText": "Ooooh cool I wanted to get rid of these \"this\" for so long...", "author": "Bischoff", "createdAt": "2020-03-19T16:03:20Z", "path": "testsuite/features/secondary/min_action_chain.feature", "diffHunk": "@@ -165,7 +165,7 @@ Feature: Action chains on Salt minions\n     And I follow \"new action chain\"\n     And I click on \"Save and Schedule\"\n     Then I should see a \"Action Chain new action chain has been scheduled for execution.\" text\n-    When I wait for \"virgo-dummy\" to be installed on this \"sle_minion\"\n+    When I wait for \"virgo-dummy\" to be installed on \"sle_minion\"", "originalCommit": "9f0d5922c229218f5112b3b99f5c5f02998d64f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab3a9b2e0efef4d466a97d5204d4224c8a548271", "url": "https://github.com/uyuni-project/uyuni/commit/ab3a9b2e0efef4d466a97d5204d4224c8a548271", "message": "Refactoring the validation of a package installed", "committedDate": "2020-03-19T16:36:39Z", "type": "forcePushed"}, {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "url": "https://github.com/uyuni-project/uyuni/commit/6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "message": "Refactoring the validation of a package installed", "committedDate": "2020-03-19T16:46:33Z", "type": "commit"}, {"oid": "6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "url": "https://github.com/uyuni-project/uyuni/commit/6049c36e5196c1a290b0aeb2b7bcb158f886cc0d", "message": "Refactoring the validation of a package installed", "committedDate": "2020-03-19T16:46:33Z", "type": "forcePushed"}]}