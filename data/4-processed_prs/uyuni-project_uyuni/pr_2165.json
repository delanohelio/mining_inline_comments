{"pr_number": 2165, "pr_title": "Cucumber test for bootstrapping minion with SSH key", "pr_createdAt": "2020-04-26T07:30:41Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2165", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDI2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415304268", "bodyText": "I would prefer to have it as part of constants.rb file. But we couldn't arrive at an agreement related to constants in our squad.", "author": "srbarrios", "createdAt": "2020-04-26T12:54:07Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -1161,3 +1161,35 @@ def server_secret\n   xpath = \"//td[contains(text(), '#{action_name}')]/ancestor::tr[contains(@class, 'list-row-even')]/td/div/button/#{button}\"\n   raise \"xpath: #{xpath} not found\" unless find(:xpath, xpath).click\n end\n+\n+\n+# todo is this the right place?\n+# common constants for SSH bootstrap with SSH key auth test\n+key_filename = 'id_rsa_bootstrap-passphrase_linux.pub'\n+## authorized_keys paths on the client\n+auth_keys_path = '/root/.ssh/authorized_keys'\n+auth_keys_sav_path = '/root/.ssh/authorized_keys.sav'\n+", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDIwNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415564207", "bodyText": "I think these constants should be part of the individual step definitions:\n1 - if they were real global constants, they should start with $\n2 - they are too specific to become really global\nPlease move them into the steps. It's not a big deal if they are repeated a few times.", "author": "Bischoff", "createdAt": "2020-04-27T07:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNjk2OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415706968", "bodyText": "Moving to steps.", "author": "hustodemon", "createdAt": "2020-04-27T10:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNDI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNTA4Nw==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415305087", "bodyText": "I personally prefer to don't have calls to endpoints in out steps, I don't remember now the step, but we have another that has the same behavior without having the URI there.", "author": "srbarrios", "createdAt": "2020-04-26T12:58:14Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"linux\" as \"privKeyPwd\"\n+    And I select the hostname of \"proxy\" from \"proxies\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Successfully bootstrapped host!\" text\n+\n+  Scenario: Check new minion bootstrapped with SSH Key in System Overview page\n+    Given I am authorized\n+    When I go to the minion onboarding page\n+    Then I should see a \"accepted\" text\n+    When I navigate to \"rhn/systems/Overview.do\" page", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjAwOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415562009", "bodyText": "100 % agree, we should avoid internals in high-level cucumber text.", "author": "Bischoff", "createdAt": "2020-04-27T07:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxMzM5OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415713398", "bodyText": "Looking at the test codebase, it even seems this seems to be the way to navigate to a \"general\" page. You are right, that there is another way - it's used in docker building feature (and it's tighly related to it), but the problem is, we'd need to write extra step for each navigation target. Btw, my code was a c&p from an existing bootstrapping test. And while I also don't like having rhn/blabla/bar in the steps that much, this seems like this should be done separately as a refactoring that targets all occurences of this step: When I navigate to \"rhn/systems/Overview.do\" page.\ngit grep 'I navigate to' | grep  \"\\.do\" | wc -l\n> 22\n\ngit grep 'I navigate to' | grep -v \"\\.do\" | wc -l\n> 11", "author": "hustodemon", "createdAt": "2020-04-27T10:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMwNTA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU1ODc2Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415558762", "bodyText": "This is a separate feature, right ? Then you forgot the declarations in run_sets/*.yml.\nCopyright of 2020 only, maybe", "author": "Bischoff", "createdAt": "2020-04-27T06:58:49Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU1OTE4MQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415559181", "bodyText": "Remove \"Be able to \".\nAll product features are about being able to do something, so this does not bring information.", "author": "Bischoff", "createdAt": "2020-04-27T06:59:33Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MDUxNw==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415560517", "bodyText": "maybe \"before bootstrap with SSH key test\" to make it more obvious what bootstrap test it's about.", "author": "Bischoff", "createdAt": "2020-04-27T07:02:04Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MDkzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415560939", "bodyText": "\"SSH key\", lowercase.", "author": "Bischoff", "createdAt": "2020-04-27T07:03:01Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTI1Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415561256", "bodyText": "Do we have balrogs for our tests? ;-)", "author": "Bischoff", "createdAt": "2020-04-27T07:03:41Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNjU1NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415716554", "bodyText": "Yes, and we need to make sure they don't pass ;)", "author": "hustodemon", "createdAt": "2020-04-27T11:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTQ0Mw==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415561443", "bodyText": "\"key\", lowercase", "author": "Bischoff", "createdAt": "2020-04-27T07:04:03Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTYwNg==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415561606", "bodyText": "same", "author": "Bischoff", "createdAt": "2020-04-27T07:04:19Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"linux\" as \"privKeyPwd\"\n+    And I select the hostname of \"proxy\" from \"proxies\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Successfully bootstrapped host!\" text\n+\n+  Scenario: Check new minion bootstrapped with SSH Key in System Overview page", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjM0Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415562342", "bodyText": "\"key\", lowercase. I will stop repeating it now, but there are more.", "author": "Bischoff", "createdAt": "2020-04-27T07:05:48Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"linux\" as \"privKeyPwd\"\n+    And I select the hostname of \"proxy\" from \"proxies\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Successfully bootstrapped host!\" text\n+\n+  Scenario: Check new minion bootstrapped with SSH Key in System Overview page\n+    Given I am authorized\n+    When I go to the minion onboarding page\n+    Then I should see a \"accepted\" text\n+    When I navigate to \"rhn/systems/Overview.do\" page\n+    And I wait until I see the name of \"sle_minion\", refreshing the page\n+    And I wait until onboarding is completed for \"sle_minion\"\n+    Then the Salt master can reach \"sle_minion\"\n+\n+  Scenario: Also check contact method of this minion\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    Then I should see a \"Default\" text\n+  \n+  Scenario: Cleanup authorized keys\n+    When I restore the SSH authorized_keys file of host \"sle_minion\"\n+\n+  Scenario: Cleanup: turn the SLES minion into a container build host after bootstrap with SSH Key", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNjg1Mg==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415716852", "bodyText": "I substituted all of them using Vim's %s.", "author": "hustodemon", "createdAt": "2020-04-27T11:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MjY5OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415562699", "bodyText": "\"And\"", "author": "Bischoff", "createdAt": "2020-04-27T07:06:24Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"linux\" as \"privKeyPwd\"\n+    And I select the hostname of \"proxy\" from \"proxies\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Successfully bootstrapped host!\" text\n+\n+  Scenario: Check new minion bootstrapped with SSH Key in System Overview page\n+    Given I am authorized\n+    When I go to the minion onboarding page\n+    Then I should see a \"accepted\" text\n+    When I navigate to \"rhn/systems/Overview.do\" page\n+    And I wait until I see the name of \"sle_minion\", refreshing the page\n+    And I wait until onboarding is completed for \"sle_minion\"\n+    Then the Salt master can reach \"sle_minion\"\n+\n+  Scenario: Also check contact method of this minion\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    Then I should see a \"Default\" text\n+  \n+  Scenario: Cleanup authorized keys\n+    When I restore the SSH authorized_keys file of host \"sle_minion\"\n+\n+  Scenario: Cleanup: turn the SLES minion into a container build host after bootstrap with SSH Key\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Details\" in the content area\n+    And I follow \"Properties\" in the content area\n+    And I check \"container_build_host\"\n+    And I click on \"Update Properties\"\n+\n+  Scenario: Cleanup: turn the SLES minion into a OS image build host after bootstrap with SSH Key\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Details\" in the content area\n+    And I follow \"Properties\" in the content area\n+    And I check \"osimage_build_host\"\n+    And I click on \"Update Properties\"\n+    Then I should see a \"OS Image Build Host type has been applied.\" text\n+    And I should see a \"Note: This action will not result in state application\" text\n+    And I should see a \"To apply the state, either use the states page or run state.highstate from the command line.\" text\n+    And I should see a \"System properties changed\" text\n+\n+  Scenario: Cleanup: apply the highstate to build host after bootstrap with SSH Key\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I wait until no Salt job is running on \"sle_minion\"\n+    And I enable repositories before installing Docker\n+    And I apply highstate on \"sle_minion\"\n+    And I wait until \"docker\" service is active on \"sle_minion\"\n+    And I wait until file \"/var/lib/Kiwi/repo/rhn-org-trusted-ssl-cert-osimage-1.0-1.noarch.rpm\" exists on \"sle_minion\"\n+    And I disable repositories after installing Docker\n+\n+  Scenario: Cleanup: check that the minion is now a build host after bootstrap with SSH Key\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    Then I should see a \"[Container Build Host]\" text\n+    Then I should see a \"[OS Image Build Host]\" text", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDUwNQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415564505", "bodyText": "\"Error\", upper case", "author": "Bischoff", "createdAt": "2020-04-27T07:09:59Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -1161,3 +1161,35 @@ def server_secret\n   xpath = \"//td[contains(text(), '#{action_name}')]/ancestor::tr[contains(@class, 'list-row-even')]/td/div/button/#{button}\"\n   raise \"xpath: #{xpath} not found\" unless find(:xpath, xpath).click\n end\n+\n+\n+# todo is this the right place?\n+# common constants for SSH bootstrap with SSH key auth test\n+key_filename = 'id_rsa_bootstrap-passphrase_linux.pub'\n+## authorized_keys paths on the client\n+auth_keys_path = '/root/.ssh/authorized_keys'\n+auth_keys_sav_path = '/root/.ssh/authorized_keys.sav'\n+\n+When(/^I backup the SSH authorized_keys file of host \"([^\"]*)\"$/) do |host|\n+  target = get_target(host)\n+  _, ret_code = target.run(\"cp #{auth_keys_path} #{auth_keys_sav_path}\")\n+  raise 'error backing up authorized_keys on host' if ret_code.nonzero?", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxODc1NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415718755", "bodyText": "Ok (although it seems the upper/lowercase convention is rather random in that file :) ).", "author": "hustodemon", "createdAt": "2020-04-27T11:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDg5MA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415564890", "bodyText": "or two string interpolations with #{...}(not sure it's a good idea, feel free to ignore)", "author": "Bischoff", "createdAt": "2020-04-27T07:10:46Z", "path": "testsuite/features/step_definitions/common_steps.rb", "diffHunk": "@@ -1161,3 +1161,35 @@ def server_secret\n   xpath = \"//td[contains(text(), '#{action_name}')]/ancestor::tr[contains(@class, 'list-row-even')]/td/div/button/#{button}\"\n   raise \"xpath: #{xpath} not found\" unless find(:xpath, xpath).click\n end\n+\n+\n+# todo is this the right place?\n+# common constants for SSH bootstrap with SSH key auth test\n+key_filename = 'id_rsa_bootstrap-passphrase_linux.pub'\n+## authorized_keys paths on the client\n+auth_keys_path = '/root/.ssh/authorized_keys'\n+auth_keys_sav_path = '/root/.ssh/authorized_keys.sav'\n+\n+When(/^I backup the SSH authorized_keys file of host \"([^\"]*)\"$/) do |host|\n+  target = get_target(host)\n+  _, ret_code = target.run(\"cp #{auth_keys_path} #{auth_keys_sav_path}\")\n+  raise 'error backing up authorized_keys on host' if ret_code.nonzero?\n+end\n+\n+And(/^I add pre\\-generated SSH public key to authorized_keys of host \"([^\"]*)\"$/) do |host|\n+  target = get_target(host)\n+  ret_code = file_inject(\n+    target,\n+    File.dirname(__FILE__) + '/../upload_files/ssh_keypair/' + key_filename,", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcyMDgzMQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415720831", "bodyText": "common_steps contain every possible way to combine path now, so I'll leave this for now since it works ;) (best way would probably be File.join(File.dirname(__FILE__), 'something'), but I don't want to break already working code).", "author": "hustodemon", "createdAt": "2020-04-27T11:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc2NDgyOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415764829", "bodyText": "yes, it might be we have been creative here... \ud83d\ude0a", "author": "Bischoff", "createdAt": "2020-04-27T12:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NjExMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415566113", "bodyText": "\"Cleanup: restore authorized keys\"", "author": "Bischoff", "createdAt": "2020-04-27T07:12:59Z", "path": "testsuite/features/secondary/sle_minion_bootstrap_ssh_key.feature", "diffHunk": "@@ -0,0 +1,92 @@\n+# Copyright (c) 2016-2020 SUSE LLC\n+# Licensed under the terms of the MIT license.\n+\n+Feature: Be able to bootstrap a Salt minion via the GUI using SSH key\n+\n+  Scenario: Delete SLES minion system profile before bootstrap test\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    When I follow \"Delete System\"\n+    Then I should see a \"Confirm System Profile Deletion\" text\n+    When I click on \"Delete Profile\"\n+    And I wait until I see \"has been deleted\" text\n+    And I cleanup minion \"sle_minion\"\n+    Then \"sle_minion\" should not be registered\n+\n+  Scenario: Prepare the minion for SSH key authentication\n+    When I backup the SSH authorized_keys file of host \"sle_minion\"\n+    And I add pre-generated SSH public key to authorized_keys of host \"sle_minion\"\n+  \n+  Scenario: Bootstrap a SLES minion using SSH Key with wrong passphrase\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"you-shall-not-pass\" as \"privKeyPwd\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Permission denied, no authentication information\" text\n+\n+  Scenario: Bootstrap a SLES minion using SSH Key\n+    Given I am authorized\n+    When I go to the bootstrapping page\n+    Then I should see a \"Bootstrap Minions\" text\n+    When I enter the hostname of \"sle_minion\" as \"hostname\"\n+    And I enter \"22\" as \"port\"\n+    And I enter \"root\" as \"user\"\n+    And I check radio button \"SSH Private Key\"\n+    And I attach the file \"ssh_keypair/id_rsa_bootstrap-passphrase_linux\" to \"privKeyFile\"\n+    And I enter \"linux\" as \"privKeyPwd\"\n+    And I select the hostname of \"proxy\" from \"proxies\"\n+    And I click on \"Bootstrap\"\n+    And I wait until I see \"Successfully bootstrapped host!\" text\n+\n+  Scenario: Check new minion bootstrapped with SSH Key in System Overview page\n+    Given I am authorized\n+    When I go to the minion onboarding page\n+    Then I should see a \"accepted\" text\n+    When I navigate to \"rhn/systems/Overview.do\" page\n+    And I wait until I see the name of \"sle_minion\", refreshing the page\n+    And I wait until onboarding is completed for \"sle_minion\"\n+    Then the Salt master can reach \"sle_minion\"\n+\n+  Scenario: Also check contact method of this minion\n+    Given I am on the Systems overview page of this \"sle_minion\"\n+    Then I should see a \"Default\" text\n+  \n+  Scenario: Cleanup authorized keys", "originalCommit": "375acc5dc17a300dc0d249d2e6495c8894c5f20f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc2NTIyMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2165#discussion_r415765220", "bodyText": "thanks!", "author": "Bischoff", "createdAt": "2020-04-27T12:21:54Z", "path": "testsuite/run_sets/secondary.yml", "diffHunk": "@@ -17,6 +17,7 @@\n - features/secondary/trad_centos_client.feature\n - features/secondary/min_ubuntu_salt.feature\n - features/secondary/minssh_bootstrap_xmlrpc.feature\n+- features/secondary/min_bootstrap_ssh_key.feature", "originalCommit": "f1cd4fc677e16aeb68f63fb82702db0ecaa9f954", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aeb5f2f83e916f114dea9e8d30848ef2ac4b8406", "url": "https://github.com/uyuni-project/uyuni/commit/aeb5f2f83e916f114dea9e8d30848ef2ac4b8406", "message": "Cucumber test: Bootstrapping minions using an SSH private key", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "21aeff4ff69fd4ce9cd5c81b04e8edad1678d5b5", "url": "https://github.com/uyuni-project/uyuni/commit/21aeff4ff69fd4ce9cd5c81b04e8edad1678d5b5", "message": "Bugfix: Separate tmp key filename creation from actual file creating\n\n.. so that the clean up can be done even if the file was created by salt\nand the mode setting failed.", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "8eb783ffb65e99e739ef85f42ab92613c60bdbfe", "url": "https://github.com/uyuni-project/uyuni/commit/8eb783ffb65e99e739ef85f42ab92613c60bdbfe", "message": "Remove unnecessary check for the mode\n\nRely on exception thrown from python in case of errors.", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "04f63d18d184a25a5be5169686337833f7e4fadd", "url": "https://github.com/uyuni-project/uyuni/commit/04f63d18d184a25a5be5169686337833f7e4fadd", "message": "Minor UI: Inform the user about the temporary key file lifecycle", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "26129bfb234b3cd2df597309b27da0e533948e2c", "url": "https://github.com/uyuni-project/uyuni/commit/26129bfb234b3cd2df597309b27da0e533948e2c", "message": "Move the constants to the steps", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "fd04c2af99cbd2f402aab16cd6f8c49d8bd61db3", "url": "https://github.com/uyuni-project/uyuni/commit/fd04c2af99cbd2f402aab16cd6f8c49d8bd61db3", "message": "Copyright & include test in the runsets", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "b65503b4f87178afd1b77fc596386df41237926c", "url": "https://github.com/uyuni-project/uyuni/commit/b65503b4f87178afd1b77fc596386df41237926c", "message": "Move the test file to follow the convention", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "38b11871fb1a0aaa01de8dcbca13bd19109f2d27", "url": "https://github.com/uyuni-project/uyuni/commit/38b11871fb1a0aaa01de8dcbca13bd19109f2d27", "message": "Minor fixes in tests (upper/lowercase letters, naming)", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "a5afba060482b8294f0e96dafdc4d40d663c4d56", "url": "https://github.com/uyuni-project/uyuni/commit/a5afba060482b8294f0e96dafdc4d40d663c4d56", "message": "Make rubocop happy", "committedDate": "2020-04-29T06:11:25Z", "type": "commit"}, {"oid": "a5afba060482b8294f0e96dafdc4d40d663c4d56", "url": "https://github.com/uyuni-project/uyuni/commit/a5afba060482b8294f0e96dafdc4d40d663c4d56", "message": "Make rubocop happy", "committedDate": "2020-04-29T06:11:25Z", "type": "forcePushed"}]}