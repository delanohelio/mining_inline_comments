{"pr_number": 2789, "pr_title": "Adds some logging to the DpkgRepo class", "pr_createdAt": "2020-11-03T15:51:07Z", "pr_url": "https://github.com/uyuni-project/uyuni/pull/2789", "timeline": [{"oid": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "url": "https://github.com/uyuni-project/uyuni/commit/bfd19ac87f8c770fe135031ad71c1b3db04a0775", "message": "Adds some logging to the DpkgRepo class", "committedDate": "2020-11-03T15:47:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MTA2Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517961066", "bodyText": "[nitpick] You don't need to capture the exception here, a raise without an argument will re-raise the last exception.. So instead of doing\nexcept Exception as ex:\n    ...\n    raise ex\nyou could do\nexcept Exception:\n    ...\n    raise", "author": "agraul", "createdAt": "2020-11-05T10:53:49Z", "path": "backend/common/repo.py", "diffHunk": "@@ -111,10 +114,15 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n                 if packages_url.startswith(\"file://\"):\n-                    with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n-                        self._pkg_index = cnt_fname, f.read()\n-                        break\n-                    # TODO: Add logging in error case!\n+                    try:\n+                        with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                            self._pkg_index = cnt_fname, f.read()\n+                            break\n+                    except FileNotFoundError as ex:\n+                        logging.execption(\n+                            \"File not found: {}\".format(\n+                                packages_url.replace(\"file://\", \"\"), exc_info=True)\n+                        raise ex", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzMjE2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518132169", "bodyText": "That's true. Kind of a habit of mine. For me it increases readability. But I'm not adamant on that. How badly do you want me to change it? \ud83d\ude09", "author": "brejoc", "createdAt": "2020-11-05T15:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1OTQ4NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518159484", "bodyText": "You can keep it if you want, it's not that important :D", "author": "agraul", "createdAt": "2020-11-05T15:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MTA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MTE1OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517961158", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    logging.execption(\n          \n          \n            \n                                    logging.exception(", "author": "agraul", "createdAt": "2020-11-05T10:54:02Z", "path": "backend/common/repo.py", "diffHunk": "@@ -111,10 +114,15 @@ def get_pkg_index_raw(self) -> typing.Tuple[str, bytes]:\n             for cnt_fname in [DpkgRepo.PKG_GZ, DpkgRepo.PKG_XZ, DpkgRepo.PKG_RW]:\n                 packages_url = self.append_index_file(cnt_fname)\n                 if packages_url.startswith(\"file://\"):\n-                    with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n-                        self._pkg_index = cnt_fname, f.read()\n-                        break\n-                    # TODO: Add logging in error case!\n+                    try:\n+                        with open(packages_url.replace(\"file://\", \"\"), \"rb\") as f:\n+                            self._pkg_index = cnt_fname, f.read()\n+                            break\n+                    except FileNotFoundError as ex:\n+                        logging.execption(", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA5ODY0NQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518098645", "bodyText": "Ouch! Thanks!", "author": "brejoc", "createdAt": "2020-11-05T14:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MTE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2Mjg1Ng==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517962856", "bodyText": "Shouldn't this be a logging.error() since there is no exception at this point? The exception will come later and logging it can be done when handling the exception.", "author": "agraul", "createdAt": "2020-11-05T10:57:01Z", "path": "backend/common/repo.py", "diffHunk": "@@ -292,11 +309,15 @@ def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntr\n         # Repo format is not flat\n         if not self.is_flat():\n             if self.gpg_verify and not self._has_valid_gpg_signature(local_path):\n+                logging.exception(\"GPG verfication failed: {}\".format(release_file), exc_info=True)", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDAzMA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517964030", "bodyText": "For consistency with the other messages about raising an exception (btw, do we actually win anything by logging that we are about to raise an exception? Isn't the exception handling logging enough to tell us we got one?), this should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logging.error(\"GeneralRepoException will be raised!\")\n          \n          \n            \n                            logging.error(\"Raising GeneralRepoException!\")", "author": "agraul", "createdAt": "2020-11-05T10:58:56Z", "path": "backend/common/repo.py", "diffHunk": "@@ -292,11 +309,15 @@ def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntr\n         # Repo format is not flat\n         if not self.is_flat():\n             if self.gpg_verify and not self._has_valid_gpg_signature(local_path):\n+                logging.exception(\"GPG verfication failed: {}\".format(release_file), exc_info=True)\n+                logging.error(\"GeneralRepoException will be raised!\")", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEwMzcwOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518103709", "bodyText": "The thing is, we are raising an other error than we are catching and logging. If the user is looking into the logs, they can only guess what lead to the GeneralRepoException if it isn't actually standing there.", "author": "brejoc", "createdAt": "2020-11-05T14:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExOTE5NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518119194", "bodyText": "Can't we use raise X from Y for that?", "author": "agraul", "createdAt": "2020-11-05T15:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc2MzQyMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518763423", "bodyText": "Yeah, that would indeed be more clean, but I think it wouldn't change anything for the logging, right?", "author": "brejoc", "createdAt": "2020-11-06T13:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzOTAwMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518839002", "bodyText": "That depends on how we handle the new exception. In this case though, it seems that there is no other exception -- this code is not in an exception handling path as far as I can see.", "author": "agraul", "createdAt": "2020-11-06T15:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDQ3OA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517964478", "bodyText": "Shouldn't this be logging.error() again?", "author": "agraul", "createdAt": "2020-11-05T10:59:42Z", "path": "backend/common/repo.py", "diffHunk": "@@ -306,31 +327,40 @@ def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntr\n             elif os.access(self._get_parent_url(local_path, 0, \"Release\"), os.R_OK):\n                 release_file = self._get_parent_url(local_path, 0, \"Release\")\n             else:\n+                logging.exception(\"No release file found in '{}'. Raising \\", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEwNDYzOQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518104639", "bodyText": "No, this is logging.exception, since it is also printing the stack trace.", "author": "brejoc", "createdAt": "2020-11-05T14:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNDU0OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518114549", "bodyText": "I came across this because the logging.exception documentation says not to use it outside of exception handling.\nI don't understand why we need to log the stack trace here and not where we handle the exception.", "author": "agraul", "createdAt": "2020-11-05T14:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1NjY0OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518156649", "bodyText": "Forget it. Must have been a copy&paste error and I didn't notice. Sorry!", "author": "brejoc", "createdAt": "2020-11-05T15:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDczMw==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517964733", "bodyText": "This one as well (logging.error())", "author": "agraul", "createdAt": "2020-11-05T11:00:06Z", "path": "backend/common/repo.py", "diffHunk": "@@ -306,31 +327,40 @@ def _get_release_index_from_file(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntr\n             elif os.access(self._get_parent_url(local_path, 0, \"Release\"), os.R_OK):\n                 release_file = self._get_parent_url(local_path, 0, \"Release\")\n             else:\n+                logging.exception(\"No release file found in '{}'. Raising \\\n+                                   GeneralRepoException.\".format(self._get_parent_url(local_path, 0)), exc_info=True)\n                 raise GeneralRepoException(\"No release file found in {}\".format(self._get_parent_url(local_path, 0)))\n \n             try:\n                 with open(release_file, \"rb\") as f:\n                     release_file_content = f.read().decode(\"utf-8\")\n                     if self.gpg_verify and not self._has_valid_gpg_signature(local_path):\n+                        logging.exception(\"GPG verfication failed: '{}'. \\", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEwNTEzOA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518105138", "bodyText": "Same as above. Also logs the stack trace.", "author": "brejoc", "createdAt": "2020-11-05T14:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NTc0NA==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r517965744", "bodyText": "Would it make sense to also include the actual problem in the exception that is raised? So instead of only saying \"GPG verification failed\", we could also say why it failed.", "author": "agraul", "createdAt": "2020-11-05T11:01:54Z", "path": "backend/common/repo.py", "diffHunk": "@@ -339,6 +369,7 @@ def _get_release_index_from_http(self) -> typing.Dict[str, \"DpkgRepo.ReleaseEntr\n             self._flat_checked = 1\n \n             if not self.is_flat() and self.gpg_verify and not self._has_valid_gpg_signature(resp.url, resp):\n+                logging.error(\"Repo has no valid GPG signature. Raising GeneralRepoException.\")\n                 raise GeneralRepoException(\"GPG verfication failed: {}\".format(resp.url))", "originalCommit": "bfd19ac87f8c770fe135031ad71c1b3db04a0775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExMDMwMg==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518110302", "bodyText": "Exceptions were already logged. But I've just added logging for the gpg return code.", "author": "brejoc", "createdAt": "2020-11-05T14:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NTc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNjY2OQ==", "url": "https://github.com/uyuni-project/uyuni/pull/2789#discussion_r518116669", "bodyText": "Yes, they were logged but did not offer help to what is broken. You could not look at the log and know why \"GPG verification failed\". I wonder why we don't pass that information to the exception, wouldn't it show up with the current logging we already do that way?", "author": "agraul", "createdAt": "2020-11-05T15:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NTc0NA=="}], "type": "inlineReview"}, {"oid": "3192dde069ba601bf69053de928de8427dff795e", "url": "https://github.com/uyuni-project/uyuni/commit/3192dde069ba601bf69053de928de8427dff795e", "message": "Adds missing parenthesis", "committedDate": "2020-11-05T14:31:58Z", "type": "commit"}, {"oid": "57187686ea56e48a9970e23ff0b5c995905c3cd0", "url": "https://github.com/uyuni-project/uyuni/commit/57187686ea56e48a9970e23ff0b5c995905c3cd0", "message": "Adds changelog entry", "committedDate": "2020-11-05T14:34:51Z", "type": "commit"}, {"oid": "9ea4fb726c167ec0d3349c5f5f776621d6b7ac7d", "url": "https://github.com/uyuni-project/uyuni/commit/9ea4fb726c167ec0d3349c5f5f776621d6b7ac7d", "message": "Fix for typo execption vs exception\n\nCo-authored-by: Alexander Graul <agraul@suse.com>", "committedDate": "2020-11-05T14:37:36Z", "type": "commit"}, {"oid": "61e0aebc233b580ca37cf27e2579ee7a8460df6c", "url": "https://github.com/uyuni-project/uyuni/commit/61e0aebc233b580ca37cf27e2579ee7a8460df6c", "message": "Wording of logging message\n\nCo-authored-by: Alexander Graul <agraul@suse.com>", "committedDate": "2020-11-05T14:43:56Z", "type": "commit"}, {"oid": "ab714d3f53a49d10bfac51ef684ed37a1293c1dd", "url": "https://github.com/uyuni-project/uyuni/commit/ab714d3f53a49d10bfac51ef684ed37a1293c1dd", "message": "Adds success and failure logging for _has_valid_gpg_signature", "committedDate": "2020-11-05T14:51:12Z", "type": "commit"}, {"oid": "d450efccf6ef143f9f0bd52c394dd0dc7ee7b38e", "url": "https://github.com/uyuni-project/uyuni/commit/d450efccf6ef143f9f0bd52c394dd0dc7ee7b38e", "message": "Adds raise from and fixes usage of exception logging", "committedDate": "2020-11-09T18:48:15Z", "type": "commit"}, {"oid": "fc0175dd94f17607451d4ba7d64999f25775ce77", "url": "https://github.com/uyuni-project/uyuni/commit/fc0175dd94f17607451d4ba7d64999f25775ce77", "message": "Merge remote-tracking branch 'uyuni/master' into uyuni-master-logging-for-repo-py", "committedDate": "2020-12-07T15:04:41Z", "type": "commit"}]}