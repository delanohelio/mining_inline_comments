{"pr_number": 2205, "pr_title": "Adding Crosslink redirect for API reference document", "pr_createdAt": "2020-12-16T06:40:24Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2205", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5OTk0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2205#discussion_r544799945", "bodyText": "Are templatePath and outputPath always supposed to reference files, rather than a directory path?\nIf so\n\nCould there be more natural defaults than ./ or /?\nIt'd be nice if the names of these two arguments differed from the previous, to distinguish their type", "author": "cenedhryn", "createdAt": "2020-12-17T04:16:33Z", "path": "scripts/doc_crosslinks/generate_cross_link_data.py", "diffHunk": "@@ -0,0 +1,120 @@\n+import os\n+import argparse\n+import io\n+import codecs\n+import json\n+import re\n+# import requests\n+from os import listdir\n+from os.path import isdir, exists, join\n+from re import split\n+\n+sdks = {}\n+clientClass = {}\n+\n+def generateDocsMap(apiDefinitionsPath, apiDefinitionsRelativePath):\n+\n+    filesInDir = [f for f in listdir(apiDefinitionsPath) if isdir(join(apiDefinitionsPath, f))]\n+    for file in filesInDir :\n+        serviceJsonFileName = join(apiDefinitionsPath, join(file, apiDefinitionsRelativePath))\n+\n+        if(exists(serviceJsonFileName)) :\n+            with codecs.open(serviceJsonFileName, 'rb', 'utf-8') as api_definition:\n+                api_content = json.loads(api_definition.read())\n+                if \"uid\" in api_content[\"metadata\"].keys():\n+                    sdks[api_content[\"metadata\"][\"uid\"]] = file\n+                clientClass[api_content[\"metadata\"][\"uid\"]] = getClientClassNameFromMetadata(api_content[\"metadata\"])\n+\n+#                 # Below  code can be used for debugging  failing clients\n+#                 str  = \"https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/\"+ file +\"/\"+getClientClassNameFromMetadata(api_content[\"metadata\"])+\".html\"+\"#validateTemplate--\"\n+#                 ret = requests.head(str)\n+#                 if( ret.status_code != 200 ):\n+#                     print(str)\n+\n+    return sdks\n+\n+def splitOnWordBoundaries(toSplit) :\n+    result = toSplit\n+    result = re.sub(r'[^A-Za-z0-9]+', \" \", result)\n+    result = re.sub(r'([^a-z]{2,})v([0-9]+)', r'\\g<1> v\\g<2>' , result)\n+    result = re.sub(r'([^A-Z]{2,})V([0-9]+)', r'\\g<1> V\\g<2>', result)\n+    result = re.sub(r'(?<=[a-z])(?=[A-Z]([a-zA-Z]|[0-9]))', r' ', result)\n+    result = re.sub(r'([A-Z]+)([A-Z][a-z])', r'\\g<1> \\g<2>', result)\n+    result = re.sub(r'([0-9])([a-zA-Z])', r'\\g<1> \\g<2>', result)\n+    result = re.sub(r' +', ' ', result)\n+    return result.split(\" \");\n+\n+\n+def capitalize(str):\n+    if(str is None or len(str) == 0):\n+        return str\n+    strFirstCaps = str[0].title() + str[1:]\n+    return strFirstCaps\n+\n+\n+def lowerCase(str):\n+    if(str is None or len(str) == 0):\n+        return str\n+    return str.lower()\n+\n+def pascalCase(str):\n+    splits = splitOnWordBoundaries(str)\n+    modifiedStr = \"\"\n+    for i in range(0, len(splits)) :\n+        modifiedStr += capitalize(lowerCase(splits[i]))\n+    return modifiedStr\n+\n+def getClientClassNameFromMetadata(metadataNode):\n+    toSanitize = \"\"\n+    if \"serviceId\" in metadataNode.keys():\n+        toSanitize = metadataNode[\"serviceId\"]\n+    clientName = pascalCase(toSanitize)\n+    clientName =  removeLeading(clientName , \"Amazon\")\n+    clientName =  removeLeading(clientName, \"Aws\")\n+    clientName = removeTrailing(clientName, \"Service\" )\n+    return   clientName + \"Client\"\n+\n+\n+def removeLeading(str, toRemove) :\n+    if(str is None) :\n+        return str\n+    if(str.startswith(toRemove)):\n+        return str.replace(toRemove, \"\")\n+    return str\n+\n+def removeTrailing(str, toRemove) :\n+    if(str is None) :\n+        return str\n+    if(str.endswith(toRemove)):\n+        return str.replace(toRemove, \"\")\n+    return str\n+\n+def insertDocsMapToRedirect(apiDefinitionsBasePath, apiDefinitionsRelativePath, templatePath, outputPath):\n+    generateDocsMap(apiDefinitionsBasePath, apiDefinitionsRelativePath)\n+    output = \"\"\n+    with codecs.open(templatePath, 'rb', 'utf-8') as redirect_template:\n+        current_template = redirect_template.read();\n+        output = current_template.replace(\"${UID_SERVICE_MAPPING}\", json.dumps(sdks, ensure_ascii=False))\n+        output = output.replace(\"${UID_CLIENT_CLASS_MAPPING}\", json.dumps(clientClass, ensure_ascii=False))\n+    with open(outputPath, 'w') as redirect_output:\n+        redirect_output.write(output)\n+\n+def Main():\n+    parser = argparse.ArgumentParser(description=\"Generates a Cross-link redirect file.\")\n+    parser.add_argument(\"--apiDefinitionsBasePath\", action=\"store\")\n+    parser.add_argument(\"--apiDefinitionsRelativePath\", action=\"store\")\n+    parser.add_argument(\"--templatePath\", action=\"store\")\n+    parser.add_argument(\"--outputPath\", action=\"store\")\n+    \n+    args = vars( parser.parse_args() )\n+    argMap = {}\n+    argMap[ \"apiDefinitionsBasePath\" ] = args[ \"apiDefinitionsBasePath\" ] or \"./../services/\"\n+    argMap[ \"apiDefinitionsRelativePath\" ] = args[ \"apiDefinitionsRelativePath\" ] or \"/src/main/resources/codegen-resources/service-2.json\"\n+    argMap[ \"templatePath\" ] = args[ \"templatePath\" ] or \"./\"\n+    argMap[ \"outputPath\" ] = args[ \"outputPath\" ] or \"/\"", "originalCommit": "013a82fc66fbb3508fdeda8898e42ec0691e59e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5MjkyMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2205#discussion_r545292921", "bodyText": "Are templatePath and outputPath always supposed to reference files, rather than a directory path?\ntemplatePath is Directory Path and outputPath is File Path. I will rename and set defaults accordingly", "author": "joviegas", "createdAt": "2020-12-17T18:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5OTk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwMTEyNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2205#discussion_r544801125", "bodyText": "Are there any alternative folders for the source of the template html file and the output? Especially the output doesn't seem like it belongs in the scripts folder, but if there is no other logical place to put them, it may be unnecessary to create a new folder.", "author": "cenedhryn", "createdAt": "2020-12-17T04:20:24Z", "path": "buildspecs/release-javadoc.yml", "diffHunk": "@@ -22,3 +22,5 @@ phases:\n     - aws s3 sync $DOC_PATH/$RELEASE_VERSION/ $DOC_PATH/latest/ --acl=public-read --delete\n     - jar cf aws-java-sdk-v2-docs.jar -C target/site/apidocs .\n     - aws s3 cp aws-java-sdk-v2-docs.jar $DOC_PATH/ --acl=\"public-read\"\n+    - python ./scripts/doc_crosslinks/generate_cross_link_data.py --apiDefinitionsBasePath ./services/ --apiDefinitionsRelativePath src/main/resources/codegen-resources/service-2.json  --templatePath ./scripts/doc_crosslinks/crosslink_redirect.html --outputPath ./scripts/crosslink_redirect.html", "originalCommit": "013a82fc66fbb3508fdeda8898e42ec0691e59e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5NjU3OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2205#discussion_r545296578", "bodyText": "There are no alternatives fir template html.\nThe \"doc_crosslinks\" is created to make sure all the required scripts/resource can be found in a single place.\nThe processed html is copied to parent ./script folder when the script is executed as a part of build process this output file is a temp file which is immediately copied to S3 .", "author": "joviegas", "createdAt": "2020-12-17T18:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwMTEyNQ=="}], "type": "inlineReview"}, {"oid": "ea78ac294eba941e8bf214ea16f3865a9fc61843", "url": "https://github.com/aws/aws-sdk-java-v2/commit/ea78ac294eba941e8bf214ea16f3865a9fc61843", "message": "Adding Crosslink redirect for API reference document", "committedDate": "2020-12-17T18:23:08Z", "type": "commit"}]}