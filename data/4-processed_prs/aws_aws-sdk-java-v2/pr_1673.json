{"pr_number": 1673, "pr_title": "Fix overflow bugs in backoff strategy.", "pr_createdAt": "2020-02-27T22:14:56Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1673", "timeline": [{"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-28T00:34:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTA5OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459099", "bodyText": "Javadoc this", "author": "spfink", "createdAt": "2020-02-28T01:09:56Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -24,6 +24,8 @@\n @FunctionalInterface\n public interface BackoffStrategy {\n \n+    int RETRIES_ATTEMPTED_CEILING = (int) Math.floor(Math.log(Integer.MAX_VALUE) / Math.log(2));", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTI0OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459248", "bodyText": "You should pull in our style template as this is incorrect", "author": "spfink", "createdAt": "2020-02-28T01:10:26Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -33,21 +35,22 @@\n     Duration computeDelayBeforeNextRetry(RetryPolicyContext context);\n \n     default int calculateExponentialDelay(int retriesAttempted, Duration baseDelay, Duration maxBackoffTime) {\n-        return (int) Math.min((1L << retriesAttempted) * baseDelay.toMillis(), maxBackoffTime.toMillis());\n+        int cappedRetries = Math.min(retriesAttempted, RETRIES_ATTEMPTED_CEILING);\n+        return (int) Math.min(baseDelay.multipliedBy(1L << cappedRetries).toMillis(), maxBackoffTime.toMillis());\n     }\n \n     static BackoffStrategy defaultStrategy() {\n         return FullJitterBackoffStrategy.builder()\n-                                        .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)\n-                                        .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n-                                        .build();\n+                .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTQ0OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459448", "bodyText": "Take a look at some of our existing tests and rename these to match our pattern", "author": "spfink", "createdAt": "2020-02-28T01:11:05Z", "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.backoff;\n+\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+\n+import java.time.Duration;\n+import java.util.Random;\n+\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.testng.Assert.assertThrows;\n+\n+public class EqualJitterBackoffStrategyTest {\n+\n+    private static final int RANDOM_RESULT = 12345;\n+    private static final Duration FIVE_DAYS = Duration.ofDays(5);\n+    private static final Duration MAX_DURATION = Duration.ofSeconds(Long.MAX_VALUE);\n+    private static final Duration ONE_SECOND = Duration.ofSeconds(1);\n+    private static final Duration ONE_NANO_SECOND = Duration.ofNanos(1);\n+    private static final int NANO_IN_MILLISECONDS = 1_000_000;\n+    private static final Duration NEGATIVE_ONE_SECOND = Duration.ofSeconds(-1);\n+\n+    @Mock\n+    private Random mockRandom = mock(Random.class);\n+\n+    @Test\n+    public void GIVEN_exponentialDelayAboveCeiling_THEN_return_JitteredCeiling() {", "originalCommit": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/3e89194e3f52c358e573c963ab8136c4fa6cb39f", "message": "Merge branch 'master' of https://github.com/aws/aws-sdk-java-v2 into backoff-overflow-fixing", "committedDate": "2020-02-28T06:26:47Z", "type": "forcePushed"}, {"oid": "0e723e512c60b46b1e7996c85582c699e11122b3", "url": "https://github.com/aws/aws-sdk-java-v2/commit/0e723e512c60b46b1e7996c85582c699e11122b3", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-28T06:37:44Z", "type": "forcePushed"}, {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-29T00:20:18Z", "type": "commit"}, {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "message": "Fix overflow bugs in backoff strategy.", "committedDate": "2020-02-29T00:20:18Z", "type": "forcePushed"}, {"oid": "ee4a458609ce5eb3220faa331922395c3299c6d7", "url": "https://github.com/aws/aws-sdk-java-v2/commit/ee4a458609ce5eb3220faa331922395c3299c6d7", "message": "Merge branch 'master' into backoff-overflow-fixing", "committedDate": "2020-02-29T00:49:51Z", "type": "commit"}, {"oid": "f5f08dc154c07f196374808be7410f9c00d9be64", "url": "https://github.com/aws/aws-sdk-java-v2/commit/f5f08dc154c07f196374808be7410f9c00d9be64", "message": "Merge branch 'master' into backoff-overflow-fixing", "committedDate": "2020-03-02T19:04:57Z", "type": "commit"}]}