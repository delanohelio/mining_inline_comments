{"pr_number": 2179, "pr_title": "Add amz-sdk-request header, removed amz-sdk-retry header.", "pr_createdAt": "2020-12-03T00:56:24Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2179", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MjY0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r535492645", "bodyText": "I think the retry capacity is very valuable for troubleshooting; otherwise there's no way to tell if the retry gets throttled. I've seen an issue before where all requests failed of IOException, and I initially thought all retry attempts failed, but this header made me realize that the request did not get retried because there was no retry capacity.", "author": "zoewangg", "createdAt": "2020-12-03T18:48:35Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/utils/RetryableStageHelper.java", "diffHunk": "@@ -140,14 +139,8 @@ public void logBackingOff(Duration backoffDelay) {\n      * Retrieve the request to send to the service, including any detailed retry information headers.\n      */\n     public SdkHttpFullRequest requestToSend() {\n-        Integer availableRetryCapacity = TokenBucketRetryCondition.getCapacityForExecution(context.executionAttributes())\n-                                                                  .map(TokenBucketRetryCondition.Capacity::capacityRemaining)\n-                                                                  .orElse(null);\n-        String headerValue = (attemptNumber - 1) + \"/\" +\n-                             context.executionAttributes().getAttribute(LAST_BACKOFF_DELAY_DURATION).toMillis() + \"/\" +\n-                             (availableRetryCapacity != null ? availableRetryCapacity : \"\");\n         return request.toBuilder()\n-                      .putHeader(SDK_RETRY_INFO_HEADER, headerValue)\n+                      .putHeader(SDK_RETRY_INFO_HEADER, \"attempt=\" + attemptNumber + \"; max=\" + retryPolicy.numRetries())", "originalCommit": "5179a538b5ecdcf960424ac9d33df2d9f0df09ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNTczOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r535505739", "bodyText": "I guess now that we have metrics, we can see it there. It's just not as obvious", "author": "zoewangg", "createdAt": "2020-12-03T19:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5OTY5NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536299695", "bodyText": "Maybe we could add a debug log whenever we do not retry because of throttling?", "author": "millems", "createdAt": "2020-12-04T18:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MjY0NQ=="}], "type": "inlineReview"}, {"oid": "5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it.", "committedDate": "2020-12-04T18:44:23Z", "type": "forcePushed"}, {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1cffce865aaed308f5ba8b818b3bb660c5421ec0", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it.", "committedDate": "2020-12-04T18:48:26Z", "type": "commit"}, {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "url": "https://github.com/aws/aws-sdk-java-v2/commit/1cffce865aaed308f5ba8b818b3bb660c5421ec0", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it.", "committedDate": "2020-12-04T18:48:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NDUyNg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536394526", "bodyText": "debug?", "author": "zoewangg", "createdAt": "2020-12-04T21:38:47Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketRetryCondition.java", "diffHunk": "@@ -122,9 +125,17 @@ public boolean shouldRetry(RetryPolicyContext context) {\n             context.executionAttributes().putAttribute(LAST_ACQUIRED_CAPACITY, c);\n             context.executionAttributes().putAttribute(RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION,\n                                                        context.retriesAttempted());\n+            log.trace(() -> \"Successfully acquired token bucket capacity to retry this request. \"", "originalCommit": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyNzU2OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536427569", "bodyText": "This seemed like a bit much for debug, since we're already logging when there wasn't enough capacity. I was thinking if we really needed to debug this, we can ask them to enable trace for this one class.", "author": "millems", "createdAt": "2020-12-04T22:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NDUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NDk3MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536394971", "bodyText": "Nice!", "author": "zoewangg", "createdAt": "2020-12-04T21:39:36Z", "path": "test/codegen-generated-classes-test/src/test/java/software/amazon/awssdk/services/retry/RetryHeaderTestSuite.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.retry;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.List;\n+import java.util.stream.Stream;\n+import org.junit.Before;\n+import org.junit.Test;\n+import software.amazon.awssdk.http.HttpExecuteResponse;\n+import software.amazon.awssdk.http.SdkHttpRequest;\n+import software.amazon.awssdk.http.SdkHttpResponse;\n+import software.amazon.awssdk.testutils.service.http.MockHttpClient;\n+\n+/**\n+ * A set of tests that verify the behavior of retry-related headers (amz-sdk-invocation-id and amz-sdk-request).\n+ */\n+public abstract class RetryHeaderTestSuite<T extends MockHttpClient> {", "originalCommit": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c30b458eded8a6afde517863df9a602682d8b817", "url": "https://github.com/aws/aws-sdk-java-v2/commit/c30b458eded8a6afde517863df9a602682d8b817", "message": "Merge branch 'master' into millem/retry-headers", "committedDate": "2020-12-04T22:44:23Z", "type": "commit"}, {"oid": "02cedf415d1e5802f8cc350624ed2778c8be6dd2", "url": "https://github.com/aws/aws-sdk-java-v2/commit/02cedf415d1e5802f8cc350624ed2778c8be6dd2", "message": "Merge branch 'master' into millem/retry-headers", "committedDate": "2020-12-07T18:31:19Z", "type": "commit"}, {"oid": "7c9a47ea83098eaf10995795b691c84fca3691a8", "url": "https://github.com/aws/aws-sdk-java-v2/commit/7c9a47ea83098eaf10995795b691c84fca3691a8", "message": "Merge branch 'master' into millem/retry-headers", "committedDate": "2020-12-07T18:37:10Z", "type": "commit"}]}