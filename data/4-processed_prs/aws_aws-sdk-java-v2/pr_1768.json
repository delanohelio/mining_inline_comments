{"pr_number": 1768, "pr_title": "Mark a connection as unreusable if there was a 5xx error so that new \u2026", "pr_createdAt": "2020-04-06T20:18:33Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1768", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1ODEwMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404458103", "bodyText": "Should we log the stream ID?", "author": "dagnir", "createdAt": "2020-04-06T23:58:04Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2ToHttpInboundAdapter.java", "diffHunk": "@@ -54,7 +59,21 @@ protected void channelRead0(ChannelHandlerContext ctx, Http2Frame frame) throws\n     }\n \n     private void onHeadersRead(Http2HeadersFrame headersFrame, ChannelHandlerContext ctx) throws Http2Exception {\n-        ctx.fireChannelRead(HttpConversionUtil.toHttpResponse(headersFrame.stream().id(), headersFrame.headers(), true));\n+\n+        HttpResponse httpResponse = HttpConversionUtil.toHttpResponse(headersFrame.stream().id(), headersFrame.headers(), true);\n+        ctx.fireChannelRead(httpResponse);\n+\n+        if (HttpStatusFamily.of(httpResponse.status().code()) == HttpStatusFamily.SERVER_ERROR) {\n+            fireConnectionExceptionForServerError(ctx);\n+        }\n+    }\n+\n+    private void fireConnectionExceptionForServerError(ChannelHandlerContext ctx) {\n+        if (ctx.channel().parent() != null) {\n+            Channel parent = ctx.channel().parent();\n+            log.debug(() -> \"An 5xx server error occurred on an Http2 stream, notifying the connection channel \" + parent);", "originalCommit": "8e75cff60c870a15213cc6edceef602000c3de76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2MTQyMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404461423", "bodyText": "yup, updated", "author": "zoewangg", "createdAt": "2020-04-07T00:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1ODEwMw=="}], "type": "inlineReview"}, {"oid": "d62ea23b55d4f16c0f0552771b6d1cd94d5833d0", "url": "https://github.com/aws/aws-sdk-java-v2/commit/d62ea23b55d4f16c0f0552771b6d1cd94d5833d0", "message": "Mark a connection as unreusable if there was a 5xx error so that new request will execute on new connection", "committedDate": "2020-04-07T00:08:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404981840", "bodyText": "Do we not support modeled 5xx exceptions for HTTP2 connections? It feels like this would break them, if we did.", "author": "millems", "createdAt": "2020-04-07T17:21:51Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2ToHttpInboundAdapter.java", "diffHunk": "@@ -54,7 +59,21 @@ protected void channelRead0(ChannelHandlerContext ctx, Http2Frame frame) throws\n     }\n \n     private void onHeadersRead(Http2HeadersFrame headersFrame, ChannelHandlerContext ctx) throws Http2Exception {\n-        ctx.fireChannelRead(HttpConversionUtil.toHttpResponse(headersFrame.stream().id(), headersFrame.headers(), true));\n+\n+        HttpResponse httpResponse = HttpConversionUtil.toHttpResponse(headersFrame.stream().id(), headersFrame.headers(), true);\n+        ctx.fireChannelRead(httpResponse);\n+\n+        if (HttpStatusFamily.of(httpResponse.status().code()) == HttpStatusFamily.SERVER_ERROR) {\n+            fireConnectionExceptionForServerError(ctx);\n+        }\n+    }\n+\n+    private void fireConnectionExceptionForServerError(ChannelHandlerContext ctx) {\n+        if (ctx.channel().parent() != null) {\n+            Channel parent = ctx.channel().parent();\n+            log.debug(() -> \"A 5xx server error occurred on an Http2 stream, notifying the connection channel \" + ctx.channel());\n+            parent.pipeline().fireExceptionCaught(Http2StreamServerErrorException.INSTANCE);", "originalCommit": "d62ea23b55d4f16c0f0552771b6d1cd94d5833d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4Mjc1Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404982752", "bodyText": "Actually, looks like this may not close the connection immediately, just closes it to new requests. I'm not sure if I like the instanceof checks to disambiguate this IOException from other IOExceptions. Should we have a different root exception type?", "author": "millems", "createdAt": "2020-04-07T17:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4OTU4OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404989588", "bodyText": "We support modeled 5xx exceptions in core, and http client modules do not have knowledge of it.\nYeah, it doesn't close the connection immediately; the RecordState will be changed to CLOSE_TO_NEW\nI can change it to RuntimeException. WDUT?", "author": "zoewangg", "createdAt": "2020-04-07T17:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MzM2OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404993368", "bodyText": "So, all RuntimeExceptions on the channel will put it into no-new-connections state? I don't think that's a bad thing, but wanted to make sure my proposal was clear.", "author": "millems", "createdAt": "2020-04-07T17:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NTY5NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r404995694", "bodyText": "So,  Http2StreamServerErrorException (extends RuntimeException) or Http2StreamIoException(extends IOException) on the stream channel will put the connection channel into close_to_new state.\nAll other exceptions on the stream channels will not have any effect on connection channel.", "author": "zoewangg", "createdAt": "2020-04-07T17:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NDg4Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r405064887", "bodyText": "Discussed offline. We decided to have a single exception class for both server errors and io error on streams so that we don't need to update the exception handling logic if there are more cases in the future", "author": "zoewangg", "createdAt": "2020-04-07T19:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NDkyMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r405074920", "bodyText": "Just a sanity check: we aren't relying on the existing exceptions we're replacing with this being an IOException (e.g. for retries) are we?", "author": "millems", "createdAt": "2020-04-07T19:57:58Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2ConnectionTerminatingException.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http.nio.netty.internal.http2;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * Exception indicating a connection is terminating\n+ */\n+@SdkInternalApi\n+final class Http2ConnectionTerminatingException extends RuntimeException {", "originalCommit": "30270f7fd2337bb46a4b365459c82231562cc5c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4MjQ5NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1768#discussion_r405082494", "bodyText": "Nope, this exception is only used internally to change the connection state to CLOSE_TO_NEW and is not returned to upstream.", "author": "zoewangg", "createdAt": "2020-04-07T20:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NDkyMA=="}], "type": "inlineReview"}, {"oid": "56fe41fb0baa56021287e717627887398ee66caa", "url": "https://github.com/aws/aws-sdk-java-v2/commit/56fe41fb0baa56021287e717627887398ee66caa", "message": "Mark a connection as unreusable if there was a 5xx error so that new request will execute on new connection", "committedDate": "2020-04-07T20:49:01Z", "type": "commit"}, {"oid": "56fe41fb0baa56021287e717627887398ee66caa", "url": "https://github.com/aws/aws-sdk-java-v2/commit/56fe41fb0baa56021287e717627887398ee66caa", "message": "Mark a connection as unreusable if there was a 5xx error so that new request will execute on new connection", "committedDate": "2020-04-07T20:49:01Z", "type": "forcePushed"}, {"oid": "e501ca2cab4b4b964fff5f093b24389ae1b28be9", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e501ca2cab4b4b964fff5f093b24389ae1b28be9", "message": "Merge branch 'master' into zoewang/connection5xxError", "committedDate": "2020-04-13T16:55:21Z", "type": "commit"}]}