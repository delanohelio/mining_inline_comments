{"pr_number": 2004, "pr_title": "Updated endpoint discovery behavior for operations that require endpoint discovery.", "pr_createdAt": "2020-08-25T23:50:38Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2004", "timeline": [{"oid": "c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "url": "https://github.com/aws/aws-sdk-java-v2/commit/c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically:\n1. If endpoint discovery is disabled, throw an exception.\n2. If an endpoint override is specified, throw an exception.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs.\n\nMotivation: The behavior across SDKs is inconsistent, so this brings it more into line for consistency. It also makes it easier to add a \"discoveryEndpointOverride\" in the future to disambiguate the \"endpoint used for execution\" from the \"endpoint used for discovery\" configuration values. Without this change, the SDK would use the endpointOverride as the discovery endpoint.", "committedDate": "2020-08-26T16:38:00Z", "type": "forcePushed"}, {"oid": "eb360c72316717b2697e555ac42fc42603dd8562", "url": "https://github.com/aws/aws-sdk-java-v2/commit/eb360c72316717b2697e555ac42fc42603dd8562", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint.", "committedDate": "2020-08-26T16:52:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzOTIwOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477539208", "bodyText": "Is this statement correct? I don't know the existing code around endpoint discovery well; when I read this code, I read it as:\n\"If the model has an endpoint discovery operation AND allowEndpointOverrideForEndpointDiscoveryRequiredOperations is true, then check the ENDPOINT_OVERRIDDEN flag.\"\nI can't see ENDPOINT_DISCOVERY_ENABLED being involved in the logic; is it then correct to say that Endpoint discovery is enabled for this client? Or am I missing something?", "author": "cenedhryn", "createdAt": "2020-08-26T19:30:00Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -154,6 +162,17 @@ private MethodSpec constructor() {\n                                  EndpointDiscoveryRefreshCache.class,\n                                  poetExtensions.getClientClass(model.getNamingStrategy().getServiceName() +\n                                                                \"EndpointDiscoveryCacheLoader\"));\n+\n+            if (model.getCustomizationConfig().allowEndpointOverrideForEndpointDiscoveryRequiredOperations()) {\n+                builder.beginControlFlow(\"if (clientConfiguration.option(SdkClientOption.ENDPOINT_OVERRIDDEN) == \"\n+                                         + \"Boolean.TRUE)\");\n+                builder.addStatement(\"log.warn(() -> $S)\",\n+                                     \"Endpoint discovery is enabled for this client, and an endpoint override was also \"\n+                                     + \"specified. This will disable endpoint discovery for methods that require it, instead \"", "originalCommit": "eb360c72316717b2697e555ac42fc42603dd8562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2NjM1OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477566359", "bodyText": "if (clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)) is specified above on line 160, so we know that endpoint discovery is enabled here.", "author": "millems", "createdAt": "2020-08-26T20:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzOTIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4Nzg4NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477587884", "bodyText": "I didn't see before that the new if statement is within the flow of the ENDPOINT_DISCOVERY_ENABLED codegen-if, which it is. So that's fine, it's\nendpoint discovery operation AND ENDPOINT_DISCOVERY_ENABLED and ENDPOINT_OVERRIDDEN allowEndpointOverrideForEndpointDiscoveryRequiredOperations which will trigger the log warning. Many ifs :-(", "author": "cenedhryn", "createdAt": "2020-08-26T21:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzOTIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0ODA1OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477548058", "bodyText": "Should the message tell the user about the allowEndpointOverrideForEndpointDiscoveryRequiredOperations flag?", "author": "cenedhryn", "createdAt": "2020-08-26T19:46:39Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -181,8 +200,37 @@ private MethodSpec constructor() {\n         protocolSpec.errorResponseHandler(opModel).ifPresent(method::addCode);\n \n         if (opModel.getEndpointDiscovery() != null) {\n+            method.addStatement(\"boolean endpointDiscoveryEnabled = \"\n+                                + \"clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)\");\n+\n+            if (opModel.getEndpointDiscovery().isRequired()) {\n+                method.beginControlFlow(\"if (!endpointDiscoveryEnabled)\");\n+                method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                    \"This operation requires endpoint discovery, but endpoint discovery was disabled on the \"\n+                                    + \"client.\");\n+                method.endControlFlow();\n+\n+\n+                method.addStatement(\"boolean endpointOverridden = \"\n+                                    + \"clientConfiguration.option(SdkClientOption.ENDPOINT_OVERRIDDEN) == Boolean.TRUE\");\n+                method.beginControlFlow(\"if (endpointOverridden)\");\n+\n+                if (!model.getCustomizationConfig()\n+                          .allowEndpointOverrideForEndpointDiscoveryRequiredOperations()) {\n+                    method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                        \"This operation requires endpoint discovery, but an endpoint override was specified when \"", "originalCommit": "eb360c72316717b2697e555ac42fc42603dd8562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2NjYzNA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477566634", "bodyText": "allowEndpointOverrideForEndpointDiscoveryRequiredOperations is a customization flag, not one that customer's are allowed to specify.", "author": "millems", "createdAt": "2020-08-26T20:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0ODA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NzY4NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477597684", "bodyText": "Got it!", "author": "cenedhryn", "createdAt": "2020-08-26T21:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0ODA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwNDI3Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477604277", "bodyText": "This is complicated, but I'll have another go at the logic.\nThe requirements state that for the values of the three flags (ED Required - ED enabled - Endpoint Overridden), 1. The general behavior when ED Required == TRUE is as follows:\nIf Endpoint Overridden == TRUE, there shall always be an exception\nIf ED enabled == FALSE there will also always be an exception\n2. The customized flag allowEndpointOverrideForEndpointDiscoveryRequiredOperations should change the default behavior so that when Endpoint Overridden == TRUE instead of an exception we'll use the custom endpoint (by disabling the endpoint discovery...)\nHowever, in the code below the Endpoint Overridden logic comes after ED enabled logic, so that if the values are FALSE - TRUE for ED enabled - Endpoint Overridden, we'll throw an exception even though it seems the requirement says we should use custom endpoints for all cases where it's specified (and the flag with the really long name is used).\nIf I understood everything correct, either the requirement is incorrect, or we should switch places of these if statements and give endpoint overridden a higher priority.", "author": "cenedhryn", "createdAt": "2020-08-26T21:38:12Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -181,8 +200,37 @@ private MethodSpec constructor() {\n         protocolSpec.errorResponseHandler(opModel).ifPresent(method::addCode);\n \n         if (opModel.getEndpointDiscovery() != null) {\n+            method.addStatement(\"boolean endpointDiscoveryEnabled = \"\n+                                + \"clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)\");\n+\n+            if (opModel.getEndpointDiscovery().isRequired()) {", "originalCommit": "eb360c72316717b2697e555ac42fc42603dd8562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMzU0Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477613546", "bodyText": "All of your assertions are correct except:\n\nHowever, in the code below the Endpoint Overridden logic comes after ED enabled logic, so that if the values are FALSE - TRUE for ED enabled - Endpoint Overridden, we'll throw an exception even though it seems the requirement says we should use custom endpoints for all cases where it's specified (and the flag with the really long name is used).\n\nWhen ED enabled = false, we must ALWAYS throw an exception. The only case that allowEndpointOverrideForEndpointDiscoveryRequiredOperations should apply is the ED enabled = true case.", "author": "millems", "createdAt": "2020-08-26T21:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwNDI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2ODUzOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r478668538", "bodyText": "Discussed offline, the spec changed a bit and we want to support what Anna-Karin asserted. Good catch.", "author": "millems", "createdAt": "2020-08-27T20:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwNDI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY3ODMxNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r478678315", "bodyText": "The refactored code is much easier to read, too!", "author": "cenedhryn", "createdAt": "2020-08-27T20:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwNDI3Nw=="}], "type": "inlineReview"}, {"oid": "47a001f6030df9c083984df8da9a027e0bef389f", "url": "https://github.com/aws/aws-sdk-java-v2/commit/47a001f6030df9c083984df8da9a027e0bef389f", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint.", "committedDate": "2020-08-27T20:09:25Z", "type": "forcePushed"}, {"oid": "03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "url": "https://github.com/aws/aws-sdk-java-v2/commit/03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint.", "committedDate": "2020-08-27T20:10:38Z", "type": "commit"}, {"oid": "03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "url": "https://github.com/aws/aws-sdk-java-v2/commit/03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint.", "committedDate": "2020-08-27T20:10:38Z", "type": "forcePushed"}, {"oid": "839576bd2162f6e62526b7fe9fa8e30eb73bac0c", "url": "https://github.com/aws/aws-sdk-java-v2/commit/839576bd2162f6e62526b7fe9fa8e30eb73bac0c", "message": "Merge branch 'master' into millem/endpoint-discovery-updates", "committedDate": "2020-08-27T20:11:47Z", "type": "commit"}]}