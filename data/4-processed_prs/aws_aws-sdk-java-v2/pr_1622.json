{"pr_number": 1622, "pr_title": "h2 connection exception handling ", "pr_createdAt": "2020-01-29T04:06:45Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1622", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372550600", "bodyText": "RuntimeException might not be the best exception to be wrapped with. The reason I didn't use IOException is because I figured not all exceptions thrown on connection are retryable, but is that true?", "author": "zoewangg", "createdAt": "2020-01-29T18:20:16Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "diffHunk": "@@ -184,7 +185,19 @@ void closeChildChannels() {\n      * Delivers the exception to all registered child channels, and prohibits new streams being created on this connection.\n      */\n     void closeChildChannels(Throwable t) {\n-        closeAndExecuteOnChildChannels(ch -> ch.pipeline().fireExceptionCaught(t));\n+        closeAndExecuteOnChildChannels(ch -> {\n+            RuntimeException ioException = new RuntimeException(\"An exception occurred on the connection \", t);", "originalCommit": "ab03e4ae7276a66d9eec88c62abffac83d289653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1Nzg2Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372557863", "bodyText": "Wouldn't we want IOExceptions to stay IOExceptions? Any reason we need to re-wrap here?", "author": "millems", "createdAt": "2020-01-29T18:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2NTk5OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372565998", "bodyText": "The reason I re-wrap it here is to provide more descriptive message on the exception. Currently, it's not very clear why the request fails.", "author": "zoewangg", "createdAt": "2020-01-29T18:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4MDQyMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372580421", "bodyText": "Wouldn't this make currently-retried exceptions not be retried? Should we make it an IOException if the wrapped is an IOException?", "author": "millems", "createdAt": "2020-01-29T19:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NjIzNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372586235", "bodyText": "I thought our default retry policy would check if the root cause of the exception is assignable from IOException, but turns out it would only check one level down.\n\n  \n    \n      aws-sdk-java-v2/core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/RetryOnExceptionsCondition.java\n    \n    \n        Lines 59 to 62\n      in\n      138def2\n    \n    \n    \n    \n\n        \n          \n           Predicate<Class<? extends Exception>> hasRetrableCause = \n        \n\n        \n          \n               ex -> exception.getCause() != null && ex.isAssignableFrom(exception.getCause().getClass()); \n        \n\n        \n          \n            \n        \n\n        \n          \n           return exceptionsToRetryOn.stream().anyMatch(isRetryableException.or(hasRetrableCause)); \n        \n    \n  \n\n\nI'll make it an IOException if the wrapped is an IOException", "author": "zoewangg", "createdAt": "2020-01-29T19:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5ODEzMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372598131", "bodyText": "Or we could update the retry policy to check down the entire chain? That would probably be better.", "author": "millems", "createdAt": "2020-01-29T19:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYzODQ4MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372638481", "bodyText": "+1. I'll create a backlog item for it. I think it'd still be nice to wrap IOException with an IOException here to make it clear this is a transient retryable I/O related error.", "author": "zoewangg", "createdAt": "2020-01-29T21:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MDYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTcyOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372555729", "bodyText": "Do we still need the IN_USE checks in the handler if we are removing it?", "author": "millems", "createdAt": "2020-01-29T18:30:03Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/HandlerRemovingChannelPool.java", "diffHunk": "@@ -83,7 +83,8 @@ private void removePerRequestHandlers(Channel channel) {\n                            FlushOnReadHandler.class,\n                            ResponseHandler.class,\n                            ReadTimeoutHandler.class,\n-                           WriteTimeoutHandler.class);\n+                           WriteTimeoutHandler.class,\n+                           UnusedChannelExceptionHandler.class);", "originalCommit": "ab03e4ae7276a66d9eec88c62abffac83d289653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTQ0Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372561442", "bodyText": "Hmm, good point. I'll change it to only add it once when the channel is created and not removing it.", "author": "zoewangg", "createdAt": "2020-01-29T18:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYzNzQyNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372637425", "bodyText": "Reverted this change. Now we only attach UnusedChannelExceptionHandler to h1 channels once they are created", "author": "zoewangg", "createdAt": "2020-01-29T21:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1Njk0NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372556944", "bodyText": "This seems super fragile. Can we just have a handler at the end of every pipeline that closes on exception?", "author": "millems", "createdAt": "2020-01-29T18:32:29Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "diffHunk": "@@ -184,7 +185,19 @@ void closeChildChannels() {\n      * Delivers the exception to all registered child channels, and prohibits new streams being created on this connection.\n      */\n     void closeChildChannels(Throwable t) {\n-        closeAndExecuteOnChildChannels(ch -> ch.pipeline().fireExceptionCaught(t));\n+        closeAndExecuteOnChildChannels(ch -> {\n+            RuntimeException ioException = new RuntimeException(\"An exception occurred on the connection \", t);\n+\n+            // Deliver the exception only if the channel knows to handle the exception\n+            if (ch.pipeline().get(ResponseHandler.class) != null) {\n+                log.debug(() -> \"Delivering exception to child channel \" + ch + ioException);\n+                ch.pipeline().fireExceptionCaught(ioException);\n+            } else {\n+                log.debug(() -> \"Closing child channel \" + ch + ioException);\n+                ch.close();", "originalCommit": "ab03e4ae7276a66d9eec88c62abffac83d289653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTYzNw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372561637", "bodyText": "The connection could get closed before any handler is attached to stream channels and there would be nothing catching the exception. I found out this issue in my testing where I set a very low pingPeriod.", "author": "zoewangg", "createdAt": "2020-01-29T18:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4MjEwMA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372582100", "bodyText": "Can we have a handler attached to the end of every channel as soon as it is created, before it is even connected, that calls close() when an exception is fired on the channel, assuming nothing else closed the channel already?", "author": "millems", "createdAt": "2020-01-29T19:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYzNjMyNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372636325", "bodyText": "Updated to attach UnusedChannelExceptionHandler to the stream channels once they are created and that should take care of it.", "author": "zoewangg", "createdAt": "2020-01-29T21:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1Njk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYzOTE0MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372639140", "bodyText": "What happens when an exception is fired on a parent H2 channel after this change?", "author": "millems", "createdAt": "2020-01-29T21:27:38Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java", "diffHunk": "@@ -109,7 +109,14 @@ public void channelCreated(Channel ch) {\n         }\n \n         pipeline.addLast(FutureCancelHandler.getInstance());\n-        pipeline.addLast(UnusedChannelExceptionHandler.getInstance());\n+\n+        // Only add it for h1 channel because it does not apply to\n+        // h2 connection channel. It will be attached\n+        // to stream channels when they are created.\n+        if (protocol == Protocol.HTTP1_1) {\n+            pipeline.addLast(UnusedChannelExceptionHandler.getInstance());", "originalCommit": "3bfe6ae35ad04070bdcab5961d6e29a8c16434cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0MTIzOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r372641238", "bodyText": "ReleaseOnExceptionHandler will take care of it.\n\n  \n    \n      aws-sdk-java-v2/http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2MultiplexedChannelPool.java\n    \n    \n        Lines 380 to 396\n      in\n      138def2\n    \n    \n    \n    \n\n        \n          \n           private static final class ReleaseOnExceptionHandler extends ChannelDuplexHandler { \n        \n\n        \n          \n               private static final ReleaseOnExceptionHandler INSTANCE = new ReleaseOnExceptionHandler(); \n        \n\n        \n          \n            \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               public void channelInactive(ChannelHandlerContext ctx) { \n        \n\n        \n          \n                   closeAndReleaseParent(ctx, new ClosedChannelException()); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               @Override \n        \n\n        \n          \n               public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { \n        \n\n        \n          \n                   closeAndReleaseParent(ctx, cause); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               private void closeAndReleaseParent(ChannelHandlerContext ctx, Throwable cause) { \n        \n\n        \n          \n                   Http2MultiplexedChannelPool pool = ctx.channel().attr(ChannelAttributeKey.HTTP2_MULTIPLEXED_CHANNEL_POOL).get(); \n        \n\n        \n          \n                   pool.closeAndReleaseParent(ctx.channel(), cause); \n        \n\n        \n          \n               }", "author": "zoewangg", "createdAt": "2020-01-29T21:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYzOTE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NzMwOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r373187309", "bodyText": "minor: instanceof here is more concise", "author": "dagnir", "createdAt": "2020-01-30T20:52:35Z", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "diffHunk": "@@ -184,7 +186,16 @@ void closeChildChannels() {\n      * Delivers the exception to all registered child channels, and prohibits new streams being created on this connection.\n      */\n     void closeChildChannels(Throwable t) {\n-        closeAndExecuteOnChildChannels(ch -> ch.pipeline().fireExceptionCaught(t));\n+        closeAndExecuteOnChildChannels(ch -> ch.pipeline().fireExceptionCaught(decorateConnectionException(t)));\n+    }\n+\n+    private Throwable decorateConnectionException(Throwable t) {\n+        String message = \"An error occurred on the connection: \" + t.getMessage();\n+        if (IOException.class.isAssignableFrom(t.getClass())) {", "originalCommit": "3bfe6ae35ad04070bdcab5961d6e29a8c16434cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMTQ4MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r373211481", "bodyText": "Fixed", "author": "zoewangg", "createdAt": "2020-01-30T21:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NzY5NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r373187694", "bodyText": "nit: space in \"connection.This\"", "author": "dagnir", "createdAt": "2020-01-30T20:53:29Z", "path": ".changes/next-release/bugfix-NettyNIOHTTPClient-dba3e80.json", "diffHunk": "@@ -0,0 +1,5 @@\n+{\n+    \"category\": \"Netty NIO HTTP Client\", \n+    \"type\": \"bugfix\", \n+    \"description\": \"Deliver exceptions to stream channels correctly if there's an exception thrown on connection.This also fixes a bug where publisher signals onComplete if the stream is closed as a result of outbound GOAWAY.\"", "originalCommit": "3bfe6ae35ad04070bdcab5961d6e29a8c16434cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMTUyMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1622#discussion_r373211523", "bodyText": "Fixed", "author": "zoewangg", "createdAt": "2020-01-30T21:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NzY5NA=="}], "type": "inlineReview"}, {"oid": "2ebb967c6a21eeac07440c5f578985291b34d2d8", "url": "https://github.com/aws/aws-sdk-java-v2/commit/2ebb967c6a21eeac07440c5f578985291b34d2d8", "message": "Update UnusedExceptionHandler to a per-request handler. Wrapps a connection thrown from a connection with more information before delivering to stream channels.", "committedDate": "2020-01-30T21:44:42Z", "type": "forcePushed"}, {"oid": "43c3aa1a0fa788dbc73bb8d05a8aafee9e97700b", "url": "https://github.com/aws/aws-sdk-java-v2/commit/43c3aa1a0fa788dbc73bb8d05a8aafee9e97700b", "message": "Fix the issue where the publisher signals onComplete if the stream is closed as a result of outbound of GOAWAY.", "committedDate": "2020-02-04T02:06:07Z", "type": "commit"}, {"oid": "43c3aa1a0fa788dbc73bb8d05a8aafee9e97700b", "url": "https://github.com/aws/aws-sdk-java-v2/commit/43c3aa1a0fa788dbc73bb8d05a8aafee9e97700b", "message": "Fix the issue where the publisher signals onComplete if the stream is closed as a result of outbound of GOAWAY.", "committedDate": "2020-02-04T02:06:07Z", "type": "forcePushed"}]}