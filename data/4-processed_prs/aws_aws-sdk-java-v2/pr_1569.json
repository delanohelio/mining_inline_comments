{"pr_number": 1569, "pr_title": "Add RequestBody.fromRemainingByteBuffer()", "pr_createdAt": "2020-01-02T21:55:14Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/1569", "timeline": [{"oid": "94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "url": "https://github.com/aws/aws-sdk-java-v2/commit/94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534", "committedDate": "2020-01-02T21:57:39Z", "type": "forcePushed"}, {"oid": "7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "url": "https://github.com/aws/aws-sdk-java-v2/commit/7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534", "committedDate": "2020-01-02T21:59:47Z", "type": "forcePushed"}, {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "url": "https://github.com/aws/aws-sdk-java-v2/commit/088b5fdb4811bc12b53800d34f8f3eef3ec79647", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534", "committedDate": "2020-01-02T22:00:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NjUzMg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666532", "bodyText": "Can we update the javadoc in the original fromByteBuffer(...) to make it clear that this one does -not- respect the current read position.", "author": "bmaizels", "createdAt": "2020-01-02T23:22:41Z", "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/sync/RequestBody.java", "diffHunk": "@@ -169,6 +169,18 @@ public static RequestBody fromByteBuffer(ByteBuffer byteBuffer) {\n         return fromBytesDirect(BinaryUtils.copyAllBytesFrom(byteBuffer));\n     }\n \n+    /**\n+     * Creates a {@link RequestBody} from the remaining readable bytes from a {@link ByteBuffer}. Unlike\n+     * {@link #fromByteBuffer(ByteBuffer)}, this method respects the current read position of the buffer and reads only\n+     * the remaining bytes. The buffer is copied before reading so no changes are made to original buffer.\n+     *\n+     * @param byteBuffer ByteBuffer to send to the service.\n+     * @return RequestBody instance.\n+     */", "originalCommit": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODkxNQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362668915", "bodyText": "+1", "author": "dagnir", "createdAt": "2020-01-02T23:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NjUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg0Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666843", "bodyText": "Capture bb.remaining() before calling fromRemainingByteBuffer just to ensure that it's not being mutated.", "author": "bmaizels", "createdAt": "2020-01-02T23:24:04Z", "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/sync/RequestBodyTest.java", "diffHunk": "@@ -104,4 +103,19 @@ public void emptyBytesConstructorHasCorrectContentType() {\n         RequestBody requestBody = RequestBody.empty();\n         assertThat(requestBody.contentType()).isEqualTo(Mimetype.MIMETYPE_OCTET_STREAM);\n     }\n+\n+    @Test\n+    public void remainingByteBufferConstructorOnlyRemainingBytesCopied() throws IOException {\n+        ByteBuffer bb = ByteBuffer.allocate(4);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.get();\n+\n+        RequestBody requestBody = RequestBody.fromRemainingByteBuffer(bb);\n+        assertThat(requestBody.contentLength()).isEqualTo(bb.remaining());", "originalCommit": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg5Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666892", "bodyText": "Or have a separate test to assert such...", "author": "bmaizels", "createdAt": "2020-01-02T23:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODkzOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362668938", "bodyText": "Will do", "author": "dagnir", "createdAt": "2020-01-02T23:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzIwMw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362667203", "bodyText": "Not keen on the way this test is written, it's vulnerable to bb being mutated, also the assertion reads kinda back to front usually we assert the thing that's under test rather than the thing being under test as the thing we compare to.", "author": "bmaizels", "createdAt": "2020-01-02T23:25:56Z", "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/sync/RequestBodyTest.java", "diffHunk": "@@ -104,4 +103,19 @@ public void emptyBytesConstructorHasCorrectContentType() {\n         RequestBody requestBody = RequestBody.empty();\n         assertThat(requestBody.contentType()).isEqualTo(Mimetype.MIMETYPE_OCTET_STREAM);\n     }\n+\n+    @Test\n+    public void remainingByteBufferConstructorOnlyRemainingBytesCopied() throws IOException {\n+        ByteBuffer bb = ByteBuffer.allocate(4);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.get();\n+\n+        RequestBody requestBody = RequestBody.fromRemainingByteBuffer(bb);\n+        assertThat(requestBody.contentLength()).isEqualTo(bb.remaining());\n+\n+        byte[] requestBodyBytes = IoUtils.toByteArray(requestBody.contentStreamProvider().newStream());\n+        assertThat(bb).isEqualTo(ByteBuffer.wrap(requestBodyBytes));", "originalCommit": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3MDE4NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362670184", "bodyText": "Gotcha, I'll flip it.", "author": "dagnir", "createdAt": "2020-01-02T23:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzcyNA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362667724", "bodyText": "Can we use assertJ for all our new tests? I get that you don't want to refactor all the existing tests, but at least for new tests.", "author": "bmaizels", "createdAt": "2020-01-02T23:28:29Z", "path": "utils/src/test/java/software/amazon/awssdk/utils/BinaryUtilsTest.java", "diffHunk": "@@ -159,4 +159,46 @@ public void testCopyBytesFrom_DirectByteBuffer_Idempotent() {\n         assertTrue(partial1.length == 3);\n         assertTrue(Arrays.equals(new byte[] {2, 3, 4}, partial1));\n     }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_nullBuffer() {\n+        assertNull(BinaryUtils.copyRemainingBytesFrom(null));", "originalCommit": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2OTc1Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362669757", "bodyText": "Yeah, I didn't want to start mixing them within the same test class, but I'm fine either way.", "author": "dagnir", "createdAt": "2020-01-02T23:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODQxOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362668418", "bodyText": "These tests might be clearer if we work with bytes instead of ints. Also, we should assert that the sequence is read correctly, eg: given a sequence of [ 1, 2, 3, 4 ] of which we read two bytes we can assert that we are left with a buffer that is equivalent to [ 3, 4 ] rather than just checking length.", "author": "bmaizels", "createdAt": "2020-01-02T23:32:01Z", "path": "utils/src/test/java/software/amazon/awssdk/utils/BinaryUtilsTest.java", "diffHunk": "@@ -159,4 +159,46 @@ public void testCopyBytesFrom_DirectByteBuffer_Idempotent() {\n         assertTrue(partial1.length == 3);\n         assertTrue(Arrays.equals(new byte[] {2, 3, 4}, partial1));\n     }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_nullBuffer() {\n+        assertNull(BinaryUtils.copyRemainingBytesFrom(null));\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_noRemainingBytes() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.getInt();\n+\n+        assertEquals(0, BinaryUtils.copyRemainingBytesFrom(bb).length);\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_fullBuffer() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        byte[] copy = BinaryUtils.copyRemainingBytesFrom(bb);\n+        assertEquals(bb, ByteBuffer.wrap(copy));\n+        assertEquals(8, copy.length);\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_partiallyReadBuffer() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.getInt();\n+\n+        byte[] copy = BinaryUtils.copyRemainingBytesFrom(bb);\n+        assertEquals(bb, ByteBuffer.wrap(copy));\n+        assertEquals(4, copy.length);\n+    }", "originalCommit": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2OTYwMQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362669601", "bodyText": "+1 bytes instead of ints. The assertEquals() should take care of the ordering check since ByteBuffer#equals() enforces that.", "author": "dagnir", "createdAt": "2020-01-02T23:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3MDA2MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362670060", "bodyText": "Yes, sorry my comment wasn't clear. My concern about that was you were writing the same int (42) twice, therefore you don't know if what you are left with is the start or the end of the original buffer.", "author": "bmaizels", "createdAt": "2020-01-02T23:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NTg2NA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362675864", "bodyText": "Ah gotcha, yep that makes sense.", "author": "dagnir", "createdAt": "2020-01-03T00:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODQxOA=="}], "type": "inlineReview"}, {"oid": "2cd1664907cc3a78ba59f4548caef2a002de2db5", "url": "https://github.com/aws/aws-sdk-java-v2/commit/2cd1664907cc3a78ba59f4548caef2a002de2db5", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534", "committedDate": "2020-01-03T00:15:00Z", "type": "commit"}, {"oid": "2cd1664907cc3a78ba59f4548caef2a002de2db5", "url": "https://github.com/aws/aws-sdk-java-v2/commit/2cd1664907cc3a78ba59f4548caef2a002de2db5", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534", "committedDate": "2020-01-03T00:15:00Z", "type": "forcePushed"}]}