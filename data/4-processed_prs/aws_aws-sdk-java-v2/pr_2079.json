{"pr_number": 2079, "pr_title": "Fix slash path parameter in apache http client", "pr_createdAt": "2020-10-01T20:34:37Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2079", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTY2Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498501667", "bodyText": "Irrelevant but \"wow\" to this name.", "author": "Quanzzzz", "createdAt": "2020-10-01T20:41:31Z", "path": "services/s3/src/it/java/software/amazon/awssdk/services/s3/KeysWithLeadingSlashIntegrationTest.java", "diffHunk": "@@ -26,7 +26,8 @@\n public class KeysWithLeadingSlashIntegrationTest extends S3IntegrationTestBase {\n \n     private static final String BUCKET = temporaryBucketName(KeysWithLeadingSlashIntegrationTest.class);\n-    private static final String KEY = \"/stupidkeywithillegalleadingslashthatsucks\";", "originalCommit": "87fa6603cad01f097ae35ea89a2ee0b75392efcb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccef13d571397dc180a9deac2b0c398a6d4741ca", "url": "https://github.com/aws/aws-sdk-java-v2/commit/ccef13d571397dc180a9deac2b0c398a6d4741ca", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-01T20:59:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMDI3Nw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498500277", "bodyText": "Seems unnecessary.", "author": "millems", "createdAt": "2020-10-01T20:38:22Z", "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/ApacheHttpRequestConfig.java", "diffHunk": "@@ -1,3 +1,4 @@\n+", "originalCommit": "87fa6603cad01f097ae35ea89a2ee0b75392efcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzNzk3Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498537972", "bodyText": "Yup, removed it in the new revision", "author": "zoewangg", "createdAt": "2020-10-01T22:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMDI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwNjg3OA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498506878", "bodyText": "What if they are explicitly using the port? i.e. http://localhost:80/test. Is that handled correctly, without mangling the host for the signature?", "author": "millems", "createdAt": "2020-10-01T20:52:48Z", "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/impl/ApacheHttpRequestFactory.java", "diffHunk": "@@ -66,12 +66,24 @@ public HttpRequestBase create(final HttpExecuteRequest request, final ApacheHttp\n      * and other AWS services, this is allowed and required. This methods replaces\n      * any occurrence of \"//\" in the URI path with \"/%2F\".\n      *\n+     * @see SdkHttpRequest#getUri()\n      * @param uri The existing URI with double slashes not sanitized for Apache.\n      * @return a new String containing the modified URI\n      */\n     private String sanitizeUri(URI uri) {\n-        String newPath = uri.getPath().replace(\"//\", \"/%2F\");\n-        return uri.toString().replace(uri.getPath(), newPath);\n+        String path = uri.getPath();\n+        if (path.contains(\"//\")) {\n+            String newPath = path.replace(\"//\", \"/%2F\");\n+            String portString = SdkHttpUtils.isUsingStandardPort(uri.getScheme(), uri.getPort()) ?\n+                                \"\" : \":\" + uri.getPort();", "originalCommit": "87fa6603cad01f097ae35ea89a2ee0b75392efcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0MDg0NQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498540845", "bodyText": "Yeah, we should probably check if (uri.getPort()) == -1 instead. I'll update it", "author": "zoewangg", "createdAt": "2020-10-01T22:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwNjg3OA=="}], "type": "inlineReview"}, {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "url": "https://github.com/aws/aws-sdk-java-v2/commit/dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-01T22:25:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0MzA4OQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498543089", "bodyText": "What about fragment? Are there other parts of the URI we should also be worried about?", "author": "millems", "createdAt": "2020-10-01T22:28:26Z", "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/impl/ApacheHttpRequestFactory.java", "diffHunk": "@@ -66,12 +64,23 @@ public HttpRequestBase create(final HttpExecuteRequest request, final ApacheHttp\n      * and other AWS services, this is allowed and required. This methods replaces\n      * any occurrence of \"//\" in the URI path with \"/%2F\".\n      *\n+     * @see SdkHttpRequest#getUri()\n      * @param uri The existing URI with double slashes not sanitized for Apache.\n      * @return a new String containing the modified URI\n      */\n     private String sanitizeUri(URI uri) {\n-        String newPath = uri.getPath().replace(\"//\", \"/%2F\");\n-        return uri.toString().replace(uri.getPath(), newPath);\n+        String path = uri.getPath();\n+        if (path.contains(\"//\")) {\n+            String newPath = path.replace(\"//\", \"/%2F\");\n+            String port = uri.getPort() == -1 ? \"\" : String.valueOf(uri.getPort());\n+\n+            String query = uri.getQuery() == null ? \"\" : uri.getQuery();\n+\n+            return URI.create(uri.getScheme() + \"://\" +\n+                              uri.getHost() + port + newPath + query)\n+                      .toString();\n+        }", "originalCommit": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0NDE4MQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498544181", "bodyText": "We don't have fragment and other parts inSdkHttpRequest.getUri() either.\n\n  \n    \n      aws-sdk-java-v2/http-client-spi/src/main/java/software/amazon/awssdk/http/SdkHttpRequest.java\n    \n    \n        Lines 99 to 120\n      in\n      d23f9e7\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Convert this HTTP request's protocol, host, port, path and query string into a properly-encoded URI string that matches the \n        \n\n        \n          \n                * URI string used for AWS request signing. \n        \n\n        \n          \n                * \n        \n\n        \n          \n                * <p>The URI's port will be missing (-1) when the {@link #port()} is the default port for the {@link #protocol()}. (80 for \n        \n\n        \n          \n                * http and 443 for https). This is to reflect the fact that request signature does not include the port.</p> \n        \n\n        \n          \n                * \n        \n\n        \n          \n                * @return The URI for this request, formatted in the same way the AWS HTTP request signer uses the URI in the signature. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               default URI getUri() { \n        \n\n        \n          \n                   // We can't create a URI by simply passing the query parameters into the URI constructor that takes a query string, \n        \n\n        \n          \n                   // because URI will re-encode them. Because we want to encode them using our encoder, we have to build the URI \n        \n\n        \n          \n                   // ourselves and pass it to the single-argument URI constructor that doesn't perform the encoding. \n        \n\n        \n          \n            \n        \n\n        \n          \n                   String encodedQueryString = SdkHttpUtils.encodeAndFlattenQueryParameters(rawQueryParameters()) \n        \n\n        \n          \n                                                           .map(value -> \"?\" + value) \n        \n\n        \n          \n                                                           .orElse(\"\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n                   // Do not include the port in the URI when using the default port for the protocol. \n        \n\n        \n          \n                   String portString = SdkHttpUtils.isUsingStandardPort(protocol(), port()) ? \"\" : \":\" + port(); \n        \n\n        \n          \n            \n        \n\n        \n          \n                   return URI.create(protocol() + \"://\" + host() + portString + encodedPath() + encodedQueryString);", "author": "zoewangg", "createdAt": "2020-10-01T22:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0MzA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1MDQyNw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498550427", "bodyText": "Hmm... okay, future bug to fix, I suppose!", "author": "millems", "createdAt": "2020-10-01T22:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0MzA4OQ=="}], "type": "inlineReview"}, {"oid": "2b302acb2a605ac4b0efa5e6d97552220e2c334d", "url": "https://github.com/aws/aws-sdk-java-v2/commit/2b302acb2a605ac4b0efa5e6d97552220e2c334d", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-01T23:01:05Z", "type": "forcePushed"}, {"oid": "e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "url": "https://github.com/aws/aws-sdk-java-v2/commit/e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-02T00:02:36Z", "type": "forcePushed"}, {"oid": "d0f0e0a72444ab367d7f340c350b63b76551927a", "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0f0e0a72444ab367d7f340c350b63b76551927a", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-02T00:03:59Z", "type": "commit"}, {"oid": "d0f0e0a72444ab367d7f340c350b63b76551927a", "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0f0e0a72444ab367d7f340c350b63b76551927a", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.", "committedDate": "2020-10-02T00:03:59Z", "type": "forcePushed"}]}