{"pr_number": 2031, "pr_title": "Update codegen module to generate service waiter implementation classes", "pr_createdAt": "2020-09-11T01:35:41Z", "pr_url": "https://github.com/aws/aws-sdk-java-v2/pull/2031", "timeline": [{"oid": "7320ba13961d6b7c364c2d4b996003b252769a2b", "url": "https://github.com/aws/aws-sdk-java-v2/commit/7320ba13961d6b7c364c2d4b996003b252769a2b", "message": "Update codegen module to generate service waiter implementation classes", "committedDate": "2020-09-11T01:41:24Z", "type": "forcePushed"}, {"oid": "beaa43c44fad5c6269d2b0b5b0ebaaaad9f57f81", "url": "https://github.com/aws/aws-sdk-java-v2/commit/beaa43c44fad5c6269d2b0b5b0ebaaaad9f57f81", "message": "Update codegen module to generate service waiter implementation classes", "committedDate": "2020-09-11T04:05:40Z", "type": "forcePushed"}, {"oid": "4c38a5594d4d1d9a0c61b691e30f928cfa24ed57", "url": "https://github.com/aws/aws-sdk-java-v2/commit/4c38a5594d4d1d9a0c61b691e30f928cfa24ed57", "message": "Update codegen module to generate service waiter implementation classes", "committedDate": "2020-09-11T17:23:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMTE2Mw==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487221163", "bodyText": "minor: use $S here so you don't need to escape the quotes", "author": "dagnir", "createdAt": "2020-09-11T18:36:09Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/waiters/AsyncWaiterClassSpec.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.codegen.poet.waiters;\n+\n+import static javax.lang.model.element.Modifier.FINAL;\n+import static javax.lang.model.element.Modifier.PRIVATE;\n+import static javax.lang.model.element.Modifier.STATIC;\n+\n+import com.squareup.javapoet.ClassName;\n+import com.squareup.javapoet.FieldSpec;\n+import com.squareup.javapoet.MethodSpec;\n+import com.squareup.javapoet.ParameterizedTypeName;\n+import com.squareup.javapoet.TypeSpec;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import javax.lang.model.element.Modifier;\n+import software.amazon.awssdk.codegen.model.intermediate.IntermediateModel;\n+import software.amazon.awssdk.codegen.model.intermediate.OperationModel;\n+import software.amazon.awssdk.codegen.poet.PoetExtensions;\n+import software.amazon.awssdk.core.internal.waiters.WaiterAttribute;\n+import software.amazon.awssdk.core.waiters.AsyncWaiter;\n+import software.amazon.awssdk.core.waiters.WaiterResponse;\n+import software.amazon.awssdk.utils.ThreadFactoryBuilder;\n+\n+public class AsyncWaiterClassSpec extends BaseWaiterClassSpec {\n+\n+    private final PoetExtensions poetExtensions;\n+    private final ClassName className;\n+    private final IntermediateModel model;\n+    private final String modelPackage;\n+\n+    public AsyncWaiterClassSpec(IntermediateModel model) {\n+        super(model, ClassName.get(AsyncWaiter.class));\n+        this.model = model;\n+        this.modelPackage = model.getMetadata().getFullModelPackageName();\n+        this.poetExtensions = new PoetExtensions(model);\n+        this.className = poetExtensions.getAsyncWaiterClass();\n+    }\n+\n+    @Override\n+    public ClassName className() {\n+        return className;\n+    }\n+\n+    @Override\n+    protected ClassName clientClassName() {\n+        return poetExtensions.getClientClass(model.getMetadata().getAsyncInterface());\n+    }\n+\n+    @Override\n+    protected ParameterizedTypeName getWaiterResponseType(OperationModel opModel) {\n+        ClassName pojoResponse = ClassName.get(modelPackage, opModel.getReturnType().getReturnType());\n+        ParameterizedTypeName waiterResponse = ParameterizedTypeName.get(ClassName.get(WaiterResponse.class), pojoResponse);\n+\n+        return ParameterizedTypeName.get(ClassName.get(CompletableFuture.class),\n+                                         waiterResponse);\n+    }\n+\n+    @Override\n+    protected ClassName interfaceClassName() {\n+        return poetExtensions.getAsyncWaiterInterface();\n+    }\n+\n+    @Override\n+    protected Optional<String> additionalWaiterConfig() {\n+        return Optional.of(\".scheduledExecutorService(executorService)\");\n+    }\n+\n+    @Override\n+    protected void additionalConstructorInitialization(MethodSpec.Builder method) {\n+        method.beginControlFlow(\"if (builder.executorService == null)\")\n+              .addStatement(\"this.executorService = $T.newScheduledThreadPool(5, new $T().threadNamePrefix\"\n+                            + \"(\\\"waiters-ScheduledExecutor\\\").build())\",", "originalCommit": "4c38a5594d4d1d9a0c61b691e30f928cfa24ed57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzAxOQ==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487223019", "bodyText": "Should we have provider overload, where the returned executors are managed by the SDK?", "author": "dagnir", "createdAt": "2020-09-11T18:40:03Z", "path": "codegen/src/test/resources/software/amazon/awssdk/codegen/poet/waiters/query-async-waiter-interface.java", "diffHunk": "@@ -35,11 +37,23 @@\n      *\n      * @return a builder\n      */\n-    static void builder() {\n-        throw new UnsupportedOperationException();\n+    static Builder builder() {\n+        return DefaultQueryAsyncWaiter.builder();\n     }\n \n     interface Builder {\n+        /**\n+         * Sets a custom {@link ScheduledExecutorService} that will be used to schedule async polling attempts\n+         * <p>\n+         * This executorService must be closed by the caller when it is ready to be disposed. The SDK will not close the\n+         * executorService when the waiter is closed\n+         *\n+         * @param executorService\n+         *        the executorService to set\n+         * @return a reference to this object so that method calls can be chained together.\n+         */\n+        Builder executorService(ScheduledExecutorService executorService);", "originalCommit": "4c38a5594d4d1d9a0c61b691e30f928cfa24ed57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyOTI4Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487229286", "bodyText": "I like the idea, but we don't have it for the futureCompletionExecutorService override either. I feel this is additive and we can add it in the future if people are asking for it. I'd expect most customers to use the waiters retrieved the service clients, where they don't need to configure it at all.", "author": "zoewangg", "createdAt": "2020-09-11T18:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMDE0Ng==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487230146", "bodyText": "Sounds good", "author": "dagnir", "createdAt": "2020-09-11T18:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzgzOA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487223838", "bodyText": "Hmm why does the async waiter need a threadpool? Would it be enough to just rely on the async client?", "author": "dagnir", "createdAt": "2020-09-11T18:41:48Z", "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/waiters/AsyncWaiterClassSpec.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.codegen.poet.waiters;\n+\n+import static javax.lang.model.element.Modifier.FINAL;\n+import static javax.lang.model.element.Modifier.PRIVATE;\n+import static javax.lang.model.element.Modifier.STATIC;\n+\n+import com.squareup.javapoet.ClassName;\n+import com.squareup.javapoet.FieldSpec;\n+import com.squareup.javapoet.MethodSpec;\n+import com.squareup.javapoet.ParameterizedTypeName;\n+import com.squareup.javapoet.TypeSpec;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import javax.lang.model.element.Modifier;\n+import software.amazon.awssdk.codegen.model.intermediate.IntermediateModel;\n+import software.amazon.awssdk.codegen.model.intermediate.OperationModel;\n+import software.amazon.awssdk.codegen.poet.PoetExtensions;\n+import software.amazon.awssdk.core.internal.waiters.WaiterAttribute;\n+import software.amazon.awssdk.core.waiters.AsyncWaiter;\n+import software.amazon.awssdk.core.waiters.WaiterResponse;\n+import software.amazon.awssdk.utils.ThreadFactoryBuilder;\n+\n+public class AsyncWaiterClassSpec extends BaseWaiterClassSpec {\n+\n+    private final PoetExtensions poetExtensions;\n+    private final ClassName className;\n+    private final IntermediateModel model;\n+    private final String modelPackage;\n+\n+    public AsyncWaiterClassSpec(IntermediateModel model) {\n+        super(model, ClassName.get(AsyncWaiter.class));\n+        this.model = model;\n+        this.modelPackage = model.getMetadata().getFullModelPackageName();\n+        this.poetExtensions = new PoetExtensions(model);\n+        this.className = poetExtensions.getAsyncWaiterClass();\n+    }\n+\n+    @Override\n+    public ClassName className() {\n+        return className;\n+    }\n+\n+    @Override\n+    protected ClassName clientClassName() {\n+        return poetExtensions.getClientClass(model.getMetadata().getAsyncInterface());\n+    }\n+\n+    @Override\n+    protected ParameterizedTypeName getWaiterResponseType(OperationModel opModel) {\n+        ClassName pojoResponse = ClassName.get(modelPackage, opModel.getReturnType().getReturnType());\n+        ParameterizedTypeName waiterResponse = ParameterizedTypeName.get(ClassName.get(WaiterResponse.class), pojoResponse);\n+\n+        return ParameterizedTypeName.get(ClassName.get(CompletableFuture.class),\n+                                         waiterResponse);\n+    }\n+\n+    @Override\n+    protected ClassName interfaceClassName() {\n+        return poetExtensions.getAsyncWaiterInterface();\n+    }\n+\n+    @Override\n+    protected Optional<String> additionalWaiterConfig() {\n+        return Optional.of(\".scheduledExecutorService(executorService)\");\n+    }\n+\n+    @Override\n+    protected void additionalConstructorInitialization(MethodSpec.Builder method) {\n+        method.beginControlFlow(\"if (builder.executorService == null)\")", "originalCommit": "4c38a5594d4d1d9a0c61b691e30f928cfa24ed57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyNjM1MA==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487226350", "bodyText": "We still need a ScheduledExecutorService to schedule the attempts.", "author": "zoewangg", "createdAt": "2020-09-11T18:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyOTk3Mg==", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2031#discussion_r487229972", "bodyText": "Ah gotcha forgot about the backoffs", "author": "dagnir", "createdAt": "2020-09-11T18:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzgzOA=="}], "type": "inlineReview"}, {"oid": "f48a0868c082fe9e956aa5137c50dcc53210e324", "url": "https://github.com/aws/aws-sdk-java-v2/commit/f48a0868c082fe9e956aa5137c50dcc53210e324", "message": "Update codegen module to generate service waiter implementation classes", "committedDate": "2020-09-11T20:03:16Z", "type": "commit"}, {"oid": "f48a0868c082fe9e956aa5137c50dcc53210e324", "url": "https://github.com/aws/aws-sdk-java-v2/commit/f48a0868c082fe9e956aa5137c50dcc53210e324", "message": "Update codegen module to generate service waiter implementation classes", "committedDate": "2020-09-11T20:03:16Z", "type": "forcePushed"}]}