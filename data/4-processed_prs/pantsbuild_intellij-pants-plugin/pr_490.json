{"pr_number": 490, "pr_title": "Fix pants version parsing", "pr_createdAt": "2020-02-06T17:21:36Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490", "timeline": [{"oid": "71966d8a828458407a1d51d722754109cc9c83f6", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/71966d8a828458407a1d51d722754109cc9c83f6", "message": "Change isCompatiblePantsVersion to use the new class instead", "committedDate": "2020-02-06T17:36:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NDY2Mw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r375994663", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Link to regular expression cehcking this: https://regex101.com/r/SUZCl6/2\n          \n          \n            \n              // Link to regular expression checking this: https://regex101.com/r/SUZCl6/2", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:03:45Z", "path": "common/com/twitter/intellij/pants/model/PantsVersion.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.model;\n+\n+import com.twitter.intellij.pants.PantsException;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class PantsVersion {\n+\n+  private int major;\n+  private int minor;\n+  private int patch;\n+  private PantsPatchVersionKind kind;\n+\n+  // Link to regular expression cehcking this: https://regex101.com/r/SUZCl6/2", "originalCommit": "e7614e521201ae3da894edefba86fcf5b96ae5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMjU1OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376002559", "bodyText": "Btw, fantastic move to link to regex101.com -- thanks for thinking about this! This is exactly how we make regex a little more comprehensible.", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NDY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDI4MQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376000281", "bodyText": "I might also add a test for a version like 1.24.0rc1-git2481dab2-md59a1c1708 as well, since we see that in our internal pants repo. I am pretty sure that the parsing mechanism you've developed here is only going to capture the relevant numbers, but in the case that we modify the parsing in the future, it might be good to have a complete example?", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:15:46Z", "path": "tests/com/twitter/intellij/pants/util/PantsUtilTest.java", "diffHunk": "@@ -40,17 +31,19 @@ public void testIsPantsProjectFile() {\n   }\n \n   public void testIsCompatibleVersion() {\n-    assertTrue(PantsUtil.isCompatibleVersion(\"2.2.3\", \"1.2.3\"));\n-    assertTrue(PantsUtil.isCompatibleVersion(\"1.4.4\", \"1.2.3\"));\n-    assertTrue(PantsUtil.isCompatibleVersion(\"1.2.4\", \"1.2.3\"));\n-    assertTrue(PantsUtil.isCompatibleVersion(\"1.2.4rc0\", \"1.2.3\"));\n-    assertTrue(PantsUtil.isCompatibleVersion(\"1.2.4.dev0\", \"1.2.3\"));\n-    assertTrue(PantsUtil.isCompatibleVersion(\"1.2.3\", \"1.2.3\"));\n-\n-    assertFalse(PantsUtil.isCompatibleVersion(\"1.2.0rc122\", \"1.2.3\"));\n-    assertFalse(PantsUtil.isCompatibleVersion(\"2.34.43\", \"2.34.44\"));\n-    assertFalse(PantsUtil.isCompatibleVersion(\"2.33.44\", \"2.34.44\"));\n-    assertFalse(PantsUtil.isCompatibleVersion(\"1.34.44\", \"2.34.44\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"2.2.3\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.4.4\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.4\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.4rc0\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.4.dev0\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.3\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.3+git12345678\", \"1.2.3\"));\n+    assertTrue(PantsUtil.isCompatiblePantsVersion(\"1.2.3-git12345678\", \"1.2.3\"));", "originalCommit": "e7614e521201ae3da894edefba86fcf5b96ae5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMTkzNw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376331937", "bodyText": "Added! Thanks", "author": "blorente", "createdAt": "2020-02-07T10:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDcwMw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376000703", "bodyText": "Good change!! Thank you for fixing up naming hygiene here!", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:16:37Z", "path": "common/com/twitter/intellij/pants/util/PantsUtil.java", "diffHunk": "@@ -214,16 +211,17 @@ public static boolean isScalaRelatedTestRunConfiguration(RunConfiguration rc) {\n     return workingDir.map(file -> file.findChild(PantsConstants.PANTS_INI));\n   }\n \n-  public static boolean isCompatiblePantsVersion(String projectPath, String minVersion) {\n+  public static boolean isCompatibleProjectPantsVersion(String projectPath, String minVersion) {\n     return PantsUtil.findPantsExecutable(projectPath)\n       .flatMap(exec -> PantsOptions.getPantsOptions(exec.getPath()).get(\"pants_version\"))\n-      .map(version -> PantsUtil.isCompatibleVersion(version, minVersion))\n+      .map(version -> PantsUtil.isCompatiblePantsVersion(version, minVersion))\n       .orElse(false);\n   }\n \n-  public static boolean isCompatibleVersion(String current, String minimum) {\n-    String currentVersion = current.replaceAll(\"rc.+\", \"\").trim();\n-    return versionCompare(currentVersion, minimum) >= 0;\n+  public static boolean isCompatiblePantsVersion(String current, String minimum) {", "originalCommit": "e7614e521201ae3da894edefba86fcf5b96ae5d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNDI0Ng==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376004246", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String PANTS_VERSION_FORMAT = \"(\\\\d+)\\\\.(\\\\d+)\\\\.(\\\\d+)(rc\\\\d+|\\\\.dev\\\\d+)?\";\n          \n          \n            \n              private static final String PANTS_VERSION_FORMAT = \"^(\\\\d+)\\\\.(\\\\d+)\\\\.(\\\\d+)(rc\\\\d+|\\\\.dev\\\\d+)?\";", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:23:59Z", "path": "common/com/twitter/intellij/pants/model/PantsVersion.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.model;\n+\n+import com.twitter.intellij.pants.PantsException;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class PantsVersion {\n+\n+  private int major;\n+  private int minor;\n+  private int patch;\n+  private PantsPatchVersionKind kind;\n+\n+  // Link to regular expression cehcking this: https://regex101.com/r/SUZCl6/2\n+  private static final String PANTS_VERSION_FORMAT = \"(\\\\d+)\\\\.(\\\\d+)\\\\.(\\\\d+)(rc\\\\d+|\\\\.dev\\\\d+)?\";", "originalCommit": "e7614e521201ae3da894edefba86fcf5b96ae5d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNTE1NA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376005154", "bodyText": "Is there a reason we're using Pattern.MULTILINE here? I believe that would convert the above ^ into start-of-line instead of start-of-input, see: https://stackoverflow.com/a/6143347/2518889.", "author": "cosmicexplorer", "createdAt": "2020-02-06T18:25:48Z", "path": "common/com/twitter/intellij/pants/model/PantsVersion.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.model;\n+\n+import com.twitter.intellij.pants.PantsException;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class PantsVersion {\n+\n+  private int major;\n+  private int minor;\n+  private int patch;\n+  private PantsPatchVersionKind kind;\n+\n+  // Link to regular expression cehcking this: https://regex101.com/r/SUZCl6/2\n+  private static final String PANTS_VERSION_FORMAT = \"(\\\\d+)\\\\.(\\\\d+)\\\\.(\\\\d+)(rc\\\\d+|\\\\.dev\\\\d+)?\";\n+  final Pattern pants_version_pattern = Pattern.compile(PANTS_VERSION_FORMAT, Pattern.MULTILINE);", "originalCommit": "e7614e521201ae3da894edefba86fcf5b96ae5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzMjEyMg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/490#discussion_r376332122", "bodyText": "Changed, thanks! I like the ^ a lot, btw :) Nice catch.", "author": "blorente", "createdAt": "2020-02-07T10:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNTE1NA=="}], "type": "inlineReview"}, {"oid": "095411e744fdf67441ad9340a66f785a30d2a3b0", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/095411e744fdf67441ad9340a66f785a30d2a3b0", "message": "Add some extra test cases for parsing", "committedDate": "2020-02-07T10:55:13Z", "type": "forcePushed"}, {"oid": "10a30d717c767a21524cf260cb0fa8792c3eccfd", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/10a30d717c767a21524cf260cb0fa8792c3eccfd", "message": "Update TargetFileResolutionIntegrationTest.java", "committedDate": "2020-02-21T17:23:26Z", "type": "forcePushed"}, {"oid": "b4a67a3ab822298c2b385c5425e260879f0ff9a7", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/b4a67a3ab822298c2b385c5425e260879f0ff9a7", "message": "Update TargetFileResolutionIntegrationTest.java", "committedDate": "2020-02-21T17:25:59Z", "type": "forcePushed"}, {"oid": "6c62d64c12e4e2817751597b4616f7db469be8b9", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/6c62d64c12e4e2817751597b4616f7db469be8b9", "message": "Add PantsVersion to model\n\nTypo in a comment\n\nCo-Authored-By: Danny McClanahan <1305167+cosmicexplorer@users.noreply.github.com>\n\nImprove parsing regex to use beginning of line.\n\nCo-Authored-By: Danny McClanahan <1305167+cosmicexplorer@users.noreply.github.com>\n\nTo merge into impl", "committedDate": "2020-02-21T17:27:45Z", "type": "commit"}, {"oid": "78b576cd3c36a37be87984719208fc0833f3985f", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/78b576cd3c36a37be87984719208fc0833f3985f", "message": "Rename isCompatibleVersion and isCompatiblePantsVersion", "committedDate": "2020-02-21T17:28:51Z", "type": "commit"}, {"oid": "bdf995e92e853d8ba8475a914434e8effdeb68cc", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/bdf995e92e853d8ba8475a914434e8effdeb68cc", "message": "Change isCompatiblePantsVersion to use the new class instead", "committedDate": "2020-02-21T17:28:51Z", "type": "commit"}, {"oid": "1143f6b1abf80d534f1749232c39245739b4ba53", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/1143f6b1abf80d534f1749232c39245739b4ba53", "message": "Add some extra test cases for parsing", "committedDate": "2020-02-21T17:28:51Z", "type": "commit"}, {"oid": "af06f49ffc65f73593c1b2a78cc0da97d598e978", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/af06f49ffc65f73593c1b2a78cc0da97d598e978", "message": "Update regex101 link", "committedDate": "2020-02-21T17:28:51Z", "type": "commit"}, {"oid": "42e8f0e1369f532b2e520944c666940eee59b77e", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/42e8f0e1369f532b2e520944c666940eee59b77e", "message": "Update TargetFileResolutionIntegrationTest.java", "committedDate": "2020-02-21T17:29:13Z", "type": "commit"}, {"oid": "42e8f0e1369f532b2e520944c666940eee59b77e", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/42e8f0e1369f532b2e520944c666940eee59b77e", "message": "Update TargetFileResolutionIntegrationTest.java", "committedDate": "2020-02-21T17:29:13Z", "type": "forcePushed"}, {"oid": "e6a6dfac89b792e63eaa1a50499d1ecbc9bfd0da", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/e6a6dfac89b792e63eaa1a50499d1ecbc9bfd0da", "message": "Merge branch 'master' into test_abc", "committedDate": "2020-02-23T08:47:59Z", "type": "commit"}, {"oid": "27e6cc94e9c81bb1514d87ce1ea2583991365c63", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/27e6cc94e9c81bb1514d87ce1ea2583991365c63", "message": "fix", "committedDate": "2020-02-23T09:11:35Z", "type": "commit"}, {"oid": "a4e019e3b792f9aa97a801b15867d63cbbcc8813", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/a4e019e3b792f9aa97a801b15867d63cbbcc8813", "message": "fix", "committedDate": "2020-02-23T09:59:57Z", "type": "commit"}]}