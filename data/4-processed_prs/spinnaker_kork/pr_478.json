{"pr_number": 478, "pr_title": "refactor(secrets/s3): s3 custom endpoint", "pr_createdAt": "2020-01-20T17:59:04Z", "pr_url": "https://github.com/spinnaker/kork/pull/478", "timeline": [{"oid": "aa9ddcb3c001d7f497528a53154bd59c3a8c6618", "url": "https://github.com/spinnaker/kork/commit/aa9ddcb3c001d7f497528a53154bd59c3a8c6618", "message": "Add the url to the s3 configuration properties in order to point to custom buckets (Minio for example)", "committedDate": "2020-01-16T17:07:23Z", "type": "commit"}, {"oid": "f830479fa21751799c8216d004ab8388ad6edda9", "url": "https://github.com/spinnaker/kork/commit/f830479fa21751799c8216d004ab8388ad6edda9", "message": "remove lombok version, rename configuration parameters, validate a possible NPE", "committedDate": "2020-01-17T18:07:16Z", "type": "commit"}, {"oid": "75ff4d41a95b2cfb60b0c76571a5c5a4a77dfff1", "url": "https://github.com/spinnaker/kork/commit/75ff4d41a95b2cfb60b0c76571a5c5a4a77dfff1", "message": "replace ConditionalOnExpression by ConditionalOnProperty on configuration, rename attributes", "committedDate": "2020-01-20T17:34:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDMyOA==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r368690328", "bodyText": "Logger isn't used anywhere in this class - remove.", "author": "robzienert", "createdAt": "2020-01-20T18:59:31Z", "path": "kork-secrets-aws/src/main/java/com/netflix/spinnaker/kork/secrets/engines/S3Configuration.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Armory, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.secrets.engines;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.stereotype.Component;\n+\n+@Getter\n+@Component\n+@Configuration\n+@ConditionalOnProperty(\"secrets.s3.enabled\")\n+@Slf4j", "originalCommit": "75ff4d41a95b2cfb60b0c76571a5c5a4a77dfff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTI3NA==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r369319274", "bodyText": "removed", "author": "jorgebee65", "createdAt": "2020-01-22T00:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDczMA==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r368690730", "bodyText": "This class is odd: It's acting like a @ConfigurationProperties, but it isn't one.\nWe prefer to avoid the use of @Value annotations in favor of @ConfigurationProperties classes that get injected where they need to go. Would recommend refactoring to fall in line with this pattern.", "author": "robzienert", "createdAt": "2020-01-20T19:00:51Z", "path": "kork-secrets-aws/src/main/java/com/netflix/spinnaker/kork/secrets/engines/S3Configuration.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Armory, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.secrets.engines;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.stereotype.Component;\n+\n+@Getter\n+@Component\n+@Configuration\n+@ConditionalOnProperty(\"secrets.s3.enabled\")\n+@Slf4j\n+public class S3Configuration {\n+\n+  private String endpointUrl;\n+  private boolean pathStyleAccessEnabled;\n+\n+  @Autowired\n+  public S3Configuration(\n+      @Value(\"${secrets.s3.endpoint-url}\") String endpointUrl,\n+      @Value(\"${secrets.s3.path-style-access-enabled}\") boolean pathStyleAccessEnabled) {", "originalCommit": "75ff4d41a95b2cfb60b0c76571a5c5a4a77dfff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MTE5OA==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r368691198", "bodyText": "I'm also worried (having not looked at the whole module) that you have a @ConditionalOnProperty annotation here, but then use it directly in S3SecretEngine's constructor, but have it typed as a required object. Depending on how the rest of the module is wired up, this could cause a runtime exception during startup.", "author": "robzienert", "createdAt": "2020-01-20T19:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMyMDA3NQ==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r369320075", "bodyText": "S3Configuration changed according to the pattern.\nS3SecretEngine: change the initialization from the constructor to an Autowired (not required) attribute.", "author": "jorgebee65", "createdAt": "2020-01-22T00:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNTI5MQ==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r371405291", "bodyText": "Do not use property injection. If the property is not required, you can still use constructor injection, but you have to wrap the optional properties in Optional:\nclass Foo {\n  private final Optional<MyDep> myDep;\n\n  Foo(Optional<MyDep> myDep) {\n    this.myDep = myDep;\n  }\n}", "author": "robzienert", "createdAt": "2020-01-27T18:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzMTc5Nw==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r372031797", "bodyText": "changed following the instructions.", "author": "jorgebee65", "createdAt": "2020-01-28T20:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5MDczMA=="}], "type": "inlineReview"}, {"oid": "b15f96b72f9e9afffc6c17b449fb655b8eb3c023", "url": "https://github.com/spinnaker/kork/commit/b15f96b72f9e9afffc6c17b449fb655b8eb3c023", "message": "refactor(secrets/s3): s3 custom endpoint, remove logger from S3CongigurationProperties class, also change from Component to Configuration annotation and ConfigurationProperties instead Values, in S3SecretEngine add an Autowired (required = false) property instead of initialize from constructor", "committedDate": "2020-01-22T00:37:22Z", "type": "commit"}, {"oid": "24c9f8440f4fb467d0cb15acf636218246dc5efe", "url": "https://github.com/spinnaker/kork/commit/24c9f8440f4fb467d0cb15acf636218246dc5efe", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-22T14:44:55Z", "type": "commit"}, {"oid": "ef4bf8c42bd3adbfde3281624d249a31d467c494", "url": "https://github.com/spinnaker/kork/commit/ef4bf8c42bd3adbfde3281624d249a31d467c494", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-24T17:11:51Z", "type": "commit"}, {"oid": "67255da32918ac61421910e22cdb0a4a5a60ce00", "url": "https://github.com/spinnaker/kork/commit/67255da32918ac61421910e22cdb0a4a5a60ce00", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-27T16:16:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNDE5Nw==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r371404197", "bodyText": "Just do org.projectlombok:lombok so that kork-bom takes care of the lombok version.", "author": "robzienert", "createdAt": "2020-01-27T18:22:16Z", "path": "kork-secrets-aws/kork-secrets-aws.gradle", "diffHunk": "@@ -6,4 +6,8 @@ dependencies {\n   api project(':kork-secrets')\n \n   implementation \"com.amazonaws:aws-java-sdk-s3\"\n+\n+  compileOnly 'org.projectlombok:lombok:+'\n+\n+  annotationProcessor 'org.projectlombok:lombok:+'", "originalCommit": "67255da32918ac61421910e22cdb0a4a5a60ce00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzMjkxMg==", "url": "https://github.com/spinnaker/kork/pull/478#discussion_r372032912", "bodyText": "I just remove these lines and add: \"$rootDir/gradle/lombok.gradle\"", "author": "jorgebee65", "createdAt": "2020-01-28T20:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNDE5Nw=="}], "type": "inlineReview"}, {"oid": "159c49577ac45c3846730f2b7c165c9fd507bdb2", "url": "https://github.com/spinnaker/kork/commit/159c49577ac45c3846730f2b7c165c9fd507bdb2", "message": "refactor(secrets/s3): Change the S3ConfigurationProperties injection from property to constructor wrapping it as Optional, also change the lombok references by a plugin", "committedDate": "2020-01-28T20:02:34Z", "type": "commit"}, {"oid": "9699730ef2b14b1ce409324656c4000e4d4f05fa", "url": "https://github.com/spinnaker/kork/commit/9699730ef2b14b1ce409324656c4000e4d4f05fa", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-28T20:16:43Z", "type": "commit"}, {"oid": "0333eb927486c51dcc33f4aebe03f8c17da81aa0", "url": "https://github.com/spinnaker/kork/commit/0333eb927486c51dcc33f4aebe03f8c17da81aa0", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-28T23:01:58Z", "type": "commit"}, {"oid": "593c9a14b2c09fa7e499d8b4909a1c1b843e827a", "url": "https://github.com/spinnaker/kork/commit/593c9a14b2c09fa7e499d8b4909a1c1b843e827a", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-01-29T18:28:55Z", "type": "commit"}, {"oid": "30d5491139bdc2a4836d38d95fa3b9de90e8c2e0", "url": "https://github.com/spinnaker/kork/commit/30d5491139bdc2a4836d38d95fa3b9de90e8c2e0", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-02-03T16:42:12Z", "type": "commit"}, {"oid": "380c6fe1db5da95c082b690bc338510fae51fc30", "url": "https://github.com/spinnaker/kork/commit/380c6fe1db5da95c082b690bc338510fae51fc30", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-02-05T15:07:47Z", "type": "commit"}, {"oid": "967a89b845e464ec85cf7965be69cc7644bbb9f6", "url": "https://github.com/spinnaker/kork/commit/967a89b845e464ec85cf7965be69cc7644bbb9f6", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-02-10T15:25:35Z", "type": "commit"}, {"oid": "7261a9fafb03e68dbbc7da1665dddc7edd43acf3", "url": "https://github.com/spinnaker/kork/commit/7261a9fafb03e68dbbc7da1665dddc7edd43acf3", "message": "Merge branch 'master' into s3-custom-url", "committedDate": "2020-02-10T20:58:13Z", "type": "commit"}]}