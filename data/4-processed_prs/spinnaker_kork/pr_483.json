{"pr_number": 483, "pr_title": "fix(plugins): Fixes for SpinnakerPluginInfo, front50 update repository, and other minor issues", "pr_createdAt": "2020-01-21T23:23:11Z", "pr_url": "https://github.com/spinnaker/kork/pull/483", "timeline": [{"oid": "7d0d28383fb8f2663efd77825599132cc176f511", "url": "https://github.com/spinnaker/kork/commit/7d0d28383fb8f2663efd77825599132cc176f511", "message": "fix(plugins): Fixes for reading remote SpinnakerPluginInfo and other minor issues", "committedDate": "2020-01-21T23:44:48Z", "type": "commit"}, {"oid": "7d0d28383fb8f2663efd77825599132cc176f511", "url": "https://github.com/spinnaker/kork/commit/7d0d28383fb8f2663efd77825599132cc176f511", "message": "fix(plugins): Fixes for reading remote SpinnakerPluginInfo and other minor issues", "committedDate": "2020-01-21T23:44:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODI2MA==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369308260", "bodyText": "This basically ensures we have a decent configuration process such that if front50.baseUrl is already defined in the config the operator does not need to add the url to spinnaker.extensibility.repositories.front50.url.", "author": "jonsie", "createdAt": "2020-01-21T23:59:47Z", "path": "kork-plugins/src/main/java/com/netflix/spinnaker/config/Front50UpdateRepositoryConfiguration.java", "diffHunk": "@@ -60,6 +61,21 @@ public static UpdateRepository pluginFront50UpdateRepository(\n                         \"Unable to bind ok-http-client property to \"\n                             + OkHttpClientConfigurationProperties.class.getSimpleName()));\n \n+    URL defaultFront50Url =\n+        Binder.get(environment)\n+            .bind(\"front50.base-url\", Bindable.of(URL.class))\n+            .orElseThrow(\n+                () ->\n+                    new BeanCreationException(\n+                        \"Unable to bind front50.base-url property to \"\n+                            + URL.class.getSimpleName()));\n+\n+    PluginRepositoryProperties front50RepositoryProps =\n+        pluginRepositoriesConfig.get(PluginsConfigurationProperties.FRONT5O_REPOSITORY);\n+\n+    URL front50Url =\n+        defaultFront50Url != null ? defaultFront50Url : front50RepositoryProps.getUrl();\n+", "originalCommit": "7d0d28383fb8f2663efd77825599132cc176f511", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODcyOA==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369308728", "bodyText": "There are no getters or setters on the parent PluginInfo public fields, so I had to do this to support SpinnakerPluginRelease.", "author": "jonsie", "createdAt": "2020-01-22T00:01:30Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/SpinnakerPluginInfo.kt", "diffHunk": "@@ -16,12 +16,20 @@\n \n package com.netflix.spinnaker.kork.plugins.update\n \n-import com.fasterxml.jackson.annotation.JsonProperty\n+import com.fasterxml.jackson.annotation.JsonSetter\n import org.pf4j.update.PluginInfo\n \n-data class SpinnakerPluginInfo(\n-  @JsonProperty(\"releases\") val spinnakerReleases: List<SpinnakerPluginRelease>\n-) : PluginInfo() {\n+class SpinnakerPluginInfo : PluginInfo() {\n+\n+  @Suppress(\"UNCHECKED_CAST\")\n+  fun getReleases(): List<SpinnakerPluginRelease> {\n+    return releases as List<SpinnakerPluginRelease>\n+  }\n+\n+  @JsonSetter(\"releases\")\n+  fun setReleases(spinnakerReleases: List<SpinnakerPluginRelease>) {\n+    releases = spinnakerReleases\n+  }", "originalCommit": "7d0d28383fb8f2663efd77825599132cc176f511", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTAyMw==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369309023", "bodyText": "These changes ensure we load and start plugins once (from ExtensionBeanDefinitionRegistryPostProcessor).  This is more efficient and I think easier to understand.", "author": "jonsie", "createdAt": "2020-01-22T00:02:34Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/SpinnakerUpdateManager.kt", "diffHunk": "@@ -85,21 +73,24 @@ class SpinnakerUpdateManager(\n       return false\n     }\n \n-    val pluginsRoot = pluginManager.pluginsRoot\n-    val file = pluginsRoot.resolve(downloaded.fileName)\n-    try {\n-      Files.move(downloaded, file, StandardCopyOption.REPLACE_EXISTING)\n-    } catch (e: IOException) {\n-      throw PluginRuntimeException(\"Failed to write plugin file {} to plugin folder\", file)\n-    }\n-\n-    val newPluginId = pluginManager.loadPlugin(file)\n-    val state = pluginManager.startPlugin(newPluginId)\n-\n-    return PluginState.STARTED == state\n+    return pluginManager.pluginsRoot.write(downloaded)\n   }\n \n+  /**\n+   * Exists to expose protected [downloadPlugin]\n+   */\n   fun downloadPluginRelease(pluginId: String, version: String): Path {\n     return downloadPlugin(pluginId, version)\n   }\n+\n+  private fun Path.write(downloaded: Path): Boolean {\n+    val file = this.resolve(downloaded.fileName)\n+    File(this.toString()).mkdirs()\n+    try {\n+      return Files.move(downloaded, file, StandardCopyOption.REPLACE_EXISTING)\n+        .contains(downloaded.fileName)\n+    } catch (e: IOException) {\n+      throw PluginRuntimeException(e, \"Failed to write file '{}' to plugins folder\", file)\n+    }\n+  }", "originalCommit": "7d0d28383fb8f2663efd77825599132cc176f511", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTM3OA==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369309378", "bodyText": "There may be a way around this, but I think it's the standard pattern with Retrofit2 to wrap the result in a Call.  Without this, we threw a Retrofit exception.", "author": "jonsie", "createdAt": "2020-01-22T00:03:58Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/front50/Front50Service.kt", "diffHunk": "@@ -29,8 +30,8 @@ import retrofit2.http.Query\n interface Front50Service {\n \n   @GET(\"/pluginInfo/{id}\")\n-  fun getById(@Path(\"id\") id: String): SpinnakerPluginInfo\n+  fun getById(@Path(\"id\") id: String): Call<SpinnakerPluginInfo>\n \n   @GET(\"/pluginInfo\")\n-  fun list(@Query(\"service\") service: String): Collection<SpinnakerPluginInfo>\n+  fun list(@Query(\"service\") service: String): Call<Collection<SpinnakerPluginInfo>>", "originalCommit": "7d0d28383fb8f2663efd77825599132cc176f511", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1OTY4Mw==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369759683", "bodyText": "This kind of leakiness is why I don't like Retrofit.", "author": "robzienert", "createdAt": "2020-01-22T19:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTM3OA=="}], "type": "inlineReview"}, {"oid": "f06ba484f75766484b4f28f2d002743b0985ce3e", "url": "https://github.com/spinnaker/kork/commit/f06ba484f75766484b4f28f2d002743b0985ce3e", "message": "fix(plugins): Minor refactor to disable UpdateManager installPlugin and updatePlugin usage", "committedDate": "2020-01-22T19:25:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2MDQ3Ng==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369760476", "bodyText": "applicationContext.getApplicationName() was returning null.  It didn't seem to be reading spring.application.name, this approach works though.", "author": "jonsie", "createdAt": "2020-01-22T19:32:49Z", "path": "kork-plugins/src/main/java/com/netflix/spinnaker/config/Front50UpdateRepositoryConfiguration.java", "diffHunk": "@@ -73,21 +87,18 @@ public static UpdateRepository pluginFront50UpdateRepository(\n             .configure(SerializationFeature.INDENT_OUTPUT, true)\n             .setSerializationInclusion(JsonInclude.Include.NON_NULL);\n \n-    PluginRepositoryProperties front50RepositoryProps =\n-        pluginRepositoriesConfig.get(PluginsConfigurationProperties.FRONT5O_REPOSITORY);\n-\n     Front50Service front50Service =\n         new Retrofit.Builder()\n             .addConverterFactory(JacksonConverterFactory.create(objectMapper))\n-            .baseUrl(front50RepositoryProps.getUrl())\n+            .baseUrl(front50Url)\n             .client(okHttpClient)\n             .build()\n             .create(Front50Service.class);\n \n     return new Front50UpdateRepository(\n         PluginsConfigurationProperties.FRONT5O_REPOSITORY,\n-        applicationContext.getApplicationName(),\n-        front50RepositoryProps.getUrl(),\n+        Objects.requireNonNull(environment.getProperty(\"spring.application.name\")),", "originalCommit": "f06ba484f75766484b4f28f2d002743b0985ce3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "76c9f22e37688a2c3708ffc4e644bf83b58ea62b", "url": "https://github.com/spinnaker/kork/commit/76c9f22e37688a2c3708ffc4e644bf83b58ea62b", "message": "fix(plugins): Update PluginUpdateServiceTest and remove obsolete comment", "committedDate": "2020-01-22T20:57:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMDQ0NA==", "url": "https://github.com/spinnaker/kork/pull/483#discussion_r369800444", "bodyText": "Loading and starting plugins is no longer possible outside the context of ExtensionBeanDefinitionRegistryPostProcessor, so this comment no longer applies.  I think it's clearer to have just one path for loading and running plugins, until we want to explicitly tackle the problem of reloading plugins at runtime and refreshing the Spring context.", "author": "jonsie", "createdAt": "2020-01-22T21:01:08Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/PluginUpdateService.kt", "diffHunk": "@@ -33,23 +39,16 @@ import java.nio.file.Path\n  *\n  * All plugins that are returned by the repository will be downloaded and installed.\n  *\n- * While it's possible that this could be used after the application has started up, there is no guarantee that the\n- * extensions a plugin exposes will be correctly refreshed within the Spring context at this point. Therefore, it is\n- * strongly advised that if a plugin update needs to occur, the service should be redeployed. If live updates are\n- * desired in the future, we'll need to proxy extensions so that the real implementing object is delegated to, allowing\n- * Spring injection to continue working.", "originalCommit": "76c9f22e37688a2c3708ffc4e644bf83b58ea62b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51435c76dfe43f4ab57fb2a22ed3936a1c75e33c", "url": "https://github.com/spinnaker/kork/commit/51435c76dfe43f4ab57fb2a22ed3936a1c75e33c", "message": "fix(plugins): spotless", "committedDate": "2020-01-22T21:04:24Z", "type": "commit"}, {"oid": "15c949f16d20d563a65c72c05dd6a5d8c542ba19", "url": "https://github.com/spinnaker/kork/commit/15c949f16d20d563a65c72c05dd6a5d8c542ba19", "message": "fix(plugins): spotless prt 2", "committedDate": "2020-01-22T21:09:26Z", "type": "commit"}, {"oid": "8d49577575ad85e589d7d7215e5fff8c9df3c4ee", "url": "https://github.com/spinnaker/kork/commit/8d49577575ad85e589d7d7215e5fff8c9df3c4ee", "message": "Merge branch 'master' into misc-kork-front50", "committedDate": "2020-01-22T21:23:25Z", "type": "commit"}]}