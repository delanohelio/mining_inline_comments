{"pr_number": 501, "pr_title": "fix(swagger): Exclude MetaClass from swagger model generation", "pr_createdAt": "2020-02-06T00:49:29Z", "pr_url": "https://github.com/spinnaker/kork/pull/501", "timeline": [{"oid": "fef6188c664c3e830d048aa5b455ee0c583114aa", "url": "https://github.com/spinnaker/kork/commit/fef6188c664c3e830d048aa5b455ee0c583114aa", "message": "fix(swagger): Exclude MetaClass from swagger model generation\n\nAll groovy classes have an implicit metaClass field that handles\nmetaprogramming. In cases where a groovy class is used in an\nAPI the springfox library to generate Swagger docs is including\nthe metaClass in the model for the class. In addition to being\nconfusing (as a producer/consumer of the API would never set\nthat field), it also leads to terrible performance in some\ncases.\n\nThe performance issues come from the fact that it then tries to\nbuild a model of MetaClass by reflecting its fields, etc. until\nit has built models of most of the Groovy classes.\n\nIn particular, before this change, front50 took 140 seconds to start;\nwith this change it now takes 13 seconds.", "committedDate": "2020-02-06T00:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r375589930", "bodyText": "I don't love needing to pull in groovy as a dependency just to exclude a groovy class from model building...open to suggestions for a better way of doing this.  (I think it needs to be api as if this isn't on the classpath of the consuming service at runtime I think it will fail if it looks at the list of excluded types and finds an undefined class.)\nOne other thought I had was to define a bean of type List<Class> excludedSwaggerClasses() here that's empty, and leave it to services to override that bean with anything they want to exclude...given that we'd probably want this in almost all services (as they almost all have groovy) that seemed more verbose, but definitely open to thoughts on that.", "author": "ezimanyi", "createdAt": "2020-02-06T00:52:30Z", "path": "kork-swagger/kork-swagger.gradle", "diffHunk": "@@ -6,4 +6,5 @@ dependencies {\n   api \"org.springframework.boot:spring-boot-autoconfigure\"\n   api \"io.springfox:springfox-swagger2\"\n   api \"io.springfox:springfox-swagger-ui\"\n+  api \"org.codehaus.groovy:groovy-all\"", "originalCommit": "fef6188c664c3e830d048aa5b455ee0c583114aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NDgwNQ==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r376164805", "bodyText": "I'm fairly certain we can change this to implementation - at least at that point we're not forcing groovy as a dependency on everything else that uses this module.", "author": "robzienert", "createdAt": "2020-02-07T00:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4NTIzMw==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r377285233", "bodyText": "Good call, let me quickly test that and will update the PR if it works.", "author": "ezimanyi", "createdAt": "2020-02-10T20:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwMzM2MQ==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r377303361", "bodyText": "If this doesn't work, I'd be happy to volunteer being the grunt that converts gate's controllers to Java.\ned: Are there other services that actually use the swagger stuff?", "author": "robzienert", "createdAt": "2020-02-10T20:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMDk0Mg==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r377720942", "bodyText": "I just tested and it does indeed work using an implementation dependency though unfortunately (which I probably already knew at some point) that does mean we're still pulling Groovy into the runtime classpath of any consuming services.  It's not on the compile classpath (which is the difference from api) so at least these services won't be able to directly call groovy code.", "author": "ezimanyi", "createdAt": "2020-02-11T15:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMjA0NQ==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r377722045", "bodyText": "I noticed this in front50 in particular as 90% of the startup time was this swagger generation; looks like clouddriver also uses it, probably others too.\nLet me know if you think this is reasonable as implementation even though it will put groovy on the runtime classpath of java-only dependencies.", "author": "ezimanyi", "createdAt": "2020-02-11T15:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzODMzNQ==", "url": "https://github.com/spinnaker/kork/pull/501#discussion_r377838335", "bodyText": "I think that's reasonable. We can improve the swagger experience now and then once Groovy is removed from our controllers, we'll be able to remove this dep. I've updated the TOC board to include this task: https://github.com/orgs/spinnaker/projects/6\nThis specific refactor was something I was targeting as next for me to take from the TOC project board anyway.", "author": "robzienert", "createdAt": "2020-02-11T19:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU4OTkzMA=="}], "type": "inlineReview"}, {"oid": "c71141501979a116471e69e4c8f213b737ee89d5", "url": "https://github.com/spinnaker/kork/commit/c71141501979a116471e69e4c8f213b737ee89d5", "message": "fix(swagger): Make groovy implementation dependency\n\nThis does not need to be an API dependency.", "committedDate": "2020-02-11T15:41:28Z", "type": "commit"}, {"oid": "84b4ccdaf133cff2dd1ba06af775e1f5b3979715", "url": "https://github.com/spinnaker/kork/commit/84b4ccdaf133cff2dd1ba06af775e1f5b3979715", "message": "fix(swagger): Only bring in core groovy\n\nWe don't need all of it, only the core", "committedDate": "2020-02-11T15:56:27Z", "type": "commit"}, {"oid": "24eca330d4f8356a5e90fe780c06fd7de9e8fed4", "url": "https://github.com/spinnaker/kork/commit/24eca330d4f8356a5e90fe780c06fd7de9e8fed4", "message": "Merge branch 'master' into exclude-groovy", "committedDate": "2020-02-11T19:08:06Z", "type": "commit"}]}