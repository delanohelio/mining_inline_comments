{"pr_number": 540, "pr_title": "fix(ssl): pass TrustManager to okHttp SSL socketfactory for JDK9+", "pr_createdAt": "2020-03-04T05:21:23Z", "pr_url": "https://github.com/spinnaker/kork/pull/540", "timeline": [{"oid": "3dc04cd6e538e2e28394f72d19eea01f365fa080", "url": "https://github.com/spinnaker/kork/commit/3dc04cd6e538e2e28394f72d19eea01f365fa080", "message": "fix(ssl): pass TrustManager to okHttp SSL socketfactory as required by JDK9+\n\nWe recently encountered a crash loop using the igor 1.18.X codeline\nwhen enabling SSL with a local truststore. The error being thrown is\n```\nFailed to instantiate [com.jakewharton.retrofit.Ok3Client]: Factory method\n'ok3Client' threw exception; nested exception is java.lang.UnsupportedOperationException:\n clientBuilder.sslSocketFactory(SSLSocketFactory) not supported on JDK 9+\n```\nThe stack trace allowed me to trace it back to kork's instantiation of the okHttpClient\nwhich wasn't updated to pass in the TrustManager with the update of that JDK.\n\nThis only shows up if you are terminating SSL with your own truststore in the pod\nso we may have been the first ones to come across this issue in the wild.", "committedDate": "2020-03-04T05:13:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MjA4Mg==", "url": "https://github.com/spinnaker/kork/pull/540#discussion_r387952082", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                okHttpClientBuilder.sslSocketFactory(sslContext.socketFactory, (X509TrustManager) trustManagerFactory.getTrustManagers().first())\n          \n          \n            \n                def trustManagers = trustManagerFactory.getTrustManagers()\n          \n          \n            \n                checkState(trustManagers.length == 1, \"Found multiple trust managers; don't know which one to use\")\n          \n          \n            \n                checkState(trustManagers.first() instanceof X509TrustManager, \"Configured TrustManager is a %s, not an X509TrustManager; don't know how to configure it\", trustManagers.first().class.getName())\n          \n          \n            \n                okHttpClientBuilder.sslSocketFactory(sslContext.socketFactory, (X509TrustManager) trustManagers.first())\n          \n      \n    \n    \n  \n\n(and import static com.google.common.base.Preconditions.checkState)", "author": "plumpy", "createdAt": "2020-03-04T21:43:49Z", "path": "kork-web/src/main/groovy/com/netflix/spinnaker/config/OkHttp3ClientConfiguration.groovy", "diffHunk": "@@ -99,7 +100,7 @@ class OkHttp3ClientConfiguration {\n     }\n \n     sslContext.init(keyManagerFactory.keyManagers, trustManagerFactory.trustManagers, secureRandom)\n-    okHttpClientBuilder.sslSocketFactory(sslContext.socketFactory)\n+    okHttpClientBuilder.sslSocketFactory(sslContext.socketFactory, (X509TrustManager) trustManagerFactory.getTrustManagers().first())", "originalCommit": "3dc04cd6e538e2e28394f72d19eea01f365fa080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e13f3ba143f78c147ffb66cdd169b01dd7e2b226", "url": "https://github.com/spinnaker/kork/commit/e13f3ba143f78c147ffb66cdd169b01dd7e2b226", "message": "Updated with fixes from plumpy", "committedDate": "2020-03-04T22:04:00Z", "type": "commit"}]}