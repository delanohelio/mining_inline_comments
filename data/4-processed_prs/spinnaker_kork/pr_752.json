{"pr_number": 752, "pr_title": "feat(plugins): Spring-backed native plugin extensions", "pr_createdAt": "2020-08-19T19:16:28Z", "pr_url": "https://github.com/spinnaker/kork/pull/752", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3MDU4OQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473270589", "bodyText": "I'm wondering what happens if someone creates in the plugin classes MyExtensionImpl that implements a defined extension point MyExtension, since the bean class is MyExtensionImpl and only known to the plugin classloader, is spring able to resolve that the bean is an instance of MyExtension?\nI'm sort of wondering if this needs to register the bean class as the MyExtension class instead - but I have no idea whether this is an issue or not", "author": "cfieber", "createdAt": "2020-08-19T19:31:57Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/v2/ExtensionPromotionBeanPostProcessor.kt", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2\n+\n+import com.netflix.spinnaker.kork.plugins.api.internal.SpinnakerExtensionPoint\n+import org.pf4j.PluginWrapper\n+import org.slf4j.LoggerFactory\n+import org.springframework.beans.factory.config.BeanPostProcessor\n+import org.springframework.context.support.GenericApplicationContext\n+import org.springframework.core.Ordered\n+import org.springframework.core.PriorityOrdered\n+import org.springframework.util.Assert\n+\n+/**\n+ * Handles promotion of plugin beans to the parent service application context.\n+ *\n+ * Only beans that implement [SpinnakerExtensionPoint] are candidates for promotion.\n+ */\n+class ExtensionPromotionBeanPostProcessor(\n+  private val pluginWrapper: PluginWrapper,\n+  private val pluginApplicationContext: GenericApplicationContext,\n+  private val beanPromoter: BeanPromoter\n+) : BeanPostProcessor, PriorityOrdered {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun postProcessAfterInitialization(bean: Any, beanName: String): Any? {\n+    val definition = pluginApplicationContext.getBeanDefinition(beanName)\n+\n+    Assert.notNull(definition.beanClassName, \"Bean class name is null\")\n+\n+    val beanClass = getBeanClass(definition.beanClassName!!)\n+    if (SpinnakerExtensionPoint::class.java.isAssignableFrom(beanClass)) {\n+      log.debug(\"Promoting plugin extension to service context (${pluginWrapper.pluginId}): $beanClass\")\n+      beanPromoter.promote(\"${pluginWrapper.pluginId}_${beanName}\", bean, beanClass)", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MDY4Mw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473480683", "bodyText": "It seems to work fine. The BeanPromoter does register both the bean instance, as well as the class, with the parent bean factory.", "author": "robzienert", "createdAt": "2020-08-20T00:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3MDU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3ODcyMA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473378720", "bodyText": "I wonder if there is an opportunity here to unify what we have in kork-plugins-tck.  We don't actually use TestPluginBuilder there, but instead use PluginJar and PluginZip.  Here's an example (and we also have examples in Orca, Echo, and Gate):\nhttps://github.com/spinnaker/kork/blob/master/kork-plugins-tck/src/test/kotlin/com/spinnaker/netflix/kork/plugins/tck/PluginsTckFixtureTest.kt#L73", "author": "jonsie", "createdAt": "2020-08-19T22:16:19Z", "path": "kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/testplugin/GeneratedPluginFixture.kt", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.testplugin\n+\n+import com.netflix.spinnaker.config.PluginsAutoConfiguration\n+import com.netflix.spinnaker.kork.plugins.FRAMEWORK_V2\n+import com.netflix.spinnaker.kork.plugins.SpinnakerPluginDescriptor\n+import com.netflix.spinnaker.kork.plugins.finders.SpinnakerPropertiesPluginDescriptorFinder\n+import com.netflix.spinnaker.kork.plugins.internal.TestPlugin\n+import org.springframework.boot.autoconfigure.AutoConfigurations\n+import org.springframework.boot.test.context.runner.ApplicationContextRunner\n+import java.nio.file.Files\n+import java.nio.file.Path\n+\n+/**\n+ * Standard fixture for tests that need to generate a plugin.\n+ *\n+ * It is recommended to create a companion object to wrap this fixture so that a new plugin is\n+ * not generated for each test case.\n+ */\n+class GeneratedPluginFixture(pluginName: String, builder: TestPluginBuilder.() -> Unit) {", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4MTMwMQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473481301", "bodyText": "Probably would be a good move. You're thinking of this for service owners, not plugin developers, right?", "author": "robzienert", "createdAt": "2020-08-20T00:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3ODcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE2NTM5Ng==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474165396", "bodyText": "Yeah, kork-plugins-tck is used in services.  Though, it could be used in the framework too.  I think the plugin developer testing stuff would be a different library.", "author": "jonsie", "createdAt": "2020-08-20T17:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3ODcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDQ1NA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473574454", "bodyText": "nit: single imports.", "author": "luispollo", "createdAt": "2020-08-20T04:02:00Z", "path": "kork-plugins-api/src/main/java/com/netflix/spinnaker/kork/plugins/api/PluginComponent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.api;\n+\n+import com.netflix.spinnaker.kork.annotations.Beta;\n+\n+import java.lang.annotation.*;", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NTE2NA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473575164", "bodyText": "The second part of this comment seems to be more encompassing than what's on line 23. Worth reconciling?", "author": "luispollo", "createdAt": "2020-08-20T04:04:41Z", "path": "kork-plugins-api/src/main/java/com/netflix/spinnaker/kork/plugins/api/PluginComponent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.api;\n+\n+import com.netflix.spinnaker.kork.annotations.Beta;\n+\n+import java.lang.annotation.*;\n+\n+/**\n+ * Marks a class within a plugin as one that is candidate for dependency injection.\n+ *\n+ * Classes defined within the plugin, as well as classes exposed via a service's API are valid candidates for", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NTYxNw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473575617", "bodyText": "Hmm, are we relaxing the style on star imports? Then I won't nitpick elsewhere. \ud83d\ude42", "author": "luispollo", "createdAt": "2020-08-20T04:06:15Z", "path": "kork-plugins/src/main/java/com/netflix/spinnaker/config/PluginsAutoConfiguration.java", "diffHunk": "@@ -20,11 +20,7 @@\n import com.netflix.spinnaker.config.PluginsConfigurationProperties.PluginRepositoryProperties;\n import com.netflix.spinnaker.kork.dynamicconfig.DynamicConfigService;\n import com.netflix.spinnaker.kork.dynamicconfig.SpringDynamicConfigService;\n-import com.netflix.spinnaker.kork.plugins.ExtensionBeanDefinitionRegistryPostProcessor;\n-import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager;\n-import com.netflix.spinnaker.kork.plugins.SpinnakerServiceVersionManager;\n-import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider;\n-import com.netflix.spinnaker.kork.plugins.SpringStrictPluginLoaderStatusProvider;\n+import com.netflix.spinnaker.kork.plugins.*;", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIxNjI1NA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474216254", "bodyText": "I'm doing whatever Spotless is doing. \ud83e\udd37", "author": "robzienert", "createdAt": "2020-08-20T19:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NTYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NzQxOA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473577418", "bodyText": "(Just for my education) I'm curious how this works in the first place (even with PrivilegedSpringPlugin) since plugin classes are loaded in a separate class loader from the service's. Do the class loaders of the parent and the plugin interact in some way?", "author": "luispollo", "createdAt": "2020-08-20T04:12:21Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/v2/DefaultBeanPromoter.kt", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2\n+\n+import org.springframework.context.support.GenericApplicationContext\n+\n+/**\n+ * Promotes a given plugin bean to the provided [serviceApplicationContext].\n+ */\n+class DefaultBeanPromoter(\n+  private val serviceApplicationContext: GenericApplicationContext\n+) : BeanPromoter {\n+\n+  override fun promote(beanName: String, bean: Any, beanClass: Class<*>) {\n+    serviceApplicationContext.registerBean(\n+      beanName,\n+      beanClass,", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzODg1Nw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474238857", "bodyText": "This is more information than you asked for, but I think we could use a top-to-bottom.\nClassLoader is for loading classes; that is, they load compiled Java classes into the JVM. Once that's done, there's not much for them to do.\nIn Spinnaker's context, the service uses the default system ClassLoader (call it ServiceClassLoader), and then each plugin gets its own PluginClassLoader. PluginClassLoader is a child of the ServiceClassLoader, so whatever classes ServiceClassLoader has available to it, so does the PluginClassLoader. A child ClassLoader will first look to itself for a class it can load, and if it can't, it'll go to its parent and so-on. A parent ClassLoader cannot load classes that are in a child.\nAn object created by ClassLoaderA is going to be able to interact with objects created by ClassLoaderB and vice-versa: It isn't object isolation, it's class isolation. It's just bytecode in a VM, so once the Class is loaded, we're OK to use it wherever. The part where things lead to sadness is when a Class loaded from ClassLoaderA interacts with a Class from ClassLoaderB, both of which use the same dependency (Jackson, Spring, etc.) as part of their contract (an interface or some other public member), but are using different versions and then different bytecodes. In this case, Java cannot reconcile how these two classes can interact because the bytecodes for the contract between these two objects are incompatible.\nGoing back to parent-child relationships of ClassLoader, you can see why having a conflicting version of Spring would cause issues because the PluginClassLoader loads its definition of Spring for its own context, even though the ServiceClassLoader has already loaded another version, and the service has created a bunch of objects using a conflicting version.\nNow, for the Spring bit that you commented on.\nWe're registering a BeanDefinition into the parent application, which has a bunch of metadata that Spring needs to know how, in what order, etc. to create your bean. An ApplicationContext is tightly-coupled to one ClassLoader, which a BeanFactory will use to load the class -- this won't work for our case, obviously, since the service ClassLoader doesn't know about plugin classes. To get around this, I'm providing a Supplier as a factory method to the bean instance that was already created from the PluginClassLoader -- effectively making this plugin extension a singleton within the scope of the service. Furthermore, Spring is able to do all of its autowiring and what have you because I'm also providing that BeanFactory with the Class of the bean that we're promoting, so it'll be able to do whatever reflection magic it needs to do.\nHope that helps, I gotta run to a meeting, so that's the abrupt end to this comment.", "author": "robzienert", "createdAt": "2020-08-20T19:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NzQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1ODYxOQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474858619", "bodyText": "Oof, what a master class! This was incredibly helpful, thanks so much for taking the time to write it! \u2764\ufe0f", "author": "luispollo", "createdAt": "2020-08-21T18:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NzQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3OTc0OQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473579749", "bodyText": "Isn't this the other way around? Ordered.HIGHEST_PRECEDENCE is defined as Integer.MIN_VALUE (i.e. loads earlier).", "author": "luispollo", "createdAt": "2020-08-20T04:22:02Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/v2/PluginFrameworkInitializer.kt", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2\n+\n+import org.slf4j.LoggerFactory\n+import org.springframework.beans.factory.config.ConfigurableListableBeanFactory\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry\n+import org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor\n+import org.springframework.context.ApplicationContext\n+import org.springframework.context.ApplicationContextAware\n+import org.springframework.core.Ordered\n+import org.springframework.core.PriorityOrdered\n+\n+/**\n+ * Responsible for initializing the plugin framework within a service.\n+ *\n+ * [PriorityOrdered] to run as early as possible in the service application lifecycle.\n+ */\n+class PluginFrameworkInitializer(\n+  private val pluginService: SpinnakerPluginService\n+) : BeanDefinitionRegistryPostProcessor, ApplicationContextAware, PriorityOrdered {\n+\n+  override fun postProcessBeanDefinitionRegistry(registry: BeanDefinitionRegistry) {\n+    pluginService.initialize()\n+    pluginService.startPlugins(registry)\n+  }\n+\n+  override fun postProcessBeanFactory(beanFactory: ConfigurableListableBeanFactory) {\n+  }\n+\n+  override fun setApplicationContext(applicationContext: ApplicationContext) {\n+    ApplicationContextGraph.serviceApplicationContext = applicationContext\n+  }\n+\n+  override fun getOrder(): Int = Ordered.LOWEST_PRECEDENCE", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExNTI0OA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474115248", "bodyText": "Ha. Whoops, yes.", "author": "robzienert", "createdAt": "2020-08-20T16:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3OTc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MjEzNQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473582135", "bodyText": "Is this where the service and the plugin \"connect\" as far as class loaders go?", "author": "luispollo", "createdAt": "2020-08-20T04:31:47Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/v2/SpringPluginInitializer.kt", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2\n+\n+import com.netflix.spinnaker.kork.plugins.api.ExtensionConfiguration\n+import com.netflix.spinnaker.kork.plugins.api.PluginComponent\n+import com.netflix.spinnaker.kork.plugins.api.PluginConfiguration\n+import com.netflix.spinnaker.kork.plugins.api.internal.SpinnakerExtensionPoint\n+import org.pf4j.Plugin\n+import org.pf4j.PluginWrapper\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationContext\n+import org.springframework.context.ApplicationContextAware\n+import org.springframework.context.annotation.ClassPathBeanDefinitionScanner\n+import org.springframework.context.support.GenericApplicationContext\n+import org.springframework.core.io.DefaultResourceLoader\n+import org.springframework.core.type.filter.AnnotationTypeFilter\n+import org.springframework.core.type.filter.AssignableTypeFilter\n+\n+/**\n+ * Initializes the given [plugin]'s [pluginApplicationContext] after being connected to the service's\n+ * own [ApplicationContext].\n+ */\n+class SpringPluginInitializer(\n+  private val plugin: Plugin,\n+  private val pluginWrapper: PluginWrapper,\n+  private val pluginApplicationContext: GenericApplicationContext,\n+  private val beanPromoter: BeanPromoter\n+) : ApplicationContextAware {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun setApplicationContext(applicationContext: ApplicationContext) {\n+    log.info(\"Initializing '${pluginWrapper.pluginId}'\")\n+\n+    // For every bean created in the plugin ApplicationContext, we'll need to post-process to evaluate\n+    // which ones need to be promoted to the service ApplicationContext for autowiring into core functionality.\n+    pluginApplicationContext\n+      .beanFactory\n+      .addBeanPostProcessor(ExtensionPromotionBeanPostProcessor(\n+        pluginWrapper,\n+        pluginApplicationContext,\n+        beanPromoter\n+      ))\n+\n+    pluginApplicationContext.classLoader = pluginWrapper.pluginClassLoader", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3OTM5Mw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474279393", "bodyText": "Yeah, kind of. They don't really connect (aside from parent/child relationships of the class loaders themselves).\nThe service has its own ClassLoader and each plugin has its own ClassLoader. Similarly, the service has one Spring ApplicationContext and each plugin has its own ApplicationContext in a parent/child relationship. Just classes are isolated from each other with class loaders, the different ApplicationContexts isolate dependency graphs from each other, with child ApplicationContexts being able to reach into the parent for bean definitions should one not be available.", "author": "robzienert", "createdAt": "2020-08-20T21:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MjEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1MjU5Mg==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474852592", "bodyText": "Thanks, that's very helpful! \ud83d\ude4f", "author": "luispollo", "createdAt": "2020-08-21T18:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MjEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NDk4Ng==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r473584986", "bodyText": "Is this used anywhere in the tests?", "author": "luispollo", "createdAt": "2020-08-20T04:43:21Z", "path": "kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/v2/fixtures/ParentServiceBean.kt", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2.fixtures\n+\n+import org.springframework.beans.factory.annotation.Value\n+import org.springframework.stereotype.Component\n+\n+@Component(\"parentServiceBean\")\n+class ParentServiceBean(@Value(\"\\${someKey}\") val someKey: String)", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0ODQwMQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474148401", "bodyText": "Since all the other configuration classes are Java, and we're importing this one into PluginsAutoConfiguration, should we make this one Java just to be uniform?", "author": "jonsie", "createdAt": "2020-08-20T17:16:54Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/config/V2PluginConfiguration.kt", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.config\n+\n+import com.netflix.spinnaker.kork.plugins.FRAMEWORK_V2\n+import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.config.ConfigFactory\n+import com.netflix.spinnaker.kork.plugins.sdk.SdkFactory\n+import com.netflix.spinnaker.kork.plugins.update.SpinnakerUpdateManager\n+import com.netflix.spinnaker.kork.plugins.update.release.provider.PluginInfoReleaseProvider\n+import com.netflix.spinnaker.kork.plugins.v2.SpringPluginFactory\n+import com.netflix.spinnaker.kork.plugins.v2.PluginFrameworkInitializer\n+import com.netflix.spinnaker.kork.plugins.v2.SpinnakerPluginService\n+import org.pf4j.PluginFactory\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty\n+import org.springframework.context.ApplicationEventPublisher\n+import org.springframework.context.annotation.Bean\n+import org.springframework.context.annotation.Configuration\n+import org.springframework.context.support.GenericApplicationContext\n+\n+@Configuration\n+@ConditionalOnProperty(value = [\"spinnaker.extensibility.framework.version\"], havingValue = FRAMEWORK_V2)\n+class V2PluginConfiguration {", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NTQ0NQ==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474185445", "bodyText": "I would really rather not; I'd prefer to get rid of the last remnants of Java in kork-plugins instead!", "author": "robzienert", "createdAt": "2020-08-20T18:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMyMTY1Nw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474321657", "bodyText": "Would be nice, but haven't we seen issues with loading Kotlin ConfigurationProperties or Configuration classes though?  This is a bit vague, but I seem to recall an issue with that.", "author": "jonsie", "createdAt": "2020-08-20T23:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwMTE5Nw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474801197", "bodyText": "Configuration classes should be fine, ConfigurationProperties might trip up the spring binder if they aren't mutable or annotated for constructor binding", "author": "cfieber", "createdAt": "2020-08-21T16:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwODcxOA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474808718", "bodyText": "Yeah, I think we just had val on config properties - which we cannot do. We've been fine in other projects and modules in kork with Kotlin config / config properties.", "author": "robzienert", "createdAt": "2020-08-21T16:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0ODQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE2NDU4NA==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474164584", "bodyText": "Wrap this in withTiming?  Might be useful especially if we start doing more with a plugin start hook.", "author": "jonsie", "createdAt": "2020-08-20T17:46:07Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/v2/SpinnakerPluginService.kt", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2\n+\n+import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.api.spring.PrivilegedSpringPlugin\n+import com.netflix.spinnaker.kork.plugins.update.SpinnakerUpdateManager\n+import com.netflix.spinnaker.kork.plugins.update.release.provider.PluginInfoReleaseProvider\n+import org.slf4j.LoggerFactory\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry\n+import org.springframework.context.ApplicationEventPublisher\n+import org.springframework.util.Assert\n+\n+/**\n+ * A service for managing the plugin framework.\n+ *\n+ * NOTE: Over time, we should be moving to this class over [SpinnakerPluginManager] and\n+ * [SpinnakerUpdateManager] as the primary touch points for the plugin framework, decoupling\n+ * Spinnaker-specific plugin framework logic from PF4J wherever possible.\n+ */\n+class SpinnakerPluginService(\n+  private val pluginManager: SpinnakerPluginManager,\n+  private val updateManager: SpinnakerUpdateManager,\n+  private val pluginInfoReleaseProvider: PluginInfoReleaseProvider,\n+  private val springPluginStatusProvider: SpringPluginStatusProvider\n+) {\n+\n+  private val log = LoggerFactory.getLogger(javaClass)\n+\n+  /**\n+   * Tracks the initialization state of the plugin framework: It can only be initialized once.\n+   */\n+  private var initialized: Boolean = false\n+\n+  /**\n+   * Starts the plugin framework and completely initializes extensions for use by the application.\n+   */\n+  fun initialize() {\n+    Assert.isTrue(!initialized, \"Plugin framework has already been initialized\")\n+\n+    withTiming(\"initializing plugins\") {\n+      // Load known plugins prior to downloading so we can resolve what needs to be updated.\n+      pluginManager.loadPlugins()\n+\n+      // Find the plugin releases for the currently enabled list of plugins\n+      val releases = updateManager.plugins\n+        .filter { springPluginStatusProvider.isPluginEnabled(it.id) }\n+        .let { enabledPlugins -> pluginInfoReleaseProvider.getReleases(enabledPlugins) }\n+\n+      // Download releases, if any, updating previously loaded plugins where necessary\n+      updateManager.downloadPluginReleases(releases).forEach { pluginPath ->\n+        pluginManager.loadPlugin(pluginPath)\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Start the plugins, attaching exported plugin extensions to the provided [registry].\n+   */\n+  fun startPlugins(registry: BeanDefinitionRegistry) {\n+    // Start plugins. This should only be called once.\n+    pluginManager.startPlugins()", "originalCommit": "23dec8af65dc57a99e562acaad42d532add4ab2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e34e1d4d7a5bbb55806e6294ea51474ef09d0160", "url": "https://github.com/spinnaker/kork/commit/e34e1d4d7a5bbb55806e6294ea51474ef09d0160", "message": "feat(plugins): Spring-backed native plugin extensions", "committedDate": "2020-08-20T19:20:41Z", "type": "forcePushed"}, {"oid": "cbb5407d5c02f7ef317f700f260568f7ef7be878", "url": "https://github.com/spinnaker/kork/commit/cbb5407d5c02f7ef317f700f260568f7ef7be878", "message": "feat(plugins): Spring-backed native plugin extensions", "committedDate": "2020-08-20T21:21:56Z", "type": "forcePushed"}, {"oid": "d11777fc25e49ca4a4239568c64d93203f1e0320", "url": "https://github.com/spinnaker/kork/commit/d11777fc25e49ca4a4239568c64d93203f1e0320", "message": "feat(plugins): Spring-backed native plugin extensions", "committedDate": "2020-08-20T23:14:24Z", "type": "commit"}, {"oid": "d11777fc25e49ca4a4239568c64d93203f1e0320", "url": "https://github.com/spinnaker/kork/commit/d11777fc25e49ca4a4239568c64d93203f1e0320", "message": "feat(plugins): Spring-backed native plugin extensions", "committedDate": "2020-08-20T23:14:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1NDg1Mw==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474854853", "bodyText": "nit: This would be a little easier to read if you looked up the field by name, IMHO.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            val field = it.javaClass.declaredFields.first()\n          \n          \n            \n                            val field = it.javaClass.declaredField(\"parentServiceBean\")", "author": "luispollo", "createdAt": "2020-08-21T18:18:26Z", "path": "kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/v2/scenarios/ServiceDependenciesScenarioTest.kt", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2.scenarios\n+\n+import com.netflix.spinnaker.config.PluginsAutoConfiguration\n+import com.netflix.spinnaker.kork.plugins.FRAMEWORK_V2\n+import com.netflix.spinnaker.kork.plugins.testplugin.testPlugin\n+import com.netflix.spinnaker.kork.plugins.v2.ApplicationContextGraph\n+import com.netflix.spinnaker.kork.plugins.v2.scenarios.fixtures.ParentServiceBean\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import org.springframework.boot.autoconfigure.AutoConfigurations\n+import org.springframework.boot.test.context.assertj.AssertableApplicationContext\n+import org.springframework.boot.test.context.runner.ApplicationContextRunner\n+import org.springframework.context.annotation.ComponentScan\n+import org.springframework.context.annotation.Configuration\n+import strikt.api.expectThat\n+import strikt.assertions.isEqualTo\n+import strikt.assertions.isNotNull\n+\n+/**\n+ * Tests that beans created by the service are injectable into plugin extensions.\n+ */\n+class ServiceDependenciesScenarioTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext<Fixture> {\n+    fixture {\n+      Fixture()\n+    }\n+\n+    test(\"plugin extension is autowired with service bean\") {\n+      app\n+        .withUserConfiguration(TestApplicationConfiguration::class.java)\n+        .run { ctx: AssertableApplicationContext ->\n+          val serviceBean = ctx.getBean(ParentServiceBean::class.java)\n+\n+          expectThat(ApplicationContextGraph.pluginContext(generated.plugin.pluginId))\n+            .isNotNull()\n+            .get {\n+              getBean(\"myExtension\").let {\n+                val field = it.javaClass.declaredFields.first()", "originalCommit": "d11777fc25e49ca4a4239568c64d93203f1e0320", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "258a07447d0dc9307a5bf45cc0561edfa1474793", "url": "https://github.com/spinnaker/kork/commit/258a07447d0dc9307a5bf45cc0561edfa1474793", "message": "Update kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/v2/scenarios/ServiceDependenciesScenarioTest.kt\n\nCo-authored-by: Luis Pollo <1323478+luispollo@users.noreply.github.com>", "committedDate": "2020-08-21T18:37:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg2NjY0Ng==", "url": "https://github.com/spinnaker/kork/pull/752#discussion_r474866646", "bodyText": "Sorry, my bad.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            val field = it.javaClass.declaredField(\"parentServiceBean\")\n          \n          \n            \n                            val field = it.javaClass.getDeclaredField(\"parentServiceBean\")", "author": "luispollo", "createdAt": "2020-08-21T18:45:03Z", "path": "kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/v2/scenarios/ServiceDependenciesScenarioTest.kt", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.v2.scenarios\n+\n+import com.netflix.spinnaker.config.PluginsAutoConfiguration\n+import com.netflix.spinnaker.kork.plugins.FRAMEWORK_V2\n+import com.netflix.spinnaker.kork.plugins.testplugin.testPlugin\n+import com.netflix.spinnaker.kork.plugins.v2.ApplicationContextGraph\n+import com.netflix.spinnaker.kork.plugins.v2.scenarios.fixtures.ParentServiceBean\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import org.springframework.boot.autoconfigure.AutoConfigurations\n+import org.springframework.boot.test.context.assertj.AssertableApplicationContext\n+import org.springframework.boot.test.context.runner.ApplicationContextRunner\n+import org.springframework.context.annotation.ComponentScan\n+import org.springframework.context.annotation.Configuration\n+import strikt.api.expectThat\n+import strikt.assertions.isEqualTo\n+import strikt.assertions.isNotNull\n+\n+/**\n+ * Tests that beans created by the service are injectable into plugin extensions.\n+ */\n+class ServiceDependenciesScenarioTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext<Fixture> {\n+    fixture {\n+      Fixture()\n+    }\n+\n+    test(\"plugin extension is autowired with service bean\") {\n+      app\n+        .withUserConfiguration(TestApplicationConfiguration::class.java)\n+        .run { ctx: AssertableApplicationContext ->\n+          val serviceBean = ctx.getBean(ParentServiceBean::class.java)\n+\n+          expectThat(ApplicationContextGraph.pluginContext(generated.plugin.pluginId))\n+            .isNotNull()\n+            .get {\n+              getBean(\"myExtension\").let {\n+                val field = it.javaClass.declaredField(\"parentServiceBean\")", "originalCommit": "258a07447d0dc9307a5bf45cc0561edfa1474793", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eba7c0460eaa5317b4669323b4e19c656a6e51f0", "url": "https://github.com/spinnaker/kork/commit/eba7c0460eaa5317b4669323b4e19c656a6e51f0", "message": "Update kork-plugins/src/test/kotlin/com/netflix/spinnaker/kork/plugins/v2/scenarios/ServiceDependenciesScenarioTest.kt\n\nCo-authored-by: Luis Pollo <1323478+luispollo@users.noreply.github.com>", "committedDate": "2020-08-21T19:29:08Z", "type": "commit"}, {"oid": "65da79a91f90e6cf50247f5a08fdeaa4c2e4ad0a", "url": "https://github.com/spinnaker/kork/commit/65da79a91f90e6cf50247f5a08fdeaa4c2e4ad0a", "message": "Merge branch 'master' into native-plugins-v2", "committedDate": "2020-08-21T19:34:26Z", "type": "commit"}]}