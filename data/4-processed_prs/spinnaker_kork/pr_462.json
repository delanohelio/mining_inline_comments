{"pr_number": 462, "pr_title": "feat(plugins): Add ability to download plugins with an external process", "pr_createdAt": "2020-01-13T23:32:59Z", "pr_url": "https://github.com/spinnaker/kork/pull/462", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMDgyNQ==", "url": "https://github.com/spinnaker/kork/pull/462#discussion_r366100825", "bodyText": "I think this factory will need to support more than a ConfigurableUpdateRepository - for example, there will be a concrete Front50UpdateRepository implementation that we will want to instantiate.", "author": "jonsie", "createdAt": "2020-01-14T00:32:37Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/UpdateRepositoryFactory.kt", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.update\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.PluginsConfigurationProperties.PluginRepositoryProperties.FileDownloaderProperties\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.config.Configurable\n+import org.pf4j.update.FileDownloader\n+import org.pf4j.update.SimpleFileDownloader\n+import org.pf4j.update.UpdateRepository\n+import org.pf4j.update.verifier.CompoundVerifier\n+import java.net.URL\n+\n+/**\n+ * Factory for [UpdateRepository].\n+ */\n+class UpdateRepositoryFactory(", "originalCommit": "6e14b7d865ba7a06aa7ab6fa60a321fb5ab97fb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ3NTQ0NQ==", "url": "https://github.com/spinnaker/kork/pull/462#discussion_r366475445", "bodyText": "I agree - but since we only have one UpdateRepository implementation today, this is all I can really build for.", "author": "robzienert", "createdAt": "2020-01-14T17:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMDgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTk5Mw==", "url": "https://github.com/spinnaker/kork/pull/462#discussion_r366101993", "bodyText": "Will this wait for 1 minute regardless of the proc status?", "author": "jonsie", "createdAt": "2020-01-14T00:37:31Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/downloader/internal/DefaultProcessRunner.kt", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.update.downloader.internal\n+\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.update.downloader.ProcessFileDownloader\n+import org.slf4j.Logger\n+import org.slf4j.LoggerFactory\n+import java.io.BufferedReader\n+import java.io.InputStreamReader\n+import java.util.concurrent.TimeUnit\n+\n+/**\n+ * Default [ProcessFileDownloader.ProcessRunner] implementation.\n+ */\n+internal class DefaultProcessRunner : ProcessFileDownloader.ProcessRunner {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun completeOrTimeout(processBuilder: ProcessBuilder): String {\n+    val process = processBuilder.start()\n+    val finished = process.waitFor(1, TimeUnit.MINUTES)", "originalCommit": "6e14b7d865ba7a06aa7ab6fa60a321fb5ab97fb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ3MjcyNg==", "url": "https://github.com/spinnaker/kork/pull/462#discussion_r366472726", "bodyText": "That's right.", "author": "robzienert", "createdAt": "2020-01-14T17:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ3Nzk4OA==", "url": "https://github.com/spinnaker/kork/pull/462#discussion_r366477988", "bodyText": "I've changed this to not have a timeout and to wait for the process to finish.", "author": "robzienert", "createdAt": "2020-01-14T17:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTk5Mw=="}], "type": "inlineReview"}, {"oid": "66dec0256d6647db392627f4da50f7343ebcf092", "url": "https://github.com/spinnaker/kork/commit/66dec0256d6647db392627f4da50f7343ebcf092", "message": "feat(plugins): Add ability to download plugins with an external process\n\nPrior to this PR, plugins can only be downloaded from unauthenticated HTTP\nendpoints. This functionality adds the capability of specifying new\nfile downloader strategies, with an initial alternative strategy for\nrunning an external process to download a plugin artifact.\n\nWe will be writing a new default FileDownloader that can be configured for\ncustom certificates, as well as basic auth, and probably other integrations\nfor artifact repositories that need something extra.", "committedDate": "2020-01-14T17:39:04Z", "type": "commit"}, {"oid": "66dec0256d6647db392627f4da50f7343ebcf092", "url": "https://github.com/spinnaker/kork/commit/66dec0256d6647db392627f4da50f7343ebcf092", "message": "feat(plugins): Add ability to download plugins with an external process\n\nPrior to this PR, plugins can only be downloaded from unauthenticated HTTP\nendpoints. This functionality adds the capability of specifying new\nfile downloader strategies, with an initial alternative strategy for\nrunning an external process to download a plugin artifact.\n\nWe will be writing a new default FileDownloader that can be configured for\ncustom certificates, as well as basic auth, and probably other integrations\nfor artifact repositories that need something extra.", "committedDate": "2020-01-14T17:39:04Z", "type": "forcePushed"}, {"oid": "37c29313b7b1212339bf83013ab8cae46c6459d8", "url": "https://github.com/spinnaker/kork/commit/37c29313b7b1212339bf83013ab8cae46c6459d8", "message": "Merge branch 'master' into plugin-bin-github-releases", "committedDate": "2020-01-14T17:47:14Z", "type": "commit"}]}