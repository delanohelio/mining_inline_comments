{"pr_number": 747, "pr_title": "feat(plugins): Remote plugins configuration, cache, and remote transport with OkHttp3 client implementation", "pr_createdAt": "2020-08-17T03:41:08Z", "pr_url": "https://github.com/spinnaker/kork/pull/747", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIxNjY1Nw==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471216657", "bodyText": "Previous change added the config here - this is resolved internally and used to be build up the client.", "author": "jonsie", "createdAt": "2020-08-17T03:42:55Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/RemotePluginConfigChangedListener.kt", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.DefaultServiceEndpoint\n+import com.netflix.spinnaker.config.okhttp3.OkHttpClientProvider\n+import com.netflix.spinnaker.kork.annotations.Beta\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.DISABLED\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.ENABLED\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.UPDATED\n+import com.netflix.spinnaker.kork.plugins.remote.transport.OkHttpRemoteExtensionTransport\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationListener\n+\n+@Beta\n+class RemotePluginConfigChangedListener(\n+  private val objectMapper: ObjectMapper,\n+  private val okHttpClientProvider: OkHttpClientProvider,\n+  private val remotePluginsCache: RemotePluginsCache\n+) : ApplicationListener<RemotePluginConfigChanged> {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun onApplicationEvent(event: RemotePluginConfigChanged) {\n+    when (event.status) {\n+      ENABLED -> put(event)\n+      UPDATED -> put(event)\n+      DISABLED -> remotePluginsCache.remove(event.pluginId)\n+    }\n+  }\n+\n+  private fun put(event: RemotePluginConfigChanged) {\n+    val remoteExtensions: MutableSet<RemoteExtension> = mutableSetOf()\n+\n+    event.remoteExtensionConfigs.forEach { remoteExtensionConfig ->\n+\n+      // TODO(jonsie): Support enabling/disabling transports in the config.\n+      // Configure HTTP if it is available since it is the only configurable transport right now.\n+      val remoteExtensionTransport = if (remoteExtensionConfig.transport.http.url.isNotEmpty()) {\n+        val client = okHttpClientProvider.getClient(\n+          DefaultServiceEndpoint(\n+            remoteExtensionConfig.id,\n+            remoteExtensionConfig.transport.http.url,\n+            remoteExtensionConfig.transport.http.config", "originalCommit": "12c03e7f060d3c1fa30685475f3d0ad68897608f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIxODQxMQ==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471218411", "bodyText": "We'll need to register subtypes in services for this to work.", "author": "jonsie", "createdAt": "2020-08-17T03:51:44Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/transport/OkHttpRemoteExtensionTransport.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote.transport\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.security.AuthenticatedRequest\n+import okhttp3.MediaType\n+import okhttp3.OkHttpClient\n+import okhttp3.Request\n+import okhttp3.RequestBody\n+\n+class OkHttpRemoteExtensionTransport(\n+  private val objectMapper: ObjectMapper,\n+  private val client: OkHttpClient,\n+  private val url: String\n+) : RemoteExtensionTransport {\n+\n+  override fun invoke(remoteExtensionPayload: RemoteExtensionPayload) {\n+    AuthenticatedRequest.propagate {\n+      val request = Request.Builder()\n+        .url(url)\n+        .post(\n+          RequestBody.create(\n+            MediaType.parse(\"application/json\"),\n+            objectMapper.writeValueAsString(remoteExtensionPayload)", "originalCommit": "12c03e7f060d3c1fa30685475f3d0ad68897608f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5MTM0Mg==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471791342", "bodyText": "Downstream of what?", "author": "robzienert", "createdAt": "2020-08-17T21:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIxODQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NzUxNQ==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471797515", "bodyText": "Really just in services, I'm overusing the term downstream (since kork just runs in a service, it's not really downstream of anything).  \ud83e\udd37\u200d\u2642\ufe0f", "author": "jonsie", "createdAt": "2020-08-17T21:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIxODQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIyMDY4NA==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471220684", "bodyText": "I would expect the response code to be a 202 but I didn't want to be strict about it - so long as the remote extension uses the provided callback (which will either be another PR or part of this one) we are \ud83d\udc4d .", "author": "jonsie", "createdAt": "2020-08-17T04:03:40Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/transport/OkHttpRemoteExtensionTransport.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote.transport\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.security.AuthenticatedRequest\n+import okhttp3.MediaType\n+import okhttp3.OkHttpClient\n+import okhttp3.Request\n+import okhttp3.RequestBody\n+\n+class OkHttpRemoteExtensionTransport(\n+  private val objectMapper: ObjectMapper,\n+  private val client: OkHttpClient,\n+  private val url: String\n+) : RemoteExtensionTransport {\n+\n+  override fun invoke(remoteExtensionPayload: RemoteExtensionPayload) {\n+    AuthenticatedRequest.propagate {\n+      val request = Request.Builder()\n+        .url(url)\n+        .post(\n+          RequestBody.create(\n+            MediaType.parse(\"application/json\"),\n+            objectMapper.writeValueAsString(remoteExtensionPayload)\n+          )\n+        )\n+        .build()\n+\n+      val response = client.newCall(request).execute()", "originalCommit": "12c03e7f060d3c1fa30685475f3d0ad68897608f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7359eb9333f606d03b89a464a6f70d71c7483af7", "url": "https://github.com/spinnaker/kork/commit/7359eb9333f606d03b89a464a6f70d71c7483af7", "message": "feat(plugins): Remote plugins configuration, cache, and remote transport with OkHttp client implementation", "committedDate": "2020-08-17T18:56:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4OTU2Mg==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471789562", "bodyText": "downstream of what?", "author": "robzienert", "createdAt": "2020-08-17T21:38:37Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/events/RemotePluginCacheRefresh.kt", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.netflix.spinnaker.kork.plugins.events\n+\n+import com.netflix.spinnaker.kork.plugins.remote.RemotePluginsCache\n+import org.springframework.context.ApplicationEvent\n+\n+/**\n+ * A Spring [ApplicationEvent] that is emitted when the remote plugins cache is changed.\n+ *\n+ * The remote plugins cache is the cache of resolved remote plugins with remote transport\n+ * clients.  This can optionally be used in downstream Spinnaker services to ensure a remote", "originalCommit": "7359eb9333f606d03b89a464a6f70d71c7483af7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5MDY4NQ==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471790685", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.debug(\"Remote plugin '{}' added to cache due to '{}' event\", event.pluginId, event.status.toString())\n          \n          \n            \n                log.debug(\"Remote plugin '{}' added to cache due to '{}' event\", event.pluginId, event.status)\n          \n      \n    \n    \n  \n\nnit: toString() will be called for you.", "author": "robzienert", "createdAt": "2020-08-17T21:41:18Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/RemotePluginConfigChangedListener.kt", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.DefaultServiceEndpoint\n+import com.netflix.spinnaker.config.okhttp3.OkHttpClientProvider\n+import com.netflix.spinnaker.kork.annotations.Beta\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.DISABLED\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.ENABLED\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginConfigChanged.Status.UPDATED\n+import com.netflix.spinnaker.kork.plugins.remote.transport.OkHttpRemoteExtensionTransport\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationListener\n+\n+@Beta\n+class RemotePluginConfigChangedListener(\n+  private val objectMapper: ObjectMapper,\n+  private val okHttpClientProvider: OkHttpClientProvider,\n+  private val remotePluginsCache: RemotePluginsCache\n+) : ApplicationListener<RemotePluginConfigChanged> {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun onApplicationEvent(event: RemotePluginConfigChanged) {\n+    when (event.status) {\n+      ENABLED -> put(event)\n+      UPDATED -> put(event)\n+      DISABLED -> remotePluginsCache.remove(event.pluginId)\n+    }\n+  }\n+\n+  private fun put(event: RemotePluginConfigChanged) {\n+    val remoteExtensions: MutableSet<RemoteExtension> = mutableSetOf()\n+\n+    event.remoteExtensionConfigs.forEach { remoteExtensionConfig ->\n+\n+      // TODO(jonsie): Support enabling/disabling transports in the config.\n+      // Configure HTTP if it is available since it is the only configurable transport right now.\n+      val remoteExtensionTransport = if (remoteExtensionConfig.transport.http.url.isNotEmpty()) {\n+        val client = okHttpClientProvider.getClient(\n+          DefaultServiceEndpoint(\n+            remoteExtensionConfig.id,\n+            remoteExtensionConfig.transport.http.url,\n+            remoteExtensionConfig.transport.http.config\n+          )\n+        )\n+        OkHttpRemoteExtensionTransport(\n+          objectMapper,\n+          client,\n+          remoteExtensionConfig.transport.http.url\n+        )\n+      } else {\n+        throw RemoteExtensionTransportConfigurationException(event.pluginId)\n+      }\n+\n+      remoteExtensions.add(\n+        RemoteExtension(\n+          remoteExtensionConfig.id,\n+          remoteExtensionConfig.type,\n+          remoteExtensionConfig.config ?: mapOf(),\n+          remoteExtensionTransport\n+        )\n+      )\n+    }\n+\n+    val remotePlugin = RemotePlugin(event.pluginId, event.version, remoteExtensions)\n+    remotePluginsCache.put(remotePlugin)\n+    log.debug(\"Remote plugin '{}' added to cache due to '{}' event\", event.pluginId, event.status.toString())", "originalCommit": "7359eb9333f606d03b89a464a6f70d71c7483af7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5MTYyNA==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r471791624", "bodyText": "nit: I'd move this out to a separate file.", "author": "robzienert", "createdAt": "2020-08-17T21:43:35Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/transport/RemoteExtensionTransport.kt", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote.transport\n+\n+import com.netflix.spinnaker.kork.annotations.Beta\n+\n+/**\n+ * The transport on which to address the remote extension.\n+ */\n+@Beta\n+interface RemoteExtensionTransport {\n+\n+  /**\n+   * Invoke the remote extension.  The remote extension is an async process with a callback, so we\n+   * do not wait for a particular response here - but the underlying [RemoteExtensionTransport]\n+   * implementation may throw an exception if something unexpected, like a connection error, occurs.\n+   */\n+  fun invoke(remoteExtensionPayload: RemoteExtensionPayload)\n+}\n+\n+/**\n+ * Marker interface for the payload for the remote extension - implemented at various extension\n+ * points throughout the services.\n+ */\n+@Beta\n+interface RemoteExtensionPayload", "originalCommit": "7359eb9333f606d03b89a464a6f70d71c7483af7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92c967edddea751f6628fbf76451c54723e5e072", "url": "https://github.com/spinnaker/kork/commit/92c967edddea751f6628fbf76451c54723e5e072", "message": "feat(plugins): Remote plugins configuration, cache, and remote transport with OkHttp client implementation", "committedDate": "2020-08-19T22:03:31Z", "type": "commit"}, {"oid": "92c967edddea751f6628fbf76451c54723e5e072", "url": "https://github.com/spinnaker/kork/commit/92c967edddea751f6628fbf76451c54723e5e072", "message": "feat(plugins): Remote plugins configuration, cache, and remote transport with OkHttp client implementation", "committedDate": "2020-08-19T22:03:31Z", "type": "forcePushed"}, {"oid": "ec2e72adcf49b44d0184666cf839bd1798c8e78b", "url": "https://github.com/spinnaker/kork/commit/ec2e72adcf49b44d0184666cf839bd1798c8e78b", "message": "Merge branch 'master' into feat-remote-plugin-real", "committedDate": "2020-08-19T22:04:26Z", "type": "commit"}, {"oid": "0e4c94b53864f03168109c20402d76106066f7b8", "url": "https://github.com/spinnaker/kork/commit/0e4c94b53864f03168109c20402d76106066f7b8", "message": "fix(plugins): Provider for ObjectMapper and OkHttpClientProvider\n\nSince we can not say for certain these beans will be available (though they should be) and so we do not need to add unnecessary mocks when testing the plugin framework, wrap ObjectMapper and OkHttpClientProvider in Provder", "committedDate": "2020-08-19T22:24:15Z", "type": "commit"}, {"oid": "3aac2b3c476559ff2d9f9f51dbb4b18f7d87f28a", "url": "https://github.com/spinnaker/kork/commit/3aac2b3c476559ff2d9f9f51dbb4b18f7d87f28a", "message": "fix(plugins): Fixup RemotePluginConfigChangedListenerTest", "committedDate": "2020-08-19T22:35:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM5NTUwMA==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r473395500", "bodyText": "Food for thought:\nIf a service already has pluginId@0.1.0 and then gets a changed event for pluginId@0.2.0, we'll just overwrite the cache object and it gets dereferenced. There's nothing preventing a service developer from having assigned the plugin to some other class, which could lead to problems and they'd be kinda hard to trace.\nTwo ways I see this going:\n\nWe add remote plugin lifecycles, which allow us to stop() a remote plugin (basically set a flag that any access to it will cause IllegalStateException) when replacing it in the cache.\nMake the remote plugin cache put operations more of an upsert, where the existing RemotePlugin object is updated with new values and refreshed when changes are made.\n\nI kinda like the first option more at this moment.", "author": "robzienert", "createdAt": "2020-08-19T22:38:42Z", "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/remote/RemotePluginsCache.kt", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.remote\n+\n+import com.github.benmanes.caffeine.cache.Cache\n+import com.github.benmanes.caffeine.cache.Caffeine\n+import com.netflix.spinnaker.kork.plugins.events.RemotePluginCacheRefresh\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationEventPublisher\n+\n+/**\n+ * Provides a read/write remote plugin cache used by either the [RemotePluginConfigChangedListener]\n+ * to add plugins based on configuration changes or the [RemotePluginsProvider] to retrieve plugins\n+ * for use in services.\n+ */\n+class RemotePluginsCache(", "originalCommit": "0e4c94b53864f03168109c20402d76106066f7b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQwNjIyMg==", "url": "https://github.com/spinnaker/kork/pull/747#discussion_r473406222", "bodyText": "Yep, I've been mulling this over but haven't landed on a solution yet.  I think this can merge in for now and continue forward, but I agree - this is something I think I will need to address.", "author": "jonsie", "createdAt": "2020-08-19T22:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM5NTUwMA=="}], "type": "inlineReview"}]}