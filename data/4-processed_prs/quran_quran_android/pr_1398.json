{"pr_number": 1398, "pr_title": "Support Reordering Of Translations. Fixes #1179", "pr_createdAt": "2020-07-07T15:01:41Z", "pr_url": "https://github.com/quran/quran_android/pull/1398", "timeline": [{"oid": "aa72ffa817b3db14cdc8b873c4a6bf3298fe55c0", "url": "https://github.com/quran/quran_android/commit/aa72ffa817b3db14cdc8b873c4a6bf3298fe55c0", "message": "Support Reordering Of Translations. Fixes #1179", "committedDate": "2020-07-07T15:17:52Z", "type": "forcePushed"}, {"oid": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "url": "https://github.com/quran/quran_android/commit/4b6c4a923b250e179bbf0462c07c1b25a69d2562", "message": "Support Reordering Of Translations. Fixes #1179", "committedDate": "2020-07-08T15:28:59Z", "type": "commit"}, {"oid": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "url": "https://github.com/quran/quran_android/commit/4b6c4a923b250e179bbf0462c07c1b25a69d2562", "message": "Support Reordering Of Translations. Fixes #1179", "committedDate": "2020-07-08T15:28:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzU0MA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451943540", "bodyText": "Please revert these changes. (Most probably you used them to test an upgrade?).", "author": "ozbek", "createdAt": "2020-07-09T03:30:01Z", "path": "app/build.gradle", "diffHunk": "@@ -17,8 +17,8 @@ android {\n   defaultConfig {\n     minSdkVersion deps.android.build.minSdkVersion\n     targetSdkVersion deps.android.build.targetSdkVersion\n-    versionCode 3010\n-    versionName \"3.0.1\"\n+    versionCode 3100", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzODAyNA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452438024", "bodyText": "oops yes", "author": "papasmile", "createdAt": "2020-07-09T19:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzczMg==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451943732", "bodyText": "Please, consider closing this cursor.", "author": "ozbek", "createdAt": "2020-07-09T03:30:48Z", "path": "app/src/main/java/com/quran/labs/androidquran/database/TranslationsDBAdapter.java", "diffHunk": "@@ -105,11 +106,31 @@ public void deleteTranslationByFile(String filename) {\n   public boolean writeTranslationUpdates(List<TranslationItem> updates) {\n     boolean result = true;\n     db.beginTransaction();\n+\n     try {\n       for (int i = 0, updatesSize = updates.size(); i < updatesSize; i++) {\n         TranslationItem item = updates.get(i);\n         if (item.exists()) {\n+          int displayOrder = 0;\n+\n           final Translation translation = item.getTranslation();\n+\n+          if (item.getDisplayOrder() > -1) {\n+            displayOrder = item.getDisplayOrder();\n+          } else {\n+            // get next highest display order\n+            Cursor cursor = db.query(", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzODIzOQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452438239", "bodyText": "oops, yes to both cursor comments", "author": "papasmile", "createdAt": "2020-07-09T19:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODc0Mw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r458448743", "bodyText": "you should do this in a try / finally because if an exception is thrown due to the query, we will leak the cursor", "author": "ahmedre", "createdAt": "2020-07-21T23:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODY1MQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460078651", "bodyText": "sorry to nitpick, the try/catch should be before the cursor assignment even - so like:\nCursor cursor = null;\ntry {\n  cursor = ..\n} finally {\n  DatabasUtils.closeCursor(cursor);\n}", "author": "ahmedre", "createdAt": "2020-07-24T14:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MzczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NDE3Nw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451944177", "bodyText": "I am not entirely sure if db.endTransaction() auto-closes previous cursors, but you may need to close this cursor as well.", "author": "ozbek", "createdAt": "2020-07-09T03:32:46Z", "path": "app/src/main/java/com/quran/labs/androidquran/database/TranslationsDBHelper.java", "diffHunk": "@@ -69,6 +73,34 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n         db.endTransaction();\n       }\n     }\n+    if (oldVersion < 5) {\n+      // Add display order column and add arbitrary order to existing translations\n+      db.beginTransaction();\n+      try {\n+        db.execSQL(\"ALTER TABLE \"\n+            + TranslationsTable.TABLE_NAME\n+            + \" ADD COLUMN \"\n+            + TranslationsTable.DISPLAY_ORDER\n+            + \" integer not null default -1\"\n+        );\n+        Cursor translations = db.query(", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0OTcyNw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r458449727", "bodyText": "+1 - also, as a hack, can we just use the row id as the value here so we don't have to do an upload loop?\ni.e. something like\nUPDATE translations SET display_order = id", "author": "ahmedre", "createdAt": "2020-07-21T23:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NDE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NTcwMQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451945701", "bodyText": "Why do you need an activity here? It is generally a bad idea to have a reference to an activity.\nThere should be a better way of achieving your goal. Maybe replace with an interface?", "author": "ozbek", "createdAt": "2020-07-09T03:39:47Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/adapter/TranslationsAdapter.java", "diffHunk": "@@ -26,12 +30,23 @@\n \n   private final UnicastSubject<TranslationRowData> onClickDownloadSubject = UnicastSubject.create();\n   private final UnicastSubject<TranslationRowData> onClickRemoveSubject = UnicastSubject.create();\n+  private final UnicastSubject<TranslationRowData> onClickRankUpSubject = UnicastSubject.create();\n+  private final UnicastSubject<TranslationRowData> onClickRankDownSubject = UnicastSubject.create();\n+\n+  private final AppCompatActivity activity;", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1Nzg5OQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452857899", "bodyText": "OK, I admit programmer laziness since were already using Context.  Happy to make that a cleaner interface instead...", "author": "papasmile", "createdAt": "2020-07-10T13:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NTcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NTk5Nw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451945997", "bodyText": "Please consider following the existing coding style.", "author": "ozbek", "createdAt": "2020-07-09T03:41:08Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/adapter/TranslationsAdapter.java", "diffHunk": "@@ -152,19 +219,75 @@ ImageView getRightImage() {\n       return rightImage;\n     }\n \n-    final View.OnClickListener removeListener = v -> {\n-      TranslationItem item = (TranslationItem) translations.get(getAdapterPosition());\n-      onClickRemoveSubject.onNext(item);\n+    final View.OnLongClickListener actionMenuListener = v -> {\n+      if (actionMode != null) {\n+        actionMode.finish();\n+        selectionListener.clearSelection();\n+      } else if (activity != null) {\n+        selectionListener.handleSelection(item);\n+        actionMode = activity.startSupportActionMode(new ModeCallback());\n+      }\n+      return true;\n     };\n \n     @Override\n     public void onClick(View v) {\n-      TranslationItem item = (TranslationItem) translations.get(getAdapterPosition());\n-      if (item.exists() && !item.needsUpgrade()) {\n-        onClickRemoveSubject.onNext(item);\n-      } else {\n+      if (actionMode != null) {\n+        actionMode.finish();\n+      }\n+      selectionListener.clearSelection();\n+      if (!item.exists() || item.needsUpgrade()) {\n         onClickDownloadSubject.onNext(item);\n       }\n     }\n   }\n+\n+  private class ModeCallback implements ActionMode.Callback  {\n+    @Override\n+    public boolean onCreateActionMode ( ActionMode mode, Menu menu )", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzOTAzOA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452439038", "bodyText": "@ozbek I have not figured out how project's code style works yet... is there an actual formatter config I am overlooking?  Or is there just something(s) specific that you'd like to stick to?", "author": "papasmile", "createdAt": "2020-07-09T19:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyOTE4Ng==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452629186", "bodyText": "Nothing serious, it's just how you have put the braces and use of white-space.", "author": "ozbek", "createdAt": "2020-07-10T05:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0NTk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0ODUzNA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r451948534", "bodyText": "Out of curiosity, what does \"dtm\" stand for? :)", "author": "ozbek", "createdAt": "2020-07-09T03:52:49Z", "path": "app/src/main/res/values/strings.xml", "diffHunk": "@@ -237,6 +237,10 @@\n   <string name=\"export_data_error\">Error exporting data</string>\n   <string name=\"exported_data\">Data exported to %1$s</string>\n \n+  <string name=\"dtm_move_up\">Move Up</string>", "originalCommit": "4b6c4a923b250e179bbf0462c07c1b25a69d2562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzOTI4NA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452439284", "bodyText": "lol 'downloaded translation menu' :)  just needed to make it unique", "author": "papasmile", "createdAt": "2020-07-09T19:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0ODUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYzMDE0MA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r452630140", "bodyText": "I don't think there is a need for unique names here, make them generic (simply use move_up, move_down and delete_translation?). We might as well re-use them elsewhere in the future.", "author": "ozbek", "createdAt": "2020-07-10T05:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0ODUzNA=="}], "type": "inlineReview"}, {"oid": "b8ac99ea08874409a515136a6a585af0883a12b9", "url": "https://github.com/quran/quran_android/commit/b8ac99ea08874409a515136a6a585af0883a12b9", "message": "cleanup", "committedDate": "2020-07-16T13:18:46Z", "type": "commit"}, {"oid": "25dd8898ba5eff35e2a2d855644145f6f8e7e624", "url": "https://github.com/quran/quran_android/commit/25dd8898ba5eff35e2a2d855644145f6f8e7e624", "message": "Initialize Cursor", "committedDate": "2020-07-17T13:02:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODEzMw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r458448133", "bodyText": "do we really expect these to be nullable? because if not, we can simplify things here", "author": "ahmedre", "createdAt": "2020-07-21T23:34:03Z", "path": "app/src/main/java/com/quran/labs/androidquran/common/LocalTransationDiplaySort.kt", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.quran.labs.androidquran.common\n+\n+class LocalTransationDiplaySort : Comparator<LocalTranslation> {\n+  override fun compare(p0: LocalTranslation?, p1: LocalTranslation?): Int {", "originalCommit": "25dd8898ba5eff35e2a2d855644145f6f8e7e624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk0MDkyNA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r458940924", "bodyText": "yup, good call", "author": "papasmile", "createdAt": "2020-07-22T16:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODUyNQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r458448525", "bodyText": "similarly, can these actually be nullable?", "author": "ahmedre", "createdAt": "2020-07-21T23:35:15Z", "path": "app/src/main/java/com/quran/labs/androidquran/dao/translation/TranslationItemDiplaySort.kt", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.quran.labs.androidquran.dao.translation\n+\n+class TranslationItemDiplaySort : Comparator<TranslationItem> {\n+  override fun compare(p0: TranslationItem?, p1: TranslationItem?): Int {", "originalCommit": "25dd8898ba5eff35e2a2d855644145f6f8e7e624", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7f5aca29ad808af53827e29e12b533d481f54d6", "url": "https://github.com/quran/quran_android/commit/b7f5aca29ad808af53827e29e12b533d481f54d6", "message": "cleanup and multi-move", "committedDate": "2020-07-23T15:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxNzY4NA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r459917684", "bodyText": "Who ate the s? :)", "author": "ozbek", "createdAt": "2020-07-24T08:25:00Z", "path": "app/src/main/java/com/quran/labs/androidquran/common/LocalTransationDiplaySort.kt", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.quran.labs.androidquran.common\n+\n+class LocalTransationDiplaySort : Comparator<LocalTranslation> {", "originalCommit": "b7f5aca29ad808af53827e29e12b533d481f54d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzODM2NA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460038364", "bodyText": "and the 'l' too you mean?  yea oops correcting spelling...", "author": "papasmile", "createdAt": "2020-07-24T13:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxNzY4NA=="}], "type": "inlineReview"}, {"oid": "604b9bf451792f7ce88b76a26f99c1af04f8b592", "url": "https://github.com/quran/quran_android/commit/604b9bf451792f7ce88b76a26f99c1af04f8b592", "message": "spelling", "committedDate": "2020-07-24T13:24:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODgwOQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460078809", "bodyText": "see comment below - try should move up though", "author": "ahmedre", "createdAt": "2020-07-24T14:14:01Z", "path": "app/src/main/java/com/quran/labs/androidquran/database/TranslationsDBAdapter.java", "diffHunk": "@@ -72,23 +72,27 @@ public long getLastWriteTime() {\n         null, null, null, null, null,\n         TranslationsTable.ID + \" ASC\");\n     if (cursor != null) {\n-      while (cursor.moveToNext()) {\n-        int id = cursor.getInt(0);\n-        String name = cursor.getString(1);\n-        String translator = cursor.getString(2);\n-        String translatorForeign = cursor.getString(3);\n-        String filename = cursor.getString(4);\n-        String url = cursor.getString(5);\n-        String languageCode = cursor.getString(6);\n-        int version = cursor.getInt(7);\n-        int minimumVersion = cursor.getInt(8);\n-\n-        if (quranFileUtils.hasTranslation(context, filename)) {\n-          items.add(new LocalTranslation(id, filename, name, translator,\n-              translatorForeign, url, languageCode, version, minimumVersion));\n+      try {", "originalCommit": "604b9bf451792f7ce88b76a26f99c1af04f8b592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4ODUwNw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460888507", "bodyText": "Salam, @ahmedre, can you explain why would we need to close a null cursor?", "author": "papasmile", "createdAt": "2020-07-27T13:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAwODk4NQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r461008985", "bodyText": "wa3laikum alsalam - you don't, but you can't skip closing the cursor until you assign it either - so as a better pattern, you do something like:\nCursor cursor = null;\ntry {\n  cursor = db.query()\n  while (cursor.moveToNext()) {\n  }\n} finally {\n  if (cursor != null) {\n    cursor.close()\n  }\n}\n\ncursor.close() can actually throw also, which is why we have the DatabaseUtils.closeCursor method which does that for you - it checks if it's null and if so does nothing - if it's not null, it tries to close it and swallows any exceptions it throws.", "author": "ahmedre", "createdAt": "2020-07-27T16:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxOTMwOA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r461019308", "bodyText": "Oh, ok, @ahmedre, you just shuffled the null check, lol.  I can't say that is necessarily \"better\"... actually it's a little more \"traditional\" e.g. to catch errors from cursor instantiation, in which case you'd need to keep a reference to it outside of try/catch.  But that's neither here nor there.\nHowever, I'm curious about DatabaseUtils.closeCursor.  Why would we want to swallow cursor.close() and not db.query().  I was going for consistency (ie throw everything)... but are you just wanting to ignore cursor close errors specifically?", "author": "papasmile", "createdAt": "2020-07-27T16:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MTM3OQ==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r461061379", "bodyText": "if cursor.close() fails, there's nothing i can do about it - there's nothing that can be fixed, etc so we swallow it. db.query() failing could be because of a bad query, missing column, etc and can fail for a number of reasons, and in all of these cases i want to know about it so i can fix it.", "author": "ahmedre", "createdAt": "2020-07-27T17:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MTI4OA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460081288", "bodyText": "question - why do we have to do this? why not assume that the result from sortDownloadedItems() is the sort ordering - so basically when you choose item 3 and move up, you just swap positions 2 and 3 without having to do these loops.", "author": "ahmedre", "createdAt": "2020-07-24T14:17:51Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/TranslationManagerActivity.java", "diffHunk": "@@ -330,6 +356,86 @@ private void removeItem(final TranslationRowData translationRowData) {\n     builder.show();\n   }\n \n+  private List<TranslationItem> sortedDownloadedItems() {\n+    final ArrayList<TranslationItem> result = new ArrayList<>();\n+    for (TranslationItem item : allItems) {\n+      if (item.exists()) result.add(item);\n+    }\n+    Collections.sort(result, new TranslationItemDisplaySort ());\n+    return result;\n+  }\n+\n+  private void rankDownItem(TranslationRowData targetRow) {\n+    TranslationItem targetItem = (TranslationItem) targetRow;\n+    List<TranslationItem> sortedDownloads = sortedDownloadedItems();\n+    if (sortedDownloads.indexOf(targetItem) + 1 < sortedDownloads.size()) { // ignore last item in list\n+      TranslationItem updatedItem = targetItem.withDisplayOrder(targetItem.getDisplayOrder() + 1);\n+      ArrayList<TranslationItem> toUpdate = new ArrayList<>();", "originalCommit": "604b9bf451792f7ce88b76a26f99c1af04f8b592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MjU0OA==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460092548", "bodyText": "Again, for what was mentioned previously that there may be gaps when an item is deleted.  Alternatively, shifting logic could be moved to download routine... but that seems a lot trickier at first glance.", "author": "papasmile", "createdAt": "2020-07-24T14:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MTI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4MTU4Nw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460081587", "bodyText": "same here", "author": "ahmedre", "createdAt": "2020-07-24T14:18:17Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/TranslationManagerActivity.java", "diffHunk": "@@ -330,6 +356,86 @@ private void removeItem(final TranslationRowData translationRowData) {\n     builder.show();\n   }\n \n+  private List<TranslationItem> sortedDownloadedItems() {\n+    final ArrayList<TranslationItem> result = new ArrayList<>();\n+    for (TranslationItem item : allItems) {\n+      if (item.exists()) result.add(item);\n+    }\n+    Collections.sort(result, new TranslationItemDisplaySort ());\n+    return result;\n+  }\n+\n+  private void rankDownItem(TranslationRowData targetRow) {\n+    TranslationItem targetItem = (TranslationItem) targetRow;\n+    List<TranslationItem> sortedDownloads = sortedDownloadedItems();\n+    if (sortedDownloads.indexOf(targetItem) + 1 < sortedDownloads.size()) { // ignore last item in list\n+      TranslationItem updatedItem = targetItem.withDisplayOrder(targetItem.getDisplayOrder() + 1);\n+      ArrayList<TranslationItem> toUpdate = new ArrayList<>();\n+      toUpdate.add(updatedItem);\n+      TranslationItem swapItem = null;\n+      for(TranslationItem translationItem : sortedDownloads){\n+        if (translationItem.getDisplayOrder() == updatedItem.getDisplayOrder()) {\n+          swapItem = translationItem;\n+          break;\n+        }\n+      }\n+      if (swapItem != null) { // swap item order\n+        if (swapItem.getDisplayOrder() > 0) {\n+          toUpdate.add(swapItem.withDisplayOrder(swapItem.getDisplayOrder() - 1));\n+        }\n+      } else { // shift item order for higher items\n+        for (TranslationItem translationItem : sortedDownloads) {\n+          if (translationItem.getDisplayOrder() > -1 && translationItem.getDisplayOrder() < updatedItem.getDisplayOrder()) {\n+            toUpdate.add(translationItem.withDisplayOrder(translationItem.getDisplayOrder() + 1));\n+          }\n+        }\n+      }\n+      if (!toUpdate.isEmpty()) {\n+        if (selectionListener != null) selectionListener.handleSelection(updatedItem);\n+        for(TranslationItem toUpdateItem : toUpdate){\n+          updateTranslationItem(toUpdateItem);\n+        }\n+        generateListItems();\n+      }\n+    }\n+  }\n+\n+  private void rankUpItem(TranslationRowData targetRow) {\n+    TranslationItem targetItem = (TranslationItem) targetRow;\n+    List<TranslationItem> sortedDownloads = sortedDownloadedItems();\n+    if (sortedDownloads.indexOf(targetItem) > 0) { // ignore first item in list\n+      ArrayList<TranslationItem> toUpdate  = new ArrayList<>();", "originalCommit": "604b9bf451792f7ce88b76a26f99c1af04f8b592", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4NTM3Ng==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460085376", "bodyText": "this is expensive because every move is a database query when it doesn't need to be. we should just update when action mode is closed.", "author": "ahmedre", "createdAt": "2020-07-24T14:24:12Z", "path": "app/src/main/java/com/quran/labs/androidquran/ui/TranslationManagerActivity.java", "diffHunk": "@@ -330,6 +356,86 @@ private void removeItem(final TranslationRowData translationRowData) {\n     builder.show();\n   }\n \n+  private List<TranslationItem> sortedDownloadedItems() {\n+    final ArrayList<TranslationItem> result = new ArrayList<>();\n+    for (TranslationItem item : allItems) {\n+      if (item.exists()) result.add(item);\n+    }\n+    Collections.sort(result, new TranslationItemDisplaySort ());\n+    return result;\n+  }\n+\n+  private void rankDownItem(TranslationRowData targetRow) {\n+    TranslationItem targetItem = (TranslationItem) targetRow;\n+    List<TranslationItem> sortedDownloads = sortedDownloadedItems();\n+    if (sortedDownloads.indexOf(targetItem) + 1 < sortedDownloads.size()) { // ignore last item in list\n+      TranslationItem updatedItem = targetItem.withDisplayOrder(targetItem.getDisplayOrder() + 1);\n+      ArrayList<TranslationItem> toUpdate = new ArrayList<>();\n+      toUpdate.add(updatedItem);\n+      TranslationItem swapItem = null;\n+      for(TranslationItem translationItem : sortedDownloads){\n+        if (translationItem.getDisplayOrder() == updatedItem.getDisplayOrder()) {\n+          swapItem = translationItem;\n+          break;\n+        }\n+      }\n+      if (swapItem != null) { // swap item order\n+        if (swapItem.getDisplayOrder() > 0) {\n+          toUpdate.add(swapItem.withDisplayOrder(swapItem.getDisplayOrder() - 1));\n+        }\n+      } else { // shift item order for higher items\n+        for (TranslationItem translationItem : sortedDownloads) {\n+          if (translationItem.getDisplayOrder() > -1 && translationItem.getDisplayOrder() < updatedItem.getDisplayOrder()) {\n+            toUpdate.add(translationItem.withDisplayOrder(translationItem.getDisplayOrder() + 1));\n+          }\n+        }\n+      }\n+      if (!toUpdate.isEmpty()) {\n+        if (selectionListener != null) selectionListener.handleSelection(updatedItem);\n+        for(TranslationItem toUpdateItem : toUpdate){\n+          updateTranslationItem(toUpdateItem);\n+        }\n+        generateListItems();\n+      }", "originalCommit": "604b9bf451792f7ce88b76a26f99c1af04f8b592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NTI5Mw==", "url": "https://github.com/quran/quran_android/pull/1398#discussion_r460095293", "bodyText": "Hm, updateTranslationItem updates both our activity data and database in one go.  But, yea, it's probably not necessary... then we'll have to break up updateTranslationItem for use in moving translations.", "author": "papasmile", "createdAt": "2020-07-24T14:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4NTM3Ng=="}], "type": "inlineReview"}]}