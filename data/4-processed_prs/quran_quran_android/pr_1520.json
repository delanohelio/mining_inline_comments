{"pr_number": 1520, "pr_title": "Remove old upgrades", "pr_createdAt": "2020-12-30T21:14:26Z", "pr_url": "https://github.com/quran/quran_android/pull/1520", "timeline": [{"oid": "98ee447828cfde4e6576550c685a42e9054e602a", "url": "https://github.com/quran/quran_android/commit/98ee447828cfde4e6576550c685a42e9054e602a", "message": "Remove old upgrades\n\nThere are some very old preference upgrades that still run. These are\nactually very dangerous on non-Madani releases, since they may result in\nthe data being \"lost\" if the default data directory changes. Whenever\nnew updates like this are added, care should be taken to treat different\nflavors differently.", "committedDate": "2020-12-30T21:12:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyOTE0Nw==", "url": "https://github.com/quran/quran_android/pull/1520#discussion_r550329147", "bodyText": "this was from 2016.", "author": "ahmedre", "createdAt": "2020-12-30T21:15:24Z", "path": "app/src/main/java/com/quran/labs/androidquran/util/QuranSettings.java", "diffHunk": "@@ -185,63 +185,6 @@ public void upgradePreferences() {\n         version = prefs.getInt(Constants.PREF_VERSION, 0);\n       }\n \n-      if (version != 0) {\n-        if (version < 2672) {", "originalCommit": "98ee447828cfde4e6576550c685a42e9054e602a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyOTIxOA==", "url": "https://github.com/quran/quran_android/pull/1520#discussion_r550329218", "bodyText": "so was this.", "author": "ahmedre", "createdAt": "2020-12-30T21:15:31Z", "path": "app/src/main/java/com/quran/labs/androidquran/util/QuranSettings.java", "diffHunk": "@@ -185,63 +185,6 @@ public void upgradePreferences() {\n         version = prefs.getInt(Constants.PREF_VERSION, 0);\n       }\n \n-      if (version != 0) {\n-        if (version < 2672) {\n-          // migrate preferences\n-          setAppCustomLocation(prefs.getString(Constants.PREF_APP_LOCATION, null));\n-\n-          if (prefs.contains(Constants.PREF_SHOULD_FETCH_PAGES)) {\n-            setShouldFetchPages(prefs.getBoolean(Constants.PREF_SHOULD_FETCH_PAGES, false));\n-          }\n-\n-          if (prefs.contains(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)) {\n-            setLastDownloadError(\n-                prefs.getString(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM, null),\n-                prefs.getInt(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR, 0));\n-          }\n-\n-          prefs.edit()\n-              .remove(Constants.PREF_VERSION)\n-              .remove(Constants.PREF_APP_LOCATION)\n-              .remove(Constants.PREF_SHOULD_FETCH_PAGES)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM)\n-              .remove(Constants.PREF_ACTIVE_TRANSLATION)\n-              // these aren't migrated since they can be derived pretty easily\n-              .remove(\"didPresentPermissionsRationale\") // was renamed, removing old one\n-              .remove(Constants.PREF_DEFAULT_IMAGES_DIR)\n-              .remove(Constants.PREF_HAVE_UPDATED_TRANSLATIONS)\n-              .remove(Constants.PREF_LAST_UPDATED_TRANSLATIONS)\n-              .apply();\n-        } else if (version < 2674) {", "originalCommit": "98ee447828cfde4e6576550c685a42e9054e602a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyOTI0MA==", "url": "https://github.com/quran/quran_android/pull/1520#discussion_r550329240", "bodyText": "2017", "author": "ahmedre", "createdAt": "2020-12-30T21:15:38Z", "path": "app/src/main/java/com/quran/labs/androidquran/util/QuranSettings.java", "diffHunk": "@@ -185,63 +185,6 @@ public void upgradePreferences() {\n         version = prefs.getInt(Constants.PREF_VERSION, 0);\n       }\n \n-      if (version != 0) {\n-        if (version < 2672) {\n-          // migrate preferences\n-          setAppCustomLocation(prefs.getString(Constants.PREF_APP_LOCATION, null));\n-\n-          if (prefs.contains(Constants.PREF_SHOULD_FETCH_PAGES)) {\n-            setShouldFetchPages(prefs.getBoolean(Constants.PREF_SHOULD_FETCH_PAGES, false));\n-          }\n-\n-          if (prefs.contains(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)) {\n-            setLastDownloadError(\n-                prefs.getString(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM, null),\n-                prefs.getInt(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR, 0));\n-          }\n-\n-          prefs.edit()\n-              .remove(Constants.PREF_VERSION)\n-              .remove(Constants.PREF_APP_LOCATION)\n-              .remove(Constants.PREF_SHOULD_FETCH_PAGES)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM)\n-              .remove(Constants.PREF_ACTIVE_TRANSLATION)\n-              // these aren't migrated since they can be derived pretty easily\n-              .remove(\"didPresentPermissionsRationale\") // was renamed, removing old one\n-              .remove(Constants.PREF_DEFAULT_IMAGES_DIR)\n-              .remove(Constants.PREF_HAVE_UPDATED_TRANSLATIONS)\n-              .remove(Constants.PREF_LAST_UPDATED_TRANSLATIONS)\n-              .apply();\n-        } else if (version < 2674) {\n-          // explicitly an else - if we migrated via the above, we're okay. otherwise, we are in\n-          // a bad state due to not crashing in 2.6.7-p2 (thus getting its incorrect behavior),\n-          // and thus crashing on 2.6.7-p3 and above (where the bug was fixed). this works around\n-          // this issue.\n-          try {\n-            getLastDownloadItemWithError();\n-            getLastDownloadErrorCode();\n-          } catch (Exception e) {\n-            clearLastDownloadError();\n-          }\n-        } else if (version == 2800) {", "originalCommit": "98ee447828cfde4e6576550c685a42e9054e602a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyOTI2OQ==", "url": "https://github.com/quran/quran_android/pull/1520#discussion_r550329269", "bodyText": "just cleanup, ok if we don't do it.", "author": "ahmedre", "createdAt": "2020-12-30T21:15:48Z", "path": "app/src/main/java/com/quran/labs/androidquran/util/QuranSettings.java", "diffHunk": "@@ -185,63 +185,6 @@ public void upgradePreferences() {\n         version = prefs.getInt(Constants.PREF_VERSION, 0);\n       }\n \n-      if (version != 0) {\n-        if (version < 2672) {\n-          // migrate preferences\n-          setAppCustomLocation(prefs.getString(Constants.PREF_APP_LOCATION, null));\n-\n-          if (prefs.contains(Constants.PREF_SHOULD_FETCH_PAGES)) {\n-            setShouldFetchPages(prefs.getBoolean(Constants.PREF_SHOULD_FETCH_PAGES, false));\n-          }\n-\n-          if (prefs.contains(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)) {\n-            setLastDownloadError(\n-                prefs.getString(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM, null),\n-                prefs.getInt(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR, 0));\n-          }\n-\n-          prefs.edit()\n-              .remove(Constants.PREF_VERSION)\n-              .remove(Constants.PREF_APP_LOCATION)\n-              .remove(Constants.PREF_SHOULD_FETCH_PAGES)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM)\n-              .remove(Constants.PREF_ACTIVE_TRANSLATION)\n-              // these aren't migrated since they can be derived pretty easily\n-              .remove(\"didPresentPermissionsRationale\") // was renamed, removing old one\n-              .remove(Constants.PREF_DEFAULT_IMAGES_DIR)\n-              .remove(Constants.PREF_HAVE_UPDATED_TRANSLATIONS)\n-              .remove(Constants.PREF_LAST_UPDATED_TRANSLATIONS)\n-              .apply();\n-        } else if (version < 2674) {\n-          // explicitly an else - if we migrated via the above, we're okay. otherwise, we are in\n-          // a bad state due to not crashing in 2.6.7-p2 (thus getting its incorrect behavior),\n-          // and thus crashing on 2.6.7-p3 and above (where the bug was fixed). this works around\n-          // this issue.\n-          try {\n-            getLastDownloadItemWithError();\n-            getLastDownloadErrorCode();\n-          } catch (Exception e) {\n-            clearLastDownloadError();\n-          }\n-        } else if (version == 2800) {\n-          // upgrading from 2800, need to remove notification channels\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n-            deleteOldNotificationChannels();\n-          }\n-        }\n-\n-        if (version < 2943) {", "originalCommit": "98ee447828cfde4e6576550c685a42e9054e602a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyOTM0OA==", "url": "https://github.com/quran/quran_android/pull/1520#discussion_r550329348", "bodyText": "more recent but ok if we don't do it anymore since al7amdulillah most people stopped complaining about partial pages now.", "author": "ahmedre", "createdAt": "2020-12-30T21:16:01Z", "path": "app/src/main/java/com/quran/labs/androidquran/util/QuranSettings.java", "diffHunk": "@@ -185,63 +185,6 @@ public void upgradePreferences() {\n         version = prefs.getInt(Constants.PREF_VERSION, 0);\n       }\n \n-      if (version != 0) {\n-        if (version < 2672) {\n-          // migrate preferences\n-          setAppCustomLocation(prefs.getString(Constants.PREF_APP_LOCATION, null));\n-\n-          if (prefs.contains(Constants.PREF_SHOULD_FETCH_PAGES)) {\n-            setShouldFetchPages(prefs.getBoolean(Constants.PREF_SHOULD_FETCH_PAGES, false));\n-          }\n-\n-          if (prefs.contains(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)) {\n-            setLastDownloadError(\n-                prefs.getString(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM, null),\n-                prefs.getInt(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR, 0));\n-          }\n-\n-          prefs.edit()\n-              .remove(Constants.PREF_VERSION)\n-              .remove(Constants.PREF_APP_LOCATION)\n-              .remove(Constants.PREF_SHOULD_FETCH_PAGES)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ERROR)\n-              .remove(QuranDownloadService.PREF_LAST_DOWNLOAD_ITEM)\n-              .remove(Constants.PREF_ACTIVE_TRANSLATION)\n-              // these aren't migrated since they can be derived pretty easily\n-              .remove(\"didPresentPermissionsRationale\") // was renamed, removing old one\n-              .remove(Constants.PREF_DEFAULT_IMAGES_DIR)\n-              .remove(Constants.PREF_HAVE_UPDATED_TRANSLATIONS)\n-              .remove(Constants.PREF_LAST_UPDATED_TRANSLATIONS)\n-              .apply();\n-        } else if (version < 2674) {\n-          // explicitly an else - if we migrated via the above, we're okay. otherwise, we are in\n-          // a bad state due to not crashing in 2.6.7-p2 (thus getting its incorrect behavior),\n-          // and thus crashing on 2.6.7-p3 and above (where the bug was fixed). this works around\n-          // this issue.\n-          try {\n-            getLastDownloadItemWithError();\n-            getLastDownloadErrorCode();\n-          } catch (Exception e) {\n-            clearLastDownloadError();\n-          }\n-        } else if (version == 2800) {\n-          // upgrading from 2800, need to remove notification channels\n-          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n-            deleteOldNotificationChannels();\n-          }\n-        }\n-\n-        if (version < 2943) {\n-          prefs.edit().remove(\"didDownloadPages\").apply();\n-        }\n-\n-        if (version < 2961) {", "originalCommit": "98ee447828cfde4e6576550c685a42e9054e602a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}