{"pr_number": 1073, "pr_title": "[Merge only after UltraBrew changes are merged]Generate Metrics code in API Requests", "pr_createdAt": "2020-08-02T12:47:29Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1073", "timeline": [{"oid": "d2c6f3ae872c543715c1d5265e3ac42f16839801", "url": "https://github.com/AthenZ/athenz/commit/d2c6f3ae872c543715c1d5265e3ac42f16839801", "message": "Generate Metrics code in ZMS API Requests", "committedDate": "2020-08-02T14:49:26Z", "type": "forcePushed"}, {"oid": "c16226203072b0ed845485ad0019e5f7169ef3e5", "url": "https://github.com/AthenZ/athenz/commit/c16226203072b0ed845485ad0019e5f7169ef3e5", "message": "Generate Metrics code in ZMS API Requests", "committedDate": "2020-08-02T14:51:59Z", "type": "forcePushed"}, {"oid": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "url": "https://github.com/AthenZ/athenz/commit/66bdd5336dd678aa53ba43d1956a6927e5b45c87", "message": "Generate Metrics code in ZMS API Requests", "committedDate": "2020-08-03T08:57:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5MDU2Nw==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464290567", "bodyText": "I'm setting the domain name here to \"invalid_domain\"", "author": "OferLevi85", "createdAt": "2020-08-03T09:12:30Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2536,15 +2433,14 @@ Access getAccessCheck(Principal principal, String action, String resource,\n         // retrieve the domain based on our resource and action/trustDomain pair\n \n         String domainName = retrieveResourceDomain(resource, action, trustDomain);\n+        setRequestDomain(ctx, domainName);\n         if (domainName == null) {\n-            metric.increment(ZMSConsts.HTTP_REQUEST, ZMSConsts.ZMS_INVALID_DOMAIN, principal.getDomain());\n-            metric.increment(caller, ZMSConsts.ZMS_INVALID_DOMAIN, principal.getDomain());\n+            setRequestDomain(ctx, ZMSConsts.ZMS_INVALID_DOMAIN);", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5MDc4MQ==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464290781", "bodyText": "I'm setting the domain name here to \"unknown_domain\"", "author": "OferLevi85", "createdAt": "2020-08-03T09:12:52Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2536,15 +2433,14 @@ Access getAccessCheck(Principal principal, String action, String resource,\n         // retrieve the domain based on our resource and action/trustDomain pair\n \n         String domainName = retrieveResourceDomain(resource, action, trustDomain);\n+        setRequestDomain(ctx, domainName);\n         if (domainName == null) {\n-            metric.increment(ZMSConsts.HTTP_REQUEST, ZMSConsts.ZMS_INVALID_DOMAIN, principal.getDomain());\n-            metric.increment(caller, ZMSConsts.ZMS_INVALID_DOMAIN, principal.getDomain());\n+            setRequestDomain(ctx, ZMSConsts.ZMS_INVALID_DOMAIN);\n             throw ZMSUtils.notFoundError(\"getAccessCheck: Unable to extract resource domain\", caller);\n         }\n         AthenzDomain domain = retrieveAccessDomain(domainName, principal);\n         if (domain == null) {\n-            metric.increment(ZMSConsts.HTTP_REQUEST, ZMSConsts.ZMS_UNKNOWN_DOMAIN, principal.getDomain());\n-            metric.increment(caller, ZMSConsts.ZMS_UNKNOWN_DOMAIN, principal.getDomain());\n+            setRequestDomain(ctx, ZMSConsts.ZMS_UNKNOWN_DOMAIN);", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5NDM4Nw==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464294387", "bodyText": "I originally had the caller (method name in lowercase) placed in the context in ZMSResources and then I was able to have the same line for every method: \"final String caller = ctx.getApiName();\".\nThe reason I didn't change it eventually as I noticed that it is sometimes used in authority checks (as the operation in verifyAuthorizedServiceOperation calls). So maybe it is best to keep it explicit.\nLet me know what you think.", "author": "OferLevi85", "createdAt": "2020-08-03T09:19:46Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -1054,12 +1054,7 @@ public DomainList getDomainList(ResourceContext ctx, Integer limit, String skip,\n             String modifiedSince) {\n \n         final String caller = \"getdomainlist\";", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMwMTAzNA==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464301034", "bodyText": "Originally this method doesn't send the domain but I think it is correct to put it (if it exists)", "author": "OferLevi85", "createdAt": "2020-08-03T09:31:53Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -5385,6 +5026,7 @@ public Response getSignedDomains(ResourceContext ctx, String domainName, String\n         if (domainName != null) {\n             domainName = domainName.toLowerCase();\n             validate(domainName, TYPE_DOMAIN_NAME, caller);\n+            setRequestDomain(ctx, domainName);", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMwMTY0Mg==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464301642", "bodyText": "Originally this method doesn't send the domain but I think it is correct to put it (if it exists)", "author": "OferLevi85", "createdAt": "2020-08-03T09:33:02Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -5530,6 +5166,7 @@ public JWSDomain getJWSDomain(ResourceContext ctx, String domainName) {\n         // policy, service, etc name)\n \n         domainName = domainName.toLowerCase();\n+        setRequestDomain(ctx, domainName);", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MTYwOQ==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464581609", "bodyText": "Not sure we can move this call out of try block. If it throws an exception, it might expose our trace and some other internal data to the caller which we can't have. We should be able to define the ResourceContext context = null outside of the try block and keep the delegate call within the block and within the recordMetrics calls make sure to handle the case where context is null.", "author": "havetisyan", "createdAt": "2020-08-03T18:13:46Z", "path": "rdl/rdl-gen-athenz-server/main.go", "diffHunk": "@@ -407,8 +408,9 @@ func (gen *javaServerGenerator) resourcePath(r *rdl.Resource) string {\n \n func (gen *javaServerGenerator) handlerBody(r *rdl.Resource) string {\n \tnoContent := r.Expected == \"NO_CONTENT\" && r.Alternatives == nil\n-\ts := \"        try {\\n\"\n-\ts += \"            ResourceContext context = this.delegate.newResourceContext(this.request, this.response);\\n\"\n+\ts := \"        int code = ResourceException.OK;\\n\"\n+\ts += \"        ResourceContext context = this.delegate.newResourceContext(this.request, this.response);\\n\"", "originalCommit": "66bdd5336dd678aa53ba43d1956a6927e5b45c87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e78897312430328fa45762945760972d7ace9c40", "url": "https://github.com/AthenZ/athenz/commit/e78897312430328fa45762945760972d7ace9c40", "message": "Fix", "committedDate": "2020-08-04T06:42:10Z", "type": "forcePushed"}, {"oid": "8bacadffffe31b5b915051ba55a221735b44bebe", "url": "https://github.com/AthenZ/athenz/commit/8bacadffffe31b5b915051ba55a221735b44bebe", "message": "Generate Metrics code in API Requests", "committedDate": "2020-08-04T08:43:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkwMTUwNw==", "url": "https://github.com/AthenZ/athenz/pull/1073#discussion_r464901507", "bodyText": "postInstanceRefreshInformation has many metrics that are not related to the HTTP request (such as \"providerconfirm\"). I didn't change them.", "author": "OferLevi85", "createdAt": "2020-08-04T08:53:11Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2938,9 +2784,6 @@ public InstanceIdentity postInstanceRefreshInformation(ResourceContext ctx, Stri\n             String domain, String service, String instanceId, InstanceRefreshInformation info) {\n \n         final String caller = \"postinstancerefreshinformation\";\n-        final String callerTiming = \"postinstancerefreshinformation_timing\";\n-\n-        metric.increment(HTTP_POST);", "originalCommit": "8bacadffffe31b5b915051ba55a221735b44bebe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ec54d7fe3c8fd9410b2b2312d33a6527790d79e", "url": "https://github.com/AthenZ/athenz/commit/2ec54d7fe3c8fd9410b2b2312d33a6527790d79e", "message": "Generate Metrics code in API Requests", "committedDate": "2020-08-04T09:16:08Z", "type": "commit"}, {"oid": "2ec54d7fe3c8fd9410b2b2312d33a6527790d79e", "url": "https://github.com/AthenZ/athenz/commit/2ec54d7fe3c8fd9410b2b2312d33a6527790d79e", "message": "Generate Metrics code in API Requests", "committedDate": "2020-08-04T09:16:08Z", "type": "forcePushed"}]}