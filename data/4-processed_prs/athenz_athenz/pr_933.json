{"pr_number": 933, "pr_title": "Refactor EmailNotificationService", "pr_createdAt": "2020-04-15T12:47:18Z", "pr_url": "https://github.com/AthenZ/athenz/pull/933", "timeline": [{"oid": "19cd600da9d0fd18a289c9fed15f5649854227e1", "url": "https://github.com/AthenZ/athenz/commit/19cd600da9d0fd18a289c9fed15f5649854227e1", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email", "committedDate": "2020-04-15T12:59:30Z", "type": "forcePushed"}, {"oid": "809ea6302d92a0052bee0d4135e60728d500a51e", "url": "https://github.com/AthenZ/athenz/commit/809ea6302d92a0052bee0d4135e60728d500a51e", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email", "committedDate": "2020-04-15T13:04:35Z", "type": "forcePushed"}, {"oid": "6650ff42e168a1389e16dcdb97349d0d0768c1b5", "url": "https://github.com/AthenZ/athenz/commit/6650ff42e168a1389e16dcdb97349d0d0768c1b5", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email", "committedDate": "2020-04-16T08:25:58Z", "type": "forcePushed"}, {"oid": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "url": "https://github.com/AthenZ/athenz/commit/8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email", "committedDate": "2020-04-16T15:31:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMjU4Nw==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409732587", "bodyText": "The structure returned from NotificationToEmailConverter. EmailNotificationService will get the subject / body / email of recipients from it.", "author": "OferLevi85", "createdAt": "2020-04-16T17:36:22Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationEmail.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+public class NotificationEmail {\n+    private String subject;\n+    private String body;\n+    private Set<String> fullyQualifiedRecipientsEmail;\n+", "originalCommit": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMjg4Ng==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409732886", "bodyText": "Common class used by all NotificationToEmailConverters.", "author": "OferLevi85", "createdAt": "2020-04-16T17:36:52Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class NotificationToEmailConverterCommon {", "originalCommit": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMzMyMg==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409733322", "bodyText": "All notification specific logic was removed.", "author": "OferLevi85", "createdAt": "2020-04-16T17:37:40Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "diffHunk": "@@ -48,86 +46,24 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(EmailNotificationService.class);\n \n-    private static final String AT = \"@\";\n-    private static final String USER_DOMAIN_DEFAULT = \"user\";", "originalCommit": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczNDIzMg==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r409734232", "bodyText": "This method gets ClassLoader as it will be called from both ZTS and ZMS (each with its own resources).", "author": "OferLevi85", "createdAt": "2020-04-16T17:39:07Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationToEmailConverterCommon.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.text.MessageFormat;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class NotificationToEmailConverterCommon {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(NotificationToEmailConverterCommon.class);\n+\n+    private static final String AT = \"@\";\n+    private static final String USER_DOMAIN_DEFAULT = \"user\";\n+    private static final String PROP_USER_DOMAIN = \"athenz.user_domain\";\n+    private static final String PROP_NOTIFICATION_EMAIL_DOMAIN_TO = \"athenz.notification_email_domain_to\";\n+    private static final String PROP_NOTIFICATION_WORKFLOW_URL = \"athenz.notification_workflow_url\";\n+    private static final String PROP_NOTIFICATION_ATHENZ_UI_URL = \"athenz.notification_athenz_ui_url\";\n+    private static final String PROP_NOTIFICATION_SUPPORT_TEXT = \"athenz.notification_support_text\";\n+    private static final String PROP_NOTIFICATION_SUPPORT_URL = \"athenz.notification_support_url\";\n+    private static final String EMAIL_TEMPLATE_CSS = \"emails/base.css\";\n+\n+    private static final String HTML_STYLE_TAG_START = \"<style>\";\n+    private static final String HTML_STYLE_TAG_END = \"</style>\";\n+    private static final String HTML_TBODY_TAG_START = \"<tbody>\";\n+    private static final String HTML_TBODY_TAG_END = \"</tbody>\";\n+\n+    // can be moved to constructor which can take Locale as input parameter and return appropriate resource bundle\n+    private static final ResourceBundle RB = ResourceBundle.getBundle(\"messages/ServerCommon\");\n+\n+    private String userDomainPrefix;\n+    private String emailDomainTo;\n+    private String workflowUrl;\n+    private String athenzUIUrl;\n+    private String supportText;\n+    private String supportUrl;\n+    private String emailBaseCSS;\n+\n+\n+    public NotificationToEmailConverterCommon() {\n+        String userDomain = System.getProperty(PROP_USER_DOMAIN, USER_DOMAIN_DEFAULT);\n+        userDomainPrefix = userDomain + \"\\\\.\";\n+        emailDomainTo = System.getProperty(PROP_NOTIFICATION_EMAIL_DOMAIN_TO);\n+        workflowUrl = System.getProperty(PROP_NOTIFICATION_WORKFLOW_URL);\n+        athenzUIUrl = System.getProperty(PROP_NOTIFICATION_ATHENZ_UI_URL);\n+        supportText = System.getProperty(PROP_NOTIFICATION_SUPPORT_TEXT);\n+        supportUrl = System.getProperty(PROP_NOTIFICATION_SUPPORT_URL);\n+\n+        emailBaseCSS = readContentFromFile(getClass().getClassLoader(), EMAIL_TEMPLATE_CSS);\n+\n+    }\n+\n+    public String readContentFromFile(ClassLoader classLoader, String fileName) {", "originalCommit": "8c7b3040d0b56df8fb19b6d9c1b57d559e1e2f59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c195a5820595d4226e9dc52b07a5bc4afdbd5327", "url": "https://github.com/AthenZ/athenz/commit/c195a5820595d4226e9dc52b07a5bc4afdbd5327", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email", "committedDate": "2020-04-19T07:21:30Z", "type": "forcePushed"}, {"oid": "c9db91decdbbc3445daa5dabf4242844fa109eac", "url": "https://github.com/AthenZ/athenz/commit/c9db91decdbbc3445daa5dabf4242844fa109eac", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email\n3. Removed NotificationType from Notification as it is no longer required in EmailNotificationServie", "committedDate": "2020-04-19T08:38:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzA3MA==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r410853070", "bodyText": "Removed the type from notification as it is no longer required (was used in EmailNotificationService in a switch statement to determine which body / subject to generate.", "author": "OferLevi85", "createdAt": "2020-04-19T08:41:25Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -20,27 +20,24 @@\n \n public class Notification {\n \n-    // Denotes notification type. MEMBERSHIP_APPROVAL, MEMBERSHIP_EXPIRY etc.", "originalCommit": "c9db91decdbbc3445daa5dabf4242844fa109eac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzQwOQ==", "url": "https://github.com/AthenZ/athenz/pull/933#discussion_r410853409", "bodyText": "NotificationToEmailConverter will be implemented inside each NotificationTask. Its purpose is to convert the notification into an email", "author": "OferLevi85", "createdAt": "2020-04-19T08:43:20Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -20,27 +20,24 @@\n \n public class Notification {\n \n-    // Denotes notification type. MEMBERSHIP_APPROVAL, MEMBERSHIP_EXPIRY etc.\n-    private String type;\n-\n     // Intended recipients of notification\n     private Set<String> recipients;\n \n     // key value pair describing additional details about notification\n     private Map<String, String> details;\n \n-    public Notification (String type, Set<String> recipients, Map<String, String> details) {\n-        this.type = type;\n+    // Utility class to convert the notification into an email", "originalCommit": "c9db91decdbbc3445daa5dabf4242844fa109eac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "62ab8a214980a99a6694b43fef1405edfff760f4", "url": "https://github.com/AthenZ/athenz/commit/62ab8a214980a99a6694b43fef1405edfff760f4", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email\n3. Removed NotificationType from Notification as it is no longer required in EmailNotificationServie", "committedDate": "2020-04-21T11:30:33Z", "type": "forcePushed"}, {"oid": "e959597b6f454e191ba41b9d83ccb250ebb6f921", "url": "https://github.com/AthenZ/athenz/commit/e959597b6f454e191ba41b9d83ccb250ebb6f921", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email\n3. Removed NotificationType from Notification as it is no longer required in EmailNotificationServie", "committedDate": "2020-04-21T12:16:32Z", "type": "forcePushed"}, {"oid": "2d2a2d6f6c7da286a45c1b06865042227f994987", "url": "https://github.com/AthenZ/athenz/commit/2d2a2d6f6c7da286a45c1b06865042227f994987", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email\n3. Removed NotificationType from Notification as it is no longer required in EmailNotificationServie", "committedDate": "2020-04-22T13:07:26Z", "type": "commit"}, {"oid": "2d2a2d6f6c7da286a45c1b06865042227f994987", "url": "https://github.com/AthenZ/athenz/commit/2d2a2d6f6c7da286a45c1b06865042227f994987", "message": "Refactor EmailNotificationService\n1. Moved all Notification specific logic to the respective NotificationTask\n2. Each NotiicationTask will have an inner static class implementing NotificationToEmailConverter that will convert the notification to email\n3. Removed NotificationType from Notification as it is no longer required in EmailNotificationServie", "committedDate": "2020-04-22T13:07:26Z", "type": "forcePushed"}]}