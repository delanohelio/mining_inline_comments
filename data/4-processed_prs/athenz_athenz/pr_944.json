{"pr_number": 944, "pr_title": "Production docker deployment", "pr_createdAt": "2020-04-22T05:36:20Z", "pr_url": "https://github.com/AthenZ/athenz/pull/944", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjUwMw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418332503", "bodyText": "Is the comment correct?", "author": "ssunorz", "createdAt": "2020-04-30T22:50:02Z", "path": "docker/README.md", "diffHunk": "@@ -6,117 +6,157 @@\n \n - [Athenz on Docker](#athenz-on-docker)\n     - [Index](#index)\n-    - [Prerequisite](#prerequisite)\n+    - [Prerequisites](#prerequisites)\n     - [Build Athenz](#build-athenz)\n     - [Deploy Athenz](#deploy-athenz)\n+    - [Verify Athenz Deployment](#verify-athenz-deployment)\n+        - [JAVA Remote debugging](#java-remote-debugging)\n     - [Cleanup](#cleanup)\n-    - [Configuration Details](#configuration-details)\n-    - [Useful Commands](#useful-commands)\n-    - [[WIP] deploy with docker-stack](#wip-deploy-with-docker-stack)\n-    - [TO-DO](#to-do)\n-    - [Important Files](#important-files)\n+    - [Appendix](#appendix)\n+        - [Important Files](#important-files)\n+        - [[WIP] Configuration Details](#wip-configuration-details)\n+        - [Useful Commands](#useful-commands)\n+        - [TODO](#todo)\n \n <!-- /TOC -->\n \n-<a id=\"markdown-prerequisite\" name=\"prerequisite\"></a>\n-## Prerequisite\n-- docker\n-- make\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. `git`\n+1. `docker`\n+1. `make`\n \n <a id=\"markdown-build-athenz\" name=\"build-athenz\"></a>\n ## Build Athenz\n \n ```bash\n cd `git rev-parse --show-toplevel`/docker\n \n-# there are a lot of build logs. You may want to check it inside a log file later on.\n-make build | tee ./athenz-docker-build.log\n+# it takes about 15-30 mins\n+make build\n+\n+# TODO: update the min. version before merge\n+# P.S. the latest code may cause docker build to fail, please use older version by specifying the tag version (> v1.8.60) or post an issue\n+# make build TAG=v1.8.60\n ```\n \n <a id=\"markdown-deploy-athenz\" name=\"deploy-athenz\"></a>\n ## Deploy Athenz\n \n+- production environment\n+    - [Athenz-bootstrap](./docs/Athenz-bootstrap.md)\n+- development environment\n+    ```bash\n+    make deploy-dev\n+    ```\n+\n+<a id=\"markdown-verify-athenz-deployment\" name=\"verify-athenz-deployment\"></a>\n+## Verify Athenz Deployment\n+\n+- production environment\n+    - [acceptance-test](./docs/acceptance-test.md)\n - development environment\n-    - deploy commands\n-        ```bash\n-        cd `git rev-parse --show-toplevel`/docker\n-\n-        # 1. set passwords (P.S. values in *.properties files will overwrite these values)\n-        source ./setup-scripts/0.export-default-passwords.sh\n-\n-        # 2. generate key-pairs, certificates and keystore/truststore\n-        make setup-dev-config\n-\n-        # 3. (once ONLY) create docker network\n-        make setup-docker-network\n-\n-        # 4.1 (optional) if you are running web browser and docker containers in the same host\n-        export HOSTNAME=localhost\n-        # 4.2. run Athenz\n-        make run-docker-dev\n-        ```\n-    - Note for UI\n-        - To ignore certificate warning from the browser,\n-            1. for ZMS server certificate,\n-                1. get ZMS URL by `echo https://${HOSTNAME}:${ZMS_PORT:-4443}/zms/v1/status`\n-                1. access ZMS using above URL in the browser\n-                1. ignore the browser warning (certificate authority invalid)\n-            1. for UI server certificate,\n-                1. get UI URL by `echo https://${HOSTNAME}:${UI_PORT:-443}/`\n-                1. access UI using above URL in the browser\n-                1. ignore the browser warning (certificate authority invalid)\n-            - Why do I need to explicitly ignore certificate warning from the browser for both ZMS and UI?\n-                - You need to connect to ZMS to get a user token during the login process of UI.\n-                - Since the certificates generated in DEV. deployment are all self-signed certificates, they are not trusted by the browser.\n-                - Also, they may not have the correct `${HOSTNAME}` in the SAN field depending on your DEV. deployment.\n-                - Hence, explicitly ignoring the browsers warning message is needed for both ZMS and UI.\n-        - UI login username/password\n-            - username: `admin` ([zms.properties](./zms/conf/zms.properties#L37-L41))\n-            - password: `replace_me_with_a_strong_password` ([deploy script](./deploy-scripts/1.2.config-zms-domain-admin.dev.sh#L12))\n+    ```bash\n+    make verify\n+    ```\n+\n+<a id=\"markdown-java-remote-debugging\" name=\"java-remote-debugging\"></a>\n+### JAVA Remote debugging\n+\n+```bash\n+### ZMS\n+ZMS_DEBUG_PORT=8001\n+export ZMS_JAVA_OPTS=\"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${ZMS_DEBUG_PORT}\"\n+# re-deploy ZMS, reference: ./deploy-scripts/zms-deploy.sh\n+# expose debug port\n+docker run --rm \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -p \"${ZMS_DEBUG_PORT}:${ZMS_DEBUG_PORT}\" \\\n+    --link \"${ZMS_HOST}:target\" \\\n+    alpine/socat \\\n+    \"tcp-listen:${ZMS_DEBUG_PORT},fork,reuseaddr\" \\\n+    \"tcp-connect:target:${ZMS_DEBUG_PORT}\"\n+\n+### ZTS\n+ZTS_DEBUG_PORT=8002\n+export ZTS_JAVA_OPTS=\"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${ZTS_DEBUG_PORT}\"\n+# re-deploy ZTS, reference: ./deploy-scripts/zts-deploy.sh\n+# expose debug port\n+docker run --rm \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -p \"${ZTS_DEBUG_PORT}:${ZTS_DEBUG_PORT}\" \\\n+    --link \"${ZTS_HOST}:target\" \\\n+    alpine/socat \\\n+    \"tcp-listen:${ZTS_DEBUG_PORT},fork,reuseaddr\" \\\n+    \"tcp-connect:target:${ZTS_DEBUG_PORT}\"\n+```\n \n <a id=\"markdown-cleanup\" name=\"cleanup\"></a>\n ## Cleanup\n+\n ```bash\n-# remove deployment\n+# remove Athenz containers\n+make remove-containers\n+\n+# remove server data\n+make remove-files\n+\n+# remove bootstrap setup files", "originalCommit": "aad60957f2178f8e8bfee09481ae5fe7e0fc2b4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNDI4OQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418404289", "bodyText": "any other suggestions?", "author": "WindzCUHK", "createdAt": "2020-05-01T03:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwODQ1OA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418408458", "bodyText": "I'm sorry, it was a mistake. I think this is fine.", "author": "ssunorz", "createdAt": "2020-05-01T04:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjg2MA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418332860", "bodyText": "Is the comment correct?", "author": "ssunorz", "createdAt": "2020-04-30T22:51:06Z", "path": "docker/README.md", "diffHunk": "@@ -6,117 +6,157 @@\n \n - [Athenz on Docker](#athenz-on-docker)\n     - [Index](#index)\n-    - [Prerequisite](#prerequisite)\n+    - [Prerequisites](#prerequisites)\n     - [Build Athenz](#build-athenz)\n     - [Deploy Athenz](#deploy-athenz)\n+    - [Verify Athenz Deployment](#verify-athenz-deployment)\n+        - [JAVA Remote debugging](#java-remote-debugging)\n     - [Cleanup](#cleanup)\n-    - [Configuration Details](#configuration-details)\n-    - [Useful Commands](#useful-commands)\n-    - [[WIP] deploy with docker-stack](#wip-deploy-with-docker-stack)\n-    - [TO-DO](#to-do)\n-    - [Important Files](#important-files)\n+    - [Appendix](#appendix)\n+        - [Important Files](#important-files)\n+        - [[WIP] Configuration Details](#wip-configuration-details)\n+        - [Useful Commands](#useful-commands)\n+        - [TODO](#todo)\n \n <!-- /TOC -->\n \n-<a id=\"markdown-prerequisite\" name=\"prerequisite\"></a>\n-## Prerequisite\n-- docker\n-- make\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. `git`\n+1. `docker`\n+1. `make`\n \n <a id=\"markdown-build-athenz\" name=\"build-athenz\"></a>\n ## Build Athenz\n \n ```bash\n cd `git rev-parse --show-toplevel`/docker\n \n-# there are a lot of build logs. You may want to check it inside a log file later on.\n-make build | tee ./athenz-docker-build.log\n+# it takes about 15-30 mins\n+make build\n+\n+# TODO: update the min. version before merge\n+# P.S. the latest code may cause docker build to fail, please use older version by specifying the tag version (> v1.8.60) or post an issue\n+# make build TAG=v1.8.60\n ```\n \n <a id=\"markdown-deploy-athenz\" name=\"deploy-athenz\"></a>\n ## Deploy Athenz\n \n+- production environment\n+    - [Athenz-bootstrap](./docs/Athenz-bootstrap.md)\n+- development environment\n+    ```bash\n+    make deploy-dev\n+    ```\n+\n+<a id=\"markdown-verify-athenz-deployment\" name=\"verify-athenz-deployment\"></a>\n+## Verify Athenz Deployment\n+\n+- production environment\n+    - [acceptance-test](./docs/acceptance-test.md)\n - development environment\n-    - deploy commands\n-        ```bash\n-        cd `git rev-parse --show-toplevel`/docker\n-\n-        # 1. set passwords (P.S. values in *.properties files will overwrite these values)\n-        source ./setup-scripts/0.export-default-passwords.sh\n-\n-        # 2. generate key-pairs, certificates and keystore/truststore\n-        make setup-dev-config\n-\n-        # 3. (once ONLY) create docker network\n-        make setup-docker-network\n-\n-        # 4.1 (optional) if you are running web browser and docker containers in the same host\n-        export HOSTNAME=localhost\n-        # 4.2. run Athenz\n-        make run-docker-dev\n-        ```\n-    - Note for UI\n-        - To ignore certificate warning from the browser,\n-            1. for ZMS server certificate,\n-                1. get ZMS URL by `echo https://${HOSTNAME}:${ZMS_PORT:-4443}/zms/v1/status`\n-                1. access ZMS using above URL in the browser\n-                1. ignore the browser warning (certificate authority invalid)\n-            1. for UI server certificate,\n-                1. get UI URL by `echo https://${HOSTNAME}:${UI_PORT:-443}/`\n-                1. access UI using above URL in the browser\n-                1. ignore the browser warning (certificate authority invalid)\n-            - Why do I need to explicitly ignore certificate warning from the browser for both ZMS and UI?\n-                - You need to connect to ZMS to get a user token during the login process of UI.\n-                - Since the certificates generated in DEV. deployment are all self-signed certificates, they are not trusted by the browser.\n-                - Also, they may not have the correct `${HOSTNAME}` in the SAN field depending on your DEV. deployment.\n-                - Hence, explicitly ignoring the browsers warning message is needed for both ZMS and UI.\n-        - UI login username/password\n-            - username: `admin` ([zms.properties](./zms/conf/zms.properties#L37-L41))\n-            - password: `replace_me_with_a_strong_password` ([deploy script](./deploy-scripts/1.2.config-zms-domain-admin.dev.sh#L12))\n+    ```bash\n+    make verify\n+    ```\n+\n+<a id=\"markdown-java-remote-debugging\" name=\"java-remote-debugging\"></a>\n+### JAVA Remote debugging\n+\n+```bash\n+### ZMS\n+ZMS_DEBUG_PORT=8001\n+export ZMS_JAVA_OPTS=\"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${ZMS_DEBUG_PORT}\"\n+# re-deploy ZMS, reference: ./deploy-scripts/zms-deploy.sh\n+# expose debug port\n+docker run --rm \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -p \"${ZMS_DEBUG_PORT}:${ZMS_DEBUG_PORT}\" \\\n+    --link \"${ZMS_HOST}:target\" \\\n+    alpine/socat \\\n+    \"tcp-listen:${ZMS_DEBUG_PORT},fork,reuseaddr\" \\\n+    \"tcp-connect:target:${ZMS_DEBUG_PORT}\"\n+\n+### ZTS\n+ZTS_DEBUG_PORT=8002\n+export ZTS_JAVA_OPTS=\"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${ZTS_DEBUG_PORT}\"\n+# re-deploy ZTS, reference: ./deploy-scripts/zts-deploy.sh\n+# expose debug port\n+docker run --rm \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -p \"${ZTS_DEBUG_PORT}:${ZTS_DEBUG_PORT}\" \\\n+    --link \"${ZTS_HOST}:target\" \\\n+    alpine/socat \\\n+    \"tcp-listen:${ZTS_DEBUG_PORT},fork,reuseaddr\" \\\n+    \"tcp-connect:target:${ZTS_DEBUG_PORT}\"\n+```\n \n <a id=\"markdown-cleanup\" name=\"cleanup\"></a>\n ## Cleanup\n+\n ```bash\n-# remove deployment\n+# remove Athenz containers\n+make remove-containers\n+\n+# remove server data\n+make remove-files\n+\n+# remove bootstrap setup files\n+make reset-repo\n+```\n+```bash\n+# ENV reset", "originalCommit": "aad60957f2178f8e8bfee09481ae5fe7e0fc2b4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNDQxOA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418404418", "bodyText": "how about\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # ENV reset\n          \n          \n            \n            # reset docker and repo", "author": "WindzCUHK", "createdAt": "2020-05-01T03:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNzgwNg==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418407806", "bodyText": "I think it's good.", "author": "ssunorz", "createdAt": "2020-05-01T04:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMjg2MA=="}], "type": "inlineReview"}, {"oid": "750452c03f4e6f9a51e26663e7f807d3db91b92f", "url": "https://github.com/AthenZ/athenz/commit/750452c03f4e6f9a51e26663e7f807d3db91b92f", "message": "sync zts.prop", "committedDate": "2020-05-01T03:41:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwOTQ2NQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r418409465", "bodyText": "I think it would be better to add the following command.\nBASE_DIR=\"`git rev-parse --show-toplevel`\"", "author": "ssunorz", "createdAt": "2020-05-01T04:16:27Z", "path": "docker/docs/try-out-Athenz-with-self-signed-CA.md", "diffHunk": "@@ -0,0 +1,133 @@\n+<a id=\"markdown-try-out-athenz-with-self-signed-ca-for-dev-only\" name=\"try-out-athenz-with-self-signed-ca-for-dev-only\"></a>\n+# Try out Athenz with self-signed CA (for dev. ONLY)\n+\n+<!-- TOC -->\n+\n+- [Try out Athenz with self-signed CA (for dev. ONLY)](#try-out-athenz-with-self-signed-ca-for-dev-only)\n+    - [Prerequisites](#prerequisites)\n+    - [Prepare certificates](#prepare-certificates)\n+    - [Overwrite env., and continue the setup](#overwrite-env-and-continue-the-setup)\n+    - [Appendix](#appendix)\n+        - [Note for mac users (not recommended)](#note-for-mac-users-not-recommended)\n+\n+<!-- /TOC -->\n+\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+All the setup commands below are expected to run inside [athenz-setup-env](../setup-scripts/Dockerfile) container.\n+```bash", "originalCommit": "750452c03f4e6f9a51e26663e7f807d3db91b92f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4MzMxMA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421183310", "bodyText": "added in 392d4ea", "author": "WindzCUHK", "createdAt": "2020-05-07T01:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwOTQ2NQ=="}], "type": "inlineReview"}, {"oid": "f88fe61219f42614a2333a062d0dbb2e83a5c233", "url": "https://github.com/AthenZ/athenz/commit/f88fe61219f42614a2333a062d0dbb2e83a5c233", "message": "sync zms & zts prop", "committedDate": "2020-05-06T22:05:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDE2Nw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421164167", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ca: ${ATHENZ_CA_PATH}\n          \n          \n            \n              ca: ${DEV_ATHENZ_CA_PATH}", "author": "ssunorz", "createdAt": "2020-05-07T00:13:16Z", "path": "docker/sample/zts/create-self-signed-certs.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/bin/sh\n+\n+set -eu\n+set -o pipefail\n+\n+# to script directory\n+cd \"$(dirname \"$0\")\"\n+echo 'running...'\n+\n+### ----------------------------------------------------------------\n+# ZTS server certificate\n+# create CSR\n+CN='Sample Self Signed ZTS' SAN=\"${ZTS_HOST}\" openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -reqexts v3_req -extensions usr_cert \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZTS_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZTS_CSR_PATH}\" 2> /dev/null\n+# sign request\n+SAN=\"${ZTS_HOST}\" openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZTS_CSR_PATH}\" \\\n+  -CA \"${DEV_ATHENZ_CA_PATH}\" \\\n+  -CAkey \"${DEV_ATHENZ_CA_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions usr_cert \\\n+  -out \"${DEV_ZTS_CERT_PATH}\"\n+\n+### ----------------------------------------------------------------\n+# intermediate certificate for certificate signing\n+# create CSR\n+CN='Sample Self Signed Intermediate CA' openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZTS_SIGNER_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZTS_SIGNER_CSR_PATH}\" 2> /dev/null\n+# sign request using Athenz CA\n+openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZTS_SIGNER_CSR_PATH}\" \\\n+  -CA \"${DEV_SERVICE_CA_PATH}\" \\\n+  -CAkey \"${DEV_SERVICE_CA_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions v3_ca \\\n+  -out \"${DEV_ZTS_SIGNER_CERT_PATH}\"\n+\n+### ----------------------------------------------------------------\n+# ZTS client certificate\n+# create CSR (make sure the CN == 'sys.auth.zts')\n+CN='sys.auth.zts' openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZMS_CLIENT_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZMS_CLIENT_CSR_PATH}\" 2> /dev/null\n+# sign request using the intermediate CA of certificate signer\n+openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZMS_CLIENT_CSR_PATH}\" \\\n+  -CA \"${DEV_ZTS_SIGNER_CERT_PATH}\" \\\n+  -CAkey \"${DEV_ZTS_SIGNER_CERT_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions usr_cert \\\n+  -out \"${DEV_ZMS_CLIENT_CERT_PATH}\"\n+# create certificate bundle with client certificate and intermediate certificate\n+cat \"${DEV_ZMS_CLIENT_CERT_PATH}\" \"${DEV_ZTS_SIGNER_CERT_PATH}\" > \"${DEV_ZMS_CLIENT_CERT_BUNDLE_PATH}\"\n+\n+cat <<EOF\n+\n+self-signed ZTS server certificate created.\n+  ca: ${ATHENZ_CA_PATH}", "originalCommit": "346a39829e4c70c95f56d23dcaa5e155201900e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4MzgxMg==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421183812", "bodyText": "updated, thx", "author": "WindzCUHK", "createdAt": "2020-05-07T01:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDM0Nw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421164347", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ca: ${SERVICE_CA_PATH}\n          \n          \n            \n              ca: ${DEV_SERVICE_CA_PATH}", "author": "ssunorz", "createdAt": "2020-05-07T00:13:54Z", "path": "docker/sample/zts/create-self-signed-certs.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/bin/sh\n+\n+set -eu\n+set -o pipefail\n+\n+# to script directory\n+cd \"$(dirname \"$0\")\"\n+echo 'running...'\n+\n+### ----------------------------------------------------------------\n+# ZTS server certificate\n+# create CSR\n+CN='Sample Self Signed ZTS' SAN=\"${ZTS_HOST}\" openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -reqexts v3_req -extensions usr_cert \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZTS_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZTS_CSR_PATH}\" 2> /dev/null\n+# sign request\n+SAN=\"${ZTS_HOST}\" openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZTS_CSR_PATH}\" \\\n+  -CA \"${DEV_ATHENZ_CA_PATH}\" \\\n+  -CAkey \"${DEV_ATHENZ_CA_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions usr_cert \\\n+  -out \"${DEV_ZTS_CERT_PATH}\"\n+\n+### ----------------------------------------------------------------\n+# intermediate certificate for certificate signing\n+# create CSR\n+CN='Sample Self Signed Intermediate CA' openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZTS_SIGNER_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZTS_SIGNER_CSR_PATH}\" 2> /dev/null\n+# sign request using Athenz CA\n+openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZTS_SIGNER_CSR_PATH}\" \\\n+  -CA \"${DEV_SERVICE_CA_PATH}\" \\\n+  -CAkey \"${DEV_SERVICE_CA_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions v3_ca \\\n+  -out \"${DEV_ZTS_SIGNER_CERT_PATH}\"\n+\n+### ----------------------------------------------------------------\n+# ZTS client certificate\n+# create CSR (make sure the CN == 'sys.auth.zts')\n+CN='sys.auth.zts' openssl req -nodes \\\n+  -config \"${SELF_SIGN_CNF_PATH}\" \\\n+  -newkey rsa:4096 \\\n+  -keyout \"${DEV_ZMS_CLIENT_CERT_KEY_PATH}\" \\\n+  -out \"${DEV_ZMS_CLIENT_CSR_PATH}\" 2> /dev/null\n+# sign request using the intermediate CA of certificate signer\n+openssl x509 -req -days 3650 \\\n+  -in \"${DEV_ZMS_CLIENT_CSR_PATH}\" \\\n+  -CA \"${DEV_ZTS_SIGNER_CERT_PATH}\" \\\n+  -CAkey \"${DEV_ZTS_SIGNER_CERT_KEY_PATH}\" \\\n+  -CAcreateserial \\\n+  -extfile \"${SELF_SIGN_CNF_PATH}\" -extensions usr_cert \\\n+  -out \"${DEV_ZMS_CLIENT_CERT_PATH}\"\n+# create certificate bundle with client certificate and intermediate certificate\n+cat \"${DEV_ZMS_CLIENT_CERT_PATH}\" \"${DEV_ZTS_SIGNER_CERT_PATH}\" > \"${DEV_ZMS_CLIENT_CERT_BUNDLE_PATH}\"\n+\n+cat <<EOF\n+\n+self-signed ZTS server certificate created.\n+  ca: ${ATHENZ_CA_PATH}\n+  key: ${DEV_ZTS_CERT_KEY_PATH}\n+  cert: ${DEV_ZTS_CERT_PATH}\n+\n+self-signed Intermediate CA certificate created.\n+  ca: ${SERVICE_CA_PATH}", "originalCommit": "346a39829e4c70c95f56d23dcaa5e155201900e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4MzgzMQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421183831", "bodyText": "updated, thx", "author": "WindzCUHK", "createdAt": "2020-05-07T01:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI1NjA2Mg==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421256062", "bodyText": "I think it would be better to state that this file is a work in progress. Because there are multiple broken links.", "author": "ssunorz", "createdAt": "2020-05-07T05:56:06Z", "path": "docker/docs/configuration.dev.md", "diffHunk": "@@ -4,25 +4,19 @@\n ## Index", "originalCommit": "efa346a06f0b705c98a0f95412a6aad8b862780d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc4Nzc1MQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421787751", "bodyText": "deleted", "author": "WindzCUHK", "createdAt": "2020-05-07T20:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI1NjA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNDU2NA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421324564", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            docker run --rm -it \\\n          \n          \n            \n            BASE_DIR=\"`git rev-parse --show-toplevel`\"\n          \n          \n            \n            docker run --rm -it \\", "author": "ssunorz", "createdAt": "2020-05-07T08:20:03Z", "path": "docker/docs/zms-setup.md", "diffHunk": "@@ -0,0 +1,213 @@\n+<a id=\"markdown-setup-zms-in-production-env\" name=\"setup-zms-in-production-env\"></a>\n+# Setup ZMS in production env.\n+\n+<!-- TOC -->\n+\n+- [Setup ZMS in production env.](#setup-zms-in-production-env)\n+    - [Prerequisites](#prerequisites)\n+    - [Target](#target)\n+    - [Steps](#steps)\n+        - [1. update your passwords](#1-update-your-passwords)\n+        - [2. get a server certificate for ZMS](#2-get-a-server-certificate-for-zms)\n+        - [3. create ZMS key pairs for signing Athenz token](#3-create-zms-key-pairs-for-signing-athenz-token)\n+        - [4. create ZMS trust store for HTTPS connections](#4-create-zms-trust-store-for-https-connections)\n+        - [5. create ZMS key store with ZMS server certificate](#5-create-zms-key-store-with-zms-server-certificate)\n+        - [6. config the Athenz domain admin](#6-config-the-athenz-domain-admin)\n+        - [7. summary](#7-summary)\n+    - [Get Athenz domain admin user certificate for accessing ZMS](#get-athenz-domain-admin-user-certificate-for-accessing-zms)\n+    - [Deploy ZMS](#deploy-zms)\n+        - [Debug ZMS](#debug-zms)\n+\n+<!-- /TOC -->\n+\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. Env. setup done. ([env.sh](../env.sh))\n+1. Bootstrap setup done. ([Done step 1, 2, 3](./Athenz-bootstrap.md#bootstrap-steps))\n+1. All the setup commands below are expected to run inside [athenz-setup-env](../setup-scripts/Dockerfile) container.\n+```bash\n+docker run --rm -it \\", "originalCommit": "efa346a06f0b705c98a0f95412a6aad8b862780d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc4OTE2Nw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421789167", "bodyText": "updated", "author": "WindzCUHK", "createdAt": "2020-05-07T20:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNDU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNDgzNA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421324834", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            docker run --rm -it \\\n          \n          \n            \n            BASE_DIR=\"`git rev-parse --show-toplevel`\"\n          \n          \n            \n            docker run --rm -it \\", "author": "ssunorz", "createdAt": "2020-05-07T08:20:30Z", "path": "docker/docs/zts-setup.md", "diffHunk": "@@ -0,0 +1,352 @@\n+\n+<a id=\"markdown-setup-zts-in-production-env\" name=\"setup-zts-in-production-env\"></a>\n+# Setup ZTS in production env.\n+\n+<!-- TOC -->\n+\n+- [Setup ZTS in production env.](#setup-zts-in-production-env)\n+    - [Prerequisites](#prerequisites)\n+    - [Target](#target)\n+    - [Steps](#steps)\n+        - [1. update your passwords](#1-update-your-passwords)\n+        - [2. get a server certificate for ZTS](#2-get-a-server-certificate-for-zts)\n+        - [3. create ZTS key pairs for signing Athenz token](#3-create-zts-key-pairs-for-signing-athenz-token)\n+        - [4. create trust store containing all the trusted CAs](#4-create-trust-store-containing-all-the-trusted-cas)\n+        - [5. create key store containing the ZTS server certificate](#5-create-key-store-containing-the-zts-server-certificate)\n+        - [6. set up for certificate signing](#6-set-up-for-certificate-signing)\n+            - [HttpCertSigner](#httpcertsigner)\n+            - [KeyStoreCertSigner](#keystorecertsigner)\n+        - [7. set up for ZMS connection](#7-set-up-for-zms-connection)\n+            - [Note](#note)\n+        - [8. summary](#8-summary)\n+        - [9. register ZTS service to Athenz](#9-register-zts-service-to-athenz)\n+        - [10. create athenz.conf](#10-create-athenzconf)\n+    - [Deploy ZTS](#deploy-zts)\n+        - [Debug ZTS](#debug-zts)\n+    - [Appendix](#appendix)\n+        - [HttpCertSigner Details](#httpcertsigner-details)\n+\n+<!-- /TOC -->\n+\n+\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. Env. setup done. ([env.sh](../env.sh))\n+1. Bootstrap setup done. ([Done step 1, 2, 3, 4](./Athenz-bootstrap.md#bootstrap-steps))\n+1. ZMS is running. ([zms-setup](./zms-setup.md))\n+1. All the setup commands below are expected to run inside [athenz-setup-env](../setup-scripts/Dockerfile) container.\n+```bash\n+docker run --rm -it \\", "originalCommit": "efa346a06f0b705c98a0f95412a6aad8b862780d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc5MDQyMg==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421790422", "bodyText": "no change\n\nUser has to set DOCKER_NETWORK in the command.\nAs stated in the prerequisites, user should run the env.sh already and set both BASE_DIR and DOCKER_NETWORK before running the command.", "author": "WindzCUHK", "createdAt": "2020-05-07T20:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNDgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1OTE1Nw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421859157", "bodyText": "Please add the following.\nhttps://github.com/yahoo/athenz/blob/377b2963d3ecf118d2e77663175078bc6d98a4b5/servers/zms/conf/zms.properties#L419-L421", "author": "ssunorz", "createdAt": "2020-05-07T23:54:44Z", "path": "docker/zms/conf/zms.properties", "diffHunk": "@@ -9,7 +9,7 @@\n ", "originalCommit": "a10b9cfa60a2324ca8377be4c272f8aea960d0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg5NDc5Mw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421894793", "bodyText": "thx, fixed in 39efe30", "author": "WindzCUHK", "createdAt": "2020-05-08T02:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1OTE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2NzI5OA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421867298", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"${ZMS_CERT_KEY_PATH}\"\n          \n          \n            \n                echo \"${ZTS_SIGNER_CERT_KEY_PATH}\"", "author": "ssunorz", "createdAt": "2020-05-08T00:22:13Z", "path": "docker/docs/zts-setup.md", "diffHunk": "@@ -0,0 +1,352 @@\n+\n+<a id=\"markdown-setup-zts-in-production-env\" name=\"setup-zts-in-production-env\"></a>\n+# Setup ZTS in production env.\n+\n+<!-- TOC -->\n+\n+- [Setup ZTS in production env.](#setup-zts-in-production-env)\n+    - [Prerequisites](#prerequisites)\n+    - [Target](#target)\n+    - [Steps](#steps)\n+        - [1. update your passwords](#1-update-your-passwords)\n+        - [2. get a server certificate for ZTS](#2-get-a-server-certificate-for-zts)\n+        - [3. create ZTS key pairs for signing Athenz token](#3-create-zts-key-pairs-for-signing-athenz-token)\n+        - [4. create trust store containing all the trusted CAs](#4-create-trust-store-containing-all-the-trusted-cas)\n+        - [5. create key store containing the ZTS server certificate](#5-create-key-store-containing-the-zts-server-certificate)\n+        - [6. set up for certificate signing](#6-set-up-for-certificate-signing)\n+            - [HttpCertSigner](#httpcertsigner)\n+            - [KeyStoreCertSigner](#keystorecertsigner)\n+        - [7. set up for ZMS connection](#7-set-up-for-zms-connection)\n+            - [Note](#note)\n+        - [8. summary](#8-summary)\n+        - [9. register ZTS service to Athenz](#9-register-zts-service-to-athenz)\n+        - [10. create athenz.conf](#10-create-athenzconf)\n+    - [Deploy ZTS](#deploy-zts)\n+        - [Debug ZTS](#debug-zts)\n+    - [Appendix](#appendix)\n+        - [HttpCertSigner Details](#httpcertsigner-details)\n+\n+<!-- /TOC -->\n+\n+\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. Env. setup done. ([env.sh](../env.sh))\n+1. Bootstrap setup done. ([Done step 1, 2, 3, 4](./Athenz-bootstrap.md#bootstrap-steps))\n+1. ZMS is running. ([zms-setup](./zms-setup.md))\n+1. All the setup commands below are expected to run inside [athenz-setup-env](../setup-scripts/Dockerfile) container.\n+```bash\n+docker run --rm -it \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -v \"${BASE_DIR}:/athenz\" \\\n+    --user \"$(id -u):$(id -g)\" \\\n+    athenz-setup-env \\\n+    sh\n+\n+# load the ENV. inside the container\n+BASE_DIR=\"`git rev-parse --show-toplevel`\"\n+source \"${BASE_DIR}/docker/env.sh\"\n+```\n+\n+<a id=\"markdown-target\" name=\"target\"></a>\n+## Target\n+\n+![ZTS-setup](./images/ZTS-setup.png)\n+\n+<a id=\"markdown-steps\" name=\"steps\"></a>\n+## Steps\n+\n+<a id=\"markdown-1-update-your-passwords\" name=\"1-update-your-passwords\"></a>\n+### 1. update your passwords\n+\n+```bash\n+# ZTS passwords\n+export ZTS_DB_ROOT_PASS=<your_password>\n+export ZTS_DB_ADMIN_PASS=<your_password>\n+export ZTS_KEYSTORE_PASS=<your_password>\n+export ZTS_TRUSTSTORE_PASS=<your_password>\n+\n+# used by com.yahoo.athenz.zts.cert.impl.HttpCertSigner, com.yahoo.athenz.zts.cert.impl.crypki.HttpCertSigner\n+export ZTS_SIGNER_KEYSTORE_PASS=<your_password>\n+export ZTS_SIGNER_TRUSTSTORE_PASS=<your_password>\n+\n+# used by ZMS client in ZTS for ZMS connection\n+export ZMS_CLIENT_KEYSTORE_PASS=<your_password>\n+export ZMS_CLIENT_TRUSTSTORE_PASS=<your_password>\n+\n+# javax.net.ssl.trustStorePassword\n+# export ZTS_JAVAX_TRUSTSTORE_PASS=<your_password>\n+```\n+\n+<a id=\"markdown-2-get-a-server-certificate-for-zts\" name=\"2-get-a-server-certificate-for-zts\"></a>\n+### 2. get a server certificate for ZTS\n+\n+- Create your CSR and private key for ZTS\n+- Ask your **Athenz CA** to sign the CSR and get the server certificate for ZTS\n+```bash\n+# copy your file in the following paths\n+echo ${ZTS_CERT_KEY_PATH}\n+echo ${ZTS_CERT_PATH}\n+```\n+\n+<a id=\"markdown-3-create-zts-key-pairs-for-signing-athenz-token\" name=\"3-create-zts-key-pairs-for-signing-athenz-token\"></a>\n+### 3. create ZTS key pairs for signing Athenz token\n+```bash\n+openssl genrsa -out \"${ZTS_PRIVATE_KEY_PATH}\" 4096\n+openssl rsa -pubout -in \"${ZTS_PRIVATE_KEY_PATH}\" -out \"${ZTS_PUBLIC_KEY_PATH}\"\n+```\n+\n+<a id=\"markdown-4-create-trust-store-containing-all-the-trusted-cas\" name=\"4-create-trust-store-containing-all-the-trusted-cas\"></a>\n+### 4. create trust store containing all the trusted CAs\n+\n+- Verify CA file paths\n+```bash\n+ls -l \"${ATHENZ_CA_PATH}\"\n+ls -l \"${USER_CA_PATH}\"\n+ls -l \"${SERVICE_CA_PATH}\"\n+```\n+- Create the ZTS trust store\n+```bash\n+rm -f \"${ZTS_TRUSTSTORE_PATH}\"\n+\n+CERT_ALIAS='athenz_ca'\n+openssl x509 -outform pem -in \"${ATHENZ_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+CERT_ALIAS='user_ca'\n+openssl x509 -outform pem -in \"${USER_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+CERT_ALIAS='service_ca'\n+openssl x509 -outform pem -in \"${SERVICE_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+# keytool -list -storepass \"${ZTS_TRUSTSTORE_PASS}\" -keystore \"${ZTS_TRUSTSTORE_PATH}\"\n+```\n+\n+<a id=\"markdown-5-create-key-store-containing-the-zts-server-certificate\" name=\"5-create-key-store-containing-the-zts-server-certificate\"></a>\n+### 5. create key store containing the ZTS server certificate\n+\n+```bash\n+openssl pkcs12 -export -noiter -nomaciter \\\n+    -out \"${ZTS_KEYSTORE_PATH}\" -passout \"pass:${ZTS_KEYSTORE_PASS}\" \\\n+    -in \"${ZTS_CERT_PATH}\" -inkey \"${ZTS_CERT_KEY_PATH}\"\n+\n+# keytool -list -storepass \"${ZTS_KEYSTORE_PASS}\" -keystore \"${ZTS_KEYSTORE_PATH}\"\n+```\n+\n+<a id=\"markdown-6-set-up-for-certificate-signing\" name=\"6-set-up-for-certificate-signing\"></a>\n+### 6. set up for certificate signing\n+\n+<a id=\"markdown-httpcertsigner\" name=\"httpcertsigner\"></a>\n+#### HttpCertSigner\n+For production environment, we suggest to use the [HttpCertSigner.java](https://github.com/yahoo/athenz/blob/master/servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/HttpCertSigner.java), so that you do not need to manage the signer CA's private key in Athenz server. For details, please refer to [HttpCertSigner Details](./zts-setup.md#httpcertsigner-details).\n+\n+<a id=\"markdown-keystorecertsigner\" name=\"keystorecertsigner\"></a>\n+#### KeyStoreCertSigner\n+However, to simplify the setup, we will create an intermediate CA signed by the **Service CA** (1), and then use that intermediate CA to sign the service certificates issued by Athenz (2).\n+\n+1. Create an intermediate CA certificate\n+    - Create your CSR and private key for the intermediate CA\n+    - Ask your **Service CA** to sign the CSR and get the intermediate CA certificate\n+    ```bash\n+    # copy your file in the following paths\n+    echo \"${ZMS_CERT_KEY_PATH}\"", "originalCommit": "a10b9cfa60a2324ca8377be4c272f8aea960d0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg5NDgyMA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421894820", "bodyText": "thx, fixed in 39efe30", "author": "WindzCUHK", "createdAt": "2020-05-08T02:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2NzI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2NzQxMw==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421867413", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"${ZMS_CERT_PATH}\"\n          \n          \n            \n                echo \"${ZTS_SIGNER_CERT_PATH}\"", "author": "ssunorz", "createdAt": "2020-05-08T00:22:39Z", "path": "docker/docs/zts-setup.md", "diffHunk": "@@ -0,0 +1,352 @@\n+\n+<a id=\"markdown-setup-zts-in-production-env\" name=\"setup-zts-in-production-env\"></a>\n+# Setup ZTS in production env.\n+\n+<!-- TOC -->\n+\n+- [Setup ZTS in production env.](#setup-zts-in-production-env)\n+    - [Prerequisites](#prerequisites)\n+    - [Target](#target)\n+    - [Steps](#steps)\n+        - [1. update your passwords](#1-update-your-passwords)\n+        - [2. get a server certificate for ZTS](#2-get-a-server-certificate-for-zts)\n+        - [3. create ZTS key pairs for signing Athenz token](#3-create-zts-key-pairs-for-signing-athenz-token)\n+        - [4. create trust store containing all the trusted CAs](#4-create-trust-store-containing-all-the-trusted-cas)\n+        - [5. create key store containing the ZTS server certificate](#5-create-key-store-containing-the-zts-server-certificate)\n+        - [6. set up for certificate signing](#6-set-up-for-certificate-signing)\n+            - [HttpCertSigner](#httpcertsigner)\n+            - [KeyStoreCertSigner](#keystorecertsigner)\n+        - [7. set up for ZMS connection](#7-set-up-for-zms-connection)\n+            - [Note](#note)\n+        - [8. summary](#8-summary)\n+        - [9. register ZTS service to Athenz](#9-register-zts-service-to-athenz)\n+        - [10. create athenz.conf](#10-create-athenzconf)\n+    - [Deploy ZTS](#deploy-zts)\n+        - [Debug ZTS](#debug-zts)\n+    - [Appendix](#appendix)\n+        - [HttpCertSigner Details](#httpcertsigner-details)\n+\n+<!-- /TOC -->\n+\n+\n+<a id=\"markdown-prerequisites\" name=\"prerequisites\"></a>\n+## Prerequisites\n+\n+1. Env. setup done. ([env.sh](../env.sh))\n+1. Bootstrap setup done. ([Done step 1, 2, 3, 4](./Athenz-bootstrap.md#bootstrap-steps))\n+1. ZMS is running. ([zms-setup](./zms-setup.md))\n+1. All the setup commands below are expected to run inside [athenz-setup-env](../setup-scripts/Dockerfile) container.\n+```bash\n+docker run --rm -it \\\n+    --network=\"${DOCKER_NETWORK}\" \\\n+    -v \"${BASE_DIR}:/athenz\" \\\n+    --user \"$(id -u):$(id -g)\" \\\n+    athenz-setup-env \\\n+    sh\n+\n+# load the ENV. inside the container\n+BASE_DIR=\"`git rev-parse --show-toplevel`\"\n+source \"${BASE_DIR}/docker/env.sh\"\n+```\n+\n+<a id=\"markdown-target\" name=\"target\"></a>\n+## Target\n+\n+![ZTS-setup](./images/ZTS-setup.png)\n+\n+<a id=\"markdown-steps\" name=\"steps\"></a>\n+## Steps\n+\n+<a id=\"markdown-1-update-your-passwords\" name=\"1-update-your-passwords\"></a>\n+### 1. update your passwords\n+\n+```bash\n+# ZTS passwords\n+export ZTS_DB_ROOT_PASS=<your_password>\n+export ZTS_DB_ADMIN_PASS=<your_password>\n+export ZTS_KEYSTORE_PASS=<your_password>\n+export ZTS_TRUSTSTORE_PASS=<your_password>\n+\n+# used by com.yahoo.athenz.zts.cert.impl.HttpCertSigner, com.yahoo.athenz.zts.cert.impl.crypki.HttpCertSigner\n+export ZTS_SIGNER_KEYSTORE_PASS=<your_password>\n+export ZTS_SIGNER_TRUSTSTORE_PASS=<your_password>\n+\n+# used by ZMS client in ZTS for ZMS connection\n+export ZMS_CLIENT_KEYSTORE_PASS=<your_password>\n+export ZMS_CLIENT_TRUSTSTORE_PASS=<your_password>\n+\n+# javax.net.ssl.trustStorePassword\n+# export ZTS_JAVAX_TRUSTSTORE_PASS=<your_password>\n+```\n+\n+<a id=\"markdown-2-get-a-server-certificate-for-zts\" name=\"2-get-a-server-certificate-for-zts\"></a>\n+### 2. get a server certificate for ZTS\n+\n+- Create your CSR and private key for ZTS\n+- Ask your **Athenz CA** to sign the CSR and get the server certificate for ZTS\n+```bash\n+# copy your file in the following paths\n+echo ${ZTS_CERT_KEY_PATH}\n+echo ${ZTS_CERT_PATH}\n+```\n+\n+<a id=\"markdown-3-create-zts-key-pairs-for-signing-athenz-token\" name=\"3-create-zts-key-pairs-for-signing-athenz-token\"></a>\n+### 3. create ZTS key pairs for signing Athenz token\n+```bash\n+openssl genrsa -out \"${ZTS_PRIVATE_KEY_PATH}\" 4096\n+openssl rsa -pubout -in \"${ZTS_PRIVATE_KEY_PATH}\" -out \"${ZTS_PUBLIC_KEY_PATH}\"\n+```\n+\n+<a id=\"markdown-4-create-trust-store-containing-all-the-trusted-cas\" name=\"4-create-trust-store-containing-all-the-trusted-cas\"></a>\n+### 4. create trust store containing all the trusted CAs\n+\n+- Verify CA file paths\n+```bash\n+ls -l \"${ATHENZ_CA_PATH}\"\n+ls -l \"${USER_CA_PATH}\"\n+ls -l \"${SERVICE_CA_PATH}\"\n+```\n+- Create the ZTS trust store\n+```bash\n+rm -f \"${ZTS_TRUSTSTORE_PATH}\"\n+\n+CERT_ALIAS='athenz_ca'\n+openssl x509 -outform pem -in \"${ATHENZ_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+CERT_ALIAS='user_ca'\n+openssl x509 -outform pem -in \"${USER_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+CERT_ALIAS='service_ca'\n+openssl x509 -outform pem -in \"${SERVICE_CA_PATH}\" | keytool -importcert -noprompt \\\n+    -keystore \"${ZTS_TRUSTSTORE_PATH}\" -storepass \"${ZTS_TRUSTSTORE_PASS}\" \\\n+    -storetype JKS -alias \"${CERT_ALIAS}\"\n+\n+# keytool -list -storepass \"${ZTS_TRUSTSTORE_PASS}\" -keystore \"${ZTS_TRUSTSTORE_PATH}\"\n+```\n+\n+<a id=\"markdown-5-create-key-store-containing-the-zts-server-certificate\" name=\"5-create-key-store-containing-the-zts-server-certificate\"></a>\n+### 5. create key store containing the ZTS server certificate\n+\n+```bash\n+openssl pkcs12 -export -noiter -nomaciter \\\n+    -out \"${ZTS_KEYSTORE_PATH}\" -passout \"pass:${ZTS_KEYSTORE_PASS}\" \\\n+    -in \"${ZTS_CERT_PATH}\" -inkey \"${ZTS_CERT_KEY_PATH}\"\n+\n+# keytool -list -storepass \"${ZTS_KEYSTORE_PASS}\" -keystore \"${ZTS_KEYSTORE_PATH}\"\n+```\n+\n+<a id=\"markdown-6-set-up-for-certificate-signing\" name=\"6-set-up-for-certificate-signing\"></a>\n+### 6. set up for certificate signing\n+\n+<a id=\"markdown-httpcertsigner\" name=\"httpcertsigner\"></a>\n+#### HttpCertSigner\n+For production environment, we suggest to use the [HttpCertSigner.java](https://github.com/yahoo/athenz/blob/master/servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/HttpCertSigner.java), so that you do not need to manage the signer CA's private key in Athenz server. For details, please refer to [HttpCertSigner Details](./zts-setup.md#httpcertsigner-details).\n+\n+<a id=\"markdown-keystorecertsigner\" name=\"keystorecertsigner\"></a>\n+#### KeyStoreCertSigner\n+However, to simplify the setup, we will create an intermediate CA signed by the **Service CA** (1), and then use that intermediate CA to sign the service certificates issued by Athenz (2).\n+\n+1. Create an intermediate CA certificate\n+    - Create your CSR and private key for the intermediate CA\n+    - Ask your **Service CA** to sign the CSR and get the intermediate CA certificate\n+    ```bash\n+    # copy your file in the following paths\n+    echo \"${ZMS_CERT_KEY_PATH}\"\n+    echo \"${ZMS_CERT_PATH}\"", "originalCommit": "a10b9cfa60a2324ca8377be4c272f8aea960d0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg5NDg0MA==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r421894840", "bodyText": "thx, fixed in 39efe30", "author": "WindzCUHK", "createdAt": "2020-05-08T02:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2NzQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg1OTQ1Mg==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r422859452", "bodyText": "I understand why it fails on ubuntu.\nhttps://stackoverflow.com/questions/13702425/source-command-not-found-in-sh-shell\nFor the time being, I think it's okay to exclude ubuntu from support, but what do you think?", "author": "ssunorz", "createdAt": "2020-05-11T08:09:01Z", "path": "docker/deploy-scripts/zms-deploy.sh", "diffHunk": "@@ -0,0 +1,118 @@\n+#!/bin/sh\n+\n+set -eu\n+set -o pipefail\n+\n+# to script directory\n+cd \"$(dirname \"$0\")\"\n+\n+# import functions\n+source ../setup-scripts/common/color-print.sh", "originalCommit": "39efe305c88a541059e4398383df86b99f9fbbad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA0OTE0NQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r423049145", "bodyText": "sure, can you help to fix the script?", "author": "WindzCUHK", "createdAt": "2020-05-11T13:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg1OTQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzNDY3MQ==", "url": "https://github.com/AthenZ/athenz/pull/944#discussion_r424934671", "bodyText": "since it is difficult to be compatible with dash in Ubuntu, added note in a8740c7.", "author": "WindzCUHK", "createdAt": "2020-05-14T07:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg1OTQ1Mg=="}], "type": "inlineReview"}, {"oid": "9a8288c879af7bc296ed569a7a377a18fb4b8d4e", "url": "https://github.com/AthenZ/athenz/commit/9a8288c879af7bc296ed569a7a377a18fb4b8d4e", "message": "use ZTS can use signing key in keystore", "committedDate": "2020-05-15T04:55:33Z", "type": "commit"}, {"oid": "96689e366a92eca4c882407bafb85e5abace9136", "url": "https://github.com/AthenZ/athenz/commit/96689e366a92eca4c882407bafb85e5abace9136", "message": "docker rework", "committedDate": "2020-05-15T04:55:36Z", "type": "commit"}, {"oid": "e8f66cbf18dc73fef0749ce42161dc9c8f012014", "url": "https://github.com/AthenZ/athenz/commit/e8f66cbf18dc73fef0749ce42161dc9c8f012014", "message": "sync zms & zts prop", "committedDate": "2020-05-15T04:55:36Z", "type": "commit"}, {"oid": "f593fde6f8ff770ca9d37307427c7df9b9edcfd3", "url": "https://github.com/AthenZ/athenz/commit/f593fde6f8ff770ca9d37307427c7df9b9edcfd3", "message": "update auth core version", "committedDate": "2020-05-15T04:55:36Z", "type": "commit"}, {"oid": "a195d5b7e320963de887813f5953a466d2522d48", "url": "https://github.com/AthenZ/athenz/commit/a195d5b7e320963de887813f5953a466d2522d48", "message": "update tag", "committedDate": "2020-05-15T04:56:20Z", "type": "commit"}, {"oid": "eda4149b33b50753e3d36ce256028cf4f6c0163f", "url": "https://github.com/AthenZ/athenz/commit/eda4149b33b50753e3d36ce256028cf4f6c0163f", "message": "fix doc", "committedDate": "2020-05-15T04:56:20Z", "type": "commit"}, {"oid": "2f1b38269b308c831c751fb58ea1c3ca94c35307", "url": "https://github.com/AthenZ/athenz/commit/2f1b38269b308c831c751fb58ea1c3ca94c35307", "message": "update doc", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "bb19c02b443a61e72ee1e5fe519aeaf9aaa0109f", "url": "https://github.com/AthenZ/athenz/commit/bb19c02b443a61e72ee1e5fe519aeaf9aaa0109f", "message": "Update docker/README.md", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "ae9cdacf40416802f12067b2a792c545d7920eef", "url": "https://github.com/AthenZ/athenz/commit/ae9cdacf40416802f12067b2a792c545d7920eef", "message": "Update docker/sample/zts/create-self-signed-certs.sh\n\nCo-authored-by: ssunorz <42366422+ssunorz@users.noreply.github.com>", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "94c9c05ebff99d6e266e7843cf756714070a3a35", "url": "https://github.com/AthenZ/athenz/commit/94c9c05ebff99d6e266e7843cf756714070a3a35", "message": "Update docker/sample/zts/create-self-signed-certs.sh\n\nCo-authored-by: ssunorz <42366422+ssunorz@users.noreply.github.com>", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "996c8395ff9bc4104680170e69eb894fadf46181", "url": "https://github.com/AthenZ/athenz/commit/996c8395ff9bc4104680170e69eb894fadf46181", "message": "fix doc", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "1cca396584540cf98efb2381a98e57dbc82c7af2", "url": "https://github.com/AthenZ/athenz/commit/1cca396584540cf98efb2381a98e57dbc82c7af2", "message": "add zms RO DB support", "committedDate": "2020-05-15T04:56:21Z", "type": "commit"}, {"oid": "6d72c52e77a44a62c3fc06e6689f96eada01df06", "url": "https://github.com/AthenZ/athenz/commit/6d72c52e77a44a62c3fc06e6689f96eada01df06", "message": "remove default value, as the connection will wait until timeout", "committedDate": "2020-05-15T04:56:50Z", "type": "commit"}, {"oid": "4751e40e41d420a849096de66348a83de3d0205e", "url": "https://github.com/AthenZ/athenz/commit/4751e40e41d420a849096de66348a83de3d0205e", "message": "Update docker/docs/zms-setup.md\n\nCo-authored-by: ssunorz <42366422+ssunorz@users.noreply.github.com>", "committedDate": "2020-05-15T04:56:50Z", "type": "commit"}, {"oid": "246fa816bf9aba87990199d09a5a49a68fcb6e74", "url": "https://github.com/AthenZ/athenz/commit/246fa816bf9aba87990199d09a5a49a68fcb6e74", "message": "Update docker/docs/zts-setup.md\n\nCo-authored-by: ssunorz <42366422+ssunorz@users.noreply.github.com>", "committedDate": "2020-05-15T04:56:50Z", "type": "commit"}, {"oid": "4f630090cae99d30385086c8220c0e53745629a5", "url": "https://github.com/AthenZ/athenz/commit/4f630090cae99d30385086c8220c0e53745629a5", "message": "Revert \"Update docker/docs/zts-setup.md\"\n\nThis reverts commit 76f9ad23616d27899abba67ff513efbf9d7f065f.", "committedDate": "2020-05-15T04:56:50Z", "type": "commit"}, {"oid": "e3de0f3f9a24eaa13cb17d4015475235fd51ff32", "url": "https://github.com/AthenZ/athenz/commit/e3de0f3f9a24eaa13cb17d4015475235fd51ff32", "message": "update doc & prop", "committedDate": "2020-05-15T04:56:50Z", "type": "commit"}, {"oid": "0f653879c5ed3cd5549b6c5c95d5d9e8b0802a34", "url": "https://github.com/AthenZ/athenz/commit/0f653879c5ed3cd5549b6c5c95d5d9e8b0802a34", "message": "resolve conflict", "committedDate": "2020-05-15T04:57:11Z", "type": "commit"}, {"oid": "1e8d6c611826499a68eee42cb03c0c4dac3a1b55", "url": "https://github.com/AthenZ/athenz/commit/1e8d6c611826499a68eee42cb03c0c4dac3a1b55", "message": "resolve conflict 2", "committedDate": "2020-05-15T04:57:36Z", "type": "commit"}, {"oid": "c2d1f6a22545c3773db437c8758246ae78a605d9", "url": "https://github.com/AthenZ/athenz/commit/c2d1f6a22545c3773db437c8758246ae78a605d9", "message": "fix doc", "committedDate": "2020-05-15T04:57:36Z", "type": "commit"}, {"oid": "2f942963611483478a3ed1ba8972a1e9edc3fd1e", "url": "https://github.com/AthenZ/athenz/commit/2f942963611483478a3ed1ba8972a1e9edc3fd1e", "message": "fix sh", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "d6d02fcdea91981401d5ef34ed74e166e057564b", "url": "https://github.com/AthenZ/athenz/commit/d6d02fcdea91981401d5ef34ed74e166e057564b", "message": "add sh", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "ebac8061b3c6288f86d307858c863786f69b8b4a", "url": "https://github.com/AthenZ/athenz/commit/ebac8061b3c6288f86d307858c863786f69b8b4a", "message": "update test sh", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "63d98b52f8bbf528b61bacd77f95c4d7d4d1eee1", "url": "https://github.com/AthenZ/athenz/commit/63d98b52f8bbf528b61bacd77f95c4d7d4d1eee1", "message": "remove unused files", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "155b2ca486c3164e440cb7f0e2d437be1fefee29", "url": "https://github.com/AthenZ/athenz/commit/155b2ca486c3164e440cb7f0e2d437be1fefee29", "message": "fix cast", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "44ff19bdb7f855a7559f96e865db61c9de9b7122", "url": "https://github.com/AthenZ/athenz/commit/44ff19bdb7f855a7559f96e865db61c9de9b7122", "message": "add cast", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "a584146f8bc58cbcdb788ef3c0a63de7bff5e6e6", "url": "https://github.com/AthenZ/athenz/commit/a584146f8bc58cbcdb788ef3c0a63de7bff5e6e6", "message": "fix cast doc", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "513cb9179dc96af72518664bd8979c6622d06192", "url": "https://github.com/AthenZ/athenz/commit/513cb9179dc96af72518664bd8979c6622d06192", "message": "fix wordings", "committedDate": "2020-05-15T04:57:37Z", "type": "commit"}, {"oid": "0371dd4b23c0a729d51e6a4ca95f42ddfcf77290", "url": "https://github.com/AthenZ/athenz/commit/0371dd4b23c0a729d51e6a4ca95f42ddfcf77290", "message": "fix README version", "committedDate": "2020-05-15T04:58:51Z", "type": "commit"}, {"oid": "0371dd4b23c0a729d51e6a4ca95f42ddfcf77290", "url": "https://github.com/AthenZ/athenz/commit/0371dd4b23c0a729d51e6a4ca95f42ddfcf77290", "message": "fix README version", "committedDate": "2020-05-15T04:58:51Z", "type": "forcePushed"}]}