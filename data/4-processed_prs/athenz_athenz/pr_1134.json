{"pr_number": 1134, "pr_title": "Implemented notification to metrics converters", "pr_createdAt": "2020-10-06T13:40:46Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1134", "timeline": [{"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "url": "https://github.com/AthenZ/athenz/commit/a22a52cca1266238d404ce149d520d22e4ca8bdf", "message": "Implemented notification to metrics converters", "committedDate": "2020-10-06T19:33:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU0ODc4Mw==", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500548783", "bodyText": "NotificationToMetricConverter purpose is similar to NotificationToEmailConverter (instead of mail convert to metrics)", "author": "OferLevi85", "createdAt": "2020-10-06T19:37:16Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -26,12 +26,12 @@\n     // key value pair describing additional details about notification\n     private Map<String, String> details;\n \n-    // Type of notification\n-    private String type;\n-\n     // Utility class to convert the notification into an email\n     private NotificationToEmailConverter notificationToEmailConverter;\n \n+    // Utility class to convert the notification into metric attributes\n+    private NotificationToMetricConverter notificationToMetricConverter;", "originalCommit": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MDMxMg==", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500550312", "bodyText": "NotificationMetric holds attributes in the data structure List<String[]> (a list of flat array metric records).\nSo I had to implement custom equals and hashCode (for tests to check equality correctly and to enable holding this structure in a hashmap if we would like to do so in the future).", "author": "OferLevi85", "createdAt": "2020-10-06T19:40:11Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationMetric.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class NotificationMetric {\n+\n+    // Metric attributes as a list of flat arrays\n+    private List<String[]> attributes;\n+\n+    public NotificationMetric(List<String[]> attributes) {\n+        this.attributes = attributes;\n+    }\n+\n+    public List<String[]> getAttributes() {\n+        return attributes;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        NotificationMetric that = (NotificationMetric) o;\n+\n+        if (attributes.size() != ((NotificationMetric) o).attributes.size()) {\n+            return false;", "originalCommit": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MjU3MQ==", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500552571", "bodyText": "There are two notification tasks that don't contain details at all (PendingGroupMembershipApprovalNotificationToMetricConverter and PendingRoleMembershipApprovalNotificationToMetricConverter).\nCurrently, I only record that notification of that type happened. Let me know if I should record the recipients.", "author": "OferLevi85", "createdAt": "2020-10-06T19:44:30Z", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/notification/PendingGroupMembershipApprovalNotificationTask.java", "diffHunk": "@@ -88,4 +91,20 @@ public NotificationEmail getNotificationAsEmail(Notification notification) {\n             return new NotificationEmail(subject, body, fullyQualifiedEmailAddresses);\n         }\n     }\n+\n+    public static class PendingGroupMembershipApprovalNotificationToMetricConverter implements NotificationToMetricConverter {\n+        private final static String NOTIFICATION_TYPE = \"pending_group_membership_approval\";\n+\n+        @Override\n+        public NotificationMetric getNotificationAsMetrics(Notification notification) {\n+            String[] record = new String[] {\n+                    METRIC_NOTIFICATION_TYPE_KEY, NOTIFICATION_TYPE\n+            };\n+\n+            List<String[]> attributes = new ArrayList<>();\n+            attributes.add(record);\n+            // This notification doesn't contain any details. We should consider adding the recipients in their own tags.", "originalCommit": "a22a52cca1266238d404ce149d520d22e4ca8bdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9eadcde6bd7a30087da1c5298ff55d54e320104c", "url": "https://github.com/AthenZ/athenz/commit/9eadcde6bd7a30087da1c5298ff55d54e320104c", "message": "Implemented notification to metrics converters", "committedDate": "2020-10-06T20:47:50Z", "type": "forcePushed"}, {"oid": "b72474c81183505cb4034759593970e387d4886c", "url": "https://github.com/AthenZ/athenz/commit/b72474c81183505cb4034759593970e387d4886c", "message": "Implemented notification to metrics converters", "committedDate": "2020-10-06T21:42:29Z", "type": "forcePushed"}, {"oid": "763ef6e7519d4a15333f4def5c077ef07edfcf88", "url": "https://github.com/AthenZ/athenz/commit/763ef6e7519d4a15333f4def5c077ef07edfcf88", "message": "Implement notification to metrics converters", "committedDate": "2020-10-06T22:17:24Z", "type": "forcePushed"}, {"oid": "7b4ac90f8be636843f6678895b782b75d7dc6b8f", "url": "https://github.com/AthenZ/athenz/commit/7b4ac90f8be636843f6678895b782b75d7dc6b8f", "message": "Implement notification to metrics converters", "committedDate": "2020-10-06T22:45:05Z", "type": "forcePushed"}, {"oid": "3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "url": "https://github.com/AthenZ/athenz/commit/3cdb9a56581a50dfb9dad11242b9fc4defa0c6e1", "message": "Implement notification to metrics converters", "committedDate": "2020-10-07T07:41:29Z", "type": "forcePushed"}, {"oid": "384a299bbd48e00968d93575f33f5a544babccd5", "url": "https://github.com/AthenZ/athenz/commit/384a299bbd48e00968d93575f33f5a544babccd5", "message": "Implement notification to metrics converters", "committedDate": "2020-10-07T08:40:23Z", "type": "forcePushed"}, {"oid": "785bbff855c1d5136318b459c1c04c8d287952b4", "url": "https://github.com/AthenZ/athenz/commit/785bbff855c1d5136318b459c1c04c8d287952b4", "message": "Implement notification to metrics converters", "committedDate": "2020-10-07T09:07:03Z", "type": "forcePushed"}, {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "url": "https://github.com/AthenZ/athenz/commit/2da05a38e91075fd3fdcba1d2631b27d505323f6", "message": "Implement notification to metrics converters", "committedDate": "2020-10-07T10:29:26Z", "type": "commit"}, {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "url": "https://github.com/AthenZ/athenz/commit/2da05a38e91075fd3fdcba1d2631b27d505323f6", "message": "Implement notification to metrics converters", "committedDate": "2020-10-07T10:29:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkwNzkxMg==", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500907912", "bodyText": "I get the currentTime as an interface argument so equality checks will be successful in tests (calculating the currentTime inside each notification makes a difference for attributes such as \"expiry_days\" which can sometimes result in test failures)", "author": "OferLevi85", "createdAt": "2020-10-07T10:33:31Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -93,6 +86,18 @@ public NotificationEmail getNotificationAsEmail() {\n         return null;\n     }\n \n+    public Notification setNotificationToMetricConverter(NotificationToMetricConverter notificationToMetricConverter) {\n+        this.notificationToMetricConverter = notificationToMetricConverter;\n+        return this;\n+    }\n+\n+    public NotificationMetric getNotificationAsMetrics(Timestamp currentTime) {", "originalCommit": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2NzE3Ng==", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r501467176", "bodyText": "I also took advantage of the changes to change the Timestamps used in this notification from \"java.sql.Timestamp\" to \"com.yahoo.rdl.Timestamp\".", "author": "OferLevi85", "createdAt": "2020-10-08T06:03:06Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "diffHunk": "@@ -25,17 +25,18 @@\n import com.yahoo.athenz.zts.ZTSConsts;\n import com.yahoo.athenz.zts.cert.InstanceCertManager;\n import com.yahoo.athenz.zts.store.DataStore;\n+import com.yahoo.rdl.Timestamp;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import java.sql.Timestamp;", "originalCommit": "2da05a38e91075fd3fdcba1d2631b27d505323f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}