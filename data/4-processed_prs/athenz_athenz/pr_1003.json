{"pr_number": 1003, "pr_title": "Enabled Email Notifications for ZTS with DynamoDB", "pr_createdAt": "2020-06-09T16:38:59Z", "pr_url": "https://github.com/AthenZ/athenz/pull/1003", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3MDI2Ng==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r437570266", "bodyText": "Note that I've changed this check to only verify hostname If hostnameResolver is used.", "author": "OferLevi85", "createdAt": "2020-06-09T16:40:15Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "diffHunk": "@@ -132,7 +132,7 @@ public CertFailedRefreshNotificationTask(InstanceCertManager instanceCertManager\n \n     private List<X509CertRecord> getRecordsWithValidHosts(List<X509CertRecord> unrefreshedCerts) {\n         return unrefreshedCerts.stream()\n-                    .filter(record -> hostnameResolver.isValidHostname(record.getHostName()))\n+                    .filter(record -> hostnameResolver == null || hostnameResolver.isValidHostname(record.getHostName()))", "originalCommit": "4158ef4bad47fcc08683f66358c5e8a894e07025", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3MTAzMw==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r437571033", "bodyText": "Note that we need to create a new index in prod and any other environment before pushing these changes", "author": "OferLevi85", "createdAt": "2020-06-09T16:41:38Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -54,17 +59,25 @@\n     private static final String KEY_EXPIRY_TIME = \"expiryTime\";\n     private static final String KEY_HOSTNAME = \"hostName\";\n     private static final String KEY_TTL = \"ttl\";\n+    public static final String INDEX_CURRENT_DATE = \"currentDate-index\";", "originalCommit": "4158ef4bad47fcc08683f66358c5e8a894e07025", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1Mzg5Mg==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r439253892", "bodyText": "In the conf/zts.properties for the athenz.zts.cert_dynamodb_table_name setting I have small section what type of table we need to create. can you also update that section to include the requirement for this index as well.", "author": "havetisyan", "createdAt": "2020-06-12T07:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3MTAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3Mjc2Mg==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r437572762", "bodyText": "Regarding the scan, please note the following:\n\nCouldn't avoid the scan when getting the updated records as I must use consistent reading. Indexes only support eventual consistency so there's a good chance we'll miss records if we use it.\nWe will need to enable Scan in DynamoDB for the IAM role in prod and any other environments in order for scanning to work.", "author": "OferLevi85", "createdAt": "2020-06-09T16:44:35Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -213,17 +231,92 @@ public int deleteExpiredX509CertRecords(int expiryTimeMins) {\n     public boolean updateUnrefreshedCertificatesNotificationTimestamp(String lastNotifiedServer,\n                                                                       long lastNotifiedTime,\n                                                                       String provider) {\n-        // Currently unimplemented for AWS\n-        return false;\n+        try {\n+            List<Item> items = getUnrefreshedCertsRecords(lastNotifiedTime, provider);\n+            updateLastNotified(lastNotifiedServer, lastNotifiedTime, items);\n+        } catch (Exception ex) {\n+            LOGGER.error(\"DynamoDB updateUnrefreshedCertificatesNotificationTimestamp Error: {}/{}\", ex.getClass(), ex.getMessage());\n+            return false;\n+        }\n+\n+        return true;\n     }\n \n     @Override\n     public List<X509CertRecord> getNotifyUnrefreshedCertificates(String lastNotifiedServer, long lastNotifiedTime) {\n-        // Currently unimplemented for AWS\n-        return new ArrayList<>();\n+\n+        Map<String, AttributeValue> expressionAttributeValues = new HashMap<>();\n+        expressionAttributeValues.put(\":lastNotifiedServerVal\", new AttributeValue().withS(lastNotifiedServer));\n+        expressionAttributeValues.put(\":lastNotifiedTimeVal\", new AttributeValue().withN(Long.toString(lastNotifiedTime)));\n+\n+        // Get all records that that should receive notifications.\n+        ScanRequest scanRequest = new ScanRequest()", "originalCommit": "4158ef4bad47fcc08683f66358c5e8a894e07025", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4MjY2Ng==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r438382666", "bodyText": "We don't really care about consistency reading in this use case. Remember we're not making changes and then expecting to read within a second or two to process notifications. Notifications are processed for records that have been created at least 3 days ago so there isn't much chance of missing records. We should use query instead of scan for all of our use cases.", "author": "havetisyan", "createdAt": "2020-06-10T20:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3OTI3Nw==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r438579277", "bodyText": "We actually make an update just moments before when writing the lastNotifiedTime and server.\nIn InstanceCertManager.getUnrefreshedCertsNotifications we call 2 functions right after the other:\n\nupdateUnrefreshedCertificatesNotificationTimestamp - we quey the index and update the records with the lastNotifiedTime and server\nMake the call to this function, getNotifyUnrefreshedCertificates to get all the records that were just updated by us.\nIf we update the records and don't read them with consistency then we'll miss some of these records and skip their notifications.", "author": "OferLevi85", "createdAt": "2020-06-11T06:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY5MDMwNw==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r438690307", "bodyText": "Edit: There is actually no good reason for InstanceCertManager.getUnrefreshedCertsNotifications to make separate calls.\nWe can make a single call to the store connection and have it responsible for getting all records that should receive notifications.\nFor JDBC we can leave the implementation as is (it will just do the calls one after the other) but for DynamoDB we can just return all the updated records from the query. I'll fix it and push", "author": "OferLevi85", "createdAt": "2020-06-11T10:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3Mjc2Mg=="}], "type": "inlineReview"}, {"oid": "ba2d1ff0e82f86f2bfd29777db1ad07a2d425844", "url": "https://github.com/AthenZ/athenz/commit/ba2d1ff0e82f86f2bfd29777db1ad07a2d425844", "message": "Enabled Email Notifications for ZTS with DynamoDB", "committedDate": "2020-06-09T20:27:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMDExNw==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r437700117", "bodyText": "Everytime we update the currentTime column (hold epoch in long format), we should also update the new currentDate column (ISO date in the format YYYY-MM-DD).", "author": "OferLevi85", "createdAt": "2020-06-09T20:31:48Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -139,10 +156,10 @@ public boolean updateX509CertRecord(X509CertRecord certRecord) {\n                             new AttributeUpdate(KEY_CURRENT_SERIAL).put(certRecord.getCurrentSerial()),\n                             new AttributeUpdate(KEY_CURRENT_IP).put(certRecord.getCurrentIP()),\n                             new AttributeUpdate(KEY_CURRENT_TIME).put(getLongFromDate(certRecord.getCurrentTime())),\n+                            new AttributeUpdate(KEY_CURRENT_DATE).put(dynamoDBUtils.getIso8601FromDate(certRecord.getCurrentTime())),", "originalCommit": "ba2d1ff0e82f86f2bfd29777db1ad07a2d425844", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4Mjk1Ng==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r438382956", "bodyText": "what was the reason for removing client cert flag?", "author": "havetisyan", "createdAt": "2020-06-10T20:15:48Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -139,10 +156,10 @@ public boolean updateX509CertRecord(X509CertRecord certRecord) {\n                             new AttributeUpdate(KEY_CURRENT_SERIAL).put(certRecord.getCurrentSerial()),\n                             new AttributeUpdate(KEY_CURRENT_IP).put(certRecord.getCurrentIP()),\n                             new AttributeUpdate(KEY_CURRENT_TIME).put(getLongFromDate(certRecord.getCurrentTime())),\n+                            new AttributeUpdate(KEY_CURRENT_DATE).put(dynamoDBUtils.getIso8601FromDate(certRecord.getCurrentTime())),\n                             new AttributeUpdate(KEY_PREV_SERIAL).put(certRecord.getPrevSerial()),\n                             new AttributeUpdate(KEY_PREV_IP).put(certRecord.getPrevIP()),\n                             new AttributeUpdate(KEY_PREV_TIME).put(getLongFromDate(certRecord.getPrevTime())),\n-                            new AttributeUpdate(KEY_CLIENT_CERT).put(certRecord.getClientCert()),", "originalCommit": "ba2d1ff0e82f86f2bfd29777db1ad07a2d425844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU4MTQwMg==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r438581402", "bodyText": "Yeah sorry I put the explanation in the closed PR and forgot to copy it here.\nIn any case, I noticed that in JDBC connection we do not update this column during an update.\nAfter checking the purpose of this attribute (differentiating between server and client certificates), I assumed that it is a column that should never be changed after the record is first inserted.\nIf my assumption is incorrect let me know (in which case we should also add it to the JDBC update call).", "author": "OferLevi85", "createdAt": "2020-06-11T07:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4Mjk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NTY0OA==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r439255648", "bodyText": "Yes, we should update it and fix jdbc as well. The logic is that once you get a client cert, you can't request a service cert. However, the provider may decide that it wants ZTS to issue a client cert only for a request in which case we honor the downgrade option.", "author": "havetisyan", "createdAt": "2020-06-12T07:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4Mjk1Ng=="}], "type": "inlineReview"}, {"oid": "28e7213bbaa8dbe23208b4e49f2fd130740e80c7", "url": "https://github.com/AthenZ/athenz/commit/28e7213bbaa8dbe23208b4e49f2fd130740e80c7", "message": "Enabled Email Notifications for ZTS with DynamoDB", "committedDate": "2020-06-11T11:52:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0ODI4Mg==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r439248282", "bodyText": "by default we were list certs that were not refreshed for more than 3 days (the default value in jdbc)\nlet's update the return description since we're returning List now.", "author": "havetisyan", "createdAt": "2020-06-12T07:15:04Z", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/cert/CertRecordStoreConnection.java", "diffHunk": "@@ -73,21 +73,13 @@\n     int deleteExpiredX509CertRecords(int expiryTimeMins);\n \n     /**\n-     * Update lastNotifiedServer and lastNotifiedTime for certificate that failed to refresh for more than one day.\n+     * List all certificates that failed to refresh for more than one day.\n      * @param lastNotifiedServer\n      * @param lastNotifiedTime\n      * @param provider\n      * @return True if at least one certificate record was updated (needs notification to be sent)", "originalCommit": "28e7213bbaa8dbe23208b4e49f2fd130740e80c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1Mjc4OA==", "url": "https://github.com/AthenZ/athenz/pull/1003#discussion_r439252788", "bodyText": "what are we creating a new instance of DynamoDBUtils and passing here? Why can't DynamoDBCertRecordStoreConnection just maintain it's own instance of the class since it only has a couple of public methods? Any reason why those methods can't be static and then no need to create any instances?", "author": "havetisyan", "createdAt": "2020-06-12T07:25:59Z", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStore.java", "diffHunk": "@@ -32,18 +33,18 @@\n     private static final Logger LOGGER = LoggerFactory.getLogger(DynamoDBCertRecordStore.class);\n     private static final Logger CERTLOGGER = LoggerFactory.getLogger(\"X509CertLogger\");\n \n-    private DynamoDB dynamoDB;\n     private String tableName;\n+    private DynamoDB dynamoDB;\n \n     public DynamoDBCertRecordStore(AmazonDynamoDB client, final String tableName) {\n-        dynamoDB = new DynamoDB(client);\n+        this.dynamoDB = new DynamoDB(client);\n         this.tableName = tableName;\n     }\n \n     @Override\n     public CertRecordStoreConnection getConnection() {\n         try {\n-            return new DynamoDBCertRecordStoreConnection(dynamoDB, tableName);\n+            return new DynamoDBCertRecordStoreConnection(dynamoDB, tableName, new DynamoDBUtils());", "originalCommit": "28e7213bbaa8dbe23208b4e49f2fd130740e80c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a1348c10952f648479dd830bb31482e03386011", "url": "https://github.com/AthenZ/athenz/commit/2a1348c10952f648479dd830bb31482e03386011", "message": "Fix", "committedDate": "2020-06-15T09:53:32Z", "type": "forcePushed"}, {"oid": "a5b81da321bb013ea0b975a06dbb8b654b023bc6", "url": "https://github.com/AthenZ/athenz/commit/a5b81da321bb013ea0b975a06dbb8b654b023bc6", "message": "Enabled Email Notifications for ZTS with DynamoDB", "committedDate": "2020-06-15T10:23:09Z", "type": "commit"}, {"oid": "a5b81da321bb013ea0b975a06dbb8b654b023bc6", "url": "https://github.com/AthenZ/athenz/commit/a5b81da321bb013ea0b975a06dbb8b654b023bc6", "message": "Enabled Email Notifications for ZTS with DynamoDB", "committedDate": "2020-06-15T10:23:09Z", "type": "forcePushed"}]}