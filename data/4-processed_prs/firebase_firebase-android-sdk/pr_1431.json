{"pr_number": 1431, "pr_title": "Add large payload support to datatransport.", "pr_createdAt": "2020-04-07T17:51:29Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1431", "timeline": [{"oid": "507e8c63a1733e9db0632f2288dcc2f3de9beb33", "url": "https://github.com/firebase/firebase-android-sdk/commit/507e8c63a1733e9db0632f2288dcc2f3de9beb33", "message": "Add large payload support to datatransport.\n\nLarge payloads are stored in a separate table as 80KB chunks of data keyed\nby (sequence_num,event_id).\nThe motivation for the change is to avoid the Android SQLite\nimplementation limitation, that uses `CursorWindow`s of a limited size\nthat is unknown at runtime and vendors can change arbitrarily, hence the\nconservative choice of 80KB instead of 2048KB that is present in AOSP\nsource code.\n\nThe way it manifests is that it is possible to write rows in the the db\nthat is impossible to read back as an exception gets thrown.\n\nAn altertative approach that was considered was to store file paths in\nthe DB and store blobs in the file-system. But that would introduce more\ncomplexity to the storage system:\n\n* Loss of ACID semantics, i.e. if we fail to commit we may fail to\n  delete the underlying file.\n* Should we store it in cache dir or in file dir?\n* What if cache is cleared but the event reference still exists in the db?\n* etc.", "committedDate": "2020-04-07T17:50:46Z", "type": "commit"}, {"oid": "5ede9fa22e9e502753f9efd9708efed3fce9ede4", "url": "https://github.com/firebase/firebase-android-sdk/commit/5ede9fa22e9e502753f9efd9708efed3fce9ede4", "message": "Fix integ test", "committedDate": "2020-04-07T20:52:41Z", "type": "commit"}, {"oid": "aeeb09c14e29253ed547e10ea6d217c82400ef99", "url": "https://github.com/firebase/firebase-android-sdk/commit/aeeb09c14e29253ed547e10ea6d217c82400ef99", "message": "Upgrade to latest dagger.", "committedDate": "2020-04-07T20:52:52Z", "type": "commit"}, {"oid": "2e25a7f8211df2f03c271c7b7068964bd6e48db7", "url": "https://github.com/firebase/firebase-android-sdk/commit/2e25a7f8211df2f03c271c7b7068964bd6e48db7", "message": "Increase device coverage of sqlite tests.\n\nSpecifically moved sqlite tests to instrumentation such that they run on\nall configured devices in FTL.\n\nAdditionally added migration test from v3 to v4.", "committedDate": "2020-04-08T17:01:28Z", "type": "commit"}, {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576", "url": "https://github.com/firebase/firebase-android-sdk/commit/3870f605a87c6216c4a01a385530ee10f9fb7576", "message": "upgrade robolectric.", "committedDate": "2020-04-08T17:04:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNDA5Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405824097", "bodyText": "MAX_BLOB_SIZE_BYTES ?", "author": "ashwinraghav", "createdAt": "2020-04-08T21:24:42Z", "path": "transport/transport-runtime/src/androidTest/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStoreTest.java", "diffHunk": "@@ -52,8 +53,14 @@\n           .build();\n \n   private static final long HOUR = 60 * 60 * 1000;\n+  private static final int MAX_BLOB_SIZE = 6;", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNDQ2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405824463", "bodyText": "setMaxBlobSizeBytesPerRow ?", "author": "ashwinraghav", "createdAt": "2020-04-08T21:25:28Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/EventStoreConfig.java", "diffHunk": "@@ -61,6 +66,8 @@ Builder toBuilder() {\n \n     abstract Builder setEventCleanUpAge(long value);\n \n+    abstract Builder setMaxBlobSizePerRow(int value);", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNTUyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405825521", "bodyText": "Can we move lines 99 to 103 up to the setup portion of the test  to conform to the pattern you have in here\n//setup\n//Act\n//assert", "author": "ashwinraghav", "createdAt": "2020-04-08T21:27:44Z", "path": "transport/transport-runtime/src/androidTest/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStoreTest.java", "diffHunk": "@@ -75,6 +85,31 @@ public void persist_correctlyRoundTrips() {\n     assertThat(events).containsExactly(newEvent);\n   }\n \n+  @Test\n+  public void persist_withNonInlineBlob_correctlyRoundTrips() {\n+    byte[] payload = \"LongerThanSixBytes\".getBytes(Charset.defaultCharset());\n+    EventInternal event =\n+        EVENT.toBuilder().setEncodedPayload(new EncodedPayload(JSON_ENCODING, payload)).build();\n+    PersistedEvent newEvent = store.persist(TRANSPORT_CONTEXT, event);\n+    Iterable<PersistedEvent> events = store.loadBatch(TRANSPORT_CONTEXT);\n+\n+    assertThat(newEvent.getEvent()).isEqualTo(event);\n+    assertThat(events).containsExactly(newEvent);\n+    long expectedRows = payload.length / MAX_BLOB_SIZE;", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODE0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405828144", "bodyText": "Nit: I realize this is starting to look like an integration test. Consider splitting up.", "author": "ashwinraghav", "createdAt": "2020-04-08T21:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNTUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODczMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405828733", "bodyText": "MAX_BLOB_SIZE_PER_ROW_BYTES ?", "author": "ashwinraghav", "createdAt": "2020-04-08T21:34:23Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/EventStoreConfig.java", "diffHunk": "@@ -22,13 +22,15 @@\n   private static final int LOAD_BATCH_SIZE = 200;\n   private static final int LOCK_TIME_OUT_MS = 10000;\n   private static final long DURATION_ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;\n+  private static final int MAX_BLOB_SIZE_PER_ROW = 80 * 1024;", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMTU4NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405831584", "bodyText": "Consider Math.ceil((double)payloadBytes.length / maxBlobSizePerRow)", "author": "ashwinraghav", "createdAt": "2020-04-08T21:40:47Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -104,16 +106,39 @@ public PersistedEvent persist(TransportContext transportContext, EventInternal e\n               }\n \n               long contextId = ensureTransportContext(db, transportContext);\n+              int maxBlobSizePerRow = config.getMaxBlobSizePerRow();\n+\n+              byte[] payloadBytes = event.getEncodedPayload().getBytes();\n+              boolean inline = payloadBytes.length <= maxBlobSizePerRow;\n               ContentValues values = new ContentValues();\n               values.put(\"context_id\", contextId);\n               values.put(\"transport_name\", event.getTransportName());\n               values.put(\"timestamp_ms\", event.getEventMillis());\n               values.put(\"uptime_ms\", event.getUptimeMillis());\n               values.put(\"payload_encoding\", event.getEncodedPayload().getEncoding().getName());\n-              values.put(\"payload\", event.getEncodedPayload().getBytes());\n               values.put(\"code\", event.getCode());\n               values.put(\"num_attempts\", 0);\n+              values.put(\"inline\", inline);\n+              values.put(\"payload\", inline ? payloadBytes : new byte[0]);\n               long newEventId = db.insert(\"events\", null, values);\n+              if (!inline) {\n+                int numChunks = payloadBytes.length / maxBlobSizePerRow;", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMjgwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405832802", "bodyText": "Dug around a bit and failed to find a way to avoid copying (sanely).", "author": "ashwinraghav", "createdAt": "2020-04-08T21:43:34Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -104,16 +106,39 @@ public PersistedEvent persist(TransportContext transportContext, EventInternal e\n               }\n \n               long contextId = ensureTransportContext(db, transportContext);\n+              int maxBlobSizePerRow = config.getMaxBlobSizePerRow();\n+\n+              byte[] payloadBytes = event.getEncodedPayload().getBytes();\n+              boolean inline = payloadBytes.length <= maxBlobSizePerRow;\n               ContentValues values = new ContentValues();\n               values.put(\"context_id\", contextId);\n               values.put(\"transport_name\", event.getTransportName());\n               values.put(\"timestamp_ms\", event.getEventMillis());\n               values.put(\"uptime_ms\", event.getUptimeMillis());\n               values.put(\"payload_encoding\", event.getEncodedPayload().getEncoding().getName());\n-              values.put(\"payload\", event.getEncodedPayload().getBytes());\n               values.put(\"code\", event.getCode());\n               values.put(\"num_attempts\", 0);\n+              values.put(\"inline\", inline);\n+              values.put(\"payload\", inline ? payloadBytes : new byte[0]);\n               long newEventId = db.insert(\"events\", null, values);\n+              if (!inline) {\n+                int numChunks = payloadBytes.length / maxBlobSizePerRow;\n+                if (payloadBytes.length % maxBlobSizePerRow != 0) {\n+                  numChunks += 1;\n+                }\n+                for (int chunk = 1; chunk <= numChunks; chunk++) {\n+                  byte[] chunkBytes =\n+                      Arrays.copyOfRange(", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNDU0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405834549", "bodyText": "Can be moved into the loop above?", "author": "ashwinraghav", "createdAt": "2020-04-08T21:47:45Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -386,6 +418,37 @@ public void clearDb() {\n     return events;\n   }\n \n+  private byte[] readPayload(long eventId) {\n+    return tryWithCursor(\n+        getDb()\n+            .query(\n+                \"event_payloads\",\n+                new String[] {\"bytes\"},\n+                \"event_id = ?\",\n+                new String[] {String.valueOf(eventId)},\n+                null,\n+                null,\n+                \"sequence_num\"),\n+        cursor -> {\n+          List<byte[]> chunks = new ArrayList<>();\n+          while (cursor.moveToNext()) {\n+            chunks.add(cursor.getBlob(0));\n+          }\n+          int totalLength = 0;\n+          for (byte[] chunk : chunks) {\n+            totalLength += chunk.length;", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNzM2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405837362", "bodyText": "What does this do?", "author": "ashwinraghav", "createdAt": "2020-04-08T21:53:48Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -95,12 +104,24 @@\n   private static final SchemaManager.Migration MIGRATE_TO_V3 =\n       db -> db.execSQL(\"ALTER TABLE events ADD COLUMN payload_encoding TEXT\");\n \n+  private static final SchemaManager.Migration MIGRATE_TO_V4 =\n+      db -> {\n+        db.execSQL(\"ALTER TABLE events ADD COLUMN inline BOOLEAN DEFAULT 1\");\n+        ContentValues values = new ContentValues();\n+        values.put(\"inline\", 1);\n+        db.update(\"events\", values, null, new String[0]);", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NzYzMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r406277633", "bodyText": "I thought I needed to backfill values, but it turns out I did not, updated the migration test to verify that it's backfilled.", "author": "vkryachko", "createdAt": "2020-04-09T15:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNzM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0Mjg0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405842848", "bodyText": "What happens to existing inline events that may be too large. Should we cleanup since migration seems impossible ?", "author": "ashwinraghav", "createdAt": "2020-04-08T22:06:51Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -95,12 +104,24 @@\n   private static final SchemaManager.Migration MIGRATE_TO_V3 =\n       db -> db.execSQL(\"ALTER TABLE events ADD COLUMN payload_encoding TEXT\");\n \n+  private static final SchemaManager.Migration MIGRATE_TO_V4 =\n+      db -> {\n+        db.execSQL(\"ALTER TABLE events ADD COLUMN inline BOOLEAN DEFAULT 1\");", "originalCommit": "3870f605a87c6216c4a01a385530ee10f9fb7576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4MDYzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r406280635", "bodyText": "I think it's highly unlikely that we have such events out there and the cleanup would be pretty involved if we don't want to lose data, we would have to:\n\nquery all events with len(payload) > X\nfor each event select X bytes chunk by chunk and put into new table\nclear inline + payload fields\n\nAnd all of this would have to be maintained forever.\nSo given how unlikely it is that we have large payloads out there, I'd prefer not to bother with this. wdyt?", "author": "vkryachko", "createdAt": "2020-04-09T15:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0Mjg0OA=="}], "type": "inlineReview"}, {"oid": "866abb7cb773646ac67552de5fa60536a2a36414", "url": "https://github.com/firebase/firebase-android-sdk/commit/866abb7cb773646ac67552de5fa60536a2a36414", "message": "Address review comments.", "committedDate": "2020-04-09T15:19:13Z", "type": "commit"}]}