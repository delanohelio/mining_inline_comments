{"pr_number": 1443, "pr_title": "Logging error response from FIS servers", "pr_createdAt": "2020-04-09T21:37:43Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1443", "timeline": [{"oid": "4283a2bb3b4434510e061a0d9c4b080595658c2a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4283a2bb3b4434510e061a0d9c4b080595658c2a", "message": "Dropping guava and appcompat dependency from FIS SDK.", "committedDate": "2020-02-06T17:59:09Z", "type": "commit"}, {"oid": "984884cd6f9a90a8172d0957bd13e68e3f06db2f", "url": "https://github.com/firebase/firebase-android-sdk/commit/984884cd6f9a90a8172d0957bd13e68e3f06db2f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-06T18:16:08Z", "type": "commit"}, {"oid": "a82387701d2549bb5fc3b5dc2530a83ed0680d02", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82387701d2549bb5fc3b5dc2530a83ed0680d02", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-11T18:58:16Z", "type": "commit"}, {"oid": "afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "url": "https://github.com/firebase/firebase-android-sdk/commit/afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-13T23:37:48Z", "type": "commit"}, {"oid": "5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "url": "https://github.com/firebase/firebase-android-sdk/commit/5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-05T16:49:33Z", "type": "commit"}, {"oid": "a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-09T16:31:08Z", "type": "commit"}, {"oid": "45312e68fe8516dc4d48a2bfdb422f5023c1241b", "url": "https://github.com/firebase/firebase-android-sdk/commit/45312e68fe8516dc4d48a2bfdb422f5023c1241b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T18:13:59Z", "type": "commit"}, {"oid": "f0be4fa07222c687044f66d8cb2859e156611896", "url": "https://github.com/firebase/firebase-android-sdk/commit/f0be4fa07222c687044f66d8cb2859e156611896", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T21:55:48Z", "type": "commit"}, {"oid": "ac0397ba816265b24da3eca4645761a37d4b46b6", "url": "https://github.com/firebase/firebase-android-sdk/commit/ac0397ba816265b24da3eca4645761a37d4b46b6", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-11T18:14:18Z", "type": "commit"}, {"oid": "8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "url": "https://github.com/firebase/firebase-android-sdk/commit/8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-12T19:40:52Z", "type": "commit"}, {"oid": "686a998ab40a6c855d81b30f7686ef20aef1713c", "url": "https://github.com/firebase/firebase-android-sdk/commit/686a998ab40a6c855d81b30f7686ef20aef1713c", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-16T17:31:01Z", "type": "commit"}, {"oid": "3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "url": "https://github.com/firebase/firebase-android-sdk/commit/3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-18T21:05:27Z", "type": "commit"}, {"oid": "07ff7ddc966270c28df8d123ef95e63a9f058494", "url": "https://github.com/firebase/firebase-android-sdk/commit/07ff7ddc966270c28df8d123ef95e63a9f058494", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-30T21:58:00Z", "type": "commit"}, {"oid": "f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "url": "https://github.com/firebase/firebase-android-sdk/commit/f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-31T22:05:19Z", "type": "commit"}, {"oid": "672526aca799c55e7f83aaa0f08c7e698be388ed", "url": "https://github.com/firebase/firebase-android-sdk/commit/672526aca799c55e7f83aaa0f08c7e698be388ed", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-05T05:34:09Z", "type": "commit"}, {"oid": "1adf4a2621f9367521f806ea893770921713e49f", "url": "https://github.com/firebase/firebase-android-sdk/commit/1adf4a2621f9367521f806ea893770921713e49f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-07T20:56:39Z", "type": "commit"}, {"oid": "8df231d17739c5c011382975ad8d59d6608be1a6", "url": "https://github.com/firebase/firebase-android-sdk/commit/8df231d17739c5c011382975ad8d59d6608be1a6", "message": "Expanding preconditions checks description to help 3p developers", "committedDate": "2020-04-07T22:00:57Z", "type": "commit"}, {"oid": "8c7b74c4426778ba2021145505a019ead02c0db9", "url": "https://github.com/firebase/firebase-android-sdk/commit/8c7b74c4426778ba2021145505a019ead02c0db9", "message": "Upgrading FIAM dependencies to IID version 20.1.5", "committedDate": "2020-04-08T22:13:37Z", "type": "commit"}, {"oid": "44e1f106a4ad80ef5ec7360f6e212c3b6ad13992", "url": "https://github.com/firebase/firebase-android-sdk/commit/44e1f106a4ad80ef5ec7360f6e212c3b6ad13992", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-09T20:24:16Z", "type": "commit"}, {"oid": "2ab7ee59766a094373f1c2c7fae62c2671154d31", "url": "https://github.com/firebase/firebase-android-sdk/commit/2ab7ee59766a094373f1c2c7fae62c2671154d31", "message": "Logging error response from FIS servers", "committedDate": "2020-04-09T20:41:21Z", "type": "commit"}, {"oid": "fabac7321f918bf41a1045debd668a1243b8c8b0", "url": "https://github.com/firebase/firebase-android-sdk/commit/fabac7321f918bf41a1045debd668a1243b8c8b0", "message": "Remove Fiam changes", "committedDate": "2020-04-09T21:35:36Z", "type": "commit"}, {"oid": "037eecb8ededad598bc8f2fb1f9ca78206690df0", "url": "https://github.com/firebase/firebase-android-sdk/commit/037eecb8ededad598bc8f2fb1f9ca78206690df0", "message": "Remove preconditions update", "committedDate": "2020-04-09T21:37:08Z", "type": "commit"}, {"oid": "40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "url": "https://github.com/firebase/firebase-android-sdk/commit/40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "message": "Disconnecting connection after reading error stream in Delete network\ncall", "committedDate": "2020-04-09T21:38:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MTQyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406541420", "bodyText": "How about creating a method for this to prevent code duplication:\nprivate void logFisCommunicationError(HttpURLConnection conn) {\n  String logString = [...];\n  Log.w(FIS_TAG, logString);\n}\n\nPlease ignore/ack if you think this makes no sense.", "author": "andirayo", "createdAt": "2020-04-10T00:10:16Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -161,6 +164,8 @@ public InstallationResponse createFirebaseInstallation(\n           return readCreateResponse(httpURLConnection);\n         }\n \n+        Log.w(FIS_TAG, readErrorResponse(httpURLConnection));", "originalCommit": "40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2MjE2OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406862169", "bodyText": "Done", "author": "ankitaj224", "createdAt": "2020-04-10T17:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MTQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MzU0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406543541", "bodyText": "I would ask you to please add another log message to the case that the request fails as ResponseCode.BAD_CONFIG, when we know that the application is misconfigured.\nSince this is the main concern we are addressing, I recommend to add another log message, preferably as \"Error\" or as \"Critical\" - I'm not sure which one is more accurate:\nLog.e/c(FIS_TAG, \"Firebase Installations can not communicate with Firebase server APIs due to invalid configuration. Please update your Firebase initialization process and set valid Firebase options (API key, Project ID, Application ID) when initializing Firebase.\"", "author": "andirayo", "createdAt": "2020-04-10T00:17:33Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -161,6 +164,8 @@ public InstallationResponse createFirebaseInstallation(\n           return readCreateResponse(httpURLConnection);\n         }\n \n+        Log.w(FIS_TAG, readErrorResponse(httpURLConnection));\n+\n         if (httpResponseCode == 429 || (httpResponseCode >= 500 && httpResponseCode < 600)) {\n           retryCount++;\n           continue;", "originalCommit": "40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxMTgzOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406911839", "bodyText": "Done. PTAL", "author": "ankitaj224", "createdAt": "2020-04-10T19:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MzU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0Mzg0Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406543842", "bodyText": "If we are only using this for logging, should we swallow that IOException? Wdyt?", "author": "andirayo", "createdAt": "2020-04-10T00:18:41Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -486,4 +495,19 @@ static long parseTokenExpirationTimestamp(String expiresIn) {\n         ? 0L\n         : Long.parseLong(expiresIn.substring(0, expiresIn.length() - 1));\n   }\n+\n+  // Read the error message from the response.\n+  private String readErrorResponse(HttpURLConnection conn) throws IOException {", "originalCommit": "40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxMTkzMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406911933", "bodyText": "Makes sense. Done", "author": "ankitaj224", "createdAt": "2020-04-10T19:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0Mzg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0NTk2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406545961", "bodyText": "FIS\n\"Firebase Installations API\" or \"Firebase Installations server API\" instead of \"FIS server\".\nWe don't use FIS in public documentation.\nAlso it uses the term \"Firebase\" so developers are more likely to recognize that this is used by their Firebase service.\nColon\nPlease add a colon between ResponseMessage and ResponseBody. I think that is the standard when printing these errors (not 100% sure).\nSuggestion\n\"Error when communicating with the Firebase Installations server API. HTTP response: [%d %s: %s]\"", "author": "andirayo", "createdAt": "2020-04-10T00:27:16Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -486,4 +495,19 @@ static long parseTokenExpirationTimestamp(String expiresIn) {\n         ? 0L\n         : Long.parseLong(expiresIn.substring(0, expiresIn.length() - 1));\n   }\n+\n+  // Read the error message from the response.\n+  private String readErrorResponse(HttpURLConnection conn) throws IOException {\n+    try (BufferedReader reader =\n+        new BufferedReader(new InputStreamReader(conn.getErrorStream(), UTF_8))) {\n+      StringBuilder response = new StringBuilder();\n+      for (String input = reader.readLine(); input != null; input = reader.readLine()) {\n+        response.append(input).append('\\n');\n+      }\n+\n+      return String.format(\n+          \"The FIS server responded with an error. HTTP response: [%d %s %s]\",", "originalCommit": "40d915c7e234ac01eb49e88c5eaf0d0ce72d4000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aaa1ee514efcfeac9264ab158ee71d64ac3d95a7", "url": "https://github.com/firebase/firebase-android-sdk/commit/aaa1ee514efcfeac9264ab158ee71d64ac3d95a7", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisErrorStream", "committedDate": "2020-04-10T17:18:08Z", "type": "commit"}, {"oid": "f6836a69b988a69c4060ba6a3d972e4f2ce0e3fa", "url": "https://github.com/firebase/firebase-android-sdk/commit/f6836a69b988a69c4060ba6a3d972e4f2ce0e3fa", "message": "Fix for Rayo's comments", "committedDate": "2020-04-10T19:39:54Z", "type": "commit"}, {"oid": "f2eba2c02e87d7f7eddc75d9cbf17ba150bdff59", "url": "https://github.com/firebase/firebase-android-sdk/commit/f2eba2c02e87d7f7eddc75d9cbf17ba150bdff59", "message": "Code cleanup", "committedDate": "2020-04-10T19:44:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNTI0Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406915243", "bodyText": "@nullable", "author": "andirayo", "createdAt": "2020-04-10T19:50:25Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -486,4 +511,27 @@ static long parseTokenExpirationTimestamp(String expiresIn) {\n         ? 0L\n         : Long.parseLong(expiresIn.substring(0, expiresIn.length() - 1));\n   }\n+\n+  private static void logFisCommunicationError(HttpURLConnection conn) {\n+    String logString = readErrorResponse(conn);\n+    if (!TextUtils.isEmpty(logString)) {\n+      Log.w(FIS_TAG, logString);\n+    }\n+  }\n+\n+  // Read the error message from the response.\n+  private static String readErrorResponse(HttpURLConnection conn) {", "originalCommit": "f2eba2c02e87d7f7eddc75d9cbf17ba150bdff59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNTg0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406915849", "bodyText": "If you return before this httpURLConnection seems to stay connected, because you only call #disconnect over here.", "author": "andirayo", "createdAt": "2020-04-10T19:52:15Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -286,19 +294,23 @@ public void deleteFirebaseInstallation(\n       httpURLConnection.addRequestProperty(\"Authorization\", \"FIS_v2 \" + refreshToken);\n \n       int httpResponseCode = httpURLConnection.getResponseCode();\n-      httpURLConnection.disconnect();\n \n       if (httpResponseCode == 200 || httpResponseCode == 401 || httpResponseCode == 404) {\n         return;\n       }\n \n+      logFisCommunicationError(httpURLConnection);\n+      httpURLConnection.disconnect();", "originalCommit": "f2eba2c02e87d7f7eddc75d9cbf17ba150bdff59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNzgzOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1443#discussion_r406917839", "bodyText": "Good catch. Fixed it.", "author": "ankitaj224", "createdAt": "2020-04-10T19:57:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkxNTg0OQ=="}], "type": "inlineReview"}, {"oid": "2711ae0907c580f3dd3b2195f93faf5443735e7b", "url": "https://github.com/firebase/firebase-android-sdk/commit/2711ae0907c580f3dd3b2195f93faf5443735e7b", "message": "Minor bug fix", "committedDate": "2020-04-10T19:56:56Z", "type": "commit"}]}