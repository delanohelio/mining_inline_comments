{"pr_number": 1353, "pr_title": "C++ API for Crashlytics NDK ", "pr_createdAt": "2020-03-16T15:21:58Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1353", "timeline": [{"oid": "fe3e4de7dc778e43cb556d400a83a5e2145bb036", "url": "https://github.com/firebase/firebase-android-sdk/commit/fe3e4de7dc778e43cb556d400a83a5e2145bb036", "message": "Add the Crashlytics C++ API for NDK (in progress)\n\nAdd the new C++-only API provided by the header-only library\n(crashlytics.h) and break compatibility with C.\n\nThis commit is in progress; subsequent work on this branch will\nremove the C-only parts of crashlytics.h and add documentation.", "committedDate": "2020-03-11T17:25:08Z", "type": "commit"}, {"oid": "822fc78798cc87e3a41725285d72327a7947a504", "url": "https://github.com/firebase/firebase-android-sdk/commit/822fc78798cc87e3a41725285d72327a7947a504", "message": "Removed C APIs and put everything in firebase::crashlytics namespace. \\n\\nAlso prefixed all non-public functions / identifiers with '__'. Formatting will be cleaned up in the next commit.", "committedDate": "2020-03-16T15:03:39Z", "type": "commit"}, {"oid": "e4f1e4d46ac08970dfb75ee581ca06cbb3643863", "url": "https://github.com/firebase/firebase-android-sdk/commit/e4f1e4d46ac08970dfb75ee581ca06cbb3643863", "message": "Formatting changes. \\n\\nThis is only partially auto-formatted, so their may be some formatting inconsistencies in favor of overall readability.", "committedDate": "2020-03-16T15:19:09Z", "type": "commit"}, {"oid": "5e1df4fd1f44133755509a346d4c29897095c038", "url": "https://github.com/firebase/firebase-android-sdk/commit/5e1df4fd1f44133755509a346d4c29897095c038", "message": "Remove crashlytics.h dependencies on jni.h and android\n\nWe aren't currently using the JNI_Env type so there's no\nneed for the jni.h dependency. The android logcat output\nis not essential either, so we'll remove it in favor of\nfewer dependencies.", "committedDate": "2020-03-16T15:59:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE2NzY4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1353#discussion_r393167683", "bodyText": "Is the intent to log an error here, as you mentioned in the refdoc?", "author": "mrwillis21", "createdAt": "2020-03-16T16:52:34Z", "path": "firebase-crashlytics-ndk/src/main/jni/libcrashlytics/include/crashlytics/external/crashlytics.h", "diffHunk": "@@ -14,85 +14,151 @@\n #ifndef __CRASHLYTICS_H__\n #define __CRASHLYTICS_H__\n \n-#if defined (__cplusplus)\n-        #include <cstddef>\n-#else\n-        #include <stdlib.h>\n-        #include <string.h>\n-#endif\n-\n+#include <cstddef>\n+#include <string>\n #include <dlfcn.h>\n \n-// THIS IS THE LEGACY PUBLIC C++ API FOR THE FABRIC CRASHLYTICS NDK, INTENDED FOR BACKWARDS\n-// COMPATIBILITY ONLY. THIS API IS DEPRECATED AND SCHEDULED FOR REPLACEMENT IN 2020.\n+/// @brief Firebase Crashlytics NDK API, for Android apps which use native code.\n+///\n+/// This API is optional: It enables adding custom metadata to your native Crashlytics crash\n+/// reports. See <a href=\"https://firebase.google.com/docs/crashlytics\">the developer guides</a>\n+/// for information on using Firebase Crashlytics in your NDK-enabled Android apps.\n+namespace firebase::crashlytics {\n+\n+    /** PUBLIC API **/\n+\n+    /// @brief Initialize the Crashlytics API.\n+    ///\n+    /// This must be called prior to calling any other methods in the firebase:crashlytics\n+    /// namespace.\n+    void Initialize();\n \n-/*! Custom logs and keys ---------------------------------------------------------------------------------------*/\n-/*! Native API:\n+    /// @brief Terminate the Crashlytics API.\n+    ///\n+    /// Cleans up resources associated with the API. Subsequent calls to the Crashlytics native API\n+    /// will log an error and have no other effect.\n+    void Terminate();\n \n-        crashlytics_context_t* crashlytics_init();\n-        void crashlytics_context_t::set(crashlytics_context_t* context, const char* key, const char* value);\n-        void crashlytics_context_t::log(crashlytics_context_t* context, const char* message);\n-        void crashlytics_context_t::set_user_id(crashlytics_context_t* context, const char* identifier);\n+    /// @brief Logs a message to be included in the next fatal or non-fatal report.\n+    void Log(const char *msg);\n \n-        void crashlytics_free(crashlytics_context_t** context);\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, bool value);\n \n-    Example:\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, const char *value);\n \n-        ...\n-        crashlytics_context_t* context = crashlytics_init();\n-        ...\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, double value);\n \n-        context->set(context, \"key\", \"value\");\n-        context->log(context, \"this is a message\");\n-        context->set_user_id(context, \"identifier\");\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, float value);\n \n-        ...\n-        crashlytics_free(&context);\n-        ...\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, int value);\n \n- */\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, long value);\n \n-struct         __crashlytics_context;\n-struct         __crashlytics_unspecified;\n-typedef struct __crashlytics_context                    crashlytics_context_t;\n-typedef struct __crashlytics_unspecified                __crashlytics_unspecified_t;\n+    /// @brief Records a user ID (identifier) that's associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetUserId(const char *id);\n \n-typedef void   (*__crashlytics_set_t)                   (crashlytics_context_t *, const char *, const char *);\n-typedef void   (*__crashlytics_log_t)                   (crashlytics_context_t *, const char *);\n-typedef void   (*__crashlytics_set_user_id_t)           (crashlytics_context_t *, const char *);\n+    /** END PUBLIC API **/\n \n-typedef __crashlytics_unspecified_t*    (*__crashlytics_initialize_t)      ();\n-typedef void                            (*__crashlytics_set_internal_t)    (__crashlytics_unspecified_t *, const char *, const char *);\n-typedef void                            (*__crashlytics_log_internal_t)    (__crashlytics_unspecified_t *, const char *);\n-typedef void                            (*__crashlytics_dispose_t)         (__crashlytics_unspecified_t *);\n+    struct         __crashlytics_context;\n+    struct         __crashlytics_unspecified;\n+    typedef struct __crashlytics_context                    __crashlytics_context_t;\n+    typedef struct __crashlytics_unspecified                __crashlytics_unspecified_t;\n \n-typedef void                            (*__crashlytics_set_user_id_internal_t)(__crashlytics_unspecified_t *, const char *);\n+    typedef __crashlytics_unspecified_t*    (*__crashlytics_initialize_t)      ();\n+    typedef void                            (*__crashlytics_set_internal_t)    (__crashlytics_unspecified_t *, const char *, const char *);\n+    typedef void                            (*__crashlytics_log_internal_t)    (__crashlytics_unspecified_t *, const char *);\n+    typedef void                            (*__crashlytics_set_user_id_internal_t)(__crashlytics_unspecified_t *, const char *);\n+    typedef void                            (*__crashlytics_dispose_t)         (__crashlytics_unspecified_t *);\n \n-struct  __crashlytics_context {\n-/* API ---------------------------------------------------------------------------------------------------------*/\n-        __crashlytics_set_t                            set;\n-        __crashlytics_log_t                            log;\n-        __crashlytics_set_user_id_t                    set_user_id;\n-/*--------------------------------------------------------------------------------------------------------------*/\n+    struct __crashlytics_context {\n \n-        __crashlytics_set_internal_t                   __set;\n-        __crashlytics_log_internal_t                   __log;\n-        __crashlytics_set_user_id_internal_t           __set_user_id;\n+        __crashlytics_set_internal_t __set;\n+        __crashlytics_log_internal_t __log;\n+        __crashlytics_set_user_id_internal_t __set_user_id;\n \n-        __crashlytics_unspecified_t*                   __ctx;\n-        __crashlytics_dispose_t                        __dispose;\n-};\n+        __crashlytics_unspecified_t *__ctx;\n+        __crashlytics_dispose_t __dispose;\n+    };\n \n #define __CRASHLYTICS_NULL_CONTEXT                             (struct __crashlytics_context *) 0\n #define __CRASHLYTICS_INITIALIZE_FAILURE                       (struct __crashlytics_unspecified *) 0\n #define __CRASHLYTICS_DECORATED                                __attribute__ ((always_inline))\n \n-/* API ---------------------------------------------------------------------------------------------------------*/\n \n-static inline crashlytics_context_t* crashlytics_init()                                   __CRASHLYTICS_DECORATED;\n-static inline void                   crashlytics_free(crashlytics_context_t** context)    __CRASHLYTICS_DECORATED;\n+    static inline __crashlytics_context_t* __crashlytics_init() __CRASHLYTICS_DECORATED;\n+    static inline void                     __crashlytics_free(__crashlytics_context_t **context) __CRASHLYTICS_DECORATED;\n+\n+    __crashlytics_context_t *__context;\n+\n+    bool VerifyCrashlytics() {\n+        if (__context) {\n+            return true;\n+        }\n+        return false;", "originalCommit": "5e1df4fd1f44133755509a346d4c29897095c038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwODA4Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1353#discussion_r393208087", "bodyText": "It was, but then I removed it in the most recent commit so we wouldn't need to include any android headers, per kmandrika's suggestion. I'll update the comment to match reality.", "author": "mrichards", "createdAt": "2020-03-16T17:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE2NzY4Mw=="}], "type": "inlineReview"}, {"oid": "f795f22724d257483f42964e0b893e0e43c510f0", "url": "https://github.com/firebase/firebase-android-sdk/commit/f795f22724d257483f42964e0b893e0e43c510f0", "message": "Comment clean up.", "committedDate": "2020-03-16T17:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMjIwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1353#discussion_r393222208", "bodyText": "All definitions within this file should be declared as inline, otherwise, you are going to run into a \"multiple definition\" compiler error. You can test this by including this file into two separate translation units and compiling.", "author": "kmandrika", "createdAt": "2020-03-16T18:13:38Z", "path": "firebase-crashlytics-ndk/src/main/jni/libcrashlytics/include/crashlytics/external/crashlytics.h", "diffHunk": "@@ -14,85 +14,152 @@\n #ifndef __CRASHLYTICS_H__\n #define __CRASHLYTICS_H__\n \n-#if defined (__cplusplus)\n-        #include <cstddef>\n-#else\n-        #include <stdlib.h>\n-        #include <string.h>\n-#endif\n-\n+#include <cstddef>\n+#include <string>\n #include <dlfcn.h>\n \n-// THIS IS THE LEGACY PUBLIC C++ API FOR THE FABRIC CRASHLYTICS NDK, INTENDED FOR BACKWARDS\n-// COMPATIBILITY ONLY. THIS API IS DEPRECATED AND SCHEDULED FOR REPLACEMENT IN 2020.\n+/// @brief Firebase Crashlytics NDK API, for Android apps which use native code.\n+///\n+/// This API is optional: It enables adding custom metadata to your native Crashlytics crash\n+/// reports. See <a href=\"https://firebase.google.com/docs/crashlytics\">the developer guides</a>\n+/// for information on using Firebase Crashlytics in your NDK-enabled Android apps.\n+namespace firebase::crashlytics {\n+\n+    /** PUBLIC API **/\n+\n+    /// @brief Initialize the Crashlytics NDK API, for Android apps using native code.\n+    ///\n+    /// This must be called prior to calling any other methods in the firebase:crashlytics\n+    /// namespace. This call is only required for adding custom metadata to crash reports. Use of\n+    /// this header file is NOT required for Android NDK crash reporting.\n+    void Initialize();\n \n-/*! Custom logs and keys ---------------------------------------------------------------------------------------*/\n-/*! Native API:\n+    /// @brief Terminate the Crashlytics NDK API.\n+    ///\n+    /// Cleans up resources associated with the API. Subsequent calls to the Crashlytics native API\n+    /// will have no effect.\n+    void Terminate();\n \n-        crashlytics_context_t* crashlytics_init();\n-        void crashlytics_context_t::set(crashlytics_context_t* context, const char* key, const char* value);\n-        void crashlytics_context_t::log(crashlytics_context_t* context, const char* message);\n-        void crashlytics_context_t::set_user_id(crashlytics_context_t* context, const char* identifier);\n+    /// @brief Logs a message to be included in the next fatal or non-fatal report.\n+    void Log(const char *msg);\n \n-        void crashlytics_free(crashlytics_context_t** context);\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, bool value);\n \n-    Example:\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, const char *value);\n \n-        ...\n-        crashlytics_context_t* context = crashlytics_init();\n-        ...\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, double value);\n \n-        context->set(context, \"key\", \"value\");\n-        context->log(context, \"this is a message\");\n-        context->set_user_id(context, \"identifier\");\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, float value);\n \n-        ...\n-        crashlytics_free(&context);\n-        ...\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, int value);\n \n- */\n+    /// @brief Records a custom key and value to be associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetCustomKey(const char *key, long value);\n \n-struct         __crashlytics_context;\n-struct         __crashlytics_unspecified;\n-typedef struct __crashlytics_context                    crashlytics_context_t;\n-typedef struct __crashlytics_unspecified                __crashlytics_unspecified_t;\n+    /// @brief Records a user ID (identifier) that's associated with subsequent fatal and non-fatal\n+    /// reports.\n+    void SetUserId(const char *id);\n \n-typedef void   (*__crashlytics_set_t)                   (crashlytics_context_t *, const char *, const char *);\n-typedef void   (*__crashlytics_log_t)                   (crashlytics_context_t *, const char *);\n-typedef void   (*__crashlytics_set_user_id_t)           (crashlytics_context_t *, const char *);\n+    /** END PUBLIC API **/\n \n-typedef __crashlytics_unspecified_t*    (*__crashlytics_initialize_t)      ();\n-typedef void                            (*__crashlytics_set_internal_t)    (__crashlytics_unspecified_t *, const char *, const char *);\n-typedef void                            (*__crashlytics_log_internal_t)    (__crashlytics_unspecified_t *, const char *);\n-typedef void                            (*__crashlytics_dispose_t)         (__crashlytics_unspecified_t *);\n+    struct         __crashlytics_context;\n+    struct         __crashlytics_unspecified;\n+    typedef struct __crashlytics_context                    __crashlytics_context_t;\n+    typedef struct __crashlytics_unspecified                __crashlytics_unspecified_t;\n \n-typedef void                            (*__crashlytics_set_user_id_internal_t)(__crashlytics_unspecified_t *, const char *);\n+    typedef __crashlytics_unspecified_t*    (*__crashlytics_initialize_t)      ();\n+    typedef void                            (*__crashlytics_set_internal_t)    (__crashlytics_unspecified_t *, const char *, const char *);\n+    typedef void                            (*__crashlytics_log_internal_t)    (__crashlytics_unspecified_t *, const char *);\n+    typedef void                            (*__crashlytics_set_user_id_internal_t)(__crashlytics_unspecified_t *, const char *);\n+    typedef void                            (*__crashlytics_dispose_t)         (__crashlytics_unspecified_t *);\n \n-struct  __crashlytics_context {\n-/* API ---------------------------------------------------------------------------------------------------------*/\n-        __crashlytics_set_t                            set;\n-        __crashlytics_log_t                            log;\n-        __crashlytics_set_user_id_t                    set_user_id;\n-/*--------------------------------------------------------------------------------------------------------------*/\n+    struct __crashlytics_context {\n \n-        __crashlytics_set_internal_t                   __set;\n-        __crashlytics_log_internal_t                   __log;\n-        __crashlytics_set_user_id_internal_t           __set_user_id;\n+        __crashlytics_set_internal_t __set;\n+        __crashlytics_log_internal_t __log;\n+        __crashlytics_set_user_id_internal_t __set_user_id;\n \n-        __crashlytics_unspecified_t*                   __ctx;\n-        __crashlytics_dispose_t                        __dispose;\n-};\n+        __crashlytics_unspecified_t *__ctx;\n+        __crashlytics_dispose_t __dispose;\n+    };\n \n #define __CRASHLYTICS_NULL_CONTEXT                             (struct __crashlytics_context *) 0\n #define __CRASHLYTICS_INITIALIZE_FAILURE                       (struct __crashlytics_unspecified *) 0\n #define __CRASHLYTICS_DECORATED                                __attribute__ ((always_inline))\n \n-/* API ---------------------------------------------------------------------------------------------------------*/\n \n-static inline crashlytics_context_t* crashlytics_init()                                   __CRASHLYTICS_DECORATED;\n-static inline void                   crashlytics_free(crashlytics_context_t** context)    __CRASHLYTICS_DECORATED;\n+    static inline __crashlytics_context_t* __crashlytics_init() __CRASHLYTICS_DECORATED;\n+    static inline void                     __crashlytics_free(__crashlytics_context_t **context) __CRASHLYTICS_DECORATED;\n+\n+    __crashlytics_context_t *__context;\n+\n+    bool VerifyCrashlytics() {\n+        if (__context) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    void Initialize() {", "originalCommit": "f795f22724d257483f42964e0b893e0e43c510f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e9a56d891c975f26ae57b7ecf048a0fafb37bcb", "url": "https://github.com/firebase/firebase-android-sdk/commit/3e9a56d891c975f26ae57b7ecf048a0fafb37bcb", "message": "Inlined all new API functions.", "committedDate": "2020-03-17T12:59:50Z", "type": "commit"}, {"oid": "ec9b2df086d17c16696c0b3024e0deb777b795e4", "url": "https://github.com/firebase/firebase-android-sdk/commit/ec9b2df086d17c16696c0b3024e0deb777b795e4", "message": "Restyle to C++ conventions\n\nMove `inline` declarations to front of the signature; use `type* id`\ninstead of `type *id`.", "committedDate": "2020-03-17T14:46:01Z", "type": "commit"}]}