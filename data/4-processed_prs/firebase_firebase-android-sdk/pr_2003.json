{"pr_number": 2003, "pr_title": "Enable request limiter for CreateInstallation, GenerateAuthToken request calls.", "pr_createdAt": "2020-09-23T16:43:13Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2003", "timeline": [{"oid": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "url": "https://github.com/firebase/firebase-android-sdk/commit/f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "message": "Enable request limiter for CreateInstallation & GenerateAuthToken\nrequest calls.", "committedDate": "2020-09-22T23:04:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5MzMwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r493993307", "bodyText": "Why does RandomFidGenerator needs to be instantiated?\nUsually I would assume, because a RandomNumberGenerator has to be injected, but that does not seem to be the case.\nThus, can we use the methods of this class statically?\nAs a more general note:\nFor general code design it would be better if there was a FIS model class that would represent FIDs and also carry methods like generating a random FID.\nNo action item! I just wanted to leave this comment here.", "author": "andirayo", "createdAt": "2020-09-24T01:53:18Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -132,7 +132,7 @@ public Thread newThread(Runnable r) {\n         new FirebaseInstallationServiceClient(\n             firebaseApp.getApplicationContext(), publisher, heartbeatInfo),\n         new PersistedInstallation(firebaseApp),\n-        new Utils(),\n+        Utils.getInstance(),\n         new IidStore(firebaseApp),\n         new RandomFidGenerator());", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxNjgyMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r497816823", "bodyText": "(fyi: this was not addressed or acknowledged)", "author": "andirayo", "createdAt": "2020-09-30T21:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5MzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MjU4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r498982583", "bodyText": "Acknowledged. I will address this in a following PR.", "author": "ankitaj224", "createdAt": "2020-10-02T18:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5MzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5MzQzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r493993430", "bodyText": "I recommend calling this variable singleton.\nIt is just so self-explanatory that you don't need any comments.", "author": "andirayo", "createdAt": "2020-09-24T01:53:54Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -30,6 +30,16 @@\n   public static final long AUTH_TOKEN_EXPIRATION_BUFFER_IN_SECS = TimeUnit.HOURS.toSeconds(1);\n   private static final String APP_ID_IDENTIFICATION_SUBSTRING = \":\";\n   private static final Pattern API_KEY_FORMAT = Pattern.compile(\"\\\\AA[\\\\w-]{38}\\\\z\");\n+  private static Utils utils;", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5MzU0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r493993541", "bodyText": "Please add JavaDoc, e.g.:\n\"Factory method that always returns the same Utils instance.\"", "author": "andirayo", "createdAt": "2020-09-24T01:54:17Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -30,6 +30,16 @@\n   public static final long AUTH_TOKEN_EXPIRATION_BUFFER_IN_SECS = TimeUnit.HOURS.toSeconds(1);\n   private static final String APP_ID_IDENTIFICATION_SUBSTRING = \":\";\n   private static final Pattern API_KEY_FORMAT = Pattern.compile(\"\\\\AA[\\\\w-]{38}\\\\z\");\n+  private static Utils utils;\n+\n+  private Utils() {}\n+\n+  public static Utils getInstance() {", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5Mzk0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r493993944", "bodyText": "Is it necessary to pass the Utils parameter?\nSince there is only one Utils instance, RequestLimiter should be able to access that instance itself and does not need to be passed a Utils instance.\nMaybe the Utils parameter can be optional?\nNot saying that it's better! Just thinking out loud! :)", "author": "andirayo", "createdAt": "2020-09-24T01:55:36Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -112,6 +115,7 @@ public FirebaseInstallationServiceClient(\n     this.context = context;\n     this.userAgentPublisher = publisher;\n     this.heartbeatInfo = heartbeatInfo;\n+    this.requestLimiter = new RequestLimiter(Utils.getInstance());", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MTc2OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r496261769", "bodyText": "Optional not supported due to minSDK version.\nThis is for testing this class easily.", "author": "ankitaj224", "createdAt": "2020-09-28T22:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5Mzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxODU3OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r497818578", "bodyText": "By \"optional\" I mean that you have 2 constructors, one with Utils parameter, one without.\nThe constructor without Utils parameter just calls Utils.getInstance(), so we don't need this implementation detail here.", "author": "andirayo", "createdAt": "2020-09-30T21:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5Mzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMzI1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494003252", "bodyText": "Question:\nWhen we should not send requests to the server, we throw a FirebaseInstallationsException with message \"Firebase Installations Service is unavailable.\"? Is that correct and desired behavior?\nIf yes, why not throw this exception before the while loop?", "author": "andirayo", "createdAt": "2020-09-24T02:32:58Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -143,7 +147,7 @@ public InstallationResponse createFirebaseInstallation(\n     String resourceName = String.format(CREATE_REQUEST_RESOURCE_NAME_FORMAT, projectID);\n     int retryCount = 0;\n     URL url = getFullyQualifiedRequestUri(resourceName);\n-    while (retryCount <= MAX_RETRIES) {\n+    while (requestLimiter.isRequestAllowed() || shouldServerErrorRetry) {", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIyNTIyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r496225228", "bodyText": "Makes sense. Changed it to throw the exception before the loop.\nNow about the desired behavior: We should throw an exception. But I am unclear if it should state \"Firebase Installations Service is unavailable\". WDYT?", "author": "ankitaj224", "createdAt": "2020-09-28T20:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMzI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMzYxMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494003613", "bodyText": "What happens in case of exceptions?\nDo we need to set a nextRequestTime?\nI assume not, just checking if you considered that case.", "author": "andirayo", "createdAt": "2020-09-24T02:34:26Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -158,15 +162,17 @@ public InstallationResponse createFirebaseInstallation(\n         writeFIDCreateRequestBodyToOutputStream(httpURLConnection, fid, appId);\n \n         int httpResponseCode = httpURLConnection.getResponseCode();\n+        requestLimiter.setNextRequestTime(httpResponseCode);", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIyNDAwMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r496224001", "bodyText": "Correct, we should & do not set nextRequestTime on exceptions. Instead retry once before throwing unavailable  exception.", "author": "ankitaj224", "createdAt": "2020-09-28T20:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMzYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTMyMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494005322", "bodyText": "I'm not sure if I like this code!\nThere is several things wrong with this I think:\na) When I read the While loop condition above, it is unclear to me what shouldServerErrorRetry is and I have to search the code to find where the variable is set.\nb) If avoidable (which is almost always the case) local variables should not change in value, because it makes code hard to read - this is actually a great example why. If you have to do it at all costs, you should mark the local variable as @Var.\nc) I just realize it's not a local variable, but an instance variable. Why is that? That is even more confusing to me. Are you saying that other parallel processes can change the value of the variable and affect this while loop? (c.1) I doubt that this is the case. (c.2) And if it's the case, I doubt that it's a good idea!\nd) I also liked using a variable named retryCount in the while loop condition better than a variable called shouldServerErrorRetry... With the retryCount it is immediately obvious, that we will retry sending the same request for some times... shouldServerErrorRetry does not really give that much information.\nI recommend:\nLeave the retryCount <= MAX_RETRIES in the while loop.\nEven better, get rid of the while loop and replace it with a for (int retryCount = 0; retryCount <= MAX_RETRIES; retryCount++).\nThat explains so much better what is happening here than a local variable that is changed somewhere else.", "author": "andirayo", "createdAt": "2020-09-24T02:41:20Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -158,15 +162,17 @@ public InstallationResponse createFirebaseInstallation(\n         writeFIDCreateRequestBodyToOutputStream(httpURLConnection, fid, appId);\n \n         int httpResponseCode = httpURLConnection.getResponseCode();\n+        requestLimiter.setNextRequestTime(httpResponseCode);\n \n         if (httpResponseCode == 200) {\n           return readCreateResponse(httpURLConnection);\n         }\n \n         logFisCommunicationError(httpURLConnection, appId, apiKey, projectID);\n \n-        if (httpResponseCode == 429 || (httpResponseCode >= 500 && httpResponseCode < 600)) {\n+        if (httpResponseCode >= 500 && httpResponseCode < 600) {\n           retryCount++;\n+          shouldServerErrorRetry = retryCount <= MAX_RETRIES;", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MTM0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r496261347", "bodyText": "Changed it . PTAL.", "author": "ankitaj224", "createdAt": "2020-09-28T22:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTQ0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494005441", "bodyText": "What happened to 429?\nWe logBadConfigError for that status now?\nIf that is the case, I think it's not correct.", "author": "andirayo", "createdAt": "2020-09-24T02:41:47Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -158,15 +162,17 @@ public InstallationResponse createFirebaseInstallation(\n         writeFIDCreateRequestBodyToOutputStream(httpURLConnection, fid, appId);\n \n         int httpResponseCode = httpURLConnection.getResponseCode();\n+        requestLimiter.setNextRequestTime(httpResponseCode);\n \n         if (httpResponseCode == 200) {\n           return readCreateResponse(httpURLConnection);\n         }\n \n         logFisCommunicationError(httpURLConnection, appId, apiKey, projectID);\n \n-        if (httpResponseCode == 429 || (httpResponseCode >= 500 && httpResponseCode < 600)) {\n+        if (httpResponseCode >= 500 && httpResponseCode < 600) {", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIyMjk2MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r496222960", "bodyText": "Oh right. Changed it to throw an exception on 429.", "author": "ankitaj224", "createdAt": "2020-09-28T20:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTc5Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494005792", "bodyText": "This obviously seemed to have worked in the past, but maybe it's better we check for a successful code here?\nI'm not sure, but I think the FIS server responds with 201 in case of a successful registatration.", "author": "andirayo", "createdAt": "2020-09-24T02:43:17Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/FirebaseInstallationServiceClient.java", "diffHunk": "@@ -158,15 +162,17 @@ public InstallationResponse createFirebaseInstallation(\n         writeFIDCreateRequestBodyToOutputStream(httpURLConnection, fid, appId);\n \n         int httpResponseCode = httpURLConnection.getResponseCode();\n+        requestLimiter.setNextRequestTime(httpResponseCode);\n \n         if (httpResponseCode == 200) {", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTkyMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r494005923", "bodyText": "camel case:\nisSuccessfulOrRequiresNewFidCreation", "author": "andirayo", "createdAt": "2020-09-24T02:43:50Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/remote/RequestLimiter.java", "diffHunk": "@@ -45,7 +45,7 @@\n   // Based on the response code, calculates the next request time to communicate with the FIS\n   // servers.\n   public synchronized void setNextRequestTime(int responseCode) {\n-    if (isSuccessful(responseCode)) {\n+    if (isSuccessfulOrRequiresNewFIDCreation(responseCode)) {", "originalCommit": "f18cb66e23584ff7f5d163876b5c5c8c5d7bbf59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2033ccd9bdc218ccfac6dbae63f34957b03769c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/2033ccd9bdc218ccfac6dbae63f34957b03769c2", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into enableRequestLimiter", "committedDate": "2020-09-28T17:59:17Z", "type": "commit"}, {"oid": "6d6b7c319fbe1dd443e00d5bdb89057da9c66ec2", "url": "https://github.com/firebase/firebase-android-sdk/commit/6d6b7c319fbe1dd443e00d5bdb89057da9c66ec2", "message": "Addressing Rayo's comments.", "committedDate": "2020-09-28T21:06:36Z", "type": "commit"}, {"oid": "bb37ff1d01901ae7c1e6b86fb120f9664c8fd87b", "url": "https://github.com/firebase/firebase-android-sdk/commit/bb37ff1d01901ae7c1e6b86fb120f9664c8fd87b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into enableRequestLimiter", "committedDate": "2020-09-29T20:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxNzU2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r497817568", "bodyText": "Please avoid code duplication:\npublic static Utils getInstance() {\n  return getInstance(SystemClock.getInstance());\n}", "author": "andirayo", "createdAt": "2020-09-30T21:42:24Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -31,11 +32,28 @@\n   public static final long AUTH_TOKEN_EXPIRATION_BUFFER_IN_SECS = TimeUnit.HOURS.toSeconds(1);\n   private static final String APP_ID_IDENTIFICATION_SUBSTRING = \":\";\n   private static final Pattern API_KEY_FORMAT = Pattern.compile(\"\\\\AA[\\\\w-]{38}\\\\z\");\n+  private static Utils singleton;\n   private final Clock clock;\n \n-  Utils(Clock clock) {\n+  private Utils(Clock clock) {\n     this.clock = clock;\n   }\n+\n+  // Factory method that always returns the same Utils instance.\n+  public static Utils getInstance() {\n+    if (singleton == null) {\n+      singleton = new Utils(SystemClock.getInstance());\n+    }\n+    return singleton;", "originalCommit": "bb37ff1d01901ae7c1e6b86fb120f9664c8fd87b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxNzk1MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2003#discussion_r497817950", "bodyText": "Please add JavaDoc, that the first call will define the Clock used.\nIf a Utils instance has already been initialized, the parameter will be ignored and the old instance will be returned.", "author": "andirayo", "createdAt": "2020-09-30T21:43:11Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -31,11 +32,28 @@\n   public static final long AUTH_TOKEN_EXPIRATION_BUFFER_IN_SECS = TimeUnit.HOURS.toSeconds(1);\n   private static final String APP_ID_IDENTIFICATION_SUBSTRING = \":\";\n   private static final Pattern API_KEY_FORMAT = Pattern.compile(\"\\\\AA[\\\\w-]{38}\\\\z\");\n+  private static Utils singleton;\n   private final Clock clock;\n \n-  Utils(Clock clock) {\n+  private Utils(Clock clock) {\n     this.clock = clock;\n   }\n+\n+  // Factory method that always returns the same Utils instance.\n+  public static Utils getInstance() {\n+    if (singleton == null) {\n+      singleton = new Utils(SystemClock.getInstance());\n+    }\n+    return singleton;\n+  }\n+\n+  public static Utils getTestInstance(Clock clock) {", "originalCommit": "bb37ff1d01901ae7c1e6b86fb120f9664c8fd87b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22668895a8d119139b1fb2b439128c1c2f8b013e", "url": "https://github.com/firebase/firebase-android-sdk/commit/22668895a8d119139b1fb2b439128c1c2f8b013e", "message": "Addressing rayo's comments", "committedDate": "2020-10-02T18:23:53Z", "type": "commit"}, {"oid": "46726cbd0dedd5b5e739ef6789f005e12ee70117", "url": "https://github.com/firebase/firebase-android-sdk/commit/46726cbd0dedd5b5e739ef6789f005e12ee70117", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into enableRequestLimiter", "committedDate": "2020-10-02T18:25:50Z", "type": "commit"}, {"oid": "91ca982fabe496a0802fc9029ad9a746d574a7a8", "url": "https://github.com/firebase/firebase-android-sdk/commit/91ca982fabe496a0802fc9029ad9a746d574a7a8", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into enableRequestLimiter", "committedDate": "2020-10-05T17:57:25Z", "type": "commit"}]}