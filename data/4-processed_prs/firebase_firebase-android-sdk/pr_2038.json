{"pr_number": 2038, "pr_title": "Make `ComponentRuntime` mutable.", "pr_createdAt": "2020-10-05T14:40:45Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2038", "timeline": [{"oid": "d9348ac1586539dc9aeb1bdf61145703cd7a0bf6", "url": "https://github.com/firebase/firebase-android-sdk/commit/d9348ac1586539dc9aeb1bdf61145703cd7a0bf6", "message": "Make `ComponentRuntime` mutable.\n\nThis is done in preparation for dynamic module loading support.\n\nThe gist of the change is to make:\n\n* Missing optional dependencies backed by \"empty\" providers. That can be\n  mutated at runtime to start returning non-null values if dependencies\n  become available\n* Set components backed by thread-safe `Set`s that can be extended with\n  newly loaded dependencies.", "committedDate": "2020-10-05T14:30:40Z", "type": "commit"}, {"oid": "4e0dac20b22cca439aa182df8d37c1c9888ae83c", "url": "https://github.com/firebase/firebase-android-sdk/commit/4e0dac20b22cca439aa182df8d37c1c9888ae83c", "message": "Fix auth not to make assumption that Providers always return non null values.", "committedDate": "2020-10-05T15:15:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4MzcwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2038#discussion_r501083707", "bodyText": "shouldn't this be Provider<LazySet<?>> ?", "author": "rlazo", "createdAt": "2020-10-07T14:59:44Z", "path": "firebase-components/src/main/java/com/google/firebase/components/LazySet.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.components;\n+\n+import com.google.firebase.inject.Provider;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Lazy mutable thread-safe {@link Provider} for {@link Set}s.\n+ *\n+ * <p>The actual set is materialized only when first requested via {@link #get()}.\n+ *\n+ * <p>As new values are added to the set via {@link #add(Provider)}, the underlying set is updated\n+ * with the new value.\n+ */\n+class LazySet<T> implements Provider<Set<T>> {\n+\n+  private volatile Set<Provider<T>> providers;\n+  private volatile Set<T> actualSet = null;\n+\n+  LazySet(Collection<Provider<T>> providers) {\n+    this.providers = Collections.newSetFromMap(new ConcurrentHashMap<>());\n+    this.providers.addAll(providers);\n+  }\n+\n+  static Provider<Set<?>> fromCollection(Collection<Provider<?>> providers) {", "originalCommit": "4e0dac20b22cca439aa182df8d37c1c9888ae83c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzNDYzMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2038#discussion_r501134633", "bodyText": "No because LazySet<T> is a Provider<Set<T>> and does not implement Set<T> itself", "author": "vkryachko", "createdAt": "2020-10-07T16:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4MzcwNw=="}], "type": "inlineReview"}]}