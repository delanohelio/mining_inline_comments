{"pr_number": 2236, "pr_title": "Delete model", "pr_createdAt": "2020-12-07T20:45:22Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2236", "timeline": [{"oid": "e8eb9b9dc880692d040fc52016fb5d0bbe6e4b35", "url": "https://github.com/firebase/firebase-android-sdk/commit/e8eb9b9dc880692d040fc52016fb5d0bbe6e4b35", "message": "Reviewer suggested changes.", "committedDate": "2020-12-07T20:24:17Z", "type": "commit"}, {"oid": "3b30492c1b1a4a56ac4fec0da7c73d621155678c", "url": "https://github.com/firebase/firebase-android-sdk/commit/3b30492c1b1a4a56ac4fec0da7c73d621155678c", "message": "Add code for custom model deletion from a device.", "committedDate": "2020-12-07T20:28:50Z", "type": "commit"}, {"oid": "f18a918759eaadb8abe258587f26722295a0ddfd", "url": "https://github.com/firebase/firebase-android-sdk/commit/f18a918759eaadb8abe258587f26722295a0ddfd", "message": "Add code for custom model deletion from a device.", "committedDate": "2020-12-07T21:38:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzA4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r537877083", "bodyText": "In case the app crashes, or the phone dies, after models have been deleted but before their details have been removed from sharedPreferences, what would happen?", "author": "rlazo", "createdAt": "2020-12-07T22:21:18Z", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/FirebaseModelDownloader.java", "diffHunk": "@@ -187,7 +192,16 @@ public static FirebaseModelDownloader getInstance(@NonNull FirebaseApp app) {\n    */\n   @NonNull\n   public Task<Void> deleteDownloadedModel(@NonNull String modelName) {\n-    throw new UnsupportedOperationException(\"Not yet implemented.\");\n+\n+    TaskCompletionSource<Void> taskCompletionSource = new TaskCompletionSource<>();\n+    executor.execute(\n+        () -> {\n+          // remove all files associated with this model and then clean up model references.\n+          fileManager.deleteAllModels(modelName);", "originalCommit": "f18a918759eaadb8abe258587f26722295a0ddfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyNDI2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r538824265", "bodyText": "The model would be listed but when they tried to get the file it would return null... I think this is acceptable. I did update the getFile to handle this case a little more cleanly. If you can think of a better solution. I'm open to suggestions. I've also made a bug b/175144342 to add a start-up routine that will check that models with filePaths actually point to files and will clean them up if they don't.", "author": "annzimmer", "createdAt": "2020-12-08T21:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk1NjAxMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r538956010", "bodyText": "LGTM", "author": "rlazo", "createdAt": "2020-12-09T02:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3Nzg2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r537877861", "bodyText": "Intentional?", "author": "rlazo", "createdAt": "2020-12-07T22:22:26Z", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/ModelFileManager.java", "diffHunk": "@@ -118,6 +126,21 @@ private int getLatestCachedModelVersion(@NonNull File modelDir) {\n   @Nullable\n   File getModelFileDestination(@NonNull CustomModel model) throws Exception {\n     File destFolder = getDirImpl(model.getName());\n+    if (!destFolder.exists()) {\n+      Log.d(TAG, \"model folder does not exist, creating one: \" + destFolder.getAbsolutePath());\n+      if (!destFolder.mkdirs()) {\n+        System.out.println(\"Failed to create model folder\" + destFolder);\n+        //        throw new FirebaseMLException(", "originalCommit": "f18a918759eaadb8abe258587f26722295a0ddfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyNDMyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r538824320", "bodyText": "yes - the logging which will be the commented out lines is currently being tested. Almost there.", "author": "annzimmer", "createdAt": "2020-12-08T21:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3Nzg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk1NjMzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2236#discussion_r538956332", "bodyText": "Sure. Ping me when they're done so I can do a last review before granting approval. Thanks!", "author": "rlazo", "createdAt": "2020-12-09T02:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3Nzg2MQ=="}], "type": "inlineReview"}, {"oid": "734a39745d3bf8c7fedadba93ec94c3384cadbad", "url": "https://github.com/firebase/firebase-android-sdk/commit/734a39745d3bf8c7fedadba93ec94c3384cadbad", "message": "Update getFile so it checks if the file exists before returning.", "committedDate": "2020-12-08T19:42:16Z", "type": "commit"}, {"oid": "319ec2954421ec44d422847b4d0f14bc805e8d93", "url": "https://github.com/firebase/firebase-android-sdk/commit/319ec2954421ec44d422847b4d0f14bc805e8d93", "message": "Adding logging todo.", "committedDate": "2020-12-11T15:40:04Z", "type": "commit"}, {"oid": "fd19c30437a38a1ffd7afabd53c6676740b263ab", "url": "https://github.com/firebase/firebase-android-sdk/commit/fd19c30437a38a1ffd7afabd53c6676740b263ab", "message": "Adding logging todo.", "committedDate": "2020-12-11T15:44:48Z", "type": "commit"}]}