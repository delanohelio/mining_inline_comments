{"pr_number": 1872, "pr_title": "Add != and NOT_IN queries (not public)", "pr_createdAt": "2020-08-10T22:04:43Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1872", "timeline": [{"oid": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "url": "https://github.com/firebase/firebase-android-sdk/commit/c5ffda3f244bd18b4558eb7f3463f923404ba04c", "message": "add != and NOT_IN support\n\noops", "committedDate": "2020-08-11T16:12:46Z", "type": "commit"}, {"oid": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "url": "https://github.com/firebase/firebase-android-sdk/commit/c5ffda3f244bd18b4558eb7f3463f923404ba04c", "message": "add != and NOT_IN support\n\noops", "committedDate": "2020-08-11T16:12:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0MjYyNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469542625", "bodyText": "This name doesn't seem right. Neither argument is an array and the ordered-container property of arrays is explicitly ignored in the implementation.\nassertSetEquals above are essentially asserting the two containers are equal without regard for ordering. I think you probably could use the same name here, since that's what you're doing.\nHowever, I think you can combine this with the one above. Make it:\npublic static <T> void assertSetEquals(Iterable<T> expected, Iterable<T> actual) {\n  Set<T> expectedSet = Sets.newHashSet(expected);\n  Set<T> actualSet = Sets.newHashSet(actual);\n  assertEquals(expectedSet, actualSet);\n}\nThis has the added benefit of allowing Collection<T> to be passed as an argument directly, which will eliminate all the Lists.newArrayList in your callers.", "author": "wilhuff", "createdAt": "2020-08-12T20:57:57Z", "path": "firebase-firestore/src/testUtil/java/com/google/firebase/firestore/testutil/TestUtil.java", "diffHunk": "@@ -607,6 +611,18 @@ public static ByteString streamToken(String contents) {\n     assertEquals(expectedSet, actual);\n   }\n \n+  /**\n+   * Asserts that the contents of actual list is equal to that of the expected one.\n+   *\n+   * @param expected A list of the expected contents of the set, in any order.\n+   * @param actual The list to compare against.\n+   * @param <T> The type of the values of in common between the expected list and actual set.\n+   */\n+  // PORTING NOTE: JUnit and XCTest use reversed conventions on expected and actual values :-(.\n+  public static <T> void assertArrayEquals(List<T> expected, List<T> actual) {", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5NTk0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470295946", "bodyText": "Done. Thanks for the explanation!", "author": "thebrianchen", "createdAt": "2020-08-13T23:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0MjYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0MzAyMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469543023", "bodyText": "As noted on assertArrayEquals, remove this Lists.newArrayList, here and throughout.", "author": "wilhuff", "createdAt": "2020-08-12T20:58:40Z", "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/QueryTest.java", "diffHunk": "@@ -483,6 +487,83 @@ public void testQueriesFireFromCacheWhenOffline() {\n     listener.remove();\n   }\n \n+  // TODO(ne-queries): Re-enable once emulator support is added to CI.\n+  @Ignore\n+  @Test\n+  public void testQueriesCanUseNotEqualFilters() {\n+    Map<String, Object> docA = map(\"zip\", 98101L);\n+    Map<String, Object> docB = map(\"zip\", 91102L);\n+    Map<String, Object> docC = map(\"zip\", \"98101\");\n+    Map<String, Object> docD = map(\"zip\", asList(98101L));\n+    Map<String, Object> docE = map(\"zip\", asList(\"98101\", map(\"zip\", 98101L)));\n+    Map<String, Object> docF = map(\"zip\", map(\"code\", 500L));\n+    Map<String, Object> docG = map(\"zip\", asList(98101L, 98102L));\n+    Map<String, Object> docH = map(\"code\", 500L);\n+    Map<String, Object> docI = map(\"zip\", null);\n+    Map<String, Object> docJ = map(\"zip\", Double.NaN);\n+\n+    Map<String, Map<String, Object>> allDocs =\n+        map(\n+            \"a\", docA, \"b\", docB, \"c\", docC, \"d\", docD, \"e\", docE, \"f\", docF, \"g\", docG, \"h\", docH,\n+            \"i\", docI, \"j\", docJ);\n+    CollectionReference collection = testCollectionWithDocs(allDocs);\n+\n+    // Search for zips not matching 98101.\n+    Map<String, Map<String, Object>> expectedDocsMap = Maps.newHashMap(allDocs);\n+    expectedDocsMap.remove(\"a\");\n+    expectedDocsMap.remove(\"h\");\n+    expectedDocsMap.remove(\"i\");\n+\n+    QuerySnapshot snapshot = waitFor(collection.whereNotEqualTo(\"zip\", 98101L).get());\n+    assertArrayEquals(\n+        Lists.newArrayList(expectedDocsMap.values()), querySnapshotToValues(snapshot));", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5NjAwNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470296005", "bodyText": "Removed here and throughout.", "author": "thebrianchen", "createdAt": "2020-08-13T23:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0MzAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NTc2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469575768", "bodyText": "To make a list use\n<ol>\n<li>Only one array operator ...\n<li>One one disjunctive ...\n</ol>", "author": "wilhuff", "createdAt": "2020-08-12T22:12:27Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/Query.java", "diffHunk": "@@ -445,15 +520,44 @@ private void validateOrderByFieldMatchesInequality(\n     }\n   }\n \n+  /**\n+   * Given an operator, returns the set of operators that cannot be used with it.\n+   *\n+   * <p>Operators in a query must adhere to the following set of rules: 1. Only one array operator", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5MzE5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470293194", "bodyText": "done.", "author": "thebrianchen", "createdAt": "2020-08-13T22:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MjgyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470372821", "bodyText": "The list wrapper element is required (<ol> indicates an ordered list (aka numbered); use <ul> for unordered (aka bulleted)).", "author": "wilhuff", "createdAt": "2020-08-14T02:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyMDUwNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470720505", "bodyText": "Done for reals.", "author": "thebrianchen", "createdAt": "2020-08-14T16:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NTc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4MDU5NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469580595", "bodyText": "Operator must already be imported here (see references to Operator.ARRAY_CONTAINS) so you can drop the Filter in Filter.Operator.", "author": "wilhuff", "createdAt": "2020-08-12T22:24:42Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/FieldFilter.java", "diffHunk": "@@ -64,20 +64,24 @@ public static FieldFilter create(FieldPath path, Operator operator, Value value)\n     if (path.isKeyField()) {\n       if (operator == Operator.IN) {\n         return new KeyFieldInFilter(path, value);\n+      } else if (operator == Operator.NOT_IN) {\n+        return new KeyFieldNotInFilter(path, value);\n       } else {\n         hardAssert(\n             operator != Operator.ARRAY_CONTAINS && operator != Operator.ARRAY_CONTAINS_ANY,\n             operator.toString() + \"queries don't make sense on document keys\");\n         return new KeyFieldFilter(path, operator, value);\n       }\n     } else if (Values.isNullValue(value)) {\n-      if (operator != Filter.Operator.EQUAL) {\n+      // TODO(ne-queries): Update error message to include != operator.\n+      if (operator != Filter.Operator.EQUAL && operator != Filter.Operator.NOT_EQUAL) {", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5MzQwNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470293404", "bodyText": "done.", "author": "thebrianchen", "createdAt": "2020-08-13T22:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4MDU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4MTU0MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469581540", "bodyText": "2020", "author": "wilhuff", "createdAt": "2020-08-12T22:27:03Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/KeyFieldNotInFilter.java", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright 2019 Google LLC", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5MzQyNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470293424", "bodyText": "done.", "author": "thebrianchen", "createdAt": "2020-08-13T22:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4MTU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4Mjc3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r469582774", "bodyText": "This isn't likely to be a widely used or general utility. Better to make this a package private static member of e.g. KeyFieldInFilter and just call it from the other one.\n(Another clue that this doesn't belong here is that you're referring to KeyFieldInFilter in the error message. This is therefore pretty specific to those classes.)", "author": "wilhuff", "createdAt": "2020-08-12T22:30:20Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/util/Util.java", "diffHunk": "@@ -234,4 +240,22 @@ public static int compareByteStrings(ByteString left, ByteString right) {\n     }\n     return Util.compareIntegers(left.size(), right.size());\n   }\n+\n+  public static List<DocumentKey> extractDocumentKeysFromArrayValue(", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI5NDAwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470294007", "bodyText": "Done. Thanks for pointing out the code smell, that's a helpful check I'll keep in mind.", "author": "thebrianchen", "createdAt": "2020-08-13T22:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4Mjc3NA=="}], "type": "inlineReview"}, {"oid": "025ef85305cb25e8646737d0a910b3106eee88bb", "url": "https://github.com/firebase/firebase-android-sdk/commit/025ef85305cb25e8646737d0a910b3106eee88bb", "message": "resolve gil comments", "committedDate": "2020-08-13T23:08:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTY2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470371661", "bodyText": "Apologies for what's going to be an irritating question (since I didn't pick up on this earlier), but why do you assertSetEquals(x, expected) in the test above but assertEquals(asList(x), expected) here when we're testing the same underlying operator?\nTo me it seems like either the ordering matters or it doesn't. If ordering of query results is predictable, assertSetEquals seems wrong because it allows the result to be unordered when our customers really care that it's ordered. The reverse is also true: if ordering doesn't matter, then this test is too strict, and could create a false positive.\nTo my understanding, query results always have a well defined ordering (breaking ties on key ordering). This seems to point to assertSetEquals being wrong above.\nWhat's your take on this? Why the discrepancy?\n(The same concern applies to the whereNotIn, below).", "author": "wilhuff", "createdAt": "2020-08-14T02:10:16Z", "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/QueryTest.java", "diffHunk": "@@ -483,6 +486,79 @@ public void testQueriesFireFromCacheWhenOffline() {\n     listener.remove();\n   }\n \n+  // TODO(ne-queries): Re-enable once emulator support is added to CI.\n+  @Ignore\n+  @Test\n+  public void testQueriesCanUseNotEqualFilters() {\n+    Map<String, Object> docA = map(\"zip\", 98101L);\n+    Map<String, Object> docB = map(\"zip\", 91102L);\n+    Map<String, Object> docC = map(\"zip\", \"98101\");\n+    Map<String, Object> docD = map(\"zip\", asList(98101L));\n+    Map<String, Object> docE = map(\"zip\", asList(\"98101\", map(\"zip\", 98101L)));\n+    Map<String, Object> docF = map(\"zip\", map(\"code\", 500L));\n+    Map<String, Object> docG = map(\"zip\", asList(98101L, 98102L));\n+    Map<String, Object> docH = map(\"code\", 500L);\n+    Map<String, Object> docI = map(\"zip\", null);\n+    Map<String, Object> docJ = map(\"zip\", Double.NaN);\n+\n+    Map<String, Map<String, Object>> allDocs =\n+        map(\n+            \"a\", docA, \"b\", docB, \"c\", docC, \"d\", docD, \"e\", docE, \"f\", docF, \"g\", docG, \"h\", docH,\n+            \"i\", docI, \"j\", docJ);\n+    CollectionReference collection = testCollectionWithDocs(allDocs);\n+\n+    // Search for zips not matching 98101.\n+    Map<String, Map<String, Object>> expectedDocsMap = Maps.newHashMap(allDocs);\n+    expectedDocsMap.remove(\"a\");\n+    expectedDocsMap.remove(\"h\");\n+    expectedDocsMap.remove(\"i\");\n+\n+    QuerySnapshot snapshot = waitFor(collection.whereNotEqualTo(\"zip\", 98101L).get());\n+    assertSetEquals(expectedDocsMap.values(), querySnapshotToValues(snapshot));\n+\n+    // With objects.\n+    expectedDocsMap = Maps.newHashMap(allDocs);\n+    expectedDocsMap.remove(\"f\");\n+    expectedDocsMap.remove(\"h\");\n+    expectedDocsMap.remove(\"i\");\n+    snapshot = waitFor(collection.whereNotEqualTo(\"zip\", map(\"code\", 500)).get());\n+    assertSetEquals(expectedDocsMap.values(), querySnapshotToValues(snapshot));\n+\n+    // With Null.\n+    expectedDocsMap = Maps.newHashMap(allDocs);\n+    expectedDocsMap.remove(\"h\");\n+    expectedDocsMap.remove(\"i\");\n+    snapshot = waitFor(collection.whereNotEqualTo(\"zip\", null).get());\n+    assertSetEquals(expectedDocsMap.values(), querySnapshotToValues(snapshot));\n+\n+    // With NaN.\n+    expectedDocsMap = Maps.newHashMap(allDocs);\n+    expectedDocsMap.remove(\"h\");\n+    expectedDocsMap.remove(\"i\");\n+    expectedDocsMap.remove(\"j\");\n+    snapshot = waitFor(collection.whereNotEqualTo(\"zip\", Double.NaN).get());\n+    assertSetEquals(expectedDocsMap.values(), querySnapshotToValues(snapshot));\n+  }\n+\n+  // TODO(ne-queries): Re-enable once emulator support is added to CI.\n+  @Ignore\n+  @Test\n+  public void testQueriesCanUseNotEqualFiltersWithDocIds() {\n+    Map<String, String> docA = map(\"key\", \"aa\");\n+    Map<String, String> docB = map(\"key\", \"ab\");\n+    Map<String, String> docC = map(\"key\", \"ba\");\n+    Map<String, String> docD = map(\"key\", \"bb\");\n+    Map<String, Map<String, Object>> testDocs =\n+        map(\n+            \"aa\", docA,\n+            \"ab\", docB,\n+            \"ba\", docC,\n+            \"bb\", docD);\n+    CollectionReference collection = testCollectionWithDocs(testDocs);\n+    QuerySnapshot docs = waitFor(collection.whereNotEqualTo(FieldPath.documentId(), \"aa\").get());\n+    assertEquals(asList(docB, docC, docD), querySnapshotToValues(docs));", "originalCommit": "025ef85305cb25e8646737d0a910b3106eee88bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcxOTg0Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470719843", "bodyText": "Thanks for catching this actually! I originally ran into an issue where I was converting the snapshots into a HashSet in order to easily remove the unneeded documents, but converting them back into a List resulted in an ordering that didn't match the query snapshots from the query. Instead of trying to create the expectedDocsMap in the correct order, I took the \"shortcut\" of comparing them as sets to avoid the ordering errors without realizing that order matters in query results.\nI took a look at the code, and realized that Using Maps.newHashMap() keeps the documents in the correct order. Switched back to using assertEquals with Lists.newArrayList().", "author": "thebrianchen", "createdAt": "2020-08-14T16:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3NjAyMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470376022", "bodyText": "2020 here too", "author": "wilhuff", "createdAt": "2020-08-14T02:29:25Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/NotInFilter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+// Copyright 2019 Google LLC", "originalCommit": "c5ffda3f244bd18b4558eb7f3463f923404ba04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcxOTg5Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1872#discussion_r470719892", "bodyText": "done.", "author": "thebrianchen", "createdAt": "2020-08-14T16:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3NjAyMg=="}], "type": "inlineReview"}, {"oid": "cc4397bcef343a007c8e1f9daefcc3adeddc9752", "url": "https://github.com/firebase/firebase-android-sdk/commit/cc4397bcef343a007c8e1f9daefcc3adeddc9752", "message": "switch back to Lists.newArrayList() and remove assertSetEquals override", "committedDate": "2020-08-14T16:12:25Z", "type": "commit"}]}