{"pr_number": 1319, "pr_title": "Make binary size report format compatible with the metrics service.", "pr_createdAt": "2020-03-06T02:36:03Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1319", "timeline": [{"oid": "8201b10cdafba8991f9481769c0a0906da73cb35", "url": "https://github.com/firebase/firebase-android-sdk/commit/8201b10cdafba8991f9481769c0a0906da73cb35", "message": "Make binary size report format compatible with the metrics service.", "committedDate": "2020-03-06T06:58:38Z", "type": "forcePushed"}, {"oid": "5b26e6ae27a304e2723be896e90eb1da2085f21b", "url": "https://github.com/firebase/firebase-android-sdk/commit/5b26e6ae27a304e2723be896e90eb1da2085f21b", "message": "Make binary size report compatible with the metrics service.", "committedDate": "2020-03-06T07:48:25Z", "type": "forcePushed"}, {"oid": "78cc9d13991e7af720452da7f7236a1f7d5163c6", "url": "https://github.com/firebase/firebase-android-sdk/commit/78cc9d13991e7af720452da7f7236a1f7d5163c6", "message": "Make binary size report compatible with the metrics service.", "committedDate": "2020-03-06T08:39:11Z", "type": "forcePushed"}, {"oid": "23f526467ea719f0131d3ec251f89750818b639b", "url": "https://github.com/firebase/firebase-android-sdk/commit/23f526467ea719f0131d3ec251f89750818b639b", "message": "Make binary size report compatible with the metrics service.", "committedDate": "2020-03-06T10:15:20Z", "type": "forcePushed"}, {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "url": "https://github.com/firebase/firebase-android-sdk/commit/9305ba085f7fc4ad695a651564c498dc95d32ec6", "message": "Make binary size report compatible with the metrics service.", "committedDate": "2020-03-06T10:33:00Z", "type": "commit"}, {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "url": "https://github.com/firebase/firebase-android-sdk/commit/9305ba085f7fc4ad695a651564c498dc95d32ec6", "message": "Make binary size report compatible with the metrics service.", "committedDate": "2020-03-06T10:33:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDUxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389064518", "bodyText": "Reverse the logic to reduce nesting\nif (!system.getenv...) {\nproject.logger.quiet\nreturn ?\n} \n...\n\nthe continue with the rest of the code", "author": "rlazo", "createdAt": "2020-03-06T18:18:45Z", "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {", "originalCommit": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMTY0MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389921641", "bodyText": "Done.", "author": "yifanyang", "createdAt": "2020-03-09T19:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDg2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389064863", "bodyText": "this post happens even if the CI is not prow", "author": "rlazo", "createdAt": "2020-03-06T18:19:27Z", "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {\n+            project.logger.quiet \"Prow CI detected.\"\n+\n+            owner = System.getenv(\"REPO_OWNER\")\n+            repo = System.getenv(\"REPO_NAME\")\n+            baseCommit = System.getenv(\"PULL_BASE_SHA\")\n+            headCommit = System.getenv(\"PULL_PULL_SHA\") ?: baseCommit\n+            pullRequest = System.getenv(\"PULL_NUMBER\")\n+        } else {\n+            project.logger.quiet \"CI other than Prow is not supported currently.\"\n+        }\n+\n+        post(project, report, owner, repo, headCommit, baseCommit, pullRequest)", "originalCommit": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMTY4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389921682", "bodyText": "Fixed. Previously in case of non-Prow CI, the post request will be sent and fail silently; now it will not be sent at all.", "author": "yifanyang", "createdAt": "2020-03-09T19:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NTc1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389065758", "bodyText": "I'm not 100% sure that relying in curl for this is the best option, but I'll not object it.", "author": "rlazo", "createdAt": "2020-03-06T18:21:22Z", "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {\n+            project.logger.quiet \"Prow CI detected.\"\n+\n+            owner = System.getenv(\"REPO_OWNER\")\n+            repo = System.getenv(\"REPO_NAME\")\n+            baseCommit = System.getenv(\"PULL_BASE_SHA\")\n+            headCommit = System.getenv(\"PULL_PULL_SHA\") ?: baseCommit\n+            pullRequest = System.getenv(\"PULL_NUMBER\")\n+        } else {\n+            project.logger.quiet \"CI other than Prow is not supported currently.\"\n+        }\n+\n+        post(project, report, owner, repo, headCommit, baseCommit, pullRequest)\n+    }\n+\n+    private static void post(Project project, String report, String owner, String repo,\n+                             String commit, String baseCommit, String pullRequest) {\n+        def post = '-X POST'\n+        def headerAuth = '-H \"Authorization: Bearer $(gcloud auth print-identity-token)\"'\n+        def headerContentType = '-H \"Content-Type: application/json\"'\n+        def body = \"-d @${report}\"\n+\n+        def endpoint = \"${METRICS_SERVICE_URL}/repos/${owner}/${repo}/commits/${commit}/reports\"\n+        if (baseCommit && pullRequest) {\n+            endpoint += \"?base_commit=${baseCommit}&pull_request=${pullRequest}\"\n+        }\n+\n+        def request = \"curl ${post} ${headerAuth} ${headerContentType} ${body} \\\"${endpoint}\\\"\"\n+\n+        project.logger.quiet \"Making post request: ${request} ...\"\n+\n+        project.exec {\n+            commandLine 'bash', '-c', request", "originalCommit": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMTcyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389921728", "bodyText": "I agree with your concern. The best option is probably to sent the request programatically.\nMy thinking is that this request needs an authentication header, which comes from running gcloud auth print-identity-token. There doesn't seem to be a way to run gcloud command programatically, so seems like some shell command is unavoidable. Also this part of code will only be run on CI (it will be skipped when running locally), and we have control over the container image, then it should be fine.\nI can change to use some java http client if you prefer that way.", "author": "yifanyang", "createdAt": "2020-03-09T19:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NjU4Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389066587", "bodyText": "nit: generateCurrentLogLink sounds like a better fit since you are generating the url, but it's a matter of style.", "author": "rlazo", "createdAt": "2020-03-06T18:23:08Z", "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/TestLogFinder.groovy", "diffHunk": "@@ -0,0 +1,48 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+/** A utility class that finds test log links on different CI systems. */\n+class TestLogFinder {\n+\n+    /** Returns the link to the current running test. */\n+    static String getCurrentLogLink() {", "originalCommit": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMjAyNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389922024", "bodyText": "Done. Changed to generateCurrentLogLink.", "author": "yifanyang", "createdAt": "2020-03-09T19:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NjU4Nw=="}], "type": "inlineReview"}, {"oid": "53c85666e29c72a01beb7fee7b84877c7551a2f0", "url": "https://github.com/firebase/firebase-android-sdk/commit/53c85666e29c72a01beb7fee7b84877c7551a2f0", "message": "Rewrite newly added groovy files in java.", "committedDate": "2020-03-06T20:28:05Z", "type": "forcePushed"}, {"oid": "a70552cba5d7f62fc6b0b26185aa280fae088d16", "url": "https://github.com/firebase/firebase-android-sdk/commit/a70552cba5d7f62fc6b0b26185aa280fae088d16", "message": "Rewrite newly added groovy files in java.", "committedDate": "2020-03-06T20:39:46Z", "type": "forcePushed"}, {"oid": "b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "url": "https://github.com/firebase/firebase-android-sdk/commit/b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "message": "Rewrite newly added groovy files in java.", "committedDate": "2020-03-09T19:02:44Z", "type": "forcePushed"}, {"oid": "e8b422ac8ee62908eff778bc3db6567557cdc152", "url": "https://github.com/firebase/firebase-android-sdk/commit/e8b422ac8ee62908eff778bc3db6567557cdc152", "message": "Rewrite newly added groovy files in java.", "committedDate": "2020-03-09T19:27:16Z", "type": "commit"}, {"oid": "e8b422ac8ee62908eff778bc3db6567557cdc152", "url": "https://github.com/firebase/firebase-android-sdk/commit/e8b422ac8ee62908eff778bc3db6567557cdc152", "message": "Rewrite newly added groovy files in java.", "committedDate": "2020-03-09T19:27:16Z", "type": "forcePushed"}]}