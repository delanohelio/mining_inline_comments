{"pr_number": 1550, "pr_title": "Fix FIAM Display lifecycle interactions", "pr_createdAt": "2020-05-11T22:40:49Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1550", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMjEyNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423912125", "bodyText": "Can we add some comments on why we need to bind when this condition is true?", "author": "prakhar1989", "createdAt": "2020-05-12T17:33:55Z", "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -236,11 +221,42 @@ public void onActivityDestroyed(Activity activity) {\n   @Override\n   public void onActivityResumed(Activity activity) {\n     super.onActivityResumed(activity);\n+    bindFiamToActivity(activity);\n+  }\n+\n+  private void bindFiamToActivity(Activity activity) {\n+    if (!currentActivityName.equals(activity.getLocalClassName())) {", "originalCommit": "9cc749c622e5bb4320a41a7139e7f84f033987a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMjkxMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423912912", "bodyText": "Should we set this to null and add @Nullable annotation on this variable? I think an empty name can be error prone", "author": "prakhar1989", "createdAt": "2020-05-12T17:35:09Z", "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -236,11 +221,42 @@ public void onActivityDestroyed(Activity activity) {\n   @Override\n   public void onActivityResumed(Activity activity) {\n     super.onActivityResumed(activity);\n+    bindFiamToActivity(activity);\n+  }\n+\n+  private void bindFiamToActivity(Activity activity) {\n+    if (!currentActivityName.equals(activity.getLocalClassName())) {\n+      Logging.logi(\"Binding to activity: \" + activity.getLocalClassName());\n+      headlessInAppMessaging.setMessageDisplayComponent(\n+          (iam, cb) -> {\n+            // When we are in the middle of showing a message, we ignore other notifications these\n+            // messages will be fired when the corresponding events happen the next time.\n+            if (inAppMessage != null || headlessInAppMessaging.areMessagesSuppressed()) {\n+              Logging.logd(\"Active FIAM exists. Skipping trigger\");\n+              return;\n+            }\n+            inAppMessage = iam;\n+            callbacks = cb;\n+            showActiveFiam(activity);\n+          });\n+      // set the current activity to be the one passed in\n+      currentActivityName = activity.getLocalClassName();\n+    }\n     if (inAppMessage != null) {\n       showActiveFiam(activity);\n     }\n   }\n \n+  private void unbindFiamFromActivity(Activity activity) {\n+    if (currentActivityName.equals(activity.getLocalClassName())) {\n+      Logging.logi(\"Unbinding from activity: \" + activity.getLocalClassName());\n+      headlessInAppMessaging.clearDisplayListener();\n+      imageLoader.cancelTag(activity.getClass());\n+      removeDisplayedFiam(activity);\n+      currentActivityName = \"\";", "originalCommit": "9cc749c622e5bb4320a41a7139e7f84f033987a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzA3OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423913079", "bodyText": "nice ;)", "author": "prakhar1989", "createdAt": "2020-05-12T17:35:26Z", "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -318,8 +334,7 @@ public void onClick(View v) {\n \n     Map<Action, View.OnClickListener> actionListeners = new HashMap<>();\n     // If the message has an action, but not an action url, we dismiss when the action\n-    // button is\n-    // clicked;\n+    // button is clicked", "originalCommit": "9cc749c622e5bb4320a41a7139e7f84f033987a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "74b576b4062042bb9cd1a2cb3c625e16604860df", "url": "https://github.com/firebase/firebase-android-sdk/commit/74b576b4062042bb9cd1a2cb3c625e16604860df", "message": "fix display racecondition", "committedDate": "2020-05-12T18:34:20Z", "type": "commit"}, {"oid": "0dca9456df85c46ecfa39b4aead67daac31e6852", "url": "https://github.com/firebase/firebase-android-sdk/commit/0dca9456df85c46ecfa39b4aead67daac31e6852", "message": "format", "committedDate": "2020-05-12T18:34:24Z", "type": "commit"}, {"oid": "a833d0ed2c05f348537018a05d9a53e0b7e9c0e4", "url": "https://github.com/firebase/firebase-android-sdk/commit/a833d0ed2c05f348537018a05d9a53e0b7e9c0e4", "message": "<3", "committedDate": "2020-05-12T18:34:24Z", "type": "commit"}, {"oid": "b01c6a4ef6539949df3a3f0c43988a8d067dd9c6", "url": "https://github.com/firebase/firebase-android-sdk/commit/b01c6a4ef6539949df3a3f0c43988a8d067dd9c6", "message": "add api.txt", "committedDate": "2020-05-12T18:34:24Z", "type": "commit"}, {"oid": "83aeac55ce63be01ada30b829708a199c2677a2d", "url": "https://github.com/firebase/firebase-android-sdk/commit/83aeac55ce63be01ada30b829708a199c2677a2d", "message": "kk", "committedDate": "2020-05-12T18:34:24Z", "type": "commit"}, {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/b8aaa5508c1108a273009cae0a22b92c4a8856c2", "message": "Address comments", "committedDate": "2020-05-12T18:35:27Z", "type": "commit"}, {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/b8aaa5508c1108a273009cae0a22b92c4a8856c2", "message": "Address comments", "committedDate": "2020-05-12T18:35:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NTE3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423975173", "bodyText": "why do we need to bind from activity onstart and onresume? can't we just limit it to one place onResume?", "author": "eldhosembabu", "createdAt": "2020-05-12T19:19:44Z", "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -182,19 +184,7 @@ public void clearFiamListener() {\n   @Override\n   public void onActivityStarted(final Activity activity) {\n     super.onActivityStarted(activity);\n-    // Register FIAM listener with the headless sdk.\n-    headlessInAppMessaging.setMessageDisplayComponent(\n-        (iam, cb) -> {\n-          // When we are in the middle of showing a message, we ignore other notifications these\n-          // messages will be fired when the corresponding events happen the next time.\n-          if (inAppMessage != null || headlessInAppMessaging.areMessagesSuppressed()) {\n-            Logging.logd(\"Active FIAM exists. Skipping trigger\");\n-            return;\n-          }\n-          inAppMessage = iam;\n-          callbacks = cb;\n-          showActiveFiam(activity);\n-        });\n+    bindFiamToActivity(activity);", "originalCommit": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NTg1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423975859", "bodyText": "Similar to bind call, can we limit the unbind to a single place rather than having in onPause and onDestroy?", "author": "eldhosembabu", "createdAt": "2020-05-12T19:20:48Z", "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -205,10 +195,7 @@ public void onActivityStarted(final Activity activity) {\n   @Keep\n   @Override\n   public void onActivityPaused(Activity activity) {\n-    // clear all state scoped to activity and dismiss fiam\n-    headlessInAppMessaging.clearDisplayListener();\n-    imageLoader.cancelTag(activity.getClass());\n-    removeDisplayedFiam(activity);\n+    unbindFiamFromActivity(activity);", "originalCommit": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ecc6cf51ce7448cd3d69be01e3e37c37d1e69fd", "url": "https://github.com/firebase/firebase-android-sdk/commit/1ecc6cf51ce7448cd3d69be01e3e37c37d1e69fd", "message": "address comments", "committedDate": "2020-05-12T20:19:44Z", "type": "commit"}]}