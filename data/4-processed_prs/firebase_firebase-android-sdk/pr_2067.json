{"pr_number": 2067, "pr_title": "Add support for fireperf e2e test in fireci.", "pr_createdAt": "2020-10-15T22:11:09Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2067", "timeline": [{"oid": "bc28475893ff2e8bea9580aa27287462ffe4255e", "url": "https://github.com/firebase/firebase-android-sdk/commit/bc28475893ff2e8bea9580aa27287462ffe4255e", "message": "Add support for fireperf e2e test in fireci.", "committedDate": "2020-10-15T22:05:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1Njg4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2067#discussion_r506656883", "bodyText": "What if there are multiple versions available (which can happen if the previous run was on a different version and the local m2 repo is not cleaned up)?\nMay be cleaning up the local maven repo before kicking the build might help to reduce the noise OR pick the latest one.", "author": "ramanpreetSinghKhinda", "createdAt": "2020-10-16T18:37:20Z", "path": "ci/fireci/fireciplugins/fireperf.py", "diffHunk": "@@ -0,0 +1,85 @@\n+# Copyright 2020 Google LLC\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+import click\n+import contextlib\n+import logging\n+import os\n+import pathlib\n+\n+from fireci import ci_command\n+from fireci import gradle\n+\n+_logger = logging.getLogger('fireci.fireperf')\n+\n+\n+@click.option(\n+  '--plugin_repo_dir',\n+  help='The location of the fireperf plugin repository.',\n+  required=True,\n+)\n+@click.option(\n+  '--target_environment',\n+  type=click.Choice(['prod', 'autopush'], case_sensitive=False),\n+  help='The target environment fireperf is built for.',\n+  required=True,\n+)\n+@ci_command()\n+def fireperf_e2e_test(target_environment, plugin_repo_dir):\n+  \"\"\"Run Firebase Performance end to end test.\"\"\"\n+\n+  _logger.info('Building fireperf plugin ...')\n+  with chdir(plugin_repo_dir):\n+    build_plugin_task = ':firebase-performance:performance-gradle:publishToMavenLocal'\n+    gradle.run(build_plugin_task, gradle.P('publishMode', 'SNAPSHOT'))\n+\n+  version = _find_fireperf_plugin_version()\n+  _logger.info(f'Setting environment variable: FIREBASE_PERF_PLUGIN_VERSION={version} ...')\n+  os.environ['FIREBASE_PERF_PLUGIN_VERSION'] = version\n+\n+  fireperf_e2e_test_gradle_command = [\n+    '--build-cache',\n+    '--parallel',\n+    '--continue',\n+    ':firebase-perf:e2e-app:deviceCheck'\n+  ]\n+  if target_environment == 'autopush':\n+    fireperf_e2e_test_gradle_command += [gradle.P('fireperfBuildForAutopush', 'true')]\n+  _logger.info(f'Running fireperf e2e test with target environment: {target_environment} ...')\n+  gradle.run(*fireperf_e2e_test_gradle_command)\n+\n+\n+@contextlib.contextmanager\n+def chdir(directory):\n+  \"\"\"Change working dir to `directory` and restore to original afterwards.\"\"\"\n+  _logger.debug(f'Changing directory to: {directory} ...')\n+  original_dir = os.getcwd()\n+  os.chdir(directory)\n+  try:\n+    yield\n+  finally:\n+    _logger.debug(f'Restoring directory to: {original_dir} ...')\n+    os.chdir(original_dir)\n+\n+\n+def _find_fireperf_plugin_version():\n+  local_maven_repo_dir = pathlib.Path.home().joinpath('.m2', 'repository')\n+  artifacts_path = local_maven_repo_dir.joinpath('com', 'google', 'firebase', 'perf-plugin')\n+  versions = [pom.parent.name for pom in artifacts_path.rglob('*.pom')]\n+  snapshots = list(filter(lambda v: v.endswith('-SNAPSHOT'), versions))\n+\n+  if snapshots:\n+    return snapshots[0]\n+  else:\n+    raise click.ClickException('Cannot find a snapshot version in local maven repo.')", "originalCommit": "bc28475893ff2e8bea9580aa27287462ffe4255e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MTAzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2067#discussion_r506661030", "bodyText": "maven local is guarantted to be empty when the job starts, so checking should not be required", "author": "vkryachko", "createdAt": "2020-10-16T18:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1Njg4Mw=="}], "type": "inlineReview"}]}