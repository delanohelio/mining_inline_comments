{"pr_number": 1387, "pr_title": "Clean up error handling for report persistence", "pr_createdAt": "2020-03-24T20:30:24Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1387", "timeline": [{"oid": "b0f19696a0f568ed8c84d6bd106fcf7ea792f484", "url": "https://github.com/firebase/firebase-android-sdk/commit/b0f19696a0f568ed8c84d6bd106fcf7ea792f484", "message": "Clean up error handling for report persistence\n\nEnsure data written to disk is cleaned up properly when\nread/write/serialization errors occur.", "committedDate": "2020-03-24T19:51:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NDc4OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1387#discussion_r397444789", "bodyText": "What do you think about making some of this output logged as errors, since they are basically logging failed asserts?", "author": "mrichards", "createdAt": "2020-03-24T20:37:08Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/CrashlyticsUncaughtExceptionHandler.java", "diffHunk": "@@ -46,7 +46,13 @@ public CrashlyticsUncaughtExceptionHandler(\n   public void uncaughtException(Thread thread, Throwable ex) {\n     isHandlingException.set(true);\n     try {\n-      crashListener.onUncaughtException(settingsDataProvider, thread, ex);\n+      if (thread == null) {\n+        Logger.getLogger().d(\"Could not handle uncaught exception; null thread\");", "originalCommit": "b0f19696a0f568ed8c84d6bd106fcf7ea792f484", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NTc4Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1387#discussion_r397445787", "bodyText": "I think in this particular case that makes sense.", "author": "mrwillis21", "createdAt": "2020-03-24T20:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NDc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ1ODEzNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1387#discussion_r397458136", "bodyText": "This is a lot cleaner! \ud83d\ude0d", "author": "mrichards", "createdAt": "2020-03-24T21:01:19Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -169,66 +184,52 @@ public void deleteFinalizedReport(String sessionId) {\n     }\n   }\n \n-  public void finalizeSessionWithNativeEvent(\n-      String sessionId, CrashlyticsReport.FilesPayload build) {\n-    final File outputDirectory = prepareDirectory(nativeReportsDirectory);\n-\n-    File sessionFile = new File(getSessionDirectoryById(sessionId), REPORT_FILE_NAME);\n-\n-    if (!sessionFile.exists()) {\n-      return;\n-    }\n-\n-    String textFile = readTextFile(sessionFile);\n-\n-    if (textFile == null) {\n-      return;\n-    }\n-\n-    CrashlyticsReport report = TRANSFORM.reportFromJson(textFile);\n-\n-    // In the unlikely event the open non-native report has been cleaned up,\n-    // we no longer can retrieve the relevant context about the session.\n-    if (report == null) {\n-      return;\n-    }\n-\n-    report = report.withNdkPayload(build);\n-\n-    writeTextFile(new File(outputDirectory, sessionId), TRANSFORM.reportToJson(report));\n-  }\n-\n-  // TODO: Deal with potential runtime exceptions\n-  public void finalizeReports(String currentSessionId, long sessionEndTime) {\n-    // TODO: Need to implement procedure to skip finalizing the current session when this is\n-    //  called on app start, but keep the current session when called at crash time. Currently\n-    //  this only works when called at app start.\n-    List<File> sessionDirectories = capAndGetOpenSessions(currentSessionId);\n+  /**", "originalCommit": "b0f19696a0f568ed8c84d6bd106fcf7ea792f484", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c715a88939d6c94fea7081d921740febe07d8a35", "url": "https://github.com/firebase/firebase-android-sdk/commit/c715a88939d6c94fea7081d921740febe07d8a35", "message": "Change log level in appropriate places", "committedDate": "2020-03-24T21:24:54Z", "type": "commit"}, {"oid": "8f6eaafed74d85615afc81be0eeb7b3cd524ad52", "url": "https://github.com/firebase/firebase-android-sdk/commit/8f6eaafed74d85615afc81be0eeb7b3cd524ad52", "message": "Update encoders versioning for appropriate dependency", "committedDate": "2020-03-24T21:25:25Z", "type": "commit"}, {"oid": "052fc33887d975078ad75b5637adffb9d7d3523f", "url": "https://github.com/firebase/firebase-android-sdk/commit/052fc33887d975078ad75b5637adffb9d7d3523f", "message": "Fix nullability for nonfatals & clean up logging calls", "committedDate": "2020-03-24T21:45:43Z", "type": "commit"}]}