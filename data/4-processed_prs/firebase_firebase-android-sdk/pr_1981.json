{"pr_number": 1981, "pr_title": "Fix ConcurrentModificationException in FirestoreMultiDbComponent.onDeleted()", "pr_createdAt": "2020-09-14T20:26:07Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1981", "timeline": [{"oid": "6f306b84473129b687a4d347e81242d2a5356dba", "url": "https://github.com/firebase/firebase-android-sdk/commit/6f306b84473129b687a4d347e81242d2a5356dba", "message": "Fix ConcurrentModificationException in FirestoreMultiDbComponent.onDeleted()", "committedDate": "2020-09-14T20:25:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDE5MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1981#discussion_r488284191", "bodyText": "This is just a sanity check to make sure that the instances map is in the expected state after the for loop completes. If terminate() is ever changed to not remove the instance then that would go unnoticed, breaking the contract of this method.", "author": "dconeybe", "createdAt": "2020-09-14T22:59:34Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirestoreMultiDbComponent.java", "diffHunk": "@@ -79,10 +80,15 @@ public synchronized void remove(@NonNull String databaseId) {\n \n   @Override\n   public synchronized void onDeleted(String firebaseAppName, FirebaseOptions options) {\n-    // Shuts down all database instances and remove them from registry map when App is deleted.\n-    for (Map.Entry<String, FirebaseFirestore> entry : instances.entrySet()) {\n-      entry.getValue().terminateInternal();\n-      instances.remove(entry.getKey());\n+    // Shut down all database instances and remove them from the registry map. To avoid\n+    // ConcurrentModificationException, make a copy of the entries instead of using an iterator from\n+    // the `instances` map directly.\n+    for (Map.Entry<String, FirebaseFirestore> entry : new ArrayList<>(instances.entrySet())) {\n+      entry.getValue().terminate();\n+      if (instances.containsKey(entry.getKey())) {", "originalCommit": "6f306b84473129b687a4d347e81242d2a5356dba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NTM1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1981#discussion_r488295352", "bodyText": "hardAssert is what you want for this.", "author": "wilhuff", "createdAt": "2020-09-14T23:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc5MTUwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1981#discussion_r489791503", "bodyText": "Done.", "author": "dconeybe", "createdAt": "2020-09-16T22:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NDE5MQ=="}], "type": "inlineReview"}, {"oid": "d475fac0549faa02f52c2d4d4da9cf70af33a693", "url": "https://github.com/firebase/firebase-android-sdk/commit/d475fac0549faa02f52c2d4d4da9cf70af33a693", "message": "Add unit test for FirestoreMultiDbComponent.onDeleted()", "committedDate": "2020-09-16T20:17:51Z", "type": "commit"}, {"oid": "76beda82544d649d519adb48ede6b214a3cefc70", "url": "https://github.com/firebase/firebase-android-sdk/commit/76beda82544d649d519adb48ede6b214a3cefc70", "message": "Convert IllegalStateException to hardAssert", "committedDate": "2020-09-16T20:26:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgxMTk3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1981#discussion_r489811973", "bodyText": "Is this cleanup actually required? There's no shared state, so it seems like it would be fine to just drop the component and delete this line and the comment.\nIf this clean-up is required, then this should probably be within a finally block, because assertNotSame will throw on a failure and then the cleanup won't happen.", "author": "wilhuff", "createdAt": "2020-09-16T23:40:04Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/FirestoreMultiDbComponentTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.firestore;\n+\n+import android.content.Context;\n+\n+import androidx.test.platform.app.InstrumentationRegistry;\n+\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.auth.internal.InternalAuthProvider;\n+import com.google.firebase.firestore.remote.GrpcMetadataProvider;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.junit.Assert.assertNotSame;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(manifest = Config.NONE)\n+public class FirestoreMultiDbComponentTest {\n+\n+  @Test\n+  public void onDeleted_shouldRemoveAllInstances() {\n+    FirebaseApp firebaseApp = createApp(\"onDeleted-shouldRemoveAllInstances\");\n+    FirestoreMultiDbComponent component = createComponent(firebaseApp);\n+    FirebaseFirestore firebaseFirestore1 = component.get(\"db1\");\n+    FirebaseFirestore firebaseFirestore2 = component.get(\"db2\");\n+\n+    component.onDeleted(firebaseApp.getName(), firebaseApp.getOptions());\n+\n+    assertNotSame(firebaseFirestore1, component.get(\"db1\"));\n+    assertNotSame(firebaseFirestore2, component.get(\"db2\"));\n+    // Clean up the instances registered by the calls above.\n+    component.onDeleted(firebaseApp.getName(), firebaseApp.getOptions());", "originalCommit": "76beda82544d649d519adb48ede6b214a3cefc70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MjUwNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1981#discussion_r527792504", "bodyText": "No, it's probably not required. I've removed it.", "author": "dconeybe", "createdAt": "2020-11-20T16:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgxMTk3Mw=="}], "type": "inlineReview"}, {"oid": "9d76f0b19226a135613f0cc96e7174abfaeecfd6", "url": "https://github.com/firebase/firebase-android-sdk/commit/9d76f0b19226a135613f0cc96e7174abfaeecfd6", "message": "Merge remote-tracking branch 'origin/master' at 4a366a82 into FixOnDeleted", "committedDate": "2020-11-20T15:56:37Z", "type": "commit"}, {"oid": "7a7193a1827e8212b3d6d6dc963851313c02e858", "url": "https://github.com/firebase/firebase-android-sdk/commit/7a7193a1827e8212b3d6d6dc963851313c02e858", "message": "Remove unnecessary cleanup", "committedDate": "2020-11-20T16:04:30Z", "type": "commit"}, {"oid": "1471b6ebb2a0beca3f1a1992f0d35f72a15dc21d", "url": "https://github.com/firebase/firebase-android-sdk/commit/1471b6ebb2a0beca3f1a1992f0d35f72a15dc21d", "message": "Format code with ./gradlew :firebase-firestore:googleJavaFormat", "committedDate": "2020-11-20T16:20:07Z", "type": "commit"}]}