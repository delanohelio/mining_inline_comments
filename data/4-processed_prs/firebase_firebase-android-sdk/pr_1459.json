{"pr_number": 1459, "pr_title": "Add precondition format checks for AppId and API Key", "pr_createdAt": "2020-04-14T00:55:01Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1459", "timeline": [{"oid": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "url": "https://github.com/firebase/firebase-android-sdk/commit/cbbffa5bb568008275d5c23b1194e746ff73c8a2", "message": "Add precondition format checks for AppId and API Key", "committedDate": "2020-04-14T00:43:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDUyNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407810525", "bodyText": "lowercase variable names:\nappId", "author": "andirayo", "createdAt": "2020-04-14T01:22:27Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -41,4 +45,12 @@ public boolean isAuthTokenExpired(PersistedInstallationEntry entry) {\n   public long currentTimeInSecs() {\n     return TimeUnit.MILLISECONDS.toSeconds(System.currentTimeMillis());\n   }\n+\n+  static boolean isValidAppIdFormat(String AppId) {", "originalCommit": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDY2Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407810666", "bodyText": "I think we can also add a @nonnull here.", "author": "andirayo", "createdAt": "2020-04-14T01:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDY1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407810654", "bodyText": "lowercase variable names:\napiKey\nI think we can also add a @nonnull here.", "author": "andirayo", "createdAt": "2020-04-14T01:22:53Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -41,4 +45,12 @@ public boolean isAuthTokenExpired(PersistedInstallationEntry entry) {\n   public long currentTimeInSecs() {\n     return TimeUnit.MILLISECONDS.toSeconds(System.currentTimeMillis());\n   }\n+\n+  static boolean isValidAppIdFormat(String AppId) {\n+    return AppId.contains(APP_ID_IDENTIFICATION_SUBSTRING);\n+  }\n+\n+  static boolean isValidApiKeyFormat(String ApiKey) {", "originalCommit": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDk0NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407810945", "bodyText": "Please check with Android folks (e.g. Ashwin) if we can use that package here of if we should use re2j.", "author": "andirayo", "createdAt": "2020-04-14T01:23:51Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -17,11 +17,15 @@\n import android.text.TextUtils;\n import com.google.firebase.installations.local.PersistedInstallationEntry;\n import java.util.concurrent.TimeUnit;\n+import java.util.regex.Pattern;", "originalCommit": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkwOTE2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407909163", "bodyText": "Greg said it's used in FCM SDK so it's fine.", "author": "ChaoqunCHEN", "createdAt": "2020-04-14T07:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1Nzg3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r408257872", "bodyText": "He might have said that because it's GMSCore and GMSCore has rules that apply to older code.\nMaybe for other Firebase SDKs we have other requirements.\nPlease check with someone from Android team, if it is fine to use this package instead of re2j.", "author": "andirayo", "createdAt": "2020-04-14T16:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMDk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMTExNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407811114", "bodyText": "line length", "author": "andirayo", "createdAt": "2020-04-14T01:24:18Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -965,4 +966,41 @@ public void testDelete_networkError() throws Exception {\n           entry.isRegistered());\n     }\n   }\n+\n+  @Test\n+  public void testAppIdCheck() {\n+    // valid appid\n+    assertTrue(Utils.isValidAppIdFormat(\"1:123456789:android:abcdef\"));\n+    assertTrue(Utils.isValidAppIdFormat(\"1:515438998704:android:e78ec19738058349\"));\n+    assertTrue(Utils.isValidAppIdFormat(\"1:208472424340:android:a243f98a00873753\"));\n+    assertTrue(Utils.isValidAppIdFormat(\"1:755541669657:ios:4d6d5a5ce71e9d30\"));\n+    assertTrue(Utils.isValidAppIdFormat(\"1:1086610230652:ios:852c7f6ee799ff89\"));\n+    assertTrue(Utils.isValidAppIdFormat(\"1:35006771263:web:32b6f4a5b95acd2c\"));\n+    // invalid appid\n+    assertFalse(Utils.isValidAppIdFormat(\"abc.abc.abc\"));\n+    assertFalse(\n+        Utils.isValidAppIdFormat(\n+            \"com.google.firebase.samples.messaging.advanced\")); // using pakage name as App ID\n+  }\n+\n+  @Test\n+  public void testApiKeyCheck() {\n+    // valid ApiKey\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyabcdefghijklmnopqrstuvwxyz1234567\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyA4UrcGxgwQFTfaI3no3t7Lt1sjmdnP5sQ\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyA5_iVawFQ8ABuTZNUdcwERLJv_a_p4wtM\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyANUvH9H9BsUccjsu2pCmEkOPjjaXeDQgY\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyASWm6HmTMdYWpgMnjRBjxcQ9CKctWmLd4\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyAdOS2zB6NCsk1pCdZ4-P6GBdi_UUPwX7c\"));\n+    assertTrue(Utils.isValidApiKeyFormat(\"AIzaSyAnLA7NfeLquW1tJFpx_eQCxoX-oo6YyIs\"));\n+    // invalid ApiKey\n+    assertFalse(\n+        Utils.isValidApiKeyFormat(\"BIzaSyabcdefghijklmnopqrstuvwxyz1234567\")); // wrong prefix\n+    assertFalse(Utils.isValidApiKeyFormat(\"AIzaSyabcdefghijklmnopqrstuvwxyz\")); // wrong length\n+    assertFalse(Utils.isValidApiKeyFormat(\"AIzaSyabcdefghijklmno:qrstuvwxyzabcdefg\")); // wrong char\n+    assertFalse(Utils.isValidApiKeyFormat(\"AIzaSyabcdefghijklmno qrstuvwxyzabcdefg\")); // wrong char\n+    assertFalse(\n+        Utils.isValidApiKeyFormat(\n+            \"AAAAdpB7anM:APA91bFFK03DIT8y3l5uymwbKcUDJdYqTRSP9Qcxg8SU5kKPalEpObdx0C0xv8gQttdWlLW4hLvvHA0JoDKA6Lrvbi-edUjFCPY_WJkuvHxFwGWXjnj4yI4sPQ27mXuSVIyAbgX4aTK0QYpIKq2j1NBi7ZU75gunQg\")); // using FCM server key as API key.", "originalCommit": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgxMTM3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r407811373", "bodyText": "Please update similarly to IID change.", "author": "andirayo", "createdAt": "2020-04-14T01:25:11Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -146,6 +146,14 @@ private void preConditionChecks() {\n     Preconditions.checkNotEmpty(getApplicationId());\n     Preconditions.checkNotEmpty(getProjectIdentifier());\n     Preconditions.checkNotEmpty(getApiKey());\n+    Preconditions.checkArgument(\n+        Utils.isValidAppIdFormat(getApplicationId()),\n+        \"Invalid AppId format. Please refer to\"\n+            + \" https://firebase.google.com/support/privacy/init-options for details.\");\n+    Preconditions.checkArgument(\n+        Utils.isValidApiKeyFormat(getApiKey()),\n+        \"Invalid Api-key format. Please refer to\"\n+            + \" https://firebase.google.com/support/privacy/init-options for details.\");", "originalCommit": "cbbffa5bb568008275d5c23b1194e746ff73c8a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "137c97d28a6e02684e3b1c847eae0d824b3a2743", "url": "https://github.com/firebase/firebase-android-sdk/commit/137c97d28a6e02684e3b1c847eae0d824b3a2743", "message": "fix minor issue", "committedDate": "2020-04-14T07:11:07Z", "type": "commit"}, {"oid": "14423d238fa56271e858494f67dd9bd0acee51bd", "url": "https://github.com/firebase/firebase-android-sdk/commit/14423d238fa56271e858494f67dd9bd0acee51bd", "message": "Merge branch 'master' into AppId_ApiKey_precheck", "committedDate": "2020-04-14T07:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NzE0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r408257144", "bodyText": "This should be @nonnull - not @nullable.", "author": "andirayo", "createdAt": "2020-04-14T16:06:58Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -41,4 +48,12 @@ public boolean isAuthTokenExpired(PersistedInstallationEntry entry) {\n   public long currentTimeInSecs() {\n     return TimeUnit.MILLISECONDS.toSeconds(System.currentTimeMillis());\n   }\n+\n+  static boolean isValidAppIdFormat(@Nullable String appId) {", "originalCommit": "14423d238fa56271e858494f67dd9bd0acee51bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NzE5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r408257198", "bodyText": "This should be @nonnull - not @nullable.", "author": "andirayo", "createdAt": "2020-04-14T16:07:03Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -41,4 +48,12 @@ public boolean isAuthTokenExpired(PersistedInstallationEntry entry) {\n   public long currentTimeInSecs() {\n     return TimeUnit.MILLISECONDS.toSeconds(System.currentTimeMillis());\n   }\n+\n+  static boolean isValidAppIdFormat(@Nullable String appId) {\n+    return appId.contains(APP_ID_IDENTIFICATION_SUBSTRING);\n+  }\n+\n+  static boolean isValidApiKeyFormat(@Nullable String apiKey) {", "originalCommit": "14423d238fa56271e858494f67dd9bd0acee51bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODIxNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1459#discussion_r408258214", "bodyText": "Why did you remove the messages?\nThis is important for developers to see!\nPlease re-add!", "author": "andirayo", "createdAt": "2020-04-14T16:08:25Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -143,18 +143,19 @@ public Thread newThread(Runnable r) {\n    * or empty.\n    */\n   private void preConditionChecks() {\n-    Preconditions.checkNotEmpty(\n-        getApplicationId(),\n-        \"Please set your Application ID. A valid Firebase App ID is required to communicate \"\n-            + \"with Firebase server APIs: It identifies your application with Firebase.\");\n-    Preconditions.checkNotEmpty(\n-        getProjectIdentifier(),\n-        \"Please set your project ID. A valid Firebase project ID is required to communicate \"\n-            + \"with Firebase server APIs: It identifies your project with Google.\");\n-    Preconditions.checkNotEmpty(\n-        getApiKey(),\n-        \"Please set a valid API key. A Firebase API key is required to communicate with \"\n-            + \"Firebase server APIs: It authenticates your project with Google.\");\n+    Preconditions.checkNotEmpty(getApplicationId());\n+    Preconditions.checkNotEmpty(getProjectIdentifier());\n+    Preconditions.checkNotEmpty(getApiKey());", "originalCommit": "14423d238fa56271e858494f67dd9bd0acee51bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}