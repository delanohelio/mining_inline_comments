{"pr_number": 1972, "pr_title": "Make the language reported via headers configurable", "pr_createdAt": "2020-09-10T23:21:22Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1972", "timeline": [{"oid": "138602d59fb38d9bf25a103375174a01ecaa4107", "url": "https://github.com/firebase/firebase-android-sdk/commit/138602d59fb38d9bf25a103375174a01ecaa4107", "message": "Initial commit", "committedDate": "2020-09-10T23:05:02Z", "type": "commit"}, {"oid": "b6f9f8fa5db64fd8d67a18da90a92cfd0936a8ff", "url": "https://github.com/firebase/firebase-android-sdk/commit/b6f9f8fa5db64fd8d67a18da90a92cfd0936a8ff", "message": "Fixes", "committedDate": "2020-09-10T23:11:05Z", "type": "commit"}, {"oid": "d1de27decf79b1d845999b660ea9d78464969a77", "url": "https://github.com/firebase/firebase-android-sdk/commit/d1de27decf79b1d845999b660ea9d78464969a77", "message": "Formatting", "committedDate": "2020-09-10T23:22:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NjM5MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r486686390", "bodyText": "Unfortunately, the method to retrieve the gRPC version is not public in the Java SDK.", "author": "var-const", "createdAt": "2020-09-10T23:23:02Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/remote/FirestoreChannel.java", "diffHunk": "@@ -281,10 +278,24 @@ public void invalidateToken() {\n     credentialsProvider.invalidateToken();\n   }\n \n+  public static void setClientLanguage(String languageToken) {\n+    clientLanguage = languageToken;\n+  }\n+\n+  private static String getDefaultClientLanguage() {\n+    // Note: there is no good way to get the Java language version on Android\n+    // (System.getProperty(\"java.version\") returns \"0\", for example).\n+    return \"gl-java/\";\n+  }\n+\n+  private String getGoogApiClientValue() {\n+    return String.format(\"%s fire/%s grpc/\", clientLanguage, BuildConfig.VERSION_NAME);", "originalCommit": "b6f9f8fa5db64fd8d67a18da90a92cfd0936a8ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE0MzMzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488143330", "bodyText": "Changing this to public requires annotating it with @hide in the javadoc so that it doesn't become a part of the public API.", "author": "wilhuff", "createdAt": "2020-09-14T18:39:47Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/remote/FirestoreChannel.java", "diffHunk": "@@ -39,19 +39,16 @@\n  * Wrapper class around io.grpc.Channel that adds headers, exception handling and simplifies\n  * invoking RPCs.\n  */\n-class FirestoreChannel {\n+public class FirestoreChannel {", "originalCommit": "d1de27decf79b1d845999b660ea9d78464969a77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NTAwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488285008", "bodyText": "Thanks!", "author": "var-const", "createdAt": "2020-09-14T23:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE0MzMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE0NDI2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488144261", "bodyText": "Why not inline the string literal here?\nSeparately: this access should be synchronized, but since we don't really care about the results of multiple concurrent results of setClientLanguage, you can mark this field volatile to avoid the need for a lock.", "author": "wilhuff", "createdAt": "2020-09-14T18:41:31Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/remote/FirestoreChannel.java", "diffHunk": "@@ -39,19 +39,16 @@\n  * Wrapper class around io.grpc.Channel that adds headers, exception handling and simplifies\n  * invoking RPCs.\n  */\n-class FirestoreChannel {\n+public class FirestoreChannel {\n \n   private static final Metadata.Key<String> X_GOOG_API_CLIENT_HEADER =\n       Metadata.Key.of(\"x-goog-api-client\", Metadata.ASCII_STRING_MARSHALLER);\n \n   private static final Metadata.Key<String> RESOURCE_PREFIX_HEADER =\n       Metadata.Key.of(\"google-cloud-resource-prefix\", Metadata.ASCII_STRING_MARSHALLER);\n \n-  // TODO: The gRPC version is determined using a package manifest, which is not available\n-  // to us at build time or runtime (it's empty when building in google3). So for now we omit the\n-  // version of grpc.\n-  private static final String X_GOOG_API_CLIENT_VALUE =\n-      \"gl-java/ fire/\" + BuildConfig.VERSION_NAME + \" grpc/\";\n+  /** The client language reported via the X_GOOG_API_CLIENT_HEADER. */\n+  private static String clientLanguage = getDefaultClientLanguage();", "originalCommit": "d1de27decf79b1d845999b660ea9d78464969a77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4NTU2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488285568", "bodyText": "Done.", "author": "var-const", "createdAt": "2020-09-14T23:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE0NDI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI1MzExMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488253111", "bodyText": "Proguard will rewrite this method name in release builds of users' applications. We need to annotate this, likely with @KeepForSdk or possibly @Keep, though I don't know which applies to package-private methods.\nNote that this method does not have to be public to be accessible from JNI (JNI ignores access control modifiers), but this can only work when the name isn't shortened.\nThe argument here should have a nullability annotation, probably @NonNull.", "author": "wilhuff", "createdAt": "2020-09-14T22:09:53Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -635,4 +636,15 @@ void validateReference(DocumentReference docRef) {\n           \"Provided document reference is from a different Cloud Firestore instance.\");\n     }\n   }\n+\n+  /**\n+   * Sets the language of the public API in the format of \"gl-<language>/<version>\" where version\n+   * might be blank, e.g. `gl-cpp/`. The provided string is used as is.\n+   *\n+   * Note: this method is package-private because it is expected to only be called via JNI (which\n+   * ignores access modifiers).\n+   */\n+  static void setClientLanguage(String languageToken) {", "originalCommit": "d1de27decf79b1d845999b660ea9d78464969a77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NjU3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1972#discussion_r488296572", "bodyText": "Hmm, looking at the way @KeepForSdk is described, it appears to have a more limited effect than @Keep, so it seems using @Keep is safer (apparently @KeepForSdk still allows for the method to be stripped in end-developer apps). Feel free to correct me, though.", "author": "var-const", "createdAt": "2020-09-14T23:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI1MzExMQ=="}], "type": "inlineReview"}, {"oid": "0ec868c0eb5828ff91f1da0211f6bf9388f18e46", "url": "https://github.com/firebase/firebase-android-sdk/commit/0ec868c0eb5828ff91f1da0211f6bf9388f18e46", "message": "Feedback", "committedDate": "2020-09-14T23:19:14Z", "type": "commit"}, {"oid": "bb21cc0a2ba50cd277a5d4bc4015536edb381a39", "url": "https://github.com/firebase/firebase-android-sdk/commit/bb21cc0a2ba50cd277a5d4bc4015536edb381a39", "message": "Remove test logging", "committedDate": "2020-09-14T23:36:53Z", "type": "commit"}]}