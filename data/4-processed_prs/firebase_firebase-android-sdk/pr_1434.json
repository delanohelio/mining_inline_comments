{"pr_number": 1434, "pr_title": "Update crashlytics global data collection", "pr_createdAt": "2020-04-07T20:41:46Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1434", "timeline": [{"oid": "7eb1b44da6789531286c28c884fe33a9ad2cc3ef", "url": "https://github.com/firebase/firebase-android-sdk/commit/7eb1b44da6789531286c28c884fe33a9ad2cc3ef", "message": "fix tests", "committedDate": "2020-04-07T20:40:51Z", "type": "commit"}, {"oid": "89cb018ed15a418c410197dd96324d2887838053", "url": "https://github.com/firebase/firebase-android-sdk/commit/89cb018ed15a418c410197dd96324d2887838053", "message": "add tests", "committedDate": "2020-04-07T20:43:04Z", "type": "commit"}, {"oid": "c29b8422be45e8bb4bf6b03215057a648f51b5e5", "url": "https://github.com/firebase/firebase-android-sdk/commit/c29b8422be45e8bb4bf6b03215057a648f51b5e5", "message": "add tests for crashlytics api change", "committedDate": "2020-04-08T22:45:27Z", "type": "commit"}, {"oid": "811732ee779167657c839d16851cb64c33a8ec10", "url": "https://github.com/firebase/firebase-android-sdk/commit/811732ee779167657c839d16851cb64c33a8ec10", "message": "add api txt", "committedDate": "2020-04-09T15:45:57Z", "type": "commit"}, {"oid": "09da19b9810e032140f4088c09ad7955a8dae4af", "url": "https://github.com/firebase/firebase-android-sdk/commit/09da19b9810e032140f4088c09ad7955a8dae4af", "message": "crashlytics test", "committedDate": "2020-04-09T16:27:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMzAwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r410433002", "bodyText": "We can help our future selves by adding some comments here :)", "author": "ashwinraghav", "createdAt": "2020-04-17T19:41:55Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/DataCollectionArbiter.java", "diffHunk": "@@ -107,13 +116,29 @@ public boolean isAutomaticDataCollectionEnabled() {\n   }\n \n   @SuppressLint({\"CommitPrefEdits\", \"ApplySharedPref\"})\n-  public void setCrashlyticsDataCollectionEnabled(boolean enabled) {\n-    crashlyticsDataCollectionEnabled = enabled;\n-    crashlyticsDataCollectionExplicitlySet = true;\n-    sharedPreferences.edit().putBoolean(FIREBASE_CRASHLYTICS_COLLECTION_ENABLED, enabled).commit();\n+  public synchronized void setCrashlyticsDataCollectionEnabled(Boolean enabled) {", "originalCommit": "09da19b9810e032140f4088c09ad7955a8dae4af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMzM2OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r410433369", "bodyText": "Can you split this up into separate tests that express the conditions they check?", "author": "ashwinraghav", "createdAt": "2020-04-17T19:42:43Z", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/common/CrashlyticsControllerTest.java", "diffHunk": "@@ -842,6 +842,21 @@ public void testUploadDisabledThenEnabled() throws Exception {\n     Task<Void> task = controller.submitAllReports(1.0f, testSettingsDataProvider.getAppSettings());\n \n     arbiter.setCrashlyticsDataCollectionEnabled(true);\n+    assertTrue(arbiter.isAutomaticDataCollectionEnabled());\n+\n+    when(mockEditor.putBoolean(PREFS_KEY, false)).thenReturn(mockEditor);\n+    when(mockPrefs.getBoolean(PREFS_KEY, true)).thenReturn(false);\n+    arbiter.setCrashlyticsDataCollectionEnabled(false);\n+    assertFalse(arbiter.isAutomaticDataCollectionEnabled());\n+\n+    when(mockPrefs.contains(PREFS_KEY)).thenReturn(false);", "originalCommit": "09da19b9810e032140f4088c09ad7955a8dae4af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTg3Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r444979876", "bodyText": "What is this method synchronizing that was missed before?", "author": "mrwillis21", "createdAt": "2020-06-24T15:26:51Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/DataCollectionArbiter.java", "diffHunk": "@@ -107,13 +116,29 @@ public boolean isAutomaticDataCollectionEnabled() {\n   }\n \n   @SuppressLint({\"CommitPrefEdits\", \"ApplySharedPref\"})\n-  public void setCrashlyticsDataCollectionEnabled(boolean enabled) {\n-    crashlyticsDataCollectionEnabled = enabled;\n-    crashlyticsDataCollectionExplicitlySet = true;\n-    sharedPreferences.edit().putBoolean(FIREBASE_CRASHLYTICS_COLLECTION_ENABLED, enabled).commit();\n+  public synchronized void setCrashlyticsDataCollectionEnabled(Boolean enabled) {", "originalCommit": "09da19b9810e032140f4088c09ad7955a8dae4af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1NDgwNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r461054806", "bodyText": "Yes looks like it was missed before.", "author": "VinayGuthal", "createdAt": "2020-07-27T17:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1Nzk5Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r461057997", "bodyText": "My question was more the what is being synchronized, rather than \"was this missed\". I'm not 100% sure this needs to be synchronized, but if some state in here does need to be, we should probably be more explicit about it and try to use a synchronized block with a named lock for clarity.", "author": "mrwillis21", "createdAt": "2020-07-27T17:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5MzY1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r461093659", "bodyText": "Talked offline about this: going to leave as it is for now and potentially polish it in a subsequent commit.", "author": "mrwillis21", "createdAt": "2020-07-27T18:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4ODkxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r444988917", "bodyText": "Question: this setting, conceptually, should be \"clear the shared preferences setting, then reset the values based on the manifest\". Is there any way we could consolidate that second part with the same conceptual code (i.e. setting the values based on the manifest) in the constructor, and make a method out of it? That would 1) make this method simpler and more compact, and 2) make sure that both times (on construction and also here) we set the values the same way.", "author": "mrwillis21", "createdAt": "2020-06-24T15:39:48Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/DataCollectionArbiter.java", "diffHunk": "@@ -107,13 +116,29 @@ public boolean isAutomaticDataCollectionEnabled() {\n   }\n \n   @SuppressLint({\"CommitPrefEdits\", \"ApplySharedPref\"})\n-  public void setCrashlyticsDataCollectionEnabled(boolean enabled) {\n-    crashlyticsDataCollectionEnabled = enabled;\n-    crashlyticsDataCollectionExplicitlySet = true;\n-    sharedPreferences.edit().putBoolean(FIREBASE_CRASHLYTICS_COLLECTION_ENABLED, enabled).commit();\n+  public synchronized void setCrashlyticsDataCollectionEnabled(Boolean enabled) {\n+    if (enabled == null) {", "originalCommit": "09da19b9810e032140f4088c09ad7955a8dae4af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ffb1c7770400ee23a6c4a4dcdb4630cae23411cc", "url": "https://github.com/firebase/firebase-android-sdk/commit/ffb1c7770400ee23a6c4a4dcdb4630cae23411cc", "message": "Merge branch 'master' into update_crash_api", "committedDate": "2020-07-27T17:55:25Z", "type": "commit"}, {"oid": "d6ea27371fe46cdab2b99dd9a47675b3d6b5d0bc", "url": "https://github.com/firebase/firebase-android-sdk/commit/d6ea27371fe46cdab2b99dd9a47675b3d6b5d0bc", "message": "make constructor change", "committedDate": "2020-07-27T18:16:43Z", "type": "commit"}, {"oid": "48deb6958771e01a1396125416e45aae3857a419", "url": "https://github.com/firebase/firebase-android-sdk/commit/48deb6958771e01a1396125416e45aae3857a419", "message": "use enabled", "committedDate": "2020-07-27T18:34:41Z", "type": "commit"}, {"oid": "4f2068b9f5c348df1d86d115f022cca39ce9f257", "url": "https://github.com/firebase/firebase-android-sdk/commit/4f2068b9f5c348df1d86d115f022cca39ce9f257", "message": "Refactor and clarify DataCollectionArbiter", "committedDate": "2020-07-30T20:25:09Z", "type": "commit"}, {"oid": "e29abd61c3908ba18cbb5c4397d67e89864c2401", "url": "https://github.com/firebase/firebase-android-sdk/commit/e29abd61c3908ba18cbb5c4397d67e89864c2401", "message": "Better group related methods", "committedDate": "2020-07-30T20:37:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTQ0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r464675449", "bodyText": "Suggest replacing line 468 with:\n\"* Allows you to enable or disable the automatic data collection configuration in Crashlytics.\"", "author": "cbonnie", "createdAt": "2020-08-03T21:37:10Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/FirebaseCrashlytics.java", "diffHunk": "@@ -463,4 +463,23 @@ public boolean didCrashOnPreviousExecution() {\n   public void setCrashlyticsCollectionEnabled(boolean enabled) {\n     core.setCrashlyticsCollectionEnabled(enabled);\n   }\n+\n+  /**\n+   * Enables/disables/clears automatic data collection config by Crashlytics.", "originalCommit": "e29abd61c3908ba18cbb5c4397d67e89864c2401", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NzQ5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r464677498", "bodyText": "Suggest replacing lines 470 and 471 with:\n\"* If not set, defaults to True. When set to False, disables automatic collection by overriding the data collections settings in the AndroidManifest.xml, as well as any Firebase-wide automatic data collection settings. When set to null, clears the Crashlytics data collection configuration (in this case, enabling data collection becomes dependent on other settings).\"", "author": "cbonnie", "createdAt": "2020-08-03T21:42:04Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/FirebaseCrashlytics.java", "diffHunk": "@@ -463,4 +463,23 @@ public boolean didCrashOnPreviousExecution() {\n   public void setCrashlyticsCollectionEnabled(boolean enabled) {\n     core.setCrashlyticsCollectionEnabled(enabled);\n   }\n+\n+  /**\n+   * Enables/disables/clears automatic data collection config by Crashlytics.\n+   *\n+   * <p>If this is set, it overrides the data collection settings provided by the Android Manifest,", "originalCommit": "e29abd61c3908ba18cbb5c4397d67e89864c2401", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3Nzk1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1434#discussion_r464677956", "bodyText": "Suggest replacing line 479 with:\n\"@param Determines whether to enable or disable automatic data collection. If set to null, clears the Crashlytics data collection configuration.\"", "author": "cbonnie", "createdAt": "2020-08-03T21:43:19Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/FirebaseCrashlytics.java", "diffHunk": "@@ -463,4 +463,23 @@ public boolean didCrashOnPreviousExecution() {\n   public void setCrashlyticsCollectionEnabled(boolean enabled) {\n     core.setCrashlyticsCollectionEnabled(enabled);\n   }\n+\n+  /**\n+   * Enables/disables/clears automatic data collection config by Crashlytics.\n+   *\n+   * <p>If this is set, it overrides the data collection settings provided by the Android Manifest,\n+   * as well as any Firebase-wide automatic data collection settings.\n+   *\n+   * <p>If automatic data collection is disabled for Crashlytics, crash reports are stored on the\n+   * device. To check for reports, use the {@link #checkForUnsentReports()} method. Use {@link\n+   * #sendUnsentReports()} to upload existing reports even when automatic data collection is\n+   * disabled. Use {@link #deleteUnsentReports()} to delete any reports stored on the device without\n+   * sending them to Crashlytics.\n+   *\n+   * @param enabled whether to enable automatic data collection. The value of null would clear the", "originalCommit": "e29abd61c3908ba18cbb5c4397d67e89864c2401", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}