{"pr_number": 2073, "pr_title": "Add CustomModel class framework.", "pr_createdAt": "2020-10-16T20:29:33Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2073", "timeline": [{"oid": "614e48f5298b70ea6e2f743e5aaaaa45ef5dcc09", "url": "https://github.com/firebase/firebase-android-sdk/commit/614e48f5298b70ea6e2f743e5aaaaa45ef5dcc09", "message": "Add CustomModel class framework.", "committedDate": "2020-10-16T20:28:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNTUzNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507905537", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public @NonNull String getName() {\n          \n          \n            \n              @NonNull public String getName() {\n          \n      \n    \n    \n  \n\nhere and throughout", "author": "vkryachko", "createdAt": "2020-10-19T16:54:10Z", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import java.io.File;\n+\n+/**\n+ * Used to store information about custom models that are being downloaded or are already downloaded\n+ * on a device.\n+ */\n+public class CustomModel {\n+  private String name;\n+  private long downloadId;\n+  private long fileSize;\n+  private String modelHash;\n+  private String localFilePath = \"\";\n+\n+  public @NonNull String getName() {", "originalCommit": "614e48f5298b70ea6e2f743e5aaaaa45ef5dcc09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyNTQ5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507925498", "bodyText": "done.", "author": "annzimmer", "createdAt": "2020-10-19T17:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjM5Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507906396", "bodyText": "Is the class intended to be mutated? Why not make all fields final?", "author": "vkryachko", "createdAt": "2020-10-19T16:55:24Z", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import java.io.File;\n+\n+/**\n+ * Used to store information about custom models that are being downloaded or are already downloaded\n+ * on a device.\n+ */\n+public class CustomModel {\n+  private String name;\n+  private long downloadId;\n+  private long fileSize;\n+  private String modelHash;\n+  private String localFilePath = \"\";", "originalCommit": "614e48f5298b70ea6e2f743e5aaaaa45ef5dcc09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyNTQ4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507925480", "bodyText": "Added a comment to the class. At this point I'm just adding the public parts - enough to get the API headers written in the next PR. The file associated with the model can be updated but will only be supported as a protected method call via the downloader. So no public way to modify the class. The name however should be final. There will be a few other update calls and private fields in the next few PRs.", "author": "annzimmer", "createdAt": "2020-10-19T17:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0OTYzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r508549632", "bodyText": "Making this class mutable and updating it as model state changes has many consequences:\n\nIt must be made thread-safe as updates to it may happen on a thread different from where the developer is using it.\nYou would also have to keep track of all instances of CustomModel that are being used and update them all.\n\nSo my question is, is it worth it? Can the class be made immutable and for any state updates a new CustomModel instance can be created and handed out to progress listeners?", "author": "vkryachko", "createdAt": "2020-10-20T14:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3MjQ5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r508572498", "bodyText": "Thanks for clarifying - I agree generating a new immutable CustomModel from the stored information each time we need a version would be simpler. Updated to immutable.", "author": "annzimmer", "createdAt": "2020-10-20T14:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507906800", "bodyText": "What can a model without a file be use for?", "author": "vkryachko", "createdAt": "2020-10-19T16:56:02Z", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import java.io.File;\n+\n+/**\n+ * Used to store information about custom models that are being downloaded or are already downloaded\n+ * on a device.\n+ */\n+public class CustomModel {\n+  private String name;\n+  private long downloadId;\n+  private long fileSize;\n+  private String modelHash;\n+  private String localFilePath = \"\";\n+\n+  public @NonNull String getName() {\n+    return name;\n+  }\n+\n+  public @Nullable File getFile() {", "originalCommit": "614e48f5298b70ea6e2f743e5aaaaa45ef5dcc09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyNTQ2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507925464", "bodyText": "It can be used to get the downloadId, which can be used to get the progress of the file's download status.", "author": "annzimmer", "createdAt": "2020-10-19T17:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk1NDI5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507954294", "bodyText": "Not sure I understand. How can I get a hold of an instance of CustomModel before the download has completed?\nIt looks like the only ways to get a CustomModel is to call download and wait for its task to complete, or list all \"downloaded\" models", "author": "vkryachko", "createdAt": "2020-10-19T17:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MjA5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507972098", "bodyText": "Good point, I forgot to add the addOnProgressListener to the getModel in the API design - it was discussed and planned (hence the download id). So, I added example. In the addOnProgressListener, the CustomModel is returned with the download id and can then be used to updated the progress bar, etc. Does this clarify?", "author": "annzimmer", "createdAt": "2020-10-19T18:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk4MzkxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r507983918", "bodyText": "Thanks, it does. But it also reveals a potential design issue, namely, most of the getters have the following javadoc: \"When models is not downloaded returns X, otherwise Y\".\nimo, the fact that the model has 2 modes of operation, indicates that type has low cohesion, and really represents 2 separate things:\n\nModelDownload - contains info about the download that is in progress. Contains (modelName, downloadId), passed to onProgressListeners\nCustomModel - describes a fully downloaded model. Contains (name, file, size, hash), available only upon download completion.\n\nThis could reduce developer confusion, as they won't have to guess which state they are in(downloading vs downloaded). wdyt?", "author": "vkryachko", "createdAt": "2020-10-19T18:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyNDAzNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2073#discussion_r508024037", "bodyText": "We will actually have everything except the file during the progress listener. We have the model size and hash in advanced. So the difference is during \"in progress\" you'd use the download id to get download status information (which could be used to see if the download had started and % complete) and during \"on success\" you'd get the actual model file. We added the in progress functionality with download id so that a progress bar could be created and populated as desired.", "author": "annzimmer", "createdAt": "2020-10-19T19:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNjgwMA=="}], "type": "inlineReview"}, {"oid": "3342833574076948537094bf6eab478f1cec5f72", "url": "https://github.com/firebase/firebase-android-sdk/commit/3342833574076948537094bf6eab478f1cec5f72", "message": "Add CustomModelDownloadConditions class.", "committedDate": "2020-10-19T17:25:59Z", "type": "commit"}, {"oid": "1cfe949ebbcdcace0585c7ed54d4732d50826937", "url": "https://github.com/firebase/firebase-android-sdk/commit/1cfe949ebbcdcace0585c7ed54d4732d50826937", "message": "Update to immutable CustomModel class.", "committedDate": "2020-10-20T14:45:10Z", "type": "commit"}, {"oid": "89df78a9a29925c595ad9be352ddd37798c5b4c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/89df78a9a29925c595ad9be352ddd37798c5b4c2", "message": "Update to immutable CustomModel class.", "committedDate": "2020-10-20T14:54:54Z", "type": "commit"}]}