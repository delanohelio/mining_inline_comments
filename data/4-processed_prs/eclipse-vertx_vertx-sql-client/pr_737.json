{"pr_number": 737, "pr_title": "Unsigned long HexSequence for name of PgPreparedStatement", "pr_createdAt": "2020-08-17T17:24:36Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737", "timeline": [{"oid": "430e91ab251b58974fc0667a6b9af999408505f8", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/430e91ab251b58974fc0667a6b9af999408505f8", "message": "Unlimited HexSequence for name of PgPreparedStatment\n\nReplace StringLongSequence by unlimited HexSequence\nto avoid duplicate prepared statement name in\nPgPreparedStatement.\n\nExample:\n\n```\nconn.prepare(\"SELECT 1\", ctx.asyncAssertSuccess(ps1 -> {\n  for (int i=1; i<=0x10000; i++) {\n    conn.prepare(\"SELECT 2\", ctx.asyncAssertSuccess(ps2 -> {\n      ps2.query().execute(ctx.asyncAssertSuccess(done -> ps2.close()));\n    }));\n  }\n}));\n```\n\nThis example has a first prepared statement that is not closed.\n0x10000 other prepared statements are created and closed, they\nuse the names 0000001 to 000FFFF and finally 0000000. The\n0000000 is still in use by the first prepared statement and\ncauses this exception:\n\n\"message\": \"prepared statement \"0000000\" already exists\",\n\"severity\": \"ERROR\", \"code\": \"42P05\", \"file\": \"prepare.c\",\n\"line\": \"475\", \"routine\": \"StorePreparedStatement\"\n\nThe new HexSequence does not reuse names. After 000FFFF it\ncontinues with 00010000.\n\nFixes #732.\n\nSigned-off-by: Julian Ladisch <eclipse.org-rtn@ladisch.de>", "committedDate": "2020-08-17T17:23:40Z", "type": "commit"}, {"oid": "16005295bea4447e98fe1484df5985b788ed8b38", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/16005295bea4447e98fe1484df5985b788ed8b38", "message": "Merge branch 'master' into HexSequence-PgPreparedStatement\n\nSigned-off-by: Julian Ladisch <eclipse.org-rtn@ladisch.de>", "committedDate": "2020-09-04T13:46:01Z", "type": "commit"}, {"oid": "4d4e1c1f734601ca4a6e5f0beb610ae4b3822bfa", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/4d4e1c1f734601ca4a6e5f0beb610ae4b3822bfa", "message": "Increment a long as counter\n\nSigned-off-by: Julian Ladisch <eclipse.org-rtn@ladisch.de>", "committedDate": "2020-09-04T13:47:40Z", "type": "commit"}, {"oid": "7934684555cc6181bf8db20106f95f7536325ae3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/7934684555cc6181bf8db20106f95f7536325ae3", "message": "Merge remote-tracking branch 'eclipse-vertx/master' into HexSequence-PgPreparedStatement", "committedDate": "2021-05-07T09:01:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTE1MzQ1Ng==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r629153456", "bodyText": "this should avoid using an intermediary string. Instead it should allocate the byte[] with the right length and poke the corresponding value in it.", "author": "vietj", "createdAt": "2021-05-10T08:33:15Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/HexSequence.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n+ * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+ */\n+\n+package io.vertx.sqlclient.impl;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Locale;\n+\n+/**\n+ * A sequence of hex values, each terminated by a zero byte.\n+ *\n+ * The hex number is left padded to start with at least three 0\n+ * and to have at least seven digits.\n+ *\n+ * After 000FFFFFFFFFFFFFFFF it will restart with 0000000.\n+ *\n+ * The generated sequence:\n+ * <pre>\n+ * 0000000\n+ * 0000001\n+ * 0000002\n+ * ...\n+ * 000FFFF\n+ * 00010000\n+ * ...\n+ * 000FFFFF\n+ * 000100000\n+ * ...\n+ * 000FFFFFF\n+ * 0001000000\n+ * ...\n+ * 000FFFFFFFFFFFFFFFF\n+ * </pre>\n+ */\n+public class HexSequence {\n+  private long i;\n+\n+  /**\n+   * Start the sequence with 0000000.\n+   */\n+  public HexSequence() {\n+    i = 0;\n+  }\n+\n+  /**\n+   * @param startValue unsigned long for the first value returned by {@link #next()}\n+   */\n+  public HexSequence(long startValue) {\n+    i = startValue;\n+  }\n+\n+  /**\n+   * @return a copy of the next hex value, terminated by a zero byte.\n+   */\n+  public byte[] next() {\n+    String hex = Long.toUnsignedString(i, 16).toUpperCase(Locale.ROOT);\n+    i++;\n+    switch (hex.length()) {\n+    case 1: return (\"000000\" + hex + \"\\0\").getBytes(StandardCharsets.US_ASCII);", "originalCommit": "7934684555cc6181bf8db20106f95f7536325ae3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTE2NDEyMg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r629164122", "bodyText": "for the hex conversion we can rely on branchless conversion https://gist.github.com/stryku/b8177a66f79540f912ca8b7909ffccda", "author": "vietj", "createdAt": "2021-05-10T08:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTE1MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTE3MDE2NQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r629170165", "bodyText": "although I'm not sure it's worth optimizing using branchless", "author": "vietj", "createdAt": "2021-05-10T08:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTE1MzQ1Ng=="}], "type": "inlineReview"}, {"oid": "a5276825d28f130b5ac3f75bf246c37a27e5ffe0", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/a5276825d28f130b5ac3f75bf246c37a27e5ffe0", "message": "Merge branch 'master' into HexSequence-PgPreparedStatement", "committedDate": "2021-06-03T22:35:06Z", "type": "commit"}, {"oid": "37fe67c1a1325a9614882bc481ea9e8c44207a6b", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/37fe67c1a1325a9614882bc481ea9e8c44207a6b", "message": "Directly calculate bytes, avoid Long.toUnsignedString", "committedDate": "2021-06-03T22:36:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2MTIzNA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651561234", "bodyText": "we should use a constant for this", "author": "vietj", "createdAt": "2021-06-15T08:20:58Z", "path": "vertx-pg-client/src/main/java/io/vertx/pgclient/impl/codec/PrepareStatementCommandCodec.java", "diffHunk": "@@ -38,7 +38,7 @@ void encode(PgEncoder encoder) {\n       statement = encoder.nextStatementName();\n     } else {\n       // Use unnamed prepared statements that don't need to be closed\n-      statement = 0L;\n+      statement = new byte[] { 0 };", "originalCommit": "37fe67c1a1325a9614882bc481ea9e8c44207a6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTY3ODA0Mg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651678042", "bodyText": "Replaced by EMPTY_STRING constant.", "author": "julianladisch", "createdAt": "2021-06-15T10:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2MTIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2MjY3Mg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651562672", "bodyText": "is that class still used ?", "author": "vietj", "createdAt": "2021-06-15T08:22:42Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/StringLongSequence.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n   private short count;\n \n+  /**", "originalCommit": "37fe67c1a1325a9614882bc481ea9e8c44207a6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTY3ODEyOA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651678128", "bodyText": "No, removed.", "author": "julianladisch", "createdAt": "2021-06-15T10:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2MjY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2NDEyMA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651564120", "bodyText": "@franz1981 do you mind having a look ?", "author": "vietj", "createdAt": "2021-06-15T08:24:31Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/HexSequence.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) 2021 Contributors to the Eclipse Foundation\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0, or the Apache License, Version 2.0\n+ * which is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+ */\n+\n+package io.vertx.sqlclient.impl;\n+\n+/**\n+ * A sequence of hex values, each terminated by a zero byte.\n+ *\n+ * <p>The hex number is left padded to start with at least three 0\n+ * and to have at least seven digits.\n+ *\n+ * <p>After 000FFFFFFFFFFFFFFFF it will restart with 0000000.\n+ *\n+ * <p>The generated sequence:\n+ * <pre>\n+ * 0000000\n+ * 0000001\n+ * 0000002\n+ * ...\n+ * 000FFFF\n+ * 00010000\n+ * ...\n+ * 000FFFFF\n+ * 000100000\n+ * ...\n+ * 000FFFFFF\n+ * 0001000000\n+ * ...\n+ * 000FFFFFFFFFFFFFFFF\n+ * </pre>\n+ */\n+public class HexSequence {\n+  private long i;\n+\n+  /**\n+   * Start the sequence with 0000000.\n+   */\n+  public HexSequence() {\n+    i = 0;\n+  }\n+\n+  /**\n+   * @param startValue unsigned long for the first value returned by {@link #next()}\n+   */\n+  public HexSequence(long startValue) {\n+    i = startValue;\n+  }\n+\n+  private static byte toHex(long c) {\n+    if (c < 10) {\n+      return (byte)('0' + c);\n+    } else {\n+      return (byte)('A' + c - 10);\n+    }\n+  }\n+\n+  /**\n+   * A copy of the next hex value, terminated by a zero byte.\n+   */\n+  public byte[] next() {", "originalCommit": "37fe67c1a1325a9614882bc481ea9e8c44207a6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2Nzk0Ng==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r651567946", "bodyText": "correctness or perf?", "author": "franz1981", "createdAt": "2021-06-15T08:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2NDEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDAwNjE3NA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r654006174", "bodyText": "correctness, it's not critical", "author": "vietj", "createdAt": "2021-06-17T22:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2NDEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDAwNjQwOA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/737#discussion_r654006408", "bodyText": "but it does not mean it should be slower than necessary :-)", "author": "vietj", "createdAt": "2021-06-17T22:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU2NDEyMA=="}], "type": "inlineReview"}, {"oid": "0cd43556f0a5bc4da6653aa7403cd36afe91f358", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/0cd43556f0a5bc4da6653aa7403cd36afe91f358", "message": "Use EMPTY_STRING constant\n\nSigned-off-by: Julian Ladisch <julianladisch@users.noreply.github.com>", "committedDate": "2021-06-15T10:41:39Z", "type": "commit"}, {"oid": "d0b00bb6e2b57ec914a055d207a25226ee1a19f4", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/d0b00bb6e2b57ec914a055d207a25226ee1a19f4", "message": "Delete unused StringLongSequence\n\nSigned-off-by: Julian Ladisch <julianladisch@users.noreply.github.com>", "committedDate": "2021-06-15T10:43:03Z", "type": "commit"}, {"oid": "67cb4c5320b7b2894f1ba31d38e937ac7c7c0e7d", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/67cb4c5320b7b2894f1ba31d38e937ac7c7c0e7d", "message": "Move i++ into separate line for readability\n\nSigned-off-by: Julian Ladisch <julianladisch@users.noreply.github.com>", "committedDate": "2021-06-15T11:00:43Z", "type": "commit"}]}