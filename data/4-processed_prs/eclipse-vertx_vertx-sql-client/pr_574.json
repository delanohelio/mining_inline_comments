{"pr_number": 574, "pr_title": "Simplified transaction API improvements", "pr_createdAt": "2020-04-06T12:33:10Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574", "timeline": [{"oid": "37d4af04b40e95f38fc4531dba7d788257ec1400", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/37d4af04b40e95f38fc4531dba7d788257ec1400", "message": "TransactionImpl should use TxCommand instead of comparing SQL for isComplete", "committedDate": "2020-04-05T20:12:42Z", "type": "commit"}, {"oid": "01f86383a77899bd84c3d4d788ea8a25b1265c1b", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/01f86383a77899bd84c3d4d788ea8a25b1265c1b", "message": "Now Transaction provides a result that can be used to track the transaction outcome", "committedDate": "2020-04-06T09:17:45Z", "type": "commit"}, {"oid": "630a0f3fbefe8f459ac245875978de106469c1ca", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/630a0f3fbefe8f459ac245875978de106469c1ca", "message": "Use an enum for TxCommand kind instead of being singletons", "committedDate": "2020-04-06T09:17:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406107065", "bodyText": "Can you clarify is it necessary that Transaction does not extend SqlClient anymore? I think it becomes more complicated since users have to use the connection API directly if doing some operations on a transaction.", "author": "BillyYccc", "createdAt": "2020-04-09T10:23:30Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/Transaction.java", "diffHunk": "@@ -26,7 +26,7 @@\n  * A transaction that allows to control the transaction and receive events.\n  */\n @VertxGen\n-public interface Transaction extends SqlClient {", "originalCommit": "060c1dec62332a2862d03f187ab7d6adb4d17ede", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExNDMzNA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406114334", "bodyText": "I removed it for several reasons:\n\nI wanted to have the ability to have Transaction extends Future<Void> instead of having a result() field and extending SqlClient was preventing this (unless we annotated SqlClient with @VertxGen(concrete = false))\nwe might add in the future the withTransaction method to SqlClient and in this case it does not make sense to have withTransaction on Transaction in this situation", "author": "vietj", "createdAt": "2020-04-09T10:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2Mjc4OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406162788", "bodyText": "how about duplicating the two interfaces query and preparedQuery on Transaction so that we can use Transaction instread of using the connection reference to schedule a command.", "author": "BillyYccc", "createdAt": "2020-04-09T12:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2NjU3OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406166578", "bodyText": "I believe Transaction should remain only there for managing transactions.", "author": "vietj", "createdAt": "2020-04-09T12:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2ODkyNQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406168925", "bodyText": "in other words, having Transaction extending SqlClient was a design mistake I did and I would like to fix it", "author": "vietj", "createdAt": "2020-04-09T12:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5NDEwNA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406494104", "bodyText": "ok, it seems that we could also remove Transaction#prepare in this interface?", "author": "BillyYccc", "createdAt": "2020-04-09T21:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5Njg5Mw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406496893", "bodyText": "yes totally, I think I forgot that and I will remove it, thanks for noticing", "author": "vietj", "createdAt": "2020-04-09T21:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5ODUxMw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406498513", "bodyText": "I will also likely remove the abortHandler as it is now replaced with the fact that the transaction has a Future that gives the overral transaction result and thus onComplete can be called instead.", "author": "vietj", "createdAt": "2020-04-09T21:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzIyNQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406513225", "bodyText": "the field could be removed and use completionPromise.future() instead.", "author": "BillyYccc", "createdAt": "2020-04-09T22:31:40Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/TransactionImpl.java", "diffHunk": "@@ -209,24 +218,12 @@ public void rollback(Handler<AsyncResult<Void>> handler) {\n     }\n   }\n \n-  @Override\n-  public void close() {\n-    rollback();\n-  }\n-\n-  @Override\n-  public io.vertx.sqlclient.Transaction abortHandler(Handler<Void> handler) {\n-    failedHandler = handler;\n-    return this;\n-  }\n-\n-  private ScheduledCommand<Void> doQuery(TxCommand cmd, Promise<Void> handler) {\n+  private <R> ScheduledCommand<R> doQuery(TxCommand<R> cmd, Promise<R> handler) {\n     return new ScheduledCommand<>(cmd, handler);\n   }\n-  \n+\n   @Override\n-  boolean autoCommit() {\n-    return false;\n+  public Future<Void> completion() {\n+    return completionFuture;", "originalCommit": "4797965a02ce7ee9e917b03be64ae2245f389582", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzg0OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406513848", "bodyText": "we can let the TransactionRollbackException include the failure context here, like new TransactionRollbackException(ar.cause).", "author": "BillyYccc", "createdAt": "2020-04-09T22:33:28Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/TransactionImpl.java", "diffHunk": "@@ -58,21 +64,61 @@\n     }\n   }\n \n-  @Override\n-  protected <T> Promise<T> promise() {\n-    return context.promise();\n+  Future<Transaction> begin() {\n+    PromiseInternal<Transaction> promise = context.promise(this::afterBegin);\n+    ScheduledCommand<Transaction> b = doQuery(new TxCommand<>(TxCommand.Kind.BEGIN, this), promise);\n+    doSchedule(b.cmd, b.handler);\n+    return promise.future();\n   }\n \n-  @Override\n-  protected <T> Promise<T> promise(Handler<AsyncResult<T>> handler) {\n-    return context.promise(handler);\n+  private <R> void doSchedule(CommandBase<R> cmd, Handler<AsyncResult<R>> handler) {\n+    connection.schedule(cmd, context.promise(handler));\n   }\n \n-  private <R> void doSchedule(CommandBase<R> cmd, Handler<AsyncResult<R>> handler) {\n-    conn.schedule(cmd, context.promise(handler));\n+  private <R> void wrapAndSchedule(ScheduledCommand<R> scheduled) {\n+    CommandBase<R> cmd = scheduled.cmd;\n+    if (isComplete(cmd)) {\n+      status = ST_COMPLETED;\n+      doSchedule(cmd, ar -> {\n+        if (ar.succeeded()) {\n+          if (cmd == COMMIT) {\n+            completionPromise.tryComplete();\n+          } else {\n+            completionPromise.tryFail(TransactionRollbackException.INSTANCE);", "originalCommit": "4797965a02ce7ee9e917b03be64ae2245f389582", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxNDc3Nw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406514777", "bodyText": "my bad, it's not possible here", "author": "BillyYccc", "createdAt": "2020-04-09T22:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzg0OA=="}], "type": "inlineReview"}, {"oid": "949961b1284ada235558dfaa1ad332230a129195", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/949961b1284ada235558dfaa1ad332230a129195", "message": "TxCommand now has a generic result instead of a void result", "committedDate": "2020-04-10T11:45:55Z", "type": "commit"}, {"oid": "4710fbef5579034045de5e11dcb0849bf8b1ffbe", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/4710fbef5579034045de5e11dcb0849bf8b1ffbe", "message": "SqlConnection begin returns a Future<Transaction>", "committedDate": "2020-04-10T11:45:55Z", "type": "commit"}, {"oid": "5f707f523845f7209b9384aa001111548035569f", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/5f707f523845f7209b9384aa001111548035569f", "message": "Transaction API improvements\n- Transaction does not extend anymore SqlClient\n- Pool#begin is removed\n- new simplified transaction API with Pool#withTransaction", "committedDate": "2020-04-10T12:08:46Z", "type": "commit"}, {"oid": "82024de2d86459f0224dc8c19f4a2cb9e1329269", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/82024de2d86459f0224dc8c19f4a2cb9e1329269", "message": "Remove prepare method on Transaction", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "efe6539fd01aaee37875cde8dde2289528ce0afc", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/efe6539fd01aaee37875cde8dde2289528ce0afc", "message": "Remove abort handler", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "fc069553c33b0b14c81e95847b949e2bf6723b98", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/fc069553c33b0b14c81e95847b949e2bf6723b98", "message": "Rename Transaction#result() => Transaction#completion()", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "bf02d3a9e1f2149b49fa29b5824ce7fc12d92aad", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/bf02d3a9e1f2149b49fa29b5824ce7fc12d92aad", "message": "Remove Transaction#close()", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "16cc918ac56366a069ce7d8282546f0f68fdca5e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/16cc918ac56366a069ce7d8282546f0f68fdca5e", "message": "Only keep the completion Promise in Transaction and remove the future field", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "0453bb30caf6cbd9434b7ae6936a789202a5ac7e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/0453bb30caf6cbd9434b7ae6936a789202a5ac7e", "message": "More improvements", "committedDate": "2020-04-10T12:08:47Z", "type": "commit"}, {"oid": "88f8a396d78a3a519164736e46270d4fcda4d407", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/88f8a396d78a3a519164736e46270d4fcda4d407", "message": "Fix autocommit bug with DB2", "committedDate": "2020-04-10T15:46:48Z", "type": "commit"}, {"oid": "88f8a396d78a3a519164736e46270d4fcda4d407", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/88f8a396d78a3a519164736e46270d4fcda4d407", "message": "Fix autocommit bug with DB2", "committedDate": "2020-04-10T15:46:48Z", "type": "forcePushed"}]}