{"pr_number": 625, "pr_title": "Tracing support", "pr_createdAt": "2020-05-13T08:18:49Z", "pr_url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625", "timeline": [{"oid": "f9792f826aea3ecf14e8acb42a8c7fd75b0baea0", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/f9792f826aea3ecf14e8acb42a8c7fd75b0baea0", "message": "Move all query command execution method in SqlResultBuilder", "committedDate": "2020-05-22T08:58:23Z", "type": "commit"}, {"oid": "196411df0d07c3bc1d9d431384eca7fdbeb71e33", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/196411df0d07c3bc1d9d431384eca7fdbeb71e33", "message": "Initial implementation of SQL client tracing", "committedDate": "2020-05-22T10:07:08Z", "type": "forcePushed"}, {"oid": "624a111d7badfdc61c2d48f0090f49ce06fb5237", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/624a111d7badfdc61c2d48f0090f49ce06fb5237", "message": "Initial implementation of SQL client tracing", "committedDate": "2020-05-22T10:17:59Z", "type": "commit"}, {"oid": "624a111d7badfdc61c2d48f0090f49ce06fb5237", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/624a111d7badfdc61c2d48f0090f49ce06fb5237", "message": "Initial implementation of SQL client tracing", "committedDate": "2020-05-22T10:17:59Z", "type": "forcePushed"}, {"oid": "680b3291f4337a589877766b214b7348049fccb5", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/680b3291f4337a589877766b214b7348049fccb5", "message": "Minor", "committedDate": "2020-05-22T11:38:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4OTAzNg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429289036", "bodyText": "do we have to add the prepared statement parameters?(we could make it optional for saving the large payload transmission)", "author": "BillyYccc", "createdAt": "2020-05-22T14:42:45Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/tracing/QueryRequest.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package io.vertx.sqlclient.impl.tracing;\n+\n+import io.vertx.sqlclient.Tuple;\n+\n+import java.util.List;\n+\n+/**\n+ * A traceable query.\n+ */\n+public class QueryRequest {\n+\n+  final SqlTracer tracer;\n+  final String sql;\n+  final List<Tuple> tuples;\n+\n+  public QueryRequest(SqlTracer tracer, String sql, List<Tuple> tuples) {\n+    this.tracer = tracer;\n+    this.sql = sql;\n+    this.tuples = tuples;", "originalCommit": "680b3291f4337a589877766b214b7348049fccb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNDg1NA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429334854", "bodyText": "aren't tuples the prepared statement parameters ?", "author": "vietj", "createdAt": "2020-05-22T16:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4OTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTMyMQ==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429341321", "bodyText": "I mean we could make sending statement parameters as part of payload an option for users. Because the parameter might be a big BLOB or text value, sending them over the network would  not be a good choice and there's hardly any benefit on this.", "author": "BillyYccc", "createdAt": "2020-05-22T16:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4OTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NDc5Nw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429344797", "bodyText": "this actually is not logged by the tracers, if you look at it, a tracer would need to cast the request to a QueryRequest and do something with parameters. It seems that by default tracers don't care about parameters. So we only provide opportunity for a tracer to downcast to a QueryRequest and do something with them if they way. If that's a blob then it is up to the tracer to care about the payload issue, not the SQL client", "author": "vietj", "createdAt": "2020-05-22T16:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4OTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUxNDExMw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429514113", "bodyText": "ok I see how this works in vertx-tracing", "author": "BillyYccc", "createdAt": "2020-05-23T04:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4OTAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5MDA2OA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429290068", "bodyText": "the host might be an unresolved hostname,  we need to use SocketAddress to represent ip:port, hostname, ip, etc... more accurately.", "author": "BillyYccc", "createdAt": "2020-05-22T14:44:25Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/tracing/SqlTracer.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.vertx.sqlclient.impl.tracing;\n+\n+import io.vertx.core.impl.ContextInternal;\n+import io.vertx.core.spi.tracing.TagExtractor;\n+import io.vertx.core.spi.tracing.VertxTracer;\n+import io.vertx.sqlclient.SqlConnectOptions;\n+import io.vertx.sqlclient.Tuple;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+/**\n+ * Tracer for SQL client, wrapping the generic tracer.\n+ */\n+public class SqlTracer {\n+\n+  enum RequestTags {\n+\n+    // Generic\n+    PEER_ADDRESS(\"peer.address\", q -> q.tracer.address),\n+    PEER_SERVICE(\"peer.service\", q -> \"todo\"),\n+    SPAN_KIND(\"span.kind\", q -> \"client\"),\n+\n+    // DB\n+    // See https://github.com/opentracing/specification/blob/master/semantic_conventions.md\n+\n+    DB_USER(\"db.user\", q -> q.tracer.user),\n+    DB_INSTANCE(\"db.instance\", q -> q.tracer.database),\n+    DB_STATEMENT(\"db.statement\", QueryRequest::sql),\n+    DB_TYPE(\"db.type\", q -> \"sql\");\n+\n+    final String name;\n+    final Function<QueryRequest, String> fn;\n+\n+    RequestTags(String name, Function<QueryRequest, String> fn) {\n+      this.name = name;\n+      this.fn = fn;\n+    }\n+  }\n+\n+  private static final TagExtractor<QueryRequest> REQUEST_TAG_EXTRACTOR = new TagExtractor<QueryRequest>() {\n+\n+    private final RequestTags[] TAGS = RequestTags.values();\n+\n+    @Override\n+    public int len(QueryRequest obj) {\n+      return TAGS.length;\n+    }\n+    @Override\n+    public String name(QueryRequest obj, int index) {\n+      return TAGS[index].name;\n+    }\n+    @Override\n+    public String value(QueryRequest obj, int index) {\n+      return TAGS[index].fn.apply(obj);\n+    }\n+  };\n+\n+  private final VertxTracer tracer;\n+  private final String address;\n+  private final String host;\n+  private final int port;\n+  private final String user;\n+  private final String database;\n+\n+  public SqlTracer(VertxTracer tracer, SqlConnectOptions options) {\n+    this.tracer = tracer;\n+    this.address = options.getHost() + \":\" + options.getPort();", "originalCommit": "680b3291f4337a589877766b214b7348049fccb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNjU5NA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429336594", "bodyText": "likely yes, but we cannot use it in options because it's not an option object", "author": "vietj", "createdAt": "2020-05-22T16:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5MDA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429314423", "bodyText": "peer.service is not used for now", "author": "BillyYccc", "createdAt": "2020-05-22T15:29:11Z", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/tracing/SqlTracer.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.vertx.sqlclient.impl.tracing;\n+\n+import io.vertx.core.impl.ContextInternal;\n+import io.vertx.core.spi.tracing.TagExtractor;\n+import io.vertx.core.spi.tracing.VertxTracer;\n+import io.vertx.sqlclient.SqlConnectOptions;\n+import io.vertx.sqlclient.Tuple;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Function;\n+\n+/**\n+ * Tracer for SQL client, wrapping the generic tracer.\n+ */\n+public class SqlTracer {\n+\n+  enum RequestTags {\n+\n+    // Generic\n+    PEER_ADDRESS(\"peer.address\", q -> q.tracer.address),\n+    PEER_SERVICE(\"peer.service\", q -> \"todo\"),", "originalCommit": "680b3291f4337a589877766b214b7348049fccb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMTY5Mg==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429331692", "bodyText": "I think that peer.service is something the user can provide, I think we might simply have this part of the TracingOptions when creating Vert.x and leave it the tracer actually set it", "author": "vietj", "createdAt": "2020-05-22T16:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNDc3Ng==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429334776", "bodyText": "I think that peer.service is something the user can provide, I think we might simply have this part of the TracingOptions when creating Vert.x and leave it the tracer actually set it", "author": "vietj", "createdAt": "2020-05-22T16:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNzg4Mw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429337883", "bodyText": "I think actually in our case we should not use this tag", "author": "vietj", "createdAt": "2020-05-22T16:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzODE3MA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429338170", "bodyText": "from https://docs.instana.io/ecosystem/opentracing/ \"Set the peer.service tag if you don't know the remote side is instrumented. In general, it is not required as long as the remote side is monitored by Instana and, in that case, it will automatically have a service name set. If peer.service is set in the client call and the server is instrumented and has a custom service name, the results are undefined.\" so we don't need it as it's a backend not service", "author": "vietj", "createdAt": "2020-05-22T16:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUxNDUyOA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429514528", "bodyText": "+1 I think in our SQL client usecase we don't need to add this.", "author": "BillyYccc", "createdAt": "2020-05-23T04:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNTM5Nw==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429315397", "bodyText": "in the assertions order of the expected value and actual value is reversed which reports wrong error messages when tests fail.", "author": "BillyYccc", "createdAt": "2020-05-22T15:31:03Z", "path": "vertx-pg-client/src/test/java/io/vertx/pgclient/TracingTest.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package io.vertx.pgclient;\n+\n+import io.vertx.core.Context;\n+import io.vertx.core.Future;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.core.spi.VertxTracerFactory;\n+import io.vertx.core.spi.tracing.TagExtractor;\n+import io.vertx.core.spi.tracing.VertxTracer;\n+import io.vertx.core.tracing.TracingOptions;\n+import io.vertx.ext.unit.Async;\n+import io.vertx.ext.unit.TestContext;\n+import io.vertx.sqlclient.PoolOptions;\n+import io.vertx.sqlclient.RowSet;\n+import io.vertx.sqlclient.SqlClient;\n+import io.vertx.sqlclient.Tuple;\n+import io.vertx.sqlclient.impl.tracing.QueryRequest;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.BiConsumer;\n+import java.util.function.Function;\n+\n+public class TracingTest extends PgTestBase {\n+\n+  Vertx vertx;\n+  VertxTracer tracer;\n+  PgPool pool;\n+\n+  @Before\n+  public void setup() throws Exception {\n+    super.setup();\n+    vertx = Vertx.vertx(new VertxOptions().setTracingOptions(\n+      new TracingOptions().setEnabled(true).setFactory(tracingOptions -> new VertxTracer() {\n+        @Override\n+        public Object sendRequest(Context context, Object request, String operation, BiConsumer headers, TagExtractor tagExtractor) {\n+          return tracer.sendRequest(context, request, operation, headers, tagExtractor);\n+        }\n+\n+        @Override\n+        public void receiveResponse(Context context, Object response, Object payload, Throwable failure, TagExtractor tagExtractor) {\n+          tracer.receiveResponse(context, response, payload, failure, tagExtractor);\n+        }\n+      }))\n+    );\n+    pool = PgPool.pool(vertx, options, new PoolOptions());\n+  }\n+\n+  @After\n+  public void teardown(TestContext ctx) {\n+    vertx.close(ctx.asyncAssertSuccess());\n+  }\n+\n+  @Test\n+  public void testTraceSimpleQuery(TestContext ctx) {\n+    String sql = \"SELECT * FROM Fortune WHERE id=1\";\n+    testTraceQuery(ctx, sql, Collections.emptyList(), conn -> conn.query(sql).execute());\n+  }\n+\n+  @Test\n+  public void testTracePreparedQuery(TestContext ctx) {\n+    String sql = \"SELECT * FROM Fortune WHERE id=$1\";\n+    Tuple tuple = Tuple.of(1);\n+    testTraceQuery(ctx, sql, Collections.singletonList(tuple), conn -> conn.preparedQuery(sql).execute(tuple));\n+  }\n+\n+  @Test\n+  public void testTraceBatchQuery(TestContext ctx) {\n+    String sql = \"SELECT * FROM Fortune WHERE id=$1\";\n+    List<Tuple> tuples = Arrays.asList(Tuple.of(1), Tuple.of(2));\n+    testTraceQuery(ctx, sql, tuples, conn -> conn.preparedQuery(sql).executeBatch(tuples));\n+  }\n+\n+  public void testTraceQuery(TestContext ctx, String expectedSql, List<Tuple> expectedTuples, Function<SqlClient, Future<?>> fn) {\n+    AtomicBoolean called = new AtomicBoolean();\n+    AtomicReference<Context> requestContext = new AtomicReference<>();\n+    AtomicReference<Context> responseContext = new AtomicReference<>();\n+    Object expectedPayload = new Object();\n+    tracer = new VertxTracer<Object, Object>() {\n+      @Override\n+      public <R> Object sendRequest(Context context, R request, String operation, BiConsumer<String, String> headers, TagExtractor<R> tagExtractor) {\n+        QueryRequest query = (QueryRequest) request;\n+        ctx.assertEquals(query.sql(), expectedSql);", "originalCommit": "680b3291f4337a589877766b214b7348049fccb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNDgyMA==", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/625#discussion_r429334820", "bodyText": "right :-)", "author": "vietj", "createdAt": "2020-05-22T16:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNTM5Nw=="}], "type": "inlineReview"}, {"oid": "899deeafc3869268e20d3324020f853337352ea8", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/899deeafc3869268e20d3324020f853337352ea8", "message": "Remove peer.service that does not make any sense here", "committedDate": "2020-05-23T09:28:06Z", "type": "commit"}, {"oid": "c950b72051d734d1aab730042afd315f7d9ad093", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/c950b72051d734d1aab730042afd315f7d9ad093", "message": "Revert some assertEquals operands to get correct failure reporting", "committedDate": "2020-05-23T09:29:55Z", "type": "commit"}, {"oid": "ada9240b11eaa58407f8a56450f669c47e6b246e", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/ada9240b11eaa58407f8a56450f669c47e6b246e", "message": "A few internal renaming", "committedDate": "2020-05-23T09:36:09Z", "type": "commit"}, {"oid": "32ebb46bf67bee69b3cd3d92dab07a3e3d72b9db", "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/32ebb46bf67bee69b3cd3d92dab07a3e3d72b9db", "message": "Rename SqlTracer -> QueryTracer", "committedDate": "2020-05-24T08:05:06Z", "type": "commit"}]}