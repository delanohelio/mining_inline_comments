{"pr_number": 1101, "pr_title": "DPC 570 fix silently failing smoke tests", "pr_createdAt": "2020-10-23T15:25:08Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1101", "timeline": [{"oid": "658f95030130a7f93a66ae559b4e99a046119ee2", "url": "https://github.com/CMSgov/dpc-app/commit/658f95030130a7f93a66ae559b4e99a046119ee2", "message": "Disabled lookback for smoketest orgs", "committedDate": "2020-10-12T06:57:13Z", "type": "commit"}, {"oid": "0cb52f29b686dba931633f5f5e4756407a0035df", "url": "https://github.com/CMSgov/dpc-app/commit/0cb52f29b686dba931633f5f5e4756407a0035df", "message": "Fixed app configs", "committedDate": "2020-10-12T20:01:35Z", "type": "commit"}, {"oid": "154ded0543662586e2b391560dc55feb2cde77c1", "url": "https://github.com/CMSgov/dpc-app/commit/154ded0543662586e2b391560dc55feb2cde77c1", "message": "Merge branch 'master' into sg/DPC-725-bypass-lookback-during-smoke-testing", "committedDate": "2020-10-12T20:12:08Z", "type": "commit"}, {"oid": "76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "url": "https://github.com/CMSgov/dpc-app/commit/76ec6cf32f8b91213b1b3bef9fb1f2ffe3fdec0e", "message": "Fixed NPE in mock blueButton Client", "committedDate": "2020-10-15T16:08:44Z", "type": "commit"}, {"oid": "bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "url": "https://github.com/CMSgov/dpc-app/commit/bdb58c5d1287cd9212740929ad94dcc6fa4218e4", "message": "Reverted smoke test changes.", "committedDate": "2020-10-15T17:13:48Z", "type": "commit"}, {"oid": "440a848b6233370b7af9ab71acf4aedfe12f4912", "url": "https://github.com/CMSgov/dpc-app/commit/440a848b6233370b7af9ab71acf4aedfe12f4912", "message": "Enabled checking of data contents during smoke tests. Refactored smoke tests. Fixed failing smoke tests", "committedDate": "2020-10-15T17:54:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2MjU1OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r510962558", "bodyText": "Method runAndMonitorExportJob has 6 arguments (exceeds 4 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-10-23T15:26:11Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -221,18 +204,20 @@ public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n             patientSample.sampleEnd();\n             smokeTestResult.addSubResult(patientSample);\n         }\n+        return patientReferences;\n+    }\n \n \n-        // Upload the roster bundle\n+    private void uploadRosterBundle(JavaSamplerContext samplerContext, Bundle providerBundle, IGenericClient exportClient, Map<String,Reference> patientReferences){\n         logger.debug(\"Uploading roster\");\n         try {\n-            ClientUtils.createAndUploadRosters(javaSamplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n+            ClientUtils.createAndUploadRosters(samplerContext.getParameter(\"seed-file\"), providerBundle, exportClient, UUID.fromString(organizationID), patientReferences);\n         } catch (Exception e) {\n             throw new IllegalStateException(\"Cannot upload roster\", e);\n         }\n+    }\n \n-        // Run the job\n-        // Create a custom http client to use for monitoring the non-FHIR export request\n+    private void runAndMonitorExportJob(SampleResult smokeTestResult, String hostParam, String clientToken, Pair<UUID, PrivateKey> keyTuple, IGenericClient exportClient, List<String> providerNPIs){", "originalCommit": "440a848b6233370b7af9ab71acf4aedfe12f4912", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0119681253fb04ac0b639b5c0778357c19f7952", "url": "https://github.com/CMSgov/dpc-app/commit/e0119681253fb04ac0b639b5c0778357c19f7952", "message": "Resolved Merge Conflicts", "committedDate": "2020-10-23T15:52:01Z", "type": "commit"}, {"oid": "1d3096c13126ec651be1adac005a46674fae0460", "url": "https://github.com/CMSgov/dpc-app/commit/1d3096c13126ec651be1adac005a46674fae0460", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-10-28T23:44:01Z", "type": "commit"}, {"oid": "9828b22b2b9b1c58d63922b2703b6cbf996d5657", "url": "https://github.com/CMSgov/dpc-app/commit/9828b22b2b9b1c58d63922b2703b6cbf996d5657", "message": "Fixed make ci-app issues. Added extra check when deleting an org during smoke tests", "committedDate": "2020-10-29T04:59:02Z", "type": "commit"}, {"oid": "59f70fcf5c3e5c069fe457f636b018d58277081c", "url": "https://github.com/CMSgov/dpc-app/commit/59f70fcf5c3e5c069fe457f636b018d58277081c", "message": "Merge branch 'sg/DPC-570-Fix-Failing-Smoke-Tests' of https://github.com/CMSgov/dpc-app into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-10-29T04:59:17Z", "type": "commit"}, {"oid": "559bd4cffcbaeabd841a439bd552d3d8955d61e7", "url": "https://github.com/CMSgov/dpc-app/commit/559bd4cffcbaeabd841a439bd552d3d8955d61e7", "message": "Smoke Test: added checks for errors withing operation outcomes, checking for empty data files.", "committedDate": "2020-10-29T06:39:10Z", "type": "commit"}, {"oid": "cf580b3286798c8d887eaed1cae8d2192503367a", "url": "https://github.com/CMSgov/dpc-app/commit/cf580b3286798c8d887eaed1cae8d2192503367a", "message": "Smoke tests: checked data file contents", "committedDate": "2020-10-29T14:05:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMTc4OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514321788", "bodyText": "would it be possible to log the error here so that we know what is going on?", "author": "jonfulk", "createdAt": "2020-10-29T14:53:22Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -61,11 +66,10 @@ static void handleExportJob(IGenericClient exportClient, List<String> providerNP\n                 .map(npi -> exportRequestDispatcher(exportClient, npi))\n                 .map(search -> (Group) search.getEntryFirstRep().getResource())\n                 .map(group -> jobCompletionLambda(exportClient, httpClient, group, overrideURL))\n-                //TODO: ignore until we can skip lookback per request and switch over to use real bfd client\n-//                .peek(jobResponse -> {\n-//                    if (jobResponse.getError().size() > 0)\n-//                        throw new IllegalStateException(\"Export job completed, but with errors\");\n-//                })\n+                .peek(jobResponse -> {\n+                    if (jobResponse.getError().size() > 0)\n+                        throw new IllegalStateException(\"Export job completed, but with errors\");", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA4NzIzNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r521087235", "bodyText": "They are found in the operation outcome files.", "author": "MrMorie", "createdAt": "2020-11-11T03:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMTc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMzUxNA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514323514", "bodyText": "should this check be case insensitive?", "author": "jonfulk", "createdAt": "2020-10-29T14:55:22Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();\n+                JsonArray outcomeIssues = outcomeEntry.getAsJsonArray(\"issue\");\n+                String finalLine = line;\n+                outcomeIssues.forEach(issue-> {\n+                    if(\"error\".equals(issue.getAsJsonObject().get(\"severity\").getAsString())){", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5MjA3Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514392073", "bodyText": "not sure, but good point. ill make the change.", "author": "MrMorie", "createdAt": "2020-10-29T16:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMzUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyNzgyOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514327829", "bodyText": "Seems like we should check that the created org is what we expect before confirming that it was created, but maybe you do that in createOrganization", "author": "jonfulk", "createdAt": "2020-10-29T15:00:26Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5MzU4Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514393582", "bodyText": "I think that would go beyond the scope of what we are trying to cover in our smoke tests. here this flag is only used to determine if the org can be safely deleted.", "author": "MrMorie", "createdAt": "2020-10-29T16:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyNzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyOTAxMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514329011", "bodyText": "it's long, but i would call this practitionerSubmitResults for clarity.", "author": "jonfulk", "createdAt": "2020-10-29T15:01:58Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;\n+\n+        Pair<UUID, PrivateKey> keyTuple = createPublicKey(apiURL);\n \n-            // Create a new public key\n-            try {\n-                keyTuple = APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n-            } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n-                throw new IllegalStateException(\"Failed uploading public key\", e);\n-            }\n-        } else {\n-            // Parse the private key and create a new ID/PrivateKey tuple\n-            final Path path = Paths.get(privateKeyPath);\n-            try (final PEMParser pemParser = new PEMParser(Files.newBufferedReader(path, StandardCharsets.UTF_8))) {\n-                JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\n-                Object object = pemParser.readObject();\n-                KeyPair kp = converter.getKeyPair((PEMKeyPair) object);\n-                PrivateKey privateKey = kp.getPrivate();\n-                if (privateKey == null) {\n-                    throw new IllegalStateException(\"Key cannot be null\");\n-                }\n-                keyTuple = Pair.of(UUID.fromString(keyID), privateKey);\n-            } catch (IOException e) {\n-                throw new IllegalArgumentException(String.format(\"Cannot read private key from: %s\", privateKeyPath));\n-            }\n-        }\n         // Create an authenticated and async client (the async part is ignored by other endpoints)\n-        final IGenericClient exportClient;\n+        final IGenericClient exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, apiURL, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+\n+        Pair<Bundle, List<String>> practSubmitResults = submitPractitioners(javaSamplerContext, smokeTestResult, exportClient);", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMTQwNg==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514331406", "bodyText": "you removed String.format() before and used {} for interpolation instead. we should that here too.", "author": "jonfulk", "createdAt": "2020-10-29T15:05:08Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -102,85 +95,77 @@ public void teardownTest(JavaSamplerContext context) {\n \n     @Override\n     public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n-        // Create things\n-        final String hostParam = javaSamplerContext.getParameter(\"host\");\n+        final String apiURL = javaSamplerContext.getParameter(\"host\");\n         final String adminURL = javaSamplerContext.getParameter(\"admin-url\");\n-        logger.info(\"Running against {}\", hostParam);\n+        logger.info(\"Running against {}\", apiURL);\n         logger.info(\"Admin URL: {}\", adminURL);\n         logger.info(\"Running with {} threads\", JMeterContextService.getNumberOfThreads());\n \n-        this.organizationID = javaSamplerContext.getParameter(\"organization-id\");\n-        String clientToken = javaSamplerContext.getParameter(\"client-token\");\n-        String privateKeyPath = javaSamplerContext.getParameter(\"private-key\");\n-        final String keyID = javaSamplerContext.getParameter(\"key-id\");\n+        this.organizationID = getTestOrganizationId(javaSamplerContext);\n \n         final SampleResult smokeTestResult = new SampleResult();\n         smokeTestResult.setSampleLabel(\"Smoke Test\");\n-        // False, unless proven otherwise\n         smokeTestResult.setSuccessful(false);\n         smokeTestResult.sampleStart();\n \n         // Disable validation against Attribution service\n         this.ctx = FhirContext.forDstu3();\n \n-        // If we're not supplied all the init parameters, create a new org\n-        Pair<UUID, PrivateKey> keyTuple;\n-        if (organizationID.equals(\"\") || clientToken.equals(\"\") || privateKeyPath.equals(\"\") || keyID.equals(\"\")) {\n-            this.organizationID = UUID.randomUUID().toString();\n+        try {\n+            this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n+        } catch (Exception e) {\n+            throw new IllegalStateException(\"Failed creating Macaroon\", e);\n+        }\n \n-            logger.info(String.format(\"Creating organization %s\", organizationID));\n+        final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, apiURL, goldenMacaroon, true, true);\n \n-            try {\n-                this.goldenMacaroon = APIAuthHelpers.createGoldenMacaroon(adminURL);\n-            } catch (Exception e) {\n-                throw new IllegalStateException(\"Failed creating Macaroon\", e);\n-            }\n-            // Create admin client for registering organization\n-            final IGenericClient adminClient = APIAuthHelpers.buildAdminClient(ctx, hostParam, goldenMacaroon, true, true);\n-\n-            final SampleResult orgRegistrationResult = new SampleResult();\n-            smokeTestResult.addSubResult(orgRegistrationResult);\n-\n-            orgRegistrationResult.sampleStart();\n-            try {\n-                String npi = NPIUtil.generateNPI();\n-                clientToken = FHIRHelpers.registerOrganization(adminClient, ctx.newJsonParser(), organizationID, npi, adminURL);\n-                orgRegistrationResult.setSuccessful(true);\n-            } catch (Exception e) {\n-                orgRegistrationResult.setSuccessful(false);\n-                throw new IllegalStateException(\"Cannot register org\", e);\n-            } finally {\n-                orgRegistrationResult.sampleEnd();\n-            }\n+        String clientToken = createOrganization(smokeTestResult, adminClient, adminURL);\n+        orgWasCreated = true;\n+\n+        Pair<UUID, PrivateKey> keyTuple = createPublicKey(apiURL);\n \n-            // Create a new public key\n-            try {\n-                keyTuple = APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n-            } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n-                throw new IllegalStateException(\"Failed uploading public key\", e);\n-            }\n-        } else {\n-            // Parse the private key and create a new ID/PrivateKey tuple\n-            final Path path = Paths.get(privateKeyPath);\n-            try (final PEMParser pemParser = new PEMParser(Files.newBufferedReader(path, StandardCharsets.UTF_8))) {\n-                JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(\"BC\");\n-                Object object = pemParser.readObject();\n-                KeyPair kp = converter.getKeyPair((PEMKeyPair) object);\n-                PrivateKey privateKey = kp.getPrivate();\n-                if (privateKey == null) {\n-                    throw new IllegalStateException(\"Key cannot be null\");\n-                }\n-                keyTuple = Pair.of(UUID.fromString(keyID), privateKey);\n-            } catch (IOException e) {\n-                throw new IllegalArgumentException(String.format(\"Cannot read private key from: %s\", privateKeyPath));\n-            }\n-        }\n         // Create an authenticated and async client (the async part is ignored by other endpoints)\n-        final IGenericClient exportClient;\n+        final IGenericClient exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, apiURL, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+\n+        Pair<Bundle, List<String>> practSubmitResults = submitPractitioners(javaSamplerContext, smokeTestResult, exportClient);\n+\n+        final Map<String, Reference> patientReferences = submitPatients(javaSamplerContext, smokeTestResult, exportClient);\n+\n+        uploadRosterBundle(javaSamplerContext, practSubmitResults.getLeft(), exportClient, patientReferences);\n \n-        exportClient = APIAuthHelpers.buildAuthenticatedClient(ctx, hostParam, clientToken, keyTuple.getLeft(), keyTuple.getRight(), true, true);\n+        runAndMonitorExportJob(smokeTestResult, apiURL, clientToken, keyTuple, exportClient, practSubmitResults.getRight());\n \n-        // Upload a batch of patients and a batch of providers\n+        return smokeTestResult;\n+    }\n+\n+    private Pair<UUID, PrivateKey> createPublicKey(String hostParam){\n+        try {\n+            return APIAuthHelpers.generateAndUploadKey(KEY_ID, organizationID, goldenMacaroon, hostParam);\n+        } catch (IOException | URISyntaxException | GeneralSecurityException e) {\n+            throw new IllegalStateException(\"Failed uploading public key\", e);\n+        }\n+    }\n+\n+    private String createOrganization(SampleResult smokeTestResult, IGenericClient adminClient, String adminURL){\n+        logger.info(String.format(\"Creating organization %s\", organizationID));", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMjAwNA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514332004", "bodyText": "we use practitioner in some places and provider in other places. Are they the same?", "author": "jonfulk", "createdAt": "2020-10-29T15:05:56Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/SmokeTest.java", "diffHunk": "@@ -203,14 +188,16 @@ public SampleResult runTest(JavaSamplerContext javaSamplerContext) {\n         } finally {\n             practitionerSample.sampleEnd();\n         }\n-\n         smokeTestResult.addSubResult(practitionerSample);\n+        return Pair.of(providerBundle, providerNPIs);", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA5MTA3Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r521091077", "bodyText": "They are the same. We will need to revisit refactoring or rewriting these tests eventually.", "author": "MrMorie", "createdAt": "2020-11-11T03:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMjAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM3MDc4MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r514370781", "bodyText": "Define and throw a dedicated exception instead of using a generic one.", "author": "codeclimate", "createdAt": "2020-10-29T15:54:17Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();\n+                JsonArray outcomeIssues = outcomeEntry.getAsJsonArray(\"issue\");\n+                String finalLine = line;\n+                outcomeIssues.forEach(issue-> {\n+                    if(\"error\".equals(issue.getAsJsonObject().get(\"severity\").getAsString())){\n+                        throw new IllegalStateException(String.format(\"Operation outcome contains an error: File path:  %s, Error line: %s\", outcomeFile.getPath(), finalLine));\n+                    }\n+                });\n+                line = reader.readLine();\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Cannot read operation outcome file.\", e);", "originalCommit": "cf580b3286798c8d887eaed1cae8d2192503367a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29daf2a1e3d7fafd94e25231fd4a9350ff25a006", "url": "https://github.com/CMSgov/dpc-app/commit/29daf2a1e3d7fafd94e25231fd4a9350ff25a006", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-10-29T16:25:34Z", "type": "commit"}, {"oid": "a3403fbb9dba19216ef89fbef40776a4326d68f4", "url": "https://github.com/CMSgov/dpc-app/commit/a3403fbb9dba19216ef89fbef40776a4326d68f4", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-10-30T15:32:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExMzk2Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r516113967", "bodyText": "You can use the fhircontext to get a json parser that will parse it directly to an OperationOutcome object", "author": "MrBilnon", "createdAt": "2020-11-02T16:54:53Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){\n+                verifyOperationOutcomeContents(file);\n+            }\n         } catch (IOException e) {\n             throw new RuntimeException(\"Cannot output file\", e);\n         }\n     }\n \n+    private static void verifyOperationOutcomeContents(File outcomeFile){\n+        try (BufferedReader reader = Files.newBufferedReader(outcomeFile.toPath(), Charset.defaultCharset())){\n+            String line = reader.readLine();\n+            while (line != null) {\n+                JsonObject outcomeEntry = new JsonParser().parse(line).getAsJsonObject();", "originalCommit": "a3403fbb9dba19216ef89fbef40776a4326d68f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDUyMA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r516224520", "bodyText": "I don't think this will ever get called because you already throw an exception if there are errors", "author": "MrBilnon", "createdAt": "2020-11-02T20:05:58Z", "path": "dpc-smoketest/src/main/java/gov/cms/dpc/testing/smoketests/ClientUtils.java", "diffHunk": "@@ -242,11 +246,36 @@ private static void jobResponseHandler(CloseableHttpClient client, JobCompletion\n         try {\n             final File file = fetchExportedFiles(entry.getUrl(), client);\n             System.out.println(String.format(\"Downloaded file to: %s\", file.getPath()));\n+            if(file.length() == 0){\n+                throw new IllegalStateException(String.format(\"Downloaded file was empty. file path:  %s\", file.getPath()));\n+            }\n+            if(ResourceType.OperationOutcome.equals(entry.getType())){", "originalCommit": "a3403fbb9dba19216ef89fbef40776a4326d68f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMjQzNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r520932435", "bodyText": "My understanding is an OperationOutcome does not always have to be an error. But now that you mentioned it, I believe this would still get called but it would never fail validation since it would have thrown an exception before.", "author": "MrMorie", "createdAt": "2020-11-10T23:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA5NTY5OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1101#discussion_r521095698", "bodyText": "Fixed: Removed this validation since it would never get reached.", "author": "MrMorie", "createdAt": "2020-11-11T03:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDUyMA=="}], "type": "inlineReview"}, {"oid": "0695742da68a9a88094aaa70c0ec8497d20637b5", "url": "https://github.com/CMSgov/dpc-app/commit/0695742da68a9a88094aaa70c0ec8497d20637b5", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-11-03T20:26:40Z", "type": "commit"}, {"oid": "48f9b01e8e8a968105df7462592aec07d0b77f6c", "url": "https://github.com/CMSgov/dpc-app/commit/48f9b01e8e8a968105df7462592aec07d0b77f6c", "message": "Resolved PR requests.", "committedDate": "2020-11-09T20:37:17Z", "type": "commit"}, {"oid": "0c6a8f0c352a1576d4f4b7e8e2f3da11ef93383c", "url": "https://github.com/CMSgov/dpc-app/commit/0c6a8f0c352a1576d4f4b7e8e2f3da11ef93383c", "message": "Merge branch 'master' into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-11-10T22:36:10Z", "type": "commit"}, {"oid": "22fc3334ed261453ddcc8d9696eff5eb1ade8749", "url": "https://github.com/CMSgov/dpc-app/commit/22fc3334ed261453ddcc8d9696eff5eb1ade8749", "message": "Fixed PR issues. Reverted refactoring changes.", "committedDate": "2020-11-11T03:33:47Z", "type": "commit"}, {"oid": "24604c0b912ab9fc18eeba834d6dea0f5797d1d4", "url": "https://github.com/CMSgov/dpc-app/commit/24604c0b912ab9fc18eeba834d6dea0f5797d1d4", "message": "Merge branch 'sg/DPC-570-Fix-Failing-Smoke-Tests' of https://github.com/CMSgov/dpc-app into sg/DPC-570-Fix-Failing-Smoke-Tests", "committedDate": "2020-11-11T03:34:14Z", "type": "commit"}, {"oid": "c96ce8132a1c863121611f203669262a54cf1564", "url": "https://github.com/CMSgov/dpc-app/commit/c96ce8132a1c863121611f203669262a54cf1564", "message": "Fixed logging bug pointed out by Sonar", "committedDate": "2020-11-11T15:06:01Z", "type": "commit"}]}