{"pr_number": 1061, "pr_title": "DPC-732: Basic performance test suite for /Token endpoints", "pr_createdAt": "2020-09-24T20:57:34Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1061", "timeline": [{"oid": "4d0a88c2f773b58c88b9d0dc74c41c19f0c7ad51", "url": "https://github.com/CMSgov/dpc-app/commit/4d0a88c2f773b58c88b9d0dc74c41c19f0c7ad51", "message": "Token perf testing WIP", "committedDate": "2020-09-24T15:31:07Z", "type": "commit"}, {"oid": "5533f3e31a768a1ffcef035bcb26828dcf1d86ef", "url": "https://github.com/CMSgov/dpc-app/commit/5533f3e31a768a1ffcef035bcb26828dcf1d86ef", "message": "More /Token testing in progress", "committedDate": "2020-09-24T15:31:07Z", "type": "commit"}, {"oid": "68a00ef1b2f913540714ac83877e961d4b27b58f", "url": "https://github.com/CMSgov/dpc-app/commit/68a00ef1b2f913540714ac83877e961d4b27b58f", "message": "Move Token/validate requests before Token/auth; un-comment DELETE test", "committedDate": "2020-09-24T15:31:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwNjg0MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1061#discussion_r494606841", "bodyText": "Function testTokenEndpoints has 73 lines of code (exceeds 50 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-09-24T20:58:58Z", "path": "dpc-testing/performance/token.go", "diffHunk": "@@ -0,0 +1,153 @@\n+package main\n+\n+import (\n+\t\"container/list\"\n+\t\"crypto/rsa\"\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\t\"net/url\"\n+\n+\tdpcclient \"github.com/CMSgov/dpc-app/dpcclient/lib\"\n+\tvegeta \"github.com/tsenart/vegeta/lib\"\n+)\n+\n+type ClientTokenResp struct {\n+\tResource\n+\tClientToken []byte `json:\"token\"`\n+}\n+\n+type AccessTokenResp struct {\n+\tResource\n+\tAccessToken string `json:\"access_token\"`\n+}\n+\n+func testTokenEndpoints(accessToken string, privateKey *rsa.PrivateKey, keyID string, clientToken []byte) {", "originalCommit": "68a00ef1b2f913540714ac83877e961d4b27b58f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwNzE1Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/1061#discussion_r497807156", "bodyText": "This is probably due to my limited knowledge of Go, but I'm not finding the definition of generateKeyPairAndSignature", "author": "jonfulk", "createdAt": "2020-09-30T21:20:01Z", "path": "dpc-testing/performance/key.go", "diffHunk": "@@ -0,0 +1,74 @@\n+package main\n+\n+import (\n+\t\"encoding/json\"\n+\t\"fmt\"\n+\n+\tvegeta \"github.com/tsenart/vegeta/lib\"\n+)\n+\n+func testKeyEndpoints(accessToken string) {\n+\n+\tresps := runTestWithTargeter(fmt.Sprintf(\"POST %s/Key\", apiURL), newPOSTKeyTargeter(accessToken), 5, 5)\n+\tvar keyIDs []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)\n+\t\tkeyIDs = append(keyIDs, result.ID)\n+\t}\n+\n+\tgetKeysTarget := vegeta.Target{\n+\t\tMethod: \"GET\",\n+\t\tURL:    fmt.Sprintf(\"%s%s\", apiURL, \"/Key\"),\n+\t\tHeader: map[string][]string{\n+\t\t\t\"Accept\":        {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t},\n+\t}\n+\trunTest(getKeysTarget, 5, 5)\n+\n+\tgetKeyTarget := vegeta.Target{\n+\t\tMethod: \"GET\",\n+\t\tURL:    fmt.Sprintf(\"%s%s%s\", apiURL, \"/Key/\", keyIDs[0]),\n+\t\tHeader: map[string][]string{\n+\t\t\t\"Accept\":        {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t},\n+\t}\n+\trunTest(getKeyTarget, 5, 5)\n+\n+\tdeleteKeyTargeter := newDELETEKeyTargeter(accessToken, func() string {\n+\t\tkeyID := keyIDs[0]\n+\t\tkeyIDs = keyIDs[1:]\n+\t\treturn keyID\n+\t})\n+\trunTestWithTargeter(fmt.Sprintf(\"DELETE %s/Key/{id}\", apiURL), deleteKeyTargeter, 5, 5)\n+}\n+\n+func newPOSTKeyTargeter(accessToken string) vegeta.Targeter {\n+\treturn func(t *vegeta.Target) error {\n+\t\tt.Method = \"POST\"\n+\t\tt.URL = fmt.Sprintf(\"%s/Key\", apiURL)\n+\t\tt.Header = map[string][]string{\n+\t\t\t\"Content-Type\":  {\"application/json\"},\n+\t\t\t\"Authorization\": {fmt.Sprintf(\"Bearer %s\", accessToken)},\n+\t\t}\n+\n+\t\tpubKeyStr, _, signature := generateKeyPairAndSignature()", "originalCommit": "68a00ef1b2f913540714ac83877e961d4b27b58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyMTQzNg==", "url": "https://github.com/CMSgov/dpc-app/pull/1061#discussion_r497821436", "bodyText": "Thanks for taking a look! That function is in setup.go, in the same package main: https://github.com/CMSgov/dpc-app/blob/master/dpc-testing/performance/setup.go#L78", "author": "em1", "createdAt": "2020-09-30T21:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwNzE1Ng=="}], "type": "inlineReview"}, {"oid": "cf19ba9c381b44d1991ce8e1572f8d89bb1440b7", "url": "https://github.com/CMSgov/dpc-app/commit/cf19ba9c381b44d1991ce8e1572f8d89bb1440b7", "message": "Merge branch 'master' into emily/dpc-732-perf-test-token", "committedDate": "2020-10-01T11:00:00Z", "type": "commit"}]}