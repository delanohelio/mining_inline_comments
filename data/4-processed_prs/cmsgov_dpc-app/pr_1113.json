{"pr_number": 1113, "pr_title": "DPC-772 Add DPC specific headers to BFD call", "pr_createdAt": "2020-11-03T03:01:50Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1113", "timeline": [{"oid": "5a6225d96acd16b8a07f1bf9d514c8eb0e01a4fa", "url": "https://github.com/CMSgov/dpc-app/commit/5a6225d96acd16b8a07f1bf9d514c8eb0e01a4fa", "message": "add DPC specific headers to BFD call", "committedDate": "2020-11-03T02:49:03Z", "type": "commit"}, {"oid": "a34b2227fedc74202c52df0b5a181bcf3d10e005", "url": "https://github.com/CMSgov/dpc-app/commit/a34b2227fedc74202c52df0b5a181bcf3d10e005", "message": "Merge branch 'master' into wh/DPC-772-pass-bfd-required-headers", "committedDate": "2020-11-05T15:47:20Z", "type": "commit"}, {"oid": "5a4b98b64728261ad1dd2ce43cb2878aa462d863", "url": "https://github.com/CMSgov/dpc-app/commit/5a4b98b64728261ad1dd2ce43cb2878aa462d863", "message": "remove clear mdc", "committedDate": "2020-11-09T15:55:50Z", "type": "commit"}, {"oid": "a1b3d5e63411a9c67165873e760e0832df2c3086", "url": "https://github.com/CMSgov/dpc-app/commit/a1b3d5e63411a9c67165873e760e0832df2c3086", "message": "Merge remote-tracking branch 'origin/wh/DPC-772-pass-bfd-required-headers' into wh/DPC-772-pass-bfd-required-headers", "committedDate": "2020-11-09T15:55:58Z", "type": "commit"}, {"oid": "b2bf43b8dd4b4be4e6111b755e417f70c720d4b7", "url": "https://github.com/CMSgov/dpc-app/commit/b2bf43b8dd4b4be4e6111b755e417f70c720d4b7", "message": "test removal of MDC values after engine is stopped", "committedDate": "2020-11-09T16:43:26Z", "type": "commit"}, {"oid": "d34125767bf0d47988d8269b52de64324b4c975e", "url": "https://github.com/CMSgov/dpc-app/commit/d34125767bf0d47988d8269b52de64324b4c975e", "message": "Merge branch 'master' into wh/DPC-772-pass-bfd-required-headers", "committedDate": "2020-11-09T16:59:17Z", "type": "commit"}, {"oid": "d24fa47ec59d72765e5eaacc855cd16a7f11467d", "url": "https://github.com/CMSgov/dpc-app/commit/d24fa47ec59d72765e5eaacc855cd16a7f11467d", "message": "change BFD headers to match their new requirements", "committedDate": "2020-11-12T17:05:55Z", "type": "commit"}, {"oid": "01af871ff00fa03ba1f78d48ac3fc4e922c74478", "url": "https://github.com/CMSgov/dpc-app/commit/01af871ff00fa03ba1f78d48ac3fc4e922c74478", "message": "use same constants", "committedDate": "2020-11-13T04:06:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MzE5Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r524343196", "bodyText": "Have we tested in dev from an external address, to see whether we get the actual client IP or Akamai's IP?", "author": "dhgreene", "createdAt": "2020-11-16T15:16:11Z", "path": "dpc-bluebutton/src/main/java/gov/cms/dpc/bluebutton/client/BlueButtonClientImpl.java", "diffHunk": "@@ -268,4 +279,23 @@ public String hashMbi(String mbi) throws GeneralSecurityException {\n             timerContext.stop();\n         }\n     }\n+\n+    private void addBFDHeaders(IQuery<?> query) {\n+\n+        try {\n+            query.withAdditionalHeader(Constants.INCLUDE_IDENTIFIERS_HEADER, \"mbi\");\n+            var providerId = MDC.get(MDCConstants.PROVIDER_ID);\n+            var jobId = MDC.get(MDCConstants.JOB_ID);\n+            if (StringUtils.isNotBlank(providerId)) {\n+                query.withAdditionalHeader(Constants.BULK_CLIENT_ID_HEADER, providerId);\n+            }\n+            if (StringUtils.isNotBlank(jobId)) {\n+                query.withAdditionalHeader(Constants.BULK_JOB_ID_HEADER, jobId);\n+            }\n+            query.withAdditionalHeader(HttpHeaders.X_FORWARDED_FOR, InetAddress.getLocalHost().getHostAddress());", "originalCommit": "01af871ff00fa03ba1f78d48ac3fc4e922c74478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4272bef9115a82dd15c98c6e548aa0444187f9c", "url": "https://github.com/CMSgov/dpc-app/commit/a4272bef9115a82dd15c98c6e548aa0444187f9c", "message": "pass requesting ip into job batch to send to BFD", "committedDate": "2020-11-18T16:14:45Z", "type": "commit"}, {"oid": "e454c9346c62b33c73d81c4876c349b5ae05e320", "url": "https://github.com/CMSgov/dpc-app/commit/e454c9346c62b33c73d81c4876c349b5ae05e320", "message": "remove requesting ip after batch is processed", "committedDate": "2020-11-18T16:18:20Z", "type": "commit"}, {"oid": "0d60bd8e307e8b04b12b9b34855dd4804b739988", "url": "https://github.com/CMSgov/dpc-app/commit/0d60bd8e307e8b04b12b9b34855dd4804b739988", "message": "Merge branch 'master' into wh/DPC-772-pass-bfd-required-headers", "committedDate": "2020-11-18T19:03:19Z", "type": "commit"}, {"oid": "4e7ba33e73859412387b3fa0489b439df39fd0d8", "url": "https://github.com/CMSgov/dpc-app/commit/4e7ba33e73859412387b3fa0489b439df39fd0d8", "message": "increasing character count to requesting_ip column in case ipv6 starts getting appended by akami or aws", "committedDate": "2020-11-18T22:11:52Z", "type": "commit"}, {"oid": "355fb79d77fc39c6fa1f500c7c380dd0e015c650", "url": "https://github.com/CMSgov/dpc-app/commit/355fb79d77fc39c6fa1f500c7c380dd0e015c650", "message": "Merge remote-tracking branch 'origin/wh/DPC-772-pass-bfd-required-headers' into wh/DPC-772-pass-bfd-required-headers", "committedDate": "2020-11-18T22:12:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2MjMzNA==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r526462334", "bodyText": "Not an issue, but we could just inject the HttpHeaders instead of the entire request.", "author": "MrMorie", "createdAt": "2020-11-18T22:21:49Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/GroupResource.java", "diffHunk": "@@ -272,7 +274,8 @@ public Response export(@ApiParam(hidden = true)\n                            @DefaultValue(FHIR_NDJSON) @QueryParam(\"_outputFormat\") @NoHtml String outputFormat,\n                            @ApiParam(value = \"Resources will be included in the response if their state has changed after the supplied time (e.g. if Resource.meta.lastUpdated is later than the supplied _since time).\")\n                            @QueryParam(\"_since\") @NoHtml String sinceParam,\n-                           @ApiParam(hidden = true) @HeaderParam(\"Prefer\")  @Valid String Prefer) {\n+                           @ApiParam(hidden = true) @HeaderParam(\"Prefer\")  @Valid String Prefer,\n+                           @Context HttpServletRequest request) {", "originalCommit": "355fb79d77fc39c6fa1f500c7c380dd0e015c650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Mjk2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r526462963", "bodyText": "Not an issue, but we could just inject the HttpHeaders instead of the entire request.\n\nI don't just use the x-forwarded-for header, if it's not present then I'll call request.getRemoteAddr()", "author": "MrBilnon", "createdAt": "2020-11-18T22:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2MjMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2ODY5OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r526468698", "bodyText": "oh right. good point.", "author": "MrMorie", "createdAt": "2020-11-18T22:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2MjMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2NjQ0NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r526466445", "bodyText": "Since we have an MDCConstants.java file, maybe rename this to something more specific? HeadersConstants? Unless this will be a catch all constants file and just happens to have only headers at the moment.", "author": "MrMorie", "createdAt": "2020-11-18T22:29:59Z", "path": "dpc-common/src/main/java/gov/cms/dpc/common/Constants.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package gov.cms.dpc.common;", "originalCommit": "355fb79d77fc39c6fa1f500c7c380dd0e015c650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2ODU4Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/1113#discussion_r526468587", "bodyText": "I was going to use this as a catch all in the future", "author": "MrBilnon", "createdAt": "2020-11-18T22:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2NjQ0NQ=="}], "type": "inlineReview"}]}