{"pr_number": 846, "pr_title": "Dpc 361 move sidekiq to container service", "pr_createdAt": "2020-06-10T20:31:14Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/846", "timeline": [{"oid": "318124529f4f53bff7e9fa4aceb489a8dc0b4b3e", "url": "https://github.com/CMSgov/dpc-app/commit/318124529f4f53bff7e9fa4aceb489a8dc0b4b3e", "message": "Replace default CMD in Dockerfike to ENTRYPOINT and replace CMD with default arg", "committedDate": "2020-06-10T20:07:31Z", "type": "commit"}, {"oid": "dfc85aa1d2a7e1c132782d3615213e1e8d1853a0", "url": "https://github.com/CMSgov/dpc-app/commit/dfc85aa1d2a7e1c132782d3615213e1e8d1853a0", "message": "Allow entrypoint to either run the web app or the sidekiq server depending on an argument flag", "committedDate": "2020-06-10T20:08:17Z", "type": "commit"}, {"oid": "2363df7d024d830ccd79afaa5fa8b96aede708fe", "url": "https://github.com/CMSgov/dpc-app/commit/2363df7d024d830ccd79afaa5fa8b96aede708fe", "message": "Update docker compose file to allow for a sidekiq container and a redis container", "committedDate": "2020-06-10T20:09:06Z", "type": "commit"}, {"oid": "501b129b0a0d865c0bd3a699fde87ca5c3911b59", "url": "https://github.com/CMSgov/dpc-app/commit/501b129b0a0d865c0bd3a699fde87ca5c3911b59", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-10T20:37:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwODAwNA==", "url": "https://github.com/CMSgov/dpc-app/pull/846#discussion_r438408004", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n          \n          \n            \n              # like provided here https://github.com/mperham/sidekiq/wiki/Deployment", "author": "dhgreene", "createdAt": "2020-06-10T21:05:22Z", "path": "dpc-web/docker/entrypoint.sh", "diffHunk": "@@ -7,22 +7,26 @@ if [ -f tmp/pids/server.pid ]; then\n   rm tmp/pids/server.pid\n fi\n \n-# Run the database migrations\n-echo \"Migrating the database...\"\n-bundle exec rails db:migrate\n+if [ \"$1\" == \"web\" ]; then\n+  # Run the database migrations\n+  echo \"Migrating the database...\"\n+  bundle exec rails db:migrate\n \n-# Seed the database\n-# This step is not needed, as there is no database seed data yet\n+  # Seed the database\n+  # This step is not needed, as there is no database seed data yet\n \n-# Start background job processing\n-# TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n-# like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n-bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log &\n+  # Start the database service (and make accessible outside the Docker container)\n+  echo \"Starting Rails server...\"\n+  if [[ -n \"$JACOCO\" ]]; then\n+    bundle exec rails server -b 0.0.0.0 -p 3000\n+  else\n+    bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+  fi\n+fi\n \n-# Start the database service (and make accessible outside the Docker container)\n-echo \"Starting Rails server...\"\n-if [ -n \"$JACOCO\" ]; then\n-  bundle exec rails server -b 0.0.0.0 -p 3000\n-else\n-  bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+if [ \"$1\" == \"sidekiq\" ]; then\n+  # Start Sidekiq job processing\n+  # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n+  # like provided here https://github.com/mperham/sidekiq/wiki/Deployment", "originalCommit": "2363df7d024d830ccd79afaa5fa8b96aede708fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwOTIyOA==", "url": "https://github.com/CMSgov/dpc-app/pull/846#discussion_r438409228", "bodyText": "To account for local envs should we do something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log\n          \n          \n            \n              if [[ -n \"$JACOCO\" ]]; then\n          \n          \n            \n                bundle exec sidekiq -q default -q mailers\n          \n          \n            \n              else\n          \n          \n            \n                bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log\n          \n          \n            \n              fi", "author": "dhgreene", "createdAt": "2020-06-10T21:08:00Z", "path": "dpc-web/docker/entrypoint.sh", "diffHunk": "@@ -7,22 +7,26 @@ if [ -f tmp/pids/server.pid ]; then\n   rm tmp/pids/server.pid\n fi\n \n-# Run the database migrations\n-echo \"Migrating the database...\"\n-bundle exec rails db:migrate\n+if [ \"$1\" == \"web\" ]; then\n+  # Run the database migrations\n+  echo \"Migrating the database...\"\n+  bundle exec rails db:migrate\n \n-# Seed the database\n-# This step is not needed, as there is no database seed data yet\n+  # Seed the database\n+  # This step is not needed, as there is no database seed data yet\n \n-# Start background job processing\n-# TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n-# like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n-bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log &\n+  # Start the database service (and make accessible outside the Docker container)\n+  echo \"Starting Rails server...\"\n+  if [[ -n \"$JACOCO\" ]]; then\n+    bundle exec rails server -b 0.0.0.0 -p 3000\n+  else\n+    bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+  fi\n+fi\n \n-# Start the database service (and make accessible outside the Docker container)\n-echo \"Starting Rails server...\"\n-if [ -n \"$JACOCO\" ]; then\n-  bundle exec rails server -b 0.0.0.0 -p 3000\n-else\n-  bundle exec rails server -b 0.0.0.0 -p 3000 2>&1 | tee -a /var/log/dpc-web-$(hostname).log\n+if [ \"$1\" == \"sidekiq\" ]; then\n+  # Start Sidekiq job processing\n+  # TODO: We should avoid using the dameonize flag in production and, instead, pursue a deployment\n+  # like provided here https://github.com/mperham/sidekiq/wiki/Deployment\n+  bundle exec sidekiq -q default -q mailers 2>&1 | tee -a /var/log/dpc-web-$(hostname)-sidekiq.log", "originalCommit": "2363df7d024d830ccd79afaa5fa8b96aede708fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f74c52466796fe5b67fdd7a0d4690db3d7127bd8", "url": "https://github.com/CMSgov/dpc-app/commit/f74c52466796fe5b67fdd7a0d4690db3d7127bd8", "message": "Update dpc-web/docker/entrypoint.sh\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>", "committedDate": "2020-06-15T23:39:25Z", "type": "commit"}, {"oid": "18f5aca7285e4743ab213e7cf2e01d6a562032df", "url": "https://github.com/CMSgov/dpc-app/commit/18f5aca7285e4743ab213e7cf2e01d6a562032df", "message": "Update dpc-web/docker/entrypoint.sh\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>", "committedDate": "2020-06-15T23:39:40Z", "type": "commit"}, {"oid": "530df161e38a073404cb564aba06b097180fd7af", "url": "https://github.com/CMSgov/dpc-app/commit/530df161e38a073404cb564aba06b097180fd7af", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-15T23:39:46Z", "type": "commit"}, {"oid": "b41fab6d4af8e4cb107dc669b04040d44319b492", "url": "https://github.com/CMSgov/dpc-app/commit/b41fab6d4af8e4cb107dc669b04040d44319b492", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-16T15:52:46Z", "type": "commit"}, {"oid": "3990b24dc51a33e0ff804165effa6e4d215db68a", "url": "https://github.com/CMSgov/dpc-app/commit/3990b24dc51a33e0ff804165effa6e4d215db68a", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-16T19:23:57Z", "type": "commit"}, {"oid": "55783bf00e49ff720a1d3b4cd12993be493253ab", "url": "https://github.com/CMSgov/dpc-app/commit/55783bf00e49ff720a1d3b4cd12993be493253ab", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-17T16:09:19Z", "type": "commit"}, {"oid": "90e09a3a65e35fbfd20fda49b1ac8fec280e8551", "url": "https://github.com/CMSgov/dpc-app/commit/90e09a3a65e35fbfd20fda49b1ac8fec280e8551", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-17T20:33:59Z", "type": "commit"}, {"oid": "f24a0d631dfff90ffd8e701f1785def9ba1036c8", "url": "https://github.com/CMSgov/dpc-app/commit/f24a0d631dfff90ffd8e701f1785def9ba1036c8", "message": "Add sidekiq_alive for monitoring sidekiq health", "committedDate": "2020-06-18T19:54:21Z", "type": "commit"}, {"oid": "1ad9b55bffa89ddb575abc1d421332ec58bac55f", "url": "https://github.com/CMSgov/dpc-app/commit/1ad9b55bffa89ddb575abc1d421332ec58bac55f", "message": "Added the sidekiq web ui monitoring service for development", "committedDate": "2020-06-18T20:04:10Z", "type": "commit"}, {"oid": "b893f70565ad4f8cf894d05fa3b08462ad92ad94", "url": "https://github.com/CMSgov/dpc-app/commit/b893f70565ad4f8cf894d05fa3b08462ad92ad94", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-18T20:07:36Z", "type": "commit"}, {"oid": "d91094ad36adcfe2f01f62b483bffb709b08a81b", "url": "https://github.com/CMSgov/dpc-app/commit/d91094ad36adcfe2f01f62b483bffb709b08a81b", "message": "suppress warning for redis", "committedDate": "2020-06-22T16:27:47Z", "type": "commit"}, {"oid": "4bf4fe848419aed6e45017a1e2303f8ba609090f", "url": "https://github.com/CMSgov/dpc-app/commit/4bf4fe848419aed6e45017a1e2303f8ba609090f", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-22T20:45:54Z", "type": "commit"}, {"oid": "8a4f225f194de035b00d1d64a4fa835369136d5f", "url": "https://github.com/CMSgov/dpc-app/commit/8a4f225f194de035b00d1d64a4fa835369136d5f", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-23T15:15:27Z", "type": "commit"}, {"oid": "8b1017f8ae54a90fd0fd2e5c8021482c377d0997", "url": "https://github.com/CMSgov/dpc-app/commit/8b1017f8ae54a90fd0fd2e5c8021482c377d0997", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-24T21:46:06Z", "type": "commit"}, {"oid": "70a6da3d2a506c7826ee1f8f06ba58f103904bf3", "url": "https://github.com/CMSgov/dpc-app/commit/70a6da3d2a506c7826ee1f8f06ba58f103904bf3", "message": "Merge branch 'master' into dpc-361-move-sidekiq-to-container-service", "committedDate": "2020-06-24T22:20:02Z", "type": "commit"}]}