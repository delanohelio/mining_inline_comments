{"pr_number": 860, "pr_title": "DPC-326: As an internal user, I want to filter organizations", "pr_createdAt": "2020-06-16T16:21:27Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/860", "timeline": [{"oid": "2980faec2d76c9366e4cc21e43463ea73e3f828e", "url": "https://github.com/CMSgov/dpc-app/commit/2980faec2d76c9366e4cc21e43463ea73e3f828e", "message": "Init", "committedDate": "2020-06-15T14:42:21Z", "type": "commit"}, {"oid": "d5936ad6d7357492c1d656a46fc15a0540d03334", "url": "https://github.com/CMSgov/dpc-app/commit/d5936ad6d7357492c1d656a46fc15a0540d03334", "message": "Org filter providers/vendors", "committedDate": "2020-06-15T17:21:55Z", "type": "commit"}, {"oid": "cb98913fa764ed8813d4a95bdd3c275408d71e07", "url": "https://github.com/CMSgov/dpc-app/commit/cb98913fa764ed8813d4a95bdd3c275408d71e07", "message": "Search progress", "committedDate": "2020-06-15T21:01:50Z", "type": "commit"}, {"oid": "fb2b6bfeeb8932c5be287f0fcfdcd3e94cc92c07", "url": "https://github.com/CMSgov/dpc-app/commit/fb2b6bfeeb8932c5be287f0fcfdcd3e94cc92c07", "message": "Search org by type", "committedDate": "2020-06-16T13:38:09Z", "type": "commit"}, {"oid": "2899f33c86b30852e5701fa44a09f3eb9daf868b", "url": "https://github.com/CMSgov/dpc-app/commit/2899f33c86b30852e5701fa44a09f3eb9daf868b", "message": "Registered or unregistered added", "committedDate": "2020-06-16T14:46:05Z", "type": "commit"}, {"oid": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "url": "https://github.com/CMSgov/dpc-app/commit/4258e1c1ad412520b5d51a9513ba7383ff0e962d", "message": "Register/not register filter", "committedDate": "2020-06-16T16:14:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI1Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992256", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-06-16T16:39:56Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)\n+    # Check if registered org\n+    if params[:registered_org]\n+      radio = params[:registered_org]\n+\n+      if radio == 'registered'\n+        scope = scope.where('id IN(SELECT DISTINCT(organization_id) FROM registered_organizations)')\n+      elsif radio == 'unregistered'\n+        scope = scope.where('id NOT IN(SELECT DISTINCT(organization_id) FROM registered_organizations)')\n+      else\n+        scope = Organization\n+      end\n+    end\n+\n+    # Check if provider or vender\n+    if params[:org_type] == 'vendor'\n+      scope = scope.vendor\n+    elsif params[:org_type] == 'provider'\n+      scope = scope.provider\n+    end\n+\n+    # Check org type\n+    if params[:organization_type].present?\n+      scope = scope.where(organization_type: params[:organization_type])\n+    end\n+\n+    scope\n+  end\n+\n+  def apply_date_queries(scope)", "originalCommit": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2MA==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992260", "bodyText": "Argument scope was shadowed by a local variable before it was used.", "author": "codeclimate", "createdAt": "2020-06-16T16:39:56Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'", "originalCommit": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992263", "bodyText": "Cyclomatic complexity for apply_org_queries is too high. [7/6]", "author": "codeclimate", "createdAt": "2020-06-16T16:39:56Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "originalCommit": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992265", "bodyText": "Method has too many lines. [19/15]", "author": "codeclimate", "createdAt": "2020-06-16T16:39:56Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "originalCommit": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjI2OA==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r440992268", "bodyText": "Perceived complexity for apply_org_queries is too high. [9/7]", "author": "codeclimate", "createdAt": "2020-06-16T16:39:56Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,80 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "originalCommit": "4258e1c1ad412520b5d51a9513ba7383ff0e962d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba9057ee5c80f2517479633c49db522fefc6b191", "url": "https://github.com/CMSgov/dpc-app/commit/ba9057ee5c80f2517479633c49db522fefc6b191", "message": "remove form", "committedDate": "2020-06-16T16:54:07Z", "type": "commit"}, {"oid": "d31e233a3034bed72f59ca01f37251a4255749a2", "url": "https://github.com/CMSgov/dpc-app/commit/d31e233a3034bed72f59ca01f37251a4255749a2", "message": "Fix spec", "committedDate": "2020-06-16T16:57:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMDM1NA==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r441020354", "bodyText": "Use the return of the conditional for variable assignment and comparison.", "author": "codeclimate", "createdAt": "2020-06-16T17:26:46Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,90 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all'\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+    scope = apply_search_word(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)\n+    # Check if registered org\n+    if params[:registered_org]\n+      radio = params[:registered_org]\n+\n+      if radio == 'registered'", "originalCommit": "d31e233a3034bed72f59ca01f37251a4255749a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b3ae2a727143dd47623e578c307a14777c5733c", "url": "https://github.com/CMSgov/dpc-app/commit/5b3ae2a727143dd47623e578c307a14777c5733c", "message": "code climate", "committedDate": "2020-06-16T18:23:31Z", "type": "commit"}, {"oid": "98de153affb6a09dad644971f5d0611511d0264c", "url": "https://github.com/CMSgov/dpc-app/commit/98de153affb6a09dad644971f5d0611511d0264c", "message": "code climate", "committedDate": "2020-06-16T19:12:32Z", "type": "commit"}, {"oid": "659556cb2125a27e7912912215ee250a254eebe1", "url": "https://github.com/CMSgov/dpc-app/commit/659556cb2125a27e7912912215ee250a254eebe1", "message": "Fixes", "committedDate": "2020-06-16T19:26:56Z", "type": "commit"}, {"oid": "917973c6b24911c101c07d39346ea1043f8c168e", "url": "https://github.com/CMSgov/dpc-app/commit/917973c6b24911c101c07d39346ea1043f8c168e", "message": "Fix", "committedDate": "2020-06-16T19:28:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDM3NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r441154375", "bodyText": "Method has too many lines. [16/15]", "author": "codeclimate", "createdAt": "2020-06-16T21:31:59Z", "path": "dpc-web/app/services/organization_search.rb", "diffHunk": "@@ -0,0 +1,73 @@\n+# frozen_string_literal: true\n+\n+class OrganizationSearch\n+  ALLOWED_SCOPES = %w[all provider vendor].freeze\n+\n+  attr_reader :params, :initial_scope\n+\n+  def initialize(params: {}, scope: 'all')\n+    scope = 'all' unless ALLOWED_SCOPES.include? scope\n+\n+    @params = params\n+    @initial_scope = scope\n+  end\n+\n+  def results\n+    @results ||= query\n+  end\n+\n+  private\n+\n+  def query\n+    scope = Organization.send(initial_scope)\n+\n+    scope = apply_org_queries(scope)\n+    scope = apply_date_queries(scope)\n+    scope = apply_keyword_search(scope)\n+\n+    scope\n+  end\n+\n+  def apply_org_queries(scope)", "originalCommit": "917973c6b24911c101c07d39346ea1043f8c168e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee32df7826eb51cd68984746ffd8470ac1287dfd", "url": "https://github.com/CMSgov/dpc-app/commit/ee32df7826eb51cd68984746ffd8470ac1287dfd", "message": "Search simplify", "committedDate": "2020-06-17T13:32:49Z", "type": "commit"}, {"oid": "6a8338ffdaede0d4cb02354b3800aae155264d44", "url": "https://github.com/CMSgov/dpc-app/commit/6a8338ffdaede0d4cb02354b3800aae155264d44", "message": "Code climate simplify", "committedDate": "2020-06-17T13:37:20Z", "type": "commit"}, {"oid": "b92e967a3bd675d0345544dad3773ca67f88cbab", "url": "https://github.com/CMSgov/dpc-app/commit/b92e967a3bd675d0345544dad3773ca67f88cbab", "message": "Base Search progress", "committedDate": "2020-06-17T17:20:07Z", "type": "commit"}, {"oid": "69cd949f82ea556f9e857a4b5daf0824d9457a8a", "url": "https://github.com/CMSgov/dpc-app/commit/69cd949f82ea556f9e857a4b5daf0824d9457a8a", "message": "Base search complete", "committedDate": "2020-06-17T18:23:05Z", "type": "commit"}, {"oid": "f62b132cc2c3e3b98aa1c2025754ca6d13b355d9", "url": "https://github.com/CMSgov/dpc-app/commit/f62b132cc2c3e3b98aa1c2025754ca6d13b355d9", "message": "Fix rspec", "committedDate": "2020-06-17T20:15:36Z", "type": "commit"}, {"oid": "bdb6e63a2df5d075e816cf4163329a6f85cfc0ba", "url": "https://github.com/CMSgov/dpc-app/commit/bdb6e63a2df5d075e816cf4163329a6f85cfc0ba", "message": "Update rspec", "committedDate": "2020-06-17T20:33:08Z", "type": "commit"}, {"oid": "20ddc3db6c0b5728f2e95d174ad5df4ee4304cb9", "url": "https://github.com/CMSgov/dpc-app/commit/20ddc3db6c0b5728f2e95d174ad5df4ee4304cb9", "message": "Fix code climate issue", "committedDate": "2020-06-17T20:34:59Z", "type": "commit"}, {"oid": "fada6b8e0521d73727dcb6a7a935495b60ae1bee", "url": "https://github.com/CMSgov/dpc-app/commit/fada6b8e0521d73727dcb6a7a935495b60ae1bee", "message": "Update search filter", "committedDate": "2020-06-18T18:06:08Z", "type": "commit"}, {"oid": "f5c1f049b11edab154666c40a719f2ae4043ef23", "url": "https://github.com/CMSgov/dpc-app/commit/f5c1f049b11edab154666c40a719f2ae4043ef23", "message": "Merge branch 'master' into nicole/dpc-326-org-filter", "committedDate": "2020-06-18T18:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442431734", "bodyText": "Do we need to filter here which parameters we accept, to be consistent with #843 ?", "author": "dhgreene", "createdAt": "2020-06-18T18:47:31Z", "path": "dpc-web/app/controllers/internal/organizations_controller.rb", "diffHunk": "@@ -5,22 +5,9 @@ class OrganizationsController < ApplicationController\n     before_action :authenticate_internal_user!\n \n     def index\n-      scope = if params[:org_type] == 'vendor'\n-                Organization.vendor\n-              elsif params[:org_type] == 'provider'\n-                Organization.provider\n-              else\n-                Organization.all\n-              end\n-\n-      if keyword_param[:keyword].present?\n-        keyword = \"%#{keyword_param[:keyword].downcase}%\"\n-        scope = scope.where(\n-          'LOWER(name) LIKE :keyword', keyword: keyword\n-        )\n-      end\n+      results = BaseSearch.new(params: params, scope: params[:org_type]).results\n \n-      @organizations = scope.page params[:page]\n+      @organizations = results.page params[:page]", "originalCommit": "f5c1f049b11edab154666c40a719f2ae4043ef23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NTg4Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442445883", "bodyText": "What do you think @SMLuthi ?", "author": "Sun-Mountain", "createdAt": "2020-06-18T19:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NzA4OQ==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442447089", "bodyText": "I could put results.page page[:params] in a private method like org_page_params(results)", "author": "Sun-Mountain", "createdAt": "2020-06-18T19:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1MDM3Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/860#discussion_r442450377", "bodyText": "I just did it :)", "author": "Sun-Mountain", "createdAt": "2020-06-18T19:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTczNA=="}], "type": "inlineReview"}, {"oid": "89bedbd1f56051e976b5e0e5651b466feebfd549", "url": "https://github.com/CMSgov/dpc-app/commit/89bedbd1f56051e976b5e0e5651b466feebfd549", "message": "stronger parameters", "committedDate": "2020-06-18T19:22:48Z", "type": "commit"}, {"oid": "35ee0c096665f61d4d699927d014ec9728384cac", "url": "https://github.com/CMSgov/dpc-app/commit/35ee0c096665f61d4d699927d014ec9728384cac", "message": "Merge branch 'nicole/dpc-326-org-filter' of github.com:CMSgov/dpc-app into nicole/dpc-326-org-filter", "committedDate": "2020-06-18T19:23:00Z", "type": "commit"}]}