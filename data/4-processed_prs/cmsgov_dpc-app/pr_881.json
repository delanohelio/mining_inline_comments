{"pr_number": 881, "pr_title": "DPC-148 & 362: Simplify web app for one environment", "pr_createdAt": "2020-06-25T16:38:21Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/881", "timeline": [{"oid": "1f071f510386afa80fde63f66ab2ee8fa1b24607", "url": "https://github.com/CMSgov/dpc-app/commit/1f071f510386afa80fde63f66ab2ee8fa1b24607", "message": "Remove api_env column from registered_organization table", "committedDate": "2020-06-24T18:42:39Z", "type": "commit"}, {"oid": "00453faa3b9f93e81e77e54f926c39f794ec084e", "url": "https://github.com/CMSgov/dpc-app/commit/00453faa3b9f93e81e77e54f926c39f794ec084e", "message": "Remove mention of api_env from client token controller", "committedDate": "2020-06-24T18:55:46Z", "type": "commit"}, {"oid": "ef5fa989b27faa54e69ba159864996286635d572", "url": "https://github.com/CMSgov/dpc-app/commit/ef5fa989b27faa54e69ba159864996286635d572", "message": "Remove mention of api_env from internal organization controller", "committedDate": "2020-06-24T18:56:34Z", "type": "commit"}, {"oid": "9da63c1312d861c36c19a3e016f158f7f938655c", "url": "https://github.com/CMSgov/dpc-app/commit/9da63c1312d861c36c19a3e016f158f7f938655c", "message": "Remove mention of api_env from internal registered org controller and update new/create endpoints to build a singular reg org entry", "committedDate": "2020-06-24T18:58:50Z", "type": "commit"}, {"oid": "25cffb5cc902ee14fcc1d79218ea0167d1b08fbb", "url": "https://github.com/CMSgov/dpc-app/commit/25cffb5cc902ee14fcc1d79218ea0167d1b08fbb", "message": "Remove mention of api_env from public keys controller", "committedDate": "2020-06-24T18:59:54Z", "type": "commit"}, {"oid": "fa46fb1b1b7793c8d01bfe56129082b7ab56590c", "url": "https://github.com/CMSgov/dpc-app/commit/fa46fb1b1b7793c8d01bfe56129082b7ab56590c", "message": "Update organization model to have has_one instead of has_many registered orgs. Remove env specific logic and remove usage of api_env.", "committedDate": "2020-06-24T19:01:26Z", "type": "commit"}, {"oid": "4f3453f08505aeff361bf2ebaa8db88de8434c4a", "url": "https://github.com/CMSgov/dpc-app/commit/4f3453f08505aeff361bf2ebaa8db88de8434c4a", "message": "Update sandbox check for org user assignment model to use new method", "committedDate": "2020-06-24T19:05:51Z", "type": "commit"}, {"oid": "876c1aebe620badae3583f5fe4129b43277a98a9", "url": "https://github.com/CMSgov/dpc-app/commit/876c1aebe620badae3583f5fe4129b43277a98a9", "message": "Update registerd organization model to remove usage of api_env. Dry out APIClient service creation.", "committedDate": "2020-06-24T19:07:13Z", "type": "commit"}, {"oid": "7ac1723ae701c2ddad8a9fcecfb90a596b3e82a1", "url": "https://github.com/CMSgov/dpc-app/commit/7ac1723ae701c2ddad8a9fcecfb90a596b3e82a1", "message": "Update apiclient to remove usage of api_env.", "committedDate": "2020-06-24T19:08:33Z", "type": "commit"}, {"oid": "92e81b74d3db4e5539a1b3a0b8e94a164581fe3d", "url": "https://github.com/CMSgov/dpc-app/commit/92e81b74d3db4e5539a1b3a0b8e94a164581fe3d", "message": "Update client token manager service to remove usage of api_env", "committedDate": "2020-06-24T19:09:01Z", "type": "commit"}, {"oid": "da8954d6ee064bedfabd217b35b014fe489e2cb4", "url": "https://github.com/CMSgov/dpc-app/commit/da8954d6ee064bedfabd217b35b014fe489e2cb4", "message": "Update public key manager service to remove usage of api_env", "committedDate": "2020-06-24T19:09:28Z", "type": "commit"}, {"oid": "36a23c095ccbae650faa454d5d6d53d92685527a", "url": "https://github.com/CMSgov/dpc-app/commit/36a23c095ccbae650faa454d5d6d53d92685527a", "message": "Update show.thml.erb in organizations to use new prod_sbx check than old sandbox_enabled check", "committedDate": "2020-06-24T19:10:11Z", "type": "commit"}, {"oid": "afe56a882047f880728c0fe7596754d0e14790c7", "url": "https://github.com/CMSgov/dpc-app/commit/afe56a882047f880728c0fe7596754d0e14790c7", "message": "Init view work\n\nChange external user views.", "committedDate": "2020-06-24T20:47:08Z", "type": "commit"}, {"oid": "17cb762aab29a7ccb5f0908dd525003cf0cc94d5", "url": "https://github.com/CMSgov/dpc-app/commit/17cb762aab29a7ccb5f0908dd525003cf0cc94d5", "message": "Progress", "committedDate": "2020-06-24T21:28:48Z", "type": "commit"}, {"oid": "117c44b7cc14b5c167128bb695dde315b608abdc", "url": "https://github.com/CMSgov/dpc-app/commit/117c44b7cc14b5c167128bb695dde315b608abdc", "message": "View progress", "committedDate": "2020-06-24T22:49:34Z", "type": "commit"}, {"oid": "c11dacad42a13bd2f2d21ddbb7e307f567640f2b", "url": "https://github.com/CMSgov/dpc-app/commit/c11dacad42a13bd2f2d21ddbb7e307f567640f2b", "message": "Enabled in API label added", "committedDate": "2020-06-24T22:54:20Z", "type": "commit"}, {"oid": "db32e2cb392541ac67f114acbc566be6e8c2bd43", "url": "https://github.com/CMSgov/dpc-app/commit/db32e2cb392541ac67f114acbc566be6e8c2bd43", "message": "Public key manager spec", "committedDate": "2020-06-25T13:07:47Z", "type": "commit"}, {"oid": "a120fa4e806f60766977387e03b9039496e49838", "url": "https://github.com/CMSgov/dpc-app/commit/a120fa4e806f60766977387e03b9039496e49838", "message": "Organization model spec", "committedDate": "2020-06-25T14:17:44Z", "type": "commit"}, {"oid": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "url": "https://github.com/CMSgov/dpc-app/commit/0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "message": "Registered organization spec progress", "committedDate": "2020-06-25T14:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQwNw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693407", "bodyText": "Useless assignment to variable - reg_org.", "author": "codeclimate", "createdAt": "2020-06-25T16:40:45Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?\n+      return reg_org = registered_organization", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQwOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693409", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "author": "codeclimate", "createdAt": "2020-06-25T16:40:46Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693411", "bodyText": "Redundant return detected.", "author": "codeclimate", "createdAt": "2020-06-25T16:40:46Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -71,34 +63,20 @@ def prod_sbx?\n     ENV['ENV'] == 'prod-sbx'\n   end\n \n-  def update_registered_organizations\n+  def update_registered_organization\n     return unless npi.present? || sandbox_id.present?\n \n-    registered_organizations.each(&:update_api_organization)\n-  end\n-\n-  def sandbox_enabled?\n-    sandbox_registered_organization.present?\n-  end\n-\n-  def sandbox_registered_organization\n-    registered_organizations.find_by(api_env: 'sandbox')\n-  end\n-\n-  def sandbox_fhir_endpoint\n-    sandbox_registered_organization.fhir_endpoint\n-  end\n-\n-  def production_enabled?\n-    production_registered_organization.present?\n+    registered_organization.update_api_organization\n   end\n \n-  def production_registered_organization\n-    registered_organizations.find_by(api_env: 'production')\n+  def reg_org\n+    if registered_organization.present?\n+      return reg_org = registered_organization", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxMw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693413", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "author": "codeclimate", "createdAt": "2020-06-25T16:40:46Z", "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzQxNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693415", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "author": "codeclimate", "createdAt": "2020-06-25T16:40:46Z", "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = \"Organization access updated.\"", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzcwMA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693700", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "author": "codeclimate", "createdAt": "2020-06-25T16:41:14Z", "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = \"Organization has been enabled.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = \"Organization access updated.\"\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"#{@registered_organization.api_env.capitalize} access could not be\n+        flash[:alert] = \"Organization access could not be\n                         updated: #{model_error_string(@registered_organization)}.\"\n         render :edit\n       end\n     end\n \n     def destroy\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.destroy\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access disabled.\"\n+        flash[:notice] = \"Organization access disabled.\"", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5MzcwNw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445693707", "bodyText": "Prefer single-quoted strings when you don't need string interpolation or special symbols.", "author": "codeclimate", "createdAt": "2020-06-25T16:41:15Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -110,7 +103,7 @@ def delegated_macaroon(reg_org_api_id)\n   end\n \n   def golden_macaroon\n-    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_#{api_env.upcase}\")\n+    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_SANDBOX\")", "originalCommit": "0b179f6d3b5c59aafbf78b52be1985a79f198e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc64b89fa3930aad371f3d55fd205294664fa095", "url": "https://github.com/CMSgov/dpc-app/commit/cc64b89fa3930aad371f3d55fd205294664fa095", "message": "Fix broken tests for registerd org controller", "committedDate": "2020-06-25T16:43:50Z", "type": "commit"}, {"oid": "fb22bc95eded1b3fec12a4424b898c028c13d656", "url": "https://github.com/CMSgov/dpc-app/commit/fb22bc95eded1b3fec12a4424b898c028c13d656", "message": "Updated organization update", "committedDate": "2020-06-25T17:02:25Z", "type": "commit"}, {"oid": "2d129ef7e6e88e1c543d306d67214733ad3b3ec0", "url": "https://github.com/CMSgov/dpc-app/commit/2d129ef7e6e88e1c543d306d67214733ad3b3ec0", "message": "Merge branch 'DPC-148-simplify-web-app-for-one-env' of github.com:CMSgov/dpc-app into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-25T17:02:35Z", "type": "commit"}, {"oid": "05443cdd012611d315c84b743062f199822a0baf", "url": "https://github.com/CMSgov/dpc-app/commit/05443cdd012611d315c84b743062f199822a0baf", "message": "Updating user org send sandbox email", "committedDate": "2020-06-25T17:05:38Z", "type": "commit"}, {"oid": "4675f7a0d8cb3a63288bcc9a1095c01f8795c465", "url": "https://github.com/CMSgov/dpc-app/commit/4675f7a0d8cb3a63288bcc9a1095c01f8795c465", "message": "Organization_User_Assignment Spec", "committedDate": "2020-06-25T19:26:42Z", "type": "commit"}, {"oid": "b617151d135f085665b58e8dc9240bf8ba1dcc81", "url": "https://github.com/CMSgov/dpc-app/commit/b617151d135f085665b58e8dc9240bf8ba1dcc81", "message": "Make reg_org short circuit call in org model", "committedDate": "2020-06-25T19:36:06Z", "type": "commit"}, {"oid": "cf590f28a17f29ae694d5421353291fdc6bb5b91", "url": "https://github.com/CMSgov/dpc-app/commit/cf590f28a17f29ae694d5421353291fdc6bb5b91", "message": "Update tests for registered org specs", "committedDate": "2020-06-25T19:36:32Z", "type": "commit"}, {"oid": "c74bb76f93ac6e35aab8637fc2c3d35c677938b3", "url": "https://github.com/CMSgov/dpc-app/commit/c74bb76f93ac6e35aab8637fc2c3d35c677938b3", "message": "Fix cloudwatch issues", "committedDate": "2020-06-25T19:49:39Z", "type": "commit"}, {"oid": "649cac55cda40c51a44143f0123b40bc8d3dce67", "url": "https://github.com/CMSgov/dpc-app/commit/649cac55cda40c51a44143f0123b40bc8d3dce67", "message": "Fix tests in client token controller spec", "committedDate": "2020-06-25T20:04:07Z", "type": "commit"}, {"oid": "9ff893793c693c49eed8d0dfdc2c1538f997b4e7", "url": "https://github.com/CMSgov/dpc-app/commit/9ff893793c693c49eed8d0dfdc2c1538f997b4e7", "message": "Creating & Updating Organizations Spec", "committedDate": "2020-06-25T20:05:34Z", "type": "commit"}, {"oid": "62d36d13ef312b1bfbbf7c4a862203028abd64da", "url": "https://github.com/CMSgov/dpc-app/commit/62d36d13ef312b1bfbbf7c4a862203028abd64da", "message": "Merge branch 'DPC-148-simplify-web-app-for-one-env' of github.com:CMSgov/dpc-app into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-25T20:05:43Z", "type": "commit"}, {"oid": "9fcceaeaa0ce09e797d54376a0769c24907c5e25", "url": "https://github.com/CMSgov/dpc-app/commit/9fcceaeaa0ce09e797d54376a0769c24907c5e25", "message": "Client token manager spec", "committedDate": "2020-06-25T20:12:03Z", "type": "commit"}, {"oid": "75d843fcb78fd3d789fbea39adb3ecacfee92002", "url": "https://github.com/CMSgov/dpc-app/commit/75d843fcb78fd3d789fbea39adb3ecacfee92002", "message": "Managing API credentials spec", "committedDate": "2020-06-25T20:15:32Z", "type": "commit"}, {"oid": "6a5e31e5f7c33bd732c304e724a3004f6983a9bd", "url": "https://github.com/CMSgov/dpc-app/commit/6a5e31e5f7c33bd732c304e724a3004f6983a9bd", "message": "Update api client spec tests", "committedDate": "2020-06-25T20:33:39Z", "type": "commit"}, {"oid": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "url": "https://github.com/CMSgov/dpc-app/commit/4a46687a9df6a1e11c7a7766f3b5730676814c42", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-25T20:36:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNDgzNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445834835", "bodyText": "Names with \"sandbox\" in them retain the old view of the app--in this case, that we need to differentiate sandbox-related emails from, say, prod-related emails.  How hard is it to rename this method and the tests that call it?", "author": "dhgreene", "createdAt": "2020-06-25T20:59:31Z", "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -3,13 +3,18 @@\n require 'rails_helper'\n \n RSpec.describe OrganizationUserAssignment, type: :model do\n+  include APIClientSupport\n+\n   describe 'callbacks' do\n     describe '#send_organization_sandbox_email' do", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0ODQ0Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445848447", "bodyText": "Currently we dont have prod emailing setup at all. It just doesnt exist. Im assuming, at some point, we will introduce that. We can make changes now or wait till that work comes down the pipeline.", "author": "SMLuthi", "createdAt": "2020-06-25T21:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1NTMyMA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446155320", "bodyText": "Also right now the emails sent to sandbox have language specific to the sandbox environment (i.e. naming it, reminding users not to use real patient data etc etc.", "author": "Sun-Mountain", "createdAt": "2020-06-26T12:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNDgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNTY3NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445835675", "bodyText": "Do we still need this property (and a test for it), since we're now automatically allowing all new sandbox users?  I see references to :sandbox_enabled? being replaced with :api_enabled?.", "author": "dhgreene", "createdAt": "2020-06-25T21:01:09Z", "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -3,13 +3,18 @@\n require 'rails_helper'\n \n RSpec.describe OrganizationUserAssignment, type: :model do\n+  include APIClientSupport\n+\n   describe 'callbacks' do\n     describe '#send_organization_sandbox_email' do\n       it 'sends email if org is sandbox_enabled' do", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1ODA4NA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446258084", "bodyText": "Changed.", "author": "Sun-Mountain", "createdAt": "2020-06-26T15:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzNTY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzOTU5Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445839596", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Enable PI access for <%= @organization.name %>\n          \n          \n            \n                  Enable API access for <%= @organization.name %>", "author": "dhgreene", "createdAt": "2020-06-25T21:09:25Z", "path": "dpc-web/app/views/internal/registered_organizations/new.html.erb", "diffHunk": "@@ -3,8 +3,8 @@\n <div class=\"ds-l-container ds-u-padding-x--0\">\n   <section class=\"ds-u-display--flex ds-u-justify-content--between ds-u-align-items--center\">\n \n-    <h1 class=\"ds-u-font-size--title ds-u-font-weight--normal ds-u-margin--0\" data-test=\"new-reg-org-<%= @registered_organization.api_env %>\">\n-      Enable <%= @api_env.capitalize %> API access for <%= @organization.name %>\n+    <h1 class=\"ds-u-font-size--title ds-u-font-weight--normal ds-u-margin--0\" data-test=\"new-reg-org\" >\n+      Enable PI access for <%= @organization.name %>", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTUwNA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445841504", "bodyText": "We don't have a web app for pilot", "author": "dhgreene", "createdAt": "2020-06-25T21:13:32Z", "path": "dpc-web/app/views/dashboard/_assigned_content.html.erb", "diffHunk": "@@ -1,4 +1,11 @@\n-<p class=\"ds-text--lead ds-u-measure--wide ds-u-margin-top--2\">Welcome to the Data at the Point of Care Pilot. You have been assigned to the organizations below to start using the APIs in a synthetic, or test, sandbox. <strong>Remember</strong>, do NOT add any real patient information to the sandbox environment. </p>\n+<p class=\"ds-text--lead ds-u-measure--wide ds-u-margin-top--2\">\n+  <% if prod_sbx? %>\n+    Welcome to the Data at the Point of Care Sandbox. You have been assigned to the organizations below to start using the APIs in a synthetic, or test, sandbox. <strong>Remember</strong>, do NOT add any real patient information to the sandbox environment.\n+  <% else %>\n+    <%# Need to speak with Product/H Team about welcome for pilot %>\n+    Welcome to the Data at the Point of Care Pilot.", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIxOTI2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446219263", "bodyText": "Will it always be sandbox?", "author": "Sun-Mountain", "createdAt": "2020-06-26T14:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzMjEyNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446232125", "bodyText": "Reverted, but right now the language does say that they are working in Sandbox and to not upload real patient data to the API. Will the pilot users ever use the web app?", "author": "Sun-Mountain", "createdAt": "2020-06-26T14:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTk5Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445841996", "bodyText": "Is it worth renaming this to GOLDEN_MACAROON?  It would require an associated ops PR, but decrease cognitive dissonance in dev and test to see GOLDEN_MACAROON_SANDBOX.", "author": "dhgreene", "createdAt": "2020-06-25T21:14:37Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -110,7 +103,7 @@ def delegated_macaroon(reg_org_api_id)\n   end\n \n   def golden_macaroon\n-    @golden_macaroon ||= ENV.fetch(\"GOLDEN_MACAROON_#{api_env.upcase}\")\n+    @golden_macaroon ||= ENV.fetch('GOLDEN_MACAROON_SANDBOX')", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NzE5MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445847191", "bodyText": "Yes, I've taken notes on a few things like this. I didnt include them in this PR because I figured a separate, smaller PR with an associated ops PR would be a little cleaner... rather than trying to dump it all in this one giant one", "author": "SMLuthi", "createdAt": "2020-06-25T21:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDY4NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445844685", "bodyText": "Should \"Organization\" be \"API\" in this and the following alerts?", "author": "dhgreene", "createdAt": "2020-06-25T21:20:28Z", "path": "dpc-web/app/controllers/internal/registered_organizations_controller.rb", "diffHunk": "@@ -17,49 +16,45 @@ def new\n \n     def create\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations\n-                                              .build(registered_organization_params)\n-      @api_env = params[:api_env] || @registered_organization.api_env\n+      @registered_organization = @organization.build_registered_organization(registered_organization_params)\n \n       if @registered_organization.save\n-        flash[:notice] = \"Access to #{@registered_organization.api_env} enabled.\"\n+        flash[:notice] = 'Organization has been enabled.'\n         redirect_to internal_organization_path(@organization)\n       else\n-        flash[:alert] = \"Access to #{@registered_organization.api_env} could not be enabled:\n+        flash[:alert] = \"Organization could not be enabled:\n                         #{model_error_string(@registered_organization)}.\"\n         render :new\n       end\n     end\n \n     def edit\n-      @api_env = params[:api_env]\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n+      @registered_organization = @organization.registered_organization\n     end\n \n     def update\n       @organization = Organization.find(org_id_param)\n-      @registered_organization = @organization.registered_organizations.find(params[:id])\n-      @api_env = @registered_organization.api_env\n+      @registered_organization = @organization.registered_organization\n \n       if @registered_organization.update(registered_organization_params)\n-        flash[:notice] = \"#{@registered_organization.api_env.capitalize} access updated.\"\n+        flash[:notice] = 'Organization access updated.'", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIyMjA5OA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446222098", "bodyText": "Changed!", "author": "Sun-Mountain", "createdAt": "2020-06-26T14:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTU2OQ==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445845569", "bodyText": "Does it still make sense to have two separate models/tables?", "author": "dhgreene", "createdAt": "2020-06-25T21:22:22Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -6,7 +6,7 @@ class Organization < ApplicationRecord\n   has_one :address, as: :addressable, dependent: :destroy\n   has_many :organization_user_assignments, dependent: :destroy\n   has_many :users, through: :organization_user_assignments\n-  has_many :registered_organizations, dependent: :destroy\n+  has_one :registered_organization, dependent: :destroy", "originalCommit": "4a46687a9df6a1e11c7a7766f3b5730676814c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0Nzg1Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r445847853", "bodyText": "Good question. I could go either way on this tbh. On one hand it contains a clean separation between an org and a registered organization but on the other hand we could just incorporate them together and allow for blank columns. Im open for suggestions.", "author": "SMLuthi", "createdAt": "2020-06-25T21:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTAwNA==", "url": "https://github.com/CMSgov/dpc-app/pull/881#discussion_r446165004", "bodyText": "This was something that we were definitely talking about during our work.\nMy understanding is a registered organization is what exists in the API (and is copied from & updated w/ the organization model).", "author": "Sun-Mountain", "createdAt": "2020-06-26T12:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTU2OQ=="}], "type": "inlineReview"}, {"oid": "81ebefd8509e087be8c4cc55f0be58cce9d0b523", "url": "https://github.com/CMSgov/dpc-app/commit/81ebefd8509e087be8c4cc55f0be58cce9d0b523", "message": "Update dpc-web/app/views/internal/registered_organizations/new.html.erb\n\nCo-authored-by: dhgreene <dhgreene@gmail.com>", "committedDate": "2020-06-25T21:24:10Z", "type": "commit"}, {"oid": "0117fd1d129570fa505ba2657ef82260c454b6bb", "url": "https://github.com/CMSgov/dpc-app/commit/0117fd1d129570fa505ba2657ef82260c454b6bb", "message": "registered organization controller alerts & notices updated", "committedDate": "2020-06-26T14:33:12Z", "type": "commit"}, {"oid": "a3fa21089c8df497a32462f9626585f63fcdcdb6", "url": "https://github.com/CMSgov/dpc-app/commit/a3fa21089c8df497a32462f9626585f63fcdcdb6", "message": "Remove prod_sbx conditional view from assigned content", "committedDate": "2020-06-26T14:42:15Z", "type": "commit"}, {"oid": "2daecde365217bc9dc8309fe804bde8a8b449c15", "url": "https://github.com/CMSgov/dpc-app/commit/2daecde365217bc9dc8309fe804bde8a8b449c15", "message": "Change names of organization user assigment spec tests", "committedDate": "2020-06-26T15:05:21Z", "type": "commit"}, {"oid": "ab415c8c64b0c8f9b93be6a4153816c28df3721e", "url": "https://github.com/CMSgov/dpc-app/commit/ab415c8c64b0c8f9b93be6a4153816c28df3721e", "message": "Internal org dashboard update", "committedDate": "2020-06-26T15:16:28Z", "type": "commit"}, {"oid": "015fca72ab7a870ae29ed259196de9d347311520", "url": "https://github.com/CMSgov/dpc-app/commit/015fca72ab7a870ae29ed259196de9d347311520", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-26T16:27:37Z", "type": "commit"}, {"oid": "332ff182b54fc6bc30702a4f9c07fcde670127f1", "url": "https://github.com/CMSgov/dpc-app/commit/332ff182b54fc6bc30702a4f9c07fcde670127f1", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-30T19:17:04Z", "type": "commit"}, {"oid": "4b5f0c626d84da76b6b4e8a5f3624ed405a35569", "url": "https://github.com/CMSgov/dpc-app/commit/4b5f0c626d84da76b6b4e8a5f3624ed405a35569", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-06-30T20:38:55Z", "type": "commit"}, {"oid": "afd7328b7fbb8e275b0d90e1d67827863ac30158", "url": "https://github.com/CMSgov/dpc-app/commit/afd7328b7fbb8e275b0d90e1d67827863ac30158", "message": "Merge branch 'master' into DPC-148-simplify-web-app-for-one-env", "committedDate": "2020-07-01T16:20:19Z", "type": "commit"}]}