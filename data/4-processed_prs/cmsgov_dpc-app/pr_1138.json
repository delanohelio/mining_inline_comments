{"pr_number": 1138, "pr_title": "DPC-916 fix: Remove requirement for Patient to be in a group for Patient/$everything", "pr_createdAt": "2020-12-09T21:34:11Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1138", "timeline": [{"oid": "1700e94ac35fdacd307fd4b7a2bdc33b87e23056", "url": "https://github.com/CMSgov/dpc-app/commit/1700e94ac35fdacd307fd4b7a2bdc33b87e23056", "message": "refactor: clean up `PatientResourceTest` and add new test\nTo improve readability, move duplicate code into shared private methods\n- split up `Patient/$everything` test\n- add new test for patients without groups", "committedDate": "2020-12-09T21:02:57Z", "type": "commit"}, {"oid": "d27af0bc53d5b06590b7609942bfacfe1bb5ad77", "url": "https://github.com/CMSgov/dpc-app/commit/d27af0bc53d5b06590b7609942bfacfe1bb5ad77", "message": "refactor: rename `patientIDs` to `patientMBIs` for clarity", "committedDate": "2020-12-09T21:13:20Z", "type": "commit"}, {"oid": "923e462cd4c43ae293c6cdaf32349129bff6d42c", "url": "https://github.com/CMSgov/dpc-app/commit/923e462cd4c43ae293c6cdaf32349129bff6d42c", "message": "feat: Add `ProviderDAO` and enable retrieving Provider NPI from `LookBackServiceImpl` when no Roster.", "committedDate": "2020-12-09T21:17:30Z", "type": "commit"}, {"oid": "9f1f082fadbb2bac85b7f4f94c3d9545cae50122", "url": "https://github.com/CMSgov/dpc-app/commit/9f1f082fadbb2bac85b7f4f94c3d9545cae50122", "message": "fix: no longer need to limit Roster check by Provider as we are checking this in the `LookBackServiceImpl`", "committedDate": "2020-12-09T21:18:53Z", "type": "commit"}, {"oid": "79e3a9ddc1aad2f7171e7993254099efab4fc3be", "url": "https://github.com/CMSgov/dpc-app/commit/79e3a9ddc1aad2f7171e7993254099efab4fc3be", "message": "fix: remove requirement for Patient to be in a Roster for `$everything` request and catch OperationOutcome from LookBack", "committedDate": "2020-12-09T21:20:08Z", "type": "commit"}, {"oid": "8513a0274b8255575c62c6be8956629bb26e393e", "url": "https://github.com/CMSgov/dpc-app/commit/8513a0274b8255575c62c6be8956629bb26e393e", "message": "Merge branch 'master' into jkf/dpc-916-fix-patient-everything", "committedDate": "2020-12-09T21:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3NTY2OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r539675668", "bodyText": "Method provideLookBackService has 5 arguments (exceeds 4 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-12-09T21:52:24Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/AggregationAppModule.java", "diffHunk": "@@ -94,13 +96,13 @@ public int provideJobTimeoutInSeconds() {\n     }\n \n     @Provides\n-    LookBackService provideLookBackService(DPCManagedSessionFactory sessionFactory, RosterDAO rosterDAO, OrganizationDAO organizationDAO, OperationsConfig operationsConfig) {\n+    LookBackService provideLookBackService(DPCManagedSessionFactory sessionFactory, ProviderDAO providerDAO, RosterDAO rosterDAO, OrganizationDAO organizationDAO, OperationsConfig operationsConfig) {", "originalCommit": "8513a0274b8255575c62c6be8956629bb26e393e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNDE3OQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r539734179", "bodyText": "the constructor requires all of those for injection by guice. The only way to avoid this would be to create another class that takes a subset of those as a constructor, which is unnecessary.", "author": "jonfulk", "createdAt": "2020-12-09T23:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3NTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1Nzk2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540257963", "bodyText": "could you change the description too?  Something like List of patient MBIs", "author": "MrBilnon", "createdAt": "2020-12-10T15:24:26Z", "path": "dpc-queue/src/main/java/gov/cms/dpc/queue/service/DataService.java", "diffHunk": "@@ -53,17 +53,17 @@ public Resource retrieveData(UUID organizationId, UUID providerId, List<String>\n      * Retrieves data from BFD\n      * @param organizationID UUID of organization\n      * @param providerID UUID of provider\n-     * @param patientIDs List of patient String UUIDs\n+     * @param patientMBIs List of patient String UUIDs", "originalCommit": "8513a0274b8255575c62c6be8956629bb26e393e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzNDE1MA==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540434150", "bodyText": "good point. i'll do that!", "author": "jonfulk", "createdAt": "2020-12-10T19:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1Nzk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2MDIwMA==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540260200", "bodyText": "not sure about the name of this exception as an operation outcome could be returned due to BFD being down or the MBI was in a bad format or something else.", "author": "MrBilnon", "createdAt": "2020-12-10T15:27:04Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/PatientResource.java", "diffHunk": "@@ -198,16 +197,16 @@ public Bundle everything(@ApiParam(hidden = true) @Auth OrganizationPrincipal or\n         final String patientMbi = FHIRExtractors.getPatientMBI(patient);\n         final UUID orgId = organization.getID();\n \n-        if (!isPatientInRoster(patientId, FHIRExtractors.getProviderNPI(practitioner), orgId)) {\n-            throw new WebApplicationException(HttpStatus.UNAUTHORIZED_401);\n-        }\n-\n         final String requestingIP = APIHelpers.fetchRequestingIP(request);\n         Resource result = dataService.retrieveData(orgId, practitionerId, List.of(patientMbi), APIHelpers.fetchTransactionTime(bfdClient),\n                 requestingIP, ResourceType.Patient, ResourceType.ExplanationOfBenefit, ResourceType.Coverage);\n         if (ResourceType.Bundle.equals(result.getResourceType())) {\n             return (Bundle) result;\n         }\n+        if (ResourceType.OperationOutcome.equals(result.getResourceType())) {\n+            OperationOutcome resultOp = (OperationOutcome) result;\n+            throw new NotAuthorizedException(resultOp.getIssueFirstRep().getDetails().getText());", "originalCommit": "8513a0274b8255575c62c6be8956629bb26e393e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzNTcyOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540435729", "bodyText": "@whuang85 Are you saying that it should be a different exception type, that we should check something else before throwing an exception, and/or that the message could fail if there isn't an issue with details and text? All of the above is an acceptable answer.", "author": "jonfulk", "createdAt": "2020-12-10T19:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2MDIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3NzgwMw==", "url": "https://github.com/CMSgov/dpc-app/pull/1138#discussion_r540477803", "bodyText": "@jonfulk just not sure if it should be returning a 401 when the reason data could not be returned is because either BFD is down, mbi is malformed, or look back failed. Could theoretically be caused by a null pointer exception in aggregation too.", "author": "MrBilnon", "createdAt": "2020-12-10T20:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2MDIwMA=="}], "type": "inlineReview"}, {"oid": "f33e0b73e529c824c53c30965f7424f8019083bb", "url": "https://github.com/CMSgov/dpc-app/commit/f33e0b73e529c824c53c30965f7424f8019083bb", "message": "fix: update argument description to match name", "committedDate": "2020-12-11T15:36:37Z", "type": "commit"}, {"oid": "f7d8935538bc3d69d6f055fd1a5591001281efe9", "url": "https://github.com/CMSgov/dpc-app/commit/f7d8935538bc3d69d6f055fd1a5591001281efe9", "message": "fix: since exceptions from BFD could vary, return a 500", "committedDate": "2020-12-11T15:37:03Z", "type": "commit"}, {"oid": "e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1", "url": "https://github.com/CMSgov/dpc-app/commit/e96deaefb338c46f6a9e00f5bb16c8cdc87b1bb1", "message": "fix: update test for different exception type", "committedDate": "2020-12-11T15:44:13Z", "type": "commit"}]}