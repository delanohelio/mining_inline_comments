{"pr_number": 974, "pr_title": "DPC-582: Return HTTP 410 for jobs older than 24 hours", "pr_createdAt": "2020-08-13T12:45:43Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/974", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "96bedd06430f83a41566548d9d4f02c6dfa7e3fc", "url": "https://github.com/CMSgov/dpc-app/commit/96bedd06430f83a41566548d9d4f02c6dfa7e3fc", "message": "Add 410 job and data responses to Swagger annotations", "committedDate": "2020-08-13T14:14:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0NzU3MA==", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476447570", "bodyText": "Does this mean that we will NOT return a 410 on a job if the batches are not all completed, even if expired? That sounds fine because all batches should be completed within 24 hours, but I just wanted to ask the question to be sure that there isn't a missed edge case here.", "author": "jonfulk", "createdAt": "2020-08-25T13:28:04Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/resources/v1/DataResource.java", "diffHunk": "@@ -130,6 +139,17 @@ public Response downloadExportFile(@ApiParam(hidden = true) @Auth OrganizationPr\n \n         final FileManager.FilePointer filePointer = this.manager.getFile(organizationPrincipal.getID(), fileID);\n \n+        // If job is expired, the files should no longer be accessible\n+        List<JobQueueBatch> batches = queue.getJobBatches(filePointer.getJobID());\n+        Set<JobStatus> jobStatusSet = batches.stream().map(JobQueueBatch::getStatus).collect(Collectors.toSet());\n+        if (jobStatusSet.size() == 1 && jobStatusSet.contains(JobStatus.COMPLETED)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2MjAyNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476462025", "bodyText": "Great question. The job isn't considered expired until 24 hours after all of its batches are completed.", "author": "em1", "createdAt": "2020-08-25T13:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0NzU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NzI1OA==", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476457258", "bodyText": "why do you need both of these assertions? if the second is true, the first is as well.", "author": "jonfulk", "createdAt": "2020-08-25T13:41:31Z", "path": "dpc-api/src/test/java/gov/cms/dpc/api/resources/v1/JobResourceTest.java", "diffHunk": "@@ -129,6 +132,10 @@ public void testSuccessfulJob() {\n         final Response response = resource.checkJobStatus(organizationPrincipal, jobID.toString());\n         assertAll(() -> assertEquals(HttpStatus.OK_200, response.getStatus()));\n \n+        var expires = ZonedDateTime.parse(response.getHeaderString(\"Expires\"), JobResource.HTTP_DATE_FORMAT);\n+        assertAll(() -> expires.isAfter(ZonedDateTime.now().plusHours(23)),\n+                () -> expires.isAfter(ZonedDateTime.now().plusHours(25)));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2Mjc2OA==", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476462768", "bodyText": "You may have caught a bug; that second one should be .isBefore()! Taking a closer look.", "author": "em1", "createdAt": "2020-08-25T13:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NzI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ3NDkxNg==", "url": "https://github.com/CMSgov/dpc-app/pull/974#discussion_r476474916", "bodyText": "Fixed! Thanks for catching this.", "author": "em1", "createdAt": "2020-08-25T14:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NzI1OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "d089b6378375a8632a80f13c41c50d4ded45fcdd", "url": "https://github.com/CMSgov/dpc-app/commit/d089b6378375a8632a80f13c41c50d4ded45fcdd", "message": "Return 410 Gone when latest job batch completion was more than 24 hours ago", "committedDate": "2020-08-25T14:11:20Z", "type": "commit"}, {"oid": "e8d75138684ee32757f61d55ce7ce1106d68bd4c", "url": "https://github.com/CMSgov/dpc-app/commit/e8d75138684ee32757f61d55ce7ce1106d68bd4c", "message": "Add Expires header to completed jobs; confirm that a job is not yet expired at 23 hours", "committedDate": "2020-08-25T14:11:20Z", "type": "commit"}, {"oid": "0c58a25c1f87706da595e770b56c6ab9c9ca7546", "url": "https://github.com/CMSgov/dpc-app/commit/0c58a25c1f87706da595e770b56c6ab9c9ca7546", "message": "Return 410 Gone on data files when job is expired", "committedDate": "2020-08-25T14:11:20Z", "type": "commit"}, {"oid": "5e3ebf299a4864e8e3e7b32c2039c0b2aa6d5a2e", "url": "https://github.com/CMSgov/dpc-app/commit/5e3ebf299a4864e8e3e7b32c2039c0b2aa6d5a2e", "message": "Add 410 job and data responses to Swagger annotations", "committedDate": "2020-08-25T14:11:20Z", "type": "commit"}, {"oid": "77aa44dfd064895c6c64c6ab73f41a03710599dd", "url": "https://github.com/CMSgov/dpc-app/commit/77aa44dfd064895c6c64c6ab73f41a03710599dd", "message": "Unit test correction", "committedDate": "2020-08-25T14:11:20Z", "type": "commit"}, {"oid": "77aa44dfd064895c6c64c6ab73f41a03710599dd", "url": "https://github.com/CMSgov/dpc-app/commit/77aa44dfd064895c6c64c6ab73f41a03710599dd", "message": "Unit test correction", "committedDate": "2020-08-25T14:11:20Z", "type": "forcePushed"}, {"oid": "670705c000b484b3196980c96d2b0a5518020e64", "url": "https://github.com/CMSgov/dpc-app/commit/670705c000b484b3196980c96d2b0a5518020e64", "message": "Merge branch 'master' into emily/dpc-582-job-expiration", "committedDate": "2020-08-26T14:40:48Z", "type": "commit"}, {"oid": "4867d2a70136bd678d3e5fc5add1bf24cccd6c26", "url": "https://github.com/CMSgov/dpc-app/commit/4867d2a70136bd678d3e5fc5add1bf24cccd6c26", "message": "Merge branch 'master' into emily/dpc-582-job-expiration", "committedDate": "2020-09-01T15:35:03Z", "type": "commit"}, {"oid": "bced4a0a9090c569ba1aa79e8e8eb463125b0181", "url": "https://github.com/CMSgov/dpc-app/commit/bced4a0a9090c569ba1aa79e8e8eb463125b0181", "message": "Merge branch 'master' into emily/dpc-582-job-expiration", "committedDate": "2020-09-04T18:28:49Z", "type": "commit"}, {"oid": "187a2a862c43eac82b6a6dd6f403a247de1fcf2d", "url": "https://github.com/CMSgov/dpc-app/commit/187a2a862c43eac82b6a6dd6f403a247de1fcf2d", "message": "Merge branch 'master' into emily/dpc-582-job-expiration", "committedDate": "2020-09-09T17:50:06Z", "type": "commit"}]}