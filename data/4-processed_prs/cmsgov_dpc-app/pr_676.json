{"pr_number": 676, "pr_title": "aggregation engine health check", "pr_createdAt": "2020-03-10T14:37:33Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/676", "timeline": [{"oid": "658eb3fe62826497a7d0e4cdd0279064b15550bf", "url": "https://github.com/CMSgov/dpc-app/commit/658eb3fe62826497a7d0e4cdd0279064b15550bf", "message": "aggregation engine health check", "committedDate": "2020-03-10T14:36:53Z", "type": "commit"}, {"oid": "2ca60734e2d8012bcad570c3c2b18a5b9490176c", "url": "https://github.com/CMSgov/dpc-app/commit/2ca60734e2d8012bcad570c3c2b18a5b9490176c", "message": "revert changing method to public", "committedDate": "2020-03-10T14:38:33Z", "type": "commit"}, {"oid": "112fed5e9badb5c2e2fb006be74bd20122eced94", "url": "https://github.com/CMSgov/dpc-app/commit/112fed5e9badb5c2e2fb006be74bd20122eced94", "message": "add another test", "committedDate": "2020-03-10T14:45:13Z", "type": "commit"}, {"oid": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "url": "https://github.com/CMSgov/dpc-app/commit/fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "message": "when calling stop, engine should be healthy again", "committedDate": "2020-03-10T15:11:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390449224", "bodyText": "Marking a batch as failed is a recoverable state. How would the aggregator return to a healthy state after marking a batch as inError?", "author": "ronaldheft-usds", "createdAt": "2020-03-10T16:33:27Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -179,6 +186,7 @@ protected void processJobBatch(JobQueueBatch job) {\n         } catch (Exception error) {\n             logger.error(\"FAILED job {} batch {}\", job.getJobID(), job.getBatchID(), error);\n             this.queue.failBatch(job, aggregatorID);\n+            inError.set(true);", "originalCommit": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NDkwMA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390454900", "bodyText": "I'm thinking we either need to set inError on line 188, and then set it back to false in a finally block (so if the batch is marked correctly as failed and processing resumes, the aggregator is no longer inError), or we don't count this scenario as an error scenario.", "author": "ronaldheft-usds", "createdAt": "2020-03-10T16:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MzYwOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390463609", "bodyText": "@ronaldheft-usds, if it went to inError and it's running wouldn't EC2 restart the instance and spin up a new AggregationEngine?", "author": "MrBilnon", "createdAt": "2020-03-10T16:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU0OTMzNg==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390549336", "bodyText": "Correct, but this.queue.failBatch is a recoverable scenario. It marks the batch as failed and then starts processing the next item. Unlike what happens in the pollQueue method, where an error in their stops processing, and the AggregationEngine ends up just sitting there doing nothing.", "author": "ronaldheft-usds", "createdAt": "2020-03-10T19:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI1Nzg2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391257863", "bodyText": "just to put it here, so the only place where a true unrecoverable error can happen is in the error callback of the subscribe but since the processBatch catches all exceptions, it should technically never reach that callback", "author": "MrBilnon", "createdAt": "2020-03-11T20:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0OTIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODA2Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r390458067", "bodyText": "Is this test starting the aggregator for 5 seconds, then running assertions, and stopping the aggregator?\nDo we need to test the behind-the-scenes action of the AggregationEngine, or is a mock more sufficient (simulating isRunning and inError states)?\nWe do have an existing test suite called AggregationEngineTest that may be better suited to handle the verifying the inError state is set correct.", "author": "ronaldheft-usds", "createdAt": "2020-03-10T16:46:19Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig);\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(aggregatorID, engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);", "originalCommit": "fc4dd4df246369f0f6ee88c6846695bc8a2c5904", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxMzA3NA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391813074", "bodyText": "I\u2019ve left these tests to showcase that these scenarios should not cause the engine to shutdown but to continue running.\nI\u2019ve added a test in aggregationEngineTest that does have the engine exit the loop with an error and thus calls onError and sets the isRunning to false.", "author": "MrBilnon", "createdAt": "2020-03-12T18:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODA2Nw=="}], "type": "inlineReview"}, {"oid": "c25f6870135ca9d1bc43e96032cad9c77061d395", "url": "https://github.com/CMSgov/dpc-app/commit/c25f6870135ca9d1bc43e96032cad9c77061d395", "message": "remove call to set inError in places where the job is recoverable", "committedDate": "2020-03-11T17:55:30Z", "type": "commit"}, {"oid": "3676ff60b4a617564efdf17a68161c2eff2a0feb", "url": "https://github.com/CMSgov/dpc-app/commit/3676ff60b4a617564efdf17a68161c2eff2a0feb", "message": "use accessor for aggregatorId", "committedDate": "2020-03-11T18:28:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NTk1NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391265955", "bodyText": "Should anything outside of the engine ever call the onError? In other words, why is this method public? I don't quite follow the logic here. It seems to be saying if engine.onError is called then engine.inError is true. Not sure if that is what you wanted to test.", "author": "RickHawesUSDS", "createdAt": "2020-03-11T21:02:10Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/engine/AggregationEngineTest.java", "diffHunk": "@@ -157,6 +158,26 @@ void simpleJobTest() {\n         assertTrue(Files.exists(Path.of(outputFilePath)));\n         final var errorFilePath = ResourceWriter.formOutputFilePath(exportPath, completeJob.getBatchID(), ResourceType.OperationOutcome, 0);\n         assertFalse(Files.exists(Path.of(errorFilePath)), \"expect no error file\");\n+        assertFalse(engine.inError());\n+    }\n+\n+    @Test\n+    void simpleJobExceptionTest() {\n+        final var orgID = UUID.randomUUID();\n+\n+        // Make a simple job with one resource type\n+        final var jobID = queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(MockBlueButtonClient.TEST_PATIENT_MBIS.get(0)),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        // Work the batch\n+        queue.claimBatch(engine.getAggregatorID())\n+                .ifPresent(t -> engine.onError(new RuntimeException(\"error\")));\n+", "originalCommit": "3676ff60b4a617564efdf17a68161c2eff2a0feb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5OTA2Mw==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391299063", "bodyText": "After the changes from Ron and Emily, theoretically the engine.onError should never be called as the processBatch already catches all Exceptions and then marks the batch failed and the engine moves on. My health check is getting less relevant as Ron checks in more commits.", "author": "MrBilnon", "createdAt": "2020-03-11T22:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2Nzg0Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391267842", "bodyText": "Unless I'm missing something, I'm don't see a negative (eg. Assert.assertFalse(healthCheck.check().isHealth())) test. Should there be one?", "author": "RickHawesUSDS", "createdAt": "2020-03-11T21:06:10Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = Mockito.spy(new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig));\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenJobBatchErrors() throws InterruptedException {\n+\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(bbclient).requestPatientFromServer(Mockito.anyString());\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenClaimBatchErrors() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(queue).claimBatch(Mockito.any(UUID.class));\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+    }\n+\n+    @Test\n+    public void testHealthyEngineWhenQueueOperationsError() throws InterruptedException {\n+        Mockito.doThrow(new RuntimeException(\"Error\")).when(queue).completePartialBatch(Mockito.any(JobQueueBatch.class), Mockito.any(UUID.class));\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);\n+        executor.awaitTermination(5, TimeUnit.SECONDS);\n+\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+    }\n+}", "originalCommit": "3676ff60b4a617564efdf17a68161c2eff2a0feb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI3MDg4Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391270886", "bodyText": "I'm wondering how a stuck job will make the aggregator unhealthy? Or is the intent to only make the aggregator unhealthy when an exception is thrown?", "author": "RickHawesUSDS", "createdAt": "2020-03-11T21:12:20Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -123,17 +129,23 @@ protected void pollQueue() {\n                 .map(Optional::get)\n                 .subscribe(\n                         this::processJobBatch,\n-                        error -> {\n-                            logger.error(\"Error processing queue. Exiting...\", error);\n-                            queueRunning.set(false);\n-                        },\n-                        () -> {\n-                            logger.info(\"Finished processing queue. Exiting...\");\n-                            queueRunning.set(false);\n-                        }\n+                        this::onError,\n+                        this::onCompleted\n                 );\n     }\n \n+    public void onError(Throwable error) {\n+        logger.error(\"Error processing queue. Exiting...\", error);\n+        queueRunning.set(false);\n+        inError.set(true);\n+    }", "originalCommit": "3676ff60b4a617564efdf17a68161c2eff2a0feb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczNTE0OA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r391735148", "bodyText": "A stuck job will be handled by the JobQueueHealthCheck. This is to handle the scenario we were seeing where the aggregator is exiting the loop. That has been fixed with #664, but I still think it's a great idea to have a health check that catches this issue if it gets reintroduced somehow.", "author": "ronaldheft-usds", "createdAt": "2020-03-12T16:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI3MDg4Ng=="}], "type": "inlineReview"}, {"oid": "cc15ffbaf8ef3b15fc6941d7d4ce77a46559bd0f", "url": "https://github.com/CMSgov/dpc-app/commit/cc15ffbaf8ef3b15fc6941d7d4ce77a46559bd0f", "message": "base health check on isRunning instead. This will indicate if broke out of the loop and in combination with the queue health check, this will also help determine if something is stuck", "committedDate": "2020-03-12T15:49:39Z", "type": "commit"}, {"oid": "94324b651e3e078934e3b674ac77a8448183d5ed", "url": "https://github.com/CMSgov/dpc-app/commit/94324b651e3e078934e3b674ac77a8448183d5ed", "message": "oops, fix mocking", "committedDate": "2020-03-12T16:28:45Z", "type": "commit"}, {"oid": "65538a965dfabf2dbfd493a491fcb48849304565", "url": "https://github.com/CMSgov/dpc-app/commit/65538a965dfabf2dbfd493a491fcb48849304565", "message": "Merge branch 'master' into willh/aggregation-engine-health-check", "committedDate": "2020-03-12T17:11:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0ODU3MA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392248570", "bodyText": "Suggest that you add a comment for the reason to initialize to running. There was a discussion on this and it would be helpful to capture.", "author": "RickHawesUSDS", "createdAt": "2020-03-13T14:06:20Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -54,7 +54,7 @@\n     private final Meter resourceMeter;\n     private final Meter operationalOutcomeMeter;\n     private Disposable subscribe;\n-    protected AtomicBoolean queueRunning = new AtomicBoolean(false);\n+    protected AtomicBoolean queueRunning = new AtomicBoolean(true);", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjE0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392262146", "bodyText": "Isn't it important to assert while the engine is running? Suggest that you check isHealthy() here.", "author": "RickHawesUSDS", "createdAt": "2020-03-13T14:28:49Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,160 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * These tests are here to make sure the engine is still running/polling in situations where errors are recoverable.\n+ * A test to check if the engine exits out of the loop correctly when an error occurs\n+ * in AggregationEngineTest#testUnhealthyIfProcessJobBatchThrowsException\n+ */\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {\n+    private static final String TEST_PROVIDER_ID = \"1\";\n+    private static final UUID aggregatorID = UUID.randomUUID();\n+\n+    private IJobQueue queue;\n+    private BlueButtonClient bbclient;\n+    private AggregationEngine engine;\n+\n+    static private FhirContext fhirContext = FhirContext.forDstu3();\n+    static private MetricRegistry metricRegistry = new MetricRegistry();\n+    static private String exportPath;\n+\n+\n+    @BeforeAll\n+    static void setupAll() {\n+        final var config = ConfigFactory.load(\"testing.conf\").getConfig(\"dpc.aggregation\");\n+        exportPath = config.getString(\"exportPath\");\n+        AggregationEngine.setGlobalErrorHandler();\n+        ContextUtils.prefetchResourceModels(fhirContext, JobQueueBatch.validResourceTypes);\n+    }\n+\n+    @BeforeEach\n+    void setupEach() {\n+        queue = Mockito.spy(new MemoryBatchQueue(10));\n+        bbclient = Mockito.spy(new MockBlueButtonClient(fhirContext));\n+        var operationalConfig = new OperationsConfig(1000, exportPath, 500);\n+        engine = Mockito.spy(new AggregationEngine(aggregatorID, bbclient, queue, fhirContext, metricRegistry, operationalConfig));\n+        AggregationEngine.setGlobalErrorHandler();\n+    }\n+\n+    @Test\n+    public void testHealthyEngine() throws InterruptedException {\n+\n+        final var orgID = UUID.randomUUID();\n+\n+        queue.createJob(\n+                orgID,\n+                TEST_PROVIDER_ID,\n+                Collections.singletonList(\"1\"),\n+                Collections.singletonList(ResourceType.Patient)\n+        );\n+\n+        AggregationEngineHealthCheck healthCheck = new AggregationEngineHealthCheck(engine);\n+        Assert.assertTrue(healthCheck.check().isHealthy());\n+\n+        ExecutorService executor = Executors.newCachedThreadPool();\n+        executor.execute(engine);", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3OTk0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392279946", "bodyText": "@RickHawesUSDS I think @whuang85 has that covered here: https://github.com/CMSgov/dpc-app/pull/676/files#diff-b6b2fc6f1b1f240ec7b0a995d56cf410R84", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjYzMg==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392262632", "bodyText": "Great change! Covers us in that window during startup.", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:29:36Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -54,7 +54,7 @@\n     private final Meter resourceMeter;\n     private final Meter operationalOutcomeMeter;\n     private Disposable subscribe;\n-    protected AtomicBoolean queueRunning = new AtomicBoolean(false);\n+    protected AtomicBoolean queueRunning = new AtomicBoolean(true);", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzA2OA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392263068", "bodyText": "Nice breaking out the methods into their own callbacks. Makes the code easier to read and easier to test.", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:30:16Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -123,17 +123,21 @@ protected void pollQueue() {\n                 .map(Optional::get)\n                 .subscribe(\n                         this::processJobBatch,\n-                        error -> {\n-                            logger.error(\"Error processing queue. Exiting...\", error);\n-                            queueRunning.set(false);\n-                        },\n-                        () -> {\n-                            logger.info(\"Finished processing queue. Exiting...\");\n-                            queueRunning.set(false);\n-                        }\n+                        this::onError,\n+                        this::onCompleted", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2Mzc1Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392263756", "bodyText": "Switching up aggregationID to public was a good move. Ensures we are consistent with the IDs.", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:31:22Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheck.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import com.codahale.metrics.health.HealthCheck;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class AggregationEngineHealthCheck extends HealthCheck {\n+\n+    private AggregationEngine aggregationEngine;\n+\n+    @Inject\n+    public AggregationEngineHealthCheck(AggregationEngine aggregationEngine) {\n+        this.aggregationEngine = aggregationEngine;\n+    }\n+\n+    @Override\n+    public Result check() {\n+        Result result = Result.healthy();\n+        if (!aggregationEngine.isRunning()) {\n+            result = Result.unhealthy(\"Aggregation Engine instance: \" + aggregationEngine.getAggregatorID() + \" in error state\");", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NDUzNA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392264534", "bodyText": "Great work covering this scenario. This scenario is exactly why we want this health check.", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:32:42Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/engine/AggregationEngineTest.java", "diffHunk": "@@ -388,6 +392,31 @@ void testBlueButtonException() throws GeneralSecurityException {\n \n     }\n \n+    @Test\n+    public void testUnhealthyIfProcessJobBatchThrowsException() throws InterruptedException {", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NjU2NA==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392266564", "bodyText": "I really like this test quite. You covered all the issues that have tripped up on the incident.\nMy only concern is the 5 second requirement per test. This adds 20+ seconds to our test suite. I don't want to hold up closing out the incident over this, but I think we should keep this tech debt in mind, that we may have to optimize our unit tests in the future to run quicker.", "author": "ronaldheft-usds", "createdAt": "2020-03-13T14:36:05Z", "path": "dpc-aggregation/src/test/java/gov/cms/dpc/aggregation/health/AggregationEngineHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,160 @@\n+package gov.cms.dpc.aggregation.health;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import com.codahale.metrics.MetricRegistry;\n+import com.typesafe.config.ConfigFactory;\n+import gov.cms.dpc.aggregation.engine.AggregationEngine;\n+import gov.cms.dpc.aggregation.engine.OperationsConfig;\n+import gov.cms.dpc.bluebutton.client.BlueButtonClient;\n+import gov.cms.dpc.bluebutton.client.MockBlueButtonClient;\n+import gov.cms.dpc.fhir.hapi.ContextUtils;\n+import gov.cms.dpc.queue.IJobQueue;\n+import gov.cms.dpc.queue.MemoryBatchQueue;\n+import gov.cms.dpc.queue.models.JobQueueBatch;\n+import gov.cms.dpc.testing.BufferedLoggerHandler;\n+import org.hl7.fhir.dstu3.model.ResourceType;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * These tests are here to make sure the engine is still running/polling in situations where errors are recoverable.\n+ * A test to check if the engine exits out of the loop correctly when an error occurs\n+ * in AggregationEngineTest#testUnhealthyIfProcessJobBatchThrowsException\n+ */\n+@ExtendWith(BufferedLoggerHandler.class)\n+public class AggregationEngineHealthCheckTest {", "originalCommit": "65538a965dfabf2dbfd493a491fcb48849304565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwMjA0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/676#discussion_r392302046", "bodyText": "I can cut it down on some time, I just wanted to ensure it has time to process a job and the rest of the time it is sitting in the repeatWhen loop", "author": "MrBilnon", "createdAt": "2020-03-13T15:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NjU2NA=="}], "type": "inlineReview"}, {"oid": "605c1e04d4f47de6a78dbf4c2b0108c7765abf29", "url": "https://github.com/CMSgov/dpc-app/commit/605c1e04d4f47de6a78dbf4c2b0108c7765abf29", "message": "Merge branch 'master' into willh/aggregation-engine-health-check", "committedDate": "2020-03-13T14:36:21Z", "type": "commit"}, {"oid": "da0dc1c362421de200336795e97e576d4bb80be3", "url": "https://github.com/CMSgov/dpc-app/commit/da0dc1c362421de200336795e97e576d4bb80be3", "message": "add comment on why queueRunning initial value is true and cut down on executor wait time", "committedDate": "2020-03-13T15:38:06Z", "type": "commit"}, {"oid": "aec8ad5d5f7f589a0aeef8b5a4799cf8c15f1b7f", "url": "https://github.com/CMSgov/dpc-app/commit/aec8ad5d5f7f589a0aeef8b5a4799cf8c15f1b7f", "message": "Merge remote-tracking branch 'origin/willh/aggregation-engine-health-check' into willh/aggregation-engine-health-check", "committedDate": "2020-03-13T15:38:27Z", "type": "commit"}, {"oid": "1389d86ca00b72354219f59c2c8706e4dc8af43a", "url": "https://github.com/CMSgov/dpc-app/commit/1389d86ca00b72354219f59c2c8706e4dc8af43a", "message": "Merge branch 'master' into willh/aggregation-engine-health-check", "committedDate": "2020-03-13T15:39:40Z", "type": "commit"}]}