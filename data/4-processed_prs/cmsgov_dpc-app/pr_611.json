{"pr_number": 611, "pr_title": "DPC 1011: Unique auto number generator for vendor id", "pr_createdAt": "2020-02-14T20:36:58Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/611", "timeline": [{"oid": "ed12e7fa2b5ddf3c0957186ed7636b451950c458", "url": "https://github.com/CMSgov/dpc-app/commit/ed12e7fa2b5ddf3c0957186ed7636b451950c458", "message": "generate vendor id on org creation and org update (if vendor id is blank)", "committedDate": "2020-02-14T20:25:25Z", "type": "commit"}, {"oid": "86e3497bf435fad4374cf4615e4ac37d48fa5b96", "url": "https://github.com/CMSgov/dpc-app/commit/86e3497bf435fad4374cf4615e4ac37d48fa5b96", "message": "organization serializer uses vendor id instead of npi if org type is 'health_it_vendor' in sandbox api", "committedDate": "2020-02-14T20:26:54Z", "type": "commit"}, {"oid": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "url": "https://github.com/CMSgov/dpc-app/commit/5f5ddef3d8052391dd4b87e97595325c7be8151f", "message": "on org update in api, if org type is 'health_it_vendor' will use vendor id instead of npi", "committedDate": "2020-02-14T20:28:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MDI0Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381340246", "bodyText": "This is actually already a method that's available because of the organization_type enum. Rails enum gives you a few helper methods -- including a boolean response method for every option in the enum. We have #primary_care_clinic?, #speciality_clinic?, #health_it_vendor?, etc. Can we utilize that instead of writing a new method? (Or, if a new method is necessary, let's call it something else so that the enum method isn't overwritten.)", "author": "switzersc-usds", "createdAt": "2020-02-19T14:51:02Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+    current_org.save!\n+  end\n+\n+  def health_it_vendor?", "originalCommit": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0Mjc2Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381342762", "bodyText": "We should do something like the loop demonstrated in the top example here to ensure that the vendor_id generated doesn't already exist.", "author": "switzersc-usds", "createdAt": "2020-02-19T14:54:24Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"", "originalCommit": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ2MTk0Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381461942", "bodyText": "And we should also validate that this field is unique with a validation", "author": "switzersc-usds", "createdAt": "2020-02-19T18:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0Mjc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MzI2Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381343262", "bodyText": "If we use before_create and before_update callbacks instead, then the save! isn't necessary. Let's do that to minimize database writes. On that note -- can we use just before_save (which gets called during create and update) instead of two callbacks?", "author": "switzersc-usds", "createdAt": "2020-02-19T14:55:03Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +42,16 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    current_org = Organization.find(id)\n+    current_org.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+    current_org.save!", "originalCommit": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDEzMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381344131", "bodyText": "We can use the enum method provided by Rails here (if the custom method is removed/changed):\n            value: object.health_it_vendor? ? object.vendor_id : object.npi", "author": "switzersc-usds", "createdAt": "2020-02-19T14:56:11Z", "path": "dpc-web/app/serializers/organization_submit_serializer.rb", "diffHunk": "@@ -26,7 +26,7 @@ def organization_resource\n         identifier: [\n           {\n             system: 'http://hl7.org/fhir/sid/us-npi',\n-            value: object.npi\n+            value: object.organization_type == 'health_it_vendor' ? object.vendor_id : object.npi", "originalCommit": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0NDI2NA==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r381344264", "bodyText": "Ditto", "author": "switzersc-usds", "createdAt": "2020-02-19T14:56:22Z", "path": "dpc-web/app/services/fhir_resource_builder.rb", "diffHunk": "@@ -6,7 +6,12 @@ def fhir_org(reg_org)\n     fhir_org = FHIR::Organization.new(\n       id: reg_org.api_id,\n       name: org.name,\n-      identifier: [{ system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi }]\n+      identifier: [\n+        {\n+          system: 'http://hl7.org/fhir/sid/us-npi',\n+          value: org.organization_type == 'health_it_vendor' ? org.vendor_id : org.npi", "originalCommit": "5f5ddef3d8052391dd4b87e97595325c7be8151f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abd204ee6bf492595fd9a24e713ee662961d2c1a", "url": "https://github.com/CMSgov/dpc-app/commit/abd204ee6bf492595fd9a24e713ee662961d2c1a", "message": "use enum instead of new method to check org type", "committedDate": "2020-02-20T14:42:11Z", "type": "commit"}, {"oid": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "url": "https://github.com/CMSgov/dpc-app/commit/4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id", "committedDate": "2020-02-20T14:57:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3NDYyOA==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382074628", "bodyText": "Remove debugger entry point binding.pry.", "author": "codeclimate", "createdAt": "2020-02-20T15:30:43Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,13 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    if vendor_id.blank?\n+      self.vendor_id = \"V_#{SecureRandom.alphanumeric(10)}\"\n+      binding.pry", "originalCommit": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3NDYzMw==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382074633", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "author": "codeclimate", "createdAt": "2020-02-20T15:30:43Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,13 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    if vendor_id.blank?", "originalCommit": "4d55c0036e033ecfc66c0478c3b11c2b3d41ded4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6dc6c0c3d191cef9c87e5ad47b40cc341b1d438", "url": "https://github.com/CMSgov/dpc-app/commit/c6dc6c0c3d191cef9c87e5ad47b40cc341b1d438", "message": "upadted for more efficient code from notes", "committedDate": "2020-02-20T21:08:39Z", "type": "commit"}, {"oid": "8fa39fe0c9e653e77fa5e71108472f317c34cc32", "url": "https://github.com/CMSgov/dpc-app/commit/8fa39fe0c9e653e77fa5e71108472f317c34cc32", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id", "committedDate": "2020-02-20T21:09:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI3OTE0MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/611#discussion_r382279141", "bodyText": "Add empty line after guard clause.", "author": "codeclimate", "createdAt": "2020-02-20T21:54:24Z", "path": "dpc-web/app/models/organization.rb", "diffHunk": "@@ -39,6 +41,18 @@ def api_credentialable?\n     registered_organizations.count.positive? && npi.present?\n   end\n \n+  def assign_vendor_id\n+    return true if vendor_id.present?", "originalCommit": "8fa39fe0c9e653e77fa5e71108472f317c34cc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4849198edd83650e55179045b02791ecd3d19b0", "url": "https://github.com/CMSgov/dpc-app/commit/c4849198edd83650e55179045b02791ecd3d19b0", "message": "Merge branch 'master' of github.com:CMSgov/dpc-app into nzonnenberg/DPC-1011-generate-vendor-id", "committedDate": "2020-02-21T16:46:54Z", "type": "commit"}, {"oid": "fb40e0736fed3e47dafffc64b97906d022a55906", "url": "https://github.com/CMSgov/dpc-app/commit/fb40e0736fed3e47dafffc64b97906d022a55906", "message": "testing vendor_id generator", "committedDate": "2020-02-21T20:33:57Z", "type": "commit"}, {"oid": "130942d3ceed0889edff73b5b6e6a560d2f27c13", "url": "https://github.com/CMSgov/dpc-app/commit/130942d3ceed0889edff73b5b6e6a560d2f27c13", "message": "more efficient code for serializers", "committedDate": "2020-02-21T20:43:48Z", "type": "commit"}, {"oid": "989087f9ba03a3d37aa7d22ec4d2feb73f0948b6", "url": "https://github.com/CMSgov/dpc-app/commit/989087f9ba03a3d37aa7d22ec4d2feb73f0948b6", "message": "Update organization.rb", "committedDate": "2020-02-21T20:44:44Z", "type": "commit"}, {"oid": "2c44070995bbff86fb7813f687e2055858b1d824", "url": "https://github.com/CMSgov/dpc-app/commit/2c44070995bbff86fb7813f687e2055858b1d824", "message": "Update organization.rb", "committedDate": "2020-02-21T21:01:11Z", "type": "commit"}, {"oid": "466d4c6d4487b2cd8bb00a77f24cf8585808a058", "url": "https://github.com/CMSgov/dpc-app/commit/466d4c6d4487b2cd8bb00a77f24cf8585808a058", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id", "committedDate": "2020-02-21T21:01:20Z", "type": "commit"}, {"oid": "0769a8a3236cf577e1ef86ae4f7372650c86150d", "url": "https://github.com/CMSgov/dpc-app/commit/0769a8a3236cf577e1ef86ae4f7372650c86150d", "message": "Update organization.rb", "committedDate": "2020-02-21T21:18:53Z", "type": "commit"}, {"oid": "3d4ff2d014e2ac2cb66518f780a0a04beb3f1c84", "url": "https://github.com/CMSgov/dpc-app/commit/3d4ff2d014e2ac2cb66518f780a0a04beb3f1c84", "message": "Merge branch 'master' into nzonnenberg/DPC-1011-generate-vendor-id", "committedDate": "2020-02-21T21:38:29Z", "type": "commit"}]}