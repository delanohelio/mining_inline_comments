{"pr_number": 814, "pr_title": "DPC-335: Verify public key with snippet signature", "pr_createdAt": "2020-05-22T20:52:17Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/814", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MjQ1MA==", "url": "https://github.com/CMSgov/dpc-app/pull/814#discussion_r429452450", "bodyText": "Method uploadKey has 5 arguments (exceeds 4 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-05-22T21:10:19Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/cli/keys/KeyUpload.java", "diffHunk": "@@ -59,25 +70,31 @@ public void run(Bootstrap<?> bootstrap, Namespace namespace) throws Exception {\n         System.out.println(String.format(\"Connecting to API service at: %s\", apiService));\n \n         // Read the file and parse it\n-        final Path filePath = FileSystems.getDefault().getPath(namespace.getString(KEY_FILE));\n-        final String pemFile = Files.readString(filePath);\n+        final Path keyFilePath = FileSystems.getDefault().getPath(namespace.getString(KEY_FILE));\n+        final String publicKey = Files.readString(keyFilePath);\n+\n+        final Path signaturePath = FileSystems.getDefault().getPath(namespace.getString(SIGNATURE_FILE));\n+        final String signature = Files.readString(signaturePath);\n \n         final Optional<String> label = Optional.ofNullable(namespace.getString(\"key-label\"));\n-        uploadKey(apiService, orgID.getIdPart(), label, pemFile);\n+        uploadKey(apiService, orgID.getIdPart(), label, publicKey, signature);\n     }\n \n     @SuppressWarnings(\"OptionalUsedAsFieldOrParameterType\")\n-    private void uploadKey(String apiService, String orgID, Optional<String> label, String pem) throws IOException, URISyntaxException {\n+    private void uploadKey(String apiService, String orgID, Optional<String> label, String pem, String signature) throws IOException, URISyntaxException {", "originalCommit": "e4cd0c7e7b343b7bab1a4663f30feae9401d4d15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTg3OA==", "url": "https://github.com/CMSgov/dpc-app/pull/814#discussion_r430469878", "bodyText": "Are we certain at this point in the code that we're not dealing with an ECC signature?", "author": "dhgreene", "createdAt": "2020-05-26T14:47:01Z", "path": "dpc-api/src/main/java/gov/cms/dpc/api/auth/jwt/PublicKeyHandler.java", "diffHunk": "@@ -91,6 +90,30 @@ public static void validatePublicKey(SubjectPublicKeyInfo value) {\n \n     }\n \n+    public static boolean verifySignature(String publicKeyPem, String snippet, String sigStr) {\n+        String keyStr = publicKeyPem\n+                .replace(\"-----BEGIN PUBLIC KEY-----\", \"\")\n+                .replace(\"-----END PUBLIC KEY-----\", \"\")\n+                .replaceAll(\"[\\n\\r]+\", \"\");\n+        sigStr = sigStr.replaceAll(\"[\\n\\r]+\", \"\");\n+\n+        try {\n+            byte[] keyBytes = Base64.getDecoder().decode(keyStr);\n+            X509EncodedKeySpec keySpec = new X509EncodedKeySpec(keyBytes);\n+            KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+            PublicKey publicKey = keyFactory.generatePublic(keySpec);\n+\n+            Signature signature = Signature.getInstance(\"SHA256withRSA\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYwMzE3Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/814#discussion_r430603172", "bodyText": "Good catch! Added a check here. https://github.com/CMSgov/dpc-app/pull/814/files#diff-064337c58bb98d2ffe6a3d1a993e68deR151-R153", "author": "em1", "createdAt": "2020-05-26T17:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTg3OA=="}], "type": "inlineReview"}, {"oid": "3ee0ca4312f0cbaaa8000815849af64805ad6f92", "url": "https://github.com/CMSgov/dpc-app/commit/3ee0ca4312f0cbaaa8000815849af64805ad6f92", "message": "Reject ECC keys (temporarily); testing cleanup", "committedDate": "2020-05-26T17:44:38Z", "type": "forcePushed"}, {"oid": "892f4a88e97d399ac3f713ee07de91c345cfe9ab", "url": "https://github.com/CMSgov/dpc-app/commit/892f4a88e97d399ac3f713ee07de91c345cfe9ab", "message": "Public key/signature verification in progress", "committedDate": "2020-05-28T12:46:03Z", "type": "commit"}, {"oid": "26da4a0e20dd3c03607e4acbcce127e8593f6f18", "url": "https://github.com/CMSgov/dpc-app/commit/26da4a0e20dd3c03607e4acbcce127e8593f6f18", "message": "Accept key and signature as JSON", "committedDate": "2020-05-28T12:46:06Z", "type": "commit"}, {"oid": "9d5a033bcdef7e18a7ea8f5c6fed0eb73bb323b2", "url": "https://github.com/CMSgov/dpc-app/commit/9d5a033bcdef7e18a7ea8f5c6fed0eb73bb323b2", "message": "Accept signature with CLI key creation; skip ECC tests temporarily", "committedDate": "2020-05-28T12:46:06Z", "type": "commit"}, {"oid": "f3b9016b04448554c3edb2786b547193f05bd2ac", "url": "https://github.com/CMSgov/dpc-app/commit/f3b9016b04448554c3edb2786b547193f05bd2ac", "message": "CLI test fixes", "committedDate": "2020-05-28T12:46:06Z", "type": "commit"}, {"oid": "d7ac73fc59ddc9dca74a86c1c20885b0365a9ac8", "url": "https://github.com/CMSgov/dpc-app/commit/d7ac73fc59ddc9dca74a86c1c20885b0365a9ac8", "message": "Address Code Climate exception message issue", "committedDate": "2020-05-28T12:46:07Z", "type": "commit"}, {"oid": "fe2f4699a26feed6bad99bd213421d9a76614f5f", "url": "https://github.com/CMSgov/dpc-app/commit/fe2f4699a26feed6bad99bd213421d9a76614f5f", "message": "Reject ECC keys (temporarily); testing cleanup", "committedDate": "2020-05-28T12:46:07Z", "type": "commit"}, {"oid": "fe2f4699a26feed6bad99bd213421d9a76614f5f", "url": "https://github.com/CMSgov/dpc-app/commit/fe2f4699a26feed6bad99bd213421d9a76614f5f", "message": "Reject ECC keys (temporarily); testing cleanup", "committedDate": "2020-05-28T12:46:07Z", "type": "forcePushed"}, {"oid": "38de5015e141068b31f1bf5987eb5af14da7ff15", "url": "https://github.com/CMSgov/dpc-app/commit/38de5015e141068b31f1bf5987eb5af14da7ff15", "message": "Adjustment for Code Climate", "committedDate": "2020-05-28T15:16:06Z", "type": "commit"}, {"oid": "930541c5d941bb8a34b0cbc537925db3a5f8b031", "url": "https://github.com/CMSgov/dpc-app/commit/930541c5d941bb8a34b0cbc537925db3a5f8b031", "message": "Change verifySignature() to throw an exception rather than returning false, to be consistent with other methods", "committedDate": "2020-05-28T21:32:43Z", "type": "commit"}, {"oid": "d1c8d13fef27a3686e4c95264be97557ca9e6de0", "url": "https://github.com/CMSgov/dpc-app/commit/d1c8d13fef27a3686e4c95264be97557ca9e6de0", "message": "Merge branch 'master' into emily/dpc-335-verify-signature", "committedDate": "2020-06-04T13:06:28Z", "type": "commit"}]}