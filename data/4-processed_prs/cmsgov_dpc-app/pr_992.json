{"pr_number": 992, "pr_title": "Silvio/dpc 156 rate limit emails", "pr_createdAt": "2020-08-19T23:23:23Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/992", "timeline": [{"oid": "bfd5157230a742b15b848e392a33c0f3aabc8877", "url": "https://github.com/CMSgov/dpc-app/commit/bfd5157230a742b15b848e392a33c0f3aabc8877", "message": "Add redis-namespace gem", "committedDate": "2020-08-18T22:53:32Z", "type": "commit"}, {"oid": "8feae86b0aafd0d2e4602033f64fa3a73c177443", "url": "https://github.com/CMSgov/dpc-app/commit/8feae86b0aafd0d2e4602033f64fa3a73c177443", "message": "create redis store mail throttle class", "committedDate": "2020-08-18T22:54:52Z", "type": "commit"}, {"oid": "9ab754503b7003c0bf93d85785b830d7786ebeab", "url": "https://github.com/CMSgov/dpc-app/commit/9ab754503b7003c0bf93d85785b830d7786ebeab", "message": "Add fake redis for test runs", "committedDate": "2020-08-19T21:56:00Z", "type": "commit"}, {"oid": "78cfc807245f51d952a1b33b3343a7511e0c48c5", "url": "https://github.com/CMSgov/dpc-app/commit/78cfc807245f51d952a1b33b3343a7511e0c48c5", "message": "Add mail throttle store tests", "committedDate": "2020-08-19T21:57:05Z", "type": "commit"}, {"oid": "8edf08525b610cbc8bbab252ff4e45258cc17c5f", "url": "https://github.com/CMSgov/dpc-app/commit/8edf08525b610cbc8bbab252ff4e45258cc17c5f", "message": "Add application configs for mail throttler", "committedDate": "2020-08-19T21:57:24Z", "type": "commit"}, {"oid": "c091bb436aa31847b5b3822e5ff9ff30fa3bef7b", "url": "https://github.com/CMSgov/dpc-app/commit/c091bb436aa31847b5b3822e5ff9ff30fa3bef7b", "message": "Add mail throttling to the organization email for sandbox", "committedDate": "2020-08-19T22:16:43Z", "type": "commit"}, {"oid": "9e5c8033d64c013e31792983aed5e633dc62bc2f", "url": "https://github.com/CMSgov/dpc-app/commit/9e5c8033d64c013e31792983aed5e633dc62bc2f", "message": "Add tests for org mail throttling email", "committedDate": "2020-08-19T22:17:06Z", "type": "commit"}, {"oid": "27dcc05df9ffa060ec02106d1188fd461588c131", "url": "https://github.com/CMSgov/dpc-app/commit/27dcc05df9ffa060ec02106d1188fd461588c131", "message": "add mail throttling to password reset requests by users", "committedDate": "2020-08-19T22:27:15Z", "type": "commit"}, {"oid": "e2cead259c72ccf13afbea16474fabc02e6a7707", "url": "https://github.com/CMSgov/dpc-app/commit/e2cead259c72ccf13afbea16474fabc02e6a7707", "message": "Add reset user password rate limit test", "committedDate": "2020-08-19T22:27:55Z", "type": "commit"}, {"oid": "423e1ba9992869f33e336c9596b755b5a5bd0929", "url": "https://github.com/CMSgov/dpc-app/commit/423e1ba9992869f33e336c9596b755b5a5bd0929", "message": "Add email throttling for confirmation emails", "committedDate": "2020-08-19T23:14:35Z", "type": "commit"}, {"oid": "4d063b9757028a4520de4840bc0c71f978f26598", "url": "https://github.com/CMSgov/dpc-app/commit/4d063b9757028a4520de4840bc0c71f978f26598", "message": "Add after clause to spec tests to reset rails config", "committedDate": "2020-08-19T23:39:01Z", "type": "commit"}, {"oid": "0f005669b285571678cd8c4ebd23f39647a58c6d", "url": "https://github.com/CMSgov/dpc-app/commit/0f005669b285571678cd8c4ebd23f39647a58c6d", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails", "committedDate": "2020-08-19T23:39:35Z", "type": "commit"}, {"oid": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "url": "https://github.com/CMSgov/dpc-app/commit/a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "message": "codeclimate fixes", "committedDate": "2020-08-19T23:43:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1OTc5Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r473459796", "bodyText": "Use a guard clause instead of wrapping the code inside a conditional expression.", "author": "codeclimate", "createdAt": "2020-08-20T00:09:21Z", "path": "dpc-web/app/models/organization_user_assignment.rb", "diffHunk": "@@ -12,9 +14,13 @@ class OrganizationUserAssignment < ApplicationRecord\n   def send_organization_sandbox_email\n     return unless organization.prod_sbx? && organization.registered_organization.present?\n \n-    UserMailer\n-      .with(user: user, vendor: organization.health_it_vendor?)\n-      .organization_sandbox_email\n-      .deliver_later\n+    mail_throttle_store = RedisStore::MailThrottleStore.new\n+\n+    if mail_throttle_store.can_email? user.email", "originalCommit": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUxODUxOA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r473518518", "bodyText": "Ironically, this yells at me if I use a guard clause because the code, even though its a single line execution, is spaced out on multiple lines.", "author": "SMLuthi", "createdAt": "2020-08-20T01:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1OTc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyMjM5MA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474022390", "bodyText": "Is this worth allowing an env var to override, in case we want to dial this back during an event?\nAlso, is 10 too high for a default?  Allowing for 1 email confirmation, 1 password reset, 1 email for future purposes, multiplied by a 2x \"oops\" factor still only gives 6 emails--and that sequence might take more than 5 minutes.", "author": "dhgreene", "createdAt": "2020-08-20T14:23:31Z", "path": "dpc-web/config/application.rb", "diffHunk": "@@ -53,5 +53,9 @@ class Application < Rails::Application\n     config.action_mailer.delivery_job = \"ActionMailer::MailDeliveryJob\"\n \n     config.to_prepare { Devise::Mailer.layout \"mailer\" }\n+\n+    # Mail throttling\n+    config.x.mail_throttle.limit = 10 # Limit to 10 emails before hard stop", "originalCommit": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA4MjM3NA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474082374", "bodyText": "I've thought about this as well. The issue is that once the rails web app is running it will have loaded the config already. Meaning that even if we change the env var it wont be reflected in the running app... we'd have to either run another deploy (or perhaps just killing the current containers may do it). But it may just be worth moving this to an env var (with a default) to make it easier to manage.\nAs for the 10 limit email, that was suggested by the ticket but I agree it may be high. Maybe we should lower this to 5?\n@dhgreene", "author": "SMLuthi", "createdAt": "2020-08-20T15:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyMjM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyNTM4NA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474025384", "bodyText": "Can you mention the new dependencies in the PR description, with some thoughts about selection criteria?", "author": "dhgreene", "createdAt": "2020-08-20T14:27:26Z", "path": "dpc-web/Gemfile", "diffHunk": "@@ -35,6 +35,7 @@ gem 'kaminari'\n gem 'active_model_serializers'\n gem 'macaroons'\n gem 'lograge'\n+gem 'redis-namespace'", "originalCommit": "a817ae8e16e8ce0fc76d6ef03c97b9f6ba0f5cf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96b8e36e8e299a62cfc4677153db7ee28b3300a7", "url": "https://github.com/CMSgov/dpc-app/commit/96b8e36e8e299a62cfc4677153db7ee28b3300a7", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails", "committedDate": "2020-08-20T15:22:38Z", "type": "commit"}, {"oid": "0b705aea9d11f9369820074e216b155cf2eca25f", "url": "https://github.com/CMSgov/dpc-app/commit/0b705aea9d11f9369820074e216b155cf2eca25f", "message": "Add tests for password confirmation page", "committedDate": "2020-08-20T19:01:40Z", "type": "commit"}, {"oid": "7f18219f650c2f667eadc6a767d3e44cf212737f", "url": "https://github.com/CMSgov/dpc-app/commit/7f18219f650c2f667eadc6a767d3e44cf212737f", "message": "Merge branch 'silvio/dpc-156-rate-limit-emails' of github.com:CMSgov/dpc-app into silvio/dpc-156-rate-limit-emails", "committedDate": "2020-08-20T19:02:00Z", "type": "commit"}, {"oid": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "url": "https://github.com/CMSgov/dpc-app/commit/dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "message": "change mail throttle limit to be fetched through an ENV var (or default)", "committedDate": "2020-08-20T19:05:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTM2NA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209364", "bodyText": "Should this be setting it back to its original value, rather than 10?", "author": "dhgreene", "createdAt": "2020-08-20T19:09:08Z", "path": "dpc-web/spec/features/confirmation/user_confirmation_email_spec.rb", "diffHunk": "@@ -0,0 +1,78 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+RSpec.feature 'user resends confirmation instructions' do\n+  let(:user) { create :user, confirmed_at: nil }\n+\n+  context 'when successful' do\n+    scenario 'user resends confirmation instructions' do\n+      visit new_user_confirmation_path\n+\n+      fill_in 'user_email', with: user.email\n+\n+      expect do\n+        find('input[data-test=\"submit\"]').click\n+        Sidekiq::Worker.drain_all\n+      end.to change(ActionMailer::Base.deliveries, :count).by(2)\n+\n+      last_delivery = ActionMailer::Base.deliveries.last\n+      email = last_delivery.body\n+\n+      expect(email).to include('Confirm my account')\n+\n+      confirmation_link = last_delivery.body.raw_source.match(%r{href=\"http:\\/\\/localhost:3000(?<path>.+?)\">})[:path]\n+\n+      visit confirmation_link\n+\n+      expect(page.body).to include(\"Welcome, #{user.first_name}!\")\n+    end\n+  end\n+\n+  context 'when incorrect email' do\n+    scenario 'user does not send confirmation instructions' do\n+      visit new_user_confirmation_path\n+\n+      fill_in 'user_email', with: 'not_a_real@email.com'\n+\n+      expect do\n+        find('input[data-test=\"submit\"]').click\n+        Sidekiq::Worker.drain_all\n+      end.to change(ActionMailer::Base.deliveries, :count).by(0)\n+\n+      expect(page.body).to include('Resend confirmation instructions')\n+    end\n+  end\n+\n+  context 'with too many emails' do\n+    before do\n+      Rails.configuration.x.mail_throttle.limit = 1\n+    end\n+\n+    after do\n+      Rails.configuration.x.mail_throttle.limit = 10", "originalCommit": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTU0NA==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209544", "bodyText": ". . . same as above", "author": "dhgreene", "createdAt": "2020-08-20T19:09:29Z", "path": "dpc-web/spec/lib/redis_store/mail_throttle_store_spec.rb", "diffHunk": "@@ -0,0 +1,54 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+require './lib/redis_store/mail_throttle_store'\n+\n+describe RedisStore::MailThrottleStore do\n+  let(:mail_throttler) { described_class.new }\n+  let(:limit) { 2 }\n+  let(:expiration) { 5 }\n+\n+  before do\n+    Rails.configuration.x.mail_throttle.limit = limit\n+    Rails.configuration.x.mail_throttle.expiration = expiration\n+  end\n+\n+  after do\n+    Rails.configuration.x.mail_throttle.limit = 10", "originalCommit": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwOTY0MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/992#discussion_r474209641", "bodyText": ". . . and again", "author": "dhgreene", "createdAt": "2020-08-20T19:09:41Z", "path": "dpc-web/spec/models/organization_user_assignment_spec.rb", "diffHunk": "@@ -36,6 +37,33 @@\n \n         expect(UserMailer).not_to have_received(:with)\n       end\n+\n+      context 'when mail rate limit has been reached' do\n+        before do\n+          Rails.configuration.x.mail_throttle.limit = 0\n+        end\n+\n+        after do\n+          Rails.configuration.x.mail_throttle.limit = 10", "originalCommit": "dbadf20d7004343cebeb65e3ff46bcd518caf2ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1bd4f3b2d79a0d20e52d64fecf988b0b80798085", "url": "https://github.com/CMSgov/dpc-app/commit/1bd4f3b2d79a0d20e52d64fecf988b0b80798085", "message": "Chamnge before/after blocks to be around blocks and reset default config values instead of arbitrary ints", "committedDate": "2020-08-20T21:47:11Z", "type": "commit"}, {"oid": "d90ffa95404fcc37c91ccb0146705d29f7934ec9", "url": "https://github.com/CMSgov/dpc-app/commit/d90ffa95404fcc37c91ccb0146705d29f7934ec9", "message": "Merge branch 'master' into silvio/dpc-156-rate-limit-emails", "committedDate": "2020-08-21T15:29:02Z", "type": "commit"}]}