{"pr_number": 1127, "pr_title": "DPC-829: Update CSV file download on website to reflect filtering and tags", "pr_createdAt": "2020-11-30T20:51:16Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1127", "timeline": [{"oid": "cfcc88c5e357b088c61d07641cccf7139a8f9276", "url": "https://github.com/CMSgov/dpc-app/commit/cfcc88c5e357b088c61d07641cccf7139a8f9276", "message": "CSV filter enabled", "committedDate": "2020-11-30T17:35:27Z", "type": "commit"}, {"oid": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "url": "https://github.com/CMSgov/dpc-app/commit/4339f971e8d2f3f1c55376facac177c08fcdbcde", "message": "Move CsvGenerator into concern for future refactoring", "committedDate": "2020-11-30T19:47:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcxMg==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895712", "bodyText": "Align the elements of an array literal if they span more than one line.", "author": "codeclimate", "createdAt": "2020-11-30T20:52:12Z", "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze", "originalCommit": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcxOA==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895718", "bodyText": "Extra empty line detected at module body beginning.", "author": "codeclimate", "createdAt": "2020-11-30T20:52:13Z", "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+", "originalCommit": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcyMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895721", "bodyText": "Extra empty line detected at module body end.", "author": "codeclimate", "createdAt": "2020-11-30T20:52:13Z", "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+\n+  # html escape these fields for XSS protection\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+\n+  def cvs_convert(users)\n+    CSV.generate(headers:true) do |csv|\n+      csv << ATTRS\n+      users.each do |user|\n+        attributes = user.attributes\n+        escaped_attributes = attributes.map do |k, v|\n+          if ESCAPED_ATTRS.include? k\n+            v = ERB::Util.html_escape(v)\n+          end\n+\n+          [k, v]\n+        end.to_h\n+        csv << escaped_attributes.values_at(*ATTRS)\n+      end\n+    end\n+  end\n+", "originalCommit": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NTcyMw==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r532895723", "bodyText": "Space missing after colon.", "author": "codeclimate", "createdAt": "2020-11-30T20:52:13Z", "path": "dpc-web/app/controllers/concerns/csv_generator.rb", "diffHunk": "@@ -0,0 +1,28 @@\n+# frozen_string_literal: true\n+\n+module CsvGenerator\n+\n+  ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n+    address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+\n+  # html escape these fields for XSS protection\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+\n+  def cvs_convert(users)\n+    CSV.generate(headers:true) do |csv|", "originalCommit": "4339f971e8d2f3f1c55376facac177c08fcdbcde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df7f69045d10ad27919979c3c89c02684869af3e", "url": "https://github.com/CMSgov/dpc-app/commit/df7f69045d10ad27919979c3c89c02684869af3e", "message": "Working on tests", "committedDate": "2020-12-01T19:08:45Z", "type": "commit"}, {"oid": "9698d4523b41d1923e6d946de16cfe449ff9d32b", "url": "https://github.com/CMSgov/dpc-app/commit/9698d4523b41d1923e6d946de16cfe449ff9d32b", "message": "Tests passing", "committedDate": "2020-12-01T20:55:22Z", "type": "commit"}, {"oid": "9c04801f7d400fe2277c246e4e7f1a387265e1ba", "url": "https://github.com/CMSgov/dpc-app/commit/9c04801f7d400fe2277c246e4e7f1a387265e1ba", "message": "Climate code fixes", "committedDate": "2020-12-01T21:15:51Z", "type": "commit"}, {"oid": "1a399025cbc63c8f6f4388144fe23d95b37c35a8", "url": "https://github.com/CMSgov/dpc-app/commit/1a399025cbc63c8f6f4388144fe23d95b37c35a8", "message": "Code climate fix", "committedDate": "2020-12-01T21:26:56Z", "type": "commit"}, {"oid": "9969b294d76da6d8f15fee5b27ba406172d73c17", "url": "https://github.com/CMSgov/dpc-app/commit/9969b294d76da6d8f15fee5b27ba406172d73c17", "message": "Test fix", "committedDate": "2020-12-02T15:38:16Z", "type": "commit"}, {"oid": "b7b837584f5e48a2e81548abff7e24908a72d441", "url": "https://github.com/CMSgov/dpc-app/commit/b7b837584f5e48a2e81548abff7e24908a72d441", "message": "Add tags to csv file", "committedDate": "2020-12-02T19:14:17Z", "type": "commit"}, {"oid": "79f2ae3df482b7a5134e7189de6dcd94dd86a226", "url": "https://github.com/CMSgov/dpc-app/commit/79f2ae3df482b7a5134e7189de6dcd94dd86a226", "message": "Code climate fixes", "committedDate": "2020-12-02T19:22:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMxOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434319", "bodyText": "Method has too many lines. [20/15]", "author": "codeclimate", "createdAt": "2020-12-02T19:42:29Z", "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)", "originalCommit": "79f2ae3df482b7a5134e7189de6dcd94dd86a226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMyMg==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434322", "bodyText": "Use delete! instead of gsub!.", "author": "codeclimate", "createdAt": "2020-12-02T19:42:29Z", "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)\n+    users = User.find(user_ids)\n     CSV.generate(headers: true) do |csv|\n       csv << ATTRS\n-      all.each do |user|\n+      users.each do |user|\n         attributes = user.attributes\n+        attributes['tags'] = user.tags.map(&:name)\n         escaped_attributes = attributes.map do |k, v|\n           if ESCAPED_ATTRS.include? k\n             v = ERB::Util.html_escape(v)\n+\n+            if k == 'tags'\n+              v.gsub!('&quot;', '')\n+              v.gsub!('[', '')", "originalCommit": "79f2ae3df482b7a5134e7189de6dcd94dd86a226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzNDMyNA==", "url": "https://github.com/CMSgov/dpc-app/pull/1127#discussion_r534434324", "bodyText": "Use delete! instead of gsub!.", "author": "codeclimate", "createdAt": "2020-12-02T19:42:29Z", "path": "dpc-web/app/models/user.rb", "diffHunk": "@@ -83,19 +83,28 @@ class User < ApplicationRecord\n   end\n \n   ATTRS = %w[id first_name last_name email requested_organization requested_organization_type\n-             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at updated_at].freeze\n+             address_1 address_2 city state zip agree_to_terms requested_num_providers created_at\n+             updated_at tags].freeze\n \n   # html escape these fields for XSS protection\n-  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city].freeze\n+  ESCAPED_ATTRS = %w[first_name last_name requested_organization address_1 address_2 city tags].freeze\n \n-  def self.to_csv\n+  def self.to_csv(user_ids)\n+    users = User.find(user_ids)\n     CSV.generate(headers: true) do |csv|\n       csv << ATTRS\n-      all.each do |user|\n+      users.each do |user|\n         attributes = user.attributes\n+        attributes['tags'] = user.tags.map(&:name)\n         escaped_attributes = attributes.map do |k, v|\n           if ESCAPED_ATTRS.include? k\n             v = ERB::Util.html_escape(v)\n+\n+            if k == 'tags'\n+              v.gsub!('&quot;', '')\n+              v.gsub!('[', '')\n+              v.gsub!(']', '')", "originalCommit": "79f2ae3df482b7a5134e7189de6dcd94dd86a226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3cafadc58f6a360b5cb3b28c2a17b927973c6bfc", "url": "https://github.com/CMSgov/dpc-app/commit/3cafadc58f6a360b5cb3b28c2a17b927973c6bfc", "message": "Code climate and spec fixes", "committedDate": "2020-12-02T20:30:10Z", "type": "commit"}, {"oid": "806188d790beaaaae02d9b816ec85968728d1375", "url": "https://github.com/CMSgov/dpc-app/commit/806188d790beaaaae02d9b816ec85968728d1375", "message": "Remove whitespace to appease code climate", "committedDate": "2020-12-02T20:35:00Z", "type": "commit"}, {"oid": "11e663961fe6ac5483dc2d14c4cf791bf63280f0", "url": "https://github.com/CMSgov/dpc-app/commit/11e663961fe6ac5483dc2d14c4cf791bf63280f0", "message": "Merge branch 'master' into nz/dpc-829-csv-filter", "committedDate": "2020-12-02T21:09:11Z", "type": "commit"}, {"oid": "d1bfb2a00a93ca92bce6b64a7ac22db68d6c1b33", "url": "https://github.com/CMSgov/dpc-app/commit/d1bfb2a00a93ca92bce6b64a7ac22db68d6c1b33", "message": "Remove 'all users' from CSV button", "committedDate": "2020-12-02T21:12:46Z", "type": "commit"}, {"oid": "3e924d7110528a3eba20f63afa50f89571760f63", "url": "https://github.com/CMSgov/dpc-app/commit/3e924d7110528a3eba20f63afa50f89571760f63", "message": "Merge branch 'nz/dpc-829-csv-filter' of github.com:CMSgov/dpc-app into nz/dpc-829-csv-filter", "committedDate": "2020-12-02T21:12:52Z", "type": "commit"}, {"oid": "9115ff3973c42b6ce3232f9872ecb327909152ef", "url": "https://github.com/CMSgov/dpc-app/commit/9115ff3973c42b6ce3232f9872ecb327909152ef", "message": "Merge branch 'master' into nz/dpc-829-csv-filter", "committedDate": "2020-12-03T19:11:28Z", "type": "commit"}]}