{"pr_number": 555, "pr_title": "DPC-942: Update organization in API from web app", "pr_createdAt": "2020-01-22T13:35:22Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/555", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569405", "bodyText": "Method OrganizationRegistrar#existing_registered_orgs is defined at both dpc-web/app/services/organization_registrar.rb:4 and dpc-web/app/services/organization_registrar.rb:39.", "author": "codeclimate", "createdAt": "2020-01-22T13:51:18Z", "path": "dpc-web/app/services/organization_registrar.rb", "diffHunk": "@@ -26,18 +25,28 @@ def register_organization(api_env)\n     api_client = APIClient.new(api_env).create_organization(organization)\n     api_org = api_client.response_body\n \n-    create_registered_org(api_env, api_org) if api_client.response_successful?\n+    create_registered_organization(api_env, api_org) if api_client.response_successful?\n+  end\n+\n+  def update_existing_registered_orgs\n+    existing_registered_orgs.each do |registered_org|\n+      APIClient.new(registered_org.api_env).update_organization(registered_org)\n+    end\n   end\n \n   private\n \n-  def no_change?\n+  def existing_registered_orgs", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NTMyNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369795325", "bodyText": "Took care of this", "author": "switzersc-usds", "createdAt": "2020-01-22T20:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNg==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569406", "bodyText": "Space inside { missing.", "author": "codeclimate", "createdAt": "2020-01-22T13:51:18Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwNw==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569407", "bodyText": "Space inside } missing.", "author": "codeclimate", "createdAt": "2020-01-22T13:51:18Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQwOQ==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569409", "bodyText": "Line is too long. [147/120]", "author": "codeclimate", "createdAt": "2020-01-22T13:51:18Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2OTQxMg==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369569412", "bodyText": "Annotation keywords like TODO should be all upper case, followed by a colon, and a space, then a note describing the problem.", "author": "codeclimate", "createdAt": "2020-01-22T13:51:19Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,42 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n+  def update_organization(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(id: reg_org.api_id, name: org.name, identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}])\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.update(fhir_org, reg_org.api_id)\n+    if response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+    # TODO update fhir endpoint from reg_org.api_endpoint_ref", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzMg==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686532", "bodyText": "Extra empty line detected before the rescue.", "author": "codeclimate", "createdAt": "2020-01-22T17:04:19Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -118,6 +192,7 @@ def http_request(request, uri)\n     response = http.request(request)\n     @response_status = response.code.to_i\n     @response_body = parsed_response(response)\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzNw==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686537", "bodyText": "Space inside { missing.", "author": "codeclimate", "createdAt": "2020-01-22T17:04:19Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}]", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjUzOA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686538", "bodyText": "Space inside } missing.", "author": "codeclimate", "createdAt": "2020-01-22T17:04:20Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi}]", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjU0MA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686540", "bodyText": "Remove debugger entry point binding.pry.", "author": "codeclimate", "createdAt": "2020-01-22T17:04:20Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4NjU0Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369686542", "bodyText": "Method has too many lines. [18/15]", "author": "codeclimate", "createdAt": "2020-01-22T17:04:20Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,97 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    response = client.read(FHIR::Organization, reg_org.api_id)\n+    binding.pry\n+  end\n+\n+  def update_organization(reg_org)\n+    # build the FHIR::Organization with latest attributes\n+    # build the FHIR::Endpoint with latest attributes\n+    # instantiate the FHIR::Client\n+    # add auth heads to client\n+    # client makes org update request\n+    # client makes endpoint update request\n+    # return true or false\n+\n+    fhir_org = build_fhir_org(reg_org)\n+    fhir_endpoint = build_fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def build_fhir_org(reg_org)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NTExNw==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369795117", "bodyText": "We aren't using this method in the app code but it was super helpful when messing around in console and testing with the live API.", "author": "switzersc-usds", "createdAt": "2020-01-22T20:49:47Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NjA4OA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369796088", "bodyText": "Would've included the whole body but ran into an issue where I couldn't replicate the whitespace in the JSON request the FHIR Client makes, and webmock doesn't ignore whitespace. So instead I'm just making sure the body has something in it that is unique to this request.", "author": "switzersc-usds", "createdAt": "2020-01-22T20:51:53Z", "path": "dpc-web/spec/services/api_client_spec.rb", "diffHunk": "@@ -166,6 +186,71 @@\n     end\n   end\n \n+  describe '#update_organization' do\n+    context 'successful request' do\n+      it 'uses fhir_client to send org data to API' do\n+        org = create(:organization, api_environments: [0])\n+        create(:fhir_endpoint, organization: org)\n+        reg_org = create(:registered_organization, organization: org, api_env: 'sandbox', api_endpoint_ref: 'Endpoint/12345')\n+\n+        stub_request(:put, \"http://dpc.example.com/Organization/#{reg_org.api_id}\").\n+          with(\n+            body: /#{reg_org.api_id}/,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5Njc0NA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369796744", "bodyText": "This is a workaround for now. We are going to refactor this model structure soon so that we can fully support multiple FHIR endpoints for an org, rather than sort of supporting it in theory but in practicality only supporting a single one.", "author": "switzersc-usds", "createdAt": "2020-01-22T20:53:18Z", "path": "dpc-web/app/services/fhir_resource_builder.rb", "diffHunk": "@@ -0,0 +1,65 @@\n+# frozen_string_literal: true\n+\n+class FhirResourceBuilder\n+  def fhir_org(reg_org)\n+    org = reg_org.organization\n+    fhir_org = FHIR::Organization.new(\n+      id: reg_org.api_id,\n+      name: org.name,\n+      identifier: [{ system: 'http://hl7.org/fhir/sid/us-npi', value: org.npi }]\n+    )\n+    fhir_org.endpoint = { reference: reg_org.api_endpoint_ref }\n+\n+    fhir_org.address = fhir_address(org)\n+    fhir_org\n+  end\n+\n+  def fhir_address(org)\n+    FHIR::Address.new(\n+      line: org.address_street,\n+      city: org.address_city,\n+      postalCode: org.address_zip,\n+      state: org.address_state,\n+      country: 'US',\n+      use: org.address_use,\n+      type: org.address_type\n+    )\n+  end\n+\n+  def fhir_endpoint(reg_org)\n+    org = reg_org.organization\n+    org_endpoint = org.fhir_endpoints.first", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNDE0NA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369804144", "bodyText": "Do we have a ticket for this?", "author": "nickrobison-usds", "createdAt": "2020-01-22T21:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5Njc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNzg3OA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369807878", "bodyText": "DPC-954", "author": "switzersc-usds", "createdAt": "2020-01-22T21:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5Njc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5ODA3MA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369798070", "bodyText": "Will be implemented with DPC-957", "author": "switzersc-usds", "createdAt": "2020-01-22T20:56:02Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    client.read(FHIR::Organization, reg_org.api_id).resource\n+  end\n+\n+  def update_organization(reg_org)\n+    fhir_org = FhirResourceBuilder.new.fhir_org(reg_org)\n+    fhir_endpoint = FhirResourceBuilder.new.fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def delete_organization(org)\n+    # DELETE\n+    # client.destroy(FHIR::Organization, org.id)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzQ2OQ==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369803469", "bodyText": "Should we also check the endpoint_response code?", "author": "nickrobison-usds", "createdAt": "2020-01-22T21:07:16Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -1,23 +1,53 @@\n # frozen_string_literal: true\n \n class APIClient\n-  attr_reader :api_env, :response_body, :response_status\n+  attr_reader :api_env, :base_url, :response_body, :response_status\n \n   def initialize(api_env)\n     @api_env = api_env\n+    @base_url = base_urls[api_env]\n   end\n \n   def create_organization(org)\n-    uri_string = base_urls[api_env] + '/Organization/$submit'\n+    uri_string = base_url + '/Organization/$submit'\n     json = OrganizationSubmitSerializer.new(org).to_json\n     post_request(uri_string, json, fhir_headers(golden_macaroon))\n     self\n   end\n \n-  def delete_organization(org); end\n+  def get_organization(reg_org)\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+    client.read(FHIR::Organization, reg_org.api_id).resource\n+  end\n+\n+  def update_organization(reg_org)\n+    fhir_org = FhirResourceBuilder.new.fhir_org(reg_org)\n+    fhir_endpoint = FhirResourceBuilder.new.fhir_endpoint(reg_org)\n+\n+    client = FHIR::Client.new(base_url)\n+    client.additional_headers = auth_header(delegated_macaroon(reg_org.api_id))\n+\n+    org_response = client.update(fhir_org, reg_org.api_id)\n+    endpoint_response = client.update(fhir_endpoint, fhir_endpoint.id)\n+\n+    if org_response.response[:code] == '200' && endpoint_response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = org_response.response[:code]", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNzU2MA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369807560", "bodyText": "Hm, yeah. We do check for the code in line 34 and only respond with success if both the org and the endpoint codes are 200. However, we set the status to be the org's response code. It would be better not to make two requests here in the APIClient but instead have the OrganizationRegistrar call the API Client to make both requests -- that way we don't have to muddy the semantics and with two API requests in a single method that suggests it's making just one request.", "author": "switzersc-usds", "createdAt": "2020-01-22T21:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNzYxNA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369807614", "bodyText": "I'll refactor", "author": "switzersc-usds", "createdAt": "2020-01-22T21:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzg4Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369803886", "bodyText": "How difficult would it be to avoid bringing in the DSTU2 models? Not a huge deal, but might be a nice way to reduce the deployment size.", "author": "nickrobison-usds", "createdAt": "2020-01-22T21:08:12Z", "path": "dpc-web/Gemfile.lock", "diffHunk": "@@ -113,12 +118,41 @@ GEM\n     faraday (0.15.4)\n       multipart-post (>= 1.2, < 3)\n     ffi (1.11.3)\n+    fhir_client (4.0.3)\n+      activesupport (>= 3)\n+      addressable (>= 2.3)\n+      fhir_dstu2_models (>= 1.0.10)\n+      fhir_models (>= 4.0.2)\n+      fhir_stu3_models (>= 3.0.1)\n+      nokogiri (>= 1.10.4)\n+      oauth2 (~> 1.1)\n+      rack (>= 1.5)\n+      rest-client (~> 2.0)\n+      tilt (>= 1.1)\n+    fhir_dstu2_models (1.0.10)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNjMwNQ==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369806305", "bodyText": "Unavoidable if we want to use the Ruby FHIR client gem. It's required: https://github.com/fhir-crucible/fhir_client/blob/master/fhir_client.gemspec#L27", "author": "switzersc-usds", "createdAt": "2020-01-22T21:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMzg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgyNTc0MA==", "url": "https://github.com/CMSgov/dpc-app/pull/555#discussion_r369825740", "bodyText": "Do not prefix writer method names with set_.", "author": "codeclimate", "createdAt": "2020-01-22T21:56:13Z", "path": "dpc-web/app/services/api_client.rb", "diffHunk": "@@ -124,6 +150,25 @@ def http_request(request, uri)\n     @response_body = { 'issue' => [{ 'details' => { 'text' => 'Connection error' } }] }\n   end\n \n+  def fhir_client_update_request(reg_org_id, resource, resource_id)\n+    set_fhir_client_auth(reg_org_id)\n+\n+    response = fhir_client.update(resource, resource_id)\n+\n+    if response.response[:code] == '200'\n+      true\n+    else\n+      Rails.logger.warn 'Unsuccessulful request to API'\n+      @response_status = response.response[:code]\n+      @response_body = { 'issue' => [{ 'details' => { 'text' => 'Request error' } }] }\n+      false\n+    end\n+  end\n+\n+  def set_fhir_client_auth(reg_org_id)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d9ed96cd003604997c11472ed552ca8432eadb5", "url": "https://github.com/CMSgov/dpc-app/commit/1d9ed96cd003604997c11472ed552ca8432eadb5", "message": "Update organization from web app to API\n\nUse FHIR client to update registered organizations in API\n\nAlso some cleanup from manual testing; remove delay in org creation", "committedDate": "2020-01-23T14:19:25Z", "type": "commit"}, {"oid": "45f2e3c4044ced771b355f584523ab07ab86bedb", "url": "https://github.com/CMSgov/dpc-app/commit/45f2e3c4044ced771b355f584523ab07ab86bedb", "message": "Add fhir endpoint updating", "committedDate": "2020-01-23T14:19:40Z", "type": "commit"}, {"oid": "c967b52d25127a1f9a78e27f15e33b8566ad3030", "url": "https://github.com/CMSgov/dpc-app/commit/c967b52d25127a1f9a78e27f15e33b8566ad3030", "message": "Add payloadType to endpoint update request", "committedDate": "2020-01-23T14:19:40Z", "type": "commit"}, {"oid": "b5231bfe9c0143c212c731c667522242ce9ff09e", "url": "https://github.com/CMSgov/dpc-app/commit/b5231bfe9c0143c212c731c667522242ce9ff09e", "message": "Add Endpoint.payloadType to Organization$submit\n\nThis field is required by FHIR but currently our API has a bug that\nskips validation of this field when creating an Endpoint. This commit\nadds the field and updates the test stubs.\n\nSee:\nhttps://hl7.org/fhir/STU3/endpoint-example.json.html\nhttps://dpc.cms.gov/ig/StructureDefinition-dpc-profile-endpoint-definitions.html", "committedDate": "2020-01-23T14:19:40Z", "type": "commit"}, {"oid": "4a9744b191e21d995cba81049531309bd12cfa3e", "url": "https://github.com/CMSgov/dpc-app/commit/4a9744b191e21d995cba81049531309bd12cfa3e", "message": "Cleanup", "committedDate": "2020-01-23T14:19:40Z", "type": "commit"}, {"oid": "02dcf41aecfdf81b2b6a69625c7e22bd8e21679e", "url": "https://github.com/CMSgov/dpc-app/commit/02dcf41aecfdf81b2b6a69625c7e22bd8e21679e", "message": "Refactor for smaller APIClient class\n\nPull out FHIR resource building into a separate class.\n\nOne other cleanup fix in attribute method in organization_registrar\n\nMore cleanup from codeclimate recs", "committedDate": "2020-01-23T14:19:41Z", "type": "commit"}, {"oid": "074ac7d056f05e09757cf14d27592337f9154a91", "url": "https://github.com/CMSgov/dpc-app/commit/074ac7d056f05e09757cf14d27592337f9154a91", "message": "Refactor APIClient to separate org and endpoint\n\nOrg and endpint update requests should be separate methods because\nthey are separate interactions with the API.", "committedDate": "2020-01-23T14:19:45Z", "type": "commit"}, {"oid": "074ac7d056f05e09757cf14d27592337f9154a91", "url": "https://github.com/CMSgov/dpc-app/commit/074ac7d056f05e09757cf14d27592337f9154a91", "message": "Refactor APIClient to separate org and endpoint\n\nOrg and endpint update requests should be separate methods because\nthey are separate interactions with the API.", "committedDate": "2020-01-23T14:19:45Z", "type": "forcePushed"}]}