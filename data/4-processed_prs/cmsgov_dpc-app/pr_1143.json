{"pr_number": 1143, "pr_title": "DPC-859 creating resource templates for the tests", "pr_createdAt": "2020-12-16T06:24:52Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/1143", "timeline": [{"oid": "6bc0f09846aa8e05c11b83af517ab1a01480aa1f", "url": "https://github.com/CMSgov/dpc-app/commit/6bc0f09846aa8e05c11b83af517ab1a01480aa1f", "message": "creating resource templates for the tests", "committedDate": "2020-12-16T06:23:41Z", "type": "commit"}, {"oid": "a8afa75dc9b5b309bf72e71b368ae024ff3578c4", "url": "https://github.com/CMSgov/dpc-app/commit/a8afa75dc9b5b309bf72e71b368ae024ff3578c4", "message": "generate mbi for patient tests", "committedDate": "2020-12-16T07:29:19Z", "type": "commit"}, {"oid": "f41a0f332db1c8f8298b408bd1e53e1553ed6ccf", "url": "https://github.com/CMSgov/dpc-app/commit/f41a0f332db1c8f8298b408bd1e53e1553ed6ccf", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2020-12-16T16:00:56Z", "type": "commit"}, {"oid": "08f53607868f92462e757444c7a2de16ffee7095", "url": "https://github.com/CMSgov/dpc-app/commit/08f53607868f92462e757444c7a2de16ffee7095", "message": "remove old test files, replaced by templates", "committedDate": "2020-12-16T16:02:08Z", "type": "commit"}, {"oid": "4e90dee56630e1eb012d434a546454aecfaf0e23", "url": "https://github.com/CMSgov/dpc-app/commit/4e90dee56630e1eb012d434a546454aecfaf0e23", "message": "revert changes to unmarshallId, create new fn instead", "committedDate": "2020-12-16T16:03:11Z", "type": "commit"}, {"oid": "5b327057bca36bd20681cda4171431e17f54996b", "url": "https://github.com/CMSgov/dpc-app/commit/5b327057bca36bd20681cda4171431e17f54996b", "message": "Merge branch 'DPC-859-resource-templates-for-performance-tests' of https://github.com/CMSgov/dpc-app into DPC-859-resource-templates-for-performance-tests", "committedDate": "2020-12-16T16:03:17Z", "type": "commit"}, {"oid": "4766c39a081ac911550d8973bce5c987f198ee90", "url": "https://github.com/CMSgov/dpc-app/commit/4766c39a081ac911550d8973bce5c987f198ee90", "message": "change variable name", "committedDate": "2020-12-16T16:14:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3ODA1OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544478058", "bodyText": "thats pretty cool", "author": "MrMorie", "createdAt": "2020-12-16T17:17:25Z", "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -109,11 +132,15 @@ func readBodies(pattern string) [][]byte {\n \treturn bodies\n }\n \n-func generateKeyBodies(n int, fn func() (string, *rsa.PrivateKey, string)) [][]byte {\n-\tvar bodies [][]byte\n-\tfor i := 0; i < n; i++ {\n-\t\tpubKeyStr, _, signature := fn()\n-\t\tbodies = append(bodies, []byte(fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)))\n+func generateNPI() string {\n+\tluhnWithPrefix := luhn.GenerateWithPrefix(15, \"808403\")\n+\treturn luhnWithPrefix[len(luhnWithPrefix)-10:]\n+}\n+\n+func generateMBI() string {\n+\tmbi, err := regen.Generate(\"^[1-9][a-zA-Z][a-zA-Z0-9][0-9][a-zA-Z][a-zA-Z0-9][0-9][a-zA-Z]{2}[0-9]{2}$\")", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MjE4MQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544452181", "bodyText": "We'll want to capture and respond to possible errors here, and with any other functions that can return an error.", "author": "dhgreene", "createdAt": "2020-12-16T16:43:17Z", "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -29,6 +36,22 @@ func unmarshalIDs(resps [][]byte) []string {\n \treturn IDs\n }\n \n+// Pull `identifier` out of a set of response bodies\n+func unmarshalIdentifiers(resps [][]byte, system string) []string {\n+\tvar identifierValue []string\n+\tfor _, resp := range resps {\n+\t\tvar result Resource\n+\t\tjson.Unmarshal(resp, &result)", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1Mjk2Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544452967", "bodyText": "We probably don't need to modify this \ud83d\ude04", "author": "dhgreene", "createdAt": "2020-12-16T16:44:18Z", "path": "dpc-testing/performance/main.go", "diffHunk": "@@ -26,4 +26,5 @@ func main() {\n \tapi.RunPractitionerTests()\n \tapi.RunOrgTests()\n \tapi.RunGroupTests()\n+", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1ODk0NQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544458945", "bodyText": "What's our convention for test MBIs?", "author": "dhgreene", "createdAt": "2020-12-16T16:51:46Z", "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -109,11 +132,15 @@ func readBodies(pattern string) [][]byte {\n \treturn bodies\n }\n \n-func generateKeyBodies(n int, fn func() (string, *rsa.PrivateKey, string)) [][]byte {\n-\tvar bodies [][]byte\n-\tfor i := 0; i < n; i++ {\n-\t\tpubKeyStr, _, signature := fn()\n-\t\tbodies = append(bodies, []byte(fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)))\n+func generateNPI() string {\n+\tluhnWithPrefix := luhn.GenerateWithPrefix(15, \"808403\")\n+\treturn luhnWithPrefix[len(luhnWithPrefix)-10:]\n+}\n+\n+func generateMBI() string {\n+\tmbi, err := regen.Generate(\"^[1-9][a-zA-Z][a-zA-Z0-9][0-9][a-zA-Z][a-zA-Z0-9][0-9][a-zA-Z]{2}[0-9]{2}$\")", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5MjIwMQ==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544492201", "bodyText": "this is a copy form the java code, only change made was changing \\d to 0-9 since \\d means something else in golang regex.  I did make it slightly stricter by making the first position only 1-9 instead of 0-9 according to CMS mbi", "author": "MrBilnon", "createdAt": "2020-12-16T17:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1ODk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwNjk2Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544506962", "bodyText": "Right, but we don't want valid MBIs, just MBI-like test values.  Can we have one of those characters limited to the proscribed characater set [SLOIBZ]?", "author": "dhgreene", "createdAt": "2020-12-16T17:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1ODk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0MjgyNg==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544542826", "bodyText": "I think for our purposes here, generating strict mbis here are fine since the check in the service is more lenient.", "author": "MrBilnon", "createdAt": "2020-12-16T18:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1ODk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ2MTk4OA==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544461988", "bodyText": "Let's add unit tests for the functions in this file!  \ud83e\uddea", "author": "dhgreene", "createdAt": "2020-12-16T16:55:46Z", "path": "dpc-testing/performance/pkg/dpc/generator.go", "diffHunk": "@@ -0,0 +1,99 @@\n+package dpc\n+\n+import (\n+\t\"bytes\"\n+\t\"crypto/rsa\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"net/url\"\n+)\n+\n+func templateBodyGenerator(templateFile string, replacementMap map[string]func() string) func() []byte {", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ2NzY4Ng==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544467686", "bodyText": "This will be more readable with `` instead of \"\":\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tbodies = append(bodies, []byte(fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)))\n          \n          \n            \n            \t\tbodies = append(bodies, []byte(fmt.Sprintf(`{ \"key\": \"%s\", \"signature\": \"%s\"}`, pubKeyStr, signature)))", "author": "dhgreene", "createdAt": "2020-12-16T17:03:23Z", "path": "dpc-testing/performance/pkg/dpc/generator.go", "diffHunk": "@@ -0,0 +1,99 @@\n+package dpc\n+\n+import (\n+\t\"bytes\"\n+\t\"crypto/rsa\"\n+\t\"fmt\"\n+\t\"io/ioutil\"\n+\t\"net/url\"\n+)\n+\n+func templateBodyGenerator(templateFile string, replacementMap map[string]func() string) func() []byte {\n+\tbody, err := ioutil.ReadFile(templateFile)\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\treturn func() []byte {\n+\t\toutput := body\n+\n+\t\tfor k, v := range replacementMap {\n+\t\t\tkeyCount := bytes.Count(body, []byte(k))\n+\t\t\tfor i := 0; i < keyCount; i++ {\n+\t\t\t\tvalue := v()\n+\t\t\t\toutput = bytes.Replace(output, []byte(k), []byte(value), i+1)\n+\t\t\t}\n+\n+\t\t}\n+\n+\t\treturn output\n+\t}\n+}\n+\n+func keyBodyGenerator(n int, fn func() (string, *rsa.PrivateKey, string)) func() []byte {\n+\tvar bodies [][]byte\n+\tfor i := 0; i < n; i++ {\n+\t\tpubKeyStr, _, signature := fn()\n+\t\tbodies = append(bodies, []byte(fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)))", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5MDgyMA==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r544490820", "bodyText": "Can we make dpc.generateNPI() public and reference it here and a few lines later?", "author": "dhgreene", "createdAt": "2020-12-16T17:35:12Z", "path": "dpc-testing/performance/pkg/dpc/test_organization.go", "diffHunk": "@@ -13,7 +14,10 @@ func (api *API) RunOrgTests() {\n \t\tBaseURL:     api.URL,\n \t\tEndpoint:    endpoint + \"/$submit\",\n \t\tAccessToken: string(api.goldenMacaroon),\n-\t\tBodies:      readBodies(\"../../src/main/resources/organizations/base-organization.json\"),\n+\t\tGenerator: templateBodyGenerator(\"./templates/organization-bundle-template.json\", map[string]func() string{\"{NPI}\": func() string {\n+\t\t\tluhnWithPrefix := luhn.GenerateWithPrefix(15, \"808403\")", "originalCommit": "4766c39a081ac911550d8973bce5c987f198ee90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "669ef9a4eddc7c3edf2d321cbc3ec834a61abfbc", "url": "https://github.com/CMSgov/dpc-app/commit/669ef9a4eddc7c3edf2d321cbc3ec834a61abfbc", "message": "pr concerns", "committedDate": "2020-12-16T18:04:46Z", "type": "commit"}, {"oid": "536a0f678d7178c3a74161e5d608fa1bb6c2a3ac", "url": "https://github.com/CMSgov/dpc-app/commit/536a0f678d7178c3a74161e5d608fa1bb6c2a3ac", "message": "make generated mbis strict", "committedDate": "2020-12-16T18:05:01Z", "type": "commit"}, {"oid": "96c48090d7af84656af8e3193c6219a62be9741d", "url": "https://github.com/CMSgov/dpc-app/commit/96c48090d7af84656af8e3193c6219a62be9741d", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2020-12-16T18:35:47Z", "type": "commit"}, {"oid": "711baf88b7b437d0612dfa2d5b5758cd8d9c0f8c", "url": "https://github.com/CMSgov/dpc-app/commit/711baf88b7b437d0612dfa2d5b5758cd8d9c0f8c", "message": "pr concerns", "committedDate": "2020-12-16T21:23:11Z", "type": "commit"}, {"oid": "bc2a29567358f6e8dad9769fc7e2706c424343da", "url": "https://github.com/CMSgov/dpc-app/commit/bc2a29567358f6e8dad9769fc7e2706c424343da", "message": "fix some stuff", "committedDate": "2020-12-17T06:46:00Z", "type": "commit"}, {"oid": "fd79b393be2f7fad1ceb1771533fc821d8b70aeb", "url": "https://github.com/CMSgov/dpc-app/commit/fd79b393be2f7fad1ceb1771533fc821d8b70aeb", "message": "removed commented out code", "committedDate": "2020-12-17T06:48:23Z", "type": "commit"}, {"oid": "d8edaa39d4714d4fce70a97ca629a7d110a12333", "url": "https://github.com/CMSgov/dpc-app/commit/d8edaa39d4714d4fce70a97ca629a7d110a12333", "message": "remove more commented out code", "committedDate": "2020-12-17T06:50:37Z", "type": "commit"}, {"oid": "5f77a485f3e3ecc76204c53ded911be38f848d14", "url": "https://github.com/CMSgov/dpc-app/commit/5f77a485f3e3ecc76204c53ded911be38f848d14", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2020-12-21T15:27:52Z", "type": "commit"}, {"oid": "35f8d4f7cacae37131751a2c56162b24b4ac2bc2", "url": "https://github.com/CMSgov/dpc-app/commit/35f8d4f7cacae37131751a2c56162b24b4ac2bc2", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2020-12-21T23:25:04Z", "type": "commit"}, {"oid": "d3205331774e35166f91fa181e85b71c3c7fa99c", "url": "https://github.com/CMSgov/dpc-app/commit/d3205331774e35166f91fa181e85b71c3c7fa99c", "message": "make code climate happy", "committedDate": "2020-12-22T03:19:15Z", "type": "commit"}, {"oid": "3bfb7b2b02865b2ed3782458452860db8ec5fd67", "url": "https://github.com/CMSgov/dpc-app/commit/3bfb7b2b02865b2ed3782458452860db8ec5fd67", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-04T22:50:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY4NTM5Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/1143#discussion_r551685397", "bodyText": "Thats pretty cool.", "author": "MrMorie", "createdAt": "2021-01-05T02:41:26Z", "path": "dpc-testing/performance/pkg/dpc/dpc.go", "diffHunk": "@@ -90,30 +110,15 @@ func cleanAndPanic(err error) {\n \tpanic(err)\n }\n \n-func readBodies(pattern string) [][]byte {\n-\tfilenames, err := filepath.Glob(pattern)\n-\tif err != nil {\n-\t\tpanic(err)\n-\t}\n-\n-\tbodies := make([][]byte, 0)\n-\tfor _, fname := range filenames {\n-\t\tbody, err := ioutil.ReadFile(fname)\n-\t\tif err != nil {\n-\t\t\tpanic(err)\n-\t\t}\n-\n-\t\tbodies = append(bodies, body)\n-\t}\n-\n-\treturn bodies\n+func generateNPI() string {\n+\tluhnWithPrefix := luhn.GenerateWithPrefix(15, \"808403\")\n+\treturn luhnWithPrefix[len(luhnWithPrefix)-10:]\n }\n \n-func generateKeyBodies(n int, fn func() (string, *rsa.PrivateKey, string)) [][]byte {\n-\tvar bodies [][]byte\n-\tfor i := 0; i < n; i++ {\n-\t\tpubKeyStr, _, signature := fn()\n-\t\tbodies = append(bodies, []byte(fmt.Sprintf(\"{ \\\"key\\\": \\\"%s\\\", \\\"signature\\\": \\\"%s\\\"}\", pubKeyStr, signature)))\n+func generateMBI() string {\n+\tmbi, err := regen.Generate(\"^[1-9][ac-hj-km-np-rt-yAC-HJ-KM-NP-RT-Y][ac-hj-km-np-rt-yAC-HJ-KM-NP-RT-Y0-9][0-9][ac-hj-km-np-rt-yAC-HJ-KM-NP-RT-Y][ac-hj-km-np-rt-yAC-HJ-KM-NP-RT-Y0-9][0-9][ac-hj-km-np-rt-yAC-HJ-KM-NP-RT-Y]{2}[0-9]{2}$\")", "originalCommit": "3bfb7b2b02865b2ed3782458452860db8ec5fd67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3dcc8b53a9017bba7db2dfbbe518de80b1a81716", "url": "https://github.com/CMSgov/dpc-app/commit/3dcc8b53a9017bba7db2dfbbe518de80b1a81716", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-06T16:28:31Z", "type": "commit"}, {"oid": "ed3269fa5072c0c6f346f29849f4c08e9f7084d4", "url": "https://github.com/CMSgov/dpc-app/commit/ed3269fa5072c0c6f346f29849f4c08e9f7084d4", "message": "add test for template generator", "committedDate": "2021-01-06T21:19:11Z", "type": "commit"}, {"oid": "7f756b3fc8cc0358705cae6887f43b76392c4dfe", "url": "https://github.com/CMSgov/dpc-app/commit/7f756b3fc8cc0358705cae6887f43b76392c4dfe", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-06T21:19:52Z", "type": "commit"}, {"oid": "f42bd0e4f0148cf9a5a986086e54d9b0fe8d6e68", "url": "https://github.com/CMSgov/dpc-app/commit/f42bd0e4f0148cf9a5a986086e54d9b0fe8d6e68", "message": "use testify", "committedDate": "2021-01-06T21:41:54Z", "type": "commit"}, {"oid": "97dfae4a81bbafc7c6f48cb2ea45800d0d604cbe", "url": "https://github.com/CMSgov/dpc-app/commit/97dfae4a81bbafc7c6f48cb2ea45800d0d604cbe", "message": "Merge branch 'DPC-859-resource-templates-for-performance-tests' of https://github.com/CMSgov/dpc-app into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-06T21:41:59Z", "type": "commit"}, {"oid": "2d836625100e99ea9b3c51fdf9f07c235de65c01", "url": "https://github.com/CMSgov/dpc-app/commit/2d836625100e99ea9b3c51fdf9f07c235de65c01", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-08T16:36:14Z", "type": "commit"}, {"oid": "5b3299f1a77f20eab31550555d1b442499e4d006", "url": "https://github.com/CMSgov/dpc-app/commit/5b3299f1a77f20eab31550555d1b442499e4d006", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-08T17:15:15Z", "type": "commit"}, {"oid": "34c271bf6d9b684b7aa522d1ba8313341ccb3f6f", "url": "https://github.com/CMSgov/dpc-app/commit/34c271bf6d9b684b7aa522d1ba8313341ccb3f6f", "message": "Merge branch 'master' into DPC-859-resource-templates-for-performance-tests", "committedDate": "2021-01-08T17:57:18Z", "type": "commit"}]}