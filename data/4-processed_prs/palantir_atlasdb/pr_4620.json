{"pr_number": 4620, "pr_title": "Refactor out an AsyncRetrier to allow for better testing", "pr_createdAt": "2020-03-02T09:51:31Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4620", "timeline": [{"oid": "bf3719ee0cdd3d058b828c6bf78f3c649d4dfc6d", "url": "https://github.com/palantir/atlasdb/commit/bf3719ee0cdd3d058b828c6bf78f3c649d4dfc6d", "message": "Add generated changelog entries", "committedDate": "2020-02-28T18:44:30Z", "type": "commit"}, {"oid": "9675ddc822fc7c2a2b8b544d8870b82f36e57464", "url": "https://github.com/palantir/atlasdb/commit/9675ddc822fc7c2a2b8b544d8870b82f36e57464", "message": "Refactor out an AsyncRetrier to allow for better testing", "committedDate": "2020-03-02T09:49:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNjQ2Mg==", "url": "https://github.com/palantir/atlasdb/pull/4620#discussion_r386306462", "bodyText": "This if statement feels a bit odd: it exits when the predicate is satisfied (which makes sense), but also when you run out of retries. However, running out of retries will return the result even though it doesn't satisfy the predicate - meaning the name of the method retryUntilSatisfied is a little misleading, as it can return a result when the predicate is not satisfied. I think this is a bit misleading.", "author": "Jolyon-S", "createdAt": "2020-03-02T10:20:59Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AsyncRetrier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader.proxy;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.ListeningExecutorService;\n+import com.google.common.util.concurrent.ListeningScheduledExecutorService;\n+\n+/**\n+ * Class that uses ListenableFuture primitives to provide a simple delay-retry loop. Should be kept very simple.\n+ */\n+final class AsyncRetrier<T> {\n+    private final int maxAttempts;\n+    private final Duration delayBetweenAttempts;\n+    private final ListeningScheduledExecutorService schedulingExecutor;\n+    private final ListeningExecutorService executionExecutor;\n+    private final Predicate<T> predicate;\n+\n+    AsyncRetrier(\n+            int maxAttempts,\n+            Duration delayBetweenAttempts,\n+            ListeningScheduledExecutorService schedulingExecutor,\n+            ListeningExecutorService executionExecutor,\n+            Predicate<T> predicate) {\n+        this.maxAttempts = maxAttempts;\n+        this.delayBetweenAttempts = delayBetweenAttempts;\n+        this.schedulingExecutor = schedulingExecutor;\n+        this.executionExecutor = executionExecutor;\n+        this.predicate = predicate;\n+    }\n+\n+    public ListenableFuture<T> retryUntilSatistfied(Supplier<ListenableFuture<T>> supplier) {\n+        return retryUntilSatistfied(supplier, maxAttempts);\n+    }\n+\n+    private ListenableFuture<T> retryUntilSatistfied(Supplier<ListenableFuture<T>> supplier, int retriesRemaining) {\n+        return Futures.transformAsync(Futures.submitAsync(supplier::get, executionExecutor),\n+                result -> {\n+                    int newRetriesRemaining = retriesRemaining - 1;\n+                    if (predicate.test(result) || newRetriesRemaining == 0) {", "originalCommit": "bf3719ee0cdd3d058b828c6bf78f3c649d4dfc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxNzMwMg==", "url": "https://github.com/palantir/atlasdb/pull/4620#discussion_r386317302", "bodyText": "Renamed to execute()", "author": "j-baker", "createdAt": "2020-03-02T10:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMwNjQ2Mg=="}], "type": "inlineReview"}, {"oid": "8ab6a37108bae1f68a09b76a64802fa052aa4df2", "url": "https://github.com/palantir/atlasdb/commit/8ab6a37108bae1f68a09b76a64802fa052aa4df2", "message": "Execute", "committedDate": "2020-03-02T10:42:15Z", "type": "commit"}, {"oid": "423f2fca21b07d4d9461cc9918c8d8d9a47cde4d", "url": "https://github.com/palantir/atlasdb/commit/423f2fca21b07d4d9461cc9918c8d8d9a47cde4d", "message": "Merge branch 'jbaker/async_retrier' of github.com:palantir/atlasdb into jbaker/async_retrier", "committedDate": "2020-03-02T10:42:51Z", "type": "commit"}]}