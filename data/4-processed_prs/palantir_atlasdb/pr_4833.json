{"pr_number": 4833, "pr_title": "Feedback 1", "pr_createdAt": "2020-06-12T09:31:06Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4833", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0Mzc4Mg==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439343782", "bodyText": "Consider using a stream-of-optionals impl? It's probably going to be neater (provided it works)", "author": "jeremyk-91", "createdAt": "2020-06-12T10:42:01Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -538,6 +545,19 @@ private TransactionManager serializableInternal(@Output List<AutoCloseable> clos\n         return transactionManager;\n     }\n \n+    private String getServiceName() {\n+        String serviceName = \"UNKNOWN\";\n+        if (config().namespace().isPresent()) {\n+            serviceName = config().namespace().get();\n+        } else if (config().timelock().isPresent()) {\n+            TimeLockClientConfig timeLockClientConfig = config().timelock().get();\n+            serviceName = timeLockClientConfig.getClientOrThrow();\n+        } else if (config().keyValueService().namespace().isPresent()) {\n+            serviceName = config().keyValueService().namespace().get();\n+        }\n+        return serviceName;", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "171688b88548d15b2c0ce6fb8abde3ef8c60eac2", "url": "https://github.com/palantir/atlasdb/commit/171688b88548d15b2c0ce6fb8abde3ef8c60eac2", "message": "timeLock metrics | poc", "committedDate": "2020-06-12T13:16:43Z", "type": "commit"}, {"oid": "19b663688cdb52803e5fd97303eb56a4a322511b", "url": "https://github.com/palantir/atlasdb/commit/19b663688cdb52803e5fd97303eb56a4a322511b", "message": "remove redundant code", "committedDate": "2020-06-12T13:16:43Z", "type": "commit"}, {"oid": "3dfaacf2a2e3709d5267b7552a2f75b71e5cf060", "url": "https://github.com/palantir/atlasdb/commit/3dfaacf2a2e3709d5267b7552a2f75b71e5cf060", "message": "poc", "committedDate": "2020-06-12T13:17:43Z", "type": "commit"}, {"oid": "89fa0c4d0a07bdff9a4227307be60ba5eb191285", "url": "https://github.com/palantir/atlasdb/commit/89fa0c4d0a07bdff9a4227307be60ba5eb191285", "message": "clean", "committedDate": "2020-06-12T13:17:44Z", "type": "commit"}, {"oid": "80a1aef6722cbe7504c26297d4173058bcd5f398", "url": "https://github.com/palantir/atlasdb/commit/80a1aef6722cbe7504c26297d4173058bcd5f398", "message": "refactor", "committedDate": "2020-06-12T13:17:44Z", "type": "commit"}, {"oid": "f2de8477aa9c2ecc15a9be101b7bd0dc78b73d00", "url": "https://github.com/palantir/atlasdb/commit/f2de8477aa9c2ecc15a9be101b7bd0dc78b73d00", "message": "Fix", "committedDate": "2020-06-12T13:17:44Z", "type": "commit"}, {"oid": "f2de8477aa9c2ecc15a9be101b7bd0dc78b73d00", "url": "https://github.com/palantir/atlasdb/commit/f2de8477aa9c2ecc15a9be101b7bd0dc78b73d00", "message": "Fix", "committedDate": "2020-06-12T13:17:44Z", "type": "forcePushed"}, {"oid": "6c9e6e30e0e001ea3e7a8855a439eb793dcfb674", "url": "https://github.com/palantir/atlasdb/commit/6c9e6e30e0e001ea3e7a8855a439eb793dcfb674", "message": "client feedback", "committedDate": "2020-06-12T15:29:46Z", "type": "commit"}, {"oid": "bcdf0e2359de9aad1ed982e0f9dc3ccca0270c83", "url": "https://github.com/palantir/atlasdb/commit/bcdf0e2359de9aad1ed982e0f9dc3ccca0270c83", "message": "remove redundant import", "committedDate": "2020-06-12T15:30:54Z", "type": "commit"}, {"oid": "e86603ae1f3016e0aa38aa0a7fd4837c29db67ae", "url": "https://github.com/palantir/atlasdb/commit/e86603ae1f3016e0aa38aa0a7fd4837c29db67ae", "message": "Cleanup", "committedDate": "2020-06-12T15:57:18Z", "type": "commit"}, {"oid": "ba3ff8232f1169e41f239a233a1cb8155a8d8c7f", "url": "https://github.com/palantir/atlasdb/commit/ba3ff8232f1169e41f239a233a1cb8155a8d8c7f", "message": "remove redundant dependency", "committedDate": "2020-06-15T07:28:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0MzkwNg==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439343906", "bodyText": "Background tasks need to be shut down when the TM shuts down", "author": "jeremyk-91", "createdAt": "2020-06-12T10:42:17Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -359,6 +361,11 @@ public TransactionManager serializable() {\n     private TransactionManager serializableInternal(@Output List<AutoCloseable> closeables) {\n         MetricsManager metricsManager = MetricsManagers.of(globalMetricsRegistry(), globalTaggedMetricRegistry());\n \n+        TimeLockFeedbackBackgroundTask.create(", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2NDAxNA==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440364014", "bodyText": "(I don't think we fixed this yet - we've made the task AutoCloseable but it is not actually closed when the TM shuts down!)", "author": "jeremyk-91", "createdAt": "2020-06-15T18:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0MzkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0NDg3Ng==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439344876", "bodyText": "This is broadly correct, but some notes:\n\nDo we really need 5 threads? I think a PtExecutors.singleThreadScheduledExecutor() should be enough - in fact given how we use it I don't think we'll ever have more than 1 thread\nBackground threads should have names indicating what they do\nAs noted these need to be shut down when the TM closes. The background task needs to be closeable.", "author": "jeremyk-91", "createdAt": "2020-06-12T10:44:21Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.util.UUID;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockFeedbackBackgroundTask {\n+    private TimeLockFeedbackBackgroundTask() {\n+        // no op\n+    }\n+\n+    public static void create(TaggedMetricRegistry taggedMetricRegistry, Supplier<String> versionSupplier,\n+            String serviceName) {\n+        UUID nodeId = UUID.randomUUID();\n+\n+        ScheduledExecutorService scheduledExecutorService =\n+                Executors.newScheduledThreadPool(5);", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0NTE2NQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439345165", "bodyText": "nit: p99 is standard for 99th percentile I think; the one minute rate should be 1m or rate", "author": "jeremyk-91", "createdAt": "2020-06-12T10:45:06Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.util.UUID;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockFeedbackBackgroundTask {\n+    private TimeLockFeedbackBackgroundTask() {\n+        // no op\n+    }\n+\n+    public static void create(TaggedMetricRegistry taggedMetricRegistry, Supplier<String> versionSupplier,\n+            String serviceName) {\n+        UUID nodeId = UUID.randomUUID();\n+\n+        ScheduledExecutorService scheduledExecutorService =\n+                Executors.newScheduledThreadPool(5);\n+        scheduledExecutorService.scheduleWithFixedDelay((Runnable) () -> {\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics =\n+                    ConjureTimelockServiceBlockingMetrics.of(taggedMetricRegistry);\n+\n+            ImmutableMap.of(\n+            \"perc99\", conjureTimelockServiceBlockingMetrics.startTransactions().getSnapshot().get99thPercentile(),\n+            \"Rate\", conjureTimelockServiceBlockingMetrics.startTransactions().getOneMinuteRate(),", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0NTIwNg==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439345206", "bodyText": "Is casting needed?", "author": "jeremyk-91", "createdAt": "2020-06-12T10:45:12Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.util.UUID;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockFeedbackBackgroundTask {\n+    private TimeLockFeedbackBackgroundTask() {\n+        // no op\n+    }\n+\n+    public static void create(TaggedMetricRegistry taggedMetricRegistry, Supplier<String> versionSupplier,\n+            String serviceName) {\n+        UUID nodeId = UUID.randomUUID();\n+\n+        ScheduledExecutorService scheduledExecutorService =\n+                Executors.newScheduledThreadPool(5);\n+        scheduledExecutorService.scheduleWithFixedDelay((Runnable) () -> {", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM0NTI5Mg==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r439345292", "bodyText": "Probably best to have a constant for the interval", "author": "jeremyk-91", "createdAt": "2020-06-12T10:45:22Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.util.UUID;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockFeedbackBackgroundTask {\n+    private TimeLockFeedbackBackgroundTask() {\n+        // no op\n+    }\n+\n+    public static void create(TaggedMetricRegistry taggedMetricRegistry, Supplier<String> versionSupplier,\n+            String serviceName) {\n+        UUID nodeId = UUID.randomUUID();\n+\n+        ScheduledExecutorService scheduledExecutorService =\n+                Executors.newScheduledThreadPool(5);\n+        scheduledExecutorService.scheduleWithFixedDelay((Runnable) () -> {\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics =\n+                    ConjureTimelockServiceBlockingMetrics.of(taggedMetricRegistry);\n+\n+            ImmutableMap.of(\n+            \"perc99\", conjureTimelockServiceBlockingMetrics.startTransactions().getSnapshot().get99thPercentile(),\n+            \"Rate\", conjureTimelockServiceBlockingMetrics.startTransactions().getOneMinuteRate(),\n+            \"atlasVersion\", versionSupplier.get(),\n+            \"nodeId\", nodeId,\n+                    \"serviceName\", serviceName);\n+\n+\n+        }, 30, 30, TimeUnit.SECONDS);", "originalCommit": "caf006534f3e512c329a135f58ca1386e991c3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0MDM1Nw==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440040357", "bodyText": "Fine for now. Watch out for exceptions though!", "author": "jeremyk-91", "createdAt": "2020-06-15T09:17:30Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.util.UUID;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockFeedbackBackgroundTask {\n+    private TimeLockFeedbackBackgroundTask() {\n+        // no op\n+    }\n+\n+    public static void create(TaggedMetricRegistry taggedMetricRegistry, Supplier<String> versionSupplier,\n+            String serviceName) {\n+        UUID nodeId = UUID.randomUUID();\n+\n+        ScheduledExecutorService scheduledExecutorService =\n+                Executors.newScheduledThreadPool(5);\n+        scheduledExecutorService.scheduleWithFixedDelay(() -> {", "originalCommit": "ba3ff8232f1169e41f239a233a1cb8155a8d8c7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0MDg3Nw==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440040877", "bodyText": "This is OK, but I'd prefer we use the opportunity to define it as a Conjure object", "author": "jeremyk-91", "createdAt": "2020-06-15T09:18:20Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/ClientFeedback.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+import java.util.UUID;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+\n+@Value.Immutable\n+@JsonSerialize(as = ImmutableClientFeedback.class)\n+@JsonDeserialize(as = ImmutableClientFeedback.class)\n+public interface ClientFeedback {", "originalCommit": "ba3ff8232f1169e41f239a233a1cb8155a8d8c7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3451b8634357df410abf413fabb69aad0955fc2d", "url": "https://github.com/palantir/atlasdb/commit/3451b8634357df410abf413fabb69aad0955fc2d", "message": "Stream of optionals", "committedDate": "2020-06-15T11:07:54Z", "type": "commit"}, {"oid": "9b810fc2df4199ef2923d98658a7d7cb45011f56", "url": "https://github.com/palantir/atlasdb/commit/9b810fc2df4199ef2923d98658a7d7cb45011f56", "message": "Address comments - I", "committedDate": "2020-06-15T12:45:19Z", "type": "commit"}, {"oid": "be7f9a1b61a35e3a016f032e1acb1b2de1a462c5", "url": "https://github.com/palantir/atlasdb/commit/be7f9a1b61a35e3a016f032e1acb1b2de1a462c5", "message": "conjure", "committedDate": "2020-06-15T13:37:55Z", "type": "commit"}, {"oid": "0e23e0920d98884a07c314ecb91196126411fa8d", "url": "https://github.com/palantir/atlasdb/commit/0e23e0920d98884a07c314ecb91196126411fa8d", "message": "conjure-objects", "committedDate": "2020-06-15T13:48:18Z", "type": "commit"}, {"oid": "23b5e534f29eaa452ae4e8d11055d9b3179c10b1", "url": "https://github.com/palantir/atlasdb/commit/23b5e534f29eaa452ae4e8d11055d9b3179c10b1", "message": "Address comments", "committedDate": "2020-06-15T13:52:46Z", "type": "commit"}, {"oid": "11d2ce8a3f0672c8e84896b49bf414b719022a7a", "url": "https://github.com/palantir/atlasdb/commit/11d2ce8a3f0672c8e84896b49bf414b719022a7a", "message": "remove clientFeedback", "committedDate": "2020-06-15T14:01:54Z", "type": "commit"}, {"oid": "ae1e0adec9802984b29c1b1222d56aa7c309292a", "url": "https://github.com/palantir/atlasdb/commit/ae1e0adec9802984b29c1b1222d56aa7c309292a", "message": "test", "committedDate": "2020-06-15T14:11:12Z", "type": "commit"}, {"oid": "dca56388bb55ad92079212b17f9cf3ecaab48ce2", "url": "https://github.com/palantir/atlasdb/commit/dca56388bb55ad92079212b17f9cf3ecaab48ce2", "message": "test", "committedDate": "2020-06-15T14:44:55Z", "type": "commit"}, {"oid": "9af643923fc1c5a3aa441d6fee509be3ebedfe4f", "url": "https://github.com/palantir/atlasdb/commit/9af643923fc1c5a3aa441d6fee509be3ebedfe4f", "message": "remove redundant code", "committedDate": "2020-06-15T14:47:01Z", "type": "commit"}, {"oid": "a428ab0835ef948a195602235948eb7a29fb96d9", "url": "https://github.com/palantir/atlasdb/commit/a428ab0835ef948a195602235948eb7a29fb96d9", "message": "Use namedThreadFactory", "committedDate": "2020-06-15T14:54:00Z", "type": "commit"}, {"oid": "ba03d437476626de78a31a11b9cc9e8d3fdba6e9", "url": "https://github.com/palantir/atlasdb/commit/ba03d437476626de78a31a11b9cc9e8d3fdba6e9", "message": "Test fixes", "committedDate": "2020-06-15T16:08:36Z", "type": "commit"}, {"oid": "f905f38ba864c086d18c433f75780c28637cf323", "url": "https://github.com/palantir/atlasdb/commit/f905f38ba864c086d18c433f75780c28637cf323", "message": "Add generated changelog entries", "committedDate": "2020-06-15T16:08:36Z", "type": "commit"}, {"oid": "0c6ef06b0ee3f61abd95312acd60b0f322341be4", "url": "https://github.com/palantir/atlasdb/commit/0c6ef06b0ee3f61abd95312acd60b0f322341be4", "message": "Fix tests", "committedDate": "2020-06-15T16:57:02Z", "type": "commit"}, {"oid": "feed0d86033831b9a63a27a1544583f653a9499e", "url": "https://github.com/palantir/atlasdb/commit/feed0d86033831b9a63a27a1544583f653a9499e", "message": "Merge branch 'feedback_!' of github.com:palantir/atlasdb into feedback_!", "committedDate": "2020-06-15T17:13:49Z", "type": "commit"}, {"oid": "ba1ff5097397c0abe6ad083e08d79c24e957b8ac", "url": "https://github.com/palantir/atlasdb/commit/ba1ff5097397c0abe6ad083e08d79c24e957b8ac", "message": "Minor refactor", "committedDate": "2020-06-15T17:40:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM1OTkxNQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440359915", "bodyText": "We might want a timelock one for completeness?", "author": "jeremyk-91", "createdAt": "2020-06-15T18:17:30Z", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -440,6 +441,65 @@ public void keyValueServiceMetricsDoNotContainUserAgent() {\n                 .anyMatch(metricName -> metricName.contains(USER_AGENT_NAME)), is(false));\n     }\n \n+    @Test\n+    public void serviceNameIsFetchedFromAtlasConfig() {\n+        KeyValueServiceConfig kvs = new InMemoryAtlasDbConfig();\n+        AtlasDbConfig atlasDbConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(kvs)\n+                .namespace(Optional.of(\"namespace\"))\n+                .build();\n+        MetricRegistry metrics = new MetricRegistry();\n+        TransactionManagers transactionManagers = TransactionManagers.builder()\n+                .config(atlasDbConfig)\n+                .userAgent(USER_AGENT)\n+                .globalMetricsRegistry(metrics)\n+                .globalTaggedMetricRegistry(DefaultTaggedMetricRegistry.getDefault())\n+                .registrar(environment)\n+                .build();\n+\n+        assertThat(transactionManagers.getServiceName()).isEqualTo(\"namespace\");\n+    }\n+\n+    @Test\n+    public void serviceNameIsFetchedFromKvsConfigWhenItIsNotPresentInAtlasConfig() {\n+        KeyValueServiceConfig kvs = mock(KeyValueServiceConfig.class);\n+        when(kvs.type()).thenReturn(\"memory\");\n+        when(kvs.namespace()).thenReturn(Optional.of(\"namespace\"));\n+        when(kvs.concurrentGetRangesThreadPoolSize()).thenReturn(1);\n+\n+        AtlasDbConfig atlasDbConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(kvs)\n+                .build();\n+        MetricRegistry metrics = new MetricRegistry();\n+        TransactionManagers transactionManagers = TransactionManagers.builder()\n+                .config(atlasDbConfig)\n+                .userAgent(USER_AGENT)\n+                .globalMetricsRegistry(metrics)\n+                .globalTaggedMetricRegistry(DefaultTaggedMetricRegistry.getDefault())\n+                .registrar(environment)\n+                .build();\n+\n+        assertThat(transactionManagers.getServiceName()).isEqualTo(\"namespace\");\n+    }", "originalCommit": "ba1ff5097397c0abe6ad083e08d79c24e957b8ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MzQyOQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440743429", "bodyText": "This is hard to write because the migrator tries to reach to timeLock servers.", "author": "sudiksha27", "createdAt": "2020-06-16T10:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM1OTkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDMxNw==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440360317", "bodyText": "Did we need this? I think it would be a break if it turned out that we must specify a client", "author": "jeremyk-91", "createdAt": "2020-06-15T18:18:15Z", "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/TimeLockTestUtils.java", "diffHunk": "@@ -76,6 +76,7 @@ static TransactionManagerContext createTransactionManager(\n                                 .servers(serverUris)\n                                 .sslConfiguration(SslConfiguration.of(Paths.get(\"var/security/trustStore.jks\")))\n                                 .build())\n+                        .client(Optional.of(agent))", "originalCommit": "ba1ff5097397c0abe6ad083e08d79c24e957b8ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMjM2MQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440422361", "bodyText": "So, the problem is highlighted by this line - config().timelock().map(TimeLockClientConfig::getClientOrThrow). If timeLockConfig is present then client must be present otherwise, if we try to fetch the client, we throw this SafeIllegalStateEx - \"Tried to read a client from a TimeLockClientConfig, but it hadn't been initialised.\"", "author": "sudiksha27", "createdAt": "2020-06-15T20:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDMxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMDYxMQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440710611", "bodyText": "Ah, this is a break then. Can you see a way around this?", "author": "jeremyk-91", "createdAt": "2020-06-16T09:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDMxNw=="}], "type": "inlineReview"}, {"oid": "9dd1e170206aaa5341e7907a77450f2c1cfb9b94", "url": "https://github.com/palantir/atlasdb/commit/9dd1e170206aaa5341e7907a77450f2c1cfb9b94", "message": "Add TimeLock feedback task to list of closeables", "committedDate": "2020-06-15T18:50:29Z", "type": "commit"}, {"oid": "b41771d60e804f411eadd9a1f7477c7ca5e99cbf", "url": "https://github.com/palantir/atlasdb/commit/b41771d60e804f411eadd9a1f7477c7ca5e99cbf", "message": "Add test + register closeable", "committedDate": "2020-06-15T19:27:44Z", "type": "commit"}, {"oid": "94a51e93b1c894367cfae7c25c3a8f5c705788c7", "url": "https://github.com/palantir/atlasdb/commit/94a51e93b1c894367cfae7c25c3a8f5c705788c7", "message": "Use client and not throw", "committedDate": "2020-06-16T10:04:50Z", "type": "commit"}, {"oid": "459c7c2ce30ed422f851922b4d19cdc7b27296fc", "url": "https://github.com/palantir/atlasdb/commit/459c7c2ce30ed422f851922b4d19cdc7b27296fc", "message": "Fix tests | checkstyle", "committedDate": "2020-06-16T10:11:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0MDk4OQ==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440740989", "bodyText": "move to bckTask", "author": "sudiksha27", "createdAt": "2020-06-16T10:13:49Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/Constants.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+public class Constants {\n+    private Constants () {\n+        // no op\n+    }\n+\n+    public static final String TIMELOCK_FEEDBACK_THREAD_PREFIX = \"TimeLockFeedbackBackgroundTask\";\n+    public static final long TIMELOCK_CLIENT_FEEDBACK_INTERVAL_SECONDS = 30;\n+}", "originalCommit": "459c7c2ce30ed422f851922b4d19cdc7b27296fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f9e53092df00a83e8cd303dce7488262a2e617c1", "url": "https://github.com/palantir/atlasdb/commit/f9e53092df00a83e8cd303dce7488262a2e617c1", "message": "resolve comment", "committedDate": "2020-06-16T10:15:04Z", "type": "commit"}, {"oid": "2ed5126dd4457665a05cc64276833164aa63ccde", "url": "https://github.com/palantir/atlasdb/commit/2ed5126dd4457665a05cc64276833164aa63ccde", "message": "Remove redundant code", "committedDate": "2020-06-16T10:17:10Z", "type": "commit"}, {"oid": "9a396a9949252001762f5fe73e3d917bad425e34", "url": "https://github.com/palantir/atlasdb/commit/9a396a9949252001762f5fe73e3d917bad425e34", "message": "Make logger static", "committedDate": "2020-06-16T10:19:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc1MjEwMA==", "url": "https://github.com/palantir/atlasdb/pull/4833#discussion_r440752100", "bodyText": "nit: This should be static, there's no reason each instance needs a different copy of this", "author": "jeremyk-91", "createdAt": "2020-06-16T10:34:39Z", "path": "lock-api/src/main/java/com/palantir/lock/client/metrics/TimeLockFeedbackBackgroundTask.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client.metrics;\n+\n+\n+import java.time.Duration;\n+import java.util.UUID;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.palantir.common.concurrent.NamedThreadFactory;\n+import com.palantir.common.concurrent.PTExecutors;\n+import com.palantir.lock.client.ConjureTimelockServiceBlockingMetrics;\n+import com.palantir.logsafe.SafeArg;\n+import com.palantir.timelock.feedback.ConjureTimeLockClientFeedback;\n+import com.palantir.timelock.feedback.EndpointStatistics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public final class TimeLockFeedbackBackgroundTask implements AutoCloseable {\n+    private static final Logger log = LoggerFactory.getLogger(\n+            TimeLockFeedbackBackgroundTask.class);\n+    private static final String TIMELOCK_FEEDBACK_THREAD_PREFIX = \"TimeLockFeedbackBackgroundTask\";\n+    private final ScheduledExecutorService executor = PTExecutors.newSingleThreadScheduledExecutor(\n+                    new NamedThreadFactory(TIMELOCK_FEEDBACK_THREAD_PREFIX, true));\n+\n+    private final UUID nodeId = UUID.randomUUID();\n+    private final Duration timeLockClientFeedbackReportInterval = Duration.ofSeconds(30);", "originalCommit": "9a396a9949252001762f5fe73e3d917bad425e34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7b5379c7b4559529d3d781ab694a044b87010ed", "url": "https://github.com/palantir/atlasdb/commit/c7b5379c7b4559529d3d781ab694a044b87010ed", "message": "Address comment", "committedDate": "2020-06-16T13:11:50Z", "type": "commit"}]}