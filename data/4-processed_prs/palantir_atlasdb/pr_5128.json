{"pr_number": 5128, "pr_title": "[Cross Client Batching LeaderTimes - 3b] | AtlasDb accepts external request batcher for LeaderTime api", "pr_createdAt": "2020-11-24T13:23:07Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5128", "timeline": [{"oid": "8adc98b47ee30af809c95b2f241bc6dd990cb377", "url": "https://github.com/palantir/atlasdb/commit/8adc98b47ee30af809c95b2f241bc6dd990cb377", "message": "BatcherProviders - Wip", "committedDate": "2020-11-24T13:06:57Z", "type": "commit"}, {"oid": "983488eaeea3b260ee44e1a3f20fbe834ea2bbb5", "url": "https://github.com/palantir/atlasdb/commit/983488eaeea3b260ee44e1a3f20fbe834ea2bbb5", "message": "Fix build", "committedDate": "2020-11-24T13:07:21Z", "type": "commit"}, {"oid": "993513e0a75ece7747cf1e26607559233b53c0f2", "url": "https://github.com/palantir/atlasdb/commit/993513e0a75ece7747cf1e26607559233b53c0f2", "message": "Fix tests", "committedDate": "2020-11-24T13:07:45Z", "type": "commit"}, {"oid": "d0f171f143cb9dfd22397ea344b722f22c559e8b", "url": "https://github.com/palantir/atlasdb/commit/d0f171f143cb9dfd22397ea344b722f22c559e8b", "message": "Change signature", "committedDate": "2020-11-24T13:07:54Z", "type": "commit"}, {"oid": "f7a8a47a57c0a60f5cfbc313f9ad2f4390cb8623", "url": "https://github.com/palantir/atlasdb/commit/f7a8a47a57c0a60f5cfbc313f9ad2f4390cb8623", "message": "Modify batcherProvider api", "committedDate": "2020-11-24T13:08:23Z", "type": "commit"}, {"oid": "1633b993975cf87116fa041359bd3c592f215b64", "url": "https://github.com/palantir/atlasdb/commit/1633b993975cf87116fa041359bd3c592f215b64", "message": "Update service", "committedDate": "2020-11-24T13:12:10Z", "type": "commit"}, {"oid": "564abd0687718a227d586532742f8744e83ec8ec", "url": "https://github.com/palantir/atlasdb/commit/564abd0687718a227d586532742f8744e83ec8ec", "message": "Add generated changelog entries", "committedDate": "2020-11-24T13:12:10Z", "type": "commit"}, {"oid": "7a75921b2114f38755e89f80012a623d62119ed2", "url": "https://github.com/palantir/atlasdb/commit/7a75921b2114f38755e89f80012a623d62119ed2", "message": "Add generated changelog entries", "committedDate": "2020-11-24T13:12:10Z", "type": "commit"}, {"oid": "e44794a9f0dcdaeefc490d8351ea6866effb7093", "url": "https://github.com/palantir/atlasdb/commit/e44794a9f0dcdaeefc490d8351ea6866effb7093", "message": "Refactor", "committedDate": "2020-11-25T12:12:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NTM0OQ==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r530365349", "bodyText": "wow, it really needs this type hint to work? Funky", "author": "Jolyon-S", "createdAt": "2020-11-25T13:15:12Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1223,24 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+        return timelockRequestBatcherProviders\n+                .map(TimeLockRequestBatcherProviders::leaderTimeBatcherProvider)\n+                .map(provider -> provider.getBatcher(getMultiClientTimelockServiceSupplier(serviceProvider)))\n+                .<LeaderTimeGetter>map(batcher -> new NamespacedCoalescingLeaderTimeGetter(timelockNamespace, batcher))", "originalCommit": "e44794a9f0dcdaeefc490d8351ea6866effb7093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NzMwNg==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r530367306", "bodyText": "Feels a bit weird - very specific arg but generic return type. I wonder what thoughts are on making this:\nT getBatcher(Supplier<K> service);\nI can see pros and cons both ways. However, if you want to keep this param as is, maybe I'd be a bit more specific on the name (MultiClientBatchProvider? TimelockBatchProvider? idk).", "author": "Jolyon-S", "createdAt": "2020-11-25T13:18:27Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/BatcherProvider.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import com.palantir.lock.client.InternalMultiClientConjureTimelockService;\n+import java.util.function.Supplier;\n+\n+public interface BatcherProvider<T> {\n+    T getBatcher(Supplier<InternalMultiClientConjureTimelockService> multiClientConjureTimelockService);", "originalCommit": "e44794a9f0dcdaeefc490d8351ea6866effb7093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "900a52846f52b2ccd110ebfd669026efe342ab28", "url": "https://github.com/palantir/atlasdb/commit/900a52846f52b2ccd110ebfd669026efe342ab28", "message": "Rename", "committedDate": "2020-11-25T13:25:14Z", "type": "commit"}, {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1", "url": "https://github.com/palantir/atlasdb/commit/1fbb29133a5942a9395307918be66cdbb1aad0b1", "message": "Spotless", "committedDate": "2020-11-25T13:28:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MTE5NQ==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532481195", "bodyText": "This broadly makes sense. As a matter of style I'd probably write this imperatively as there is a fair bit to take in, but this is fine if you prefer.", "author": "jeremyk-91", "createdAt": "2020-11-30T10:11:44Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1223,24 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+        return timelockRequestBatcherProviders\n+                .map(TimeLockRequestBatcherProviders::leaderTimeBatcherProvider)\n+                .map(provider -> provider.getBatcher(getMultiClientTimelockServiceSupplier(serviceProvider)))\n+                .<LeaderTimeGetter>map(batcher -> new NamespacedCoalescingLeaderTimeGetter(timelockNamespace, batcher))", "originalCommit": "1fbb29133a5942a9395307918be66cdbb1aad0b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MjI5NQ==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532482295", "bodyText": "nit: probably want articles i.e. on line 3, configured by its clients to use a custom request batcher; line 5, in the absence of a custom batcher, we fall back to a legacy leaderTime request coalescing batcher.", "author": "jeremyk-91", "createdAt": "2020-11-30T10:13:32Z", "path": "changelog/@unreleased/pr-5128.v2.yml", "diffHunk": "@@ -0,0 +1,7 @@\n+type: feature\n+feature:\n+  description: AtlasDb can now be configured by its clients to use custom request\n+    batcher for batching requests to leaderTime api on Timelock. In the absence of\n+    custom batcher, we fall back to legacy leaderTime request coalescing batcher.", "originalCommit": "1fbb29133a5942a9395307918be66cdbb1aad0b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4NTc1Ng==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532485756", "bodyText": "can we name this timelockRequestBatcherProviders for consistency?", "author": "jeremyk-91", "createdAt": "2020-11-30T10:19:06Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -244,6 +252,8 @@ boolean allSafeForLogging() {\n \n     abstract UserAgent userAgent();\n \n+    abstract Optional<TimeLockRequestBatcherProviders> batcherProviders();", "originalCommit": "1fbb29133a5942a9395307918be66cdbb1aad0b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09e5a927d67eeccce4b66ff3b426140720c3772c", "url": "https://github.com/palantir/atlasdb/commit/09e5a927d67eeccce4b66ff3b426140720c3772c", "message": "Address comments", "committedDate": "2020-11-30T10:46:52Z", "type": "commit"}, {"oid": "271514837e3859e1faf84d1f92a79bd55347d9d6", "url": "https://github.com/palantir/atlasdb/commit/271514837e3859e1faf84d1f92a79bd55347d9d6", "message": "Add generated changelog entries", "committedDate": "2020-11-30T10:46:52Z", "type": "commit"}, {"oid": "7781b78ddcfa79ca18979d22d7faed325b908d0c", "url": "https://github.com/palantir/atlasdb/commit/7781b78ddcfa79ca18979d22d7faed325b908d0c", "message": "Add generated changelog entries", "committedDate": "2020-11-30T10:46:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxNzgxMQ==", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532517811", "bodyText": "go to the next line :)", "author": "jeremyk-91", "createdAt": "2020-11-30T11:10:15Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1224,28 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+\n+        if (!timelockRequestBatcherProviders.isPresent()) {\n+            return new LegacyLeaderTimeGetter(namespacedConjureTimelockService);\n+        }\n+\n+        LeaderTimeCoalescingBatcher batcher = timelockRequestBatcherProviders.get()", "originalCommit": "7781b78ddcfa79ca18979d22d7faed325b908d0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3bd74ff2ac8c82832a83e28edb84f9b9f3356055", "url": "https://github.com/palantir/atlasdb/commit/3bd74ff2ac8c82832a83e28edb84f9b9f3356055", "message": "Spotless", "committedDate": "2020-11-30T11:32:23Z", "type": "commit"}]}