{"pr_number": 4874, "pr_title": "Consolidate PTExexutors fixed executor usage into string-based factories", "pr_createdAt": "2020-06-30T15:20:48Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4874", "timeline": [{"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa", "url": "https://github.com/palantir/atlasdb/commit/d9459fae29d52f82a34b1a53d435a1e0a54539fa", "message": "Consolidate PTExexutors fixed executor usage into string-based factories\n\nThis new API will allow us to optimize thread utilization in a\nfuture change without impacting callers.", "committedDate": "2020-06-30T15:18:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3MjQxNA==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447772414", "bodyText": "There's no ThreadFactory passed in.", "author": "jkozlowski", "createdAt": "2020-06-30T15:25:57Z", "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "diffHunk": "@@ -196,13 +196,34 @@ public static ThreadPoolExecutor newFixedThreadPool(int numThreads) {\n      * @return the newly created thread pool\n      * @throws NullPointerException if threadFactory is null\n      * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     * @deprecated Prefer {@link #newFixedThreadPool(int, String)}.\n      */\n+    @Deprecated\n     public static ThreadPoolExecutor newFixedThreadPool(int numThreads, ThreadFactory threadFactory) {\n         return newThreadPoolExecutor(numThreads, numThreads,\n                 DEFAULT_THREAD_POOL_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS,\n                 new LinkedBlockingQueue<Runnable>(), threadFactory);\n     }\n \n+    /**\n+     * Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded\n+     * queue, using the provided ThreadFactory to create new threads when needed.  At any point, at", "originalCommit": "d9459fae29d52f82a34b1a53d435a1e0a54539fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NjI3MA==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447776270", "bodyText": "updated docs.", "author": "carterkozak", "createdAt": "2020-06-30T15:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3MjQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447774463", "bodyText": "Feels like this should have a name?", "author": "jkozlowski", "createdAt": "2020-06-30T15:28:37Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -107,7 +107,7 @@ private AwaitingLeadershipProxy(\n                 \"Unable to create an AwaitingLeadershipProxy with no supplier\");\n         this.delegateSupplier = delegateSupplier;\n         this.leaderElectionService = leaderElectionService;\n-        this.executor = PTExecutors.newSingleThreadExecutor(PTExecutors.newNamedThreadFactory(true));\n+        this.executor = PTExecutors.newSingleThreadExecutor();", "originalCommit": "d9459fae29d52f82a34b1a53d435a1e0a54539fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTQ1OQ==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447775459", "bodyText": "So this will loose daemon threading? @jeremyk-91", "author": "jkozlowski", "createdAt": "2020-06-30T15:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NjI1Nw==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447776257", "bodyText": "This uses the same logic as before, discovering a name based on the call site.", "author": "carterkozak", "createdAt": "2020-06-30T15:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3ODcwMw==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447778703", "bodyText": "This used daemon threads before, and the default is using daemon threads. This one hasn't changed, only the psl threads are changing to daemons.", "author": "carterkozak", "createdAt": "2020-06-30T15:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447775697", "bodyText": "Again, no daemons?", "author": "jkozlowski", "createdAt": "2020-06-30T15:30:08Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogBatchReader.java", "diffHunk": "@@ -40,7 +39,7 @@ public PaxosStateLogBatchReader(PaxosStateLog<V> delegate, Persistable.Hydrator<\n         this.delegate = delegate;\n         this.hydrator = hydrator;\n         this.executor = MoreExecutors.listeningDecorator(\n-                PTExecutors.newFixedThreadPool(numThreads, new NamedThreadFactory(\"psl-reader\", true)));\n+                PTExecutors.newFixedThreadPool(numThreads, \"psl-reader\"));", "originalCommit": "d9459fae29d52f82a34b1a53d435a1e0a54539fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NzM2MA==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447777360", "bodyText": "Yes. this is a change to avoid daemon threads. Do you think non-daemon threads are required here?", "author": "carterkozak", "createdAt": "2020-06-30T15:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MjMyNQ==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447872325", "bodyText": "This one could be either way I think, it's part of the SQLite migration so it blocks startup for timelock, and there'll always be other main threads going around.", "author": "jeremyk-91", "createdAt": "2020-06-30T17:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw=="}], "type": "inlineReview"}, {"oid": "f85420089e8aa6d9e2e2acc833bf784e5f4eaaef", "url": "https://github.com/palantir/atlasdb/commit/f85420089e8aa6d9e2e2acc833bf784e5f4eaaef", "message": "docs", "committedDate": "2020-06-30T15:32:35Z", "type": "commit"}, {"oid": "ca3377786b308cffec1507b6db1226975c508a74", "url": "https://github.com/palantir/atlasdb/commit/ca3377786b308cffec1507b6db1226975c508a74", "message": "Add generated changelog entries", "committedDate": "2020-06-30T15:32:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg2OTg0Mg==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447869842", "bodyText": "Might want to call out (method name? or at least docs) that this is non-daemon since a lot of the other methods in this class seem to use daemon threads", "author": "jeremyk-91", "createdAt": "2020-06-30T17:47:14Z", "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "diffHunk": "@@ -196,13 +196,33 @@ public static ThreadPoolExecutor newFixedThreadPool(int numThreads) {\n      * @return the newly created thread pool\n      * @throws NullPointerException if threadFactory is null\n      * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     * @deprecated Prefer {@link #newFixedThreadPool(int, String)}.\n      */\n+    @Deprecated\n     public static ThreadPoolExecutor newFixedThreadPool(int numThreads, ThreadFactory threadFactory) {\n         return newThreadPoolExecutor(numThreads, numThreads,\n                 DEFAULT_THREAD_POOL_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS,\n                 new LinkedBlockingQueue<Runnable>(), threadFactory);\n     }\n \n+    /**\n+     * Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded\n+     * queue.  At any point, at most <tt>numThreads</tt> threads will be active processing tasks.  If\n+     * additional tasks are submitted when all threads are active, they will wait in the queue until\n+     * a thread is available.  If any thread terminates due to a failure during execution prior to\n+     * shutdown, a new one will take its place if needed to execute subsequent tasks.  The threads\n+     * in the pool will exist until it is explicitly {@link\n+     * ExecutorService#shutdown shutdown}.\n+     *\n+     * @param numThreads the number of threads in the pool\n+     * @param name Executor name used for thread naming and instrumentation\n+     * @return the newly created thread pool\n+     * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     */\n+    public static ThreadPoolExecutor newFixedThreadPool(int numThreads, String name) {\n+        return newFixedThreadPool(numThreads, new NamedThreadFactory(name));", "originalCommit": "ca3377786b308cffec1507b6db1226975c508a74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MDM2MA==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447870360", "bodyText": "This one seems a bit suspicious - we're changing it to be non-daemon, and there doesn't seem to be anything that shuts down the executor service anywhere. Do we know/have we tested if timelock will shut down gracefully?", "author": "jeremyk-91", "createdAt": "2020-06-30T17:48:09Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/LeaderPingHealthCheck.java", "diffHunk": "@@ -51,7 +50,7 @@ public LeaderPingHealthCheck(\n         this.pingers = pingers;\n         this.executorService = PTExecutors.newFixedThreadPool(\n                 pingers.size(),\n-                new NamedThreadFactory(\"leader-ping-healthcheck\", true));\n+                \"leader-ping-healthcheck\");", "originalCommit": "ca3377786b308cffec1507b6db1226975c508a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NTI3Mw==", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447875273", "bodyText": "Ah, I had though the default NamedThreadFactory ctor used daemon threads, but that was incorrect. I definitely want this to use daemon threads.\nI don't think we actually want any ptexecutors to use non-daemon threads since they've historically been a source of pain.", "author": "carterkozak", "createdAt": "2020-06-30T17:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MDM2MA=="}], "type": "inlineReview"}, {"oid": "c7becba1d3a6b3d48bdf92d4de05d2ed7a1e1e61", "url": "https://github.com/palantir/atlasdb/commit/c7becba1d3a6b3d48bdf92d4de05d2ed7a1e1e61", "message": "specify daemon", "committedDate": "2020-06-30T17:56:48Z", "type": "commit"}, {"oid": "d3e20de59448d0db25c70ac538354bf3e3376892", "url": "https://github.com/palantir/atlasdb/commit/d3e20de59448d0db25c70ac538354bf3e3376892", "message": "NamedThreadFactory creates daemon threads by default", "committedDate": "2020-06-30T17:57:38Z", "type": "commit"}]}