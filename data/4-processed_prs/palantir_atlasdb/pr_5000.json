{"pr_number": 5000, "pr_title": "[TimeLock] Fix Antiquated cURL Instructions From TimeLock Documentation", "pr_createdAt": "2020-09-24T20:11:56Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5000", "timeline": [{"oid": "d3fe479281db55d5de2de097022fee3ad4634ee1", "url": "https://github.com/palantir/atlasdb/commit/d3fe479281db55d5de2de097022fee3ad4634ee1", "message": "Bad Curls", "committedDate": "2020-09-24T20:03:35Z", "type": "commit"}, {"oid": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "url": "https://github.com/palantir/atlasdb/commit/7340dde662ea4b0cbda448ab4d10144e79b4ad81", "message": "more fixes", "committedDate": "2020-09-24T20:06:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODQ4OA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494618488", "bodyText": "It'd probably be nice to have a callout/reminder that only the leader will respond, and other nodes will return a 308. Adding a -i to the curl was the only thing that tipped me off to the 308, otherwise there's just no output from non-leaders.", "author": "lycarter", "createdAt": "2020-09-24T21:23:07Z", "path": "docs/source/services/timelock_service/manual-migration.rst", "diffHunk": "@@ -79,7 +80,8 @@ To verify that this step was completed correctly, you may curl the Timelock Serv\n \n    .. code:: bash\n \n-      curl -XPOST localhost:8080/test/timestamp/fresh-timestamp\n+      curl -XPOST <protocol>://<host>:<port>/timelock/api/tl/ts/<namespace> \\\n+        --data '{\"numTimestamps\": 1}' -H \"Authorization: Bearer q\" -H \"Content-Type: application/json\"", "originalCommit": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyMzE5OQ==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r496023199", "bodyText": "\ud83d\udc4d  we can say this in the beginning", "author": "gmaretic", "createdAt": "2020-09-28T15:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcyMTU1NA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r506721554", "bodyText": "Yep. I added the -i to display headers to the commands too.", "author": "jeremyk-91", "createdAt": "2020-10-16T21:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODc4Ng==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494618786", "bodyText": "possibly also a reminder about the leader here", "author": "lycarter", "createdAt": "2020-09-24T21:23:51Z", "path": "docs/source/services/timelock_service/reverse-migration.rst", "diffHunk": "@@ -44,10 +44,10 @@ of timestamps across TimeLock and the key-value service backed services is monot\n This can be obtained using ``curl`` as follows. Note that if you obtain an HTTP 503 error, this is because you curled a\n node that was not the leader; please try the other nodes.\n \n-.. code-block:: none\n+   .. code:: bash\n \n-   $ curl -XPOST https://<timelock-host>:8421/timelock/api/client/timestamp/fresh-timestamp\n-   123456789\n+      curl -XPOST <protocol>://<host>:<port>/timelock/api/tl/ts/<namespace> \\\n+        --data '{\"numTimestamps\": 1}' -H \"Authorization: Bearer q\" -H \"Content-Type: application/json\"", "originalCommit": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMDUzMA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r496030530", "bodyText": "The reminder is directly above", "author": "gmaretic", "createdAt": "2020-09-28T15:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcyMTk1MA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r506721950", "bodyText": "I think Grgur means below, but yep", "author": "jeremyk-91", "createdAt": "2020-10-16T21:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxODc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxOTg5NA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494619894", "bodyText": "For this endpoint I received a 308, not 503", "author": "lycarter", "createdAt": "2020-09-24T21:26:09Z", "path": "docs/source/services/timelock_service/service-management.rst", "diffHunk": "@@ -33,7 +33,8 @@ less than the fresh timestamp. This may be obtained through the fresh timestamp\n \n .. code:: bash\n \n-      curl -XPOST localhost:8080/timelock/api/old_namespace/timelock/fresh-timestamp\n+    curl -XPOST https://localhost:8421/timelock/api/tl/ts/old_namespace \\\n+      --data '{\"numTimestamps\": 1}' -H \"Authorization: Bearer q\" -H \"Content-Type: application/json\"\n \n A cluster of TimeLock servers elects a single leader, so if you contact a node that is not the leader you'll receive a\n ``NotCurrentLeaderException`` and an HTTP 503. In this case, try the same request on other nodes until you find the", "originalCommit": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4MzUzMQ==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494883531", "bodyText": "Ah, good catch. Yeah, I'll edit this: it can be either - you get a 503 if the node is not the leader but doesn't know who the leader is, but we more recently added 308 for cases where we do know who the leader is", "author": "jeremyk-91", "createdAt": "2020-09-25T10:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxOTg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMTY4MA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r496031680", "bodyText": "Also make sure you update the info / add the correct info on the other two commented places", "author": "gmaretic", "createdAt": "2020-09-28T15:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxOTg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMDE4MQ==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494620181", "bodyText": "here you refer directly to https and localhost while in other files you refer to <protocol> and <host> - probably best to be consistent?", "author": "lycarter", "createdAt": "2020-09-24T21:26:46Z", "path": "docs/source/services/timelock_service/service-management.rst", "diffHunk": "@@ -49,7 +50,7 @@ on TimeLock.\n \n .. code:: bash\n \n-      curl -XPOST localhost:8080/timelock/api/new_namespace/timestamp-management/fast-forward?currentTimestamp=TS\n+      curl -XPOST https://localhost:8421/timelock/api/new_namespace/timestamp-management/fast-forward?currentTimestamp=TS", "originalCommit": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMDc1NA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494620754", "bodyText": "As an unrelated comment, it is a bit surprising to me that this method is unauth'd - wouldn't this cause an issue if the endpoint was called with MAX_LONG?", "author": "lycarter", "createdAt": "2020-09-24T21:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMDE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg4NDYyMw==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r494884623", "bodyText": "Yeah, will switch to host/port.\nYou're right that there is an issue with long max. However, internally we configure our proxies so that this method is never exposed in a way where it can be called from non-Palantir applications, so that's why this hasn't been prioritised.", "author": "jeremyk-91", "createdAt": "2020-09-25T10:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMDE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyODQ1OA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r496028458", "bodyText": "Does this page even serve a purpose now?", "author": "gmaretic", "createdAt": "2020-09-28T15:16:05Z", "path": "docs/source/services/timelock_service/product-changes.rst", "diffHunk": "@@ -6,17 +6,4 @@ Developing a product to use the timelock service\n All products deploying against the AtlasDB Timelock service should adhere to the following checklist.", "originalCommit": "7340dde662ea4b0cbda448ab4d10144e79b4ad81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcyMjY4NA==", "url": "https://github.com/palantir/atlasdb/pull/5000#discussion_r506722684", "bodyText": "I guess it still does for things in large internal product ecosystem...", "author": "jeremyk-91", "createdAt": "2020-10-16T21:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyODQ1OA=="}], "type": "inlineReview"}, {"oid": "7d0562ed487b615089cbf41635c53fd5d8571924", "url": "https://github.com/palantir/atlasdb/commit/7d0562ed487b615089cbf41635c53fd5d8571924", "message": "Fix", "committedDate": "2020-10-16T21:10:18Z", "type": "commit"}]}