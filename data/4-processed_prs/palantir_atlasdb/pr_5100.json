{"pr_number": 5100, "pr_title": "[LW] Filter out locks using the serverToken, not the fake token in LeasedLockToken", "pr_createdAt": "2020-11-05T10:42:58Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5100", "timeline": [{"oid": "6b908f20529c46b3bc5fa6220d6eee30e574a835", "url": "https://github.com/palantir/atlasdb/commit/6b908f20529c46b3bc5fa6220d6eee30e574a835", "message": "actually filter out the right token", "committedDate": "2020-11-05T10:40:00Z", "type": "commit"}, {"oid": "db7fe6271790c889988405a3490b5885ab2863e9", "url": "https://github.com/palantir/atlasdb/commit/db7fe6271790c889988405a3490b5885ab2863e9", "message": "Add generated changelog entries", "committedDate": "2020-11-05T10:40:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk1NTMwNA==", "url": "https://github.com/palantir/atlasdb/pull/5100#discussion_r517955304", "bodyText": "this shows that LOCK_EVENT is filtered out, which contains DESCRIPTOR_3, whereas LOCK_EVENT_2 is present, with DESCRIPTOR present.", "author": "Jolyon-S", "createdAt": "2020-11-05T10:44:21Z", "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -391,6 +398,28 @@ public void newEventsCauseOldEventsToBeDeleted() {\n         verifyStage();\n     }\n \n+    @Test\n+    public void commitLocksAreCorrectlyFilteredOutUsingServerToken() {\n+        setupInitialState();\n+        eventCache.processStartTransactionsUpdate(ImmutableSet.of(), SUCCESS);\n+\n+        // simulates the actual lock token that the client receives\n+        ConjureLockToken serverToken = ConjureLockToken.of(COMMIT_TOKEN.getRequestId());\n+        LockToken commitToken = LeasedLockTokenCreator.of(\n+                serverToken,\n+                Lease.of(LeaderTime.of(LeadershipId.random(), NanoTime.createForTests(1L)), Duration.ZERO));\n+        eventCache.processGetCommitTimestampsUpdate(\n+                ImmutableSet.of(ImmutableTransactionUpdate.builder()\n+                        .commitTs(5L)\n+                        .startTs(START_TS)\n+                        .writesToken(commitToken)\n+                        .build()),\n+                SUCCESS_2);\n+\n+        assertThat(eventCache.getCommitUpdate(START_TS).accept(new CommitUpdateVisitor()))\n+                .containsExactlyInAnyOrder(DESCRIPTOR);", "originalCommit": "6b908f20529c46b3bc5fa6220d6eee30e574a835", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44980e5f9c28bcef4c3302de04c1012dc3c54998", "url": "https://github.com/palantir/atlasdb/commit/44980e5f9c28bcef4c3302de04c1012dc3c54998", "message": "force circle", "committedDate": "2020-11-05T17:26:53Z", "type": "commit"}, {"oid": "0e447cbec24d32a3f06609e74e5ad1b4cf5c7f3c", "url": "https://github.com/palantir/atlasdb/commit/0e447cbec24d32a3f06609e74e5ad1b4cf5c7f3c", "message": "revert change", "committedDate": "2020-11-05T17:27:38Z", "type": "commit"}, {"oid": "d6f310ef6f39068edba1086cf3817aea9e001334", "url": "https://github.com/palantir/atlasdb/commit/d6f310ef6f39068edba1086cf3817aea9e001334", "message": "remove bad test", "committedDate": "2020-11-06T11:56:59Z", "type": "commit"}, {"oid": "95c2696c0411b1c5cc39598b09f4e2265cc415a7", "url": "https://github.com/palantir/atlasdb/commit/95c2696c0411b1c5cc39598b09f4e2265cc415a7", "message": "Merge branch 'develop' into lw/lease-lock-token", "committedDate": "2020-11-06T12:51:05Z", "type": "commit"}]}