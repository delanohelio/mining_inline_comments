{"pr_number": 4940, "pr_title": "Merge some per-txn-manager thread pools into shared thread pools", "pr_createdAt": "2020-08-12T17:27:18Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4940", "timeline": [{"oid": "d773f873586d45d4f8575f53773e2b113f43045b", "url": "https://github.com/palantir/atlasdb/commit/d773f873586d45d4f8575f53773e2b113f43045b", "message": "Merge some per-txn-manager thread pools into shared thread pools\n\nAs of now, the thread pools I merge are responsible for around 480\nthreads on production stacks I've looked at. Each of them is doing some\nmenial task that probably doesn't need to be done in parallel, but needs\nscheduling.\n\nShared scheduled thread pools are hard to get right, so instead we just\nshare between tasks with the same type. We therefore take 8 thread pools\n(480 threads) and replace with 8 threads.\n\nGiven the durations of tasks, this shouldn't affect top end performance\na whole lot.", "committedDate": "2020-08-12T17:25:02Z", "type": "commit"}, {"oid": "ef50ed46e45a1ef97291c8d055f5282b44d976fa", "url": "https://github.com/palantir/atlasdb/commit/ef50ed46e45a1ef97291c8d055f5282b44d976fa", "message": "Fixes", "committedDate": "2020-08-12T17:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MTAzMw==", "url": "https://github.com/palantir/atlasdb/pull/4940#discussion_r470161033", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    task = executor.scheduleWithFixedDelay(() -> {\n          \n          \n            \n                    ret.task = executor.scheduleWithFixedDelay(() -> {", "author": "carterkozak", "createdAt": "2020-08-13T18:29:24Z", "path": "lock-api/src/main/java/com/palantir/lock/client/LockRefreshingLockService.java", "diffHunk": "@@ -42,16 +43,18 @@\n public final class LockRefreshingLockService extends SimplifyingLockService {\n     public static final int REFRESH_BATCH_SIZE = 500_000;\n     private static final Logger log = LoggerFactory.getLogger(LockRefreshingLockService.class);\n+    private static final ScheduledExecutorService executor =\n+            PTExecutors.newScheduledThreadPool(1, PTExecutors.newNamedThreadFactory(true));\n \n     final LockService delegate;\n     final Set<LockRefreshToken> toRefresh;\n-    final ScheduledExecutorService exec;\n     final long refreshFrequencyMillis = 5000;\n+    ScheduledFuture<?> task;\n     volatile boolean isClosed = false;\n \n     public static LockRefreshingLockService create(LockService delegate) {\n         final LockRefreshingLockService ret = new LockRefreshingLockService(delegate);\n-        ret.exec.scheduleWithFixedDelay(() -> {\n+        task = executor.scheduleWithFixedDelay(() -> {", "originalCommit": "ef50ed46e45a1ef97291c8d055f5282b44d976fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "882dfef2f42d2409eb8a5cce47536318b1a256ba", "url": "https://github.com/palantir/atlasdb/commit/882dfef2f42d2409eb8a5cce47536318b1a256ba", "message": "Update lock-api/src/main/java/com/palantir/lock/client/LockRefreshingLockService.java", "committedDate": "2020-08-14T11:00:30Z", "type": "commit"}, {"oid": "f9b66e9979de96970a1a95e28f2473c23f6ca91d", "url": "https://github.com/palantir/atlasdb/commit/f9b66e9979de96970a1a95e28f2473c23f6ca91d", "message": "Add generated changelog entries", "committedDate": "2020-08-14T11:00:30Z", "type": "commit"}, {"oid": "bd407e712cb00d84153b53a38c87d4aece627802", "url": "https://github.com/palantir/atlasdb/commit/bd407e712cb00d84153b53a38c87d4aece627802", "message": "Merge branch 'develop' of github.com:palantir/atlasdb into jbaker/delete_some_threads", "committedDate": "2020-09-02T09:22:59Z", "type": "commit"}]}