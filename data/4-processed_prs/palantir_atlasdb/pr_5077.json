{"pr_number": 5077, "pr_title": "[DB TimeLock] 3Q - Simplify DbTimestampCreationSetting To Only Apply To DB TimeLock", "pr_createdAt": "2020-10-22T16:59:53Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5077", "timeline": [{"oid": "2b130ba59220382da56c3410b02c107a9f2a2b83", "url": "https://github.com/palantir/atlasdb/commit/2b130ba59220382da56c3410b02c107a9f2a2b83", "message": "[DB TimeLock] 3Q - Pay Down Tech Debt", "committedDate": "2020-10-22T16:54:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3MDE2MQ==", "url": "https://github.com/palantir/atlasdb/pull/5077#discussion_r511870161", "bodyText": "nit: inline?", "author": "sudiksha27", "createdAt": "2020-10-26T10:49:08Z", "path": "atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java", "diffHunk": "@@ -95,49 +91,26 @@ public ManagedTimestampService createManagedTimestampService(\n                 rawKvs.getClass());\n         ConnectionManagerAwareDbKvs dbkvs = (ConnectionManagerAwareDbKvs) rawKvs;\n \n-        return PersistentTimestampServiceImpl.create(createTimestampBoundStore(creationParameters, dbkvs));\n+        return PersistentTimestampServiceImpl.create(createTimestampBoundStore(tableReferenceOverride, dbkvs));\n     }\n \n     private static InDbTimestampBoundStore createTimestampBoundStore(\n-            Optional<DbTimestampCreationSetting> creationParameters, ConnectionManagerAwareDbKvs dbkvs) {\n-        return creationParameters\n-                .map(params -> DbTimestampCreationSettings.caseOf(params)\n-                        .multipleSeries((table, series) -> multiSeries(dbkvs, table, series))\n-                        .singleSeries(table -> singleSeries(dbkvs, table)))\n-                .orElseGet(() -> defaultTimestampBoundStore(dbkvs));\n-    }\n-\n-    private static InDbTimestampBoundStore singleSeries(\n-            ConnectionManagerAwareDbKvs dbkvs, Optional<TableReference> tableRef) {\n+            Optional<TableReference> tableRef, ConnectionManagerAwareDbKvs dbkvs) {\n         // Not using the table prefix here, as the tableRef should contain any necessary prefix.\n         return tableRef.map(reference -> InDbTimestampBoundStore.create(dbkvs.getConnectionManager(), reference))\n                 .orElseGet(() -> defaultTimestampBoundStore(dbkvs));\n     }\n \n-    private static InDbTimestampBoundStore multiSeries(\n-            ConnectionManagerAwareDbKvs dbkvs, TableReference tableRef, TimestampSeries series) {\n-        return InDbTimestampBoundStore.createForMultiSeries(dbkvs.getConnectionManager(), tableRef, series);\n-    }\n-\n     private static InDbTimestampBoundStore defaultTimestampBoundStore(ConnectionManagerAwareDbKvs dbkvs) {\n         return InDbTimestampBoundStore.create(\n                 dbkvs.getConnectionManager(), defaultTimestampTable(), defaultTablePrefix(dbkvs));\n     }\n \n     @Override\n     public TimestampStoreInvalidator createTimestampStoreInvalidator(\n-            KeyValueService rawKvs, Optional<DbTimestampCreationSetting> creationParameters) {\n+            KeyValueService rawKvs, Optional<TableReference> tableReference) {\n         ConnectionManagerAwareDbKvs dbkvs = (ConnectionManagerAwareDbKvs) rawKvs;\n-        return creationParameters\n-                .map(params -> DbTimestampCreationSettings.caseOf(params)\n-                        .singleSeries(table -> timestampStoreInvalidator(dbkvs, table))\n-                        .otherwise(() -> {\n-                            throw new SafeIllegalStateException(\n-                                    \"Invalidator must only be called by embedded DB timeLock that \"\n-                                            + \"does not support multi series timestamp store. This is unexpected, \"\n-                                            + \"please contact support.\");\n-                        }))\n-                .orElseGet(() -> timestampStoreInvalidator(dbkvs, Optional.empty()));\n+        return timestampStoreInvalidator(dbkvs, tableReference);", "originalCommit": "2b130ba59220382da56c3410b02c107a9f2a2b83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3MjEzNg==", "url": "https://github.com/palantir/atlasdb/pull/5077#discussion_r511872136", "bodyText": "Would it be useful to validation checks here i.e. tableReferenceOverride is not DB_TIMELOCK_TIMESTAMP_TABLE?", "author": "sudiksha27", "createdAt": "2020-10-26T10:52:32Z", "path": "atlasdb-dbkvs/src/main/java/com/palantir/atlasdb/keyvalue/dbkvs/DbAtlasDbFactory.java", "diffHunk": "@@ -84,7 +80,7 @@ public KeyValueService createRawKeyValueService(\n \n     @Override\n     public ManagedTimestampService createManagedTimestampService(\n-            KeyValueService rawKvs, Optional<DbTimestampCreationSetting> creationParameters, boolean initializeAsync) {\n+            KeyValueService rawKvs, Optional<TableReference> tableReferenceOverride, boolean initializeAsync) {\n         if (initializeAsync) {", "originalCommit": "2b130ba59220382da56c3410b02c107a9f2a2b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY3MTU1Mg==", "url": "https://github.com/palantir/atlasdb/pull/5077#discussion_r513671552", "bodyText": "Ah, that's a decent call. I think that makes sense", "author": "jeremyk-91", "createdAt": "2020-10-28T18:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3MjEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NzQ2Mw==", "url": "https://github.com/palantir/atlasdb/pull/5077#discussion_r512867463", "bodyText": "Why did we remove this test?", "author": "gmaretic", "createdAt": "2020-10-27T17:01:34Z", "path": "atlasdb-dbkvs-tests/src/test/java/com/palantir/atlasdb/keyvalue/dbkvs/DbTimestampStoreInvalidatorCreationTest.java", "diffHunk": "@@ -75,35 +71,15 @@ public void setUp() {\n         invalidationRunner.createTableIfDoesNotExist();\n     }\n \n-    @Test\n-    public void doesNotInvalidateMultiSeriesTable() {\n-        assertThatThrownBy(() -> storeUpperLimitAndGetTimestampStoreInvalidator(Optional.of(\n-                        DbTimestampCreationSettings.multipleSeries(otherTable, TimestampSeries.of(\"test\")))))\n-                .isInstanceOf(SafeIllegalStateException.class)\n-                .hasMessageContaining(\"Invalidator must only be called by embedded DB timeLock that does not support \"\n-                        + \"multi series timestamp store. This is unexpected, please contact support.\");\n-    }\n-\n     @Test\n     public void canInvalidatorForSingleSeriesTable() {\n-        TimestampStoreInvalidator timestampStoreInvalidator = storeUpperLimitAndGetTimestampStoreInvalidator(\n-                Optional.of(DbTimestampCreationSettings.singleSeries(Optional.of(otherTable))));\n+        TimestampStoreInvalidator timestampStoreInvalidator =\n+                storeUpperLimitAndGetTimestampStoreInvalidator(Optional.of(otherTable));\n         assertThat(timestampStoreInvalidator.backupAndInvalidate()).isEqualTo(TIMESTAMP_1);\n \n         assertBoundNotReadableAfterBeingPoisoned(otherStore);\n     }\n \n-    @Test", "originalCommit": "2b130ba59220382da56c3410b02c107a9f2a2b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY3MTMzOA==", "url": "https://github.com/palantir/atlasdb/pull/5077#discussion_r513671338", "bodyText": "Since the changes you can't physically create a config where single series is not implied. So this test becomes equivalent to invalidatesDefaultTableForEmptyParameters() below it", "author": "jeremyk-91", "createdAt": "2020-10-28T18:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NzQ2Mw=="}], "type": "inlineReview"}, {"oid": "77b7a9a850f66445b206dc2430545d2696f7ae72", "url": "https://github.com/palantir/atlasdb/commit/77b7a9a850f66445b206dc2430545d2696f7ae72", "message": "fix", "committedDate": "2020-10-29T17:31:04Z", "type": "commit"}, {"oid": "8a3d334f7ba1a99530b58637bbfa7fc30a4b6c6e", "url": "https://github.com/palantir/atlasdb/commit/8a3d334f7ba1a99530b58637bbfa7fc30a4b6c6e", "message": "Spotless", "committedDate": "2020-10-29T20:21:04Z", "type": "commit"}, {"oid": "4a8822c375f9dcbfa9921a0bee5b6408afd3a1ac", "url": "https://github.com/palantir/atlasdb/commit/4a8822c375f9dcbfa9921a0bee5b6408afd3a1ac", "message": "fail", "committedDate": "2020-10-29T21:24:39Z", "type": "commit"}]}