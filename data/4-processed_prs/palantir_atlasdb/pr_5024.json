{"pr_number": 5024, "pr_title": "[DB TimeLock] 3B.1 - DB TimeLock Bugfixes and Preparation for MNPTLSIT", "pr_createdAt": "2020-10-12T20:44:56Z", "pr_url": "https://github.com/palantir/atlasdb/pull/5024", "timeline": [{"oid": "f3da1e2e588e0a1e8a83f36f85eef9bcb2808dfb", "url": "https://github.com/palantir/atlasdb/commit/f3da1e2e588e0a1e8a83f36f85eef9bcb2808dfb", "message": "Some progress, still stuck on dbkvs creation path bug", "committedDate": "2020-10-12T15:04:11Z", "type": "commit"}, {"oid": "7a69506ba692b1257702e9576858b72284f981f0", "url": "https://github.com/palantir/atlasdb/commit/7a69506ba692b1257702e9576858b72284f981f0", "message": "what is this", "committedDate": "2020-10-12T20:26:11Z", "type": "commit"}, {"oid": "d22b89792b9aa8f6825e16b727c7a91e9db542db", "url": "https://github.com/palantir/atlasdb/commit/d22b89792b9aa8f6825e16b727c7a91e9db542db", "message": "more things", "committedDate": "2020-10-12T20:26:20Z", "type": "commit"}, {"oid": "05b2a64d4058185527348b0e4c9f0c9f7d34a6ae", "url": "https://github.com/palantir/atlasdb/commit/05b2a64d4058185527348b0e4c9f0c9f7d34a6ae", "message": "baseline", "committedDate": "2020-10-12T20:32:04Z", "type": "commit"}, {"oid": "f7df442263300c0e35a898880d99c7572122e50a", "url": "https://github.com/palantir/atlasdb/commit/f7df442263300c0e35a898880d99c7572122e50a", "message": "nit", "committedDate": "2020-10-12T20:45:12Z", "type": "commit"}, {"oid": "4c866b9fd60588df6a68308013de5ae2a5562fda", "url": "https://github.com/palantir/atlasdb/commit/4c866b9fd60588df6a68308013de5ae2a5562fda", "message": "Add generated changelog entries", "committedDate": "2020-10-12T20:45:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NjAwNA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503766004", "bodyText": "There is some code duplication here, but I don't know if we want to clean that up in this PR or at all.", "author": "sudiksha27", "createdAt": "2020-10-13T08:31:54Z", "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/DbKvsRule.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.net.InetSocketAddress;\n+import java.sql.Connection;\n+import java.util.concurrent.Callable;\n+\n+import org.awaitility.Awaitility;\n+import org.awaitility.Duration;\n+import org.junit.rules.ExternalResource;\n+import org.junit.rules.RuleChain;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+import com.palantir.atlasdb.keyvalue.dbkvs.DbKeyValueServiceConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.ImmutableDbKeyValueServiceConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.ImmutablePostgresDdlConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.impl.ConnectionManagerAwareDbKvs;\n+import com.palantir.conjure.java.api.config.service.HumanReadableDuration;\n+import com.palantir.docker.compose.DockerComposeRule;\n+import com.palantir.docker.compose.configuration.ShutdownStrategy;\n+import com.palantir.docker.compose.connection.Container;\n+import com.palantir.docker.compose.connection.DockerPort;\n+import com.palantir.docker.compose.logging.LogDirectory;\n+import com.palantir.nexus.db.pool.config.ConnectionConfig;\n+import com.palantir.nexus.db.pool.config.ImmutableMaskedValue;\n+import com.palantir.nexus.db.pool.config.ImmutablePostgresConnectionConfig;\n+\n+public class DbKvsRule implements TestRule {\n+    private static final int POSTGRES_PORT = 5432;\n+    private static final int FIVE_SECONDS = 5;\n+\n+    private final DockerComposeRule docker = DockerComposeRule.builder()\n+            .file(\"src/testCommon/resources/docker-compose.yml\")\n+            .waitingForService(\"postgres\", Container::areAllPortsOpen)\n+            .saveLogsTo(LogDirectory.circleAwareLogDirectory(DbKvsRule.class))\n+            .shutdownStrategy(ShutdownStrategy.AGGRESSIVE_WITH_NETWORK_CLEANUP)\n+            .build();\n+\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return RuleChain.outerRule(docker)\n+                .around(new ExternalResource() {\n+                    @Override\n+                    protected void before() {\n+                        waitUntilDbkvsIsUp();\n+                    }\n+\n+                    @Override\n+                    protected void after() {\n+                        // no op\n+                    }\n+                }).apply(base, description);\n+    }\n+\n+    private void waitUntilDbkvsIsUp() {\n+        Awaitility.await()\n+                .atMost(Duration.ONE_MINUTE)\n+                .pollInterval(Duration.ONE_SECOND)\n+                .until(canCreateKeyValueService());\n+    }\n+\n+    private DbKeyValueServiceConfig getKvsConfig() {\n+        DockerPort port = docker.containers()\n+                .container(\"postgres\")\n+                .port(POSTGRES_PORT);\n+\n+        InetSocketAddress postgresAddress = new InetSocketAddress(port.getIp(), port.getExternalPort());\n+\n+        ConnectionConfig connectionConfig = ImmutablePostgresConnectionConfig.builder()\n+                .dbName(\"atlas\")\n+                .dbLogin(\"palantir\")\n+                .dbPassword(ImmutableMaskedValue.of(\"palantir\"))\n+                .host(postgresAddress.getHostName())\n+                .port(postgresAddress.getPort())\n+                .build();\n+\n+        return ImmutableDbKeyValueServiceConfig.builder()\n+                .connection(connectionConfig)\n+                .ddl(ImmutablePostgresDdlConfig.builder()\n+                        .compactInterval(HumanReadableDuration.days(2))\n+                        .build())\n+                .build();\n+    }\n+\n+    private Callable<Boolean> canCreateKeyValueService() {\n+        return () -> {\n+            ConnectionManagerAwareDbKvs kvs = null;\n+            try {\n+                kvs = createKvs();\n+                try (Connection connection = kvs.getConnectionManager().getConnection()) {\n+                    return connection.isValid(FIVE_SECONDS);\n+                }\n+            } catch (Exception ex) {\n+                if (ex.getMessage().contains(\"The connection attempt failed.\")\n+                        || ex.getMessage().contains(\"the database system is starting up\")) {\n+                    return false;\n+                } else {\n+                    throw ex;\n+                }\n+            } finally {\n+                if (kvs != null) {\n+                    kvs.close();\n+                }\n+            }\n+        };\n+    }\n+", "originalCommit": "4c866b9fd60588df6a68308013de5ae2a5562fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MTM4Nw==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503871387", "bodyText": "I think as mentioned in #5025 it does make sense to clean that up (e.g. move this to container test utils), just that I wouldn't prioritise it right now.", "author": "jeremyk-91", "createdAt": "2020-10-13T11:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NjAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2OTM2Nw==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503769367", "bodyText": "Why are we doing this?", "author": "sudiksha27", "createdAt": "2020-10-13T08:36:57Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimestampCreator.java", "diffHunk": "@@ -21,6 +21,11 @@\n import com.palantir.paxos.Client;\n import com.palantir.timestamp.ManagedTimestampService;\n \n-public interface TimestampCreator {\n+public interface TimestampCreator extends AutoCloseable {\n     Supplier<ManagedTimestampService> createTimestampService(Client client, LeaderConfig leaderConfig);\n+\n+    @Override\n+    default void close() {\n+        // Do nothing\n+    }", "originalCommit": "4c866b9fd60588df6a68308013de5ae2a5562fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDU0OA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503874548", "bodyText": "This is overridden in DbTimestampCreator: when the service is shut down, it needs to gracefully close its connections to the key-value-service. Because of encapsulation we (rightly, IMO) don't expose the KVS above the ServiceDiscoveringDatabaseTimeLockSupplier.\nOr do you mean why are we providing a default no-op impl? I don't mind changing that and having PaxosTimestampCreator explicitly say that it does nothing - fine either way.", "author": "jeremyk-91", "createdAt": "2020-10-13T11:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2OTM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3MDQ4OA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504170488", "bodyText": "I meant the latter, apologies it was not clear; I thought it would be good to force overriding close() so it can not be ignored.", "author": "sudiksha27", "createdAt": "2020-10-13T18:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2OTM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMzY4NA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504533684", "bodyText": "I agree with no default here", "author": "gmaretic", "createdAt": "2020-10-14T09:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2OTM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NjIzMg==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504566232", "bodyText": "Cool, added no-op close to PaxosTimestampCreator and removed the default impl. Makes sense", "author": "jeremyk-91", "createdAt": "2020-10-14T10:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2OTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5MzIzOQ==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503793239", "bodyText": "When do we have runtimeConfig?", "author": "sudiksha27", "createdAt": "2020-10-13T09:12:22Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/DbBoundTimestampCreator.java", "diffHunk": "@@ -18,46 +18,45 @@\n import java.util.Optional;\n import java.util.function.Supplier;\n \n-import com.codahale.metrics.MetricRegistry;\n import com.palantir.atlasdb.AtlasDbConstants;\n import com.palantir.atlasdb.config.LeaderConfig;\n-import com.palantir.atlasdb.factory.ServiceDiscoveringAtlasSupplier;\n-import com.palantir.atlasdb.spi.AtlasDbFactory;\n import com.palantir.atlasdb.spi.KeyValueServiceConfig;\n+import com.palantir.atlasdb.spi.KeyValueServiceRuntimeConfig;\n import com.palantir.atlasdb.util.MetricsManager;\n-import com.palantir.logsafe.Preconditions;\n import com.palantir.paxos.Client;\n-import com.palantir.timestamp.DelegatingManagedTimestampService;\n+import com.palantir.timelock.ServiceDiscoveringDatabaseTimeLockSupplier;\n import com.palantir.timestamp.ManagedTimestampService;\n-import com.palantir.timestamp.TimestampManagementService;\n-import com.palantir.timestamp.TimestampService;\n-import com.palantir.tritium.metrics.registry.SharedTaggedMetricRegistries;\n \n-public class DbBoundTimestampCreator implements TimestampCreator {\n+public final class DbBoundTimestampCreator implements TimestampCreator {\n \n-    private KeyValueServiceConfig kvsConfig;\n+    private final ServiceDiscoveringDatabaseTimeLockSupplier serviceDiscoveringDatabaseTimeLockSupplier;\n \n-    public DbBoundTimestampCreator(KeyValueServiceConfig kvsConfig) {\n-        this.kvsConfig = kvsConfig;\n+    private DbBoundTimestampCreator(\n+            ServiceDiscoveringDatabaseTimeLockSupplier serviceDiscoveringDatabaseTimeLockSupplier) {\n+        this.serviceDiscoveringDatabaseTimeLockSupplier = serviceDiscoveringDatabaseTimeLockSupplier;\n+    }\n+\n+    public static TimestampCreator create(\n+            KeyValueServiceConfig kvsConfig,\n+            MetricsManager metricsManager,\n+            Supplier<Optional<KeyValueServiceRuntimeConfig>> kvsRuntimeConfig,\n+            LeaderConfig leaderConfig) {", "originalCommit": "4c866b9fd60588df6a68308013de5ae2a5562fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MDgxOQ==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503870819", "bodyText": "Currently we don't. It's fair to remove it for now, so I will", "author": "jeremyk-91", "createdAt": "2020-10-13T11:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5MzIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5NTY4OA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503795688", "bodyText": "Are we using the kvsConfig OR plan on using it? If so, It might be worth adding a comment otherwise, I am skeptical of passing around the config.", "author": "sudiksha27", "createdAt": "2020-10-13T09:15:59Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/TimeLockManagementResource.java", "diffHunk": "@@ -101,6 +100,9 @@ public static TimeLockManagementService jersey(\n \n     private static Set<PersistentNamespaceLoader> createNamespaceLoaders(\n             PersistentNamespaceContext persistentNamespaceContext) {\n+        if (persistentNamespaceContext.databasePersistence().isPresent()) {\n+            return ImmutableSet.of(new DatabaseNamespaceLoader());\n+        }", "originalCommit": "4c866b9fd60588df6a68308013de5ae2a5562fda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3OTkzNg==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r503879936", "bodyText": "I was originally planning on using it (at some point we should implement support for this in db-timelock as well), though actually it probably won't be enough in that we should use the same KVS as the timestamp creator.\nWill switch to a boolean for now, though this will change again soon.", "author": "jeremyk-91", "createdAt": "2020-10-13T11:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc5NTY4OA=="}], "type": "inlineReview"}, {"oid": "c259af106aab55825e9d11abe4e56a76b69b80e7", "url": "https://github.com/palantir/atlasdb/commit/c259af106aab55825e9d11abe4e56a76b69b80e7", "message": "CR", "committedDate": "2020-10-13T11:44:01Z", "type": "commit"}, {"oid": "6f28e2772fc3a2007e8c6a3ee55c9fc0a432eced", "url": "https://github.com/palantir/atlasdb/commit/6f28e2772fc3a2007e8c6a3ee55c9fc0a432eced", "message": "Merge branch 'jkong/test-rule-for-dbkvs' of github.com:palantir/atlasdb into jkong/test-rule-for-dbkvs", "committedDate": "2020-10-13T11:44:24Z", "type": "commit"}, {"oid": "cdee853fa3437016c0a7879c42962ff4ae599e96", "url": "https://github.com/palantir/atlasdb/commit/cdee853fa3437016c0a7879c42962ff4ae599e96", "message": "fix imports", "committedDate": "2020-10-13T13:03:44Z", "type": "commit"}, {"oid": "9341d05f6309887b0ea288b17f69b6580a4fb3f4", "url": "https://github.com/palantir/atlasdb/commit/9341d05f6309887b0ea288b17f69b6580a4fb3f4", "message": "Add generated changelog entries", "committedDate": "2020-10-13T13:03:44Z", "type": "commit"}, {"oid": "468cc38607ad6174ca5e6f182cf48ad425aa546c", "url": "https://github.com/palantir/atlasdb/commit/468cc38607ad6174ca5e6f182cf48ad425aa546c", "message": "Merge branch 'develop' into jkong/test-rule-for-dbkvs", "committedDate": "2020-10-13T14:13:16Z", "type": "commit"}, {"oid": "2f0abb439d0943e40358ff80dffae67d47d64ebf", "url": "https://github.com/palantir/atlasdb/commit/2f0abb439d0943e40358ff80dffae67d47d64ebf", "message": "fix", "committedDate": "2020-10-13T14:29:25Z", "type": "commit"}, {"oid": "aeda6db14cb3e4103d4be94ea9143c4282b214cf", "url": "https://github.com/palantir/atlasdb/commit/aeda6db14cb3e4103d4be94ea9143c4282b214cf", "message": "unused imports", "committedDate": "2020-10-13T14:50:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyNTE0MQ==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504525141", "bodyText": "Not in scope (?) but the inversion of parameters here and in atlasFactory.createRawKeyValueService is infuriating", "author": "gmaretic", "createdAt": "2020-10-14T09:13:28Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/ServiceDiscoveringAtlasSupplier.java", "diffHunk": "@@ -66,7 +63,7 @@ public ServiceDiscoveringAtlasSupplier(\n             LongSupplier timestampSupplier) {", "originalCommit": "aeda6db14cb3e4103d4be94ea9143c4282b214cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NjY4Nw==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504566687", "bodyText": "Yeah, now's not a good time to touch this class's API (and above)", "author": "jeremyk-91", "createdAt": "2020-10-14T10:21:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyNTE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMjkxMg==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504532912", "bodyText": "This will eventually be implemented?", "author": "gmaretic", "createdAt": "2020-10-14T09:25:37Z", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DatabaseNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.util.Set;\n+\n+import com.palantir.paxos.Client;\n+\n+public class DatabaseNamespaceLoader implements PersistentNamespaceLoader {\n+    @Override\n+    public Set<Client> getAllPersistedNamespaces() {\n+        throw new UnsupportedOperationException(\"Loading all namespaces from the database is not supported yet!\");", "originalCommit": "aeda6db14cb3e4103d4be94ea9143c4282b214cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NzQ1Nw==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504567457", "bodyText": "Yep! I probably should have given a bit more context. Internally this part of the workstream has two phases: 3B (which is ensuring db timelock runs single client namespace integration tests correctly) and 3C (which is giving full compatibility with MNPTLSIT, including the getAllNamespaces tests). Eventually in 3C.3 this will be implemented :)", "author": "jeremyk-91", "createdAt": "2020-10-14T10:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMjkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjYwMA==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504536600", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ConnectionManagerAwareDbKvs kvs = null;\n          \n          \n            \n                        try {\n          \n          \n            \n                            kvs = createKvs();\n          \n          \n            \n                            try (Connection connection = kvs.getConnectionManager().getConnection()) {\n          \n          \n            \n                                return connection.isValid(FIVE_SECONDS);\n          \n          \n            \n                            }\n          \n          \n            \n                        } catch (Exception ex) {\n          \n          \n            \n                            if (ex.getMessage().contains(\"The connection attempt failed.\")\n          \n          \n            \n                                    || ex.getMessage().contains(\"the database system is starting up\")) {\n          \n          \n            \n                                return false;\n          \n          \n            \n                            } else {\n          \n          \n            \n                                throw ex;\n          \n          \n            \n                            }\n          \n          \n            \n                        } finally {\n          \n          \n            \n                            if (kvs != null) {\n          \n          \n            \n                                kvs.close();\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n          \n            \n                        try (ConnectionManagerAwareDbKvs kvs = createKvs()) {\n          \n          \n            \n                            try (Connection connection = kvs.getConnectionManager().getConnection()) {\n          \n          \n            \n                                return connection.isValid(FIVE_SECONDS);\n          \n          \n            \n                            }\n          \n          \n            \n                        } catch (Exception ex) {\n          \n          \n            \n                            if (ex.getMessage().contains(\"The connection attempt failed.\")\n          \n          \n            \n                                    || ex.getMessage().contains(\"the database system is starting up\")) {\n          \n          \n            \n                                return false;\n          \n          \n            \n                            } else {\n          \n          \n            \n                                throw ex;\n          \n          \n            \n                            }\n          \n          \n            \n                        }", "author": "gmaretic", "createdAt": "2020-10-14T09:31:37Z", "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/DbKvsRule.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.net.InetSocketAddress;\n+import java.sql.Connection;\n+import java.util.concurrent.Callable;\n+\n+import org.awaitility.Awaitility;\n+import org.awaitility.Duration;\n+import org.junit.rules.ExternalResource;\n+import org.junit.rules.RuleChain;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+import com.palantir.atlasdb.keyvalue.dbkvs.DbKeyValueServiceConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.ImmutableDbKeyValueServiceConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.ImmutablePostgresDdlConfig;\n+import com.palantir.atlasdb.keyvalue.dbkvs.impl.ConnectionManagerAwareDbKvs;\n+import com.palantir.conjure.java.api.config.service.HumanReadableDuration;\n+import com.palantir.docker.compose.DockerComposeRule;\n+import com.palantir.docker.compose.configuration.ShutdownStrategy;\n+import com.palantir.docker.compose.connection.Container;\n+import com.palantir.docker.compose.connection.DockerPort;\n+import com.palantir.docker.compose.logging.LogDirectory;\n+import com.palantir.nexus.db.pool.config.ConnectionConfig;\n+import com.palantir.nexus.db.pool.config.ImmutableMaskedValue;\n+import com.palantir.nexus.db.pool.config.ImmutablePostgresConnectionConfig;\n+\n+public class DbKvsRule implements TestRule {\n+    private static final int POSTGRES_PORT = 5432;\n+    private static final int FIVE_SECONDS = 5;\n+\n+    private final DockerComposeRule docker = DockerComposeRule.builder()\n+            .file(\"src/testCommon/resources/docker-compose.yml\")\n+            .waitingForService(\"postgres\", Container::areAllPortsOpen)\n+            .saveLogsTo(LogDirectory.circleAwareLogDirectory(DbKvsRule.class))\n+            .shutdownStrategy(ShutdownStrategy.AGGRESSIVE_WITH_NETWORK_CLEANUP)\n+            .build();\n+\n+    @Override\n+    public Statement apply(Statement base, Description description) {\n+        return RuleChain.outerRule(docker)\n+                .around(new ExternalResource() {\n+                    @Override\n+                    protected void before() {\n+                        waitUntilDbkvsIsUp();\n+                    }\n+\n+                    @Override\n+                    protected void after() {\n+                        // no op\n+                    }\n+                }).apply(base, description);\n+    }\n+\n+    private void waitUntilDbkvsIsUp() {\n+        Awaitility.await()\n+                .atMost(Duration.ONE_MINUTE)\n+                .pollInterval(Duration.ONE_SECOND)\n+                .until(canCreateKeyValueService());\n+    }\n+\n+    private DbKeyValueServiceConfig getKvsConfig() {\n+        DockerPort port = docker.containers()\n+                .container(\"postgres\")\n+                .port(POSTGRES_PORT);\n+\n+        InetSocketAddress postgresAddress = new InetSocketAddress(port.getIp(), port.getExternalPort());\n+\n+        ConnectionConfig connectionConfig = ImmutablePostgresConnectionConfig.builder()\n+                .dbName(\"atlas\")\n+                .dbLogin(\"palantir\")\n+                .dbPassword(ImmutableMaskedValue.of(\"palantir\"))\n+                .host(postgresAddress.getHostName())\n+                .port(postgresAddress.getPort())\n+                .build();\n+\n+        return ImmutableDbKeyValueServiceConfig.builder()\n+                .connection(connectionConfig)\n+                .ddl(ImmutablePostgresDdlConfig.builder()\n+                        .compactInterval(HumanReadableDuration.days(2))\n+                        .build())\n+                .build();\n+    }\n+\n+    private Callable<Boolean> canCreateKeyValueService() {\n+        return () -> {\n+            ConnectionManagerAwareDbKvs kvs = null;\n+            try {\n+                kvs = createKvs();\n+                try (Connection connection = kvs.getConnectionManager().getConnection()) {\n+                    return connection.isValid(FIVE_SECONDS);\n+                }\n+            } catch (Exception ex) {\n+                if (ex.getMessage().contains(\"The connection attempt failed.\")\n+                        || ex.getMessage().contains(\"the database system is starting up\")) {\n+                    return false;\n+                } else {\n+                    throw ex;\n+                }\n+            } finally {\n+                if (kvs != null) {\n+                    kvs.close();\n+                }\n+            }", "originalCommit": "aeda6db14cb3e4103d4be94ea9143c4282b214cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3MDIwNQ==", "url": "https://github.com/palantir/atlasdb/pull/5024#discussion_r504570205", "bodyText": "Good call, yeah I copypasted this one", "author": "jeremyk-91", "createdAt": "2020-10-14T10:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjYwMA=="}], "type": "inlineReview"}, {"oid": "bd60672e67516edfeb1cc246d313cfdb12b656ec", "url": "https://github.com/palantir/atlasdb/commit/bd60672e67516edfeb1cc246d313cfdb12b656ec", "message": "Update timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/DbKvsRule.java\n\nCo-authored-by: gmaretic <gmaretic@palantir.com>", "committedDate": "2020-10-14T10:28:08Z", "type": "commit"}, {"oid": "35b8adb0e30c3813b748975847c6fe176efdf3ae", "url": "https://github.com/palantir/atlasdb/commit/35b8adb0e30c3813b748975847c6fe176efdf3ae", "message": "No default for TimestampCreators", "committedDate": "2020-10-14T10:28:43Z", "type": "commit"}, {"oid": "6dbf57d78ff116b03b6bd102548b21afb82c090d", "url": "https://github.com/palantir/atlasdb/commit/6dbf57d78ff116b03b6bd102548b21afb82c090d", "message": "Merge branch 'jkong/test-rule-for-dbkvs' of github.com:palantir/atlasdb into jkong/test-rule-for-dbkvs", "committedDate": "2020-10-14T10:30:00Z", "type": "commit"}]}