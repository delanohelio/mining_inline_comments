{"pr_number": 4809, "pr_title": "[Dialogue] Part 10: :hot_pepper: TimeLock Internode by Shim", "pr_createdAt": "2020-05-27T22:14:50Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4809", "timeline": [{"oid": "d289c144dddb95cefe051dad3199aabe87acdb0c", "url": "https://github.com/palantir/atlasdb/commit/d289c144dddb95cefe051dad3199aabe87acdb0c", "message": "TLDSP", "committedDate": "2020-05-27T21:22:42Z", "type": "commit"}, {"oid": "d36695203b167eea5cdc6b306f7357236f7673da", "url": "https://github.com/palantir/atlasdb/commit/d36695203b167eea5cdc6b306f7357236f7673da", "message": "checkpoint", "committedDate": "2020-05-27T21:22:42Z", "type": "commit"}, {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "url": "https://github.com/palantir/atlasdb/commit/a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "message": "Wire it all through", "committedDate": "2020-05-27T22:06:09Z", "type": "commit"}, {"oid": "02661f76c0d2dda8c9be1f5361f11ffd1f362d43", "url": "https://github.com/palantir/atlasdb/commit/02661f76c0d2dda8c9be1f5361f11ffd1f362d43", "message": "Add generated changelog entries", "committedDate": "2020-05-27T22:06:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431843996", "bodyText": "We could work around this by making it Optional", "author": "jeremyk-91", "createdAt": "2020-05-28T13:42:43Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -117,6 +129,28 @@ public static TimeLockAgent create(\n         return agent;\n     }\n \n+    private static TimeLockDialogueServiceProvider createTimeLockDialogueServiceProvider(\n+            MetricsManager metricsManager, TimeLockInstallConfiguration install, UserAgent userAgent) {\n+        DialogueClients.ReloadingFactory baseFactory = DialogueClients.create(\n+                Refreshable.only(ServicesConfigBlock.builder().build()));\n+        ServerListConfig timeLockServerListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(PaxosRemotingUtils.getRemoteServerPaths(install))\n+                .sslConfiguration(install.cluster().cluster().security())\n+                .proxyConfiguration(install.cluster().cluster().proxyConfiguration())\n+                .build();\n+        return TimeLockDialogueServiceProvider.create(\n+                metricsManager.getTaggedRegistry(),\n+                baseFactory,\n+                timeLockServerListConfig,\n+                AuxiliaryRemotingParameters.builder()\n+                        .userAgent(userAgent)\n+                        .shouldLimitPayload(false)\n+                        .shouldRetry(false) // Is subsequently overridden.", "originalCommit": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxOTIxOQ==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431919219", "bodyText": "\ud83d\udc4d", "author": "gmaretic", "createdAt": "2020-05-28T15:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5MzE5NA==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r432393194", "bodyText": "Turns out this causes a lot of unexpected headaches with the logic for detecting different remote clients, so I'm not going to block on this if that's okay?", "author": "jeremyk-91", "createdAt": "2020-05-29T10:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5NzA0NA==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r432397044", "bodyText": "Fair enough, can live with this", "author": "gmaretic", "createdAt": "2020-05-29T10:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwMzQ5Mg==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r432403492", "bodyText": "never mind, I coded a silly bug", "author": "jeremyk-91", "createdAt": "2020-05-29T10:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODcwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431918701", "bodyText": "nit: extract method", "author": "gmaretic", "createdAt": "2020-05-28T15:17:59Z", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockDialogueServiceProvider.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.paxos;\n+\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableServerListConfig;\n+import com.palantir.atlasdb.config.ServerListConfig;\n+import com.palantir.atlasdb.http.AtlasDbHttpClients;\n+import com.palantir.atlasdb.http.AtlasDbRemotingConstants;\n+import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n+import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n+import com.palantir.atlasdb.http.v2.RemoteServiceConfiguration;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.conjure.java.client.config.ClientConfiguration;\n+import com.palantir.conjure.java.client.config.NodeSelectionStrategy;\n+import com.palantir.dialogue.clients.DialogueClients;\n+import com.palantir.refreshable.Refreshable;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockDialogueServiceProvider {\n+    private final DialogueClients.ReloadingFactory reloadingFactory;\n+    private final TaggedMetricRegistry taggedMetricRegistry;\n+\n+    private TimeLockDialogueServiceProvider(\n+            DialogueClients.ReloadingFactory reloadingFactory,\n+            TaggedMetricRegistry taggedMetricRegistry) {\n+        this.reloadingFactory = reloadingFactory;\n+        this.taggedMetricRegistry = taggedMetricRegistry;\n+    }\n+\n+    public static TimeLockDialogueServiceProvider create(\n+            TaggedMetricRegistry taggedMetricRegistry,\n+            DialogueClients.ReloadingFactory baseFactory,\n+            ServerListConfig serverListConfig,\n+            AuxiliaryRemotingParameters parameters) {\n+        UserAgent versionedAgent = parameters.userAgent().addAgent(AtlasDbRemotingConstants.ATLASDB_HTTP_CLIENT_AGENT);\n+        Map<String, RemoteServiceConfiguration> remoteServiceConfigurations\n+                = createRemoteServiceConfigurations(serverListConfig, versionedAgent, parameters);\n+        DialogueClients.ReloadingFactory reloadingFactory\n+                = decorate(baseFactory, Refreshable.only(remoteServiceConfigurations)).withUserAgent(versionedAgent);\n+        return new TimeLockDialogueServiceProvider(reloadingFactory, taggedMetricRegistry);\n+    }\n+\n+    private static Map<String, RemoteServiceConfiguration> createRemoteServiceConfigurations(\n+            ServerListConfig serverListConfig, UserAgent versionedAgent, AuxiliaryRemotingParameters parameters) {\n+        return KeyedStream.of(serverListConfig.servers())\n+                .map(server -> ImmutableServerListConfig.builder()\n+                        .from(serverListConfig)\n+                        .servers(ImmutableList.of(server))\n+                        .build())\n+                .flatMapEntries((uri, singleServerConfig) -> {\n+                    RemoteServiceConfiguration nonRetrying = ImmutableRemoteServiceConfiguration.builder()", "originalCommit": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84456b22898c9e1837ede5c7d8d396379dea3f95", "url": "https://github.com/palantir/atlasdb/commit/84456b22898c9e1837ede5c7d8d396379dea3f95", "message": "Merge branch 'develop' into jkong/dialogue-shims2", "committedDate": "2020-05-28T19:45:57Z", "type": "commit"}, {"oid": "1c8757ca9ec51e2ba76e11a813c455d4b44054dc", "url": "https://github.com/palantir/atlasdb/commit/1c8757ca9ec51e2ba76e11a813c455d4b44054dc", "message": "Imports", "committedDate": "2020-05-28T19:47:38Z", "type": "commit"}, {"oid": "18f876b1d463238e41b6a0d5f6b8431d3d79ab5e", "url": "https://github.com/palantir/atlasdb/commit/18f876b1d463238e41b6a0d5f6b8431d3d79ab5e", "message": "Optional, and don't set useless ShouldRetry", "committedDate": "2020-05-28T20:06:48Z", "type": "commit"}, {"oid": "184f604661fd77dcb50ebd0f93dd5c9b007141d2", "url": "https://github.com/palantir/atlasdb/commit/184f604661fd77dcb50ebd0f93dd5c9b007141d2", "message": "Extract method", "committedDate": "2020-05-28T20:11:09Z", "type": "commit"}, {"oid": "715361f29c94a7722af5d4d5e5bcbd15cb964066", "url": "https://github.com/palantir/atlasdb/commit/715361f29c94a7722af5d4d5e5bcbd15cb964066", "message": "Silly bugs", "committedDate": "2020-05-28T21:41:15Z", "type": "commit"}, {"oid": "e5754da2372270bc725daa418e517067abc35243", "url": "https://github.com/palantir/atlasdb/commit/e5754da2372270bc725daa418e517067abc35243", "message": ":Revert \"Silly bugs\"\n\nThis reverts commit 715361f29c94a7722af5d4d5e5bcbd15cb964066.", "committedDate": "2020-05-29T10:21:49Z", "type": "commit"}, {"oid": "caf337d076510dcaf23833e260e554f97329c18e", "url": "https://github.com/palantir/atlasdb/commit/caf337d076510dcaf23833e260e554f97329c18e", "message": "Revert \"Optional, and don't set useless ShouldRetry\"\n\nThis reverts commit 18f876b1d463238e41b6a0d5f6b8431d3d79ab5e.", "committedDate": "2020-05-29T10:21:59Z", "type": "commit"}, {"oid": "c149af399d4c26a6f030e1e85a3dca24172d82a0", "url": "https://github.com/palantir/atlasdb/commit/c149af399d4c26a6f030e1e85a3dca24172d82a0", "message": "graaaaaargh", "committedDate": "2020-05-29T10:41:11Z", "type": "commit"}, {"oid": "a3deb99e5c90351178c4068f844f3cf440e9bfc0", "url": "https://github.com/palantir/atlasdb/commit/a3deb99e5c90351178c4068f844f3cf440e9bfc0", "message": "Revert \":Revert \"Silly bugs\"\"\n\nThis reverts commit e5754da2372270bc725daa418e517067abc35243.", "committedDate": "2020-05-29T10:45:19Z", "type": "commit"}, {"oid": "03d01858699ffecb8e412f413809ffe977c73089", "url": "https://github.com/palantir/atlasdb/commit/03d01858699ffecb8e412f413809ffe977c73089", "message": "Revert \"Revert \"Optional, and don't set useless ShouldRetry\"\"\n\nThis reverts commit caf337d076510dcaf23833e260e554f97329c18e.", "committedDate": "2020-05-29T10:45:41Z", "type": "commit"}, {"oid": "b2efc5cea4900cb7e0f28ad8a94947128a16ba25", "url": "https://github.com/palantir/atlasdb/commit/b2efc5cea4900cb7e0f28ad8a94947128a16ba25", "message": "DCO", "committedDate": "2020-05-29T11:13:00Z", "type": "commit"}]}