{"pr_number": 4907, "pr_title": "Leader election rate", "pr_createdAt": "2020-07-21T17:22:36Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4907", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyNjg3Ng==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r458726876", "bodyText": "How hard would it be to add a test?", "author": "jkozlowski", "createdAt": "2020-07-22T11:35:26Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader.health;\n+\n+import com.palantir.leader.LeaderElectionServiceMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeaderElectionHealthCheck {\n+    private static final double MAX_ALLOWED_5_MIN_RATE = 5;\n+    private static final double MAX_ALLOWED_15_MIN_RATE = 15;\n+\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics;\n+\n+    public LeaderElectionHealthCheck(TaggedMetricRegistry taggedMetricRegistry) {", "originalCommit": "ff2e096e22335b91cb10ad536cf51b417aab1aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2MDgxMw==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r460060813", "bodyText": "Test added for the health check.", "author": "sudiksha27", "createdAt": "2020-07-24T13:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyNjg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyNzIxMQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r458727211", "bodyText": "This means 5 in the last minute? or 5 in the last 5 minutes?", "author": "jkozlowski", "createdAt": "2020-07-22T11:36:09Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader.health;\n+\n+import com.palantir.leader.LeaderElectionServiceMetrics;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeaderElectionHealthCheck {\n+    private static final double MAX_ALLOWED_5_MIN_RATE = 5;", "originalCommit": "ff2e096e22335b91cb10ad536cf51b417aab1aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4Mjc4Ng==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r460082786", "bodyText": "This constant is incorrect; i am fixing this.", "author": "sudiksha27", "createdAt": "2020-07-24T14:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyNzIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDExNTI5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r460115291", "bodyText": "It may be good to say what the metrics are, as opposed to what specifically they do.", "author": "jeremyk-91", "createdAt": "2020-07-24T15:11:41Z", "path": "leader-election-impl/src/main/metrics/leader-election.yml", "diffHunk": "@@ -0,0 +1,31 @@\n+options:\n+  javaPackage: 'com.palantir.leader'\n+\n+namespaces:\n+  leaderElectionService:\n+    docs: Metrics helpful for TimeLock adjudication.", "originalCommit": "74f3973942739ff0137e696374e91d6c6997a464", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4ODk5MA==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461588990", "bodyText": "(I think we still need to fix this in round 2)", "author": "jeremyk-91", "createdAt": "2020-07-28T13:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDExNTI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDExNTUwNA==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r460115504", "bodyText": "nit: remember to clean this up", "author": "jeremyk-91", "createdAt": "2020-07-24T15:12:01Z", "path": "changelog/@unreleased/pr-4907.v2.yml", "diffHunk": "@@ -0,0 +1,11 @@\n+type: improvement\n+improvement:\n+  description: |-\n+    This change adds a health check to track the leader election rate on TimeLock.\n+    <!---\n+    Please remember to:\n+    - Add any necessary release notes (including breaking changes)\n+    - Make sure the documentation is up to date for your change\n+    --->", "originalCommit": "74f3973942739ff0137e696374e91d6c6997a464", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5NzQyMQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r460197421", "bodyText": "This feels a bit high: one election per second is pretty unstable. Based on metrics we've seen internally I think we want this to be maybe one in 30 seconds?", "author": "jeremyk-91", "createdAt": "2020-07-24T17:41:47Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader.health;\n+\n+import com.palantir.leader.LeaderElectionServiceMetrics;\n+\n+public class LeaderElectionHealthCheck {\n+    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 1;", "originalCommit": "74f3973942739ff0137e696374e91d6c6997a464", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4MzkwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461583901", "bodyText": "Nice work!", "author": "jeremyk-91", "createdAt": "2020-07-28T13:35:07Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -35,64 +34,49 @@\n \n     private static final String LEADER_LOG_NAME = \"leadership\";\n     private static final Logger leaderLog = LoggerFactory.getLogger(LEADER_LOG_NAME);\n-\n-    private final Meter gainedLeadership;\n-    private final Meter lostLeadership;\n-    private final Meter noQuorum;\n-    private final Meter proposedLeadership;\n-    private final Meter proposalFailure;\n-    private final Meter leaderPingFailure;\n-    private final Meter leaderPingTimeout;\n-    private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics;", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NTYyMg==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461585622", "bodyText": "nit: registry", "author": "jeremyk-91", "createdAt": "2020-07-28T13:37:30Z", "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Meter;\n+import com.palantir.leader.health.LeaderElectionHealthCheck;\n+import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeadershipElectionCheckTest {\n+    private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n+    private final TaggedMetricRegistry registry1 = mock(TaggedMetricRegistry.class);", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NjI2NA==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461586264", "bodyText": "Sorry - despite the comment I'm not sure what the significance of the 6 seconds here is?", "author": "jeremyk-91", "createdAt": "2020-07-28T13:38:25Z", "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Meter;\n+import com.palantir.leader.health.LeaderElectionHealthCheck;\n+import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeadershipElectionCheckTest {\n+    private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n+    private final TaggedMetricRegistry registry1 = mock(TaggedMetricRegistry.class);\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics =\n+            LeaderElectionServiceMetrics.of(registry1);\n+    private final LeaderElectionHealthCheck leaderElectionHealthCheck =\n+            new LeaderElectionHealthCheck(leaderElectionServiceMetrics);\n+\n+    @Before\n+    public void setup() {\n+        when(registry1.meter(any())).thenReturn(new Meter(fakeTimeClock));\n+    }\n+\n+    @Test\n+    public void shouldBeHealthyForOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(3, 60);\n+\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.HEALTHY);\n+    }\n+\n+    @Test\n+    public void shouldBeUnhealthyForMoreThanOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(7, 30);\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.UNHEALTHY);\n+    }\n+\n+    public void markLeaderElectionsAtSpecifiedInterval(int leaderElectionCount, long timeIntervalInSeconds) {\n+        // First tick\n+        fakeTimeClock.advance(6, TimeUnit.SECONDS);", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NjQzOQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461586439", "bodyText": "\u2764\ufe0f", "author": "jeremyk-91", "createdAt": "2020-07-28T13:38:41Z", "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Meter;\n+import com.palantir.leader.health.LeaderElectionHealthCheck;\n+import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeadershipElectionCheckTest {\n+    private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n+    private final TaggedMetricRegistry registry1 = mock(TaggedMetricRegistry.class);\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics =\n+            LeaderElectionServiceMetrics.of(registry1);\n+    private final LeaderElectionHealthCheck leaderElectionHealthCheck =\n+            new LeaderElectionHealthCheck(leaderElectionServiceMetrics);\n+\n+    @Before\n+    public void setup() {\n+        when(registry1.meter(any())).thenReturn(new Meter(fakeTimeClock));\n+    }\n+\n+    @Test\n+    public void shouldBeHealthyForOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(3, 60);\n+\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.HEALTHY);\n+    }\n+\n+    @Test\n+    public void shouldBeUnhealthyForMoreThanOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(7, 30);\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.UNHEALTHY);\n+    }\n+\n+    public void markLeaderElectionsAtSpecifiedInterval(int leaderElectionCount, long timeIntervalInSeconds) {\n+        // First tick\n+        fakeTimeClock.advance(6, TimeUnit.SECONDS);\n+\n+        IntStream.range(0, leaderElectionCount).forEach(idx -> {", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NjkwMw==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461586903", "bodyText": "nit: I'd pass Duration into markLeaderElections(...) for readability", "author": "jeremyk-91", "createdAt": "2020-07-28T13:39:17Z", "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Meter;\n+import com.palantir.leader.health.LeaderElectionHealthCheck;\n+import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeadershipElectionCheckTest {\n+    private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n+    private final TaggedMetricRegistry registry1 = mock(TaggedMetricRegistry.class);\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics =\n+            LeaderElectionServiceMetrics.of(registry1);\n+    private final LeaderElectionHealthCheck leaderElectionHealthCheck =\n+            new LeaderElectionHealthCheck(leaderElectionServiceMetrics);\n+\n+    @Before\n+    public void setup() {\n+        when(registry1.meter(any())).thenReturn(new Meter(fakeTimeClock));\n+    }\n+\n+    @Test\n+    public void shouldBeHealthyForOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(3, 60);", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4Njk4Mg==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461586982", "bodyText": "nit: private?", "author": "jeremyk-91", "createdAt": "2020-07-28T13:39:23Z", "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Meter;\n+import com.palantir.leader.health.LeaderElectionHealthCheck;\n+import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class LeadershipElectionCheckTest {\n+    private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n+    private final TaggedMetricRegistry registry1 = mock(TaggedMetricRegistry.class);\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics =\n+            LeaderElectionServiceMetrics.of(registry1);\n+    private final LeaderElectionHealthCheck leaderElectionHealthCheck =\n+            new LeaderElectionHealthCheck(leaderElectionServiceMetrics);\n+\n+    @Before\n+    public void setup() {\n+        when(registry1.meter(any())).thenReturn(new Meter(fakeTimeClock));\n+    }\n+\n+    @Test\n+    public void shouldBeHealthyForOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(3, 60);\n+\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.HEALTHY);\n+    }\n+\n+    @Test\n+    public void shouldBeUnhealthyForMoreThanOneLeaderElectionPerMinute() {\n+        markLeaderElectionsAtSpecifiedInterval(7, 30);\n+        assertThat(leaderElectionHealthCheck.leaderElectionRateHealthStatus())\n+                .isEqualTo(LeaderElectionHealthStatus.UNHEALTHY);\n+    }\n+\n+    public void markLeaderElectionsAtSpecifiedInterval(int leaderElectionCount, long timeIntervalInSeconds) {", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NzM2OA==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461587368", "bodyText": "nit: the name of the constant implies <=?", "author": "jeremyk-91", "createdAt": "2020-07-28T13:39:56Z", "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.leader.health;\n+\n+import com.palantir.leader.LeaderElectionServiceMetrics;\n+\n+public class LeaderElectionHealthCheck {\n+    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.016;\n+\n+    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics;\n+\n+    public LeaderElectionHealthCheck(LeaderElectionServiceMetrics leaderElectionServiceMetrics) {\n+        this.leaderElectionServiceMetrics = leaderElectionServiceMetrics;\n+    }\n+\n+    public LeaderElectionHealthStatus leaderElectionRateHealthStatus() {\n+        return leaderElectionServiceMetrics.proposedLeadership().getFiveMinuteRate() < MAX_ALLOWED_LAST_5_MINUTE_RATE", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4OTk0NQ==", "url": "https://github.com/palantir/atlasdb/pull/4907#discussion_r461589945", "bodyText": "We should standardise between Number of times(per second) and Rate. I think I slightly prefer the former - or maybe Rate (frequency per second)?", "author": "jeremyk-91", "createdAt": "2020-07-28T13:43:20Z", "path": "leader-election-impl/src/main/metrics/leader-election.yml", "diffHunk": "@@ -0,0 +1,31 @@\n+options:\n+  javaPackage: 'com.palantir.leader'\n+\n+namespaces:\n+  leaderElectionService:\n+    docs: Metrics helpful for TimeLock adjudication.\n+    metrics:\n+      gainedLeadership:\n+        type: meter\n+        docs: Number of times(per second) leadership was gained successully.\n+      lostLeadership:\n+        type: meter\n+        docs: Number of times(per second) leadership was lost.\n+      noQuorum:\n+        type: meter\n+        docs: Number of times(per second) there was no quorum while determining leadership status.\n+      proposedLeadership:\n+        type: meter\n+        docs: Number of times(per second) leadership was proposed.\n+      proposalFailure:\n+        type: meter\n+        docs: Number of times(per second) leadership could not be gained after proposal.", "originalCommit": "18aca492fe87271e7fe037333273ad76e4e808f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0fe9a05ff84f551bdd3e9fb337f8376ba92a219", "url": "https://github.com/palantir/atlasdb/commit/b0fe9a05ff84f551bdd3e9fb337f8376ba92a219", "message": "Move leader election metrics to metric-schema", "committedDate": "2020-07-29T09:50:55Z", "type": "commit"}, {"oid": "9349d83702f3ae52fce892d781042607c3049419", "url": "https://github.com/palantir/atlasdb/commit/9349d83702f3ae52fce892d781042607c3049419", "message": "Leader election rate health check", "committedDate": "2020-07-29T09:51:53Z", "type": "commit"}, {"oid": "ef0a4f94c97c3e5d4fcd60c1bcbc8d41d4203c27", "url": "https://github.com/palantir/atlasdb/commit/ef0a4f94c97c3e5d4fcd60c1bcbc8d41d4203c27", "message": "Update docs", "committedDate": "2020-07-29T09:51:53Z", "type": "commit"}, {"oid": "3567b74130136b7b538451294e8912a897c2edcb", "url": "https://github.com/palantir/atlasdb/commit/3567b74130136b7b538451294e8912a897c2edcb", "message": "Exclude generated metric schema from License violation check", "committedDate": "2020-07-29T09:51:53Z", "type": "commit"}, {"oid": "84de6c4e5396f1e66140be6ee605b712d6a73959", "url": "https://github.com/palantir/atlasdb/commit/84de6c4e5396f1e66140be6ee605b712d6a73959", "message": "Refactor", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "64122e87fd55b2219dcd30f768c32ffa2c62d5fa", "url": "https://github.com/palantir/atlasdb/commit/64122e87fd55b2219dcd30f768c32ffa2c62d5fa", "message": "Test", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "0fba2981853368f6c0b38424f8e4f5bee3878de2", "url": "https://github.com/palantir/atlasdb/commit/0fba2981853368f6c0b38424f8e4f5bee3878de2", "message": "Comment", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "c4ecccd258de24055aa349da7b5961463dce02be", "url": "https://github.com/palantir/atlasdb/commit/c4ecccd258de24055aa349da7b5961463dce02be", "message": "Add generated changelog entries", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "5075c6db261e51adf79956a96a428aa70c1cdbf9", "url": "https://github.com/palantir/atlasdb/commit/5075c6db261e51adf79956a96a428aa70c1cdbf9", "message": "Fix threshold + tests", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "0ee82e807593547e02451a4ac6836209141ba5af", "url": "https://github.com/palantir/atlasdb/commit/0ee82e807593547e02451a4ac6836209141ba5af", "message": "Add generated changelog entries", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "d23c4b7ea5a6fd3e5c0a4b5e3327de9bd4c1b13b", "url": "https://github.com/palantir/atlasdb/commit/d23c4b7ea5a6fd3e5c0a4b5e3327de9bd4c1b13b", "message": "Update test", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "dde349553a0da0a7ca78d0f9db3a2b2a57ff9c8f", "url": "https://github.com/palantir/atlasdb/commit/dde349553a0da0a7ca78d0f9db3a2b2a57ff9c8f", "message": "Checkstyle", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "8f66f6a49691d46d53c38f58906593e4caedb236", "url": "https://github.com/palantir/atlasdb/commit/8f66f6a49691d46d53c38f58906593e4caedb236", "message": "Address comments", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "42747e055d0f24c046c8bb47f310809d9440c537", "url": "https://github.com/palantir/atlasdb/commit/42747e055d0f24c046c8bb47f310809d9440c537", "message": "Add comment", "committedDate": "2020-07-29T09:52:19Z", "type": "commit"}, {"oid": "42747e055d0f24c046c8bb47f310809d9440c537", "url": "https://github.com/palantir/atlasdb/commit/42747e055d0f24c046c8bb47f310809d9440c537", "message": "Add comment", "committedDate": "2020-07-29T09:52:19Z", "type": "forcePushed"}]}