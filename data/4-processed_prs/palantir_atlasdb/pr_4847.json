{"pr_number": 4847, "pr_title": "[PDS$-110002] Part 5 | PoC?: Threshold-Based Metric Filtering and Metric-Schema for Targeted Sweep Metrics", "pr_createdAt": "2020-06-18T20:42:57Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4847", "timeline": [{"oid": "358b28eebf09514d606c1771c5b9205442cf3b22", "url": "https://github.com/palantir/atlasdb/commit/358b28eebf09514d606c1771c5b9205442cf3b22", "message": "only used tagged MR", "committedDate": "2020-06-17T21:24:33Z", "type": "commit"}, {"oid": "f081295f6385ad7e1fcce3358bbcb8ad408078f9", "url": "https://github.com/palantir/atlasdb/commit/f081295f6385ad7e1fcce3358bbcb8ad408078f9", "message": "disjoint union set", "committedDate": "2020-06-17T21:24:54Z", "type": "commit"}, {"oid": "b1088ed7f74d166c1e5a6faae6e31a8b6ba95ad9", "url": "https://github.com/palantir/atlasdb/commit/b1088ed7f74d166c1e5a6faae6e31a8b6ba95ad9", "message": "pffty", "committedDate": "2020-06-17T21:35:15Z", "type": "commit"}, {"oid": "c11b01027cde938a3fec71d32eb4f5ec7d37819a", "url": "https://github.com/palantir/atlasdb/commit/c11b01027cde938a3fec71d32eb4f5ec7d37819a", "message": "Concept of filters", "committedDate": "2020-06-18T10:07:22Z", "type": "commit"}, {"oid": "e8aecd5620c61fa108930d850b883fbdf96d9fce", "url": "https://github.com/palantir/atlasdb/commit/e8aecd5620c61fa108930d850b883fbdf96d9fce", "message": "metric schema attempt", "committedDate": "2020-06-18T11:36:52Z", "type": "commit"}, {"oid": "a5d63f2b4454066705539c8af94f0ec8203a708d", "url": "https://github.com/palantir/atlasdb/commit/a5d63f2b4454066705539c8af94f0ec8203a708d", "message": "Change API", "committedDate": "2020-06-18T11:43:13Z", "type": "commit"}, {"oid": "539dbeaf79ec809be0ad35bd65d8f5622e6408fd", "url": "https://github.com/palantir/atlasdb/commit/539dbeaf79ec809be0ad35bd65d8f5622e6408fd", "message": "Add kill switch", "committedDate": "2020-06-18T12:01:52Z", "type": "commit"}, {"oid": "be181f8a15e21a1e3531b2c77ea119c45202353e", "url": "https://github.com/palantir/atlasdb/commit/be181f8a15e21a1e3531b2c77ea119c45202353e", "message": "fix", "committedDate": "2020-06-18T12:03:55Z", "type": "commit"}, {"oid": "5af95b59a7bfabf27b471fc29938ec136e908ba6", "url": "https://github.com/palantir/atlasdb/commit/5af95b59a7bfabf27b471fc29938ec136e908ba6", "message": "baseline", "committedDate": "2020-06-18T19:22:00Z", "type": "commit"}, {"oid": "4f6bb7205f22b48f36633dc7620da49e0f6b778a", "url": "https://github.com/palantir/atlasdb/commit/4f6bb7205f22b48f36633dc7620da49e0f6b778a", "message": "Baseline and Licenses", "committedDate": "2020-06-18T19:36:28Z", "type": "commit"}, {"oid": "d2ab7087ebd20419fefe45da6509b965aa65deae", "url": "https://github.com/palantir/atlasdb/commit/d2ab7087ebd20419fefe45da6509b965aa65deae", "message": "Tests", "committedDate": "2020-06-18T20:05:21Z", "type": "commit"}, {"oid": "274891fa564085531f41ed9b6934f72397255dd4", "url": "https://github.com/palantir/atlasdb/commit/274891fa564085531f41ed9b6934f72397255dd4", "message": "Exclude metric schema generated stuff from license", "committedDate": "2020-06-18T20:28:52Z", "type": "commit"}, {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd", "url": "https://github.com/palantir/atlasdb/commit/50e24b4b212edae0fc473b20a61149cc41bbb4cd", "message": "The relative paths are hard", "committedDate": "2020-06-18T20:52:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc5Nzg2OA==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442797868", "bodyText": "Would it make sense for this class to just take a Predicate, and implement the filtering rules somewhere else?", "author": "jkozlowski", "createdAt": "2020-06-19T11:56:18Z", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/FilteredTaggedMetricSet.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.metrics;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+\n+import com.codahale.metrics.Metric;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.refreshable.Refreshable;\n+import com.palantir.tritium.metrics.registry.MetricName;\n+import com.palantir.tritium.metrics.registry.TaggedMetricSet;\n+\n+public class FilteredTaggedMetricSet implements TaggedMetricSet {\n+    private final TaggedMetricSet unfiltered;\n+    private final Map<MetricName, List<MetricPublicationFilter>> singleMetricFilters;", "originalCommit": "50e24b4b212edae0fc473b20a61149cc41bbb4cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1NzUyOA==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442857528", "bodyText": "As in this class just takes Predicate<MetricName> (and then have some kind of filter registry that handles this map)? Yep, we could - I don't feel strongly either way (what you propose does split responsibilities better, though it does add another piece).", "author": "jeremyk-91", "createdAt": "2020-06-19T14:00:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc5Nzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2MDI1NQ==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442860255", "bodyText": "(for clarity: yeah I plan to change this)", "author": "jeremyk-91", "createdAt": "2020-06-19T14:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc5Nzg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgwMDc5MQ==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442800791", "bodyText": "I wonder if metric-schema should provide all of this for us? Basically the ability to specify that a metrics should be published only once a certain threshold is breached? I suspect we'll need this in a bunch of projects that are hoping to cut on spend. @ferozco", "author": "jkozlowski", "createdAt": "2020-06-19T12:03:49Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/TargetedSweepMetricPublicationFilter.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.sweep.metrics;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.LongSupplier;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+\n+/**\n+ * Indicates whether targeted sweep metrics should be published.\n+ *\n+ * The criteria for publishing metrics for a given strategy, is if the number of enqueued writes or reads is in\n+ * excess of {@link #MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE}, or it is believed that targeted sweep is behind by\n+ * more than {@link #MINIMUM_STALE_DURATION}. If any of these conditions are true, then all targeted sweep metrics\n+ * will be published.\n+ */\n+public class TargetedSweepMetricPublicationFilter implements MetricPublicationFilter {\n+    @VisibleForTesting\n+    static final long MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE = 1_000;\n+    @VisibleForTesting\n+    static final Duration MINIMUM_STALE_DURATION = Duration.ofHours(4);\n+\n+    private final AtomicBoolean publicationLatch;\n+\n+    private final LongSupplier enqueuedWrites;\n+    private final LongSupplier entriesRead;\n+    private final LongSupplier millisSinceLastSweptTs;\n+\n+    public TargetedSweepMetricPublicationFilter(DecisionMetrics decisionMetrics) {\n+        this.publicationLatch = new AtomicBoolean(false);\n+        this.enqueuedWrites = decisionMetrics.enqueuedWrites();\n+        this.entriesRead = decisionMetrics.entriesRead();\n+        this.millisSinceLastSweptTs = decisionMetrics.millisSinceLastSweptTs();\n+    }\n+\n+    @Override\n+    public boolean shouldPublish() {\n+        if (publicationLatch.get()) {\n+            return true;\n+        }\n+        boolean conditionsAchieved = testConditions();\n+        if (conditionsAchieved) {\n+            publicationLatch.compareAndSet(false, true);\n+        }\n+        return conditionsAchieved;\n+    }\n+\n+    private boolean testConditions() {\n+        return enqueuedWrites.getAsLong() >= MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE", "originalCommit": "50e24b4b212edae0fc473b20a61149cc41bbb4cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1ODc2Nw==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442858767", "bodyText": "Yep, it would be cool if metric-schema would do that (and subject to team prioritisation I would be very interested in helping with such an effort, if we think it should live there).\nNote that here we register these filters even for the other TS metrics so having 'publish A only if B is above a certain value' might be a little bit much to ask (though if we want to support that in metric schema I'm not complaining!).", "author": "jeremyk-91", "createdAt": "2020-06-19T14:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgwMDc5MQ=="}], "type": "inlineReview"}, {"oid": "8f139cfd6481b6cae4f02d97f79e6255ff0b82cc", "url": "https://github.com/palantir/atlasdb/commit/8f139cfd6481b6cae4f02d97f79e6255ff0b82cc", "message": "null filter", "committedDate": "2020-06-19T12:30:28Z", "type": "commit"}, {"oid": "94a114146f734c0ec0fac4fdaa7ea6cf9f8f4d62", "url": "https://github.com/palantir/atlasdb/commit/94a114146f734c0ec0fac4fdaa7ea6cf9f8f4d62", "message": "Separate predicate and filter registration logic", "committedDate": "2020-06-19T14:49:31Z", "type": "commit"}, {"oid": "e02928dfef0b203aa4535f79553e62b0aa97d204", "url": "https://github.com/palantir/atlasdb/commit/e02928dfef0b203aa4535f79553e62b0aa97d204", "message": "Oops", "committedDate": "2020-06-19T14:49:53Z", "type": "commit"}, {"oid": "14dffbcc54dc4681b05ce60c2c2121e08d749d8a", "url": "https://github.com/palantir/atlasdb/commit/14dffbcc54dc4681b05ce60c2c2121e08d749d8a", "message": "Simplify MetricsManager and extract filter logic to the Arbiter", "committedDate": "2020-06-19T14:57:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzgxMA==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442943810", "bodyText": "Should we make this user-configurable?", "author": "sudiksha27", "createdAt": "2020-06-19T16:43:15Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/TargetedSweepMetricPublicationFilter.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.sweep.metrics;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.LongSupplier;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+\n+/**\n+ * Indicates whether targeted sweep metrics should be published.\n+ *\n+ * The criteria for publishing metrics for a given strategy, is if the number of enqueued writes or reads is in\n+ * excess of {@link #MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE}, or it is believed that targeted sweep is behind by\n+ * more than {@link #MINIMUM_STALE_DURATION}. If any of these conditions are true, then all targeted sweep metrics\n+ * will be published.\n+ */\n+public class TargetedSweepMetricPublicationFilter implements MetricPublicationFilter {\n+    @VisibleForTesting\n+    static final long MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE = 1_000;\n+    @VisibleForTesting", "originalCommit": "14dffbcc54dc4681b05ce60c2c2121e08d749d8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2ODc3OQ==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r443068779", "bodyText": "Dunno in this particular case, but in general, less config is always better. We should aim to build systems that either self-tune or have good enough defaults that work in most cases.", "author": "jkozlowski", "createdAt": "2020-06-19T22:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxOTU5MA==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r443619590", "bodyText": "Good question. I think I'll hang on to this for now: the kill switch allows us to recover our metrics if there's a P0 (or even a P1), and otherwise I doubt there'll be a situation where we need to change these so urgently that it can't wait for a quick PR that adds configurability.", "author": "jeremyk-91", "createdAt": "2020-06-22T14:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwMDgwMA==", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r443700800", "bodyText": "(In general I think I'd slant more towards leaving uncertain things configurable in AtlasDB, while less so in AtlasDB-Proxy mainly because of the relative difficulty/friction of recalling bad versions of AtlasDB.)", "author": "jeremyk-91", "createdAt": "2020-06-22T16:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzgxMA=="}], "type": "inlineReview"}, {"oid": "4c880a1bca9dcfaa1bc33bad3a129a9b313af56b", "url": "https://github.com/palantir/atlasdb/commit/4c880a1bca9dcfaa1bc33bad3a129a9b313af56b", "message": "Baseline", "committedDate": "2020-06-19T16:45:41Z", "type": "commit"}, {"oid": "d71efbd74b34af83e0105fa6db61419a8bc1ba0d", "url": "https://github.com/palantir/atlasdb/commit/d71efbd74b34af83e0105fa6db61419a8bc1ba0d", "message": "Merge branch 'develop' into jkong/tagged-with-restrictions", "committedDate": "2020-06-22T16:56:58Z", "type": "commit"}, {"oid": "5fc4c24e5f52c5c7c35f91a272579c3732bcda92", "url": "https://github.com/palantir/atlasdb/commit/5fc4c24e5f52c5c7c35f91a272579c3732bcda92", "message": "changelog", "committedDate": "2020-06-22T17:06:40Z", "type": "commit"}, {"oid": "8968902274dbf6c92e8e0f35507ad420e6f0a7a2", "url": "https://github.com/palantir/atlasdb/commit/8968902274dbf6c92e8e0f35507ad420e6f0a7a2", "message": "semantic merge", "committedDate": "2020-06-22T17:07:12Z", "type": "commit"}]}