{"pr_number": 4651, "pr_title": "Make #close safer.", "pr_createdAt": "2020-03-13T22:30:03Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4651", "timeline": [{"oid": "2705831763586a6632cc567889bd2de9ec29b456", "url": "https://github.com/palantir/atlasdb/commit/2705831763586a6632cc567889bd2de9ec29b456", "message": "Always run full cleanup.", "committedDate": "2020-03-13T22:24:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzQ2NQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392527465", "bodyText": "curious if we should just use try-with-resources\n    @Override\n    @SuppressWarnings(\"unused\") // try-with-resources closes everything\n    public void close() {\n        if (isClosed.compareAndSet(false, true)) {\n            SafeRuntimeException exception = new SafeRuntimeException(\"Close failed.\");\n            try {\n                try (AutoCloseable closeParent = super::close;\n                        AutoCloseable closeCleaner = cleaner;\n                        AutoCloseable closeKvs = keyValueService;\n                        AutoCloseable closeDelegate = () -> shutdownExecutor(deleteExecutor);\n                        AutoCloseable closeRanges = () -> shutdownExecutor(getRangesExecutor);\n                        AutoCloseable closeLockServiceIfPossible = this::closeLockServiceIfPossible;\n                        AutoCloseable closeMetrics = metricsManager::deregisterMetrics) {\n                    log.info(\"Shutting down transaction manager\");\n                    for (Runnable callback : Lists.reverse(closingCallbacks)) {\n                        try (AutoCloseable closeCallback = callback::run) {\n                            log.info(\"Closing callback\");\n                        } catch (Throwable t) {\n                            exception.addSuppressed(t);\n                        }\n                    }\n                }\n            } catch (Exception e) {\n                exception.initCause(e);\n                throw exception;\n            }\n        }\n    }", "author": "schlosna", "createdAt": "2020-03-13T23:31:20Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -327,24 +326,24 @@ public void registerClosingCallback(Runnable closingCallback) {\n     @Override\n     public void close() {\n         if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+\n+            ShutdownRunner shutdownRunner = new ShutdownRunner();", "originalCommit": "2705831763586a6632cc567889bd2de9ec29b456", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg2MTEwOQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392861109", "bodyText": "The way you implemented it it changes the semantics of the closing callbacks. From javadoc of #registerClosingCallback:\nRegisters a Runnable that will be run after the transaction manager is closed.\n\nI am not a fan of those giant try-with-resources, and since the semantics are so funky (always run closing callbacks AFTER you've closed everything else), I think I prefer my solution.", "author": "jkozlowski", "createdAt": "2020-03-16T08:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg2NTA3Nw==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392865077", "bodyText": "But I amended it to make the ShutdownRunner implement autocloseable, that is nice.", "author": "jkozlowski", "createdAt": "2020-03-16T08:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwODc5NQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r393008795", "bodyText": "I believe you actually want Guava's Closer, which does this.", "author": "felixdesouza", "createdAt": "2020-03-16T13:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzQ2NQ=="}], "type": "inlineReview"}, {"oid": "4ee85dfb163e2bd7fd4be28cfe54dd546a418589", "url": "https://github.com/palantir/atlasdb/commit/4ee85dfb163e2bd7fd4be28cfe54dd546a418589", "message": "Use AutoCloseable and return early.", "committedDate": "2020-03-16T08:54:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDc0OQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392944749", "bodyText": "Given that there is a test for this class, would you be able to add any tests that verify this new behaviour (i.e. what happens when an exception is thrown during close)?", "author": "Jolyon-S", "createdAt": "2020-03-16T11:14:24Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -326,26 +325,23 @@ public void registerClosingCallback(Runnable closingCallback) {\n      */\n     @Override\n     public void close() {\n-        if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+        if (!isClosed.compareAndSet(false, true)) {\n+            return;\n+        }\n+\n+        try (ShutdownRunner shutdownRunner = new ShutdownRunner()) {\n+            shutdownRunner.shutdownSafely(super::close);\n+            shutdownRunner.shutdownSafely(cleaner::close);\n+            shutdownRunner.shutdownSafely(keyValueService::close);\n+            shutdownRunner.shutdownSafely(() -> shutdownExecutor(deleteExecutor));\n+            shutdownRunner.shutdownSafely(() -> shutdownExecutor(getRangesExecutor));\n+            shutdownRunner.shutdownSafely(this::closeLockServiceIfPossible);\n+\n             for (Runnable callback : Lists.reverse(closingCallbacks)) {\n-                runShutdownCallbackSafely(callback).ifPresent(suppressedExceptions::add);\n+                shutdownRunner.shutdownSafely(callback);", "originalCommit": "4ee85dfb163e2bd7fd4be28cfe54dd546a418589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk2OTkwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392969901", "bodyText": "I will see what tests I can add, although there's already a whole bunch of tests for SnapshotTransactionManager to do with #close behavior", "author": "jkozlowski", "createdAt": "2020-03-16T12:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwMTc2Ng==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r393001766", "bodyText": "If I am not mistaken, none of them handle errors during the close.", "author": "Jolyon-S", "createdAt": "2020-03-16T12:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNDY5Mg==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r398524692", "bodyText": "Tests added, good shout. I was holding off until we agreed on approach.", "author": "jkozlowski", "createdAt": "2020-03-26T12:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDc0OQ=="}], "type": "inlineReview"}, {"oid": "e6a98a4f5b597054b0ad261ec26839d9e3a68bd2", "url": "https://github.com/palantir/atlasdb/commit/e6a98a4f5b597054b0ad261ec26839d9e3a68bd2", "message": "Save.", "committedDate": "2020-03-26T11:44:46Z", "type": "commit"}, {"oid": "73a22991f894d4f57ec3d9d2715dbfeff136edee", "url": "https://github.com/palantir/atlasdb/commit/73a22991f894d4f57ec3d9d2715dbfeff136edee", "message": "Merge branch 'develop' into safe-cleanup", "committedDate": "2020-03-26T11:45:07Z", "type": "commit"}, {"oid": "34c205ff90f808ef315e1ed69271ba6a5df40ad2", "url": "https://github.com/palantir/atlasdb/commit/34c205ff90f808ef315e1ed69271ba6a5df40ad2", "message": "Fixup", "committedDate": "2020-03-26T11:46:18Z", "type": "commit"}, {"oid": "7cd8b9c487a204304ca20ef2123b160aa0ee043a", "url": "https://github.com/palantir/atlasdb/commit/7cd8b9c487a204304ca20ef2123b160aa0ee043a", "message": "More tests.", "committedDate": "2020-03-26T12:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNTA1MQ==", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r398525051", "bodyText": "Diff here is much better in IntelliJ. The order should be exactly the same, just wrapped with shutdownSafely calls", "author": "jkozlowski", "createdAt": "2020-03-26T12:14:45Z", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -326,26 +326,23 @@ public void registerClosingCallback(Runnable closingCallback) {\n      */\n     @Override\n     public void close() {\n-        if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+        if (!isClosed.compareAndSet(false, true)) {\n+            return;\n+        }\n+\n+        try (ShutdownRunner shutdownRunner = new ShutdownRunner()) {\n+            shutdownRunner.shutdownSafely(super::close);", "originalCommit": "7cd8b9c487a204304ca20ef2123b160aa0ee043a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}