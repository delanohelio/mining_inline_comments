{"pr_number": 4519, "pr_title": "Shorter Nonblocking Calls, Part 2: Configurable Support in Parameters", "pr_createdAt": "2020-01-16T20:27:02Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4519", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5NTg5Nw==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367695897", "bodyText": "\ud83d\udc83", "author": "felixdesouza", "createdAt": "2020-01-16T23:07:44Z", "path": "atlasdb-conjure/src/main/java/com/palantir/atlasdb/http/v2/ClientOptions.java", "diffHunk": "@@ -33,28 +35,21 @@\n \n @Value.Immutable\n public abstract class ClientOptions {\n-    // TODO (jkong): Re-enable client QoS after response body leaks are handled correctly.\n-    // Throws after expected outages of 1/2 * 0.01 * (2^13 - 1) = 40.96 s\n-    public static final ClientOptions DEFAULT_RETRYING = ImmutableClientOptions.builder()\n-            .connectTimeout(Duration.ofSeconds(10))\n-            .readTimeout(Duration.ofSeconds(65))\n-            .backoffSlotSize(Duration.ofMillis(10))\n-            .failedUrlCooldown(Duration.ofMillis(100))\n-            .maxNumRetries(13)\n-            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n-            .build();\n+    private static final Duration CONNECT_TIMEOUT = Duration.ofMillis(500);\n \n-    // TODO (jkong): Re-enable client QoS after response body leaks are handled correctly.\n-    public static final ClientOptions DEFAULT_NO_RETRYING = ImmutableClientOptions.builder()\n-            .connectTimeout(Duration.ofSeconds(10))\n-            .readTimeout(Duration.ofSeconds(65))\n-            .backoffSlotSize(Duration.ofMillis(100))\n-            .failedUrlCooldown(Duration.ofMillis(1))\n-            .maxNumRetries(0)\n-            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n-            .build();\n+    @VisibleForTesting\n+    static final Duration NON_BLOCKING_READ_TIMEOUT = Duration.ofMillis(12566); // Odd number for debugging", "originalCommit": "236d0223ad7c917e854526c69884fa6209c65b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2MTU0Ng==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r368561546", "bodyText": "haha technically it's not \"odd\" \ud83d\ude1b", "author": "felixdesouza", "createdAt": "2020-01-20T13:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5NTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0ODkxMw==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r368948913", "bodyText": "The odd even number was intentional \ud83d\ude05", "author": "jeremyk-91", "createdAt": "2020-01-21T11:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5NTg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5Nzc4Ng==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367697786", "bodyText": "this test is kinda weird, there's no notion of default AuxiliaryRemotingParameters", "author": "felixdesouza", "createdAt": "2020-01-16T23:14:15Z", "path": "atlasdb-conjure/src/test/java/com/palantir/atlasdb/http/v2/ClientOptionsTest.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.http.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Duration;\n+\n+import org.junit.Test;\n+\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.conjure.java.client.config.ClientConfiguration;\n+\n+public class ClientOptionsTest {\n+    private static final UserAgent USER_AGENT = UserAgent.of(UserAgent.Agent.of(\"tom\", \"1.2.3\"));\n+\n+    // Throws after expected outages of 1/2 * 0.01 * (2^13 - 1) = 40.96 s\n+    private static final ClientOptions DEFAULT_RETRYING = ImmutableClientOptions.builder()\n+            .connectTimeout(Duration.ofMillis(500))\n+            .readTimeout(Duration.ofSeconds(65))\n+            .backoffSlotSize(Duration.ofMillis(10))\n+            .failedUrlCooldown(Duration.ofMillis(100))\n+            .maxNumRetries(13)\n+            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+            .build();\n+\n+    private static final ClientOptions DEFAULT_NO_RETRYING = ImmutableClientOptions.builder()\n+            .connectTimeout(Duration.ofMillis(500))\n+            .readTimeout(Duration.ofSeconds(65))\n+            .backoffSlotSize(Duration.ofMillis(10))\n+            .failedUrlCooldown(Duration.ofMillis(1))\n+            .maxNumRetries(0)\n+            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+            .build();\n+\n+    @Test\n+    public void proxyShouldSupportBlockingReadTimeoutIfUnspecified() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void proxyShouldSupportBlockingReadTimeoutIfExplicitlyConfigured() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .shouldSupportBlockingOperations(true)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void proxyShouldSupportNonBlockingReadTimeoutIfExplicitlyConfigured() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .shouldSupportBlockingOperations(false)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.NON_BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void defaultRetryingOptionsShouldMatchLegacyBehaviour() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()", "originalCommit": "236d0223ad7c917e854526c69884fa6209c65b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ4NTA5Nw==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r368485097", "bodyText": "Sure, yep. I changed this to minimallySpecified... as that's what I meant here", "author": "jeremyk-91", "createdAt": "2020-01-20T10:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5Nzc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5ODk5OQ==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367698999", "bodyText": "I suppose for the lock service, it's only the lock endpoint that you want to be able to block no?\nYou could create an impl of the lock service which uses the \"supports blocking operations\" for the lock method, and then the standard for everything else.", "author": "felixdesouza", "createdAt": "2020-01-16T23:17:46Z", "path": "atlasdb-remoting-api/src/main/java/com/palantir/atlasdb/config/AuxiliaryRemotingParameters.java", "diffHunk": "@@ -37,6 +37,17 @@\n      */\n     boolean shouldRetry();\n \n+    /**\n+     * Whether this client should support operations that block on the server side.\n+     * In practice, this means that read and idle connection timeouts may be longer.\n+     *\n+     * This is set to true by default, to support legacy behaviour.\n+     */\n+    @Value.Default\n+    default boolean shouldSupportBlockingOperations() {", "originalCommit": "236d0223ad7c917e854526c69884fa6209c65b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwMDA3Nw==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367700077", "bodyText": "oh, you did this in #4520 \ud83d\udc83", "author": "felixdesouza", "createdAt": "2020-01-16T23:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5ODk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5OTQwMQ==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367699401", "bodyText": "some docs would be good, to describe what the effect each combination will have, so we don't have to do the same exercise we did today, or even if we do, it's a lot easier.\neither here or the constants above.", "author": "felixdesouza", "createdAt": "2020-01-16T23:19:06Z", "path": "atlasdb-conjure/src/main/java/com/palantir/atlasdb/http/v2/ClientOptions.java", "diffHunk": "@@ -129,4 +124,27 @@ public static ClientOptions of(Duration connect, Duration read, Duration backoff\n                 .maxNumRetries(retries)\n                 .build();\n     }\n+\n+    static ClientOptions fromRemotingParameters(AuxiliaryRemotingParameters parameters) {\n+        ImmutableClientOptions.Builder builder = ImmutableClientOptions.builder();\n+\n+        setupTimeouts(builder, parameters);\n+        setupRetrying(builder, parameters);\n+\n+        return builder.clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+                .build();\n+    }\n+\n+    private static void setupTimeouts(ImmutableClientOptions.Builder builder, AuxiliaryRemotingParameters parameters) {", "originalCommit": "236d0223ad7c917e854526c69884fa6209c65b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ4NzQwMg==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r368487402", "bodyText": "Added a bit of explanation - I'm not sure exactly what you want, might be worth catching up if there are more specific things you'd like to be documented. Thanks!", "author": "jeremyk-91", "createdAt": "2020-01-20T10:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1ODY5Mg==", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r368558692", "bodyText": "This'll do, I suppose I wanted a way to codify our investigation, something along the lines of, anything below a proxy probably shouldn't retry etc. What the current setup is, if there are separate timelock to timelock configurations vs client to timelock etc.", "author": "felixdesouza", "createdAt": "2020-01-20T13:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5OTQwMQ=="}], "type": "inlineReview"}, {"oid": "4dd1d733c7991c02c88083074f3e3c8a14e189ba", "url": "https://github.com/palantir/atlasdb/commit/4dd1d733c7991c02c88083074f3e3c8a14e189ba", "message": "Refactor ClientOptions", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "afddbeb20f41135d166d363d0f22dc3220b8c8a1", "url": "https://github.com/palantir/atlasdb/commit/afddbeb20f41135d166d363d0f22dc3220b8c8a1", "message": "Master key", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "7865aad057b46d9cd3f8ca9f1650a42fe256b6a9", "url": "https://github.com/palantir/atlasdb/commit/7865aad057b46d9cd3f8ca9f1650a42fe256b6a9", "message": "Checkstyle and test artifacts", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "514c38b6bcb65487fb0d20e6d3a73197b08982d2", "url": "https://github.com/palantir/atlasdb/commit/514c38b6bcb65487fb0d20e6d3a73197b08982d2", "message": "AtomicLong", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "3d34fd4d78c39fa9638610d3e8524ed9fc0f5025", "url": "https://github.com/palantir/atlasdb/commit/3d34fd4d78c39fa9638610d3e8524ed9fc0f5025", "message": "More unusedness", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "url": "https://github.com/palantir/atlasdb/commit/5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "message": "Changelog", "committedDate": "2020-01-20T10:13:57Z", "type": "commit"}, {"oid": "5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "url": "https://github.com/palantir/atlasdb/commit/5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "message": "Changelog", "committedDate": "2020-01-20T10:13:57Z", "type": "forcePushed"}, {"oid": "a1a496aab4727881f670c825d109be02a58ab8fe", "url": "https://github.com/palantir/atlasdb/commit/a1a496aab4727881f670c825d109be02a58ab8fe", "message": "PR comments", "committedDate": "2020-01-20T10:58:31Z", "type": "commit"}, {"oid": "eca253a7aba241fc15309cc5ef0ec43150a9da60", "url": "https://github.com/palantir/atlasdb/commit/eca253a7aba241fc15309cc5ef0ec43150a9da60", "message": "move comments to constant", "committedDate": "2020-01-20T15:26:18Z", "type": "commit"}]}