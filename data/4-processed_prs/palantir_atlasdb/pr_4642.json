{"pr_number": 4642, "pr_title": "Allow easy migration from/to thorough sweep", "pr_createdAt": "2020-03-10T10:22:24Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4642", "timeline": [{"oid": "14180f25182fe3a81b7246c9b52aa5c94fafeb0d", "url": "https://github.com/palantir/atlasdb/commit/14180f25182fe3a81b7246c9b52aa5c94fafeb0d", "message": "Allow easy migration from/to thorough sweep\n\nThis PR adds a new sweep strategy, thorough_migration.\nIt forces the lock checking of thorough sweep, whilst actually behaving\nlike conservative sweep.\n\nIn this way, to migrate to thorough sweep, you simply:\n\n1. Change to thorough_migration.\n2. Make sure all nodes are on the new version (via e.g. schema version\nbump).\n3. Change to thorough.\n\nSame in reverse safely migrates you back to conservative.", "committedDate": "2020-03-10T10:20:02Z", "type": "commit"}, {"oid": "cf78b7e02ad872e884fd00f733f306e20256ba82", "url": "https://github.com/palantir/atlasdb/commit/cf78b7e02ad872e884fd00f733f306e20256ba82", "message": "To thorough", "committedDate": "2020-03-10T10:24:36Z", "type": "commit"}, {"oid": "a8048dff399ed9eddb8b800efd36d4ee9300c5ad", "url": "https://github.com/palantir/atlasdb/commit/a8048dff399ed9eddb8b800efd36d4ee9300c5ad", "message": "Fix writeinfo partitioner", "committedDate": "2020-03-10T10:36:12Z", "type": "commit"}, {"oid": "4fc729cfaede9eed0b72cab1c9fa821784b155ff", "url": "https://github.com/palantir/atlasdb/commit/4fc729cfaede9eed0b72cab1c9fa821784b155ff", "message": "Tests", "committedDate": "2020-03-10T10:45:06Z", "type": "commit"}, {"oid": "9f95ba182e66f27aa369bc5ddab66edef207b97a", "url": "https://github.com/palantir/atlasdb/commit/9f95ba182e66f27aa369bc5ddab66edef207b97a", "message": "Add generated changelog entries", "committedDate": "2020-03-10T10:45:06Z", "type": "commit"}, {"oid": "b447f76217fb642d1121c61e54c954c4b63b67a0", "url": "https://github.com/palantir/atlasdb/commit/b447f76217fb642d1121c61e54c954c4b63b67a0", "message": "fix tests", "committedDate": "2020-03-10T10:54:57Z", "type": "commit"}, {"oid": "8051a690de3e01427e0b8d7dde4d923aff9937a7", "url": "https://github.com/palantir/atlasdb/commit/8051a690de3e01427e0b8d7dde4d923aff9937a7", "message": "t push\nMerge branch 'jbaker/to_thorough' of github.com:palantir/atlasdb into jbaker/to_thorough", "committedDate": "2020-03-10T10:55:14Z", "type": "commit"}, {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711", "url": "https://github.com/palantir/atlasdb/commit/27d636fb2967ef7bab814e3a2b833d9af15fa711", "message": "Imports", "committedDate": "2020-03-10T12:46:26Z", "type": "commit"}, {"oid": "5cf09d8315003c40c11c377e3b0e91260f79683a", "url": "https://github.com/palantir/atlasdb/commit/5cf09d8315003c40c11c377e3b0e91260f79683a", "message": "Add generated changelog entries", "committedDate": "2020-03-10T12:46:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4ODc1MA==", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390388750", "bodyText": "Could we change the message to something like - \"Can only read from a table with a no/conservative sweep strategy in a read only transaction.\" ?", "author": "sudiksha27", "createdAt": "2020-03-10T15:12:07Z", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/ReadTransaction.java", "diffHunk": "@@ -127,7 +126,7 @@ public Transaction delegate() {\n \n     private void checkTableName(TableReference tableRef) {\n         SweepStrategy sweepStrategy = sweepStrategies.get(tableRef);\n-        if (sweepStrategy == SweepStrategy.THOROUGH) {\n+        if (sweepStrategy.mustCheckImmutableLockAfterReads()) {\n             throw new SafeIllegalStateException(\n                     \"Cannot read from a table with a thorough sweep strategy in a read only transaction.\");\n         }", "originalCommit": "27d636fb2967ef7bab814e3a2b833d9af15fa711", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NTA0OQ==", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390485049", "bodyText": "done", "author": "j-baker", "createdAt": "2020-03-10T17:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4ODc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMTUzMg==", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390421532", "bodyText": "I guess this is fine, would add a bit of caution saying please talk to the AtlasDB team before you do this (if someone forgets that you must e.g. declare an internal schema version in internal framework, then they open themselves to corruption).", "author": "jeremyk-91", "createdAt": "2020-03-10T15:55:16Z", "path": "changelog/@unreleased/pr-4642.v2.yml", "diffHunk": "@@ -0,0 +1,5 @@\n+type: improvement\n+improvement:\n+  description: Allow easy migration from/to thorough sweep", "originalCommit": "27d636fb2967ef7bab814e3a2b833d9af15fa711", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MTE2Mw==", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390481163", "bodyText": "done", "author": "j-baker", "createdAt": "2020-03-10T17:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMTUzMg=="}], "type": "inlineReview"}, {"oid": "382c5d78462bcceb1e76ad6937bbd8318d66cca8", "url": "https://github.com/palantir/atlasdb/commit/382c5d78462bcceb1e76ad6937bbd8318d66cca8", "message": "Error message change", "committedDate": "2020-03-10T17:27:05Z", "type": "commit"}, {"oid": "fa4714f6f1f372cff552032a6b89d5e3baafe983", "url": "https://github.com/palantir/atlasdb/commit/fa4714f6f1f372cff552032a6b89d5e3baafe983", "message": "Merge branch 'jbaker/to_thorough' of github.com:palantir/atlasdb into jbaker/to_thorough", "committedDate": "2020-03-10T17:27:28Z", "type": "commit"}]}