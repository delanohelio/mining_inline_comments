{"pr_number": 4948, "pr_title": "[PDS-130107] Enable Divergent KVS Namespaces and TimeLock Clients", "pr_createdAt": "2020-08-14T15:10:30Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4948", "timeline": [{"oid": "fe7214de26352cfd1f00950a6746af60a75c314e", "url": "https://github.com/palantir/atlasdb/commit/fe7214de26352cfd1f00950a6746af60a75c314e", "message": "config", "committedDate": "2020-08-14T15:07:35Z", "type": "commit"}, {"oid": "4978613621371ebe2d6e3c41f3774be728ffb133", "url": "https://github.com/palantir/atlasdb/commit/4978613621371ebe2d6e3c41f3774be728ffb133", "message": "Add generated changelog entries", "committedDate": "2020-08-14T15:07:35Z", "type": "commit"}, {"oid": "cc577250ecf3068b102e78021537dbcef2d0fb8d", "url": "https://github.com/palantir/atlasdb/commit/cc577250ecf3068b102e78021537dbcef2d0fb8d", "message": "flatmpa", "committedDate": "2020-08-14T15:12:17Z", "type": "commit"}, {"oid": "1285d70d323229c9bd270a731eabbd371b1ec0af", "url": "https://github.com/palantir/atlasdb/commit/1285d70d323229c9bd270a731eabbd371b1ec0af", "message": "Merge branch 'jkong/aaaargh' of github.com:palantir/atlasdb into jkong/aaaargh", "committedDate": "2020-08-14T15:27:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY5MjU4OA==", "url": "https://github.com/palantir/atlasdb/pull/4948#discussion_r470692588", "bodyText": "nit: remove com.palantir.logsafe?", "author": "sudiksha27", "createdAt": "2020-08-14T15:23:04Z", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/AtlasDbConfig.java", "diffHunk": "@@ -319,69 +333,56 @@ private static void checkServersListHasAtLeastOneServerIfPresent(Optional<Server\n                         \"Server list must have at least one server.\"));\n     }\n \n-    private String checkNamespaceConfigAndGetNamespace() {\n+    private void checkNamespaceConfigConsistent() {\n         if (namespace().isPresent()) {\n-            String namespaceConfigValue = namespace().get();\n-\n-            Preconditions.checkState(!namespaceConfigValue.contains(\"\\\"\"),\n-                    \"Namespace should not be quoted\");\n+            String presentNamespace = namespace().get();\n+            Preconditions.checkState(!presentNamespace.contains(\"\\\"\"), \"Namespace should not be quoted\");\n \n             keyValueService().namespace().ifPresent(kvsNamespace ->\n-                    com.palantir.logsafe.Preconditions.checkState(kvsNamespace.equals(namespaceConfigValue),\n+                    Preconditions.checkState(kvsNamespace.equals(presentNamespace),\n                             \"If present, keyspace/dbName/sid config should be the same as the\"\n                                     + \" atlas root-level namespace config.\"));\n \n             timelock().ifPresent(timelock -> timelock.client().ifPresent(client ->\n-                    com.palantir.logsafe.Preconditions.checkState(client.equals(namespaceConfigValue),\n+                    Preconditions.checkState(client.equals(presentNamespace),\n                             \"If present, the TimeLock client config should be the same as the\"\n                                     + \" atlas root-level namespace config.\")));\n-            return namespaceConfigValue;\n-        } else if (!(keyValueService() instanceof InMemoryAtlasDbConfig)) {\n-            com.palantir.logsafe.Preconditions.checkState(keyValueService().namespace().isPresent(),\n-                    \"Either the atlas root-level namespace\"\n-                            + \" or the keyspace/dbName/sid config needs to be set.\");\n+            return;\n+        }\n \n-            String keyValueServiceNamespace = keyValueService().namespace().get();\n+        // There is no top level namespace\n+        if (keyValueService() instanceof InMemoryAtlasDbConfig) {\n+            if (timelock().isPresent() && !timelock().get().client().isPresent()) {\n+                throw new SafeIllegalStateException(\"For InMemoryKVS, the TimeLock client should not be empty\");\n+            }\n+            return;\n+        }\n \n-            Preconditions.checkState(!keyValueServiceNamespace.contains(\"\\\"\"),\n-                    \"KeyValueService namespace should not be quoted\");\n+        // There is no top level namespace AND the config is not an in-memory config\n+        Preconditions.checkState(keyValueService().namespace().isPresent(),\n+                \"Either the atlas root-level namespace\"\n+                        + \" or the keyspace/dbName/sid config needs to be set.\");\n+        String keyValueServiceNamespace = keyValueService().namespace().get();\n+        Preconditions.checkState(!keyValueServiceNamespace.contains(\"\\\"\"),\n+                \"KeyValueService namespace should not be quoted\");\n \n-            if (timelock().isPresent()) {\n-                TimeLockClientConfig timeLockConfig = timelock().get();\n+        if (timelock().isPresent()) {\n+            TimeLockClientConfig timeLockConfig = timelock().get();\n \n-                com.palantir.logsafe.Preconditions.checkState(timeLockConfig.client().isPresent(),\n-                        \"Either the atlas root-level namespace config or the TimeLock client config\"\n-                                + \" should be present.\");\n+            com.palantir.logsafe.Preconditions.checkState(timeLockConfig.client().isPresent(),\n+                    \"Either the atlas root-level namespace config or the TimeLock client config should be present.\");", "originalCommit": "4978613621371ebe2d6e3c41f3774be728ffb133", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c01fbdbd6a46ebb13e34fc63b7df0e4566049ec", "url": "https://github.com/palantir/atlasdb/commit/8c01fbdbd6a46ebb13e34fc63b7df0e4566049ec", "message": "nit", "committedDate": "2020-08-14T16:27:33Z", "type": "commit"}, {"oid": "1fd830cc07b6f849b5efca301d0c92d536d30f07", "url": "https://github.com/palantir/atlasdb/commit/1fd830cc07b6f849b5efca301d0c92d536d30f07", "message": "baseline", "committedDate": "2020-08-14T16:28:48Z", "type": "commit"}]}