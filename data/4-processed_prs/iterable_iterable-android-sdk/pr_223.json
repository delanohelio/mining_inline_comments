{"pr_number": 223, "pr_title": "Adds Campaign ID to IterableInAppMessage", "pr_createdAt": "2020-04-19T23:02:06Z", "pr_url": "https://github.com/Iterable/iterable-android-sdk/pull/223", "timeline": [{"oid": "24681786617d2a53ada0ef912a83667832f51573", "url": "https://github.com/Iterable/iterable-android-sdk/commit/24681786617d2a53ada0ef912a83667832f51573", "message": "Adds campaignId to IterableInAppMessage\n\nThis parses a missing key or a null value for the JSON `clientId` as an\nempty string, just like the Swift SDK", "committedDate": "2020-04-17T21:01:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxMjI5NA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r411012294", "bodyText": "Removed redundant import.", "author": "nkotula", "createdAt": "2020-04-19T23:08:58Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppMessage.java", "diffHunk": "@@ -7,7 +7,6 @@\n import androidx.annotation.RestrictTo;\n import androidx.core.util.ObjectsCompat;\n \n-import org.json.JSONArray;", "originalCommit": "24681786617d2a53ada0ef912a83667832f51573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxMjQxMw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r411012413", "bodyText": "I reorganized the code here because I find this easier to read, but this is solely a code style change and I could revert this back to one line if that's preferred.", "author": "nkotula", "createdAt": "2020-04-19T23:09:38Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppMessage.java", "diffHunk": "@@ -30,8 +30,18 @@\n     private boolean loadedHtmlFromJson = false;\n     private @Nullable IterableInAppStorage inAppStorageInterface;\n \n-    IterableInAppMessage(@NonNull String messageId, @NonNull Content content, @NonNull JSONObject customPayload, @NonNull Date createdAt, @NonNull Date expiresAt, @NonNull Trigger trigger, @Nullable Boolean saveToInbox, @Nullable InboxMetadata inboxMetadata) {\n+    IterableInAppMessage(@NonNull String messageId,\n+                         @NonNull String campaignId,\n+                         @NonNull Content content,\n+                         @NonNull JSONObject customPayload,\n+                         @NonNull Date createdAt,\n+                         @NonNull Date expiresAt,\n+                         @NonNull Trigger trigger,\n+                         @Nullable Boolean saveToInbox,\n+                         @Nullable InboxMetadata inboxMetadata) {", "originalCommit": "24681786617d2a53ada0ef912a83667832f51573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxMjgyMQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r411012821", "bodyText": "Again, I find this style of constructor/method invocation where parameters are on individual lines much more readable, but I could very easily revert this as it is only code-style related.  The core change is to simply add the campaignId to the constructor invocation.", "author": "nkotula", "createdAt": "2020-04-19T23:11:41Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppMessage.java", "diffHunk": "@@ -306,8 +322,17 @@ static IterableInAppMessage fromJSONObject(@NonNull JSONObject messageJson, @Nul\n         JSONObject inboxPayloadJson = messageJson.optJSONObject(IterableConstants.ITERABLE_IN_APP_INBOX_METADATA);\n         InboxMetadata inboxMetadata = InboxMetadata.fromJSONObject(inboxPayloadJson);\n \n-        IterableInAppMessage message = new IterableInAppMessage(messageId,\n-                new Content(html, padding, backgroundAlpha), customPayload, createdAt, expiresAt, trigger, saveToInbox, inboxMetadata);\n+        IterableInAppMessage message = new IterableInAppMessage(\n+                messageId,\n+                campaignId,\n+                new Content(html, padding, backgroundAlpha),\n+                customPayload,\n+                createdAt,\n+                expiresAt,\n+                trigger,\n+                saveToInbox,\n+                inboxMetadata);", "originalCommit": "24681786617d2a53ada0ef912a83667832f51573", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "768a55ea6ca04c7ce017c0294216524d7b3abcc2", "url": "https://github.com/Iterable/iterable-android-sdk/commit/768a55ea6ca04c7ce017c0294216524d7b3abcc2", "message": "Changes clientId to Long with validation checks", "committedDate": "2020-04-22T17:46:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413197847", "bodyText": "I'd make it return long and default to 0. Long is here only to serialize/deserialize properly, for a consumer of this API it shouldn't matter whether it is 0 or null.", "author": "vbabenkoru", "createdAt": "2020-04-22T17:58:33Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppMessage.java", "diffHunk": "@@ -193,6 +203,11 @@ public String getMessageId() {\n         return messageId;\n     }\n \n+    @Nullable\n+    public Long getCampaignId() {", "originalCommit": "768a55ea6ca04c7ce017c0294216524d7b3abcc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MzE2NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413363165", "bodyText": "Okay, trying some push-back here...  I hope I don't overstep my bounds \ud83d\ude05\nAs a consumer of any API, I actually prefer the distinction between null and a value being present.  null to me clearly states that a value is not present, and more importantly, it shows that a value can be missing.  By changing this to a primitive long, a consumer of this API might assume the value is always present in every message, which could lead to unexpected behavior.  Also, they would not be able to tell the difference between a campaign ID that was missing from the message, and one where the campaign ID is actually 0.\nAnother reason I don't like defaulting to 0 is that it has a kind of \"magic number\" feeling to it.  I as the consumer would have to know what 0 means in the context of this API.  Some maintainer down the line could see a line like this: if (message.getCampaignId() > 0), and think, \"wait, is 0 a valid campaign ID?\"  If instead they saw this:  if (message.getCampaignId() != null) they would immediately know that we're checking if the value is present or not.\nThose are my thoughts on the issue.  After programming in Kotlin for so long, I've become accustomed to the ease-of-use surrounding nullables and leveraging them to alleviate the risks I described above.  I know that Java makes null-checking like this very verbose, so if primitives are still preferred, I will change it as you described \ud83d\ude03", "author": "nkotula", "createdAt": "2020-04-22T22:01:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MzYzMg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413363632", "bodyText": "It is actually present in responses to all API calls to inApp/getMessages per our API spec.", "author": "vbabenkoru", "createdAt": "2020-04-22T22:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2Mzk2MA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413363960", "bodyText": "Because of this I'm not sure additional null-checking and validation is necessary here..", "author": "vbabenkoru", "createdAt": "2020-04-22T22:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NDM3NQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413364375", "bodyText": "Oh!  Lol that settles that!  I'll change it \ud83d\udc4d", "author": "nkotula", "createdAt": "2020-04-22T22:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NDgzOQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413364839", "bodyText": "Sorry for the confusion..", "author": "vbabenkoru", "createdAt": "2020-04-22T22:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NTc2Ng==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413365766", "bodyText": "And campaignId is also declared as plain int (should make it long at some point) elsewhere, in IterableAttributionInfo. I would make it long in this case, the only reason to keep it nullable internally is to make the tests pass until we add campaignId to all test JSON payloads (how did I even miss that? \ud83e\udd26\u200d\u2642\ufe0f).", "author": "vbabenkoru", "createdAt": "2020-04-22T22:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2NzY5MA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r413367690", "bodyText": "Oh!  Okay, so do the check for null and convert null to 0 in the getter?\nEDIT: That should bridge the gap between this first pass at getting the ID into IterableInAppMessage and when the rest of the API catches up, correct?", "author": "nkotula", "createdAt": "2020-04-22T22:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1OTU5MA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414759590", "bodyText": "So... @vbabenkoru I just did a check with an SSL proxy, and I see that when I send proofs to my device, the campaignId is indeed not present in the raw message JSON with calls to getMessages?email=my.email.here@example.com.  Are we sure we shouldn't keep this nullable?", "author": "nkotula", "createdAt": "2020-04-24T17:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2MTY3OQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414761679", "bodyText": "@nkotula Just went to check again.. You're right, sorry for the confusion. It totally makes sense to make it a nullable Long.", "author": "vbabenkoru", "createdAt": "2020-04-24T17:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc2NDM5OA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414764398", "bodyText": "Okay, cool beans.  I'll go ahead and revert that change.", "author": "nkotula", "createdAt": "2020-04-24T18:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzg0Nw=="}], "type": "inlineReview"}, {"oid": "079f84fe0d797d99b2590bdb9f146af22259724f", "url": "https://github.com/Iterable/iterable-android-sdk/commit/079f84fe0d797d99b2590bdb9f146af22259724f", "message": "Make public campaign ID getter non-null", "committedDate": "2020-04-23T14:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414084804", "bodyText": "Why not just use an inline ternary rather than creating separate retrieval/validation methods?\nfinal Long campaignId = (messageJson.isNull(IterableConstants.KEY_CAMPAIGN_ID)) ? null :\njsonObject.optLong(IterableConstants.KEY_CAMPAIGN_ID);", "author": "davidtruong", "createdAt": "2020-04-23T20:00:04Z", "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableInAppMessage.java", "diffHunk": "@@ -281,6 +299,7 @@ static IterableInAppMessage fromJSONObject(@NonNull JSONObject messageJson, @Nul\n         }\n \n         String messageId = messageJson.optString(IterableConstants.KEY_MESSAGE_ID);\n+        final Long campaignId = IterableUtil.retrieveValidCampaignIdOrNull(messageJson, IterableConstants.KEY_CAMPAIGN_ID);", "originalCommit": "079f84fe0d797d99b2590bdb9f146af22259724f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjA2Mg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414092062", "bodyText": "I see from the comments that you are checking for a valid non negative campaignId. Not sure if that check is necessary.", "author": "davidtruong", "createdAt": "2020-04-23T20:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMzI4OQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414103289", "bodyText": "My thought was to centralize validation logic to be used elsewhere.  That, and I had it in my head that it shouldn't be the responsibility of IterableInAppMessage to know how to validate the ID, just in case that validation could ever change in the future.  That may not be relevant here, but that's what I was considering when breaking this out into a Util method.", "author": "nkotula", "createdAt": "2020-04-23T20:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4MDIxOQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414780219", "bodyText": "@nkotula Do you prefer to validate all data from API responses? My thought was that if there is an API contract, we shouldn't have to do client-side validation (unless it is something that may cause crashes).", "author": "vbabenkoru", "createdAt": "2020-04-24T18:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5MTAzNg==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r414791036", "bodyText": "I do prefer to sanity-check data integrity on the client-side, but that is totally a personal preference.  To me, having both client-side and server-side validation of the same data makes the system as a whole more resilient because they can provide checks against each other, but it comes at the cost of a larger burden on the maintainers.  I will defer to your team as to whether this should be moved to an inline ternary operation as David mentioned.", "author": "nkotula", "createdAt": "2020-04-24T18:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2NTY2OQ==", "url": "https://github.com/Iterable/iterable-android-sdk/pull/223#discussion_r415965669", "bodyText": "I think it's ok to keep it. Thanks!", "author": "vbabenkoru", "createdAt": "2020-04-27T16:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDgwNA=="}], "type": "inlineReview"}, {"oid": "a17487fdfc88eb05e3c19b4ff1e061af2ac19a7f", "url": "https://github.com/Iterable/iterable-android-sdk/commit/a17487fdfc88eb05e3c19b4ff1e061af2ac19a7f", "message": "Revert \"Make public campaign ID getter non-null\"\n\nThis reverts commit 079f84fe0d797d99b2590bdb9f146af22259724f.\nPer discussion in PR, this value is indeed optional in the JSON, so it\nis appropriate to leave it nullable.", "committedDate": "2020-04-24T18:12:28Z", "type": "commit"}, {"oid": "34fa48064d597fcd990fdabedd11a137b1f74ee6", "url": "https://github.com/Iterable/iterable-android-sdk/commit/34fa48064d597fcd990fdabedd11a137b1f74ee6", "message": "Merge branch 'master' into feature/campaign-id-visibility", "committedDate": "2020-04-28T20:50:23Z", "type": "commit"}]}