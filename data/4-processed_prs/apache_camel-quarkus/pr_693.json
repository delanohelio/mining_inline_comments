{"pr_number": 693, "pr_title": "Add olingo4 extension", "pr_createdAt": "2020-02-11T09:35:49Z", "pr_url": "https://github.com/apache/camel-quarkus/pull/693", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3ODYxNQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377578615", "bodyText": "Do you happen to know if this is necessary also on Camel master? If not, a comment would be handy that it can be removed after Camel 3.1. Otherwise, a Camel issue would be nice requiring to fix what is necessary in Camel.", "author": "ppalaga", "createdAt": "2020-02-11T11:28:45Z", "path": "extensions/olingo4/deployment/src/main/java/org/apache/camel/quarkus/component/olingo4/deployment/Olingo4Processor.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.quarkus.component.olingo4.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.AdditionalApplicationArchiveMarkerBuildItem;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import org.apache.camel.component.olingo4.Olingo4AppEndpointConfiguration;\n+import org.apache.camel.quarkus.core.deployment.UnbannedReflectiveBuildItem;\n+import org.apache.olingo.server.core.ODataImpl;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+class Olingo4Processor {\n+\n+    private static final String FEATURE = \"camel-olingo4\";\n+    private static final DotName JSON_DESERIALIZE_DOT_NAME = DotName\n+            .createSimple(\"com.fasterxml.jackson.databind.annotation.JsonDeserialize\");\n+\n+    @BuildStep\n+    FeatureBuildItem feature() {\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep\n+    UnbannedReflectiveBuildItem whitelistOlingo4AppEndpointConfiguration() {\n+        return new UnbannedReflectiveBuildItem(Olingo4AppEndpointConfiguration.class.getName());", "originalCommit": "85b293f43e94ba460539987933b72f25e6caed33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4NTc1MQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377585751", "bodyText": "I have not checked. I assume it is fixed, but I can add a note. We could eventually remove this  on the camel-master branch.", "author": "jamesnetherton", "createdAt": "2020-02-11T11:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3ODYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTI5Mg==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377579292", "bodyText": "I think this done by Quarkus Jackson extension. If that's really the case, we should perhaps prefer depending on them.", "author": "ppalaga", "createdAt": "2020-02-11T11:30:10Z", "path": "extensions/olingo4/deployment/src/main/java/org/apache/camel/quarkus/component/olingo4/deployment/Olingo4Processor.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.quarkus.component.olingo4.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.AdditionalApplicationArchiveMarkerBuildItem;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import org.apache.camel.component.olingo4.Olingo4AppEndpointConfiguration;\n+import org.apache.camel.quarkus.core.deployment.UnbannedReflectiveBuildItem;\n+import org.apache.olingo.server.core.ODataImpl;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+class Olingo4Processor {\n+\n+    private static final String FEATURE = \"camel-olingo4\";\n+    private static final DotName JSON_DESERIALIZE_DOT_NAME = DotName\n+            .createSimple(\"com.fasterxml.jackson.databind.annotation.JsonDeserialize\");\n+\n+    @BuildStep\n+    FeatureBuildItem feature() {\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep\n+    UnbannedReflectiveBuildItem whitelistOlingo4AppEndpointConfiguration() {\n+        return new UnbannedReflectiveBuildItem(Olingo4AppEndpointConfiguration.class.getName());\n+    }\n+\n+    @BuildStep\n+    AdditionalApplicationArchiveMarkerBuildItem olingoArchiveMarker() {\n+        return new AdditionalApplicationArchiveMarkerBuildItem(\"org/apache/olingo\");\n+    }\n+\n+    @BuildStep\n+    void registerForReflection(BuildProducer<ReflectiveClassBuildItem> reflectiveClass, CombinedIndexBuildItem combinedIndex) {\n+        reflectiveClass.produce(new ReflectiveClassBuildItem(true, false, ODataImpl.class));\n+        reflectiveClass.produce(new ReflectiveClassBuildItem(true, true, Olingo4AppEndpointConfiguration.class));\n+\n+        // Register Olingo Deserializer classes for reflection\n+        IndexView index = combinedIndex.getIndex();\n+        index.getAnnotations(JSON_DESERIALIZE_DOT_NAME)", "originalCommit": "85b293f43e94ba460539987933b72f25e6caed33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4NTc5OQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377585799", "bodyText": "I'll double check, but I didn't see this being done by the Jackson extension.", "author": "jamesnetherton", "createdAt": "2020-02-11T11:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NDA0NQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377594045", "bodyText": "Here is what they do https://github.com/quarkusio/quarkus/blob/master/extensions/jackson/deployment/src/main/java/io/quarkus/jackson/deployment/JacksonProcessor.java#L94", "author": "ppalaga", "createdAt": "2020-02-11T12:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwODQ3Ng==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377608476", "bodyText": "The Quarkus Jackson extension seems to ignore cases like this:\n@JsonDeserialize(using = ClientCsdlAction.ActionDeserializer.class)\nclass ClientCsdlAction extends CsdlAction implements Serializable {\n...\n}\nIt only takes the using part into consideration where the annotation is applied to a field or method.\nI can add a comment about that and maybe raise an issue on the Quarkus side.", "author": "jamesnetherton", "createdAt": "2020-02-11T12:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTk0OA==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377579948", "bodyText": "Hm... why is this filter actually required?", "author": "ppalaga", "createdAt": "2020-02-11T11:31:44Z", "path": "extensions/olingo4/deployment/src/main/java/org/apache/camel/quarkus/component/olingo4/deployment/Olingo4Processor.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.quarkus.component.olingo4.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.AdditionalApplicationArchiveMarkerBuildItem;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import org.apache.camel.component.olingo4.Olingo4AppEndpointConfiguration;\n+import org.apache.camel.quarkus.core.deployment.UnbannedReflectiveBuildItem;\n+import org.apache.olingo.server.core.ODataImpl;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+class Olingo4Processor {\n+\n+    private static final String FEATURE = \"camel-olingo4\";\n+    private static final DotName JSON_DESERIALIZE_DOT_NAME = DotName\n+            .createSimple(\"com.fasterxml.jackson.databind.annotation.JsonDeserialize\");\n+\n+    @BuildStep\n+    FeatureBuildItem feature() {\n+        return new FeatureBuildItem(FEATURE);\n+    }\n+\n+    @BuildStep\n+    UnbannedReflectiveBuildItem whitelistOlingo4AppEndpointConfiguration() {\n+        return new UnbannedReflectiveBuildItem(Olingo4AppEndpointConfiguration.class.getName());\n+    }\n+\n+    @BuildStep\n+    AdditionalApplicationArchiveMarkerBuildItem olingoArchiveMarker() {\n+        return new AdditionalApplicationArchiveMarkerBuildItem(\"org/apache/olingo\");\n+    }\n+\n+    @BuildStep\n+    void registerForReflection(BuildProducer<ReflectiveClassBuildItem> reflectiveClass, CombinedIndexBuildItem combinedIndex) {\n+        reflectiveClass.produce(new ReflectiveClassBuildItem(true, false, ODataImpl.class));\n+        reflectiveClass.produce(new ReflectiveClassBuildItem(true, true, Olingo4AppEndpointConfiguration.class));\n+\n+        // Register Olingo Deserializer classes for reflection\n+        IndexView index = combinedIndex.getIndex();\n+        index.getAnnotations(JSON_DESERIALIZE_DOT_NAME)\n+                .stream()\n+                .map(annotation -> annotation.value(\"using\").asClass().name().toString())\n+                .filter(className -> className.startsWith(\"org.apache.olingo\"))", "originalCommit": "85b293f43e94ba460539987933b72f25e6caed33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4NTkzNQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377585935", "bodyText": "Should the extension concern itself with configuring reflection for stuff that is not associated with it? E.g non-olingo stuff.", "author": "jamesnetherton", "createdAt": "2020-02-11T11:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5NjQ5Mg==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377596492", "bodyText": "OK, I see the problem. Hard to say, I am not acquainted well enough with olingo. Are the users likely to write their own deserializers to be able to use the olingo extension?", "author": "ppalaga", "createdAt": "2020-02-11T12:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwOTE4Nw==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377609187", "bodyText": "I don't think folks are going to want to write their own deserializers when interacting with the olingo component extension. So for now, I'd say it's safe to include the filter.\nIt will be simple enough to remove if we get feedback that proves that we don't need it.", "author": "jamesnetherton", "createdAt": "2020-02-11T12:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU3OTk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MDQ3NQ==", "url": "https://github.com/apache/camel-quarkus/pull/693#discussion_r377580475", "bodyText": "I appreciate the comment!", "author": "ppalaga", "createdAt": "2020-02-11T11:32:56Z", "path": "extensions/support/httpclient/deployment/src/main/java/org/apache/camel/quarkus/support/httpclient/deployment/HttpClientProcessor.java", "diffHunk": "@@ -45,4 +46,10 @@ void registerForReflection(\n             reflectiveClasses.produce(new ReflectiveClassBuildItem(true, false, info.name().toString()));\n         }\n     }\n+\n+    @BuildStep\n+    NativeImageResourceBuildItem suffixListResource() {\n+        // Required by org.apache.http.conn.util.PublicSuffixMatcher", "originalCommit": "85b293f43e94ba460539987933b72f25e6caed33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "07fc9c75a3925b535e219c7b22c2042507f09558", "url": "https://github.com/apache/camel-quarkus/commit/07fc9c75a3925b535e219c7b22c2042507f09558", "message": "Add olingo4 extension\n\nfixes #692", "committedDate": "2020-02-11T13:34:46Z", "type": "commit"}, {"oid": "07fc9c75a3925b535e219c7b22c2042507f09558", "url": "https://github.com/apache/camel-quarkus/commit/07fc9c75a3925b535e219c7b22c2042507f09558", "message": "Add olingo4 extension\n\nfixes #692", "committedDate": "2020-02-11T13:34:46Z", "type": "forcePushed"}]}