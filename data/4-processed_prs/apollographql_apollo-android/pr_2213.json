{"pr_number": 2213, "pr_title": "Take nullity into account to generate correct code", "pr_createdAt": "2020-04-24T20:31:44Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2213", "timeline": [{"oid": "dd5a8b7e0eefb60a5232f96e6c3abed6be7f1d13", "url": "https://github.com/apollographql/apollo-android/commit/dd5a8b7e0eefb60a5232f96e6c3abed6be7f1d13", "message": "Take nullity into account to generate correct code", "committedDate": "2020-04-24T20:31:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwMzQ3NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2213#discussion_r414903475", "bodyText": "hm, that strange why do we have this in ResponseWriter:\ninterface ListWriter<T> {\n    fun write(items: List<T>?, listItemWriter: ListItemWriter)\n  }\n\nI have to double check, as it looks like it should be:\ninterface ListWriter<T> {\n    fun write(items: List<T>, listItemWriter: ListItemWriter)\n  }\n\nAnd the reason why I'm confused is that we check for null before:\n  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n    if (values == null) {\n      data[field.responseName] = null\n    } else {\n      val listItemWriter = CustomListItemWriter(scalarTypeAdapters)\n      listWriter.write(values, listItemWriter)\n      data[field.responseName] = listItemWriter.data\n    }\n  }", "author": "sav007", "createdAt": "2020-04-24T22:45:12Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/codegen/kotlin/KotlinCodeGen.kt", "diffHunk": "@@ -331,25 +347,31 @@ internal object KotlinCodeGen {\n     }\n   }\n \n-  private val FieldType.writeListItemCode: CodeBlock\n+  private val FieldType.Array.writeListItemCode: CodeBlock\n     get() {\n-      return when (this) {\n-        is FieldType.Scalar -> when (this) {\n+      val safeValue = if (isOptional) \"value?\" else \"value\"\n+      return when (rawType) {\n+        is FieldType.Scalar -> when (rawType) {\n           is FieldType.Scalar.String -> CodeBlock.of(\"listItemWriter.writeString(value)\")\n           is FieldType.Scalar.Int -> CodeBlock.of(\"listItemWriter.writeInt(value)\")\n           is FieldType.Scalar.Boolean -> CodeBlock.of(\"listItemWriter.writeBoolean(value)\")\n           is FieldType.Scalar.Float -> CodeBlock.of(\"listItemWriter.writeDouble(value)\")\n-          is FieldType.Scalar.Enum -> CodeBlock.of(\"listItemWriter.writeString(value?.rawValue)\")\n-          is FieldType.Scalar.Custom -> CodeBlock.of(\"listItemWriter.writeCustom(%T.%L, value)\", customEnumType.asTypeName(),\n-              customEnumConst)\n+          is FieldType.Scalar.Enum -> CodeBlock.of(\"listItemWriter.writeString($safeValue.rawValue)\")\n+          is FieldType.Scalar.Custom -> {\n+            CodeBlock.of(\"listItemWriter.writeCustom(%T.%L, value)\", rawType.customEnumType.asTypeName(), rawType.customEnumConst)\n+          }\n         }\n-        is FieldType.Object -> CodeBlock.of(\"listItemWriter.writeObject(value?.marshaller())\", asTypeName())\n+        is FieldType.Object -> CodeBlock.of(\"listItemWriter.writeObject($safeValue.marshaller())\", asTypeName())\n         is FieldType.Array -> {\n           CodeBlock.builder()\n               .beginControlFlow(\n                   \"listItemWriter.writeList(value)\u00b7{ value, listItemWriter ->\",\n-                  List::class.asClassName().parameterizedBy(rawType.asTypeName()))\n-              .beginControlFlow(\"value?.forEach\u00b7{ value ->\", List::class.asClassName().parameterizedBy(rawType.asTypeName()))\n+                  List::class.asClassName().parameterizedBy(rawType.rawType.asTypeName())\n+              )\n+              .beginControlFlow(\n+                  \"value?.forEach\u00b7{ value ->\", // value always nullable in ListItemWriter", "originalCommit": "dd5a8b7e0eefb60a5232f96e6c3abed6be7f1d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkxMjQyMw==", "url": "https://github.com/apollographql/apollo-android/pull/2213#discussion_r414912423", "bodyText": "Would be good to merge this PR? I was wondering about this too. It would be great if you can take a look after merging this.", "author": "tasomaniac", "createdAt": "2020-04-24T23:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwMzQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk0MTIzOA==", "url": "https://github.com/apollographql/apollo-android/pull/2213#discussion_r414941238", "bodyText": "Yeah, pls merge will look after", "author": "sav007", "createdAt": "2020-04-25T01:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwMzQ3NQ=="}], "type": "inlineReview"}]}