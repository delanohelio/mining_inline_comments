{"pr_number": 2756, "pr_title": "Use GQLDocument for validation/IR building", "pr_createdAt": "2020-11-16T16:05:41Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2756", "timeline": [{"oid": "29bc8e28b8d9bd70f4da2e163239ba63a100a0c2", "url": "https://github.com/apollographql/apollo-android/commit/29bc8e28b8d9bd70f4da2e163239ba63a100a0c2", "message": "wip", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "dff0901dcee8f9bcfebb545df252331c8f9b1287", "url": "https://github.com/apollographql/apollo-android/commit/dff0901dcee8f9bcfebb545df252331c8f9b1287", "message": "add types extensions", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "c74c9ebc57d00c6ae2c5c8802920e17abe6580e1", "url": "https://github.com/apollographql/apollo-android/commit/c74c9ebc57d00c6ae2c5c8802920e17abe6580e1", "message": "operation name might be null for anonymous operations", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "b1895d3d9d41b70f05e21fd11cbe12f73a7bad5a", "url": "https://github.com/apollographql/apollo-android/commit/b1895d3d9d41b70f05e21fd11cbe12f73a7bad5a", "message": "added GQLNode", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "b41df38b12543b217d23a2929876628d59b5b70a", "url": "https://github.com/apollographql/apollo-android/commit/b41df38b12543b217d23a2929876628d59b5b70a", "message": "implement type extensions", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "8efaa66376280f758ee6e0018ece2592d99b79b3", "url": "https://github.com/apollographql/apollo-android/commit/8efaa66376280f758ee6e0018ece2592d99b79b3", "message": "rename", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "bbc146b310fb6e5c602c1000ab611fc770a01474", "url": "https://github.com/apollographql/apollo-android/commit/bbc146b310fb6e5c602c1000ab611fc770a01474", "message": "implement AST to Introspection", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "6e974d1f2e60b2f1c31008e8343bdd8fa100741f", "url": "https://github.com/apollographql/apollo-android/commit/6e974d1f2e60b2f1c31008e8343bdd8fa100741f", "message": "update builtins, add GQLDocument constructor", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "fdf26beca4005f37337a80d7c2bfa05264a1f034", "url": "https://github.com/apollographql/apollo-android/commit/fdf26beca4005f37337a80d7c2bfa05264a1f034", "message": "fix the VERSION property not being recognized by intelliJ", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "198d957c3b9ad4259dda814eb5d745adac61705e", "url": "https://github.com/apollographql/apollo-android/commit/198d957c3b9ad4259dda814eb5d745adac61705e", "message": "implement Introspection -> AST conversion", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "406c92d4dac888e13d3b577760ddcb5d99c64c54", "url": "https://github.com/apollographql/apollo-android/commit/406c92d4dac888e13d3b577760ddcb5d99c64c54", "message": "wip on writing GQL documents", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "226a9c7391f08fdaeadcc3640de94d56e3ec69d0", "url": "https://github.com/apollographql/apollo-android/commit/226a9c7391f08fdaeadcc3640de94d56e3ec69d0", "message": "work on schemaWriter", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "8c591d635f4183cd92b4ded22e0c697068467d38", "url": "https://github.com/apollographql/apollo-android/commit/8c591d635f4183cd92b4ded22e0c697068467d38", "message": "fix antlr ambiguity", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "46ef780dbd0d8067332e8f654799a1364f49e2f1", "url": "https://github.com/apollographql/apollo-android/commit/46ef780dbd0d8067332e8f654799a1364f49e2f1", "message": "finish writers implementations", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "8967da5b59525add927d47f362e1955821b6faa8", "url": "https://github.com/apollographql/apollo-android/commit/8967da5b59525add927d47f362e1955821b6faa8", "message": "better file names", "committedDate": "2020-11-16T15:49:16Z", "type": "commit"}, {"oid": "8d1d2183a8260f6a2417478f518b65a8cd1e1e54", "url": "https://github.com/apollographql/apollo-android/commit/8d1d2183a8260f6a2417478f518b65a8cd1e1e54", "message": "use the GraphQL AST for SDL", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "1c10c92484fe727180f1114c91c34f086c77b666", "url": "https://github.com/apollographql/apollo-android/commit/1c10c92484fe727180f1114c91c34f086c77b666", "message": "fix tests", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "e2a4eda99951a930342ea2b8b495081d513af143", "url": "https://github.com/apollographql/apollo-android/commit/e2a4eda99951a930342ea2b8b495081d513af143", "message": "fix tests", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "f783c7b200a5a8c049c1a82823313d8ce73aae1c", "url": "https://github.com/apollographql/apollo-android/commit/f783c7b200a5a8c049c1a82823313d8ce73aae1c", "message": "fix some tests", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "3d8b2c37ae5df641e45747a63236a46ffb5dacea", "url": "https://github.com/apollographql/apollo-android/commit/3d8b2c37ae5df641e45747a63236a46ffb5dacea", "message": "update test fixtures", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "a2d322d59757e2f7d5196097c9782d35c488f4a2", "url": "https://github.com/apollographql/apollo-android/commit/a2d322d59757e2f7d5196097c9782d35c488f4a2", "message": "remove old SDL package", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "24e9c54ec8e2982ec9f2539e0c582e5a04e7c02c", "url": "https://github.com/apollographql/apollo-android/commit/24e9c54ec8e2982ec9f2539e0c582e5a04e7c02c", "message": "prettify SDL output", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "5ec3645215db7c01be795b35ba3861c1a4b6195e", "url": "https://github.com/apollographql/apollo-android/commit/5ec3645215db7c01be795b35ba3861c1a4b6195e", "message": "keep the alias space and the diff small", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "cb3abf7396b080a319b2e61fdb738d0a478ac1b8", "url": "https://github.com/apollographql/apollo-android/commit/cb3abf7396b080a319b2e61fdb738d0a478ac1b8", "message": "create the directory if it doen't exist, fixes tests", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "5c78c00c9fc9532ae551fa6b789b5642cad97b15", "url": "https://github.com/apollographql/apollo-android/commit/5c78c00c9fc9532ae551fa6b789b5642cad97b15", "message": "use GQLDocument in the download task", "committedDate": "2020-11-16T15:49:17Z", "type": "commit"}, {"oid": "ec9190dd77d6421cd7878dc3bc86ab83e7aa6f9f", "url": "https://github.com/apollographql/apollo-android/commit/ec9190dd77d6421cd7878dc3bc86ab83e7aa6f9f", "message": "First drop for using GQLDocument for validation and IR building", "committedDate": "2020-11-21T00:58:38Z", "type": "commit"}, {"oid": "3685285f3f40c42c8e22d64e094a508117d3fec9", "url": "https://github.com/apollographql/apollo-android/commit/3685285f3f40c42c8e22d64e094a508117d3fec9", "message": "update test fixtures", "committedDate": "2020-11-21T00:59:29Z", "type": "commit"}, {"oid": "3685285f3f40c42c8e22d64e094a508117d3fec9", "url": "https://github.com/apollographql/apollo-android/commit/3685285f3f40c42c8e22d64e094a508117d3fec9", "message": "update test fixtures", "committedDate": "2020-11-21T00:59:29Z", "type": "forcePushed"}, {"oid": "458047913284d30bd9fa1b8d379fb9d7d5101bec", "url": "https://github.com/apollographql/apollo-android/commit/458047913284d30bd9fa1b8d379fb9d7d5101bec", "message": "fix SDL tests\n\ncreate the test directory if it does not exist", "committedDate": "2020-11-21T15:24:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY5Nzk1Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r529697957", "bodyText": "\ud83d\udc4d", "author": "sav007", "createdAt": "2020-11-24T16:13:29Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/ast/CodeGenerationAst.kt", "diffHunk": "@@ -43,6 +43,7 @@ internal data class CodeGenerationAst(\n   data class FragmentType(\n       val graphqlName: String,\n       val rootType: TypeRef,\n+      val description: String,", "originalCommit": "458047913284d30bd9fa1b8d379fb9d7d5101bec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0MzUxNg==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r529743516", "bodyText": "Once this is merged and used, I think we should try to upstream this inside the GraphQL spec so that other tools don't choke on it.", "author": "martinbonnin", "createdAt": "2020-11-24T17:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY5Nzk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcwNTA0Mw==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r529705043", "bodyText": "nit: should we call it GQLSchema?", "author": "sav007", "createdAt": "2020-11-24T16:20:55Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/parser/gql/Schema.kt", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.apollographql.apollo.compiler.parser.gql\n+\n+/**\n+ * a very thin wrapper around a schema GQLDocument\n+ *\n+ * It serves as a common ground between GQLDocument and IntrospectionSchema\n+ *\n+ * Schema should always contain all types, including the builtin ones\n+ */\n+class Schema(", "originalCommit": "458047913284d30bd9fa1b8d379fb9d7d5101bec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0NTE3OA==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r529745178", "bodyText": "I'd like to keep the GQL prefix for everything that is in the GQLNode type hierarchy and Schema doesn't inherit from GQLNode.\nThere should be only 2 instances of schemas: one for introspection and this one so I think having Schema and IntrospectionSchema isn't too confusing but I'm happy to think of another prefix if needed.", "author": "martinbonnin", "createdAt": "2020-11-24T17:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcwNTA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcwNTkwOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r529705909", "bodyText": "\ud83d\udc4d \ud83d\udc4d \ud83d\udc4d  very important for fragment parsing", "author": "sav007", "createdAt": "2020-11-24T16:22:05Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/parser/gql/add_typename.kt", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.apollographql.apollo.compiler.parser.gql\n+\n+fun GQLOperationDefinition.withTypenameWhenNeeded(schema: Schema): GQLOperationDefinition {\n+  val hasFragmentSpread = selectionSet.selections.filterIsInstance<GQLFragmentSpread>().isNotEmpty()\n+\n+  return copy(\n+      selectionSet = selectionSet.withTypenameWhenNeeded(schema, hasFragmentSpread)\n+  )\n+}\n+\n+fun GQLFragmentDefinition.withTypenameWhenNeeded(schema: Schema): GQLFragmentDefinition {\n+  return copy(\n+      selectionSet = selectionSet.withTypenameWhenNeeded(schema, true)\n+  )\n+}\n+\n+private val typeNameField = GQLField(\n+    name = \"__typename\",\n+    arguments = null,\n+    selectionSet = null,\n+    sourceLocation = SourceLocation.UNKNOWN,\n+    directives = emptyList(),\n+    alias = null\n+)\n+\n+/**\n+ * XXX: add typename less often\n+ */\n+private fun GQLSelectionSet.withTypenameWhenNeeded(schema: Schema, needed: Boolean): GQLSelectionSet {\n+\n+  var newSelections = selections.map {\n+    when (it) {\n+      is GQLInlineFragment -> {\n+        val neededInInlineFragments = it.selectionSet.selections.filterIsInstance<GQLInlineFragment>().isNotEmpty()\n+        it.copy(\n+            selectionSet = it.selectionSet.withTypenameWhenNeeded(schema, neededInInlineFragments)\n+        )\n+      }\n+      is GQLFragmentSpread -> it\n+      is GQLField -> it.copy(\n+          selectionSet = it.selectionSet?.withTypenameWhenNeeded(schema, true)\n+      )\n+    }\n+  }\n+\n+  newSelections = if (needed) {\n+    // remove the __typename if it exists\n+    // and add it again at the top so we're guaranteed to have it at the beginning of json parsing", "originalCommit": "458047913284d30bd9fa1b8d379fb9d7d5101bec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "000dd2090793fdaa53a92f45851708e065bfbe62", "url": "https://github.com/apollographql/apollo-android/commit/000dd2090793fdaa53a92f45851708e065bfbe62", "message": "tweak the add_typename algorythm and add unit tests for it", "committedDate": "2020-11-24T17:09:57Z", "type": "commit"}, {"oid": "b1290544f0fbb6b0768ab9822056275a96b96d95", "url": "https://github.com/apollographql/apollo-android/commit/b1290544f0fbb6b0768ab9822056275a96b96d95", "message": "fix typo", "committedDate": "2020-11-24T18:00:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDExMDU3MA==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r530110570", "bodyText": "it should because we have nested inline fragment here Droid", "author": "sav007", "createdAt": "2020-11-25T05:06:08Z", "path": "apollo-compiler/src/test/typename/fragment_spread.graphql", "diffHunk": "@@ -0,0 +1,13 @@\n+query TestQuery {\n+    hero {\n+        ...heroFragment\n+    }\n+}\n+\n+fragment heroFragment on Character {\n+    # No typename should be appended here", "originalCommit": "000dd2090793fdaa53a92f45851708e065bfbe62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIyOTUyNA==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r530229524", "bodyText": "I thought that as well but since the Fragment spread will always be queried on a parent field, the __typename will be added there. In that case, the transformed definitions will be:\nquery TestQuery {\n    hero {\n        # added in the containing field\n        __typename\n        ...heroFragment\n    }\n}\n\n# Fragment did'nt change\nfragment heroFragment on Character {\n    name\n    ... on Droid {\n        primaryFunction\n    }\n} \nUnless the codegen assumes it to generate fragments?", "author": "martinbonnin", "createdAt": "2020-11-25T09:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDExMDU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEyMDE5OA==", "url": "https://github.com/apollographql/apollo-android/pull/2756#discussion_r530120198", "bodyText": "remove?", "author": "sav007", "createdAt": "2020-11-25T05:42:14Z", "path": "apollo-compiler/src/test/kotlin/com/apollographql/apollo/compiler/TypenameTest.kt", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.apollographql.apollo.compiler\n+\n+import com.apollographql.apollo.compiler.parser.gql.GQLFragmentDefinition\n+import com.apollographql.apollo.compiler.parser.gql.GQLOperationDefinition\n+import com.apollographql.apollo.compiler.parser.gql.GraphQLParser\n+import com.apollographql.apollo.compiler.parser.gql.toFile\n+import com.apollographql.apollo.compiler.parser.gql.toSchema\n+import com.apollographql.apollo.compiler.parser.gql.toUtf8\n+import com.apollographql.apollo.compiler.parser.gql.toUtf8WithIndents\n+import com.apollographql.apollo.compiler.parser.gql.withTypenameWhenNeeded\n+import com.apollographql.apollo.compiler.parser.introspection.IntrospectionSchema\n+import com.google.common.truth.Truth.assertThat\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import org.junit.runners.Parameterized\n+import java.io.File\n+\n+@Suppress(\"UNUSED_PARAMETER\")\n+@RunWith(Parameterized::class)\n+class TypenameTest(val name: String, private val graphQLFile: File) {\n+\n+  @Test\n+  fun testTypename() {\n+    val schemaFile = File(\"src/test/graphql/schema.sdl\")\n+    val schema = GraphQLParser.parseSchema(schemaFile)\n+\n+    val document = GraphQLParser.parseOperations(graphQLFile, schema).orThrow()\n+\n+    val documentWithTypename = document.copy(\n+        definitions = document.definitions.map {\n+          when (it) {\n+            is GQLOperationDefinition -> it.withTypenameWhenNeeded(schema)\n+            is GQLFragmentDefinition -> it.withTypenameWhenNeeded(schema)\n+            else -> it\n+          }\n+        }\n+    ).toUtf8WithIndents()\n+\n+    val expectedFile = File(graphQLFile.parentFile, \"${name}.with_typename\")\n+\n+\n+    if (TestUtils.shouldUpdateTestFixtures()) {\n+      expectedFile.writeText(documentWithTypename)\n+    } else {\n+      assertThat(documentWithTypename).isEqualTo(expectedFile.readText())\n+    }\n+  }\n+\n+  companion object {\n+    @JvmStatic\n+    @Parameterized.Parameters(name = \"{0}\")\n+    fun data(): Collection<Array<Any>> {\n+      return File(\"src/test/typename/\")\n+          .walk()\n+          .toList()\n+          .filter { it.isFile }\n+          .filter { it.extension == \"graphql\" }\n+          .sortedBy { it.name }\n+          //.filter { it.name.contains(\"InputObjectFieldType\") }", "originalCommit": "000dd2090793fdaa53a92f45851708e065bfbe62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ced68811fe49796cb4ae1535afe2a1d4bbd48d50", "url": "https://github.com/apollographql/apollo-android/commit/ced68811fe49796cb4ae1535afe2a1d4bbd48d50", "message": "remove bad copy/paste", "committedDate": "2020-11-25T09:37:51Z", "type": "commit"}, {"oid": "ca4e028f295aaa07bf55e64e70c2fc4be8214127", "url": "https://github.com/apollographql/apollo-android/commit/ca4e028f295aaa07bf55e64e70c2fc4be8214127", "message": "move everything to the 'frontend' package", "committedDate": "2020-11-25T10:50:21Z", "type": "commit"}, {"oid": "c181b9c37d87c0732c901691a302b0c5c5fcaec3", "url": "https://github.com/apollographql/apollo-android/commit/c181b9c37d87c0732c901691a302b0c5c5fcaec3", "message": "add typename to fragments as well", "committedDate": "2020-11-25T18:16:15Z", "type": "commit"}, {"oid": "39fbfe7dd9344ced58f677e5012f93c6451d1e3a", "url": "https://github.com/apollographql/apollo-android/commit/39fbfe7dd9344ced58f677e5012f93c6451d1e3a", "message": "fix tests", "committedDate": "2020-11-25T18:52:54Z", "type": "commit"}, {"oid": "08ef7536c9f8b45e4476f61ee6b545ebe7af639e", "url": "https://github.com/apollographql/apollo-android/commit/08ef7536c9f8b45e4476f61ee6b545ebe7af639e", "message": "force typename on all fragments, update test fixtures", "committedDate": "2020-11-25T19:07:48Z", "type": "commit"}, {"oid": "cca243e01b510728fea5b46a3fbf4406e550afb2", "url": "https://github.com/apollographql/apollo-android/commit/cca243e01b510728fea5b46a3fbf4406e550afb2", "message": "update tests", "committedDate": "2020-11-25T19:58:21Z", "type": "commit"}, {"oid": "c76ab5c545fa21cde2d9af344aa45d21ac9532d3", "url": "https://github.com/apollographql/apollo-android/commit/c76ab5c545fa21cde2d9af344aa45d21ac9532d3", "message": "fix integration tests", "committedDate": "2020-11-26T10:49:05Z", "type": "commit"}]}