{"pr_number": 2648, "pr_title": "Introduce new response reader API to support reading from stream - part1", "pr_createdAt": "2020-10-10T16:47:44Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2648", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNTA0Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r502925046", "bodyText": "Why do we even need shouldSkip ? Isn't this supposed to be handled server side? If a server returns a value for a skipped field, this is most likely against the spec. Maybe we can avoid this logic client side and save a few more CPU cycles?", "author": "martinbonnin", "createdAt": "2020-10-11T14:47:18Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/ResponseReader.kt", "diffHunk": "@@ -78,4 +80,24 @@ interface ResponseReader {\n       })\n     }\n   }\n+\n+  fun ResponseField.shouldSkip(variableValues: Map<String, Any?>): Boolean {", "originalCommit": "868a8a72563223029b36ed8fbb70708abf108924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwOTU0Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503009546", "bodyText": "Yeah, I think you are right. This function is only needed in case of normalized cache. We can remove it.", "author": "sav007", "createdAt": "2020-10-12T02:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxMjg2Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503012866", "bodyText": "I will leave it for now in RealResponseReader as it used when parse normalized cache, until we replace it with stream parses.", "author": "sav007", "createdAt": "2020-10-12T02:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyMDMyNQ==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503120325", "bodyText": "Right \ud83d\udc4d", "author": "martinbonnin", "createdAt": "2020-10-12T08:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r502927410", "bodyText": "We could leverage the fact that field order should be preserved to remove the iteration here and have faster parsing performance than json. Maybe with a \"slow\" path for non-compliant server implementations.", "author": "martinbonnin", "createdAt": "2020-10-11T15:05:30Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/SimpleResponseReader.kt", "diffHunk": "@@ -13,121 +13,64 @@ class SimpleResponseReader private constructor(\n     private val variableValues: Map<String, Any?>,\n     private val scalarTypeAdapters: ScalarTypeAdapters\n ) : ResponseReader {\n+  private val responseRecordSetIterator = recordSet.iterator()\n \n   constructor(\n       recordSet: Map<String, Any?>,\n       variables: Operation.Variables,\n       scalarTypeAdapters: ScalarTypeAdapters\n   ) : this(recordSet, variables.valueMap(), scalarTypeAdapters)\n \n-  override fun readString(field: ResponseField): String? {\n-    if (shouldSkip(field)) {\n-      return null\n-    }\n+  override fun selectField(fields: Array<ResponseField>): Int {\n+    while (true)\n+      if (responseRecordSetIterator.hasNext()) {\n+        val (nextFieldName, _) = responseRecordSetIterator.next()\n+        val fieldIndex = fields.indexOfFirst { field -> field.responseName == nextFieldName }", "originalCommit": "868a8a72563223029b36ed8fbb70708abf108924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxMTIxNg==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503011216", "bodyText": "Even this is in 90% cases true, I wouldn't trust the order of fields we have in our models vs fields sent in query, we already do couple optimizations / merging fields, the order might changed and it's very fragile in terms of our codegen, any changes that impact fields order in our models everything will fall down as house of cards.", "author": "sav007", "createdAt": "2020-10-12T02:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyMzk0MA==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503123940", "bodyText": "we already do couple optimizations / merging fields\n\nDo you have an exemple for that?\nWe'd have to do some benchmarking but if we started the string matching on an index that increments as new fields are read and that'd work in 90% of the case, I think we'd save some time and be effectively faster than json (that'd be a cool marketing claim ;)). If the 10% case fallbacks to iterating all the possible fields, everything would still work, albeit with performance on average the same as the one we have now?", "author": "martinbonnin", "createdAt": "2020-10-12T08:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwMjczMw==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503302733", "bodyText": "Inline fragments, in some conditions we merge fields. Also I'm not sure that we preserve 100% order when build IR or AST. If we want to do this we need to verify all over the place where we build IR and AST that we keep the original order of fields.\nI would say let's first do perf measurement and see if it's a case, pretty sure we will get the same numbers as Moshi as it does the same field lookup.", "author": "sav007", "createdAt": "2020-10-12T13:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwNDI0MQ==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503304241", "bodyText": "Damn inline fragments! But yea, I agree this all needs to be benchmarked.", "author": "martinbonnin", "createdAt": "2020-10-12T13:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNzgwNA==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503317804", "bodyText": "Actually after thinking we can do small optimization here, we can keep previously selected field index, then during next selectField call we can try to guess next field to select by fields[previousSelectedFieldIndex + 1] and if we fail fallback to lookup. Should optimize in 90%.", "author": "sav007", "createdAt": "2020-10-12T14:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxODU3NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503318575", "bodyText": "Yes, exactly \ud83d\udc4d", "author": "martinbonnin", "createdAt": "2020-10-12T14:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM2NTA5OA==", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r503365098", "bodyText": "I will address this in my next PR in StreamResponseReader.", "author": "sav007", "createdAt": "2020-10-12T15:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA=="}], "type": "inlineReview"}, {"oid": "484f5dbbd5576a97a1facc03491749362c1092a5", "url": "https://github.com/apollographql/apollo-android/commit/484f5dbbd5576a97a1facc03491749362c1092a5", "message": "Remove `shouldSkip` from simple response reader.\nRevert back `Mapper` code generation.\nRebase.", "committedDate": "2020-10-12T03:24:13Z", "type": "forcePushed"}, {"oid": "acda55c7137d31b9e9cb472f5b736a16d3f33c16", "url": "https://github.com/apollographql/apollo-android/commit/acda55c7137d31b9e9cb472f5b736a16d3f33c16", "message": "Introduce new response reader API to support reading from stream\n\n- Introduce new API `selectField` to be used in feature implementation of stream reader\n- Provide implementation to existing Map based readers\n- Update code generation to parse response based on `selectField`\n\nPart of #2523", "committedDate": "2020-10-12T15:54:57Z", "type": "commit"}, {"oid": "76afa546a2ec3438df73c2267e6b4b0441356dac", "url": "https://github.com/apollographql/apollo-android/commit/76afa546a2ec3438df73c2267e6b4b0441356dac", "message": "Codegen + test fixtures", "committedDate": "2020-10-12T15:54:57Z", "type": "commit"}, {"oid": "0af7c8ca734994b0c9c1cf70dea4e701761e2c7b", "url": "https://github.com/apollographql/apollo-android/commit/0af7c8ca734994b0c9c1cf70dea4e701761e2c7b", "message": "Fix reading number issue", "committedDate": "2020-10-12T15:54:57Z", "type": "commit"}, {"oid": "02131f4be67d004749fe82f67c76097b07ee2cc1", "url": "https://github.com/apollographql/apollo-android/commit/02131f4be67d004749fe82f67c76097b07ee2cc1", "message": "Remove `shouldSkip` from simple response reader.\nRevert back `Mapper` code generation.\nRebase.", "committedDate": "2020-10-12T15:54:57Z", "type": "commit"}, {"oid": "e6f20b468248c1711a2d35656c576948c8411f26", "url": "https://github.com/apollographql/apollo-android/commit/e6f20b468248c1711a2d35656c576948c8411f26", "message": "Rework `RealResponseReader` to fix issue with parsing response from cache.", "committedDate": "2020-10-12T15:54:57Z", "type": "commit"}, {"oid": "e6f20b468248c1711a2d35656c576948c8411f26", "url": "https://github.com/apollographql/apollo-android/commit/e6f20b468248c1711a2d35656c576948c8411f26", "message": "Rework `RealResponseReader` to fix issue with parsing response from cache.", "committedDate": "2020-10-12T15:54:57Z", "type": "forcePushed"}, {"oid": "71a3a44587a65fc80342f0d27d478666cdaaf57e", "url": "https://github.com/apollographql/apollo-android/commit/71a3a44587a65fc80342f0d27d478666cdaaf57e", "message": "Update test fixture", "committedDate": "2020-10-12T17:34:18Z", "type": "commit"}]}