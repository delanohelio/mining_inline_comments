{"pr_number": 2819, "pr_title": "Cleanup the custom scalar APIs 1/3", "pr_createdAt": "2020-12-24T10:22:24Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2819", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ4MzMzNg==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r548483336", "bodyText": "Removed the api.txt for now. I'll re-add them for 3.0.0-alpha01", "author": "martinbonnin", "createdAt": "2020-12-24T10:25:24Z", "path": "apollo-android-support/api.txt", "diffHunk": "@@ -1,31 +0,0 @@\n-// Signature format: 3.0\n-package com.apollographql.apollo {", "originalCommit": "6bf620041caa95abbef030e1c7465262f415682b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ4NDE3Mg==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r548484172", "bodyText": "JsonElement is the new, more type safe CustomTypeValue. It makes it clear that CustomScalarAdapters ultimately work on Json:\ninterface CustomScalarAdapter<T> {\n  fun decode(jsonElement: JsonElement): T\n  fun encode(value: T): JsonElement\n}\nI know GraphQL is not Json-only but so far it is so we'll see when (if...) that changes.", "author": "martinbonnin", "createdAt": "2020-12-24T10:28:09Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/BuiltinAdapters.kt", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.apollographql.apollo.api\n+\n+import com.apollographql.apollo.api.internal.json.JsonWriter\n+import com.apollographql.apollo.api.internal.json.Utils\n+import com.apollographql.apollo.api.internal.json.use\n+import okio.Buffer\n+\n+/**\n+ * Builtin CustomScalarTypeAdapter provided for convenience. Encoding is most of the times straightforward. Decoding\n+ * can involve coercion. If you need stricter decoding or different logic, define your own adapter\n+ */\n+object BuiltinScalarTypeAdapters {\n+  val STRING_ADAPTER = adapterWithDefaultEncode { jsonElement ->\n+    when (jsonElement) {\n+      is JsonElement.JsonString -> jsonElement.value\n+      is JsonElement.JsonNull -> null\n+      is JsonElement.JsonBoolean -> jsonElement.value.toString()\n+      is JsonElement.JsonNumber -> jsonElement.value.toString()\n+      is JsonElement.JsonObject,\n+      is JsonElement.JsonList -> {", "originalCommit": "6bf620041caa95abbef030e1c7465262f415682b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ4NTQ0MA==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r548485440", "bodyText": "Converted a bunch of files to Kotlin as I'd like to get rid of @JvmField annotation for 3.0.0-alpha01", "author": "martinbonnin", "createdAt": "2020-12-24T10:32:18Z", "path": "apollo-idling-resource/src/test/java/com/apollographql/apollo/test/espresso/ApolloIdlingResourceTest.kt", "diffHunk": "@@ -0,0 +1,210 @@\n+package com.apollographql.apollo.test.espresso", "originalCommit": "6bf620041caa95abbef030e1c7465262f415682b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDU1NA==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549024554", "bodyText": "nit: should we move this into /json subfolder?", "author": "sav007", "createdAt": "2020-12-26T19:40:52Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/JsonElement.kt", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.apollographql.apollo.api\n+\n+/**\n+ * A wrapper class for representation of custom GraphQL type value, used in user provided [CustomScalarAdapter]\n+ * encoding / decoding functions.\n+ **/\n+sealed class JsonElement {", "originalCommit": "a28a7502cee70a35d0715ca78b741fd7c4e3afae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI4MjEwOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549282109", "bodyText": "Good question. We currently have com.apollographql.apollo.api.internal.json where the Json parser (BufferedSourceJsonReader) resides.\nTechnically, we could make the json parser work with JsonElement but that will introduce some unnecessary wrapping and I'm afraid it'll only slow down parsing...\nSo JsonElement is right now only used to wrap Kotlin instances into more type-safe/user-friendly types. In that sense I feel that it should be closer to CustomScalarAdapter than BufferedSourceJsonReader, even if it's about Json. Also the com.apollographql.apollo.api package isn't too much cluttered right now. It contains ~30 classes, some of which can maybe be moved to internal. All that makes me want to keep it in the root package for the time being but I'm not against reorganizing things differently if we ultimately think it makes more sense.", "author": "martinbonnin", "createdAt": "2020-12-28T09:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDc0Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549024746", "bodyText": "nit: should we rename this to CustomScalarType?", "author": "sav007", "createdAt": "2020-12-26T19:43:44Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/ScalarType.kt", "diffHunk": "@@ -1,17 +1,17 @@\n package com.apollographql.apollo.api\n \n /**\n- * Represents a custom GraphQL scalar type\n+ * Represents a mapping from a custom GraphQL scalar type to a Java/Kotlin class\n  */\n interface ScalarType {", "originalCommit": "a28a7502cee70a35d0715ca78b741fd7c4e3afae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNTI2MA==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549025260", "bodyText": "nvm I see it's done in next PR #2820", "author": "sav007", "createdAt": "2020-12-26T19:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDkwNw==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549024907", "bodyText": "same should we use naming CustomScalar* everywhere?", "author": "sav007", "createdAt": "2020-12-26T19:45:29Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/ScalarTypeAdapters.kt", "diffHunk": "@@ -1,129 +1,65 @@\n package com.apollographql.apollo.api\n \n-import com.apollographql.apollo.api.CustomTypeValue.*\n-import com.apollographql.apollo.api.CustomTypeValue.Companion.fromRawValue\n-import com.apollographql.apollo.api.internal.json.JsonWriter\n-import com.apollographql.apollo.api.internal.json.Utils\n-import com.apollographql.apollo.api.internal.json.use\n-import okio.Buffer\n-import kotlin.jvm.JvmField\n+class ScalarTypeAdapters(val customScalarAdapters: Map<ScalarType, CustomScalarAdapter<*>>) {", "originalCommit": "a28a7502cee70a35d0715ca78b741fd7c4e3afae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNTI2Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2819#discussion_r549025267", "bodyText": "nvm I see it's done in next PR #2820", "author": "sav007", "createdAt": "2020-12-26T19:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAyNDkwNw=="}], "type": "inlineReview"}, {"oid": "39a9e10876cd285b3e5f2da3632666e2ab39add0", "url": "https://github.com/apollographql/apollo-android/commit/39a9e10876cd285b3e5f2da3632666e2ab39add0", "message": "CustomTypeAdapter -> CustomScalarTypeAdapter", "committedDate": "2021-01-03T15:44:04Z", "type": "commit"}, {"oid": "bfa466e98b3d2c2ccb752f34efcf35e710152026", "url": "https://github.com/apollographql/apollo-android/commit/bfa466e98b3d2c2ccb752f34efcf35e710152026", "message": "customTypeMap -> customScalarsMapping", "committedDate": "2021-01-03T15:44:04Z", "type": "commit"}, {"oid": "a245ece6abe534d0596bc06b52bb0bde4a188ccd", "url": "https://github.com/apollographql/apollo-android/commit/a245ece6abe534d0596bc06b52bb0bde4a188ccd", "message": "more renaming to customScalarsMapping", "committedDate": "2021-01-03T15:44:04Z", "type": "commit"}, {"oid": "750770ecc4dcfa7fd1cb2f07001cc4fa3212a1d5", "url": "https://github.com/apollographql/apollo-android/commit/750770ecc4dcfa7fd1cb2f07001cc4fa3212a1d5", "message": "Simplify ScalarType\n\nScalarType.typeName() -> ScalarType.graphqlName\nScalarType.className() -> ScalarType.className", "committedDate": "2021-01-03T15:44:47Z", "type": "commit"}, {"oid": "841ae135372e8dabba2b7c4d92c5ff4852a43a60", "url": "https://github.com/apollographql/apollo-android/commit/841ae135372e8dabba2b7c4d92c5ff4852a43a60", "message": "added ./gradlew rmbuild", "committedDate": "2021-01-03T15:44:50Z", "type": "commit"}, {"oid": "1a755fb4154520d04d320c983421e1138579abf6", "url": "https://github.com/apollographql/apollo-android/commit/1a755fb4154520d04d320c983421e1138579abf6", "message": "forgot to add files", "committedDate": "2021-01-03T15:44:50Z", "type": "commit"}, {"oid": "50aad989ee547470844c6ec38cc87c516b70401d", "url": "https://github.com/apollographql/apollo-android/commit/50aad989ee547470844c6ec38cc87c516b70401d", "message": "customType -> customScalarType", "committedDate": "2021-01-03T15:45:04Z", "type": "commit"}, {"oid": "2093acb9a8ddaa6097d42c4cc5e0686644aa2369", "url": "https://github.com/apollographql/apollo-android/commit/2093acb9a8ddaa6097d42c4cc5e0686644aa2369", "message": "more renaming", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "315677198566389216adacbf066803711b0f789a", "url": "https://github.com/apollographql/apollo-android/commit/315677198566389216adacbf066803711b0f789a", "message": "fix tests", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "9a57bfaf2f4c048387b76fe4f470e2aa9e97c151", "url": "https://github.com/apollographql/apollo-android/commit/9a57bfaf2f4c048387b76fe4f470e2aa9e97c151", "message": "wip", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "c4770918e5d4b7a50c1783d4d8a46a757c15b104", "url": "https://github.com/apollographql/apollo-android/commit/c4770918e5d4b7a50c1783d4d8a46a757c15b104", "message": "convert ApolloIdlingResource to kotlin", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "cd63466b37bff512c44bd6bd32e3192a4b8f44c2", "url": "https://github.com/apollographql/apollo-android/commit/cd63466b37bff512c44bd6bd32e3192a4b8f44c2", "message": "convert some more tests to Kotlin", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "a30d79217d73ac5647c894c33d8a2f8766a926e2", "url": "https://github.com/apollographql/apollo-android/commit/a30d79217d73ac5647c894c33d8a2f8766a926e2", "message": "remove the api.txt files from dev-3.x, they make the diffs harder to\nread\n\nI will re-enable them when the API stabilizes", "committedDate": "2021-01-03T15:45:06Z", "type": "commit"}, {"oid": "d33906f19ff6c82146492719711ded35daec6151", "url": "https://github.com/apollographql/apollo-android/commit/d33906f19ff6c82146492719711ded35daec6151", "message": "simplify even more and drop the `Type`", "committedDate": "2021-01-03T15:45:12Z", "type": "commit"}, {"oid": "69a6806148bfda52b4fb2331679a54d762aa8901", "url": "https://github.com/apollographql/apollo-android/commit/69a6806148bfda52b4fb2331679a54d762aa8901", "message": "forgot to add files + make things more consistent", "committedDate": "2021-01-03T15:45:14Z", "type": "commit"}, {"oid": "e8549559aa812e62b585b9a95dcdcd8fab2baf2d", "url": "https://github.com/apollographql/apollo-android/commit/e8549559aa812e62b585b9a95dcdcd8fab2baf2d", "message": "be more robust to thread scheduling randomness", "committedDate": "2021-01-03T15:45:14Z", "type": "commit"}, {"oid": "e8549559aa812e62b585b9a95dcdcd8fab2baf2d", "url": "https://github.com/apollographql/apollo-android/commit/e8549559aa812e62b585b9a95dcdcd8fab2baf2d", "message": "be more robust to thread scheduling randomness", "committedDate": "2021-01-03T15:45:14Z", "type": "forcePushed"}, {"oid": "c2cf2f8a1bc158ea7a3b3a6afccf7e574f03592b", "url": "https://github.com/apollographql/apollo-android/commit/c2cf2f8a1bc158ea7a3b3a6afccf7e574f03592b", "message": "fix tests", "committedDate": "2021-01-03T15:52:11Z", "type": "commit"}]}