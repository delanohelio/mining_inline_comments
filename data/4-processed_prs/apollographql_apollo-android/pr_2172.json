{"pr_number": 2172, "pr_title": "Update maven publishing", "pr_createdAt": "2020-04-14T17:47:50Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2172", "timeline": [{"oid": "1167a2739b2d0efef6547a875a8a0ae344efc084", "url": "https://github.com/apollographql/apollo-android/commit/1167a2739b2d0efef6547a875a8a0ae344efc084", "message": "update maven publishing\n\n* use the Android software components available with AGP 3.6\n* do not create publications if the java-gradle-plugin or org.jetbrains.kotlin.multiplatform did it for us\n* properly configure the pom metadata\n* remove the bintrayMarker repository", "committedDate": "2020-04-14T17:30:05Z", "type": "commit"}, {"oid": "01a45282db9313dd656aff9f3fba66db70b90960", "url": "https://github.com/apollographql/apollo-android/commit/01a45282db9313dd656aff9f3fba66db70b90960", "message": "everything goes in the same bintray package now", "committedDate": "2020-04-14T17:34:56Z", "type": "commit"}, {"oid": "ed71c1c18e9907c61ba304cb7baef0414dac3130", "url": "https://github.com/apollographql/apollo-android/commit/ed71c1c18e9907c61ba304cb7baef0414dac3130", "message": "since the publications do not overlap anymore, we can use publishAllPublicationXYZ", "committedDate": "2020-04-14T17:45:36Z", "type": "commit"}, {"oid": "63186853aa6773a967246df7621ccd5487877b8d", "url": "https://github.com/apollographql/apollo-android/commit/63186853aa6773a967246df7621ccd5487877b8d", "message": "fix tests", "committedDate": "2020-04-14T17:56:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0OTc2NA==", "url": "https://github.com/apollographql/apollo-android/pull/2172#discussion_r408349764", "bodyText": "This was missing and preventing the license url to be present in the pom files", "author": "martinbonnin", "createdAt": "2020-04-14T18:32:33Z", "path": "build.gradle.kts", "diffHunk": "@@ -209,43 +208,43 @@ fun Project.configurePublishing() {\n \n   configure<PublishingExtension> {\n     publications {\n-      if (plugins.hasPlugin(\"org.jetbrains.kotlin.multiplatform\")) {\n-        withType<MavenPublication>().getByName(\"jvm\") {\n-          if (javadocJarTaskProvider != null) {\n-            artifact(javadocJarTaskProvider.get())\n+      when {\n+        plugins.hasPlugin(\"org.jetbrains.kotlin.multiplatform\") -> {\n+          withType<MavenPublication>().getByName(\"jvm\") {\n+            if (javadocJarTaskProvider != null) {\n+              artifact(javadocJarTaskProvider.get())\n+            }\n           }\n         }\n-      } else {\n-        create<MavenPublication>(publicationName) {\n-          val javaComponent = components.findByName(\"java\")\n-          if (javaComponent != null) {\n-            from(javaComponent)\n-          } else if (android != null) {\n-            // this is a workaround while the below is fixed.\n-            // dependency information in the pom file will most likely be wrong\n-            // but it's been like that for some time now. As long as users still\n-            // import apollo-runtime in addition to the android artifacts, it\n-            // should be fine.\n-            //\n-            // https://issuetracker.google.com/issues/37055147\n-            // https://github.com/gradle/gradle/pull/8399\n-            afterEvaluate {\n-              artifact(tasks.named(\"bundleReleaseAar\").get())\n+        plugins.hasPlugin(\"java-gradle-plugin\") -> {\n+          // do nothing, the plugin will create the publications for us\n+        }\n+        else -> {\n+          create<MavenPublication>(\"default\") {\n+            val javaComponent = components.findByName(\"java\")\n+            if (javaComponent != null) {\n+              from(javaComponent)\n+            } else if (android != null) {\n+              from(components.findByName(\"release\"))\n             }\n-          }\n \n-          if (javadocJarTaskProvider != null) {\n-            artifact(javadocJarTaskProvider.get())\n-          }\n-          if (sourcesJarTaskProvider != null) {\n-            artifact(sourcesJarTaskProvider.get())\n-          }\n+            if (javadocJarTaskProvider != null) {\n+              artifact(javadocJarTaskProvider.get())\n+            }\n+            if (sourcesJarTaskProvider != null) {\n+              artifact(sourcesJarTaskProvider.get())\n+            }\n \n-          pom {\n-            artifactId = findProperty(\"POM_ARTIFACT_ID\") as String?\n+            pom {\n+              artifactId = findProperty(\"POM_ARTIFACT_ID\") as String?\n+            }\n           }\n         }\n       }\n+\n+      withType<MavenPublication>() {\n+        setDefaultPomFields()", "originalCommit": "63186853aa6773a967246df7621ccd5487877b8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c0a0d54c18c900d8041b4491fef6fb888558281", "url": "https://github.com/apollographql/apollo-android/commit/8c0a0d54c18c900d8041b4491fef6fb888558281", "message": "fix artifact id", "committedDate": "2020-04-14T19:09:38Z", "type": "commit"}, {"oid": "b7de8fd4b08485af21f462f0c5f60295b146babb", "url": "https://github.com/apollographql/apollo-android/commit/b7de8fd4b08485af21f462f0c5f60295b146babb", "message": "wrap in afterEvaluate so that the component is actually there", "committedDate": "2020-04-14T19:11:25Z", "type": "commit"}, {"oid": "528407644623b02c25d4fa71782f0e276e4d9dd2", "url": "https://github.com/apollographql/apollo-android/commit/528407644623b02c25d4fa71782f0e276e4d9dd2", "message": "add javadoc/sources for the plugin too", "committedDate": "2020-04-14T21:38:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1MDczOA==", "url": "https://github.com/apollographql/apollo-android/pull/2172#discussion_r408650738", "bodyText": "Ops", "author": "tasomaniac", "createdAt": "2020-04-15T07:56:00Z", "path": "apollo-normalized-cache-sqlite/gradle.properties", "diffHunk": "@@ -1,4 +1,4 @@\n-POM_ARTIFACT_ID=apollo-sqlite-cache\n+POM_ARTIFACT_ID=apollo-normalized-cache-sqlite", "originalCommit": "528407644623b02c25d4fa71782f0e276e4d9dd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}