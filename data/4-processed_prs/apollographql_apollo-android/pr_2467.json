{"pr_number": 2467, "pr_title": "JS support in apollo-api", "pr_createdAt": "2020-07-24T11:17:32Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2467", "timeline": [{"oid": "06cf1cb17ef56704e3e49370daeece8e52632278", "url": "https://github.com/apollographql/apollo-android/commit/06cf1cb17ef56704e3e49370daeece8e52632278", "message": "apollo-api JS support", "committedDate": "2020-07-24T20:34:38Z", "type": "forcePushed"}, {"oid": "c661c9505e662afa5fb5f19b63650516f368d041", "url": "https://github.com/apollographql/apollo-android/commit/c661c9505e662afa5fb5f19b63650516f368d041", "message": "Declare kotlin.reflect as a dep of apollo-api JVM.", "committedDate": "2020-07-24T20:48:30Z", "type": "forcePushed"}, {"oid": "ffbec3b41cc1528285aa6d2e3e7908028500a406", "url": "https://github.com/apollographql/apollo-android/commit/ffbec3b41cc1528285aa6d2e3e7908028500a406", "message": "Update apollo-compiler code gen.", "committedDate": "2020-07-24T23:42:57Z", "type": "forcePushed"}, {"oid": "164ac1204264543b932de53cd0f23486ff38da86", "url": "https://github.com/apollographql/apollo-android/commit/164ac1204264543b932de53cd0f23486ff38da86", "message": "Update apollo-compiler code gen.", "committedDate": "2020-07-24T23:43:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxMTczOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2467#discussion_r460411739", "bodyText": "I'm super reluctant to adding kotlin-reflect as a dependency as it's known to be a laaaaaarge dependency. See https://youtrack.jetbrains.com/issue/KT-20793 for an exemple.\napollo-api is pretty lightweight at the moment and given that it's imported by all other modules, I'd like to keep it that way.\nCan you elaborate why keeping a String for scalar types doesn't work ? I didn't find that many places using KClass.qualifiedName() and most of them are for debug/troubleshooting.", "author": "martinbonnin", "createdAt": "2020-07-25T14:45:39Z", "path": "apollo-api/build.gradle.kts", "diffHunk": "@@ -36,6 +44,7 @@ kotlin {\n       dependsOn(commonMain)\n       dependencies {\n         implementation(kotlin(\"stdlib\"))\n+        implementation(groovy.util.Eval.x(project, \"x.dep.kotlin.reflect\"))", "originalCommit": "f52b490097c584426828e6a9cd930632ca5c8e50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNDIzOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2467#discussion_r460414239", "bodyText": "The dependency shouldn't be required since 1.3.70, since KClass is moved out of kotlin-reflect jar. I will remove it.\n\nCan you elaborate why keeping a String for scalar types doesn't work ? I didn't find that many places using KClass.qualifiedName() and most of them are for debug/troubleshooting.\n\nIt is used by apollo-api to select the type adapters to use (among the set of default ones for Kotlin/Java stdlib types, and the user-supplied ones via customTypeMapping in Gradle). The lookup tables are currently keyed by KClass.qualifiedName(), which does not work at Kotlin/JS runtime.", "author": "andersio", "createdAt": "2020-07-25T15:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxMTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTkxOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2467#discussion_r460415919", "bodyText": "The dependency shouldn't be required since 1.3.70, since KClass is moved out of kotlin-reflect jar. I will remove it.\n\nNice \ud83d\udc4d\n\nThe lookup tables are currently keyed by KClass.qualifiedName(), which does not work at Kotlin/JS runtime.\n\nThat's what I'm trying to understand.\nLooking at ScalarTypeAdapters:\n  fun <T : Any> adapterFor(scalarType: ScalarType): CustomTypeAdapter<T> {\n    var customTypeAdapter: CustomTypeAdapter<*>? = customTypeAdapters[scalarType.typeName()]\n    if (customTypeAdapter == null) {\n      customTypeAdapter = DEFAULT_ADAPTERS[scalarType.className()]\n    }\n    return requireNotNull(customTypeAdapter) {\n      \"Can't map GraphQL type: `${scalarType.typeName()}` to: `${scalarType.className()}`. Did you forget to add a custom type adapter?\"\n    } as CustomTypeAdapter<T>\n  }\nThis doesn't use KClass.qualifiedName(), does it ? both typeName() and className()are generated by the compiler based on either default hardcoded value (java.lang.String, etc...) or user input in case of a custom adapter:\nenum class CustomType : ScalarType {\n  ID {\n    override fun typeName(): String = \"ID\"\n\n    override fun className(): String = \"kotlin.String\"\n  },\n\n  URL {\n    override fun typeName(): String = \"URL\"\n\n    override fun className(): String = \"kotlin.Any\"\n  }\n}", "author": "martinbonnin", "createdAt": "2020-07-25T15:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxMTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNjg5Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2467#discussion_r460416896", "bodyText": "That's a good point. I probably had made the decision to change it simply because Gradle wasn't building, ignoring the fact that .qualifiedName() is used only in Tests. I will revert it.", "author": "andersio", "createdAt": "2020-07-25T15:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxMTczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxMjAyMQ==", "url": "https://github.com/apollographql/apollo-android/pull/2467#discussion_r460412021", "bodyText": "Nit: unused import?", "author": "martinbonnin", "createdAt": "2020-07-25T14:49:17Z", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/Response.kt", "diffHunk": "@@ -1,6 +1,7 @@\n package com.apollographql.apollo.api\n \n import kotlin.jvm.JvmStatic\n+import kotlin.js.JsName", "originalCommit": "f52b490097c584426828e6a9cd930632ca5c8e50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbfb053c08d342df32392805e601469b5dd1f349", "url": "https://github.com/apollographql/apollo-android/commit/dbfb053c08d342df32392805e601469b5dd1f349", "message": "Update tests to stop using `KClass.qualifiedName()`.", "committedDate": "2020-07-25T16:12:53Z", "type": "forcePushed"}, {"oid": "ab46dd8da6d0c67c3f1f4879264e96ca352bf39a", "url": "https://github.com/apollographql/apollo-android/commit/ab46dd8da6d0c67c3f1f4879264e96ca352bf39a", "message": "Update tests to stop using `KClass.qualifiedName()`.", "committedDate": "2020-07-25T16:14:03Z", "type": "forcePushed"}, {"oid": "0587be956b26d35d1808d49b208f87971ce66311", "url": "https://github.com/apollographql/apollo-android/commit/0587be956b26d35d1808d49b208f87971ce66311", "message": "`apollo-api` JS support. (rebased from dev-3.x to master)", "committedDate": "2020-07-25T19:11:31Z", "type": "forcePushed"}, {"oid": "212a7ee502d7a1e03c8a6e506e0ddf8d4e717260", "url": "https://github.com/apollographql/apollo-android/commit/212a7ee502d7a1e03c8a6e506e0ddf8d4e717260", "message": "`apollo-api` JS support. (rebased from dev-3.x to master)", "committedDate": "2020-07-25T19:24:29Z", "type": "commit"}, {"oid": "212a7ee502d7a1e03c8a6e506e0ddf8d4e717260", "url": "https://github.com/apollographql/apollo-android/commit/212a7ee502d7a1e03c8a6e506e0ddf8d4e717260", "message": "`apollo-api` JS support. (rebased from dev-3.x to master)", "committedDate": "2020-07-25T19:24:29Z", "type": "forcePushed"}, {"oid": "9dbcb99c4a5427aaacee01097a0a04cca61dc4f1", "url": "https://github.com/apollographql/apollo-android/commit/9dbcb99c4a5427aaacee01097a0a04cca61dc4f1", "message": "Update apollo-api/api.txt. Mark external JS decl as internal.", "committedDate": "2020-07-25T23:51:13Z", "type": "forcePushed"}, {"oid": "047886ead99b6db562f7abd3f00b21417143a415", "url": "https://github.com/apollographql/apollo-android/commit/047886ead99b6db562f7abd3f00b21417143a415", "message": "Update apollo-api/api.txt. Mark external JS decl as internal.", "committedDate": "2020-07-26T01:30:59Z", "type": "commit"}, {"oid": "047886ead99b6db562f7abd3f00b21417143a415", "url": "https://github.com/apollographql/apollo-android/commit/047886ead99b6db562f7abd3f00b21417143a415", "message": "Update apollo-api/api.txt. Mark external JS decl as internal.", "committedDate": "2020-07-26T01:30:59Z", "type": "forcePushed"}, {"oid": "2d751d6e1dbc2f630d6e19f0b4957fd7e33234b5", "url": "https://github.com/apollographql/apollo-android/commit/2d751d6e1dbc2f630d6e19f0b4957fd7e33234b5", "message": "Merge branch 'master' into api-js", "committedDate": "2020-07-30T08:53:51Z", "type": "commit"}]}