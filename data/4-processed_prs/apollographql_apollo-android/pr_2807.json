{"pr_number": 2807, "pr_title": "Initial work for multiplatform cache", "pr_createdAt": "2020-12-16T09:53:42Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2807", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODU4MQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546498581", "bodyText": "why not just call it apollo-cache? I thought that everything that belongs to normalize cache will be packaged in one artifact?", "author": "sav007", "createdAt": "2020-12-21T04:04:30Z", "path": "apollo-cache-interceptor/gradle.properties", "diffHunk": "@@ -0,0 +1,3 @@\n+POM_ARTIFACT_ID=apollo-cache-interceptor", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MDEwNA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546590104", "bodyText": "Excellent question! I'm not 100% sure where I'm going with this but it feels like we should bundle the sqlite cache by default so multiple artifacts would be needed. At this stage of development, my rationale was that having multiple single-responsibility modules makes for better separation of concern and that we would \"polish\" the user-facing API/artifacts once everything is feature complete.", "author": "martinbonnin", "createdAt": "2020-12-21T09:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYyNDkxOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r547624919", "bodyText": "Sure, we can always change this later, let's leave it for now.", "author": "sav007", "createdAt": "2020-12-23T03:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODc5NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546498795", "bodyText": "nit: private for both props?", "author": "sav007", "createdAt": "2020-12-21T04:05:33Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/ApolloCacheInterceptor.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.api.Response.Companion.builder\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.internal.NoOpResolveDelegate\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.CacheKeyResolver\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.internal.CacheFieldValueResolver\n+import com.apollographql.apollo.cache.normalized.internal.CacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ReadableStore\n+import com.apollographql.apollo.cache.normalized.internal.RealCacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ResponseNormalizer\n+import com.apollographql.apollo.cache.normalized.simple.SimpleNormalizedCache\n+import com.apollographql.apollo.interceptor.ApolloInterceptorChain\n+import com.apollographql.apollo.interceptor.ApolloRequest\n+import com.apollographql.apollo.interceptor.ApolloRequestInterceptor\n+import com.apollographql.apollo.interceptor.ApolloResponse\n+import com.apollographql.apollo.internal.response.RealResponseReader\n+import com.apollographql.apollo.internal.response.RealResponseWriter\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.collect\n+import kotlinx.coroutines.flow.flow\n+\n+@ApolloExperimental\n+class ApolloCacheInterceptor : ApolloRequestInterceptor {\n+  val normalizedCache = SimpleNormalizedCache()\n+  val readableStore = object : ReadableStore {", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTQyOQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546499429", "bodyText": "should we mark as internal? I was thinking back in a day that cache plugin will take existing ApolloClient and decorate it with proper execution context and setup interceptors, so user won't know existence of interceptor as it's our internal implementation abstraction.", "author": "sav007", "createdAt": "2020-12-21T04:08:57Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/ApolloCacheInterceptor.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.api.Response.Companion.builder\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.internal.NoOpResolveDelegate\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.CacheKeyResolver\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.internal.CacheFieldValueResolver\n+import com.apollographql.apollo.cache.normalized.internal.CacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ReadableStore\n+import com.apollographql.apollo.cache.normalized.internal.RealCacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ResponseNormalizer\n+import com.apollographql.apollo.cache.normalized.simple.SimpleNormalizedCache\n+import com.apollographql.apollo.interceptor.ApolloInterceptorChain\n+import com.apollographql.apollo.interceptor.ApolloRequest\n+import com.apollographql.apollo.interceptor.ApolloRequestInterceptor\n+import com.apollographql.apollo.interceptor.ApolloResponse\n+import com.apollographql.apollo.internal.response.RealResponseReader\n+import com.apollographql.apollo.internal.response.RealResponseWriter\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.collect\n+import kotlinx.coroutines.flow.flow\n+\n+@ApolloExperimental\n+class ApolloCacheInterceptor : ApolloRequestInterceptor {", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5NTQ1Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546595457", "bodyText": "Also excellent question. I'd love to find a nicer API. Did you have something in mind already?\nShould we introduce a ApolloClientBuilder to take care of the wiring of all the interceptors? In all cases, I think this should stay public as ultimately, we also want users to be able to plug their own interceptors and modify the list as they please?", "author": "martinbonnin", "createdAt": "2020-12-21T09:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI5NDc1MQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r547294751", "bodyText": "@sav007 I ended up adding ApolloClient.Builder, one option would have been to make ApolloClient a data class and copying it around. Using a Builder adds some boilerplate code but also has a few advantages:\n\nI didn't really liked the idea of making ApolloClient a data class\nIt makes it clear what is mutable and what's not\nIt puts the arguments verification logic in a single place", "author": "martinbonnin", "createdAt": "2020-12-22T14:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTY1Mw==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546499653", "bodyText": "Should we extract interface and inject implementation during construction time?", "author": "sav007", "createdAt": "2020-12-21T04:10:15Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/ApolloCacheInterceptor.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.api.Response.Companion.builder\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.internal.NoOpResolveDelegate\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.CacheKeyResolver\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.internal.CacheFieldValueResolver\n+import com.apollographql.apollo.cache.normalized.internal.CacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ReadableStore\n+import com.apollographql.apollo.cache.normalized.internal.RealCacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ResponseNormalizer\n+import com.apollographql.apollo.cache.normalized.simple.SimpleNormalizedCache\n+import com.apollographql.apollo.interceptor.ApolloInterceptorChain\n+import com.apollographql.apollo.interceptor.ApolloRequest\n+import com.apollographql.apollo.interceptor.ApolloRequestInterceptor\n+import com.apollographql.apollo.interceptor.ApolloResponse\n+import com.apollographql.apollo.internal.response.RealResponseReader\n+import com.apollographql.apollo.internal.response.RealResponseWriter\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.collect\n+import kotlinx.coroutines.flow.flow\n+\n+@ApolloExperimental\n+class ApolloCacheInterceptor : ApolloRequestInterceptor {\n+  val normalizedCache = SimpleNormalizedCache()", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTgxNA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546499814", "bodyText": "nit: could you pls put arguments on separate lines", "author": "sav007", "createdAt": "2020-12-21T04:11:14Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/ApolloCacheInterceptor.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.api.Response.Companion.builder\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.internal.NoOpResolveDelegate\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.CacheKeyResolver\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.internal.CacheFieldValueResolver\n+import com.apollographql.apollo.cache.normalized.internal.CacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ReadableStore\n+import com.apollographql.apollo.cache.normalized.internal.RealCacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ResponseNormalizer\n+import com.apollographql.apollo.cache.normalized.simple.SimpleNormalizedCache\n+import com.apollographql.apollo.interceptor.ApolloInterceptorChain\n+import com.apollographql.apollo.interceptor.ApolloRequest\n+import com.apollographql.apollo.interceptor.ApolloRequestInterceptor\n+import com.apollographql.apollo.interceptor.ApolloResponse\n+import com.apollographql.apollo.internal.response.RealResponseReader\n+import com.apollographql.apollo.internal.response.RealResponseWriter\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.collect\n+import kotlinx.coroutines.flow.flow\n+\n+@ApolloExperimental\n+class ApolloCacheInterceptor : ApolloRequestInterceptor {\n+  val normalizedCache = SimpleNormalizedCache()\n+  val readableStore = object : ReadableStore {\n+    override fun read(key: String, cacheHeaders: CacheHeaders): Record? {\n+      return normalizedCache.loadRecord(key, cacheHeaders)\n+    }\n+\n+    override fun read(keys: Collection<String>, cacheHeaders: CacheHeaders): Collection<Record> {\n+      return keys.mapNotNull { normalizedCache.loadRecord(it, cacheHeaders) }\n+    }\n+  }\n+\n+  override fun <D : Operation.Data> intercept(request: ApolloRequest<D>, chain: ApolloInterceptorChain): Flow<ApolloResponse<D>> {\n+    return flow {\n+      val response = readFromCache(request)\n+      if (response != null) {\n+        emit(ApolloResponse(requestUuid = request.requestUuid, response = response, executionContext = request.executionContext + CacheExecutionContext(true)))", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5NzE0OA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546597148", "bodyText": "Sure thing!", "author": "martinbonnin", "createdAt": "2020-12-21T09:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMDAzMg==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546500032", "bodyText": "internal?", "author": "sav007", "createdAt": "2020-12-21T04:12:28Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/CacheExecutionContext.kt", "diffHunk": "@@ -0,0 +1,17 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.ExecutionContext\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+\n+@ApolloExperimental\n+data class CacheExecutionContext(", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5ODA2MA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546598060", "bodyText": "I used this to carry the information about whether a given response came from the cache or not so ultimately the user should have access to this.\nSee Response<D>.cacheContext()", "author": "martinbonnin", "createdAt": "2020-12-21T09:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMDAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5ODc1NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546798755", "bodyText": "My bad you are right.", "author": "sav007", "createdAt": "2020-12-21T16:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMDAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMDgxMA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546500810", "bodyText": "As far as I remember the original idea is that interceptor get *Store implementation injected where *Store is constructed with cache implementation. So interceptor knows only about store, and has only one dependency.", "author": "sav007", "createdAt": "2020-12-21T04:16:26Z", "path": "apollo-cache-interceptor/src/commonMain/kotlin/com/apollographql/apollo/interceptor/cache/ApolloCacheInterceptor.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package com.apollographql.apollo.interceptor.cache\n+\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.api.Response.Companion.builder\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.internal.NoOpResolveDelegate\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.CacheKeyResolver\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.internal.CacheFieldValueResolver\n+import com.apollographql.apollo.cache.normalized.internal.CacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ReadableStore\n+import com.apollographql.apollo.cache.normalized.internal.RealCacheKeyBuilder\n+import com.apollographql.apollo.cache.normalized.internal.ResponseNormalizer\n+import com.apollographql.apollo.cache.normalized.simple.SimpleNormalizedCache\n+import com.apollographql.apollo.interceptor.ApolloInterceptorChain\n+import com.apollographql.apollo.interceptor.ApolloRequest\n+import com.apollographql.apollo.interceptor.ApolloRequestInterceptor\n+import com.apollographql.apollo.interceptor.ApolloResponse\n+import com.apollographql.apollo.internal.response.RealResponseReader\n+import com.apollographql.apollo.internal.response.RealResponseWriter\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.collect\n+import kotlinx.coroutines.flow.flow\n+\n+@ApolloExperimental\n+class ApolloCacheInterceptor : ApolloRequestInterceptor {\n+  val normalizedCache = SimpleNormalizedCache()\n+  val readableStore = object : ReadableStore {", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwNDk4NA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546604984", "bodyText": "Makes perfect sense, I changed that.", "author": "martinbonnin", "createdAt": "2020-12-21T09:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMDgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMTAxNA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546501014", "bodyText": "private?", "author": "sav007", "createdAt": "2020-12-21T04:17:18Z", "path": "apollo-normalized-cache/src/commonMain/kotlin/com/apollographql/apollo/cache/normalized/simple/SimpleNormalizedCache.kt", "diffHunk": "@@ -0,0 +1,45 @@\n+package com.apollographql.apollo.cache.normalized.simple\n+\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.NormalizedCache\n+import com.apollographql.apollo.cache.normalized.Record\n+\n+class SimpleNormalizedCache : NormalizedCache() {\n+  val map = mutableMapOf<String, Record>()", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMTIyMA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546501220", "bodyText": "internal? Also should we call it InMemoryNormalizedCache or  MapNormalizedCache?", "author": "sav007", "createdAt": "2020-12-21T04:18:35Z", "path": "apollo-normalized-cache/src/commonMain/kotlin/com/apollographql/apollo/cache/normalized/simple/SimpleNormalizedCache.kt", "diffHunk": "@@ -0,0 +1,45 @@\n+package com.apollographql.apollo.cache.normalized.simple\n+\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.NormalizedCache\n+import com.apollographql.apollo.cache.normalized.Record\n+\n+class SimpleNormalizedCache : NormalizedCache() {", "originalCommit": "2512343dd52a6d6e08db26e995bf62458e665352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwNzA4NA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r546607084", "bodyText": "Renamed to MapNormalizedCache. InMemoryNormalizedCache might clash with the future LRU cache.", "author": "martinbonnin", "createdAt": "2020-12-21T09:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUwMTIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYyNDEyMA==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r547624120", "bodyText": "nit:\nfun serverUrl(serverUrl: String): Builder = apply {\n   ...\n}\n\nthe same nit for the rest APIs", "author": "sav007", "createdAt": "2020-12-23T03:48:31Z", "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/ApolloClient.kt", "diffHunk": "@@ -50,4 +55,100 @@ class ApolloClient(\n         executionContext = executionContext + coroutineDispatcherContext\n     )\n   }\n+\n+  fun newBuilder(): Builder {\n+    return DefaultBuilder(scalarTypeAdapters)\n+        .networkTransport(networkTransport)\n+        .subscriptionNetworkTransport(subscriptionNetworkTransport)\n+        .interceptors(interceptors)\n+        .executionContext(executionContext)\n+  }\n+\n+  class DefaultBuilder(override val scalarTypeAdapters: ScalarTypeAdapters = ScalarTypeAdapters.DEFAULT) : Builder()\n+\n+  abstract class Builder {\n+    internal abstract val scalarTypeAdapters: ScalarTypeAdapters\n+\n+    private var networkTransport: NetworkTransport? = null\n+    private var subscriptionNetworkTransport: NetworkTransport? = null\n+    private var interceptors: List<ApolloRequestInterceptor> = emptyList()\n+    private var executionContext: ExecutionContext = ExecutionContext.Empty\n+\n+    fun serverUrl(serverUrl: String): Builder {", "originalCommit": "5da516e8019aef5462ed28ab6ee0f3314249c4b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYyNDU0Mg==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r547624542", "bodyText": "is there a reason to have this DefaultBuilder  class, can't Builder be concrete class with scalarTypeAdapters: ScalarTypeAdapters = ScalarTypeAdapters.DEFAULT", "author": "sav007", "createdAt": "2020-12-23T03:50:23Z", "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/ApolloClient.kt", "diffHunk": "@@ -50,4 +55,100 @@ class ApolloClient(\n         executionContext = executionContext + coroutineDispatcherContext\n     )\n   }\n+\n+  fun newBuilder(): Builder {\n+    return DefaultBuilder(scalarTypeAdapters)\n+        .networkTransport(networkTransport)\n+        .subscriptionNetworkTransport(subscriptionNetworkTransport)\n+        .interceptors(interceptors)\n+        .executionContext(executionContext)\n+  }\n+\n+  class DefaultBuilder(override val scalarTypeAdapters: ScalarTypeAdapters = ScalarTypeAdapters.DEFAULT) : Builder()", "originalCommit": "5da516e8019aef5462ed28ab6ee0f3314249c4b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgxMjk0Mw==", "url": "https://github.com/apollographql/apollo-android/pull/2807#discussion_r547812943", "bodyText": "I was contemplating the idea of auto generating Builders with pre-built ScalarTypeAdapters like ApolloClient.Companion.GithubBuilder(). But that makes the generated code depend on the runtime which isn't great. I'll revert.", "author": "martinbonnin", "createdAt": "2020-12-23T08:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYyNDU0Mg=="}], "type": "inlineReview"}, {"oid": "d5daa2231640ab65df08a7e2f528bea7728e8330", "url": "https://github.com/apollographql/apollo-android/commit/d5daa2231640ab65df08a7e2f528bea7728e8330", "message": "Initial work for the multiplatform cache\n\n* Added `apollo-cache-interceptor` as a separate artifact\n* The cache is cache_first only at the moment and provided by\n  `ApolloCacheInterceptor`\n* Added CacheExecutionContext and `Response.cacheContext` to access\n  `fromCache`\n* Added `apollo-integration-kotlin`, like `apollo-integration` but\n  multiplatform. See CacheInterceptorTest for a test\n* Added `apollo-testing-support` to group useful classes for testing.\n  Ultimately, this could be exported to end users for mock/testing\npurposes\n\nNext steps:\n* Implement different fetchers\n* Make the cache work with the streaming parser\n\nmake compile", "committedDate": "2020-12-23T08:59:49Z", "type": "commit"}, {"oid": "23196762a0d814862adc4a2e86eaf2212a8963f2", "url": "https://github.com/apollographql/apollo-android/commit/23196762a0d814862adc4a2e86eaf2212a8963f2", "message": "make the normalized cache injectable and private", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "b32fc605607afaa6a2cb924e8c3dbfc8080db0a4", "url": "https://github.com/apollographql/apollo-android/commit/b32fc605607afaa6a2cb924e8c3dbfc8080db0a4", "message": "put arguments on multiple lines", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "d0ac7e34b994a59527416e0daf775a3786aafebe", "url": "https://github.com/apollographql/apollo-android/commit/d0ac7e34b994a59527416e0daf775a3786aafebe", "message": "make ApolloCacheInterceptor depend on Store only", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "1f4f8bce854032e478d14c5b85c4ef3c10d7dbe1", "url": "https://github.com/apollographql/apollo-android/commit/1f4f8bce854032e478d14c5b85c4ef3c10d7dbe1", "message": "make private", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "38e79696d483097d0be74e370137546203c352bc", "url": "https://github.com/apollographql/apollo-android/commit/38e79696d483097d0be74e370137546203c352bc", "message": "rename to `MapNormalizedCache`", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "43e68647add7c9e442bba15bc22739e7ea2eceb7", "url": "https://github.com/apollographql/apollo-android/commit/43e68647add7c9e442bba15bc22739e7ea2eceb7", "message": "fix tests", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "754e2983b031cf8bf867c216b3fe4e3ce2e158d6", "url": "https://github.com/apollographql/apollo-android/commit/754e2983b031cf8bf867c216b3fe4e3ce2e158d6", "message": "fix some more tests", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "d64481c518ecf1d87560d2351afa2976817e456b", "url": "https://github.com/apollographql/apollo-android/commit/d64481c518ecf1d87560d2351afa2976817e456b", "message": "introduce ApolloClient.Builder", "committedDate": "2020-12-23T09:00:08Z", "type": "commit"}, {"oid": "9e5f76c8398026587e66ddd8e694e7f1a3f348bb", "url": "https://github.com/apollographql/apollo-android/commit/9e5f76c8398026587e66ddd8e694e7f1a3f348bb", "message": "add ApolloClient.Builder.normalizedCache()", "committedDate": "2020-12-23T09:00:09Z", "type": "commit"}, {"oid": "e65950f4d9f64e5da0e5e4af19281c293e8069d3", "url": "https://github.com/apollographql/apollo-android/commit/e65950f4d9f64e5da0e5e4af19281c293e8069d3", "message": "Opt-in the experimental coroutines API\n\nDo not propagate the experimental annotation, the experimental usages\nare implementation details and we already have @ApolloExperimental for\nour experimental stuff", "committedDate": "2020-12-23T09:00:09Z", "type": "commit"}, {"oid": "9be079883bc0015d4ac8a31f2511c906fe20bc6f", "url": "https://github.com/apollographql/apollo-android/commit/9be079883bc0015d4ac8a31f2511c906fe20bc6f", "message": "update to new coroutine API", "committedDate": "2020-12-23T09:00:09Z", "type": "commit"}, {"oid": "d1fbb435464633bea458a46c0034b7b56ceacc44", "url": "https://github.com/apollographql/apollo-android/commit/d1fbb435464633bea458a46c0034b7b56ceacc44", "message": "use apply", "committedDate": "2020-12-23T09:00:09Z", "type": "commit"}, {"oid": "23cd570c0d17abadb020a19d1db4bd6ac81bf58d", "url": "https://github.com/apollographql/apollo-android/commit/23cd570c0d17abadb020a19d1db4bd6ac81bf58d", "message": "make `Builder` instanciable directly", "committedDate": "2020-12-23T09:00:09Z", "type": "commit"}, {"oid": "23cd570c0d17abadb020a19d1db4bd6ac81bf58d", "url": "https://github.com/apollographql/apollo-android/commit/23cd570c0d17abadb020a19d1db4bd6ac81bf58d", "message": "make `Builder` instanciable directly", "committedDate": "2020-12-23T09:00:09Z", "type": "forcePushed"}, {"oid": "406c2c0282408bba880080ed3e1f920ef4ca964b", "url": "https://github.com/apollographql/apollo-android/commit/406c2c0282408bba880080ed3e1f920ef4ca964b", "message": "use Builder instead of DefaultBuilder", "committedDate": "2020-12-23T09:24:57Z", "type": "commit"}]}