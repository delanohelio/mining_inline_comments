{"pr_number": 2592, "pr_title": "[Compiler] Handle lists in arguments", "pr_createdAt": "2020-09-21T11:22:01Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2592", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2ODUwNQ==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r491968505", "bodyText": "I also took this opportunity to map GraphQL's Int and Float to Kotlin's Int and Double for better typing. While I believe it's more correct, it's a behaviour change so I'm happy to revert if we think this is risky.", "author": "martinbonnin", "createdAt": "2020-09-21T11:27:34Z", "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -170,21 +171,34 @@ data class TestQuery(\n           ResponseField.forObject(\"heroWithReview\", \"heroWithReview\", mapOf<String, Any>(\n             \"episode\" to mapOf<String, Any>(\n               \"kind\" to \"Variable\",\n-              \"variableName\" to \"episode\"),\n+              \"variableName\" to \"episode\"\n+            ),\n             \"review\" to mapOf<String, Any>(\n               \"stars\" to mapOf<String, Any>(\n                 \"kind\" to \"Variable\",\n-                \"variableName\" to \"stars\"),\n+                \"variableName\" to \"stars\"\n+              ),\n               \"favoriteColor\" to mapOf<String, Any>(\n-                \"red\" to \"0\",\n+                \"red\" to 0,", "originalCommit": "92e556bf29139a768b44db3c19b7f1392a37515c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3NDU3NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r491974575", "bodyText": "Thinking more about this, this shouldn't change what's sent to the server (which is in QUERY_DOCUMENT) so the impact would only be for the cache. So impact is still limited but that could trigger some unwanted cache miss so I'm going to revert that.", "author": "martinbonnin", "createdAt": "2020-09-21T11:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2ODUwNQ=="}], "type": "inlineReview"}, {"oid": "46dde50109e565dbd055b800627642950cbe6369", "url": "https://github.com/apollographql/apollo-android/commit/46dde50109e565dbd055b800627642950cbe6369", "message": "InputTypes should not contain variables themselves, no need to recurse\nhere", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "02284678f7be8dc3f8ecce45192757faf3f1583a", "url": "https://github.com/apollographql/apollo-android/commit/02284678f7be8dc3f8ecce45192757faf3f1583a", "message": "add a (currently-failing) test", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "a30e0c2995d99d083c585438a4f42c982da6b79b", "url": "https://github.com/apollographql/apollo-android/commit/a30e0c2995d99d083c585438a4f42c982da6b79b", "message": "Generate Kotlin lists for Graphql lists argument values", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "6d0d26732fcdea4d5d87ba79b2fc0c5613cd1c9e", "url": "https://github.com/apollographql/apollo-android/commit/6d0d26732fcdea4d5d87ba79b2fc0c5613cd1c9e", "message": "handle Lists in arguments", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "80ca943b15e565a1e61575485ae6f958c387b712", "url": "https://github.com/apollographql/apollo-android/commit/80ca943b15e565a1e61575485ae6f958c387b712", "message": "update tests", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "e50845e2641e5f530efbfa046e0dcb41e1ba0961", "url": "https://github.com/apollographql/apollo-android/commit/e50845e2641e5f530efbfa046e0dcb41e1ba0961", "message": "keep numbers encoded as Strings", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "0842204c4269f53b629be9e5a1e717b61a655844", "url": "https://github.com/apollographql/apollo-android/commit/0842204c4269f53b629be9e5a1e717b61a655844", "message": "remove indentation fix to keep the model as close as possible to their\nprevious state", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "0ed6a247a33a3ab7bd119cdd820f7cdbec9fbf46", "url": "https://github.com/apollographql/apollo-android/commit/0ed6a247a33a3ab7bd119cdd820f7cdbec9fbf46", "message": "update test fixtures", "committedDate": "2020-09-21T11:44:52Z", "type": "commit"}, {"oid": "0ed6a247a33a3ab7bd119cdd820f7cdbec9fbf46", "url": "https://github.com/apollographql/apollo-android/commit/0ed6a247a33a3ab7bd119cdd820f7cdbec9fbf46", "message": "update test fixtures", "committedDate": "2020-09-21T11:44:52Z", "type": "forcePushed"}, {"oid": "04a162648359692b9becd6843ca5c55c2646aa6b", "url": "https://github.com/apollographql/apollo-android/commit/04a162648359692b9becd6843ca5c55c2646aa6b", "message": "add a comment", "committedDate": "2020-09-21T13:13:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0OTEwNw==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r493849107", "bodyText": "toSortedMap() fits also\nhttps://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/to-sorted-map.html", "author": "akelix", "createdAt": "2020-09-23T19:39:46Z", "path": "apollo-normalized-cache/src/commonMain/kotlin/com/apollographql/apollo/cache/normalized/internal/RealCacheKeyBuilder.kt", "diffHunk": "@@ -29,34 +29,39 @@ class RealCacheKeyBuilder : CacheKeyBuilder {\n   }\n \n   @Suppress(\"UNCHECKED_CAST\")\n-  private fun resolveArguments(objectMap: Map<String, Any?>, variables: Operation.Variables): Map<String, Any?> {\n-    return objectMap.mapValues { (_, value) ->\n-      if (value is Map<*, *>) {\n-        val nestedObjectMap = value as Map<String, Any?>\n-        if (isArgumentValueVariableType(nestedObjectMap)) {\n-          resolveVariableArgument(nestedObjectMap, variables)\n+  private fun resolveVariables(value: Any?, variables: Operation.Variables): Any? {\n+    return when (value) {\n+      null -> null\n+      is Map<*, *> -> {\n+        value as Map<String, Any?>\n+        if (isArgumentValueVariableType(value)) {\n+          resolveVariable(value, variables)\n         } else {\n-          resolveArguments(nestedObjectMap, variables)\n+          value.mapValues {\n+            resolveVariables(it.value, variables)\n+          }.toList()\n+              .sortedBy { it.first }", "originalCommit": "04a162648359692b9becd6843ca5c55c2646aa6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkyMDYzMA==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r493920630", "bodyText": "I wish it worked but unfortunately toSortedMap() is JVM only. At this point this is mainly rhetorical because there's no real way to consume the normalized cache from anything else than JVM but there will be a native cache in the future.", "author": "martinbonnin", "createdAt": "2020-09-23T22:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0OTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NjM5Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r493946396", "bodyText": "sanity check: why these lines were removed?", "author": "sav007", "createdAt": "2020-09-23T23:10:33Z", "path": "apollo-normalized-cache/src/commonMain/kotlin/com/apollographql/apollo/cache/normalized/internal/RealCacheKeyBuilder.kt", "diffHunk": "@@ -29,34 +29,39 @@ class RealCacheKeyBuilder : CacheKeyBuilder {\n   }\n \n   @Suppress(\"UNCHECKED_CAST\")\n-  private fun resolveArguments(objectMap: Map<String, Any?>, variables: Operation.Variables): Map<String, Any?> {\n-    return objectMap.mapValues { (_, value) ->\n-      if (value is Map<*, *>) {\n-        val nestedObjectMap = value as Map<String, Any?>\n-        if (isArgumentValueVariableType(nestedObjectMap)) {\n-          resolveVariableArgument(nestedObjectMap, variables)\n+  private fun resolveVariables(value: Any?, variables: Operation.Variables): Any? {\n+    return when (value) {\n+      null -> null\n+      is Map<*, *> -> {\n+        value as Map<String, Any?>\n+        if (isArgumentValueVariableType(value)) {\n+          resolveVariable(value, variables)\n         } else {\n-          resolveArguments(nestedObjectMap, variables)\n+          value.mapValues {\n+            resolveVariables(it.value, variables)\n+          }.toList()\n+              .sortedBy { it.first }\n+              .toMap()\n+        }\n+      }\n+      is List<*> -> {\n+        value.map {\n+          resolveVariables(it, variables)\n         }\n-      } else {\n-        value\n       }\n-    }.toList()\n-        .sortedBy { it.first }\n-        .toMap()\n+      else -> value\n+    }\n   }\n \n   @Suppress(\"UNCHECKED_CAST\")\n-  private fun resolveVariableArgument(objectMap: Map<String, Any?>, variables: Operation.Variables): Any? {\n+  private fun resolveVariable(objectMap: Map<String, Any?>, variables: Operation.Variables): Any? {\n     val variable = objectMap[ResponseField.VARIABLE_NAME_KEY]\n \n     return when (val resolvedVariable = variables.valueMap()[variable]) {\n-      null -> null\n-      is Map<*, *> -> resolveArguments(resolvedVariable as Map<String, Any?>, variables)", "originalCommit": "04a162648359692b9becd6843ca5c55c2646aa6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNTU0NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r494005545", "bodyText": "nvm, I found that it's handled above", "author": "sav007", "createdAt": "2020-09-24T02:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NjM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NzQ0OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r493947449", "bodyText": "don't really remember why but looks like this was launching recursion for nested map arguments resolution for input type. We this change we dont do this anymore, is it right?", "author": "sav007", "createdAt": "2020-09-23T23:12:19Z", "path": "apollo-normalized-cache/src/commonMain/kotlin/com/apollographql/apollo/cache/normalized/internal/RealCacheKeyBuilder.kt", "diffHunk": "@@ -29,34 +29,39 @@ class RealCacheKeyBuilder : CacheKeyBuilder {\n   }\n \n   @Suppress(\"UNCHECKED_CAST\")\n-  private fun resolveArguments(objectMap: Map<String, Any?>, variables: Operation.Variables): Map<String, Any?> {\n-    return objectMap.mapValues { (_, value) ->\n-      if (value is Map<*, *>) {\n-        val nestedObjectMap = value as Map<String, Any?>\n-        if (isArgumentValueVariableType(nestedObjectMap)) {\n-          resolveVariableArgument(nestedObjectMap, variables)\n+  private fun resolveVariables(value: Any?, variables: Operation.Variables): Any? {\n+    return when (value) {\n+      null -> null\n+      is Map<*, *> -> {\n+        value as Map<String, Any?>\n+        if (isArgumentValueVariableType(value)) {\n+          resolveVariable(value, variables)\n         } else {\n-          resolveArguments(nestedObjectMap, variables)\n+          value.mapValues {\n+            resolveVariables(it.value, variables)\n+          }.toList()\n+              .sortedBy { it.first }\n+              .toMap()\n+        }\n+      }\n+      is List<*> -> {\n+        value.map {\n+          resolveVariables(it, variables)\n         }\n-      } else {\n-        value\n       }\n-    }.toList()\n-        .sortedBy { it.first }\n-        .toMap()\n+      else -> value\n+    }\n   }\n \n   @Suppress(\"UNCHECKED_CAST\")\n-  private fun resolveVariableArgument(objectMap: Map<String, Any?>, variables: Operation.Variables): Any? {\n+  private fun resolveVariable(objectMap: Map<String, Any?>, variables: Operation.Variables): Any? {\n     val variable = objectMap[ResponseField.VARIABLE_NAME_KEY]\n \n     return when (val resolvedVariable = variables.valueMap()[variable]) {\n-      null -> null\n-      is Map<*, *> -> resolveArguments(resolvedVariable as Map<String, Any?>, variables)\n       is InputType -> {\n         val inputFieldMapWriter = SortedInputFieldMapWriter()\n         resolvedVariable.marshaller().marshal(inputFieldMapWriter)\n-        resolveArguments(inputFieldMapWriter.map(), variables)", "originalCommit": "04a162648359692b9becd6843ca5c55c2646aa6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwODE3OA==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r494008178", "bodyText": "Looks like it doesn't make any sense for recursion here at first place. If resolvedVariable is InputType there is no way it has reference to other variables.", "author": "sav007", "createdAt": "2020-09-24T02:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwMzkzNQ==", "url": "https://github.com/apollographql/apollo-android/pull/2592#discussion_r494103935", "bodyText": "Yes, exactly !", "author": "martinbonnin", "createdAt": "2020-09-24T07:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0NzQ0OQ=="}], "type": "inlineReview"}]}