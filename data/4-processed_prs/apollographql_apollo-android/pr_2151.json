{"pr_number": 2151, "pr_title": "More Kotlin in normalized-cache", "pr_createdAt": "2020-04-10T20:12:05Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2151", "timeline": [{"oid": "9731a012052afc9eec9722614bc30a6a9e79a17b", "url": "https://github.com/apollographql/apollo-android/commit/9731a012052afc9eec9722614bc30a6a9e79a17b", "message": "Remove unnecessary gradle file", "committedDate": "2020-04-10T17:43:39Z", "type": "commit"}, {"oid": "9867f8f9212441f327ff8301a3f94910fef5c83a", "url": "https://github.com/apollographql/apollo-android/commit/9867f8f9212441f327ff8301a3f94910fef5c83a", "message": "Rename .java to .kt", "committedDate": "2020-04-10T19:05:22Z", "type": "commit"}, {"oid": "2d633db5b8d5766c3077d6317150d08e4010ab4b", "url": "https://github.com/apollographql/apollo-android/commit/2d633db5b8d5766c3077d6317150d08e4010ab4b", "message": "Convert NormalizedCache to Kotlin", "committedDate": "2020-04-10T19:16:53Z", "type": "commit"}, {"oid": "a6960cf0d2801958f91483839554a28da9c4ac2e", "url": "https://github.com/apollographql/apollo-android/commit/a6960cf0d2801958f91483839554a28da9c4ac2e", "message": "Rename .java to .kt", "committedDate": "2020-04-10T19:31:30Z", "type": "commit"}, {"oid": "b59222bc42e016355adb36898489a4b4e3716eb9", "url": "https://github.com/apollographql/apollo-android/commit/b59222bc42e016355adb36898489a4b4e3716eb9", "message": "Migrate LruNormalizedCache", "committedDate": "2020-04-10T19:32:46Z", "type": "commit"}, {"oid": "47ade249efd1690f8222723da739a8cb905c595f", "url": "https://github.com/apollographql/apollo-android/commit/47ade249efd1690f8222723da739a8cb905c595f", "message": "Rename .java to .kt", "committedDate": "2020-04-10T19:51:17Z", "type": "commit"}, {"oid": "d8a06d071abb4bc3060a048bca797d8e69818d4a", "url": "https://github.com/apollographql/apollo-android/commit/d8a06d071abb4bc3060a048bca797d8e69818d4a", "message": "Migrate OptimisticNormalizedCache", "committedDate": "2020-04-10T19:51:17Z", "type": "commit"}, {"oid": "df59e582ef8a5e1e8bdc2f9b3fa558db62c30639", "url": "https://github.com/apollographql/apollo-android/commit/df59e582ef8a5e1e8bdc2f9b3fa558db62c30639", "message": "Revert changes in tests by keeping API backward compatible.", "committedDate": "2020-04-10T20:16:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDQ2Mg==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r406924462", "bodyText": "This is out of scope but it was redundant.", "author": "tasomaniac", "createdAt": "2020-04-10T20:17:11Z", "path": "apollo-android-support/build.gradle.kts", "diffHunk": "@@ -1,10 +1,4 @@\n import com.android.build.gradle.BaseExtension\n-buildscript {", "originalCommit": "df59e582ef8a5e1e8bdc2f9b3fa558db62c30639", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89d3fe378cc17fd436629e9317508a0f9794faa1", "url": "https://github.com/apollographql/apollo-android/commit/89d3fe378cc17fd436629e9317508a0f9794faa1", "message": "Rename .java to .kt", "committedDate": "2020-04-10T20:31:12Z", "type": "commit"}, {"oid": "ac1e1c19d10ceee990e5f4e918ad05742a90b594", "url": "https://github.com/apollographql/apollo-android/commit/ac1e1c19d10ceee990e5f4e918ad05742a90b594", "message": "Also convert NormalizedCacheFactory", "committedDate": "2020-04-10T21:29:51Z", "type": "commit"}, {"oid": "ac1e1c19d10ceee990e5f4e918ad05742a90b594", "url": "https://github.com/apollographql/apollo-android/commit/ac1e1c19d10ceee990e5f4e918ad05742a90b594", "message": "Also convert NormalizedCacheFactory", "committedDate": "2020-04-10T21:29:51Z", "type": "forcePushed"}, {"oid": "b87ef9d8212689867548c0389eb9a6e537d335c8", "url": "https://github.com/apollographql/apollo-android/commit/b87ef9d8212689867548c0389eb9a6e537d335c8", "message": "Move prettifyDump back to NormalizedCache", "committedDate": "2020-04-11T10:48:30Z", "type": "commit"}, {"oid": "b87ef9d8212689867548c0389eb9a6e537d335c8", "url": "https://github.com/apollographql/apollo-android/commit/b87ef9d8212689867548c0389eb9a6e537d335c8", "message": "Move prettifyDump back to NormalizedCache", "committedDate": "2020-04-11T10:48:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MTUxOA==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407081518", "bodyText": "I have to double check entire logic of this function, after quick look at the logic that was before looks suspicious.\nIt looks like we remove only from the nextCache if it present and never from current instance \ud83e\udd14", "author": "sav007", "createdAt": "2020-04-11T16:15:54Z", "path": "apollo-android-support/src/main/java/com/apollographql/apollo/cache/normalized/sql/SqlNormalizedCache.java", "diffHunk": "@@ -102,40 +99,35 @@\n     return changedKeys;\n   }\n \n-  @SuppressWarnings(\"ResultOfMethodCallIgnored\")\n   @Override public void clearAll() {\n-    //noinspection ResultOfMethodCallIgnored\n-    nextCache().apply(new Action<NormalizedCache>() {\n-      @Override public void apply(@NotNull NormalizedCache cache) {\n-        cache.clearAll();\n-      }\n-    });\n+    NormalizedCache nextCache = getNextCache();\n+    if (nextCache != null) {\n+      nextCache.clearAll();\n+    }\n     clearCurrentCache();\n   }\n \n   @Override public boolean remove(@NotNull final CacheKey cacheKey, final boolean cascade) {", "originalCommit": "b87ef9d8212689867548c0389eb9a6e537d335c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjA1Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407082056", "bodyText": "Do you mean the current change is suspicious or the old behavior is? This code is quite well tested.", "author": "tasomaniac", "createdAt": "2020-04-11T16:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MTUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjI3OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407082279", "bodyText": "From what I understand, return result || ... was doing the same. If the result is true, the rest will never be executed.\nOn a second look, I don't think the tests cover having a nextCache scenario", "author": "tasomaniac", "createdAt": "2020-04-11T16:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MTUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEwMTM3Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407101376", "bodyText": "I did another iteration to keep it much closer to the original implementation. Behavior wise, it should be the same but I think this will make it easier to review. Let me know if you see any issues.\nI am personally not 100% sure how should the implementation be with the nextCache involved.", "author": "tasomaniac", "createdAt": "2020-04-11T19:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MTUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNzI3NA==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407137274", "bodyText": "No sorry for the confusion, I had to mention that it's not about your changes, I meant the logic that we had before.\nThe issue is that we are removing the next chained cache (nextCache()) and if it  succeed we skip the current one as return result || deleteRecord won't call deleteRecord.\nThe reason that it's not an issue is because usually SqlNormalizedCache is the last one in the chain but implementation is definitely not correct.\nI will fix it in separate PR, let's keep it for now as is.", "author": "sav007", "createdAt": "2020-04-12T02:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MTUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjA5NQ==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407082095", "bodyText": "what is the implication on the user side, will it be required to include this compiler arg on the library consumer side as well?", "author": "sav007", "createdAt": "2020-04-11T16:21:33Z", "path": "build.gradle.kts", "diffHunk": "@@ -71,7 +71,10 @@ subprojects {\n   }\n \n   tasks.withType<KotlinCompile> {\n-    kotlinOptions.jvmTarget = JavaVersion.VERSION_1_8.toString()\n+    kotlinOptions {\n+      jvmTarget = JavaVersion.VERSION_1_8.toString()\n+      freeCompilerArgs += \"-Xopt-in=kotlin.RequiresOptIn\"", "originalCommit": "b87ef9d8212689867548c0389eb9a6e537d335c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjQ2OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407082469", "bodyText": "As far as understand, this makes it an implementation detail. Users shouldn't require anything. We can test that with snapshots after merging this one. If it is not the case, it is easy to remove this. The experimental map/set builder API is just nicer.", "author": "tasomaniac", "createdAt": "2020-04-11T16:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjA5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNzYxNw==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407137617", "bodyText": "I just want to make sure that we don't introduce extra requirements for the users to include this compilation flag on their end whenever they want to use dump().\nhttps://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-experimental-stdlib-api/\n\nBeware using the annotated API especially if you're developing a library, since your library might become binary incompatible with the future versions of the standard library.\n\nIt can cause issues in the future if they decide to change API.", "author": "sav007", "createdAt": "2020-04-12T02:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjA5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0ODQ2MA==", "url": "https://github.com/apollographql/apollo-android/pull/2151#discussion_r407148460", "bodyText": "Tbh, this is an inline function and it is not something we expose to consumers.In this particular case, it should be fine.", "author": "tasomaniac", "createdAt": "2020-04-12T05:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4MjA5NQ=="}], "type": "inlineReview"}, {"oid": "32893ca1f8f847a5bd0d0caf5f96beaa555aee0f", "url": "https://github.com/apollographql/apollo-android/commit/32893ca1f8f847a5bd0d0caf5f96beaa555aee0f", "message": "2nd iteration on remove function to keep it closer to the original implementation", "committedDate": "2020-04-11T19:24:48Z", "type": "commit"}]}