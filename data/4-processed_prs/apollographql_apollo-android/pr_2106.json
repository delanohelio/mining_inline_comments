{"pr_number": 2106, "pr_title": "Fix duplicate class generation in test folders", "pr_createdAt": "2020-03-27T20:23:00Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2106", "timeline": [{"oid": "4ee34dfdd94f7816666d336f3f564e6fefcef56b", "url": "https://github.com/apollographql/apollo-android/commit/4ee34dfdd94f7816666d336f3f564e6fefcef56b", "message": "Replace deprecated AGP function", "committedDate": "2020-03-27T20:12:01Z", "type": "commit"}, {"oid": "c80fae375159e5134fcb623570b7fe422fc5e79f", "url": "https://github.com/apollographql/apollo-android/commit/c80fae375159e5134fcb623570b7fe422fc5e79f", "message": "Modify and auto-add sourceSets only for non-test variants", "committedDate": "2020-03-27T20:22:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxOTE3OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2106#discussion_r399519179", "bodyText": "I just noticed that this is deprecated in AGP 3.6.1 and removed in 4.0", "author": "tasomaniac", "createdAt": "2020-03-27T20:23:38Z", "path": "build.gradle.kts", "diffHunk": "@@ -55,7 +55,7 @@ subprojects {\n   }\n \n   plugins.withType(com.android.build.gradle.BasePlugin::class.java) {\n-    extension.compileOptions {", "originalCommit": "c80fae375159e5134fcb623570b7fe422fc5e79f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8143fac6393946ea5ad796efd81ce81decec5f13", "url": "https://github.com/apollographql/apollo-android/commit/8143fac6393946ea5ad796efd81ce81decec5f13", "message": "Add tests to verify the fix", "committedDate": "2020-03-27T20:49:11Z", "type": "commit"}, {"oid": "3396e5f184b8701dcfe142d63460da732760ec15", "url": "https://github.com/apollographql/apollo-android/commit/3396e5f184b8701dcfe142d63460da732760ec15", "message": "Revert change in Plugin and adjust finding soources based on test sources", "committedDate": "2020-03-27T21:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NzI4OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2106#discussion_r399557289", "bodyText": "Starting from suggestions in the IDE, I ended up refactoring this to make it easier to follow. This is the only behavior change.\nI recommend reviewing this in \"split\" view.", "author": "tasomaniac", "createdAt": "2020-03-27T21:58:39Z", "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/DefaultCompilationUnit.kt", "diffHunk": "@@ -65,29 +66,38 @@ abstract class DefaultCompilationUnit @Inject constructor(\n     }\n   }\n \n-  fun setSourcesIfNeeded(graphqlSourceDirectorySet: SourceDirectorySet, schemaFile: RegularFileProperty) {\n-    if (graphqlSourceDirectorySet.srcDirs.isEmpty()) {\n-      if (schemaFile.isPresent) {\n-        graphqlSourceDirectorySet.srcDir(schemaFile.asFile.get().parent)\n-      } else {\n+  fun setSourcesIfNeeded(sourceDirectorySet: SourceDirectorySet, schemaFile: RegularFileProperty) {\n+    if (sourceDirectorySet.srcDirs.isEmpty()) {\n+      sourceDirectorySet.findSources(schemaFile)\n+    }\n+\n+    if (!schemaFile.isPresent) {\n+      schemaFile.set { resolveSchema(sourceDirectorySet) }\n+    }\n+  }\n+\n+  private fun SourceDirectorySet.findSources(schemaFile: RegularFileProperty) {\n+    when {\n+      apolloVariant.isTest -> srcDirFromVariant(apolloVariant)", "originalCommit": "3396e5f184b8701dcfe142d63460da732760ec15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec6d1e99137604777ba0cc9a249f4ef826dcb859", "url": "https://github.com/apollographql/apollo-android/commit/ec6d1e99137604777ba0cc9a249f4ef826dcb859", "message": "Do not take sourceFolder into account", "committedDate": "2020-03-27T22:46:34Z", "type": "commit"}]}