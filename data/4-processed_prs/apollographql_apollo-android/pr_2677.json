{"pr_number": 2677, "pr_title": "[Gradle Plugin] Add helpers for android and multi source sets", "pr_createdAt": "2020-10-20T13:01:48Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2677", "timeline": [{"oid": "3a1fd546875f93df5a492eb114d3ea8259e789be", "url": "https://github.com/apollographql/apollo-android/commit/3a1fd546875f93df5a492eb114d3ea8259e789be", "message": "add createAllAndroidVariantServices and createAllKotlinJvmSourceSetServices\n\nThese are long specific methods that will create multiple services for\nadvanced users that want their graphql in multiple source sets", "committedDate": "2020-10-20T12:49:21Z", "type": "commit"}, {"oid": "eab76b24dcb5c891a6358316775aa4cf7b928303", "url": "https://github.com/apollographql/apollo-android/commit/eab76b24dcb5c891a6358316775aa4cf7b928303", "message": "reorgnize tests and add tests for multiple variants/sourceSets", "committedDate": "2020-10-20T12:49:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MjY5Mg==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509062692", "bodyText": "Shouldn't we just delete this completely now?", "author": "tasomaniac", "createdAt": "2020-10-21T07:50:58Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/GraphQLCompiler.kt", "diffHunk": "@@ -45,7 +45,10 @@ class GraphQLCompiler(val logger: Logger = NoOpLogger) {\n     )\n \n     val files = args.graphqlFiles\n-    checkDuplicateFiles(roots, files)\n+    /**\n+     * Android can have duplicate files but that's ok as long as they do not define the same operations (which is checked in IRBuilder)\n+     */\n+    // checkDuplicateFiles(roots, files)", "originalCommit": "eab76b24dcb5c891a6358316775aa4cf7b928303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2ODE2Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509068167", "bodyText": "I guess I got sentimentally attached to this method \ud83d\ude02 . You're right, I'll remove it. Also it's present in the createAllAndroidVariantServices so that should be enough", "author": "martinbonnin", "createdAt": "2020-10-21T07:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MjY5Mg=="}], "type": "inlineReview"}, {"oid": "be28b2fd06a0ff097bb244c09dc78469bd510851", "url": "https://github.com/apollographql/apollo-android/commit/be28b2fd06a0ff097bb244c09dc78469bd510851", "message": "remove unused method", "committedDate": "2020-10-21T08:00:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MzU0OA==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509063548", "bodyText": "project is not used in this function. What about making this an extension over androidExtension or making androidExtension a parameter?", "author": "tasomaniac", "createdAt": "2020-10-21T07:52:19Z", "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/api/AndroidProject.kt", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.apollographql.apollo.gradle.api\n+\n+import com.android.build.gradle.AppExtension\n+import com.android.build.gradle.BaseExtension\n+import com.android.build.gradle.LibraryExtension\n+import com.android.build.gradle.TestedExtension\n+import com.android.build.gradle.api.BaseVariant\n+import com.apollographql.apollo.gradle.internal.ApolloGenerateSourcesTask\n+import org.gradle.api.Project\n+import org.gradle.api.Task\n+import org.gradle.api.file.Directory\n+import org.gradle.api.provider.Provider\n+import org.gradle.api.tasks.TaskContainer\n+import org.gradle.api.tasks.TaskProvider\n+import org.jetbrains.kotlin.gradle.tasks.KotlinCompile\n+\n+object AndroidProject {\n+  fun onEachVariant(project: Project, withTestVariants: Boolean = false, block: (BaseVariant) -> Unit) {", "originalCommit": "eab76b24dcb5c891a6358316775aa4cf7b928303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2NDYxMg==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509064612", "bodyText": "Hmm, I see now that you do a null check with a proper message. But it looks like the usages also check that.", "author": "tasomaniac", "createdAt": "2020-10-21T07:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5MDA0NA==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509990044", "bodyText": "project is not used in this function. What about making this an extension over androidExtension or making androidExtension a parameter?\n\nI like that it's somehow symmetric with KotlinJvmProject and KotlinMultiplatformProject. These helpers are now public APIs so users can use them to do all kind of crazy things if they really want to. They all take a project as a first parameter because this is what's usually available from build.gradle[.kts]\n\nHmm, I see now that you do a null check with a proper message. But it looks like the usages also check that.\n\nYup, that check is not needed, I'll remove it.", "author": "martinbonnin", "createdAt": "2020-10-22T08:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MzU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjAyMg==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509972022", "bodyText": "Can we not target 6.2 now?", "author": "tasomaniac", "createdAt": "2020-10-22T08:23:56Z", "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/DefaultService.kt", "diffHunk": "@@ -20,14 +21,22 @@ import javax.inject.Inject\n abstract class DefaultService @Inject constructor(val objects: ObjectFactory, override val name: String)\n   : Service {\n \n+  init {\n+    // see https://github.com/gradle/gradle/issues/7485\n+    // TODO replace with `convention(null)` when we can target Gradle 6.2", "originalCommit": "be28b2fd06a0ff097bb244c09dc78469bd510851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4MTE0OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509981149", "bodyText": "This was filed not so long ago: #2536\nOverall, I don't think this alone justifies bumping the Gradle version. We could do something like this:\nif (gradleVersion >= 6.2) {\n   customTypeMapping.convention(null)\n} else {\n   customTypeMapping.set(null as Map<String, String>?)\n}\n\nThis would make it possible for 6.2+ users to do something like\napollo {\n  customTypeMapping.put(\"Date\", \"java.util.Date\")\n}\n\n(in addition to the always working)\napollo {\n  customTypeMapping.set(mapOf(\"Date\" to \"java.util.Date\"))\n}", "author": "martinbonnin", "createdAt": "2020-10-22T08:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzMTMzOA==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r510431338", "bodyText": "Hmm, I was thinking because of 3.x but you're right. If we don't need it, we shouldn't.\nYour suggestion also looks like a good improvement. I didn't know that. It is up to you.", "author": "tasomaniac", "createdAt": "2020-10-22T20:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwODgxMQ==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r510508811", "bodyText": "I added it, it feels more natural to have proper .put support", "author": "martinbonnin", "createdAt": "2020-10-22T23:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjgwMw==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509972803", "bodyText": "This error is now missing a suggestion. When we fail because of multiple schemas, what should they do?", "author": "tasomaniac", "createdAt": "2020-10-22T08:25:08Z", "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/DefaultService.kt", "diffHunk": "@@ -123,16 +128,7 @@ abstract class DefaultService @Inject constructor(val objects: ObjectFactory, ov\n         \"\"\"\n Multiple schemas found:\n ${candidates.joinToString(separator = \"\\n\")}", "originalCommit": "be28b2fd06a0ff097bb244c09dc78469bd510851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk4Njk2Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r509986967", "bodyText": "The answer to this question depends whether you're using service or createAllAndroidVariantServices. It was actually wrong to suggest using multiple services before if the multiple schemas were the result of schemas being present in multiple flavor/buildType source sets. So I'd prefer a less precise error message over a wrong one.", "author": "martinbonnin", "createdAt": "2020-10-22T08:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzMjEzNg==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r510432136", "bodyText": "Can we say that multiple schema files are not supported?", "author": "tasomaniac", "createdAt": "2020-10-22T20:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwOTM4Mw==", "url": "https://github.com/apollographql/apollo-android/pull/2677#discussion_r510509383", "bodyText": "I added this: Multiple schemas are not supported. You can either define multiple services or specify the schema you want to use explicitely with schemaFile`. I think this is technically not wrong :)", "author": "martinbonnin", "createdAt": "2020-10-22T23:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MjgwMw=="}], "type": "inlineReview"}, {"oid": "56e3499889701e750b986c44e95e4c746eaba8f8", "url": "https://github.com/apollographql/apollo-android/commit/56e3499889701e750b986c44e95e4c746eaba8f8", "message": "use androidExtensionOrFail", "committedDate": "2020-10-22T13:12:31Z", "type": "commit"}, {"oid": "50b711fc4ff3d81de7781f53a330b8f412a1be8e", "url": "https://github.com/apollographql/apollo-android/commit/50b711fc4ff3d81de7781f53a330b8f412a1be8e", "message": "allow to call customTypeMapping.put", "committedDate": "2020-10-22T23:14:12Z", "type": "commit"}, {"oid": "e2212d54ede675e644b03171ba69c3a5f0f363a2", "url": "https://github.com/apollographql/apollo-android/commit/e2212d54ede675e644b03171ba69c3a5f0f363a2", "message": "add more details", "committedDate": "2020-10-22T23:16:29Z", "type": "commit"}]}