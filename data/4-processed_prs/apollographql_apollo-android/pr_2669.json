{"pr_number": 2669, "pr_title": "[bugfix] fragment code-gen respect module package.", "pr_createdAt": "2020-10-16T18:48:18Z", "pr_url": "https://github.com/apollographql/apollo-android/pull/2669", "timeline": [{"oid": "44e3f482775c588c6a38b2db60b340b36042fbe3", "url": "https://github.com/apollographql/apollo-android/commit/44e3f482775c588c6a38b2db60b340b36042fbe3", "message": "[bugfix] fragment code-gen respect module package.", "committedDate": "2020-10-16T19:43:53Z", "type": "forcePushed"}, {"oid": "02821ada0765ddf5946713a064de7228aa10c169", "url": "https://github.com/apollographql/apollo-android/commit/02821ada0765ddf5946713a064de7228aa10c169", "message": "[bugfix] fragment code-gen respect module package.", "committedDate": "2020-10-16T19:44:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4Nzg4Nw==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506687887", "bodyText": "I think this should work but would love another pair of eyes.", "author": "Laimiux", "createdAt": "2020-10-16T19:46:07Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/FragmentsResponseMapperBuilder.kt", "diffHunk": "@@ -69,7 +69,7 @@ class FragmentsResponseMapperBuilder(\n   private fun mapperFields(fragmentFields: List<ResponseFieldSpec>): List<FieldSpec> {\n     return fragmentFields.map { field ->\n       val fieldType = field.normalizedFieldSpec.type as ClassName\n-      val mapperClassName = ClassName.get(context.ir.fragmentsPackageName, fieldType.simpleName(),\n+      val mapperClassName = ClassName.get(fieldType.packageName(), fieldType.simpleName(),", "originalCommit": "02821ada0765ddf5946713a064de7228aa10c169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY5ODg0OA==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506698848", "bodyText": "Looks good to me \ud83d\udc40", "author": "martinbonnin", "createdAt": "2020-10-16T20:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4Nzg4Nw=="}], "type": "inlineReview"}, {"oid": "d042483ac9d2f4d67877854a86e0987160bf6aab", "url": "https://github.com/apollographql/apollo-android/commit/d042483ac9d2f4d67877854a86e0987160bf6aab", "message": "[bugfix] fragment code-gen respect module package.", "committedDate": "2020-10-16T19:46:39Z", "type": "commit"}, {"oid": "d042483ac9d2f4d67877854a86e0987160bf6aab", "url": "https://github.com/apollographql/apollo-android/commit/d042483ac9d2f4d67877854a86e0987160bf6aab", "message": "[bugfix] fragment code-gen respect module package.", "committedDate": "2020-10-16T19:46:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM5OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506688399", "bodyText": "I'm assuming fragmentRef and fragment are representing the same object.", "author": "Laimiux", "createdAt": "2020-10-16T19:47:17Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/SchemaTypeSpecBuilder.kt", "diffHunk": "@@ -190,7 +190,7 @@ class SchemaTypeSpecBuilder(\n             val optional = fragmentRef.isOptional()\n             val possibleTypes = fragment.takeIf { fragment.typeCondition != normalizeGraphQlType(schemaType) }?.possibleTypes ?: emptyList()\n             val fieldSpec = FieldSpec.builder(\n-                JavaTypeResolver(context = context, packageName = context.ir.fragmentsPackageName)\n+                JavaTypeResolver(context = context, packageName = fragment.packageName)", "originalCommit": "d042483ac9d2f4d67877854a86e0987160bf6aab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM1MQ==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506688351", "bodyText": "A few comments:\n\nWhat about dropping the \".fragment\" here? It made sense as long as all fragments ended up in the same package but if we start using the file package name instead, it might be confusing to append \".fragment\nSince fragments are not operations, we might want to rename operationPackageName to filePackageName\nIt's ok to change this behaviour for experimental multi-module things but not for the stable non-multi-module users so this will have to be configurable somewhere.", "author": "martinbonnin", "createdAt": "2020-10-16T19:47:09Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/parser/graphql/GraphQLDocumentParser.kt", "diffHunk": "@@ -531,7 +531,8 @@ class GraphQLDocumentParser(\n             fragmentRefs = fragmentRefs.union(mergeInlineFragmentRefs).toList(),\n             inlineFragments = inlineFragments.result.filter { it.typeCondition != typeCondition },\n             filePath = graphQLFilePath,\n-            sourceLocation = SourceLocation(start)\n+            sourceLocation = SourceLocation(start),\n+            packageName = \"${packageNameProvider.operationPackageName(graphQLFilePath)}.fragment\".removePrefix(\".\")", "originalCommit": "d042483ac9d2f4d67877854a86e0987160bf6aab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY5MTY0OQ==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506691649", "bodyText": "Thanks for the feedback:\n\nI'm for dropping the fragment package suffix.\nMakes sense, however, if we want to make this behavior configurable, maybe having a separate fragmentPackageName() function that encapsulates this logical fork?\nDo you have a suggestion for a flag name?", "author": "Laimiux", "createdAt": "2020-10-16T19:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY5NzY3NA==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506697674", "bodyText": "I'm for dropping the fragment package suffix.\n\n\ud83d\udc4d\n\nDo you have a suggestion for a flag name?\n\nMaybe something like:\napollo {\n  // Use the path to the file that defined the fragment as package name\n  // i.e. com/example/Fragment.graphql will end up in `com.example` package instead of a global `*.fragment` package\n  useFilePackageNameForFragments.set(true)\n}\n\n\nmaybe having a separate fragmentPackageName() function that encapsulates this logical fork?\n\nYup, that works too", "author": "martinbonnin", "createdAt": "2020-10-16T20:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4ODM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwMDgwMg==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506700802", "bodyText": "Can you add packageName: String? to ObjectType instead? It doesn't really make sense to have an AST type named \"Fragment\" as Kotlin doesn't know anything about a Fragment.", "author": "martinbonnin", "createdAt": "2020-10-16T20:16:32Z", "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/ast/AST.kt", "diffHunk": "@@ -92,6 +92,11 @@ internal data class ObjectType(\n   }\n }\n \n+internal class FragmentType(\n+    val objectType: ObjectType,\n+    val packageName: String\n+)", "originalCommit": "d042483ac9d2f4d67877854a86e0987160bf6aab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwNzQzMA==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506707430", "bodyText": "Mmm but there's also an OperationType too so maybe it doesn't matter that much. @sav007 any opinion about this ?", "author": "martinbonnin", "createdAt": "2020-10-16T20:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwMDgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMzg2Ng==", "url": "https://github.com/apollographql/apollo-android/pull/2669#discussion_r506713866", "bodyText": "I think your point that it doesn't map to a Kotlin concept is valid. The reason I didn't place it on the ObjectType is that ObjectType is also used as an intermediary object in a couple of places so it feels like it is breaking this principle already. I used a separate type to more closely tie package name to class generation logic which allows the type system to ensure that packageName is provided. Let me know if you want me to change that, not a big deal to me just wanted to explain my position.", "author": "Laimiux", "createdAt": "2020-10-16T20:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwMDgwMg=="}], "type": "inlineReview"}, {"oid": "2e0d8d65c532ab40807eac2b4190b3f485a45e8f", "url": "https://github.com/apollographql/apollo-android/commit/2e0d8d65c532ab40807eac2b4190b3f485a45e8f", "message": "PR feedback.", "committedDate": "2020-10-16T20:35:49Z", "type": "commit"}, {"oid": "275a74e61ca96e99f5461c1d8bcf5dd8c1a3dc34", "url": "https://github.com/apollographql/apollo-android/commit/275a74e61ca96e99f5461c1d8bcf5dd8c1a3dc34", "message": "Fix test compilation + new fixtures.", "committedDate": "2020-10-16T21:01:49Z", "type": "commit"}, {"oid": "275a74e61ca96e99f5461c1d8bcf5dd8c1a3dc34", "url": "https://github.com/apollographql/apollo-android/commit/275a74e61ca96e99f5461c1d8bcf5dd8c1a3dc34", "message": "Fix test compilation + new fixtures.", "committedDate": "2020-10-16T21:01:49Z", "type": "forcePushed"}, {"oid": "0ca4aae49d4bac4a4ca4f91f18443ee3516242cc", "url": "https://github.com/apollographql/apollo-android/commit/0ca4aae49d4bac4a4ca4f91f18443ee3516242cc", "message": "Fixing missing compiler flag.", "committedDate": "2020-10-16T21:54:48Z", "type": "commit"}, {"oid": "0ca4aae49d4bac4a4ca4f91f18443ee3516242cc", "url": "https://github.com/apollographql/apollo-android/commit/0ca4aae49d4bac4a4ca4f91f18443ee3516242cc", "message": "Fixing missing compiler flag.", "committedDate": "2020-10-16T21:54:48Z", "type": "forcePushed"}, {"oid": "114dc70256f99b461344f8b1cd726b0215c058d0", "url": "https://github.com/apollographql/apollo-android/commit/114dc70256f99b461344f8b1cd726b0215c058d0", "message": "update metalava", "committedDate": "2020-10-17T14:27:55Z", "type": "commit"}, {"oid": "c2ead39b3f2478f2b3021db96be4a92defce0320", "url": "https://github.com/apollographql/apollo-android/commit/c2ead39b3f2478f2b3021db96be4a92defce0320", "message": "Adding a new code-gen test.", "committedDate": "2020-10-20T21:18:09Z", "type": "commit"}, {"oid": "d99c5c92752e9c6673854cbe032ae4e52ce660fb", "url": "https://github.com/apollographql/apollo-android/commit/d99c5c92752e9c6673854cbe032ae4e52ce660fb", "message": "replace `useFilePackageNameForFragments` with plain `packageName`\n\npackageName not take into account the folder hiearchy and puts\neverything under the flat `packageName` directory\n\nThis is not working for input/enum/scalars yet", "committedDate": "2020-10-28T10:53:48Z", "type": "commit"}, {"oid": "6978db3e67f1e50460ce5d463d290e3a59052bfa", "url": "https://github.com/apollographql/apollo-android/commit/6978db3e67f1e50460ce5d463d290e3a59052bfa", "message": "fix tests", "committedDate": "2020-10-28T11:13:21Z", "type": "commit"}, {"oid": "611e1dda7ae25c121aa4fdf71ec70177637ca502", "url": "https://github.com/apollographql/apollo-android/commit/611e1dda7ae25c121aa4fdf71ec70177637ca502", "message": "fix java test fixtures", "committedDate": "2020-10-28T11:21:33Z", "type": "commit"}, {"oid": "589ac75c2912b531c850513b1759b9bfacfefbfe", "url": "https://github.com/apollographql/apollo-android/commit/589ac75c2912b531c850513b1759b9bfacfefbfe", "message": "fix metalava", "committedDate": "2020-10-28T13:55:49Z", "type": "commit"}]}