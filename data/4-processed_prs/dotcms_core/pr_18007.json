{"pr_number": 18007, "pr_title": "Issue 17992 autoassign dotasset", "pr_createdAt": "2020-02-18T22:40:16Z", "pr_url": "https://github.com/dotCMS/core/pull/18007", "timeline": [{"oid": "724b85ea0cde42eb69b1bf9c83dae4ce0e4d7f91", "url": "https://github.com/dotCMS/core/commit/724b85ea0cde42eb69b1bf9c83dae4ce0e4d7f91", "message": "#16565 first draft of the dotAsset content type", "committedDate": "2020-02-03T22:08:20Z", "type": "commit"}, {"oid": "35bf0c8598b0e5ab80a3253abb4a8e70787d8831", "url": "https://github.com/dotCMS/core/commit/35bf0c8598b0e5ab80a3253abb4a8e70787d8831", "message": "#16565 now the tags is also removable", "committedDate": "2020-02-04T04:03:17Z", "type": "commit"}, {"oid": "25a59cd4e90a6d1ebbd572786f03decc3a27ae0e", "url": "https://github.com/dotCMS/core/commit/25a59cd4e90a6d1ebbd572786f03decc3a27ae0e", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-16565-dotasset", "committedDate": "2020-02-04T16:05:07Z", "type": "commit"}, {"oid": "0c9132235406d651988806a2ea172401ef122d18", "url": "https://github.com/dotCMS/core/commit/0c9132235406d651988806a2ea172401ef122d18", "message": "#16565 changes after review", "committedDate": "2020-02-04T18:44:31Z", "type": "commit"}, {"oid": "b44e82b28a25f517544f115beb578dd203c7e6cd", "url": "https://github.com/dotCMS/core/commit/b44e82b28a25f517544f115beb578dd203c7e6cd", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-16565-dotasset", "committedDate": "2020-02-12T15:58:24Z", "type": "commit"}, {"oid": "5760b938cfc980c6e144ca6afb68828dc94511dd", "url": "https://github.com/dotCMS/core/commit/5760b938cfc980c6e144ca6afb68828dc94511dd", "message": "#16565 added a new base type and content type dotAsset", "committedDate": "2020-02-12T22:34:53Z", "type": "commit"}, {"oid": "a62dea4ca7e0308489f4f48e198e7324de299474", "url": "https://github.com/dotCMS/core/commit/a62dea4ca7e0308489f4f48e198e7324de299474", "message": "#16565 adding the support for the graphql", "committedDate": "2020-02-12T22:50:17Z", "type": "commit"}, {"oid": "ac3405b6a30cf3c65aa42781579a50e15271ef22", "url": "https://github.com/dotCMS/core/commit/ac3405b6a30cf3c65aa42781579a50e15271ef22", "message": "#16565 added codacy feedback", "committedDate": "2020-02-13T16:04:03Z", "type": "commit"}, {"oid": "a3ae160091a2fc5780071d873f53f4ee760f6c20", "url": "https://github.com/dotCMS/core/commit/a3ae160091a2fc5780071d873f53f4ee760f6c20", "message": "#16565 adding unit test", "committedDate": "2020-02-13T22:25:24Z", "type": "commit"}, {"oid": "25e9cd54e28c8017da39ec7b57d22361b4800c44", "url": "https://github.com/dotCMS/core/commit/25e9cd54e28c8017da39ec7b57d22361b4800c44", "message": "#17992 added second draft for the mime type discovery", "committedDate": "2020-02-18T22:39:29Z", "type": "commit"}, {"oid": "7e8f9b05199c7f626c1f56893b4eea1d3175f431", "url": "https://github.com/dotCMS/core/commit/7e8f9b05199c7f626c1f56893b4eea1d3175f431", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-17992-autoassign-dotasset", "committedDate": "2020-02-18T22:42:53Z", "type": "commit"}, {"oid": "160320844391e4f241062215c5db3825faa5c623", "url": "https://github.com/dotCMS/core/commit/160320844391e4f241062215c5db3825faa5c623", "message": "#17992 added a logic on the workflow resource and the checkin contentlet api", "committedDate": "2020-02-20T04:04:05Z", "type": "commit"}, {"oid": "8159860f79cd635edb30f6b8fa318407308f09f5", "url": "https://github.com/dotCMS/core/commit/8159860f79cd635edb30f6b8fa318407308f09f5", "message": "#17992 fixes minor changes and curl tests", "committedDate": "2020-02-20T20:11:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NzMyOQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382247329", "bodyText": "Use the un-repackaged version.", "author": "wezell", "createdAt": "2020-02-20T20:44:55Z", "path": "dotCMS/src/integration-test/java/com/dotcms/contenttype/test/ContentTypeAPIImplTest.java", "diffHunk": "@@ -57,6 +51,7 @@\n import com.dotcms.datagen.SiteDataGen;\n import com.dotcms.datagen.TestDataUtils;\n import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.repackage.org.xhtmlrenderer.util.IOUtil;", "originalCommit": "8159860f79cd635edb30f6b8fa318407308f09f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0ODk2Mw==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382248963", "bodyText": "Maybe we need a contentlet.getBaseType() method that looks up against the contentType if set or the map if not?", "author": "wezell", "createdAt": "2020-02-20T20:48:35Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -4113,6 +4122,40 @@ private Contentlet checkin(final Contentlet contentletIn, final ContentletRelati\n         }\n     }\n \n+    /*\n+     * If the contentletIn is new, has not any content type assigned and has a base type set into the properties\n+     * will try to figure out a match for the content type\n+     */\n+    private void checkOrSetContentType(final Contentlet contentletIn, final User user) {\n+\n+        if (contentletIn.isNew() && null == contentletIn.getContentType() &&\n+                contentletIn.getMap().containsKey(Contentlet.BASE_TYPE_KEY)) {", "originalCommit": "8159860f79cd635edb30f6b8fa318407308f09f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1NTMyOQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382255329", "bodyText": "If this is to be our MimeTypeUtils, please add a convenience method that calls our FileAssetAPI.getMimeType() or move that here and call it from the FileAssetAPIImpl", "author": "wezell", "createdAt": "2020-02-20T20:59:41Z", "path": "dotCMS/src/main/java/com/dotcms/util/MimeTypeUtils.java", "diffHunk": "@@ -41,4 +44,20 @@ public static String getMimeType (final File binary) {\n \n         return mimeType;\n     }\n+\n+    /**\n+     * See if one mime type1 match into another\n+     * @param mimeType1 String\n+     * @param mimeType2 String\n+     * @return boolean\n+     */\n+    public static boolean match (final String mimeType1, final String mimeType2) {\n+\n+        if (ACCEPT_ALL.equals(mimeType1)) {\n+            return true;\n+        }\n+        final MimeType mimeTypeObj1 = Sneaky.sneak(() -> new MimeType(mimeType1));\n+        final MimeType mimeTypeObj2 = Sneaky.sneak(() -> new MimeType(mimeType2));\n+        return mimeTypeObj1.match(mimeTypeObj2);\n+    }", "originalCommit": "8159860f79cd635edb30f6b8fa318407308f09f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c007d23b3399cd3444dc59ff2a3c4d52ca92ec1", "url": "https://github.com/dotCMS/core/commit/3c007d23b3399cd3444dc59ff2a3c4d52ca92ec1", "message": "#17922 adding feedback", "committedDate": "2020-02-21T16:31:02Z", "type": "commit"}, {"oid": "893e4a83da4eca1c67411adb2fa1b4a7b1c2d19c", "url": "https://github.com/dotCMS/core/commit/893e4a83da4eca1c67411adb2fa1b4a7b1c2d19c", "message": "#17922 adding feedback 2", "committedDate": "2020-02-21T16:38:01Z", "type": "commit"}, {"oid": "4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "url": "https://github.com/dotCMS/core/commit/4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "message": "#17992 merge master done", "committedDate": "2020-02-21T16:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5Mzg2OQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382693869", "bodyText": "Maybe another test with the fail scenario?", "author": "erickgonzalez", "createdAt": "2020-02-21T16:55:45Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/business/ContentletAPITest.java", "diffHunk": "@@ -149,6 +150,45 @@\n @RunWith(DataProviderRunner.class)\n public class ContentletAPITest extends ContentletBaseTest {\n \n+    @Test", "originalCommit": "4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5NTAyOQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382695029", "bodyText": "tests for the API?", "author": "erickgonzalez", "createdAt": "2020-02-21T16:57:41Z", "path": "dotCMS/src/main/java/com/dotcms/contenttype/business/DotAssetAPI.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.dotcms.contenttype.business;\n+\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.liferay.portal.model.User;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+/**\n+ * API to handle the @{@link com.dotcms.contenttype.model.type.DotAssetContentType}\n+ * @author jsanca\n+ */\n+public interface DotAssetAPI {", "originalCommit": "4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5NTQ0OQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382695449", "bodyText": "I think you should validate that dotAssetContentlet has an inode and an identifier because you are testing the checkin method", "author": "nollymar", "createdAt": "2020-02-21T16:58:32Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/contentlet/business/ContentletAPITest.java", "diffHunk": "@@ -149,6 +150,45 @@\n @RunWith(DataProviderRunner.class)\n public class ContentletAPITest extends ContentletBaseTest {\n \n+    @Test\n+    public void testDotAsset_Checkin () throws DotDataException, DotSecurityException, IOException {\n+\n+        // 1) creates a dotasset for test\n+        final String variable = \"testDotAsset\" + System.currentTimeMillis();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+        ContentType dotAssetContentType     = contentTypeAPI\n+                .save(ContentTypeBuilder.builder(DotAssetContentType.class).folder(FolderAPI.SYSTEM_FOLDER)\n+                .host(Host.SYSTEM_HOST).name(variable)\n+                .owner(user.getUserId()).build());\n+        final Map<String, com.dotcms.contenttype.model.field.Field> fieldMap = dotAssetContentType.fieldMap();\n+        com.dotcms.contenttype.model.field.Field binaryField           = fieldMap.get(DotAssetContentType.ASSET_FIELD_VAR);\n+        final FieldVariable allowFileTypes = ImmutableFieldVariable.builder().key(BinaryField.ALLOWED_FILE_TYPES)\n+                .value(\"application/*, text/*\").fieldId(binaryField.id()).build();\n+        binaryField.constructFieldVariables(Arrays.asList(allowFileTypes));\n+\n+        dotAssetContentType = contentTypeAPI.save(dotAssetContentType);\n+        binaryField = fieldAPI.save(binaryField, user);\n+        fieldAPI.save(allowFileTypes, user);\n+\n+        final File tempTestFile = File\n+                .createTempFile(\"fileTest_\" + new Date().getTime(), \".txt\");\n+        FileUtils.writeStringToFile(tempTestFile, \"Test hi this a test longer than ten characters\");\n+\n+        Contentlet dotAssetContentlet = new Contentlet();\n+        dotAssetContentlet.setLanguageId(languageAPI.getDefaultLanguage().getId());\n+        dotAssetContentlet.setModUser(user.getUserId());\n+        dotAssetContentlet.setHost(APILocator.systemHost().getIdentifier());\n+        dotAssetContentlet.setStringProperty(Contentlet.BASE_TYPE_KEY, BaseContentType.DOTASSET.getAlternateName());\n+        dotAssetContentlet.setBinary(binaryField, tempTestFile);\n+        dotAssetContentlet.setIndexPolicy(IndexPolicy.FORCE);\n+        dotAssetContentlet.setIndexPolicyDependencies(IndexPolicy.FORCE);\n+        dotAssetContentlet = contentletAPI.checkin(dotAssetContentlet, user, false);\n+\n+        assertNotNull(dotAssetContentlet);", "originalCommit": "4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5ODYwOQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r382698609", "bodyText": "I think this return here is redundant as there is a return Optional.empty() at the end of the method. Besides, it might be worth to a log at least of debug level", "author": "nollymar", "createdAt": "2020-02-21T17:04:43Z", "path": "dotCMS/src/main/java/com/dotcms/contenttype/business/BaseTypeToContentTypeStrategyResolver.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package com.dotcms.contenttype.business;\n+\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.DotAssetContentType;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.google.common.collect.ImmutableMap;\n+import com.liferay.portal.model.User;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Subscribe Strategies to resolve from base types a content type\n+ * and get the strategy for a set of arguments if applies\n+ * @author jsanca\n+ */\n+public class BaseTypeToContentTypeStrategyResolver {\n+\n+    private volatile Map<BaseContentType, BaseTypeToContentTypeStrategy> strategiesMap = this.getDefaultStrategies();\n+\n+    private  Map<BaseContentType, BaseTypeToContentTypeStrategy> getDefaultStrategies() {\n+\n+        final ImmutableMap.Builder<BaseContentType, BaseTypeToContentTypeStrategy> builder =\n+                new ImmutableMap.Builder<>();\n+\n+        builder.put(BaseContentType.DOTASSET, new DotAssetBaseTypeToContentTypeStrategyImpl());\n+\n+        return builder.build();\n+    }\n+\n+\n+    public synchronized void subscribe (final BaseContentType baseContentType, final BaseTypeToContentTypeStrategy strategy) {\n+\n+        if (null != baseContentType && null != strategy) {\n+\n+            final ImmutableMap.Builder<BaseContentType, BaseTypeToContentTypeStrategy> builder =\n+                    new ImmutableMap.Builder<>();\n+\n+            builder.putAll(this.strategiesMap);\n+            builder.put(BaseContentType.DOTASSET, strategy);\n+\n+            this.strategiesMap = builder.build();\n+        }\n+    }\n+\n+\n+    private static class SingletonHolder {\n+        private static final BaseTypeToContentTypeStrategyResolver INSTANCE = new BaseTypeToContentTypeStrategyResolver();\n+    }\n+\n+    /**\n+     * Get the instance.\n+     * @return BaseTypeToContentTypeStrategyResolver\n+     */\n+    public static BaseTypeToContentTypeStrategyResolver getInstance() {\n+\n+        return BaseTypeToContentTypeStrategyResolver.SingletonHolder.INSTANCE;\n+    } // getInstance.\n+\n+\n+    /**\n+     * Get a strategy if applies\n+     * @param baseContentType {@link BaseContentType}\n+     * @return Optional BaseTypeToContentTypeStrategy\n+     */\n+    public Optional<BaseTypeToContentTypeStrategy> get(final BaseContentType baseContentType) {\n+\n+        return this.strategiesMap.containsKey(baseContentType)?\n+                Optional.of(this.strategiesMap.get(baseContentType)):\n+                Optional.empty();\n+    }\n+    /////////////\n+    private class DotAssetBaseTypeToContentTypeStrategyImpl  implements BaseTypeToContentTypeStrategy {\n+\n+        @Override\n+        public Optional<ContentType> apply(final BaseContentType baseContentType, final Map<String, Object> contextMap) {\n+\n+            final User user = (User)contextMap.get(\"user\");\n+            final Host currentHost = (Host)contextMap.get(\"host\");\n+            final List<File> binaryFiles = (List<File>) contextMap.getOrDefault(\"binaryFiles\", Collections.emptyList());\n+            final Map<String, Object> contentletMap = (Map<String, Object>) contextMap.get(\"contentletMap\");\n+\n+            final File file = this.getBinary(binaryFiles, contentletMap);\n+            if (null != file && file.exists() && file.canRead()) {\n+\n+                try {\n+\n+                    return APILocator.getDotAssetAPI().tryMatch(file, currentHost, user);\n+                } catch (DotDataException | DotSecurityException e) {\n+                    return Optional.empty();", "originalCommit": "4539cd0cf51ee411fbd3593668f0f0a7de9a8eef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9760343fd70a1378b279742919f646bc683097bc", "url": "https://github.com/dotCMS/core/commit/9760343fd70a1378b279742919f646bc683097bc", "message": "#17992 adding unit test", "committedDate": "2020-02-24T16:28:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3NzkzNg==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383377936", "bodyText": "Issue found: The String literal \"image/png\" appears 6 times in this file; the first occurrence is on line 55", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:44Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"text/plain\");\n+\n+        Assert.assertTrue(\"* must match with text/plain\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_image() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"image/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"image/* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/webp\");\n+\n+        Assert.assertTrue(\"image/* must match with image/webp\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/png\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3Nzk1NA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383377954", "bodyText": "Issue found: The String literal \"/\" appears 4 times in this file; the first occurrence is on line 32", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:46Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3Nzk2OA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383377968", "bodyText": "Issue found: Use block level rather than method level synchronization", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:47Z", "path": "dotCMS/src/main/java/com/dotcms/contenttype/business/BaseTypeToContentTypeStrategyResolver.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package com.dotcms.contenttype.business;\n+\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.DotAssetContentType;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.google.common.collect.ImmutableMap;\n+import com.liferay.portal.model.User;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Subscribe Strategies to resolve from base types a content type\n+ * and get the strategy for a set of arguments if applies\n+ * @author jsanca\n+ */\n+public class BaseTypeToContentTypeStrategyResolver {\n+\n+    private volatile Map<BaseContentType, BaseTypeToContentTypeStrategy> strategiesMap = this.getDefaultStrategies();\n+\n+    private  Map<BaseContentType, BaseTypeToContentTypeStrategy> getDefaultStrategies() {\n+\n+        final ImmutableMap.Builder<BaseContentType, BaseTypeToContentTypeStrategy> builder =\n+                new ImmutableMap.Builder<>();\n+\n+        builder.put(BaseContentType.DOTASSET, new DotAssetBaseTypeToContentTypeStrategyImpl());\n+\n+        return builder.build();\n+    }\n+\n+\n+    public synchronized void subscribe (final BaseContentType baseContentType, final BaseTypeToContentTypeStrategy strategy) {", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3Nzk3OQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383377979", "bodyText": "Issue found: Unnecessary modifier 'public' on method 'getMimeType': the method is declared in an interface type", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:48Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPI.java", "diffHunk": "@@ -322,8 +322,23 @@\n      */\n     public void cleanThumbnailsFromFileAsset(IFileAsset fileAsset);\n \n+\t/**\n+\t * Tries to determine the mime type from a since file path, @{@link FileAsset#UNKNOWN_MIME_TYPE} if not found\n+\t * For a more powerful but also more expensive version see {@link #getMimeType(File)}\n+\t * @param filename {@link String}\n+\t * @return String mime type\n+\t */\n \tpublic String getMimeType (String filename);\n \n+\t/**\n+\t * Tries to determine the mime type from a binary,  @{@link FileAsset#UNKNOWN_MIME_TYPE} if not found\n+\t * This is a more poweful and also more expensive version of {@link #getMimeType(String)}\n+\t * since it uses more methods to figure out/fallbacks the mime type\n+\t * @param binary {@link File}\n+\t * @return String\n+\t */\n+\tpublic String getMimeType (final File binary);", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3Nzk5NA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383377994", "bodyText": "Issue found: The String literal \"application/*\" appears 4 times in this file; the first occurrence is on line 67", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:49Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"text/plain\");\n+\n+        Assert.assertTrue(\"* must match with text/plain\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_image() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"image/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"image/* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/webp\");\n+\n+        Assert.assertTrue(\"image/* must match with image/webp\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/png\");\n+\n+        Assert.assertTrue(\"image/* must match with image/png\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"application/vnd.hzn-3d-crossword\");\n+\n+        Assert.assertFalse(\"image/* must not match with application/vnd.hzn-3d-crossword\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_application() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"application/*\", \"application/vnd.hzn-3d-crossword\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODAwOQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378009", "bodyText": "Issue found: The String literal \"text/*\" appears 4 times in this file; the first occurrence is on line 87", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:51Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"text/plain\");\n+\n+        Assert.assertTrue(\"* must match with text/plain\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_image() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"image/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"image/* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/webp\");\n+\n+        Assert.assertTrue(\"image/* must match with image/webp\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/png\");\n+\n+        Assert.assertTrue(\"image/* must match with image/png\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"application/vnd.hzn-3d-crossword\");\n+\n+        Assert.assertFalse(\"image/* must not match with application/vnd.hzn-3d-crossword\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_application() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"application/*\", \"application/vnd.hzn-3d-crossword\");\n+\n+        Assert.assertTrue(\"application/* must match with application/vnd.hzn-3d-crossword\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"application/x-7z-compressed\");\n+\n+        Assert.assertTrue(\"application/* must match with application/x-7z-compressed\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"application/* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"image/png\");\n+\n+        Assert.assertFalse(\"application/* must not match with image/png\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_text() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"text/*\", \"text/x-asm\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODAyNA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378024", "bodyText": "Issue found: Avoid using implementation types like 'LinkedHashSet'; use the interface instead", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:52Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/workflow/WorkflowResource.java", "diffHunk": "@@ -1779,11 +1779,17 @@ private void validateMultiPartContent (final Map<String, Object> contentMap,\n         return binaryFields.size() <= binaryFileSize? binaryFields: binaryFields.subList(0, binaryFields.size());\n     }\n \n+    private String getContentTypeInode (final Map<String, Object> contentMap, final User user, final List<File> binaryFiles) {\n+\n+        this.contentHelper.checkOrSetContentType(contentMap, user, binaryFiles);\n+        return MapToContentletPopulator.INSTANCE.getContentTypeInode(contentMap);\n+    }\n+\n     private void processFiles(final Map<String, Object> contentMap, final List<File> binaryFiles,\n-                              final LinkedHashSet<String> argBinaryFields) throws DotDataException, DotSecurityException {\n+                              final LinkedHashSet<String> argBinaryFields, final User user) throws DotDataException, DotSecurityException {", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODAzNg==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378036", "bodyText": "Issue found: Unnecessary use of fully qualified name 'com.dotcms.contenttype.model.field.Field' due to existing import 'com.dotcms.contenttype.model.field.Field'", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:54Z", "path": "dotCMS/src/integration-test/java/com/dotcms/contenttype/test/DotAssetAPITest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.dotcms.contenttype.test;\n+\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.business.FieldAPI;\n+import com.dotcms.contenttype.model.field.BinaryField;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldVariable;\n+import com.dotcms.contenttype.model.field.ImmutableFieldVariable;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.model.type.DotAssetContentType;\n+import com.dotcms.repackage.org.apache.commons.io.FileUtils;\n+import com.dotcms.util.ConfigTestHelper;\n+import com.dotcms.util.TestMediaCreator;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import io.vavr.Tuple;\n+import io.vavr.Tuple2;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class DotAssetAPITest extends ContentTypeBaseTest  {\n+\n+    @Test\n+    public void test_try_match () throws Exception {\n+\n+        final Host host = APILocator.systemHost();\n+        final Tuple2<Field, ContentType> fieldDotVideoAssetContentType = this.createDotAssetContentType(host,\n+                \"video/*\", \"videoDotAsset\" + System.currentTimeMillis());\n+\n+        final Tuple2<Field, ContentType> fieldDotTextAssetContentType = this.createDotAssetContentType(host,\n+                \"text/*\", \"textDotAsset\" + System.currentTimeMillis());\n+\n+        final Tuple2<Field, ContentType> fieldDotimageAssetContentType = this.createDotAssetContentType(host,\n+                \"image/*\", \"imageDotAsset\" + System.currentTimeMillis());\n+\n+        final File tempTestFile = File\n+                .createTempFile(\"fileTest_\" + new Date().getTime(), \".txt\");\n+        FileUtils.writeStringToFile(tempTestFile, \"Test hi this a test longer than ten characters\");\n+\n+        Optional<ContentType> contentTypeOpt = Optional.empty();\n+\n+        final File tempMovieTestFile = new File(ConfigTestHelper.getPathToTestResource(\"images/testmovie.mov\"));\n+        contentTypeOpt = APILocator.getDotAssetAPI().tryMatch(\n+                tempMovieTestFile, host, APILocator.systemUser());\n+\n+        assertTrue(contentTypeOpt.isPresent());\n+        assertEquals(fieldDotVideoAssetContentType._2().variable(), contentTypeOpt.get().variable());\n+\n+        contentTypeOpt = APILocator.getDotAssetAPI().tryMatch(\n+                tempTestFile, host, APILocator.systemUser());\n+\n+        assertTrue(contentTypeOpt.isPresent());\n+        assertEquals(fieldDotTextAssetContentType._2().variable(), contentTypeOpt.get().variable());\n+\n+        final File tempImageTestFile = TestMediaCreator.createPNG();\n+        contentTypeOpt = APILocator.getDotAssetAPI().tryMatch(\n+                tempImageTestFile, host, APILocator.systemUser());\n+\n+        assertTrue(contentTypeOpt.isPresent());\n+        assertEquals(fieldDotimageAssetContentType._2().variable(), contentTypeOpt.get().variable());\n+\n+        final File tempImageTestFile2 = TestMediaCreator.createJPEG();\n+        contentTypeOpt = APILocator.getDotAssetAPI().tryMatch(\n+                tempImageTestFile2, host, APILocator.systemUser());\n+\n+        assertTrue(contentTypeOpt.isPresent());\n+        assertEquals(fieldDotimageAssetContentType._2().variable(), contentTypeOpt.get().variable());\n+\n+    }\n+\n+    private Tuple2<Field, ContentType> createDotAssetContentType (final Host host, final String accept, final String variable) throws DotSecurityException, DotDataException {\n+\n+        final FieldAPI fieldAPI = APILocator.getContentTypeFieldAPI();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+        ContentType dotAssetContentType     = contentTypeAPI\n+                .save(ContentTypeBuilder.builder(DotAssetContentType.class).folder(FolderAPI.SYSTEM_FOLDER)\n+                        .host(host.getIdentifier()).name(variable)\n+                        .owner(user.getUserId()).build());\n+        final Map<String, Field> fieldMap = dotAssetContentType.fieldMap();\n+        com.dotcms.contenttype.model.field.Field binaryField           = fieldMap.get(DotAssetContentType.ASSET_FIELD_VAR);", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODA0OA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378048", "bodyText": "Issue found: The String literal \"text/csv\" appears 4 times in this file; the first occurrence is on line 95", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:55Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"text/plain\");\n+\n+        Assert.assertTrue(\"* must match with text/plain\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_image() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"image/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"image/* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/webp\");\n+\n+        Assert.assertTrue(\"image/* must match with image/webp\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"image/png\");\n+\n+        Assert.assertTrue(\"image/* must match with image/png\", match);\n+\n+        match = MimeTypeUtils.match(\"image/*\", \"application/vnd.hzn-3d-crossword\");\n+\n+        Assert.assertFalse(\"image/* must not match with application/vnd.hzn-3d-crossword\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_application() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"application/*\", \"application/vnd.hzn-3d-crossword\");\n+\n+        Assert.assertTrue(\"application/* must match with application/vnd.hzn-3d-crossword\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"application/x-7z-compressed\");\n+\n+        Assert.assertTrue(\"application/* must match with application/x-7z-compressed\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"application/* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"application/*\", \"image/png\");\n+\n+        Assert.assertFalse(\"application/* must not match with image/png\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_text() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"text/*\", \"text/x-asm\");\n+\n+        Assert.assertTrue(\"text/* must match with text/x-asm\", match);\n+\n+        match = MimeTypeUtils.match(\"text/*\", \"text/css\");\n+\n+        Assert.assertTrue(\"text/* must match with text/css\", match);\n+\n+        match = MimeTypeUtils.match(\"text/*\", \"text/csv\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODA2MQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378061", "bodyText": "Issue found: The String literal \"image/*\" appears 4 times in this file; the first occurrence is on line 47", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:56Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/MimeTypeUtilsTest.java", "diffHunk": "@@ -25,6 +26,122 @@ public static void prepare() throws Exception {\n         IntegrationTestInitService.getInstance().init();\n     }\n \n+    @Test\n+    public void test_match_MimeType_all() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"*/*\", \"image/jpeg\");\n+\n+        Assert.assertTrue(\"* must match with image/jpeg\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"application/pdf\");\n+\n+        Assert.assertTrue(\"* must match with application/pdf\", match);\n+\n+        match = MimeTypeUtils.match(\"*/*\", \"text/plain\");\n+\n+        Assert.assertTrue(\"* must match with text/plain\", match);\n+    }\n+\n+    @Test\n+    public void test_match_MimeType_partial_image() throws IOException {\n+\n+        boolean match = MimeTypeUtils.match(\"image/*\", \"image/jpeg\");", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODA3NA==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378074", "bodyText": "Issue found: The user-supplied array 'mimeTypeFieldVariables' is stored directly.", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:57Z", "path": "dotCMS/src/main/java/com/dotcms/contenttype/business/DotAssetAPIImpl.java", "diffHunk": "@@ -0,0 +1,146 @@\n+package com.dotcms.contenttype.business;\n+\n+import com.dotcms.contenttype.model.field.BinaryField;\n+import com.dotcms.contenttype.model.field.Field;\n+import com.dotcms.contenttype.model.field.FieldVariable;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.contenttype.model.type.DotAssetContentType;\n+import com.dotcms.util.MimeTypeUtils;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.util.UtilMethods;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Default implementation\n+ * @author jsanca\n+ */\n+public class DotAssetAPIImpl implements DotAssetAPI {\n+\n+    @Override\n+    public Optional<ContentType> tryMatch(final File file,final  Host currentHost,final  User user) throws DotDataException, DotSecurityException {\n+\n+        return this.tryMatch(APILocator.getFileAssetAPI().getMimeType(file), currentHost, user);\n+    }\n+\n+    @Override\n+    public Optional<ContentType> tryMatch(final String mimeType, final Host currentHost, final User user) throws DotSecurityException, DotDataException {\n+\n+        final List<ContentType> dotAssetContentTypes = APILocator.getContentTypeAPI(user).findByType(BaseContentType.DOTASSET);\n+\n+        if (UtilMethods.isSet(dotAssetContentTypes)) {\n+\n+            // Stores the content type indexed by mimetypes, on each index stores the subsets\n+            // 0:Exact/on Site, 1:Exact/SYSTEM_HOST, 2:Partial Wildcard/on Site, 3:Partial Wildcard/SYSTEM_HOST,\n+            // 4:Total Wildcard (or null)/on Site, 5:Total Wildcard (or null)/SYSTEM_HOST\n+            final Map<String, ContentType>[] mimeTypeMappingArray = new Map [6];\n+\n+            dotAssetContentTypes.stream()\n+                    .filter(contentType -> isSystemHostOrCurrentHost(contentType, currentHost)) // remove the ones that are not system host or current host\n+                    .map(this::mapToContentTypeMimeType).forEach(contentTypeMimeType -> {\n+\n+                for (final String mimeTypeItem : contentTypeMimeType.mimeTypeFieldVariables) {\n+\n+                    if (ALL_MIME_TYPE.equals(mimeTypeItem)) {\n+\n+                        this.getMap(mimeTypeMappingArray, contentTypeMimeType.systemHost?5:4).put(mimeTypeItem, contentTypeMimeType.contentType);\n+                    } else if (mimeTypeItem.endsWith(PARTIAL_MIME_TYPE)) {\n+\n+                        this.getMap(mimeTypeMappingArray, contentTypeMimeType.systemHost?3:2).put(mimeTypeItem, contentTypeMimeType.contentType);\n+                    } else {\n+\n+                        this.getMap(mimeTypeMappingArray, contentTypeMimeType.systemHost?1:0).put(mimeTypeItem, contentTypeMimeType.contentType);\n+                    }\n+                }\n+            });\n+\n+            return findDotAssetContentType (mimeType, mimeTypeMappingArray);\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    private Optional<ContentType> findDotAssetContentType(final String mimeType,\n+                                                          final Map<String, ContentType>... mimeTypeMappingArray) {\n+\n+        for (final Map<String, ContentType> mimeTypeContentTypeMap : mimeTypeMappingArray) {\n+\n+            if (null != mimeTypeContentTypeMap) {\n+                for (final Map.Entry<String, ContentType> entry : mimeTypeContentTypeMap.entrySet()) {\n+\n+                    if (MimeTypeUtils.match(entry.getKey(), mimeType)) {\n+\n+                        return Optional.ofNullable(entry.getValue());\n+                    }\n+                }\n+            }\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    private Map<String, ContentType> getMap(final Map<String, ContentType>[] mimeTypeMappingArray, final int index) {\n+\n+        if (null == mimeTypeMappingArray[index]) {\n+\n+            mimeTypeMappingArray[index] = new HashMap<>();\n+        }\n+\n+        return mimeTypeMappingArray[index];\n+    }\n+\n+    private ContentTypeMimeType mapToContentTypeMimeType(final ContentType contentType) {\n+\n+        final String systemHostId          = APILocator.systemHost().getIdentifier();\n+        final String contentTypeHostId     = contentType.host();\n+        final boolean isSystemHost         = null == contentTypeHostId || contentTypeHostId.equals(systemHostId);\n+        final Map<String, Field>  fieldMap = contentType.fieldMap();\n+        String [] mimeTypeFieldVariables   = new String [] { ALL_MIME_TYPE };\n+        final List<FieldVariable> fieldVariables = fieldMap.get(DotAssetContentType.ASSET_FIELD_VAR).fieldVariables();\n+        if (UtilMethods.isSet(fieldVariables)) {\n+\n+            final Optional<FieldVariable> fieldVariableOpt = fieldVariables.stream().filter(fieldVariable ->\n+                    BinaryField.ALLOWED_FILE_TYPES.equalsIgnoreCase(fieldVariable.key())).findFirst();\n+\n+            if (fieldVariableOpt.isPresent() && UtilMethods.isSet(fieldVariableOpt.get().value())) {\n+\n+                mimeTypeFieldVariables = fieldVariableOpt.get().value().split(StringPool.COMMA);\n+            }\n+        }\n+\n+        return new ContentTypeMimeType(mimeTypeFieldVariables, contentType, isSystemHost);\n+    }\n+\n+    private boolean isSystemHostOrCurrentHost (final ContentType contentType, final Host currentHost) {\n+\n+        final String contentTypeHostId = contentType.host();\n+        final String systemHostId      = APILocator.systemHost().getIdentifier();\n+        return null == contentTypeHostId ||\n+                contentTypeHostId.equals(currentHost.getIdentifier()) || contentTypeHostId.equals(systemHostId);\n+\n+    }\n+\n+    private class ContentTypeMimeType {\n+\n+        private final boolean systemHost;\n+        private final String [] mimeTypeFieldVariables;\n+        private final ContentType contentType;\n+\n+        public ContentTypeMimeType(final String [] mimeTypeFieldVariables,", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3ODA4NQ==", "url": "https://github.com/dotCMS/core/pull/18007#discussion_r383378085", "bodyText": "Issue found: All methods are static.  Consider using a utility class instead. Alternatively, you could add a private constructor or make the class abstract to silence this warning.", "author": "dev-dotcms", "createdAt": "2020-02-24T16:38:59Z", "path": "dotCMS/src/integration-test/java/com/dotcms/util/TestMediaCreator.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.dotcms.util;\n+\n+import javax.imageio.ImageIO;\n+import java.awt.*;\n+import java.awt.image.BufferedImage;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Date;\n+\n+public class TestMediaCreator {", "originalCommit": "9760343fd70a1378b279742919f646bc683097bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}