{"pr_number": 19264, "pr_title": "Issue 8538", "pr_createdAt": "2020-09-14T22:29:41Z", "pr_url": "https://github.com/dotCMS/core/pull/19264", "timeline": [{"oid": "80ab3dde92e757de4f87db43c399714df23eb48d", "url": "https://github.com/dotCMS/core/commit/80ab3dde92e757de4f87db43c399714df23eb48d", "message": "#8538 allow limited user add top level categories", "committedDate": "2020-09-10T23:08:57Z", "type": "commit"}, {"oid": "1fecc4aa2de26055ccec5ed4f9d57ee74fae0a9a", "url": "https://github.com/dotCMS/core/commit/1fecc4aa2de26055ccec5ed4f9d57ee74fae0a9a", "message": "#8538 logger and remove unused code", "committedDate": "2020-09-11T18:40:21Z", "type": "commit"}, {"oid": "4faf69a549597ffc9fe7361e668ae18d5978c27b", "url": "https://github.com/dotCMS/core/commit/4faf69a549597ffc9fe7361e668ae18d5978c27b", "message": "#8538 improve UI message", "committedDate": "2020-09-11T18:41:08Z", "type": "commit"}, {"oid": "7969d142387c850671d81ae92bffe30f98865f2e", "url": "https://github.com/dotCMS/core/commit/7969d142387c850671d81ae92bffe30f98865f2e", "message": "#8538 remove unused code, even permissions", "committedDate": "2020-09-11T18:55:07Z", "type": "commit"}, {"oid": "3620b04791dc5cf0d0f863fc103ef88b2006b470", "url": "https://github.com/dotCMS/core/commit/3620b04791dc5cf0d0f863fc103ef88b2006b470", "message": "#8538 improve error message", "committedDate": "2020-09-14T22:24:49Z", "type": "commit"}, {"oid": "94a0affac311e6cdb9d66dc121addf084aeb2cab", "url": "https://github.com/dotCMS/core/commit/94a0affac311e6cdb9d66dc121addf084aeb2cab", "message": "#8538 IT", "committedDate": "2020-09-14T22:25:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMwNTIwMA==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r490305200", "bodyText": "maybe it should go to a local method, something like:\nprivate boolean isTopLevelCategory(parent){\n    return !UtilMethods.isSet(parent);\n}", "author": "freddyucv", "createdAt": "2020-09-17T14:42:56Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/categories/business/CategoryAPIImpl.java", "diffHunk": "@@ -142,41 +102,55 @@ public Category find(final String id, final User user,\n \t\treturn permissionAPI.filterCollection(categories, PermissionAPI.PERMISSION_READ, respectFrontendRoles, user);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Saves a category\r\n+\t *\r\n+\t * When saving a new category the parent should be passed to the API\r\n+\t * to check if the user has permissions to add children to the parent\r\n+\t * and the parent will be associated to the passed category\r\n+\t *\r\n+\t * @param parent Parent can be null if saving an top level category\r\n+\t * @param category Category to be saved\r\n+\t * @param user user that is performing the save\r\n+\t * @throws DotDataException\r\n+\t * @throws DotSecurityException\r\n+\t */\r\n \t@WrapInTransaction\r\n \tpublic void save(final Category parent,\r\n-\t\t\t\t\t Category object,\r\n+\t\t\t\t\t Category category,\r\n \t\t\t\t\t final User user,\r\n \t\t\t\t\t final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\r\n \r\n         // Checking that we have a unique key.\r\n-\t    object = checkUniqueKey(object, user);\r\n-\r\n-\t    boolean isANewCategory = false;\r\n-\r\n-\t\t//Checking permissions\r\n-\t\tif(InodeUtils.isSet(object.getInode()) || parent == null) {\r\n-\t\t\t//Object is not new or is a top level category\r\n-\t\t\t//if it is a new top level category the user should be a cms administrator\r\n-\t\t\t// and that's checked in the permissions api\r\n-\t\t\t if(!com.dotmarketing.business.APILocator.getRoleAPI().doesUserHaveRole(user, com.dotmarketing.business.APILocator.getRoleAPI().loadCMSAdminRole().getId())){\r\n-              if(!permissionAPI.doesUserHavePermission(object, PermissionAPI.PERMISSION_EDIT, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to edit the category = \" + object.getInode());\r\n-\t\t\t }\r\n-\t\t} else {\r\n-\t\t\t//Object is new and a parent was provided so we check in the parent permissions\r\n-\t\t\tif(!permissionAPI.doesUserHavePermission(parent, PermissionAPI.PERMISSION_EDIT_PERMISSIONS, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to save this category = \" +\r\n-\t\t\t\t\t\tobject.getInode() + \" having as parent the category = \" + parent.getInode());\r\n+\t    category = checkUniqueKey(category, user);\r\n \r\n-\t\t\tisANewCategory = true;\r\n+\t    boolean isANewCategory = UtilMethods.isNotSet(category.getInode());\r\n+\r\n+\t    //If parent is null is a top level category, we need to check permissions over the SYSTEM_HOST\r\n+\t\tif(!UtilMethods.isSet(parent)){\r", "originalCommit": "94a0affac311e6cdb9d66dc121addf084aeb2cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMwNjkyMg==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r490306922", "bodyText": "maybe it should go to a local method too, something like:\nprivate boolean checkTopLevelCategoryPermission(parent, user, respectFrontendRoles ){\n    return !UtilMethods.isSet(parent);\n}", "author": "freddyucv", "createdAt": "2020-09-17T14:44:38Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/categories/business/CategoryAPIImpl.java", "diffHunk": "@@ -142,41 +102,55 @@ public Category find(final String id, final User user,\n \t\treturn permissionAPI.filterCollection(categories, PermissionAPI.PERMISSION_READ, respectFrontendRoles, user);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Saves a category\r\n+\t *\r\n+\t * When saving a new category the parent should be passed to the API\r\n+\t * to check if the user has permissions to add children to the parent\r\n+\t * and the parent will be associated to the passed category\r\n+\t *\r\n+\t * @param parent Parent can be null if saving an top level category\r\n+\t * @param category Category to be saved\r\n+\t * @param user user that is performing the save\r\n+\t * @throws DotDataException\r\n+\t * @throws DotSecurityException\r\n+\t */\r\n \t@WrapInTransaction\r\n \tpublic void save(final Category parent,\r\n-\t\t\t\t\t Category object,\r\n+\t\t\t\t\t Category category,\r\n \t\t\t\t\t final User user,\r\n \t\t\t\t\t final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\r\n \r\n         // Checking that we have a unique key.\r\n-\t    object = checkUniqueKey(object, user);\r\n-\r\n-\t    boolean isANewCategory = false;\r\n-\r\n-\t\t//Checking permissions\r\n-\t\tif(InodeUtils.isSet(object.getInode()) || parent == null) {\r\n-\t\t\t//Object is not new or is a top level category\r\n-\t\t\t//if it is a new top level category the user should be a cms administrator\r\n-\t\t\t// and that's checked in the permissions api\r\n-\t\t\t if(!com.dotmarketing.business.APILocator.getRoleAPI().doesUserHaveRole(user, com.dotmarketing.business.APILocator.getRoleAPI().loadCMSAdminRole().getId())){\r\n-              if(!permissionAPI.doesUserHavePermission(object, PermissionAPI.PERMISSION_EDIT, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to edit the category = \" + object.getInode());\r\n-\t\t\t }\r\n-\t\t} else {\r\n-\t\t\t//Object is new and a parent was provided so we check in the parent permissions\r\n-\t\t\tif(!permissionAPI.doesUserHavePermission(parent, PermissionAPI.PERMISSION_EDIT_PERMISSIONS, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to save this category = \" +\r\n-\t\t\t\t\t\tobject.getInode() + \" having as parent the category = \" + parent.getInode());\r\n+\t    category = checkUniqueKey(category, user);\r\n \r\n-\t\t\tisANewCategory = true;\r\n+\t    boolean isANewCategory = UtilMethods.isNotSet(category.getInode());\r\n+\r\n+\t    //If parent is null is a top level category, we need to check permissions over the SYSTEM_HOST\r\n+\t\tif(!UtilMethods.isSet(parent)){\r\n+\t\t\t\tif(!permissionAPI.doesUserHavePermission(APILocator.systemHost(), PermissionAPI.PERMISSION_CAN_ADD_CHILDREN, user, respectFrontendRoles) ||\r", "originalCommit": "94a0affac311e6cdb9d66dc121addf084aeb2cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMwNzIxOQ==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r490307219", "bodyText": "maybe it should go to a local method too, something like:\nprivate boolean checkCategoryPermission(parent, user, respectFrontendRoles ){\n    return !UtilMethods.isSet(parent);\n}", "author": "freddyucv", "createdAt": "2020-09-17T14:44:55Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/categories/business/CategoryAPIImpl.java", "diffHunk": "@@ -142,41 +102,55 @@ public Category find(final String id, final User user,\n \t\treturn permissionAPI.filterCollection(categories, PermissionAPI.PERMISSION_READ, respectFrontendRoles, user);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Saves a category\r\n+\t *\r\n+\t * When saving a new category the parent should be passed to the API\r\n+\t * to check if the user has permissions to add children to the parent\r\n+\t * and the parent will be associated to the passed category\r\n+\t *\r\n+\t * @param parent Parent can be null if saving an top level category\r\n+\t * @param category Category to be saved\r\n+\t * @param user user that is performing the save\r\n+\t * @throws DotDataException\r\n+\t * @throws DotSecurityException\r\n+\t */\r\n \t@WrapInTransaction\r\n \tpublic void save(final Category parent,\r\n-\t\t\t\t\t Category object,\r\n+\t\t\t\t\t Category category,\r\n \t\t\t\t\t final User user,\r\n \t\t\t\t\t final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\r\n \r\n         // Checking that we have a unique key.\r\n-\t    object = checkUniqueKey(object, user);\r\n-\r\n-\t    boolean isANewCategory = false;\r\n-\r\n-\t\t//Checking permissions\r\n-\t\tif(InodeUtils.isSet(object.getInode()) || parent == null) {\r\n-\t\t\t//Object is not new or is a top level category\r\n-\t\t\t//if it is a new top level category the user should be a cms administrator\r\n-\t\t\t// and that's checked in the permissions api\r\n-\t\t\t if(!com.dotmarketing.business.APILocator.getRoleAPI().doesUserHaveRole(user, com.dotmarketing.business.APILocator.getRoleAPI().loadCMSAdminRole().getId())){\r\n-              if(!permissionAPI.doesUserHavePermission(object, PermissionAPI.PERMISSION_EDIT, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to edit the category = \" + object.getInode());\r\n-\t\t\t }\r\n-\t\t} else {\r\n-\t\t\t//Object is new and a parent was provided so we check in the parent permissions\r\n-\t\t\tif(!permissionAPI.doesUserHavePermission(parent, PermissionAPI.PERMISSION_EDIT_PERMISSIONS, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to save this category = \" +\r\n-\t\t\t\t\t\tobject.getInode() + \" having as parent the category = \" + parent.getInode());\r\n+\t    category = checkUniqueKey(category, user);\r\n \r\n-\t\t\tisANewCategory = true;\r\n+\t    boolean isANewCategory = UtilMethods.isNotSet(category.getInode());\r\n+\r\n+\t    //If parent is null is a top level category, we need to check permissions over the SYSTEM_HOST\r\n+\t\tif(!UtilMethods.isSet(parent)){\r\n+\t\t\t\tif(!permissionAPI.doesUserHavePermission(APILocator.systemHost(), PermissionAPI.PERMISSION_CAN_ADD_CHILDREN, user, respectFrontendRoles) ||\r\n+\t\t\t\t\t\t!permissionAPI.doesUserHavePermissions(PermissionableType.CATEGORY, PermissionAPI.PERMISSION_EDIT, user)){\r\n+\t\t\t\t\tLogger.error(this,\"User doesn't have permission to save the category at top level\");\r\n+\t\t\t\tthrow new DotSecurityException(\r\n+\t\t\t\t\t\t\"User doesn't have permission to save the category at top level\");\r\n+\t\t\t}\r\n+\t\t} else {\r\n+\t\t\tif (!permissionAPI.doesUserHavePermission(parent, PermissionAPI.PERMISSION_EDIT, user, respectFrontendRoles)) {\r", "originalCommit": "94a0affac311e6cdb9d66dc121addf084aeb2cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "075bd2bd913eb558211aedbd46da68b33ed2b795", "url": "https://github.com/dotCMS/core/commit/075bd2bd913eb558211aedbd46da68b33ed2b795", "message": "Merge branch 'master' into issue-8538", "committedDate": "2020-09-18T19:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTAzMA==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r491149030", "bodyText": "Codacy found an issue: Avoid reassigning parameters such as 'category'", "author": "dev-dotcms", "createdAt": "2020-09-18T19:27:31Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/categories/business/CategoryAPIImpl.java", "diffHunk": "@@ -142,41 +102,55 @@ public Category find(final String id, final User user,\n \t\treturn permissionAPI.filterCollection(categories, PermissionAPI.PERMISSION_READ, respectFrontendRoles, user);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Saves a category\r\n+\t *\r\n+\t * When saving a new category the parent should be passed to the API\r\n+\t * to check if the user has permissions to add children to the parent\r\n+\t * and the parent will be associated to the passed category\r\n+\t *\r\n+\t * @param parent Parent can be null if saving an top level category\r\n+\t * @param category Category to be saved\r\n+\t * @param user user that is performing the save\r\n+\t * @throws DotDataException\r\n+\t * @throws DotSecurityException\r\n+\t */\r\n \t@WrapInTransaction\r\n \tpublic void save(final Category parent,\r\n-\t\t\t\t\t Category object,\r\n+\t\t\t\t\t Category category,\r", "originalCommit": "075bd2bd913eb558211aedbd46da68b33ed2b795", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTA0MQ==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r491149041", "bodyText": "Codacy found an issue: Avoid unused local variables such as 'newCategory'.", "author": "dev-dotcms", "createdAt": "2020-09-18T19:27:32Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/categories/business/CategoryAPITest.java", "diffHunk": "@@ -1087,6 +1080,192 @@ private ContentType createContentTypeWithCatAndTextField(final Category parentCa\n     }\n \n     /**\n+     * Method to test: {@link CategoryAPI#save(Category, Category, User, boolean)}\n+     * Given Scenario: As a admin user create a top level category\n+     * ExpectedResult: Category created successfully\n+     */\n+    @Test\n+    public void test_save_createTopLevelCategory_asAdmin_success()\n+            throws DotSecurityException, DotDataException {\n+        //Create new Top Level Category\n+        final String categoryName = \"newCategory\" + System.currentTimeMillis();\n+        final Category newCategory = new CategoryDataGen().setCategoryName(categoryName)", "originalCommit": "075bd2bd913eb558211aedbd46da68b33ed2b795", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTA0Nw==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r491149047", "bodyText": "Codacy found an issue: Avoid unused local variables such as 'newParentCategory'.", "author": "dev-dotcms", "createdAt": "2020-09-18T19:27:33Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/categories/business/CategoryAPITest.java", "diffHunk": "@@ -1087,6 +1080,192 @@ private ContentType createContentTypeWithCatAndTextField(final Category parentCa\n     }\n \n     /**\n+     * Method to test: {@link CategoryAPI#save(Category, Category, User, boolean)}\n+     * Given Scenario: As a admin user create a top level category\n+     * ExpectedResult: Category created successfully\n+     */\n+    @Test\n+    public void test_save_createTopLevelCategory_asAdmin_success()\n+            throws DotSecurityException, DotDataException {\n+        //Create new Top Level Category\n+        final String categoryName = \"newCategory\" + System.currentTimeMillis();\n+        final Category newCategory = new CategoryDataGen().setCategoryName(categoryName)\n+                .setCategoryVelocityVarName(categoryName).setKey(categoryName).nextPersisted();\n+        //Find created Category\n+        final Category getCategory = categoryAPI.findByKey(categoryName,user,false);\n+        //Check that the category obtained is the same as the created\n+        assertNotNull(getCategory);\n+        assertEquals(categoryName,getCategory.getCategoryName());\n+    }\n+\n+    /**\n+     * Method to test: {@link CategoryAPI#save(Category, Category, User, boolean)}\n+     * Given Scenario: As a admin user create a top level category and a subcategory of it\n+     * ExpectedResult: Categories created successfully\n+     */\n+    @Test\n+    public void test_save_createSubCategory_asAdmin_success()\n+            throws DotSecurityException, DotDataException {\n+        final String parentCategoryName = \"newParentCategory\" + System.currentTimeMillis();\n+        final String childCategoryName = \"newChildCategory\" + System.currentTimeMillis();\n+        //Create Child Category\n+        final Category newChildCategory = new CategoryDataGen().setCategoryName(childCategoryName)\n+                .setCategoryVelocityVarName(childCategoryName).setKey(childCategoryName).next();\n+        //Create Parent Category\n+        final Category newParentCategory = new CategoryDataGen().setCategoryName(parentCategoryName)", "originalCommit": "075bd2bd913eb558211aedbd46da68b33ed2b795", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0OTA1NA==", "url": "https://github.com/dotCMS/core/pull/19264#discussion_r491149054", "bodyText": "Codacy found an issue: Avoid declaring a variable if it is unreferenced before a possible exit point.", "author": "dev-dotcms", "createdAt": "2020-09-18T19:27:34Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/categories/business/CategoryAPIImpl.java", "diffHunk": "@@ -142,41 +102,55 @@ public Category find(final String id, final User user,\n \t\treturn permissionAPI.filterCollection(categories, PermissionAPI.PERMISSION_READ, respectFrontendRoles, user);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Saves a category\r\n+\t *\r\n+\t * When saving a new category the parent should be passed to the API\r\n+\t * to check if the user has permissions to add children to the parent\r\n+\t * and the parent will be associated to the passed category\r\n+\t *\r\n+\t * @param parent Parent can be null if saving an top level category\r\n+\t * @param category Category to be saved\r\n+\t * @param user user that is performing the save\r\n+\t * @throws DotDataException\r\n+\t * @throws DotSecurityException\r\n+\t */\r\n \t@WrapInTransaction\r\n \tpublic void save(final Category parent,\r\n-\t\t\t\t\t Category object,\r\n+\t\t\t\t\t Category category,\r\n \t\t\t\t\t final User user,\r\n \t\t\t\t\t final boolean respectFrontendRoles) throws DotDataException, DotSecurityException {\r\n \r\n         // Checking that we have a unique key.\r\n-\t    object = checkUniqueKey(object, user);\r\n-\r\n-\t    boolean isANewCategory = false;\r\n-\r\n-\t\t//Checking permissions\r\n-\t\tif(InodeUtils.isSet(object.getInode()) || parent == null) {\r\n-\t\t\t//Object is not new or is a top level category\r\n-\t\t\t//if it is a new top level category the user should be a cms administrator\r\n-\t\t\t// and that's checked in the permissions api\r\n-\t\t\t if(!com.dotmarketing.business.APILocator.getRoleAPI().doesUserHaveRole(user, com.dotmarketing.business.APILocator.getRoleAPI().loadCMSAdminRole().getId())){\r\n-              if(!permissionAPI.doesUserHavePermission(object, PermissionAPI.PERMISSION_EDIT, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to edit the category = \" + object.getInode());\r\n-\t\t\t }\r\n-\t\t} else {\r\n-\t\t\t//Object is new and a parent was provided so we check in the parent permissions\r\n-\t\t\tif(!permissionAPI.doesUserHavePermission(parent, PermissionAPI.PERMISSION_EDIT_PERMISSIONS, user, respectFrontendRoles))\r\n-\t\t\t\tthrow new DotSecurityException(\"User doesn't have permission to save this category = \" +\r\n-\t\t\t\t\t\tobject.getInode() + \" having as parent the category = \" + parent.getInode());\r\n+\t    category = checkUniqueKey(category, user);\r\n \r\n-\t\t\tisANewCategory = true;\r\n+\t    boolean isANewCategory = UtilMethods.isNotSet(category.getInode());\r", "originalCommit": "075bd2bd913eb558211aedbd46da68b33ed2b795", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}