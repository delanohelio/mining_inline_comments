{"pr_number": 18378, "pr_title": "#18364 : This \"code fix\" has been tested in several customer environm\u2026", "pr_createdAt": "2020-04-28T16:03:03Z", "pr_url": "https://github.com/dotCMS/core/pull/18378", "timeline": [{"oid": "22993c63d53b99daf5ae8ee5c13479744f18797f", "url": "https://github.com/dotCMS/core/commit/22993c63d53b99daf5ae8ee5c13479744f18797f", "message": "#18364 : This \"code fix\" has been tested in several customer environments and has been the most effective solution to Vanity URL problems so far. However, the whole Vanity URL  API needs to be completely re-imagined. This fix is made up of three changes: (1) forcing an additional read in case the cache regions do not return valid data (which should not happen in normal circumstances), (2) explicitly define cache regions for the two Vanity URL regions, not just one of them, and (3) ALWAYS use the Timed Cache for the Vanity URL caches. The default 2-minute timeout works for most customers; however, some of them might require a timeout of 1 minute or less. Also, the legacy \"virtuallinkscache\" region has been replaced with the correct Vanity URL regions.", "committedDate": "2020-04-28T16:02:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzMjYzMQ==", "url": "https://github.com/dotCMS/core/pull/18378#discussion_r416832631", "bodyText": "This method needs Integration Tests", "author": "dsilvam", "createdAt": "2020-04-28T18:29:16Z", "path": "dotCMS/src/main/java/com/dotcms/vanityurl/business/VanityUrlAPIImpl.java", "diffHunk": "@@ -133,10 +133,42 @@ private void initializeActiveVanityURLsCacheBySiteAndLanguage(final String siteI\n                         (siteId, languageId, includeSystemHost);\n             }\n         } catch (final Exception e) {\n-            throw new DotRuntimeException(\"Error searching and populating the Vanity URL Cache\", e);\n+            throw new DotRuntimeException(String.format(\"Error searching and populating the Vanity URL from DB for \" +\n+                    \"Site ID '%s', language ID = '%s': %s\", siteId, languageId, e.getMessage()), e);\n         }\n     } // initializeActiveVanityURLsCacheBySiteAndLanguage.\n \n+    /**\n+     * Searches for all Vanity URLs for a given Site in the system <b>without loading data into any of the Vanity URL\n+     * Cache Regions</b>. This initialization routine will also add Vanity URLs located under System Host.\n+     *\n+     * @param siteId     The ID of the Site whose Vanity URLs will be retrieved.\n+     * @param languageId The ID of the language for the Vanity URLs.\n+     *\n+     * @return A list of Vanity URLs read from the data source.\n+     */\n+    private List<CachedVanityUrl> getActiveVanityURLsNoCacheBySiteAndLanguage(final String siteId, final Long languageId) {", "originalCommit": "22993c63d53b99daf5ae8ee5c13479744f18797f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzNDUxMA==", "url": "https://github.com/dotCMS/core/pull/18378#discussion_r416834510", "bodyText": "do we have existing Integration Tests that end up calling this private method?", "author": "dsilvam", "createdAt": "2020-04-28T18:32:21Z", "path": "dotCMS/src/main/java/com/dotcms/vanityurl/business/VanityUrlAPIImpl.java", "diffHunk": "@@ -155,7 +187,8 @@ private void initializeActiveVanityURLsCacheBySiteAndLanguage(final String siteI\n         List<Contentlet> contentlets = new ArrayList<>();\n         final StringBuilder query = new StringBuilder();\n         query.append(\"SELECT cvi.live_inode FROM contentlet c \");\n-        query.append(\"INNER JOIN identifier i ON c.identifier = i.id AND i.host_inode \");\n+        //c.text2 is the Site Field for Vanity URL Content Type\n+        query.append(\"INNER JOIN identifier i ON c.identifier = i.id AND c.text2 \");", "originalCommit": "22993c63d53b99daf5ae8ee5c13479744f18797f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}