{"pr_number": 18674, "pr_title": "#18673 : Adding validation to the objects that have a high chance of \u2026", "pr_createdAt": "2020-06-16T17:44:14Z", "pr_url": "https://github.com/dotCMS/core/pull/18674", "timeline": [{"oid": "d09516d072ee251ce53836eb28388470bd0b46b1", "url": "https://github.com/dotCMS/core/commit/d09516d072ee251ce53836eb28388470bd0b46b1", "message": "#18673 : Adding validation to the objects that have a high chance of causing NPEs because of incorrect/unexpected content information during the reindex. Improving error logging. These errors are very likely because the customer who experienced them comes from a very old version of dotCMS.", "committedDate": "2020-06-16T17:43:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNDgzNQ==", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r441034835", "bodyText": "DotDataException", "author": "dsilvam", "createdAt": "2020-06-16T17:51:21Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -189,10 +189,36 @@ public String toJson(final Contentlet contentlet) throws DotMappingException {\n             loadRelationshipFields(contentlet, contentletMap, sw);\n \n \t\t\tfinal Identifier contentIdentifier = APILocator.getIdentifierAPI().find(contentlet);\n+            if (null == contentIdentifier || !UtilMethods.isSet(contentIdentifier.getId())) {\n+                final String errorMsg = String.format(\"Identifier '%s' was not found via API.\", contentlet\n+                        .getIdentifier());\n+                throw new Exception(errorMsg);", "originalCommit": "d09516d072ee251ce53836eb28388470bd0b46b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b", "url": "https://github.com/dotCMS/core/commit/a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b", "message": "#18673 : Adding code review changes", "committedDate": "2020-06-16T17:57:00Z", "type": "commit"}, {"oid": "9938bcfcc5e8f4b36ae0bdeece14f617bbb49262", "url": "https://github.com/dotCMS/core/commit/9938bcfcc5e8f4b36ae0bdeece14f617bbb49262", "message": "#18673 testing", "committedDate": "2020-07-07T21:30:37Z", "type": "commit"}, {"oid": "107fdac2966377d5256dc1df93f980bee747a3b3", "url": "https://github.com/dotCMS/core/commit/107fdac2966377d5256dc1df93f980bee747a3b3", "message": "#18673 merge", "committedDate": "2020-07-07T21:34:05Z", "type": "commit"}, {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a", "url": "https://github.com/dotCMS/core/commit/9d2526a38591cb54642add73c8a84c65e659e82a", "message": "#18673 Testing", "committedDate": "2020-07-08T18:05:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNTY1Nw==", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r451735657", "bodyText": "Codacy found an issue: Avoid unused local variables such as 'versionInfo'.", "author": "dev-dotcms", "createdAt": "2020-07-08T18:12:02Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -143,6 +145,106 @@ public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n \n     }\n \n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid host\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidHostId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setHost(\"not_exist_host\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid folder\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidFolderId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setFolder(\"not_exist_folder\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid content type\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidContentTypeId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setContentTypeId(\"not_exist_content_type\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has not {@link com.dotmarketing.beans.Identifier}\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasNotIdentifier() {\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has not {@link ContentletVersionInfo}\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasNotContentletVersionInfo() throws DotDataException {\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).nextPersisted();\n+\n+        final ContentletVersionInfo versionInfo = APILocator.getVersionableAPI()", "originalCommit": "9d2526a38591cb54642add73c8a84c65e659e82a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNTY3NA==", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r451735674", "bodyText": "Codacy found an issue: Avoid unused imports such as 'com.dotmarketing.business'", "author": "dev-dotcms", "createdAt": "2020-07-08T18:12:04Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -26,24 +27,24 @@\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.model.type.ImmutableFileAssetContentType;\n import com.dotcms.contenttype.model.type.SimpleContentType;\n-import com.dotcms.contenttype.util.KeyValueFieldUtil;\n+\n import com.dotcms.datagen.ContentTypeDataGen;\n import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.contenttype.util.KeyValueFieldUtil;\n import com.dotcms.datagen.FieldDataGen;\n import com.dotcms.datagen.FileAssetDataGen;\n import com.dotcms.datagen.SiteDataGen;\n import com.dotcms.util.CollectionsUtils;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.RelationshipAPI;\n-import com.dotmarketing.business.UserAPI;\n+import com.dotmarketing.business.*;", "originalCommit": "9d2526a38591cb54642add73c8a84c65e659e82a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}