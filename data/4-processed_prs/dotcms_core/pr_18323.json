{"pr_number": 18323, "pr_title": "#18233 integrating app into the translate actionlet", "pr_createdAt": "2020-04-20T05:03:43Z", "pr_url": "https://github.com/dotCMS/core/pull/18323", "timeline": [{"oid": "bb980bf8635edbe817b3466ae3dd10f6f116dabb", "url": "https://github.com/dotCMS/core/commit/bb980bf8635edbe817b3466ae3dd10f6f116dabb", "message": "#18233 integrating app into the translate actionlet", "committedDate": "2020-04-20T05:02:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyNjUyNA==", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r411426524", "bodyText": "I think we are missing some test here", "author": "freddyucv", "createdAt": "2020-04-20T14:31:30Z", "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -121,7 +135,47 @@ public void setServiceParameters(List<ServiceParameter> params) {\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey();\n+    }\n+\n+\n+    private String getFallbackApiKey () {\n+\n+        final String appsTranslationKey    = Config.getStringProperty(\"apps_translation_key\", \"app-translation\");\n+        final String appsTranslationApiKey = Config.getStringProperty(\"apps_translation_apikey\", \"apiKey\");\n+\n+        Optional<AppSecrets> appSecretsOpt = Optional.empty();\n+        try {\n+            appSecretsOpt = APILocator.getAppsAPI().getSecrets\n+                    (appsTranslationKey, true, this.resolveHost(), APILocator.systemUser());\n+        } catch (DotDataException | DotSecurityException e) {\n+            Logger.error(this, e.getMessage());\n+        }\n+\n+        if (appSecretsOpt.isPresent()) {\n+\n+            final Secret secret = appSecretsOpt.get().getSecrets().get(appsTranslationApiKey);\n+            if (null != secret) {\n+                return secret.getString();\n+            }\n+        }\n+\n+        return Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", StringPool.BLANK);\n+    }\n+\n+    private Host resolveHost () {\n+\n+        Host  host = null;\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        if (null != request) {\n+            host = Try.of(()->WebAPILocator.getHostWebAPI().getCurrentHostNoThrow(request)).getOrNull();\n+        }\n+\n+        if (null == host) {\n+            host = Try.of(() -> APILocator.getHostAPI().findDefaultHost(APILocator.systemUser(), false)).getOrNull();\n+        }\n+\n+        return null == host? APILocator.systemHost(): host;", "originalCommit": "bb980bf8635edbe817b3466ae3dd10f6f116dabb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b85b4153a6e59710e24901250520302fd9fb3192", "url": "https://github.com/dotCMS/core/commit/b85b4153a6e59710e24901250520302fd9fb3192", "message": "#18233 now the host is being taking from the content host", "committedDate": "2020-04-20T15:53:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5Nzg1Nw==", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r412297857", "bodyText": "This logic should be tested", "author": "nollymar", "createdAt": "2020-04-21T16:04:00Z", "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -113,15 +127,60 @@ public String translateString(String toTranslate, Language from, Language to) th\n     }\n \n     @Override\n-    public void setServiceParameters(List<ServiceParameter> params) {\n+    public void setServiceParameters(final List<ServiceParameter> params, final Optional<String> hostOpt) {\n         this.params = params;\n         Map<String, ServiceParameter> paramsMap = params.stream().collect(\n             Collectors.toMap(ServiceParameter::getKey, Function.identity()));\n         String apiKeyValue = paramsMap.get(\"apiKey\").getValue();\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey(hostOpt);", "originalCommit": "b85b4153a6e59710e24901250520302fd9fb3192", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cce16e31c73aeaa532615eb7dda140b35a9fae6a", "url": "https://github.com/dotCMS/core/commit/cce16e31c73aeaa532615eb7dda140b35a9fae6a", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18233-translate-service-app", "committedDate": "2020-08-10T18:14:58Z", "type": "commit"}, {"oid": "04710ad1cd423879894e28f6cfd4cb04edc05c2e", "url": "https://github.com/dotCMS/core/commit/04710ad1cd423879894e28f6cfd4cb04edc05c2e", "message": "#18233 add googleTranslate config yaml", "committedDate": "2020-08-11T17:33:46Z", "type": "commit"}, {"oid": "6a51fa151517be1016e9b4f8d87af7a7e8fd332f", "url": "https://github.com/dotCMS/core/commit/6a51fa151517be1016e9b4f8d87af7a7e8fd332f", "message": "#18233 refactor translate service", "committedDate": "2020-08-11T17:34:52Z", "type": "commit"}, {"oid": "7d613f337b1f2ebaf2f4f681bfd4e0f7b208eb4c", "url": "https://github.com/dotCMS/core/commit/7d613f337b1f2ebaf2f4f681bfd4e0f7b208eb4c", "message": "#18233 feedback", "committedDate": "2020-08-11T18:51:10Z", "type": "commit"}, {"oid": "9c2a79d130167756d98bbacd1e9cf0a9c8e75288", "url": "https://github.com/dotCMS/core/commit/9c2a79d130167756d98bbacd1e9cf0a9c8e75288", "message": "#18233 check if appSecrets is present", "committedDate": "2020-08-11T21:54:58Z", "type": "commit"}, {"oid": "e81a817c6426153e914eb75195a6d380fce83dae", "url": "https://github.com/dotCMS/core/commit/e81a817c6426153e914eb75195a6d380fce83dae", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18233-translate-service-app", "committedDate": "2020-08-11T21:55:34Z", "type": "commit"}, {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8", "url": "https://github.com/dotCMS/core/commit/a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8", "message": "#18233 tests", "committedDate": "2020-08-11T21:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzA0MA==", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r469323040", "bodyText": "Tests need doc", "author": "nollymar", "createdAt": "2020-08-12T14:57:17Z", "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {", "originalCommit": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NjU5OQ==", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r469396599", "bodyText": "done", "author": "erickgonzalez", "createdAt": "2020-08-12T16:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzA0MA=="}], "type": "inlineReview"}, {"oid": "9a80776ada647b8bdb65d622ea36ef5fef69b194", "url": "https://github.com/dotCMS/core/commit/9a80776ada647b8bdb65d622ea36ef5fef69b194", "message": "#18233 doc tests", "committedDate": "2020-08-12T16:43:14Z", "type": "commit"}, {"oid": "e6571cd9d51f731fc0f6786ae1a1dc49606fb309", "url": "https://github.com/dotCMS/core/commit/e6571cd9d51f731fc0f6786ae1a1dc49606fb309", "message": "#18233 doc tests", "committedDate": "2020-08-12T16:43:59Z", "type": "commit"}, {"oid": "e38fe83ebe9c8e955c6a3a70194377c686e380f6", "url": "https://github.com/dotCMS/core/commit/e38fe83ebe9c8e955c6a3a70194377c686e380f6", "message": "#18233 rename yaml file", "committedDate": "2020-08-13T15:22:45Z", "type": "commit"}, {"oid": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f", "url": "https://github.com/dotCMS/core/commit/b49bd0207c8eadb02ba8160904ed90d89ffafc3f", "message": "master", "committedDate": "2020-08-14T20:56:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2NDI3NQ==", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r470864275", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-08-14T21:04:12Z", "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {\n+\n+    private static User admin;\n+    private static GoogleTranslationService translationService;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}