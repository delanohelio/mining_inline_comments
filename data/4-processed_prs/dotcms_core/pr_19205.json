{"pr_number": 19205, "pr_title": "#18988 _text fields should be optional", "pr_createdAt": "2020-09-01T16:33:55Z", "pr_url": "https://github.com/dotCMS/core/pull/19205", "timeline": [{"oid": "849d0cc0e13693d1905493da0a38c0aadf5a8503", "url": "https://github.com/dotCMS/core/commit/849d0cc0e13693d1905493da0a38c0aadf5a8503", "message": "#18988 _text fields are added to the index only if the CREATE_TEXT_INDEX_FIELD_FOR_NON_TEXT_FIELDS property is on", "committedDate": "2020-09-01T16:32:31Z", "type": "commit"}, {"oid": "ab4cd48a0213198af2796d026d6ac0acfc482bfc", "url": "https://github.com/dotCMS/core/commit/ab4cd48a0213198af2796d026d6ac0acfc482bfc", "message": "#18988 New ITs", "committedDate": "2020-09-01T17:20:35Z", "type": "commit"}, {"oid": "4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "url": "https://github.com/dotCMS/core/commit/4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "message": "#18988 Fixing codacy suggestion and doc", "committedDate": "2020-09-01T22:32:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MDA1MA==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482170050", "bodyText": "this could be reduce to\ncontentletMap.put(ESMappingConstants.PUBLISH_DATE,\n                        elasticSearchDateTimeFormat.format(UtilMethods.isSet(contentIdentifier.getSysPublishDate())?contentIdentifier.getSysPublishDate():versionInfo.getVersionTs()));\n\nUp to you", "author": "jdotcms", "createdAt": "2020-09-02T15:38:35Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -286,29 +278,26 @@ public String toJson(final Contentlet contentlet) throws DotMappingException {\n \t\t\t//add workflow to map\n \t\t\tcontentletMap.putAll(getWorkflowInfoForContentlet(contentlet));\n \n-\t\t\tif(UtilMethods.isSet(contentIdentifier.getSysPublishDate())) {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE, elasticSearchDateTimeFormat.format(contentIdentifier.getSysPublishDate()));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE + TEXT,\n-\t\t\t\t\t\tdatetimeFormat.format(contentIdentifier.getSysPublishDate()));\n-\t\t\t}else {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE, elasticSearchDateTimeFormat.format(versionInfo.getVersionTs()));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE + TEXT,\n-\t\t\t\t\t\tdatetimeFormat.format(versionInfo.getVersionTs()));\n-\t\t\t}\n+            if (UtilMethods.isSet(contentIdentifier.getSysPublishDate())) {\n+                contentletMap.put(ESMappingConstants.PUBLISH_DATE,", "originalCommit": "4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU0OTYwNw==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482549607", "bodyText": "it could, but I think this way it's easier to read", "author": "nollymar", "createdAt": "2020-09-02T22:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MDA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MDY3Mw==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482170673", "bodyText": "same thing", "author": "jdotcms", "createdAt": "2020-09-02T15:39:26Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -286,29 +278,26 @@ public String toJson(final Contentlet contentlet) throws DotMappingException {\n \t\t\t//add workflow to map\n \t\t\tcontentletMap.putAll(getWorkflowInfoForContentlet(contentlet));\n \n-\t\t\tif(UtilMethods.isSet(contentIdentifier.getSysPublishDate())) {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE, elasticSearchDateTimeFormat.format(contentIdentifier.getSysPublishDate()));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE + TEXT,\n-\t\t\t\t\t\tdatetimeFormat.format(contentIdentifier.getSysPublishDate()));\n-\t\t\t}else {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE, elasticSearchDateTimeFormat.format(versionInfo.getVersionTs()));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.PUBLISH_DATE + TEXT,\n-\t\t\t\t\t\tdatetimeFormat.format(versionInfo.getVersionTs()));\n-\t\t\t}\n+            if (UtilMethods.isSet(contentIdentifier.getSysPublishDate())) {\n+                contentletMap.put(ESMappingConstants.PUBLISH_DATE,\n+                        elasticSearchDateTimeFormat.format(contentIdentifier.getSysPublishDate()));\n+            } else {\n+                contentletMap.put(ESMappingConstants.PUBLISH_DATE,\n+                        elasticSearchDateTimeFormat.format(versionInfo.getVersionTs()));\n+            }\n \n-\t\t\tif(UtilMethods.isSet(contentIdentifier.getSysExpireDate())) {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.EXPIRE_DATE, elasticSearchDateTimeFormat.format(contentIdentifier.getSysExpireDate()));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.EXPIRE_DATE + TEXT,\n-\t\t\t\t\t\tdatetimeFormat.format(contentIdentifier.getSysExpireDate()));\n-\t\t\t}else {\n-\t\t\t\tcontentletMap.put(ESMappingConstants.EXPIRE_DATE, elasticSearchDateTimeFormat.format(29990101000000L));\n-\t\t\t\tcontentletMap.put(ESMappingConstants.EXPIRE_DATE + TEXT, \"29990101000000\");\n-\t\t\t}\n+            if (UtilMethods.isSet(contentIdentifier.getSysExpireDate())) {", "originalCommit": "4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MTUzOQ==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482171539", "bodyText": "it is meaningless, rename it", "author": "jdotcms", "createdAt": "2020-09-02T15:40:36Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -567,11 +612,14 @@ protected void loadPermissions(final Contentlet con, final Map<String,Object> m)\n \t\t}\n \t\tm.put(ESMappingConstants.PERMISSIONS, permissionsSt.toString());\n \t\tm.put(ESMappingConstants.OWNER_CAN_READ, ownerCanRead);\n-\t\tm.put(ESMappingConstants.OWNER_CAN_READ + TEXT, Boolean.toString(ownerCanRead));\n \t\tm.put(ESMappingConstants.OWNER_CAN_WRITE, ownerCanWrite);\n-\t\tm.put(ESMappingConstants.OWNER_CAN_WRITE + TEXT, Boolean.toString(ownerCanWrite));\n \t\tm.put(ESMappingConstants.OWNER_CAN_PUBLISH, ownerCanPub);\n-\t\tm.put(ESMappingConstants.OWNER_CAN_PUBLISH + TEXT, Boolean.toString(ownerCanPub));\n+\n+        if (Config.getBooleanProperty(\"CREATE_TEXT_INDEX_FIELD_FOR_NON_TEXT_FIELDS\", false)) {\n+            m.put(ESMappingConstants.OWNER_CAN_READ + TEXT, Boolean.toString(ownerCanRead));", "originalCommit": "4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU0MDg5MA==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482540890", "bodyText": "@jdotcms what do you mean with \"m is missingless\"?", "author": "nollymar", "createdAt": "2020-09-02T22:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MTUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU0MzM2Mg==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482543362", "bodyText": "I think he meant \"meaningless\" and that you should perhaps rename the variable \"map\"  or \"permissionsMap\" or something", "author": "wezell", "createdAt": "2020-09-02T22:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MTUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU1MDI5NA==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482550294", "bodyText": "Done", "author": "nollymar", "createdAt": "2020-09-02T22:35:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3NDY2MA==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482174660", "bodyText": "I think we need to treat methods with void returns as a code smell  especially if we are passing in an object that is intended to be mutated under the covers.  This to me is an coding anti-pattern.\nA better choice for this method for example  is to return an Optional that if it is present, gets added to the existing collection.  That allows for simpler testing and a clear understanding of what object is being changed when this method is called.", "author": "wezell", "createdAt": "2020-09-02T15:44:58Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -384,6 +373,59 @@ public String toJson(final Contentlet contentlet) throws DotMappingException {\n \t\t}\n \t}\n \n+    /**\n+     * Fields with suffix _text will be indexed if the property `CREATE_TEXT_INDEX_FIELD_FOR_NON_TEXT_FIELDS` is on\n+     * @param contentletMap\n+     * @param contentlet\n+     * @param contentIdentifier\n+     * @param versionInfo\n+     * @param contentType\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    private void addTextFieldToMapIfNeeded(final Map<String, Object> contentletMap,", "originalCommit": "4196eecad05b0802d9ea58bbc7d9539ed54f40f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU0MDk5OQ==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r482540999", "bodyText": "done", "author": "nollymar", "createdAt": "2020-09-02T22:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3NDY2MA=="}], "type": "inlineReview"}, {"oid": "bfd22e09d4e0a6d5ef04032d781ae8f4524de09b", "url": "https://github.com/dotCMS/core/commit/bfd22e09d4e0a6d5ef04032d781ae8f4524de09b", "message": "#18988 Applying code review suggestions", "committedDate": "2020-09-02T17:50:37Z", "type": "commit"}, {"oid": "7fc3b9d2e41b5bdf974fd89315837a5a1d1b0703", "url": "https://github.com/dotCMS/core/commit/7fc3b9d2e41b5bdf974fd89315837a5a1d1b0703", "message": "#18988 Applying code review suggestion", "committedDate": "2020-09-02T22:33:15Z", "type": "commit"}, {"oid": "ffa4ffcb0acd07d4c288d2234fc187747d95146a", "url": "https://github.com/dotCMS/core/commit/ffa4ffcb0acd07d4c288d2234fc187747d95146a", "message": "#18988 Fixing IT that was broken with my previous change", "committedDate": "2020-09-04T20:35:05Z", "type": "commit"}, {"oid": "59db67ded9276c46442fa45336efc99a767ffe7f", "url": "https://github.com/dotCMS/core/commit/59db67ded9276c46442fa45336efc99a767ffe7f", "message": "#18988 Fixing IT", "committedDate": "2020-09-04T22:48:51Z", "type": "commit"}, {"oid": "9c7dd8b91bed8c771ea66eb9291cc098ec7e3d05", "url": "https://github.com/dotCMS/core/commit/9c7dd8b91bed8c771ea66eb9291cc098ec7e3d05", "message": "#18988 Fixing IT", "committedDate": "2020-09-08T17:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NjE0OQ==", "url": "https://github.com/dotCMS/core/pull/19205#discussion_r485086149", "bodyText": "Codacy found an issue: Avoid unused imports such as 'com.dotmarketing.util.Config'", "author": "dev-dotcms", "createdAt": "2020-09-08T17:33:09Z", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelperTest.java", "diffHunk": "@@ -43,6 +43,7 @@\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.languagesmanager.model.Language;\n import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.util.Config;", "originalCommit": "9c7dd8b91bed8c771ea66eb9291cc098ec7e3d05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}