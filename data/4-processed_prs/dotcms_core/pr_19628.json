{"pr_number": 19628, "pr_title": "#19489 #19458 Unique fields and tag fields are mapped as keywords", "pr_createdAt": "2020-11-25T17:07:52Z", "pr_url": "https://github.com/dotCMS/core/pull/19628", "timeline": [{"oid": "b50f9d20ce9195a45bb01a0383db4a02c294e93e", "url": "https://github.com/dotCMS/core/commit/b50f9d20ce9195a45bb01a0383db4a02c294e93e", "message": "#19489 #19458 Unique fields and tag fields are mapped as keywords", "committedDate": "2020-11-25T17:07:19Z", "type": "commit"}, {"oid": "b83f95d1d90d38738463948c30756dab45ff3eaa", "url": "https://github.com/dotCMS/core/commit/b83f95d1d90d38738463948c30756dab45ff3eaa", "message": "#19536 Using _dotraw to validate unique and key fields", "committedDate": "2020-11-25T22:49:28Z", "type": "commit"}, {"oid": "b50f420e9f90193022098cf6eca86d99262c2af8", "url": "https://github.com/dotCMS/core/commit/b50f420e9f90193022098cf6eca86d99262c2af8", "message": "#19489 #19536 #19458 Fixing ITs and including new test cases", "committedDate": "2020-11-30T21:02:41Z", "type": "commit"}, {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "url": "https://github.com/dotCMS/core/commit/c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "message": "#19489 #19458 New test cases", "committedDate": "2020-11-30T21:47:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932556", "bodyText": "So this maps a tag field as keyword, but isn't there another part to this?  When putting a content tag field into ES, don't we have to put the tags in as an array of Strings?", "author": "wezell", "createdAt": "2020-11-30T22:02:35Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -361,20 +363,31 @@ private void addMappingForFieldIfNeeded(\n                 .of(DataTypes.BOOL, \"boolean\", DataTypes.FLOAT, \"double\", DataTypes.INTEGER,\n                         \"long\");\n         String mappingForField = null;\n-        if (field instanceof DateField || field instanceof DateTimeField\n-                || field instanceof TimeField) {\n-            mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n-            mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n-        } else if (field instanceof TextField || field instanceof TextAreaField\n-                || field instanceof WysiwygField || field instanceof RadioField\n-                || field instanceof SelectField) {\n-            if (dataTypesMap.containsKey(field.dataType())) {\n-                mappingForField = String.format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\", dataTypesMap.get(field.dataType()));\n-            } else if (!matchesExclusions(fieldVariableName)){\n-                mappingForField = \"{\\n\"\n-                        + \"\\\"type\\\":\\\"text\\\",\\n\"\n-                        + \"\\\"analyzer\\\":\\\"my_analyzer\\\"\"\n-                        + \"\\n}\";\n+\n+        if (!matchesExclusions(fieldVariableName)) {\n+            if (field instanceof DateField || field instanceof DateTimeField\n+                    || field instanceof TimeField) {\n+                mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n+                mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n+            } else if (field instanceof TextField || field instanceof TextAreaField\n+                    || field instanceof WysiwygField || field instanceof RadioField\n+                    || field instanceof SelectField || field instanceof MultiSelectField\n+                    || field instanceof TagField) {\n+\n+                if (dataTypesMap.containsKey(field.dataType())) {\n+                    mappingForField = String\n+                            .format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\",\n+                                    dataTypesMap.get(field.dataType()));\n+                } else {\n+                    if (field.unique() || field instanceof TagField) {", "originalCommit": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ5MTAzNg==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533491036", "bodyText": "@wezell it's already implemented here: https://github.com/dotCMS/core/blob/master/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java#L703-L708 . But I'll confirm with Kibana \ud83d\udc4d", "author": "nollymar", "createdAt": "2020-12-01T15:15:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1OTUxNA==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533559514", "bodyText": "I have confirmed. No additional change is needed", "author": "nollymar", "createdAt": "2020-12-01T16:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932949", "bodyText": "What if the unique field has a quote \" in its value?", "author": "wezell", "createdAt": "2020-11-30T22:03:29Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -6311,9 +6313,18 @@ else if(field.getFieldType().equals(Field.FieldType.DATE_TIME.toString())){\n \n                     buffy.append(\" +languageId:\" + contentlet.getLanguageId());\n \n-                    buffy.append(\" +\" + contentlet.getContentType().variable() + StringPool.PERIOD + field\n-                            .getVelocityVarName() + StringPool.COLON);\n-                    buffy.append(getFieldValue(contentlet, new LegacyFieldTransformer(field).from()));\n+                    buffy.append(\" +\" + contentlet.getContentType().variable()).append(StringPool.PERIOD)\n+                            .append(field.getVelocityVarName());\n+\n+                    if (isDataTypeNumber){\n+                        buffy.append(StringPool.COLON).append(\"\\\"\").append(getFieldValue(contentlet,\n+                                new LegacyFieldTransformer(field).from())).append(\"\\\"\");\n+                    }else{\n+                        buffy.append(\"_dotraw\").append(StringPool.COLON).append(\"\\\"\")\n+                                .append(getFieldValue(contentlet,\n+                                        new LegacyFieldTransformer(field).from()))", "originalCommit": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ5MTI4NA==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533491284", "bodyText": "I'll do some tests", "author": "nollymar", "createdAt": "2020-12-01T15:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg0MDY4Ng==", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533840686", "bodyText": "@wezell I have fixed it. I modified the logic to use the _sha256 field to make the validation more accurate and consider special characters.\nBesides, _sha256 are now mapped as keyword", "author": "nollymar", "createdAt": "2020-12-02T01:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ=="}], "type": "inlineReview"}, {"oid": "e347ee2a00cb09a8d025a3a836fed96bac084373", "url": "https://github.com/dotCMS/core/commit/e347ee2a00cb09a8d025a3a836fed96bac084373", "message": "#19489 Uniqueness validation should consider special characters", "committedDate": "2020-12-02T01:40:25Z", "type": "commit"}, {"oid": "70d481733271db9ef3cbeac98d6f32acb8252c87", "url": "https://github.com/dotCMS/core/commit/70d481733271db9ef3cbeac98d6f32acb8252c87", "message": "#19536 Uniqueness validation should consider special characters", "committedDate": "2020-12-02T01:41:59Z", "type": "commit"}, {"oid": "5adda2ac87b58f3ba06961cdca086bd9aaf54f50", "url": "https://github.com/dotCMS/core/commit/5adda2ac87b58f3ba06961cdca086bd9aaf54f50", "message": "Merge branch 'master' of https://github.com/dotCMS/core into fix-for-issues-19489-19536-19458", "committedDate": "2020-12-02T16:57:30Z", "type": "commit"}, {"oid": "eba5e953cd2f15ee1ac39c8b6fe0a02ef0cba7c5", "url": "https://github.com/dotCMS/core/commit/eba5e953cd2f15ee1ac39c8b6fe0a02ef0cba7c5", "message": "#19536 Fixing failing tests", "committedDate": "2020-12-02T17:57:10Z", "type": "commit"}]}