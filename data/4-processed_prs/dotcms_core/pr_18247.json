{"pr_number": 18247, "pr_title": "Issue 18245 monitor resource", "pr_createdAt": "2020-04-01T23:50:17Z", "pr_url": "https://github.com/dotCMS/core/pull/18247", "timeline": [{"oid": "9a83efe43a5b3c8a97835899676dc2b4c0375969", "url": "https://github.com/dotCMS/core/commit/9a83efe43a5b3c8a97835899676dc2b4c0375969", "message": "#18245 make monitor query lighter", "committedDate": "2020-04-01T23:49:16Z", "type": "commit"}, {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566", "url": "https://github.com/dotCMS/core/commit/cb55653f54650bf09e71591bffe14db1bf20d566", "message": "#18245 make monitor query lighter", "committedDate": "2020-04-01T23:49:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402351828", "bodyText": "why is not it  just do 'SELECT 1 FROM dot_cluster LIMIT 1'?, really we don't need to count, also we can do it for every data base.", "author": "freddyucv", "createdAt": "2020-04-02T14:21:42Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "originalCommit": "cb55653f54650bf09e71591bffe14db1bf20d566", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1NDk1Nw==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402354957", "bodyText": "It is as lightweight as we can make it while trying to avoid a full table scan in postgres.  The switch to using the dot_cluster table means that at most there will be 1 record in any dotCMS db which should be good enough for most other dbs.", "author": "wezell", "createdAt": "2020-04-02T14:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDU1NQ==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402394555", "bodyText": "do you think this improvement applies for others DBs as well?", "author": "nollymar", "createdAt": "2020-04-02T15:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzOTEwMA==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r403039100", "bodyText": "\"The switch to using the dot_cluster table means that at most there will be 1 record in any dotCMS db\", that is why I said that really we don't need to count", "author": "freddyucv", "createdAt": "2020-04-03T14:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNTA4NA==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r407625084", "bodyText": "A count is going to obviously be performant in a table with 1 record.  I think it is ok as is.", "author": "wezell", "createdAt": "2020-04-13T18:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjUyMg==", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402352522", "bodyText": "I think is good idea so some test here, we can test this method\n\n  \n    \n      core/dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java\n    \n    \n         Line 87\n      in\n      cb55653\n    \n    \n    \n    \n\n        \n          \n           MonitorStats getMonitorStats() throws Throwable{", "author": "freddyucv", "createdAt": "2020-04-02T14:22:37Z", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;\n+                        }\n+                        else {\n+                            return  dc.setSQL(\"SELECT count(*) as count from dot_cluster\").getInt(\"count\")>0;\n+                        }\n                     }\n                     finally{\n                         DbConnectionFactory.closeSilently();", "originalCommit": "cb55653f54650bf09e71591bffe14db1bf20d566", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}