{"pr_number": 19429, "pr_title": "Issue 19428 webdav use db to list files in a folder", "pr_createdAt": "2020-10-12T16:35:18Z", "pr_url": "https://github.com/dotCMS/core/pull/19429", "timeline": [{"oid": "cb8e0762bacf6cf724c251004053873ec7302efa", "url": "https://github.com/dotCMS/core/commit/cb8e0762bacf6cf724c251004053873ec7302efa", "message": "#19428 with tests.  gets folder contents from database.", "committedDate": "2020-10-12T16:13:20Z", "type": "commit"}, {"oid": "d5cc868bc8f968a954e86a06c42fd3ce932b11ed", "url": "https://github.com/dotCMS/core/commit/d5cc868bc8f968a954e86a06c42fd3ce932b11ed", "message": "#19428 cleaning test", "committedDate": "2020-10-12T16:16:16Z", "type": "commit"}, {"oid": "afc4a8334152d2d43096522837b349c2a9d4db0e", "url": "https://github.com/dotCMS/core/commit/afc4a8334152d2d43096522837b349c2a9d4db0e", "message": "#19428 fixing tests", "committedDate": "2020-10-12T16:24:35Z", "type": "commit"}, {"oid": "b59125df43a36bc02f3049821b3949293e797e7a", "url": "https://github.com/dotCMS/core/commit/b59125df43a36bc02f3049821b3949293e797e7a", "message": "#19428 adding another test", "committedDate": "2020-10-12T16:33:38Z", "type": "commit"}, {"oid": "d813e4c550c37c4c965afe394b74db423fb0c6de", "url": "https://github.com/dotCMS/core/commit/d813e4c550c37c4c965afe394b74db423fb0c6de", "message": "#19410 by way of #19428 set default folder structure based on parent", "committedDate": "2020-10-12T18:18:34Z", "type": "commit"}, {"oid": "2d5083e72fe0566cf573ad67c22f2c6bb7f585ca", "url": "https://github.com/dotCMS/core/commit/2d5083e72fe0566cf573ad67c22f2c6bb7f585ca", "message": "#19429 fixing test", "committedDate": "2020-10-12T21:08:56Z", "type": "commit"}, {"oid": "d97de62ca9435c90f8fa85d0c3ef8526f14d82a2", "url": "https://github.com/dotCMS/core/commit/d97de62ca9435c90f8fa85d0c3ef8526f14d82a2", "message": "#19428 fixing tests", "committedDate": "2020-10-13T01:20:52Z", "type": "commit"}, {"oid": "c1b4e0c8c0a6d10174f748e8d5eaccbc12261f5c", "url": "https://github.com/dotCMS/core/commit/c1b4e0c8c0a6d10174f748e8d5eaccbc12261f5c", "message": "Merge branch 'master' of https://github.com/dotCMS/core into issue-19428-webdav-use-db", "committedDate": "2020-10-26T20:05:15Z", "type": "commit"}, {"oid": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "url": "https://github.com/dotCMS/core/commit/a41a3704c3052d9f9f91c36185149e7c4d1daf38", "message": "Fixing Codacy suggestions", "committedDate": "2020-10-26T20:19:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2NjQ2Nw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512266467", "bodyText": "good", "author": "jdotcms", "createdAt": "2020-10-26T21:03:09Z", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentFactoryImpl.java", "diffHunk": "@@ -647,8 +648,11 @@ protected void delete(List<Contentlet> contentlets, boolean deleteIdentifier) th\n \t        for (Contentlet c : contentlets) {\n \t            if(InodeUtils.isSet(c.getInode())){\n \t                Identifier ident = APILocator.getIdentifierAPI().find(c.getIdentifier());\n-\t                String si = ident.getInode();\n-\t                if(!identsDeleted.contains(si) && si!=null && si!=\"\" ){\n+\t                if(ident==null || UtilMethods.isEmpty(ident.getId())) {\n+\t                    continue;\n+\t                }\n+\t                String si = ident.getId();\n+\t                if(!identsDeleted.contains(si)){", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2NzQzMQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512267431", "bodyText": "what happen if oldValue is null?", "author": "jdotcms", "createdAt": "2020-10-26T21:04:53Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/model/Contentlet.java", "diffHunk": "@@ -1609,16 +1611,19 @@ public ContentletHashMap() {\n \t\t\tsuper();\n \t\t}\n \n-\t\tpublic Object put(final String key, final Object value) {\n+\t\tpublic Object put(final String key, final Object newValue) {\n \n-\t\t\tContentlet.this.markAsDirty();\n+\t\t    final Object oldValue = this.get(key);", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4NTE4Mw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512285183", "bodyText": "equals will return false and the contentlet will be marked as dirty if  newValue != null:\npublic static boolean equals(Object a, Object b) {\n        return (a == b) || (a != null && a.equals(b));\n    }\n\nOtherwise, the key will be removed.", "author": "nollymar", "createdAt": "2020-10-26T21:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2NzQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2ODM5NQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512268395", "bodyText": "Good", "author": "jdotcms", "createdAt": "2020-10-26T21:06:45Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPI.java", "diffHunk": "@@ -362,5 +362,22 @@\n \t * @throws DotDataException\n \t * @throws DotSecurityException\n \t */\n-  FileAsset find(String inode, User user, boolean respectFrontendRoles) throws DotDataException, DotSecurityException;\n+\tFileAsset find(String inode, User user, boolean respectFrontendRoles) throws DotDataException, DotSecurityException;\n+\n+\n+    \n+    /**\n+     * Takes a {@link FileAssetSearcher} searcher object and returns fileAssets based on it. You can build a new\n+     * searcher using a builder , e.g.\n+     * FileAssetSearcher searcher = FileAssetSearcher.builder()\n+     * .folder(parent)\n+     * .user(user)\n+     * .respectFrontendRoles(true)\n+     * .build()\n+     * \n+     * @param searcher\n+     * @return\n+     */\n+    List<FileAsset> findFileAssetsByDB(FileAssetSearcher searcher);", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODk1NA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512288954", "bodyText": "remove this annotation", "author": "jdotcms", "createdAt": "2020-10-26T21:46:54Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryImpl.java", "diffHunk": "@@ -35,45 +32,59 @@ public FileAssetFactoryImpl() {\n         permissionAPI = APILocator.getPermissionAPI();\n     }\n \n-    @Override\n-    public List<Contentlet> findFileAssetsByFolderInDB(\n-            final Folder parentFolder,\n-            final  User user,\n-            final boolean live) throws DotDataException, DotSecurityException {\n-\n-        final boolean respectFrontendRoles = live;\n+    \n+    /**\n+     * takes a list of inodes and returns the list of contentlets - includes permissions check\n+     * \n+     * @param identifiers\n+     * @param user\n+     * @param respectFrontendRoles\n+     * @return\n+     */\n \n-        if(!permissionAPI.doesUserHavePermission(parentFolder, PermissionAPI.PERMISSION_READ, user, respectFrontendRoles)){\n-            throw new DotSecurityException(\"User:\" + user.getUserId() + \" does not have permissions on Folder \" + parentFolder);\n-        }\n+    @NotNull", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYyNjMyNw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513626327", "bodyText": "Done", "author": "nollymar", "createdAt": "2020-10-28T17:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4OTgwMw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512289803", "bodyText": "StringPool already has SLASH, feel free to add DOUBLE_SLASH", "author": "jdotcms", "createdAt": "2020-10-26T21:48:54Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/folders/business/FolderFactoryImpl.java", "diffHunk": "@@ -219,6 +220,8 @@ protected Folder findFolderByPath(String path, final Host site) throws DotDataEx\n \t\tif(site == null || path == null){\n \t\t\treturn null;\n \t\t}\n+\t\t// replace nasty double //\n+\t\tpath=path.replaceAll(\"//\", \"/\");", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYyMzY5OA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513623698", "bodyText": "Done", "author": "nollymar", "createdAt": "2020-10-28T17:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4OTgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MDQ1Mg==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r512290452", "bodyText": "cool, but I would double check this assumption in terms of the content search or site browser if the state is the expected when using /live", "author": "jdotcms", "createdAt": "2020-10-26T21:50:14Z", "path": "dotCMS/src/main/java/com/dotmarketing/webdav/DotWebdavHelper.java", "diffHunk": "@@ -905,8 +906,10 @@ private Contentlet runWorkflowIfPossible(final String resourceUri, final User us\n \t\t\t\t\t\t\t\t\t\t\t final boolean disableWorkflow, final Contentlet fileAsset)\n \t\t\tthrows DotDataException, DotSecurityException {\n \n-\t\tfileAsset.setIndexPolicy(IndexPolicy.WAIT_FOR);\n-\t\tfileAsset.getMap().put(Contentlet.VALIDATE_EMPTY_FILE, false);\n+\t    // We can use defer because we use the DB to list files / folders\n+\t\tfileAsset.setIndexPolicy(IndexPolicy.DEFER);", "originalCommit": "a41a3704c3052d9f9f91c36185149e7c4d1daf38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a8210500a050802ddf3eb80601c8954cad47ac95", "url": "https://github.com/dotCMS/core/commit/a8210500a050802ddf3eb80601c8954cad47ac95", "message": "#19428 Applying code review suggestions", "committedDate": "2020-10-28T17:23:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDIxMA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634210", "bodyText": "Codacy found an issue: Field defaultFileType has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:02Z", "path": "dotCMS/src/integration-test/java/com/dotcms/datagen/FolderDataGen.java", "diffHunk": "@@ -21,7 +21,10 @@\n     private String fileMasks = \"\";\n     private Folder parent;\n     private Host site = host;\n-\n+    private String defaultFileType = CacheLocator.getContentTypeCache()", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDIyNw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634227", "bodyText": "Codacy found an issue: Field offset has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:03Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDI0Mg==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634242", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:04Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDI1OQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634259", "bodyText": "Codacy found an issue: Unnecessary use of fully qualified name 'java.util.Objects.equals' due to existing import 'java.util.Objects'", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:05Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/model/Contentlet.java", "diffHunk": "@@ -1609,16 +1611,19 @@ public ContentletHashMap() {\n \t\t\tsuper();\n \t\t}\n \n-\t\tpublic Object put(final String key, final Object value) {\n+\t\tpublic Object put(final String key, final Object newValue) {\n \n-\t\t\tContentlet.this.markAsDirty();\n+\t\t    final Object oldValue = this.get(key);\n+\t\t    if(!java.util.Objects.equals(oldValue, newValue)) {", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDI3MA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634270", "bodyText": "Codacy found an issue: Field user has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:06Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;\n+        private int limit;\n+        private String searchTerm;\n+        private User user;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDI4Ng==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634286", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:07Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDI5OA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634298", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:08Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/folders/business/FolderAPIImpl.java", "diffHunk": "@@ -634,7 +650,9 @@ public Folder createFolders(String path, Host host, User user, boolean respectFr\n \t\t\t\tf.setSortOrder(0);\n \t\t\t\tf.setFilesMasks(\"\");\n \t\t\t\tf.setHostId(host.getIdentifier());\n-\t\t\t\tf.setDefaultFileType(CacheLocator.getContentTypeCache().getStructureByVelocityVarName(APILocator.getFileAssetAPI().DEFAULT_FILE_ASSET_STRUCTURE_VELOCITY_VAR_NAME).getInode());\n+\t\t\t\tf.setDefaultFileType((parent!=null && parent.getDefaultFileType() !=null) ", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDMxMQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634311", "bodyText": "Codacy found an issue: Field limit has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:09Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;\n+        private int limit;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDMxOQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634319", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:10Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/model/FolderTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.dotmarketing.portlets.folders.model;\n+\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+\n+public class FolderTest {\n+\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+\n+    /**\n+     * this tests that the isSystemFolder return appropiatly\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_folder_isSystemFolder() throws Exception {\n+\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assert (systemFolder.isSystemFolder());\n+\n+        // test a db persisted folder\n+        assertFalse(new FolderDataGen().nextPersisted().isSystemFolder());\n+\n+        // test an unpersisted folder\n+        Folder folder = new FolderDataGen().next();\n+        assertFalse(folder.isSystemFolder());\n+\n+\n+\n+    }\n+\n+\n+    /**\n+     * this tests the convience method of getting the host from the folder.getHost() method\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_folder_host_method() throws Exception {\n+\n+        // tests that the system folder lives on system host\n+        final Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        assert (systemFolder.getHost().equals(APILocator.systemHost()));", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDMzMg==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634332", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:11Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDM0Nw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634347", "bodyText": "Codacy found an issue: Field live has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:12Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;\n+        private int limit;\n+        private String searchTerm;\n+        private User user;\n+        private boolean respectFrontendRoles;\n+        private boolean live;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDM1OA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634358", "bodyText": "Codacy found an issue: Field searchTerm has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:13Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;\n+        private int limit;\n+        private String searchTerm;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDM2OA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634368", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:14Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/business/FolderAPITest.java", "diffHunk": "@@ -1292,4 +1292,62 @@ public void test_findFolderByPath_UserWithPermissionsOverFolderAndHost_success()\n \t\tAssert.assertEquals(folder.getOwner(), folderByPath.getOwner());\n \t}\n \n-}\n\\ No newline at end of file\n+\t\n+\t\n+    /**\n+     * this method tests that when you create a folder with a default file type and then create folders\n+     * underneith it, that the children folders inherit the parent's default file type. This is\n+     * especially used when creating folders via webdav\n+     * \n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void test_folders_inherit_the_filetypes_of_their_parents() throws DotDataException, DotSecurityException {\n+        final Host newHost = new SiteDataGen().nextPersisted();\n+        final long currentTime = System.currentTimeMillis();\n+\n+        final ContentType fileAssetType = contentTypeAPI.find(FileAssetAPI.DEFAULT_FILE_ASSET_STRUCTURE_VELOCITY_VAR_NAME);\n+        ContentType newFileAssetType = ContentTypeBuilder\n+                        .builder(fileAssetType)\n+                        .id(null)\n+                        .variable(\"fileAsset\"  + currentTime)\n+                        .name(\"fileAsset\"  + currentTime)\n+                        .build();\n+        \n+        newFileAssetType =  contentTypeAPI.save(newFileAssetType);\n+        \n+\n+        \n+        assertEquals(newFileAssetType.variable(),\"fileAsset\"  + currentTime);\n+        assert(newFileAssetType.id()!=null);\n+        \n+        final Folder parentFolder = new FolderDataGen().defaultFileType(newFileAssetType.id()).site(newHost).nextPersisted();\n+        assertEquals(parentFolder.getDefaultFileType(), newFileAssetType.id());\n+        \n+        \n+        final String folderPath = parentFolder.getPath() + \"folder1/folder2/folder3\";\n+\n+        folderAPI.createFolders(folderPath, newHost, user, false);\n+\n+        // /path/folder1\n+        Folder folder1 = folderAPI.findFolderByPath(parentFolder.getPath() + \"/folder1\", newHost, user, false);\n+        assert(folder1!=null);\n+        assertEquals(folder1.getDefaultFileType(), newFileAssetType.id());\n+        \n+        // /path/folder2\n+        Folder folder2 = folderAPI.findFolderByPath(parentFolder.getPath() + \"/folder1/folder2\", newHost, user, false);", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDM4NA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634384", "bodyText": "Codacy found an issue: assertTrue(true) or similar statements are unnecessary", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:15Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        final List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+        // we have all the working files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == fileAssetSize);\n+\n+        \n+        \n+        searcher = FileAssetSearcher.builder().live(true).user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+        \n+        \n+        // there are no live files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == 0);\n+\n+\n+        \n+        \n+        \n+    }\n+    \n+    \n+    \n+    \n+    /**\n+     * This tests that file assets saved to a folder are not readable unless the user has read permissions to the parent folder itself\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_folder_permissions()\n+            throws Exception {\n+\n+        final User user = APILocator.getUserAPI().getAnonymousUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        try {\n+            APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        }\n+        catch(DotRuntimeException e) {\n+            assertTrue(\"We should have thrown a DotRuntimeException\", e!=null);\n+            assertTrue(\"This should have a good message\", e.getMessage().contains(\"does not have permission to view the parent folder\"));\n+            return;\n+        }\n+\n+        assertTrue(\"this should have thrown a DotRuntimeException\", false);", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQwMw==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634403", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:16Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        final List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+        // we have all the working files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == fileAssetSize);\n+\n+        \n+        \n+        searcher = FileAssetSearcher.builder().live(true).user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+        \n+        \n+        // there are no live files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == 0);\n+\n+\n+        \n+        \n+        \n+    }\n+    \n+    \n+    \n+    \n+    /**\n+     * This tests that file assets saved to a folder are not readable unless the user has read permissions to the parent folder itself\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_folder_permissions()\n+            throws Exception {\n+\n+        final User user = APILocator.getUserAPI().getAnonymousUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        try {\n+            APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        }\n+        catch(DotRuntimeException e) {\n+            assertTrue(\"We should have thrown a DotRuntimeException\", e!=null);\n+            assertTrue(\"This should have a good message\", e.getMessage().contains(\"does not have permission to view the parent folder\"));\n+            return;\n+        }\n+\n+        assertTrue(\"this should have thrown a DotRuntimeException\", false);\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to the system folder, e.g. / will be returned from the database\n+     * as exepcteds\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_we_return_files_from_host_system_folder() throws Exception {", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQxNQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634415", "bodyText": "Codacy found an issue: Avoid unused imports such as 'org.jetbrains.annotations.NotNull'", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:17Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetFactoryImpl.java", "diffHunk": "@@ -3,17 +3,14 @@\n import com.dotmarketing.business.APILocator;\n import com.dotmarketing.business.PermissionAPI;\n import com.dotmarketing.common.db.DotConnect;\n-import com.dotmarketing.exception.DotDataException;\n-import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.exception.DotRuntimeException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n-import com.dotmarketing.portlets.folders.model.Folder;\n-import com.dotmarketing.util.Logger;\n import com.google.common.collect.ImmutableList;\n import com.liferay.portal.model.User;\n-import org.jetbrains.annotations.NotNull;\n-\n+import io.vavr.control.Try;\n import java.util.List;\n-import java.util.Map;\n+import java.util.stream.Collectors;\n+import org.jetbrains.annotations.NotNull;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQyNg==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634426", "bodyText": "Codacy found an issue: Avoid unused imports such as 'org.junit.Assert'", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:18Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/model/FolderTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.dotmarketing.portlets.folders.model;\n+\n+import static org.junit.Assert.*;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQzNg==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634436", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:19Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        final List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+        // we have all the working files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == fileAssetSize);\n+\n+        \n+        \n+        searcher = FileAssetSearcher.builder().live(true).user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+        \n+        \n+        // there are no live files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == 0);\n+\n+\n+        \n+        \n+        \n+    }\n+    \n+    \n+    \n+    \n+    /**\n+     * This tests that file assets saved to a folder are not readable unless the user has read permissions to the parent folder itself\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_folder_permissions()\n+            throws Exception {\n+\n+        final User user = APILocator.getUserAPI().getAnonymousUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        try {\n+            APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        }\n+        catch(DotRuntimeException e) {\n+            assertTrue(\"We should have thrown a DotRuntimeException\", e!=null);\n+            assertTrue(\"This should have a good message\", e.getMessage().contains(\"does not have permission to view the parent folder\"));\n+            return;\n+        }\n+\n+        assertTrue(\"this should have thrown a DotRuntimeException\", false);\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to the system folder, e.g. / will be returned from the database\n+     * as exepcteds\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_we_return_files_from_host_system_folder() throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize = 3;\n+\n+        for (int i = 0; i < fileAssetSize; i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+\n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user)\n+                        .host(APILocator.getHostAPI().findDefaultHost(user, false)).respectFrontendRoles(false).build();\n+\n+        List<String> assetNames = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).stream()\n+                        .map(c -> c.getFileName()).collect(Collectors.toList());\n+\n+\n+        assert (assetNames.size() > -fileAssetSize);\n+        fileNames.forEach(f -> {\n+            assert (assetNames.contains(f));", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQ1MA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634450", "bodyText": "Codacy found an issue: Field respectFrontendRoles has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:20Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;\n+        private Folder folder;\n+        private long language;\n+        private int offset;\n+        private int limit;\n+        private String searchTerm;\n+        private User user;\n+        private boolean respectFrontendRoles;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQ2NQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634465", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:21Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        final List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+        // we have all the working files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == fileAssetSize);", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQ3Ng==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634476", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:23Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/business/FolderAPITest.java", "diffHunk": "@@ -1292,4 +1292,62 @@ public void test_findFolderByPath_UserWithPermissionsOverFolderAndHost_success()\n \t\tAssert.assertEquals(folder.getOwner(), folderByPath.getOwner());\n \t}\n \n-}\n\\ No newline at end of file\n+\t\n+\t\n+    /**\n+     * this method tests that when you create a folder with a default file type and then create folders\n+     * underneith it, that the children folders inherit the parent's default file type. This is\n+     * especially used when creating folders via webdav\n+     * \n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    @Test\n+    public void test_folders_inherit_the_filetypes_of_their_parents() throws DotDataException, DotSecurityException {\n+        final Host newHost = new SiteDataGen().nextPersisted();\n+        final long currentTime = System.currentTimeMillis();\n+\n+        final ContentType fileAssetType = contentTypeAPI.find(FileAssetAPI.DEFAULT_FILE_ASSET_STRUCTURE_VELOCITY_VAR_NAME);\n+        ContentType newFileAssetType = ContentTypeBuilder\n+                        .builder(fileAssetType)\n+                        .id(null)\n+                        .variable(\"fileAsset\"  + currentTime)\n+                        .name(\"fileAsset\"  + currentTime)\n+                        .build();\n+        \n+        newFileAssetType =  contentTypeAPI.save(newFileAssetType);\n+        \n+\n+        \n+        assertEquals(newFileAssetType.variable(),\"fileAsset\"  + currentTime);\n+        assert(newFileAssetType.id()!=null);\n+        \n+        final Folder parentFolder = new FolderDataGen().defaultFileType(newFileAssetType.id()).site(newHost).nextPersisted();\n+        assertEquals(parentFolder.getDefaultFileType(), newFileAssetType.id());\n+        \n+        \n+        final String folderPath = parentFolder.getPath() + \"folder1/folder2/folder3\";\n+\n+        folderAPI.createFolders(folderPath, newHost, user, false);\n+\n+        // /path/folder1\n+        Folder folder1 = folderAPI.findFolderByPath(parentFolder.getPath() + \"/folder1\", newHost, user, false);\n+        assert(folder1!=null);\n+        assertEquals(folder1.getDefaultFileType(), newFileAssetType.id());\n+        \n+        // /path/folder2\n+        Folder folder2 = folderAPI.findFolderByPath(parentFolder.getPath() + \"/folder1/folder2\", newHost, user, false);\n+        assert(folder2!=null);\n+        assertEquals(folder2.getDefaultFileType(), newFileAssetType.id());\n+        \n+        // /path/folder3\n+        Folder folder3 = folderAPI.findFolderByPath(parentFolder.getPath() + \"/folder1/folder2/folder3\", newHost, user, false);", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDQ4OA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634488", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:24Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/model/FolderTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.dotmarketing.portlets.folders.model;\n+\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+\n+public class FolderTest {\n+\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDUwMA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634500", "bodyText": "Codacy found an issue: Use assertNull(x) instead of assertTrue(x==null), or assertNotNull(x) vs assertFalse(x==null)", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:25Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/fileassets/business/FileAssetAPITest.java", "diffHunk": "@@ -170,5 +173,161 @@ public void Test_That_File_Asset_Gets_Stored_in_Cache_and_is_Not_Rebuilt_Everyti\n       assertTrue(\"FileAssets should be the same Object\", asset3 == asset4);\n       \n     }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_works()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        List<FileAsset> assets = APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        assert(assets.size()==fileAssetSize);\n+        assets.forEach(a-> {\n+            assert(fileNames.contains(a.getFileName()));\n+        });\n+\n+    }\n+    \n+    /**\n+     * This tests that file assets saved to a random folder, e.g. /dasfasd/ will be returned from the database\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_live_working_flag()\n+            throws Exception {\n+\n+        final User user = APILocator.systemUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        final List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+        // we have all the working files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == fileAssetSize);\n+\n+        \n+        \n+        searcher = FileAssetSearcher.builder().live(true).user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+        \n+        \n+        // there are no live files\n+        assert(APILocator.getFileAssetAPI().findFileAssetsByDB(searcher).size() == 0);\n+\n+\n+        \n+        \n+        \n+    }\n+    \n+    \n+    \n+    \n+    /**\n+     * This tests that file assets saved to a folder are not readable unless the user has read permissions to the parent folder itself\n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_that_file_asset_from_db_respects_folder_permissions()\n+            throws Exception {\n+\n+        final User user = APILocator.getUserAPI().getAnonymousUser();\n+        final Folder parentFolder = new FolderDataGen().nextPersisted();\n+    \n+        List<String> fileNames = new ArrayList<>();\n+        final int fileAssetSize=3;\n+        \n+        for(int i=0;i<fileAssetSize;i++) {\n+            final java.io.File file = java.io.File.createTempFile(\"blah\" + i, \".txt\");\n+            fileNames.add(file.getName());\n+            FileUtil.write(file, \"helloworld\");\n+            final FileAssetDataGen fileAssetDataGen = new FileAssetDataGen(parentFolder, file);\n+            fileAssetDataGen.setPolicy(IndexPolicy.DEFER);\n+            fileAssetDataGen.nextPersisted();\n+        }\n+        \n+        FileAssetSearcher searcher = FileAssetSearcher.builder().user(user).folder(parentFolder).respectFrontendRoles(false).build();\n+                        \n+\n+        try {\n+            APILocator.getFileAssetAPI().findFileAssetsByDB(searcher);\n+        }\n+        catch(DotRuntimeException e) {\n+            assertTrue(\"We should have thrown a DotRuntimeException\", e!=null);", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDUwOQ==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634509", "bodyText": "Codacy found an issue: Field host has the same name as a method", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:26Z", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/business/FileAssetSearcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package com.dotmarketing.portlets.fileassets.business;\n+\n+import javax.annotation.Nonnull;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.liferay.portal.model.User;\n+import io.vavr.control.Try;\n+\n+\n+@JsonDeserialize(builder = FileAssetSearcher.Builder.class)\n+public class FileAssetSearcher {\n+\n+    final Host host;\n+    final Folder folder;\n+    final long language;\n+    final int offset, limit;\n+    final String searchTerm;\n+    final User user;\n+    final boolean respectFrontendRoles;\n+    final boolean live;\n+    private FileAssetSearcher(Builder builder) {\n+\n+        \n+        this.host = builder.host ;\n+        this.folder = builder.folder;\n+        this.language = builder.language;\n+        this.offset = builder.offset;\n+        this.limit = builder.limit;\n+        this.searchTerm = builder.searchTerm;\n+        this.user = builder.user;\n+        this.respectFrontendRoles = builder.respectFrontendRoles;\n+        this.live=builder.live;\n+    }\n+    /**\n+     * Creates builder to build {@link FileAssetSearcher}.\n+     * @return created builder\n+     */\n+    \n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+    /**\n+     * Creates a builder to build {@link FileAssetSearcher} and initialize it with the given object.\n+     * @param fileAssetSearcher to initialize the builder with\n+     * @return created builder\n+     */\n+    \n+    public static Builder from(FileAssetSearcher fileAssetSearcher) {\n+        return new Builder(fileAssetSearcher);\n+    }\n+    /**\n+     * Builder to build {@link FileAssetSearcher}.\n+     */\n+    \n+    public static final class Builder {\n+        private Host host;", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYzNDUyMA==", "url": "https://github.com/dotCMS/core/pull/19429#discussion_r513634520", "bodyText": "Codacy found an issue: Useless parentheses.", "author": "dev-dotcms", "createdAt": "2020-10-28T17:32:27Z", "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/folders/model/FolderTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.dotmarketing.portlets.folders.model;\n+\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+\n+public class FolderTest {\n+\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+\n+    /**\n+     * this tests that the isSystemFolder return appropiatly\n+     * \n+     * @throws Exception\n+     */\n+    @Test\n+    public void test_folder_isSystemFolder() throws Exception {\n+\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assert (systemFolder.isSystemFolder());", "originalCommit": "a8210500a050802ddf3eb80601c8954cad47ac95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}