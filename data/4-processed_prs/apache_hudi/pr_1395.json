{"pr_number": 1395, "pr_title": "[HUDI-667] Fixing delete tests for DeltaStreamer", "pr_createdAt": "2020-03-10T23:59:59Z", "pr_url": "https://github.com/apache/hudi/pull/1395", "timeline": [{"oid": "e7d9f28dced40d6bcad84a35211fe7d2de286933", "url": "https://github.com/apache/hudi/commit/e7d9f28dced40d6bcad84a35211fe7d2de286933", "message": "Fixing delete tests for DeltaStreamer", "committedDate": "2020-03-11T05:27:05Z", "type": "commit"}, {"oid": "e7d9f28dced40d6bcad84a35211fe7d2de286933", "url": "https://github.com/apache/hudi/commit/e7d9f28dced40d6bcad84a35211fe7d2de286933", "message": "Fixing delete tests for DeltaStreamer", "committedDate": "2020-03-11T05:27:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMDkyNQ==", "url": "https://github.com/apache/hudi/pull/1395#discussion_r392120925", "bodyText": "this line is solving the use case that you pointed out in jira @prashantwason . I guess the fix is complete and good to merge.", "author": "pratyakshsharma", "createdAt": "2020-03-13T09:39:54Z", "path": "hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java", "diffHunk": "@@ -429,24 +428,24 @@ public HoodieRecord generateUpdateRecord(HoodieKey key, String commitTime) throw\n    */\n   public Stream<HoodieKey> generateUniqueDeleteStream(Integer n) {\n     final Set<KeyPartition> used = new HashSet<>();\n-\n     if (n > numExistingKeys) {\n       throw new IllegalArgumentException(\"Requested unique deletes is greater than number of available keys\");\n     }\n \n-    return IntStream.range(0, n).boxed().map(i -> {\n-      int index = numExistingKeys == 1 ? 0 : RAND.nextInt(numExistingKeys - 1);\n-      KeyPartition kp = existingKeys.get(index);\n-      // Find the available keyPartition starting from randomly chosen one.\n-      while (used.contains(kp)) {\n+    List<HoodieKey> result = new ArrayList<>();\n+    for (int i = 0; i < n; i++) {\n+      int index = RAND.nextInt(numExistingKeys);\n+      while (!existingKeys.containsKey(index)) {\n         index = (index + 1) % numExistingKeys;\n-        kp = existingKeys.get(index);\n       }\n-      existingKeys.remove(kp);\n+      KeyPartition kp = existingKeys.remove(index);\n+      existingKeys.put(index, existingKeys.get(numExistingKeys - 1));\n+      existingKeys.remove(numExistingKeys - 1);", "originalCommit": "e7d9f28dced40d6bcad84a35211fe7d2de286933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwMzMyNA==", "url": "https://github.com/apache/hudi/pull/1395#discussion_r392403324", "bodyText": "Looks good. I didnt read the fix correctly.", "author": "prashantwason", "createdAt": "2020-03-13T18:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMDkyNQ=="}], "type": "inlineReview"}]}