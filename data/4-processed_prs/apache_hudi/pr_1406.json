{"pr_number": 1406, "pr_title": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "pr_createdAt": "2020-03-15T01:59:52Z", "pr_url": "https://github.com/apache/hudi/pull/1406", "timeline": [{"oid": "dec5a88fbc287d95fc2277167ad9f44b53a00060", "url": "https://github.com/apache/hudi/commit/dec5a88fbc287d95fc2277167ad9f44b53a00060", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-16T17:35:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTgyOA==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r394069828", "bodyText": "From what I understand, and if you look at the schema generated by Hudi as well..shouldn't the record name tip also be tip_history instead ?", "author": "umehrot2", "createdAt": "2020-03-18T02:14:04Z", "path": "hudi-client/src/test/java/org/apache/hudi/common/HoodieTestDataGenerator.java", "diffHunk": "@@ -81,10 +82,12 @@\n       + \"{\\\"name\\\": \\\"end_lat\\\", \\\"type\\\": \\\"double\\\"},\" + \"{\\\"name\\\": \\\"end_lon\\\", \\\"type\\\": \\\"double\\\"},\"\n       + \"{\\\"name\\\": \\\"fare\\\",\\\"type\\\": {\\\"type\\\":\\\"record\\\", \\\"name\\\":\\\"fare\\\",\\\"fields\\\": [\"\n       + \"{\\\"name\\\": \\\"amount\\\",\\\"type\\\": \\\"double\\\"},{\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}},\"\n+      + \"{\\\"name\\\": \\\"tip_history\\\", \\\"type\\\": {\\\"type\\\": \\\"array\\\", \\\"items\\\": {\\\"type\\\": \\\"record\\\", \\\"name\\\": \\\"tip\\\", \\\"fields\\\": [\"\n+      + \"{\\\"name\\\": \\\"amount\\\", \\\"type\\\": \\\"double\\\"}, {\\\"name\\\": \\\"currency\\\", \\\"type\\\": \\\"string\\\"}]}}},\"", "originalCommit": "dec5a88fbc287d95fc2277167ad9f44b53a00060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4OTEyMA==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r395789120", "bodyText": "Right. Replaced now.", "author": "zhedoubushishi", "createdAt": "2020-03-20T17:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTkyOQ==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r394069929", "bodyText": "Might be good to add a test for Map types as well. We can be sure that we have fixed these issues once and for all, for all the major types we support. Also in future if spark-avro changes something we can immediately fix these issues.", "author": "umehrot2", "createdAt": "2020-03-18T02:14:31Z", "path": "hudi-spark/src/main/scala/org/apache/hudi/AvroConversionHelper.scala", "diffHunk": "@@ -324,7 +323,7 @@ object AvroConversionHelper {\n           avroSchema,\n           valueType,\n           structName,\n-          getNewRecordNamespace(valueType, recordNamespace, structName))\n+          recordNamespace)", "originalCommit": "dec5a88fbc287d95fc2277167ad9f44b53a00060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1NjI1Mg==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r395456252", "bodyText": "Good idea. A test case for Map is added.", "author": "zhedoubushishi", "createdAt": "2020-03-20T06:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2OTkyOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "2183ad041de499157a252873d71b23ea21348250", "url": "https://github.com/apache/hudi/commit/2183ad041de499157a252873d71b23ea21348250", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-20T05:43:12Z", "type": "commit"}, {"oid": "2183ad041de499157a252873d71b23ea21348250", "url": "https://github.com/apache/hudi/commit/2183ad041de499157a252873d71b23ea21348250", "message": "[HUDI-713] Fix conversion of Spark array of struct type to Avro schema", "committedDate": "2020-03-20T05:43:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0ODIxMw==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r396148213", "bodyText": "nit: recordNameSpace.size() == 0 ?", "author": "vinothchandar", "createdAt": "2020-03-22T22:23:33Z", "path": "hudi-spark/src/main/scala/org/apache/hudi/AvroConversionHelper.scala", "diffHunk": "@@ -338,12 +337,13 @@ object AvroConversionHelper {\n         }\n       case structType: StructType =>\n         val schema: Schema = SchemaConverters.toAvroType(structType, nullable = false, structName, recordNamespace)\n+        val childNameSpace = if (recordNamespace != \"\") s\"$recordNamespace.$structName\" else structName", "originalCommit": "2183ad041de499157a252873d71b23ea21348250", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MTY5MA==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r397341690", "bodyText": "This line is directly copied from: https://github.com/apache/spark/blob/master/external/avro/src/main/scala/org/apache/spark/sql/avro/SchemaConverters.scala#L175\nDo you still want me to change it?", "author": "zhedoubushishi", "createdAt": "2020-03-24T17:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0ODIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzNzcyOQ==", "url": "https://github.com/apache/hudi/pull/1406#discussion_r400537729", "bodyText": "I mean its a nit.. not sure if the line being in spark would change how feel about it.. but again its a nit, happy to let this be this way :)", "author": "vinothchandar", "createdAt": "2020-03-30T22:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0ODIxMw=="}], "type": "inlineReview"}]}