{"pr_number": 1473, "pr_title": "[HUDI-568] Improve unit test coverage", "pr_createdAt": "2020-03-31T22:26:43Z", "pr_url": "https://github.com/apache/hudi/pull/1473", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTI3Nw==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r401955277", "bodyText": "What if getRocksDB is called repetitively ? It should not init() every time, do we plan to add a different check in init to allow for better code coverage ?", "author": "n3nash", "createdAt": "2020-04-01T22:50:11Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/collection/RocksDBDAO.java", "diffHunk": "@@ -75,9 +75,6 @@ public RocksDBDAO(String basePath, String rocksDBBasePath) {\n    * Create RocksDB if not initialized.\n    */\n   private RocksDB getRocksDB() {\n-    if (null == rocksDB) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ0NTQxMg==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r402445412", "bodyText": "i looked at the entire code. it seems like init()  gets called from the only constructor in this class. so there will never be a case where rocksDB == null. this code seemed redundant and was never going to get called. that's why removed it. without this code, we are just going to return the rocksDB instance everytime without checking. Also checked the code and there is no where the variable is being set to null", "author": "ramachandranms", "createdAt": "2020-04-02T16:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE4OTM3Mg==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r403189372", "bodyText": "sounds good, thanks for the explanation", "author": "n3nash", "createdAt": "2020-04-03T17:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNDI1NQ==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r405804255", "bodyText": "refactored the code as you requested. lmk if this can be merged. thanks", "author": "ramachandranms", "createdAt": "2020-04-08T20:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTY2MQ==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r401955661", "bodyText": "can we make this log ? if there is already an assert, this might not be needed", "author": "n3nash", "createdAt": "2020-04-01T22:51:15Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/util/collection/TestRocksDBManager.java", "diffHunk": "@@ -99,25 +104,119 @@ public void testRocksDBManager() {\n         List<Pair<String, Payload>> gotPayloads =\n             dbManager.<Payload>prefixSearch(family, prefix).collect(Collectors.toList());\n         Integer expCount = countsMap.get(family).get(prefix);\n+        System.out.printf(\"%s,%s: %d, %d\\n\", prefix, family, expCount == null ? 0L : expCount.longValue(), gotPayloads.size());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2NjE1NQ==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r403266155", "bodyText": "this was just a debug statement. so removed it", "author": "ramachandranms", "createdAt": "2020-04-03T19:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1ODk4MA==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r401958980", "bodyText": "Can you add comments for each of the tests you have added to explain what you are trying to test here ? Especially with the mock, it is unclear to a new reader", "author": "n3nash", "createdAt": "2020-04-01T23:00:14Z", "path": "hudi-hadoop-mr/src/test/java/org/apache/hudi/hadoop/realtime/TestHoodieRealtimeFileSplit.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.hadoop.realtime;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.mapred.FileSplit;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.InOrder;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.AdditionalMatchers.aryEq;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyByte;\n+import static org.mockito.Matchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.inOrder;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.when;\n+\n+public class TestHoodieRealtimeFileSplit {\n+\n+  private HoodieRealtimeFileSplit split;\n+  private String basePath = \"/tmp\";\n+  private List<String> deltaLogPaths = Collections.singletonList(\"/tmp/1.log\");\n+  private FileSplit baseFileSplit = new FileSplit(new Path(\"/tmp\", \"test.file\"), 0, 100, new String[]{});\n+  private String maxCommitTime = \"10001\";\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    split = new HoodieRealtimeFileSplit(baseFileSplit, basePath, deltaLogPaths, maxCommitTime);\n+  }\n+\n+  @Test\n+  public void write() throws IOException {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2MDMwNg==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r402460306", "bodyText": "added comments", "author": "ramachandranms", "createdAt": "2020-04-02T16:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1ODk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTk5Mg==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r401959992", "bodyText": "Take a look at https://github.com/apache/incubator-hudi/blob/master/hudi-common/src/test/java/org/apache/hudi/common/HoodieCommonTestHarness.java#L48 to better initialize things like basePath and other variables that you intend to use throughout the execution of the test", "author": "n3nash", "createdAt": "2020-04-01T23:03:15Z", "path": "hudi-hadoop-mr/src/test/java/org/apache/hudi/hadoop/realtime/TestHoodieRealtimeFileSplit.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.hadoop.realtime;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.mapred.FileSplit;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.InOrder;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.AdditionalMatchers.aryEq;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyByte;\n+import static org.mockito.Matchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.inOrder;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.when;\n+\n+public class TestHoodieRealtimeFileSplit {\n+\n+  private HoodieRealtimeFileSplit split;\n+  private String basePath = \"/tmp\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ0OTM0Nw==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r402449347", "bodyText": "this is a pure unit test and everything that happens is within the context of this class. all the variables used here are just dummy paths. since i am doing checks on the length of data written down the call stack, it will be hard to validate things if we use temporary folder names given by the testing framework.", "author": "ramachandranms", "createdAt": "2020-04-02T16:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE5MDYxMg==", "url": "https://github.com/apache/hudi/pull/1473#discussion_r403190612", "bodyText": "The path is something you can keep in a temporary variable in a @BeforeClass or @before, it's best to use that or if you prefer use the TemporaryFolder from junit -> would like to avoid hard-coded temp paths used for testing", "author": "n3nash", "createdAt": "2020-04-03T17:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTk5Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "6e8e0b6292a396e7276e268118de050feda9e0d5", "url": "https://github.com/apache/hudi/commit/6e8e0b6292a396e7276e268118de050feda9e0d5", "message": "[HUDI-568] Improve unit test coverage\n\nClasses improved:\n* HoodieTableMetaClient\n* RocksDBDAO\n* HoodieRealtimeFileSplit", "committedDate": "2020-04-08T19:55:04Z", "type": "commit"}, {"oid": "6e8e0b6292a396e7276e268118de050feda9e0d5", "url": "https://github.com/apache/hudi/commit/6e8e0b6292a396e7276e268118de050feda9e0d5", "message": "[HUDI-568] Improve unit test coverage\n\nClasses improved:\n* HoodieTableMetaClient\n* RocksDBDAO\n* HoodieRealtimeFileSplit", "committedDate": "2020-04-08T19:55:04Z", "type": "forcePushed"}]}