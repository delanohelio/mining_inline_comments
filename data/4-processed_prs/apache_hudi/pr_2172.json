{"pr_number": 2172, "pr_title": "[HUDI-1338] Adding Delete support to test suite framework", "pr_createdAt": "2020-10-11T14:12:12Z", "pr_url": "https://github.com/apache/hudi/pull/2172", "timeline": [{"oid": "8832628562139b75906c9cff38edecac215b1669", "url": "https://github.com/apache/hudi/commit/8832628562139b75906c9cff38edecac215b1669", "message": "Adding Delete support to test suite", "committedDate": "2020-10-11T14:12:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzQ4Mw==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707483", "bodyText": "Is this prod needed ? Also the naming should start from prop1 ?", "author": "n3nash", "createdAt": "2020-10-26T03:53:12Z", "path": "docker/demo/config/test-suite/complex-dag-cow.yaml", "diffHunk": "@@ -93,3 +93,50 @@ second_hive_query:\n       result2: 11900\n   type: HiveQueryNode\n   deps: second_upsert\n+fourth_insert:\n+  config:\n+    record_size: 70000\n+    num_insert_partitions: 1\n+    repeat_count: 1\n+    num_records_insert: 1000\n+  deps: second_hive_query\n+  type: InsertNode\n+third_hive_query:\n+  config:\n+    hive_props:\n+      prop2: \"set spark.yarn.queue=\"", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzUyMQ==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707521", "bodyText": "same here", "author": "n3nash", "createdAt": "2020-10-26T03:53:26Z", "path": "docker/demo/config/test-suite/complex-dag-cow.yaml", "diffHunk": "@@ -93,3 +93,50 @@ second_hive_query:\n       result2: 11900\n   type: HiveQueryNode\n   deps: second_upsert\n+fourth_insert:\n+  config:\n+    record_size: 70000\n+    num_insert_partitions: 1\n+    repeat_count: 1\n+    num_records_insert: 1000\n+  deps: second_hive_query\n+  type: InsertNode\n+third_hive_query:\n+  config:\n+    hive_props:\n+      prop2: \"set spark.yarn.queue=\"\n+      prop3: \"set hive.strict.checks.large.query=false\"\n+      prop4: \"set hive.stats.autogather=false\"\n+    hive_queries:\n+      query1: \"select count(*) from testdb.table1 group by `_row_key` having count(*) > 1\"\n+      result1: 0\n+      query2: \"select count(*) from testdb.table1\"\n+      result2: 12900\n+  type: HiveQueryNode\n+  deps: fourth_insert\n+first_delete:\n+  config:\n+    record_size: 70000\n+    num_partitions_delete: 1\n+    num_records_delete: 200\n+  deps: third_hive_query\n+  type: DeleteNode\n+fourth_hive_sync:\n+  config:\n+    queue_name: \"adhoc\"\n+    engine: \"mr\"\n+  type: HiveSyncNode\n+  deps: first_delete\n+fourth_hive_query:\n+  config:\n+    hive_props:\n+      prop2: \"set spark.yarn.queue=\"", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzYzMw==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707633", "bodyText": "What does default value \"1\" mean in this case ?", "author": "n3nash", "createdAt": "2020-10-26T03:54:10Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/configuration/DeltaConfig.java", "diffHunk": "@@ -118,6 +125,10 @@ public int getNumUpsertPartitions() {\n       return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_UPSERT, 0).toString());\n     }\n \n+    public int getNumDeletePartitions() {\n+      return Integer.valueOf(configsMap.getOrDefault(NUM_PARTITIONS_DELETE, 1).toString());", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzc4Mg==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511707782", "bodyText": "Nit: revert whitespace changes", "author": "n3nash", "createdAt": "2020-10-26T03:55:00Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/dag/nodes/UpsertNode.java", "diffHunk": "@@ -23,6 +23,7 @@\n import org.apache.hudi.integ.testsuite.HoodieTestSuiteWriter;\n import org.apache.hudi.integ.testsuite.configuration.DeltaConfig.Config;\n import org.apache.hudi.integ.testsuite.generator.DeltaGenerator;\n+", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODM1NA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708354", "bodyText": "Should this be renamed from adjustedRDD to something else ?", "author": "n3nash", "createdAt": "2020-10-26T03:57:52Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/DeltaGenerator.java", "diffHunk": "@@ -155,6 +156,42 @@ public DeltaGenerator(DeltaConfig deltaOutputConfig, JavaSparkContext jsc, Spark\n     }\n   }\n \n+  public JavaRDD<GenericRecord> generateDeletes(Config config) throws IOException {\n+    if (deltaOutputConfig.getDeltaOutputMode() == DeltaOutputMode.DFS) {\n+      DeltaInputReader deltaInputReader = null;\n+      JavaRDD<GenericRecord> adjustedRDD = null;\n+\n+      if (config.getNumDeletePartitions() < 1) {\n+        // randomly generate deletes for a given number of records without regard to partitions and files\n+        deltaInputReader = new DFSAvroDeltaInputReader(sparkSession, schemaStr,\n+            ((DFSDeltaConfig) deltaOutputConfig).getDeltaBasePath(), Option.empty(), Option.empty());\n+        adjustedRDD = deltaInputReader.read(config.getNumRecordsDelete());", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODQyMg==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708422", "bodyText": "Ohh I see, you are trying to reduce number of variables used...", "author": "n3nash", "createdAt": "2020-10-26T03:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwODkxNA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511708914", "bodyText": "Make this an inline else-if ?", "author": "n3nash", "createdAt": "2020-10-26T04:00:52Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/generator/GenericRecordFullPayloadGenerator.java", "diffHunk": "@@ -130,43 +132,60 @@ public GenericRecord getUpdatePayload(GenericRecord record, List<String> blackli\n   }\n \n   /**\n-   * Create a new {@link GenericRecord} with random values. Not all the fields have value, it is random, and its value\n-   * is random too.\n+   * Create a new {@link GenericRecord} with random values. Not all the fields have value, it is random, and its value is random too.\n    *\n    * @param schema Schema to create with.\n    * @return A {@link GenericRecord} with random value.\n    */\n   protected GenericRecord convertPartial(Schema schema) {\n     GenericRecord result = new GenericData.Record(schema);\n     for (Schema.Field f : schema.getFields()) {\n-      boolean setNull = random.nextBoolean();\n-      if (!setNull) {\n-        result.put(f.name(), typeConvert(f));\n+      if (f.name().equals(DEFAULT_HOODIE_IS_DELETED_COL)) {\n+        result.put(f.name(), false);\n       } else {\n-        result.put(f.name(), null);\n+        boolean setNull = random.nextBoolean();\n+        if (!setNull) {\n+          result.put(f.name(), typeConvert(f));\n+        } else {\n+          result.put(f.name(), null);\n+        }\n       }\n     }\n     // TODO : pack remaining bytes into a complex field\n     return result;\n   }\n \n   /**\n-   * Set random value to {@link GenericRecord} according to the schema type of field.\n-   * The field in blacklist will not be set.\n+   * Set random value to {@link GenericRecord} according to the schema type of field. The field in blacklist will not be set.\n    *\n-   * @param record          GenericRecord to randomize.\n+   * @param record GenericRecord to randomize.\n    * @param blacklistFields blacklistFields where the filed will not be randomized.\n    * @return Randomized GenericRecord.\n    */\n   protected GenericRecord randomize(GenericRecord record, List<String> blacklistFields) {\n     for (Schema.Field f : record.getSchema().getFields()) {\n-      if (blacklistFields == null || !blacklistFields.contains(f.name())) {\n-        record.put(f.name(), typeConvert(f));\n+      if (f.name().equals(DEFAULT_HOODIE_IS_DELETED_COL)) {\n+        record.put(f.name(), false);\n+      } else {", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwOTEzNA==", "url": "https://github.com/apache/hudi/pull/2172#discussion_r511709134", "bodyText": "Should these be uncommented or removed ?", "author": "n3nash", "createdAt": "2020-10-26T04:02:07Z", "path": "hudi-integ-test/src/main/java/org/apache/hudi/integ/testsuite/writer/DFSDeltaWriterAdapter.java", "diffHunk": "@@ -40,10 +40,12 @@ public DFSDeltaWriterAdapter(DeltaInputWriter<GenericRecord> deltaInputGenerator\n   @Override\n   public List<DeltaWriteStats> write(Iterator<GenericRecord> input) throws IOException {\n     while (input.hasNext()) {\n+      //GenericRecord next = input.next();", "originalCommit": "8832628562139b75906c9cff38edecac215b1669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bede6f88f1964b87a68bf18babb7348d6ba4f614", "url": "https://github.com/apache/hudi/commit/bede6f88f1964b87a68bf18babb7348d6ba4f614", "message": "Addressing feedback", "committedDate": "2020-10-29T03:32:38Z", "type": "forcePushed"}, {"oid": "9d59ffd065756417474337ae24d9c4c886b057f9", "url": "https://github.com/apache/hudi/commit/9d59ffd065756417474337ae24d9c4c886b057f9", "message": "trigger rebuild", "committedDate": "2020-10-30T13:07:01Z", "type": "commit"}, {"oid": "e7e5c71d9446a63ec7c354e6f38d9e8df7718d2f", "url": "https://github.com/apache/hudi/commit/e7e5c71d9446a63ec7c354e6f38d9e8df7718d2f", "message": "[HUDI-1156] Remove unused dependencies from HoodieDeltaStreamerWrapper Class (#1927)", "committedDate": "2020-10-30T13:07:01Z", "type": "commit"}, {"oid": "86fe78daba7e80e82a0ce0b7af6179ffbb4383ef", "url": "https://github.com/apache/hudi/commit/86fe78daba7e80e82a0ce0b7af6179ffbb4383ef", "message": "Adding Delete support to test suite", "committedDate": "2020-10-30T13:17:54Z", "type": "commit"}, {"oid": "cc65d9502c6fcba59be7c20e7ac495ea2dcf02dc", "url": "https://github.com/apache/hudi/commit/cc65d9502c6fcba59be7c20e7ac495ea2dcf02dc", "message": "Addressing feedback", "committedDate": "2020-10-30T13:17:59Z", "type": "commit"}, {"oid": "7b8d2bcfd62a80df39ef84ea8235bc5831781838", "url": "https://github.com/apache/hudi/commit/7b8d2bcfd62a80df39ef84ea8235bc5831781838", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T13:18:29Z", "type": "forcePushed"}, {"oid": "9f24856b379b371c882e215c9fabd0992d126652", "url": "https://github.com/apache/hudi/commit/9f24856b379b371c882e215c9fabd0992d126652", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T18:37:22Z", "type": "commit"}, {"oid": "9f24856b379b371c882e215c9fabd0992d126652", "url": "https://github.com/apache/hudi/commit/9f24856b379b371c882e215c9fabd0992d126652", "message": "Fixing test.properties instructions in README", "committedDate": "2020-10-30T18:37:22Z", "type": "forcePushed"}]}