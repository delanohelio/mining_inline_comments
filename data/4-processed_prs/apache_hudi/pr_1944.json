{"pr_number": 1944, "pr_title": "[HUDI-1174] Changes for bootstrapped tables to work with presto", "pr_createdAt": "2020-08-10T22:48:46Z", "pr_url": "https://github.com/apache/hudi/pull/1944", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzI3NQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468693275", "bodyText": "why are we bundling guava?  we can just use presto's guava classes right?", "author": "vinothchandar", "createdAt": "2020-08-11T16:02:53Z", "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -159,5 +172,24 @@\n       <artifactId>avro</artifactId>\n       <scope>compile</scope>\n     </dependency>\n+\n+    <dependency>", "originalCommit": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc5Nzc5OQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468797799", "bodyText": "I remember its due a conflict between the version hbase needs vs what presto has. Most of the issues are coming in because of trying to package hbase and make it work through presto.", "author": "umehrot2", "createdAt": "2020-08-11T18:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxODU2NQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468818565", "bodyText": "Here is the stack trace why we need to shade guava:\njava.lang.NoSuchMethodError: com.google.common.base.Objects.toStringHelper(Ljava/lang/Object;)Lcom/google/common/base/Objects$ToStringHelper;\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.LruBlockCache.toString(LruBlockCache.java:704)\n\tat java.lang.String.valueOf(String.java:2994)\n\tat java.lang.StringBuilder.append(StringBuilder.java:131)\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.CacheConfig.toString(CacheConfig.java:502)\n\tat java.lang.String.valueOf(String.java:2994)\n\tat java.lang.StringBuilder.append(StringBuilder.java:131)\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.CacheConfig.<init>(CacheConfig.java:260)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.createReader(HFileBootstrapIndex.java:181)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.access$400(HFileBootstrapIndex.java:76)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.partitionIndexReader(HFileBootstrapIndex.java:272)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.fetchBootstrapIndexInfo(HFileBootstrapIndex.java:262)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.initIndexInfo(HFileBootstrapIndex.java:252)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.<init>(HFileBootstrapIndex.java:243)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.createReader(HFileBootstrapIndex.java:191)\n\tat org.apache.hudi.common.table.view.AbstractTableFileSystemView.lambda$addFilesToView$2(AbstractTableFileSystemView.java:128)\n\tat java.util.HashMap.forEach(HashMap.java:1289)\n\tat org.apache.hudi.common.table.view.AbstractTableFileSystemView.addFilesToView(AbstractTableFileSystemView.java:125)\n\tat org.apache.hudi.common.table.view.HoodieTableFileSystemView.<init>(HoodieTableFileSystemView.java:131)\n\tat org.apache.hudi.hadoop.utils.HoodieInputFormatUtils.filterFileStatusForSnapshotMode(HoodieInputFormatUtils.java:376)\n\tat org.apache.hudi.hadoop.HoodieParquetInputFormat.listStatus(HoodieParquetInputFormat.java:119)\n\tat org.apache.hadoop.mapred.FileInputFormat.getSplits(FileInputFormat.java:288)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.loadPartition(BackgroundHiveSplitLoader.java:370)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.loadSplits(BackgroundHiveSplitLoader.java:263)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.access$300(BackgroundHiveSplitLoader.java:95)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader$HiveSplitLoaderTask.process(BackgroundHiveSplitLoader.java:192)\n\tat com.facebook.presto.hive.util.ResumableTasks.safeProcessTask(ResumableTasks.java:47)\n\tat com.facebook.presto.hive.util.ResumableTasks.access$000(ResumableTasks.java:20)\n\tat com.facebook.presto.hive.util.ResumableTasks$1.run(ResumableTasks.java:35)\n\tat com.facebook.airlift.concurrent.BoundedExecutor.drainQueue(BoundedExecutor.java:78)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n\nThis happens because hbase 1.2.3 needs guava 12.0.1 whereas presto is on guava 26.0.", "author": "umehrot2", "createdAt": "2020-08-11T19:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3MzQyNQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468873425", "bodyText": "ah. did not realize that we live in this world now. yeah makes sense. is hbase 2.x not happening? anyways, we need to shade guava.", "author": "vinothchandar", "createdAt": "2020-08-11T21:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NjM4Mg==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468696382", "bodyText": "Is this specific to Parquet or Hive in general. If this is specific to Parquet, can you move it to ParquetUtils ?", "author": "bvaradar", "createdAt": "2020-08-11T16:07:42Z", "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/utils/HoodieHiveUtils.java", "diffHunk": "@@ -38,6 +40,9 @@\n   public static final String HOODIE_CONSUME_MODE_PATTERN = \"hoodie.%s.consume.mode\";\n   public static final String HOODIE_START_COMMIT_PATTERN = \"hoodie.%s.consume.start.timestamp\";\n   public static final String HOODIE_MAX_COMMIT_PATTERN = \"hoodie.%s.consume.max.commits\";\n+  public static final Set<String> VIRTUAL_COLUMN_NAMES = CollectionUtils.createImmutableSet(", "originalCommit": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4MzE3MQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468783171", "bodyText": "This is a concept of Hive metadata, and not specific to parquet.", "author": "umehrot2", "createdAt": "2020-08-11T18:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NjM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMjA2MQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468702061", "bodyText": "@umehrot2  Are these jars not provided by Presto runtime itself ? Version mismatch with guava had been a regular issue earlier but I see that you have shaded them.\nPlease also check the licensing of the new dependencies. Are they Apache ?", "author": "bvaradar", "createdAt": "2020-08-11T16:16:31Z", "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -76,7 +76,12 @@\n                   <include>org.apache.hbase:hbase-common</include>\n                   <include>org.apache.hbase:hbase-protocol</include>\n                   <include>org.apache.hbase:hbase-server</include>\n+                  <include>org.apache.hbase:hbase-annotations</include>\n                   <include>org.apache.htrace:htrace-core</include>\n+                  <include>com.yammer.metrics:metrics-core</include>\n+                  <include>com.google.guava:guava</include>", "originalCommit": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMzY2MA==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468723660", "bodyText": "Unless, there is a strong reason, we should avoid bundling it.", "author": "bvaradar", "createdAt": "2020-08-11T16:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMjA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc5NzA3Ng==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468797076", "bodyText": "These dependencies are fixes for runtime issues. guava is there is the class-path but there is a runtime mismatch. The main problem is coming in due to hbase dependencies, and they conflict with the presto versions. Let me try to provide the stack traces if that helps.\nAbout the licensing:\n\nhttps://mvnrepository.com/artifact/com.yammer.metrics/metrics-core\nhttps://mvnrepository.com/artifact/com.google.guava/guava\nhttps://mvnrepository.com/artifact/commons-lang/commons-lang\nhttps://mvnrepository.com/artifact/com.google.protobuf/protobuf-java => this seems to be BSD License. So is this going to be an issue ?", "author": "umehrot2", "createdAt": "2020-08-11T18:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMjA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxOTYyNQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468819625", "bodyText": "Stack trace why we need guava shading:\njava.lang.NoSuchMethodError: com.google.common.base.Objects.toStringHelper(Ljava/lang/Object;)Lcom/google/common/base/Objects$ToStringHelper;\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.LruBlockCache.toString(LruBlockCache.java:704)\n\tat java.lang.String.valueOf(String.java:2994)\n\tat java.lang.StringBuilder.append(StringBuilder.java:131)\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.CacheConfig.toString(CacheConfig.java:502)\n\tat java.lang.String.valueOf(String.java:2994)\n\tat java.lang.StringBuilder.append(StringBuilder.java:131)\n\tat org.apache.hudi.org.apache.hadoop.hbase.io.hfile.CacheConfig.<init>(CacheConfig.java:260)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.createReader(HFileBootstrapIndex.java:181)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.access$400(HFileBootstrapIndex.java:76)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.partitionIndexReader(HFileBootstrapIndex.java:272)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.fetchBootstrapIndexInfo(HFileBootstrapIndex.java:262)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.initIndexInfo(HFileBootstrapIndex.java:252)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex$HFileBootstrapIndexReader.<init>(HFileBootstrapIndex.java:243)\n\tat org.apache.hudi.common.bootstrap.index.HFileBootstrapIndex.createReader(HFileBootstrapIndex.java:191)\n\tat org.apache.hudi.common.table.view.AbstractTableFileSystemView.lambda$addFilesToView$2(AbstractTableFileSystemView.java:128)\n\tat java.util.HashMap.forEach(HashMap.java:1289)\n\tat org.apache.hudi.common.table.view.AbstractTableFileSystemView.addFilesToView(AbstractTableFileSystemView.java:125)\n\tat org.apache.hudi.common.table.view.HoodieTableFileSystemView.<init>(HoodieTableFileSystemView.java:131)\n\tat org.apache.hudi.hadoop.utils.HoodieInputFormatUtils.filterFileStatusForSnapshotMode(HoodieInputFormatUtils.java:376)\n\tat org.apache.hudi.hadoop.HoodieParquetInputFormat.listStatus(HoodieParquetInputFormat.java:119)\n\tat org.apache.hadoop.mapred.FileInputFormat.getSplits(FileInputFormat.java:288)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.loadPartition(BackgroundHiveSplitLoader.java:370)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.loadSplits(BackgroundHiveSplitLoader.java:263)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader.access$300(BackgroundHiveSplitLoader.java:95)\n\tat com.facebook.presto.hive.BackgroundHiveSplitLoader$HiveSplitLoaderTask.process(BackgroundHiveSplitLoader.java:192)\n\tat com.facebook.presto.hive.util.ResumableTasks.safeProcessTask(ResumableTasks.java:47)\n\tat com.facebook.presto.hive.util.ResumableTasks.access$000(ResumableTasks.java:20)\n\tat com.facebook.presto.hive.util.ResumableTasks$1.run(ResumableTasks.java:35)\n\tat com.facebook.airlift.concurrent.BoundedExecutor.drainQueue(BoundedExecutor.java:78)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n\nThis happens because hbase 1.2.3 needs guava 12.0.1 whereas presto is on guava 26.0.", "author": "umehrot2", "createdAt": "2020-08-11T19:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMjA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzQ3NQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468703475", "bodyText": "Can you also shade commons-lang and protobuf ?", "author": "bvaradar", "createdAt": "2020-08-11T16:18:41Z", "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -76,7 +76,12 @@\n                   <include>org.apache.hbase:hbase-common</include>\n                   <include>org.apache.hbase:hbase-protocol</include>\n                   <include>org.apache.hbase:hbase-server</include>\n+                  <include>org.apache.hbase:hbase-annotations</include>\n                   <include>org.apache.htrace:htrace-core</include>\n+                  <include>com.yammer.metrics:metrics-core</include>\n+                  <include>com.google.guava:guava</include>\n+                  <include>commons-lang:commons-lang</include>", "originalCommit": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc5OTQwMw==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468799403", "bodyText": "I think shading protobuf causes other issues. Also these dependencies were not part of presto runtime that is why I did not feel the need to shade them.", "author": "umehrot2", "createdAt": "2020-08-11T18:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc5OTc3OQ==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468799779", "bodyText": "Let me quickly try shading them again, and remember what issues I was running into.", "author": "umehrot2", "createdAt": "2020-08-11T18:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2NjAxMg==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468866012", "bodyText": "I am able to shade as well as relocate commons-lang and protobuf", "author": "umehrot2", "createdAt": "2020-08-11T21:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNDI1Nw==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468704257", "bodyText": "Is this the main change ?", "author": "bvaradar", "createdAt": "2020-08-11T16:19:53Z", "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java", "diffHunk": "@@ -63,6 +62,7 @@\n  * that does not correspond to a hoodie table then they are passed in as is (as what FileInputFormat.listStatus()\n  * would do). The JobConf could have paths from multipe Hoodie/Non-Hoodie tables\n  */\n+@UseRecordReaderFromInputFormat", "originalCommit": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4MjI0Mg==", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468782242", "bodyText": "Yes this is the main change required to integrate with presto. Rest are just fixes for the various runtime issues I ran into trying to get this working.", "author": "umehrot2", "createdAt": "2020-08-11T18:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNDI1Nw=="}], "type": "inlineReview"}, {"oid": "2a24180728b8c8a89844a50c66f4396c2389a101", "url": "https://github.com/apache/hudi/commit/2a24180728b8c8a89844a50c66f4396c2389a101", "message": "Changes for bootstrapped tables to work with presto", "committedDate": "2020-08-11T18:39:56Z", "type": "forcePushed"}, {"oid": "8fb43b696fff4dc6da842c14bfda894109d320f3", "url": "https://github.com/apache/hudi/commit/8fb43b696fff4dc6da842c14bfda894109d320f3", "message": "Changes for bootstrapped tables to work with presto", "committedDate": "2020-08-11T21:07:31Z", "type": "forcePushed"}, {"oid": "8687662fe3b041c745b536fad7e9d3d5f5b52849", "url": "https://github.com/apache/hudi/commit/8687662fe3b041c745b536fad7e9d3d5f5b52849", "message": "Changes for bootstrapped tables to work with presto", "committedDate": "2020-08-12T23:12:07Z", "type": "commit"}, {"oid": "8687662fe3b041c745b536fad7e9d3d5f5b52849", "url": "https://github.com/apache/hudi/commit/8687662fe3b041c745b536fad7e9d3d5f5b52849", "message": "Changes for bootstrapped tables to work with presto", "committedDate": "2020-08-12T23:12:07Z", "type": "forcePushed"}]}