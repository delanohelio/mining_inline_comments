{"pr_number": 1242, "pr_title": "[HUDI-544] Archived commits command code cleanup", "pr_createdAt": "2020-01-17T09:50:34Z", "pr_url": "https://github.com/apache/hudi/pull/1242", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMjM3MA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r371022370", "bodyText": "this is already overridden at the datasource and deltastreamer level.. Please revert this since it can affect all the old tables written into . ..\n@n3nash can you advise here.. only reason to not change is all the old data at uber..", "author": "vinothchandar", "createdAt": "2020-01-26T19:08:52Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTableConfig.java", "diffHunk": "@@ -68,7 +68,7 @@\n   public static final HoodieFileFormat DEFAULT_LOG_FILE_FORMAT = HoodieFileFormat.HOODIE_LOG;\n   public static final String DEFAULT_PAYLOAD_CLASS = OverwriteWithLatestAvroPayload.class.getName();\n   public static final Integer DEFAULT_TIMELINE_LAYOUT_VERSION = TimelineLayoutVersion.VERSION_0;\n-  public static final String DEFAULT_ARCHIVELOG_FOLDER = \"\";\n+  public static final String DEFAULT_ARCHIVELOG_FOLDER = \"archived\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNjE0MQ==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r371426141", "bodyText": "@vinothchandar that's correct, we don't override this and all commits archived data at Uber is written to .hoodie/.\n@hddong this change doesn't seem necessary but has serious concerns for older data written (even by other users who might not be overriding the archived folder name), could you please revert it ?", "author": "n3nash", "createdAt": "2020-01-27T19:07:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMjM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQyNzk3NQ==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r373427975", "bodyText": "If remove this option, user can not use specified path.", "author": "hmatu", "createdAt": "2020-01-31T11:08:10Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/ArchivedCommitsCommand.java", "diffHunk": "@@ -54,7 +55,6 @@\n \n   @CliCommand(value = \"show archived commit stats\", help = \"Read commits from archived files and show details\")\n   public String showArchivedCommits(\n-      @CliOption(key = {\"archiveFolderPattern\"}, help = \"Archive Folder\", unspecifiedDefaultValue = \"\") String folder,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTI1Mw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r373751253", "bodyText": "If remove this option, user can not use specified path.\n\nIMO, it is not need here, archiveFolder is stored in  .hoodie.", "author": "hddong", "createdAt": "2020-02-01T02:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQyNzk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0MDA3MA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374440070", "bodyText": "This config is here to allow for users to be able to provide a full path of the files under the archive folder and read it, lets leave it here - Btw, these commands are being reworked in this PR - #1274.", "author": "n3nash", "createdAt": "2020-02-04T02:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQyNzk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0NDY3NA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374444674", "bodyText": "If leave it there, this pr will has nothing to be commited, just enhancing #1274", "author": "hmatu", "createdAt": "2020-02-04T02:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQyNzk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQzOTMyMw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374439323", "bodyText": "I'm assuming HoodieCLI.getTableMetaClient().getArchivePath() returns the path with .hoodie ?", "author": "n3nash", "createdAt": "2020-02-04T01:58:17Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/ArchivedCommitsCommand.java", "diffHunk": "@@ -63,10 +63,7 @@ public String showArchivedCommits(\n       throws IOException {\n     System.out.println(\"===============> Showing only \" + limit + \" archived commits <===============\");\n     String basePath = HoodieCLI.getTableMetaClient().getBasePath();\n-    Path archivePath = new Path(basePath + \"/.hoodie/.commits_.archive*\");\n-    if (folder != null && !folder.isEmpty()) {\n-      archivePath = new Path(basePath + \"/.hoodie/\" + folder);\n-    }\n+    Path archivePath = new Path(HoodieCLI.getTableMetaClient().getArchivePath() + \"/.commits_.archive*\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0NTMwNw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374445307", "bodyText": "public String getArchivePath() {\n  String archiveFolder = tableConfig.getArchivelogFolder();\n  if (archiveFolder.equals(HoodieTableConfig.DEFAULT_ARCHIVELOG_FOLDER)) {\n    return getMetaPath();\n  } else {\n    return getMetaPath() + \"/\" + archiveFolder;\n  }\n}", "author": "hmatu", "createdAt": "2020-02-04T02:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQzOTMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ1MTI4MA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374451280", "bodyText": "I'm assuming HoodieCLI.getTableMetaClient().getArchivePath() returns the path with .hoodie ?\n\nYes, it read from metadata and include .hoodie.", "author": "hddong", "createdAt": "2020-02-04T02:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQzOTMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r374622575", "bodyText": "This can affect all the old tables read archives.", "author": "hmatu", "createdAt": "2020-02-04T11:42:51Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/ArchivedCommitsCommand.java", "diffHunk": "@@ -138,9 +139,11 @@ public String showCommits(\n       throws IOException {\n \n     System.out.println(\"===============> Showing only \" + limit + \" archived commits <===============\");\n-    String basePath = HoodieCLI.getTableMetaClient().getBasePath();\n+    HoodieTableMetaClient metaClient = HoodieCLI.getTableMetaClient();\n+    String basePath = metaClient.getBasePath();\n+    Path archivePath = new Path(metaClient.getArchivePath() + \"/.commits_.archive*\");\n     FileStatus[] fsStatuses =\n-        FSUtils.getFs(basePath, HoodieCLI.conf).globStatus(new Path(basePath + \"/.hoodie/.commits_.archive*\"));\n+        FSUtils.getFs(basePath, HoodieCLI.conf).globStatus(archivePath);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAzOTczNg==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r375039736", "bodyText": "archivePath = new Path(metaClient.getArchivePath() + \"/.commits_.archive*\") is equivalent of new Path(basePath + \"/.hoodie/.commits_.archive*\"). the metaClient.getArchivePath() should return basePath + \"/.hoodie\" for all old tables.\n@hmatu what concerns do you have ?", "author": "n3nash", "createdAt": "2020-02-05T03:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA3NTY2Nw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r375075667", "bodyText": "@n3nash, they are different,\none: /table/.hoodie/archived/.commits_.archive*\nanother: /table/.hoodie/.commits_archive*", "author": "hmatu", "createdAt": "2020-02-05T06:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA3NTg5Mw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r375075893", "bodyText": "The right way is add archiveFolderPattern to show archived commits command\nlike show archived commit stats dose.", "author": "hmatu", "createdAt": "2020-02-05T06:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwNjc1MA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r375606750", "bodyText": "@hmatu @n3nash  It return /table/.hoodie/.commits_archive* if old tables use DEFAULT '' and return /table/.hoodie/archived/.commits_.archive* if old tables use path archived to archive. So it will return the correct path with archive path stored in .hoodie.\nOn the other hand\uff0carchiveFolderPattern allow for users to be able to provide a full path of the files under the archive folder and read it.", "author": "hddong", "createdAt": "2020-02-06T02:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1NzkwOQ==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r375657909", "bodyText": "Thanks for your explain, but I still think it's a right way that add archiveFolderPattern to show archived commits command like show archived commit stats dose.", "author": "hmatu", "createdAt": "2020-02-06T06:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0MTAyMw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r378441023", "bodyText": "@hmatu I think this is just a clean up of code to remove the hard-coded \"archived\" and providing it through the archive folder name, this is fine IMO since this does not break any backwards compatibility @hddong confirm ?\nWhat you are referring to is also correct, but that should be another PR to allow for reading a path pattern for show archived commits just like others have.", "author": "n3nash", "createdAt": "2020-02-12T18:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ0NjMxMw==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r378446313", "bodyText": "@n3nash, this pr aims to \"Adjust the read and write path of archive\". IMO, it is unnecessary to create an new pr.", "author": "hmatu", "createdAt": "2020-02-12T18:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU2MDY1Ng==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r379560656", "bodyText": "@hmatu I agree, I think this PR is just doing some basic cleanup so we should just rename this PR and merge it and fix the adjusting of the read/write path in a different one.\n@hddong please rename this PR as \"archived commits command code cleanup\" and we can merge this", "author": "n3nash", "createdAt": "2020-02-14T17:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMjU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3MTg5OA==", "url": "https://github.com/apache/hudi/pull/1242#discussion_r401971898", "bodyText": "@hddong I'm accepting and will merge after you create another ticket for us to add to the release notes that if someone was actually overriding HOODIE_ARCHIVELOG_FOLDER_PROP_NAME that was not being honored before and now will be honored for those cases it can break (since this is the right thing to do)", "author": "n3nash", "createdAt": "2020-04-01T23:40:03Z", "path": "hudi-spark/src/main/scala/org/apache/hudi/HoodieSparkSqlWriter.scala", "diffHunk": "@@ -119,8 +119,10 @@ private[hudi] object HoodieSparkSqlWriter {\n \n       // Create the table if not present\n       if (!exists) {\n+        val archiveLogFolder = parameters.getOrElse(\n+          HoodieTableConfig.HOODIE_ARCHIVELOG_FOLDER_PROP_NAME, \"archived\")\n         HoodieTableMetaClient.initTableType(sparkContext.hadoopConfiguration, path.get, tableType,\n-          tblName.get, \"archived\", parameters(PAYLOAD_CLASS_OPT_KEY))\n+          tblName.get, archiveLogFolder, parameters(PAYLOAD_CLASS_OPT_KEY))", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "0e54583e99874215c75fc3ea737c39e7d82e4ed9", "url": "https://github.com/apache/hudi/commit/0e54583e99874215c75fc3ea737c39e7d82e4ed9", "message": "Archived commits command code cleanup", "committedDate": "2020-07-10T02:32:20Z", "type": "forcePushed"}, {"oid": "aaa49912e0efc4c8ba3a1cc3d54b979bf72fe8b2", "url": "https://github.com/apache/hudi/commit/aaa49912e0efc4c8ba3a1cc3d54b979bf72fe8b2", "message": "Archived commits command code cleanup", "committedDate": "2020-08-05T09:55:06Z", "type": "forcePushed"}, {"oid": "4f4246c512310b66241adf589cd9f1147aa9a5d9", "url": "https://github.com/apache/hudi/commit/4f4246c512310b66241adf589cd9f1147aa9a5d9", "message": "Archived commits command code cleanup", "committedDate": "2020-08-12T02:03:38Z", "type": "forcePushed"}, {"oid": "1808c57dcbec73a395aaa971ce1e5a7a0c42f91b", "url": "https://github.com/apache/hudi/commit/1808c57dcbec73a395aaa971ce1e5a7a0c42f91b", "message": "fix", "committedDate": "2020-08-12T10:05:40Z", "type": "forcePushed"}, {"oid": "fc10456c363693a1401da6293bf73c898b1c3880", "url": "https://github.com/apache/hudi/commit/fc10456c363693a1401da6293bf73c898b1c3880", "message": "Archived commits command code cleanup", "committedDate": "2020-09-15T08:42:44Z", "type": "commit"}, {"oid": "0d739af9561a071827f10117dda8a3d413025185", "url": "https://github.com/apache/hudi/commit/0d739af9561a071827f10117dda8a3d413025185", "message": "fix", "committedDate": "2020-09-15T08:42:46Z", "type": "commit"}, {"oid": "0d739af9561a071827f10117dda8a3d413025185", "url": "https://github.com/apache/hudi/commit/0d739af9561a071827f10117dda8a3d413025185", "message": "fix", "committedDate": "2020-09-15T08:42:46Z", "type": "forcePushed"}]}