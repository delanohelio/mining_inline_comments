{"pr_number": 1187, "pr_title": "[HUDI-499] Allow update partition path with GLOBAL_BLOOM", "pr_createdAt": "2020-01-05T23:20:40Z", "pr_url": "https://github.com/apache/hudi/pull/1187", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTAyOQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r365545029", "bodyText": "should we include \"global\" in the name. Bcoz, this is applicable only incase of global. In case of regular, the new record will be inserted as a new entry to new partition path.", "author": "nsivabalan", "createdAt": "2020-01-11T22:19:08Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieIndexConfig.java", "diffHunk": "@@ -77,6 +77,9 @@\n   public static final String BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"hoodie.bloom.index.input.storage.level\";\n   public static final String DEFAULT_BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"MEMORY_AND_DISK_SER\";\n \n+  public static final String BLOOM_INDEX_SHOULD_UPDATE_PARTITION_PATH = \"hoodie.bloom.index.should.update.partition.path\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTA5NA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r365545094", "bodyText": "Also, can we add some java docs since the property is not very intuitive.", "author": "nsivabalan", "createdAt": "2020-01-11T22:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUwODI3MA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r367508270", "bodyText": "Renamed and added docs.", "author": "xushiyan", "createdAt": "2020-01-16T16:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTA5Nw==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r365545097", "bodyText": "would appreciate if you can add java docs", "author": "nsivabalan", "createdAt": "2020-01-11T22:21:14Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieWriteConfig.java", "diffHunk": "@@ -431,6 +431,10 @@ public StorageLevel getBloomIndexInputStorageLevel() {\n     return StorageLevel.fromString(props.getProperty(HoodieIndexConfig.BLOOM_INDEX_INPUT_STORAGE_LEVEL));\n   }\n \n+  public boolean getBloomIndexShouldUpdatePartitionPath() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUwODk3Ng==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r367508976", "bodyText": "@nsivabalan I think for a simple a getter that fetch the property, the javadoc is accessible from the property itself. I've added the docs there. So can i skip it here?", "author": "xushiyan", "createdAt": "2020-01-16T16:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTc5OA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r365545798", "bodyText": "I guess we need to have a if else case here. Let me try to explain my understanding. correct me if its wrong.\nThe scenario we are trying to tackle is, insertion for a record happened in PartitionPath1, while update is sent to PartitionPath2. With the newly added cofig value set to true, we want the update operation to insert in PartitionPath2 and also delete in PartitionPath1.\nSo, in this case, after the left outer join, here are the values for the record\nrecord._1 -> incoming record. recordKey1, PartitionPath2\nrecord._2 -> Tuple2<HoodieRecordLocation, HoodieKey> after index look up. should refer to recordKey1, PartitionPath1.\n`\nif (recordLocationHoodieKeyPair.isPresent()) {\n    if(recordLocationHoodieKeyPair.get()._2.getPartitionPath().equals(hoodieRecord.getPartitionPath())){\n      return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n    } else {\n      if(config value is true) {\n        // need to add two records. one delete in old partition path and an insert into new one.\n        HoodieRecord<T> emptyRecord = new HoodieRecord(recordLocationHoodieKeyPair.get()._2,\n            new EmptyHoodieRecordPayload());\n        HoodieRecord<T> taggedRecord = getTaggedRecord(hoodieRecord, Option.empty());\n        return Arrays.asList(emptyRecord, taggedRecord).iterator();\n        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n      } else{\n        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n      }\n    }\n\n    // Record key matched to file\n   // return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n  } else {\n    return getTaggedRecord(hoodieRecord, Option.empty());\n  }\n\n`", "author": "nsivabalan", "createdAt": "2020-01-11T22:40:42Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/bloom/HoodieGlobalBloomIndex.java", "diffHunk": "@@ -114,14 +117,23 @@ public HoodieGlobalBloomIndex(HoodieWriteConfig config) {\n         keyLocationPairRDD.mapToPair(p -> new Tuple2<>(p._1.getRecordKey(), new Tuple2<>(p._2, p._1)));\n \n     // Here as the recordRDD might have more data than rowKeyRDD (some rowKeys' fileId is null), so we do left outer join.\n-    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().map(record -> {\n+    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().flatMap(record -> {\n       final HoodieRecord<T> hoodieRecord = record._1;\n       final Optional<Tuple2<HoodieRecordLocation, HoodieKey>> recordLocationHoodieKeyPair = record._2;\n       if (recordLocationHoodieKeyPair.isPresent()) {\n         // Record key matched to file\n-        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n+        if (config.getBloomIndexShouldUpdatePartitionPath()) {\n+          HoodieRecord<T> emptyRecord = new HoodieRecord(recordLocationHoodieKeyPair.get()._2,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5MDM5Mg==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r367490392", "bodyText": "Exactly @nsivabalan . I understood the logic but missed the part of checking path update.", "author": "xushiyan", "createdAt": "2020-01-16T15:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU0NTc5OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NjczMw==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r369556733", "bodyText": "minor: \"when set to true, an update to a record with diff partition compared to its existence, will insert the record to new partition and delete from old partition. When set to false, record will be updated to old partition\".", "author": "nsivabalan", "createdAt": "2020-01-22T13:26:14Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieIndexConfig.java", "diffHunk": "@@ -77,6 +77,17 @@\n   public static final String BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"hoodie.bloom.index.input.storage.level\";\n   public static final String DEFAULT_BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"MEMORY_AND_DISK_SER\";\n \n+  /**\n+   * Only applies if index type is GLOBAL_BLOOM.\n+   * <p>\n+   * When set to true, an update including the partition path of a record that already exists will result in inserting", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk4MTQ2NQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r370981465", "bodyText": "can we also add this to the configurations md file , to keep the docs upto date?", "author": "vinothchandar", "createdAt": "2020-01-26T08:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NjczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMjE4OA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371022188", "bodyText": "can we also add this to the configurations md file , to keep the docs upto date?\n\nThe docs update PR is in #1190 . I'll update it once this is merged.", "author": "xushiyan", "createdAt": "2020-01-26T19:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NjczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDAzNQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r369560035", "bodyText": "can we add a comment here. for eg \"If partition path differs from incoming record to those in index, and if config for partition path update is set to true,\na. insert to new partition from incoming record\nb. delete existing record from existing partition from index\".", "author": "nsivabalan", "createdAt": "2020-01-22T13:33:14Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/bloom/HoodieGlobalBloomIndex.java", "diffHunk": "@@ -114,14 +117,24 @@ public HoodieGlobalBloomIndex(HoodieWriteConfig config) {\n         keyLocationPairRDD.mapToPair(p -> new Tuple2<>(p._1.getRecordKey(), new Tuple2<>(p._2, p._1)));\n \n     // Here as the recordRDD might have more data than rowKeyRDD (some rowKeys' fileId is null), so we do left outer join.\n-    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().map(record -> {\n+    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().flatMap(record -> {\n       final HoodieRecord<T> hoodieRecord = record._1;\n       final Optional<Tuple2<HoodieRecordLocation, HoodieKey>> recordLocationHoodieKeyPair = record._2;\n       if (recordLocationHoodieKeyPair.isPresent()) {\n         // Record key matched to file\n-        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n+        if (config.getGlobalBloomIndexShouldUpdatePartitionPath()\n+            && !recordLocationHoodieKeyPair.get()._2.getPartitionPath().equals(hoodieRecord.getPartitionPath())) {\n+          HoodieRecord<T> emptyRecord = new HoodieRecord(recordLocationHoodieKeyPair.get()._2,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMTI5Nw==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371021297", "bodyText": "Ok I'll just explain the purposes of those 2 HoodieRecords, which I think it'd be clear enough.", "author": "xushiyan", "createdAt": "2020-01-26T18:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMTM1MA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371021350", "bodyText": "+1", "author": "vinothchandar", "createdAt": "2020-01-26T18:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MDA4OA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r369560088", "bodyText": "can we add a comment here mentioning which branch this else part serves. For eg, \"Either if partition path matches from incoming record to those in index, or if config value for partition path update is set to false, choose the partition path from index and update the record, ignoring the partition from incoming record\".", "author": "nsivabalan", "createdAt": "2020-01-22T13:33:21Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/bloom/HoodieGlobalBloomIndex.java", "diffHunk": "@@ -114,14 +117,24 @@ public HoodieGlobalBloomIndex(HoodieWriteConfig config) {\n         keyLocationPairRDD.mapToPair(p -> new Tuple2<>(p._1.getRecordKey(), new Tuple2<>(p._2, p._1)));\n \n     // Here as the recordRDD might have more data than rowKeyRDD (some rowKeys' fileId is null), so we do left outer join.\n-    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().map(record -> {\n+    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().flatMap(record -> {\n       final HoodieRecord<T> hoodieRecord = record._1;\n       final Optional<Tuple2<HoodieRecordLocation, HoodieKey>> recordLocationHoodieKeyPair = record._2;\n       if (recordLocationHoodieKeyPair.isPresent()) {\n         // Record key matched to file\n-        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n+        if (config.getGlobalBloomIndexShouldUpdatePartitionPath()\n+            && !recordLocationHoodieKeyPair.get()._2.getPartitionPath().equals(hoodieRecord.getPartitionPath())) {\n+          HoodieRecord<T> emptyRecord = new HoodieRecord(recordLocationHoodieKeyPair.get()._2,\n+              new EmptyHoodieRecordPayload());\n+          HoodieRecord<T> taggedRecord = getTaggedRecord(hoodieRecord, Option.empty());\n+          return Arrays.asList(emptyRecord, taggedRecord).iterator();\n+        } else {\n+          return Collections.singletonList(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Nzg0OA==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r369847848", "bodyText": "minor: Would be good if we first check partition path differs and then check config value. Bcoz, the config value doesn't matter if partition path matches. So, for readability purposes would be good to swap the condition checks.", "author": "nsivabalan", "createdAt": "2020-01-22T22:47:50Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/bloom/HoodieGlobalBloomIndex.java", "diffHunk": "@@ -114,14 +117,24 @@ public HoodieGlobalBloomIndex(HoodieWriteConfig config) {\n         keyLocationPairRDD.mapToPair(p -> new Tuple2<>(p._1.getRecordKey(), new Tuple2<>(p._2, p._1)));\n \n     // Here as the recordRDD might have more data than rowKeyRDD (some rowKeys' fileId is null), so we do left outer join.\n-    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().map(record -> {\n+    return incomingRowKeyRecordPairRDD.leftOuterJoin(existingRecordKeyToRecordLocationHoodieKeyMap).values().flatMap(record -> {\n       final HoodieRecord<T> hoodieRecord = record._1;\n       final Optional<Tuple2<HoodieRecordLocation, HoodieKey>> recordLocationHoodieKeyPair = record._2;\n       if (recordLocationHoodieKeyPair.isPresent()) {\n         // Record key matched to file\n-        return getTaggedRecord(new HoodieRecord<>(recordLocationHoodieKeyPair.get()._2, hoodieRecord.getData()), Option.ofNullable(recordLocationHoodieKeyPair.get()._1));\n+        if (config.getGlobalBloomIndexShouldUpdatePartitionPath()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMDc2OQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371020769", "bodyText": "I can actually make the argument otherwise :) .. the first check is easier to read and I only need to both with the second one, if first passes.. we can leave this to @xushiyan  to make the call.", "author": "vinothchandar", "createdAt": "2020-01-26T18:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Nzg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMjc0OQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371022749", "bodyText": "2nd thought on this: we should treat a configuration as the dominating factor and the partition equality check as a supporting factor. Doing it the other way will diminish the purpose of a configuration. Hence I would keep that order as is. Thanks for bringing thoughts to it!", "author": "xushiyan", "createdAt": "2020-01-26T19:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0Nzg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0ODI0NQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r369848245", "bodyText": "@vinothchandar : does the config param looks good. I am okay with this. just wanted your opinion.", "author": "nsivabalan", "createdAt": "2020-01-22T22:48:44Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieIndexConfig.java", "diffHunk": "@@ -77,6 +77,17 @@\n   public static final String BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"hoodie.bloom.index.input.storage.level\";\n   public static final String DEFAULT_BLOOM_INDEX_INPUT_STORAGE_LEVEL = \"MEMORY_AND_DISK_SER\";\n \n+  /**\n+   * Only applies if index type is GLOBAL_BLOOM.\n+   * <p>\n+   * When set to true, an update including the partition path of a record that already exists will result in inserting\n+   * the incoming record into the new partition and deleting the original record in the old partition.\n+   * <p>\n+   * When set to false, the original record will only be updated in the old partition.\n+   */\n+  public static final String GLOBAL_BLOOM_INDEX_SHOULD_UPDATE_PARTITION_PATH = \"hoodie.global.bloom.index.should.update.partition.path\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMDUxNg==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371020516", "bodyText": "Since this applies to the bloom index, can we slightly rename to hoodie.bloom.index.update.partition.path and also shorten it a bit", "author": "vinothchandar", "createdAt": "2020-01-26T18:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0ODI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMjA4NQ==", "url": "https://github.com/apache/hudi/pull/1187#discussion_r371022085", "bodyText": "Since this applies to the bloom index, can we slightly rename to hoodie.bloom.index.update.partition.path and also shorten it a bit\n\nI like the brevity. As the docs specify as \"only apply to GLOBAL_BLOOM\", it is unlikely to confuse users.", "author": "xushiyan", "createdAt": "2020-01-26T19:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0ODI0NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "5dfc4e0a965a22701adf3682d6b6e6d310375351", "url": "https://github.com/apache/hudi/commit/5dfc4e0a965a22701adf3682d6b6e6d310375351", "message": "[HUDI-499] Allow update partition path with GLOBAL_BLOOM\n\n* Handle partition path update by deleting a record from the old partition and\n  insert into the new one\n* Add a new configuration \"hoodie.bloom.index.update.partition.path\" to\n  enable the behavior\n* Add a new unit test case for global bloom index", "committedDate": "2020-02-05T06:43:02Z", "type": "commit"}, {"oid": "5dfc4e0a965a22701adf3682d6b6e6d310375351", "url": "https://github.com/apache/hudi/commit/5dfc4e0a965a22701adf3682d6b6e6d310375351", "message": "[HUDI-499] Allow update partition path with GLOBAL_BLOOM\n\n* Handle partition path update by deleting a record from the old partition and\n  insert into the new one\n* Add a new configuration \"hoodie.bloom.index.update.partition.path\" to\n  enable the behavior\n* Add a new unit test case for global bloom index", "committedDate": "2020-02-05T06:43:02Z", "type": "forcePushed"}]}