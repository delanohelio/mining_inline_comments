{"pr_number": 1953, "pr_title": "[HUDI-1181] Fix decimal type display issue for record key field", "pr_createdAt": "2020-08-12T05:57:37Z", "pr_url": "https://github.com/apache/hudi/pull/1953", "timeline": [{"oid": "3225e96866aadef083a9b310c5d17cd87335dba3", "url": "https://github.com/apache/hudi/commit/3225e96866aadef083a9b310c5d17cd87335dba3", "message": "Remove getNestedFieldVal method from DataSourceUtils", "committedDate": "2020-08-12T07:26:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMTgwMg==", "url": "https://github.com/apache/hudi/pull/1953#discussion_r475021802", "bodyText": "I would suggest to abstract this out into its own function like convertValueForAvroLogicalTypes() and call it from both places instead of using recursive call which is adding overhead of more repetitive checks happening. Since this will be called for each record I would like to keep it as lightweight as possible.\n     if (fieldSchema.getType() == Schema.Type.UNION) {\n           for (Schema schema : fieldSchema.getTypes()) {\n                  return convertValueForAvroLogicalTypes()\n               }\n    } else {\n       return convertValueForAvroLogicalTypes()\n   }", "author": "umehrot2", "createdAt": "2020-08-22T00:36:16Z", "path": "hudi-common/src/main/java/org/apache/hudi/avro/HoodieAvroUtils.java", "diffHunk": "@@ -431,25 +435,30 @@ private static Object convertValueForSpecificDataTypes(Schema fieldSchema, Objec\n       return fieldValue;\n     }\n \n-    if (isLogicalTypeDate(fieldSchema)) {\n+    if (fieldSchema.getType() == Schema.Type.UNION) {\n+      for (Schema schema : fieldSchema.getTypes()) {\n+        if (schema.getLogicalType() == LogicalTypes.date() || schema.getLogicalType() instanceof LogicalTypes.Decimal) {\n+          return convertValueForSpecificDataTypes(schema, fieldValue);\n+        }\n+      }\n+    } else if (fieldSchema.getLogicalType() == LogicalTypes.date()) {\n+      // special handle for Logical Date type\n       return LocalDate.ofEpochDay(Long.parseLong(fieldValue.toString()));\n+    } else if (fieldSchema.getLogicalType() instanceof LogicalTypes.Decimal) {\n+      // special handle for Logical Decimal type\n+      Decimal dc = (Decimal) fieldSchema.getLogicalType();\n+      DecimalConversion decimalConversion = new DecimalConversion();\n+      if (fieldSchema.getType() == Schema.Type.FIXED) {\n+        return decimalConversion.fromFixed((GenericFixed) fieldValue, fieldSchema,\n+            LogicalTypes.decimal(dc.getPrecision(), dc.getScale()));\n+      } else if (fieldSchema.getType() == Schema.Type.BYTES) {\n+        return decimalConversion.fromBytes((ByteBuffer) fieldValue, fieldSchema,\n+            LogicalTypes.decimal(dc.getPrecision(), dc.getScale()));\n+      }", "originalCommit": "3225e96866aadef083a9b310c5d17cd87335dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3dcd1b72e13cada5eef864edbe44a626700e277", "url": "https://github.com/apache/hudi/commit/e3dcd1b72e13cada5eef864edbe44a626700e277", "message": "[HUDI-1181] Fix decimal type display issue for record key field", "committedDate": "2020-08-25T18:38:29Z", "type": "commit"}, {"oid": "07fdb19549e8f040c5e400d99007cbd345395920", "url": "https://github.com/apache/hudi/commit/07fdb19549e8f040c5e400d99007cbd345395920", "message": "Remove getNestedFieldVal method from DataSourceUtils", "committedDate": "2020-08-25T18:40:44Z", "type": "commit"}, {"oid": "55f6a57bc17c0c298041343f611c5d9dfa605ac3", "url": "https://github.com/apache/hudi/commit/55f6a57bc17c0c298041343f611c5d9dfa605ac3", "message": "resolve comments", "committedDate": "2020-08-25T21:54:42Z", "type": "forcePushed"}, {"oid": "3f8bb76135edccfdb2a576adff8a84385d6f32eb", "url": "https://github.com/apache/hudi/commit/3f8bb76135edccfdb2a576adff8a84385d6f32eb", "message": "resolve comments", "committedDate": "2020-08-25T21:56:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDQzNg==", "url": "https://github.com/apache/hudi/pull/1953#discussion_r476840436", "bodyText": "Do we need to check this explicitly ? convertValueForAvroLogicalTypes will either ways just return the field value in this case.\nThe check is either ways not being performed in case Schema type is not UNION. It might be okay to remove this.", "author": "umehrot2", "createdAt": "2020-08-25T23:13:40Z", "path": "hudi-common/src/main/java/org/apache/hudi/avro/HoodieAvroUtils.java", "diffHunk": "@@ -433,23 +434,46 @@ private static Object convertValueForSpecificDataTypes(Schema fieldSchema, Objec\n       return fieldValue;\n     }\n \n-    if (isLogicalTypeDate(fieldSchema)) {\n-      return LocalDate.ofEpochDay(Long.parseLong(fieldValue.toString()));\n+    if (fieldSchema.getType() == Schema.Type.UNION) {\n+      for (Schema schema : fieldSchema.getTypes()) {\n+        if (schema.getType() != Schema.Type.NULL) {", "originalCommit": "3f8bb76135edccfdb2a576adff8a84385d6f32eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMTAyMw==", "url": "https://github.com/apache/hudi/pull/1953#discussion_r476901023", "bodyText": "For schema like:\n{\n\"name\":\"event_cost3\",\n\"type\":[\n\"null\",\n{\n\"type\":\"fixed\",\n\"name\":\"dc\",\n\"size\":5,\n\"logicalType\":\"decimal\",\n\"precision\":10,\n\"scale\":6\n}\n]\n\nor\n{\n\"name\":\"event_date3\",\n\"type\":[\n\"null\",\n{\n\"type\":\"int\",\n\"logicalType\":\"date\"\n}\n]\n\nThe first schema it gets is null, w/o this condition, it will directly return the fieldValue w/o any special conversion. BTW this comment remind me to add another test case for decimal type with union.", "author": "zhedoubushishi", "createdAt": "2020-08-26T00:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDQzNg=="}], "type": "inlineReview"}, {"oid": "1548cfb5d54fef1ddce18131810423f9c8fbe4e2", "url": "https://github.com/apache/hudi/commit/1548cfb5d54fef1ddce18131810423f9c8fbe4e2", "message": "resolve comments", "committedDate": "2020-08-26T00:14:30Z", "type": "forcePushed"}, {"oid": "f0cc45854d2f2336ae97c148a2a9dd09d7edcf9b", "url": "https://github.com/apache/hudi/commit/f0cc45854d2f2336ae97c148a2a9dd09d7edcf9b", "message": "resolve comments", "committedDate": "2020-08-27T19:03:54Z", "type": "commit"}, {"oid": "f0cc45854d2f2336ae97c148a2a9dd09d7edcf9b", "url": "https://github.com/apache/hudi/commit/f0cc45854d2f2336ae97c148a2a9dd09d7edcf9b", "message": "resolve comments", "committedDate": "2020-08-27T19:03:54Z", "type": "forcePushed"}]}