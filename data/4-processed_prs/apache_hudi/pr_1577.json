{"pr_number": 1577, "pr_title": "[HUDI-855] Run Auto Cleaner in parallel with ingestion", "pr_createdAt": "2020-04-30T10:26:31Z", "pr_url": "https://github.com/apache/hudi/pull/1577", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MjMxNQ==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418092315", "bodyText": "let's move this into its own method for readability?", "author": "vinothchandar", "createdAt": "2020-04-30T15:22:43Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -339,8 +352,13 @@ protected void postCommit(HoodieCommitMetadata metadata, String instantTime,\n       archiveLog.archiveIfRequired(jsc);\n       if (config.isAutoClean()) {\n         // Call clean to cleanup if there is anything to cleanup after the commit,\n-        LOG.info(\"Auto cleaning is enabled. Running cleaner now\");\n-        clean(instantTime);\n+        if (config.isRunParallelAutoClean()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NzIxOA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443157218", "bodyText": "Done", "author": "bvaradar", "createdAt": "2020-06-20T20:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MzI3OA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418093278", "bodyText": "lets move this to its own class?", "author": "vinothchandar", "createdAt": "2020-04-30T15:24:03Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -677,4 +714,27 @@ private void rollbackPendingCommits() {\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Auto Clean service running concurrently.\n+   */\n+  private static class AutoCleanerService extends AbstractAsyncService {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDIyNA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418094224", "bodyText": "And even the spawnAutoCleanerIfEnabled and waitForAutoCleanerToShutdown as static helpers in this class.. (trying to avoid code creep inside HoodieWriteClient :))", "author": "vinothchandar", "createdAt": "2020-04-30T15:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MzI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDY1Ng==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418094656", "bodyText": "move to constructor and reuse for the duration of a HoodieWriteClient ?", "author": "vinothchandar", "createdAt": "2020-04-30T15:25:58Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -677,4 +714,27 @@ private void rollbackPendingCommits() {\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Auto Clean service running concurrently.\n+   */\n+  private static class AutoCleanerService extends AbstractAsyncService {\n+\n+    private final HoodieWriteClient writeClient;\n+    private final String cleanInstant;\n+\n+    private AutoCleanerService(HoodieWriteClient writeClient, String cleanInstant) {\n+      this.writeClient = writeClient;\n+      this.cleanInstant = cleanInstant;\n+    }\n+\n+    @Override\n+    protected Pair<CompletableFuture, ExecutorService> startService() {\n+      ExecutorService executor = Executors.newFixedThreadPool(1);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NzI4MA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443157280", "bodyText": "Move to constructor of AutoCleanerService", "author": "bvaradar", "createdAt": "2020-06-20T20:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTA4Nw==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418095087", "bodyText": "this is from the other PR.", "author": "vinothchandar", "createdAt": "2020-04-30T15:26:36Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanPlanner.java", "diffHunk": "@@ -111,10 +111,15 @@ public CleanPlanner(HoodieTable<T> hoodieTable, HoodieWriteConfig config) {\n    * @throws IOException when underlying file-system throws this exception\n    */\n   public List<String> getPartitionPathsToClean(Option<HoodieInstant> newInstantToRetain) throws IOException {\n-    if (config.incrementalCleanerModeEnabled() && newInstantToRetain.isPresent()\n+\n+    if (!newInstantToRetain.isPresent() && (HoodieCleaningPolicy.KEEP_LATEST_COMMITS == config.getCleanerPolicy())) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTc5Nw==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418095797", "bodyText": "does this really belong in hudi-common or it can stay in hudi-client (execution package?)", "author": "vinothchandar", "createdAt": "2020-04-30T15:27:30Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/async/AbstractAsyncService.java", "diffHunk": "@@ -16,7 +16,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi.utilities.deltastreamer;\n+package org.apache.hudi.common.async;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NzMwNg==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443157306", "bodyText": "Moved to hudi-client", "author": "bvaradar", "createdAt": "2020-06-20T20:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTc5Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "bcbdae42b758b5297571851c365863a8c2a93961", "url": "https://github.com/apache/hudi/commit/bcbdae42b758b5297571851c365863a8c2a93961", "message": "[HUDI-855] Run Auto Cleaner in parallel with ingestion", "committedDate": "2020-06-12T05:23:45Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE2MjEzNA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443162134", "bodyText": "@yanghua : I went ahead and removed this class. I have added a jira : https://issues.apache.org/jira/browse/HUDI-1033 to go through other such examples and see if multiple CLI tests are still needed.", "author": "bvaradar", "createdAt": "2020-06-20T21:44:31Z", "path": "hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCleansCommand.java", "diffHunk": "@@ -1,106 +0,0 @@\n-/*", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyNzQzMg==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443227432", "bodyText": "Hi @bvaradar replied you on the jira.", "author": "yanghua", "createdAt": "2020-06-21T14:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE2MjEzNA=="}], "type": "inlineReview"}, {"oid": "3746e7002ccac79375f6905e1c8964bd03531092", "url": "https://github.com/apache/hudi/commit/3746e7002ccac79375f6905e1c8964bd03531092", "message": "[HUDI-855] Run Auto Cleaner in parallel with ingestion", "committedDate": "2020-06-28T06:44:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwNjg4OA==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446606888", "bodyText": "org.apache.hudi.client.service is a better location? we should have this, the timeline server etc in a single place?", "author": "vinothchandar", "createdAt": "2020-06-28T06:20:18Z", "path": "hudi-client/src/main/java/org/apache/hudi/async/AbstractAsyncService.java", "diffHunk": "@@ -16,7 +16,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi.utilities.deltastreamer;\n+package org.apache.hudi.async;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwNjk1MQ==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446606951", "bodyText": "we ideally should be reusing the same for #1752 ?", "author": "vinothchandar", "createdAt": "2020-06-28T06:21:03Z", "path": "hudi-client/src/main/java/org/apache/hudi/async/AbstractAsyncService.java", "diffHunk": "@@ -32,11 +32,11 @@\n import java.util.function.Function;\n \n /**\n- * Base Class for running delta-sync/compaction in separate thread and controlling their life-cycle.\n+ * Base Class for running clean/delta-sync/compaction in separate thread and controlling their life-cycle.\n  */\n-public abstract class AbstractDeltaStreamerService implements Serializable {\n+public abstract class AbstractAsyncService implements Serializable {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODQ3Nw==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446608477", "bodyText": "just rename to AsyncCleanerService", "author": "vinothchandar", "createdAt": "2020-06-28T06:39:00Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -81,6 +81,8 @@\n   private final transient HoodieMetrics metrics;\n   private transient Timer.Context compactionTimer;\n \n+  private transient AutoCleanerService autoCleanerService;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODUyMQ==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446608521", "bodyText": "auto or not, is a configuration that should not be leaked into class names.", "author": "vinothchandar", "createdAt": "2020-06-28T06:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwOTM2Ng==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446609366", "bodyText": "there are a lot of terms being overloaded here -- parallel, async, auto.. what you mean by parallel is async.. correct?", "author": "vinothchandar", "createdAt": "2020-06-28T06:48:16Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -338,15 +346,27 @@ protected void postCommit(HoodieCommitMetadata metadata, String instantTime,\n       // We cannot have unbounded commit files. Archive commits if we have to archive\n       HoodieTimelineArchiveLog archiveLog = new HoodieTimelineArchiveLog(config, createMetaClient(true));\n       archiveLog.archiveIfRequired(hadoopConf);\n-      if (config.isAutoClean()) {\n-        // Call clean to cleanup if there is anything to cleanup after the commit,\n+      autoCleanOnCommit(instantTime);\n+    } catch (IOException ioe) {\n+      throw new HoodieIOException(ioe.getMessage(), ioe);\n+    }\n+  }\n+\n+  /**\n+   * Handle auto clean during commit.\n+   * @param instantTime\n+   */\n+  private void autoCleanOnCommit(String instantTime) {\n+    if (config.isAutoClean()) {\n+      // Call clean to cleanup if there is anything to cleanup after the commit,\n+      if (config.isRunParallelAutoClean()) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMTI5Nw==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446611297", "bodyText": "This class feels more like a AsyncTask , rather than a service.. i.e something that is long running and accepts tasks.. can we file a follow on to clean this code uop?", "author": "vinothchandar", "createdAt": "2020-06-28T07:09:40Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/AutoCleanerService.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client;\n+\n+import org.apache.hudi.async.AbstractAsyncService;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.exception.HoodieException;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Auto Clean service running concurrently with write operation.\n+ */\n+class AutoCleanerService extends AbstractAsyncService {\n+\n+  private static final Logger LOG = LogManager.getLogger(AutoCleanerService.class);\n+\n+  private final HoodieWriteClient writeClient;\n+  private final String cleanInstant;\n+  private final transient ExecutorService executor = Executors.newFixedThreadPool(1);\n+\n+  protected AutoCleanerService(HoodieWriteClient writeClient, String cleanInstant) {\n+    this.writeClient = writeClient;\n+    this.cleanInstant = cleanInstant;\n+  }\n+\n+  @Override\n+  protected Pair<CompletableFuture, ExecutorService> startService() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMTUyNQ==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446611525", "bodyText": "how come the return value is never set to the instance variable?", "author": "vinothchandar", "createdAt": "2020-06-28T07:12:19Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -254,6 +260,7 @@ public static SparkConf registerClasses(SparkConf conf) {\n     HoodieTable<T> table = getTableAndInitCtx(WriteOperationType.BULK_INSERT);\n     table.validateInsertSchema();\n     setOperationType(WriteOperationType.BULK_INSERT);\n+    AutoCleanerService.spawnAutoCleanerIfEnabled(this, instantTime);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMjk4Mw==", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446612983", "bodyText": "this kind of resetting is probably needed after each write operation as well? may be its fine to just reinitialize the service after waitForCompletion.. food for thought..", "author": "vinothchandar", "createdAt": "2020-06-28T07:27:10Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -477,6 +497,8 @@ public HoodieRestoreMetadata restoreToInstant(final String instantTime) throws H\n    */\n   @Override\n   public void close() {\n+    AutoCleanerService.shutdownAutoCleaner(autoCleanerService);\n+    autoCleanerService = null;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4739becf6f7860d64cde664e5f997103f65989bd", "url": "https://github.com/apache/hudi/commit/4739becf6f7860d64cde664e5f997103f65989bd", "message": "[HUDI-855] Code review comments\n\n - Configs renamed\n - AutoCleanerService renamed more aptly to AsyncCleanerService\n - Fix issue with missed assignment to local variable", "committedDate": "2020-06-28T07:40:38Z", "type": "commit"}, {"oid": "4739becf6f7860d64cde664e5f997103f65989bd", "url": "https://github.com/apache/hudi/commit/4739becf6f7860d64cde664e5f997103f65989bd", "message": "[HUDI-855] Code review comments\n\n - Configs renamed\n - AutoCleanerService renamed more aptly to AsyncCleanerService\n - Fix issue with missed assignment to local variable", "committedDate": "2020-06-28T07:40:38Z", "type": "forcePushed"}]}