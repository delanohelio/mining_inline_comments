{"pr_number": 1229, "pr_title": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues", "pr_createdAt": "2020-01-15T08:04:26Z", "pr_url": "https://github.com/apache/hudi/pull/1229", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2NzY4OA==", "url": "https://github.com/apache/hudi/pull/1229#discussion_r367167688", "bodyText": "why is this ok?", "author": "vinothchandar", "createdAt": "2020-01-15T23:52:51Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieActiveTimeline.java", "diffHunk": "@@ -369,8 +366,6 @@ public HoodieInstant transitionCleanInflightToComplete(HoodieInstant inflightIns\n     Preconditions.checkArgument(inflightInstant.getAction().equals(HoodieTimeline.CLEAN_ACTION));\n     Preconditions.checkArgument(inflightInstant.isInflight());\n     HoodieInstant commitInstant = new HoodieInstant(State.COMPLETED, CLEAN_ACTION, inflightInstant.getTimestamp());\n-    // First write metadata to aux folder", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIyOTU5Ng==", "url": "https://github.com/apache/hudi/pull/1229#discussion_r367229596", "bodyText": "Unlike compaction plan, Cleaner Metadata is never read concurrently read and written. Hence, there is no need to write to .aux folder.", "author": "bvaradar", "createdAt": "2020-01-16T04:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2NzY4OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MTMxNA==", "url": "https://github.com/apache/hudi/pull/1229#discussion_r367471314", "bodyText": "but then in the meantime, every reader will be doing two RPCs for this method right? I am thinking about flipping the order.. read from aux first, then fallback to meta path...\nThis way, when we switch to writing in metapath, only the older readers will incur this additional RPC... Does it make sense?", "author": "vinothchandar", "createdAt": "2020-01-16T15:09:30Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieActiveTimeline.java", "diffHunk": "@@ -279,18 +280,28 @@ private void deleteInstantFile(HoodieInstant instant) {\n     return readDataFromPath(detailPath);\n   }\n \n+  public Option<byte[]> readCleanerInfoAsBytes(HoodieInstant instant) {\n+    // Cleaner metadata are always stored only in timeline .hoodie\n+    return readDataFromPath(new Path(metaClient.getMetaPath(), instant.getFileName()));\n+  }\n+\n   //-----------------------------------------------------------------\n   //      BEGIN - COMPACTION RELATED META-DATA MANAGEMENT.\n   //-----------------------------------------------------------------\n \n-  public Option<byte[]> readPlanAsBytes(HoodieInstant instant) {\n-    Path detailPath = null;\n-    if (metaClient.getTimelineLayoutVersion().isNullVersion()) {\n-      detailPath = new Path(metaClient.getMetaAuxiliaryPath(), instant.getFileName());\n-    } else {\n-      detailPath = new Path(metaClient.getMetaPath(), instant.getFileName());\n+  public Option<byte[]> readCompactionPlanAsBytes(HoodieInstant instant) {\n+    try {\n+      // This is going to be the common case in future when 0.5.1 is deployed.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "url": "https://github.com/apache/hudi/commit/34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "message": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues", "committedDate": "2020-01-17T17:16:32Z", "type": "commit"}, {"oid": "34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "url": "https://github.com/apache/hudi/commit/34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "message": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues", "committedDate": "2020-01-17T17:16:32Z", "type": "forcePushed"}]}