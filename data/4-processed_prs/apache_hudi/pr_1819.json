{"pr_number": 1819, "pr_title": "[HUDI-1058] Make delete marker configurable", "pr_createdAt": "2020-07-11T07:03:13Z", "pr_url": "https://github.com/apache/hudi/pull/1819", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMDIxOA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453220218", "bodyText": "typo: it should be userDefinedXXX", "author": "xushiyan", "createdAt": "2020-07-11T18:12:07Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -36,6 +36,9 @@\n public class OverwriteWithLatestAvroPayload extends BaseAvroPayload\n     implements HoodieRecordPayload<OverwriteWithLatestAvroPayload> {\n \n+  public static final String DEFAULT_DELETE_FIELD = \"_hoodie_is_deleted\";\n+  private String userDefineDeleteField = null;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTY2Mw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453221663", "bodyText": "The only caller to this method is org.apache.hudi.io.HoodieMergeHandle#write, where you have access to HoodieWriteConfig config.\nIf you make the configuration delete.field accessible from HoodieWriteConfig then make this method\ncombineAndGetUpdateValue(IndexedRecord currentValue, Schema schema, Option<String> deleteField) {\n}\nthen the overall logic will be simplified a lot.", "author": "xushiyan", "createdAt": "2020-07-11T18:29:20Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -67,7 +74,8 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n \n     GenericRecord genericRecord = (GenericRecord) recordOption.get();\n     // combining strategy here trivially ignores currentValue on disk and writes this record\n-    Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n+    String deleteField = userDefineDeleteField == null ? DEFAULT_DELETE_FIELD : userDefineDeleteField;\n+    Object deleteMarker = genericRecord.get(deleteField);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMjY3NA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453222674", "bodyText": "To maintain full compatibility and caller convenience, just provide an overloading version like\ncombineAndGetUpdateValue(IndexedRecord currentValue, Schema schema) {\n  combineAndGetUpdateValue(currentValue, schema, Option.emtpy())\n}", "author": "xushiyan", "createdAt": "2020-07-11T18:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MzE3OA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453293178", "bodyText": "It sounds good. But do we need to add the new method to the interface HoodieRecordPayload? If so, does the classes that  has implemented need to implement this method?", "author": "shenh062326", "createdAt": "2020-07-12T09:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ0OTY0Nw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453449647", "bodyText": "do we need to add the new method to the interface HoodieRecordPayload\n\nhmmm. that's tricky. Sorry i did not realize this is an interface API.. does not look clean to make it into the interface... then keeping it local to the class lose agnosticness when calling combineAndGetUpdateValue().. need more thoughts on this..", "author": "xushiyan", "createdAt": "2020-07-13T05:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1NTcwMA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453455700", "bodyText": "@shenh062326 Maybe we shouldn't do the check in the payload class itself. Maybe org.apache.hudi.io.HoodieMergeHandle#write is better for this job. After\n\n  \n    \n      hudi/hudi-client/src/main/java/org/apache/hudi/io/HoodieMergeHandle.java\n    \n    \n        Lines 222 to 223\n      in\n      2603cfb\n    \n    \n    \n    \n\n        \n          \n           Option<IndexedRecord> combinedAvroRecord = \n        \n\n        \n          \n               hoodieRecord.getData().combineAndGetUpdateValue(oldRecord, useWriterSchema ? writerSchema : originalSchema); \n        \n    \n  \n\n\nwe check combinedAvroRecord against the delete field defined in the configs and convert it to Option.empty() if appropriate. As this feature is config-related, whoever owns the configs should do it. Need more inputs from @nsivabalan", "author": "xushiyan", "createdAt": "2020-07-13T06:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMTczMg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r453221732", "bodyText": "not necessary if config goes to HoodieWriteConfig", "author": "xushiyan", "createdAt": "2020-07-11T18:29:59Z", "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/HoodieDeltaStreamer.java", "diffHunk": "@@ -202,6 +202,10 @@ public Operation convert(String value) throws ParameterException {\n         + \" to break ties between records with same key in input data. Default: 'ts' holding unix timestamp of record\")\n     public String sourceOrderingField = \"ts\";\n \n+    @Parameter(names = {\"--source-delete-field\"}, description = \"Field within source record to decide\"\n+            + \" is this record is delete record. Default: \" + OverwriteWithLatestAvroPayload.DEFAULT_DELETE_FIELD)\n+    public String sourceDeleteField = OverwriteWithLatestAvroPayload.DEFAULT_DELETE_FIELD;\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0MDE1OA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455440158", "bodyText": "we can simplify this(I haven't gone through the entire patch yet). If you set default value for this config param to \"_hoodie_is_deleted\", then you don't need to check for isEmpty. also within OverwriteWithLatestAvroPayload, you could just take in the deleteKeyField as is. either it will point to \"_hoodie_is_deleted\" if not set. Else it will point to the one user has over-written.", "author": "nsivabalan", "createdAt": "2020-07-16T00:27:15Z", "path": "hudi-spark/src/main/java/org/apache/hudi/DataSourceUtils.java", "diffHunk": "@@ -176,11 +177,21 @@ public static KeyGenerator createKeyGenerator(TypedProperties props) throws IOEx\n   /**\n    * Create a payload class via reflection, passing in an ordering/precombine value.\n    */\n-  public static HoodieRecordPayload createPayload(String payloadClass, GenericRecord record, Comparable orderingVal)\n-      throws IOException {\n+  public static HoodieRecordPayload createPayload(String payloadClass, GenericRecord record,\n+                                                  Comparable orderingVal,\n+                                                  String deleteField) throws IOException {\n     try {\n-      return (HoodieRecordPayload) ReflectionUtils.loadClass(payloadClass,\n-          new Class<?>[] {GenericRecord.class, Comparable.class}, record, orderingVal);\n+      HoodieRecordPayload payload = null;\n+      if (payloadClass.equals(OverwriteWithLatestAvroPayload.class.getName()) &&\n+              !deleteField.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYwOTAwOQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455609009", "bodyText": "done", "author": "shenh062326", "createdAt": "2020-07-16T08:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0MDE1OA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMDUwMQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455700501", "bodyText": "you might as well define the default var in this class rather than OverwriteWithLatestAvroPayload.", "author": "nsivabalan", "createdAt": "2020-07-16T10:54:49Z", "path": "hudi-spark/src/main/scala/org/apache/hudi/DataSourceOptions.scala", "diffHunk": "@@ -184,6 +184,13 @@ object DataSourceWriteOptions {\n   val PAYLOAD_CLASS_OPT_KEY = \"hoodie.datasource.write.payload.class\"\n   val DEFAULT_PAYLOAD_OPT_VAL = classOf[OverwriteWithLatestAvroPayload].getName\n \n+  /**\n+   * Field used in OverwriteWithLatestAvroPayload combineAndGetUpdateValue, When two records have the same\n+   * key value, we will check if the new record is deleted by the delete field.\n+   */\n+  val DELETE_FIELD_OPT_KEY = \"hoodie.datasource.write.delete.field\"\n+  val DEFAULT_DELETE_FIELD_OPT_VAL = OverwriteWithLatestAvroPayload.DEFAULT_DELETE_FIELD", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMTQwNA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455701404", "bodyText": "can we name it as \"isDeletedField\" or \"isDeletedMarkerField\". may or may not be user defined and hence.", "author": "nsivabalan", "createdAt": "2020-07-16T10:56:32Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -36,6 +36,9 @@\n public class OverwriteWithLatestAvroPayload extends BaseAvroPayload\n     implements HoodieRecordPayload<OverwriteWithLatestAvroPayload> {\n \n+  public static final String DEFAULT_DELETE_FIELD = \"_hoodie_is_deleted\";\n+  private String userDefinedDeleteField = DEFAULT_DELETE_FIELD;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcyNzgxMA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455727810", "bodyText": "If the variable name  change to \"isDeletedField\" or \"isDeletedMarkerField\", it means the variable type should be boolean. Maybe the default value of userDefinedDeleteField change to null.", "author": "shenh062326", "createdAt": "2020-07-16T11:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMTQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNjU2Ng==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455816566", "bodyText": "no, I meant it as field name referring to column. Thats why suffixed with \"field\"", "author": "nsivabalan", "createdAt": "2020-07-16T14:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMTQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMjA1Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r455702052", "bodyText": "this leakage is what I wish to avoid. Why would these classes access OverwriteWithLatestAvroPayload. moving it to DatasourceUtils or some config classes makes sense.", "author": "nsivabalan", "createdAt": "2020-07-16T10:57:54Z", "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/HoodieDeltaStreamer.java", "diffHunk": "@@ -202,6 +202,10 @@ public Operation convert(String value) throws ParameterException {\n         + \" to break ties between records with same key in input data. Default: 'ts' holding unix timestamp of record\")\n     public String sourceOrderingField = \"ts\";\n \n+    @Parameter(names = {\"--source-delete-field\"}, description = \"Field within source record to decide\"\n+            + \" is this record is deleted. Default: \" + OverwriteWithLatestAvroPayload.DEFAULT_DELETE_FIELD)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ1OTk2Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r456459962", "bodyText": "sorry, don't understand why we need this. the config value will either refer to \"_hoodie_is_deleted\" if not set, or will refer to the user defined prop. So, we could initialize isDeletedField = null and set it in constructor. correct me if my understanding is wrong.", "author": "nsivabalan", "createdAt": "2020-07-17T13:58:50Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -36,6 +36,9 @@\n public class OverwriteWithLatestAvroPayload extends BaseAvroPayload\n     implements HoodieRecordPayload<OverwriteWithLatestAvroPayload> {\n \n+  public static final String DEFAULT_DELETE_FIELD = \"_hoodie_is_deleted\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc3MTk3OQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r456771979", "bodyText": "Remove DEFAULT_DELETE_FIELD.", "author": "shenh062326", "createdAt": "2020-07-18T09:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ1OTk2Mg=="}], "type": "inlineReview"}, {"oid": "0dffe20b74d1cba02986c23206249fbd6714279a", "url": "https://github.com/apache/hudi/commit/0dffe20b74d1cba02986c23206249fbd6714279a", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-18T09:39:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2ODcxNw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r457468717", "bodyText": "sorry, I didn't realize the other constructor. We could then initialize isDeletedField = \"_hoodie_is_deleted\"; So that one of the constructors will over-ride the value.", "author": "nsivabalan", "createdAt": "2020-07-20T15:01:00Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -66,8 +74,9 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n     }\n \n     GenericRecord genericRecord = (GenericRecord) recordOption.get();\n-    // combining strategy here trivially ignores currentValue on disk and writes this record\n-    Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n+    // combining strategy here trivially ignores currentValue on disk and writes this record\u5417\n+    String deleteField = isDeletedField == null ? \"_hoodie_is_deleted\" : isDeletedField;", "originalCommit": "0dffe20b74d1cba02986c23206249fbd6714279a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4MTE2Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r458181162", "bodyText": "I don't see any tests being added as part of the patch. Would be nice to have some tests covering the new code that was added at all levels.\n\nWriteClient\nDatasource if there is an existing suite of tests for other write operations\nDeltastreamer\n\n\nSorry for late, I will add some testcases and fix the comments.", "author": "shenh062326", "createdAt": "2020-07-21T15:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2ODcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjY2MA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r457472660", "bodyText": "all we need is a config here. don't think we need to initialize writeClient here.", "author": "nsivabalan", "createdAt": "2020-07-20T15:05:21Z", "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -337,9 +337,15 @@ private void refreshTimeline() throws IOException {\n     }\n \n     JavaRDD<GenericRecord> avroRDD = avroRDDOptional.get();\n+    if (writeClient == null) {\n+      this.schemaProvider = schemaProvider;\n+      setupWriteClient();", "originalCommit": "0dffe20b74d1cba02986c23206249fbd6714279a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3OTYyMQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r457479621", "bodyText": "also thinking do we really need to instantiate the config. since it is just one property, can't we directly read if from TypedProperties? @bvaradar : do you have any thoughts on this. Basically we need to read just one config value for deleteMarker from the properties set. This step is little ahead of where we instantiate writeClient, so wondering how to go about it.", "author": "nsivabalan", "createdAt": "2020-07-20T15:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkxMjk1OA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r457912958", "bodyText": "+1, lets not create the write client here. As we are setting the field (including defaults) from DataSourceReadOptions, you can use the TypedProperties to get it.", "author": "bvaradar", "createdAt": "2020-07-21T08:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjY2MA=="}], "type": "inlineReview"}, {"oid": "2c17a9ffada5cf665093841a2c77fe91fb1de980", "url": "https://github.com/apache/hudi/commit/2c17a9ffada5cf665093841a2c77fe91fb1de980", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-21T15:23:03Z", "type": "forcePushed"}, {"oid": "e5c7bf8df6bc7bd41c6a5c0c7fa605b758d91cec", "url": "https://github.com/apache/hudi/commit/e5c7bf8df6bc7bd41c6a5c0c7fa605b758d91cec", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-23T12:21:36Z", "type": "forcePushed"}, {"oid": "1f06ae2e0a135f29090a0b4ac25c52d8e8884c95", "url": "https://github.com/apache/hudi/commit/1f06ae2e0a135f29090a0b4ac25c52d8e8884c95", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-24T10:21:03Z", "type": "forcePushed"}, {"oid": "c6b53e26db81ed78257a10aaf4a8487d4ee63e20", "url": "https://github.com/apache/hudi/commit/c6b53e26db81ed78257a10aaf4a8487d4ee63e20", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-24T12:44:47Z", "type": "forcePushed"}, {"oid": "1caaef3b8e29212000a1f95e2341ad7be8780e11", "url": "https://github.com/apache/hudi/commit/1caaef3b8e29212000a1f95e2341ad7be8780e11", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-25T10:30:45Z", "type": "forcePushed"}, {"oid": "78d1bbc79001dad1d8a2f6c92841707befa35191", "url": "https://github.com/apache/hudi/commit/78d1bbc79001dad1d8a2f6c92841707befa35191", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-25T10:58:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTM0Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460415342", "bodyText": "can we name something like \"deleteMarkerField\" or something. Feel \"deletedField\" conveys the field is deleted.", "author": "nsivabalan", "createdAt": "2020-07-25T15:27:21Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -36,6 +36,8 @@\n public class OverwriteWithLatestAvroPayload extends BaseAvroPayload\n     implements HoodieRecordPayload<OverwriteWithLatestAvroPayload> {\n \n+  private String deletedField = \"_hoodie_is_deleted\";", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI2NjkxMQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r461266911", "bodyText": "Thanks for your comments, I will fix the comments.", "author": "shenh062326", "createdAt": "2020-07-28T01:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTQ2Ng==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460415466", "bodyText": "can we test for both cases, i.e. user defined field and non user defined field for detele marker field", "author": "nsivabalan", "createdAt": "2020-07-25T15:29:08Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -54,16 +55,16 @@ public void testActiveRecords() throws IOException {\n     record1.put(\"id\", \"1\");\n     record1.put(\"partition\", \"partition0\");\n     record1.put(\"ts\", 0L);\n-    record1.put(\"_hoodie_is_deleted\", false);\n+    record1.put(deleteField, false);", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTY4NQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460415685", "bodyText": "try to avoid hardcoding test records. If you generate in a for loop, it wud be easy to scale tests.", "author": "nsivabalan", "createdAt": "2020-07-25T15:31:23Z", "path": "hudi-spark/src/test/scala/org/apache/hudi/functional/HoodieSparkSqlWriterSuite.scala", "diffHunk": "@@ -100,6 +100,53 @@ class HoodieSparkSqlWriterSuite extends FunSuite with Matchers {\n     }\n   }\n \n+  test(\"test OverwriteWithLatestAvroPayload with user defined delete field\") {\n+    val session = SparkSession.builder()\n+      .appName(\"test_append_mode\")\n+      .master(\"local[2]\")\n+      .config(\"spark.serializer\", \"org.apache.spark.serializer.KryoSerializer\")\n+      .getOrCreate()\n+    val path = java.nio.file.Files.createTempDirectory(\"hoodie_test_path1\")\n+\n+    try {\n+      val sqlContext = session.sqlContext\n+      val hoodieFooTableName = \"hoodie_foo_tbl\"\n+\n+      val keyField = \"id\"\n+      val deleteField = \"delete_field\"\n+\n+      //create a new table\n+      val fooTableModifier = Map(\"path\" -> path.toAbsolutePath.toString,\n+        HoodieWriteConfig.TABLE_NAME -> hoodieFooTableName,\n+        \"hoodie.insert.shuffle.parallelism\" -> \"2\",\n+        \"hoodie.upsert.shuffle.parallelism\" -> \"2\",\n+        DELETE_FIELD_OPT_KEY -> deleteField,\n+        RECORDKEY_FIELD_OPT_KEY -> keyField)\n+      val fooTableParams = HoodieSparkSqlWriter.parametersWithWriteDefaults(fooTableModifier)\n+\n+      val dataFrame = session.createDataFrame(Seq(\n+        (12, \"ming\", 20.23, \"2018-01-01T13:51:39.340396Z\", false),", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2ODI5Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r461668292", "bodyText": "Here the records is no need to scale, I will change the Seq to only contains 1 element.", "author": "shenh062326", "createdAt": "2020-07-28T15:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTc0NA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460415744", "bodyText": "can we also compare the record actually matches the active one and not the deleted one.", "author": "nsivabalan", "createdAt": "2020-07-25T15:31:58Z", "path": "hudi-spark/src/test/scala/org/apache/hudi/functional/HoodieSparkSqlWriterSuite.scala", "diffHunk": "@@ -100,6 +100,53 @@ class HoodieSparkSqlWriterSuite extends FunSuite with Matchers {\n     }\n   }\n \n+  test(\"test OverwriteWithLatestAvroPayload with user defined delete field\") {\n+    val session = SparkSession.builder()\n+      .appName(\"test_append_mode\")\n+      .master(\"local[2]\")\n+      .config(\"spark.serializer\", \"org.apache.spark.serializer.KryoSerializer\")\n+      .getOrCreate()\n+    val path = java.nio.file.Files.createTempDirectory(\"hoodie_test_path1\")\n+\n+    try {\n+      val sqlContext = session.sqlContext\n+      val hoodieFooTableName = \"hoodie_foo_tbl\"\n+\n+      val keyField = \"id\"\n+      val deleteField = \"delete_field\"\n+\n+      //create a new table\n+      val fooTableModifier = Map(\"path\" -> path.toAbsolutePath.toString,\n+        HoodieWriteConfig.TABLE_NAME -> hoodieFooTableName,\n+        \"hoodie.insert.shuffle.parallelism\" -> \"2\",\n+        \"hoodie.upsert.shuffle.parallelism\" -> \"2\",\n+        DELETE_FIELD_OPT_KEY -> deleteField,\n+        RECORDKEY_FIELD_OPT_KEY -> keyField)\n+      val fooTableParams = HoodieSparkSqlWriter.parametersWithWriteDefaults(fooTableModifier)\n+\n+      val dataFrame = session.createDataFrame(Seq(\n+        (12, \"ming\", 20.23, \"2018-01-01T13:51:39.340396Z\", false),\n+        (34, \"zhi\", 21.323, \"2018-01-01T13:52:39.340396Z\", false)\n+      )) toDF(keyField, \"name\", \"weight\", \"ts\", deleteField)\n+\n+      HoodieSparkSqlWriter.write(sqlContext, SaveMode.Append, fooTableParams, dataFrame)\n+      val recordCount1 = sqlContext.read.format(\"org.apache.hudi\").load(path.toString + \"/*/*.parquet\").count\n+      assert(recordCount1 == 2, \"result should be 2, but get \" + recordCount1)\n+\n+      val dataFrame2 = session.createDataFrame(Seq(\n+        (12, \"ming\", 20.23, \"2018-01-01T13:53:39.340396Z\", true),\n+        (34, \"zhi\", 30.3, \"2018-01-01T13:54:39.340396Z\", false)\n+      )) toDF(keyField, \"name\", \"weight\", \"ts\", deleteField)\n+      HoodieSparkSqlWriter.write(sqlContext, SaveMode.Append, fooTableParams, dataFrame2)\n+\n+      val recordCount = sqlContext.read.format(\"org.apache.hudi\").load(path.toString + \"/*/*.parquet\").count\n+      assert(recordCount == 1, \"result should be 1, but get \" + recordCount)", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTgzMQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460415831", "bodyText": "why not move this method to HoodieTestDataGenerator?", "author": "nsivabalan", "createdAt": "2020-07-25T15:33:12Z", "path": "hudi-utilities/src/test/java/org/apache/hudi/utilities/functional/TestDeltaStreamerWithOverwriteLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.utilities.functional;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.testutils.HoodieTestDataGenerator;\n+import org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer;\n+import org.apache.hudi.utilities.sources.ParquetDFSSource;\n+import org.apache.hudi.utilities.testutils.UtilitiesTestBase;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class TestDeltaStreamerWithOverwriteLatestAvroPayload extends UtilitiesTestBase {\n+  private static String PARQUET_SOURCE_ROOT;\n+  private static final String PROPS_FILENAME_TEST_PARQUET = \"test-parquet-dfs-source.properties\";\n+\n+  @BeforeAll\n+  public static void initClass() throws Exception {\n+    UtilitiesTestBase.initClass(true);\n+    PARQUET_SOURCE_ROOT = dfsBasePath + \"/parquetFiles\";\n+\n+    // prepare the configs.\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/base.properties\", dfs, dfsBasePath + \"/base.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/sql-transformer.properties\", dfs,\n+        dfsBasePath + \"/sql-transformer.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source.avsc\", dfs, dfsBasePath + \"/source.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source-flattened.avsc\", dfs, dfsBasePath + \"/source-flattened.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/target.avsc\", dfs, dfsBasePath + \"/target.avsc\");\n+  }\n+\n+  private static List<GenericRecord> genericRecords(int n, boolean isDeleteRecord, int instantTime) {", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMjUzOQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r460532539", "bodyText": "can we test for both default and user defined fields here.", "author": "nsivabalan", "createdAt": "2020-07-26T14:11:37Z", "path": "hudi-utilities/src/test/java/org/apache/hudi/utilities/functional/TestDeltaStreamerWithOverwriteLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.utilities.functional;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.testutils.HoodieTestDataGenerator;\n+import org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer;\n+import org.apache.hudi.utilities.sources.ParquetDFSSource;\n+import org.apache.hudi.utilities.testutils.UtilitiesTestBase;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class TestDeltaStreamerWithOverwriteLatestAvroPayload extends UtilitiesTestBase {\n+  private static String PARQUET_SOURCE_ROOT;\n+  private static final String PROPS_FILENAME_TEST_PARQUET = \"test-parquet-dfs-source.properties\";\n+\n+  @BeforeAll\n+  public static void initClass() throws Exception {\n+    UtilitiesTestBase.initClass(true);\n+    PARQUET_SOURCE_ROOT = dfsBasePath + \"/parquetFiles\";\n+\n+    // prepare the configs.\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/base.properties\", dfs, dfsBasePath + \"/base.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/sql-transformer.properties\", dfs,\n+        dfsBasePath + \"/sql-transformer.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source.avsc\", dfs, dfsBasePath + \"/source.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source-flattened.avsc\", dfs, dfsBasePath + \"/source-flattened.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/target.avsc\", dfs, dfsBasePath + \"/target.avsc\");\n+  }\n+\n+  private static List<GenericRecord> genericRecords(int n, boolean isDeleteRecord, int instantTime) {\n+    return IntStream.range(0, n).boxed().map(i -> {\n+      String partitionPath = \"partitionPath1\";\n+      HoodieKey key = new HoodieKey(\"id_\" + i, partitionPath);\n+      HoodieTestDataGenerator.KeyPartition kp = new HoodieTestDataGenerator.KeyPartition();\n+      kp.key = key;\n+      kp.partitionPath = partitionPath;\n+      return HoodieTestDataGenerator.generateGenericRecord(\n+          key.getRecordKey(), \"rider-\" + instantTime, \"driver-\" + instantTime, instantTime, isDeleteRecord, false);\n+    }).collect(Collectors.toList());\n+  }\n+\n+  @Test\n+  public void testOverwriteLatestAvroPayload() throws Exception {", "originalCommit": "78d1bbc79001dad1d8a2f6c92841707befa35191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NDg2Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r461674862", "bodyText": "Sure, I will add both.", "author": "shenh062326", "createdAt": "2020-07-28T15:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMjUzOQ=="}], "type": "inlineReview"}, {"oid": "45ff53fe7aa952600b0361c0c162b747f7169949", "url": "https://github.com/apache/hudi/commit/45ff53fe7aa952600b0361c0c162b747f7169949", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-28T15:39:23Z", "type": "forcePushed"}, {"oid": "8242cad9ee116261546bd067820630a3ea581df1", "url": "https://github.com/apache/hudi/commit/8242cad9ee116261546bd067820630a3ea581df1", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-07-29T01:46:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NTMwMA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463545300", "bodyText": "lets be uniform throughout. getDeleteMarkerField.", "author": "nsivabalan", "createdAt": "2020-07-31T10:58:12Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieWriteConfig.java", "diffHunk": "@@ -251,6 +253,10 @@ public int getMaxConsistencyCheckIntervalMs() {\n     return Integer.parseInt(props.getProperty(MAX_CONSISTENCY_CHECK_INTERVAL_MS_PROP));\n   }\n \n+  public String getDeleteField() {", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzNjAxNA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463936014", "bodyText": "Thanks for your comments, I will fix it.", "author": "shenh062326", "createdAt": "2020-08-01T07:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NTQ2OA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463545468", "bodyText": "deleteMarkerField", "author": "nsivabalan", "createdAt": "2020-07-31T10:58:43Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -37,14 +37,17 @@\n public class TestOverwriteWithLatestAvroPayload {\n \n   private Schema schema;\n+  String defaultDeleteField = \"_hoodie_is_deleted\";\n+  String deleteField = \"delete_field\";", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NjQzNQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463546435", "bodyText": "shouldn't this also be false.", "author": "nsivabalan", "createdAt": "2020-07-31T11:00:55Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -54,13 +57,15 @@ public void testActiveRecords() throws IOException {\n     record1.put(\"id\", \"1\");\n     record1.put(\"partition\", \"partition0\");\n     record1.put(\"ts\", 0L);\n-    record1.put(\"_hoodie_is_deleted\", false);\n+    record1.put(defaultDeleteField, false);\n+    record1.put(deleteField, true);", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzNTkzMg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463935932", "bodyText": "In fact, it does not matter whether deleteField is true or false here, only defaultDeleteField will affect decide the result.", "author": "shenh062326", "createdAt": "2020-08-01T07:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NjQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NjQ3OQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463546479", "bodyText": "same here.", "author": "nsivabalan", "createdAt": "2020-07-31T11:01:02Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -54,13 +57,15 @@ public void testActiveRecords() throws IOException {\n     record1.put(\"id\", \"1\");\n     record1.put(\"partition\", \"partition0\");\n     record1.put(\"ts\", 0L);\n-    record1.put(\"_hoodie_is_deleted\", false);\n+    record1.put(defaultDeleteField, false);\n+    record1.put(deleteField, true);\n \n     GenericRecord record2 = new GenericData.Record(schema);\n     record2.put(\"id\", \"2\");\n     record2.put(\"partition\", \"partition1\");\n     record2.put(\"ts\", 1L);\n-    record2.put(\"_hoodie_is_deleted\", false);\n+    record2.put(defaultDeleteField, false);\n+    record2.put(deleteField, true);", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzNTk3OQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463935979", "bodyText": "The same as above.", "author": "shenh062326", "createdAt": "2020-08-01T07:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0NjQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0Nzc1Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463547752", "bodyText": "can we also fix lines 70 and 71. While creating the OverwriteWithLatestAvroPayload, pass in the delete field marker. Again, can we test for both default and user defined. So, since these are active field, existing assertions should work.", "author": "nsivabalan", "createdAt": "2020-07-31T11:04:29Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -80,13 +85,16 @@ public void testDeletedRecord() throws IOException {\n     record1.put(\"id\", \"1\");\n     record1.put(\"partition\", \"partition0\");\n     record1.put(\"ts\", 0L);\n-    record1.put(\"_hoodie_is_deleted\", false);\n+    record1.put(defaultDeleteField, false);", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODAzMw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463548033", "bodyText": "generateGenericRecords.", "author": "nsivabalan", "createdAt": "2020-07-31T11:05:08Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestDataGenerator.java", "diffHunk": "@@ -177,6 +178,18 @@ public RawTripTestPayload generateRandomValueAsPerSchema(String schemaStr, Hoodi\n     return null;\n   }\n \n+  public static List<GenericRecord> genericRecords(int n, boolean isDeleteRecord, int instantTime) {", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODQzMg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463548432", "bodyText": "deleteMarkerField", "author": "nsivabalan", "createdAt": "2020-07-31T11:06:10Z", "path": "hudi-spark/src/main/java/org/apache/hudi/DataSourceUtils.java", "diffHunk": "@@ -215,11 +216,20 @@ public static HoodieDateTimeParser createDateTimeParser(TypedProperties props, S\n   /**\n    * Create a payload class via reflection, passing in an ordering/precombine value.\n    */\n-  public static HoodieRecordPayload createPayload(String payloadClass, GenericRecord record, Comparable orderingVal)\n-      throws IOException {\n+  public static HoodieRecordPayload createPayload(String payloadClass, GenericRecord record,\n+                                                  Comparable orderingVal,\n+                                                  String deleteField) throws IOException {", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODQ3OA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463548478", "bodyText": "deleteMarkerField", "author": "nsivabalan", "createdAt": "2020-07-31T11:06:18Z", "path": "hudi-spark/src/main/java/org/apache/hudi/DataSourceUtils.java", "diffHunk": "@@ -275,8 +285,9 @@ public static HoodieWriteClient createHoodieClient(JavaSparkContext jssc, String\n   }\n \n   public static HoodieRecord createHoodieRecord(GenericRecord gr, Comparable orderingVal, HoodieKey hKey,\n-                                                String payloadClass) throws IOException {\n-    HoodieRecordPayload payload = DataSourceUtils.createPayload(payloadClass, gr, orderingVal);\n+                                                String payloadClass,\n+                                                String deleteField) throws IOException {", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODk1Ng==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463548956", "bodyText": "deleteMarkerField", "author": "nsivabalan", "createdAt": "2020-07-31T11:07:35Z", "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -337,9 +337,11 @@ private void refreshTimeline() throws IOException {\n     }\n \n     JavaRDD<GenericRecord> avroRDD = avroRDDOptional.get();\n+    String deleteField = props.getString(HoodieWriteConfig.DELETE_FIELD_PROP, HoodieWriteConfig.DEFAULT_DELETE_FIELD);", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0OTE5Mw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463549193", "bodyText": "private", "author": "nsivabalan", "createdAt": "2020-07-31T11:08:16Z", "path": "hudi-utilities/src/test/java/org/apache/hudi/utilities/functional/TestDeltaStreamerWithOverwriteLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.utilities.functional;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.testutils.HoodieTestDataGenerator;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer;\n+import org.apache.hudi.utilities.sources.ParquetDFSSource;\n+import org.apache.hudi.utilities.testutils.UtilitiesTestBase;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+public class TestDeltaStreamerWithOverwriteLatestAvroPayload extends UtilitiesTestBase {\n+  private static String PARQUET_SOURCE_ROOT;\n+  private static final String PROPS_FILENAME_TEST_PARQUET = \"test-parquet-dfs-source.properties\";\n+\n+  @BeforeAll\n+  public static void initClass() throws Exception {\n+    UtilitiesTestBase.initClass(true);\n+    PARQUET_SOURCE_ROOT = dfsBasePath + \"/parquetFiles\";\n+\n+    // prepare the configs.\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/base.properties\", dfs, dfsBasePath + \"/base.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/sql-transformer.properties\", dfs,\n+        dfsBasePath + \"/sql-transformer.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source.avsc\", dfs, dfsBasePath + \"/source.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source-flattened.avsc\", dfs, dfsBasePath + \"/source-flattened.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/target.avsc\", dfs, dfsBasePath + \"/target.avsc\");\n+  }\n+\n+  @Test\n+  public void testOverwriteLatestAvroPayload() throws Exception {\n+    // test defaultDeleteField\n+    this.testOverwriteLatestAvroPayload(null);\n+\n+    // test userDefinedDeleteField\n+    this.testOverwriteLatestAvroPayload(\"user_defined_delete_field\");\n+  }\n+\n+  public void testOverwriteLatestAvroPayload(String deleteMarkerField) throws Exception {", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0OTk0Mw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463549943", "bodyText": "is it possible to verify the records for equality ?", "author": "nsivabalan", "createdAt": "2020-07-31T11:10:18Z", "path": "hudi-utilities/src/test/java/org/apache/hudi/utilities/functional/TestDeltaStreamerWithOverwriteLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.utilities.functional;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.testutils.HoodieTestDataGenerator;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer;\n+import org.apache.hudi.utilities.sources.ParquetDFSSource;\n+import org.apache.hudi.utilities.testutils.UtilitiesTestBase;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+public class TestDeltaStreamerWithOverwriteLatestAvroPayload extends UtilitiesTestBase {\n+  private static String PARQUET_SOURCE_ROOT;\n+  private static final String PROPS_FILENAME_TEST_PARQUET = \"test-parquet-dfs-source.properties\";\n+\n+  @BeforeAll\n+  public static void initClass() throws Exception {\n+    UtilitiesTestBase.initClass(true);\n+    PARQUET_SOURCE_ROOT = dfsBasePath + \"/parquetFiles\";\n+\n+    // prepare the configs.\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/base.properties\", dfs, dfsBasePath + \"/base.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/sql-transformer.properties\", dfs,\n+        dfsBasePath + \"/sql-transformer.properties\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source.avsc\", dfs, dfsBasePath + \"/source.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/source-flattened.avsc\", dfs, dfsBasePath + \"/source-flattened.avsc\");\n+    UtilitiesTestBase.Helpers.copyToDFS(\"delta-streamer-config/target.avsc\", dfs, dfsBasePath + \"/target.avsc\");\n+  }\n+\n+  @Test\n+  public void testOverwriteLatestAvroPayload() throws Exception {\n+    // test defaultDeleteField\n+    this.testOverwriteLatestAvroPayload(null);\n+\n+    // test userDefinedDeleteField\n+    this.testOverwriteLatestAvroPayload(\"user_defined_delete_field\");\n+  }\n+\n+  public void testOverwriteLatestAvroPayload(String deleteMarkerField) throws Exception {\n+    String path = PARQUET_SOURCE_ROOT + \"/1.parquet\";\n+    List<GenericRecord> records = HoodieTestDataGenerator.genericRecords(5, false, 0);\n+    Helpers.saveParquetToDFS(records, new Path(path));\n+\n+    TypedProperties parquetProps = new TypedProperties();\n+    parquetProps.setProperty(\"include\", \"base.properties\");\n+    parquetProps.setProperty(\"hoodie.datasource.write.recordkey.field\", \"_row_key\");\n+    parquetProps.setProperty(\"hoodie.datasource.write.partitionpath.field\", \"not_there\");\n+    parquetProps.setProperty(\"hoodie.deltastreamer.source.dfs.root\", PARQUET_SOURCE_ROOT);\n+    if (deleteMarkerField != null) {\n+      parquetProps.setProperty(HoodieWriteConfig.DELETE_FIELD_PROP, deleteMarkerField);\n+    }\n+    Helpers.savePropsToDFS(parquetProps, dfs, dfsBasePath + \"/\" + PROPS_FILENAME_TEST_PARQUET);\n+\n+    String tableBasePath = dfsBasePath + \"/test_overwrite_lastest_avro_payload_table\";\n+\n+    HoodieDeltaStreamer deltaStreamer = new HoodieDeltaStreamer(\n+        TestHoodieDeltaStreamer.TestHelpers.makeConfig(tableBasePath, HoodieDeltaStreamer.Operation.INSERT, ParquetDFSSource.class.getName(),\n+            null, PROPS_FILENAME_TEST_PARQUET, false,\n+            false, 100000, false, null, null, \"timestamp\"), jsc);\n+    deltaStreamer.sync();\n+    TestHoodieDeltaStreamer.TestHelpers.assertRecordCount(5, tableBasePath + \"/*/*.parquet\", sqlContext);\n+\n+    String path2 = PARQUET_SOURCE_ROOT + \"/2.parquet\";\n+    List<GenericRecord> records2 = HoodieTestDataGenerator.genericRecords(2, true, 1);\n+    Helpers.saveParquetToDFS(records2, new Path(path2));\n+    deltaStreamer.sync();\n+\n+    TestHoodieDeltaStreamer.TestHelpers.assertRecordCount(3, tableBasePath + \"/*/*.parquet\", sqlContext);", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk0MDU4Nw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463940587", "bodyText": "Since the returned Spark Row is not easy to compare with GenericRecord, it is easier for us to compare only the key.", "author": "shenh062326", "createdAt": "2020-08-01T08:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0OTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU1MDU3Nw==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463550577", "bodyText": "we could move this to a private method and so lines 99 tp 108 and 110 to 120 can re-use code", "author": "nsivabalan", "createdAt": "2020-07-31T11:12:04Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -98,6 +106,18 @@ public void testDeletedRecord() throws IOException {\n \n     assertEquals(payload1.combineAndGetUpdateValue(delRecord1, schema).get(), record1);\n     assertFalse(payload2.combineAndGetUpdateValue(record1, schema).isPresent());\n+\n+    // test userDefinedDeleteField", "originalCommit": "8242cad9ee116261546bd067820630a3ea581df1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d8cceff60a7897df5d40a534680ed651f194e19", "url": "https://github.com/apache/hudi/commit/9d8cceff60a7897df5d40a534680ed651f194e19", "message": "[HUDI-1054] Several performance fixes during finalizing writes (#1768)\n\nCo-authored-by: Udit Mehrotra <uditme@amazon.com>", "committedDate": "2020-08-01T08:09:51Z", "type": "forcePushed"}, {"oid": "57a2d7a6ba84d227302152a819a076cf4ac68f85", "url": "https://github.com/apache/hudi/commit/57a2d7a6ba84d227302152a819a076cf4ac68f85", "message": "[HUDI-1054] Several performance fixes during finalizing writes (#1768)\n\nCo-authored-by: Udit Mehrotra <uditme@amazon.com>", "committedDate": "2020-08-01T08:46:19Z", "type": "forcePushed"}, {"oid": "242c97994194b666c4ed5437ca97a04097cf24d2", "url": "https://github.com/apache/hudi/commit/242c97994194b666c4ed5437ca97a04097cf24d2", "message": "[HUDI-1054] Several performance fixes during finalizing writes (#1768)\n\nCo-authored-by: Udit Mehrotra <uditme@amazon.com>", "committedDate": "2020-08-01T12:56:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3OTE5MQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463979191", "bodyText": "sorry, why making these changes in this PR ? This PR is meant for delete marker field. are these changes related to user defined delete marker field ?", "author": "nsivabalan", "createdAt": "2020-08-01T16:45:56Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/HoodieTimelineArchiveLog.java", "diffHunk": "@@ -267,15 +268,15 @@ private boolean deleteAllInstantsOlderorEqualsInAuxMetaFolder(HoodieInstant thre\n     return success;\n   }\n \n-  public void archive(List<HoodieInstant> instants) throws HoodieCommitException {\n+  public void archive(JavaSparkContext jsc, List<HoodieInstant> instants) throws HoodieCommitException {\n     try {\n       HoodieTimeline commitTimeline = metaClient.getActiveTimeline().getAllCommitsTimeline().filterCompletedInstants();\n       Schema wrapperSchema = HoodieArchivedMetaEntry.getClassSchema();\n       LOG.info(\"Wrapper schema \" + wrapperSchema.toString());\n       List<IndexedRecord> records = new ArrayList<>();\n       for (HoodieInstant hoodieInstant : instants) {\n         try {\n-          deleteAnyLeftOverMarkerFiles(hoodieInstant);\n+          deleteAnyLeftOverMarkerFiles(jsc, hoodieInstant);", "originalCommit": "242c97994194b666c4ed5437ca97a04097cf24d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAxMDcyNA==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r464010724", "bodyText": "sorry, It does not belong to this pull request, I will remove it.", "author": "shenh062326", "createdAt": "2020-08-01T23:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3OTE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3OTQ5Mg==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r463979492", "bodyText": "actually we could test this way. not sure if you already do that.\nset default marker field value to true and user defined to false. If OverwriteWithLatestAvro is instantiated w/o any marker fields, the record should be deleted. If OverwriteWithLatestAvro is instantiated w/ user defined marker field, the record should be considered active. Vice versa as well. All tests in this class could be done this way to ensure that the other column is treated as yet another user's data column and hoodie does not care about it.", "author": "nsivabalan", "createdAt": "2020-08-01T16:49:48Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -54,13 +57,15 @@ public void testActiveRecords() throws IOException {\n     record1.put(\"id\", \"1\");\n     record1.put(\"partition\", \"partition0\");\n     record1.put(\"ts\", 0L);\n-    record1.put(\"_hoodie_is_deleted\", false);\n+    record1.put(defaultDeleteMarkerField, false);", "originalCommit": "242c97994194b666c4ed5437ca97a04097cf24d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAxMjQ0NQ==", "url": "https://github.com/apache/hudi/pull/1819#discussion_r464012445", "bodyText": "I will fix the comment.", "author": "shenh062326", "createdAt": "2020-08-01T23:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk3OTQ5Mg=="}], "type": "inlineReview"}, {"oid": "d6048093ce4979eb492251d47499c737acb156fa", "url": "https://github.com/apache/hudi/commit/d6048093ce4979eb492251d47499c737acb156fa", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-08-01T23:58:20Z", "type": "commit"}, {"oid": "d6048093ce4979eb492251d47499c737acb156fa", "url": "https://github.com/apache/hudi/commit/d6048093ce4979eb492251d47499c737acb156fa", "message": "[HUDI-1058] Make delete marker configurable", "committedDate": "2020-08-01T23:58:20Z", "type": "forcePushed"}]}