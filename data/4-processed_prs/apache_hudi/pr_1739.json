{"pr_number": 1739, "pr_title": "[HUDI-760]Remove Rolling Stat management from Hudi Writer", "pr_createdAt": "2020-06-16T13:07:03Z", "pr_url": "https://github.com/apache/hudi/pull/1739", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNTQ5Mg==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447815492", "bodyText": "Since, this method is just callling writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat)); , can we remove this function altogether and move \"writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));\" to the caller.", "author": "bvaradar", "createdAt": "2020-06-30T16:25:06Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -177,44 +175,7 @@ protected void finalizeWrite(HoodieTable<T> table, String instantTime, List<Hood\n \n   private void updateMetadataAndRollingStats(String actionType, HoodieCommitMetadata metadata,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NjI0NQ==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447956245", "bodyText": "Good suggestion, fixed", "author": "baobaoyeye", "createdAt": "2020-06-30T20:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNzM2OA==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447817368", "bodyText": "Same case for this also. Can you remove this method and move \"writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));\" to caller", "author": "bvaradar", "createdAt": "2020-06-30T16:27:40Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/BaseCommitActionExecutor.java", "diffHunk": "@@ -231,15 +231,7 @@ protected void finalizeWrite(String instantTime, List<HoodieWriteStat> stats, Ho\n   }\n \n   private void updateMetadataAndRollingStats(HoodieCommitMetadata metadata, List<HoodieWriteStat> writeStats) {\n-    // 1. Look up the previous compaction/commit and get the HoodieCommitMetadata from there.\n-    // 2. Now, first read the existing rolling stats and merge with the result of current metadata.\n-\n-    // Need to do this on every commit (delta or commit) to support COW and MOR.\n-    for (HoodieWriteStat stat : writeStats) {\n-      String partitionPath = stat.getPartitionPath();\n-      // TODO: why is stat.getPartitionPath() null at times here.\n-      metadata.addWriteStat(partitionPath, stat);\n-    }\n+    writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NjM3Ng==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447956376", "bodyText": "Good suggestion, fixed", "author": "baobaoyeye", "createdAt": "2020-06-30T20:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNzM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMjkxOQ==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447822919", "bodyText": "Rename to testMetadataStatsOnCommit", "author": "bvaradar", "createdAt": "2020-06-30T16:34:55Z", "path": "hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "diffHunk": "@@ -849,7 +848,7 @@ public void testCommitWritesRelativePaths() throws Exception {\n   }\n \n   /**\n-   * Test to ensure commit metadata points to valid files.\n+   * Test to ensure commit metadata points to valid files.10.\n    */\n   @Test\n   public void testRollingStatsInMetadata() throws Exception {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NjUwMg==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447956502", "bodyText": "fixed", "author": "baobaoyeye", "createdAt": "2020-06-30T20:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMjkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTE1OQ==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447825159", "bodyText": "Also rename this test in the same way.", "author": "bvaradar", "createdAt": "2020-06-30T16:37:55Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/TestHoodieMergeOnReadTable.java", "diffHunk": "@@ -1094,14 +1093,10 @@ public void testRollingStatsInMetadata() throws Exception {\n       HoodieCommitMetadata metadata = HoodieCommitMetadata.fromBytes(\n           table.getActiveTimeline().getInstantDetails(table.getActiveTimeline().getDeltaCommitTimeline().lastInstant().get()).get(),\n           HoodieCommitMetadata.class);\n-      HoodieRollingStatMetadata rollingStatMetadata = HoodieCommitMetadata.fromBytes(\n-          metadata.getExtraMetadata().get(HoodieRollingStatMetadata.ROLLING_STAT_METADATA_KEY).getBytes(),\n-          HoodieRollingStatMetadata.class);\n       int inserts = 0;\n-      for (Map.Entry<String, Map<String, HoodieRollingStat>> pstat : rollingStatMetadata.getPartitionToRollingStats()\n-          .entrySet()) {\n-        for (Map.Entry<String, HoodieRollingStat> stat : pstat.getValue().entrySet()) {\n-          inserts += stat.getValue().getInserts();\n+      for (Map.Entry<String, List<HoodieWriteStat>> pstat : metadata.getPartitionToWriteStats().entrySet()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NjU1OQ==", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447956559", "bodyText": "fixed", "author": "baobaoyeye", "createdAt": "2020-06-30T20:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTE1OQ=="}], "type": "inlineReview"}, {"oid": "8eaff57aa7a458c1c044433a8820226b60bc2694", "url": "https://github.com/apache/hudi/commit/8eaff57aa7a458c1c044433a8820226b60bc2694", "message": "[HUDI-760]Remove Rolling Stat management from Hudi Writer", "committedDate": "2020-06-30T20:16:39Z", "type": "commit"}, {"oid": "8eaff57aa7a458c1c044433a8820226b60bc2694", "url": "https://github.com/apache/hudi/commit/8eaff57aa7a458c1c044433a8820226b60bc2694", "message": "[HUDI-760]Remove Rolling Stat management from Hudi Writer", "committedDate": "2020-06-30T20:16:39Z", "type": "forcePushed"}]}