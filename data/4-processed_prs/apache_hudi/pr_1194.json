{"pr_number": 1194, "pr_title": "[HUDI-326] Add support to delete records with only record_key", "pr_createdAt": "2020-01-06T22:07:28Z", "pr_url": "https://github.com/apache/hudi/pull/1194", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NDAwMw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r363554003", "bodyText": "This is not very desirable since this is only required for deletion purposes and does not add any other value. Each implementation of the Index already has a method that describes whether it's global or not.", "author": "n3nash", "createdAt": "2020-01-07T01:11:36Z", "path": "hudi-client/src/main/java/org/apache/hudi/index/HoodieIndex.java", "diffHunk": "@@ -43,6 +44,8 @@\n  */\n public abstract class HoodieIndex<T extends HoodieRecordPayload> implements Serializable {\n \n+  public static EnumSet<IndexType> GLOBAL_INDICES = EnumSet.of(IndexType.GLOBAL_BLOOM, IndexType.HBASE);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NDM3NA==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r363554374", "bodyText": "There is a NonPartitionedKeyGenerator that you can pass and use for deletions. Since as a client you are aware of 2 facts a) Either you are using GLOBAL_INDEX or not b) If this batch is for Deletions, you can configure the hudi client accordingly with a correct partition generator -> https://github.com/apache/incubator-hudi/blob/master/hudi-spark/src/main/java/org/apache/hudi/NonpartitionedKeyGenerator.java\nMay be we can extend this class to reflect the correct key generation strategy for deletions with a more reasonable explicit name", "author": "n3nash", "createdAt": "2020-01-07T01:13:30Z", "path": "hudi-spark/src/main/scala/org/apache/hudi/HoodieSparkSqlWriter.scala", "diffHunk": "@@ -161,7 +162,17 @@ private[hudi] object HoodieSparkSqlWriter {\n       // Convert to RDD[HoodieKey]\n       val keyGenerator = DataSourceUtils.createKeyGenerator(toProperties(parameters))\n       val genericRecords: RDD[GenericRecord] = AvroConversionUtils.createRdd(df, structName, nameSpace)\n-      val hoodieKeysToDelete = genericRecords.map(gr => keyGenerator.getKey(gr)).toJavaRDD()\n+      val hoodieKeysToDelete = if (HoodieIndex.GLOBAL_INDICES.contains(parameters(HoodieIndexConfig.INDEX_TYPE_PROP))) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg2OTk5MQ==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r363869991", "bodyText": "@n3nash thanks for bringing that keyGenerator to my attention. That better serves my use case. Do you think extending it into a \"GlobalDeleteKeyGenerator\" would be a valid change instead? Or possibly creating an entirely new keyGenerator for global deletes instead, because the nonpartitionedKeyGenerator would not work if you are using the complex key generator.", "author": "bschell", "createdAt": "2020-01-07T17:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkxMDQ3Mg==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r363910472", "bodyText": "I think just create an entirely new keyGenerator since tables with GlobalIndex can still be partitioned, all we are doing is here allowing us to pass just the record_keys to be able to delete those records.", "author": "n3nash", "createdAt": "2020-01-07T19:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NDM3NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365045991", "bodyText": "Can you use this : https://github.com/apache/incubator-hudi/blob/master/hudi-common/src/main/java/org/apache/hudi/common/util/StringUtils.java#L67 ?\nAnd have the throws Exception in the else part that way you won't need an extra variable to track this.", "author": "n3nash", "createdAt": "2020-01-10T02:12:29Z", "path": "hudi-spark/src/main/java/org/apache/hudi/keygen/GlobalDeleteKeyGenerator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.keygen;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.DataSourceUtils;\n+import org.apache.hudi.DataSourceWriteOptions;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.util.TypedProperties;\n+import org.apache.hudi.exception.HoodieKeyException;\n+\n+/**\n+ * Key generator for deletes using global indices. Global index deletes do not require partition value\n+ * so this key generator avoids using partition value for generating HoodieKey.\n+ */\n+public class GlobalDeleteKeyGenerator extends KeyGenerator {\n+\n+  private static final String EMPTY_PARTITION = \"\";\n+  private static final String NULL_RECORDKEY_PLACEHOLDER = \"__null__\";\n+  private static final String EMPTY_RECORDKEY_PLACEHOLDER = \"__empty__\";\n+\n+  protected final List<String> recordKeyFields;\n+\n+  public GlobalDeleteKeyGenerator(TypedProperties config) {\n+    super(config);\n+    this.recordKeyFields = Arrays.asList(config.getString(DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY()).split(\",\"));\n+  }\n+\n+  @Override\n+  public HoodieKey getKey(GenericRecord record) {\n+    if (recordKeyFields == null) {\n+      throw new HoodieKeyException(\"Unable to find field names for record key or partition path in cfg\");\n+    }\n+\n+    boolean keyIsNullEmpty = true;\n+    StringBuilder recordKey = new StringBuilder();\n+    for (String recordKeyField : recordKeyFields) {\n+      String recordKeyValue = DataSourceUtils.getNestedFieldValAsString(record, recordKeyField, true);\n+      if (recordKeyValue == null) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2Mjg0NQ==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365062845", "bodyText": "Will change to this", "author": "bschell", "createdAt": "2020-01-10T03:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2MzE0OA==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365063148", "bodyText": "Actually do you want to remove the distinction between null/empty? I would rather keep it as I have seen users with both null and empty columns.", "author": "bschell", "createdAt": "2020-01-10T03:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1OTc2Mw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365459763", "bodyText": "@n3nash For more context, am trying to maintain record_key compatibility with\nhttps://github.com/apache/incubator-hudi/blob/master/hudi-spark/src/main/java/org/apache/hudi/ComplexKeyGenerator.java", "author": "bschell", "createdAt": "2020-01-10T22:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3ODAyNA==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365478024", "bodyText": "Interesting, I think we should fix the ComplexKeyGenerator as well, writing extra bytes like \"null\" just to denote null values doesn't seem like the best idea for data lakes.\nCan you open a ticket for addressing that ? We can for now keep this implementation consistent with ComplexKeyGenerator. Once you open the ticket, please link it here and squash your commits to 1 then I can merge this PR, thanks", "author": "n3nash", "createdAt": "2020-01-11T00:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDgzNw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365490837", "bodyText": "good point, will do.", "author": "bschell", "createdAt": "2020-01-11T02:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NTk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NjU1Mw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365046553", "bodyText": "If the recordkey is \"null\" what is the advantage of creating a record with this string ? There wouldn't be any records with that value in the first place right ?", "author": "n3nash", "createdAt": "2020-01-10T02:15:21Z", "path": "hudi-spark/src/main/java/org/apache/hudi/keygen/GlobalDeleteKeyGenerator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.keygen;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.DataSourceUtils;\n+import org.apache.hudi.DataSourceWriteOptions;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.util.TypedProperties;\n+import org.apache.hudi.exception.HoodieKeyException;\n+\n+/**\n+ * Key generator for deletes using global indices. Global index deletes do not require partition value\n+ * so this key generator avoids using partition value for generating HoodieKey.\n+ */\n+public class GlobalDeleteKeyGenerator extends KeyGenerator {\n+\n+  private static final String EMPTY_PARTITION = \"\";\n+  private static final String NULL_RECORDKEY_PLACEHOLDER = \"__null__\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2Mjc4Mg==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r365062782", "bodyText": "It is for the case when the record_key is a composite key comprised of 2 different columns. One could be null while the other has a value.", "author": "bschell", "createdAt": "2020-01-10T03:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0NjU1Mw=="}], "type": "inlineReview"}, {"oid": "f200c23f454191865f59c9840f988f1430490e2c", "url": "https://github.com/apache/hudi/commit/f200c23f454191865f59c9840f988f1430490e2c", "message": "Add GlobalDeleteKeyGenerator\n\nAdds new GlobalDeleteKeyGenerator for record_key deletes with global indices. Also refactors key generators into their own package.", "committedDate": "2020-01-11T02:06:02Z", "type": "commit"}, {"oid": "f200c23f454191865f59c9840f988f1430490e2c", "url": "https://github.com/apache/hudi/commit/f200c23f454191865f59c9840f988f1430490e2c", "message": "Add GlobalDeleteKeyGenerator\n\nAdds new GlobalDeleteKeyGenerator for record_key deletes with global indices. Also refactors key generators into their own package.", "committedDate": "2020-01-11T02:06:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4ODk1Mw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r366088953", "bodyText": "This is a backwards incompatible change. Users would have custom key generators using configuration : DataSourceWriteOptions.KEYGENERATOR_CLASS_OPT_KEY()\nIt makes sense to move to separate package but we need to call out the change in release notes . Please open a tracking ticket to update release notes for this.", "author": "bvaradar", "createdAt": "2020-01-13T23:47:18Z", "path": "hudi-spark/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java", "diffHunk": "@@ -16,8 +16,10 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi;\n+package org.apache.hudi.keygen;", "originalCommit": "f200c23f454191865f59c9840f988f1430490e2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwNTM1OQ==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r366505359", "bodyText": "+1 @bschell", "author": "n3nash", "createdAt": "2020-01-14T18:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4ODk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTM5Mg==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r366091392", "bodyText": "@bschell : The only difference between GlobalDeleteKeyGenerator and ComplexKeyGenerator is that the former always creates an empty-partition path. right ? In that case, can we simply refactor the getKey() method in ComplexKeyGenerator and have GlobalDeleteKeyGenerator extend ComplexKeyGenerator with necessary changes to make it to work for empty partition-path. The advantage is we use all the logic related  to nested fields handling in one place ? Let me know your thoughts.", "author": "bvaradar", "createdAt": "2020-01-13T23:56:23Z", "path": "hudi-spark/src/main/java/org/apache/hudi/keygen/GlobalDeleteKeyGenerator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.keygen;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.DataSourceUtils;\n+import org.apache.hudi.DataSourceWriteOptions;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.util.TypedProperties;\n+import org.apache.hudi.exception.HoodieKeyException;\n+\n+/**\n+ * Key generator for deletes using global indices. Global index deletes do not require partition value\n+ * so this key generator avoids using partition value for generating HoodieKey.\n+ */\n+public class GlobalDeleteKeyGenerator extends KeyGenerator {\n+\n+  private static final String EMPTY_PARTITION = \"\";\n+  private static final String NULL_RECORDKEY_PLACEHOLDER = \"__null__\";\n+  private static final String EMPTY_RECORDKEY_PLACEHOLDER = \"__empty__\";\n+\n+  protected final List<String> recordKeyFields;\n+\n+  public GlobalDeleteKeyGenerator(TypedProperties config) {\n+    super(config);\n+    this.recordKeyFields = Arrays.asList(config.getString(DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY()).split(\",\"));\n+  }\n+\n+  @Override\n+  public HoodieKey getKey(GenericRecord record) {", "originalCommit": "f200c23f454191865f59c9840f988f1430490e2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwNjA1Mw==", "url": "https://github.com/apache/hudi/pull/1194#discussion_r366506053", "bodyText": "I think the point was to make the GlobalDeleteKeyGenerator work for any case, complex or simple.\n@bvaradar", "author": "n3nash", "createdAt": "2020-01-14T18:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTM5Mg=="}], "type": "inlineReview"}]}