{"pr_number": 1768, "pr_title": "[HUDI-1054][Peformance] Several performance fixes during finalizing writes", "pr_createdAt": "2020-06-27T01:29:11Z", "pr_url": "https://github.com/apache/hudi/pull/1768", "timeline": [{"oid": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "url": "https://github.com/apache/hudi/commit/6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "message": "[Peformance] Several performance fixes during finalizing writes for S3", "committedDate": "2020-06-27T03:10:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMjcxNQ==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446502715", "bodyText": "hudi-common is a base module and feels a little weird that it relies on spark-core/spark-sql, would we remove them and move getAllDataFilesForMarkers method to hudi-client module, wdyt? cc @bvaradar @vinothchandar", "author": "leesf", "createdAt": "2020-06-27T08:48:48Z", "path": "hudi-common/pom.xml", "diffHunk": "@@ -147,6 +147,16 @@\n       <scope>test</scope>\n     </dependency>\n \n+    <!-- Spark -->\n+    <dependency>\n+      <groupId>org.apache.spark</groupId>\n+      <artifactId>spark-core_${scala.binary.version}</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.spark</groupId>\n+      <artifactId>spark-sql_${scala.binary.version}</artifactId>\n+    </dependency>\n+", "originalCommit": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMTM1MQ==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446621351", "bodyText": "yes.. we cannot depend on spark in hudi-common", "author": "vinothchandar", "createdAt": "2020-06-28T08:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMjcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NDI2Mg==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r447264262", "bodyText": "Okay so is the suggestion to move this method over to HoodieTable in hudi-client module, considering that is the only place this method is used ?", "author": "umehrot2", "createdAt": "2020-06-29T21:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMjcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5NTM3Ng==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r447595376", "bodyText": "yes.. that ll do..", "author": "vinothchandar", "createdAt": "2020-06-30T10:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMjcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjMxNw==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446622317", "bodyText": "i think this is the reason for needing spark in hudi-common.. we can move refactor the code to hudi-client..\nIn fact, #1755  has already modularized this more..", "author": "vinothchandar", "createdAt": "2020-06-28T08:55:19Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/FSUtils.java", "diffHunk": "@@ -199,16 +201,40 @@ public static String getRelativePartitionPath(Path basePath, Path partitionPath)\n     return partitions;\n   }\n \n-  public static List<String> getAllDataFilesForMarkers(FileSystem fs, String basePath, String instantTs,\n-      String markerDir, String baseFileExtension) throws IOException {\n-    List<String> dataFiles = new LinkedList<>();\n-    processFiles(fs, markerDir, (status) -> {\n-      String pathStr = status.getPath().toString();\n-      if (pathStr.endsWith(HoodieTableMetaClient.MARKER_EXTN)) {\n-        dataFiles.add(FSUtils.translateMarkerToDataPath(basePath, pathStr, instantTs, baseFileExtension));\n+  public static Set<String> getAllDataFilesForMarkers(JavaSparkContext jsc, FileSystem fs, String basePath,", "originalCommit": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjU1MQ==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446622551", "bodyText": "@umehrot2 so seems like, for object stores this is different..  and makes sense completely to do parallel cleaning of individual files.", "author": "vinothchandar", "createdAt": "2020-06-28T08:56:39Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/HoodieTable.java", "diffHunk": "@@ -386,13 +389,26 @@ public void finalizeWrite(JavaSparkContext jsc, String instantTs, List<HoodieWri\n    *\n    * @param instantTs Instant Time\n    */\n-  public void deleteMarkerDir(String instantTs) {\n+  public void deleteMarkerDir(JavaSparkContext jsc, String instantTs) {\n     try {\n       FileSystem fs = getMetaClient().getFs();\n       Path markerDir = new Path(metaClient.getMarkerFolderPath(instantTs));\n+\n       if (fs.exists(markerDir)) {\n         // For append only case, we do not write to marker dir. Hence, the above check\n-        LOG.info(\"Removing marker directory=\" + markerDir);\n+        LOG.info(\"Removing marker directory = \" + markerDir);\n+\n+        FileStatus[] fileStatuses = fs.listStatus(markerDir);", "originalCommit": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjgwOA==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446622808", "bodyText": "cc @n3nash should we have flag to protect this for HDFS.. i.e if the recursive delete works better there (IIUC). you might want to tradeoff less RPCs ..?\nwe can override defaults at spark datasource level, and set these based on StorageSchemes as well.", "author": "vinothchandar", "createdAt": "2020-06-28T08:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MDI1OQ==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r455390259", "bodyText": "@vinothchandar I don't think there is any different between EmrFS which uses S3 vs HDFS working w.r.t RPC calls made here. EmrFS just implements the HDFS interface, but the internals like RPC calls to the namenode etc. remain the same.", "author": "umehrot2", "createdAt": "2020-07-15T22:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMjU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzEwMg==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446623102", "bodyText": "Math.min(subDirectories.size(), parallelism)?", "author": "vinothchandar", "createdAt": "2020-06-28T09:00:07Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/FSUtils.java", "diffHunk": "@@ -199,16 +201,40 @@ public static String getRelativePartitionPath(Path basePath, Path partitionPath)\n     return partitions;\n   }\n \n-  public static List<String> getAllDataFilesForMarkers(FileSystem fs, String basePath, String instantTs,\n-      String markerDir, String baseFileExtension) throws IOException {\n-    List<String> dataFiles = new LinkedList<>();\n-    processFiles(fs, markerDir, (status) -> {\n-      String pathStr = status.getPath().toString();\n-      if (pathStr.endsWith(HoodieTableMetaClient.MARKER_EXTN)) {\n-        dataFiles.add(FSUtils.translateMarkerToDataPath(basePath, pathStr, instantTs, baseFileExtension));\n+  public static Set<String> getAllDataFilesForMarkers(JavaSparkContext jsc, FileSystem fs, String basePath,\n+      String instantTs, String markerDir, String baseFileExtension, int parallelism) throws IOException {\n+    FileStatus[] topLevelStatuses = fs.listStatus(new Path(markerDir));\n+\n+    Set<String> dataFiles = new HashSet<>();\n+\n+    List<String> subDirectories = new ArrayList<>();\n+    for (FileStatus topLevelStatus: topLevelStatuses) {\n+      if (topLevelStatus.isFile()) {\n+        String pathStr = topLevelStatus.getPath().toString();\n+        if (pathStr.endsWith(HoodieTableMetaClient.MARKER_EXTN)) {\n+          dataFiles.add(FSUtils.translateMarkerToDataPath(basePath, pathStr, instantTs, baseFileExtension));\n+        }\n+      } else {\n+        subDirectories.add(topLevelStatus.getPath().toString());\n       }\n-      return true;\n-    }, false);\n+    }\n+\n+    parallelism = subDirectories.size() < parallelism ? subDirectories.size() : parallelism;", "originalCommit": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NDcxNg==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r447264716", "bodyText": "Will address in the next revision, one I have more feedback as needed from @n3nash", "author": "umehrot2", "createdAt": "2020-06-29T21:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzE2Mg==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r446623162", "bodyText": "similar question here.. cc @n3nash ..", "author": "vinothchandar", "createdAt": "2020-06-28T09:00:31Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/FSUtils.java", "diffHunk": "@@ -199,16 +201,40 @@ public static String getRelativePartitionPath(Path basePath, Path partitionPath)\n     return partitions;\n   }\n \n-  public static List<String> getAllDataFilesForMarkers(FileSystem fs, String basePath, String instantTs,\n-      String markerDir, String baseFileExtension) throws IOException {\n-    List<String> dataFiles = new LinkedList<>();\n-    processFiles(fs, markerDir, (status) -> {\n-      String pathStr = status.getPath().toString();\n-      if (pathStr.endsWith(HoodieTableMetaClient.MARKER_EXTN)) {\n-        dataFiles.add(FSUtils.translateMarkerToDataPath(basePath, pathStr, instantTs, baseFileExtension));\n+  public static Set<String> getAllDataFilesForMarkers(JavaSparkContext jsc, FileSystem fs, String basePath,\n+      String instantTs, String markerDir, String baseFileExtension, int parallelism) throws IOException {\n+    FileStatus[] topLevelStatuses = fs.listStatus(new Path(markerDir));\n+\n+    Set<String> dataFiles = new HashSet<>();\n+\n+    List<String> subDirectories = new ArrayList<>();\n+    for (FileStatus topLevelStatus: topLevelStatuses) {\n+      if (topLevelStatus.isFile()) {\n+        String pathStr = topLevelStatus.getPath().toString();\n+        if (pathStr.endsWith(HoodieTableMetaClient.MARKER_EXTN)) {\n+          dataFiles.add(FSUtils.translateMarkerToDataPath(basePath, pathStr, instantTs, baseFileExtension));\n+        }\n+      } else {\n+        subDirectories.add(topLevelStatus.getPath().toString());\n       }\n-      return true;\n-    }, false);\n+    }\n+\n+    parallelism = subDirectories.size() < parallelism ? subDirectories.size() : parallelism;\n+    dataFiles.addAll(jsc.parallelize(subDirectories, parallelism).flatMap(directory -> {", "originalCommit": "6fb69418431621ba4dbb1b42ac5c4d68be9b9137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb31ed55735de021bf04cd76b2051453e3f1b928", "url": "https://github.com/apache/hudi/commit/cb31ed55735de021bf04cd76b2051453e3f1b928", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-28T19:34:04Z", "type": "forcePushed"}, {"oid": "ca7c58ba4598bcda25abe803219e893664cfcdda", "url": "https://github.com/apache/hudi/commit/ca7c58ba4598bcda25abe803219e893664cfcdda", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-28T19:39:03Z", "type": "forcePushed"}, {"oid": "39108c11713a277aa172b063be789bcbae58479d", "url": "https://github.com/apache/hudi/commit/39108c11713a277aa172b063be789bcbae58479d", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-29T23:17:25Z", "type": "forcePushed"}, {"oid": "be8e6f48f849608d8178122d63f036a9462b918c", "url": "https://github.com/apache/hudi/commit/be8e6f48f849608d8178122d63f036a9462b918c", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-29T23:49:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NDY0Nw==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r462994647", "bodyText": "note to self: this will still work when subPath is a file. i.e non-partitioned tables", "author": "vinothchandar", "createdAt": "2020-07-30T13:27:00Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/MarkerFiles.java", "diffHunk": "@@ -64,44 +69,87 @@ public MarkerFiles(HoodieTable<?> table, String instantTime) {\n         instantTime);\n   }\n \n-  public void quietDeleteMarkerDir() {\n+  public void quietDeleteMarkerDir(JavaSparkContext jsc, int parallelism) {\n     try {\n-      deleteMarkerDir();\n+      deleteMarkerDir(jsc, parallelism);\n     } catch (HoodieIOException ioe) {\n       LOG.warn(\"Error deleting marker directory for instant \" + instantTime, ioe);\n     }\n   }\n \n   /**\n    * Delete Marker directory corresponding to an instant.\n+   *\n+   * @param jsc Java Spark Context\n+   * @param parallelism Spark parallelism for deletion\n    */\n-  public boolean deleteMarkerDir() {\n+  public boolean deleteMarkerDir(JavaSparkContext jsc, int parallelism) {\n     try {\n-      boolean result = fs.delete(markerDirPath, true);\n-      if (result) {\n+      if (fs.exists(markerDirPath)) {\n+        FileStatus[] fileStatuses = fs.listStatus(markerDirPath);\n+        List<String> markerDirSubPaths = Arrays.stream(fileStatuses)\n+                .map(fileStatus -> fileStatus.getPath().toString())\n+                .collect(Collectors.toList());\n+\n+        if (markerDirSubPaths.size() > 0) {\n+          SerializableConfiguration conf = new SerializableConfiguration(fs.getConf());\n+          parallelism = Math.min(markerDirSubPaths.size(), parallelism);\n+          jsc.parallelize(markerDirSubPaths, parallelism).foreach(subPathStr -> {\n+            Path subPath = new Path(subPathStr);\n+            FileSystem fileSystem = subPath.getFileSystem(conf.get());\n+            fileSystem.delete(subPath, true);", "originalCommit": "be8e6f48f849608d8178122d63f036a9462b918c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjkzOQ==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r462996939", "bodyText": "nit: better to have the static methods right at the top?", "author": "vinothchandar", "createdAt": "2020-07-30T13:30:25Z", "path": "hudi-client/src/main/java/org/apache/hudi/table/MarkerFiles.java", "diffHunk": "@@ -110,6 +158,10 @@ private String translateMarkerToDataPath(String markerPath) {\n     return MarkerFiles.stripMarkerSuffix(rPath);\n   }\n \n+  public static String stripMarkerSuffix(String path) {", "originalCommit": "be8e6f48f849608d8178122d63f036a9462b918c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyMzYwNA==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r463323604", "bodyText": "I can change it back, but is there a code style guide we are following ? I haven't seen this rule in google style guide for java atleast.", "author": "umehrot2", "createdAt": "2020-07-30T23:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDcwMw==", "url": "https://github.com/apache/hudi/pull/1768#discussion_r463404703", "bodyText": "this is not checkstyle enforced atm. So I am happy to let this be.", "author": "vinothchandar", "createdAt": "2020-07-31T04:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjkzOQ=="}], "type": "inlineReview"}, {"oid": "8ad8a262b8581c23e4648304db6b493a2deb1a42", "url": "https://github.com/apache/hudi/commit/8ad8a262b8581c23e4648304db6b493a2deb1a42", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-31T17:37:22Z", "type": "forcePushed"}, {"oid": "4cecc151fd8b7df6b46a437ada2ba8ce94a515a9", "url": "https://github.com/apache/hudi/commit/4cecc151fd8b7df6b46a437ada2ba8ce94a515a9", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-31T19:58:12Z", "type": "commit"}, {"oid": "4cecc151fd8b7df6b46a437ada2ba8ce94a515a9", "url": "https://github.com/apache/hudi/commit/4cecc151fd8b7df6b46a437ada2ba8ce94a515a9", "message": "[Peformance] Several performance fixes during finalizing writes", "committedDate": "2020-07-31T19:58:12Z", "type": "forcePushed"}]}