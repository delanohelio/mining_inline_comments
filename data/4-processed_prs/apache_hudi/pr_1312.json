{"pr_number": 1312, "pr_title": "[HUDI-571] Add \"compactions show archived\" command to CLI", "pr_createdAt": "2020-02-08T01:03:26Z", "pr_url": "https://github.com/apache/hudi/pull/1312", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQzMzA4Ng==", "url": "https://github.com/apache/hudi/pull/1312#discussion_r378433086", "bodyText": "Pass timeline containing commit + compaction actions only, instead of activeTimeline (which may have other actions)?\nHoodieTimeline timeline = activeTimeline.getCommitsAndCompactionTimeline();", "author": "nbalajee", "createdAt": "2020-02-12T18:28:11Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/CompactionCommand.java", "diffHunk": "@@ -95,51 +101,9 @@ public String compactionsAll(\n       throws IOException {\n     HoodieTableMetaClient client = checkAndGetMetaClient();\n     HoodieActiveTimeline activeTimeline = client.getActiveTimeline();\n-    HoodieTimeline timeline = activeTimeline.getCommitsAndCompactionTimeline();\n-    HoodieTimeline commitTimeline = activeTimeline.getCommitTimeline().filterCompletedInstants();\n-    Set<String> committed = commitTimeline.getInstants().map(HoodieInstant::getTimestamp).collect(Collectors.toSet());\n-\n-    List<HoodieInstant> instants = timeline.getReverseOrderedInstants().collect(Collectors.toList());\n-    List<Comparable[]> rows = new ArrayList<>();\n-    for (HoodieInstant instant : instants) {\n-      HoodieCompactionPlan compactionPlan = null;\n-      if (!HoodieTimeline.COMPACTION_ACTION.equals(instant.getAction())) {\n-        try {\n-          // This could be a completed compaction. Assume a compaction request file is present but skip if fails\n-          compactionPlan = AvroUtils.deserializeCompactionPlan(\n-              activeTimeline.readCompactionPlanAsBytes(\n-                  HoodieTimeline.getCompactionRequestedInstant(instant.getTimestamp())).get());\n-        } catch (HoodieIOException ioe) {\n-          // SKIP\n-        }\n-      } else {\n-        compactionPlan = AvroUtils.deserializeCompactionPlan(activeTimeline.readCompactionPlanAsBytes(\n-            HoodieTimeline.getCompactionRequestedInstant(instant.getTimestamp())).get());\n-      }\n-\n-      if (null != compactionPlan) {\n-        State state = instant.getState();\n-        if (committed.contains(instant.getTimestamp())) {\n-          state = State.COMPLETED;\n-        }\n-        if (includeExtraMetadata) {\n-          rows.add(new Comparable[] {instant.getTimestamp(), state.toString(),\n-              compactionPlan.getOperations() == null ? 0 : compactionPlan.getOperations().size(),\n-              compactionPlan.getExtraMetadata().toString()});\n-        } else {\n-          rows.add(new Comparable[] {instant.getTimestamp(), state.toString(),\n-              compactionPlan.getOperations() == null ? 0 : compactionPlan.getOperations().size()});\n-        }\n-      }\n-    }\n-\n-    Map<String, Function<Object, String>> fieldNameToConverterMap = new HashMap<>();\n-    TableHeader header = new TableHeader().addTableHeaderField(\"Compaction Instant Time\").addTableHeaderField(\"State\")\n-        .addTableHeaderField(\"Total FileIds to be Compacted\");\n-    if (includeExtraMetadata) {\n-      header = header.addTableHeaderField(\"Extra Metadata\");\n-    }\n-    return HoodiePrintHelper.print(header, fieldNameToConverterMap, sortByField, descending, limit, headerOnly, rows);\n+    return printAllCompactions(activeTimeline,\n+            compactionPlanReader(this::readCompactionPlanForActiveTimeline, activeTimeline),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ3NTIxMg==", "url": "https://github.com/apache/hudi/pull/1312#discussion_r378475212", "bodyText": "@nbalajee printAllCompactions only calls compcationPlanReader for commits and compactions. As part of refactor, timeline.getCommitsAndCompactionTimeline has been moved into printAllCompactions (to reuse between active/archive timelines). I just verified this works as expected even in presence of cleans.\nLet me know if you think there is a better way to organize this.", "author": "satishkotha", "createdAt": "2020-02-12T19:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQzMzA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA4OTM1OQ==", "url": "https://github.com/apache/hudi/pull/1312#discussion_r379089359", "bodyText": "Got it.  LGTM.", "author": "nbalajee", "createdAt": "2020-02-13T20:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQzMzA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NDUxMw==", "url": "https://github.com/apache/hudi/pull/1312#discussion_r379164513", "bodyText": "what does this comment mean ?", "author": "n3nash", "createdAt": "2020-02-13T22:52:43Z", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/CompactionCommand.java", "diffHunk": "@@ -249,6 +262,128 @@ public String compact(\n     return \"Compaction successfully completed for \" + compactionInstantTime;\n   }\n \n+  /**\n+   * Prints all compaction details.\n+   * Note values in compactionsPlans and instants lists are expected to be in cohesion", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyMDk1Mg==", "url": "https://github.com/apache/hudi/pull/1312#discussion_r379220952", "bodyText": "its no longer relevant. so removed it. I intially had two parameters: List and List. But that didnt seem good, so changed it to one parameter.", "author": "satishkotha", "createdAt": "2020-02-14T02:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NDUxMw=="}], "type": "inlineReview"}, {"oid": "258ac06a83f8e90905134c95f617d87271ebe23f", "url": "https://github.com/apache/hudi/commit/258ac06a83f8e90905134c95f617d87271ebe23f", "message": "[HUDI-571] Add show archived compaction(s) to CLI", "committedDate": "2020-02-14T02:23:01Z", "type": "commit"}, {"oid": "258ac06a83f8e90905134c95f617d87271ebe23f", "url": "https://github.com/apache/hudi/commit/258ac06a83f8e90905134c95f617d87271ebe23f", "message": "[HUDI-571] Add show archived compaction(s) to CLI", "committedDate": "2020-02-14T02:23:01Z", "type": "forcePushed"}]}