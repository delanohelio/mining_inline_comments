{"pr_number": 1332, "pr_title": "[HUDI -409] Match header and footer block length to improve corrupted block detection", "pr_createdAt": "2020-02-13T23:13:31Z", "pr_url": "https://github.com/apache/hudi/pull/1332", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMjA3MA==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r379212070", "bodyText": "This is assuming that the block length will always be the last thing written in the footer, can we add comments in the footer writer part to denote this", "author": "n3nash", "createdAt": "2020-02-14T01:37:02Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -239,6 +239,15 @@ private boolean isBlockCorrupt(int blocksize) throws IOException {\n       return true;\n     }\n \n+    // check if the blocksize mentioned in the footer is the same as the header; by seeking back the length of a long\n+    // the backward seek does not incur additional IO as {@link org.apache.hadoop.hdfs.DFSInputStream#seek()}\n+    // only moves the index. actual IO happens on the next read operation\n+    inputStream.seek(inputStream.getPos() - Long.BYTES);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzODc4NQ==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r380938785", "bodyText": "added comment to the write", "author": "ramachandranms", "createdAt": "2020-02-18T21:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMjA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMjU1Ng==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r379212556", "bodyText": "nit : s/blockSizeFooter/blockSizeFromFooter", "author": "n3nash", "createdAt": "2020-02-14T01:39:06Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -239,6 +239,15 @@ private boolean isBlockCorrupt(int blocksize) throws IOException {\n       return true;\n     }\n \n+    // check if the blocksize mentioned in the footer is the same as the header; by seeking back the length of a long\n+    // the backward seek does not incur additional IO as {@link org.apache.hadoop.hdfs.DFSInputStream#seek()}\n+    // only moves the index. actual IO happens on the next read operation\n+    inputStream.seek(inputStream.getPos() - Long.BYTES);\n+    long blockSizeFooter = inputStream.readLong() - MAGIC_BUFFER.length;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1NjQyMA==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r379556420", "bodyText": "Also, we need some kind of abstraction here, feel like the reading of the block size based on long bytes is leaking here and will open to other issues when trying to evolve the code. For now, can you move this to a method and add a test case just for this ? Make that method @VisibleForTesting so it's available to be called in the test class - this way if the footer is evolved, we have a test to catch issues", "author": "n3nash", "createdAt": "2020-02-14T17:34:08Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -239,6 +239,15 @@ private boolean isBlockCorrupt(int blocksize) throws IOException {\n       return true;\n     }\n \n+    // check if the blocksize mentioned in the footer is the same as the header; by seeking back the length of a long\n+    // the backward seek does not incur additional IO as {@link org.apache.hadoop.hdfs.DFSInputStream#seek()}\n+    // only moves the index. actual IO happens on the next read operation\n+    inputStream.seek(inputStream.getPos() - Long.BYTES);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzOTY3Nw==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r380939677", "bodyText": "verified that the tests will fail if the footer is evolved in any way. also added the following logs to better troubleshoot why a corrupted block was detected.\n4828 [main] INFO  org.apache.hudi.common.table.log.HoodieLogFileReader  - Found corrupted block in file HoodieLogFile{pathStr='/var/folders/ch/42h2kyw10_l0509znbppmrsm0000gn/T/junit3752725921138110721/.test-fileid1_100.log.1_1-0-1', fileLen=0}. No magic hash found right after footer block size entry\n\n4700 [main] INFO  org.apache.hudi.common.table.log.HoodieLogFileReader  - Found corrupted block in file HoodieLogFile{pathStr='/var/folders/ch/42h2kyw10_l0509znbppmrsm0000gn/T/junit8143862081174382297/.test-fileid1_100.log.1_1-0-1', fileLen=0}. Header block size(2135) did not match the footer block size(2235)\n\n4316 [main] INFO  org.apache.hudi.common.table.log.HoodieLogFileReader  - Found corrupted block in file HoodieLogFile{pathStr='/var/folders/ch/42h2kyw10_l0509znbppmrsm0000gn/T/junit973614944657653272/.test-fileid1_100.log.1_1-0-1', fileLen=0} with block size(21350) running past EOF```", "author": "ramachandranms", "createdAt": "2020-02-18T21:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1NjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1NzcwOA==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r379557708", "bodyText": "This code is pretty complicated to understand. I see that you removed hasNext() and added some code around this + handling of corrupt blocks here. Can this be simplified with hasNext(), checkCorruptBlock() method level abstractions ? We need more logs as well to explain such checks..", "author": "n3nash", "createdAt": "2020-02-14T17:37:07Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -362,13 +370,18 @@ public HoodieLogBlock prev() throws IOException {\n     // blocksize should read everything about a block including the length as well\n     try {\n       inputStream.seek(reverseLogFilePosition - blockSize);\n+      // get the block size from head and match it with the block size from tail", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4OTUzNQ==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r379689535", "bodyText": "talked offline. will create a new JIRA to address reverse reading issues", "author": "ramachandranms", "createdAt": "2020-02-14T23:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1NzcwOA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIxNjYyMQ==", "url": "https://github.com/apache/hudi/pull/1332#discussion_r387216621", "bodyText": "Can you add the reason why we subtracting Magic header length", "author": "bvaradar", "createdAt": "2020-03-03T18:39:41Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -239,12 +240,24 @@ private boolean isBlockCorrupt(int blocksize) throws IOException {\n       return true;\n     }\n \n+    // check if the blocksize mentioned in the footer is the same as the header; by seeking back the length of a long\n+    // the backward seek does not incur additional IO as {@link org.apache.hadoop.hdfs.DFSInputStream#seek()}\n+    // only moves the index. actual IO happens on the next read operation\n+    inputStream.seek(inputStream.getPos() - Long.BYTES);\n+    long blockSizeFromFooter = inputStream.readLong() - MAGIC_BUFFER.length;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "be2344e5613749740b28cf6cb7f6b69396677be1", "url": "https://github.com/apache/hudi/commit/be2344e5613749740b28cf6cb7f6b69396677be1", "message": "[HUDI -409] Match header and footer block length to improve corrupted block detection", "committedDate": "2020-03-03T19:03:13Z", "type": "commit"}, {"oid": "be2344e5613749740b28cf6cb7f6b69396677be1", "url": "https://github.com/apache/hudi/commit/be2344e5613749740b28cf6cb7f6b69396677be1", "message": "[HUDI -409] Match header and footer block length to improve corrupted block detection", "committedDate": "2020-03-03T19:03:13Z", "type": "forcePushed"}]}