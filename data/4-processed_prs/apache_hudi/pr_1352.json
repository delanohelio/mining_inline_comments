{"pr_number": 1352, "pr_title": "[HUDI-625] Fixing performance issues around DiskBasedMap & kryo", "pr_createdAt": "2020-02-24T19:45:27Z", "pr_url": "https://github.com/apache/hudi/pull/1352", "timeline": [{"oid": "e8379e0ded45edbbf8bab64b2aaea1ff25f36a82", "url": "https://github.com/apache/hudi/commit/e8379e0ded45edbbf8bab64b2aaea1ff25f36a82", "message": "[HUDI-625] Fixing performance issues around DiskBasedMap & kryo", "committedDate": "2020-02-24T19:38:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTQwMA==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383579400", "bodyText": "I agree that the newInstance() seems like creating a new serializer instance every time if the above conditions are not triggered. And also I think Kyro should be faster than the java default.\nWhat about the user-defined custom payload? Do we need to register it somewhere?", "author": "garyli1019", "createdAt": "2020-02-24T23:40:48Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/SerializationUtils.java", "diffHunk": "@@ -121,50 +116,16 @@ Object deserialize(byte[] objectData) {\n \n     public Kryo newKryo() {\n \n-      Kryo kryo = new KryoBase();\n+      Kryo kryo = new Kryo();\n       // ensure that kryo doesn't fail if classes are not registered with kryo.\n       kryo.setRegistrationRequired(false);\n       // This would be used for object initialization if nothing else works out.\n-      kryo.setInstantiatorStrategy(new org.objenesis.strategy.StdInstantiatorStrategy());\n+      kryo.setInstantiatorStrategy(new Kryo.DefaultInstantiatorStrategy(new StdInstantiatorStrategy()));\n       // Handle cases where we may have an odd classloader setup like with libjars\n       // for hadoop\n       kryo.setClassLoader(Thread.currentThread().getContextClassLoader());\n       return kryo;\n     }\n \n-    private static class KryoBase extends Kryo {\n-      @Override\n-      protected Serializer newDefaultSerializer(Class type) {\n-        final Serializer serializer = super.newDefaultSerializer(type);\n-        if (serializer instanceof FieldSerializer) {\n-          final FieldSerializer fieldSerializer = (FieldSerializer) serializer;\n-          fieldSerializer.setIgnoreSyntheticFields(true);\n-        }\n-        return serializer;\n-      }\n-\n-      @Override\n-      protected ObjectInstantiator newInstantiator(Class type) {\n-        return () -> {\n-          // First try reflectasm - it is fastest way to instantiate an object.\n-          try {\n-            final ConstructorAccess access = ConstructorAccess.get(type);\n-            return access.newInstance();\n-          } catch (Throwable t) {\n-            // ignore this exception. We may want to try other way.\n-          }\n-          // fall back to java based instantiation.\n-          try {\n-            final Constructor constructor = type.getConstructor();\n-            constructor.setAccessible(true);\n-            return constructor.newInstance();\n-          } catch (NoSuchMethodException | IllegalAccessException | InstantiationException\n-              | InvocationTargetException e) {\n-            // ignore this exception. we will fall back to default instantiation strategy.\n-          }\n-          return super.getInstantiatorStrategy().newInstantiatorOf(type).newInstance();", "originalCommit": "e8379e0ded45edbbf8bab64b2aaea1ff25f36a82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwMTg3MQ==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383601871", "bodyText": "Hi @garyli1019, hudi put HoodieRecord to kryo, the payload data inside has been coverted to byte[] data, see BaseAvroPayload#BaseAvroPayload. So It doesn't affect anything if we register payload class.", "author": "lamberken", "createdAt": "2020-02-25T00:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwNTYxMA==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383605610", "bodyText": "What I curious about was what you mentioned in the ticket:\nkryo.register(HoodieKey.class, new HoodieKeySerializer());\nkryo.register(GenericData.Record.class, new GenericDataRecordSerializer());\nkryo.register(HoodieRecord.class, new HoodieRecordSerializer());\nkryo.register(HoodieRecordLocationSerializer.class, new HoodieRecordLocationSerializer());\nkryo.register(OverwriteWithLatestAvroPayload.class, new OverwriteWithLatestPayloadSerializer());\n\nWhere this is done?", "author": "garyli1019", "createdAt": "2020-02-25T01:06:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDQzNw==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383610437", "bodyText": "Get your point, these serializers are not necessary now.\n\nCustom serializers are need when there are special requirements for serialization and deserialization.\nWe use InstantiatorStrategy, which is also efficient. kryo-creation [1]\nkryo.setInstantiatorStrategy(new DefaultInstantiatorStrategy(new StdInstantiatorStrategy()));\n\n\nIf we do that currently, it will affect many places.\n\n[1] https://github.com/EsotericSoftware/kryo#object-creation", "author": "lamberken", "createdAt": "2020-02-25T01:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3Nzc5NQ==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383677795", "bodyText": "@lamber-ken to gary's point , we also need to consider this case\n\nWhat about the user-defined custom payload? Do we need to register it somewhere?\n\nclasses extending BaseAvroPayload may be okay. but we allow users to implement their own payload classes.. if they don't have data converted as byte[], do we need to register them etc?", "author": "vinothchandar", "createdAt": "2020-02-25T06:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTU5Mw==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383579593", "bodyText": "The default is FieldSerializer and the description of setIgnoreSyntheticFields is Controls if synthetic fields are serialized. Default is true. So I think this Override might be unnecessary.", "author": "garyli1019", "createdAt": "2020-02-24T23:41:19Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/SerializationUtils.java", "diffHunk": "@@ -121,50 +116,16 @@ Object deserialize(byte[] objectData) {\n \n     public Kryo newKryo() {\n \n-      Kryo kryo = new KryoBase();\n+      Kryo kryo = new Kryo();\n       // ensure that kryo doesn't fail if classes are not registered with kryo.\n       kryo.setRegistrationRequired(false);\n       // This would be used for object initialization if nothing else works out.\n-      kryo.setInstantiatorStrategy(new org.objenesis.strategy.StdInstantiatorStrategy());\n+      kryo.setInstantiatorStrategy(new Kryo.DefaultInstantiatorStrategy(new StdInstantiatorStrategy()));\n       // Handle cases where we may have an odd classloader setup like with libjars\n       // for hadoop\n       kryo.setClassLoader(Thread.currentThread().getContextClassLoader());\n       return kryo;\n     }\n \n-    private static class KryoBase extends Kryo {\n-      @Override\n-      protected Serializer newDefaultSerializer(Class type) {", "originalCommit": "e8379e0ded45edbbf8bab64b2aaea1ff25f36a82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4Mjg3Ng==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383682876", "bodyText": "\ud83d\udc4d", "author": "lamberken", "createdAt": "2020-02-25T06:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3OTU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3ODM4NA==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383678384", "bodyText": "I guess, this achieves the same purpose as the code in newInstantiator that you deleted below?", "author": "vinothchandar", "createdAt": "2020-02-25T06:20:09Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/SerializationUtils.java", "diffHunk": "@@ -121,50 +116,16 @@ Object deserialize(byte[] objectData) {\n \n     public Kryo newKryo() {\n \n-      Kryo kryo = new KryoBase();\n+      Kryo kryo = new Kryo();\n       // ensure that kryo doesn't fail if classes are not registered with kryo.\n       kryo.setRegistrationRequired(false);\n       // This would be used for object initialization if nothing else works out.\n-      kryo.setInstantiatorStrategy(new org.objenesis.strategy.StdInstantiatorStrategy());\n+      kryo.setInstantiatorStrategy(new Kryo.DefaultInstantiatorStrategy(new StdInstantiatorStrategy()));", "originalCommit": "e8379e0ded45edbbf8bab64b2aaea1ff25f36a82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3OTAxNw==", "url": "https://github.com/apache/hudi/pull/1352#discussion_r383679017", "bodyText": "Very right.", "author": "lamberken", "createdAt": "2020-02-25T06:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3ODM4NA=="}], "type": "inlineReview"}]}