{"pr_number": 2142, "pr_title": "[HUDI-1203] add port configuration for EmbeddedTimelineService", "pr_createdAt": "2020-10-04T03:25:48Z", "pr_url": "https://github.com/apache/hudi/pull/2142", "timeline": [{"oid": "81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "url": "https://github.com/apache/hudi/commit/81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "message": "[HUDI-1203]  add port configuration for EmbeddedTimelineService", "committedDate": "2020-10-04T04:26:23Z", "type": "forcePushed"}, {"oid": "4299cf8acfa6665a579319044644998c7d1994e5", "url": "https://github.com/apache/hudi/commit/4299cf8acfa6665a579319044644998c7d1994e5", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService", "committedDate": "2020-10-04T05:16:49Z", "type": "forcePushed"}, {"oid": "a721bb685c47b78a110e71ed4e00ab47f6691a7c", "url": "https://github.com/apache/hudi/commit/a721bb685c47b78a110e71ed4e00ab47f6691a7c", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService", "committedDate": "2020-10-04T09:40:06Z", "type": "forcePushed"}, {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "url": "https://github.com/apache/hudi/commit/cf745430a882774b1cdd714bd0eaf99bc0ddd094", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService", "committedDate": "2020-10-04T12:29:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDg4OA==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499300888", "bodyText": "nit: avoid the extra int variable?", "author": "vinothchandar", "createdAt": "2020-10-04T23:38:16Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieClient.java", "diffHunk": "@@ -102,7 +102,8 @@ private synchronized void startEmbeddedServerView() {\n         // Run Embedded Timeline Server\n         LOG.info(\"Starting Timeline service !!\");\n         Option<String> hostAddr = context.getProperty(EngineProperty.EMBEDDED_SERVER_HOST);\n-        timelineServer = Option.of(new EmbeddedTimelineService(context, hostAddr.orElse(null),\n+        int embeddedTimelineServerPort = config.getEmbeddedTimelineServerPort();", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0NDYzOQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499544639", "bodyText": "done", "author": "lw309637554", "createdAt": "2020-10-05T11:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDk4MQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499300981", "bodyText": "rename: preferredPort", "author": "vinothchandar", "createdAt": "2020-10-04T23:39:23Z", "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/embedded/EmbeddedTimelineService.java", "diffHunk": "@@ -39,17 +39,19 @@\n   private static final Logger LOG = LogManager.getLogger(EmbeddedTimelineService.class);\n \n   private int serverPort;\n+  private int userConfigPort;", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0NTA4Mg==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499545082", "bodyText": "done", "author": "lw309637554", "createdAt": "2020-10-05T11:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301076", "bodyText": "pull into static final variable?", "author": "vinothchandar", "createdAt": "2020-10-04T23:40:35Z", "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTMwOQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301309", "bodyText": "you also probably want to add a small wait between attempts?", "author": "vinothchandar", "createdAt": "2020-10-04T23:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0ODY2Mw==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499548663", "bodyText": "pull into static final variable?\n\ndone", "author": "lw309637554", "createdAt": "2020-10-05T12:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0OTgzNg==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499549836", "bodyText": "you also probably want to add a small wait between attempts?\n\ni think not need to add a small wait between attempts. because in most cases will retry when port is already in use, a attempt will change to new port .", "author": "lw309637554", "createdAt": "2020-10-05T12:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTE5Mw==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301193", "bodyText": "rename: offset -> attempt?", "author": "vinothchandar", "createdAt": "2020-10-04T23:41:47Z", "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU0OTkwMQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499549901", "bodyText": "done", "author": "lw309637554", "createdAt": "2020-10-05T12:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTI1Nw==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301257", "bodyText": "what are we trying to do in the : else part? a line of comment could help", "author": "vinothchandar", "createdAt": "2020-10-04T23:42:39Z", "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {\n+      int tryPort = port == 0 ? port : (port + offset - 1024) % (65536 - 1024) + 1024;", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU1MDA0MQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499550041", "bodyText": "done", "author": "lw309637554", "createdAt": "2020-10-05T12:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTM4MQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301381", "bodyText": "nit: %d times", "author": "vinothchandar", "createdAt": "2020-10-04T23:44:24Z", "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {\n+      int tryPort = port == 0 ? port : (port + offset - 1024) % (65536 - 1024) + 1024;\n+      try {\n+        app.start(tryPort);\n+        return app.port();\n+      } catch (Exception e) {\n+        if (e.getMessage() != null && e.getMessage().contains(\"Failed to bind to\")) {\n+          if (tryPort == 0) {\n+            LOG.warn(\"Timeline server could not bind on a random free port.\");\n+          } else {\n+            LOG.warn(String.format(\"Timeline server could not bind on port %d. \"\n+                + \"Attempting port %d + 1.\",tryPort, tryPort));\n+          }\n+        } else {\n+          LOG.warn(String.format(\"Timeline server start failed on port %d. Attempting port %d + 1.\",tryPort, tryPort), e);\n+        }\n+      }\n+    }\n+    throw new IOException(String.format(\"Timeline server start failed on port %d, after retry %d time\", port, maxRetries));", "originalCommit": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU1MDA4MQ==", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499550081", "bodyText": "done", "author": "lw309637554", "createdAt": "2020-10-05T12:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTM4MQ=="}], "type": "inlineReview"}, {"oid": "9f9d4fb983c94ff302a62ffe6d06077e142140d5", "url": "https://github.com/apache/hudi/commit/9f9d4fb983c94ff302a62ffe6d06077e142140d5", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService", "committedDate": "2020-10-05T12:14:15Z", "type": "commit"}, {"oid": "9f9d4fb983c94ff302a62ffe6d06077e142140d5", "url": "https://github.com/apache/hudi/commit/9f9d4fb983c94ff302a62ffe6d06077e142140d5", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService", "committedDate": "2020-10-05T12:14:15Z", "type": "forcePushed"}]}