{"pr_number": 2112, "pr_title": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable", "pr_createdAt": "2020-09-24T19:58:08Z", "pr_url": "https://github.com/apache/hudi/pull/2112", "timeline": [{"oid": "6fe876d5fc9db60777899f864dcdaf8857601f50", "url": "https://github.com/apache/hudi/commit/6fe876d5fc9db60777899f864dcdaf8857601f50", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "committedDate": "2020-09-24T21:57:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNTY4Nw==", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494635687", "bodyText": "change stream#foreach to for-loop to avoid the noisy try-catch block.", "author": "xushiyan", "createdAt": "2020-09-24T22:02:23Z", "path": "hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java", "diffHunk": "@@ -62,67 +62,53 @@\n   /**\n    * Create a commit file with default CommitMetadata.\n    */\n-  public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration) {\n+  public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration) throws Exception {\n     createCommitFileWithMetadata(basePath, commitTime, configuration, Option.empty(), Option.empty());\n   }\n \n   public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration,\n-      Option<Integer> writes, Option<Integer> updates) {\n+      Option<Integer> writes, Option<Integer> updates) throws Exception {\n     createCommitFileWithMetadata(basePath, commitTime, configuration, UUID.randomUUID().toString(),\n         UUID.randomUUID().toString(), writes, updates);\n   }\n \n   public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration,\n-      String fileId1, String fileId2, Option<Integer> writes, Option<Integer> updates) {\n-    Arrays.asList(HoodieTimeline.makeCommitFileName(commitTime), HoodieTimeline.makeInflightCommitFileName(commitTime),\n-        HoodieTimeline.makeRequestedCommitFileName(commitTime))\n-        .forEach(f -> {\n-          Path commitFile = new Path(\n-              basePath + \"/\" + HoodieTableMetaClient.METAFOLDER_NAME + \"/\" + f);\n-          FSDataOutputStream os = null;\n-          try {\n-            FileSystem fs = FSUtils.getFs(basePath, configuration);\n-            os = fs.create(commitFile, true);\n-            // Generate commitMetadata\n-            HoodieCommitMetadata commitMetadata =\n-                generateCommitMetadata(basePath, commitTime, fileId1, fileId2, writes, updates);\n-            // Write empty commit metadata\n-            os.writeBytes(new String(commitMetadata.toJsonString().getBytes(StandardCharsets.UTF_8)));\n-          } catch (IOException ioe) {\n-            throw new HoodieIOException(ioe.getMessage(), ioe);\n-          } finally {\n-            if (null != os) {\n-              try {\n-                os.close();\n-              } catch (IOException e) {\n-                throw new HoodieIOException(e.getMessage(), e);\n-              }\n-            }\n-          }\n-        });\n+      String fileId1, String fileId2, Option<Integer> writes, Option<Integer> updates) throws Exception {\n+    List<String> commitFileNames = Arrays.asList(HoodieTimeline.makeCommitFileName(commitTime), HoodieTimeline.makeInflightCommitFileName(commitTime),\n+        HoodieTimeline.makeRequestedCommitFileName(commitTime));\n+    for (String name : commitFileNames) {\n+      Path commitFilePath = new Path(Paths.get(basePath, HoodieTableMetaClient.METAFOLDER_NAME, name).toString());\n+      try (FSDataOutputStream os = FSUtils.getFs(basePath, configuration).create(commitFilePath, true)) {\n+        // Generate commitMetadata\n+        HoodieCommitMetadata commitMetadata =\n+            generateCommitMetadata(basePath, commitTime, fileId1, fileId2, writes, updates);\n+        // Write empty commit metadata\n+        os.writeBytes(new String(commitMetadata.toJsonString().getBytes(StandardCharsets.UTF_8)));\n+      }\n+    }", "originalCommit": "6fe876d5fc9db60777899f864dcdaf8857601f50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "52d31b061184ea94809c8a191ca9a817e39436a3", "url": "https://github.com/apache/hudi/commit/52d31b061184ea94809c8a191ca9a817e39436a3", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "committedDate": "2020-09-25T02:41:18Z", "type": "forcePushed"}, {"oid": "5171847b208e25557d23f81cc916f2646e0eb938", "url": "https://github.com/apache/hudi/commit/5171847b208e25557d23f81cc916f2646e0eb938", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "committedDate": "2020-09-25T04:13:06Z", "type": "commit"}, {"oid": "5171847b208e25557d23f81cc916f2646e0eb938", "url": "https://github.com/apache/hudi/commit/5171847b208e25557d23f81cc916f2646e0eb938", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "committedDate": "2020-09-25T04:13:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjI5MQ==", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494952291", "bodyText": "Why we should do this refactor?", "author": "yanghua", "createdAt": "2020-09-25T12:26:43Z", "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestCommitsCommand.java", "diffHunk": "@@ -76,17 +76,19 @@ public void init() throws IOException {\n         \"\", TimelineLayoutVersion.VERSION_1, \"org.apache.hudi.common.model.HoodieAvroPayload\");\n   }\n \n-  private LinkedHashMap<String, Integer[]> generateData() {\n+  private LinkedHashMap<String, Integer[]> generateData() throws Exception {\n     // generate data and metadata\n     LinkedHashMap<String, Integer[]> data = new LinkedHashMap<>();\n     data.put(\"102\", new Integer[] {15, 10});\n     data.put(\"101\", new Integer[] {20, 10});\n     data.put(\"100\", new Integer[] {15, 15});\n \n-    data.forEach((key, value) -> {\n+    for (Map.Entry<String, Integer[]> entry : data.entrySet()) {", "originalCommit": "5171847b208e25557d23f81cc916f2646e0eb938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0OTI5Ng==", "url": "https://github.com/apache/hudi/pull/2112#discussion_r495449296", "bodyText": "@yanghua In HoodieTestCommitMetadataGenerator#createCommitFileWithMetadata (refer to the comment above), I removed the try catch block by declaring the exception hence the callers need to declare it too. The callers' forEach force it to be caught therefore changed to for-loop. I'm trying to adopt a preference of declaring Exception over catching them and for-loop over Stream#forEach to avoid noisy try-catch. Please let me know your thoughts.", "author": "xushiyan", "createdAt": "2020-09-26T11:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ1NjI5MQ==", "url": "https://github.com/apache/hudi/pull/2112#discussion_r495456291", "bodyText": "Ok, I can accept this explanation.", "author": "yanghua", "createdAt": "2020-09-26T13:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjQ0Mg==", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494952442", "bodyText": "ditto", "author": "yanghua", "createdAt": "2020-09-25T12:26:59Z", "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestCommitsCommand.java", "diffHunk": "@@ -168,10 +170,12 @@ public void testShowArchivedCommits() throws IOException {\n     data.put(\"102\", new Integer[] {25, 45});\n     data.put(\"101\", new Integer[] {35, 15});\n \n-    data.forEach((key, value) -> {\n+    for (Map.Entry<String, Integer[]> entry : data.entrySet()) {", "originalCommit": "5171847b208e25557d23f81cc916f2646e0eb938", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}