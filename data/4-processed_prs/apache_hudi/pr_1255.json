{"pr_number": 1255, "pr_title": "[HUDI-559] : Make sure by default table layout version honors the configuration in hoodie.properties", "pr_createdAt": "2020-01-20T02:55:35Z", "pr_url": "https://github.com/apache/hudi/pull/1255", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NjA1MQ==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368356051", "bodyText": "should we just use a VERSION_0 instead of null?", "author": "vinothchandar", "createdAt": "2020-01-20T03:15:41Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieWriteConfig.java", "diffHunk": "@@ -145,7 +145,8 @@ public Boolean shouldAssumeDatePartitioning() {\n   }\n \n   public Integer getTimelineLayoutVersion() {\n-    return Integer.parseInt(props.getProperty(TIMELINE_LAYOUT_VERSION));\n+    return props.containsKey(TIMELINE_LAYOUT_VERSION)\n+        ? Integer.parseInt(props.getProperty(TIMELINE_LAYOUT_VERSION)) : null;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NjQyMg==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368356422", "bodyText": "and can't we do this using the regular defaults way? why the special handling for containsKey etc? props.getProperty(k, default)?", "author": "vinothchandar", "createdAt": "2020-01-20T03:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NjA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MjI2Mw==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368362263", "bodyText": "@vinothchandar : Unlike other configs, this is a config defined at 2 levels - hoodie.properties and in HoodieWriteConfig. If we actually keep a non-null value in config, the semantics is that it would override the one in hoodie.properties. If we keep version_0 as default, it would override the version even for new tables which has Version_1 in hoodie.properties ?   Let me know if I am missing something.", "author": "bvaradar", "createdAt": "2020-01-20T03:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NjA1MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4NjUxNQ==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368386515", "bodyText": "can't this be null? if so, would compareTo below be still happy?", "author": "vinothchandar", "createdAt": "2020-01-20T06:32:48Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/HoodieTableMetaClient.java", "diffHunk": "@@ -117,6 +117,13 @@ public HoodieTableMetaClient(Configuration conf, String basePath, boolean loadAc\n     TableNotFoundException.checkTableValidity(fs, basePathDir, metaPathDir);\n     this.tableConfig = new HoodieTableConfig(fs, metaPath, payloadClassName);\n     this.tableType = tableConfig.getTableType();\n+    if (layoutVersion.isPresent()) {\n+      // Ensure layout version passed in config is not lower than the one seen in hoodie.properties\n+      TimelineLayoutVersion tableConfigVersion = tableConfig.getTimelineLayoutVersion();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5ODQ3NA==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368398474", "bodyText": "You are correct, Table Config Version can be null. I have made tableConfig.getTimelineLayoutVersion() to return an option instead", "author": "bvaradar", "createdAt": "2020-01-20T07:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4NjUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4Njk4MA==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368386980", "bodyText": "can the default in HoodieWriteConfig be Option.empty instead of null? Then, we can simply make config.getTimelineLayoutVersion() return a Option directly", "author": "vinothchandar", "createdAt": "2020-01-20T06:35:21Z", "path": "hudi-client/src/main/java/org/apache/hudi/client/utils/ClientUtils.java", "diffHunk": "@@ -37,6 +37,8 @@\n   public static HoodieTableMetaClient createMetaClient(JavaSparkContext jsc, HoodieWriteConfig config,\n       boolean loadActiveTimelineOnLoad) {\n     return new HoodieTableMetaClient(jsc.hadoopConfiguration(), config.getBasePath(), loadActiveTimelineOnLoad,\n-        config.getConsistencyGuardConfig(), Option.of(new TimelineLayoutVersion(config.getTimelineLayoutVersion())));\n+        config.getConsistencyGuardConfig(),\n+        Option.ofNullable((config.getTimelineLayoutVersion() != null)\n+            ? new TimelineLayoutVersion(config.getTimelineLayoutVersion()) : null));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5ODI3OA==", "url": "https://github.com/apache/hudi/pull/1255#discussion_r368398278", "bodyText": "Yeah, this can be simplified. HoodieWriteConfig's TimelineLayoutVersion will not be null as it has default. Will change based on that.", "author": "bvaradar", "createdAt": "2020-01-20T07:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4Njk4MA=="}], "type": "inlineReview"}, {"oid": "49775272e0c643fe1d776ede8e950facb0d81525", "url": "https://github.com/apache/hudi/commit/49775272e0c643fe1d776ede8e950facb0d81525", "message": "[HUDI-559] : Make the timeline layout version default to be null version", "committedDate": "2020-01-20T07:25:48Z", "type": "commit"}, {"oid": "49775272e0c643fe1d776ede8e950facb0d81525", "url": "https://github.com/apache/hudi/commit/49775272e0c643fe1d776ede8e950facb0d81525", "message": "[HUDI-559] : Make the timeline layout version default to be null version", "committedDate": "2020-01-20T07:25:48Z", "type": "forcePushed"}]}