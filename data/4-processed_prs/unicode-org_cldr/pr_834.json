{"pr_number": 834, "pr_title": "CLDR-10883 improving JSON RBNF", "pr_createdAt": "2020-11-06T19:18:37Z", "pr_url": "https://github.com/unicode-org/cldr/pull/834", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNjgxNw==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r520806817", "bodyText": "This block could be a subroutine. convertCldrItems is about 246 lines currently, way more than one screenful", "author": "btangmu", "createdAt": "2020-11-10T19:04:37Z", "path": "tools/java/src/main/java/org/unicode/cldr/json/Ldml2JsonConverter.java", "diffHunk": "@@ -546,23 +547,16 @@ private int convertCldrItems(AtomicInteger readCount, int totalCount,\n                             throw new IllegalArgumentException(\"empty xpath in \" + filename + \" section \" + js.packageName + \"/\" + js.section);\n                         }\n                         if (type == RunType.rbnf) {\n-                            item.setValue(item.getValue().replace('\u2192', '>'));\n-                            item.setValue(item.getValue().replace('\u2190', '<'));\n-                            if (item.getFullPath().contains(\"@value\")) {\n-                                int indexStart = item.getFullPath().indexOf(\"@value\") + 8;\n-                                int indexEnd = item.getFullPath().indexOf(\"]\", indexStart) - 1;\n-                                if (indexStart >= 0 && indexEnd >= 0 && indexEnd > indexStart) {\n-                                    String sub = item.getFullPath().substring(indexStart, indexEnd);\n-                                    /* System.out.println(\"sub: \" + sub);\n-                                    System.out.println(\"full: \" + item.getFullPath());\n-                                    System.out.println(\"val: \" + item.getValue());*/\n-                                    item.setFullPath(item.getFullPath().replace(sub, item.getValue()));\n-                                    item.setFullPath(item.getFullPath().replaceAll(\"@value\", \"@\" + sub));\n-                                    //System.out.println(\"modifyfull: \" + item.getFullPath());\n-                                    item.setValue(\"\");\n-                                }\n+                            XPathParts xpp = XPathParts.getFrozenInstance(item.getFullPath());", "originalCommit": "ed508745560722e042c030b133f24b82d8f87616", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODI5Mw==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r520808293", "bodyText": "Delete rather than comment out? Recent best practice for \"clean code\" is \"no commented-out code\"", "author": "btangmu", "createdAt": "2020-11-10T19:07:22Z", "path": "tools/java/src/main/java/org/unicode/cldr/json/Ldml2JsonConverter.java", "diffHunk": "@@ -973,7 +967,7 @@ private void resolveArrayItems(JsonWriter out,\n         ArrayList<CldrNode> nodesForLastItem,\n         ArrayList<CldrItem> arrayItems)\n         throws IOException, ParseException {\n-        boolean rbnfFlag = false;\n+//        boolean rbnfFlag = false;", "originalCommit": "ed508745560722e042c030b133f24b82d8f87616", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODQ1Mw==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r520808453", "bodyText": "Same below", "author": "btangmu", "createdAt": "2020-11-10T19:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTExMQ==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r520809111", "bodyText": "Subroutine? outputArrayItem is over 100 lines", "author": "btangmu", "createdAt": "2020-11-10T19:08:58Z", "path": "tools/java/src/main/java/org/unicode/cldr/json/Ldml2JsonConverter.java", "diffHunk": "@@ -1274,10 +1268,17 @@ private void outputArrayItem(JsonWriter out, CldrItem item,\n             } else {\n                 if (!objName.equals(\"rbnfrule\")) {\n                     out.beginObject();\n-                }\n-                writeLeafNode(out, objName, attrAsValueMap, value, nodesNum, cldrNode.getName());\n-                if (!objName.equals(\"rbnfrule\")) {\n+                    writeLeafNode(out, objName, attrAsValueMap, value, nodesNum, cldrNode.getName());", "originalCommit": "ed508745560722e042c030b133f24b82d8f87616", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNTg4MA==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r521435880", "bodyText": "@btangmu I completely missed that there are two \"if(type == RunType.rbnf)\" conditionals right after another. Will fix.", "author": "srl295", "createdAt": "2020-11-11T15:25:55Z", "path": "tools/java/src/main/java/org/unicode/cldr/json/Ldml2JsonConverter.java", "diffHunk": "@@ -546,23 +547,16 @@ private int convertCldrItems(AtomicInteger readCount, int totalCount,\n                             throw new IllegalArgumentException(\"empty xpath in \" + filename + \" section \" + js.packageName + \"/\" + js.section);\n                         }\n                         if (type == RunType.rbnf) {\n-                            item.setValue(item.getValue().replace('\u2192', '>'));\n-                            item.setValue(item.getValue().replace('\u2190', '<'));\n-                            if (item.getFullPath().contains(\"@value\")) {\n-                                int indexStart = item.getFullPath().indexOf(\"@value\") + 8;\n-                                int indexEnd = item.getFullPath().indexOf(\"]\", indexStart) - 1;\n-                                if (indexStart >= 0 && indexEnd >= 0 && indexEnd > indexStart) {\n-                                    String sub = item.getFullPath().substring(indexStart, indexEnd);\n-                                    /* System.out.println(\"sub: \" + sub);\n-                                    System.out.println(\"full: \" + item.getFullPath());\n-                                    System.out.println(\"val: \" + item.getValue());*/\n-                                    item.setFullPath(item.getFullPath().replace(sub, item.getValue()));\n-                                    item.setFullPath(item.getFullPath().replaceAll(\"@value\", \"@\" + sub));\n-                                    //System.out.println(\"modifyfull: \" + item.getFullPath());\n-                                    item.setValue(\"\");\n-                                }\n+                            XPathParts xpp = XPathParts.getFrozenInstance(item.getFullPath());\n+                            final String sub = xpp.findAttributeValue(\"rbnfrule\", \"value\");\n+                            if(sub != null){\n+                                xpp = xpp.cloneAsThawed();\n+                                final String value = item.getValue();\n+                                xpp.removeAttribute(-1, \"value\");\n+                                xpp.addAttribute(sub, value);\n+                                item.setFullPath(xpp.toString());\n+                                item.setValue(\"\");\n                             }\n-\n                         }\n                         // ADJUST ACCESS=PRIVATE/PUBLIC BASED ON ICU RULE -- START\n                         if (type == RunType.rbnf) {", "originalCommit": "ed508745560722e042c030b133f24b82d8f87616", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ3NDEyOA==", "url": "https://github.com/unicode-org/cldr/pull/834#discussion_r521474128", "bodyText": "I missed that too", "author": "btangmu", "createdAt": "2020-11-11T16:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzNTg4MA=="}], "type": "inlineReview"}, {"oid": "8386a6555a7b5822493f82f51f543a7cccbddf10", "url": "https://github.com/unicode-org/cldr/commit/8386a6555a7b5822493f82f51f543a7cccbddf10", "message": "CLDR-10883 improving JSON RBNF\n\n- simplify so there are fewer rbnf special cases\n- change to simpler tuple form:\n \"%spellout-cardinal\": [ [\"-x\",\"\u10db\u10d8\u10dc\u10e3\u10e1 \u2192\u2192;\"],[\"x.x\",\"\u2190\u2190 \u10db\u10eb\u10d8\u10db\u10d4 \u2192\u2192;\"],\n to preserve ordering", "committedDate": "2020-11-11T16:55:21Z", "type": "commit"}, {"oid": "8386a6555a7b5822493f82f51f543a7cccbddf10", "url": "https://github.com/unicode-org/cldr/commit/8386a6555a7b5822493f82f51f543a7cccbddf10", "message": "CLDR-10883 improving JSON RBNF\n\n- simplify so there are fewer rbnf special cases\n- change to simpler tuple form:\n \"%spellout-cardinal\": [ [\"-x\",\"\u10db\u10d8\u10dc\u10e3\u10e1 \u2192\u2192;\"],[\"x.x\",\"\u2190\u2190 \u10db\u10eb\u10d8\u10db\u10d4 \u2192\u2192;\"],\n to preserve ordering", "committedDate": "2020-11-11T16:55:21Z", "type": "forcePushed"}]}