{"pr_number": 644, "pr_title": "CLDR-13771 playbook to include letsencrypt and deploy script", "pr_createdAt": "2020-08-19T14:58:52Z", "pr_url": "https://github.com/unicode-org/cldr/pull/644", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473190132", "bodyText": "All this does is create the nginx config file.  Where do you generate the actual certificate, and how do you point the nginx config file to that certificate?", "author": "sffc", "createdAt": "2020-08-19T17:05:09Z", "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "originalCommit": "4f41df0d463733eea5f5b58794777aab33ed204e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNDY0NQ==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473214645", "bodyText": "For certbot config, cf. https://unicode-org.atlassian.net/browse/CLDR-13567", "author": "btangmu", "createdAt": "2020-08-19T17:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxOTU3MA==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473219570", "bodyText": "The current production server uses /etc/nginx/sites-enabled/stproxy\nI think certbot automatically generates the certificate if installed right.", "author": "btangmu", "createdAt": "2020-08-19T17:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyNjUxNA==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473226514", "bodyText": "@sffc this does create the certificate and updates the config file, that's why the python3-certbot-nginx plugin was installed. https://cldr-smoke2.unicode.org was setup using only this playbook.", "author": "srl295", "createdAt": "2020-08-19T18:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjMyOQ==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475106329", "bodyText": "If this command creates the certs, then why are the certs not listed in\n      args:\n        creates: /etc/letsencrypt/options-ssl-nginx.conf", "author": "sffc", "createdAt": "2020-08-22T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}], "type": "inlineReview"}, {"oid": "8ff2f3710030e97c6b9f8b908ec3dc1b559bf4c7", "url": "https://github.com/unicode-org/cldr/commit/8ff2f3710030e97c6b9f8b908ec3dc1b559bf4c7", "message": "CLDR-13771 playbook to include letsencrypt and deploy script\n\n- use cldr-smoke2 but leave cldr-ref out\n- the autodeployment on merge is in PR#601 [CLDR-13948]", "committedDate": "2020-08-19T18:04:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTE3MA==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473191170", "bodyText": "The -f ./local-surveytool option in the ssh-keygen command above seems to not match the filename .../surveytool.pub.", "author": "echeran", "createdAt": "2020-08-19T17:06:27Z", "path": "tools/scripts/ansible/README.md", "diffHunk": "@@ -38,6 +38,28 @@ cldr-ref.unicode.org | SUCCESS => {\n \n - Install python3. Make sure `python --version` returns \"Python 3\u2026\"\n \n+- TODO: these shouldn't be needed, but they are. Here's the entire install command:\n+\n+```shell\n+sudo apt-get update && sudo apt-get install python3 python-apt python3-pymysql\n+```\n+\n+### Setup: surveytool keypair\n+\n+```shell\n+mkdir -p ./local-vars\n+ssh-keygen -t rsa -b 4096 -f ./local-surveytool -P '' -C 'surveytool deploy'\n+```\n+\n+The contents of the `local-vars/surveytool.pub` file is used for the `key:` parameter below in `local.yml`.", "originalCommit": "4f41df0d463733eea5f5b58794777aab33ed204e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MDQ1Ng==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473240456", "bodyText": "@echeran fixed in bc5742a", "author": "srl295", "createdAt": "2020-08-19T18:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyOTIzMg==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473229232", "bodyText": "The GH Action for Ansible build is currently failing with an error saying that there's an invalid key name in the YAML around somewhere here.", "author": "echeran", "createdAt": "2020-08-19T18:13:24Z", "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -52,25 +61,69 @@\n         force: no\n         owner: tomcat8\n         group: tomcat8\n-        mode: 0644\n+        mode: \"0644\"\n       notify: Restart Tomcat\n     - name: Checkout CLDR trunk\n       git:\n         repo: https://github.com/unicode-org/cldr.git\n         dest: /var/lib/tomcat8/cldr/cldr-trunk\n-        depth: 1 # don't need all history\n         force: no\n+        update: no\n         version: master\n+        # this is deep because we will need to keep updating\n+        # it with history. It does not include LFS as that\n+        # is not needed for the surveytool.\n+    - name: Setup index.html\n+      copy:\n+        src: templates/index.html\n+        dest: /var/www/html\n+        owner: root\n+        group: root\n+        mode: '0644'\n+    - name: Setup reverse proxy\n+      blockinfile:\n+        path: /etc/nginx/sites-enabled/default\n+        block: |\n+          # proxy /cldr-apps/ to tomcat\n+          location /cldr-apps/ {\n+            allow all;\n+            proxy_pass http://localhost:8080/cldr-apps/;\n+            proxy_set_header Host $host;\n+            proxy_set_header X-Real-IP $remote_addr;\n+          }\n+        marker: '# {mark} ANSIBLE MANAGED BLOCK'\n+        insertafter: '^[\\s]*server_name' # the LAST uncommented server block\n+      notify: 'Restart Nginx'\n+    - name: Setup surveytool user for deploy\n+      user:\n+        name: surveytool\n+        shell: /bin/bash\n+    - name: Give acess to surveytool user\n+      file:\n+        path: /var/lib/tomcat8/cldr/cldr-trunk\n+        owner: surveytool\n+        recurse: yes\n+    - name: Setup surveytool auth", "originalCommit": "8ff2f3710030e97c6b9f8b908ec3dc1b559bf4c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzOTI3NA==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473239274", "bodyText": "@echeran please recheck\u2026\u00a0think i fixed it", "author": "srl295", "createdAt": "2020-08-19T18:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyOTIzMg=="}], "type": "inlineReview"}, {"oid": "bc5742a530ed06892b6d456e8b877e5e551cebd7", "url": "https://github.com/unicode-org/cldr/commit/bc5742a530ed06892b6d456e8b877e5e551cebd7", "message": "CLDR-13771 playbook to include letsencrypt and deploy script\n\n- use cldr-smoke2 but leave cldr-ref out\n- the autodeployment on merge is in PR#601 [CLDR-13948]", "committedDate": "2020-08-19T18:33:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475106486", "bodyText": "What's the difference between certbot above and certbot down here?", "author": "sffc", "createdAt": "2020-08-22T16:25:25Z", "path": "tools/scripts/ansible/vars/main.yml", "diffHunk": "@@ -3,4 +3,9 @@ mysql_databases:\n     encoding: latin1\n     collation: latin1_bin\n mysql_enabled_on_startup: true\n-mysql_bind_address: localhost\n\\ No newline at end of file\n+mysql_bind_address: localhost\n+certbot_create_standalone_stop_services:\n+  - nginx\n+certbot_auto_renew: true", "originalCommit": "bc5742a530ed06892b6d456e8b877e5e551cebd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNDQ3MQ==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475114471", "bodyText": "actually, I think these lines are extraneous. I was using a certbot role and it didn't end up working out.", "author": "srl295", "createdAt": "2020-08-22T17:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNTA1MA==", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475115050", "bodyText": "deleted", "author": "srl295", "createdAt": "2020-08-22T17:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng=="}], "type": "inlineReview"}, {"oid": "b5cb071d0175e00e07d8b0b7c8bf990406d23b00", "url": "https://github.com/unicode-org/cldr/commit/b5cb071d0175e00e07d8b0b7c8bf990406d23b00", "message": "CLDR-13771 playbook to include letsencrypt and deploy script\n\n- use cldr-smoke2 but leave cldr-ref out\n- the autodeployment on merge is in PR#601 [CLDR-13948]", "committedDate": "2020-08-22T18:06:37Z", "type": "commit"}, {"oid": "b5cb071d0175e00e07d8b0b7c8bf990406d23b00", "url": "https://github.com/unicode-org/cldr/commit/b5cb071d0175e00e07d8b0b7c8bf990406d23b00", "message": "CLDR-13771 playbook to include letsencrypt and deploy script\n\n- use cldr-smoke2 but leave cldr-ref out\n- the autodeployment on merge is in PR#601 [CLDR-13948]", "committedDate": "2020-08-22T18:06:37Z", "type": "forcePushed"}]}