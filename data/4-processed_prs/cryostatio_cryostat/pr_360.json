{"pr_number": 360, "pr_title": "TargetConnectionManager allows concurrent connections", "pr_createdAt": "2020-12-16T19:23:42Z", "pr_url": "https://github.com/cryostatio/cryostat/pull/360", "timeline": [{"oid": "e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "url": "https://github.com/cryostatio/cryostat/commit/e4b1e228b2e44a10ee339cbc57c9956e4f56ec57", "message": "Implement concurrent JMX connection and enable timed reuse", "committedDate": "2020-12-17T17:34:40Z", "type": "forcePushed"}, {"oid": "80c439567d4f9a05aa005e19b50a1eb36d417768", "url": "https://github.com/cryostatio/cryostat/commit/80c439567d4f9a05aa005e19b50a1eb36d417768", "message": "Implement concurrent JMX connection and enable timed reuse", "committedDate": "2020-12-17T19:02:26Z", "type": "forcePushed"}, {"oid": "d5cbe460a7be6183421c8b08a4d7001904caa974", "url": "https://github.com/cryostatio/cryostat/commit/d5cbe460a7be6183421c8b08a4d7001904caa974", "message": "Implement concurrent JMX connection and enable timed reuse", "committedDate": "2020-12-18T17:20:39Z", "type": "forcePushed"}, {"oid": "a3f89dd857d797a70e1c770ca292048e8702b7cd", "url": "https://github.com/cryostatio/cryostat/commit/a3f89dd857d797a70e1c770ca292048e8702b7cd", "message": "Implement concurrent JMX connection and enable timed reuse", "committedDate": "2020-12-18T17:25:59Z", "type": "forcePushed"}, {"oid": "d883e6a0f28bc4ee32415fe2eeff8b310f9610d6", "url": "https://github.com/cryostatio/cryostat/commit/d883e6a0f28bc4ee32415fe2eeff8b310f9610d6", "message": "Do not expose RemovalListener in public interface", "committedDate": "2020-12-18T18:03:58Z", "type": "forcePushed"}, {"oid": "56601ddd59bfd5ca537848c805ba60a45bf7368d", "url": "https://github.com/cryostatio/cryostat/commit/56601ddd59bfd5ca537848c805ba60a45bf7368d", "message": "Invalidate cached connection if explicitly closed", "committedDate": "2020-12-18T18:28:27Z", "type": "forcePushed"}, {"oid": "faf55f551f9110b9cbc923bd3350656a02a506bc", "url": "https://github.com/cryostatio/cryostat/commit/faf55f551f9110b9cbc923bd3350656a02a506bc", "message": "Implement method for long-running operations to mark connection as still in use", "committedDate": "2020-12-18T19:03:35Z", "type": "forcePushed"}, {"oid": "7b722dd551d1e3510ec7d41294c6facbf99372f1", "url": "https://github.com/cryostatio/cryostat/commit/7b722dd551d1e3510ec7d41294c6facbf99372f1", "message": "Implement method for long-running operations to mark connection as still in use", "committedDate": "2020-12-18T19:05:45Z", "type": "forcePushed"}, {"oid": "e344b75dc0189f39cdad66dea25c757264136003", "url": "https://github.com/cryostatio/cryostat/commit/e344b75dc0189f39cdad66dea25c757264136003", "message": "Implement method for long-running operations to mark connection as still in use", "committedDate": "2020-12-21T15:42:13Z", "type": "forcePushed"}, {"oid": "187e67c70f6f51706de0cef7f4b7a17a483fd099", "url": "https://github.com/cryostatio/cryostat/commit/187e67c70f6f51706de0cef7f4b7a17a483fd099", "message": "Implement method for long-running operations to mark connection as still in use", "committedDate": "2020-12-21T18:26:03Z", "type": "forcePushed"}, {"oid": "9d95d66dc417949e8ef8eb2633777d23a13a6a16", "url": "https://github.com/cryostatio/cryostat/commit/9d95d66dc417949e8ef8eb2633777d23a13a6a16", "message": "Update JUnit to 5.7.0", "committedDate": "2020-12-22T23:29:51Z", "type": "forcePushed"}, {"oid": "b588ff62bae934c9164ae08362e3b2e5b425375a", "url": "https://github.com/cryostatio/cryostat/commit/b588ff62bae934c9164ae08362e3b2e5b425375a", "message": "Set up test container inside a pod", "committedDate": "2020-12-23T16:15:46Z", "type": "forcePushed"}, {"oid": "5f91be48b40ce1d914e92b9f233a46d42bde92c3", "url": "https://github.com/cryostatio/cryostat/commit/5f91be48b40ce1d914e92b9f233a46d42bde92c3", "message": "Report generation lock should attempt fairness", "committedDate": "2020-12-23T21:13:19Z", "type": "forcePushed"}, {"oid": "21acdd849b7a2be683db3ea47cc76b1decaae2d2", "url": "https://github.com/cryostatio/cryostat/commit/21acdd849b7a2be683db3ea47cc76b1decaae2d2", "message": "Report generation lock should attempt fairness", "committedDate": "2021-01-12T21:19:31Z", "type": "forcePushed"}, {"oid": "1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "url": "https://github.com/cryostatio/cryostat/commit/1a6e9fbbe8c148a794b33cd5ddfa2188427f08b7", "message": "Report generation lock should attempt fairness", "committedDate": "2021-01-12T21:26:26Z", "type": "forcePushed"}, {"oid": "ed191f8b3906f4c2de4fff29f017258fb09f1979", "url": "https://github.com/cryostatio/cryostat/commit/ed191f8b3906f4c2de4fff29f017258fb09f1979", "message": "Report generation lock should attempt fairness", "committedDate": "2021-01-12T21:35:13Z", "type": "forcePushed"}, {"oid": "d1bf1de660de23a985207b064d79fc55f6e2fada", "url": "https://github.com/cryostatio/cryostat/commit/d1bf1de660de23a985207b064d79fc55f6e2fada", "message": "Minor typo fix", "committedDate": "2021-01-12T21:37:17Z", "type": "forcePushed"}, {"oid": "56f8356a5226bcea076ed3837307ad9589c7fb26", "url": "https://github.com/cryostatio/cryostat/commit/56f8356a5226bcea076ed3837307ad9589c7fb26", "message": "Use vertx-fib-demo:0.6.0\n\nDeploy one without SSL or auth, one with just auth, and one with both", "committedDate": "2021-01-12T22:02:59Z", "type": "commit"}, {"oid": "960bb16cf4d7bc98456b7a5a87f73c744e7f52c2", "url": "https://github.com/cryostatio/cryostat/commit/960bb16cf4d7bc98456b7a5a87f73c744e7f52c2", "message": "Rename test class and add many-container interleaved requests test", "committedDate": "2021-01-12T22:02:59Z", "type": "commit"}, {"oid": "a0795d846cff926717ba257eebea59fc86382d70", "url": "https://github.com/cryostatio/cryostat/commit/a0795d846cff926717ba257eebea59fc86382d70", "message": "Minor typo fix", "committedDate": "2021-01-12T22:02:59Z", "type": "forcePushed"}, {"oid": "5b3316320b0439fc0982e75e9e08be5c86db8864", "url": "https://github.com/cryostatio/cryostat/commit/5b3316320b0439fc0982e75e9e08be5c86db8864", "message": "Perform test result verification in parallel", "committedDate": "2021-01-13T14:43:36Z", "type": "commit"}, {"oid": "3691b24b7d1516051a1dfc4b29a97c530a98a733", "url": "https://github.com/cryostatio/cryostat/commit/3691b24b7d1516051a1dfc4b29a97c530a98a733", "message": "Minor typo fix", "committedDate": "2021-01-13T14:43:37Z", "type": "forcePushed"}, {"oid": "28ac09c391455332c8fde8010e70e91e33228d01", "url": "https://github.com/cryostatio/cryostat/commit/28ac09c391455332c8fde8010e70e91e33228d01", "message": "Ensure recording deletions", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "f6a1461fc9dad9eec14cb2470fbe77a51a70020c", "url": "https://github.com/cryostatio/cryostat/commit/f6a1461fc9dad9eec14cb2470fbe77a51a70020c", "message": "Implement concurrent JMX connection and enable timed reuse", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "0301c6ba46b7e56d43d736320a1e08ad960ceaa4", "url": "https://github.com/cryostatio/cryostat/commit/0301c6ba46b7e56d43d736320a1e08ad960ceaa4", "message": "Remove explicit public connect method\n\nAll consumers of TargetConnectionManager now use executeConnectedTask and use the cached connection semantics, with manual resource handling and closure removed", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "28bdf7b7f63af5a46f35581a2f257a8e5913ff1f", "url": "https://github.com/cryostatio/cryostat/commit/28bdf7b7f63af5a46f35581a2f257a8e5913ff1f", "message": "Do not expose RemovalListener in public interface", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "9104b04adf2f6f92fd7bd4545761b396347835e5", "url": "https://github.com/cryostatio/cryostat/commit/9104b04adf2f6f92fd7bd4545761b396347835e5", "message": "Invalidate cached connection if explicitly closed", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "55e548516623dd9ce18a6f6e77511be01ca9afd4", "url": "https://github.com/cryostatio/cryostat/commit/55e548516623dd9ce18a6f6e77511be01ca9afd4", "message": "Implement method for long-running operations to mark connection as still in use", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "52f6e253cb93accce8fce9a09b61de3fca676c81", "url": "https://github.com/cryostatio/cryostat/commit/52f6e253cb93accce8fce9a09b61de3fca676c81", "message": "Report generation lock should attempt fairness", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9", "url": "https://github.com/cryostatio/cryostat/commit/5ae1983a0267d8ef0c8a018359485624d2ed44a9", "message": "Minor typo fix", "committedDate": "2021-01-13T15:17:45Z", "type": "commit"}, {"oid": "5ae1983a0267d8ef0c8a018359485624d2ed44a9", "url": "https://github.com/cryostatio/cryostat/commit/5ae1983a0267d8ef0c8a018359485624d2ed44a9", "message": "Minor typo fix", "committedDate": "2021-01-13T15:17:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgyMjIyMQ==", "url": "https://github.com/cryostatio/cryostat/pull/360#discussion_r556822221", "bodyText": "This can be written as logger.info(\"removing cached connection for %s\", descriptor.getTargetId()). I changed all the string.format statements in a PR a month ago, it probably makes sense to keep it consistent!", "author": "Alexjsenn", "createdAt": "2021-01-13T20:55:30Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -63,42 +67,72 @@\n     public static final Pattern HOST_PORT_PAIR_PATTERN =\n             Pattern.compile(\"^([^:\\\\s]+)(?::(\\\\d{1,5}))?$\");\n \n-    private final Logger logger;\n-    // FIXME verify concurrent connection safety and remove locking\n-    private final ReentrantLock lock = new ReentrantLock();\n-    // maintain a short-lived cache of connections to allow nested ConnectedTasks\n-    // without having to manage connection reuse\n-    private final Map<ConnectionDescriptor, JFRConnection> activeConnections = new HashMap<>();\n+    static final Duration DEFAULT_TTL = Duration.ofSeconds(90);\n+\n     private final Lazy<JFRConnectionToolkit> jfrConnectionToolkit;\n+    private final Logger logger;\n \n-    public TargetConnectionManager(Logger logger, Lazy<JFRConnectionToolkit> jfrConnectionToolkit) {\n-        this.logger = logger;\n+    private final LoadingCache<ConnectionDescriptor, JFRConnection> connections;\n+\n+    TargetConnectionManager(\n+            Lazy<JFRConnectionToolkit> jfrConnectionToolkit, Duration ttl, Logger logger) {\n         this.jfrConnectionToolkit = jfrConnectionToolkit;\n+        this.logger = logger;\n+\n+        this.connections =\n+                Caffeine.newBuilder()\n+                        .scheduler(Scheduler.systemScheduler())\n+                        .expireAfterAccess(ttl)\n+                        .removalListener(\n+                                new RemovalListener<ConnectionDescriptor, JFRConnection>() {\n+                                    @Override\n+                                    public void onRemoval(\n+                                            ConnectionDescriptor descriptor,\n+                                            JFRConnection connection,\n+                                            RemovalCause cause) {\n+                                        if (descriptor == null) {\n+                                            logger.warn(\n+                                                    \"Connection eviction triggered with null descriptor\");\n+                                            return;\n+                                        }\n+                                        if (connection == null) {\n+                                            logger.warn(\n+                                                    \"Connection eviction triggered with null connection\");\n+                                            return;\n+                                        }\n+                                        logger.info(\n+                                                String.format(", "originalCommit": "5ae1983a0267d8ef0c8a018359485624d2ed44a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgyNTQyNw==", "url": "https://github.com/cryostatio/cryostat/pull/360#discussion_r556825427", "bodyText": "Aha, good catch - this PR was opened as a draft the day before you opened that logger PR, so I just never came back around to fix that up :-)", "author": "andrewazores", "createdAt": "2021-01-13T21:01:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgyMjIyMQ=="}], "type": "inlineReview"}, {"oid": "6aea85d68e9417a3f4166fc345e470a7e1e8fbb2", "url": "https://github.com/cryostatio/cryostat/commit/6aea85d68e9417a3f4166fc345e470a7e1e8fbb2", "message": "Fix logger message format", "committedDate": "2021-01-13T21:02:43Z", "type": "commit"}]}