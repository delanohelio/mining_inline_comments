{"pr_number": 209, "pr_title": "Initial JMX authentication foundation", "pr_createdAt": "2020-07-16T19:31:15Z", "pr_url": "https://github.com/cryostatio/cryostat/pull/209", "timeline": [{"oid": "bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "url": "https://github.com/cryostatio/cryostat/commit/bf5f67548e28ac2b883ae387b63b7ecfbdebfd2c", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit", "committedDate": "2020-07-16T19:52:29Z", "type": "forcePushed"}, {"oid": "41f8047e0ddc29a4c2fa4821c6187578375e49c9", "url": "https://github.com/cryostatio/cryostat/commit/41f8047e0ddc29a4c2fa4821c6187578375e49c9", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit", "committedDate": "2020-07-16T21:41:15Z", "type": "forcePushed"}, {"oid": "2500246165d0560100659ff2e9d8529b6e0582d9", "url": "https://github.com/cryostatio/cryostat/commit/2500246165d0560100659ff2e9d8529b6e0582d9", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit", "committedDate": "2020-07-20T19:10:59Z", "type": "forcePushed"}, {"oid": "9760ece2f464df3e45b2140ae2e0a51a099fd5c5", "url": "https://github.com/cryostatio/cryostat/commit/9760ece2f464df3e45b2140ae2e0a51a099fd5c5", "message": "Bump required container-jfr-core version", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "0c7246873e400bc231e5c7640c54a425420ae953", "url": "https://github.com/cryostatio/cryostat/commit/0c7246873e400bc231e5c7640c54a425420ae953", "message": "Bubble HTTP Handler JMX auth failure exceptions", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "0b02009cef692e35154bdb82ec2b3706085ff9c2", "url": "https://github.com/cryostatio/cryostat/commit/0b02009cef692e35154bdb82ec2b3706085ff9c2", "message": "Reformat JVM flags for readability", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "5eaded0d2dff54e82c23a81658a5ea39d9a0498a", "url": "https://github.com/cryostatio/cryostat/commit/5eaded0d2dff54e82c23a81658a5ea39d9a0498a", "message": "Configure containerjfr for JMX authentication", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "43bbc5266627c47a23aa3005c59346b40db81b91", "url": "https://github.com/cryostatio/cryostat/commit/43bbc5266627c47a23aa3005c59346b40db81b91", "message": "Avoid NPE on invalid URL format", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "478eea139d1236dcb88d062b5115b122c5366f7b", "url": "https://github.com/cryostatio/cryostat/commit/478eea139d1236dcb88d062b5115b122c5366f7b", "message": "Wrap container in pod for easy rootless multi-container network testing", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "c1da6bd27179eaf3bb99b97b181297bb0fcabf03", "url": "https://github.com/cryostatio/cryostat/commit/c1da6bd27179eaf3bb99b97b181297bb0fcabf03", "message": "Autogenerate self-connection jmxremote.password\n\nAutogenerate credentials for jmxremote.password file used to secure\nContainerJFR's own JMX port at image generation time", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "7aaa022b12d2f4a2c5a6b5b2fca090c84fe8a432", "url": "https://github.com/cryostatio/cryostat/commit/7aaa022b12d2f4a2c5a6b5b2fca090c84fe8a432", "message": "Use custom entrypoint script\n\nEntrypoint generates remote JMX password at container startup time to\nsecure ContainerJFR's own incoming connection port", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "28d7507570a5521ae3bcf5a7bbf008fbbdfeccf6", "url": "https://github.com/cryostatio/cryostat/commit/28d7507570a5521ae3bcf5a7bbf008fbbdfeccf6", "message": "Return 404 instead of 500 if target connection fails (other than auth)", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "a49c5b6900447cfa968ad824917d92713ef8af73", "url": "https://github.com/cryostatio/cryostat/commit/a49c5b6900447cfa968ad824917d92713ef8af73", "message": "Respond with more appropriate status code if target RJMX auth fails", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "7496b59926b27687bc7f624bb7a30ae523566168", "url": "https://github.com/cryostatio/cryostat/commit/7496b59926b27687bc7f624bb7a30ae523566168", "message": "Minor tweak to use updated -core JFRConnectionToolkit with Credentials", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "1d1027d9e91e4d85b2f8f96f5c768d047d961e00", "url": "https://github.com/cryostatio/cryostat/commit/1d1027d9e91e4d85b2f8f96f5c768d047d961e00", "message": "Add serialized command response status enum", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "0e67fd0f2f83a38930832a747174196146321006", "url": "https://github.com/cryostatio/cryostat/commit/0e67fd0f2f83a38930832a747174196146321006", "message": "Refactor TargetConnectionManager to accept optional JMX connection credentials\n\nSupport for retrieving credentials from commands or HTTP requests not yet implemented, but this lays the foundation to do so", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "ce4f3f7eb25381a7b0ea4d1daca55c20e45fd196", "url": "https://github.com/cryostatio/cryostat/commit/ce4f3f7eb25381a7b0ea4d1daca55c20e45fd196", "message": "Rebase cleanup", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c", "url": "https://github.com/cryostatio/cryostat/commit/02c981791e710e86237a11a7d472f6dd449bab4c", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit", "committedDate": "2020-07-21T19:35:05Z", "type": "commit"}, {"oid": "02c981791e710e86237a11a7d472f6dd449bab4c", "url": "https://github.com/cryostatio/cryostat/commit/02c981791e710e86237a11a7d472f6dd449bab4c", "message": "Remove SelfDisoveryPlatformClient\n\nNew default-on JDP discovery replaces need for self-discovery client. Adjust integration tests and entrypoint to suit", "committedDate": "2020-07-21T19:35:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE0NzkwMA==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461147900", "bodyText": "I think we can remove this catch, or does it still serve a purpose?", "author": "ebaron", "createdAt": "2020-07-27T20:24:35Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -93,56 +97,55 @@\n      * finished with it. When possible, clients should use executeConnectedTask instead, which does\n      * perform automatic cleanup when the provided task has been completed.\n      */\n-    public JFRConnection connect(String targetId) throws Exception {\n+    public JFRConnection connect(ConnectionDescriptor connectionDescriptor) throws Exception {\n         try {\n-            return attemptConnectAsJMXServiceURL(targetId);\n+            return attemptConnectAsJMXServiceURL(connectionDescriptor);\n+        } catch (MalformedURLException mue) {\n+            return attemptConnectAsHostPortPair(connectionDescriptor);\n         } catch (Exception e) {\n-            return attemptConnectAsHostPortPair(targetId);\n+            throw e;\n         }", "originalCommit": "02c981791e710e86237a11a7d472f6dd449bab4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NjM1Mg==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461156352", "bodyText": "Real minor thing, but this would be more readable IMO if we used JMC's ConnectionToolkit.createServiceURL. Maybe worth adding a wrapper for it in core next time you make changes there.", "author": "ebaron", "createdAt": "2020-07-27T20:40:31Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/TargetConnectionManager.java", "diffHunk": "@@ -93,56 +97,55 @@\n      * finished with it. When possible, clients should use executeConnectedTask instead, which does\n      * perform automatic cleanup when the provided task has been completed.\n      */\n-    public JFRConnection connect(String targetId) throws Exception {\n+    public JFRConnection connect(ConnectionDescriptor connectionDescriptor) throws Exception {\n         try {\n-            return attemptConnectAsJMXServiceURL(targetId);\n+            return attemptConnectAsJMXServiceURL(connectionDescriptor);\n+        } catch (MalformedURLException mue) {\n+            return attemptConnectAsHostPortPair(connectionDescriptor);\n         } catch (Exception e) {\n-            return attemptConnectAsHostPortPair(targetId);\n+            throw e;\n         }\n     }\n \n-    private JFRConnection attemptConnectAsJMXServiceURL(String url) throws Exception {\n-        return connect(new JMXServiceURL(url));\n+    private JFRConnection attemptConnectAsJMXServiceURL(ConnectionDescriptor connectionDescriptor)\n+            throws Exception {\n+        return connect(\n+                new JMXServiceURL(connectionDescriptor.getTargetId()),\n+                connectionDescriptor.getCredentials());\n     }\n \n-    private JFRConnection attemptConnectAsHostPortPair(String s) throws Exception {\n+    private JFRConnection attemptConnectAsHostPortPair(ConnectionDescriptor connectionDescriptor)\n+            throws Exception {\n+        String s = connectionDescriptor.getTargetId();\n         Matcher m = HOST_PORT_PAIR_PATTERN.matcher(s);\n         if (!m.find()) {\n-            return null;\n+            throw new MalformedURLException(s);\n         }\n         String host = m.group(1);\n         String port = m.group(2);\n         if (port == null) {\n             port = \"9091\";\n         }\n-        return connect(host, Integer.parseInt(port));\n+        return connect(\n+                new JMXServiceURL(\n+                        \"rmi\", \"\", 0, String.format(\"/jndi/rmi://%s:%s/jmxrmi\", host, port)),", "originalCommit": "02c981791e710e86237a11a7d472f6dd449bab4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MTM0Mg==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461191342", "bodyText": "That's a good call. I'll file a -core issue so it doesn't get forgotten.", "author": "andrewazores", "createdAt": "2020-07-27T21:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NjM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NDQyOA==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461194428", "bodyText": "cryostatio/cryostat-core#44", "author": "andrewazores", "createdAt": "2020-07-27T21:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2MTg4OQ==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461161889", "bodyText": "I don't see this being called anywhere with an argument. We could probably simplify this to head -c32, unless you want to keep this length parameter for the future.", "author": "ebaron", "createdAt": "2020-07-27T20:51:00Z", "path": "src/main/extras/app/entrypoint.sh", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/bin/sh\n+\n+set -x\n+set -e\n+\n+PWFILE=\"/tmp/jmxremote.password\"\n+function createJmxPassword() {\n+    PASS=\"$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-32})\"", "originalCommit": "02c981791e710e86237a11a7d472f6dd449bab4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NjU0OQ==", "url": "https://github.com/cryostatio/cryostat/pull/209#discussion_r461196549", "bodyText": "Yea it is currently unused. It can always be put back in the future, so I'll take it out for now and leave it at fixed-length of 32.", "author": "andrewazores", "createdAt": "2020-07-27T22:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2MTg4OQ=="}], "type": "inlineReview"}, {"oid": "bb0a0da0c1bfce0d7fc86bb3e5931d8dd192657f", "url": "https://github.com/cryostatio/cryostat/commit/bb0a0da0c1bfce0d7fc86bb3e5931d8dd192657f", "message": "Remove redundant 'catch' clause", "committedDate": "2020-07-27T21:58:40Z", "type": "commit"}, {"oid": "f51e4fd55a39b1ddff62a6798baf907e86c1a5a2", "url": "https://github.com/cryostatio/cryostat/commit/f51e4fd55a39b1ddff62a6798baf907e86c1a5a2", "message": "Use fixed-length generated password", "committedDate": "2020-07-27T22:03:25Z", "type": "commit"}]}