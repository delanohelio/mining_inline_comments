{"pr_number": 299, "pr_title": "Upload certificate", "pr_createdAt": "2020-10-15T21:23:22Z", "pr_url": "https://github.com/cryostatio/cryostat/pull/299", "timeline": [{"oid": "872e66c50b0fb85752cdc88a8721526ef4f0e1b3", "url": "https://github.com/cryostatio/cryostat/commit/872e66c50b0fb85752cdc88a8721526ef4f0e1b3", "message": "Create handler for certificate post request, writes to truststore but trustore is not dynamically read during runtime", "committedDate": "2020-10-15T18:38:57Z", "type": "commit"}, {"oid": "06f8a087b9694a9906e352b4d4ccb056584a2c6e", "url": "https://github.com/cryostatio/cryostat/commit/06f8a087b9694a9906e352b4d4ccb056584a2c6e", "message": "add truststore dir as env var", "committedDate": "2020-10-15T18:38:57Z", "type": "commit"}, {"oid": "a03e8372d02b33211767d1230a2b8052447e81f2", "url": "https://github.com/cryostatio/cryostat/commit/a03e8372d02b33211767d1230a2b8052447e81f2", "message": "Certificate post handler saves file to truststore dir, requires JVM restart for cert to take effect", "committedDate": "2020-10-15T21:08:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505871274", "bodyText": "Maybe this should be more direct about the problem, like A file named \"cert\" was not included in the request?", "author": "andrewazores", "createdAt": "2020-10-15T21:31:18Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");", "originalCommit": "a03e8372d02b33211767d1230a2b8052447e81f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1OTM0NA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507759344", "bodyText": "How can it distinguish between the file name and the form entry? because cert is the entry, not the file name right?", "author": "Alexjsenn", "createdAt": "2020-10-19T13:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc2ODc5OA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507768798", "bodyText": "The file uploads is something like a map of name to file contents, so what I mean here is that the literal string \"cert\" is not a key in the map. That's what cert == null is basically testing here already, right?", "author": "andrewazores", "createdAt": "2020-10-19T13:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzNzU3Nw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507837577", "bodyText": "Yes, exactly, I guess what I thought was confusing was that the key in the map is not the same as the name of the uploaded file, but I guess it makes sense.", "author": "Alexjsenn", "createdAt": "2020-10-19T15:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzODcwNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507838707", "bodyText": "No, it's the value in the map that is the name of the file. We should just tell the user which key they missed so that they can correct the response by including it and retrying.", "author": "andrewazores", "createdAt": "2020-10-19T15:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0MTEwNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507841107", "bodyText": "Yea, makes sense.", "author": "Alexjsenn", "createdAt": "2020-10-19T15:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3MTI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3Mzk5NA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505873994", "bodyText": "Better to avoid manually constructing paths like this. fs.pathOf takes varargs, so you should just be able to do fs.exists(fs.pathOf(truststoreDir, cert.fileName()))", "author": "andrewazores", "createdAt": "2020-10-15T21:35:01Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();", "originalCommit": "a03e8372d02b33211767d1230a2b8052447e81f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NzE3NA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505877174", "bodyText": "This looks like it can/should be refactored to use try-with-resources:\ntry (DataInputStream dis = new DataInputStream(new FileInputStream(certPath))) {\n// do stuff\n}\n\nThis is assuming that these resources are autocloseable, but I would expect they are. Generally anything that is autocloseable should be wrapped in a try-with-resources, since it guarantees that the resource is properly closed, even if an exception is thrown or there is an early return statement or any other exit condition. Probably all of the various Streams in here should be wrapped in this way.", "author": "andrewazores", "createdAt": "2020-10-15T21:39:18Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, \"Certificate already exists\");\n+        }\n+\n+        try {", "originalCommit": "a03e8372d02b33211767d1230a2b8052447e81f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3ODIyMQ==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r505878221", "bodyText": "May as well include the name of the conflicting certificate here, just for ease of debugging if this is showing up in ex. Operator logs or something.", "author": "andrewazores", "createdAt": "2020-10-15T21:40:51Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"No certificate found\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = truststoreDir + \"/\" + cert.fileName();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, \"Certificate already exists\");", "originalCommit": "a03e8372d02b33211767d1230a2b8052447e81f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16df3bb3d6b19bb305fcf980f33829dcc2318de1", "url": "https://github.com/cryostatio/cryostat/commit/16df3bb3d6b19bb305fcf980f33829dcc2318de1", "message": "Change error messages, refactor try block", "committedDate": "2020-10-19T15:22:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0NDU5NQ==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r507844595", "bodyText": "I think ByteArrayInputStream must also be closed, and is AutoCloseable.", "author": "andrewazores", "createdAt": "2020-10-19T15:27:30Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.security.spec.*;\n+\n+import javax.inject.Inject;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    @Inject\n+    CertificatePostHandler(AuthManager auth, Environment env, FileSystem fs, Logger logger) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        String certPath = fs.pathOf(cert.uploadedFileName()).normalize().toString();\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);\n+\n+        try (FileInputStream fis = new FileInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = new FileOutputStream(certFile)) {\n+            CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);", "originalCommit": "16df3bb3d6b19bb305fcf980f33829dcc2318de1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5bdf82ae7b92a3c815cce85ed2ee0faaf02d03f7", "url": "https://github.com/cryostatio/cryostat/commit/5bdf82ae7b92a3c815cce85ed2ee0faaf02d03f7", "message": "Add unit tests for certificatePostHandler", "committedDate": "2020-10-21T19:04:40Z", "type": "commit"}, {"oid": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "url": "https://github.com/cryostatio/cryostat/commit/edc75015f9d01666a2c53e81bb3057ef39fe906e", "message": "suppress spotbug error", "committedDate": "2020-10-21T19:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyMjkzNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509622937", "bodyText": "verify doesn't seem like the right name given the argument types and return type, even though it does reflect what the caller is currently using the method for. certificateFromBytes or something might be a more accurate/descriptive name, or even just createCertificate or parseCertificate.", "author": "andrewazores", "createdAt": "2020-10-21T19:46:51Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.ByteArrayInputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+\n+public class CertificateValidator {\n+\n+    public Certificate verify(ByteArrayInputStream byteStream) throws Exception {", "originalCommit": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDIxMw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624213", "bodyText": "I think filePath can be left as type Path here, removing the .toString()...", "author": "andrewazores", "createdAt": "2020-10-21T19:48:48Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();", "originalCommit": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDQwNg==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624406", "bodyText": "... which would remove the need for the repeated fs.pathOf here...", "author": "andrewazores", "createdAt": "2020-10-21T19:49:12Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {", "originalCommit": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNDcyMg==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509624722", "bodyText": "... and here, filePath.toFile() would achieve the same thing if you really need it as a File.", "author": "andrewazores", "createdAt": "2020-10-21T19:49:44Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);", "originalCommit": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyOTMzNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509629337", "bodyText": "This catch clause should probably be removed - the parent AbstractAuthenticatedRequestHandler class already has handling for exceptions thrown by subclasses, including general Exceptions which get wrapped into 500s similar to what has been repeated here. IMO it would be better to allow the abstract parent class to handle this so that the behaviour across all concrete implementations is uniform.", "author": "andrewazores", "createdAt": "2020-10-21T19:53:55Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        String filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize().toString();\n+\n+        if (fs.exists(fs.pathOf(filePath))) {\n+            throw new HttpStatusException(409, filePath + \" Certificate already exists\");\n+        }\n+\n+        File certFile = new File(filePath);\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(certFile)) {\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);\n+            Certificate certificate = certValidator.verify(bytestream);\n+            byte[] buf = certificate.getEncoded();\n+\n+            out.write(buf);\n+        } catch (Exception e) {\n+            throw new HttpStatusException(500, e.getMessage());", "originalCommit": "edc75015f9d01666a2c53e81bb3057ef39fe906e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NjM0Mw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r509656343", "bodyText": "Yes, that is definitely better!", "author": "Alexjsenn", "createdAt": "2020-10-21T20:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyOTMzNw=="}], "type": "inlineReview"}, {"oid": "759f5d5052af9b578ab7799aaa70a6603e7a7cf3", "url": "https://github.com/cryostatio/cryostat/commit/759f5d5052af9b578ab7799aaa70a6603e7a7cf3", "message": "Change certificateValidator method name", "committedDate": "2020-10-21T20:06:43Z", "type": "commit"}, {"oid": "c32f319801869263927398dca550de1510e98f0e", "url": "https://github.com/cryostatio/cryostat/commit/c32f319801869263927398dca550de1510e98f0e", "message": "remove catch statement in certificatePostHandler", "committedDate": "2020-10-21T20:15:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDQ2Mw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510254463", "bodyText": "buf seems unnecessary - if parseCertificate is just being used to validate that bytestream represents a well-formed certificate, can't we do out.write(bytestream) and avoid potentially re-encoding the Certificate back into a byte array, since we already have the byte array that encoded it to begin with?", "author": "andrewazores", "createdAt": "2020-10-22T15:27:42Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            byte[] bytes = new byte[dis.available()];\n+            dis.readFully(bytes);\n+            ByteArrayInputStream bytestream = new ByteArrayInputStream(bytes);\n+            Certificate certificate = certValidator.parseCertificate(bytestream);\n+            byte[] buf = certificate.getEncoded();", "originalCommit": "c32f319801869263927398dca550de1510e98f0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzA4Mg==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510263082", "bodyText": "Is it possible that the bytestream contain other information that is not part of the certificate but parsing the certificate still works? Or would it fail in that case?", "author": "Alexjsenn", "createdAt": "2020-10-22T15:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NDQ2Mg==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510264462", "bodyText": "I don't think so - if there were some additional garbage bytes then I should hope that parsing the buffer as a certificate should fail.", "author": "andrewazores", "createdAt": "2020-10-22T15:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDQ2Mw=="}], "type": "inlineReview"}, {"oid": "86ef8d24b71af739a45de9b8e86907b91b4d0f3e", "url": "https://github.com/cryostatio/cryostat/commit/86ef8d24b71af739a45de9b8e86907b91b4d0f3e", "message": "close byteArrayInputStream", "committedDate": "2020-10-22T15:33:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzI5MA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510263290", "bodyText": "Are you sure dis.available() tells you the total size of the certificate data in all scenarios? Not all streams implement available() in this way - it's more common that this method reports the number of bytes that can be read without blocking on the next invocation of read(). If this is the case, then for larger certificates (or various other conditions perhaps to do with the underlying OS/kernel, filesystem, etc.), this byte buffer may end up undersized and only some initial chunk of the certificate will be read into the buffer, rather than the whole thing.\nWhy is the ByteArrayInputStream wrapping around this buffer needed to begin with? Can't fis or dis be passed directly to parseCertificate? The docs for generateCertificate say it accepts a generic InputStream, not specifically a ByteArrayInputStream.", "author": "andrewazores", "createdAt": "2020-10-22T15:39:27Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.DataInputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                DataInputStream dis = new DataInputStream(fis);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            byte[] bytes = new byte[dis.available()];", "originalCommit": "86ef8d24b71af739a45de9b8e86907b91b4d0f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4MDkwNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510280907", "bodyText": "It gives parsing errors when passing in the InputStream or DataInputStream. However I could add the byte array part into the parseCertificate method.", "author": "Alexjsenn", "createdAt": "2020-10-22T16:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5NDkzOA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510294938", "bodyText": "What \"parsing errors\"? Does it throw a CertificateException, and if so, does the exception say anything informative?\nThe official docs suggest that passing the FileInputStream wrapped in a BufferedInputStream should be sufficient: https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/security/cert/CertificateFactory.html\nie.\n FileInputStream fis = new FileInputStream(filename);\n BufferedInputStream bis = new BufferedInputStream(fis);\n\n CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n\n while (bis.available() > 0) {\n    Certificate cert = cf.generateCertificate(bis);\n    System.out.println(cert.toString());\n }\n\nand\n FileInputStream fis = new FileInputStream(filename);\n CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n Collection c = cf.generateCertificates(fis);\n Iterator i = c.iterator();\n while (i.hasNext()) {\n    Certificate cert = (Certificate)i.next();\n    System.out.println(cert);\n }\n\nIt would be much better if we can figure a way to generate the certificate more directly from a stream of the file, without first reading the whole file into an application memory buffer and making a stream out of that. Less bug prone and probably better overall throughput performance.", "author": "andrewazores", "createdAt": "2020-10-22T16:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDI1NA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510404254", "bodyText": "I changed the certificateValidator, it now takes in a InputStream, and outputs a Collection.", "author": "Alexjsenn", "createdAt": "2020-10-22T19:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MzI5MA=="}], "type": "inlineReview"}, {"oid": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "url": "https://github.com/cryostatio/cryostat/commit/4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "message": "Change certificateValidator to return Collection", "committedDate": "2020-10-22T19:26:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMDY0Nw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510420647", "bodyText": "Little nitpick: since this now returns a Collection, the method name should probably be update to reflect that. ie parseCertificates. Also, the raw type Collection could probably be written here as Collection<Certificate> for a bit of extra type-safety.", "author": "andrewazores", "createdAt": "2020-10-22T19:57:39Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.InputStream;\n+import java.security.cert.CertificateFactory;\n+import java.util.Collection;\n+\n+public class CertificateValidator {\n+\n+    public Collection parseCertificate(InputStream stream) throws Exception {", "originalCommit": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMTExMA==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510421110", "bodyText": "https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/security/cert/CertificateFactory.html#generateCertificates(java.io.InputStream)\nActually, Collection<? extends Certificate> - makes sense as there are subtypes of Certificate as well, like X509Certificate.", "author": "andrewazores", "createdAt": "2020-10-22T19:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMDY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMTc5NQ==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510421795", "bodyText": "Likewise, this Collection and its Iterator are raw types here but are generics and so should be Collection<? extends Certificate> and Iterator<? extends Certificate>.", "author": "andrewazores", "createdAt": "2020-10-22T19:59:42Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/web/http/api/v2/CertificatePostHandler.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.web.http.api.v2;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.security.cert.Certificate;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.function.Function;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+import com.redhat.rhjmc.containerjfr.core.sys.Environment;\n+import com.redhat.rhjmc.containerjfr.core.sys.FileSystem;\n+import com.redhat.rhjmc.containerjfr.net.AuthManager;\n+import com.redhat.rhjmc.containerjfr.net.security.CertificateValidator;\n+import com.redhat.rhjmc.containerjfr.net.web.http.AbstractAuthenticatedRequestHandler;\n+import com.redhat.rhjmc.containerjfr.net.web.http.api.ApiVersion;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.FileUpload;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.impl.HttpStatusException;\n+\n+class CertificatePostHandler extends AbstractAuthenticatedRequestHandler {\n+\n+    static final String PATH = \"certificates\";\n+\n+    private final Environment env;\n+    private final FileSystem fs;\n+    private final Logger logger;\n+\n+    private static final String TRUSTSTORE_DIR = \"TRUSTSTORE_DIR\";\n+\n+    private Function<File, FileOutputStream> outputStreamFunction;\n+    private CertificateValidator certValidator;\n+\n+    @Inject\n+    CertificatePostHandler(\n+            AuthManager auth,\n+            Environment env,\n+            FileSystem fs,\n+            Logger logger,\n+            @Named(\"OutputStreamFunction\") Function<File, FileOutputStream> outputStreamFunction,\n+            CertificateValidator certValidator) {\n+        super(auth);\n+        this.env = env;\n+        this.fs = fs;\n+        this.logger = logger;\n+        this.outputStreamFunction = outputStreamFunction;\n+        this.certValidator = certValidator;\n+    }\n+\n+    @Override\n+    public ApiVersion apiVersion() {\n+        return ApiVersion.V2;\n+    }\n+\n+    @Override\n+    public HttpMethod httpMethod() {\n+        return HttpMethod.POST;\n+    }\n+\n+    @Override\n+    public String path() {\n+        return basePath() + PATH;\n+    }\n+\n+    @Override\n+    public boolean isAsync() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean isOrdered() {\n+        return true;\n+    }\n+\n+    @Override\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public void handleAuthenticated(RoutingContext ctx) throws Exception {\n+        FileUpload cert = null;\n+        for (FileUpload fu : ctx.fileUploads()) {\n+            if (\"cert\".equals(fu.name())) {\n+                cert = fu;\n+                break;\n+            }\n+        }\n+\n+        if (cert == null) {\n+            throw new HttpStatusException(\n+                    400, \"A file named \\\"cert\\\" was not included in the request\");\n+        }\n+\n+        Path certPath = fs.pathOf(cert.uploadedFileName());\n+\n+        if (!env.hasEnv(TRUSTSTORE_DIR)) {\n+            throw new HttpStatusException(500, \"Truststore directory not set\");\n+        }\n+\n+        String truststoreDir = env.getEnv(TRUSTSTORE_DIR);\n+        Path filePath = fs.pathOf(truststoreDir, cert.fileName()).normalize();\n+\n+        if (fs.exists(filePath)) {\n+            throw new HttpStatusException(409, filePath.toString() + \" Certificate already exists\");\n+        }\n+\n+        try (InputStream fis = fs.newInputStream(certPath);\n+                FileOutputStream out = outputStreamFunction.apply(filePath.toFile())) {\n+\n+            Collection certificates = certValidator.parseCertificate(fis);", "originalCommit": "4409c0d1ccd80fcac088d2441ad2c45d690fdefc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ee4e9d18a55802d54a404367e9bcbe06d74f5ed", "url": "https://github.com/cryostatio/cryostat/commit/5ee4e9d18a55802d54a404367e9bcbe06d74f5ed", "message": "Change method name for certificateValidator", "committedDate": "2020-10-22T20:50:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkyNjIwNw==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510926207", "bodyText": "This is failing to compile for me - this line returns Collection<? extends Certificate> but the return type of parseCertificates is Collection<Certificate>. The method return type should be updated to match the bounded wildcard as we discussed over IRC.", "author": "andrewazores", "createdAt": "2020-10-23T14:32:36Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/net/security/CertificateValidator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.net.security;\n+\n+import java.io.InputStream;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateFactory;\n+import java.util.Collection;\n+\n+public class CertificateValidator {\n+\n+    public Collection<Certificate> parseCertificates(InputStream stream) throws Exception {\n+        CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+        return cf.generateCertificates(stream);", "originalCommit": "5ee4e9d18a55802d54a404367e9bcbe06d74f5ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkzNjM4OQ==", "url": "https://github.com/cryostatio/cryostat/pull/299#discussion_r510936389", "bodyText": "Sorry about that, should be fixed.", "author": "Alexjsenn", "createdAt": "2020-10-23T14:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkyNjIwNw=="}], "type": "inlineReview"}, {"oid": "cdf52d81ad68eb63b51e3c15235c34497c4e4a3f", "url": "https://github.com/cryostatio/cryostat/commit/cdf52d81ad68eb63b51e3c15235c34497c4e4a3f", "message": "Change return type for parseCertificates", "committedDate": "2020-10-23T14:46:34Z", "type": "commit"}]}