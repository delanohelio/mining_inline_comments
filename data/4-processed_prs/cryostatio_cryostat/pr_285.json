{"pr_number": 285, "pr_title": "Add Snapshot API V2 handler", "pr_createdAt": "2020-10-05T18:18:55Z", "pr_url": "https://github.com/cryostatio/cryostat/pull/285", "timeline": [{"oid": "f088d24490c45312cc58bae01b4bb6d49d87dc58", "url": "https://github.com/cryostatio/cryostat/commit/f088d24490c45312cc58bae01b4bb6d49d87dc58", "message": "Add Snapshot API V2 handler\n\nEncodes response as JSON with the same properties as customized recording creation", "committedDate": "2020-10-05T18:16:53Z", "type": "commit"}, {"oid": "4360a61bdcd600b94154f39d4b645af894b2f0da", "url": "https://github.com/cryostatio/cryostat/commit/4360a61bdcd600b94154f39d4b645af894b2f0da", "message": "Add V2 API docs", "committedDate": "2020-10-05T18:31:30Z", "type": "commit"}, {"oid": "d85c12656e91f16ffa86b1ae5b72676654d34eb1", "url": "https://github.com/cryostatio/cryostat/commit/d85c12656e91f16ffa86b1ae5b72676654d34eb1", "message": "Respond 201 and include Location header", "committedDate": "2020-10-05T18:41:06Z", "type": "forcePushed"}, {"oid": "e99df45bdbce805888d4cec2762036724807921a", "url": "https://github.com/cryostatio/cryostat/commit/e99df45bdbce805888d4cec2762036724807921a", "message": "Respond 201 and include Location header", "committedDate": "2020-10-05T18:42:34Z", "type": "forcePushed"}, {"oid": "5253a54f58f197bda02a24c42004ba67558cc9d4", "url": "https://github.com/cryostatio/cryostat/commit/5253a54f58f197bda02a24c42004ba67558cc9d4", "message": "Respond 201 and include Location header", "committedDate": "2020-10-05T18:44:27Z", "type": "commit"}, {"oid": "5253a54f58f197bda02a24c42004ba67558cc9d4", "url": "https://github.com/cryostatio/cryostat/commit/5253a54f58f197bda02a24c42004ba67558cc9d4", "message": "Respond 201 and include Location header", "committedDate": "2020-10-05T18:44:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMjIxNw==", "url": "https://github.com/cryostatio/cryostat/pull/285#discussion_r500402217", "bodyText": "The response body here just needs to be updated for V2. I just ran it so you can use this if you want:\n{\"downloadUrl\":\"http://192.168.0.109:8181/api/v1/targets/service:jmx:rmi:%2F%2F%2Fjndi%2Frmi:%2F%2Flocalhost:9091%2Fjmxrmi/recordings/snapshot-1\",\"reportUrl\":\"http://192.168.0.109:8181/api/v1/targets/service:jmx:rmi:%2F%2F%2Fjndi%2Frmi:%2F%2Flocalhost:9091%2Fjmxrmi/reports/snapshot-1\",\"id\":1,\"name\":\"snapshot-1\",\"state\":\"STOPPED\",\"startTime\":1601998841300,\"duration\":0,\"continuous\":true,\"toDisk\":true,\"maxSize\":0,\"maxAge\":0}", "author": "vic-ma", "createdAt": "2020-10-06T15:41:12Z", "path": "HTTP_API.md", "diffHunk": "@@ -1169,3 +1169,58 @@\n     ```\n     $ curl --form \"template=@Foo.jfc\" localhost:8181/api/v1/templates\n     ```\n+\n+## V2 API\n+\n+### Quick Reference\n+\n+| What you want to do                                                       | Which handler you should use                                                |\n+| ------------------------------------------------------------------------- | --------------------------------------------------------------------------- |\n+| **Recordings in target JVMs**                                             |                                                                             |\n+| Create a snapshot recording in a target JVM                               | [`TargetSnapshotPostHandler`](#TargetSnapshotPostHandler)                   |\n+\n+### Flight Recorder\n+\n+* #### `TargetSnapshotPostHandler`\n+\n+    ###### synopsis\n+    Creates a recording named `snapshot-n`, where `n` is a sequentially\n+    assigned ID, which contains information about all events recorded\n+    across all active recordings at the time of invocation.\n+\n+    ###### request\n+    `POST /api/v2/targets/:targetId/snapshot`\n+\n+    `targetId` - The location of the target JVM to connect to,\n+    in the form of a `service:rmi:jmx://` JMX Service URL, or `hostname:port`.\n+    Should use percent-encoding.\n+\n+    ###### response\n+\n+    `headers`\n+\n+    `Location` - will be set to the URL where the newly created snapshot recording\n+    can be retrieved.\n+\n+    `statuses`\n+\n+    `200` - The body is a descriptor of the newly started recording, in the form\n+    `{\"downloadUrl\":\"$DOWNLOAD_URL\",\"reportUrl\":\"$REPORT_URL\",\"id\":$ID,\"name\":\"$NAME\",\"state\":\"$STATE\",\"startTime\":$START_TIME,\"duration\":$DURATION,\"continuous\":$CONTINUOUS,\"toDisk\":$TO_DISK,\"maxSize\":$MAX_SIZE,\"maxAge\":$MAX_AGE}`.\n+\n+    `401` - User authentication failed. The body is an error message.\n+    There will be an `X-WWW-Authenticate: $SCHEME` header that indicates\n+    the authentication scheme that is used.\n+\n+    `404` - The target could not be found. The body is an error message.\n+\n+    `427` - JMX authentication failed. The body is an error message.\n+    There will be an `X-JMX-Authenticate: $SCHEME` header that indicates\n+    the authentication scheme that is used.\n+\n+    `500` - There was an unexpected error. The body is an error message.\n+\n+    ###### example\n+    ```\n+    $ curl -X POST localhost:8181/api/v2/targets/localhost/snapshot\n+    snapshot-2", "originalCommit": "5253a54f58f197bda02a24c42004ba67558cc9d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxNjA0Nw==", "url": "https://github.com/cryostatio/cryostat/pull/285#discussion_r500416047", "bodyText": "I think this should instead be a comment added to the description of the 200 response, similar to how it is with 401 and the auth header. The reason being that this header is only present if the response is a 200, but having it under \"headers\" under \"response\" might make it seem like every response will contain this header.", "author": "vic-ma", "createdAt": "2020-10-06T15:59:57Z", "path": "HTTP_API.md", "diffHunk": "@@ -1169,3 +1169,58 @@\n     ```\n     $ curl --form \"template=@Foo.jfc\" localhost:8181/api/v1/templates\n     ```\n+\n+## V2 API\n+\n+### Quick Reference\n+\n+| What you want to do                                                       | Which handler you should use                                                |\n+| ------------------------------------------------------------------------- | --------------------------------------------------------------------------- |\n+| **Recordings in target JVMs**                                             |                                                                             |\n+| Create a snapshot recording in a target JVM                               | [`TargetSnapshotPostHandler`](#TargetSnapshotPostHandler)                   |\n+\n+### Flight Recorder\n+\n+* #### `TargetSnapshotPostHandler`\n+\n+    ###### synopsis\n+    Creates a recording named `snapshot-n`, where `n` is a sequentially\n+    assigned ID, which contains information about all events recorded\n+    across all active recordings at the time of invocation.\n+\n+    ###### request\n+    `POST /api/v2/targets/:targetId/snapshot`\n+\n+    `targetId` - The location of the target JVM to connect to,\n+    in the form of a `service:rmi:jmx://` JMX Service URL, or `hostname:port`.\n+    Should use percent-encoding.\n+\n+    ###### response\n+\n+    `headers`\n+\n+    `Location` - will be set to the URL where the newly created snapshot recording", "originalCommit": "5253a54f58f197bda02a24c42004ba67558cc9d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxOTUwMg==", "url": "https://github.com/cryostatio/cryostat/pull/285#discussion_r500419502", "bodyText": "This breaks the anchor links in HTTP_API.md since there are now two handlers by the same name, performing generally the same role, but for API V1/V2.\n\nI tried clicking on the anchor button next to the header and it looks like github adds a counter for duplicate names. So I tested it using [...](#TargetSnapshotPostHandler-1) and it looks like that works.\n\nIMO the document should probably be split per version to avoid problems like this and prevent it from growing indefinitely.\n\nYeah, I think that's a good idea too. If V2 had the same amount of handlers as V1, I think that would make the document really hard to use and navigate for whichever version was at the bottom.", "author": "vic-ma", "createdAt": "2020-10-06T16:04:48Z", "path": "HTTP_API.md", "diffHunk": "@@ -1169,3 +1169,58 @@\n     ```\n     $ curl --form \"template=@Foo.jfc\" localhost:8181/api/v1/templates\n     ```\n+\n+## V2 API\n+\n+### Quick Reference\n+\n+| What you want to do                                                       | Which handler you should use                                                |\n+| ------------------------------------------------------------------------- | --------------------------------------------------------------------------- |\n+| **Recordings in target JVMs**                                             |                                                                             |\n+| Create a snapshot recording in a target JVM                               | [`TargetSnapshotPostHandler`](#TargetSnapshotPostHandler)                   |", "originalCommit": "5253a54f58f197bda02a24c42004ba67558cc9d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NTM1Mg==", "url": "https://github.com/cryostatio/cryostat/pull/285#discussion_r500445352", "bodyText": "re: anchor counts - cool, that's very neat\nre: doc splitting - alright, that's probably a topic for a separate PR. I'll leave it as-is tagged on the end for now and then we can figure out the best way to split it up", "author": "andrewazores", "createdAt": "2020-10-06T16:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxOTUwMg=="}], "type": "inlineReview"}, {"oid": "839f9869c1db38e529bc81e69cf2e1ca373b73e3", "url": "https://github.com/cryostatio/cryostat/commit/839f9869c1db38e529bc81e69cf2e1ca373b73e3", "message": "Update docs", "committedDate": "2020-10-06T16:46:04Z", "type": "commit"}]}