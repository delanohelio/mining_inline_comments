{"pr_number": 375, "pr_title": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "pr_createdAt": "2020-09-30T13:43:34Z", "pr_url": "https://github.com/kiegroup/kogito-examples/pull/375", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyMzU0NA==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497523544", "bodyText": "Added @r00ta since the changes in this test besides of the other pom changes.", "author": "tarilabs", "createdAt": "2020-09-30T13:47:53Z", "path": "dmn-tracing-quarkus/src/test/java/org/kie/dmn/kogito/quarkus/tracing/LoanEligibilityTest.java", "diffHunk": "@@ -15,55 +15,57 @@\n  */\n package org.kie.dmn.kogito.quarkus.tracing;\n \n+import static io.restassured.RestAssured.given;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n \n-import javax.inject.Inject;\n-\n-import com.fasterxml.jackson.core.JsonProcessingException;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import io.quarkus.test.common.QuarkusTestResource;\n-import io.quarkus.test.junit.QuarkusTest;\n-import io.restassured.http.ContentType;\n import org.eclipse.microprofile.config.inject.ConfigProperty;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.kie.kogito.kafka.KafkaClient;\n import org.kie.kogito.testcontainers.quarkus.KafkaQuarkusTestResource;\n import org.kie.kogito.tracing.decision.event.trace.TraceEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static io.restassured.RestAssured.given;\n-import static org.hamcrest.Matchers.is;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import io.quarkus.test.common.QuarkusTestResource;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.http.ContentType;\n \n @QuarkusTest\n @QuarkusTestResource(KafkaQuarkusTestResource.class)\n public class LoanEligibilityTest {\n \n-    private static Logger LOGGER = LoggerFactory.getLogger(LoanEligibilityTest.class);\n-\n     public static final String TOPIC_CONSUMER = \"kogito-tracing-decision\";\n \n-    @Inject\n-    private ObjectMapper objectMapper;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LoanEligibilityTest.class);\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n \n-    public KafkaClient kafkaClient;\n+    private KafkaClient kafkaClient;\n \n     @ConfigProperty(name = KafkaQuarkusTestResource.KOGITO_KAFKA_PROPERTY)\n     private String kafkaBootstrapServers;\n \n-    @Test\n-    public void testEvaluateTrafficViolation() throws InterruptedException {\n+    @BeforeEach\n+    public void setup() {\n         kafkaClient = new KafkaClient(kafkaBootstrapServers);\n+    }\n \n+    @Test\n+    public void testEvaluateTrafficViolation() throws InterruptedException {", "originalCommit": "502e9264d20d4bd6c2555cf16a564976f9c6e42f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497530282", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <failsafe.include>**/Native*IT.java</failsafe.include>\n          \n          \n            \n                    <failsafe.exclude></failsafe.exclude>\n          \n          \n            \n                    <failsafe.include>**/*IT.java,**/IT*.java,**/*ITCase.java</failsafe.include>\n          \n          \n            \n                    <failsafe.exclude></failsafe.exclude>\n          \n      \n    \n    \n  \n\nwouldn't it be simpler to restore it as default, since native test are anyway annotated?", "author": "tarilabs", "createdAt": "2020-09-30T13:56:25Z", "path": "pom.xml", "diffHunk": "@@ -232,6 +233,74 @@\n         <module>process-springboot-example</module>\n       </modules>\n     </profile>\n+\n+    <profile>\n+      <id>native</id>\n+      <properties>\n+        <failsafe.include>**/Native*IT.java</failsafe.include>\n+        <failsafe.exclude></failsafe.exclude>", "originalCommit": "502e9264d20d4bd6c2555cf16a564976f9c6e42f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1OTc5NA==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497559794", "bodyText": "Do you mean to not set the \"failsafe.include\" property (as the default one \"**/*IT.java\" already satisfy the native tests? If so, I'm fine with that, I will do it. But using the regular expressions that you suggest seems way more complex.", "author": "Sgitario", "createdAt": "2020-09-30T14:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MjU1MA==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497562550", "bodyText": "I meant to restore the Failsafe's default: https://maven.apache.org/surefire/maven-failsafe-plugin/examples/inclusion-exclusion.html#Inclusions", "author": "tarilabs", "createdAt": "2020-09-30T14:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MzcwMQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497563701", "bodyText": "This won't work as Quarkus needs a special annotation @NativeImageTest which only has it the Native*IT.java classes to work. If a IT test is executed in native mode, it won't work.", "author": "Sgitario", "createdAt": "2020-09-30T14:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2OTcyOQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497569729", "bodyText": "This won't work as Quarkus needs a special annotation @NativeImageTest which only has it the Native*IT.java classes to work\n\ninteresting, I didn't know that. Can you point me to the reference where the annotation enforces the name to be Native*IT.java, please?", "author": "tarilabs", "createdAt": "2020-09-30T14:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjk0OQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497622949", "bodyText": "I had a look to quarkus doc because I remember something similar but the required setup for native testing seems to be a bit different\nhttps://quarkus.io/guides/getting-started-testing#native-executable-testing\nhttps://quarkus.io/guides/building-native-image#testing-the-native-executable\nI don't see any specific filter on resources\n@Sgitario can you please verify?", "author": "danielezonca", "createdAt": "2020-09-30T15:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcwMzE5OQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r497703199", "bodyText": "Let me be clearer on this:\n\n\nThe @NativeImageTest annotation from Quarkus does not require that the class name follows \"NativeIT, we do. I meant that all the NativeIT.java classes we have in Kogito Examples, use this annotation (and that's why we are safe to use this regular expression in the pom.xml).\n\n\nWe need to set the property \"failsafe.include\" to \"**/Native*IT.java\" to not execute the *IT classes. Otherwise, when there are both IT.java and NativeIT.java classes, the build fails at integration-test stage (the *IT test fails). You can try yourself.\n\n\nHowever, let me know if you think something here can be improved or done differently.", "author": "Sgitario", "createdAt": "2020-09-30T18:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzNDkxOQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r498134919", "bodyText": "Ok thanks for your explanation. I see your point, we have some ITs that requires native mode and others not so we decided to apply this naming convention to solve this.\nI think we should better document it but it is out of scope for this PR :)", "author": "danielezonca", "createdAt": "2020-10-01T10:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzMDI4Mg=="}], "type": "inlineReview"}, {"oid": "4320724402a63234ac6eee2ceb2e60ff213f0e89", "url": "https://github.com/kiegroup/kogito-examples/commit/4320724402a63234ac6eee2ceb2e60ff213f0e89", "message": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "committedDate": "2020-09-30T18:05:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MDQ2NQ==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r498140465", "bodyText": "One question, why just don't apply this configuration to all the modules instead of enumerate the modules where we can have native tests?", "author": "danielezonca", "createdAt": "2020-10-01T10:24:42Z", "path": "pom.xml", "diffHunk": "@@ -232,6 +233,74 @@\n         <module>process-springboot-example</module>\n       </modules>\n     </profile>\n+\n+    <profile>\n+      <id>native</id>\n+      <properties>\n+        <failsafe.include>**/Native*IT.java</failsafe.include>\n+        <failsafe.exclude></failsafe.exclude>\n+        <quarkus.package.type>native</quarkus.package.type>\n+      </properties>\n+      <activation>\n+        <property>\n+          <name>native</name>\n+        </property>\n+      </activation>\n+      <modules>\n+        <module>decisiontable-quarkus-example</module>\n+        <module>dmn-listener-quarkus</module>\n+        <module>dmn-pmml-quarkus-example</module>\n+        <module>dmn-quarkus-example</module>\n+        <module>dmn-drools-quarkus-metrics</module>\n+        <module>dmn-tracing-quarkus</module>\n+        <module>flexible-process-quarkus</module>\n+        <module>kogito-travel-agency</module>\n+        <module>onboarding-example</module>\n+        <module>pmml-quarkus-example</module>\n+        <module>process-business-rules-quarkus</module>\n+        <module>process-infinispan-persistence-quarkus</module>\n+        <module>process-kafka-quickstart-quarkus</module>\n+        <module>process-knative-quickstart-quarkus</module>\n+        <module>process-mongodb-persistence-quarkus</module>\n+        <module>process-optaplanner-quarkus</module>\n+        <module>process-quarkus-example</module>\n+        <module>process-scripts-quarkus</module>\n+        <module>process-service-calls-quarkus</module>\n+        <module>process-service-rest-call-quarkus</module>\n+        <module>process-timer-quarkus</module>\n+        <module>process-usertasks-custom-lifecycle-quarkus</module>\n+        <module>process-usertasks-quarkus</module>\n+        <module>process-usertasks-with-security-oidc-quarkus</module>\n+        <module>process-usertasks-with-security-quarkus</module>\n+        <module>rules-quarkus-helloworld</module>\n+        <module>ruleunit-quarkus-example</module>\n+        <module>serverless-workflow-greeting-quarkus</module>\n+        <module>serverless-workflow-service-calls-quarkus</module>\n+        <module>serverless-workflow-events-quarkus</module>\n+      </modules>", "originalCommit": "4320724402a63234ac6eee2ceb2e60ff213f0e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0OTU0Ng==", "url": "https://github.com/kiegroup/kogito-examples/pull/375#discussion_r498149546", "bodyText": "This is to group only the quarkus modules and hence exclude the spring boot examples.", "author": "Sgitario", "createdAt": "2020-10-01T10:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE0MDQ2NQ=="}], "type": "inlineReview"}, {"oid": "5e23bf8f924ea6651a9d01b9bf78f6459072fad1", "url": "https://github.com/kiegroup/kogito-examples/commit/5e23bf8f924ea6651a9d01b9bf78f6459072fad1", "message": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "committedDate": "2020-10-02T05:51:51Z", "type": "forcePushed"}, {"oid": "21cfb1ac478f7aa1ae92ac1bf165495c3cee528e", "url": "https://github.com/kiegroup/kogito-examples/commit/21cfb1ac478f7aa1ae92ac1bf165495c3cee528e", "message": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "committedDate": "2020-10-05T06:02:50Z", "type": "forcePushed"}, {"oid": "d790c828517b061716087ed125a4f0f84e7695c2", "url": "https://github.com/kiegroup/kogito-examples/commit/d790c828517b061716087ed125a4f0f84e7695c2", "message": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "committedDate": "2020-10-06T05:14:28Z", "type": "commit"}, {"oid": "d790c828517b061716087ed125a4f0f84e7695c2", "url": "https://github.com/kiegroup/kogito-examples/commit/d790c828517b061716087ed125a4f0f84e7695c2", "message": "KOGITO-3480: Native Tests are not being executed in Kogito Examples", "committedDate": "2020-10-06T05:14:28Z", "type": "forcePushed"}]}