{"pr_number": 2312, "pr_title": "[#2029] Use Command Router in adapters and integration tests", "pr_createdAt": "2020-11-20T13:58:37Z", "pr_url": "https://github.com/eclipse/hono/pull/2312", "timeline": [{"oid": "06c2ce3bb542d7810e3d6c1d11c59979ca652397", "url": "https://github.com/eclipse/hono/commit/06c2ce3bb542d7810e3d6c1d11c59979ca652397", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-20T14:00:32Z", "type": "forcePushed"}, {"oid": "e8f684516f5f150e6c2b1322eaecb0f539c92db8", "url": "https://github.com/eclipse/hono/commit/e8f684516f5f150e6c2b1322eaecb0f539c92db8", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-20T14:02:16Z", "type": "forcePushed"}, {"oid": "00d8e6add4a23e6d6ba862c695748b6217c00314", "url": "https://github.com/eclipse/hono/commit/00d8e6add4a23e6d6ba862c695748b6217c00314", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-20T16:17:44Z", "type": "forcePushed"}, {"oid": "27adeb740dfc8a7c5fce2c6797d0dda8a5b7dd2c", "url": "https://github.com/eclipse/hono/commit/27adeb740dfc8a7c5fce2c6797d0dda8a5b7dd2c", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-20T16:54:28Z", "type": "forcePushed"}, {"oid": "fb6b499b5f3072d9dde3fcaa78b2dd6cf3cf812b", "url": "https://github.com/eclipse/hono/commit/fb6b499b5f3072d9dde3fcaa78b2dd6cf3cf812b", "message": "For debugging: set cmdRouter loglevel to TRACE.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-23T07:16:51Z", "type": "forcePushed"}, {"oid": "aa5f662fe2cff6d75b6c09dddd11961c73e3f308", "url": "https://github.com/eclipse/hono/commit/aa5f662fe2cff6d75b6c09dddd11961c73e3f308", "message": "For debugging: set cmdRouter loglevel to TRACE.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-23T07:49:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxMzczMQ==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528513731", "bodyText": "this doesn't look right ...", "author": "sophokles73", "createdAt": "2020-11-23T07:44:08Z", "path": "services/command-router/src/main/resources/logback-spring.xml", "diffHunk": "@@ -27,29 +27,35 @@\n     <appender-ref ref=\"STDOUT\" />\n   </root>\n \n-  <springProfile name=\"dev\">\n-    <logger name=\"org.eclipse.hono.client\" level=\"DEBUG\"/>\n-    <logger name=\"org.eclipse.hono.connection\" level=\"DEBUG\"/>\n-    <logger name=\"org.eclipse.hono.commandrouter\" level=\"DEBUG\"/>\n-    <logger name=\"org.eclipse.hono.service\" level=\"DEBUG\"/>\n+  <logger name=\"org.eclipse.hono.client\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.adapter.client\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.connection\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.commandrouter\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.service\" level=\"TRACE\"/>\n \n-    <logger name=\"org.infinispan\" level=\"DEBUG\"/>\n+<!--  <springProfile name=\"dev\">-->\n+<!--    <logger name=\"org.eclipse.hono.client\" level=\"DEBUG\"/>-->\n+<!--    <logger name=\"org.eclipse.hono.connection\" level=\"DEBUG\"/>-->\n+<!--    <logger name=\"org.eclipse.hono.commandrouter\" level=\"DEBUG\"/>-->\n+<!--    <logger name=\"org.eclipse.hono.service\" level=\"DEBUG\"/>-->\n \n-    <logger name=\"io.netty.handler.logging.LoggingHandler\" level=\"DEBUG\"/>\n-    <logger name=\"io.netty.resolver.dns\" level=\"INFO\"/>\n+<!--    <logger name=\"org.infinispan\" level=\"DEBUG\"/>-->\n \n-    <logger name=\"io.vertx.proton.impl\" level=\"INFO\"/>\n-    <logger name=\"io.vertx.core.net.impl\" level=\"INFO\"/>\n-  </springProfile>\n+<!--    <logger name=\"io.netty.handler.logging.LoggingHandler\" level=\"DEBUG\"/>-->\n+<!--    <logger name=\"io.netty.resolver.dns\" level=\"INFO\"/>-->\n \n-  <springProfile name=\"prod\">\n-    <logger name=\"org.eclipse.hono\" level=\"INFO\"/>\n+<!--    <logger name=\"io.vertx.proton.impl\" level=\"INFO\"/>-->\n+<!--    <logger name=\"io.vertx.core.net.impl\" level=\"INFO\"/>-->\n+<!--  </springProfile>-->\n \n-    <logger name=\"io.netty.handler.logging.LoggingHandler\" level=\"INFO\"/>\n-    <logger name=\"io.netty.resolver.dns\" level=\"INFO\"/>\n+<!--  <springProfile name=\"prod\">-->\n+<!--    <logger name=\"org.eclipse.hono\" level=\"INFO\"/>-->\n \n-    <logger name=\"io.vertx.proton.impl\" level=\"INFO\"/>\n-    <logger name=\"io.vertx.core.net.impl\" level=\"INFO\"/>\n-  </springProfile>\n+<!--    <logger name=\"io.netty.handler.logging.LoggingHandler\" level=\"INFO\"/>-->\n+<!--    <logger name=\"io.netty.resolver.dns\" level=\"INFO\"/>-->\n+\n+<!--    <logger name=\"io.vertx.proton.impl\" level=\"INFO\"/>-->\n+<!--    <logger name=\"io.vertx.core.net.impl\" level=\"INFO\"/>-->\n+<!--  </springProfile>-->", "originalCommit": "fb6b499b5f3072d9dde3fcaa78b2dd6cf3cf812b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNDE5Nw==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528514197", "bodyText": "we should also skip building the image if the command router is disabled ...", "author": "sophokles73", "createdAt": "2020-11-23T07:45:20Z", "path": "tests/pom.xml", "diffHunk": "@@ -875,6 +902,79 @@ Test cases are run against Docker images of Hono server + (Apache Qpid Dispatch\n                     </wait>\n                   </run>\n                 </image>\n+                <!-- ##### Command Router service (may also act as Device Connection service via 'enable-device-connection-endpoint') ##### -->\n+                <image>\n+                  <name>${docker.repository}/hono-service-command-router-test</name>\n+                  <alias>command-router</alias>\n+                  <build>\n+                    <imagePullPolicy>IfNotPresent</imagePullPolicy>", "originalCommit": "fb6b499b5f3072d9dde3fcaa78b2dd6cf3cf812b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3ODMxMw==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r530878313", "bodyText": "Done", "author": "calohmn", "createdAt": "2020-11-26T09:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNDE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjYzNA==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528516634", "bodyText": "this doesn't look right", "author": "sophokles73", "createdAt": "2020-11-23T07:51:33Z", "path": "tests/src/test/resources/commandrouter/logback-spring.xml", "diffHunk": "@@ -0,0 +1,68 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+    Copyright (c) 2020 Contributors to the Eclipse Foundation\n+   \n+    See the NOTICE file(s) distributed with this work for additional\n+    information regarding copyright ownership.\n+   \n+    This program and the accompanying materials are made available under the\n+    terms of the Eclipse Public License 2.0 which is available at\n+    http://www.eclipse.org/legal/epl-2.0\n+   \n+    SPDX-License-Identifier: EPL-2.0\n+ -->\n+\n+<!DOCTYPE configuration>\n+\n+<configuration>\n+\n+  <!-- \n+    This is the logging configuration that is used by the\n+    Hono Command Router Docker image while executing the integration tests.\n+\n+    Any changes made here will be reflected on the next start\n+    of the Hono Command Router Docker image only, i.e. the next time\n+\n+    mvn -Prun-tests verify\n+\n+    is invoked.\n+   -->\n+\n+  <appender name=\"STDOUT\" class=\"ch.qos.logback.core.ConsoleAppender\">\n+    <!-- encoders are assigned the type\n+         ch.qos.logback.classic.encoder.PatternLayoutEncoder by default -->\n+    <encoder>\n+      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>\n+    </encoder>\n+  </appender>\n+\n+  <root level=\"INFO\">\n+    <appender-ref ref=\"STDOUT\" />\n+  </root>\n+\n+  <logger name=\"org.eclipse.hono\" level=\"DEBUG\"/>\n+  <logger name=\"org.eclipse.hono.client\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.adapter.client\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.connection\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.commandrouter\" level=\"TRACE\"/>\n+  <logger name=\"org.eclipse.hono.service\" level=\"TRACE\"/>\n+\n+<!--  <springProfile name=\"trace\">-->\n+<!--    <logger name=\"org.eclipse.hono.commandrouter\" level=\"TRACE\"/>-->\n+<!--    <logger name=\"org.eclipse.hono\" level=\"DEBUG\"/>-->\n+<!--  </springProfile>-->\n+\n+<!--  <springProfile name=\"dev\">-->\n+<!--    <logger name=\"org.eclipse.hono\" level=\"DEBUG\"/>-->\n+<!--  </springProfile>-->\n+\n+<!--  <springProfile name=\"prod\">-->\n+<!--    <logger name=\"org.eclipse.hono\" level=\"INFO\"/>-->\n+<!--  </springProfile>-->\n+", "originalCommit": "aa5f662fe2cff6d75b6c09dddd11961c73e3f308", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMDI3OQ==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528530279", "bodyText": "This is only for debugging the integration test errors (I didn't get them locally). It's in the 2nd commit which won't be merged.", "author": "calohmn", "createdAt": "2020-11-23T08:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyODQwMQ==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528628401", "bodyText": "I now also get the test errors locally (sometimes occurring in CoAP tests). I think it's an issue with the CommandRouter component. I'm looking into it and will see to fix it outside of this PR.", "author": "calohmn", "createdAt": "2020-11-23T11:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg3MTUzMQ==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r528871531", "bodyText": "I've removed the above log changes. PR with the fix for the intermittent test failures is in #2323.", "author": "calohmn", "createdAt": "2020-11-23T17:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3ODIwNg==", "url": "https://github.com/eclipse/hono/pull/2312#discussion_r530878206", "bodyText": "I've rebased now to include the fix here.", "author": "calohmn", "createdAt": "2020-11-26T09:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjYzNA=="}], "type": "inlineReview"}, {"oid": "512724213d019c6fb191b3b3701d0f553b2b5c85", "url": "https://github.com/eclipse/hono/commit/512724213d019c6fb191b3b3701d0f553b2b5c85", "message": "For debugging test failures: set loglevel to TRACE.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-23T09:25:47Z", "type": "forcePushed"}, {"oid": "79a64135ed4c49a94424c2e2c8621263917e3332", "url": "https://github.com/eclipse/hono/commit/79a64135ed4c49a94424c2e2c8621263917e3332", "message": "Debug test failures: set loglevel to TRACE, add logs.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-23T09:53:23Z", "type": "forcePushed"}, {"oid": "4f31d38e46669bcb2253fd133c67811fd8411341", "url": "https://github.com/eclipse/hono/commit/4f31d38e46669bcb2253fd133c67811fd8411341", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nThis adds a org.eclipse.hono.adapter.client.command.CommandConsumerFactory\nimplementation that uses the new Command Router component.\nFor the integration tests, a new maven profile 'command-router' is added to\nlet the tests run using the Command Router component.\nThe GitHub action workflow has been adapted to use that profile in the\ntest-run that uses the jdbc device registry (so that the other test-runs\nstill use the old command routing mechanism).\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-23T17:15:39Z", "type": "forcePushed"}, {"oid": "4a7863d241a652ded83e5757d78a96e4c4d65894", "url": "https://github.com/eclipse/hono/commit/4a7863d241a652ded83e5757d78a96e4c4d65894", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nThis adds a org.eclipse.hono.adapter.client.command.CommandConsumerFactory\nimplementation that uses the new Command Router component.\nFor the integration tests, a new maven profile 'command-router' is added to\nlet the tests run using the Command Router component.\nThe GitHub action workflow has been adapted to use that profile in the\ntest-run that uses the jdbc device registry (so that the other test-runs\nstill use the old command routing mechanism).\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-26T08:51:28Z", "type": "commit"}, {"oid": "4a7863d241a652ded83e5757d78a96e4c4d65894", "url": "https://github.com/eclipse/hono/commit/4a7863d241a652ded83e5757d78a96e4c4d65894", "message": "[#2029] Use Command Router in adapters and integration tests.\n\nThis adds a org.eclipse.hono.adapter.client.command.CommandConsumerFactory\nimplementation that uses the new Command Router component.\nFor the integration tests, a new maven profile 'command-router' is added to\nlet the tests run using the Command Router component.\nThe GitHub action workflow has been adapted to use that profile in the\ntest-run that uses the jdbc device registry (so that the other test-runs\nstill use the old command routing mechanism).\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-26T08:51:28Z", "type": "forcePushed"}]}