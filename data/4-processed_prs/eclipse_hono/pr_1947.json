{"pr_number": 1947, "pr_title": "[#1679] Part 1: Add mongo db based implementation of credentials service and management APIs", "pr_createdAt": "2020-05-07T12:01:14Z", "pr_url": "https://github.com/eclipse/hono/pull/1947", "timeline": [{"oid": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "url": "https://github.com/eclipse/hono/commit/d6850e855e2f0fc3e7ee11c6cd30443917301564", "message": "[#1679] Add mongo db based credentials service and management APIs implementation.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>\nAlso-by: Jan Kostulski <jan.kostulski@bosch.io>", "committedDate": "2020-05-07T16:10:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNDUxNw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422904517", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-05-11T09:23:28Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/config/MongoDbBasedCredentialsConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.config;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * Configuration properties for Hono's credentials service and management APIs.\n+ */\n+public class MongoDbBasedCredentialsConfigProperties extends AbstractMongoDbBasedRegistryConfigProperties {\n+\n+    /**\n+     * The name of the mongodb collection where devices information are stored.\n+     */\n+    private static final String DEFAULT_CREDENTIALS_COLLECTION_NAME = \"credentials\";\n+\n+    private final Set<String> hashAlgorithmsWhitelist = new HashSet<>();\n+\n+    private int maxBcryptIterations = 10;\n+\n+    @Override\n+    protected String getDefaultCollectionName() {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk5MjE0OQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422992149", "bodyText": "Actually I wanted to mark the class as final and I will update it.", "author": "kaniyan", "createdAt": "2020-05-11T12:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNDUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIyOTc1Mw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r427229753", "bodyText": "@sophokles73 The requested changes are there now. Would you mind taking a look again?", "author": "kaniyan", "createdAt": "2020-05-19T11:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNDUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNDgxMw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422904813", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-05-11T09:23:56Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/config/MongoDbBasedCredentialsConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.config;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * Configuration properties for Hono's credentials service and management APIs.\n+ */\n+public class MongoDbBasedCredentialsConfigProperties extends AbstractMongoDbBasedRegistryConfigProperties {\n+\n+    /**\n+     * The name of the mongodb collection where devices information are stored.\n+     */\n+    private static final String DEFAULT_CREDENTIALS_COLLECTION_NAME = \"credentials\";\n+\n+    private final Set<String> hashAlgorithmsWhitelist = new HashSet<>();\n+\n+    private int maxBcryptIterations = 10;\n+\n+    @Override\n+    protected String getDefaultCollectionName() {\n+        return DEFAULT_CREDENTIALS_COLLECTION_NAME;\n+    }\n+\n+    /**\n+     * Gets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @return The maximum number.\n+     */\n+    public int getMaxBcryptIterations() {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNTI3Nw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422905277", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-05-11T09:24:43Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/config/MongoDbBasedCredentialsConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.config;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * Configuration properties for Hono's credentials service and management APIs.\n+ */\n+public class MongoDbBasedCredentialsConfigProperties extends AbstractMongoDbBasedRegistryConfigProperties {\n+\n+    /**\n+     * The name of the mongodb collection where devices information are stored.\n+     */\n+    private static final String DEFAULT_CREDENTIALS_COLLECTION_NAME = \"credentials\";\n+\n+    private final Set<String> hashAlgorithmsWhitelist = new HashSet<>();\n+\n+    private int maxBcryptIterations = 10;\n+\n+    @Override\n+    protected String getDefaultCollectionName() {\n+        return DEFAULT_CREDENTIALS_COLLECTION_NAME;\n+    }\n+\n+    /**\n+     * Gets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @return The maximum number.\n+     */\n+    public int getMaxBcryptIterations() {\n+        return maxBcryptIterations;\n+    }\n+\n+    /**\n+     * Sets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @param iterations The maximum number.\n+     * @throws IllegalArgumentException if iterations is &lt; 4 or &gt; 31.\n+     */\n+    public void setMaxBcryptIterations(final int iterations) {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNTM1OQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422905359", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-05-11T09:24:50Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/config/MongoDbBasedCredentialsConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.config;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * Configuration properties for Hono's credentials service and management APIs.\n+ */\n+public class MongoDbBasedCredentialsConfigProperties extends AbstractMongoDbBasedRegistryConfigProperties {\n+\n+    /**\n+     * The name of the mongodb collection where devices information are stored.\n+     */\n+    private static final String DEFAULT_CREDENTIALS_COLLECTION_NAME = \"credentials\";\n+\n+    private final Set<String> hashAlgorithmsWhitelist = new HashSet<>();\n+\n+    private int maxBcryptIterations = 10;\n+\n+    @Override\n+    protected String getDefaultCollectionName() {\n+        return DEFAULT_CREDENTIALS_COLLECTION_NAME;\n+    }\n+\n+    /**\n+     * Gets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @return The maximum number.\n+     */\n+    public int getMaxBcryptIterations() {\n+        return maxBcryptIterations;\n+    }\n+\n+    /**\n+     * Sets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @param iterations The maximum number.\n+     * @throws IllegalArgumentException if iterations is &lt; 4 or &gt; 31.\n+     */\n+    public void setMaxBcryptIterations(final int iterations) {\n+        if (iterations < 4 || iterations > 31) {\n+            throw new IllegalArgumentException(\"iterations must be > 3 and < 32\");\n+        } else {\n+            maxBcryptIterations = iterations;\n+        }\n+    }\n+\n+\n+    /**\n+     * Gets the list of supported hashing algorithms for pre-hashed passwords.\n+     * <p>\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not contained in this list.\n+     * If the list is empty, the device registry will accept any hashing algorithm.\n+     * <p>\n+     * Default value is an empty list.\n+     *\n+     * @return The supported algorithms.\n+     */\n+    public Set<String> getHashAlgorithmsWhitelist() {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNTY2NA==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422905664", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-05-11T09:25:18Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/config/MongoDbBasedCredentialsConfigProperties.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.config;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * Configuration properties for Hono's credentials service and management APIs.\n+ */\n+public class MongoDbBasedCredentialsConfigProperties extends AbstractMongoDbBasedRegistryConfigProperties {\n+\n+    /**\n+     * The name of the mongodb collection where devices information are stored.\n+     */\n+    private static final String DEFAULT_CREDENTIALS_COLLECTION_NAME = \"credentials\";\n+\n+    private final Set<String> hashAlgorithmsWhitelist = new HashSet<>();\n+\n+    private int maxBcryptIterations = 10;\n+\n+    @Override\n+    protected String getDefaultCollectionName() {\n+        return DEFAULT_CREDENTIALS_COLLECTION_NAME;\n+    }\n+\n+    /**\n+     * Gets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @return The maximum number.\n+     */\n+    public int getMaxBcryptIterations() {\n+        return maxBcryptIterations;\n+    }\n+\n+    /**\n+     * Sets the maximum number of iterations to use for bcrypt\n+     * password hashes.\n+     * <p>\n+     * The default value of this property is 10.\n+     *\n+     * @param iterations The maximum number.\n+     * @throws IllegalArgumentException if iterations is &lt; 4 or &gt; 31.\n+     */\n+    public void setMaxBcryptIterations(final int iterations) {\n+        if (iterations < 4 || iterations > 31) {\n+            throw new IllegalArgumentException(\"iterations must be > 3 and < 32\");\n+        } else {\n+            maxBcryptIterations = iterations;\n+        }\n+    }\n+\n+\n+    /**\n+     * Gets the list of supported hashing algorithms for pre-hashed passwords.\n+     * <p>\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not contained in this list.\n+     * If the list is empty, the device registry will accept any hashing algorithm.\n+     * <p>\n+     * Default value is an empty list.\n+     *\n+     * @return The supported algorithms.\n+     */\n+    public Set<String> getHashAlgorithmsWhitelist() {\n+        return Collections.unmodifiableSet(hashAlgorithmsWhitelist);\n+    }\n+\n+    /**\n+     * Sets the list of supported hashing algorithms for pre-hashed passwords.\n+     * <p>\n+     * The device registry will not accept credentials using a hashing\n+     * algorithm that is not contained in this list.\n+     * If the list is empty, the device registry will accept any hashing algorithm.\n+     * <p>\n+     * Default value is an empty list.\n+     *\n+     * @param hashAlgorithmsWhitelist The algorithms to support.\n+     * @throws NullPointerException if the list is {@code null}.\n+     */\n+    public void setHashAlgorithmsWhitelist(final String[] hashAlgorithmsWhitelist) {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwODkwNw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422908907", "bodyText": "FIELD_CREDENTIALS_ ...", "author": "sophokles73", "createdAt": "2020-05-11T09:30:29Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -25,6 +26,10 @@\n  */\n public final class MongoDbDocumentBuilder {\n \n+    private static final String FILED_CREDENTIALS_AUTH_ID_KEY = String.format(\"%s.%s\",", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk5MDkyOA==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422990928", "bodyText": "Typo error. I will correct it.", "author": "kaniyan", "createdAt": "2020-05-11T12:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwODkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwOTA0MA==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422909040", "bodyText": "FIELD_CREDENTIALS_ ...", "author": "sophokles73", "createdAt": "2020-05-11T09:30:40Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -25,6 +26,10 @@\n  */\n public final class MongoDbDocumentBuilder {\n \n+    private static final String FILED_CREDENTIALS_AUTH_ID_KEY = String.format(\"%s.%s\",\n+            MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, RegistryManagementConstants.FIELD_AUTH_ID);\n+    private static final String FILED_CREDENTIALS_TYPE_KEY = String.format(\"%s.%s\",", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkxMDI5OA==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422910298", "bodyText": "please remove . from the end", "author": "sophokles73", "createdAt": "2020-05-11T09:32:51Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedCredentialsService.java", "diffHunk": "@@ -36,70 +62,452 @@\n  * @see <a href=\"https://www.eclipse.org/hono/docs/api/credentials/\">Credentials API</a>\n  * @see <a href=\"https://www.eclipse.org/hono/docs/api/management/\">Device Registry Management API</a>\n  */\n-public class MongoDbBasedCredentialsService implements CredentialsManagementService, CredentialsService, Lifecycle {\n+public final class MongoDbBasedCredentialsService extends AbstractCredentialsManagementService\n+        implements CredentialsService, Lifecycle {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(MongoDbBasedCredentialsService.class);\n+\n+    private static final String CREDENTIALS_FILTERED_POSITIONAL_OPERATOR = String.format(\"%s.$\",\n+            MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS);\n+    private static final int INDEX_CREATION_MAX_RETRIES = 3;\n+\n+    private final MongoDbBasedCredentialsConfigProperties config;\n+    private final MongoClient mongoClient;\n+    private final MongoDbCallExecutor mongoDbCallExecutor;\n+\n+    /**\n+     * Creates a new service for configuration properties.\n+     *\n+     * @param vertx The vert.x instance to run on.\n+     * @param mongoClient The client for accessing the Mongo DB instance.\n+     * @param config The properties for configuring this service.\n+     * @param passwordEncoder The password encoder.\n+     * @throws NullPointerException if any of the parameters are {@code null}.\n+     */\n+    public MongoDbBasedCredentialsService(\n+            final Vertx vertx,\n+            final MongoClient mongoClient,\n+            final MongoDbBasedCredentialsConfigProperties config,\n+            final HonoPasswordEncoder passwordEncoder) {\n+\n+        super(Objects.requireNonNull(vertx), Objects.requireNonNull(passwordEncoder));\n+\n+        Objects.requireNonNull(mongoClient);\n+        Objects.requireNonNull(config);\n+\n+        this.mongoClient = mongoClient;\n+        this.config = config;\n+        this.mongoDbCallExecutor = new MongoDbCallExecutor(vertx, mongoClient);\n+    }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public Future<Void> start() {\n-        return Future.succeededFuture();\n+        return createIndices()\n+                .map(ok -> {\n+                    LOG.debug(\"MongoDB credentials service started.\");", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMTkwMQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r423011901", "bodyText": "done", "author": "kaniyan", "createdAt": "2020-05-11T12:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkxMDI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NTEwNw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422975107", "bodyText": "this is not the version of the tenant, is it?", "author": "sophokles73", "createdAt": "2020-05-11T11:32:07Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NTM5Mg==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422975392", "bodyText": "there is no secrets parameter ...", "author": "sophokles73", "createdAt": "2020-05-11T11:32:43Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.\n+     * @throws NullPointerException if any of the parameters except the secrets are {@code null}", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDkzNg==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422980936", "bodyText": "what's the difference between invoking this method and CommonCredential.getSecrets()?", "author": "sophokles73", "createdAt": "2020-05-11T11:43:55Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.\n+     * @throws NullPointerException if any of the parameters except the secrets are {@code null}\n+     * @throws IllegalArgumentException if validation of the given credentials fail.\n+     */\n+    public CredentialsDto(\n+            final String tenantId,\n+            final String deviceId,\n+            final List<CommonCredential> credentials,\n+            final String version) {\n+\n+        setTenantId(tenantId);\n+        setDeviceId(deviceId);\n+\n+        //Validate the given credentials, secrets and generate secret ids if not available.\n+        Optional.ofNullable(credentials)\n+                .ifPresent(ok -> {\n+                    validateForUniqueAuthIdAndType(credentials);\n+                    validateSecretsAndGenerateIds(credentials);\n+                });\n+        setCredentials(credentials);\n+\n+        setVersion(version);\n+        setUpdatedOn(Instant.now());\n+    }\n+\n+    /**\n+     * Gets the identifier of the tenant.\n+     *\n+     * @return The identifier of the tenant.\n+     */\n+    public String getTenantId() {\n+        return tenantId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the tenant.\n+     *\n+     * @param tenantId The tenant's identifier.\n+     * @throws NullPointerException if the tenantId is {@code null}.\n+     */\n+    public void setTenantId(final String tenantId) {\n+        this.tenantId = Objects.requireNonNull(tenantId);\n+    }\n+\n+    /**\n+     * Gets the identifier of the device.\n+     *\n+     * @return The identifier of the device.\n+     */\n+    public String getDeviceId() {\n+        return deviceId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the device.\n+     *\n+     * @param deviceId The identifier of the device.\n+     * @throws NullPointerException if the deviceId is {@code null}.\n+     */\n+    public void setDeviceId(final String deviceId) {\n+        this.deviceId = Objects.requireNonNull(deviceId);\n+    }\n+\n+    /**\n+     * Gets the list of credentials.\n+     *\n+     * @return The list of credentials.\n+     */\n+    public List<CommonCredential> getCredentials() {\n+        return credentials;\n+    }\n+\n+    /**\n+     * Sets the list of credentials.\n+     *\n+     * @param credentials A list of credentials.\n+     */\n+    public void setCredentials(final List<CommonCredential> credentials) {\n+        this.credentials = credentials;\n+    }\n+\n+    /**\n+     * Checks whether the credentials to be updated already have secret ids.\n+     *\n+     * @return hasSecretIds {@code true} if any credential already has a secret identifier,\n+     *                      otherwise {@code false}\n+     */\n+    @JsonIgnore\n+    public boolean hasSecretIds() {\n+        return hasSecretIds;\n+    }\n+\n+    /**\n+     * Sets whether the credentials to be updated already have secret ids.\n+     *\n+     * @param hasSecretIds {@code true} if any credential already has a secret identifier,\n+     *                         otherwise {@code false}\n+     */\n+    @JsonIgnore\n+    public void setHasSecretIds(final boolean hasSecretIds) {\n+        this.hasSecretIds = hasSecretIds;\n+    }\n+\n+    @JsonIgnore\n+    private List<? extends CommonSecret> getSecrets(final CommonCredential credential) {\n+        if (credential instanceof PasswordCredential) {\n+            return ((PasswordCredential) credential).getSecrets();\n+        } else if (credential instanceof X509CertificateCredential) {\n+            return ((X509CertificateCredential) credential).getSecrets();\n+        } else if (credential instanceof PskCredential) {\n+            return ((PskCredential) credential).getSecrets();\n+        } else {\n+            return ((GenericCredential) credential).getSecrets();\n+        }\n+    }", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk5NTQxOQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422995419", "bodyText": "protected abstract List<? extends CommonSecret> getSecrets()\nIt has protected access and I couldn't invoke here.", "author": "kaniyan", "createdAt": "2020-05-11T12:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTk3OQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422981979", "bodyText": "when will this constructor is supposed to be involved? I am asking because there seems to be an expectation for the checks to be invoked as part of certain scenarios ...", "author": "sophokles73", "createdAt": "2020-05-11T11:46:13Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.\n+     * @throws NullPointerException if any of the parameters except the secrets are {@code null}\n+     * @throws IllegalArgumentException if validation of the given credentials fail.\n+     */\n+    public CredentialsDto(\n+            final String tenantId,\n+            final String deviceId,\n+            final List<CommonCredential> credentials,\n+            final String version) {\n+\n+        setTenantId(tenantId);\n+        setDeviceId(deviceId);\n+\n+        //Validate the given credentials, secrets and generate secret ids if not available.\n+        Optional.ofNullable(credentials)\n+                .ifPresent(ok -> {\n+                    validateForUniqueAuthIdAndType(credentials);\n+                    validateSecretsAndGenerateIds(credentials);\n+                });", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk5NjgxOQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422996819", "bodyText": "This constructor is supposed to be involved when adding or updating credentials.", "author": "kaniyan", "createdAt": "2020-05-11T12:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MjYzNg==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422982636", "bodyText": "I'd rather check the (few) secrets explicitly ...", "author": "sophokles73", "createdAt": "2020-05-11T11:47:39Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.\n+     * @throws NullPointerException if any of the parameters except the secrets are {@code null}\n+     * @throws IllegalArgumentException if validation of the given credentials fail.\n+     */\n+    public CredentialsDto(\n+            final String tenantId,\n+            final String deviceId,\n+            final List<CommonCredential> credentials,\n+            final String version) {\n+\n+        setTenantId(tenantId);\n+        setDeviceId(deviceId);\n+\n+        //Validate the given credentials, secrets and generate secret ids if not available.\n+        Optional.ofNullable(credentials)\n+                .ifPresent(ok -> {\n+                    validateForUniqueAuthIdAndType(credentials);\n+                    validateSecretsAndGenerateIds(credentials);\n+                });\n+        setCredentials(credentials);\n+\n+        setVersion(version);\n+        setUpdatedOn(Instant.now());\n+    }\n+\n+    /**\n+     * Gets the identifier of the tenant.\n+     *\n+     * @return The identifier of the tenant.\n+     */\n+    public String getTenantId() {\n+        return tenantId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the tenant.\n+     *\n+     * @param tenantId The tenant's identifier.\n+     * @throws NullPointerException if the tenantId is {@code null}.\n+     */\n+    public void setTenantId(final String tenantId) {\n+        this.tenantId = Objects.requireNonNull(tenantId);\n+    }\n+\n+    /**\n+     * Gets the identifier of the device.\n+     *\n+     * @return The identifier of the device.\n+     */\n+    public String getDeviceId() {\n+        return deviceId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the device.\n+     *\n+     * @param deviceId The identifier of the device.\n+     * @throws NullPointerException if the deviceId is {@code null}.\n+     */\n+    public void setDeviceId(final String deviceId) {\n+        this.deviceId = Objects.requireNonNull(deviceId);\n+    }\n+\n+    /**\n+     * Gets the list of credentials.\n+     *\n+     * @return The list of credentials.\n+     */\n+    public List<CommonCredential> getCredentials() {\n+        return credentials;\n+    }\n+\n+    /**\n+     * Sets the list of credentials.\n+     *\n+     * @param credentials A list of credentials.\n+     */\n+    public void setCredentials(final List<CommonCredential> credentials) {\n+        this.credentials = credentials;\n+    }\n+\n+    /**\n+     * Checks whether the credentials to be updated already have secret ids.\n+     *\n+     * @return hasSecretIds {@code true} if any credential already has a secret identifier,\n+     *                      otherwise {@code false}\n+     */\n+    @JsonIgnore\n+    public boolean hasSecretIds() {\n+        return hasSecretIds;\n+    }", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk5OTQ2MQ==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422999461", "bodyText": "I didn't get it what do you mean, could you please explain more detailed? I set this flag, if the secrets to be updated contain any secret ids. I use this flag during the update operation, if no secret ids exist then no need to merge and I simply replace the existing document.", "author": "kaniyan", "createdAt": "2020-05-11T12:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MjYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MjgzMA==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r422982830", "bodyText": "this belongs to the CommonSecret class, doesn't it?", "author": "sophokles73", "createdAt": "2020-05-11T11:48:03Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/CredentialsDto.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.hono.deviceregistry.mongodb.model;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.eclipse.hono.client.ClientErrorException;\n+import org.eclipse.hono.deviceregistry.mongodb.utils.MongoDbDeviceRegistryUtils;\n+import org.eclipse.hono.deviceregistry.util.DeviceRegistryUtils;\n+import org.eclipse.hono.service.management.credentials.CommonCredential;\n+import org.eclipse.hono.service.management.credentials.CommonSecret;\n+import org.eclipse.hono.service.management.credentials.GenericCredential;\n+import org.eclipse.hono.service.management.credentials.PasswordCredential;\n+import org.eclipse.hono.service.management.credentials.PskCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.util.RegistryManagementConstants;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * A DTO (Data Transfer Object) class to store credentials information in mongodb.\n+ */\n+public class CredentialsDto extends BaseDto {\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_TENANT_ID, required = true)\n+    private String tenantId;\n+\n+    @JsonProperty(value = RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, required = true)\n+    private String deviceId;\n+\n+    @JsonProperty(value = MongoDbDeviceRegistryUtils.FIELD_CREDENTIALS, required = true)\n+    private List<CommonCredential> credentials;\n+    private boolean hasSecretIds;\n+\n+    /**\n+     * Default constructor for serialisation/deserialization.\n+     */\n+    public CredentialsDto() {\n+        // Explicit default constructor.\n+    }\n+\n+    /**\n+     * Creates a new data transfer object to store credentials information in mongodb.\n+     *\n+     * @param tenantId The tenant identifier.\n+     * @param deviceId The device identifier.\n+     * @param credentials The list of credentials.\n+     * @param version The version of tenant to be sent as request header.\n+     * @throws NullPointerException if any of the parameters except the secrets are {@code null}\n+     * @throws IllegalArgumentException if validation of the given credentials fail.\n+     */\n+    public CredentialsDto(\n+            final String tenantId,\n+            final String deviceId,\n+            final List<CommonCredential> credentials,\n+            final String version) {\n+\n+        setTenantId(tenantId);\n+        setDeviceId(deviceId);\n+\n+        //Validate the given credentials, secrets and generate secret ids if not available.\n+        Optional.ofNullable(credentials)\n+                .ifPresent(ok -> {\n+                    validateForUniqueAuthIdAndType(credentials);\n+                    validateSecretsAndGenerateIds(credentials);\n+                });\n+        setCredentials(credentials);\n+\n+        setVersion(version);\n+        setUpdatedOn(Instant.now());\n+    }\n+\n+    /**\n+     * Gets the identifier of the tenant.\n+     *\n+     * @return The identifier of the tenant.\n+     */\n+    public String getTenantId() {\n+        return tenantId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the tenant.\n+     *\n+     * @param tenantId The tenant's identifier.\n+     * @throws NullPointerException if the tenantId is {@code null}.\n+     */\n+    public void setTenantId(final String tenantId) {\n+        this.tenantId = Objects.requireNonNull(tenantId);\n+    }\n+\n+    /**\n+     * Gets the identifier of the device.\n+     *\n+     * @return The identifier of the device.\n+     */\n+    public String getDeviceId() {\n+        return deviceId;\n+    }\n+\n+    /**\n+     * Sets the identifier of the device.\n+     *\n+     * @param deviceId The identifier of the device.\n+     * @throws NullPointerException if the deviceId is {@code null}.\n+     */\n+    public void setDeviceId(final String deviceId) {\n+        this.deviceId = Objects.requireNonNull(deviceId);\n+    }\n+\n+    /**\n+     * Gets the list of credentials.\n+     *\n+     * @return The list of credentials.\n+     */\n+    public List<CommonCredential> getCredentials() {\n+        return credentials;\n+    }\n+\n+    /**\n+     * Sets the list of credentials.\n+     *\n+     * @param credentials A list of credentials.\n+     */\n+    public void setCredentials(final List<CommonCredential> credentials) {\n+        this.credentials = credentials;\n+    }\n+\n+    /**\n+     * Checks whether the credentials to be updated already have secret ids.\n+     *\n+     * @return hasSecretIds {@code true} if any credential already has a secret identifier,\n+     *                      otherwise {@code false}\n+     */\n+    @JsonIgnore\n+    public boolean hasSecretIds() {\n+        return hasSecretIds;\n+    }\n+\n+    /**\n+     * Sets whether the credentials to be updated already have secret ids.\n+     *\n+     * @param hasSecretIds {@code true} if any credential already has a secret identifier,\n+     *                         otherwise {@code false}\n+     */\n+    @JsonIgnore\n+    public void setHasSecretIds(final boolean hasSecretIds) {\n+        this.hasSecretIds = hasSecretIds;\n+    }\n+\n+    @JsonIgnore\n+    private List<? extends CommonSecret> getSecrets(final CommonCredential credential) {\n+        if (credential instanceof PasswordCredential) {\n+            return ((PasswordCredential) credential).getSecrets();\n+        } else if (credential instanceof X509CertificateCredential) {\n+            return ((X509CertificateCredential) credential).getSecrets();\n+        } else if (credential instanceof PskCredential) {\n+            return ((PskCredential) credential).getSecrets();\n+        } else {\n+            return ((GenericCredential) credential).getSecrets();\n+        }\n+    }\n+\n+    @JsonIgnore\n+    private <T extends CommonSecret> T generateSecretId(final T secret) {", "originalCommit": "d6850e855e2f0fc3e7ee11c6cd30443917301564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMDY4Mw==", "url": "https://github.com/eclipse/hono/pull/1947#discussion_r423010683", "bodyText": "CommonSecret class already has a provision to set the id using  setId(final String id). The method generateSecretId(...) uses generated uuids as secret ids. IMHO the device registry implementers should be able to choose the nature of the secret ids. Based on this view for me it makes sense to have this method in this class and not in the CommonSecret.", "author": "kaniyan", "createdAt": "2020-05-11T12:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MjgzMA=="}], "type": "inlineReview"}, {"oid": "1a0e93fd116474300065072dd912b5661ee1a739", "url": "https://github.com/eclipse/hono/commit/1a0e93fd116474300065072dd912b5661ee1a739", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-11T12:11:20Z", "type": "forcePushed"}, {"oid": "8950acaa2aa828a3bef6c07de022447d33140ad3", "url": "https://github.com/eclipse/hono/commit/8950acaa2aa828a3bef6c07de022447d33140ad3", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-19T07:55:50Z", "type": "forcePushed"}, {"oid": "6d79c872bf6342b89a985292d3e8a6dba41cd101", "url": "https://github.com/eclipse/hono/commit/6d79c872bf6342b89a985292d3e8a6dba41cd101", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-19T09:34:42Z", "type": "forcePushed"}, {"oid": "8131ba665bb189b60c80141d99640fddd4f79ba8", "url": "https://github.com/eclipse/hono/commit/8131ba665bb189b60c80141d99640fddd4f79ba8", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-19T10:18:19Z", "type": "forcePushed"}, {"oid": "632ce0cc4f62a998644337edd3c37ddda12297b7", "url": "https://github.com/eclipse/hono/commit/632ce0cc4f62a998644337edd3c37ddda12297b7", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-20T08:15:35Z", "type": "forcePushed"}, {"oid": "1f4801edf0b79538e5661b8c340116b277967a1d", "url": "https://github.com/eclipse/hono/commit/1f4801edf0b79538e5661b8c340116b277967a1d", "message": "[#1679] Add mongo db based credentials service and management APIs implementation.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>\nAlso-by: Jan Kostulski <jan.kostulski@bosch.io>", "committedDate": "2020-05-20T12:22:12Z", "type": "commit"}, {"oid": "66a90bbe750be4499f92a7300f54950a5995a4a8", "url": "https://github.com/eclipse/hono/commit/66a90bbe750be4499f92a7300f54950a5995a4a8", "message": "Minor fixes and improvements\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-20T12:22:12Z", "type": "commit"}, {"oid": "9ee19676af0f36abc5fed80e9043122c3c2e9a73", "url": "https://github.com/eclipse/hono/commit/9ee19676af0f36abc5fed80e9043122c3c2e9a73", "message": "[#1679] Add validation and encoding of credentials.\n\n- Also checks if the given algorithm is part of the configured white list of algorithms.\n- Also verifies for a valid BCrypt password hash.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-20T12:26:21Z", "type": "commit"}, {"oid": "9ee19676af0f36abc5fed80e9043122c3c2e9a73", "url": "https://github.com/eclipse/hono/commit/9ee19676af0f36abc5fed80e9043122c3c2e9a73", "message": "[#1679] Add validation and encoding of credentials.\n\n- Also checks if the given algorithm is part of the configured white list of algorithms.\n- Also verifies for a valid BCrypt password hash.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-05-20T12:26:21Z", "type": "forcePushed"}]}