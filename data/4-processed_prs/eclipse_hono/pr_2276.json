{"pr_number": 2276, "pr_title": "[#2267] Add AMQP 1.0 based Telemetry/EventSender implementation", "pr_createdAt": "2020-10-30T16:19:25Z", "pr_url": "https://github.com/eclipse/hono/pull/2276", "timeline": [{"oid": "82dbb47d958faa19c4710183c3ae733f6ee29393", "url": "https://github.com/eclipse/hono/commit/82dbb47d958faa19c4710183c3ae733f6ee29393", "message": "[#2267] Add AMQP 1.0 based Telemetry/EventSender implementation\n\nAdded implementations of the adapter client's TelemetrySender and\nEventSender interfaces which wrap the existing vertx-proton based\n\"legacy\" DownstreamSender.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-10-30T16:18:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzA0MA==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515237040", "bodyText": "The sender,", "author": "calohmn", "createdAt": "2020-10-30T16:51:22Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractAdapterConfig.java", "diffHunk": "@@ -175,33 +180,58 @@ protected ClientConfigProperties getDownstreamSenderFactoryConfigDefaults() {\n     }\n \n     /**\n-     * Exposes a factory for creating clients for the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * Exposes the connection to the <em>AMQP Messaging Network</em> as a Spring bean.\n      * <p>\n-     * The factory is initialized with the connection provided by {@link #downstreamConnection()}.\n+     * The connection is configured with the properties provided by {@link #downstreamSenderFactoryConfig()}\n+     * and is already trying to establish the connection to the configured peer.\n      *\n-     * @param samplerFactory The sampler factory to use. Can re-use adapter metrics, based on {@link org.eclipse.hono.service.metric.MicrometerBasedMetrics}\n-     * out of the box.\n-     * @return The factory.\n+     * @return The connection.\n      */\n     @Qualifier(Constants.QUALIFIER_MESSAGING)\n     @Bean\n     @Scope(\"prototype\")\n-    public DownstreamSenderFactory downstreamSenderFactory(final SendMessageSampler.Factory samplerFactory) {\n-        return DownstreamSenderFactory.create(downstreamConnection(), samplerFactory);\n+    public HonoConnection downstreamConnection() {\n+        return HonoConnection.newConnection(vertx(), downstreamSenderFactoryConfig());\n     }\n \n     /**\n-     * Exposes the connection to the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * Exposes a client for sending telemetry messages via the <em>AMQP Messaging Network</em> as a Spring bean.\n      * <p>\n-     * The connection is configured with the properties provided by {@link #downstreamSenderFactoryConfig()}.\n+     * The client is initialized with the connection provided by {@link #downstreamConnection()}.\n      *\n-     * @return The connection.\n+     * @param samplerFactory The sampler factory to use. Can re-use adapter metrics, based on\n+     *                       {@link org.eclipse.hono.service.metric.MicrometerBasedMetrics}\n+     *                       out of the box.\n+     * @param adapterConfig The protocol adapter's configuration properties.\n+     * @return The factory.", "originalCommit": "82dbb47d958faa19c4710183c3ae733f6ee29393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzE1OQ==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515237159", "bodyText": "The sender.", "author": "calohmn", "createdAt": "2020-10-30T16:51:33Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractAdapterConfig.java", "diffHunk": "@@ -175,33 +180,58 @@ protected ClientConfigProperties getDownstreamSenderFactoryConfigDefaults() {\n     }\n \n     /**\n-     * Exposes a factory for creating clients for the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * Exposes the connection to the <em>AMQP Messaging Network</em> as a Spring bean.\n      * <p>\n-     * The factory is initialized with the connection provided by {@link #downstreamConnection()}.\n+     * The connection is configured with the properties provided by {@link #downstreamSenderFactoryConfig()}\n+     * and is already trying to establish the connection to the configured peer.\n      *\n-     * @param samplerFactory The sampler factory to use. Can re-use adapter metrics, based on {@link org.eclipse.hono.service.metric.MicrometerBasedMetrics}\n-     * out of the box.\n-     * @return The factory.\n+     * @return The connection.\n      */\n     @Qualifier(Constants.QUALIFIER_MESSAGING)\n     @Bean\n     @Scope(\"prototype\")\n-    public DownstreamSenderFactory downstreamSenderFactory(final SendMessageSampler.Factory samplerFactory) {\n-        return DownstreamSenderFactory.create(downstreamConnection(), samplerFactory);\n+    public HonoConnection downstreamConnection() {\n+        return HonoConnection.newConnection(vertx(), downstreamSenderFactoryConfig());\n     }\n \n     /**\n-     * Exposes the connection to the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * Exposes a client for sending telemetry messages via the <em>AMQP Messaging Network</em> as a Spring bean.\n      * <p>\n-     * The connection is configured with the properties provided by {@link #downstreamSenderFactoryConfig()}.\n+     * The client is initialized with the connection provided by {@link #downstreamConnection()}.\n      *\n-     * @return The connection.\n+     * @param samplerFactory The sampler factory to use. Can re-use adapter metrics, based on\n+     *                       {@link org.eclipse.hono.service.metric.MicrometerBasedMetrics}\n+     *                       out of the box.\n+     * @param adapterConfig The protocol adapter's configuration properties.\n+     * @return The factory.\n      */\n-    @Qualifier(Constants.QUALIFIER_MESSAGING)\n+    @Qualifier(TelemetryConstants.TELEMETRY_ENDPOINT)\n     @Bean\n     @Scope(\"prototype\")\n-    public HonoConnection downstreamConnection() {\n-        return HonoConnection.newConnection(vertx(), downstreamSenderFactoryConfig());\n+    public TelemetrySender downstreamTelemetrySender(\n+            final SendMessageSampler.Factory samplerFactory,\n+            final ProtocolAdapterProperties adapterConfig) {\n+        return new ProtonBasedDownstreamSender(downstreamConnection(), samplerFactory, adapterConfig);\n+    }\n+\n+    /**\n+     * Exposes a client for sending events via the <em>AMQP Messaging Network</em> as a Spring bean.\n+     * <p>\n+     * The client is initialized with the connection provided by {@link #downstreamConnection()}.\n+     *\n+     * @param samplerFactory The sampler factory to use. Can re-use adapter metrics, based on\n+     *                       {@link org.eclipse.hono.service.metric.MicrometerBasedMetrics}\n+     *                       out of the box.\n+     * @param adapterConfig The protocol adapter's configuration properties.\n+     * @return The factory.", "originalCommit": "82dbb47d958faa19c4710183c3ae733f6ee29393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MDMyNQ==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515240325", "bodyText": "I think \"downstream\" instead of \"via the AMQP Messaging Network\" could be used here already.\nSame applies also for the getter and the corresponding EventSender methods.", "author": "calohmn", "createdAt": "2020-10-30T16:56:32Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -246,24 +249,45 @@ public final DeviceConnectionClientFactory getDeviceConnectionClientFactory() {\n     }\n \n     /**\n-     * Sets the factory to use for creating a client for the AMQP Messaging Network.\n+     * Sets the client to use for sending telemetry messages via the AMQP Messaging Network.", "originalCommit": "82dbb47d958faa19c4710183c3ae733f6ee29393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1NzY3NQ==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515257675", "bodyText": "The \"AMQP Messaging Network\" part could maybe be abstracted away here already by using telemetrySender.toString() and adding a corresponding toString() method in ProtonBasedDownstreamSender (and possibly also splitting that class in separate ProtonBasedTelemetrySender and ProtonBasedEventSender classes).", "author": "calohmn", "createdAt": "2020-10-30T17:23:25Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -477,8 +503,9 @@ protected final ConnectionLimitManager getConnectionLimitManager() {\n \n             log.info(\"using ResourceLimitChecks [{}]\", resourceLimitChecks.getClass().getName());\n \n+            startServiceClient(telemetrySender, \"AMQP Messaging Network (Telemetry)\");\n+            startServiceClient(eventSender, \"AMQP Messaging Network (Event)\");", "originalCommit": "82dbb47d958faa19c4710183c3ae733f6ee29393", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc3Njc3OA==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515776778", "bodyText": "I had already been wondering whether it would be useful to have completely separate implementations of TelemetrySender and EventSender. However, it would then be harder to share a single AMQP connection to the Messaging Network. WDYT?", "author": "sophokles73", "createdAt": "2020-11-02T07:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1NzY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5NjA4Mw==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515796083", "bodyText": "Ok, I see, that's a reason not to separate it then.", "author": "calohmn", "createdAt": "2020-11-02T08:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1NzY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI2MjEzMw==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515262133", "bodyText": "Remove \"or originDevice\" also in uploadEventMessage javadoc.", "author": "calohmn", "createdAt": "2020-10-30T17:30:24Z", "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -627,15 +625,11 @@ protected final String getAuthId(final CoapExchange exchange) {\n      * @param context The context representing the request to be processed.\n      * @return A future containing the response code that has been returned to\n      *         the device.\n-     * @throws NullPointerException if context or originDevice are {@code null}.\n+     * @throws NullPointerException if context is {@code null}.", "originalCommit": "82dbb47d958faa19c4710183c3ae733f6ee29393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d69dc664ba83ec90e47a9b8ba7d7f5cf1348034", "url": "https://github.com/eclipse/hono/commit/0d69dc664ba83ec90e47a9b8ba7d7f5cf1348034", "message": "Incorporate feedback.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-11-02T07:35:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5ODgxOA==", "url": "https://github.com/eclipse/hono/pull/2276#discussion_r515798818", "bodyText": "(Leading whitespace in first log)\nHow about changing the serviceName parameter values to \"Event\"/\"Telemetry\" and using\n            log.info(\"{} client '{}' successfully connected\", serviceName, serviceClient);\n            return c;\n        }).recover(t -> {\n            log.warn(\"{} client '{}' failed to connect\", serviceName, serviceClient, t);\n\n? Then the startInternal method already doesn't mention the AMQP messaging network anymore.", "author": "calohmn", "createdAt": "2020-11-02T08:12:25Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -801,6 +844,30 @@ protected void doStop(final Promise<Void> stopPromise) {\n                 .mapEmpty();\n     }\n \n+    /**\n+     * Starts a service client.\n+     * <p>\n+     * This method invokes the given client's {@link Lifecycle#start()} method.\n+     *\n+     * @param serviceClient The client to start.\n+     * @param serviceName The name of the service that the client is for (used for logging).\n+     * @return A future indicating the outcome of starting the client.\n+     * @throws NullPointerException if any of the parameters are {@code null}.\n+     */\n+    protected final Future<Void> startServiceClient(final Lifecycle serviceClient, final String serviceName) {\n+\n+        Objects.requireNonNull(serviceClient);\n+        Objects.requireNonNull(serviceName);\n+\n+        return serviceClient.start().map(c -> {\n+            log.info(\" {} successfully connected to {}\", serviceClient, serviceName);\n+            return c;\n+        }).recover(t -> {\n+            log.warn(\"{} failed to connect to {}\", serviceClient, serviceName, t);", "originalCommit": "0d69dc664ba83ec90e47a9b8ba7d7f5cf1348034", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43dc55b97a489cdf6f899aecb8f32f39ad733ddb", "url": "https://github.com/eclipse/hono/commit/43dc55b97a489cdf6f899aecb8f32f39ad733ddb", "message": "Always succeed stopping of senders in unit tests\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-11-02T10:10:19Z", "type": "commit"}, {"oid": "8584c1472884f98caa3697d07c362e6ba74a5e59", "url": "https://github.com/eclipse/hono/commit/8584c1472884f98caa3697d07c362e6ba74a5e59", "message": "Improve logging\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-11-02T10:16:23Z", "type": "commit"}]}