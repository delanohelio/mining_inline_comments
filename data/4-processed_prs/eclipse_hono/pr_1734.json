{"pr_number": 1734, "pr_title": "[#1716] Update documentation and release notes.", "pr_createdAt": "2020-01-31T10:39:42Z", "pr_url": "https://github.com/eclipse/hono/pull/1734", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0ODAxOA==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373448018", "bodyText": "... that the devices have already been connected ...", "author": "sophokles73", "createdAt": "2020-01-31T12:05:10Z", "path": "site/documentation/content/concepts/resource-limits.md", "diffHunk": "@@ -14,6 +14,42 @@ Before accepting a new connection request from a device, the number of existing\n \n The MQTT and AMQP protocol adapters keep the connections longer opened than their counterparts such as HTTP. Thereby the MQTT and AMQP adapters are enabled to check the connection limits before accepting any new connection to a device.\n \n+## Connection Duration Limit\n+\n+Before accepting a new connection request from a device, the overall amount of time that the devices been already connected to protocol adapters for that tenant is checked against the configured limit by the protocol adapters. The connection request is declined if the connection duration limit has been already reached. This limit is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric.", "originalCommit": "17fe48ca7ba48ccc5824d860bb671dd6c2eb53b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0ODQxOA==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373448418", "bodyText": "... that the devices have already been connected from the beginning till the end of the current (Gregorian) calendar month ...", "author": "sophokles73", "createdAt": "2020-01-31T12:06:22Z", "path": "site/documentation/content/concepts/resource-limits.md", "diffHunk": "@@ -14,6 +14,42 @@ Before accepting a new connection request from a device, the number of existing\n \n The MQTT and AMQP protocol adapters keep the connections longer opened than their counterparts such as HTTP. Thereby the MQTT and AMQP adapters are enabled to check the connection limits before accepting any new connection to a device.\n \n+## Connection Duration Limit\n+\n+Before accepting a new connection request from a device, the overall amount of time that the devices been already connected to protocol adapters for that tenant is checked against the configured limit by the protocol adapters. The connection request is declined if the connection duration limit has been already reached. This limit is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric.\n+\n+The default Prometheus based implementation uses connection duration as the factor to limit the connections. This default implementation supports two modes of connection duration limit calculation namely `days` and `monthly`. For more details on how to set the mode refer to the [Tenant API]({{< relref \"/api/tenant#resource-limits-period-configuration-format\" >}}).\n+\n+In the `monthly` mode, further device connections are only allowed, if the overall amount of time that the devices been already connected from the beginning till the end of a (Gregorian) calendar month does not exceed the configured *max-minutes* value. But for the first month, on which the connection duration limit became effective, the *effective connection duration limit* is calculated based on the *max-minutes* with respect to the remaining days in that month from the *effective-since* date.", "originalCommit": "17fe48ca7ba48ccc5824d860bb671dd6c2eb53b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTE4OQ==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373449189", "bodyText": "... devices have already been connected ...", "author": "sophokles73", "createdAt": "2020-01-31T12:08:29Z", "path": "site/documentation/content/concepts/resource-limits.md", "diffHunk": "@@ -14,6 +14,42 @@ Before accepting a new connection request from a device, the number of existing\n \n The MQTT and AMQP protocol adapters keep the connections longer opened than their counterparts such as HTTP. Thereby the MQTT and AMQP adapters are enabled to check the connection limits before accepting any new connection to a device.\n \n+## Connection Duration Limit\n+\n+Before accepting a new connection request from a device, the overall amount of time that the devices been already connected to protocol adapters for that tenant is checked against the configured limit by the protocol adapters. The connection request is declined if the connection duration limit has been already reached. This limit is only supported by protocol adapters that maintain *connection state* with authenticated devices. In particular, the HTTP adapter does not support this metric.\n+\n+The default Prometheus based implementation uses connection duration as the factor to limit the connections. This default implementation supports two modes of connection duration limit calculation namely `days` and `monthly`. For more details on how to set the mode refer to the [Tenant API]({{< relref \"/api/tenant#resource-limits-period-configuration-format\" >}}).\n+\n+In the `monthly` mode, further device connections are only allowed, if the overall amount of time that the devices been already connected from the beginning till the end of a (Gregorian) calendar month does not exceed the configured *max-minutes* value. But for the first month, on which the connection duration limit became effective, the *effective connection duration limit* is calculated based on the *max-minutes* with respect to the remaining days in that month from the *effective-since* date.\n+\n+Below is a sample resource limit configuration for a tenant, where it has been defined that the connection duration limit became effective on 10.Jul.2019 and the maximum connection duration limit for every month is 50,000 minutes. It means that from August 2019, the connection limit check ensures that no more connections are allowed for that tenant, if that limit of 50,000 minutes is already reached. But in case of July 2019, the month on which the message limit became effective, the *effective connection duration limit* is calculated by finding the average limit for a day from the configured *max-minutes* and then multiplying it with the number of days from the *effective-since* date till the end of that month. In this case it is calculated as *(50,000 minutes / 31 days) x  22 days*, which is 35,483 minutes. It means that for the month of July 2019, no more new connections are allowed, if the limit of 35,843 minutes is already reached.\n+\n+~~~json\n+\"resource-limits\": {\n+  \"connection-duration\": {\n+    \"effective-since\": \"2019-07-10T14:30:00Z\",\n+    \"max-minutes\": 50000,\n+    \"period\": {\n+      \"mode\": \"monthly\"\n+    }\n+  }\n+}\n+\n+~~~\n+In the `days` mode, further device connections are only allowed, if the overall amount of time that the devices been already connected for the configured *no-of-days* does not exceed the *max-minutes* value. In the below sample configuration, the mode is configured as `days` and the accounting duration as 30 days. In this case the connection duration limit check ensures that new connections are accepted, only if the connection duration usage for every 30 days from 10.Jul.2019 (`effective-since`) does not exceed the 50,000 minutes limit.", "originalCommit": "17fe48ca7ba48ccc5824d860bb671dd6c2eb53b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTU0NA==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373449544", "bodyText": "this also needs to be added to the Kura adapter user guide", "author": "sophokles73", "createdAt": "2020-01-31T12:09:28Z", "path": "site/documentation/content/user-guide/mqtt-adapter.md", "diffHunk": "@@ -43,6 +43,10 @@ The examples below refer to devices `4711` and `gw-1` of tenant `DEFAULT_TENANT`\n \n After verifying the credentials, the number of existing connections is checked against the configured [resource-limits] ({{< ref \"/concepts/resource-limits.md\" >}}) by the MQTT adapter.  If the limit is exceeded then a return code `0x05` indicating `Connection Refused: not authorised` is sent back.\n \n+## Connection Duration Limits\n+\n+Before accepting any connection requests from the devices, the MQTT adapter verifies that the configured [connection duration limit] ({{< relref \"/concepts/resource-limits.md#connection-duration-limit\" >}}) is not exceeded. If the limit has been already reached, then a return code `0x05` indicating `Connection Refused: not authorised` is sent back.", "originalCommit": "17fe48ca7ba48ccc5824d860bb671dd6c2eb53b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NzI5NA==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373467294", "bodyText": "Currently the information about the resource limit checks are not available in the user guide of the Kura adapter and the guide is not detailed as the other adapters . So I thought of a separate PR to update the user guide of the Kura adapter. Now I think, its better to update the user guide immediately. I have updated the user guide with the connection and connection duration limits information. Would you mind taking a look?", "author": "kaniyan", "createdAt": "2020-01-31T12:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MzA0OQ==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373473049", "bodyText": "It looks like you only have added a small paragraph but not the full information that is in the MQTT adapter. Is that by intention?", "author": "sophokles73", "createdAt": "2020-01-31T13:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3NzE4OQ==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373477189", "bodyText": "yes. It is because that the user guide of Kura adapter is not well structured with sections as that of the MQTT adapter. For example, if I include the connection and duration limit sections (with heading) as in the MQTT adapter, then the following paragraph starting with \"Once the gateway has established a connection to the Kura adapter,\" doesn't have a heading and it doesn't looks nice. IMHO the paragraph that I added is not comprehensive, but it is concise with needed information for a user.", "author": "kaniyan", "createdAt": "2020-01-31T13:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0OTc0NA==", "url": "https://github.com/eclipse/hono/pull/1734#discussion_r373449744", "bodyText": "... can now be configured to verify ...", "author": "sophokles73", "createdAt": "2020-01-31T12:10:07Z", "path": "site/homepage/content/release-notes.md", "diffHunk": "@@ -26,6 +26,10 @@ title = \"Release Notes\"\n * A new metric namely *hono.connections.authenticated.duration* has been introduced to track the \n   connection duration of the authenticated devices. Please refer to the \n   [Metrics API]({{% doclink \"/api/metrics/\" %}}) for more details.\n+* The protocol adapters that maintain *connection state* can now be enabled to verify the *connection ", "originalCommit": "17fe48ca7ba48ccc5824d860bb671dd6c2eb53b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8be1ff76a3104636eefe875f0bb6ce744b10689", "url": "https://github.com/eclipse/hono/commit/c8be1ff76a3104636eefe875f0bb6ce744b10689", "message": "[#1716] Update documentation and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <Kartheeswaran.Kalidass@bosch.io>", "committedDate": "2020-01-31T12:58:03Z", "type": "commit"}, {"oid": "c8be1ff76a3104636eefe875f0bb6ce744b10689", "url": "https://github.com/eclipse/hono/commit/c8be1ff76a3104636eefe875f0bb6ce744b10689", "message": "[#1716] Update documentation and release notes.\n\nSigned-off-by: Kartheeswaran Kalidass <Kartheeswaran.Kalidass@bosch.io>", "committedDate": "2020-01-31T12:58:03Z", "type": "forcePushed"}]}