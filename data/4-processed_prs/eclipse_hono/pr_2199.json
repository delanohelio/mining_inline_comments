{"pr_number": 2199, "pr_title": "[#2115] Add PreCredentialsValidationHandler", "pr_createdAt": "2020-09-23T06:13:30Z", "pr_url": "https://github.com/eclipse/hono/pull/2199", "timeline": [{"oid": "54631938f08ba8f5686e4bd018e54485a2e94b97", "url": "https://github.com/eclipse/hono/commit/54631938f08ba8f5686e4bd018e54485a2e94b97", "message": "[#2115] Add PreCredentialsValidationHandler.\n\nAdds an optional handler to the AuthHandler classes that is invoked\nbefore the actual (possibly expensive) credentials validation is\nperformed. This handler can do checks using tenant information obtained\nfrom the authentication data.\nRecent changes to the DeviceCredentialsAuthProvider interface have\nbeen reverted (removing the ExecutionContext dependency) and a\ngetCredentials(JsonObject) method has been added.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-23T06:07:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3MTIyOA==", "url": "https://github.com/eclipse/hono/pull/2199#discussion_r493471228", "bodyText": "authenticate(credentials, TracingHelper.extractSpanContext(tracer, authInfo), resultHandler) ?", "author": "sophokles73", "createdAt": "2020-09-23T11:22:10Z", "path": "service-base/src/main/java/org/eclipse/hono/service/auth/device/CredentialsApiAuthProvider.java", "diffHunk": "@@ -206,47 +203,19 @@ public final void authenticate(\n \n     @Override\n     public final void authenticate(final JsonObject authInfo, final Handler<AsyncResult<User>> resultHandler) {\n-        final ExecutionContext executionContext = new GenericExecutionContext(\n-                TracingHelper.extractSpanContext(tracer, authInfo));\n-        authenticate(authInfo, executionContext, s -> {\n-            if (s.succeeded()) {\n-                resultHandler.handle(Future.succeededFuture(s.result()));\n-            } else {\n-                resultHandler.handle(Future.failedFuture(s.cause()));\n-            }\n-        });\n-    }\n-\n-    @Override\n-    public final void authenticate(\n-            final JsonObject authInfo,\n-            final ExecutionContext executionContext,\n-            final Handler<AsyncResult<DeviceUser>> resultHandler) {\n \n-        Objects.requireNonNull(authInfo);\n-        Objects.requireNonNull(executionContext);\n-        Objects.requireNonNull(resultHandler);\n-\n-        final T credentials = getCredentials(authInfo);\n+        final T credentials = getCredentials(Objects.requireNonNull(authInfo));\n         if (credentials == null) {\n             resultHandler.handle(Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_UNAUTHORIZED, \"malformed credentials\")));\n         } else {\n-            authenticate(credentials, executionContext, resultHandler);\n+            authenticate(credentials, TracingHelper.extractSpanContext(tracer, authInfo), s -> {\n+                if (s.succeeded()) {\n+                    resultHandler.handle(Future.succeededFuture(s.result()));\n+                } else {\n+                    resultHandler.handle(Future.failedFuture(s.cause()));\n+                }\n+            });", "originalCommit": "54631938f08ba8f5686e4bd018e54485a2e94b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUwOTcwOA==", "url": "https://github.com/eclipse/hono/pull/2199#discussion_r493509708", "bodyText": "This won't work because of the generic AsyncResult type:\nresultHandler is of type Handler<AsyncResult<User>> (coming from the vert.x AuthProvider interface, whereas the DeviceCredentialsAuthProvider.authenticate method expects the more specific Handler<AsyncResult<DeviceUser>>.", "author": "calohmn", "createdAt": "2020-09-23T12:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3MTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUzNTc5OQ==", "url": "https://github.com/eclipse/hono/pull/2199#discussion_r493535799", "bodyText": "I always get this wrong ;-)", "author": "sophokles73", "createdAt": "2020-09-23T12:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3MTIyOA=="}], "type": "inlineReview"}]}