{"pr_number": 1908, "pr_title": "[#1858] Add lifespan to setCommandHandlingAdapterInstance", "pr_createdAt": "2020-04-16T10:21:38Z", "pr_url": "https://github.com/eclipse/hono/pull/1908", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5Nzc3OA==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r409597778", "bodyText": "FMPOV this is an API breaking change. How about making it optional until 2.0.0?", "author": "sophokles73", "createdAt": "2020-04-16T14:23:35Z", "path": "site/documentation/content/api/device-connection/index.md", "diffHunk": "@@ -126,6 +126,7 @@ The following table provides an overview of the properties a client needs to set\n | :-------------------- | :-------: | :----------------------- | :-------- | :---------- |\n | *subject*             | yes       | *properties*             | *string*  | MUST be set to `set-cmd-handling-adapter-instance`. |\n | *adapter_instance_id* | yes       | *application-properties* | *string*  | The identifier of the protocol adapter instance that currently handles commands for the device or gateway identified by the *device_id* property. |\n+| *lifespan*            | yes       | *application-properties* | *int*     | The lifetime of the mapping entry in seconds. After that period, the mapping entry shall be treated as non-existent by the *Device Registration API* methods. A negative value is interpreted as an unlimited lifespan.|", "originalCommit": "53ed37c4359d0d763530431b5461dd1395a17b24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNjE5Nw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r409626197", "bodyText": "Yes, good point. I've changed it accordingly.", "author": "calohmn", "createdAt": "2020-04-16T14:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5Nzc3OA=="}], "type": "inlineReview"}, {"oid": "d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "url": "https://github.com/eclipse/hono/commit/d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-16T14:48:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNjA5NA==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r409716094", "bodyText": "it might be easier to use a Caffeine Cache instead which already supports limiting size and defining a time-based eviction strategy ...", "author": "sophokles73", "createdAt": "2020-04-16T17:09:35Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java", "diffHunk": "@@ -43,15 +47,15 @@\n  */\n @Repository\n @Qualifier(\"backend\")\n-public final class MapBasedDeviceConnectionService implements DeviceConnectionService {\n+public class MapBasedDeviceConnectionService implements DeviceConnectionService {\n \n     private static final Logger log = LoggerFactory.getLogger(MapBasedDeviceConnectionService.class);\n \n     // <tenantId, <deviceId, lastKnownGatewayJson>>\n     private final Map<String, Map<String, JsonObject>> lastKnownGatewaysMap = new HashMap<>();\n \n     // <tenantId, <deviceId, adapterInstanceIdJson>>\n-    private final Map<String, Map<String, JsonObject>> commandHandlingAdapterInstancesMap = new HashMap<>();\n+    private final Map<String, Map<String, ExpiringValue<JsonObject>>> commandHandlingAdapterInstancesMap = new HashMap<>();", "originalCommit": "d9ffbe4f2387f2c9f8ea348d64d3e6f5ba9dec6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNzIwMw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r410117203", "bodyText": "I've committed a change so that a Caffeine Cache is now used, letting it do the eviction.\nI've haven't used the size limited feature though (maximumSize on cache builder) because that would change the behaviour. When the max size is (about to get) reached on a Caffeine Cache, some existing entry gets evicted. What we want here is to keep the existing entries and prevent addition of new entries if the max size has been reached.", "author": "calohmn", "createdAt": "2020-04-17T09:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNjA5NA=="}], "type": "inlineReview"}, {"oid": "796c5438d119b2a66bc8535fb03fc461fe3ed492", "url": "https://github.com/eclipse/hono/commit/796c5438d119b2a66bc8535fb03fc461fe3ed492", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-17T09:32:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r411919043", "bodyText": "what if the client provides the value but the implementation doesn't support it?", "author": "sophokles73", "createdAt": "2020-04-21T06:53:55Z", "path": "site/documentation/content/api/device-connection/index.md", "diffHunk": "@@ -126,6 +126,7 @@ The following table provides an overview of the properties a client needs to set\n | :-------------------- | :-------: | :----------------------- | :-------- | :---------- |\n | *subject*             | yes       | *properties*             | *string*  | MUST be set to `set-cmd-handling-adapter-instance`. |\n | *adapter_instance_id* | yes       | *application-properties* | *string*  | The identifier of the protocol adapter instance that currently handles commands for the device or gateway identified by the *device_id* property. |\n+| *lifespan*            | no        | *application-properties* | *int*     | The lifetime of the mapping entry in seconds. After that period, the mapping entry shall be treated as non-existent by the *Device Registration API* methods. A negative value, as well as an omitted property, is interpreted as an unlimited lifespan.|", "originalCommit": "796c5438d119b2a66bc8535fb03fc461fe3ed492", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4MTc1Mw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412081753", "bodyText": "I've adapted the description as follows:\n\nThe desired lifespan of the mapping entry in seconds. If the Device Registration API implementation supports this property, the mapping entry shall be treated as non-existent after that period has elapsed. A negative value, as well as an omitted property, is interpreted as an unlimited lifespan. A Device Registration API implementation may not support this property, meaning that a client can't rely on the given lifespan to be applied.", "author": "calohmn", "createdAt": "2020-04-21T10:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY1OTc5Mg==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412659792", "bodyText": "@sophokles73 An afterthought on this:\nSince we target this change for the next minor version, meaning we can introduce incompatible changes to providers of the Device Connection API, I think we can indeed require implementations of the API to support the lifespan property. And I think we should make it a requirement then (otherwise we have to maintain extra client logic for the case it isn't supported by an implementation). WDYT?", "author": "calohmn", "createdAt": "2020-04-22T04:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc0NTgxNQ==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412745815", "bodyText": "How could a client know if an implementation supports it or not? The implementation would simply ignore the given value and keep the mapping until it evicts it, wouldn't it?", "author": "sophokles73", "createdAt": "2020-04-22T07:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc1OTM0OA==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412759348", "bodyText": "My point is to make it mandatory for an implementation to support the lifespan property, so that a client can be sure it is supported.", "author": "calohmn", "createdAt": "2020-04-22T07:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3ODA1NQ==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412778055", "bodyText": "I understand that. My note was in reply to your remark\n\notherwise we have to maintain extra client logic for the case it isn't supported by an implementation\n\nWe have no way of making the registry supporting the property because the adapter has no way of detecting this and thus cannot e.g. issue a warning or shut down or use additional logic to compensate for it. I agree, though, that we should document the fact that, if a registry does not support the additional lifespan property, then the adapter might fail to correctly route commands.", "author": "sophokles73", "createdAt": "2020-04-22T08:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4Mjg5Mg==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412782892", "bodyText": "And as a general note concerning the Mandatory column in the Request Message Format properties table:\nI understand that in such a way that it is or isn't mandatory for the client to use the property in its requests. If not stated otherwise in the description, I would think that API implementations have to support the property regardless, right?", "author": "calohmn", "createdAt": "2020-04-22T08:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc5MjYxNw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412792617", "bodyText": "We have no way of making the registry supporting the property because the adapter has no way of detecting this and thus cannot e.g. issue a warning or shut down or use additional logic to compensate for it.\n\nWell, we could use the existing logic of always explicitly removing the mapping entry (with the notable exception of edge cases like when the adapter is killed before being able to do that), noticing in the return value, whether the (expired) entry was actually removed before by the API implementation.\nBut I would rather omit this and make it part of the contract that the API implementation just has to support the lifespan property.\n\nI agree, though, that we should document the fact that, if a registry does not support the additional lifespan property, then the adapter might fail to correctly route commands.\n\nYes, we can insert this as the reason why it has to be implemented in the API implementation.", "author": "calohmn", "createdAt": "2020-04-22T08:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc5NjkwNw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412796907", "bodyText": "Since we target this change for the next minor version, meaning we can introduce incompatible changes to providers of the Device Connection API, I think we can indeed require implementations of the API to support the lifespan property.\n\nI am not sure about this, because the (public) Device Connection API describes a dependency on an external system as opposed to APIs where Hono is the actual implementation (provider) of the API, e.g. the API defined by its protocol adapters towards the devices.\n@dejanb @ctron WDYT?", "author": "sophokles73", "createdAt": "2020-04-22T08:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgwNTE3Mw==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412805173", "bodyText": "Created PR #1917 for adapting the documentation.\nEDIT: sorry, didn't see the above comment, waiting on further comments here then.", "author": "calohmn", "createdAt": "2020-04-22T09:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgzNjMzOQ==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r412836339", "bodyText": "I am not sure about this, because the (public) Device Connection API describes a dependency on an external system as opposed to APIs where Hono is the actual implementation (provider) of the API, e.g. the API defined by its protocol adapters towards the devices.\n\nI was sticking to the OSGi semantic versioning notions of providers and consumers (with the emphasis of keeping only consumers stable between minor versions) here and seeing the device registry as a provider of the different Hono APIs.\nBut, yes, in the sense that the device registry is external, it could be seen as even more important to keep things compatible for it between Hono minor versions than for the protocol adapter consumers, which are Hono internal (in a way).\nBut I think, if we go that way of keeping device registry implementations compatible between Hono minor versions, we have to increase Hono major versions in more cases. For example, the Command & Control changes in 1.2 (with its additional, non-optional Device Connection API methods) would have required a 2.0.\nAnd now, the addition of another additional API flag, mentioned in #1858 (comment), where the support in the implementation should better be not optional, would strictly speaking require us to go for 2.0 instead of 1.3 as well.\nIn any case, we should decide on which approach to take.", "author": "calohmn", "createdAt": "2020-04-22T09:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NzcxOQ==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r413567719", "bodyText": "The registry APIs defined as part of Hono all define APIs that Hono consumes, i.e. they define what Hono expects to find implemented by some third party entity. The fact that we also provide an example implementation of these APIs doesn't mean that we can change these APIs in a non-backward compatible way as long as we implement these changes in the example registry. So, indeed, I agree that we already would have needed to increase the version to 2.0.0 instead of 1.2.0 because of the newly introduced, mandatory operation in the Device Connection API.\n@ctron @dejanb WDYT?", "author": "sophokles73", "createdAt": "2020-04-23T07:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYxMTM2Mg==", "url": "https://github.com/eclipse/hono/pull/1908#discussion_r415611362", "bodyText": "On the community call last Thursday it was decided that we want to stick to the OSGi semantic versioning approach.\nAn implementation of the device registry APIs is seen as a provider. Hence there can be incompatible changes between Hono minor versions for the providers, requiring changes to the implementation of the device registry APIs. But, at the same time, these API changes must keep the consumers, i.e. the protocol adapter implementations, compatible with the previous minor version.\nThat means that a device registry implementation of a newer minor version still is compatible with protocol adapters of an older minor version of the Hono APIs.\nThis was seen as the key point here.\nIt is the obligation of the device registry implementation, to keep up with additive changes in newer minor versions of the APIs then.", "author": "calohmn", "createdAt": "2020-04-27T08:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxOTA0Mw=="}], "type": "inlineReview"}, {"oid": "c2a9039f45eebc473d8b137a7931d7c258945117", "url": "https://github.com/eclipse/hono/commit/c2a9039f45eebc473d8b137a7931d7c258945117", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-21T10:52:49Z", "type": "commit"}, {"oid": "c2a9039f45eebc473d8b137a7931d7c258945117", "url": "https://github.com/eclipse/hono/commit/c2a9039f45eebc473d8b137a7931d7c258945117", "message": "[#1858] Add lifespan to setCommandHandlingAdapterInstance.\n\nThis makes it possible to restrict the lifespan of\nentries set via the setCommandHandlingAdapterInstance\nmethod of the Device Connection API.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-04-21T10:52:49Z", "type": "forcePushed"}]}