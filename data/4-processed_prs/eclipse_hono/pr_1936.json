{"pr_number": 1936, "pr_title": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance", "pr_createdAt": "2020-05-04T05:54:23Z", "pr_url": "https://github.com/eclipse/hono/pull/1936", "timeline": [{"oid": "0818b7d7f144c3d606b2275da26bcfee298bd0e1", "url": "https://github.com/eclipse/hono/commit/0818b7d7f144c3d606b2275da26bcfee298bd0e1", "message": "[#1858] Add 'onlyUpdate' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-04T07:45:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3Mjk5MQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419272991", "bodyText": "what if any of the params are null?", "author": "sophokles73", "createdAt": "2020-05-04T08:10:05Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/Cache.java", "diffHunk": "@@ -61,6 +61,19 @@\n      */\n     Future<V> put(K key, V value, long lifespan, TimeUnit lifespanUnit);\n \n+    /**\n+     * Replaces the entry for a key only if currently mapped to a given value.\n+     *\n+     * @param key The key.\n+     * @param oldValue The value to overwrite.\n+     * @param newValue The value to store.\n+     * @param lifespan The lifespan of the entry. A negative value is interpreted as an unlimited lifespan.\n+     * @param lifespanUnit The time unit for the lifespan.\n+     * @return A succeeded future containing a boolean, indicating whether the value was replaced or not.\n+     *         A failed future if the value could not be stored in the cache.\n+     */\n+    Future<Boolean> replace(K key, V oldValue, V newValue, long lifespan, TimeUnit lifespanUnit);", "originalCommit": "0818b7d7f144c3d606b2275da26bcfee298bd0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2OTAyOA==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419369028", "bodyText": "I've added checks and adapted the javadoc (also for the other methods).", "author": "calohmn", "createdAt": "2020-05-04T11:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3Mjk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NTcxNg==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419275716", "bodyText": "can we please rename this parameter to update_only?", "author": "sophokles73", "createdAt": "2020-05-04T08:15:53Z", "path": "site/documentation/content/api/device-connection/index.md", "diffHunk": "@@ -129,6 +129,7 @@ The following table provides an overview of the properties a client needs to set\n | *subject*             | yes       | *properties*             | *string*  | MUST be set to `set-cmd-handling-adapter-instance`. |\n | *adapter_instance_id* | yes       | *application-properties* | *string*  | The identifier of the protocol adapter instance that currently handles commands for the device or gateway identified by the *device_id* property. |\n | *lifespan*            | no        | *application-properties* | *int*     | The lifespan of the mapping entry in seconds. After that period, the mapping entry shall be treated as non-existent by the *Device Registration API* methods. A negative value, as well as an omitted property, is interpreted as an unlimited lifespan. |\n+| *only_update*         | no        | *application-properties* | *boolean* | If set to `true`, the command will only update an existing mapping entry with the given lifespan, provided such an entry with the given device id and adapter instance id exists. If the property is omitted or set to `false`, the mapping entry will be set regardless whether an entry with the given adapter instance id exists or not. |", "originalCommit": "0818b7d7f144c3d606b2275da26bcfee298bd0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1OTQzMw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419359433", "bodyText": "yes, I've changed that (also renamed the method parameter).", "author": "calohmn", "createdAt": "2020-05-04T11:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NTcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NjczNw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419276737", "bodyText": "FMPOV this should be returned if no entry has been found for the given device ID, regardless of the value of update_only.\nWe should then expicitly list 412 as the value to be returned for update_only = true and a non-matching orig-value. I do not see why the registry implementation should return 404 or 412 in that case, given that we expect the registry to explicitly support this property anyway ...", "author": "sophokles73", "createdAt": "2020-05-04T08:17:55Z", "path": "site/documentation/content/api/device-connection/index.md", "diffHunk": "@@ -141,9 +142,11 @@ The response message's *status* property may contain the following codes:\n | Code  | Description |\n | :---- | :---------- |\n | *204* | OK, the adapter instance for the device has been updated. |\n-| *400* | Bad Request, the command-handling adapter instance has not been updated due to invalid or missing data in the request. |\n+| *400* | Bad Request, the command-handling adapter instance has not been set or updated due to invalid or missing data in the request. |\n+| *404* | Not Found, entry to be updated was not found. This applies to requests with *only_update* set to `true`. |", "originalCommit": "0818b7d7f144c3d606b2275da26bcfee298bd0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1OTI4Nw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419359287", "bodyText": "FMPOV this should be returned if no entry has been found for the given device ID, regardless of the value of update_only.\n\nBut, whether an entry for the given device ID is found or not, only matters if update_only is true (if update_only is false, a new mapping entry with the device ID will just be created).\n\nWe should then expicitly list 412 as the value to be returned for update_only = true and a non-matching orig-value. I do not see why the registry implementation should return 404 or 412 in that case, given that we expect the registry to explicitly support this property anyway ...\n\nTwo things made me go for choosing 404 as the default for both the key-not-found and adapter-instance-not-matching cases here:\n\nthe removeCommandHandlingAdapterInstance command also requires the adapterInstanceId to match. For that command we have defined 404 as the default if no matching entry was found, and 412 as an optional alternative to 404.\na straightforward implementation might use a replace(key, oldValue, newValue) method here. With that, there is no distinction, whether an entry for the key wasn't found or whether the oldValue didn't match. In fact for the cache based implementation, I've used the corresponding cache.replaceAsync() method. (That could of course be changed to use cache.computeIfAbsentAsync where a distinction between return values can be made then.)\n\nTherefore, for the sake of keeping in sync with the other API methods and for making it easier for implementations (not requiring the key-not-found vs adapter-instance-not-matching distinction, which also isn't needed in the code using the API), I would rather keep the API definition as is.", "author": "calohmn", "createdAt": "2020-05-04T11:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NjczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5OTUyNQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419399525", "bodyText": "But, whether an entry for the given device ID is found or not, only matters if update_only is true (if update_only is false, a new mapping entry with the device ID will just be created).\n\ntrue, based on that it would probably make sense to never return 404 but to return 412 if update_only = true and either no entry for the given device ID exists at all or the expected value doesn't match.\n\nthe removeCommandHandlingAdapterInstance command also requires the adapterInstanceId to match. For that command we have defined 404 as the default if no matching entry was found, and 412 as an optional alternative to 404.\n\nmaybe we should change that as well. I don't really like the fact that a client needs to support both status codes but still doesn't really know what the problem is ...", "author": "sophokles73", "createdAt": "2020-05-04T12:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NjczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0ODIxMQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419448211", "bodyText": "I would be fine with always returning 412 (and not having the distinction between the two cases).\nTo be consistent, I agree that removeCommandHandlingAdapterInstance should then be changed as well. I think, regarding compatibility, we can do this in 1.3, since \"412\" is already defined there as a possible return value.\nAnother thing would be changing the 404 status code for the optional \"device-doesn't-exist-for-tenant\" check in the set/remove operations. I would like to change that to 412 as well. But since setLastKnownGateway doesn't define 412 as possible return code as of now, I think we can only do this in Hono 2.0.\nTherefore I would keep the 404 as the common status code for the \"device-doesn't-exist-for-tenant\" check in all methods for now.", "author": "calohmn", "createdAt": "2020-05-04T13:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NjczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ5MjgyNA==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419492824", "bodyText": "I've updated the documentation accordingly.\n(Changes concerning removeCommandHandlingAdapterInstance will go in a separate PR then.)", "author": "calohmn", "createdAt": "2020-05-04T14:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3NjczNw=="}], "type": "inlineReview"}, {"oid": "54a44ceb2dafb88567641894bef3e8467d2ed609", "url": "https://github.com/eclipse/hono/commit/54a44ceb2dafb88567641894bef3e8467d2ed609", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-04T09:56:56Z", "type": "forcePushed"}, {"oid": "7cc4db1ac61e44b610ad96bac3b2e5a87dd3535d", "url": "https://github.com/eclipse/hono/commit/7cc4db1ac61e44b610ad96bac3b2e5a87dd3535d", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-04T11:26:13Z", "type": "forcePushed"}, {"oid": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "url": "https://github.com/eclipse/hono/commit/29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-04T14:45:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMDY0Ng==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419930646", "bodyText": "how about\n\nPrecondition failed, the adapter instance for the device has not been set or updated. This status is returned if the update_only property is set to true but no matching entry for the given device ID and adapter instance value exists.", "author": "sophokles73", "createdAt": "2020-05-05T08:03:39Z", "path": "site/documentation/content/api/device-connection/index.md", "diffHunk": "@@ -140,8 +141,9 @@ The response message's *status* property may contain the following codes:\n \n | Code  | Description |\n | :---- | :---------- |\n-| *204* | OK, the adapter instance for the device has been updated. |\n-| *400* | Bad Request, the command-handling adapter instance has not been updated due to invalid or missing data in the request. |\n+| *204* | OK, the command-handling adapter instance for the device has been updated. |\n+| *400* | Bad Request, the adapter instance for the device has not been set or updated due to invalid or missing data in the request. |\n+| *412* | Precondition failed, the to be updated adapter instance entry for the device doesn't exist, or its adapter instance value doesn't match. This applies to requests with *update_only* set to `true`. |", "originalCommit": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzNDc5Mg==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419934792", "bodyText": "don't we expect the updateOnly param to be false here?", "author": "sophokles73", "createdAt": "2020-05-05T08:11:13Z", "path": "client/src/test/java/org/eclipse/hono/client/impl/ProtocolAdapterCommandConsumerFactoryImplTest.java", "diffHunk": "@@ -187,7 +187,7 @@ public void testCreateCommandConsumerSucceeds(final VertxTestContext ctx) {\n                 ctx.verify(() -> {\n                     verify(connection).createReceiver(eq(tenantCommandAddress), eq(ProtonQoS.AT_LEAST_ONCE), any(), anyInt(),\n                             eq(false), any());\n-                    verify(devConClient).setCommandHandlingAdapterInstance(eq(deviceId), anyString(), any(), any());\n+                    verify(devConClient).setCommandHandlingAdapterInstance(eq(deviceId), anyString(), any(), anyBoolean(), any());", "originalCommit": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzNDkyNg==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419934926", "bodyText": "don't we expect the updateOnly param to be false here?", "author": "sophokles73", "createdAt": "2020-05-05T08:11:28Z", "path": "client/src/test/java/org/eclipse/hono/client/impl/ProtocolAdapterCommandConsumerFactoryImplTest.java", "diffHunk": "@@ -211,7 +211,7 @@ public void testCreateTimeLimitedCommandConsumerSucceeds(final VertxTestContext\n             ctx.verify(() -> {\n                 verify(connection).createReceiver(eq(tenantCommandAddress), eq(ProtonQoS.AT_LEAST_ONCE), any(), anyInt(),\n                         eq(false), any());\n-                verify(devConClient).setCommandHandlingAdapterInstance(eq(deviceId), anyString(), any(), any());\n+                verify(devConClient).setCommandHandlingAdapterInstance(eq(deviceId), anyString(), any(), anyBoolean(), any());", "originalCommit": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzNjIzMw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419936233", "bodyText": "how about\nfinal boolean updateOnly = Optional.ofNullable(MessageHelper.getApplicationProperty(request.getApplicationProperties(), MessageHelper.APP_PROPERTY_UPDATE_ONLY, Boolean.class))\n  .orElse(false);", "author": "sophokles73", "createdAt": "2020-05-05T08:14:01Z", "path": "service-base/src/main/java/org/eclipse/hono/service/deviceconnection/DelegatingDeviceConnectionAmqpEndpoint.java", "diffHunk": "@@ -241,6 +241,7 @@ public DelegatingDeviceConnectionAmqpEndpoint(final Vertx vertx, final S service\n         final String deviceId = MessageHelper.getDeviceId(request);\n         final String adapterInstanceId = MessageHelper.getApplicationProperty(request.getApplicationProperties(), MessageHelper.APP_PROPERTY_ADAPTER_INSTANCE_ID, String.class);\n         final Integer lifespanSecondsOrNull = MessageHelper.getApplicationProperty(request.getApplicationProperties(), MessageHelper.APP_PROPERTY_LIFESPAN, Integer.class);\n+        final Boolean updateOnlyOrNull = MessageHelper.getApplicationProperty(request.getApplicationProperties(), MessageHelper.APP_PROPERTY_UPDATE_ONLY, Boolean.class);", "originalCommit": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r419938653", "bodyText": "I think we need to also remove an expired existing value if the adapter instance doesn't match ...", "author": "sophokles73", "createdAt": "2020-05-05T08:18:42Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java", "diffHunk": "@@ -128,9 +129,26 @@ public MapBasedDeviceConnectionsConfigProperties getConfig() {\n         final int currentMapSize = adapterInstancesForTenantMap.size();\n         if (currentMapSize < getConfig().getMaxDevicesPerTenant()\n                 || (currentMapSize == getConfig().getMaxDevicesPerTenant() && adapterInstancesForTenantMap.containsKey(deviceId))) {\n-            adapterInstancesForTenantMap.put(deviceId,\n-                    new ExpiringValue<>(createAdapterInstanceIdJson(protocolAdapterInstanceId), getLifespanNanos(lifespan)));\n-            result = DeviceConnectionResult.from(HttpURLConnection.HTTP_NO_CONTENT);\n+            final ExpiringValue<JsonObject> newValue = new ExpiringValue<>(\n+                    createAdapterInstanceIdJson(protocolAdapterInstanceId), getLifespanNanos(lifespan));\n+            if (updateOnly) {\n+                final ExpiringValue<JsonObject> resultingValue = adapterInstancesForTenantMap\n+                        .computeIfPresent(deviceId, (key, oldValue) -> {\n+                            if (protocolAdapterInstanceId.equals(getAdapterInstanceIdFromJson(oldValue.getValue()))) {\n+                                return newValue;\n+                            } else {\n+                                return oldValue;\n+                            }\n+                        });\n+                if (resultingValue != null && protocolAdapterInstanceId.equals(getAdapterInstanceIdFromJson(resultingValue.getValue()))) {\n+                    result = DeviceConnectionResult.from(HttpURLConnection.HTTP_NO_CONTENT);\n+                } else {\n+                    result = DeviceConnectionResult.from(HttpURLConnection.HTTP_PRECON_FAILED);\n+                }", "originalCommit": "29c2b7acd8a5fbabb274eedb8e869e1f78061eae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4MDE0Nw==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420080147", "bodyText": "@calohmn WDYT?", "author": "sophokles73", "createdAt": "2020-05-05T12:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4MzAwMg==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420083002", "bodyText": "Removing an expired entry here is something I don't quite understand - the removal of an expired entry is done under the hood by the Caffeine cache.\nHowever, I've found two other issues here: one (updated lifespan wasn't taken into account) is already fixed (along with an added test), the other (a failed update influences lifespan of existing entry) is something I'm currently working on.", "author": "calohmn", "createdAt": "2020-05-05T12:50:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4NjgyOA==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420086828", "bodyText": "But we are using a simple Map here for keeping the data, not a Caffeine Cache, or am I mistaken?", "author": "sophokles73", "createdAt": "2020-05-05T12:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5MTQ0MQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420091441", "bodyText": "The adapterInstancesForTenantMap is a Caffeine Cache under the hood (using cache.asMap()).", "author": "calohmn", "createdAt": "2020-05-05T13:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDExMDk4MA==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420110980", "bodyText": "I see", "author": "sophokles73", "createdAt": "2020-05-05T13:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE0ODkwMQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420148901", "bodyText": "2nd issue is fixed now.", "author": "calohmn", "createdAt": "2020-05-05T14:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODY1Mw=="}], "type": "inlineReview"}, {"oid": "31052fb230de6bf05b0f2d457b2070338954ba26", "url": "https://github.com/eclipse/hono/commit/31052fb230de6bf05b0f2d457b2070338954ba26", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-05T12:07:49Z", "type": "forcePushed"}, {"oid": "b5641b3c7c8fd008beda6e9c2ffdb120026437d4", "url": "https://github.com/eclipse/hono/commit/b5641b3c7c8fd008beda6e9c2ffdb120026437d4", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-05T14:21:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDE2NA==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420574164", "bodyText": "My understanding is that we do not want to change an existing value's lifespan on reading, right? Does currentDuration contain the object's remaining lifetime based on the lifetime determined at creation/update time?", "author": "sophokles73", "createdAt": "2020-05-06T06:41:18Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java", "diffHunk": "@@ -159,13 +171,13 @@ public long expireAfterCreate(final String key, final ExpiringValue<JsonObject>\n                     @Override\n                     public long expireAfterUpdate(final String key, final ExpiringValue<JsonObject> value,\n                             final long currentTime, final long currentDuration) {\n-                        return Long.MAX_VALUE;\n+                        return value.getLifespanNanos();\n                     }\n \n                     @Override\n                     public long expireAfterRead(final String key, final ExpiringValue<JsonObject> value,\n                             final long currentTime, final long currentDuration) {\n-                        return Long.MAX_VALUE;\n+                        return currentDuration;", "originalCommit": "b5641b3c7c8fd008beda6e9c2ffdb120026437d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NjQxNQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420576415", "bodyText": "Yes. As the javadoc states: The {@code currentDuration} may be returned to not modify the expiration time.. So using Long.MAX_VALUE was wrong here.", "author": "calohmn", "createdAt": "2020-05-06T06:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDI4NQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420574285", "bodyText": "java.util.function.Predicate ?", "author": "sophokles73", "createdAt": "2020-05-06T06:41:36Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/deviceconnection/MapBasedDeviceConnectionService.java", "diffHunk": "@@ -300,6 +312,22 @@ private String getAdapterInstanceIdFromJson(final JsonObject adapterInstanceIdJs\n         return expiringValue != null ? expiringValue.getValue() : null;\n     }\n \n+    /**\n+     * Replaces the entry for a key only if the matching function applied to the current value returns {@code true}.\n+     */\n+    private static <V, K> boolean replaceIfMatching(final ConcurrentMap<K, V> map, final K key, final V newValue,\n+            final Function<? super V, Boolean> matchingFunction) {", "originalCommit": "b5641b3c7c8fd008beda6e9c2ffdb120026437d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3OTgxOQ==", "url": "https://github.com/eclipse/hono/pull/1936#discussion_r420579819", "bodyText": "Yes, that's better.", "author": "calohmn", "createdAt": "2020-05-06T06:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDI4NQ=="}], "type": "inlineReview"}, {"oid": "79542f6e090d35f8492e15ec03cfc2c275a8bbe7", "url": "https://github.com/eclipse/hono/commit/79542f6e090d35f8492e15ec03cfc2c275a8bbe7", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-06T06:54:50Z", "type": "commit"}, {"oid": "79542f6e090d35f8492e15ec03cfc2c275a8bbe7", "url": "https://github.com/eclipse/hono/commit/79542f6e090d35f8492e15ec03cfc2c275a8bbe7", "message": "[#1858] Add 'updateOnly' param to setCommandHandlingAdapterInstance.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-05-06T06:54:50Z", "type": "forcePushed"}]}