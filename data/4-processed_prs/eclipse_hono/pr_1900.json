{"pr_number": 1900, "pr_title": "[#1679] Avoid conversion from Device to JsonObject in MongoDB based assertRegistration", "pr_createdAt": "2020-04-14T14:18:16Z", "pr_url": "https://github.com/eclipse/hono/pull/1900", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyMTU0MQ==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408621541", "bodyText": "why not fail the promise with a ClientErrorException(404) here instead of checking for a null result everywhere else?", "author": "sophokles73", "createdAt": "2020-04-15T07:00:07Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -196,32 +198,32 @@ public void setConfig(final MongoDbBasedRegistrationConfigProperties config) {\n         return processResolveGroupMembers(tenantId, viaGroups, span);\n     }\n \n-    private JsonObject convertDevice(final String deviceId, final Device payload) {\n-\n-        if (payload == null) {\n-            return null;\n-        }\n-\n-        final JsonObject data = JsonObject.mapFrom(payload);\n-\n-        return new JsonObject()\n-                .put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, deviceId)\n-                .put(\"data\", data);\n+    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+        return findDeviceDocument(tenantId, deviceId)\n+                .compose(result -> Optional.ofNullable(result)\n+                        .map(ok -> result.mapTo(DeviceDto.class))\n+                        .map(Future::succeededFuture)\n+                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n+                                String.format(\"Device [%s] not found.\", deviceId)))));\n     }\n \n-    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+    private Future<JsonObject> findDeviceDocument(final String tenantId, final String deviceId) {\n         final JsonObject findDeviceQuery = new MongoDbDocumentBuilder()\n                 .withTenantId(tenantId)\n                 .withDeviceId(deviceId)\n                 .document();\n         final Promise<JsonObject> readDevicePromise = Promise.promise();\n         mongoClient.findOne(config.getCollectionName(), findDeviceQuery, null, readDevicePromise);\n-        return readDevicePromise.future()\n-                .compose(result -> Optional.ofNullable(result)\n-                        .map(ok -> result.mapTo(DeviceDto.class))\n-                        .map(Future::succeededFuture)\n-                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n-                                String.format(\"Device [%s] not found.\", deviceId)))));\n+        return readDevicePromise.future();", "originalCommit": "8d1df8b3e8d6cfabbb4c7516c059470f7651908c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NDk5OA==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408664998", "bodyText": "Initially I implemented as in the comment (as below), then I changed it. In this case a recover block is needed and there it need to be checked for the ClientErrorException and create a RegistrationResult based on the status code. I thought in the other approach, by checking for null we could directly create a RegistrationResult with HTTP_NOT_FOUND and this extra check for ClientErrorException could be avoided. That's why I chose the other one. We discuss here about the error case and supposedly it's not the often occurring case, I am fine with both the approaches. I will replace it with the below code.\nreturn findDeviceDocument(deviceKey.getTenantId(), deviceKey.getDeviceId())\n\t\t.map(result -> getRegistrationResult(deviceKey.getDeviceId(),\n\t\t\t\tresult.getJsonObject(MongoDbDeviceRegistryUtils.FIELD_DEVICE)))\n\t\t.recover(error -> {\n\t\t\tlog.error(error.getMessage(), error);\n\t\t\tTracingHelper.logError(span, error.getMessage(), error);\n\t\t\tif (error instanceof ClientErrorException) {\n\t\t\t\treturn Future.succeededFuture(\n\t\t\t\t\t\tRegistrationResult.from(((ClientErrorException) error).getErrorCode()));\n\t\t\t}\n\t\t\treturn Future.succeededFuture(RegistrationResult.from(HttpURLConnection.HTTP_INTERNAL_ERROR));\n\t\t});", "author": "kaniyan", "createdAt": "2020-04-15T08:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyMTU0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2OTY0MA==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408669640", "bodyText": "No, please keep your code. You seem to have a good reason for doing it the way you do :-)", "author": "sophokles73", "createdAt": "2020-04-15T08:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyMTU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyMzA3MA==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408623070", "bodyText": "IMHO we don't need this as it seems to be a re-declaration of RegistrationConstants.FIELD_DATA, isn't it?", "author": "sophokles73", "createdAt": "2020-04-15T07:03:36Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDeviceRegistryUtils.java", "diffHunk": "@@ -35,6 +35,14 @@\n  */\n public final class MongoDbDeviceRegistryUtils {\n \n+    /**\n+     * The name of the JSON property containing the device identifier.\n+     */\n+    public static final String FIELD_DEVICE = \"device\";\n+    /**\n+     * The name of the JSON property containing the data.\n+     */\n+    public static final String FIELD_DATA = \"data\";", "originalCommit": "8d1df8b3e8d6cfabbb4c7516c059470f7651908c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyODMxOQ==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408628319", "bodyText": "IMHO this should be RegistrationConstants.FIELD_DATA", "author": "sophokles73", "createdAt": "2020-04-15T07:14:33Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -196,32 +198,32 @@ public void setConfig(final MongoDbBasedRegistrationConfigProperties config) {\n         return processResolveGroupMembers(tenantId, viaGroups, span);\n     }\n \n-    private JsonObject convertDevice(final String deviceId, final Device payload) {\n-\n-        if (payload == null) {\n-            return null;\n-        }\n-\n-        final JsonObject data = JsonObject.mapFrom(payload);\n-\n-        return new JsonObject()\n-                .put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, deviceId)\n-                .put(\"data\", data);\n+    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+        return findDeviceDocument(tenantId, deviceId)\n+                .compose(result -> Optional.ofNullable(result)\n+                        .map(ok -> result.mapTo(DeviceDto.class))\n+                        .map(Future::succeededFuture)\n+                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n+                                String.format(\"Device [%s] not found.\", deviceId)))));\n     }\n \n-    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+    private Future<JsonObject> findDeviceDocument(final String tenantId, final String deviceId) {\n         final JsonObject findDeviceQuery = new MongoDbDocumentBuilder()\n                 .withTenantId(tenantId)\n                 .withDeviceId(deviceId)\n                 .document();\n         final Promise<JsonObject> readDevicePromise = Promise.promise();\n         mongoClient.findOne(config.getCollectionName(), findDeviceQuery, null, readDevicePromise);\n-        return readDevicePromise.future()\n-                .compose(result -> Optional.ofNullable(result)\n-                        .map(ok -> result.mapTo(DeviceDto.class))\n-                        .map(Future::succeededFuture)\n-                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n-                                String.format(\"Device [%s] not found.\", deviceId)))));\n+        return readDevicePromise.future();\n+    }\n+\n+    private RegistrationResult getRegistrationResult(final String deviceId, final JsonObject devicePayload) {\n+        return RegistrationResult.from(HttpURLConnection.HTTP_OK,\n+                Optional.ofNullable(devicePayload)\n+                        .map(ok -> new JsonObject()\n+                                .put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, deviceId)\n+                                .put(MongoDbDeviceRegistryUtils.FIELD_DATA, devicePayload))", "originalCommit": "8d1df8b3e8d6cfabbb4c7516c059470f7651908c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyODg0OQ==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408628849", "bodyText": "is this field really used for the device identifier? Or is it used for the device data itself?", "author": "sophokles73", "createdAt": "2020-04-15T07:15:42Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDeviceRegistryUtils.java", "diffHunk": "@@ -35,6 +35,14 @@\n  */\n public final class MongoDbDeviceRegistryUtils {\n \n+    /**\n+     * The name of the JSON property containing the device identifier.", "originalCommit": "8d1df8b3e8d6cfabbb4c7516c059470f7651908c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMjYyNQ==", "url": "https://github.com/eclipse/hono/pull/1900#discussion_r408632625", "bodyText": "IMHO this should be RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID as the result being prepared here is defined by the Device Registration API", "author": "sophokles73", "createdAt": "2020-04-15T07:23:03Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -196,32 +198,32 @@ public void setConfig(final MongoDbBasedRegistrationConfigProperties config) {\n         return processResolveGroupMembers(tenantId, viaGroups, span);\n     }\n \n-    private JsonObject convertDevice(final String deviceId, final Device payload) {\n-\n-        if (payload == null) {\n-            return null;\n-        }\n-\n-        final JsonObject data = JsonObject.mapFrom(payload);\n-\n-        return new JsonObject()\n-                .put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, deviceId)\n-                .put(\"data\", data);\n+    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+        return findDeviceDocument(tenantId, deviceId)\n+                .compose(result -> Optional.ofNullable(result)\n+                        .map(ok -> result.mapTo(DeviceDto.class))\n+                        .map(Future::succeededFuture)\n+                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n+                                String.format(\"Device [%s] not found.\", deviceId)))));\n     }\n \n-    private Future<DeviceDto> findDevice(final String tenantId, final String deviceId) {\n+    private Future<JsonObject> findDeviceDocument(final String tenantId, final String deviceId) {\n         final JsonObject findDeviceQuery = new MongoDbDocumentBuilder()\n                 .withTenantId(tenantId)\n                 .withDeviceId(deviceId)\n                 .document();\n         final Promise<JsonObject> readDevicePromise = Promise.promise();\n         mongoClient.findOne(config.getCollectionName(), findDeviceQuery, null, readDevicePromise);\n-        return readDevicePromise.future()\n-                .compose(result -> Optional.ofNullable(result)\n-                        .map(ok -> result.mapTo(DeviceDto.class))\n-                        .map(Future::succeededFuture)\n-                        .orElseGet(() -> Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND,\n-                                String.format(\"Device [%s] not found.\", deviceId)))));\n+        return readDevicePromise.future();\n+    }\n+\n+    private RegistrationResult getRegistrationResult(final String deviceId, final JsonObject devicePayload) {\n+        return RegistrationResult.from(HttpURLConnection.HTTP_OK,\n+                Optional.ofNullable(devicePayload)\n+                        .map(ok -> new JsonObject()\n+                                .put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, deviceId)", "originalCommit": "8d1df8b3e8d6cfabbb4c7516c059470f7651908c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ac1c89265f5b08ce38c19c7ac906a589ba3c27e", "url": "https://github.com/eclipse/hono/commit/9ac1c89265f5b08ce38c19c7ac906a589ba3c27e", "message": "[#1679] Avoid conversion from Device to JsonObject during assertRegistration.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-15T08:41:23Z", "type": "commit"}, {"oid": "9ac1c89265f5b08ce38c19c7ac906a589ba3c27e", "url": "https://github.com/eclipse/hono/commit/9ac1c89265f5b08ce38c19c7ac906a589ba3c27e", "message": "[#1679] Avoid conversion from Device to JsonObject during assertRegistration.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-15T08:41:23Z", "type": "forcePushed"}]}