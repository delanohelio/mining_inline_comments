{"pr_number": 2178, "pr_title": "Use VertxTestContext checkpoints consistently", "pr_createdAt": "2020-09-15T13:51:16Z", "pr_url": "https://github.com/eclipse/hono/pull/2178", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY5ODI4NA==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488698284", "bodyText": "we should also remove the duplicate recording on the registrationClient for the variant that is no longer invoked by AbstractProtocolAdapterBase ...", "author": "sophokles73", "createdAt": "2020-09-15T14:09:15Z", "path": "service-base/src/test/java/org/eclipse/hono/service/AbstractProtocolAdapterBaseTest.java", "diffHunk": "@@ -359,20 +358,15 @@ public void testGetRegistrationAssertionSucceedsForExistingDevice(final VertxTes\n         when(registrationClient.assertRegistration(eq(\"device\"), any())).thenReturn(Future.succeededFuture(assertionResult));\n         when(registrationClient.assertRegistration(eq(\"device\"), any(), any())).thenReturn(Future.succeededFuture(assertionResult));\n \n-        final Checkpoint assertion = ctx.checkpoint();\n         // WHEN an assertion for the device is retrieved\n         adapter.getRegistrationAssertion(\"tenant\", \"device\", null, mock(SpanContext.class))\n-                .onComplete(ctx.succeeding(result -> ctx.verify(() -> {\n-            // THEN the result contains the registration assertion\n-            assertEquals(assertionResult, result);\n-            assertion.flag();\n-        })));\n-        adapter.getRegistrationAssertion(\"tenant\", \"device\", null, mock(SpanContext.class))\n-                .onComplete(ctx.succeeding(result -> ctx.verify(() -> {\n-            // THEN the result contains the registration assertion\n-            assertEquals(assertionResult, result);\n-            assertion.flag();\n-        })));\n+                .onComplete(ctx.succeeding(result -> {", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY5OTEyNQ==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488699125", "bodyText": "see above, remove duplicate recording ...", "author": "sophokles73", "createdAt": "2020-09-15T14:10:19Z", "path": "service-base/src/test/java/org/eclipse/hono/service/AbstractProtocolAdapterBaseTest.java", "diffHunk": "@@ -390,20 +384,15 @@ public void testGetRegistrationAssertionFailsWith404ForNonExistingDevice(final V\n         when(registrationClient.assertRegistration(eq(\"non-existent\"), any(), any())).thenReturn(\n                 Future.failedFuture(new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND)));\n \n-        final Checkpoint assertion = ctx.checkpoint();\n         // WHEN an assertion for a non-existing device is retrieved\n         adapter.getRegistrationAssertion(\"tenant\", \"non-existent\", null, mock(SpanContext.class))\n-                .onComplete(ctx.failing(t -> ctx.verify(() -> {\n-            // THEN the request fails with a 404\n-            assertEquals(HttpURLConnection.HTTP_NOT_FOUND, ((ServiceInvocationException) t).getErrorCode());\n-            assertion.flag();\n-        })));\n-        adapter.getRegistrationAssertion(\"tenant\", \"non-existent\", null, mock(SpanContext.class))\n-                .onComplete(ctx.failing(t -> ctx.verify(() -> {\n-            // THEN the request fails with a 404\n-            assertEquals(HttpURLConnection.HTTP_NOT_FOUND, ((ServiceInvocationException) t).getErrorCode());\n-            assertion.flag();\n-        })));\n+                .onComplete(ctx.failing(t -> {", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDYxMw==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488700613", "bodyText": "why should this change be necessary?", "author": "sophokles73", "createdAt": "2020-09-15T14:12:23Z", "path": "service-base/src/test/java/org/eclipse/hono/service/VertxBasedHealthCheckServerTest.java", "diffHunk": "@@ -99,7 +99,7 @@ void testHealthCheckServerWithInsecureEndpoint(final Vertx vertx, final VertxTes\n             .map(ok -> getWebClient(vertx, server, false))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/liveness\"))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/readiness\"))\n-            .onComplete(ctx.completing());\n+            .onComplete(ctx.succeeding(v -> testsDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1Nzg5Nw==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488857897", "bodyText": "Because registerHealthChecks(ctx, server, 1); a few lines above creates checkpoints (1 is the number of checkpoint passes).\nI've now renamed the method to registerHealthCheckCheckpoints to make this more obvious.", "author": "calohmn", "createdAt": "2020-09-15T17:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4NTEyNw==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r489185127", "bodyText": "Ah, my bad, didn't see that ...", "author": "sophokles73", "createdAt": "2020-09-16T06:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDg2OQ==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488700869", "bodyText": "why should this change be necessary?", "author": "sophokles73", "createdAt": "2020-09-15T14:12:43Z", "path": "service-base/src/test/java/org/eclipse/hono/service/VertxBasedHealthCheckServerTest.java", "diffHunk": "@@ -128,7 +129,7 @@ void testHealthCheckServerWithSecureEndpoint(final Vertx vertx, final VertxTestC\n             .map(ok -> getWebClient(vertx, server, true))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/liveness\"))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/readiness\"))\n-            .onComplete(ctx.completing());\n+            .onComplete(ctx.succeeding(v -> testsDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1ODQ1Mg==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488858452", "bodyText": "Because of the registerHealthChecks invocation before - see obvious.", "author": "calohmn", "createdAt": "2020-09-15T17:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDg2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4NTE4OA==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r489185188", "bodyText": "I see", "author": "sophokles73", "createdAt": "2020-09-16T06:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMDg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMTAwOA==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488701008", "bodyText": "why should this change be necessary?", "author": "sophokles73", "createdAt": "2020-09-15T14:12:54Z", "path": "service-base/src/test/java/org/eclipse/hono/service/VertxBasedHealthCheckServerTest.java", "diffHunk": "@@ -158,7 +160,7 @@ void testHealthCheckServerWithSecureAndInsecureEndpoint(final Vertx vertx, final\n             .compose(result -> Future.succeededFuture(getWebClient(vertx, server, false)))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/liveness\"))\n             .compose(httpClient -> checkHealth(ctx, httpClient, \"/readiness\"))\n-            .onComplete(ctx.completing());\n+            .onComplete(ctx.succeeding(v -> testsDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1ODUwMg==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488858502", "bodyText": "Because of the registerHealthChecks invocation before - see obvious.", "author": "calohmn", "createdAt": "2020-09-15T17:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMTAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4NTIyOQ==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r489185229", "bodyText": "I see", "author": "sophokles73", "createdAt": "2020-09-16T06:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMTAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMTkyNg==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488701926", "bodyText": "nice catch \ud83d\udc4d", "author": "sophokles73", "createdAt": "2020-09-15T14:14:08Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/CommandAndControlAmqpIT.java", "diffHunk": "@@ -169,7 +170,7 @@ private void connectAndSubscribe(\n                 recv.flow(50);\n                 return null;\n             }))\n-        .onComplete(setup.completing());\n+        .onComplete(setup.succeeding(v -> setupDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMzk0MA==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488703940", "bodyText": "nice catch", "author": "sophokles73", "createdAt": "2020-09-15T14:16:46Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/CommandAndControlAmqpIT.java", "diffHunk": "@@ -535,7 +538,7 @@ public void testSendCommandFailsForMalformedMessage(\n             preconditions.flag();\n             return s;\n         })\n-        .onComplete(setup.completing());\n+        .onComplete(setup.succeeding(v -> setupDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwNDE5NQ==", "url": "https://github.com/eclipse/hono/pull/2178#discussion_r488704195", "bodyText": "nice catch", "author": "sophokles73", "createdAt": "2020-09-15T14:17:04Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/CommandAndControlAmqpIT.java", "diffHunk": "@@ -609,7 +613,7 @@ public void testSendCommandFailsWhenNoCredit(\n                 recv.flow(1); // just give 1 initial credit\n                 return null;\n             }))\n-        .onComplete(setup.completing());\n+        .onComplete(setup.succeeding(v -> setupDone.flag()));", "originalCommit": "3fd176c78ead2def32c32707fb83e5d82e8c3cbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0600e45d92a10cd453351dac38393019be672edd", "url": "https://github.com/eclipse/hono/commit/0600e45d92a10cd453351dac38393019be672edd", "message": "Use VertxTestContext checkpoints consistently.\n\nWhen using checkpoints, tests should not rely on\ncontext.completeNow() to be called as the checkpoints\nalready complete the context.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-15T17:53:29Z", "type": "commit"}, {"oid": "0600e45d92a10cd453351dac38393019be672edd", "url": "https://github.com/eclipse/hono/commit/0600e45d92a10cd453351dac38393019be672edd", "message": "Use VertxTestContext checkpoints consistently.\n\nWhen using checkpoints, tests should not rely on\ncontext.completeNow() to be called as the checkpoints\nalready complete the context.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-15T17:53:29Z", "type": "forcePushed"}]}