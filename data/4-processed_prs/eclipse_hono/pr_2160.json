{"pr_number": 2160, "pr_title": "Fix command delivery not getting released, improve tracing", "pr_createdAt": "2020-09-07T08:33:18Z", "pr_url": "https://github.com/eclipse/hono/pull/2160", "timeline": [{"oid": "2299ac5faf184386bbd57a9e0ea76fdc3ea7c6e7", "url": "https://github.com/eclipse/hono/commit/2299ac5faf184386bbd57a9e0ea76fdc3ea7c6e7", "message": "[#2155] Fix command delivery not getting released.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-07T08:22:13Z", "type": "commit"}, {"oid": "268728a32bdbb6c50e9d843b31778ecc433abec3", "url": "https://github.com/eclipse/hono/commit/268728a32bdbb6c50e9d843b31778ecc433abec3", "message": "Improve Command & Control related tracing (CoAP).\n\nThe CoAP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-07T08:27:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ==", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484307989", "bodyText": "Is that change from tenantValidationTracker to tenantTracker intended?", "author": "boaks", "createdAt": "2020-09-07T09:25:05Z", "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/AbstractVertxBasedCoapAdapter.java", "diffHunk": "@@ -745,15 +749,16 @@ protected final String getAuthId(final CoapExchange exchange) {\n             return CompositeFuture.join(senderTracker, commandConsumerTracker)\n             .compose(ok -> {\n                 final DownstreamSender sender = senderTracker.result();\n-                final Integer ttd = ttdTracker.result();\n+                final Integer ttd = Optional.ofNullable(commandConsumerTracker.result())\n+                        .map(c -> ttdTracker.result())\n+                        .orElse(null);\n                 final Message downstreamMessage = newMessage(\n                         context.getRequestedQos(),\n-                        ResourceIdentifier.from(endpoint.getCanonicalName(), context.getOriginDevice().getTenantId(),\n-                                context.getOriginDevice().getDeviceId()),\n+                        ResourceIdentifier.from(endpoint.getCanonicalName(), tenantId, deviceId),\n                         \"/\" + context.getExchange().getRequestOptions().getUriPathString(),\n                         contentType,\n                         payload,\n-                        tenantValidationTracker.result(),\n+                        tenantTracker.result(),", "originalCommit": "268728a32bdbb6c50e9d843b31778ecc433abec3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMxNzM1Ng==", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484317356", "bodyText": "Yes. It makes the code more in line with the corresponding code from the HTTP adapter and makes it more obvious that it is about the returned TenantObject here. In the following lines the tenant object is accessed via tenantTracker.result() as well.", "author": "calohmn", "createdAt": "2020-09-07T09:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5NDA5Mg==", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484694092", "bodyText": "Is there a test, which demonstrates, that a failure in tenantValidationTracker is handled proper by that code?", "author": "boaks", "createdAt": "2020-09-08T07:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNDIxNw==", "url": "https://github.com/eclipse/hono/pull/2160#discussion_r484704217", "bodyText": "A failure in the tenantValidationTracker would cause the ttdTracker to fail and subsequently the commandConsumerTracker. A failed commandConsumerTracker will cause the above code block (sending the telemetry/event message) to not be entered anyway.\nA unit test in which a failed tenantValidationTracker is tested is AbstractVertxBasedCoapAdapterTest#testMessageLimitExceededForAnEventMessage.", "author": "calohmn", "createdAt": "2020-09-08T07:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwNzk4OQ=="}], "type": "inlineReview"}]}