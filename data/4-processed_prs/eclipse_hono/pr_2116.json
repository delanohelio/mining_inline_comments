{"pr_number": 2116, "pr_title": "[#2112] Add search devices operation in MongoDB based device registry", "pr_createdAt": "2020-08-18T08:16:35Z", "pr_url": "https://github.com/eclipse/hono/pull/2116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NTc5OQ==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472195799", "bodyText": "I have changed the searchDevices method signature to no longer use Optional around the filters and sort options. Can you please adapt your code accordingly?", "author": "sophokles73", "createdAt": "2020-08-18T13:27:44Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedDeviceBackend.java", "diffHunk": "@@ -77,6 +80,16 @@ public MongoDbBasedDeviceBackend(\n         return registrationService.readDevice(tenantId, deviceId, span);\n     }\n \n+    @Override\n+    public Future<OperationResult<List<DeviceWithId>>> searchDevices(final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final Optional<List<Filter>> filters,\n+            final Optional<List<Sort>> sortOptions,\n+            final Span span) {", "originalCommit": "2281374b607b484b401d70245eb752d0cbebb6e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMDQxMA==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472220410", "bodyText": "I have adapted the code according and pushed my changes.", "author": "kaniyan", "createdAt": "2020-08-18T14:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NTc5OQ=="}], "type": "inlineReview"}, {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4", "url": "https://github.com/eclipse/hono/commit/6de3ede629c0300792e4da27c880777f34ee13f4", "message": "[#2112] Add search devices operation in MongoDB based device registry\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-08-18T14:00:23Z", "type": "commit"}, {"oid": "6de3ede629c0300792e4da27c880777f34ee13f4", "url": "https://github.com/eclipse/hono/commit/6de3ede629c0300792e4da27c880777f34ee13f4", "message": "[#2112] Add search devices operation in MongoDB based device registry\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-08-18T14:00:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY5NQ==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224695", "bodyText": "this should be put into a\nif (LOG.isTraceEnabled()) {\n}\n\nblock in order to prevent serialization of query and sort documents if not required", "author": "sophokles73", "createdAt": "2020-08-18T14:07:38Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(\n+            final String tenantId,\n+            final int pageSize,\n+            final int pageOffset,\n+            final List<Filter> filters,\n+            final List<Sort> sortOptions) {\n+\n+        final FindOptions searchDevicesOptions = new FindOptions()\n+                .setLimit(pageSize)\n+                .setSkip(pageOffset);\n+        final JsonObject searchDevicesQuery = MongoDbDocumentBuilder.builder()\n+                .withTenantId(tenantId)\n+                .withDeviceFilters(filters)\n+                .document();\n+        final JsonObject sortDocument = MongoDbDocumentBuilder.builder()\n+                .withDeviceSortOptions(sortOptions)\n+                .document();\n+        final Promise<List<JsonObject>> searchDevicesPromise = Promise.promise();\n+\n+        searchDevicesOptions.setSort(sortDocument);\n+        LOG.trace(\"pageSize: [{}], pageOffset: [{}], searchDevicesQuery: [{}], sortOptions: [{}]\", pageSize, pageOffset,", "originalCommit": "6de3ede629c0300792e4da27c880777f34ee13f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0NzcxMg==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472247712", "bodyText": "I have incorporated it and pushed the changes.", "author": "kaniyan", "createdAt": "2020-08-18T14:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDk0NA==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472224944", "bodyText": "is there any value in creating this private method with exactly the same signature as searchDevices instead of simply implementing searchDevices directly?", "author": "sophokles73", "createdAt": "2020-08-18T14:08:00Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -333,6 +354,53 @@ private RegistrationResult getRegistrationResult(final String deviceId, final Js\n                 });\n     }\n \n+    private Future<OperationResult<List<DeviceWithId>>> processSearchDevices(", "originalCommit": "6de3ede629c0300792e4da27c880777f34ee13f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzMDYyOA==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472230628", "bodyText": "As the code is already compact, IMHO there is no benefit or drawback. I just followed the same style as of other methods in that class.", "author": "kaniyan", "createdAt": "2020-08-18T14:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNDk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNjU0OA==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472226548", "bodyText": "does this also cover indexes into arrays, i.e. something like /myJsonArray/1 to address the second element of a JSON array?", "author": "sophokles73", "createdAt": "2020-08-18T14:10:18Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),", "originalCommit": "6de3ede629c0300792e4da27c880777f34ee13f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0MjMzMg==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472242332", "bodyText": "yes, it covers arrays too. For example  /myJsonArray/1 is translated to device.myJsonArray.1 as required by the MongoDB search operation.", "author": "kaniyan", "createdAt": "2020-08-18T14:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNjU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNzE4OQ==", "url": "https://github.com/eclipse/hono/pull/2116#discussion_r472227189", "bodyText": "static?", "author": "sophokles73", "createdAt": "2020-08-18T14:11:10Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/utils/MongoDbDocumentBuilder.java", "diffHunk": "@@ -126,4 +131,54 @@ public MongoDbDocumentBuilder withAuthId(final String authId) {\n         document.put(FIELD_CREDENTIALS_AUTH_ID_KEY, authId);\n         return this;\n     }\n+\n+\n+    /**\n+     * Sets the json object with the given device filters.\n+     *\n+     * @param filters The device filters list.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceFilters(final List<Filter> filters) {\n+\n+        filters.forEach(filter -> {\n+            // TODO: To implement when filter values contain patterns such as * or %\n+            if (FIELD_ID.equals(filter.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID, filter.getValue());\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + filter.getField().toString().replace(\"/\", \".\"),\n+                        filter.getValue());\n+            }\n+        });\n+\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the json object with the given sorting options.\n+     *\n+     * @param sortOptions The list of soring options.\n+     * @return a reference to this for fluent use.\n+     */\n+    public MongoDbDocumentBuilder withDeviceSortOptions(final List<Sort> sortOptions) {\n+\n+        sortOptions.forEach(sortOption -> {\n+            if (FIELD_ID.equals(sortOption.getField())) {\n+                document.put(RegistryManagementConstants.FIELD_PAYLOAD_DEVICE_ID,\n+                        mapSortingDirection(sortOption.getDirection()));\n+            } else {\n+                document.put(MongoDbDeviceRegistryUtils.FIELD_DEVICE + \".\" + sortOption.getField(),\n+                        mapSortingDirection(sortOption.getDirection()));\n+            }\n+        });\n+        return this;\n+    }\n+\n+    private int mapSortingDirection(final Sort.Direction direction) {", "originalCommit": "6de3ede629c0300792e4da27c880777f34ee13f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7470b2f859e3890726605bdab6cf551f5de35bde", "url": "https://github.com/eclipse/hono/commit/7470b2f859e3890726605bdab6cf551f5de35bde", "message": "Changes related to review comments\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-08-18T14:37:10Z", "type": "commit"}]}