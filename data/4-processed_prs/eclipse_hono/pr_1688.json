{"pr_number": 1688, "pr_title": "[#1687] Close root span if connection got closed prematurely", "pr_createdAt": "2020-01-03T14:42:27Z", "pr_url": "https://github.com/eclipse/hono/pull/1688", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTE0MQ==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363205141", "bodyText": "can we merge this with the previous message being logged to the current span?", "author": "sophokles73", "createdAt": "2020-01-06T08:57:04Z", "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -860,18 +879,21 @@ protected Integer getTimeUntilDisconnectFromRequest(final RoutingContext ctx) {\n      * @param deviceId The identifier of the device.\n      * @param currentSpan The <em>OpenTracing</em> Span used for tracking the processing of the request.\n      */\n-    private void addConnectionCloseHandler(\n+    private void setTtdRequestConnectionCloseHandler(\n             final RoutingContext ctx,\n             final MessageConsumer messageConsumer,\n             final String tenantId,\n             final String deviceId,\n             final Span currentSpan) {\n \n-        if (messageConsumer != null && !ctx.response().closed()) {\n+        if (messageConsumer != null && !ctx.response().closed() && !ctx.response().ended()) {\n             ctx.response().closeHandler(v -> {\n                 log.debug(\"device [tenant: {}, device-id: {}] closed connection before response could be sent\",\n                         tenantId, deviceId);\n                 currentSpan.log(\"device closed connection\");\n+                TracingHelper.logError(currentSpan, \"cannot send HTTP response to device: response already closed\");", "originalCommit": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNTg5OQ==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363205899", "bodyText": "this handler seems to be useful/required for any request, not just TTD requests, doesn't it?", "author": "sophokles73", "createdAt": "2020-01-06T08:59:39Z", "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -860,18 +879,21 @@ protected Integer getTimeUntilDisconnectFromRequest(final RoutingContext ctx) {\n      * @param deviceId The identifier of the device.\n      * @param currentSpan The <em>OpenTracing</em> Span used for tracking the processing of the request.\n      */\n-    private void addConnectionCloseHandler(\n+    private void setTtdRequestConnectionCloseHandler(", "originalCommit": "4bc36d61527f6ae0f1d1ae0839f8f388b93834e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de081f735d826141aa68cc35dc369ca70c53e001", "url": "https://github.com/eclipse/hono/commit/de081f735d826141aa68cc35dc369ca70c53e001", "message": "[#1687] Close root span if connection got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>", "committedDate": "2020-01-06T13:20:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI5ODgzOQ==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363298839", "bodyText": "the close handler that is set here will be overwritten later by the doUploadMessage method, right?\nWhy don't we set a failure Handler here instead which finishes the root span and modify the doUploadMessage method to fail the RoutingContext e.g. with an IllegalStateException if the request is being closed before we can send the response or if sending the response fails?", "author": "sophokles73", "createdAt": "2020-01-06T13:46:44Z", "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -315,16 +316,24 @@ protected Router createRouter() {\n         final TracingHandler tracingHandler = createTracingHandler();\n         matchAllRoute.handler(tracingHandler).failureHandler(tracingHandler);\n \n-        // 3. default handler for failed routes\n+        // 3. handler to ensure tracing root span is finished if the request gets closed prematurely\n+        matchAllRoute.handler(ctx -> {\n+            if (!ctx.response().closed() && !ctx.response().ended()) {\n+                ctx.response().closeHandler(v -> finishRootSpanOnResponseGettingClosedPrematurely(ctx));", "originalCommit": "de081f735d826141aa68cc35dc369ca70c53e001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMwNjk5OA==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363306998", "bodyText": "the close handler that is set here will be overwritten later by the doUploadMessage method, right?\n\nYes, that's intended.\n\nWhy don't we set a failure Handler here instead which finishes the root span and modify the doUploadMessage method to fail the RoutingContext e.g. with an IllegalStateException if the request is being closed before we can send the response or if sending the response fails?\n\nHmm, I'll think about that. I'm currently doing some more testing.", "author": "calohmn", "createdAt": "2020-01-06T14:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI5ODgzOQ=="}], "type": "inlineReview"}, {"oid": "ce2305fa040fa360a277a2764e297061b349e0ed", "url": "https://github.com/eclipse/hono/commit/ce2305fa040fa360a277a2764e297061b349e0ed", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>", "committedDate": "2020-01-06T15:05:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MzQyMw==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363343423", "bodyText": "shouldn't this better be part of the condition in the first if statement?", "author": "sophokles73", "createdAt": "2020-01-06T15:31:49Z", "path": "service-base/src/main/java/org/eclipse/hono/service/http/HttpUtils.java", "diffHunk": "@@ -181,7 +181,7 @@ public static void failWithHeaders(\n         if (ctx.failed() || ctx.response().ended()) {\n             // nothing to do\n         } else {\n-            if (headers != null) {\n+            if (headers != null && !ctx.response().closed()) {", "originalCommit": "ce2305fa040fa360a277a2764e297061b349e0ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM2OTM2Nw==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363369367", "bodyText": "No, if the response is closed but not failed/ended yet, the fail method should get called here (which then also causes the TracingHandler failureHandler to get called).\nThe extra closed check above is to ensure that the putHeader invocation doesn't throw an exception. It would do so for a closed response using Vert.x 3.7.1 (Hono 1.0). In Vert.x 3.8.4 (Hono master) this check isn't strictly needed any more, but I think the extra condition doesn't hurt here.", "author": "calohmn", "createdAt": "2020-01-06T16:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MzQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzMTI5Mg==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363631292", "bodyText": "I see, then adding a corresponding comment would improve readability a lot here FMPOV.", "author": "sophokles73", "createdAt": "2020-01-07T08:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MzQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzODY3MQ==", "url": "https://github.com/eclipse/hono/pull/1688#discussion_r363638671", "bodyText": "Yes, I've added comments.", "author": "calohmn", "createdAt": "2020-01-07T08:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM0MzQyMw=="}], "type": "inlineReview"}, {"oid": "f9f64e4ebb147e63c89305ca6243f49d5f871e06", "url": "https://github.com/eclipse/hono/commit/f9f64e4ebb147e63c89305ca6243f49d5f871e06", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>", "committedDate": "2020-01-07T08:33:16Z", "type": "commit"}, {"oid": "f9f64e4ebb147e63c89305ca6243f49d5f871e06", "url": "https://github.com/eclipse/hono/commit/f9f64e4ebb147e63c89305ca6243f49d5f871e06", "message": "[#1687] Ensure response is ended if it got closed prematurely.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch-si.com>", "committedDate": "2020-01-07T08:33:16Z", "type": "forcePushed"}]}