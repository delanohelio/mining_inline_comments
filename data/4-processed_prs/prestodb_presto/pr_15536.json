{"pr_number": 15536, "pr_title": "Fixes for file renaming and manifest features", "pr_createdAt": "2020-12-16T23:34:59Z", "pr_url": "https://github.com/prestodb/presto/pull/15536", "timeline": [{"oid": "b886ccfb14659d837aa9b5364de362997923d16d", "url": "https://github.com/prestodb/presto/commit/b886ccfb14659d837aa9b5364de362997923d16d", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-17T17:56:50Z", "type": "forcePushed"}, {"oid": "ee36cea20acd766b3362b29ccac87825b1e65847", "url": "https://github.com/prestodb/presto/commit/ee36cea20acd766b3362b29ccac87825b1e65847", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-17T18:10:08Z", "type": "forcePushed"}, {"oid": "a07fe5c7023711bf055ab1b83838ce41246cef31", "url": "https://github.com/prestodb/presto/commit/a07fe5c7023711bf055ab1b83838ce41246cef31", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-18T23:07:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMzU3MQ==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546933571", "bodyText": "Without file renaming, how did we sort bucket file names before? Do we append 0s in front of file names?", "author": "highker", "createdAt": "2020-12-21T21:16:52Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/StoragePartitionLoader.java", "diffHunk": "@@ -346,8 +348,23 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n                             partitionName));\n         }\n \n-        // Sort FileStatus objects (instead of, e.g., fileStatus.getPath().toString). This matches org.apache.hadoop.hive.ql.metadata.Table.getSortedPaths\n-        fileInfos.sort(null);\n+        if (fileInfos.get(0).getPath().getName().matches(\"\\\\d+\")) {", "originalCommit": "47918eae68bd4b4a2970b2205d31d8c1ad4c7e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk5MTU4OA==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546991588", "bodyText": "Yes correct. We append 0s in front.", "author": "NikhilCollooru", "createdAt": "2020-12-21T23:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMzU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMzg2Nw==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546933867", "bodyText": "leave the first param to its own line", "author": "highker", "createdAt": "2020-12-21T21:17:37Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -112,17 +112,36 @@ public static long getFileSize(Page statisticsPage, int position)\n         ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n         List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n \n+        if (!partitionUpdate.containsNumberedFileNames()) {\n+            // Filenames starting with \".tmp.presto\" will be renamed in TableFinishOperator. So it doesn't make sense to store the filenames in manifest\n+            return metadata;\n+        }\n+\n         // Sort the file infos based on fileName\n         fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n \n+        List<String> fileNames = fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList());\n+        List<Long> fileSizes = fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList());\n+\n+        if (fileSizes.size() < fileNames.size()) {\n+            if (fileSizes.size() == 0) {\n+                // These files may not have been written by OrcFileWriter. So file sizes not available.\n+                return metadata;\n+            }\n+            throw new PrestoException(\n+                    MALFORMED_HIVE_FILE_STATISTICS,\n+                    format(\"During manifest creation for partition= %s, filename count= %s is not equal to filesizes count= %s\",", "originalCommit": "a2d199d6b88039219dfe55cc92a8c05f6aaba5a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzNDE3Mw==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546934173", "bodyText": "fileSizes.isEmpty()", "author": "highker", "createdAt": "2020-12-21T21:18:24Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -112,17 +112,36 @@ public static long getFileSize(Page statisticsPage, int position)\n         ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n         List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n \n+        if (!partitionUpdate.containsNumberedFileNames()) {\n+            // Filenames starting with \".tmp.presto\" will be renamed in TableFinishOperator. So it doesn't make sense to store the filenames in manifest\n+            return metadata;\n+        }\n+\n         // Sort the file infos based on fileName\n         fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n \n+        List<String> fileNames = fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList());\n+        List<Long> fileSizes = fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList());\n+\n+        if (fileSizes.size() < fileNames.size()) {\n+            if (fileSizes.size() == 0) {", "originalCommit": "a2d199d6b88039219dfe55cc92a8c05f6aaba5a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzNDk5Ng==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546934996", "bodyText": "why we need a new ArrayList?", "author": "highker", "createdAt": "2020-12-21T21:20:34Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -148,6 +150,18 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());", "originalCommit": "cfdb06a65b9502515f42bbb1ed3f4bda415e87da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzODc4NQ==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546938785", "bodyText": "This is duplicated logic. We can directly get the size info from extraPartitionMetadata in HiveMetadata.finishInsert. No need to compute it again.", "author": "highker", "createdAt": "2020-12-21T21:30:21Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -148,6 +150,18 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();", "originalCommit": "cfdb06a65b9502515f42bbb1ed3f4bda415e87da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "042b82c5546d367f4070ebccc7440df94a906294", "url": "https://github.com/prestodb/presto/commit/042b82c5546d367f4070ebccc7440df94a906294", "message": "Fix sorting file names for bucketed splits", "committedDate": "2020-12-21T23:59:24Z", "type": "commit"}, {"oid": "d11cb74a86c741d652391542c022e3bcec698332", "url": "https://github.com/prestodb/presto/commit/d11cb74a86c741d652391542c022e3bcec698332", "message": "Add containsNumberedFileNames to PartitionUpdate", "committedDate": "2020-12-21T23:59:24Z", "type": "commit"}, {"oid": "f66e653af7653552cbe9e9e2f4b5a52855364d52", "url": "https://github.com/prestodb/presto/commit/f66e653af7653552cbe9e9e2f4b5a52855364d52", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-21T23:59:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDY4Mg==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547040682", "bodyText": "createPartitionManifest is actually not used anymore. I guess we can remove it", "author": "highker", "createdAt": "2020-12-22T03:02:28Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }\n+            List<FileWriteInfo> fileWriteInfos = partitionUpdate.getFileWriteInfos();\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();\n+        }\n+\n+        Optional<Page> manifestBlob = createPartitionManifest(partitionUpdate);", "originalCommit": "f04e97e1cc48fb1f1bc2320277098f987958b6d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDc3OQ==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547040779", "bodyText": "We don't need this part, this is duplication with updatePartitionMetadataWithFileNamesAndSizes", "author": "highker", "createdAt": "2020-12-22T03:02:55Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }\n+            List<FileWriteInfo> fileWriteInfos = partitionUpdate.getFileWriteInfos();\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();", "originalCommit": "f04e97e1cc48fb1f1bc2320277098f987958b6d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2ODAyOA==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547468028", "bodyText": "updatePartitionMetadataWithFileNamesAndSizes gets called only when hive.prefer-manifests-to-list-files and file_renaming are enabled. But i want to track the manifest size even when just file_renaming is enabled. Hence this logic is needed  here as well. compressFileNames() will be invoked only once. Either in updatePartitionMetadataWithFileNamesAndSizes or here.", "author": "NikhilCollooru", "createdAt": "2020-12-22T19:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTEwMA==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041100", "bodyText": "We just check if the extra params contains MANIFEST_VERSION. If yes, we sum up the values' lengths for FILE_NAMES and FILE_SIZES.", "author": "highker", "createdAt": "2020-12-22T03:04:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }", "originalCommit": "f04e97e1cc48fb1f1bc2320277098f987958b6d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTEyNA==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041124", "bodyText": "return optional long", "author": "highker", "createdAt": "2020-12-22T03:04:22Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)", "originalCommit": "f04e97e1cc48fb1f1bc2320277098f987958b6d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTIwMQ==", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041201", "bodyText": "Only add to the stats if it's not optional empty.", "author": "highker", "createdAt": "2020-12-22T03:04:39Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1941,10 +1940,8 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                     extraPartitionMetadata = updatePartitionMetadataWithFileNamesAndSizes(partitionUpdate, extraPartitionMetadata);\n                 }\n \n-                // TODO: Put the manifest blob in partition parameters\n                 // Track the manifest blob size\n-                Optional<Page> manifestBlob = createPartitionManifest(partitionUpdate);\n-                manifestBlob.ifPresent(manifest -> hivePartitionStats.addManifestSizeInBytes(manifest.getRetainedSizeInBytes()));\n+                hivePartitionStats.addManifestSizeInBytes(getManifestSizeInBytes(session, partitionUpdate, extraPartitionMetadata));", "originalCommit": "f04e97e1cc48fb1f1bc2320277098f987958b6d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a283052e94021706eaaab601d7883ae8e8e85115", "url": "https://github.com/prestodb/presto/commit/a283052e94021706eaaab601d7883ae8e8e85115", "message": "Track compressed manifest size when file_renaming is enabled", "committedDate": "2020-12-22T19:52:45Z", "type": "commit"}, {"oid": "fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "url": "https://github.com/prestodb/presto/commit/fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-22T19:53:07Z", "type": "commit"}, {"oid": "fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "url": "https://github.com/prestodb/presto/commit/fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "message": "Store manifest only when they are preferred and file renaming is enabled", "committedDate": "2020-12-22T19:53:07Z", "type": "forcePushed"}]}