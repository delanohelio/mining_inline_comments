{"pr_number": 14286, "pr_title": "Reuse buffers in OptimizedPartitionedOutputOperator - part 2 : byte[] buffers in BlockEncodingBuffer", "pr_createdAt": "2020-03-24T09:22:54Z", "pr_url": "https://github.com/prestodb/presto/pull/14286", "timeline": [{"oid": "fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "url": "https://github.com/prestodb/presto/commit/fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-24T10:41:02Z", "type": "forcePushed"}, {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "url": "https://github.com/prestodb/presto/commit/b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-24T10:46:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397129535", "bodyText": "Do we really need this new parameter here? resetBuffer() seems to be signaling the same condition. Can't values buffer be release in resetBuffers()?", "author": "mbasmanova", "createdAt": "2020-03-24T12:54:54Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/BlockEncodingBuffer.java", "diffHunk": "@@ -50,8 +50,9 @@\n \n     /**\n      * Signals that this is the last batch in this page, so that the internal buffers in BlockEncodingBuffers can recycled.\n+     * @param bufferFull\n      */\n-    void noMoreBatches();\n+    void noMoreBatches(boolean bufferFull);", "originalCommit": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNjIyNA==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397526224", "bodyText": "@mbasmanova There are two conditions that have to be met to recycle these buffers: 1) bufferFull == true (just flushed);  2) This is the last batch in this page. If condition 2) is not met, the buffers are still needed for the next batch in the same page. Even if we returned these buffers if only 1) is met, the next batch would borrow these buffers again for the same partition. Borrowing/Returning the buffers are not free because of the Deque and Set operations are expensive. Therefore we only want to recycle the buffers when both of these two conditions are met. resetBuffer() only happens when flushing, but it doesn't guarantee that it's the last batch. Another way to do this is to signal the lastBatchInPage in flush(lastBatchInPage) but since we have done it in the finally section for the int[] buffers, I think it's better to do it the same way at the same place for the byte[] buffers.", "author": "yingsu00", "createdAt": "2020-03-24T23:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMTAyMw==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397531023", "bodyText": "@yingsu00 Thanks for explaining. Sounds like the object itself can figure out whether bufferFull is true or not, e.g. it can set a internal flag in resetBuffer, use it in noMoreBatches and reset it in setupDecodedBlocksAndPositions.", "author": "mbasmanova", "createdAt": "2020-03-24T23:53:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzNDAwNg==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397534006", "bodyText": "@mbasmanova I see. This requires adding an internal flag in AbstractBlockEncodingBuffer to signal if the buffers are just flushed or not. I'll make the change as you suggested.", "author": "yingsu00", "createdAt": "2020-03-25T00:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1NDk1Nw==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397554957", "bodyText": "@mbasmanova I just updated the PR using the way you suggested. One thing to mention is that I realized that we can't reset the flushed flag in setupDecodedBlocksAndPositions(), but instead, it has to be reset at the beginning of the do...while loop e.g. setNextBatch. Every batch needs to begin with the not-flushed state. Other than this, other changes were the same as you suggested. Thanks for reviewing and bringing up the valuable suggestion!", "author": "yingsu00", "createdAt": "2020-03-25T01:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ=="}], "type": "inlineReview"}, {"oid": "d7f5797a8e0510d9dbba3119ce4943724dc53cbf", "url": "https://github.com/prestodb/presto/commit/d7f5797a8e0510d9dbba3119ce4943724dc53cbf", "message": "Return arrays in reverse order of borrowing\n\nOptimizedPartitionedOutputOperator uses SimpleArrayAllocator to reuse\nint arrays. SimpleArrayAllocator works in stack mode that most recently\nreturned array would be borrowed out first next. To avoid unnecessary\nmemory allocations due by mismatch between borrow and return order,\nmake sure to return arrays in reverse order of borrowing.", "committedDate": "2020-03-24T23:48:12Z", "type": "commit"}, {"oid": "9c48ca60564823bc8f58ed0b35510b9185feef69", "url": "https://github.com/prestodb/presto/commit/9c48ca60564823bc8f58ed0b35510b9185feef69", "message": "Add byte[] support to ArrayAllocator", "committedDate": "2020-03-24T23:48:26Z", "type": "commit"}, {"oid": "feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "url": "https://github.com/prestodb/presto/commit/feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-24T23:48:29Z", "type": "forcePushed"}, {"oid": "c492bc6bf5a6c8d435115430a494fb808fb82aed", "url": "https://github.com/prestodb/presto/commit/c492bc6bf5a6c8d435115430a494fb808fb82aed", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-25T01:09:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU3OTYwNA==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r398579604", "bodyText": "@yingsu00 debugging leftovers?", "author": "mbasmanova", "createdAt": "2020-03-26T13:40:56Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/LongArrayBlockEncodingBuffer.java", "diffHunk": "@@ -72,7 +71,12 @@ public void serializeTo(SliceOutput output)\n         serializeNullsTo(output);\n \n         if (valuesBufferIndex > 0) {\n-            output.appendBytes(valuesBuffer, 0, valuesBufferIndex);\n+            try {\n+                output.appendBytes(valuesBuffer, 0, valuesBufferIndex);\n+            }\n+            catch (Exception e) {\n+                e.printStackTrace();", "originalCommit": "c492bc6bf5a6c8d435115430a494fb808fb82aed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1MzY3Mg==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r398953672", "bodyText": "@mbasmanova Yes, I'm sorry about it. I checked there're no other debugging leftovers in this PR. Thanks for catching this!", "author": "yingsu00", "createdAt": "2020-03-26T23:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU3OTYwNA=="}], "type": "inlineReview"}, {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286", "url": "https://github.com/prestodb/presto/commit/edb40d5607f1e15c06c3d343b1638875b77f5286", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-26T23:32:24Z", "type": "commit"}, {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286", "url": "https://github.com/prestodb/presto/commit/edb40d5607f1e15c06c3d343b1638875b77f5286", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.", "committedDate": "2020-03-26T23:32:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzMzI1OQ==", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r399233259", "bodyText": "nit: consider adding a helper method to reduce copy-paste\nsliceBuffer = returnArray(sliceBuffer, bufferAllocator);\n\n\nint[] returnArray(int[] array, ArrayAllocator arrayAllocator)\n{\n   if (array != null) {\n       arrayAllocator.returnArray(array);\n   }\n   return null;\n}", "author": "mbasmanova", "createdAt": "2020-03-27T12:36:56Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/VariableWidthBlockEncodingBuffer.java", "diffHunk": "@@ -125,16 +124,32 @@ public void resetBuffers()\n         sliceBufferIndex = 0;\n         offsetsBufferIndex = 0;\n         lastOffset = 0;\n+        flushed = true;\n         resetNullsBuffer();\n     }\n \n+    @Override\n+    public void noMoreBatches()\n+    {\n+        super.noMoreBatches();\n+\n+        if (flushed) {\n+            if (sliceBuffer != null) {", "originalCommit": "edb40d5607f1e15c06c3d343b1638875b77f5286", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}