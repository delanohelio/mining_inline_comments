{"pr_number": 13934, "pr_title": "Update error code when table is dropped during query execution", "pr_createdAt": "2020-01-07T00:24:37Z", "pr_url": "https://github.com/prestodb/presto/pull/13934", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU0NjY3Nw==", "url": "https://github.com/prestodb/presto/pull/13934#discussion_r363546677", "bodyText": "@viczhang861 I feel that this logic is based on an assumption that this code may not be in a position to make. E.g. this would break if the caller code changes and it seems unlikely that the caller is aware about this logic. If that's not the case, would you explain why this assumption is valid?", "author": "mbasmanova", "createdAt": "2020-01-07T00:36:06Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/SemiTransactionalHiveMetastore.java", "diffHunk": "@@ -1500,7 +1500,13 @@ private void executeIrreversibleMetastoreOperations()\n                 }\n                 Joiner.on(\"; \").appendTo(message, failedIrreversibleOperationDescriptions);\n \n-                PrestoException prestoException = new PrestoException(HIVE_METASTORE_ERROR, message.toString());\n+                PrestoException prestoException;\n+                if (suppressedExceptions.size() == 1 && suppressedExceptions.get(0) instanceof TableNotFoundException) {", "originalCommit": "af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU1NzYyNQ==", "url": "https://github.com/prestodb/presto/pull/13934#discussion_r363557625", "bodyText": "Based on comment in caller of this function, this function is only used for delete operation and caller is aware of possible failure\n\n\"// The next section will deal with \"dropping table/partition\".\" . Commit may still fail in this section.\n\nDoes this answer your question?", "author": "viczhang861", "createdAt": "2020-01-07T01:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU0NjY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ2MTQzNg==", "url": "https://github.com/prestodb/presto/pull/13934#discussion_r365461436", "bodyText": "Exploring suppressed exceptions seems very fragile to me as well. How sure we are there's no better way of detecting this exception? Maybe it should be replaced with more specific exception on the level below?", "author": "arhimondr", "createdAt": "2020-01-10T22:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU0NjY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYxOTU5Mg==", "url": "https://github.com/prestodb/presto/pull/13934#discussion_r367619592", "bodyText": "The suppressed exceptions inside this function are not ones extracted from Exception.getSuppressed() . I rearranged code to avoid the confusion.", "author": "viczhang861", "createdAt": "2020-01-16T19:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU0NjY3Nw=="}], "type": "inlineReview"}, {"oid": "0edc2b96eb074a51d6541f3be444483d2fb12d3a", "url": "https://github.com/prestodb/presto/commit/0edc2b96eb074a51d6541f3be444483d2fb12d3a", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table is already dropped by\nother query during query execution.", "committedDate": "2020-01-16T17:17:14Z", "type": "forcePushed"}, {"oid": "7cb8108c61fc41cc56477123a38d7b259ff6189a", "url": "https://github.com/prestodb/presto/commit/7cb8108c61fc41cc56477123a38d7b259ff6189a", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table exists after query\nstarts execution but dropped before delete operation commits.", "committedDate": "2020-01-22T21:28:55Z", "type": "commit"}, {"oid": "7cb8108c61fc41cc56477123a38d7b259ff6189a", "url": "https://github.com/prestodb/presto/commit/7cb8108c61fc41cc56477123a38d7b259ff6189a", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table exists after query\nstarts execution but dropped before delete operation commits.", "committedDate": "2020-01-22T21:28:55Z", "type": "forcePushed"}]}