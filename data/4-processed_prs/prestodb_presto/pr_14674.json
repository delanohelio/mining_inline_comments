{"pr_number": 14674, "pr_title": "Avoid wrapping iterators", "pr_createdAt": "2020-06-18T14:10:44Z", "pr_url": "https://github.com/prestodb/presto/pull/14674", "timeline": [{"oid": "c799fe9b201651abc4b937e1701e234293e4c060", "url": "https://github.com/prestodb/presto/commit/c799fe9b201651abc4b937e1701e234293e4c060", "message": "Avoid wrapping iterators", "committedDate": "2020-06-18T17:36:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyMzA3Nw==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442423077", "bodyText": "I would prefer this way\nif (currentIterator.hasNext()) {\n    prestoSparkSerializedPage = currentIterator.next();\n}\nelse {\n    currentIteratorIndex++;\n}", "author": "viczhang861", "createdAt": "2020-06-18T18:31:05Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkSerializedPageInput.java", "diffHunk": "@@ -26,23 +29,33 @@\n         implements PrestoSparkPageInput\n {\n     private final PagesSerde pagesSerde;\n-    private final Iterator<PrestoSparkSerializedPage> serializedPageIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<PrestoSparkSerializedPage>> serializedPageIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkSerializedPageInput(PagesSerde pagesSerde, Iterator<PrestoSparkSerializedPage> serializedPageIterator)\n+    public PrestoSparkSerializedPageInput(PagesSerde pagesSerde, List<Iterator<PrestoSparkSerializedPage>> serializedPageIterators)\n     {\n         this.pagesSerde = requireNonNull(pagesSerde, \"pagesSerde is null\");\n-        this.serializedPageIterator = requireNonNull(serializedPageIterator, \"serializedPageIterator is null\");\n+        this.serializedPageIterators = requireNonNull(serializedPageIterators, \"serializedPageIterator is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n-        PrestoSparkSerializedPage prestoSparkSerializedPage;\n-        synchronized (serializedPageIterator) {\n-            if (!serializedPageIterator.hasNext()) {\n-                return null;\n+        PrestoSparkSerializedPage prestoSparkSerializedPage = null;\n+        synchronized (this) {\n+            while (prestoSparkSerializedPage == null) {\n+                if (currentIteratorIndex >= serializedPageIterators.size()) {\n+                    return null;\n+                }\n+                Iterator<PrestoSparkSerializedPage> currentIterator = serializedPageIterators.get(currentIteratorIndex);\n+                if (!currentIterator.hasNext()) {\n+                    currentIteratorIndex++;\n+                    continue;\n+                }\n+                prestoSparkSerializedPage = currentIterator.next();", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyNzkzNg==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442427936", "bodyText": "same here, if (currentIterator.hasNext()) {} else {}", "author": "viczhang861", "createdAt": "2020-06-18T18:40:25Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -38,45 +42,72 @@\n     private static final int MAX_ROWS_PER_ZERO_COLUMN_PAGE = 10_000;\n \n     private final List<Type> types;\n-    private final Iterator<PrestoSparkMutableRow> rowsIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkMutableRowPageInput(List<Type> types, Iterator<PrestoSparkMutableRow> rowsIterator)\n+    public PrestoSparkMutableRowPageInput(List<Type> types, List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators)\n     {\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.rowsIterator = requireNonNull(rowsIterator, \"rowsIterator is null\");\n+        this.rowIterators = requireNonNull(rowIterators, \"rowIterators is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n         // zero columns page\n         if (types.isEmpty()) {\n-            int rowsCount = 0;\n-            synchronized (rowsIterator) {\n-                if (!rowsIterator.hasNext()) {\n-                    return null;\n-                }\n-                while (rowsIterator.hasNext() && rowsCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n-                    rowsIterator.next();\n-                    rowsCount++;\n+            int rowCount = 0;\n+            synchronized (this) {\n+                while (true) {\n+                    if (currentIteratorIndex >= rowIterators.size()) {\n+                        break;\n+                    }\n+                    if (rowCount >= MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n+                        break;\n+                    }\n+                    Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n+                    if (!currentIterator.hasNext()) {\n+                        currentIteratorIndex++;\n+                        continue;\n+                    }\n+                    currentIterator.next();\n+                    rowCount++;", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyOTU1OQ==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442429559", "bodyText": "while (currentIteratorIndex < rowIterators.size() && rowCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE)", "author": "viczhang861", "createdAt": "2020-06-18T18:43:22Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -38,45 +42,72 @@\n     private static final int MAX_ROWS_PER_ZERO_COLUMN_PAGE = 10_000;\n \n     private final List<Type> types;\n-    private final Iterator<PrestoSparkMutableRow> rowsIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkMutableRowPageInput(List<Type> types, Iterator<PrestoSparkMutableRow> rowsIterator)\n+    public PrestoSparkMutableRowPageInput(List<Type> types, List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators)\n     {\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.rowsIterator = requireNonNull(rowsIterator, \"rowsIterator is null\");\n+        this.rowIterators = requireNonNull(rowIterators, \"rowIterators is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n         // zero columns page\n         if (types.isEmpty()) {\n-            int rowsCount = 0;\n-            synchronized (rowsIterator) {\n-                if (!rowsIterator.hasNext()) {\n-                    return null;\n-                }\n-                while (rowsIterator.hasNext() && rowsCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n-                    rowsIterator.next();\n-                    rowsCount++;\n+            int rowCount = 0;\n+            synchronized (this) {\n+                while (true) {\n+                    if (currentIteratorIndex >= rowIterators.size()) {\n+                        break;\n+                    }\n+                    if (rowCount >= MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n+                        break;\n+                    }", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0OTQ3OA==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442849478", "bodyText": "Actually I would like to keep them separate as we are testing two separate conditions.", "author": "arhimondr", "createdAt": "2020-06-19T13:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyOTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTMwMA==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442431300", "bodyText": "nit, one line using ternary operator", "author": "viczhang861", "createdAt": "2020-06-18T18:46:38Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -38,45 +42,72 @@\n     private static final int MAX_ROWS_PER_ZERO_COLUMN_PAGE = 10_000;\n \n     private final List<Type> types;\n-    private final Iterator<PrestoSparkMutableRow> rowsIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkMutableRowPageInput(List<Type> types, Iterator<PrestoSparkMutableRow> rowsIterator)\n+    public PrestoSparkMutableRowPageInput(List<Type> types, List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators)\n     {\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.rowsIterator = requireNonNull(rowsIterator, \"rowsIterator is null\");\n+        this.rowIterators = requireNonNull(rowIterators, \"rowIterators is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n         // zero columns page\n         if (types.isEmpty()) {\n-            int rowsCount = 0;\n-            synchronized (rowsIterator) {\n-                if (!rowsIterator.hasNext()) {\n-                    return null;\n-                }\n-                while (rowsIterator.hasNext() && rowsCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n-                    rowsIterator.next();\n-                    rowsCount++;\n+            int rowCount = 0;\n+            synchronized (this) {\n+                while (true) {\n+                    if (currentIteratorIndex >= rowIterators.size()) {\n+                        break;\n+                    }\n+                    if (rowCount >= MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n+                        break;\n+                    }\n+                    Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n+                    if (!currentIterator.hasNext()) {\n+                        currentIteratorIndex++;\n+                        continue;\n+                    }\n+                    currentIterator.next();\n+                    rowCount++;\n                 }\n             }\n-            return new Page(rowsCount);\n+            if (rowCount == 0) {\n+                return null;\n+            }\n+            return new Page(rowCount);", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0OTc4Ng==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442849786", "bodyText": "Usually we prefer to avoid ternary operators as those are less readable. I would prefer to keep it as is.", "author": "arhimondr", "createdAt": "2020-06-19T13:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTYzOA==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442431638", "bodyText": "ditto", "author": "viczhang861", "createdAt": "2020-06-18T18:47:20Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -38,45 +42,72 @@\n     private static final int MAX_ROWS_PER_ZERO_COLUMN_PAGE = 10_000;\n \n     private final List<Type> types;\n-    private final Iterator<PrestoSparkMutableRow> rowsIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkMutableRowPageInput(List<Type> types, Iterator<PrestoSparkMutableRow> rowsIterator)\n+    public PrestoSparkMutableRowPageInput(List<Type> types, List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators)\n     {\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.rowsIterator = requireNonNull(rowsIterator, \"rowsIterator is null\");\n+        this.rowIterators = requireNonNull(rowIterators, \"rowIterators is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n         // zero columns page\n         if (types.isEmpty()) {\n-            int rowsCount = 0;\n-            synchronized (rowsIterator) {\n-                if (!rowsIterator.hasNext()) {\n-                    return null;\n-                }\n-                while (rowsIterator.hasNext() && rowsCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n-                    rowsIterator.next();\n-                    rowsCount++;\n+            int rowCount = 0;\n+            synchronized (this) {\n+                while (true) {\n+                    if (currentIteratorIndex >= rowIterators.size()) {\n+                        break;\n+                    }\n+                    if (rowCount >= MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n+                        break;\n+                    }\n+                    Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n+                    if (!currentIterator.hasNext()) {\n+                        currentIteratorIndex++;\n+                        continue;\n+                    }\n+                    currentIterator.next();\n+                    rowCount++;\n                 }\n             }\n-            return new Page(rowsCount);\n+            if (rowCount == 0) {\n+                return null;\n+            }\n+            return new Page(rowCount);\n         }\n \n         SliceOutput output = new DynamicSliceOutput(BUFFER_SIZE);\n         int rowCount = 0;\n-        synchronized (rowsIterator) {\n-            if (!rowsIterator.hasNext()) {\n-                return null;\n-            }\n-            while (rowsIterator.hasNext() && output.size() < TARGET_SIZE) {\n-                PrestoSparkMutableRow row = rowsIterator.next();\n+        synchronized (this) {\n+            while (true) {\n+                if (currentIteratorIndex >= rowIterators.size()) {\n+                    break;\n+                }\n+                if (output.size() >= TARGET_SIZE) {\n+                    break;\n+                }", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MjM4MQ==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442852381", "bodyText": "Actually I would like to keep them separate as we are testing two separate conditions.", "author": "arhimondr", "createdAt": "2020-06-19T13:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNDU2Mw==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442434563", "bodyText": "ditto, avoid continue will make code cleaner", "author": "viczhang861", "createdAt": "2020-06-18T18:52:41Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkMutableRowPageInput.java", "diffHunk": "@@ -38,45 +42,72 @@\n     private static final int MAX_ROWS_PER_ZERO_COLUMN_PAGE = 10_000;\n \n     private final List<Type> types;\n-    private final Iterator<PrestoSparkMutableRow> rowsIterator;\n+    @GuardedBy(\"this\")\n+    private final List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators;\n+    @GuardedBy(\"this\")\n+    private int currentIteratorIndex;\n \n-    public PrestoSparkMutableRowPageInput(List<Type> types, Iterator<PrestoSparkMutableRow> rowsIterator)\n+    public PrestoSparkMutableRowPageInput(List<Type> types, List<Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>>> rowIterators)\n     {\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.rowsIterator = requireNonNull(rowsIterator, \"rowsIterator is null\");\n+        this.rowIterators = requireNonNull(rowIterators, \"rowIterators is null\");\n     }\n \n     @Override\n     public Page getNextPage()\n     {\n         // zero columns page\n         if (types.isEmpty()) {\n-            int rowsCount = 0;\n-            synchronized (rowsIterator) {\n-                if (!rowsIterator.hasNext()) {\n-                    return null;\n-                }\n-                while (rowsIterator.hasNext() && rowsCount < MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n-                    rowsIterator.next();\n-                    rowsCount++;\n+            int rowCount = 0;\n+            synchronized (this) {\n+                while (true) {\n+                    if (currentIteratorIndex >= rowIterators.size()) {\n+                        break;\n+                    }\n+                    if (rowCount >= MAX_ROWS_PER_ZERO_COLUMN_PAGE) {\n+                        break;\n+                    }\n+                    Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n+                    if (!currentIterator.hasNext()) {\n+                        currentIteratorIndex++;\n+                        continue;\n+                    }\n+                    currentIterator.next();\n+                    rowCount++;\n                 }\n             }\n-            return new Page(rowsCount);\n+            if (rowCount == 0) {\n+                return null;\n+            }\n+            return new Page(rowCount);\n         }\n \n         SliceOutput output = new DynamicSliceOutput(BUFFER_SIZE);\n         int rowCount = 0;\n-        synchronized (rowsIterator) {\n-            if (!rowsIterator.hasNext()) {\n-                return null;\n-            }\n-            while (rowsIterator.hasNext() && output.size() < TARGET_SIZE) {\n-                PrestoSparkMutableRow row = rowsIterator.next();\n+        synchronized (this) {\n+            while (true) {\n+                if (currentIteratorIndex >= rowIterators.size()) {\n+                    break;\n+                }\n+                if (output.size() >= TARGET_SIZE) {\n+                    break;\n+                }\n+                Iterator<Tuple2<MutablePartitionId, PrestoSparkMutableRow>> currentIterator = rowIterators.get(currentIteratorIndex);\n+                if (!currentIterator.hasNext()) {\n+                    currentIteratorIndex++;\n+                    continue;", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0OTg1Nw==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442449857", "bodyText": "Duplicated as that in PrestoSparkUtils.java", "author": "viczhang861", "createdAt": "2020-06-18T19:22:31Z", "path": "presto-spark-classloader-interface/src/main/java/com/facebook/presto/spark/classloader_interface/PrestoSparkTaskRdd.java", "diffHunk": "@@ -124,15 +123,36 @@ private PrestoSparkTaskRdd(\n         for (int inputIndex = 0; inputIndex < shuffleInputRdds.size(); inputIndex++) {\n             shuffleInputIterators.put(\n                     shuffleInputFragmentIds.get(inputIndex),\n-                    asJavaIterator(shuffleInputRdds.get(inputIndex).iterator(partitions.get(inputIndex), context)));\n+                    shuffleInputRdds.get(inputIndex).iterator(partitions.get(inputIndex), context));\n         }\n \n-        Iterator<SerializedPrestoSparkTaskSource> taskSourceIterator = emptyIterator();\n+        Iterator<SerializedPrestoSparkTaskSource> taskSourceIterator;\n         if (taskSourceRdd != null) {\n-            taskSourceIterator = asJavaIterator(taskSourceRdd.iterator(partitions.get(partitions.size() - 1), context));\n+            taskSourceIterator = taskSourceRdd.iterator(partitions.get(partitions.size() - 1), context);\n         }\n+        else {\n+            taskSourceIterator = emptyScalaIterator();\n+        }\n+\n+        return taskProcessor.process(taskSourceIterator, unmodifiableMap(shuffleInputIterators));\n+    }\n+\n+    private static <T> Iterator<T> emptyScalaIterator()", "originalCommit": "c799fe9b201651abc4b937e1701e234293e4c060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MjExNA==", "url": "https://github.com/prestodb/presto/pull/14674#discussion_r442852114", "bodyText": "Created one more utility class in the classloader-interface module, ScalaUtils.", "author": "arhimondr", "createdAt": "2020-06-19T13:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0OTg1Nw=="}], "type": "inlineReview"}, {"oid": "af4688e186b24569f50867b1f4e9e64a775f0424", "url": "https://github.com/prestodb/presto/commit/af4688e186b24569f50867b1f4e9e64a775f0424", "message": "Avoid wrapping iterators", "committedDate": "2020-06-19T13:50:23Z", "type": "commit"}, {"oid": "af4688e186b24569f50867b1f4e9e64a775f0424", "url": "https://github.com/prestodb/presto/commit/af4688e186b24569f50867b1f4e9e64a775f0424", "message": "Avoid wrapping iterators", "committedDate": "2020-06-19T13:50:23Z", "type": "forcePushed"}]}