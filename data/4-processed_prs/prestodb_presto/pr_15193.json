{"pr_number": 15193, "pr_title": "Add docs for exchange materialization", "pr_createdAt": "2020-09-19T22:55:28Z", "pr_url": "https://github.com/prestodb/presto/pull/15193", "timeline": [{"oid": "6985c87a48214edd7ce5b493d27ba44afd1cb05e", "url": "https://github.com/prestodb/presto/commit/6985c87a48214edd7ce5b493d27ba44afd1cb05e", "message": "Add docs for exchange materialization", "committedDate": "2020-09-19T22:55:56Z", "type": "forcePushed"}, {"oid": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "url": "https://github.com/prestodb/presto/commit/8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "message": "Add docs for exchange materialization", "committedDate": "2020-09-19T23:01:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0OTk3NQ==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r492949975", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            also requires all the producers and receivers have to be executed concurrently until the\n          \n          \n            \n            also requires all the producers and consumers to be executed concurrently until the\n          \n      \n    \n    \n  \n\nProducer and consumer is the terminology normally associated with a one way queuing arrangement. Producer and receiver is not terminology I recognize.", "author": "aweisberg", "createdAt": "2020-09-22T18:32:41Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1MDQ5MQ==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r492950491", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            query finished.\n          \n          \n            \n            query is finished.", "author": "aweisberg", "createdAt": "2020-09-22T18:33:36Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the\n+query finished.", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1MTEwNQ==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r492951105", "bodyText": "fault-tolerante -> fault tolerance\nCapitalize first letter of bullet points?", "author": "aweisberg", "createdAt": "2020-09-22T18:34:29Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the\n+query finished.\n+\n+To illustrates this, consider the aggregation query:\n+\n+.. code-block:: sql\n+\n+    SELECT custkey, SUM(totalprice)\n+    FROM orders\n+    GROUP BY custkey\n+\n+\n+The following figure demonstrates how this query executes in Presto classic mode:\n+\n+.. figure:: ../images/rpc_shuffle_execution.png", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NDMyNg==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r493964326", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            it is always a temporary Hive bucketed table). This opens opportunity for flexible scheduling policies\n          \n          \n            \n            it is always a temporary Hive bucketed table). This creates an opportunity for flexible scheduling policies", "author": "aweisberg", "createdAt": "2020-09-24T00:02:38Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the\n+query finished.\n+\n+To illustrates this, consider the aggregation query:\n+\n+.. code-block:: sql\n+\n+    SELECT custkey, SUM(totalprice)\n+    FROM orders\n+    GROUP BY custkey\n+\n+\n+The following figure demonstrates how this query executes in Presto classic mode:\n+\n+.. figure:: ../images/rpc_shuffle_execution.png\n+   :align: center\n+\n+With exchange materialization, the intermediate shuffle data is written to disk (currently,\n+it is always a temporary Hive bucketed table). This opens opportunity for flexible scheduling policies", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUwMzczMQ==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r494503731", "bodyText": "@aweisberg : What about opens the opportunity for XXX?", "author": "wenleix", "createdAt": "2020-09-24T17:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NDMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU0MzE2Nw==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r494543167", "bodyText": "That WFM", "author": "aweisberg", "createdAt": "2020-09-24T18:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NDMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3ODU0OA==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r493978548", "bodyText": "Capitalize first letter of bullet points?\n\"Schedule fewer partitions concurrently to reduce memory requirements\"", "author": "aweisberg", "createdAt": "2020-09-24T00:54:49Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the\n+query finished.\n+\n+To illustrates this, consider the aggregation query:\n+\n+.. code-block:: sql\n+\n+    SELECT custkey, SUM(totalprice)\n+    FROM orders\n+    GROUP BY custkey\n+\n+\n+The following figure demonstrates how this query executes in Presto classic mode:\n+\n+.. figure:: ../images/rpc_shuffle_execution.png\n+   :align: center\n+\n+With exchange materialization, the intermediate shuffle data is written to disk (currently,\n+it is always a temporary Hive bucketed table). This opens opportunity for flexible scheduling policies\n+on the aggregation side, as only a subset of aggregation data needs to be held in memory at the\n+same time -- this execution strategy is called \"grouped execution\" in Presto.\n+\n+.. figure:: ../images/materialized_shuffle_execution.png", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3ODg2MA==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r493978860", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                -- We recommend to set hash_partition_count to be at least 5X-10X about the number of cluster size\n          \n          \n            \n                -- We recommend setting hash_partition_count to be at least 5X-10X cluster size", "author": "aweisberg", "createdAt": "2020-09-24T00:55:59Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and receivers have to be executed concurrently until the\n+query finished.\n+\n+To illustrates this, consider the aggregation query:\n+\n+.. code-block:: sql\n+\n+    SELECT custkey, SUM(totalprice)\n+    FROM orders\n+    GROUP BY custkey\n+\n+\n+The following figure demonstrates how this query executes in Presto classic mode:\n+\n+.. figure:: ../images/rpc_shuffle_execution.png\n+   :align: center\n+\n+With exchange materialization, the intermediate shuffle data is written to disk (currently,\n+it is always a temporary Hive bucketed table). This opens opportunity for flexible scheduling policies\n+on the aggregation side, as only a subset of aggregation data needs to be held in memory at the\n+same time -- this execution strategy is called \"grouped execution\" in Presto.\n+\n+.. figure:: ../images/materialized_shuffle_execution.png\n+   :align: center\n+\n+Using Exchange Materialization\n+------------------------------\n+\n+Exchange materialization can be enabled on per-query basis by setting the following 3 session properties:\n+``exchange_materialization_strategy``, ``partitioning_provider_catalog`` and ``hash_partition_count``:\n+\n+.. code-block:: sql\n+\n+    SET SESSION exchange_materialization_strategy='ALL';\n+\n+    -- Set partitioning_provider_catalog to the Hive connector catalog\n+    SET SESSION partitioning_provider_catalog='hive';\n+\n+    -- We recommend to set hash_partition_count to be at least 5X-10X about the number of cluster size", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3OTA3Mw==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r493979073", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * All high memory ETL queries (tagged with 'high_mem_etl') re routed to subgroups under the ``global.pipeline`` group,\n          \n          \n            \n            * All high memory ETL queries (tagged with 'high_mem_etl') are routed to subgroups under the ``global.pipeline`` group,", "author": "aweisberg", "createdAt": "2020-09-24T00:56:47Z", "path": "presto-docs/src/main/sphinx/admin/session-property-managers.rst", "diffHunk": "@@ -62,6 +62,9 @@ Consider the following set of requirements:\n * All ETL queries (tagged with 'etl') are routed to subgroups under the ``global.pipeline`` group, and must be\n   configured with certain properties to control writer behavior.\n \n+* All high memory ETL queries (tagged with 'high_mem_etl') re routed to subgroups under the ``global.pipeline`` group,", "originalCommit": "8339ece5cbd93f2dfe36ca2a17b3a03ccc698520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0506a66de6de0de49aeaef14da9bb7262a468802", "url": "https://github.com/prestodb/presto/commit/0506a66de6de0de49aeaef14da9bb7262a468802", "message": "Add docs for exchange materialization", "committedDate": "2020-09-24T17:57:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU0MzkxNQ==", "url": "https://github.com/prestodb/presto/pull/15193#discussion_r494543915", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                -- We recommend setting hash_partition_count to be at least 5X-10X about the number of cluster size\n          \n          \n            \n                -- We recommend setting hash_partition_count to be at least 5X-10X the cluster size", "author": "aweisberg", "createdAt": "2020-09-24T18:57:26Z", "path": "presto-docs/src/main/sphinx/admin/exchange-materialization.rst", "diffHunk": "@@ -0,0 +1,59 @@\n+========================\n+Exchange Materialization\n+========================\n+\n+Presto allows exchange materialization to support memory intensive queries.\n+This mechanism brings MapReduce-style execution to Presto's MPP architecture runtime,\n+and can be applied together with :doc:`/admin/spill`.\n+\n+Introduction\n+------------\n+\n+As with other MPP databases, Presto leverages RPC shuffle to achieve efficient and\n+low-latency query execution for join and aggregation. However, RPC shuffle\n+also requires all the producers and consumers to be executed concurrently until the\n+query is finished.\n+\n+To illustrates this, consider the aggregation query:\n+\n+.. code-block:: sql\n+\n+    SELECT custkey, SUM(totalprice)\n+    FROM orders\n+    GROUP BY custkey\n+\n+\n+The following figure demonstrates how this query executes in Presto classic mode:\n+\n+.. figure:: ../images/rpc_shuffle_execution.png\n+   :align: center\n+\n+With exchange materialization, the intermediate shuffle data is written to disk (currently,\n+it is always a temporary Hive bucketed table). This opens the opportunity for flexible scheduling policies\n+on the aggregation side, as only a subset of aggregation data needs to be held in memory at the\n+same time -- this execution strategy is called \"grouped execution\" in Presto.\n+\n+.. figure:: ../images/materialized_shuffle_execution.png\n+   :align: center\n+\n+Using Exchange Materialization\n+------------------------------\n+\n+Exchange materialization can be enabled on per-query basis by setting the following 3 session properties:\n+``exchange_materialization_strategy``, ``partitioning_provider_catalog`` and ``hash_partition_count``:\n+\n+.. code-block:: sql\n+\n+    SET SESSION exchange_materialization_strategy='ALL';\n+\n+    -- Set partitioning_provider_catalog to the Hive connector catalog\n+    SET SESSION partitioning_provider_catalog='hive';\n+\n+    -- We recommend setting hash_partition_count to be at least 5X-10X about the number of cluster size", "originalCommit": "0506a66de6de0de49aeaef14da9bb7262a468802", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3c2cd4811fc8f4833d2af575f96418f0a7db93e", "url": "https://github.com/prestodb/presto/commit/b3c2cd4811fc8f4833d2af575f96418f0a7db93e", "message": "Add docs for exchange materialization", "committedDate": "2020-09-25T17:31:44Z", "type": "commit"}, {"oid": "b3c2cd4811fc8f4833d2af575f96418f0a7db93e", "url": "https://github.com/prestodb/presto/commit/b3c2cd4811fc8f4833d2af575f96418f0a7db93e", "message": "Add docs for exchange materialization", "committedDate": "2020-09-25T17:31:44Z", "type": "forcePushed"}]}