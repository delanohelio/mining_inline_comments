{"pr_number": 14275, "pr_title": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release", "pr_createdAt": "2020-03-22T09:17:10Z", "pr_url": "https://github.com/prestodb/presto/pull/14275", "timeline": [{"oid": "2bfa3ee695ede5d48aa4cd7722816044f031768c", "url": "https://github.com/prestodb/presto/commit/2bfa3ee695ede5d48aa4cd7722816044f031768c", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release", "committedDate": "2020-03-22T19:04:26Z", "type": "forcePushed"}, {"oid": "1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "url": "https://github.com/prestodb/presto/commit/1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release", "committedDate": "2020-03-22T19:33:51Z", "type": "forcePushed"}, {"oid": "36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "url": "https://github.com/prestodb/presto/commit/36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release", "committedDate": "2020-03-22T20:52:13Z", "type": "forcePushed"}, {"oid": "b5d62277a86272edb9b29db82a89f5ce82460950", "url": "https://github.com/prestodb/presto/commit/b5d62277a86272edb9b29db82a89f5ce82460950", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release.\n\nChanges for Pinot APIs:\nNew routingTable API returns exact a queryable snapshot of servers to segments mapping, so no extra computation needed.\nNew timeBoundary API returns 404 if no time boundary found, even if table exists. It used to return 200 and an empty Json Object.\n\nThis PR will always try the new API first then fall back to old API if exception raised.", "committedDate": "2020-03-27T07:13:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NzQxMw==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401247413", "bodyText": "either put all parameters in one line, or one in each line", "author": "zhenxiao", "createdAt": "2020-03-31T22:15:14Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -359,10 +395,8 @@ public RoutingTables(@JsonProperty(\"routingTableSnapshot\") List<RoutingTableSnap\n             else {\n                 List<Map<String, List<String>>> routingTableEntriesList = snapshot.getRoutingTableEntries();\n                 if (routingTableEntriesList.isEmpty()) {\n-                    throw new PinotException(\n-                            PINOT_UNEXPECTED_RESPONSE,\n-                            Optional.empty(),\n-                            String.format(\"Empty routingTableEntries for %s. RoutingTable: %s\", tableName, responseBody));\n+                    throw new PinotException(PINOT_UNEXPECTED_RESPONSE, Optional.empty(),\n+                        String.format(\"Empty routingTableEntries for %s. RoutingTable: %s\", tableName, responseBody));", "originalCommit": "b5d62277a86272edb9b29db82a89f5ce82460950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM2MjU5MA==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401362590", "bodyText": "done", "author": "xiangfu0", "createdAt": "2020-04-01T05:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NzQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0ODA3OQ==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401248079", "bodyText": "make \"404\" a constant?\ncheck and guard no array index out of bound exception when accessing [3]? could you please comment error message format", "author": "zhenxiao", "createdAt": "2020-03-31T22:17:03Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -426,7 +460,21 @@ public TimeBoundary(\n \n     public TimeBoundary getTimeBoundaryForTable(String table)\n     {\n-        String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n-        return timeBoundaryJsonCodec.fromJson(responseBody);\n+        try {\n+            String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n+            return timeBoundaryJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception e) {\n+            if ((e instanceof PinotException)) {\n+                // New Pinot broker will set response code 404 if time boundary is not set.\n+                // This is backward incompatible with old version, as it returns an empty json object.\n+                // In order to gracefully handle this, below check will extract response code and return empty json\n+                // if not found time boundary.\n+                if (e.getMessage().split(\" \")[3].equalsIgnoreCase(\"404\")) {", "originalCommit": "b5d62277a86272edb9b29db82a89f5ce82460950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM2MjUwNg==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401362506", "bodyText": "Done", "author": "xiangfu0", "createdAt": "2020-04-01T05:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0ODA3OQ=="}], "type": "inlineReview"}, {"oid": "36c470acbd22dfc4b3551641f38e20538d822a96", "url": "https://github.com/prestodb/presto/commit/36c470acbd22dfc4b3551641f38e20538d822a96", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release.\n\nChanges for Pinot APIs:\nNew routingTable API returns exact a queryable snapshot of servers to segments mapping, so no extra computation needed.\nNew timeBoundary API returns 404 if no time boundary found, even if table exists. It used to return 200 and an empty Json Object.\n\nThis PR will always try the new API first then fall back to old API if exception raised.", "committedDate": "2020-04-01T05:50:37Z", "type": "commit"}, {"oid": "bdaaba30a91c8ff7c8c43b0aa948565300734ff6", "url": "https://github.com/prestodb/presto/commit/bdaaba30a91c8ff7c8c43b0aa948565300734ff6", "message": "Address comments", "committedDate": "2020-04-01T05:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5OTY3Mw==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401399673", "bodyText": "s/errMsgSplits/errorMessageSplits/g\nminor thing, Presto usually not use abbreviation in variable name", "author": "zhenxiao", "createdAt": "2020-04-01T07:10:40Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -426,7 +463,26 @@ public TimeBoundary(\n \n     public TimeBoundary getTimeBoundaryForTable(String table)\n     {\n-        String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n-        return timeBoundaryJsonCodec.fromJson(responseBody);\n+        try {\n+            String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n+            return timeBoundaryJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception e) {\n+            if ((e instanceof PinotException)) {\n+                /** New Pinot broker will set response code 404 if time boundary is not set.\n+                 * This is backward incompatible with old version, as it returns an empty json object.\n+                 * In order to gracefully handle this, below check will extract response code and return empty json\n+                 * if not found time boundary.\n+                 *\n+                 * Sample error message:\n+                 *     Unexpected response status: 404 for request  to url http://127.0.0.1:8000/debug/timeBoundary/baseballStats, with headers ...\n+                 */\n+                String[] errMsgSplits = e.getMessage().split(\" \");", "originalCommit": "9a3eb74b94aae83e9be878c7dc629974bb8dfbd0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMjU5Ng==", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401402596", "bodyText": "Sure! Still getting used to Presto coding style :)", "author": "xiangfu0", "createdAt": "2020-04-01T07:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5OTY3Mw=="}], "type": "inlineReview"}, {"oid": "b0ba50ada93337b920c8235593e268ca570fb566", "url": "https://github.com/prestodb/presto/commit/b0ba50ada93337b920c8235593e268ca570fb566", "message": "change variable errMsgSplits to errorMessageSplits", "committedDate": "2020-04-01T07:15:20Z", "type": "commit"}, {"oid": "b0ba50ada93337b920c8235593e268ca570fb566", "url": "https://github.com/prestodb/presto/commit/b0ba50ada93337b920c8235593e268ca570fb566", "message": "change variable errMsgSplits to errorMessageSplits", "committedDate": "2020-04-01T07:15:20Z", "type": "forcePushed"}]}