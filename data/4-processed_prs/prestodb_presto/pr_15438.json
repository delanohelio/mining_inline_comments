{"pr_number": 15438, "pr_title": " Null unused array elements in SpillableFinalOnlyGroupedAccumulator", "pr_createdAt": "2020-11-13T18:20:34Z", "pr_url": "https://github.com/prestodb/presto/pull/15438", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NDc2Nw==", "url": "https://github.com/prestodb/presto/pull/15438#discussion_r523874767", "bodyText": "Shall we check if this is safe to do so? If yes, make a comment above this line?", "author": "highker", "createdAt": "2020-11-16T02:58:26Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -718,6 +719,7 @@ public void evaluateIntermediate(int groupId, BlockBuilder output)\n                 singleArrayBlockWriter.appendStructure(rowBlock.getBlock(i));\n             }\n             output.closeEntry();\n+            blockBuilders.set(groupId, null);", "originalCommit": "7e56e03329e09be1053fa3b13ad9e667994163bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1ODM5Nw==", "url": "https://github.com/prestodb/presto/pull/15438#discussion_r524458397", "bodyText": "Yeah, I have deployed this to test clusters and this is safe. This is because\n\nevaluateIntermediate is only called once spilling is invoked (never before that point) I.e. SpillableHashAggregationBuilder.buildResult/spillToDisk() occurs. Once we do this, aggregation Step is set to PARTIAL.\nThen, we get the corresponding partial result for every aggregator by iterating over every groupId: https://fburl.com/kdl3hbhk. This groupId iterator is created in hashSortedGroupIds https://fburl.com/wrgy9wrc. As we can see in the line we are assigning each groupId an ordinal and it is impossible to have repeated groupIds in this list.\n\nWill add a comment.", "author": "sachdevs", "createdAt": "2020-11-16T17:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NDc2Nw=="}], "type": "inlineReview"}, {"oid": "1560c93bcfc1530f14e0590dcdc188172c4e826d", "url": "https://github.com/prestodb/presto/commit/1560c93bcfc1530f14e0590dcdc188172c4e826d", "message": "Null unused array elements in SpillableFinalOnlyGroupedAccumulator\n\nThis deletes references to large objects in memory during\nevaluateIntermediate", "committedDate": "2020-11-16T17:55:06Z", "type": "forcePushed"}, {"oid": "3d831e0da1bea5ece1938f16fa0d59e0658375a9", "url": "https://github.com/prestodb/presto/commit/3d831e0da1bea5ece1938f16fa0d59e0658375a9", "message": "Null unused array elements in SpillableFinalOnlyGroupedAccumulator\n\nThis deletes references to large objects in memory during\nevaluateIntermediate", "committedDate": "2020-11-17T23:51:46Z", "type": "commit"}, {"oid": "3d831e0da1bea5ece1938f16fa0d59e0658375a9", "url": "https://github.com/prestodb/presto/commit/3d831e0da1bea5ece1938f16fa0d59e0658375a9", "message": "Null unused array elements in SpillableFinalOnlyGroupedAccumulator\n\nThis deletes references to large objects in memory during\nevaluateIntermediate", "committedDate": "2020-11-17T23:51:46Z", "type": "forcePushed"}]}