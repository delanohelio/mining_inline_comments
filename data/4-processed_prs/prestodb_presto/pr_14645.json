{"pr_number": 14645, "pr_title": "Add data validation to Alluxio data caching", "pr_createdAt": "2020-06-12T16:51:06Z", "pr_url": "https://github.com/prestodb/presto/pull/14645", "timeline": [{"oid": "2e4f74aef221e0185d47e6fa1c8b70d7ae49b835", "url": "https://github.com/prestodb/presto/commit/2e4f74aef221e0185d47e6fa1c8b70d7ae49b835", "message": "Add data validation to Alluxio data caching", "committedDate": "2020-06-12T16:58:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNDk4Mg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439534982", "bodyText": "put FileInStream inputStream to its own line", "author": "highker", "createdAt": "2020-06-12T16:54:10Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,62 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n+    {\n+        this(inputStream, null, false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(FileInStream inputStream,", "originalCommit": "da2a81ea24d15f9f49c735d14d9e0de9424f51a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNjg4MA==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439536880", "bodyText": "Let's remove this so that the query runner can test the original IO path.", "author": "highker", "createdAt": "2020-06-12T16:57:56Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/HiveQueryRunner.java", "diffHunk": "@@ -157,6 +157,11 @@ public static DistributedQueryRunner createQueryRunner(\n                     .put(\"hive.assume-canonical-partition-keys\", \"true\")\n                     .put(\"hive.collect-column-statistics-on-write\", \"true\")\n                     .put(\"hive.temporary-table-schema\", TEMPORARY_TABLE_SCHEMA)\n+                    .put(\"hive.node-selection-strategy\", \"SOFT_AFFINITY\")\n+                    .put(\"cache.enabled\", \"true\")\n+                    .put(\"cache.type\", \"ALLUXIO\")\n+                    .put(\"cache.base-directory\", \"file://\" + new File(\"/tmp\", \"cache\").getAbsolutePath())\n+                    .put(\"cache.validation-enabled\", \"true\")", "originalCommit": "da2a81ea24d15f9f49c735d14d9e0de9424f51a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNzE4Mg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439537182", "bodyText": "bytes", "author": "highker", "createdAt": "2020-06-12T16:58:34Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,62 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n+    {\n+        this(inputStream, null, false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(FileInStream inputStream,\n+            FSDataInputStream originInputStream,\n+            boolean cacheValidationEnabled)\n     {\n         this.inputStream = inputStream;\n+        this.originInputStream = originInputStream;\n+        this.cacheValidationEnabled = cacheValidationEnabled;\n     }\n \n     @Override\n     public int read()\n             throws IOException\n     {\n-        return inputStream.read();\n+        int outByte = inputStream.read();\n+        if (cacheValidationEnabled) {\n+            verify(originInputStream.read() == outByte, \"corrupted buffer at position \" + getPos());\n+        }\n+        return outByte;\n     }\n \n     @Override\n     public int read(long position, byte[] buffer, int offset, int length)\n             throws IOException\n     {\n-        return inputStream.positionedRead(position, buffer, offset, length);\n+        int bytesRead = inputStream.positionedRead(position, buffer, offset, length);", "originalCommit": "da2a81ea24d15f9f49c735d14d9e0de9424f51a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNzM0MQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439537341", "bodyText": "bytes", "author": "highker", "createdAt": "2020-06-12T16:58:51Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,62 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n+    {\n+        this(inputStream, null, false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(FileInStream inputStream,\n+            FSDataInputStream originInputStream,\n+            boolean cacheValidationEnabled)\n     {\n         this.inputStream = inputStream;\n+        this.originInputStream = originInputStream;\n+        this.cacheValidationEnabled = cacheValidationEnabled;\n     }\n \n     @Override\n     public int read()\n             throws IOException\n     {\n-        return inputStream.read();\n+        int outByte = inputStream.read();", "originalCommit": "da2a81ea24d15f9f49c735d14d9e0de9424f51a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU0MTc1MQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439541751", "bodyText": "This is only reading one byte and the output is the byte, should it be bytes?", "author": "zhiyua-git", "createdAt": "2020-06-12T17:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNzM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNzgyNQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439537825", "bodyText": "requireNonNull for both", "author": "highker", "createdAt": "2020-06-12T16:59:45Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,62 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n+    {\n+        this(inputStream, null, false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(FileInStream inputStream,\n+            FSDataInputStream originInputStream,\n+            boolean cacheValidationEnabled)\n     {\n         this.inputStream = inputStream;\n+        this.originInputStream = originInputStream;", "originalCommit": "2e4f74aef221e0185d47e6fa1c8b70d7ae49b835", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78822262694586930eb474784d5c509108727543", "url": "https://github.com/prestodb/presto/commit/78822262694586930eb474784d5c509108727543", "message": "Add data validation to Alluxio data caching", "committedDate": "2020-06-12T17:06:43Z", "type": "forcePushed"}, {"oid": "89cac81b8a33c9aa7151300cc75373ff2d6ca489", "url": "https://github.com/prestodb/presto/commit/89cac81b8a33c9aa7151300cc75373ff2d6ca489", "message": "Add data validation to Alluxio data caching", "committedDate": "2020-06-12T17:09:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1Njc1Mg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439556752", "bodyText": "We should avoid fileSystem.openFile in case validation is disabled.", "author": "jainxrohit", "createdAt": "2020-06-12T17:39:02Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java", "diffHunk": "@@ -117,7 +126,7 @@ public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n             URIStatus uriStatus = mFileSystem.getStatus(getAlluxioPath(path));\n             AlluxioURIStatus alluxioURIStatus = new AlluxioURIStatus(uriStatus.getFileInfo(), hiveFileContext);\n             FileInStream fileInStream = mFileSystem.openFile(alluxioURIStatus, OpenFilePOptions.getDefaultInstance());\n-            return new FSDataInputStream(new AlluxioCachingHdfsFileInputStream(fileInStream));\n+            return new FSDataInputStream(new AlluxioCachingHdfsFileInputStream(fileInStream, fileSystem.openFile(path, hiveFileContext), cacheValidationEnabled));", "originalCommit": "89cac81b8a33c9aa7151300cc75373ff2d6ca489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NzUzMg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439557532", "bodyText": "nit: Can you rename originInputStream to dataTierInputStream? We are using dataTier to represent the origin source, makes it easy to think what it is.", "author": "jainxrohit", "createdAt": "2020-06-12T17:40:52Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,64 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+import static java.util.Objects.requireNonNull;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n     {\n-        this.inputStream = inputStream;\n+        this(inputStream, null, false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(\n+            FileInStream inputStream,\n+            FSDataInputStream originInputStream,", "originalCommit": "89cac81b8a33c9aa7151300cc75373ff2d6ca489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1ODUzNQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439558535", "bodyText": "Should only be done if validation is enabled.", "author": "jainxrohit", "createdAt": "2020-06-12T17:42:56Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -77,6 +105,7 @@ public void seek(long position)\n             throws IOException\n     {\n         inputStream.seek(position);\n+        originInputStream.seek(position);", "originalCommit": "89cac81b8a33c9aa7151300cc75373ff2d6ca489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1ODczNw==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r439558737", "bodyText": "Lets create this as optional, as it may not be present when validation is disabled.", "author": "jainxrohit", "createdAt": "2020-06-12T17:43:20Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,64 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n \n+import static com.google.common.base.Verify.verify;\n+import static java.util.Objects.requireNonNull;\n+\n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final FSDataInputStream originInputStream;", "originalCommit": "89cac81b8a33c9aa7151300cc75373ff2d6ca489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64a3035f8678e9ae805eefef34ac967280492f3a", "url": "https://github.com/prestodb/presto/commit/64a3035f8678e9ae805eefef34ac967280492f3a", "message": "Add data validation to Alluxio data caching", "committedDate": "2020-06-12T17:58:57Z", "type": "commit"}, {"oid": "64a3035f8678e9ae805eefef34ac967280492f3a", "url": "https://github.com/prestodb/presto/commit/64a3035f8678e9ae805eefef34ac967280492f3a", "message": "Add data validation to Alluxio data caching", "committedDate": "2020-06-12T17:58:57Z", "type": "forcePushed"}, {"oid": "876d02b4c8f000c8aa2040edb75133b9094b7ffe", "url": "https://github.com/prestodb/presto/commit/876d02b4c8f000c8aa2040edb75133b9094b7ffe", "message": "Add unit test for Alluxio data validation\n\n1. Add unit teste for data validation logic in AlluxioCachingHdfsFileInputStream\n2. Refactor ByteArraySeekableStream class out for reuse.", "committedDate": "2020-06-14T06:09:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxODQ2Mg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440318462", "bodyText": "Shouldn't this be offset insted of 0?\nCan you please test it with a bigger table e.g. order?", "author": "jainxrohit", "createdAt": "2020-06-15T17:01:06Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,66 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.util.Optional;\n+\n+import static com.google.common.base.Verify.verify;\n+import static java.util.Objects.requireNonNull;\n \n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final Optional<FSDataInputStream> dataTierInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n     {\n-        this.inputStream = inputStream;\n+        this(inputStream, Optional.empty(), false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(\n+            FileInStream inputStream,\n+            Optional<FSDataInputStream> dataTierInputStream,\n+            boolean cacheValidationEnabled)\n+    {\n+        this.inputStream = requireNonNull(inputStream);\n+        this.dataTierInputStream = requireNonNull(dataTierInputStream);\n+        verify(!cacheValidationEnabled || dataTierInputStream.isPresent(), \"data tier input need to be non-null for data validation.\");\n+        this.cacheValidationEnabled = cacheValidationEnabled;\n     }\n \n     @Override\n     public int read()\n             throws IOException\n     {\n-        return inputStream.read();\n+        int outByte = inputStream.read();\n+        if (cacheValidationEnabled) {\n+            verify(dataTierInputStream.get().read() == outByte, \"corrupted buffer at position \" + getPos());\n+        }\n+        return outByte;\n     }\n \n     @Override\n     public int read(long position, byte[] buffer, int offset, int length)\n             throws IOException\n     {\n-        return inputStream.positionedRead(position, buffer, offset, length);\n+        int bytes = inputStream.positionedRead(position, buffer, offset, length);\n+        if (cacheValidationEnabled) {\n+            byte[] validationBuffer = new byte[bytes];\n+            dataTierInputStream.get().read(position, validationBuffer, 0, bytes);", "originalCommit": "876d02b4c8f000c8aa2040edb75133b9094b7ffe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM1MTEyMQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440351121", "bodyText": "It is reading into the temp buffer and comparing from the beginning so it always starting from 0.", "author": "zhiyua-git", "createdAt": "2020-06-15T18:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxODQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM3MDA5OA==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440370098", "bodyText": "Not really sure what got changed here? If nothing, then can you please fix the format to make sure it does not show in diff?", "author": "jainxrohit", "createdAt": "2020-06-15T18:36:14Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -93,11 +87,47 @@ public void setupMethod()\n     @Test(timeOut = 30_000)\n     public void testBasic()\n             throws Exception\n+    {\n+        testWithDataValidation(false);\n+    }\n+\n+    @Test(timeOut = 30_000)\n+    public void testBasicWithDataValidationEnabled()\n+            throws Exception\n+    {\n+        testWithDataValidation(true);\n+    }\n+\n+    @Test(invocationCount = 10)\n+    public void testStress()\n+            throws ExecutionException, InterruptedException, URISyntaxException, IOException\n     {\n         CacheConfig cacheConfig = new CacheConfig()\n                 .setCacheType(ALLUXIO)\n                 .setCachingEnabled(true)\n                 .setBaseDirectory(cacheDirectory);\n+        AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig()", "originalCommit": "876d02b4c8f000c8aa2040edb75133b9094b7ffe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5Mjc1NQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440392755", "bodyText": "It is just the formatter, I will revert it back to make the diff minimal.", "author": "zhiyua-git", "createdAt": "2020-06-15T19:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM3MDA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM3MDYyNg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440370626", "bodyText": "Can we keep the base method name as testBasic and use it to leverage validation on/off?", "author": "jainxrohit", "createdAt": "2020-06-15T18:37:18Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -93,11 +87,47 @@ public void setupMethod()\n     @Test(timeOut = 30_000)\n     public void testBasic()\n             throws Exception\n+    {\n+        testWithDataValidation(false);\n+    }\n+\n+    @Test(timeOut = 30_000)\n+    public void testBasicWithDataValidationEnabled()\n+            throws Exception\n+    {\n+        testWithDataValidation(true);\n+    }\n+\n+    @Test(invocationCount = 10)\n+    public void testStress()\n+            throws ExecutionException, InterruptedException, URISyntaxException, IOException\n     {\n         CacheConfig cacheConfig = new CacheConfig()\n                 .setCacheType(ALLUXIO)\n                 .setCachingEnabled(true)\n                 .setBaseDirectory(cacheDirectory);\n+        AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig()\n+                .setMaxCacheSize(new DataSize(10, KILOBYTE));\n+\n+        AlluxioCachingFileSystem cachingFileSystem = cachingFileSystem(cacheConfig, alluxioCacheConfig);\n+        stressTest(data, (position, buffer, offset, length) -> {\n+            try {\n+                readFully(cachingFileSystem, position, buffer, offset, length);\n+            }\n+            catch (Exception e) {\n+                e.printStackTrace();\n+            }\n+        });\n+    }\n+\n+    private void testWithDataValidation(boolean validationEnabled)", "originalCommit": "876d02b4c8f000c8aa2040edb75133b9094b7ffe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "url": "https://github.com/prestodb/presto/commit/5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "message": "Add unit test for Alluxio data validation\n\n1. Add unit teste for data validation logic in AlluxioCachingHdfsFileInputStream\n2. Refactor ByteArraySeekableStream class out for reuse.", "committedDate": "2020-06-15T19:19:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwOTY5Nw==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440509697", "bodyText": "put fileInStream to its own line", "author": "highker", "createdAt": "2020-06-15T23:57:21Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java", "diffHunk": "@@ -117,7 +127,9 @@ public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n             URIStatus uriStatus = mFileSystem.getStatus(getAlluxioPath(path));\n             AlluxioURIStatus alluxioURIStatus = new AlluxioURIStatus(uriStatus.getFileInfo(), hiveFileContext);\n             FileInStream fileInStream = mFileSystem.openFile(alluxioURIStatus, OpenFilePOptions.getDefaultInstance());\n-            return new FSDataInputStream(new AlluxioCachingHdfsFileInputStream(fileInStream));\n+            return new FSDataInputStream(new AlluxioCachingHdfsFileInputStream(fileInStream,", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxMDE3NA==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440510174", "bodyText": "this.inputStream = requireNonNull(inputStream, \"inputStream is null\");\nSame for the other", "author": "highker", "createdAt": "2020-06-15T23:59:07Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -15,36 +15,66 @@\n \n import alluxio.client.file.FileInStream;\n import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.FSDataInputStream;\n import org.apache.hadoop.fs.PositionedReadable;\n import org.apache.hadoop.fs.Seekable;\n \n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.util.Optional;\n+\n+import static com.google.common.base.Verify.verify;\n+import static java.util.Objects.requireNonNull;\n \n public class AlluxioCachingHdfsFileInputStream\n         extends InputStream\n         implements Seekable, PositionedReadable\n {\n     private final FileInStream inputStream;\n+    private final Optional<FSDataInputStream> dataTierInputStream;\n+    private final boolean cacheValidationEnabled;\n \n     public AlluxioCachingHdfsFileInputStream(FileInStream inputStream)\n     {\n-        this.inputStream = inputStream;\n+        this(inputStream, Optional.empty(), false);\n+    }\n+\n+    public AlluxioCachingHdfsFileInputStream(\n+            FileInStream inputStream,\n+            Optional<FSDataInputStream> dataTierInputStream,\n+            boolean cacheValidationEnabled)\n+    {\n+        this.inputStream = requireNonNull(inputStream);\n+        this.dataTierInputStream = requireNonNull(dataTierInputStream);", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNDA1Mg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440514052", "bodyText": "add requireNonNull for bytes", "author": "highker", "createdAt": "2020-06-16T00:12:26Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/ByteArraySeekableStream.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.exception.ExceptionMessage;\n+import org.apache.hadoop.fs.PositionedReadable;\n+import org.apache.hadoop.fs.Seekable;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+class ByteArraySeekableStream\n+        extends InputStream\n+        implements Seekable, PositionedReadable\n+{\n+    private final ByteArrayInputStream inputStream;\n+    private final int length;\n+\n+    public ByteArraySeekableStream(byte[] bytes)\n+    {", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNjU5MQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440516591", "bodyText": "spell out buffer", "author": "highker", "createdAt": "2020-06-16T00:21:30Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNjY3NA==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440516674", "bodyText": "same", "author": "highker", "createdAt": "2020-06-16T00:21:46Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNjY5Ng==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440516696", "bodyText": "same", "author": "highker", "createdAt": "2020-06-16T00:21:50Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNjg3Mw==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440516873", "bodyText": "spell out position", "author": "highker", "createdAt": "2020-06-16T00:22:25Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzA0MQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517041", "bodyText": "seek(long position)\nPresto codebase doesn't use abbreivations", "author": "highker", "createdAt": "2020-06-16T00:22:55Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzEwNg==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517106", "bodyText": "throws IOException is redundant", "author": "highker", "createdAt": "2020-06-16T00:23:08Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)\n+                throws IOException", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzE0Nw==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517147", "bodyText": "same", "author": "highker", "createdAt": "2020-06-16T00:23:16Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)\n+                throws IOException\n+        {\n+            pos = l;\n+        }\n+\n+        @Override\n+        public long getPos()\n+                throws IOException", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzE2Nw==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517167", "bodyText": "same", "author": "highker", "createdAt": "2020-06-16T00:23:22Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)\n+                throws IOException\n+        {\n+            pos = l;\n+        }\n+\n+        @Override\n+        public long getPos()\n+                throws IOException\n+        {\n+            return pos;\n+        }\n+\n+        @Override\n+        public long remaining()\n+        {\n+            return data.length - pos;\n+        }\n+\n+        @Override\n+        public int positionedRead(long pos, byte[] b, int off, int len)", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzE4NQ==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517185", "bodyText": "same", "author": "highker", "createdAt": "2020-06-16T00:23:27Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)\n+                throws IOException\n+        {\n+            pos = l;\n+        }\n+\n+        @Override\n+        public long getPos()\n+                throws IOException\n+        {\n+            return pos;\n+        }\n+\n+        @Override\n+        public long remaining()\n+        {\n+            return data.length - pos;\n+        }\n+\n+        @Override\n+        public int positionedRead(long pos, byte[] b, int off, int len)\n+                throws IOException", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUxNzI4NA==", "url": "https://github.com/prestodb/presto/pull/14645#discussion_r440517284", "bodyText": "just return -1;", "author": "highker", "createdAt": "2020-06-16T00:23:43Z", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingHdfsFileInputStream.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.alluxio;\n+\n+import alluxio.client.file.FileInStream;\n+import com.google.common.base.VerifyException;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.cache.TestingCacheUtils.validateBuffer;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestAlluxioCachingHdfsFileInputStream\n+{\n+    @Test\n+    public void testConstructor()\n+    {\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(new byte[] {});\n+        FileInStream fileInStream = new TestFileInStream(new byte[] {});\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        try {\n+            new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.empty(), true);\n+            fail();\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"data tier input need to be non-null for data validation.\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        try {\n+            fileInputStream.readFully(0, buf, 0, buf.length);\n+            fail(\"Data validation didn't work for mismatched data.\");\n+        }\n+        catch (VerifyException ex) {\n+            assertEquals(ex.getMessage(), \"corrupted buffer at position 1\");\n+        }\n+    }\n+\n+    @Test\n+    public void testValidateDataEnabledWithDataMatched()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(inputData, 0, buf, 0, inputData.length);\n+    }\n+\n+    @Test\n+    public void testValidateDataDisabledWithDataMismatch()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        byte[] corruptedData = new byte[] {1, 3, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(corruptedData);\n+        AlluxioCachingHdfsFileInputStream fileInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+        byte[] buf = new byte[3];\n+        fileInputStream.readFully(0, buf, 0, buf.length);\n+        validateBuffer(corruptedData, 0, buf, 0, corruptedData.length);\n+    }\n+\n+    @Test\n+    public void testInteractionWithDataTierInputStream()\n+            throws IOException\n+    {\n+        byte[] inputData = new byte[] {1, 2, 3};\n+        FSDataInputStream dataTierInputStream = new TestFSDataInputStream(inputData);\n+        FileInStream fileInStream = new TestFileInStream(inputData);\n+        AlluxioCachingHdfsFileInputStream validationEnabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), true);\n+        AlluxioCachingHdfsFileInputStream validationDisabledInputStream = new AlluxioCachingHdfsFileInputStream(fileInStream, Optional.of(dataTierInputStream), false);\n+\n+        // Seek on multiple positions on validationDisabledInputStream, it should not affect data tier\n+        validationDisabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationDisabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 0L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+\n+        // Seek on multiple positions on validationEnabledInputStream, it should also seek for same position in data tier\n+        validationEnabledInputStream.seek(2L);\n+        assertEquals(dataTierInputStream.getPos(), 2L);\n+        assertEquals(fileInStream.getPos(), 2L);\n+        validationEnabledInputStream.seek(1L);\n+        assertEquals(dataTierInputStream.getPos(), 1L);\n+        assertEquals(fileInStream.getPos(), 1L);\n+    }\n+\n+    private static class TestFileInStream\n+            extends FileInStream\n+    {\n+        private final byte[] data;\n+        private long pos;\n+\n+        private TestFileInStream(byte[] data)\n+        {\n+            this.data = data;\n+            pos = 0;\n+        }\n+\n+        @Override\n+        public void seek(long l)\n+                throws IOException\n+        {\n+            pos = l;\n+        }\n+\n+        @Override\n+        public long getPos()\n+                throws IOException\n+        {\n+            return pos;\n+        }\n+\n+        @Override\n+        public long remaining()\n+        {\n+            return data.length - pos;\n+        }\n+\n+        @Override\n+        public int positionedRead(long pos, byte[] b, int off, int len)\n+                throws IOException\n+        {\n+            if (len == 0) {\n+                return 0;\n+            }\n+            else if (pos >= 0L && pos < data.length) {\n+                int lengthToRead = Math.min(len, data.length - (int) pos);\n+                System.arraycopy(data, (int) pos, b, off, lengthToRead);\n+                return lengthToRead;\n+            }\n+            else {\n+                return -1;\n+            }", "originalCommit": "5c3f173c582d39b7e2108d8ea0ef90d946f95a8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1672100c03fa0a5d23c9c2c8a620381776e2077b", "url": "https://github.com/prestodb/presto/commit/1672100c03fa0a5d23c9c2c8a620381776e2077b", "message": "Add unit test for Alluxio data validation\n\n1. Add unit teste for data validation logic in AlluxioCachingHdfsFileInputStream\n2. Refactor ByteArraySeekableStream class out for reuse.", "committedDate": "2020-06-16T01:31:42Z", "type": "commit"}, {"oid": "1672100c03fa0a5d23c9c2c8a620381776e2077b", "url": "https://github.com/prestodb/presto/commit/1672100c03fa0a5d23c9c2c8a620381776e2077b", "message": "Add unit test for Alluxio data validation\n\n1. Add unit teste for data validation logic in AlluxioCachingHdfsFileInputStream\n2. Refactor ByteArraySeekableStream class out for reuse.", "committedDate": "2020-06-16T01:31:42Z", "type": "forcePushed"}]}