{"pr_number": 14320, "pr_title": "Add max buffer count config property for optimized repartitioning", "pr_createdAt": "2020-04-01T00:08:30Z", "pr_url": "https://github.com/prestodb/presto/pull/14320", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTI0MA==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r401285240", "bodyText": "This number is highly dependent on the environment and won't work for all setups. Let's make this limit configurable.", "author": "mbasmanova", "createdAt": "2020-04-01T00:10:25Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -367,7 +367,8 @@ public OperatorFactory duplicate()\n         private final Closer blockLeaseCloser = Closer.create();\n \n         // The ArrayAllocator for the buffers used in repartitioning, e.g. PartitionBuffer#serializedRowSizes, BlockEncodingBuffer#mappedPositions.\n-        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(10_000);\n+        // Assuming there are 1000 columns, and each of them uses 3 buffers, and the number of partitions is 333, then we need 1000 * 3 * 333 about 1M buffers.\n+        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(1_000_000);", "originalCommit": "8fb84b36778346ef577752f3cd6a856763e08d8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290", "url": "https://github.com/prestodb/presto/commit/ead72224559f0395f4dcc0a655ca012cacd7c290", "message": "Add max buffer count config property for optimized repartitioning", "committedDate": "2020-04-01T01:38:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTE4MQ==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351181", "bodyText": "Integer -> int", "author": "mbasmanova", "createdAt": "2020-04-02T14:20:54Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -60,6 +60,7 @@\n \n     private DataSize sinkMaxBufferSize = new DataSize(32, Unit.MEGABYTE);\n     private DataSize maxPagePartitioningBufferSize = new DataSize(32, Unit.MEGABYTE);\n+    private Integer maxPagePartitioningBufferCount = 1_000_000;", "originalCommit": "ead72224559f0395f4dcc0a655ca012cacd7c290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTMzNw==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351337", "bodyText": "remove @NotNull\nInteger -> int", "author": "mbasmanova", "createdAt": "2020-04-02T14:21:05Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()", "originalCommit": "ead72224559f0395f4dcc0a655ca012cacd7c290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTQzMQ==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351431", "bodyText": "Integer -> int", "author": "mbasmanova", "createdAt": "2020-04-02T14:21:14Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")\n+    public TaskManagerConfig setMaxPagePartitioningBufferCount(Integer bufferCount)", "originalCommit": "ead72224559f0395f4dcc0a655ca012cacd7c290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjE2OA==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352168", "bodyText": "Add @ConfigDescription", "author": "mbasmanova", "createdAt": "2020-04-02T14:22:09Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "originalCommit": "ead72224559f0395f4dcc0a655ca012cacd7c290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MDM1OQ==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402660359", "bodyText": "Sure. Added @ConfigDescription(\"Maximum number of buffers used by repartitioning per driver\")", "author": "yingsu00", "createdAt": "2020-04-02T23:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjMwMA==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352300", "bodyText": "Integer -> int", "author": "mbasmanova", "createdAt": "2020-04-02T14:22:20Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -310,6 +310,7 @@\n     private final IndexJoinLookupStats indexJoinLookupStats;\n     private final DataSize maxPartialAggregationMemorySize;\n     private final DataSize maxPagePartitioningBufferSize;\n+    private final Integer maxPagePartitioningBufferCount;", "originalCommit": "ead72224559f0395f4dcc0a655ca012cacd7c290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac", "url": "https://github.com/prestodb/presto/commit/3777150419fd48c2402a996f34bf5c32e5cc56ac", "message": "Add max buffer count config property for optimized repartitioning", "committedDate": "2020-04-02T23:53:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzYwNg==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r403813606", "bodyText": "@Min(1)", "author": "tdcmeehan", "createdAt": "2020-04-06T03:38:21Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    public int getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "originalCommit": "3777150419fd48c2402a996f34bf5c32e5cc56ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyOTg1NA==", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r403829854", "bodyText": "Thanks @tdcmeehan ! I updated the PR with the following\n    @Min(1)\n    public int getMaxPagePartitioningBufferCount()\n    {\n        return maxPagePartitioningBufferCount;\n    }", "author": "yingsu00", "createdAt": "2020-04-06T04:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzYwNg=="}], "type": "inlineReview"}, {"oid": "c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "url": "https://github.com/prestodb/presto/commit/c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "message": "Add max buffer count config property for optimized repartitioning", "committedDate": "2020-04-06T04:56:13Z", "type": "forcePushed"}, {"oid": "21048465c750025d37b26566ba34d63b2ba57823", "url": "https://github.com/prestodb/presto/commit/21048465c750025d37b26566ba34d63b2ba57823", "message": "Add max buffer count config property for optimized repartitioning", "committedDate": "2020-04-07T05:53:31Z", "type": "commit"}, {"oid": "21048465c750025d37b26566ba34d63b2ba57823", "url": "https://github.com/prestodb/presto/commit/21048465c750025d37b26566ba34d63b2ba57823", "message": "Add max buffer count config property for optimized repartitioning", "committedDate": "2020-04-07T05:53:31Z", "type": "forcePushed"}]}