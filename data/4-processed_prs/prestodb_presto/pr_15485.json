{"pr_number": 15485, "pr_title": "Disallow ORDER BY literal in window functions", "pr_createdAt": "2020-12-01T00:46:03Z", "pr_url": "https://github.com/prestodb/presto/pull/15485", "timeline": [{"oid": "970f365ab5be1b0afc43a16412eabc5ff4743c6b", "url": "https://github.com/prestodb/presto/commit/970f365ab5be1b0afc43a16412eabc5ff4743c6b", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-29T21:26:30Z", "type": "forcePushed"}, {"oid": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "url": "https://github.com/prestodb/presto/commit/2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-29T22:00:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg3MDg1Mg==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549870852", "bodyText": "Do you want to call it ordinals or literals? Just pick one! :P", "author": "rongrong", "createdAt": "2020-12-29T22:14:12Z", "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -171,6 +171,7 @@\n     public static final String REMOTE_FUNCTIONS_ENABLED = \"remote_functions_enabled\";\n     public static final String CHECK_ACCESS_CONTROL_ON_UTILIZED_COLUMNS_ONLY = \"check_access_control_on_utilized_columns_only\";\n     public static final String SKIP_REDUNDANT_SORT = \"skip_redundant_sort\";\n+    public static final String ALLOW_WINDOW_ORDER_BY_ORDINALS = \"allow_window_order_by_ordinals\";", "originalCommit": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg3MjE2Mw==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549872163", "bodyText": "Oh yeah - I think literals is more appropriate as that's what we are doing. Fixed.", "author": "kaikalur", "createdAt": "2020-12-29T22:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg3MDg1Mg=="}], "type": "inlineReview"}, {"oid": "9a5c7910a06e270b8561e198eef16be6ed1a3951", "url": "https://github.com/prestodb/presto/commit/9a5c7910a06e270b8561e198eef16be6ed1a3951", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-29T22:19:41Z", "type": "forcePushed"}, {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "url": "https://github.com/prestodb/presto/commit/11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-29T22:39:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTA0Mg==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929042", "bodyText": "We normally use toImmutableList() rather than Collectors.toList()\nWe normally format this as\norderBy.getSortItems().stream()\n        .filter(...)\n        .collect(toImmutableList())\n\nYou can use\nList<SortItem> constSortItems = window.getOrderBy()\n        .ifPresent(orderBy -> orderBy.getSortItems()....)\n        .orElse(ImmutableList.of());", "author": "rongrong", "createdAt": "2020-12-30T04:10:00Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1535,6 +1538,34 @@ private void analyzeWindowFunctions(QuerySpecification node, List<Expression> ou\n \n                 Window window = windowFunction.getWindow().get();\n \n+                ImmutableList.Builder<SortItem> orderbyConst = ImmutableList.builder();\n+                window.getOrderBy().ifPresent(\n+                        orderBy -> orderbyConst.addAll(\n+                                orderBy.getSortItems()\n+                                .stream()\n+                                .filter(item -> item.getSortKey() instanceof Literal).collect(Collectors.toList())));", "originalCommit": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0NTQ4Ng==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549945486", "bodyText": "Done", "author": "kaikalur", "createdAt": "2020-12-30T06:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTY4OA==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929688", "bodyText": "instead of?", "author": "rongrong", "createdAt": "2020-12-30T04:14:43Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1535,6 +1538,34 @@ private void analyzeWindowFunctions(QuerySpecification node, List<Expression> ou\n \n                 Window window = windowFunction.getWindow().get();\n \n+                ImmutableList.Builder<SortItem> orderbyConst = ImmutableList.builder();\n+                window.getOrderBy().ifPresent(\n+                        orderBy -> orderbyConst.addAll(\n+                                orderBy.getSortItems()\n+                                .stream()\n+                                .filter(item -> item.getSortKey() instanceof Literal).collect(Collectors.toList())));\n+\n+                List<SortItem> constSortItems = orderbyConst.build();\n+                if (!constSortItems.isEmpty()) {\n+                    if (isAllowWindowOrderByLiterals(session)) {\n+                        warningCollector.add(\n+                                new PrestoWarning(\n+                                        PERFORMANCE_WARNING,\n+                                        String.format(\n+                                                \"ORDER BY literals/constants with window function: '%s' is unnecessary and expensive. If you intend to ORDER BY using ordinals, please use the actual expression instead: '%s'\",", "originalCommit": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0MjY3Ng==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549942676", "bodyText": "Well we already set the context in the first clause. Anyway I fixed it and also removed the unnecessary information.", "author": "kaikalur", "createdAt": "2020-12-30T05:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTc3Nw==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929777", "bodyText": "I think the description is not accurate.", "author": "rongrong", "createdAt": "2020-12-30T04:15:13Z", "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -890,6 +891,11 @@ public SystemSessionProperties(\n                         CHECK_ACCESS_CONTROL_ON_UTILIZED_COLUMNS_ONLY,\n                         \"Apply access control rules on only those columns that are required to produce the query output\",\n                         featuresConfig.isCheckAccessControlOnUtilizedColumnsOnly(),\n+                        false),\n+                booleanProperty(\n+                        ALLOW_WINDOW_ORDER_BY_LITERALS,\n+                        \"Skip redundant sort operations\",", "originalCommit": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0MjI4Ng==", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549942286", "bodyText": "Fixed.", "author": "kaikalur", "createdAt": "2020-12-30T05:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTc3Nw=="}], "type": "inlineReview"}, {"oid": "aa5719a36d4399671968b506b9f754969b6b272a", "url": "https://github.com/prestodb/presto/commit/aa5719a36d4399671968b506b9f754969b6b272a", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T05:44:26Z", "type": "forcePushed"}, {"oid": "2df8636e75e662a8e88e43644f0a39a282ab4ad9", "url": "https://github.com/prestodb/presto/commit/2df8636e75e662a8e88e43644f0a39a282ab4ad9", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T05:46:11Z", "type": "forcePushed"}, {"oid": "a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "url": "https://github.com/prestodb/presto/commit/a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T05:48:29Z", "type": "forcePushed"}, {"oid": "1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "url": "https://github.com/prestodb/presto/commit/1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T06:05:25Z", "type": "forcePushed"}, {"oid": "9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "url": "https://github.com/prestodb/presto/commit/9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T15:39:14Z", "type": "forcePushed"}, {"oid": "4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "url": "https://github.com/prestodb/presto/commit/4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T20:25:20Z", "type": "commit"}, {"oid": "4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "url": "https://github.com/prestodb/presto/commit/4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature.", "committedDate": "2020-12-30T20:25:20Z", "type": "forcePushed"}]}