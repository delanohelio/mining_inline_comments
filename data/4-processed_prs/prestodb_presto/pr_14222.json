{"pr_number": 14222, "pr_title": "Reduce positions array size in PartitionBuffer", "pr_createdAt": "2020-03-06T07:07:13Z", "pr_url": "https://github.com/prestodb/presto/pull/14222", "timeline": [{"oid": "03f40b883593b38560408c178390a19eb32dd2ac", "url": "https://github.com/prestodb/presto/commit/03f40b883593b38560408c178390a19eb32dd2ac", "message": "Reduce positions array size in PartitionBuffer\n\nPreviously the positions array in PartitionBuffer was initialized to be\nthe incoming pages' size. This is over allocating since each partition\nmay only get a small portion of rows. This commit reduces the initial\npositions array size to (positionCount / partitionCount + 1) * 2 and\ngrow it on the fly. Note that this regressed the CPU performance a\nlittle. For example, the JMH benchmark regressed by 10% for one BIGINT\nno null case.", "committedDate": "2020-03-06T07:07:22Z", "type": "forcePushed"}, {"oid": "a6784d875b457f431538700499d446b5978b01a3", "url": "https://github.com/prestodb/presto/commit/a6784d875b457f431538700499d446b5978b01a3", "message": "Reduce positions array size in PartitionBuffer\n\nPreviously the positions array in PartitionBuffer was initialized to be\nthe incoming pages' positionCount length. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size to\nmax(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.", "committedDate": "2020-03-10T07:05:47Z", "type": "forcePushed"}, {"oid": "68f4e2723b6be8ca110beb8597ae9774efd0928e", "url": "https://github.com/prestodb/presto/commit/68f4e2723b6be8ca110beb8597ae9774efd0928e", "message": "Reduce positions array size in PartitionBuffer\n\nIn OptimizedPartitionedOutputOperator, the PagePartioner has\npartitionCount number of PartitionBuffer, and each PartitionBuffer\nhas a positions array to record the positions to be appended to this\nbuffer. Previously this positions array was initialized to be the\nincoming page's positionCount size. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size from positionCount to\nmin(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.", "committedDate": "2020-03-10T07:23:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjYwOA==", "url": "https://github.com/prestodb/presto/pull/14222#discussion_r390202608", "bodyText": "@yingsu00 perhaps, add a comment explaining this calculation and maybe consider moving it to the caller; e.g.  have the caller provide an estimate of how many rows there will be in a partition\nresetPositions(int estimatedPositionCount)", "author": "mbasmanova", "createdAt": "2020-03-10T09:57:08Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -561,12 +565,13 @@ private static int getFixedWidthTypeSize(Type type)\n \n         private void resetPositions(int positionCount)\n         {\n-            positions = ensureCapacity(positions, positionCount);\n+            positions = ensureCapacity(positions, min(positionCount, (positionCount / partitionCount + 1) * 2));", "originalCommit": "68f4e2723b6be8ca110beb8597ae9774efd0928e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgyNTAyNw==", "url": "https://github.com/prestodb/presto/pull/14222#discussion_r390825027", "bodyText": "@mbasmanova Thanks for the suggestion! I updated the PR with the change and added the following comments\n// We initialize the size of the positions array in each partitionBuffers to be at most the incoming page's positionCount, or roughly two times of positionCount \n// divided by the number of partitions. This is because the latter could be greater than the positionCount when the number of partitions is 1 or positionCount is 1.", "author": "yingsu00", "createdAt": "2020-03-11T09:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwMjYwOA=="}], "type": "inlineReview"}, {"oid": "63cd738020e359a534e133087ceb28b3a2d5e014", "url": "https://github.com/prestodb/presto/commit/63cd738020e359a534e133087ceb28b3a2d5e014", "message": "Reduce positions array size in PartitionBuffer\n\nIn OptimizedPartitionedOutputOperator, the PagePartioner has\npartitionCount number of PartitionBuffer, and each PartitionBuffer\nhas a positions array to record the positions to be appended to this\nbuffer. Previously this positions array was initialized to be the\nincoming page's positionCount size. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size from positionCount to\nmin(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.", "committedDate": "2020-03-11T08:16:52Z", "type": "forcePushed"}, {"oid": "ddc219ecaae6f171d4c42d6c2fbe4177dfe46baa", "url": "https://github.com/prestodb/presto/commit/ddc219ecaae6f171d4c42d6c2fbe4177dfe46baa", "message": "Reduce positions array size in PartitionBuffer\n\nIn OptimizedPartitionedOutputOperator, the PagePartioner has\npartitionCount number of PartitionBuffer, and each PartitionBuffer\nhas a positions array to record the positions to be appended to this\nbuffer. Previously this positions array was initialized to be the\nincoming page's positionCount size. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size from positionCount to\nmin(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.\n\nJMH benchmark shows about 8-10% gain in retained size:\n\t\t\taddPage\t\toptimizedAddPage optimizedAddPage_reducePositions Gain%\nbigint\t \t \t335,715,874 \t 424,471,312 \t \t390,497,040 \t\t   8%\nARRAY(BIGINT)\t \t327,680,906 \t 294,847,046 \t \t270,506,390 \t\t   8%\nROW(BIGINT,BIGINT)\t315,490,496 \t 261,529,566 \t \t236,571,362 \t\t   10%", "committedDate": "2020-03-11T08:56:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1NDEzMw==", "url": "https://github.com/prestodb/presto/pull/14222#discussion_r390954133", "bodyText": "@yingsu00 nit: consider moving this comment and calculation of the estimated position count out of the loop to avoid repeating this computation over and over.", "author": "mbasmanova", "createdAt": "2020-03-11T13:03:58Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -435,7 +437,9 @@ public void partitionPage(Page page)\n             int positionCount = page.getPositionCount();\n \n             for (int i = 0; i < partitionBuffers.length; i++) {\n-                partitionBuffers[i].resetPositions(positionCount);\n+                // We initialize the size of the positions array in each partitionBuffers to be at most the incoming page's positionCount, or roughly two times of positionCount", "originalCommit": "ddc219ecaae6f171d4c42d6c2fbe4177dfe46baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMzc0NA==", "url": "https://github.com/prestodb/presto/pull/14222#discussion_r391333744", "bodyText": "@mbasmanova Thanks Masha. I moved the computation out of the loop as you suggested:\n            // We initialize the size of the positions array in each partitionBuffers to be at most the incoming page's positionCount, or roughly two times of positionCount\n            // divided by the number of partitions. This is because the latter could be greater than the positionCount when the number of partitions is 1 or positionCount is 1.\n            int initialPositionCountForEachBuffer = min(positionCount, (positionCount / partitionFunction.getPartitionCount() + 1) * 2);\n            for (int i = 0; i < partitionBuffers.length; i++) {\n                partitionBuffers[i].resetPositions(initialPositionCountForEachBuffer);\n            }", "author": "yingsu00", "createdAt": "2020-03-11T23:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1NDEzMw=="}], "type": "inlineReview"}, {"oid": "0328962d4e16d36f69ec54b70ea9c16f427402ca", "url": "https://github.com/prestodb/presto/commit/0328962d4e16d36f69ec54b70ea9c16f427402ca", "message": "Reduce positions array size in PartitionBuffer\n\nIn OptimizedPartitionedOutputOperator, the PagePartioner has\npartitionCount number of PartitionBuffer, and each PartitionBuffer\nhas a positions array to record the positions to be appended to this\nbuffer. Previously this positions array was initialized to be the\nincoming page's positionCount size. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size from positionCount to\nmin(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.\n\nJMH benchmark shows about 8-10% gain in retained size:\n\t\t\taddPage\t\toptimizedAddPage optimizedAddPage_reducePositions Gain%\nbigint\t \t \t335,715,874 \t 424,471,312 \t \t390,497,040 \t\t   8%\nARRAY(BIGINT)\t \t327,680,906 \t 294,847,046 \t \t270,506,390 \t\t   8%\nROW(BIGINT,BIGINT)\t315,490,496 \t 261,529,566 \t \t236,571,362 \t\t   10%", "committedDate": "2020-03-11T23:50:30Z", "type": "commit"}, {"oid": "0328962d4e16d36f69ec54b70ea9c16f427402ca", "url": "https://github.com/prestodb/presto/commit/0328962d4e16d36f69ec54b70ea9c16f427402ca", "message": "Reduce positions array size in PartitionBuffer\n\nIn OptimizedPartitionedOutputOperator, the PagePartioner has\npartitionCount number of PartitionBuffer, and each PartitionBuffer\nhas a positions array to record the positions to be appended to this\nbuffer. Previously this positions array was initialized to be the\nincoming page's positionCount size. This could waste lots of memory\nsince each partition may only get a small portion of rows. This commit\nreduces the initial positions array size from positionCount to\nmin(positionCount, (positionCount / partitionCount + 1) * 2) and\ngrow it on the fly.\n\nJMH benchmark shows about 8-10% gain in retained size:\n\t\t\taddPage\t\toptimizedAddPage optimizedAddPage_reducePositions Gain%\nbigint\t \t \t335,715,874 \t 424,471,312 \t \t390,497,040 \t\t   8%\nARRAY(BIGINT)\t \t327,680,906 \t 294,847,046 \t \t270,506,390 \t\t   8%\nROW(BIGINT,BIGINT)\t315,490,496 \t 261,529,566 \t \t236,571,362 \t\t   10%", "committedDate": "2020-03-11T23:50:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNTU4OA==", "url": "https://github.com/prestodb/presto/pull/14222#discussion_r391335588", "bodyText": "nit: estimatedPositionCountPerPartition ?", "author": "mbasmanova", "createdAt": "2020-03-11T23:59:12Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -434,8 +436,11 @@ public void partitionPage(Page page)\n             // Populate positions to copy for each destination partition.\n             int positionCount = page.getPositionCount();\n \n+            // We initialize the size of the positions array in each partitionBuffers to be at most the incoming page's positionCount, or roughly two times of positionCount\n+            // divided by the number of partitions. This is because the latter could be greater than the positionCount when the number of partitions is 1 or positionCount is 1.\n+            int initialPositionCountForEachBuffer = min(positionCount, (positionCount / partitionFunction.getPartitionCount() + 1) * 2);", "originalCommit": "0328962d4e16d36f69ec54b70ea9c16f427402ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}