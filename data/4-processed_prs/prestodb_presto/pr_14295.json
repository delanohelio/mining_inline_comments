{"pr_number": 14295, "pr_title": "Enforce buffer size limits for BlockEncodingBuffer", "pr_createdAt": "2020-03-26T06:44:21Z", "pr_url": "https://github.com/prestodb/presto/pull/14295", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxMDI5OQ==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r398810299", "bodyText": "targetSize -> estimatedMaxCapacity for consistency", "author": "mbasmanova", "createdAt": "2020-03-26T18:46:08Z", "path": "presto-array/src/main/java/com/facebook/presto/array/Arrays.java", "diffHunk": "@@ -104,9 +106,9 @@ else if (buffer.length < capacity) {\n         return buffer;\n     }\n \n-    public static byte[] ensureCapacity(byte[] buffer, int capacity, ExpansionFactor expansionFactor, ExpansionOption expansionOption, ArrayAllocator allocator)\n+    public static byte[] ensureCapacity(byte[] buffer, int capacity, int targetSize, ExpansionFactor expansionFactor, ExpansionOption expansionOption, ArrayAllocator allocator)", "originalCommit": "327b32160a036d914d9907afa9cc8da95b8ca2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5NTc0OQ==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r399195749", "bodyText": "Done. I renamed the BlockEncodingBuffer fields names too. E.g. valuesBufferTargetSize --> estimatedValueBufferMaxCapacity", "author": "yingsu00", "createdAt": "2020-03-27T11:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxMDI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxMDQ3Mw==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r398810473", "bodyText": "min(buffer.length, capacity) -> buffer.length", "author": "mbasmanova", "createdAt": "2020-03-26T18:46:26Z", "path": "presto-array/src/main/java/com/facebook/presto/array/Arrays.java", "diffHunk": "@@ -115,7 +117,7 @@ else if (buffer.length < capacity) {\n         else if (buffer.length < capacity) {\n             newBuffer = allocator.borrowByteArray(newCapacity);\n             if (expansionOption == PRESERVE) {\n-                System.arraycopy(buffer, 0, newBuffer, 0, Math.min(buffer.length, capacity));\n+                System.arraycopy(buffer, 0, newBuffer, 0, min(buffer.length, capacity));", "originalCommit": "327b32160a036d914d9907afa9cc8da95b8ca2dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxMzY2MQ==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r398813661", "bodyText": "Instead of casting in multiple places change the type of valuesBuffers to AbstractBlockEncodingBuffer", "author": "mbasmanova", "createdAt": "2020-03-26T18:51:33Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java", "diffHunk": "@@ -201,17 +204,19 @@ public String toString()\n     }\n \n     @Override\n-    protected void setupDecodedBlockAndMapPositions(DecodedBlockNode decodedBlockNode)\n+    protected void setupDecodedBlockAndMapPositions(DecodedBlockNode decodedBlockNode, int partitionBufferCapacity)\n     {\n         requireNonNull(decodedBlockNode, \"decodedBlockNode is null\");\n \n         decodedBlockNode = mapPositionsToNestedBlock(decodedBlockNode);\n         ColumnarArray columnarArray = (ColumnarArray) decodedBlockNode.getDecodedBlock();\n         decodedBlock = columnarArray.getNullCheckBlock();\n \n+        setTargetBufferSize(decodedBlockNode, partitionBufferCapacity);\n+\n         populateNestedPositions(columnarArray);\n \n-        ((AbstractBlockEncodingBuffer) valuesBuffers).setupDecodedBlockAndMapPositions(decodedBlockNode.getChildren().get(0));\n+        ((AbstractBlockEncodingBuffer) valuesBuffers).setupDecodedBlockAndMapPositions(decodedBlockNode.getChildren().get(0), partitionBufferCapacity);", "originalCommit": "327b32160a036d914d9907afa9cc8da95b8ca2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5NjEyOQ==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r399196129", "bodyText": "Done in new commit 17ee832a6a Change nested buffers to AbstractBlockEncodingBuffer", "author": "yingsu00", "createdAt": "2020-03-27T11:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxMzY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxNTQxOA==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r398815418", "bodyText": "I suggest to inline setTargetBufferSize. It is used only once and doesn't actually set target size.", "author": "mbasmanova", "createdAt": "2020-03-26T18:53:33Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java", "diffHunk": "@@ -201,17 +204,19 @@ public String toString()\n     }\n \n     @Override\n-    protected void setupDecodedBlockAndMapPositions(DecodedBlockNode decodedBlockNode)\n+    protected void setupDecodedBlockAndMapPositions(DecodedBlockNode decodedBlockNode, int partitionBufferCapacity)\n     {\n         requireNonNull(decodedBlockNode, \"decodedBlockNode is null\");\n \n         decodedBlockNode = mapPositionsToNestedBlock(decodedBlockNode);\n         ColumnarArray columnarArray = (ColumnarArray) decodedBlockNode.getDecodedBlock();\n         decodedBlock = columnarArray.getNullCheckBlock();\n \n+        setTargetBufferSize(decodedBlockNode, partitionBufferCapacity);", "originalCommit": "327b32160a036d914d9907afa9cc8da95b8ca2dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxNzc1Mg==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r398817752", "bodyText": "Can this be calculated within this class as getRetainedSizeInBytes - sum(child.getRetainedSizeInBytes())? If not, perhaps, move this change into a separate commit.", "author": "mbasmanova", "createdAt": "2020-03-26T18:57:19Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/DecodedBlockNode.java", "diffHunk": "@@ -42,10 +43,16 @@\n     private final Object decodedBlock;\n     private final List<DecodedBlockNode> children;\n \n-    public DecodedBlockNode(Object decodedBlock, List<DecodedBlockNode> children)\n+    // The portion of the size of the exclusive content of this block to the total size. For example, the exclusive content\n+    // of an ArrayBlock is its offsets and nulls array while not its elementBlock. It is used to estimate the limit of the\n+    // buffers' sizes.\n+    private double sizePortionInPage;", "originalCommit": "327b32160a036d914d9907afa9cc8da95b8ca2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5Njk0Nw==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r399196947", "bodyText": "@mbasmanova Yes you're actually right. I moved the logic to DecodedBlockNode and made a new commit 52456a0fec Introduce sizePortionInPage in DecodedBlockNode", "author": "yingsu00", "createdAt": "2020-03-27T11:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgxNzc1Mg=="}], "type": "inlineReview"}, {"oid": "16a073ba8809d8a5561d9cf4af722e0da0a3799f", "url": "https://github.com/prestodb/presto/commit/16a073ba8809d8a5561d9cf4af722e0da0a3799f", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-03-27T11:20:02Z", "type": "forcePushed"}, {"oid": "31efb06e387dd0e9c22b5ea2b0e226eb4725bef5", "url": "https://github.com/prestodb/presto/commit/31efb06e387dd0e9c22b5ea2b0e226eb4725bef5", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-03-27T23:05:35Z", "type": "forcePushed"}, {"oid": "5ab39128a5841206f33b52e4d35f7fe965f6edb5", "url": "https://github.com/prestodb/presto/commit/5ab39128a5841206f33b52e4d35f7fe965f6edb5", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-03-27T23:18:59Z", "type": "forcePushed"}, {"oid": "b1ac964cccac1fe0722817cdc67993d911bd43a1", "url": "https://github.com/prestodb/presto/commit/b1ac964cccac1fe0722817cdc67993d911bd43a1", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-03-31T03:41:10Z", "type": "forcePushed"}, {"oid": "70764ec0b82417875768ab92d520e3d7c3f1cc92", "url": "https://github.com/prestodb/presto/commit/70764ec0b82417875768ab92d520e3d7c3f1cc92", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-04-01T01:54:27Z", "type": "forcePushed"}, {"oid": "04ba8544a67766edfa7c4d980ed988229cc3cee1", "url": "https://github.com/prestodb/presto/commit/04ba8544a67766edfa7c4d980ed988229cc3cee1", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' retained sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-04-06T07:26:06Z", "type": "forcePushed"}, {"oid": "2bd5d9398b65d800ad22962830d76a918338a808", "url": "https://github.com/prestodb/presto/commit/2bd5d9398b65d800ad22962830d76a918338a808", "message": "Use inflated size for dictionary and RLE blocks in DecodedBlockNode", "committedDate": "2020-04-08T08:57:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDQzMQ==", "url": "https://github.com/prestodb/presto/pull/14295#discussion_r405710431", "bodyText": "@yingsu00 I think moving away from page.getRetainedSizeInBytes() and using estimated flattened size is the right direction. It allows for much cleaner design. The DecodedBlockNode still needs the original value for the retainedSizeInBytes as it is used in memory tracking. Hence, I suggest to introduce a new variable to store the estimate of the flattened size of the block.", "author": "mbasmanova", "createdAt": "2020-04-08T17:58:45Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -479,13 +480,15 @@ public void partitionPage(Page page)\n             }\n \n             // Decode the page just once. The decoded blocks will be fed to each PartitionBuffer object to set up AbstractBlockEncodingBuffer.\n+            decodedBlocksRetainedSize = 0;\n             for (int i = 0; i < decodedBlocks.length; i++) {\n                 decodedBlocks[i] = decodeBlock(flattener, blockLeaseCloser, page.getBlock(i));\n+                decodedBlocksRetainedSize += decodedBlocks[i].getRetainedSizeInBytes();\n             }\n \n             // Copy the data to their destination partitions and flush when the buffer is full.\n             for (int i = 0; i < partitionBuffers.length; i++) {\n-                partitionBuffers[i].appendData(decodedBlocks, page.getRetainedSizeInBytes(), fixedWidthRowSize, variableWidthChannels, outputBuffer);\n+                partitionBuffers[i].appendData(decodedBlocks, decodedBlocksRetainedSize, fixedWidthRowSize, variableWidthChannels, outputBuffer);", "originalCommit": "2bd5d9398b65d800ad22962830d76a918338a808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "313f4f7021205d085f6b7c0624d04008726d7217", "url": "https://github.com/prestodb/presto/commit/313f4f7021205d085f6b7c0624d04008726d7217", "message": "Change nested buffers to AbstractBlockEncodingBuffer", "committedDate": "2020-04-11T09:33:36Z", "type": "commit"}, {"oid": "b041b908e36e801064caa30a6bfb644ebfb3598b", "url": "https://github.com/prestodb/presto/commit/b041b908e36e801064caa30a6bfb644ebfb3598b", "message": "Refactor getRetainedSizeInBytes in DecodedBlockNode", "committedDate": "2020-04-11T09:36:24Z", "type": "commit"}, {"oid": "2f391eedc9463947aec4933c6a0fc5964d007dbf", "url": "https://github.com/prestodb/presto/commit/2f391eedc9463947aec4933c6a0fc5964d007dbf", "message": "Rename pageSize to partitionBufferCapacity", "committedDate": "2020-04-11T09:36:30Z", "type": "commit"}, {"oid": "e639da8f3e758be16f567f8308c16ec65fcb02a3", "url": "https://github.com/prestodb/presto/commit/e639da8f3e758be16f567f8308c16ec65fcb02a3", "message": "Introduce estimatedSerializedSizeInBytes in ColumnarXXX", "committedDate": "2020-04-11T09:36:30Z", "type": "commit"}, {"oid": "d36491c8d09da458243fc4d965a74c5b7383218f", "url": "https://github.com/prestodb/presto/commit/d36491c8d09da458243fc4d965a74c5b7383218f", "message": "Introduce estimatedSerializedSizeInBytes in DecodedBlockNode", "committedDate": "2020-04-11T11:06:12Z", "type": "commit"}, {"oid": "0908a03dc5a6bd7a191530c912c3e7c856f941ec", "url": "https://github.com/prestodb/presto/commit/0908a03dc5a6bd7a191530c912c3e7c856f941ec", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' logical sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-04-11T11:06:19Z", "type": "forcePushed"}, {"oid": "0c827933d5fa5eff2a3b2f44bcce41e28f099a95", "url": "https://github.com/prestodb/presto/commit/0c827933d5fa5eff2a3b2f44bcce41e28f099a95", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' logical sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-04-12T03:56:53Z", "type": "commit"}, {"oid": "0c827933d5fa5eff2a3b2f44bcce41e28f099a95", "url": "https://github.com/prestodb/presto/commit/0c827933d5fa5eff2a3b2f44bcce41e28f099a95", "message": "Enforce buffer size limits for BlockEncodingBuffer\n\nThe byte[] buffers in BlockEncodingBuffer used to be grown by a factor\nof 2. This could cause the buffers larger than necessary. Reducing\nthe expansionFactor has negative impact on performance. Therefore we\nwant to enforce stricter limit when growing these buffers. This commit\nuses incoming blocks' logical sizes as an estimation for how large the\nbuffers can grow. It shows 30% to 40% memory usage reduction for fixed\nwidth types and 10% reduction for variable width types for the\nOptimizedPartitionedOutputOperator.", "committedDate": "2020-04-12T03:56:53Z", "type": "forcePushed"}]}