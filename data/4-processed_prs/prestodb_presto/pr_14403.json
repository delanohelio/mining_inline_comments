{"pr_number": 14403, "pr_title": "Fix WarningsCollector", "pr_createdAt": "2020-04-17T02:35:56Z", "pr_url": "https://github.com/prestodb/presto/pull/14403", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MTAxOQ==", "url": "https://github.com/prestodb/presto/pull/14403#discussion_r409971019", "bodyText": "nit:static import", "author": "caithagoras", "createdAt": "2020-04-17T03:25:54Z", "path": "presto-tests/src/test/java/com/facebook/presto/execution/TestWarnings.java", "diffHunk": "@@ -64,40 +64,49 @@ public void testStageCountWarningThreshold()\n                     .append(stageIndex);\n         }\n         String query = queryBuilder.toString();\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(TOO_MANY_STAGES.toWarningCode()));\n-        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(TOO_MANY_STAGES.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableSet.of());\n     }\n \n     @Test\n     public void testNonReservedWordWarning()\n     {\n         String query = \"SELECT CURRENT_ROLE, t.current_role FROM (VALUES (3)) t(current_role)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n     }\n \n     @Test\n     public void testNewReservedWordsWarning()\n     {\n         String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+    }\n+\n+    @Test\n+    public void testWarningsAreNotStateful()\n+    {\n+        String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+        // Make sure the previous warning is not carried into the next query\n+        query = \"SELECT UNCALLED, t.uncalled FROM (VALUES (3)) t(uncalled)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of());\n     }\n \n     @Test\n     public void testQuotedIdentifiersDoNotTriggerWarning()\n     {\n         String query = \"SELECT \\\"CALLED\\\" FROM (VALUES (3)) t(\\\"called\\\")\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of());\n     }\n \n-    private static void assertWarnings(QueryRunner queryRunner, Session session, @Language(\"SQL\") String sql, List<WarningCode> expectedWarnings)\n+    private static void assertWarnings(QueryRunner queryRunner, Session session, @Language(\"SQL\") String sql, Set<WarningCode> expectedWarnings)\n     {\n         Set<WarningCode> warnings = queryRunner.execute(session, sql).getWarnings().stream()\n                 .map(PrestoWarning::getWarningCode)\n                 .collect(toImmutableSet());\n-        for (WarningCode warningCode : expectedWarnings) {\n-            if (!warnings.contains(warningCode)) {\n-                fail(\"Expected warning: \" + warningCode);\n-            }\n-        }\n+        Set<WarningCode> expectedButMissing = Sets.difference(expectedWarnings, warnings);\n+        Set<WarningCode> unexpectedWarnings = Sets.difference(warnings, expectedWarnings);", "originalCommit": "beb9cd85534c4f636af1473ba7c022e1e18b6505", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MTU2OQ==", "url": "https://github.com/prestodb/presto/pull/14403#discussion_r409971569", "bodyText": "nit: add a line break before line 90 for readability.", "author": "caithagoras", "createdAt": "2020-04-17T03:28:17Z", "path": "presto-tests/src/test/java/com/facebook/presto/execution/TestWarnings.java", "diffHunk": "@@ -64,40 +64,49 @@ public void testStageCountWarningThreshold()\n                     .append(stageIndex);\n         }\n         String query = queryBuilder.toString();\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(TOO_MANY_STAGES.toWarningCode()));\n-        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(TOO_MANY_STAGES.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableSet.of());\n     }\n \n     @Test\n     public void testNonReservedWordWarning()\n     {\n         String query = \"SELECT CURRENT_ROLE, t.current_role FROM (VALUES (3)) t(current_role)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n     }\n \n     @Test\n     public void testNewReservedWordsWarning()\n     {\n         String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+    }\n+\n+    @Test\n+    public void testWarningsAreNotStateful()\n+    {\n+        String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+        // Make sure the previous warning is not carried into the next query", "originalCommit": "beb9cd85534c4f636af1473ba7c022e1e18b6505", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9994321155ad8d2545a16d1084bdd8f2ce42b102", "url": "https://github.com/prestodb/presto/commit/9994321155ad8d2545a16d1084bdd8f2ce42b102", "message": "Fix WarningsCollector\n\nWhen this was introduced in DispatchManager, it was unintentionally made\nto be stateful.", "committedDate": "2020-04-17T04:08:10Z", "type": "commit"}, {"oid": "9994321155ad8d2545a16d1084bdd8f2ce42b102", "url": "https://github.com/prestodb/presto/commit/9994321155ad8d2545a16d1084bdd8f2ce42b102", "message": "Fix WarningsCollector\n\nWhen this was introduced in DispatchManager, it was unintentionally made\nto be stateful.", "committedDate": "2020-04-17T04:08:10Z", "type": "forcePushed"}]}