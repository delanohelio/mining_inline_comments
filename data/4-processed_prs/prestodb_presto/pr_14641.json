{"pr_number": 14641, "pr_title": "Add session property for targetResultSize", "pr_createdAt": "2020-06-12T03:31:32Z", "pr_url": "https://github.com/prestodb/presto/pull/14641", "timeline": [{"oid": "9ec5a4f705ae64f47732dd87e611c01caeece40d", "url": "https://github.com/prestodb/presto/commit/9ec5a4f705ae64f47732dd87e611c01caeece40d", "message": "Add session property for targetResultSize\n\nSetting the `target_result_size` session property will add the specified\n`targetResultSize` as a parameter to the nextUri in a statement.", "committedDate": "2020-06-12T03:34:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MzA5NQ==", "url": "https://github.com/prestodb/presto/pull/14641#discussion_r441283095", "bodyText": "how about getTargetResultSize(session).ifPresent( targetResultSize ->  uri.queryParam(\"targetResultSize\", targetResultSize)) ?", "author": "cemcayiroglu", "createdAt": "2020-06-17T05:08:09Z", "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/Query.java", "diffHunk": "@@ -507,14 +509,18 @@ private synchronized void setQueryOutputInfo(QueryExecution.QueryOutputInfo outp\n \n     private synchronized URI createNextResultsUri(String scheme, UriInfo uriInfo, long nextToken)\n     {\n-        return uriInfo.getBaseUriBuilder()\n+        UriBuilder uri = uriInfo.getBaseUriBuilder()\n                 .scheme(scheme)\n                 .replacePath(\"/v1/statement/executing\")\n                 .path(queryId.toString())\n                 .path(String.valueOf(nextToken))\n                 .replaceQuery(\"\")\n-                .queryParam(\"slug\", slug)\n-                .build();\n+                .queryParam(\"slug\", this.slug);\n+        Optional<DataSize> targetResultSize = getTargetResultSize(session);", "originalCommit": "9ec5a4f705ae64f47732dd87e611c01caeece40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5MTQzOA==", "url": "https://github.com/prestodb/presto/pull/14641#discussion_r441691438", "bodyText": "It's a small point, but I didn't want the detail of whether or not the builder returns a copy to change the behavior.", "author": "tdcmeehan", "createdAt": "2020-06-17T16:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MzA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NDg1MA==", "url": "https://github.com/prestodb/presto/pull/14641#discussion_r445054850", "bodyText": "How this param is going to be used?", "author": "highker", "createdAt": "2020-06-24T17:26:30Z", "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/Query.java", "diffHunk": "@@ -507,14 +509,18 @@ private synchronized void setQueryOutputInfo(QueryExecution.QueryOutputInfo outp\n \n     private synchronized URI createNextResultsUri(String scheme, UriInfo uriInfo, long nextToken)\n     {\n-        return uriInfo.getBaseUriBuilder()\n+        UriBuilder uri = uriInfo.getBaseUriBuilder()\n                 .scheme(scheme)\n                 .replacePath(\"/v1/statement/executing\")\n                 .path(queryId.toString())\n                 .path(String.valueOf(nextToken))\n                 .replaceQuery(\"\")\n-                .queryParam(\"slug\", slug)\n-                .build();\n+                .queryParam(\"slug\", this.slug);\n+        Optional<DataSize> targetResultSize = getTargetResultSize(session);\n+        if (targetResultSize.isPresent()) {\n+            uri = uri.queryParam(\"targetResultSize\", targetResultSize.get());", "originalCommit": "9ec5a4f705ae64f47732dd87e611c01caeece40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NzE1MQ==", "url": "https://github.com/prestodb/presto/pull/14641#discussion_r445057151", "bodyText": "It's used here: https://github.com/prestodb/presto/blob/master/presto-main/src/main/java/com/facebook/presto/server/protocol/ExecutingStatementResource.java#L152\nThis will change the batch size to be streamed back from the coordinator to the client.\nThis change could have been made differently.  We could have chosen to not add this as a query parameter, and instead use it directly inside the coordinator (without parsing it from the URI).  The intent is to set a default from the coordinator to be sent back to the client.  Because there's already a query parameter for this in ExecutingStatementResource, it seemed natural to simply add it to the nextUri.", "author": "tdcmeehan", "createdAt": "2020-06-24T17:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NDg1MA=="}], "type": "inlineReview"}, {"oid": "3657d9a07814ed892be8b8b5af37e9403e2d1d13", "url": "https://github.com/prestodb/presto/commit/3657d9a07814ed892be8b8b5af37e9403e2d1d13", "message": "Add session property for targetResultSize\n\nSetting the `target_result_size` session property will add the specified\n`targetResultSize` as a parameter to the nextUri in a statement.", "committedDate": "2020-06-25T05:01:26Z", "type": "commit"}, {"oid": "3657d9a07814ed892be8b8b5af37e9403e2d1d13", "url": "https://github.com/prestodb/presto/commit/3657d9a07814ed892be8b8b5af37e9403e2d1d13", "message": "Add session property for targetResultSize\n\nSetting the `target_result_size` session property will add the specified\n`targetResultSize` as a parameter to the nextUri in a statement.", "committedDate": "2020-06-25T05:01:26Z", "type": "forcePushed"}]}