{"pr_number": 15256, "pr_title": "Add thrift serde support for TaskStatus", "pr_createdAt": "2020-09-30T21:21:51Z", "pr_url": "https://github.com/prestodb/presto/pull/15256", "timeline": [{"oid": "0b6097d5eb1fb2092803bbf5c38f1e3fca0a7a95", "url": "https://github.com/prestodb/presto/commit/0b6097d5eb1fb2092803bbf5c38f1e3fca0a7a95", "message": "Add thrift support for TaskStatus serde", "committedDate": "2020-09-30T21:31:48Z", "type": "forcePushed"}, {"oid": "1b8765bd9aed72d967793d6d7495c2e699568b9b", "url": "https://github.com/prestodb/presto/commit/1b8765bd9aed72d967793d6d7495c2e699568b9b", "message": "Add thrift serde support for TaskStatus", "committedDate": "2020-09-30T21:34:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyODgwMg==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497828802", "bodyText": "Had to make this a public constructor since drift did not have support for factory methods like Jackson (We can add in something if there are more use cases that require this). At present drift only supports constructors and Builder method . Let me know if there is a better way.", "author": "ajaygeorge", "createdAt": "2020-09-30T22:08:33Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/HostAddress.java", "diffHunk": "@@ -73,7 +77,8 @@\n      */\n     private final int port;\n \n-    private HostAddress(String host, int port)\n+    @ThriftConstructor\n+    public HostAddress(String host, int port)", "originalCommit": "1b8765bd9aed72d967793d6d7495c2e699568b9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjYxOQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497832619", "bodyText": "I think it's fine.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyODgwMg=="}], "type": "inlineReview"}, {"oid": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "url": "https://github.com/prestodb/presto/commit/3fcdbc67fee0c055292a10c2d98a77423ea6160b", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-09-30T22:10:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyOTcxNg==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497829716", "bodyText": "We'll need to get concrete versions of these before merge.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:10:55Z", "path": "pom.xml", "diffHunk": "@@ -45,15 +45,15 @@\n         <air.maven.version>3.3.9</air.maven.version>\n \n         <dep.antlr.version>4.7.1</dep.antlr.version>\n-        <dep.airlift.version>0.194</dep.airlift.version>\n+        <dep.airlift.version>0.195-SNAPSHOT</dep.airlift.version>", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyOTg2OQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497829869", "bodyText": "Can you move this up (so it's not next to the test dependencies)?", "author": "tdcmeehan", "createdAt": "2020-09-30T22:11:18Z", "path": "presto-client/pom.xml", "diffHunk": "@@ -87,5 +87,9 @@\n             <artifactId>testng</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk4MDIwMQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497980201", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-10-01T04:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyOTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDEyOQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497830129", "bodyText": "isRecursive = TRUE -- Cool!  Did not know of this trick.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:12:04Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/ExecutionFailureInfo.java", "diffHunk": "@@ -72,53 +79,61 @@ public ExecutionFailureInfo(\n     }\n \n     @JsonProperty\n+    @ThriftField(1)\n     public String getType()\n     {\n         return type;\n     }\n \n     @Nullable\n     @JsonProperty\n+    @ThriftField(2)\n     public String getMessage()\n     {\n         return message;\n     }\n \n     @Nullable\n     @JsonProperty\n+    @ThriftField(value = 3, isRecursive = TRUE, requiredness = OPTIONAL)", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDkxMw==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497830913", "bodyText": "While we're doing this exercise, it would be nice not have to do String parsing for these values.  Did you consider an alternate constructor, perhaps that takes in a boolean with OptionalInt, and validates that when it's not grouped it's empty, and when it's grouped it's not empty?", "author": "tdcmeehan", "createdAt": "2020-09-30T22:14:05Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/Lifespan.java", "diffHunk": "@@ -67,7 +71,22 @@ public static Lifespan jsonCreator(String value)\n         return Lifespan.driverGroup(parseInt(value.substring(\"Group\".length())));\n     }\n \n+    @ThriftConstructor", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk4MTA2Ng==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497981066", "bodyText": "This logic was sort of mimicking what the json factory method was doing.\npublic static Lifespan jsonCreator(String value)", "author": "ajaygeorge", "createdAt": "2020-10-01T04:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5NjAzOA==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r501196038", "bodyText": "I wonder if we can use jsonCreator(String value) here.  We can rename the method. createLifeSpan?", "author": "cemcayiroglu", "createdAt": "2020-10-07T17:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMDk0Ng==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r501210946", "bodyText": "@cemcayiroglu  don't think a constructor can refer to a factory method directly. The alternate is going the builder route which in drift requires a complete Builder class. We can try adding in support for factory methods similar to what Jackson does as a good enhancement later on.", "author": "ajaygeorge", "createdAt": "2020-10-07T18:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMTI4Nw==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497831287", "bodyText": "I would add a comment saying that the order needs to be backwards compatible, because in theory the TaskState could be persisted.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:15:03Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskState.java", "diffHunk": "@@ -13,11 +13,15 @@\n  */\n package com.facebook.presto.execution;\n \n+import com.facebook.drift.annotations.ThriftEnum;\n+import com.facebook.drift.annotations.ThriftEnumValue;\n+\n import java.util.Set;\n import java.util.stream.Stream;\n \n import static com.google.common.collect.ImmutableSet.toImmutableSet;\n \n+@ThriftEnum\n public enum TaskState", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxNTAxMA==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r499015010", "bodyText": "Added explicit codes for enums", "author": "ajaygeorge", "createdAt": "2020-10-02T19:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMTI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjQxMg==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497832412", "bodyText": "Move this up please.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:18:05Z", "path": "presto-spi/pom.xml", "diffHunk": "@@ -115,5 +115,9 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk4MDI4Mw==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497980283", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-10-01T04:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjU5OQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497832599", "bodyText": "Similar here--please comment saying that the ordinal needs to be backwards compatible.", "author": "tdcmeehan", "createdAt": "2020-09-30T22:18:36Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/ErrorType.java", "diffHunk": "@@ -13,10 +13,20 @@\n  */\n package com.facebook.presto.spi;\n \n+import com.facebook.drift.annotations.ThriftEnum;\n+import com.facebook.drift.annotations.ThriftEnumValue;\n+\n+@ThriftEnum", "originalCommit": "3fcdbc67fee0c055292a10c2d98a77423ea6160b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk4MDYwOQ==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r497980609", "bodyText": "I was wondering if it would make sense to do a refactoring to add a integer code as a constructor\nsomething like  USER_ERROR(0) , INTERNAL_ERROR(1) and so on.", "author": "ajaygeorge", "createdAt": "2020-10-01T04:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxNDkyMg==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r499014922", "bodyText": "done", "author": "ajaygeorge", "createdAt": "2020-10-02T19:37:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMjU5OQ=="}], "type": "inlineReview"}, {"oid": "bc8bddee5e7d0daeeb3d3a25e04bda3a3e1a73e6", "url": "https://github.com/prestodb/presto/commit/bc8bddee5e7d0daeeb3d3a25e04bda3a3e1a73e6", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-10-01T04:42:33Z", "type": "forcePushed"}, {"oid": "bf32528d0cb1a0ae57263a52d360144d6b36223d", "url": "https://github.com/prestodb/presto/commit/bf32528d0cb1a0ae57263a52d360144d6b36223d", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-10-02T19:37:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwMTU5Nw==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r501201597", "bodyText": "Are we sure about covering the case when ExecutionFailureInfo is recursive?", "author": "cemcayiroglu", "createdAt": "2020-10-07T17:52:27Z", "path": "presto-main/src/test/java/com/facebook/presto/execution/TestThriftTaskStatus.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution;\n+\n+import com.facebook.drift.codec.ThriftCodec;\n+import com.facebook.drift.codec.ThriftCodecManager;\n+import com.facebook.drift.codec.internal.compiler.CompilerThriftCodecFactory;\n+import com.facebook.drift.codec.internal.reflection.ReflectionThriftCodecFactory;\n+import com.facebook.drift.protocol.TBinaryProtocol;\n+import com.facebook.drift.protocol.TCompactProtocol;\n+import com.facebook.drift.protocol.TFacebookCompactProtocol;\n+import com.facebook.drift.protocol.TMemoryBuffer;\n+import com.facebook.drift.protocol.TProtocol;\n+import com.facebook.drift.protocol.TTransport;\n+import com.facebook.presto.spi.HostAddress;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.PrestoTransportException;\n+import com.facebook.presto.sql.parser.ParsingException;\n+import com.facebook.presto.sql.tree.NodeLocation;\n+import com.facebook.presto.util.Failures;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.spi.StandardErrorCode.REMOTE_TASK_ERROR;\n+import static com.facebook.presto.spi.StandardErrorCode.SYNTAX_ERROR;\n+import static com.facebook.presto.spi.StandardErrorCode.TOO_MANY_REQUESTS_FAILED;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestThriftTaskStatus\n+{\n+    private static final ThriftCodecManager COMPILER_READ_CODEC_MANAGER = new ThriftCodecManager(new CompilerThriftCodecFactory(false));\n+    private static final ThriftCodecManager COMPILER_WRITE_CODEC_MANAGER = new ThriftCodecManager(new CompilerThriftCodecFactory(false));\n+    private static final ThriftCodec<TaskStatus> COMPILER_READ_CODEC = COMPILER_READ_CODEC_MANAGER.getCodec(TaskStatus.class);\n+    private static final ThriftCodec<TaskStatus> COMPILER_WRITE_CODEC = COMPILER_WRITE_CODEC_MANAGER.getCodec(TaskStatus.class);\n+    private static final ThriftCodecManager REFLECTION_READ_CODEC_MANAGER = new ThriftCodecManager(new ReflectionThriftCodecFactory());\n+    private static final ThriftCodecManager REFLECTION_WRITE_CODEC_MANAGER = new ThriftCodecManager(new ReflectionThriftCodecFactory());\n+    private static final ThriftCodec<TaskStatus> REFLECTION_READ_CODEC = REFLECTION_READ_CODEC_MANAGER.getCodec(TaskStatus.class);\n+    private static final ThriftCodec<TaskStatus> REFLECTION_WRITE_CODEC = REFLECTION_WRITE_CODEC_MANAGER.getCodec(TaskStatus.class);\n+    private static final TMemoryBuffer transport = new TMemoryBuffer(100 * 1024);\n+    public static final long TASK_INSTANCE_ID_LEAST_SIGNIFICANT_BITS = 123L;\n+    public static final long TASK_INSTANCE_ID_MOST_SIGNIFICANT_BITS = 456L;\n+    public static final long VERSION = 789L;\n+    public static final TaskState RUNNING = TaskState.RUNNING;\n+    public static final URI SELF_URI = java.net.URI.create(\"fake://task/\" + \"1\");\n+    public static final Set<Lifespan> LIFESPANS = ImmutableSet.of(Lifespan.taskWide(), Lifespan.taskWide());\n+    public static final int QUEUED_PARTITIONED_DRIVERS = 100;\n+    public static final int RUNNING_PARTITIONED_DRIVERS = 200;\n+    public static final double OUTPUT_BUFFER_UTILIZATION = 99.9;\n+    public static final boolean OUTPUT_BUFFER_OVERUTILIZED = true;\n+    public static final int PHYSICAL_WRITTEN_DATA_SIZE_IN_BYTES = 1024 * 1024;\n+    public static final int MEMORY_RESERVATION_IN_BYTES = 1024 * 1024 * 1024;\n+    public static final int SYSTEM_MEMORY_RESERVATION_IN_BYTES = 2 * 1024 * 1024 * 1024;\n+    public static final int FULL_GC_COUNT = 10;\n+    public static final int FULL_GC_TIME_IN_MILLIS = 1001;\n+    public static final HostAddress REMOTE_HOST = HostAddress.fromParts(\"www.fake.invalid\", 8080);\n+    private TaskStatus taskStatus;\n+\n+    @BeforeMethod\n+    public void setUp()\n+    {\n+        taskStatus = getTaskStatus();\n+    }\n+\n+    @DataProvider\n+    public Object[][] codecCombinations()\n+    {\n+        return new Object[][] {\n+                {COMPILER_READ_CODEC, COMPILER_WRITE_CODEC},\n+                {COMPILER_READ_CODEC, REFLECTION_WRITE_CODEC},\n+                {REFLECTION_READ_CODEC, COMPILER_WRITE_CODEC},\n+                {REFLECTION_READ_CODEC, REFLECTION_WRITE_CODEC}\n+        };\n+    }\n+\n+    @Test(dataProvider = \"codecCombinations\")\n+    public void testRoundTripSerializeBinaryProtocol(ThriftCodec<TaskStatus> readCodec, ThriftCodec<TaskStatus> writeCodec)\n+            throws Exception\n+    {\n+        TaskStatus taskStatus = getRoundTripSerialize(readCodec, writeCodec, TBinaryProtocol::new);\n+        assertSerde(taskStatus);\n+    }\n+\n+    @Test(dataProvider = \"codecCombinations\")\n+    public void testRoundTripSerializeTCompactProtocol(ThriftCodec<TaskStatus> readCodec, ThriftCodec<TaskStatus> writeCodec)\n+            throws Exception\n+    {\n+        TaskStatus taskStatus = getRoundTripSerialize(readCodec, writeCodec, TCompactProtocol::new);\n+        assertSerde(taskStatus);\n+    }\n+\n+    @Test(dataProvider = \"codecCombinations\")\n+    public void testRoundTripSerializeTFacebookCompactProtocol(ThriftCodec<TaskStatus> readCodec, ThriftCodec<TaskStatus> writeCodec)\n+            throws Exception\n+    {\n+        TaskStatus taskStatus = getRoundTripSerialize(readCodec, writeCodec, TFacebookCompactProtocol::new);\n+        assertSerde(taskStatus);\n+    }\n+\n+    private void assertSerde(TaskStatus taskStatus)\n+    {\n+        assertEquals(taskStatus.getTaskInstanceIdLeastSignificantBits(), 123L);\n+        assertEquals(taskStatus.getTaskInstanceIdMostSignificantBits(), 456L);\n+        assertEquals(taskStatus.getVersion(), 789L);\n+        assertEquals(taskStatus.getState(), TaskState.RUNNING);\n+        assertEquals(taskStatus.getSelf(), SELF_URI);\n+        assertEquals(taskStatus.getCompletedDriverGroups(), LIFESPANS);\n+        assertEquals(taskStatus.getQueuedPartitionedDrivers(), QUEUED_PARTITIONED_DRIVERS);\n+        assertEquals(taskStatus.getRunningPartitionedDrivers(), RUNNING_PARTITIONED_DRIVERS);\n+        assertEquals(taskStatus.getOutputBufferUtilization(), OUTPUT_BUFFER_UTILIZATION);\n+        assertEquals(taskStatus.isOutputBufferOverutilized(), OUTPUT_BUFFER_OVERUTILIZED);\n+        assertEquals(taskStatus.getPhysicalWrittenDataSizeInBytes(), PHYSICAL_WRITTEN_DATA_SIZE_IN_BYTES);\n+        assertEquals(taskStatus.getSystemMemoryReservationInBytes(), SYSTEM_MEMORY_RESERVATION_IN_BYTES);\n+        assertEquals(taskStatus.getFullGcCount(), FULL_GC_COUNT);\n+        assertEquals(taskStatus.getFullGcTimeInMillis(), FULL_GC_TIME_IN_MILLIS);\n+\n+        List<ExecutionFailureInfo> failures = taskStatus.getFailures();\n+        assertEquals(failures.size(), 3);\n+\n+        ExecutionFailureInfo firstFailure = failures.get(0);\n+        assertEquals(firstFailure.getType(), IOException.class.getName());\n+        assertEquals(firstFailure.getMessage(), \"Remote call timed out\");\n+        assertEquals(firstFailure.getErrorCode(), GENERIC_INTERNAL_ERROR.toErrorCode());\n+        List<ExecutionFailureInfo> suppressedFailures = firstFailure.getSuppressed();\n+        assertEquals(suppressedFailures.size(), 1);\n+        ExecutionFailureInfo suppressedFailure = suppressedFailures.get(0);\n+        assertEquals(suppressedFailure.getType(), IOException.class.getName());\n+        assertEquals(suppressedFailure.getMessage(), \"Thrift call timed out\");\n+        assertEquals(suppressedFailure.getErrorCode(), GENERIC_INTERNAL_ERROR.toErrorCode());\n+\n+        ExecutionFailureInfo secondFailure = failures.get(1);\n+        assertEquals(secondFailure.getType(), PrestoTransportException.class.getName());\n+        assertEquals(secondFailure.getMessage(), \"Too many requests failed\");\n+        assertEquals(secondFailure.getRemoteHost(), REMOTE_HOST);\n+        assertEquals(secondFailure.getErrorCode(), TOO_MANY_REQUESTS_FAILED.toErrorCode());\n+        ExecutionFailureInfo cause = secondFailure.getCause();\n+        assertEquals(cause.getType(), PrestoException.class.getName());\n+        assertEquals(cause.getMessage(), \"Remote Task Error\");\n+        assertEquals(cause.getErrorCode(), REMOTE_TASK_ERROR.toErrorCode());\n+\n+        ExecutionFailureInfo thirdFailure = failures.get(2);\n+        assertEquals(thirdFailure.getType(), ParsingException.class.getName());\n+        assertEquals(thirdFailure.getErrorCode(), SYNTAX_ERROR.toErrorCode());\n+        assertEquals(thirdFailure.getErrorLocation().getLineNumber(), 100);\n+        assertEquals(thirdFailure.getErrorLocation().getColumnNumber(), 3);\n+    }\n+\n+    private TaskStatus getRoundTripSerialize(ThriftCodec<TaskStatus> readCodec, ThriftCodec<TaskStatus> writeCodec, Function<TTransport, TProtocol> protocolFactory)\n+            throws Exception\n+    {\n+        TProtocol protocol = protocolFactory.apply(transport);\n+        writeCodec.write(taskStatus, protocol);\n+        return readCodec.read(protocol);\n+    }\n+\n+    private TaskStatus getTaskStatus()\n+    {\n+        List<ExecutionFailureInfo> executionFailureInfos = getExecutionFailureInfos();\n+        return new TaskStatus(\n+                TASK_INSTANCE_ID_LEAST_SIGNIFICANT_BITS,\n+                TASK_INSTANCE_ID_MOST_SIGNIFICANT_BITS,\n+                VERSION,\n+                RUNNING,\n+                SELF_URI,\n+                LIFESPANS,\n+                executionFailureInfos,\n+                QUEUED_PARTITIONED_DRIVERS,\n+                RUNNING_PARTITIONED_DRIVERS,\n+                OUTPUT_BUFFER_UTILIZATION,\n+                OUTPUT_BUFFER_OVERUTILIZED,\n+                PHYSICAL_WRITTEN_DATA_SIZE_IN_BYTES,\n+                MEMORY_RESERVATION_IN_BYTES,\n+                SYSTEM_MEMORY_RESERVATION_IN_BYTES,\n+                FULL_GC_COUNT,\n+                FULL_GC_TIME_IN_MILLIS);\n+    }\n+\n+    private List<ExecutionFailureInfo> getExecutionFailureInfos()\n+    {\n+        IOException ioException = new IOException(\"Remote call timed out\");\n+        ioException.addSuppressed(new IOException(\"Thrift call timed out\"));\n+        PrestoTransportException prestoTransportException = new PrestoTransportException(TOO_MANY_REQUESTS_FAILED,\n+                REMOTE_HOST,\n+                \"Too many requests failed\",\n+                new PrestoException(REMOTE_TASK_ERROR, \"Remote Task Error\"));\n+        ParsingException parsingException = new ParsingException(\"Parsing Exception\", new NodeLocation(100, 1));\n+        return Failures.toFailures(ImmutableList.of(ioException, prestoTransportException, parsingException));", "originalCommit": "bf32528d0cb1a0ae57263a52d360144d6b36223d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxNTU5Ng==", "url": "https://github.com/prestodb/presto/pull/15256#discussion_r501215596", "bodyText": "The PrestoTransportException takes in a PrestoException as a throwable which becomes the cause and starts setting up the recursive structure which we assert in these lines :\n        ExecutionFailureInfo secondFailure = failures.get(1);\n        assertEquals(secondFailure.getType(), PrestoTransportException.class.getName());\n        assertEquals(secondFailure.getMessage(), \"Too many requests failed\");\n        assertEquals(secondFailure.getRemoteHost(), REMOTE_HOST);\n        assertEquals(secondFailure.getErrorCode(), TOO_MANY_REQUESTS_FAILED.toErrorCode());\n        //The recursive structure\n        ExecutionFailureInfo cause = secondFailure.getCause();\n        assertEquals(cause.getType(), PrestoException.class.getName());\n        assertEquals(cause.getMessage(), \"Remote Task Error\");\n        assertEquals(cause.getErrorCode(), REMOTE_TASK_ERROR.toErrorCode());", "author": "ajaygeorge", "createdAt": "2020-10-07T18:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwMTU5Nw=="}], "type": "inlineReview"}, {"oid": "197c00e7d41279291c70ee5f7ad38bbec372ca9f", "url": "https://github.com/prestodb/presto/commit/197c00e7d41279291c70ee5f7ad38bbec372ca9f", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-10-09T00:43:11Z", "type": "forcePushed"}, {"oid": "d0c210685e9a65286de88e2e8f30cfe92b0ff96b", "url": "https://github.com/prestodb/presto/commit/d0c210685e9a65286de88e2e8f30cfe92b0ff96b", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-10-12T06:00:15Z", "type": "forcePushed"}, {"oid": "0e90d41091955f88de576b90dc9dbb716648c5b5", "url": "https://github.com/prestodb/presto/commit/0e90d41091955f88de576b90dc9dbb716648c5b5", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-12T06:36:28Z", "type": "forcePushed"}, {"oid": "bc8398147000dff1a459dc40b674fe8c390dea14", "url": "https://github.com/prestodb/presto/commit/bc8398147000dff1a459dc40b674fe8c390dea14", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-12T07:14:54Z", "type": "forcePushed"}, {"oid": "a404543d957049bf448f5aab8166094d2af81d2b", "url": "https://github.com/prestodb/presto/commit/a404543d957049bf448f5aab8166094d2af81d2b", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-12T17:42:21Z", "type": "forcePushed"}, {"oid": "b6a7acb7d677227db2f012711afa474150846a1f", "url": "https://github.com/prestodb/presto/commit/b6a7acb7d677227db2f012711afa474150846a1f", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-12T23:23:09Z", "type": "forcePushed"}, {"oid": "e7e72c16e52502dc90ad0e661eb04001e892009e", "url": "https://github.com/prestodb/presto/commit/e7e72c16e52502dc90ad0e661eb04001e892009e", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-13T17:35:37Z", "type": "forcePushed"}, {"oid": "b4f99f747fcede8d0f783a30ac9e957c83e3ff12", "url": "https://github.com/prestodb/presto/commit/b4f99f747fcede8d0f783a30ac9e957c83e3ff12", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-13T18:31:42Z", "type": "forcePushed"}, {"oid": "c8959df05868c1fb8953609c57f823a3822cc518", "url": "https://github.com/prestodb/presto/commit/c8959df05868c1fb8953609c57f823a3822cc518", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-13T21:26:58Z", "type": "forcePushed"}, {"oid": "10635d0b63e7ee47f9572b8d0e81a4613c8b9b41", "url": "https://github.com/prestodb/presto/commit/10635d0b63e7ee47f9572b8d0e81a4613c8b9b41", "message": "Add thrift serde support for TaskStatus\n\nAdded Drift annotations to TaskStatus and related classes\nto support thrift serde.", "committedDate": "2020-10-14T00:35:09Z", "type": "commit"}, {"oid": "169ac6a5d6faace69f1229288df35f5590ed57a5", "url": "https://github.com/prestodb/presto/commit/169ac6a5d6faace69f1229288df35f5590ed57a5", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-14T00:35:16Z", "type": "commit"}, {"oid": "169ac6a5d6faace69f1229288df35f5590ed57a5", "url": "https://github.com/prestodb/presto/commit/169ac6a5d6faace69f1229288df35f5590ed57a5", "message": "Update drift-api module's scope to provided\n\ndrift-api maven module is now part of SPI and should\nbe in provided scope.", "committedDate": "2020-10-14T00:35:16Z", "type": "forcePushed"}]}