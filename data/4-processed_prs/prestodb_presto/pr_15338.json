{"pr_number": 15338, "pr_title": "Change warning to ignore unreadable partitions to be a digest", "pr_createdAt": "2020-10-20T06:09:47Z", "pr_url": "https://github.com/prestodb/presto/pull/15338", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508670971", "bodyText": "Could you help to change partName to partitionName?", "author": "highker", "createdAt": "2020-10-20T16:26:54Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQyOTQ3Mg==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r509429472", "bodyText": "@highker , do you want me to later to change the MetastoreUtil.makePartName() method to makePartitionName() and modify all calls to the method to reflect the change? Even after familiarizing myself with the code, I often forgot that part = partition and wondered what a \"part\" was.", "author": "Moe82", "createdAt": "2020-10-21T16:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMTQyMA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r509531420", "bodyText": "Ya, makePartName sounds like a bad name. Let's leave the name for makePartName unchanged in this PR and maybe update it in another?", "author": "highker", "createdAt": "2020-10-21T18:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzOTcwNw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r509539707", "bodyText": "@highker , sounds good.", "author": "Moe82", "createdAt": "2020-10-21T18:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5NDEwMw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r513694103", "bodyText": "@highker , do you want me to submit a PR for this in the future? By the way, MetastoreUtil.makePartName() calls a method in Apache Hive that is also called makePartName.", "author": "Moe82", "createdAt": "2020-10-28T19:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5MTg5OQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508691899", "bodyText": "Could you help to change partitionNotReadable to reason?", "author": "highker", "createdAt": "2020-10-20T16:59:07Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n                         }\n-                        warningCollector.add(new PrestoWarning(\n-                                PARTITION_NOT_READABLE,\n-                                format(\"Table '%s' partition '%s' is not readable: %s\", tableName, partName, partitionNotReadable)));", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NDk3MQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508694971", "bodyText": "// put unreadable partitions with a limit of 2 in order not to be too verbose\nif (partitionsNotReadable.size() < 2) {\n    partitionsNotReadable.putIfAbsent(partitionNotReadable, new HashSet<>(ImmutableSet.of(partName)));\n    // limit per-reason partitions to be 2 as well\n    if (partitionsNotReadable.get(partitionNotReadable).size() < 2) {\n        partitionsNotReadable.get(partitionNotReadable).add(partName);\n    }\n}", "author": "highker", "createdAt": "2020-10-20T17:03:58Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n                         }\n-                        warningCollector.add(new PrestoWarning(\n-                                PARTITION_NOT_READABLE,\n-                                format(\"Table '%s' partition '%s' is not readable: %s\", tableName, partName, partitionNotReadable)));\n+                        partitionsNotReadable.put(partName, partitionNotReadable);", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NTQzMw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508695433", "bodyText": "We wanna make it to be concise; so likely use a mutable hash map.\nMap<String, Set<String>> partitionsNotReadable = new HashMap<>();", "author": "highker", "createdAt": "2020-10-20T17:04:41Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,6 +382,7 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            ImmutableMap.Builder<String, String> partitionsNotReadable = ImmutableMap.builder();", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NTcwMg==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508695702", "bodyText": "Also add a counter to check how many unreadable partitions are skipped", "author": "highker", "createdAt": "2020-10-20T17:05:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,6 +382,7 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            ImmutableMap.Builder<String, String> partitionsNotReadable = ImmutableMap.builder();", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NjU3NQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508696575", "bodyText": "Directly use the hash map", "author": "highker", "createdAt": "2020-10-20T17:06:24Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +477,16 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            Map<String, String> map = partitionsNotReadable.build();\n+            Multimap<String, String> multiMap = HashMultimap.create();\n+            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n+                multiMap.put(entry.getValue(), entry.getKey());\n+            }", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc3Nw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508696777", "bodyText": "Just put into one warning", "author": "highker", "createdAt": "2020-10-20T17:06:45Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +477,16 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            Map<String, String> map = partitionsNotReadable.build();\n+            Multimap<String, String> multiMap = HashMultimap.create();\n+            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n+                multiMap.put(entry.getValue(), entry.getKey());\n+            }\n+            for (java.util.Map.Entry<String, Collection<String>> entry : multiMap.asMap().entrySet()) {\n+                warningCollector.add(new PrestoWarning(\n+                        PARTITION_NOT_READABLE,\n+                        format(\"Table '%s' has '%s' out of '%s' partitions: '%s' not readable: %s\", tableName, entry.getValue().size(), partitionBatch.size(), entry.getValue(), entry.getKey())));\n+            }", "originalCommit": "8a6e899be8bfc0d29a44bd2c94ad436750c83709", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUyMTk4Mw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511521983", "bodyText": "got it", "author": "Moe82", "createdAt": "2020-10-24T22:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczNjQxNA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r509736414", "bodyText": "output:\nTable <table name> has <number of unreadable partitions> out of <total partitions> partitions unreadable: \n<error>: < partitions> <\"...\" if more than 2 unreadable partitions have this error>\n<error>: < partitions> <\"...\" if more than 2 unreadable partitions have this error>\n<\"...\" if more than 2 types of errors>", "author": "Moe82", "createdAt": "2020-10-21T21:58:18Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -477,16 +489,15 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-            Map<String, String> map = partitionsNotReadable.build();\n-            Multimap<String, String> multiMap = HashMultimap.create();\n-            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n-                multiMap.put(entry.getValue(), entry.getKey());\n-            }\n-            for (java.util.Map.Entry<String, Collection<String>> entry : multiMap.asMap().entrySet()) {\n-                warningCollector.add(new PrestoWarning(\n-                        PARTITION_NOT_READABLE,\n-                        format(\"Table '%s' has '%s' out of '%s' partitions: '%s' not readable: %s\", tableName, entry.getValue().size(), partitionBatch.size(), entry.getValue(), entry.getKey())));\n+            String prestoWarningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, partitionsNotReadable.values().stream().mapToInt(Set::size).sum(), partitionBatch.size());\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2)\n+                    prestoWarningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().iterator().next() + \", \" + entry.getValue().iterator().next() + \" ...\";\n+                else prestoWarningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString();\n             }\n+            if (reasonsSkipped > 3)\n+                prestoWarningMessage += \"\\n...\";\n+            warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, prestoWarningMessage));", "originalCommit": "5404a67af7d2884e11488f12bdc6e0301046949c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "url": "https://github.com/prestodb/presto/commit/d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "message": "squashed commits", "committedDate": "2020-10-21T22:28:02Z", "type": "forcePushed"}, {"oid": "0dec341c3632f67a8934bebfc5e7be3e7126f801", "url": "https://github.com/prestodb/presto/commit/0dec341c3632f67a8934bebfc5e7be3e7126f801", "message": "squashed commits", "committedDate": "2020-10-22T00:49:34Z", "type": "forcePushed"}, {"oid": "a470486030e5c2a6a5e3bb68d6de110ee773ec2c", "url": "https://github.com/prestodb/presto/commit/a470486030e5c2a6a5e3bb68d6de110ee773ec2c", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-22T17:14:41Z", "type": "forcePushed"}, {"oid": "26af7843ce64e9cbb0e10206d7c7721185730ec3", "url": "https://github.com/prestodb/presto/commit/26af7843ce64e9cbb0e10206d7c7721185730ec3", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-22T17:51:42Z", "type": "forcePushed"}, {"oid": "b08bcc485df7ac67f754bb2fa92a597534906db6", "url": "https://github.com/prestodb/presto/commit/b08bcc485df7ac67f754bb2fa92a597534906db6", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-22T18:50:58Z", "type": "forcePushed"}, {"oid": "c6001b68f403655f235e07ed9a384b69b2542d39", "url": "https://github.com/prestodb/presto/commit/c6001b68f403655f235e07ed9a384b69b2542d39", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-22T18:53:46Z", "type": "forcePushed"}, {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713", "url": "https://github.com/prestodb/presto/commit/4541964184c36f4bb464a91515b0cd3d11dd1713", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-22T22:20:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjE4NA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102184", "bodyText": "We should move unreadablePartitionsSkipped++; before this if", "author": "highker", "createdAt": "2020-10-23T19:23:11Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {", "originalCommit": "4541964184c36f4bb464a91515b0cd3d11dd1713", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjMxMg==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102312", "bodyText": "remove this", "author": "highker", "createdAt": "2020-10-23T19:23:20Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 3) {\n+                                partitionsNotReadable.get(reason).add(partitionName);\n+                            }\n+                            else {\n+                                unreadablePartitionsSkipped++;\n+                            }", "originalCommit": "4541964184c36f4bb464a91515b0cd3d11dd1713", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjQzOQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102439", "bodyText": "remove this", "author": "highker", "createdAt": "2020-10-23T19:23:28Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 3) {\n+                                partitionsNotReadable.get(reason).add(partitionName);\n+                            }\n+                            else {\n+                                unreadablePartitionsSkipped++;\n+                            }\n+                        }\n+                        else {\n+                            unreadablePartitionsSkipped++;\n+                            reasonsSkipped++;\n                         }", "originalCommit": "4541964184c36f4bb464a91515b0cd3d11dd1713", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjkzNQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102935", "bodyText": "partitionsNotReadable.values().stream().mapToInt(Set::size).sum() should be replaced by unreadablePartitionsSkipped\njust name warningMessage", "author": "highker", "createdAt": "2020-10-23T19:24:06Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +491,19 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            String prestoWarningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, partitionsNotReadable.values().stream().mapToInt(Set::size).sum(), partitionBatch.size());", "originalCommit": "4541964184c36f4bb464a91515b0cd3d11dd1713", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8990b6abc31d63ba5a1db52879fcfd220cf6d0ed", "url": "https://github.com/prestodb/presto/commit/8990b6abc31d63ba5a1db52879fcfd220cf6d0ed", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-24T18:55:02Z", "type": "forcePushed"}, {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841", "url": "https://github.com/prestodb/presto/commit/02f4deab72a040a7b32d8afebc976d2fc7718841", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-24T19:16:34Z", "type": "forcePushed"}, {"oid": "56616a6e3f128ffc391676c0e8e3ed19799d56ec", "url": "https://github.com/prestodb/presto/commit/56616a6e3f128ffc391676c0e8e3ed19799d56ec", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-24T21:44:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTUwNg==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515506", "bodyText": "To be consistent with the following > 2, these two should be <= 2 right?", "author": "highker", "createdAt": "2020-10-24T21:19:10Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,32 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 4) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 4) {", "originalCommit": "02f4deab72a040a7b32d8afebc976d2fc7718841", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUyMDY0MQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511520641", "bodyText": "@highker , what I meant to type was <=3 in this section, and >2 in the other section. The reason the numbers are inconsistent is because by adding at most N partitions to partitionsNotReadable, then checking in the other section if there is more than N-1 partitions, the code can add N-1 partitions to the error message and decide whether a trailing \"...\" is needed or not.", "author": "Moe82", "createdAt": "2020-10-24T22:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTU1Ng==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515556", "bodyText": "You should update unreadablePartitionsSkipped in the for loop body", "author": "highker", "createdAt": "2020-10-24T21:19:54Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,32 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;", "originalCommit": "02f4deab72a040a7b32d8afebc976d2fc7718841", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTczNA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515734", "bodyText": "In test testPartitionNotReadable, right below assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);,  assert the error message popped out is the one you would expect.", "author": "highker", "createdAt": "2020-10-24T21:22:07Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +483,20 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            String warningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size());\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage += \"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\";\n+                }\n+                else {\n+                    warningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString();\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                warningMessage += \"\\n...\";\n+            }\n+            warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, warningMessage));", "originalCommit": "02f4deab72a040a7b32d8afebc976d2fc7718841", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNzY5OQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511517699", "bodyText": "In test testPartitionNotReadable, right below assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);, assert the warning you have is the one you expect", "author": "highker", "createdAt": "2020-10-24T21:46:12Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +483,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));", "originalCommit": "56616a6e3f128ffc391676c0e8e3ed19799d56ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUyMjIxNw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511522217", "bodyText": "got it", "author": "Moe82", "createdAt": "2020-10-24T22:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNzY5OQ=="}], "type": "inlineReview"}, {"oid": "092c8898b5e082124ed4848c6b5cd411544e7c05", "url": "https://github.com/prestodb/presto/commit/092c8898b5e082124ed4848c6b5cd411544e7c05", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-24T22:28:50Z", "type": "forcePushed"}, {"oid": "a6bafa004d6f9436463aa001df16ba6f79f51c01", "url": "https://github.com/prestodb/presto/commit/a6bafa004d6f9436463aa001df16ba6f79f51c01", "message": "add tests to validate the new format of the PrestoWarning message generated in HiveSplitManager.java", "committedDate": "2020-10-27T04:03:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNzM3Mw==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512407373", "bodyText": "prior to this if statement, max of 3 reasons in the warningMessage. If 3, delete the last one and append \"...\"\nHacky, but I wanted to avoid the possibility of the code adding 3 reasons plus \"...\" when there is exactly three reasons of unreadability in partitionsNotReadable.", "author": "Moe82", "createdAt": "2020-10-27T04:17:42Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\");\n+                }\n+                else {\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString());\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                if (warningMessage.lastIndexOf(\"\\n\") >= 0) {\n+                    warningMessage.delete(warningMessage.lastIndexOf(\"\\n\"), warningMessage.length());\n+                    warningMessage.append(\"\\n...\");\n+                }\n+            }", "originalCommit": "092c8898b5e082124ed4848c6b5cd411544e7c05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf8fe2eba5be164bbfacb124b270a642274cd174", "url": "https://github.com/prestodb/presto/commit/cf8fe2eba5be164bbfacb124b270a642274cd174", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java", "committedDate": "2020-10-27T06:46:38Z", "type": "forcePushed"}, {"oid": "cb456e9ced79dc759f4fa0a1f87aaae5bb9d015d", "url": "https://github.com/prestodb/presto/commit/cb456e9ced79dc759f4fa0a1f87aaae5bb9d015d", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java", "committedDate": "2020-10-27T06:49:17Z", "type": "forcePushed"}, {"oid": "9a0047f9eec5aa71da69526810bcb7b211247c3a", "url": "https://github.com/prestodb/presto/commit/9a0047f9eec5aa71da69526810bcb7b211247c3a", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java", "committedDate": "2020-10-27T06:53:11Z", "type": "forcePushed"}, {"oid": "1a676069f089c5b4773ed49de7e5f0e227f67d20", "url": "https://github.com/prestodb/presto/commit/1a676069f089c5b4773ed49de7e5f0e227f67d20", "message": "update TestHiveClientFileMetastore.java", "committedDate": "2020-10-27T15:10:40Z", "type": "forcePushed"}, {"oid": "f1943435f8981c9749a32ca41230ebd9ca3cab46", "url": "https://github.com/prestodb/presto/commit/f1943435f8981c9749a32ca41230ebd9ca3cab46", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java", "committedDate": "2020-10-27T15:39:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjMxMA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512806310", "bodyText": "@highker , how do I get the table name?\ntableName.getTableName() returns:\ntest.tmp_presto_test_temptable_becbe4b8516d4eedbc8f2ec61b9cf4c7\nbut the expected table name is:\ntmp_presto_test_temptable_becbe4b8516d4eedbc8f2ec61b9cf4c7\nI tried to trace, but I'm really not sure where 'test' is dropped.\nedit: Sorry, I see now that I can't access it inside the method. I'll squash the 2 commits for this file if it needs to be merged.\nedit: Is it ok if I modify createDummyPartitionedTable()? I just want to make sure that the case for 3 unreadable partitions is what I expect it to be. Probably is, but I figured it would be good to make sure.", "author": "Moe82", "createdAt": "2020-10-27T15:45:04Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientFileMetastore.java", "diffHunk": "@@ -152,6 +152,8 @@ public void testPartitionNotReadable()\n                 splitManager.getSplits(transaction.getTransactionHandle(), session, tableLayout.getHandle(), SPLIT_SCHEDULING_CONTEXT);\n                 assertNotNull(SPLIT_SCHEDULING_CONTEXT.getWarningCollector());\n                 assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);\n+                assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().get(0).getMessage(), String.format(\"Table '%s' has '1' out of '3' partitions unreadable:\\nTesting Unreadable Partition: [ds=2020-01-03]\", tableName.getTableName()));", "originalCommit": "f1943435f8981c9749a32ca41230ebd9ca3cab46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NjI4NA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512846284", "bodyText": "It doesn't have to be assertEquals. It could be assertTrue followed by a substring matching or something like that", "author": "highker", "createdAt": "2020-10-27T16:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjMxMA=="}], "type": "inlineReview"}, {"oid": "64a4910ff5df51fbe813fb5875935cd1cd8842ad", "url": "https://github.com/prestodb/presto/commit/64a4910ff5df51fbe813fb5875935cd1cd8842ad", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java", "committedDate": "2020-10-27T17:51:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MDY0NQ==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512980645", "bodyText": "We really don't need to be such complicated. Also, there are many bugs in this code block like (1) this should be guarded by an if, (2) .toString() is redundant, (3) entry.getValue().toString() is going to get you the memory pointer, etc. Let's simplify this logic:\nif (unreadablePartitionsSkipped > 0) {\n    StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n    for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n        warningMessage.append(join(\", \", entry.getValue()))\n                .append(\"... are due to \")\n                .append(entry.getKey())\n                .append(\". \");\n    }\n    warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, warningMessage.toString()));\n}", "author": "highker", "createdAt": "2020-10-27T19:43:11Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\");\n+                }\n+                else {\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString());\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                if (warningMessage.lastIndexOf(\"\\n\") >= 0) {\n+                    warningMessage.delete(warningMessage.lastIndexOf(\"\\n\"), warningMessage.length());\n+                    warningMessage.append(\"\\n...\");\n+                }\n+            }", "originalCommit": "64a4910ff5df51fbe813fb5875935cd1cd8842ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MTMxNA==", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512981314", "bodyText": "Some single quotes are not needed:\n\"Table '%s' has %s out of %s partitions unreadable: \"", "author": "highker", "createdAt": "2020-10-27T19:44:13Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));", "originalCommit": "64a4910ff5df51fbe813fb5875935cd1cd8842ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a1f2abae3f009ba825d1be7e9f2faa7e7b5b6df", "url": "https://github.com/prestodb/presto/commit/4a1f2abae3f009ba825d1be7e9f2faa7e7b5b6df", "message": "update TestHiveClientFileMetastore.java", "committedDate": "2020-10-27T19:44:28Z", "type": "forcePushed"}, {"oid": "18b4d705df6ca0295a4de068fdb18521d905b851", "url": "https://github.com/prestodb/presto/commit/18b4d705df6ca0295a4de068fdb18521d905b851", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-27T20:51:45Z", "type": "forcePushed"}, {"oid": "c6cc792499a5a7c2c99486156fc7db723e840554", "url": "https://github.com/prestodb/presto/commit/c6cc792499a5a7c2c99486156fc7db723e840554", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-27T21:28:59Z", "type": "forcePushed"}, {"oid": "187cda3368af9ca3dfd2d570a2cb748e483a23c9", "url": "https://github.com/prestodb/presto/commit/187cda3368af9ca3dfd2d570a2cb748e483a23c9", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-27T21:47:27Z", "type": "forcePushed"}, {"oid": "5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "url": "https://github.com/prestodb/presto/commit/5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-28T01:26:33Z", "type": "commit"}, {"oid": "5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "url": "https://github.com/prestodb/presto/commit/5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "message": "change warning to ignore unreadable partitions to be a digest", "committedDate": "2020-10-28T01:26:33Z", "type": "forcePushed"}]}