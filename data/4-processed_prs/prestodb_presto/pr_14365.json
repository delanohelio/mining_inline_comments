{"pr_number": 14365, "pr_title": "Disallow invoking SQL functions in SQL function body", "pr_createdAt": "2020-04-08T08:13:39Z", "pr_url": "https://github.com/prestodb/presto/pull/14365", "timeline": [{"oid": "1d36b74987527cf59aff202751e2e04505f0263d", "url": "https://github.com/prestodb/presto/commit/1d36b74987527cf59aff202751e2e04505f0263d", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-08T08:15:47Z", "type": "forcePushed"}, {"oid": "5b3277a3c1c3a55fc3b2b404a3aeb2b06715f489", "url": "https://github.com/prestodb/presto/commit/5b3277a3c1c3a55fc3b2b404a3aeb2b06715f489", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-08T08:20:37Z", "type": "forcePushed"}, {"oid": "5b451d60cfa9e5f0401fd3906ebeba799610b6ae", "url": "https://github.com/prestodb/presto/commit/5b451d60cfa9e5f0401fd3906ebeba799610b6ae", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-11T00:44:46Z", "type": "forcePushed"}, {"oid": "751a6b47b149619f857bbaa97ed2068c006d9113", "url": "https://github.com/prestodb/presto/commit/751a6b47b149619f857bbaa97ed2068c006d9113", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-11T00:49:17Z", "type": "forcePushed"}, {"oid": "f096eebe32522a3cb9869bee2fd985c743fd697c", "url": "https://github.com/prestodb/presto/commit/f096eebe32522a3cb9869bee2fd985c743fd697c", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-11T02:13:11Z", "type": "forcePushed"}, {"oid": "37ca10b2b2c69e5ea169f72abde07d6eebf84c9b", "url": "https://github.com/prestodb/presto/commit/37ca10b2b2c69e5ea169f72abde07d6eebf84c9b", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-11T02:50:23Z", "type": "forcePushed"}, {"oid": "770f164933f70ca2b361cf6d1645294f2dec9bc3", "url": "https://github.com/prestodb/presto/commit/770f164933f70ca2b361cf6d1645294f2dec9bc3", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-11T08:17:14Z", "type": "forcePushed"}, {"oid": "d1dcea2f9650d08df1b8dd5035f132482e14f044", "url": "https://github.com/prestodb/presto/commit/d1dcea2f9650d08df1b8dd5035f132482e14f044", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T03:47:34Z", "type": "forcePushed"}, {"oid": "dbbd557e435f88388db43e5b278c7711fa985868", "url": "https://github.com/prestodb/presto/commit/dbbd557e435f88388db43e5b278c7711fa985868", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T03:50:21Z", "type": "forcePushed"}, {"oid": "ea07d5429a3731e0b594f0f463222dbfc04a4b76", "url": "https://github.com/prestodb/presto/commit/ea07d5429a3731e0b594f0f463222dbfc04a4b76", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T07:26:54Z", "type": "forcePushed"}, {"oid": "ae9f961a011ea31026f73a976a2352c2ced6b964", "url": "https://github.com/prestodb/presto/commit/ae9f961a011ea31026f73a976a2352c2ced6b964", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T08:10:53Z", "type": "forcePushed"}, {"oid": "486e8a1911dfb3d8a819ae80fd4666b479cb27de", "url": "https://github.com/prestodb/presto/commit/486e8a1911dfb3d8a819ae80fd4666b479cb27de", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T09:15:36Z", "type": "forcePushed"}, {"oid": "967b53a1ed7cf760f2f2f87fadca5fbca8be94ef", "url": "https://github.com/prestodb/presto/commit/967b53a1ed7cf760f2f2f87fadca5fbca8be94ef", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T09:17:05Z", "type": "forcePushed"}, {"oid": "2cd49b3a6282b185ad7526e032916ebe00f54449", "url": "https://github.com/prestodb/presto/commit/2cd49b3a6282b185ad7526e032916ebe00f54449", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T09:23:01Z", "type": "forcePushed"}, {"oid": "aaa1872b1d0c0a121cf95888c5be2a09e0e17991", "url": "https://github.com/prestodb/presto/commit/aaa1872b1d0c0a121cf95888c5be2a09e0e17991", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T12:26:13Z", "type": "forcePushed"}, {"oid": "295bf088d74e89ffb5bce2a50ef544d64faffb40", "url": "https://github.com/prestodb/presto/commit/295bf088d74e89ffb5bce2a50ef544d64faffb40", "message": "Update h2 to 1.4.199", "committedDate": "2020-04-12T12:28:27Z", "type": "commit"}, {"oid": "271dc86c51397a07ae10f231a33461038ff690bd", "url": "https://github.com/prestodb/presto/commit/271dc86c51397a07ae10f231a33461038ff690bd", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-12T12:28:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MDg5Nw==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407790897", "bodyText": "What is this change about?", "author": "rongrong", "createdAt": "2020-04-14T00:12:48Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -7043,9 +7043,9 @@ public void testArrayShuffle()\n     @Test\n     public void testNonReservedTimeWords()\n     {\n-        assertQuery(\"\" +\n-                \"SELECT TIME, TIMESTAMP, DATE, INTERVAL\\n\" +\n-                \"FROM (SELECT 1 TIME, 2 TIMESTAMP, 3 DATE, 4 INTERVAL)\");\n+        assertQuery(", "originalCommit": "295bf088d74e89ffb5bce2a50ef544d64faffb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyOTYxNQ==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407929615", "bodyText": "This change fixes the test failure for upgrading H2 from 1.4.197 to 1.4.199.\n\nThe test runs the query in QueryRunner and H2QueryRunner and compares the results.\nIn H2 1.4.199, INTERVAL became a reserved word, making the query to fail on H2, causing test failure.\nThis test was to ensure those 4 words are not reserved words in Presto. Therefore, we just need to make sure that the original query can still be ran on Presto and it can produces the correct results.", "author": "caithagoras", "createdAt": "2020-04-14T07:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MDg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MTI0Mg==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407791242", "bodyText": "What is this change about? I don't think tuple and array has the same semantic meaning.", "author": "rongrong", "createdAt": "2020-04-14T00:13:53Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -76,7 +76,7 @@\n             \"   CASE WHEN orderkey % 43 = 0 THEN null ELSE (CAST(discount AS DECIMAL(20, 8)), CAST(tax AS DECIMAL(20, 8))) END AS long_decimals, \" +\n             \"   CASE WHEN orderkey % 11 = 0 THEN null ELSE (orderkey, partkey, suppkey) END AS keys, \\n\" +\n             \"   CASE WHEN orderkey % 41 = 0 THEN null ELSE (extendedprice, discount, tax) END AS doubles, \\n\" +\n-            \"   CASE WHEN orderkey % 13 = 0 THEN null ELSE ((orderkey, partkey), (suppkey,), CASE WHEN orderkey % 17 = 0 THEN null ELSE (orderkey, partkey) END) END AS nested_keys, \\n\" +\n+            \"   CASE WHEN orderkey % 13 = 0 THEN null ELSE ARRAY[ARRAY[orderkey, partkey], ARRAY[suppkey], CASE WHEN orderkey % 17 = 0 THEN null ELSE ARRAY[orderkey, partkey] END] END AS nested_keys, \\n\" +", "originalCommit": "295bf088d74e89ffb5bce2a50ef544d64faffb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzODQwOQ==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407938409", "bodyText": "This change fixes the test failure for upgrading H2 from 1.4.197 to 1.4.199.\n\nThis is an H2 query, not a Presto query. In H2 1.4.197, (suppkey, ) represents a 1-element Row; in H2 1.4.199, this became a syntax error.\nThis line of the H2 query is expected to match the Presto query on line 148 (which is Array, not Row), so it is actually more correct to write the H2 query in Arrays. Not planning to update all the other lines since improving the test is not the objective of this commit.\nH2 Rows are all unnamed, and is represented the same way as H2 Arrays. In the tests, H2 Rows are in the results are mapped to Arrays in MaterializedRow, and that's why the tests were passing even when the H2 query is selecting Rows while the Presto query is selecting Arrays.", "author": "caithagoras", "createdAt": "2020-04-14T07:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MjIwNw==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407792207", "bodyText": "Why it's not possible to \"create a function namespace from the query engine\"? What does this mean?", "author": "rongrong", "createdAt": "2020-04-14T00:17:02Z", "path": "presto-tests/src/main/java/com/facebook/presto/tests/DistributedQueryRunner.java", "diffHunk": "@@ -335,13 +342,44 @@ public void createCatalog(String catalogName, String connectorName, Map<String,\n         log.info(\"Announced catalog %s (%s) in %s\", catalogName, connectorId, nanosSince(start));\n     }\n \n+    @Override\n     public void loadFunctionNamespaceManager(String functionNamespaceManagerName, String catalogName, Map<String, String> properties)\n     {\n         for (TestingPrestoServer server : servers) {\n             server.getMetadata().getFunctionManager().loadFunctionNamespaceManager(functionNamespaceManagerName, catalogName, properties);\n         }\n     }\n \n+    /**\n+     * This method exists only because it is currently impossible to create a function namespace from the query engine,", "originalCommit": "891d20194902a7172a92175a80fc922590fbfed4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNzM3OA==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r407927378", "bodyText": "I meant Presto Server are not able to create a function namespace - it can setup a function namespace manager that binds to a given catalog, but it don't create function namespaces within that catalog.\nTherefore, a unit test cannot use a client (e.g. QueryRunner), to run a query to create a function namespace testing.test, even if there is a catalog testing setup to be managed by a function namespace manager.\nTherefore, in order for a test to create a function in testing.test, the test will need to call some methods in the test framework to create the function namespace testing.test first, hence the purpose of this method.\nIf, in the future, we support creating function namespaces with CREATE SCHEMA syntax, this method, along with the H2 db handle will no longer be needed here.", "author": "caithagoras", "createdAt": "2020-04-14T07:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MjIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MDc4NA==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r408390784", "bodyText": "Change the comment to presto server then.", "author": "rongrong", "createdAt": "2020-04-14T19:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5MjIwNw=="}], "type": "inlineReview"}, {"oid": "ce1aceefb956465d405a5484769fe8a81641e10c", "url": "https://github.com/prestodb/presto/commit/ce1aceefb956465d405a5484769fe8a81641e10c", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T08:31:18Z", "type": "forcePushed"}, {"oid": "27f67a1239c0861c59e7357f7d9f409e1433cc8f", "url": "https://github.com/prestodb/presto/commit/27f67a1239c0861c59e7357f7d9f409e1433cc8f", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T08:36:39Z", "type": "forcePushed"}, {"oid": "d682a3ac896ceb183dea07b04d2cbee0dd37fc05", "url": "https://github.com/prestodb/presto/commit/d682a3ac896ceb183dea07b04d2cbee0dd37fc05", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T09:19:35Z", "type": "forcePushed"}, {"oid": "8a1c59415e43e3c1ee9f9befbcdf1f69af44b3be", "url": "https://github.com/prestodb/presto/commit/8a1c59415e43e3c1ee9f9befbcdf1f69af44b3be", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T09:43:13Z", "type": "forcePushed"}, {"oid": "2f1beac687a5b4b9c8384b44e1a8015ceeae6099", "url": "https://github.com/prestodb/presto/commit/2f1beac687a5b4b9c8384b44e1a8015ceeae6099", "message": "Support function namespace in integration tests\n\nAlso, remove unused line in MySqlFunctionNamespaceManagerModule.", "committedDate": "2020-04-14T10:08:34Z", "type": "commit"}, {"oid": "a8a555540aec4df7ba95d2ec734755feed075da6", "url": "https://github.com/prestodb/presto/commit/a8a555540aec4df7ba95d2ec734755feed075da6", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T10:08:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4OTU0Ng==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r408389546", "bodyText": "Just say \"not supported\". The \"yet\" makes it sound like something coming in the near future. \ud83d\ude02", "author": "rongrong", "createdAt": "2020-04-14T19:42:23Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/CreateFunctionTask.java", "diffHunk": "@@ -66,7 +70,12 @@ public String explain(CreateFunction statement, List<Expression> parameters)\n     public ListenableFuture<?> execute(CreateFunction statement, TransactionManager transactionManager, Metadata metadata, AccessControl accessControl, QueryStateMachine stateMachine, List<Expression> parameters)\n     {\n         Analyzer analyzer = new Analyzer(stateMachine.getSession(), metadata, sqlParser, accessControl, Optional.empty(), parameters, stateMachine.getWarningCollector());\n-        analyzer.analyze(statement);\n+        Analysis analysis = analyzer.analyze(statement);\n+        if (analysis.getFunctionHandles().values().stream()\n+                .anyMatch(SqlFunctionHandle.class::isInstance)) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Invoking a SQL function in SQL function body is not yet supported\");", "originalCommit": "a8a555540aec4df7ba95d2ec734755feed075da6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDcxMA==", "url": "https://github.com/prestodb/presto/pull/14365#discussion_r408434710", "bodyText": "I think it's probably better to say \"Invoking a dynamically registered function in SQL function body is not supported\".", "author": "rongrong", "createdAt": "2020-04-14T21:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4OTU0Ng=="}], "type": "inlineReview"}, {"oid": "30fbc58fec26bac1dbaa558f9fd04c9123b4806f", "url": "https://github.com/prestodb/presto/commit/30fbc58fec26bac1dbaa558f9fd04c9123b4806f", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T21:41:01Z", "type": "commit"}, {"oid": "30fbc58fec26bac1dbaa558f9fd04c9123b4806f", "url": "https://github.com/prestodb/presto/commit/30fbc58fec26bac1dbaa558f9fd04c9123b4806f", "message": "Disallow invoking SQL functions in SQL function body\n\nCurrent, executing a SQL function that calls another SQL function\nthrows internal error with \"compiler failed\" error message.\n\nIf the fix the compiling issue, we'll then have to properly handle\npossible recursion.\n\nTherefore, we should disallow such function body meanwhile.", "committedDate": "2020-04-14T21:41:01Z", "type": "forcePushed"}]}