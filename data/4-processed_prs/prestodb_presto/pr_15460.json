{"pr_number": 15460, "pr_title": "Store file names and sizes in partition parameters", "pr_createdAt": "2020-11-19T03:17:16Z", "pr_url": "https://github.com/prestodb/presto/pull/15460", "timeline": [{"oid": "a2f09ce760d577837e9bca1fba1d64daeeb5c515", "url": "https://github.com/prestodb/presto/commit/a2f09ce760d577837e9bca1fba1d64daeeb5c515", "message": "Add getFileSize() to retrieve the size of the file", "committedDate": "2020-11-19T03:20:15Z", "type": "commit"}, {"oid": "837efd384e31c3a477a11ab1c0c473f75afe120d", "url": "https://github.com/prestodb/presto/commit/837efd384e31c3a477a11ab1c0c473f75afe120d", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T03:20:15Z", "type": "forcePushed"}, {"oid": "7d2e61f744e0eed83ea8d5d7b261a45740510674", "url": "https://github.com/prestodb/presto/commit/7d2e61f744e0eed83ea8d5d7b261a45740510674", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T03:39:15Z", "type": "forcePushed"}, {"oid": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "url": "https://github.com/prestodb/presto/commit/ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T03:56:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMjQ5NA==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526602494", "bodyText": "make it 7 maybe", "author": "highker", "createdAt": "2020-11-19T05:26:10Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -17,21 +17,43 @@\n import com.facebook.presto.common.PageBuilder;\n import com.facebook.presto.common.block.BlockBuilder;\n import com.facebook.presto.spi.PrestoException;\n+import com.github.luben.zstd.Zstd;\n+import com.google.common.base.Joiner;\n import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.roaringbitmap.RoaringBitmap;\n \n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n import java.util.Optional;\n \n import static com.facebook.presto.common.type.BigintType.BIGINT;\n import static com.facebook.presto.common.type.VarcharType.VARCHAR;\n import static com.facebook.presto.hive.HiveErrorCode.MALFORMED_HIVE_FILE_STATISTICS;\n import static com.facebook.presto.hive.PartitionUpdate.FileWriteInfo;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n import static io.airlift.slice.Slices.utf8Slice;\n import static java.lang.String.format;\n \n public class HiveManifestUtils\n {\n     private static final int FILE_SIZE_CHANNEL = 0;\n     private static final int ROW_COUNT_CHANNEL = 1;\n+    private static final String CHARSET_NAME = \"ISO-8859-1\";\n+    private static final int COMPRESSION_LEVEL = 3; // default level", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMzYxMQ==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526603611", "bodyText": "I think can blindly compressing with roaring bitmap. It compress continuous range very well.", "author": "highker", "createdAt": "2020-11-19T05:29:58Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -85,4 +107,122 @@ public static long getFileSize(Page statisticsPage, int position)\n         }\n         return Optional.of(manifestBuilder.build());\n     }\n+\n+    public static Map<String, String> updatePartitionMetadataWithFileNamesAndSizes(PartitionUpdate partitionUpdate, Map<String, String> metadata)\n+    {\n+        ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n+        List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+\n+        // Sort the file infos based on fileName\n+        fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n+\n+        // Compress the file names into a consolidated string\n+        String fileNames = compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList()));\n+\n+        // Compress the file sizes\n+        String fileSizes = compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).map(Optional::get).collect(toImmutableList()));\n+\n+        partitionMetadata.put(FILE_NAMES, fileNames);\n+        partitionMetadata.put(FILE_SIZES, fileSizes);\n+        partitionMetadata.put(MANIFEST_VERSION, VERSION_1);\n+        partitionMetadata.putAll(metadata);\n+\n+        return partitionMetadata.build();\n+    }\n+\n+    static String compressFileNames(List<String> fileNames)\n+    {\n+        if (fileNames.size() == 1) {\n+            return fileNames.get(0);\n+        }\n+\n+        boolean isContinuousSequence = true;\n+        int start = 0;\n+        for (String name : fileNames) {\n+            if (start != Integer.parseInt(name)) {\n+                isContinuousSequence = false;\n+                break;\n+            }\n+            start++;\n+        }\n+\n+        if (isContinuousSequence) {\n+            return fileNames.get(fileNames.size() - 1);\n+        }\n+\n+        return compressFileNamesUsingRoaringBitmap(fileNames);", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1OTg0NA==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526659844", "bodyText": "Not really. For a list of continuous 100 numbers, RoaringBitMap is taking 218 bytes. But where as \"100\" takes 3 bytes. So the current code is more memory efficient.", "author": "NikhilCollooru", "createdAt": "2020-11-19T07:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMzYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNDkyNA==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526604924", "bodyText": "parseLong", "author": "highker", "createdAt": "2020-11-19T05:34:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -85,4 +107,122 @@ public static long getFileSize(Page statisticsPage, int position)\n         }\n         return Optional.of(manifestBuilder.build());\n     }\n+\n+    public static Map<String, String> updatePartitionMetadataWithFileNamesAndSizes(PartitionUpdate partitionUpdate, Map<String, String> metadata)\n+    {\n+        ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n+        List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+\n+        // Sort the file infos based on fileName\n+        fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n+\n+        // Compress the file names into a consolidated string\n+        String fileNames = compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList()));\n+\n+        // Compress the file sizes\n+        String fileSizes = compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).map(Optional::get).collect(toImmutableList()));\n+\n+        partitionMetadata.put(FILE_NAMES, fileNames);\n+        partitionMetadata.put(FILE_SIZES, fileSizes);\n+        partitionMetadata.put(MANIFEST_VERSION, VERSION_1);\n+        partitionMetadata.putAll(metadata);\n+\n+        return partitionMetadata.build();\n+    }\n+\n+    static String compressFileNames(List<String> fileNames)\n+    {\n+        if (fileNames.size() == 1) {\n+            return fileNames.get(0);\n+        }\n+\n+        boolean isContinuousSequence = true;\n+        int start = 0;\n+        for (String name : fileNames) {\n+            if (start != Integer.parseInt(name)) {\n+                isContinuousSequence = false;\n+                break;\n+            }\n+            start++;\n+        }\n+\n+        if (isContinuousSequence) {\n+            return fileNames.get(fileNames.size() - 1);\n+        }\n+\n+        return compressFileNamesUsingRoaringBitmap(fileNames);\n+    }\n+\n+    static List<String> decompressFileNames(String compressedFileNames)\n+    {\n+        // Check if the compressed fileNames string is a number\n+        if (compressedFileNames.matches(\"\\\\d+\")) {\n+            long end = Long.valueOf(compressedFileNames);", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNTA4Ng==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526605086", "bodyText": "ImmutableList.of(\"0\")?", "author": "highker", "createdAt": "2020-11-19T05:34:44Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -85,4 +107,122 @@ public static long getFileSize(Page statisticsPage, int position)\n         }\n         return Optional.of(manifestBuilder.build());\n     }\n+\n+    public static Map<String, String> updatePartitionMetadataWithFileNamesAndSizes(PartitionUpdate partitionUpdate, Map<String, String> metadata)\n+    {\n+        ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n+        List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+\n+        // Sort the file infos based on fileName\n+        fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n+\n+        // Compress the file names into a consolidated string\n+        String fileNames = compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList()));\n+\n+        // Compress the file sizes\n+        String fileSizes = compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).map(Optional::get).collect(toImmutableList()));\n+\n+        partitionMetadata.put(FILE_NAMES, fileNames);\n+        partitionMetadata.put(FILE_SIZES, fileSizes);\n+        partitionMetadata.put(MANIFEST_VERSION, VERSION_1);\n+        partitionMetadata.putAll(metadata);\n+\n+        return partitionMetadata.build();\n+    }\n+\n+    static String compressFileNames(List<String> fileNames)\n+    {\n+        if (fileNames.size() == 1) {\n+            return fileNames.get(0);\n+        }\n+\n+        boolean isContinuousSequence = true;\n+        int start = 0;\n+        for (String name : fileNames) {\n+            if (start != Integer.parseInt(name)) {\n+                isContinuousSequence = false;\n+                break;\n+            }\n+            start++;\n+        }\n+\n+        if (isContinuousSequence) {\n+            return fileNames.get(fileNames.size() - 1);\n+        }\n+\n+        return compressFileNamesUsingRoaringBitmap(fileNames);\n+    }\n+\n+    static List<String> decompressFileNames(String compressedFileNames)\n+    {\n+        // Check if the compressed fileNames string is a number\n+        if (compressedFileNames.matches(\"\\\\d+\")) {\n+            long end = Long.valueOf(compressedFileNames);\n+\n+            if (end == 0) {\n+                return Collections.singletonList(\"0\");", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNjA3OA==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526606078", "bodyText": "return LongStream.range(0, end + 1).mapToObj(String::valueOf).collect(toImmutableList());", "author": "highker", "createdAt": "2020-11-19T05:38:13Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -85,4 +107,122 @@ public static long getFileSize(Page statisticsPage, int position)\n         }\n         return Optional.of(manifestBuilder.build());\n     }\n+\n+    public static Map<String, String> updatePartitionMetadataWithFileNamesAndSizes(PartitionUpdate partitionUpdate, Map<String, String> metadata)\n+    {\n+        ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n+        List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+\n+        // Sort the file infos based on fileName\n+        fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n+\n+        // Compress the file names into a consolidated string\n+        String fileNames = compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList()));\n+\n+        // Compress the file sizes\n+        String fileSizes = compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).map(Optional::get).collect(toImmutableList()));\n+\n+        partitionMetadata.put(FILE_NAMES, fileNames);\n+        partitionMetadata.put(FILE_SIZES, fileSizes);\n+        partitionMetadata.put(MANIFEST_VERSION, VERSION_1);\n+        partitionMetadata.putAll(metadata);\n+\n+        return partitionMetadata.build();\n+    }\n+\n+    static String compressFileNames(List<String> fileNames)\n+    {\n+        if (fileNames.size() == 1) {\n+            return fileNames.get(0);\n+        }\n+\n+        boolean isContinuousSequence = true;\n+        int start = 0;\n+        for (String name : fileNames) {\n+            if (start != Integer.parseInt(name)) {\n+                isContinuousSequence = false;\n+                break;\n+            }\n+            start++;\n+        }\n+\n+        if (isContinuousSequence) {\n+            return fileNames.get(fileNames.size() - 1);\n+        }\n+\n+        return compressFileNamesUsingRoaringBitmap(fileNames);\n+    }\n+\n+    static List<String> decompressFileNames(String compressedFileNames)\n+    {\n+        // Check if the compressed fileNames string is a number\n+        if (compressedFileNames.matches(\"\\\\d+\")) {\n+            long end = Long.valueOf(compressedFileNames);\n+\n+            if (end == 0) {\n+                return Collections.singletonList(\"0\");\n+            }\n+\n+            ImmutableList.Builder<String> fileNames = ImmutableList.builder();\n+            for (long i = 0; i <= end; i++) {\n+                fileNames.add(String.valueOf(i));\n+            }\n+\n+            return fileNames.build();", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNjM1Mw==", "url": "https://github.com/prestodb/presto/pull/15460#discussion_r526606353", "bodyText": "Maybe also add one after this by randomly generating a sequence of numbers. Same like the one you did in testFileSizesCompression", "author": "highker", "createdAt": "2020-11-19T05:39:13Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveManifestUtils.java", "diffHunk": "@@ -76,6 +82,45 @@ public void testCreatePartitionManifest()\n         assertEquals(manifestPage.get().getPositionCount(), 1);\n     }\n \n+    @Test\n+    public void testFileNamesCompression()\n+    {\n+        List<String> fileNames = new ArrayList<>();\n+\n+        // File names are continuous and sequential\n+        for (int i = 0; i <= 100; i++) {\n+            fileNames.add(String.valueOf(i));\n+        }\n+\n+        String compressedSequentialFileNames = compressFileNames(fileNames);\n+        assertEquals(fileNames, decompressFileNames(compressedSequentialFileNames));\n+\n+        // File names NOT sequential\n+        fileNames.clear();\n+        for (int i = 0; i <= 100; i++) {\n+            if (i % 10 == 0) {\n+                continue;\n+            }\n+            fileNames.add(String.valueOf(i));\n+        }\n+\n+        String compressedNonSequentialFileNames = compressFileNames(fileNames);\n+        assertEquals(fileNames, decompressFileNames(compressedNonSequentialFileNames));\n+    }", "originalCommit": "ec3352a3f9fb2e971e22ebdf3c49d4a15b279371", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f68dfd8cfb192c2efa6978b656c27b45925411b", "url": "https://github.com/prestodb/presto/commit/1f68dfd8cfb192c2efa6978b656c27b45925411b", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T07:53:27Z", "type": "forcePushed"}, {"oid": "3ed5a668c6ffead416e706072b24380610b3d054", "url": "https://github.com/prestodb/presto/commit/3ed5a668c6ffead416e706072b24380610b3d054", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T09:41:44Z", "type": "forcePushed"}, {"oid": "283a088c9f669f58edb2b591211ab88a9e4b959c", "url": "https://github.com/prestodb/presto/commit/283a088c9f669f58edb2b591211ab88a9e4b959c", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T10:22:15Z", "type": "commit"}, {"oid": "283a088c9f669f58edb2b591211ab88a9e4b959c", "url": "https://github.com/prestodb/presto/commit/283a088c9f669f58edb2b591211ab88a9e4b959c", "message": "Store file names and sizes in partition parameters", "committedDate": "2020-11-19T10:22:15Z", "type": "forcePushed"}]}