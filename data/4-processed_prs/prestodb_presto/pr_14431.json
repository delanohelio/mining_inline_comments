{"pr_number": 14431, "pr_title": "Fix query client timeout", "pr_createdAt": "2020-04-24T05:16:32Z", "pr_url": "https://github.com/prestodb/presto/pull/14431", "timeline": [{"oid": "f05292c4bab0687f78692bec82a42d7e26eaf2af", "url": "https://github.com/prestodb/presto/commit/f05292c4bab0687f78692bec82a42d7e26eaf2af", "message": "Fix query client timeout", "committedDate": "2020-04-24T05:18:29Z", "type": "forcePushed"}, {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a", "url": "https://github.com/prestodb/presto/commit/0769cac3bb940fd02117222c08aa08a505c6486a", "message": "Fix query client timeout", "committedDate": "2020-04-24T05:22:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjI5Mg==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414796292", "bodyText": "Why do we need to recreate the server for each method? Starting and stopping a server is usually slow and prone to memory leaks", "author": "arhimondr", "createdAt": "2020-04-24T18:59:07Z", "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -44,48 +49,38 @@\n     private final HttpClient client = new JettyHttpClient();\n     private TestingPrestoServer server;\n \n-    public TestQueryResource()\n-            throws Exception\n-    {\n-        server = new TestingPrestoServer();\n-    }\n-\n-    @BeforeClass\n+    @BeforeMethod", "originalCommit": "0769cac3bb940fd02117222c08aa08a505c6486a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMTc1NA==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414801754", "bodyText": "I see why is it needed. Basically you need to recreate the server to reset the counters.\nWhat do you think about simply moving the runToCompletion  statements to the test itself? Then you can simply add the runToQueued and adjust the counters.", "author": "arhimondr", "createdAt": "2020-04-24T19:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNjcwOQ==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414806709", "bodyText": "Sounds reasonable", "author": "tdcmeehan", "createdAt": "2020-04-24T19:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjUzMw==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414796533", "bodyText": "We should initialize it in setup and close and nullify it in teardown to avoid memory leaks", "author": "arhimondr", "createdAt": "2020-04-24T18:59:32Z", "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -44,48 +49,38 @@\n     private final HttpClient client = new JettyHttpClient();", "originalCommit": "0769cac3bb940fd02117222c08aa08a505c6486a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNTg4MA==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414805880", "bodyText": "I close it in teardownClass, will nullify too", "author": "tdcmeehan", "createdAt": "2020-04-24T19:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzUxMQ==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414797511", "bodyText": "Can we have lover timeouts? e.g.: 10s / 20s?", "author": "arhimondr", "createdAt": "2020-04-24T19:01:18Z", "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -103,12 +98,64 @@ public void testGetQueryInfos()\n         assertStateCounts(infos, 0, 0, 0);\n     }\n \n+    @Test(timeOut = 60_000)\n+    public void testExpiredQueryInfo()\n+            throws Exception\n+    {\n+        runToQueued(\"SELECT 1\");\n+\n+        Thread.sleep(TimeUnit.SECONDS.toMillis(40));", "originalCommit": "0769cac3bb940fd02117222c08aa08a505c6486a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNjgyNw==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414806827", "bodyText": "Sure", "author": "tdcmeehan", "createdAt": "2020-04-24T19:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyNzk1OQ==", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414827959", "bodyText": "nit: static import Thread.sleep and TimeUnit.SECONDS", "author": "caithagoras", "createdAt": "2020-04-24T19:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzUxMQ=="}], "type": "inlineReview"}, {"oid": "12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "url": "https://github.com/prestodb/presto/commit/12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "message": "Fix query client timeout", "committedDate": "2020-04-24T20:03:50Z", "type": "forcePushed"}, {"oid": "d377421aed3a65346cdb334cce06cef5c80c636c", "url": "https://github.com/prestodb/presto/commit/d377421aed3a65346cdb334cce06cef5c80c636c", "message": "Fix query client timeout", "committedDate": "2020-04-24T20:05:55Z", "type": "forcePushed"}, {"oid": "d393ac0c89af26e9d8a086befa163aa604311015", "url": "https://github.com/prestodb/presto/commit/d393ac0c89af26e9d8a086befa163aa604311015", "message": "Fix query client timeout", "committedDate": "2020-04-24T20:07:29Z", "type": "forcePushed"}, {"oid": "c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "url": "https://github.com/prestodb/presto/commit/c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "message": "Fix query client timeout", "committedDate": "2020-04-25T13:55:16Z", "type": "commit"}, {"oid": "c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "url": "https://github.com/prestodb/presto/commit/c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "message": "Fix query client timeout", "committedDate": "2020-04-25T13:55:16Z", "type": "forcePushed"}]}