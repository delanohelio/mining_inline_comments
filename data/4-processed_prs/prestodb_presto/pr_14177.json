{"pr_number": 14177, "pr_title": "A new end point to get resource group stats", "pr_createdAt": "2020-02-28T02:37:23Z", "pr_url": "https://github.com/prestodb/presto/pull/14177", "timeline": [{"oid": "8cc1509e25b124d43cf4e3c644d7538bb8ad0732", "url": "https://github.com/prestodb/presto/commit/8cc1509e25b124d43cf4e3c644d7538bb8ad0732", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. \"/v1/resourceGroupState/fullStatsOnly/\" end point\nis added to obtain resource groups level stats. The end point\nreturns ResourceGroupInfo that does not contain the running or queued queries.", "committedDate": "2020-02-28T02:45:22Z", "type": "forcePushed"}, {"oid": "8871f8e19aca2eb9488e08cde5561bda0bafda13", "url": "https://github.com/prestodb/presto/commit/8871f8e19aca2eb9488e08cde5561bda0bafda13", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed.", "committedDate": "2020-03-02T20:00:36Z", "type": "forcePushed"}, {"oid": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "url": "https://github.com/prestodb/presto/commit/023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-18T02:06:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzODM5OA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394538398", "bodyText": "do we envision this endpoint to stay longer, if yes then i would say let's make it little little more generic, i.e. by taking a key=value as input where isStatic=true and use that instead of dedicating the entire endpoing to pull static resource group.", "author": "swapsmagic", "createdAt": "2020-03-18T17:58:09Z", "path": "presto-main/src/main/java/com/facebook/presto/server/ResourceGroupStateInfoResource.java", "diffHunk": "@@ -68,6 +68,27 @@ public ResourceGroupInfo getQueryStateInfos(@PathParam(\"resourceGroupId\") String\n         throw new WebApplicationException(NOT_FOUND);\n     }\n \n+    @GET\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @Encoded\n+    @Path(\"getStaticResourceGroupInfo/{resourceGroupId: .+}\")", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyMzM2Nw==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394623367", "bodyText": "Makes sense I will change it. We should be able to receive the whole tree if needed.", "author": "cemcayiroglu", "createdAt": "2020-03-18T20:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzODM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTM3OQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394611379", "bodyText": "Should we add a static resource group check invariant here. If somehow we make a call to this function and it is not static, then it should return a null (preferably an Optional.empty()) or raise an UnsupportedOperationException ?", "author": "mayankgarg1990", "createdAt": "2020-03-18T20:12:00Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -204,6 +213,30 @@ public ResourceGroupInfo getInfo()\n         }\n     }\n \n+    public ResourceGroupInfo getStaticResourceGroupInfo()\n+    {\n+        synchronized (root) {\n+            return new ResourceGroupInfo(", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTUzNQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394771535", "bodyText": "Makes sense. I am going to add it.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMTM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyMjYzOQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394622639", "bodyText": "do we really need both of these? Should we just keep the OptionalInt one?", "author": "mayankgarg1990", "createdAt": "2020-03-18T20:33:31Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/resourceGroups/ResourceGroupSelectionContext.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi.resourceGroups;\n+\n+import java.util.Objects;\n+import java.util.OptionalInt;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class ResourceGroupSelectionContext\n+{\n+    private final OptionalInt dynamicSegmentPosition;\n+\n+    private ResourceGroupSelectionContext(OptionalInt dynamicSegmentPosition)\n+    {\n+        this.dynamicSegmentPosition = requireNonNull(dynamicSegmentPosition, \"dynamicSegmentPosition is null\");\n+    }\n+\n+    public static ResourceGroupSelectionContext createResourceGroupSelectionContext(int dynamicSegmentPosition)\n+    {\n+        return new ResourceGroupSelectionContext(OptionalInt.of(dynamicSegmentPosition));\n+    }\n+\n+    public static ResourceGroupSelectionContext createResourceGroupSelectionContext(OptionalInt dynamicSegmentPosition)\n+    {\n+        return new ResourceGroupSelectionContext(dynamicSegmentPosition);\n+    }", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3NTIwOA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394775208", "bodyText": "I will keep the OptionalInt.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyMjYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyNDY0OA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394624648", "bodyText": "Optional.of() will never return a null. You probably want to change this to Optional.of(requireNonNull())", "author": "mayankgarg1990", "createdAt": "2020-03-18T20:37:29Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/resourceGroups/SelectionContext.java", "diffHunk": "@@ -13,17 +13,28 @@\n  */\n package com.facebook.presto.spi.resourceGroups;\n \n+import java.util.Optional;\n+\n import static java.util.Objects.requireNonNull;\n \n public final class SelectionContext<T>\n {\n     private final ResourceGroupId resourceGroupId;\n     private final T context;\n+    private final Optional<ResourceGroupSelectionContext> resourceGroupSelectionContext;\n+\n+    public SelectionContext(ResourceGroupId resourceGroupId, T context, ResourceGroupSelectionContext resourceGroupSelectionContext)\n+    {\n+        this.resourceGroupId = requireNonNull(resourceGroupId, \"resourceGroupId is null\");\n+        this.context = requireNonNull(context, \"context is null\");\n+        this.resourceGroupSelectionContext = requireNonNull(Optional.of(resourceGroupSelectionContext), \"context is null\");", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyNTA2Mg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394625062", "bodyText": "Can you better explain the decision to go for a separate class, rather than maybe just adding dynamicFragmentId here directly?", "author": "mayankgarg1990", "createdAt": "2020-03-18T20:38:16Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/resourceGroups/SelectionContext.java", "diffHunk": "@@ -13,17 +13,28 @@\n  */\n package com.facebook.presto.spi.resourceGroups;\n \n+import java.util.Optional;\n+\n import static java.util.Objects.requireNonNull;\n \n public final class SelectionContext<T>\n {\n     private final ResourceGroupId resourceGroupId;\n     private final T context;\n+    private final Optional<ResourceGroupSelectionContext> resourceGroupSelectionContext;", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3NTkwNg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394775906", "bodyText": "I was thinking that we could add more properties here. Swapnil had some plans. I can change it to dynamicFragmentId. Another option was adding this to the ResourceGroupId directly.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyNTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3MjA4OQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394072089", "bodyText": "Could we add a getter to the context class and just check that it's present and equal to the id's segment count?  This would be OK if we had Java pattern matching :)", "author": "tdcmeehan", "createdAt": "2020-03-18T02:22:49Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -583,6 +621,11 @@ public InternalResourceGroup getOrCreateSubGroup(String name)\n         }\n     }\n \n+    private boolean isSubResourceGroupStatic(Optional<ResourceGroupSelectionContext> resourceGroupSelectionContext)\n+    {\n+        return !resourceGroupSelectionContext.equals(Optional.of(createResourceGroupSelectionContext(id.getSegments().size())));", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxOTkwNg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394619906", "bodyText": "In my opinion the name is redundant, since the class is called InternalResourceGroup.  How about isStatic?", "author": "tdcmeehan", "createdAt": "2020-03-18T20:28:22Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -87,6 +89,7 @@\n     private final ResourceGroupId id;\n     private final BiConsumer<InternalResourceGroup, Boolean> jmxExportListener;\n     private final Executor executor;\n+    private final boolean isStaticResourceGroup;", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTE5MQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394771191", "bodyText": "Sure, I will change.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxOTkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyMDU2NQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394620565", "bodyText": "Not sure I follow this.  Isn't this just checking if the present RG is static?  If so, why the name?", "author": "tdcmeehan", "createdAt": "2020-03-18T20:29:37Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -583,6 +621,11 @@ public InternalResourceGroup getOrCreateSubGroup(String name)\n         }\n     }\n \n+    private boolean isSubResourceGroupStatic(Optional<ResourceGroupSelectionContext> resourceGroupSelectionContext)", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTg3MQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394771871", "bodyText": "This is actually checking if the sub resource groups is dynamic.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyMDU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyOTU1Mg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394629552", "bodyText": "It seems like we're changing the semantics of this method.  It's not really just expanding the template into a resource group id, it's giving you an entire selection context.  I would keep this method unchanged but make it private, and make a new method which calls this method to get the id, and also does the below (and it's public).", "author": "tdcmeehan", "createdAt": "2020-03-18T20:46:59Z", "path": "presto-resource-group-managers/src/main/java/com/facebook/presto/resourceGroups/ResourceGroupIdTemplate.java", "diffHunk": "@@ -53,7 +57,7 @@ public static ResourceGroupIdTemplate fromSegments(List<ResourceGroupNameTemplat\n         return new ResourceGroupIdTemplate(String.join(\".\", segments.stream().map(ResourceGroupNameTemplate::toString).collect(Collectors.toList())));\n     }\n \n-    public ResourceGroupId expandTemplate(VariableMap context)\n+    public SelectionContext<VariableMap> expandTemplate(VariableMap context)", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3NTA0MQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394775041", "bodyText": "I will change it.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:44:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyOTU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2MDk4NA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394560984", "bodyText": "similar way as mentioned above, can we make this a generic method/lambda, i.e. getInfo with filter (i.e. group.isStaticResourceGroup being passed in the argument of the method and used here).", "author": "swapsmagic", "createdAt": "2020-03-18T18:36:52Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -204,6 +213,30 @@ public ResourceGroupInfo getInfo()\n         }\n     }\n \n+    public ResourceGroupInfo getStaticResourceGroupInfo()", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTM3MQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394771371", "bodyText": "Sure, I am going to update.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2MDk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4NzgwMg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394687802", "bodyText": "Coudn't understand the logic here, how are we deciding if a subgroup is static vs dynamic.  can you explain the logic here?", "author": "swapsmagic", "createdAt": "2020-03-18T23:02:32Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -583,6 +621,11 @@ public InternalResourceGroup getOrCreateSubGroup(String name)\n         }\n     }\n \n+    private boolean isSubResourceGroupStatic(Optional<ResourceGroupSelectionContext> resourceGroupSelectionContext)\n+    {\n+        return !resourceGroupSelectionContext.equals(Optional.of(createResourceGroupSelectionContext(id.getSegments().size())));", "originalCommit": "023a506cabcac22a6b0ad6cdd4e31da1316dc2d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3NDg3Mw==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r394774873", "bodyText": "resourceGroupSelectionContext is holding the dynamic segment index.\nFor example:\nabc_static.xyx_static.qwe_dynamic.sdq_static.\ndynamic segment index is 2.\nid.segment.size() is giving the size of the parent. This is also the index of the subgroup. so if parent.segment.size == dynamic segment index than the sub groups is dynamic.", "author": "cemcayiroglu", "createdAt": "2020-03-19T03:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4NzgwMg=="}], "type": "inlineReview"}, {"oid": "731665a839384f219355ec515412af05521ec9a0", "url": "https://github.com/prestodb/presto/commit/731665a839384f219355ec515412af05521ec9a0", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-19T07:07:27Z", "type": "forcePushed"}, {"oid": "cabda69f3b493958d7059056bb8ba1293791fe1e", "url": "https://github.com/prestodb/presto/commit/cabda69f3b493958d7059056bb8ba1293791fe1e", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-19T07:19:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4ODI5MA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395188290", "bodyText": "Why is this true? Sorry I don't have much background about resource group.", "author": "shixuan-fan", "createdAt": "2020-03-19T17:13:15Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -941,9 +987,12 @@ public int hashCode()\n     {\n         private AtomicBoolean taskLimitExceeded = new AtomicBoolean();\n \n-        public RootInternalResourceGroup(String name, BiConsumer<InternalResourceGroup, Boolean> jmxExportListener, Executor executor)\n+        public RootInternalResourceGroup(\n+                String name,\n+                BiConsumer<InternalResourceGroup, Boolean> jmxExportListener,\n+                Executor executor)\n         {\n-            super(Optional.empty(), name, jmxExportListener, executor);\n+            super(Optional.empty(), name, jmxExportListener, executor, true);", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3NzE4Ng==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395877186", "bodyText": "I guess the root resource group is always static", "author": "arhimondr", "createdAt": "2020-03-20T20:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4ODI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NTc4NA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397565784", "bodyText": "Yes!", "author": "cemcayiroglu", "createdAt": "2020-03-25T01:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4ODI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NjIxOQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395866219", "bodyText": "question: Why do we need a separate method? It is technically very similar to the getQueryStateInfos. It feels like it is possible to simply add a parameter to the getQueryStateInfos.\nFor example:\n\n?includeQueryInfo=true|false\n?summarizeSubgroups=true|false\n?includeDynamicSubgroups=true|false\n\nOr maybe something like:\n\n?subgroupsInfo={SUMMARIZE|STATIC|ALL}", "author": "arhimondr", "createdAt": "2020-03-20T20:08:27Z", "path": "presto-main/src/main/java/com/facebook/presto/server/ResourceGroupStateInfoResource.java", "diffHunk": "@@ -68,6 +68,27 @@ public ResourceGroupInfo getQueryStateInfos(@PathParam(\"resourceGroupId\") String\n         throw new WebApplicationException(NOT_FOUND);\n     }\n \n+    @GET\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @Encoded\n+    @Path(\"getResourceGroupInfo/{resourceGroupId: .+}\")\n+    public ResourceGroupInfo getStaticResourceGroupInfo(@PathParam(\"resourceGroupId\") String resourceGroupIdString)", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2NzI4OA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395867288", "bodyText": "How about firstDynamicSegmentPosition (same for the getter)?", "author": "arhimondr", "createdAt": "2020-03-20T20:11:08Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/resourceGroups/SelectionContext.java", "diffHunk": "@@ -13,17 +13,28 @@\n  */\n package com.facebook.presto.spi.resourceGroups;\n \n+import java.util.OptionalInt;\n+\n import static java.util.Objects.requireNonNull;\n \n public final class SelectionContext<T>\n {\n     private final ResourceGroupId resourceGroupId;\n     private final T context;\n+    private final OptionalInt dynamicSegmentPosition;", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2OTcxNA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395869714", "bodyText": "Why is it needed?\nIf it is needed indeed - we should explicitly annotate all parameters of the constructor as we do for other Json serializable objects (e.g.: https://github.com/prestodb/presto/blob/master/presto-main/src/main/java/com/facebook/presto/execution/QueryInfo.java#L82)", "author": "arhimondr", "createdAt": "2020-03-20T20:16:55Z", "path": "presto-main/src/main/java/com/facebook/presto/server/ResourceGroupInfo.java", "diffHunk": "@@ -51,6 +52,7 @@\n     private final List<ResourceGroupInfo> subGroups;\n     private final List<QueryStateInfo> runningQueries;\n \n+    @JsonCreator", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3MDY3Nw==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395870677", "bodyText": "nit: s/isStatic/static/. By convention boolean variables in java are declared without is. Geter names for boolean variables are constructed as is + VariableName.", "author": "arhimondr", "createdAt": "2020-03-20T20:19:08Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -87,6 +89,7 @@\n     private final ResourceGroupId id;\n     private final BiConsumer<InternalResourceGroup, Boolean> jmxExportListener;\n     private final Executor executor;\n+    private final boolean isStatic;", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3MjQ2Ng==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395872466", "bodyText": "How about changing this method signature to something like public ResourceGroupInfo getFullInfo(boolean includeQueryInfo, boolean summarizeSubgroups, boolean includeDynamicSubgroups)?", "author": "arhimondr", "createdAt": "2020-03-20T20:23:29Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -154,6 +162,7 @@ protected InternalResourceGroup(Optional<InternalResourceGroup> parent, String n\n             id = new ResourceGroupId(name);\n             root = this;\n         }\n+        this.isStatic = isStatic;\n     }\n \n     public ResourceGroupInfo getFullInfo()", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3NjkwMQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r395876901", "bodyText": "This code is a little bit hard to follow. Could you please explain why is it needed to pass the OptionalInt dynamicSegmentPosition as a parameter? And why simple boolean is not enough? It feels like createGroupIfNecessary could be setting this boolean.", "author": "arhimondr", "createdAt": "2020-03-20T20:34:03Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -565,15 +604,22 @@ public void setJmxExport(boolean export)\n         jmxExportListener.accept(this, export);\n     }\n \n-    public InternalResourceGroup getOrCreateSubGroup(String name)\n+    public InternalResourceGroup getOrCreateSubGroup(String name, OptionalInt dynamicSegmentPosition)", "originalCommit": "cabda69f3b493958d7059056bb8ba1293791fe1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "url": "https://github.com/prestodb/presto/commit/790fa608df4d63d25768f54928a8340c6d1e1f1a", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-25T01:45:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNjI0Mw==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397626243", "bodyText": "Given we mark a group with static group or non static group, we should renameincludeDynamicSubGroup to includeStaticGroupOnly and use it as per it's name. Calling this flag includeDynamicSubGroup makes it non align with how we mark the resource group.", "author": "swapsmagic", "createdAt": "2020-03-25T06:06:55Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -154,9 +160,10 @@ protected InternalResourceGroup(Optional<InternalResourceGroup> parent, String n\n             id = new ResourceGroupId(name);\n             root = this;\n         }\n+        this.staticResourceGroup = staticResourceGroup;\n     }\n \n-    public ResourceGroupInfo getFullInfo()\n+    public ResourceGroupInfo getResourceGroupInfo(boolean includeQueryInfo, boolean summarizeSubgroups, boolean includeDynamicSubgroups)", "originalCommit": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNjU3MA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397626570", "bodyText": "dynamic to be renamed as staticOnly and use it accordingly. Makes it much more clear with the staticResourceGroup flag.", "author": "swapsmagic", "createdAt": "2020-03-25T06:08:07Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -565,15 +578,22 @@ public void setJmxExport(boolean export)\n         jmxExportListener.accept(this, export);\n     }\n \n-    public InternalResourceGroup getOrCreateSubGroup(String name)\n+    public InternalResourceGroup getOrCreateSubGroup(String name, boolean dynamic)", "originalCommit": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNzAwMw==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397627003", "bodyText": "we can just call is static. ResourceGroup is redundant here.", "author": "swapsmagic", "createdAt": "2020-03-25T06:09:34Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -87,6 +87,7 @@\n     private final ResourceGroupId id;\n     private final BiConsumer<InternalResourceGroup, Boolean> jmxExportListener;\n     private final Executor executor;\n+    private final boolean staticResourceGroup;", "originalCommit": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyMDUxNg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398120516", "bodyText": "static is a reserved key word.", "author": "cemcayiroglu", "createdAt": "2020-03-25T19:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNzAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyNzk0Mg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398127942", "bodyText": "how about isStatic?", "author": "swapsmagic", "createdAt": "2020-03-25T19:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNzAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxOTY3Mg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398219672", "bodyText": "It used to be isStatic. I suggested to rename it to static, as usually in java the convention is to call boolean variables without is, and then add the is prefix for a getter. Let's keep it as is.", "author": "arhimondr", "createdAt": "2020-03-25T22:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNzAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0ODQxMg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397648412", "bodyText": "i think this logic works to identify the given resource group is static or not. But a much cleaner way would be, if we mark each segment of ResourceGroupId being static or not when we create them via group.expandTemplate call, then we can easily put the flag here. And no need to rely on the context.\ni.e. this line will become something like this\ngroup = parent.getOrCreateSubGroup(id.getLastSegment().getValue(), id.getLastSegment().isStatic());\nAnd i think to make this happen, we may need to change the segments in ResourceGroupId class from string to a class Segment which looks like this:\nclass Segment {\nString value;\nString isStatic;\n}", "author": "swapsmagic", "createdAt": "2020-03-25T07:19:40Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -239,7 +240,9 @@ private synchronized void createGroupIfNecessary(SelectionContext<C> context, Ex\n                 createGroupIfNecessary(new SelectionContext<>(id.getParent().get(), context.getContext()), executor);\n                 InternalResourceGroup parent = groups.get(id.getParent().get());\n                 requireNonNull(parent, \"parent is null\");\n-                group = parent.getOrCreateSubGroup(id.getLastSegment());\n+                // parent segments size equals to subgroup segment index\n+                int subGroupSegmentIndex = parent.getId().getSegments().size();\n+                group = parent.getOrCreateSubGroup(id.getLastSegment(), (context.getFirstDynamicSegmentPosition().equals(OptionalInt.of(subGroupSegmentIndex))));", "originalCommit": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyMDAxNA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398120014", "bodyText": "We had a offline chat with @swapsmagic. We concluded that introducing a segment class would require a major code change. We are going to keep it as is.", "author": "cemcayiroglu", "createdAt": "2020-03-25T19:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0ODQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0ODk2NQ==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r397648965", "bodyText": "may be call this as includeStaticSubgroupsOnly to make it consistent with how we tag the resource group.", "author": "swapsmagic", "createdAt": "2020-03-25T07:21:25Z", "path": "presto-main/src/main/java/com/facebook/presto/server/ResourceGroupStateInfoResource.java", "diffHunk": "@@ -51,15 +53,22 @@ public ResourceGroupStateInfoResource(ResourceGroupManager<?> resourceGroupManag\n     @Produces(MediaType.APPLICATION_JSON)\n     @Encoded\n     @Path(\"{resourceGroupId: .+}\")\n-    public ResourceGroupInfo getQueryStateInfos(@PathParam(\"resourceGroupId\") String resourceGroupIdString)\n+    public ResourceGroupInfo getQueryStateInfos(\n+            @PathParam(\"resourceGroupId\") String resourceGroupIdString,\n+            @QueryParam(\"includeQueryInfo\") @DefaultValue(\"true\") boolean includeQueryInfo,\n+            @QueryParam(\"summarizeSubgroups\") @DefaultValue(\"true\") boolean summarizeSubgroups,\n+            @QueryParam(\"includeDynamicSubgroups\") @DefaultValue(\"true\") boolean includeDynamicSubgroups)", "originalCommit": "790fa608df4d63d25768f54928a8340c6d1e1f1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "750ac9026ae8cb7bab3fb7edf28459910a132c48", "url": "https://github.com/prestodb/presto/commit/750ac9026ae8cb7bab3fb7edf28459910a132c48", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-26T05:18:00Z", "type": "commit"}, {"oid": "750ac9026ae8cb7bab3fb7edf28459910a132c48", "url": "https://github.com/prestodb/presto/commit/750ac9026ae8cb7bab3fb7edf28459910a132c48", "message": "An end point to get resource group level stats\n\nA load balancer can use resource group level stats to do better\nload balancing. The new endpoint returns a ResourceGroupInfo.\nResourceGroupInfo contains a list of ResourceGroupInfo's as its subtrees.\nResourceGroupInfo consists of basic stats (running and queued query counts)\nand actual queries as strings. This method leaves the queries empty\nsince it is not needed. The end method does not return the dynamically\ngenerated the resource groups.", "committedDate": "2020-03-26T05:18:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1MTE5MA==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398751190", "bodyText": "i think this should have been named as staticSubGroup", "author": "swapsmagic", "createdAt": "2020-03-26T17:20:47Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroup.java", "diffHunk": "@@ -565,15 +578,22 @@ public void setJmxExport(boolean export)\n         jmxExportListener.accept(this, export);\n     }\n \n-    public InternalResourceGroup getOrCreateSubGroup(String name)\n+    public InternalResourceGroup getOrCreateSubGroup(String name, boolean staticSegment)", "originalCommit": "750ac9026ae8cb7bab3fb7edf28459910a132c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1MjY0Mg==", "url": "https://github.com/prestodb/presto/pull/14177#discussion_r398752642", "bodyText": "summarizeSubgroups should be summarizeSubGroups to make it true camel case.", "author": "swapsmagic", "createdAt": "2020-03-26T17:22:53Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -103,10 +104,10 @@ public InternalResourceGroupManager(\n     }\n \n     @Override\n-    public ResourceGroupInfo getResourceGroupInfo(ResourceGroupId id)\n+    public ResourceGroupInfo getResourceGroupInfo(ResourceGroupId id, boolean includeQueryInfo, boolean summarizeSubgroups, boolean includeStaticSubgroupsOnly)", "originalCommit": "750ac9026ae8cb7bab3fb7edf28459910a132c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}