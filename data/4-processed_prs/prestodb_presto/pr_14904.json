{"pr_number": 14904, "pr_title": "Move TranslateExpressions above all PickTableLayouts", "pr_createdAt": "2020-07-28T07:16:31Z", "pr_url": "https://github.com/prestodb/presto/pull/14904", "timeline": [{"oid": "31f6cb401ead87f092e40d4e2baa180bbbe7db15", "url": "https://github.com/prestodb/presto/commit/31f6cb401ead87f092e40d4e2baa180bbbe7db15", "message": "Move TranslateExpressions above IndexJoinOptimizer", "committedDate": "2020-07-28T05:14:21Z", "type": "forcePushed"}, {"oid": "3733f4f65d805effd94efe77f867e6a94aca0072", "url": "https://github.com/prestodb/presto/commit/3733f4f65d805effd94efe77f867e6a94aca0072", "message": "Remove unused functions in ExpressionUtils", "committedDate": "2020-07-28T09:02:24Z", "type": "forcePushed"}, {"oid": "33730b213fa7f97c9f3c29d2f366b43974ecdc36", "url": "https://github.com/prestodb/presto/commit/33730b213fa7f97c9f3c29d2f366b43974ecdc36", "message": "Move TranslateExpressions below GatherAndMergeWindows", "committedDate": "2020-07-28T18:38:49Z", "type": "commit"}, {"oid": "8e86d968a5d8f054b205576572e44dd4edb0a9fd", "url": "https://github.com/prestodb/presto/commit/8e86d968a5d8f054b205576572e44dd4edb0a9fd", "message": "Move TranslateExpressions above GatherAndMergeWindows", "committedDate": "2020-07-28T18:38:49Z", "type": "commit"}, {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "url": "https://github.com/prestodb/presto/commit/af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "message": "Remove unused functions in ExpressionUtils", "committedDate": "2020-07-28T18:38:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng==", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461920086", "bodyText": "This return statement is very hard to read...Though I understand it is a copy-paste, maybe consider using variable name to represent each disjunctions?", "author": "shixuan-fan", "createdAt": "2020-07-28T22:11:05Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/GatherAndMergeWindows.java", "diffHunk": "@@ -176,10 +170,21 @@ public Result apply(WindowNode parent, Captures captures, Context context)\n         }\n     }\n \n-    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments, TypeProvider types)\n+    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments)\n     {\n         Collection<RowExpression> expressions = assignments.getExpressions();\n-        return VariablesExtractor.extractUnique(expressions.stream().map(OriginalExpressionUtils::castToExpression).collect(toImmutableList()), types);\n+        return VariablesExtractor.extractUnique(expressions);\n+    }\n+\n+    private static boolean dependsOn(WindowNode parent, WindowNode child)\n+    {\n+        return parent.getPartitionBy().stream().anyMatch(child.getCreatedVariable()::contains)", "originalCommit": "8e86d968a5d8f054b205576572e44dd4edb0a9fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2OTk3MQ==", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461969971", "bodyText": "This is a bit complicated.... I'm not sure if I understand the logic here correctly as well.", "author": "highker", "createdAt": "2020-07-29T00:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NDUxOA==", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461974518", "bodyText": "Let's keep it as is then :(", "author": "shixuan-fan", "createdAt": "2020-07-29T00:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjg0NA==", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r462002844", "bodyText": "Ya, a clearer way of writing it might be to extract all variables of parent into a collection, and then call anyMatch(child.getCreatedVariable()::contains) once. But I don't have strong opinions.", "author": "rongrong", "createdAt": "2020-07-29T02:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMTM1MA==", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461921350", "bodyText": "nit: static import?", "author": "shixuan-fan", "createdAt": "2020-07-28T22:12:44Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/WindowFilterPushDown.java", "diffHunk": "@@ -180,46 +183,46 @@ else if (source instanceof WindowNode && canOptimizeWindowFunction((WindowNode)\n \n         private PlanNode rewriteFilterSource(FilterNode filterNode, PlanNode source, VariableReferenceExpression rowNumberVariable, int upperBound)\n         {\n-            ExtractionResult extractionResult = fromPredicate(metadata, session, castToExpression(filterNode.getPredicate()), types);\n-            TupleDomain<String> tupleDomain = extractionResult.getTupleDomain();\n+            DomainTranslator.ExtractionResult<VariableReferenceExpression> extractionResult = domainTranslator.fromPredicate(session.toConnectorSession(), filterNode.getPredicate());", "originalCommit": "bc66f18da5e987304e0bd557293c71ed36edb21b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5134aae5c57be99dbe75ce965eaff3322cb4f77c", "url": "https://github.com/prestodb/presto/commit/5134aae5c57be99dbe75ce965eaff3322cb4f77c", "message": "Move TranslateExpressions above WindowFilterPushDown", "committedDate": "2020-07-29T00:22:15Z", "type": "commit"}, {"oid": "0e12605f7ab695216f3b7cf46522c38434774836", "url": "https://github.com/prestodb/presto/commit/0e12605f7ab695216f3b7cf46522c38434774836", "message": "Move TranslateExpressions above LimitPushDown", "committedDate": "2020-07-29T00:22:15Z", "type": "commit"}, {"oid": "f1cf7becca420ca158f7e3f55a9db4958138f216", "url": "https://github.com/prestodb/presto/commit/f1cf7becca420ca158f7e3f55a9db4958138f216", "message": "Move TranslateExpressions above SimplifyCountOverConstant", "committedDate": "2020-07-29T00:22:15Z", "type": "commit"}, {"oid": "6bb3f98d4da9135729ccab9abb0ddc5aa6be1072", "url": "https://github.com/prestodb/presto/commit/6bb3f98d4da9135729ccab9abb0ddc5aa6be1072", "message": "Move TranslateExpressions above IndexJoinOptimizer", "committedDate": "2020-07-29T00:32:27Z", "type": "commit"}, {"oid": "f042d9b3dde8a649e02a8f3ab25fbf773109d258", "url": "https://github.com/prestodb/presto/commit/f042d9b3dde8a649e02a8f3ab25fbf773109d258", "message": "Move TranslateExpressions below PushAggregationThroughOuterJoin\n\nThe patch also alters the variable names in TestTpcdsCostBasedPlan as\nvariable allocator assign names to variables based on function name\nhints. This causes assignment variables have function name hints before\ngot inlined with projections.", "committedDate": "2020-07-29T00:32:32Z", "type": "commit"}, {"oid": "8cc01f7d9c43fe6ea2d0338f936c8993b57fc66a", "url": "https://github.com/prestodb/presto/commit/8cc01f7d9c43fe6ea2d0338f936c8993b57fc66a", "message": "Move TranslateExpressions above PushAggregationThroughOuterJoin", "committedDate": "2020-07-29T00:32:32Z", "type": "commit"}, {"oid": "85e880851d34068b1ab70ceb3ae4eee5c6a4b3c9", "url": "https://github.com/prestodb/presto/commit/85e880851d34068b1ab70ceb3ae4eee5c6a4b3c9", "message": "Move TranslateExpressions above all PickTableLayouts", "committedDate": "2020-07-29T00:32:32Z", "type": "commit"}, {"oid": "c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "url": "https://github.com/prestodb/presto/commit/c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "message": "Remove unused functions in ExpressionUtils", "committedDate": "2020-07-29T00:32:32Z", "type": "commit"}, {"oid": "c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "url": "https://github.com/prestodb/presto/commit/c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "message": "Remove unused functions in ExpressionUtils", "committedDate": "2020-07-29T00:32:32Z", "type": "forcePushed"}]}