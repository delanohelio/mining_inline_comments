{"pr_number": 13979, "pr_title": "Improve error message for the array_agg function", "pr_createdAt": "2020-01-17T17:11:42Z", "pr_url": "https://github.com/prestodb/presto/pull/13979", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369287939", "bodyText": "Do we need this new error code? Maybe just use EXCEEDED_FUNCTION_MEMORY_LIMIT. @wenleix what do you think?", "author": "yingsu00", "createdAt": "2020-01-21T22:54:40Z", "path": "presto-spi/src/main/java/com/facebook/presto/spi/StandardErrorCode.java", "diffHunk": "@@ -63,6 +63,7 @@\n     QUERY_HAS_TOO_MANY_STAGES(0x0000_0028, USER_ERROR),\n     INVALID_SPATIAL_PARTITIONING(0x0000_0029, USER_ERROR),\n     INVALID_ANALYZE_PROPERTY(0x0000_002A, USER_ERROR),\n+    EXCEEDED_MAX_ARRAY_SIZE(0x0000_002B, USER_ERROR),", "originalCommit": "4e1e3ad3cd43615bef269af93abfabca411a1f06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5NzI3Mg==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369397272", "bodyText": "@yingsu00 : I agree an error code like EXCEEDED_MAX_ARRAY_SIZE sound too specific -- we might also want to restrict map or varchar size in the future. But EXCEEDED_FUNCTION_MEMORY_LIMIT doesn't sound like for this purpose as well.\nWhat about CELL_TOO_LARGE? -- basically it complaints the single array result from array_agg is too large. cc @highker , @rschlussel", "author": "wenleix", "createdAt": "2020-01-22T07:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxODY5Mg==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369418692", "bodyText": "@yingsu00 : I agree an error code like EXCEEDED_MAX_ARRAY_SIZE sound too specific -- we might also want to restrict map or varchar size in the future. But EXCEEDED_FUNCTION_MEMORY_LIMIT doesn't sound like for this purpose as well.\n\nI saw EXCEEDED_FUNCTION_MEMORY_LIMIT was only used in TypedSet#addNewElement which was mostly used aggregation functions. It is for very similar situation where a single element is too large to be added to destination BlockBuilder. If we're going to introduce new error code, maybe we should unify the usages.", "author": "yingsu00", "createdAt": "2020-01-22T08:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMyNDQwMw==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370324403", "bodyText": "Leaning towards EXCEEDED_FUNCTION_MEMORY_LIMIT as well since it is for a similar use case, and if we don't want to add very specific error codes.", "author": "sujay-jain", "createdAt": "2020-01-23T19:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzM4MQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370797381", "bodyText": "@sujay-jain @yinghai : No it's not the memory used by function. EXCEEDED_FUNCTION_MEMORY_LIMIT should be used when some function internal state exceeds memory limit, such as the internal hash table. In this case, the aggregation internal memory usage is correctly tracked and doesn't exceed. It's the final produced result too large.", "author": "wenleix", "createdAt": "2020-01-24T19:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzU0NQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370797545", "bodyText": "@sujay-jain : Please don't mark open discussion as \"resolved\" as it makes difficult to track.", "author": "wenleix", "createdAt": "2020-01-24T19:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzMzQ0Mg==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370833442", "bodyText": "@sujay-jain : Please don't open discussion as \"resolved\" as it makes difficult to track.\nsorry about that! wasn't sure about the best flow :)", "author": "sujay-jain", "createdAt": "2020-01-24T20:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4OTUyNQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369289525", "bodyText": "nit: I don't see other places using () around the values in the output message. Remove the brackets.", "author": "yingsu00", "createdAt": "2020-01-21T22:59:15Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/ArrayAggregationFunction.java", "diffHunk": "@@ -137,7 +141,13 @@ public static void output(Type elementType, ArrayAggregationState state, BlockBu\n         }\n         else {\n             BlockBuilder entryBuilder = out.beginBlockEntry();\n-            state.forEach((block, position) -> elementType.appendTo(block, position, entryBuilder));\n+            state.forEach((block, position) -> {\n+                if (entryBuilder.getRetainedSizeInBytes() > MAX_ARRAY_SIZE) {\n+                    throw new PrestoException(EXCEEDED_MAX_ARRAY_SIZE, format(\"Array size (%s) exceeds the maximum array size (%s)\", entryBuilder.getRetainedSizeInBytes(), MAX_ARRAY_SIZE));", "originalCommit": "4e1e3ad3cd43615bef269af93abfabca411a1f06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5MTAyMg==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369291022", "bodyText": "Could you please run BenchmarkArrayAggregation with and without the change to see how much regression this size check introduces?", "author": "yingsu00", "createdAt": "2020-01-21T23:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4OTUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMyMTE1Ng==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370321156", "bodyText": "Thanks for sugesting this! Here are the results. There are slight variations in sub nanosecond range if I'm reading this correctly. So doesn't seem like there a regression?\nMaster\nRun complete. Total time: 00:14:50\n\n\n\nBenchmark\n(type)\nMode\nCnt\nScore\nError\nUnits\n\n\n\n\nBenchmarkArrayAggregation.arrayAggregation\nBIGINT\navgt\n20\n9.560\n\u00b1 0.209\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nVARCHAR\navgt\n20\n26.718\n\u00b1 0.720\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nDOUBLE\navgt\n20\n9.388\n\u00b1 0.177\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nBOOLEAN\navgt\n20\n6.659\n\u00b1 0.178\nns/op\n\n\n\nWith current Changes\nRun complete. Total time: 00:14:49\n\n\n\nBenchmark\n(type)\nMode\nCnt\nScore\nError\nUnits\n\n\n\n\nBenchmarkArrayAggregation.arrayAggregation\nBIGINT\navgt\n20\n9.745\n\u00b1 0.391\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nVARCHAR\navgt\n20\n25.441\n\u00b1 0.524\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nDOUBLE\navgt\n20\n9.201\n\u00b1 0.178\nns/op\n\n\nBenchmarkArrayAggregation.arrayAggregation\nBOOLEAN\navgt\n20\n6.883\n\u00b1 0.338\nns/op", "author": "sujay-jain", "createdAt": "2020-01-23T19:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4OTUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5ODA0MQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369398041", "bodyText": "I think you might want to \"cut the line\" earlier. For example, if the current retained size is already MAX_ARRAY_SIZE - 10, and the next element has length 11 (thinking about ARRAY<VARCHAR>). You will still get cannot allocate Slice XXX error.\nI would say just define an constant like MAX_ENTRY_RETAINED_SIZE = 1_000_000_000 in this class.", "author": "wenleix", "createdAt": "2020-01-22T07:08:33Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/ArrayAggregationFunction.java", "diffHunk": "@@ -137,7 +141,13 @@ public static void output(Type elementType, ArrayAggregationState state, BlockBu\n         }\n         else {\n             BlockBuilder entryBuilder = out.beginBlockEntry();\n-            state.forEach((block, position) -> elementType.appendTo(block, position, entryBuilder));\n+            state.forEach((block, position) -> {\n+                if (entryBuilder.getRetainedSizeInBytes() > MAX_ARRAY_SIZE) {", "originalCommit": "4e1e3ad3cd43615bef269af93abfabca411a1f06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwMTQ5OQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r369401499", "bodyText": "Also, does it make sense to do the size check after the appendTo call? :)", "author": "wenleix", "createdAt": "2020-01-22T07:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5ODA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5NTI5Ng==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370295296", "bodyText": "if we're cutting the line at almost half the actual limit I don't see much difference between before or after.. Earlier I was erring towards new USER_ERROR as opposed to INTERNAL_ERROR coming from airlift. Leaving it like this but happy to discuss if you feel strongly about moving the check to after the append", "author": "sujay-jain", "createdAt": "2020-01-23T18:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5ODA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTg0MQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370795841", "bodyText": "@sujay-jain : I usually don't click \"Resolve conversation\" if it's still an open conversation :). I will leave it to the commenter to resolve it .\nIt's not about the behavior, I am pretty sure in almost real cases, they have the same result. It's from code flow perspective, you want to do the size check after you append something, rather than before you don't do any change ( thinking about eager check vs. lazy check). And in general we prefer eager check so the exception happened right after the problem happens.", "author": "wenleix", "createdAt": "2020-01-24T19:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5ODA0MQ=="}], "type": "inlineReview"}, {"oid": "d98d79508092abceb89c5254bf94a05fcecf2fbd", "url": "https://github.com/prestodb/presto/commit/d98d79508092abceb89c5254bf94a05fcecf2fbd", "message": "Improve error message for the array_agg function\n\nCurrently, array_agg throws a `GENERIC_INTERNAL_ERROR` when an array\nis too large. eg: \"Cannot allocate slice larger than 2147483639 bytes\"\nmessage is reported when the underlying data is stored in Slice.\nThis was confusing to users.\n\nThis commit throws `PrestoException` with\n`EXCEEDED_FUNCTION_MEMORY_LIMIT` error code\nwhen the retained size of a single array exceeds 1G.", "committedDate": "2020-01-23T18:50:03Z", "type": "forcePushed"}, {"oid": "1b17656ba6d53a0725a370687d6b5ff5f83b4f96", "url": "https://github.com/prestodb/presto/commit/1b17656ba6d53a0725a370687d6b5ff5f83b4f96", "message": "Improve error message for the array_agg function\n\nCurrently, array_agg throws a `GENERIC_INTERNAL_ERROR` when an array\nis too large. eg: \"Cannot allocate slice larger than 2147483639 bytes\"\nmessage is reported when the underlying data is stored in Slice.\nThis was confusing to users.\n\nThis commit throws `PrestoException` with\n`EXCEEDED_FUNCTION_MEMORY_LIMIT` error code\nwhen the retained size of a single array exceeds 1G.", "committedDate": "2020-01-24T21:38:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5NDAxMw==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370894013", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final int MAX_ENTRY_RETAINED_SIZE = 1_000_000_000;\n          \n          \n            \n                private static final int MAX_ENTRY_RETAINED_SIZE_IN_BYTES = 1_000_000_000;", "author": "tdcmeehan", "createdAt": "2020-01-25T00:15:56Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/ArrayAggregationFunction.java", "diffHunk": "@@ -41,16 +42,19 @@\n import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n import static com.facebook.presto.operator.aggregation.AggregationUtils.generateAggregationName;\n+import static com.facebook.presto.spi.StandardErrorCode.CELL_TOO_LARGE;\n import static com.facebook.presto.spi.function.Signature.typeVariable;\n import static com.facebook.presto.spi.type.TypeSignature.parseTypeSignature;\n import static com.facebook.presto.util.Reflection.methodHandle;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n import static java.util.Objects.requireNonNull;\n \n public class ArrayAggregationFunction\n         extends SqlAggregationFunction\n {\n     private static final String NAME = \"array_agg\";\n+    private static final int MAX_ENTRY_RETAINED_SIZE = 1_000_000_000;", "originalCommit": "1b17656ba6d53a0725a370687d6b5ff5f83b4f96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk3NjE4NA==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370976184", "bodyText": "MAX_ENTRY_RETAINED_SIZE_IN_BYTES = new DataSize(1, GIGABYTE).toBytes", "author": "highker", "createdAt": "2020-01-26T06:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5NDAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5NDcwMg==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r370894702", "bodyText": "Maybe consider using DataSize in format string so we can use the nice toString which includes units?", "author": "tdcmeehan", "createdAt": "2020-01-25T00:19:55Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/ArrayAggregationFunction.java", "diffHunk": "@@ -137,7 +141,13 @@ public static void output(Type elementType, ArrayAggregationState state, BlockBu\n         }\n         else {\n             BlockBuilder entryBuilder = out.beginBlockEntry();\n-            state.forEach((block, position) -> elementType.appendTo(block, position, entryBuilder));\n+            state.forEach((block, position) -> {\n+                elementType.appendTo(block, position, entryBuilder);\n+\n+                if (entryBuilder.getRetainedSizeInBytes() > MAX_ENTRY_RETAINED_SIZE) {\n+                    throw new PrestoException(CELL_TOO_LARGE, format(\"Array size %s exceeds the maximum supported array size %s\", entryBuilder.getRetainedSizeInBytes(), MAX_ENTRY_RETAINED_SIZE));", "originalCommit": "1b17656ba6d53a0725a370687d6b5ff5f83b4f96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNzcyOQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r371027729", "bodyText": "changed.. Does it then make sense to use DataSize everywhere and not just the format String?", "author": "sujay-jain", "createdAt": "2020-01-26T20:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5NDcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2MDY3NQ==", "url": "https://github.com/prestodb/presto/pull/13979#discussion_r371360675", "bodyText": "I would avoid using it in the hot areas of this method", "author": "tdcmeehan", "createdAt": "2020-01-27T16:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5NDcwMg=="}], "type": "inlineReview"}, {"oid": "a79ed41ca8545559b73c9571f0a4ab7d582d1a43", "url": "https://github.com/prestodb/presto/commit/a79ed41ca8545559b73c9571f0a4ab7d582d1a43", "message": "Improve error message for the array_agg function\n\nCurrently, array_agg throws a `GENERIC_INTERNAL_ERROR` when an array\nis too large. eg: \"Cannot allocate slice larger than 2147483639 bytes\"\nmessage is reported when the underlying data is stored in Slice.\nThis was confusing to users.\n\nThis commit throws `PrestoException` with\n`CELL_TOO_LARGE` error code\nwhen the retained size of a single array exceeds 1G.", "committedDate": "2020-01-26T20:32:44Z", "type": "commit"}, {"oid": "a79ed41ca8545559b73c9571f0a4ab7d582d1a43", "url": "https://github.com/prestodb/presto/commit/a79ed41ca8545559b73c9571f0a4ab7d582d1a43", "message": "Improve error message for the array_agg function\n\nCurrently, array_agg throws a `GENERIC_INTERNAL_ERROR` when an array\nis too large. eg: \"Cannot allocate slice larger than 2147483639 bytes\"\nmessage is reported when the underlying data is stored in Slice.\nThis was confusing to users.\n\nThis commit throws `PrestoException` with\n`CELL_TOO_LARGE` error code\nwhen the retained size of a single array exceeds 1G.", "committedDate": "2020-01-26T20:32:44Z", "type": "forcePushed"}]}