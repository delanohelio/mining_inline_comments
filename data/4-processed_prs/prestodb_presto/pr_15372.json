{"pr_number": 15372, "pr_title": "Fix extracting logic in dynamic filtering when integrated with filter pushdown", "pr_createdAt": "2020-10-29T08:22:05Z", "pr_url": "https://github.com/prestodb/presto/pull/15372", "timeline": [{"oid": "8e848b891cd578676dafec0841a2a13b991bbf31", "url": "https://github.com/prestodb/presto/commit/8e848b891cd578676dafec0841a2a13b991bbf31", "message": "Fix extracting logic in dynamic filtering when integrated with aria\n\nWhen integrating with aria, we extract dynamic filter and leave it in the filter node\nand push the regular filters to table scan. The current extracting logic can't handle\nconjunction dynamic filters like\n'AND (($internal$dynamic_filter_function(VARCHAR 524, site_id)) OR (IS_NULL(site_id))))'", "committedDate": "2020-10-29T14:14:53Z", "type": "forcePushed"}, {"oid": "9717d3c06316c2cb03ceca8858fc5ef1d210622b", "url": "https://github.com/prestodb/presto/commit/9717d3c06316c2cb03ceca8858fc5ef1d210622b", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters like\n'AND (($internal$dynamic_filter_function(VARCHAR 524, site_id)) OR (IS_NULL(site_id))))'", "committedDate": "2020-11-01T05:03:00Z", "type": "forcePushed"}, {"oid": "6f5d00fe74722d908da52066e3ed9424def2a653", "url": "https://github.com/prestodb/presto/commit/6f5d00fe74722d908da52066e3ed9424def2a653", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters like\n'AND (($internal$dynamic_filter_function(VARCHAR 524, site_id)) OR (IS_NULL(site_id))))'", "committedDate": "2020-11-01T05:09:07Z", "type": "forcePushed"}, {"oid": "15dd507445e58a5aa4ea8c4b1b17ed4496bf3f6f", "url": "https://github.com/prestodb/presto/commit/15dd507445e58a5aa4ea8c4b1b17ed4496bf3f6f", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters like\n'AND (($internal$dynamic_filter_function(VARCHAR 524, site_id)) OR (IS_NULL(site_id))))'", "committedDate": "2020-11-01T18:42:09Z", "type": "forcePushed"}, {"oid": "58d1ef99a044c7b176fa871529bb9650528f93db", "url": "https://github.com/prestodb/presto/commit/58d1ef99a044c7b176fa871529bb9650528f93db", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters like\n'AND (($internal$dynamic_filter_function(VARCHAR 524, site_id)) OR (IS_NULL(site_id))))'", "committedDate": "2020-11-04T19:05:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0MTYwOQ==", "url": "https://github.com/prestodb/presto/pull/15372#discussion_r517641609", "bodyText": "Could you make the body of the SQL more readable?\nSELECT * FROM\nlineitem l1 LEFT OUTER JOIN part p1\nON l1.orderkey = p1.partkey AND p1.size = 47\nINNER JOIN orders o1 ON l1.orderkey = o1.orderkey\nAND o1.custkey = 397\nLEFT OUTER JOIN part p2\nON p1.name = p2.name AND p1.partkey = p2.partkey\nWHERE o1.shippriority = 0", "author": "highker", "createdAt": "2020-11-04T21:28:38Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFilteringAndFilterPushdown.java", "diffHunk": "@@ -43,4 +44,35 @@ protected Session getSession()\n                 .setCatalogSessionProperty(HIVE_CATALOG, PUSHDOWN_FILTER_ENABLED, \"true\")\n                 .build();\n     }\n+\n+    @Test\n+    // Mixed join could produce conjunction dynamic filters, we should be able to extract them out when integrating with filter pushdown\n+    // In this query, it will produce:\n+    // AND (($internal$dynamic_filter_function(VARCHAR 263, partkey)) OR (IS_NULL(partkey))))\n+    public void testMixedJoin()\n+    {\n+        assertQuery(\"SELECT\\n\" +\n+                \"*\\n\" +\n+                \"FROM (\\n\" +\n+                \"(\\n\" +\n+                \"(\\n\" +\n+                \"lineitem l1\\n\" +\n+                \"LEFT OUTER JOIN part p1\\n\" +\n+                \"ON (\\n\" +\n+                \"l1.orderkey = p1.partkey AND p1.size = 47\\n\" +\n+                \")\\n\" +\n+                \")\\n\" +\n+                \"INNER JOIN orders o1\\n\" +\n+                \"ON (\\n\" +\n+                \"l1.orderkey = o1.orderkey AND o1.custkey = 397\\n\" +\n+                \")\\n\" +\n+                \")\\n\" +\n+                \"LEFT OUTER JOIN part p2\\n\" +\n+                \"ON (\\n\" +\n+                \"p1.name = p2.name AND p1.partkey = p2.partkey\\n\" +\n+                \")\\n\" +\n+                \")\\n\" +\n+                \"WHERE\\n\" +\n+                \"o1.shippriority = 0\");", "originalCommit": "58d1ef99a044c7b176fa871529bb9650528f93db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0MTcyOA==", "url": "https://github.com/prestodb/presto/pull/15372#discussion_r517641728", "bodyText": "remove these two lines", "author": "highker", "createdAt": "2020-11-04T21:28:51Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFilteringAndFilterPushdown.java", "diffHunk": "@@ -43,4 +44,35 @@ protected Session getSession()\n                 .setCatalogSessionProperty(HIVE_CATALOG, PUSHDOWN_FILTER_ENABLED, \"true\")\n                 .build();\n     }\n+\n+    @Test\n+    // Mixed join could produce conjunction dynamic filters, we should be able to extract them out when integrating with filter pushdown\n+    // In this query, it will produce:\n+    // AND (($internal$dynamic_filter_function(VARCHAR 263, partkey)) OR (IS_NULL(partkey))))", "originalCommit": "58d1ef99a044c7b176fa871529bb9650528f93db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0MTg1Mg==", "url": "https://github.com/prestodb/presto/pull/15372#discussion_r517641852", "bodyText": "move this comment to the body of the test", "author": "highker", "createdAt": "2020-11-04T21:29:08Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFilteringAndFilterPushdown.java", "diffHunk": "@@ -43,4 +44,35 @@ protected Session getSession()\n                 .setCatalogSessionProperty(HIVE_CATALOG, PUSHDOWN_FILTER_ENABLED, \"true\")\n                 .build();\n     }\n+\n+    @Test\n+    // Mixed join could produce conjunction dynamic filters, we should be able to extract them out when integrating with filter pushdown", "originalCommit": "58d1ef99a044c7b176fa871529bb9650528f93db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c5bb3243c9ecf1a1920b8542c0d5ad3e98e7a589", "url": "https://github.com/prestodb/presto/commit/c5bb3243c9ecf1a1920b8542c0d5ad3e98e7a589", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters", "committedDate": "2020-11-18T23:04:23Z", "type": "forcePushed"}, {"oid": "990a44bfb72389d1110ee6510c3514203d656405", "url": "https://github.com/prestodb/presto/commit/990a44bfb72389d1110ee6510c3514203d656405", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters", "committedDate": "2020-11-19T00:46:22Z", "type": "commit"}, {"oid": "990a44bfb72389d1110ee6510c3514203d656405", "url": "https://github.com/prestodb/presto/commit/990a44bfb72389d1110ee6510c3514203d656405", "message": "Fix extracting logic in dynamic filtering when integrated with filter pushdown\n\nWhen integrating with filter pushdown, we extract dynamic filter\nand leave it in the filter node and push the regular filters to table scan.\nThe current extracting logic can't handle conjunction dynamic filters", "committedDate": "2020-11-19T00:46:22Z", "type": "forcePushed"}]}