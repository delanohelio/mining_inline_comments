{"pr_number": 15231, "pr_title": "Support pushdown approx_distinct(x, e) into pinot", "pr_createdAt": "2020-09-27T22:09:28Z", "pr_url": "https://github.com/prestodb/presto/pull/15231", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MTY0Nw==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r495981647", "bodyText": "Nit: uses", "author": "agrawaldevesh", "createdAt": "2020-09-28T14:27:40Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);\n+            if (standardError < 0) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                        format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\", standardError, standardErrorString, aggregation));\n+            }\n+            // Pinot use DisctintCountHll to do distinct count estimation, with hyperloglog algorithm.", "originalCommit": "e18011ebdec17d6545edce9f355c5ec727ea6208", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e", "url": "https://github.com/prestodb/presto/commit/8a7c5884403359370f895f2e1ccdb15f5919912e", "message": "Support pushdown approx_distinct(x, e) into pinot", "committedDate": "2020-09-28T18:42:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTMyNw==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496161327", "bodyText": "typo ... DistinctCountHll, can you also capitalize that to be consistent.\nCan you add some more details on the second argument that is needed: What is log2m in english would help understand the formula on line 433", "author": "agrawaldevesh", "createdAt": "2020-09-28T18:48:05Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);\n+            if (standardError < 0) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                        format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\", standardError, standardErrorString, aggregation));\n+            }\n+            // Pinot uses DisctintCountHll to do distinct count estimation, with hyperloglog algorithm.", "originalCommit": "8a7c5884403359370f895f2e1ccdb15f5919912e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTc4OQ==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189789", "bodyText": "done", "author": "xiangfu0", "createdAt": "2020-09-28T19:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTk4OQ==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496161989", "bodyText": "Can this throw a parse error ? Should we handle that ? Or perhaps assert the type of the ConstantExpression or VariableReferenceExpression is numeric ?", "author": "agrawaldevesh", "createdAt": "2020-09-28T18:49:16Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);", "originalCommit": "8a7c5884403359370f895f2e1ccdb15f5919912e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTcwNA==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189704", "bodyText": "Added a try catch for double parsing.\nConstantExpression is decimal representation, so it's actually easier to convert to string then parse double value.", "author": "xiangfu0", "createdAt": "2020-09-28T19:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MjYwMg==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496162602", "bodyText": "Does testing with approx_distinct(fare, 0) ... 0 error make sense ? I think that should throw an error. Right ?", "author": "agrawaldevesh", "createdAt": "2020-09-28T18:50:23Z", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -269,6 +269,9 @@ public void testPercentileAggregation()\n     public void testApproxDistinct()\n     {\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.1)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 6)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.02)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 11)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.01)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 13)\");", "originalCommit": "8a7c5884403359370f895f2e1ccdb15f5919912e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTA5OQ==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189099", "bodyText": "added the test with invalid params", "author": "xiangfu0", "createdAt": "2020-09-28T19:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MjYwMg=="}], "type": "inlineReview"}, {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "url": "https://github.com/prestodb/presto/commit/331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "message": "Support pushdown approx_distinct(x, e) into pinot", "committedDate": "2020-09-28T19:41:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDE2NA==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274164", "bodyText": "one param per line; leave the first line empty", "author": "highker", "createdAt": "2020-10-04T18:21:45Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),", "originalCommit": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTc1MA==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281750", "bodyText": "done.", "author": "xiangfu0", "createdAt": "2020-10-04T19:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQwOQ==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274409", "bodyText": "one param per line; leave the first line empty\n%d is incorrect. %f is the one to use. Feel free to adjust precision with %f", "author": "highker", "createdAt": "2020-10-04T18:24:23Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",", "originalCommit": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5Ng==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281696", "bodyText": "done.", "author": "xiangfu0", "createdAt": "2020-10-04T19:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyMg==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274422", "bodyText": "one param per line; leave the first line empty", "author": "highker", "createdAt": "2020-10-04T18:24:32Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",", "originalCommit": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5NA==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281694", "bodyText": "done.", "author": "xiangfu0", "createdAt": "2020-10-04T19:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyNw==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274427", "bodyText": "one param per line; leave the first line empty", "author": "highker", "createdAt": "2020-10-04T18:24:37Z", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",\n+                        standardErrorString, aggregation));\n+            }\n+            // Pinot uses DISTINCTCOUNTHLL to do distinct count estimation, with hyperloglog algorithm.\n+            //\n+            // The HyperLogLog (HLL) data structure is a probabilistic data structure used to estimate the cardinality\n+            // of a data set.\n+            // In order to construct HLL data structure, the parameter log2m is used which represents the number of\n+            // registers used internally by HLL.\n+            //\n+            // If we want a higher accuracy, we need to set these to higher values. Such a configuration\n+            // will have additional overhead because our HLL will occupy more memory. If we're fine with lower accuracy,\n+            // we can lower those parameters, and our HLL will occupy less memory.\n+            //\n+            // The relative standard deviation of HyperLoglog is:\n+            //     rsd = 1.106 / sqrt(2^(log2m))\n+            // So:\n+            //     log2m = 2 * log(1.106 / rsd) / log(2)\n+            int log2m = (int) (2 * Math.log(1.106 / standardError) / Math.log(2));\n+            if (log2m < 1) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct, the log2m generated from error is %d from input %s (function %s)\",", "originalCommit": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5MA==", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281690", "bodyText": "done.", "author": "xiangfu0", "createdAt": "2020-10-04T19:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyNw=="}], "type": "inlineReview"}, {"oid": "c9ff18f90ffa882d1dabc7c2fd3f447f28809c98", "url": "https://github.com/prestodb/presto/commit/c9ff18f90ffa882d1dabc7c2fd3f447f28809c98", "message": "Support pushdown approx_distinct(x, e) into pinot", "committedDate": "2020-10-04T19:43:36Z", "type": "forcePushed"}, {"oid": "3393e40e96621fc96a1588438a4d0ba87fc793bb", "url": "https://github.com/prestodb/presto/commit/3393e40e96621fc96a1588438a4d0ba87fc793bb", "message": "Support pushdown approx_distinct(x, e) into pinot", "committedDate": "2020-10-04T19:44:47Z", "type": "commit"}, {"oid": "3393e40e96621fc96a1588438a4d0ba87fc793bb", "url": "https://github.com/prestodb/presto/commit/3393e40e96621fc96a1588438a4d0ba87fc793bb", "message": "Support pushdown approx_distinct(x, e) into pinot", "committedDate": "2020-10-04T19:44:47Z", "type": "forcePushed"}]}