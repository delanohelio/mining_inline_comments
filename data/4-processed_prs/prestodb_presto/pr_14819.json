{"pr_number": 14819, "pr_title": "Avoid fetching encryption information when no columns requested", "pr_createdAt": "2020-07-09T19:50:26Z", "pr_url": "https://github.com/prestodb/presto/pull/14819", "timeline": [{"oid": "ff90f96db35520e2aa37975cfda939bbf2d85645", "url": "https://github.com/prestodb/presto/commit/ff90f96db35520e2aa37975cfda939bbf2d85645", "message": "Avoid fetching encryption information when no columns requested\n\nThis can happen if the user is only asking for partition columns or something like count(*). As of now,\nif the table has table level encryption key, we will try getting the key metadata for that key where\nas it is not needed. This change will allow users who don't have access to the table data to still be able\nto get the partition columns or count(*) and bring the implementation at par with column level encryption\nkey specification", "committedDate": "2020-07-09T19:45:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ1ODE2OA==", "url": "https://github.com/prestodb/presto/pull/14819#discussion_r452458168", "bodyText": "why would requested columns be absent?", "author": "rschlussel", "createdAt": "2020-07-09T20:01:41Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/AbstractDwrfEncryptionInformationSource.java", "diffHunk": "@@ -106,7 +106,12 @@ protected abstract EncryptionInformation getWriteEncryptionInformationInternal(\n \n         Map<String, String> fieldToKeyReference;\n         if (encryptTable.isPresent()) {\n-            fieldToKeyReference = ImmutableMap.of(DwrfEncryptionMetadata.TABLE_IDENTIFIER, encryptTable.get());\n+            if (!requestedColumns.isPresent() || !requestedColumns.get().isEmpty()) {", "originalCommit": "ff90f96db35520e2aa37975cfda939bbf2d85645", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3MDM4Nw==", "url": "https://github.com/prestodb/presto/pull/14819#discussion_r452470387", "bodyText": "why would it be absent (requestedColumns.isPresent()) or the underlying set by empty (requestedColumns.get.isEmpty())?\nFor requestedColumns.isPresent() it is being populated by an optimizer and it is easy for a company to not have that optimizer in their list of optimizers and that is when this will be empty. The implication is that we will try to get the keys for all columns and hence the user needs to have access to everything in the table.\nFor requestedColumns.get().isEmpty()) - this happens when you have a query like SELECT partitionCol FROM tableorSELECT count(*) FROM table` where we are not selecting or filtering on a column.", "author": "mayankgarg1990", "createdAt": "2020-07-09T20:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ1ODE2OA=="}], "type": "inlineReview"}]}