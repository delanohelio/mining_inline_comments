{"pr_number": 14458, "pr_title": "read druid query response stream by page", "pr_createdAt": "2020-04-29T08:02:45Z", "pr_url": "https://github.com/prestodb/presto/pull/14458", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MDE0Mg==", "url": "https://github.com/prestodb/presto/pull/14458#discussion_r417140142", "bodyText": "shall we just have one line, instead of splitting into 2 lines?", "author": "zhenxiao", "createdAt": "2020-04-29T08:12:15Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -119,30 +122,64 @@ public DruidSegmentInfo getSingleSegmentInfo(String dataSource, String segmentId\n         return httpClient.execute(request, createJsonResponseHandler(SEGMENT_INFO_CODEC));\n     }\n \n-    public String getData(String dql)\n+    public InputStream getData(String dql)\n     {\n-        return httpClient.execute(prepareQuery(dql), createStringResponseHandler()).getBody();\n+        return httpClient.execute(prepareDataQuery(dql), new StreamingJsonResponseHandler());\n     }\n \n     private static Request.Builder setContentTypeHeaders(Request.Builder requestBuilder)\n     {\n         return requestBuilder\n-                .setHeader(CONTENT_TYPE, JSON_UTF_8.toString())\n-                .setHeader(ACCEPT, JSON_UTF_8.toString());\n+                .setHeader(CONTENT_TYPE, JSON_UTF_8.toString());\n+    }\n+\n+    private static byte[] createRequestBody(String query, DruidResultFormat resultFormat, boolean queryHeader)\n+    {\n+        return format(\"{\\\"query\\\":\\\"%s\\\",\\\"resultFormat\" +\n+                \"\\\":\\\"%s\\\",\\\"header\\\": %b }\\n\", query, resultFormat.getResultFormat(), queryHeader).getBytes();", "originalCommit": "1c73b82322f03e0f8e131edebf9faff618ff3908", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MDM0MQ==", "url": "https://github.com/prestodb/presto/pull/14458#discussion_r417140341", "bodyText": "static import OBJECT, ARRAY_LINES ... ?", "author": "zhenxiao", "createdAt": "2020-04-29T08:12:40Z", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -119,30 +122,64 @@ public DruidSegmentInfo getSingleSegmentInfo(String dataSource, String segmentId\n         return httpClient.execute(request, createJsonResponseHandler(SEGMENT_INFO_CODEC));\n     }\n \n-    public String getData(String dql)\n+    public InputStream getData(String dql)\n     {\n-        return httpClient.execute(prepareQuery(dql), createStringResponseHandler()).getBody();\n+        return httpClient.execute(prepareDataQuery(dql), new StreamingJsonResponseHandler());\n     }\n \n     private static Request.Builder setContentTypeHeaders(Request.Builder requestBuilder)\n     {\n         return requestBuilder\n-                .setHeader(CONTENT_TYPE, JSON_UTF_8.toString())\n-                .setHeader(ACCEPT, JSON_UTF_8.toString());\n+                .setHeader(CONTENT_TYPE, JSON_UTF_8.toString());\n+    }\n+\n+    private static byte[] createRequestBody(String query, DruidResultFormat resultFormat, boolean queryHeader)\n+    {\n+        return format(\"{\\\"query\\\":\\\"%s\\\",\\\"resultFormat\" +\n+                \"\\\":\\\"%s\\\",\\\"header\\\": %b }\\n\", query, resultFormat.getResultFormat(), queryHeader).getBytes();\n     }\n \n-    private static byte[] createRequestBody(String query)\n+    private Request prepareMetadataQuery(String query)\n     {\n-        return format(\"{\\\"query\\\":\\\"%s\\\"}\\n\", query).getBytes();\n+        HttpUriBuilder uriBuilder = uriBuilderFrom(druidBroker).replacePath(SQL_ENDPOINT);\n+\n+        return setContentTypeHeaders(preparePost())\n+                .setUri(uriBuilder.build())\n+                .setBodyGenerator(createStaticBodyGenerator(createRequestBody(query, DruidResultFormat.OBJECT, false)))", "originalCommit": "1c73b82322f03e0f8e131edebf9faff618ff3908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MjYzOQ==", "url": "https://github.com/prestodb/presto/pull/14458#discussion_r417142639", "bodyText": "nice suggest", "author": "mqiang", "createdAt": "2020-04-29T08:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MDM0MQ=="}], "type": "inlineReview"}, {"oid": "ea0a9e016470015751e80b79436b522e20c2962e", "url": "https://github.com/prestodb/presto/commit/ea0a9e016470015751e80b79436b522e20c2962e", "message": "read druid query response stream by page", "committedDate": "2020-04-29T08:17:52Z", "type": "commit"}, {"oid": "ea0a9e016470015751e80b79436b522e20c2962e", "url": "https://github.com/prestodb/presto/commit/ea0a9e016470015751e80b79436b522e20c2962e", "message": "read druid query response stream by page", "committedDate": "2020-04-29T08:17:52Z", "type": "forcePushed"}]}