{"pr_number": 14895, "pr_title": "Add support for limit pushdown through union", "pr_createdAt": "2020-07-25T07:08:53Z", "pr_url": "https://github.com/prestodb/presto/pull/14895", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTkyNA==", "url": "https://github.com/prestodb/presto/pull/14895#discussion_r461171924", "bodyText": "So, theoretically, this won't fire if the limit here is > 1 either right? Maybe also test that?", "author": "rongrong", "createdAt": "2020-07-27T21:10:12Z", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestPushLimitThroughUnion.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.facebook.presto.sql.planner.iterative.rule.test.BaseRuleTest;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableListMultimap;\n+import org.testng.annotations.Test;\n+\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.limit;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.union;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.values;\n+\n+public class TestPushLimitThroughUnion\n+        extends BaseRuleTest\n+{\n+    @Test\n+    public void testPushLimitThroughUnion()\n+    {\n+        tester().assertThat(new PushLimitThroughUnion())\n+                .on(p -> {\n+                    VariableReferenceExpression a = p.variable(\"a\");\n+                    VariableReferenceExpression b = p.variable(\"b\");\n+                    VariableReferenceExpression c = p.variable(\"c\");\n+                    return p.limit(1,\n+                            p.union(\n+                                    ImmutableListMultimap.<VariableReferenceExpression, VariableReferenceExpression>builder()\n+                                            .put(c, a)\n+                                            .put(c, b)\n+                                            .build(),\n+                                    ImmutableList.of(\n+                                            p.values(10, a),\n+                                            p.values(10, b))));\n+                })\n+                .matches(\n+                        limit(1,\n+                                union(\n+                                        limit(1, true, values(\"a\")),\n+                                        limit(1, true, values(\"b\")))));\n+    }\n+\n+    @Test\n+    public void doesNotFire()\n+    {\n+        tester().assertThat(new PushLimitThroughUnion())\n+                .on(p -> {\n+                    VariableReferenceExpression a = p.variable(\"a\");\n+                    VariableReferenceExpression b = p.variable(\"b\");\n+                    VariableReferenceExpression c = p.variable(\"c\");\n+                    return p.limit(1,", "originalCommit": "b1b20f718c3d31dd24badffcb9a2891ec3194939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA2MDU2NA==", "url": "https://github.com/prestodb/presto/pull/14895#discussion_r462060564", "bodyText": "sure I add another test to cover limit2 case", "author": "fgwang7w", "createdAt": "2020-07-29T06:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NDc2MA==", "url": "https://github.com/prestodb/presto/pull/14895#discussion_r461174760", "bodyText": "I prefer a separate check before building the list. Something like\nif (unionNode.getSources().stream().allMatch(source -> isAtMost(source, context.getLookup(), parent.getCount()))) {\n    return Result.empty();\n}\n// build new plan node\n\nIt's slightly more efficient when the rule should not fire, which should happen more often.", "author": "rongrong", "createdAt": "2020-07-27T21:15:59Z", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PushLimitThroughUnion.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.matching.Capture;\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import com.facebook.presto.spi.plan.LimitNode;\n+import com.facebook.presto.spi.plan.PlanNode;\n+import com.facebook.presto.spi.plan.UnionNode;\n+import com.facebook.presto.sql.planner.iterative.Rule;\n+import com.google.common.collect.ImmutableList;\n+\n+import static com.facebook.presto.matching.Capture.newCapture;\n+import static com.facebook.presto.sql.planner.optimizations.QueryCardinalityUtil.isAtMost;\n+import static com.facebook.presto.sql.planner.plan.Patterns.limit;\n+import static com.facebook.presto.sql.planner.plan.Patterns.source;\n+import static com.facebook.presto.sql.planner.plan.Patterns.union;\n+\n+/**\n+ * Transforms:\n+ * <pre>\n+ * - Limit\n+ *    - Union\n+ *       - relation1\n+ *       - relation2\n+ *       ..\n+ * </pre>\n+ * Into:\n+ * <pre>\n+ * - Limit\n+ *    - Union\n+ *       - Limit\n+ *          - relation1\n+ *       - Limit\n+ *          - relation2\n+ *       ..\n+ * </pre>\n+ * Applies to LimitNode without ties only to avoid optimizer loop.\n+ */\n+public class PushLimitThroughUnion\n+        implements Rule<LimitNode>\n+{\n+    private static final Capture<UnionNode> CHILD = newCapture();\n+\n+    private static final Pattern<LimitNode> PATTERN = limit()\n+            .with(source().matching(union().capturedAs(CHILD)));\n+\n+    @Override\n+    public Pattern<LimitNode> getPattern()\n+    {\n+        return PATTERN;\n+    }\n+\n+    @Override\n+    public Result apply(LimitNode parent, Captures captures, Context context)\n+    {\n+        UnionNode unionNode = captures.get(CHILD);\n+        ImmutableList.Builder<PlanNode> builder = ImmutableList.builder();\n+        boolean shouldApply = false;", "originalCommit": "b1b20f718c3d31dd24badffcb9a2891ec3194939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1OTExNw==", "url": "https://github.com/prestodb/presto/pull/14895#discussion_r462059117", "bodyText": "yes this check makes sense, will incorporate it.", "author": "fgwang7w", "createdAt": "2020-07-29T06:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NDc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQxNjM3MA==", "url": "https://github.com/prestodb/presto/pull/14895#discussion_r465416370", "bodyText": "You don't need to check shouldApply anymore after the check. It should always apply if the code gets here.", "author": "rongrong", "createdAt": "2020-08-05T01:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NDc2MA=="}], "type": "inlineReview"}, {"oid": "fbaf69cd7144b9a468d3404e3e3bd065368fe8d7", "url": "https://github.com/prestodb/presto/commit/fbaf69cd7144b9a468d3404e3e3bd065368fe8d7", "message": "Add support for limit pushdown through union\n\nCherry-pick of https://github.com/prestosql/presto/commit/f2444576f51619d9b262ece8e6bd0c03cfc00c4d\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-07-29T06:11:58Z", "type": "forcePushed"}, {"oid": "fa400643b2171d8e6a84847d8eab30254ecfe942", "url": "https://github.com/prestodb/presto/commit/fa400643b2171d8e6a84847d8eab30254ecfe942", "message": "Add support for limit pushdown through union\n\nCherry-pick of https://github.com/prestosql/presto/commit/f2444576f51619d9b262ece8e6bd0c03cfc00c4d\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-07-29T22:07:09Z", "type": "forcePushed"}, {"oid": "87e43a2425cb3663aa6168f68a705a8ab0f0f7ed", "url": "https://github.com/prestodb/presto/commit/87e43a2425cb3663aa6168f68a705a8ab0f0f7ed", "message": "Add support for limit pushdown through union\n\nCherry-pick of https://github.com/prestosql/presto/commit/f2444576f51619d9b262ece8e6bd0c03cfc00c4d\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-08-05T01:28:20Z", "type": "commit"}, {"oid": "87e43a2425cb3663aa6168f68a705a8ab0f0f7ed", "url": "https://github.com/prestodb/presto/commit/87e43a2425cb3663aa6168f68a705a8ab0f0f7ed", "message": "Add support for limit pushdown through union\n\nCherry-pick of https://github.com/prestosql/presto/commit/f2444576f51619d9b262ece8e6bd0c03cfc00c4d\n\nCo-authored-by: praveenkrishna <praveenkrishna@tutanota.com>", "committedDate": "2020-08-05T01:28:20Z", "type": "forcePushed"}]}