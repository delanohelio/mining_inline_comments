{"pr_number": 14383, "pr_title": "Add preferred ordering columns for unbucketed table", "pr_createdAt": "2020-04-14T02:02:58Z", "pr_url": "https://github.com/prestodb/presto/pull/14383", "timeline": [{"oid": "8e392fda382366040101fdf595cd27d8c78fe7c6", "url": "https://github.com/prestodb/presto/commit/8e392fda382366040101fdf595cd27d8c78fe7c6", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-14T20:57:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2OTIwOQ==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r408569209", "bodyText": "Shall we make the stack variable the same as the constructor param? Having one with Optional and the other not is kinda confusing. If empty list means no preferred sorting, then we can just drop Optional.", "author": "highker", "createdAt": "2020-04-15T04:09:44Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/file/TableMetadata.java", "diffHunk": "@@ -75,7 +78,7 @@ public TableMetadata(\n         this.dataColumns = ImmutableList.copyOf(requireNonNull(dataColumns, \"dataColumns is null\"));\n         this.partitionColumns = ImmutableList.copyOf(requireNonNull(partitionColumns, \"partitionColumns is null\"));\n         this.parameters = ImmutableMap.copyOf(requireNonNull(parameters, \"parameters is null\"));\n-\n+        this.preferredOrderingColumns = ImmutableList.copyOf(requireNonNull(preferredOrderingColumns.orElse(ImmutableList.of()), \"preferredOrderingColumns is null\"));", "originalCommit": "8e392fda382366040101fdf595cd27d8c78fe7c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxMTI4NA==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409011284", "bodyText": "That was exactly what I started off with and then realized since it is also a JsonCreator, you will hit NPE when you decode something without this field :(\nEDIT: Added firstNonNull to handle this case :D", "author": "shixuan-fan", "createdAt": "2020-04-15T17:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2OTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU2OTI5Nw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r408569297", "bodyText": "We should just pass preferredOrderingColumns to make it consistent", "author": "highker", "createdAt": "2020-04-15T04:10:03Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/file/TableMetadata.java", "diffHunk": "@@ -222,6 +232,7 @@ public TableMetadata withDataColumns(List<Column> dataColumns)\n                 parameters,\n                 storageFormat,\n                 bucketProperty,\n+                Optional.of(preferredOrderingColumns),", "originalCommit": "8e392fda382366040101fdf595cd27d8c78fe7c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "url": "https://github.com/prestodb/presto/commit/31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-16T00:07:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMjczNw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409212737", "bodyText": "Make \",\" a const and add a comment to state that comma is not a reserved keyword even with quotes (https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL)", "author": "highker", "createdAt": "2020-04-16T00:36:03Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2581,43 @@ private static HiveStorageFormat extractHiveStorageFormat(Table table)\n         throw new PrestoException(HIVE_UNSUPPORTED_FORMAT, format(\"Output format %s with SerDe %s is not supported\", outputFormat, serde));\n     }\n \n+    private static String encodePreferredOrderingColumns(List<SortingColumn> preferredOrderingColumns)\n+    {\n+        return Joiner.on(',').join(preferredOrderingColumns.stream()", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDIxMQ==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409214211", "bodyText": "what if two writers write to the same fileNumber?", "author": "highker", "createdAt": "2020-04-16T00:41:04Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveWriterFactory.java", "diffHunk": "@@ -366,11 +369,10 @@ public HiveWriter createWriter(Page partitionColumns, int position, OptionalInt\n         }\n \n         if (sortingFileWriterFactory.isPresent()) {\n-            checkState(bucketNumber.isPresent(), \"missing bucket number for sorted table write\");\n             hiveFileWriter = sortingFileWriterFactory.get().createSortingFileWriter(\n                     path,\n                     hiveFileWriter,\n-                    bucketNumber.getAsInt(),\n+                    bucketNumber.orElse(random.nextInt()),", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNjE4Nw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409216187", "bodyText": "That is okay because this fileNumber is only used to determine which temp subdirectory we should write temp file into.\nFrom another perspective, temp file name is generated by appending the generated prefix with uuid, so we would not write to the same file.", "author": "shixuan-fan", "createdAt": "2020-04-16T00:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNjc4MQ==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409216781", "bodyText": "To make it less confusing, maybe we should directly pass the subdirectory number instead of file number?", "author": "shixuan-fan", "createdAt": "2020-04-16T00:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNzAxMw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409217013", "bodyText": "It might be better to make a comment on this and make sure the number is between 0 to some small numbers (rather than 2^31).", "author": "highker", "createdAt": "2020-04-16T00:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyOTQ4Nw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409229487", "bodyText": "Can it be null (similarly to serdeInfo.getParameters()?)", "author": "arhimondr", "createdAt": "2020-04-16T01:36:25Z", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/thrift/ThriftMetastoreUtil.java", "diffHunk": "@@ -625,7 +625,8 @@ public static void fromMetastoreApiStorageDescriptor(StorageDescriptor storageDe\n                 .setLocation(nullToEmpty(storageDescriptor.getLocation()))\n                 .setBucketProperty(HiveBucketProperty.fromStorageDescriptor(storageDescriptor, tablePartitionName))\n                 .setSkewed(storageDescriptor.isSetSkewedInfo() && storageDescriptor.getSkewedInfo().isSetSkewedColNames() && !storageDescriptor.getSkewedInfo().getSkewedColNames().isEmpty())\n-                .setSerdeParameters(serdeInfo.getParameters() == null ? ImmutableMap.of() : serdeInfo.getParameters());\n+                .setSerdeParameters(serdeInfo.getParameters() == null ? ImmutableMap.of() : serdeInfo.getParameters())\n+                .setParameters(storageDescriptor.getParameters());", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNzA0Ng==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409907046", "bodyText": "Good point. I would err on the safe side and do similar null handling.", "author": "shixuan-fan", "createdAt": "2020-04-16T23:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyOTQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTE2Ng==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409231166", "bodyText": "I would recommend adding a unit test. Try to check for corner cases.", "author": "arhimondr", "createdAt": "2020-04-16T01:42:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2581,43 @@ private static HiveStorageFormat extractHiveStorageFormat(Table table)\n         throw new PrestoException(HIVE_UNSUPPORTED_FORMAT, format(\"Output format %s with SerDe %s is not supported\", outputFormat, serde));\n     }\n \n+    private static String encodePreferredOrderingColumns(List<SortingColumn> preferredOrderingColumns)", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTM3Nw==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409231377", "bodyText": "upper?", "author": "arhimondr", "createdAt": "2020-04-16T01:43:02Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2581,43 @@ private static HiveStorageFormat extractHiveStorageFormat(Table table)\n         throw new PrestoException(HIVE_UNSUPPORTED_FORMAT, format(\"Output format %s with SerDe %s is not supported\", outputFormat, serde));\n     }\n \n+    private static String encodePreferredOrderingColumns(List<SortingColumn> preferredOrderingColumns)\n+    {\n+        return Joiner.on(',').join(preferredOrderingColumns.stream()\n+                .map(HiveMetadata::sortingColumnToString)\n+                .collect(toImmutableList()));\n+    }\n+\n+    private static List<SortingColumn> decodePreferredOrderingColumnsFromStorage(Storage storage)\n+    {\n+        if (!storage.getParameters().containsKey(PREFERRED_ORDERING_COLUMNS)) {\n+            return ImmutableList.of();\n+        }\n+\n+        return Splitter.on(',').trimResults().omitEmptyStrings().splitToList(storage.getParameters().get(PREFERRED_ORDERING_COLUMNS)).stream()\n+                .map(HiveMetadata::sortingColumnFromString)\n+                .collect(toImmutableList());\n+    }\n+\n+    private static SortingColumn sortingColumnFromString(String name)\n+    {\n+        SortingColumn.Order order = ASCENDING;\n+        String lower = name.toUpperCase(ENGLISH);", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTUxNg==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409231516", "bodyText": "Why do we still need trim?", "author": "arhimondr", "createdAt": "2020-04-16T01:43:29Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2581,43 @@ private static HiveStorageFormat extractHiveStorageFormat(Table table)\n         throw new PrestoException(HIVE_UNSUPPORTED_FORMAT, format(\"Output format %s with SerDe %s is not supported\", outputFormat, serde));\n     }\n \n+    private static String encodePreferredOrderingColumns(List<SortingColumn> preferredOrderingColumns)\n+    {\n+        return Joiner.on(',').join(preferredOrderingColumns.stream()\n+                .map(HiveMetadata::sortingColumnToString)\n+                .collect(toImmutableList()));\n+    }\n+\n+    private static List<SortingColumn> decodePreferredOrderingColumnsFromStorage(Storage storage)\n+    {\n+        if (!storage.getParameters().containsKey(PREFERRED_ORDERING_COLUMNS)) {\n+            return ImmutableList.of();\n+        }\n+\n+        return Splitter.on(',').trimResults().omitEmptyStrings().splitToList(storage.getParameters().get(PREFERRED_ORDERING_COLUMNS)).stream()\n+                .map(HiveMetadata::sortingColumnFromString)\n+                .collect(toImmutableList());\n+    }\n+\n+    private static SortingColumn sortingColumnFromString(String name)\n+    {\n+        SortingColumn.Order order = ASCENDING;\n+        String lower = name.toUpperCase(ENGLISH);\n+        if (lower.endsWith(\" ASC\")) {\n+            name = name.substring(0, name.length() - 4).trim();", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwNzgwNA==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409907804", "bodyText": "These two methods are actually copied from HiveTableProperties#sortingColumnFromString and HiveTableProperties#sortingColumnToString. We could also make it a public static method so we don't need to copy around. What do you think?\nSeparating them has the benefit of not binding the SerDe to how we specify them in table properties, though that might mean some code duplication.", "author": "shixuan-fan", "createdAt": "2020-04-16T23:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNTYwNQ==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409935605", "bodyText": "Per offline discussion, we moved these methods into SortingColumn.", "author": "shixuan-fan", "createdAt": "2020-04-17T01:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTc3MQ==", "url": "https://github.com/prestodb/presto/pull/14383#discussion_r409231771", "bodyText": "Maybe also specify ASC explicitly to be consistent", "author": "arhimondr", "createdAt": "2020-04-16T01:44:16Z", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2559,6 +2581,43 @@ private static HiveStorageFormat extractHiveStorageFormat(Table table)\n         throw new PrestoException(HIVE_UNSUPPORTED_FORMAT, format(\"Output format %s with SerDe %s is not supported\", outputFormat, serde));\n     }\n \n+    private static String encodePreferredOrderingColumns(List<SortingColumn> preferredOrderingColumns)\n+    {\n+        return Joiner.on(',').join(preferredOrderingColumns.stream()\n+                .map(HiveMetadata::sortingColumnToString)\n+                .collect(toImmutableList()));\n+    }\n+\n+    private static List<SortingColumn> decodePreferredOrderingColumnsFromStorage(Storage storage)\n+    {\n+        if (!storage.getParameters().containsKey(PREFERRED_ORDERING_COLUMNS)) {\n+            return ImmutableList.of();\n+        }\n+\n+        return Splitter.on(',').trimResults().omitEmptyStrings().splitToList(storage.getParameters().get(PREFERRED_ORDERING_COLUMNS)).stream()\n+                .map(HiveMetadata::sortingColumnFromString)\n+                .collect(toImmutableList());\n+    }\n+\n+    private static SortingColumn sortingColumnFromString(String name)\n+    {\n+        SortingColumn.Order order = ASCENDING;\n+        String lower = name.toUpperCase(ENGLISH);\n+        if (lower.endsWith(\" ASC\")) {\n+            name = name.substring(0, name.length() - 4).trim();\n+        }\n+        else if (lower.endsWith(\" DESC\")) {\n+            name = name.substring(0, name.length() - 5).trim();\n+            order = DESCENDING;\n+        }\n+        return new SortingColumn(name, order);\n+    }\n+\n+    private static String sortingColumnToString(SortingColumn column)\n+    {\n+        return column.getColumnName() + ((column.getOrder() == DESCENDING) ? \" DESC\" : \"\");", "originalCommit": "31d5cbe4fb62efe29aa12c5d3d0c3d53ca081c90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "326236ffd4199fee5c538c24042ac663ee8996eb", "url": "https://github.com/prestodb/presto/commit/326236ffd4199fee5c538c24042ac663ee8996eb", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-17T00:41:02Z", "type": "forcePushed"}, {"oid": "3800724f9ed11c15bbb60d28d130546766f68f79", "url": "https://github.com/prestodb/presto/commit/3800724f9ed11c15bbb60d28d130546766f68f79", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-17T01:13:22Z", "type": "forcePushed"}, {"oid": "8faae9db4200b734d4d1c0b75040271eec9db553", "url": "https://github.com/prestodb/presto/commit/8faae9db4200b734d4d1c0b75040271eec9db553", "message": "Replace comma string with static constant COMMA", "committedDate": "2020-04-17T18:31:50Z", "type": "commit"}, {"oid": "48c137f9a07d9f90d059b1ff6098c93ad2eec3bd", "url": "https://github.com/prestodb/presto/commit/48c137f9a07d9f90d059b1ff6098c93ad2eec3bd", "message": "Move sorting column string conversion methods into SortingColumn\n\nAlso fix a minor typo: lower -> upper", "committedDate": "2020-04-17T18:31:50Z", "type": "commit"}, {"oid": "a130e0ee719111c488d8533a00c90c832bbf7ba6", "url": "https://github.com/prestodb/presto/commit/a130e0ee719111c488d8533a00c90c832bbf7ba6", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-17T18:58:17Z", "type": "commit"}, {"oid": "a130e0ee719111c488d8533a00c90c832bbf7ba6", "url": "https://github.com/prestodb/presto/commit/a130e0ee719111c488d8533a00c90c832bbf7ba6", "message": "Add preferred ordering columns for unbucketed table\n\nCurrently sorted table is only a property of bucketed table. However,\nwe do see sorted file has several benefits, including better\ncompression for storage and faster scanning because of OrcReader\nskipping stripes. Introducing preferred ordering for unbucketed\ntable could bridge the gap. This property only means this table\nwould prefer to have files sorted by specified columns but does\nnot enforce it.", "committedDate": "2020-04-17T18:58:17Z", "type": "forcePushed"}]}