{"pr_number": 15335, "pr_title": "Introduce temporary store based spilling", "pr_createdAt": "2020-10-19T23:00:26Z", "pr_url": "https://github.com/prestodb/presto/pull/15335", "timeline": [{"oid": "0091ebfd1bd5d1ef86bd217e3b600c3156c3e150", "url": "https://github.com/prestodb/presto/commit/0091ebfd1bd5d1ef86bd217e3b600c3156c3e150", "message": "Introduce temporary store based spilling", "committedDate": "2020-10-19T23:02:35Z", "type": "forcePushed"}, {"oid": "3d8ee65046076e678320411dcd88e9ea6338e86d", "url": "https://github.com/prestodb/presto/commit/3d8ee65046076e678320411dcd88e9ea6338e86d", "message": "Introduce temporary store based spilling", "committedDate": "2020-10-20T04:24:07Z", "type": "forcePushed"}, {"oid": "959c247207045383138a8b1b3fb4e1202b1f6294", "url": "https://github.com/prestodb/presto/commit/959c247207045383138a8b1b3fb4e1202b1f6294", "message": "Add test for temporary store based spilling", "committedDate": "2020-10-20T20:47:50Z", "type": "forcePushed"}, {"oid": "56413e1f4387c8cb7b20d4192c7e9c38d0130572", "url": "https://github.com/prestodb/presto/commit/56413e1f4387c8cb7b20d4192c7e9c38d0130572", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-21T18:53:48Z", "type": "forcePushed"}, {"oid": "bd505e0baba787607b825d3fdaa47fed0774e14c", "url": "https://github.com/prestodb/presto/commit/bd505e0baba787607b825d3fdaa47fed0774e14c", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-21T21:36:17Z", "type": "forcePushed"}, {"oid": "c230d29b56214e0dd517e245da97072f24abf985", "url": "https://github.com/prestodb/presto/commit/c230d29b56214e0dd517e245da97072f24abf985", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-21T22:30:46Z", "type": "forcePushed"}, {"oid": "28a9397f593e4c84ecb190f9b5463f9906e2eb00", "url": "https://github.com/prestodb/presto/commit/28a9397f593e4c84ecb190f9b5463f9906e2eb00", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-22T03:40:12Z", "type": "forcePushed"}, {"oid": "d65bfef1339ad128c4fc11b910088f66286fcdb9", "url": "https://github.com/prestodb/presto/commit/d65bfef1339ad128c4fc11b910088f66286fcdb9", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-22T05:28:00Z", "type": "forcePushed"}, {"oid": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "url": "https://github.com/prestodb/presto/commit/b474a2df079d7e407bb2c4f42c176bda8f781b6a", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-22T17:27:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MDI0MA==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511150240", "bodyText": "nit: @NotNull", "author": "arhimondr", "createdAt": "2020-10-23T20:52:50Z", "path": "presto-main/src/main/java/com/facebook/presto/spiller/NodeSpillConfig.java", "diffHunk": "@@ -75,4 +76,16 @@ public NodeSpillConfig setSpillEncryptionEnabled(boolean spillEncryptionEnabled)\n         this.spillEncryptionEnabled = spillEncryptionEnabled;\n         return this;\n     }\n+\n+    public DataSize getTemporaryStoreBufferSize()", "originalCommit": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MTU1MQ==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511151551", "bodyText": "nit: Initialize in @BeforeClass", "author": "arhimondr", "createdAt": "2020-10-23T20:56:18Z", "path": "presto-main/src/test/java/com/facebook/presto/spiller/TestTemporaryStoreSingleStreamSpiller.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spiller;\n+\n+import com.facebook.presto.block.BlockEncodingManager;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.io.OutputStreamDataSink;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.memory.context.LocalMemoryContext;\n+import com.facebook.presto.operator.PageAssertions;\n+import com.facebook.presto.spi.page.PageCodecMarker;\n+import com.facebook.presto.spi.page.PagesSerdeUtil;\n+import com.facebook.presto.spi.page.SerializedPage;\n+import com.facebook.presto.testing.TestingTemporaryStoreManager;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterators;\n+import com.google.common.util.concurrent.ListeningExecutorService;\n+import io.airlift.slice.DynamicSliceOutput;\n+import io.airlift.slice.InputStreamSliceInput;\n+import io.airlift.units.DataSize;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.BigintType.BIGINT;\n+import static com.facebook.presto.common.type.DoubleType.DOUBLE;\n+import static com.facebook.presto.common.type.VarbinaryType.VARBINARY;\n+import static com.facebook.presto.memory.context.AggregatedMemoryContext.newSimpleAggregatedMemoryContext;\n+import static com.google.common.io.MoreFiles.deleteRecursively;\n+import static com.google.common.io.MoreFiles.listFiles;\n+import static com.google.common.io.RecursiveDeleteOption.ALLOW_INSECURE;\n+import static com.google.common.util.concurrent.MoreExecutors.listeningDecorator;\n+import static io.airlift.units.DataSize.Unit.KILOBYTE;\n+import static java.lang.Double.doubleToLongBits;\n+import static java.lang.Math.toIntExact;\n+import static java.nio.file.Files.newInputStream;\n+import static java.util.concurrent.Executors.newCachedThreadPool;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestTemporaryStoreSingleStreamSpiller\n+{\n+    private static final List<Type> TYPES = ImmutableList.of(BIGINT, DOUBLE, VARBINARY);\n+\n+    private final ListeningExecutorService executor = listeningDecorator(newCachedThreadPool());", "originalCommit": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTYyMjI2OQ==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511622269", "bodyText": "@arhimondr : Just curious, what's the difference?", "author": "wenleix", "createdAt": "2020-10-25T16:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MTU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzEyMg==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511153122", "bodyText": "nit @GuarderBy(\"this\")", "author": "arhimondr", "createdAt": "2020-10-23T21:00:14Z", "path": "presto-main/src/main/java/com/facebook/presto/spiller/LocalTemporaryStore.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spiller;\n+\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.common.io.DataOutput;\n+import com.facebook.presto.common.io.DataSink;\n+import com.facebook.presto.common.io.OutputStreamDataSink;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.storage.TemporaryDataSink;\n+import com.facebook.presto.spi.storage.TemporaryStore;\n+import com.facebook.presto.spi.storage.TemporaryStoreFactory;\n+import com.facebook.presto.spi.storage.TemporaryStoreHandle;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.DirectoryStream;\n+import java.nio.file.FileStore;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.facebook.presto.spi.StandardErrorCode.OUT_OF_SPILL_SPACE;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.nio.file.Files.createDirectories;\n+import static java.nio.file.Files.delete;\n+import static java.nio.file.Files.getFileStore;\n+import static java.nio.file.Files.newDirectoryStream;\n+import static java.nio.file.StandardOpenOption.APPEND;\n+import static java.util.Objects.requireNonNull;\n+\n+public class LocalTemporaryStore\n+        implements TemporaryStore\n+{\n+    public static final String NAME = \"local\";\n+    public static final String TEMPORARY_STORE_PATH = \"temporary-store.path\";\n+\n+    private static final Logger log = Logger.get(LocalTemporaryStore.class);\n+\n+    private static final String SPILL_FILE_PREFIX = \"spill\";\n+    private static final String SPILL_FILE_SUFFIX = \".bin\";\n+    private static final String SPILL_FILE_GLOB = \"spill*.bin\";\n+\n+    private final List<Path> spillPaths;\n+    private final double maxUsedSpaceThreshold;\n+    private int roundRobinIndex;", "originalCommit": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MzIyNw==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511153227", "bodyText": "nit: \"spillPaths is null\"", "author": "arhimondr", "createdAt": "2020-10-23T21:00:29Z", "path": "presto-main/src/main/java/com/facebook/presto/spiller/LocalTemporaryStore.java", "diffHunk": "@@ -0,0 +1,258 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spiller;\n+\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.common.io.DataOutput;\n+import com.facebook.presto.common.io.DataSink;\n+import com.facebook.presto.common.io.OutputStreamDataSink;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.storage.TemporaryDataSink;\n+import com.facebook.presto.spi.storage.TemporaryStore;\n+import com.facebook.presto.spi.storage.TemporaryStoreFactory;\n+import com.facebook.presto.spi.storage.TemporaryStoreHandle;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.DirectoryStream;\n+import java.nio.file.FileStore;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.facebook.presto.spi.StandardErrorCode.OUT_OF_SPILL_SPACE;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.nio.file.Files.createDirectories;\n+import static java.nio.file.Files.delete;\n+import static java.nio.file.Files.getFileStore;\n+import static java.nio.file.Files.newDirectoryStream;\n+import static java.nio.file.StandardOpenOption.APPEND;\n+import static java.util.Objects.requireNonNull;\n+\n+public class LocalTemporaryStore\n+        implements TemporaryStore\n+{\n+    public static final String NAME = \"local\";\n+    public static final String TEMPORARY_STORE_PATH = \"temporary-store.path\";\n+\n+    private static final Logger log = Logger.get(LocalTemporaryStore.class);\n+\n+    private static final String SPILL_FILE_PREFIX = \"spill\";\n+    private static final String SPILL_FILE_SUFFIX = \".bin\";\n+    private static final String SPILL_FILE_GLOB = \"spill*.bin\";\n+\n+    private final List<Path> spillPaths;\n+    private final double maxUsedSpaceThreshold;\n+    private int roundRobinIndex;\n+\n+    public LocalTemporaryStore(List<Path> spillPaths, double maxUsedSpaceThreshold)\n+    {\n+        this.spillPaths = ImmutableList.copyOf(requireNonNull(spillPaths));", "originalCommit": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1NDc0Mg==", "url": "https://github.com/prestodb/presto/pull/15335#discussion_r511154742", "bodyText": "I don't feel very strong about this, but I would recommend allowing multiple storages, similar as we allow multiple connectors.\nBasically instead of having a single file etc/temporary-store.properties we can have a directory, etc/stores. And under that directory we can have multiple configuration files, e.g.: local.properties, hdfs.properties, ...\nAnd then some particular module can be configured to use a specific storage:\ne.g.: storage-based-spiller-store=local or storage-based-spiller-store=hdfs.\nThat would allow different functionality to use different stores. For example spilling could use local store, when Broadcast join in Presto on spark would use hdfs store.", "author": "arhimondr", "createdAt": "2020-10-23T21:04:36Z", "path": "presto-main/src/main/java/com/facebook/presto/spiller/TemporaryStoreManager.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spiller;\n+\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.spi.storage.TemporaryStore;\n+import com.facebook.presto.spi.storage.TemporaryStoreFactory;\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static com.facebook.presto.spiller.LocalTemporaryStore.TEMPORARY_STORE_PATH;\n+import static com.facebook.presto.util.PropertiesUtil.loadProperties;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TemporaryStoreManager\n+{\n+    private static final Logger log = Logger.get(TemporaryStoreManager.class);\n+    private static final File TEMPORARY_STORE_CONFIGURATION = new File(\"etc/temporary-store.properties\");", "originalCommit": "b474a2df079d7e407bb2c4f42c176bda8f781b6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c8ce1dc3af03bb87c5895c9ef0269e34d4c5548", "url": "https://github.com/prestodb/presto/commit/6c8ce1dc3af03bb87c5895c9ef0269e34d4c5548", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-25T17:04:23Z", "type": "forcePushed"}, {"oid": "fea0fab26631f63fe9f1f150aca17bae332ad47e", "url": "https://github.com/prestodb/presto/commit/fea0fab26631f63fe9f1f150aca17bae332ad47e", "message": "Fixup! Allow temp storage to have separate conf files and loaded\nseparately", "committedDate": "2020-10-26T04:20:54Z", "type": "forcePushed"}, {"oid": "141599d294e3328326c51961b45a7dd7740115a4", "url": "https://github.com/prestodb/presto/commit/141599d294e3328326c51961b45a7dd7740115a4", "message": "Introduce temporary store based spilling\n\nCo-authored-by: Andrii Rosa <andriirosa@fb.com>", "committedDate": "2020-10-26T16:49:57Z", "type": "commit"}, {"oid": "ba7ac9d7c9a5bca18ce3f3d6c16eb526f99afd75", "url": "https://github.com/prestodb/presto/commit/ba7ac9d7c9a5bca18ce3f3d6c16eb526f99afd75", "message": "Add test for temporary store based spilling", "committedDate": "2020-10-26T16:49:57Z", "type": "commit"}, {"oid": "43217c4bd1ade90e44746dbb2f23a4a1f1ce066c", "url": "https://github.com/prestodb/presto/commit/43217c4bd1ade90e44746dbb2f23a4a1f1ce066c", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-26T16:49:57Z", "type": "commit"}, {"oid": "43217c4bd1ade90e44746dbb2f23a4a1f1ce066c", "url": "https://github.com/prestodb/presto/commit/43217c4bd1ade90e44746dbb2f23a4a1f1ce066c", "message": "Make TemporaryStore pluggable", "committedDate": "2020-10-26T16:49:57Z", "type": "forcePushed"}, {"oid": "0abcf2b944887b84a61bf6048fe78e5b88ec880c", "url": "https://github.com/prestodb/presto/commit/0abcf2b944887b84a61bf6048fe78e5b88ec880c", "message": "Rename TemporaryStore to TempStorage", "committedDate": "2020-10-26T19:49:36Z", "type": "commit"}, {"oid": "0abcf2b944887b84a61bf6048fe78e5b88ec880c", "url": "https://github.com/prestodb/presto/commit/0abcf2b944887b84a61bf6048fe78e5b88ec880c", "message": "Rename TemporaryStore to TempStorage", "committedDate": "2020-10-26T19:49:36Z", "type": "forcePushed"}]}