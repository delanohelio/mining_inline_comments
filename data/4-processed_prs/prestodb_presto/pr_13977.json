{"pr_number": 13977, "pr_title": "Use JTS for ST_IsValid and ST_IsSimple", "pr_createdAt": "2020-01-16T21:33:36Z", "pr_url": "https://github.com/prestodb/presto/pull/13977", "timeline": [{"oid": "fdacc4c1255ef7179987cb162d177a9631a132a8", "url": "https://github.com/prestodb/presto/commit/fdacc4c1255ef7179987cb162d177a9631a132a8", "message": "Use JTS for ST_IsValid, ST_IsSimple, and geometry_invalid_reason", "committedDate": "2020-01-16T21:39:53Z", "type": "forcePushed"}, {"oid": "3bab11b5561badb6154b6ff03bfef16d6a97cfc9", "url": "https://github.com/prestodb/presto/commit/3bab11b5561badb6154b6ff03bfef16d6a97cfc9", "message": "Use JTS for ST_IsValid, ST_IsSimple, and geometry_invalid_reason", "committedDate": "2020-01-21T18:36:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NTQwMA==", "url": "https://github.com/prestodb/presto/pull/13977#discussion_r383365400", "bodyText": "What about POLYGON, MULTI_POLYGON and GEOMETRY_COLLECTION?", "author": "arhimondr", "createdAt": "2020-02-24T16:19:13Z", "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/GeometryUtils.java", "diffHunk": "@@ -276,4 +280,40 @@ public static String wktFromJtsGeometry(org.locationtech.jts.geom.Geometry geome\n     {\n         return GEOMETRY_FACTORY.createPolygon();\n     }\n+\n+    public static String getGeometryInvalidReason(org.locationtech.jts.geom.Geometry geometry)\n+    {\n+        IsValidOp validOp = new IsValidOp(geometry);\n+        IsSimpleOp simpleOp = new IsSimpleOp(geometry);\n+        try {\n+            TopologyValidationError err = validOp.getValidationError();\n+            if (err != null) {\n+                return err.getMessage();\n+            }\n+            if (!simpleOp.isSimple()) {\n+                String errorDescription;\n+                String geometryType = geometry.getGeometryType();\n+                switch (GeometryType.getForJtsGeometryType(geometryType)) {\n+                    case POINT:\n+                        errorDescription = \"Invalid point\";\n+                        break;\n+                    case MULTI_POINT:\n+                        errorDescription = \"Repeated point\";\n+                        break;\n+                    case LINE_STRING:\n+                    case MULTI_LINE_STRING:\n+                        errorDescription = \"Self-intersection at or near\";\n+                        break;\n+                    default:\n+                        throw new PrestoException(INVALID_FUNCTION_ARGUMENT, format(\"Unknown geometry type: %s\", geometryType));", "originalCommit": "3bab11b5561badb6154b6ff03bfef16d6a97cfc9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NjAwMA==", "url": "https://github.com/prestodb/presto/pull/13977#discussion_r383366000", "bodyText": "In what cases this can be thrown?", "author": "arhimondr", "createdAt": "2020-02-24T16:20:09Z", "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/GeometryUtils.java", "diffHunk": "@@ -276,4 +280,40 @@ public static String wktFromJtsGeometry(org.locationtech.jts.geom.Geometry geome\n     {\n         return GEOMETRY_FACTORY.createPolygon();\n     }\n+\n+    public static String getGeometryInvalidReason(org.locationtech.jts.geom.Geometry geometry)\n+    {\n+        IsValidOp validOp = new IsValidOp(geometry);\n+        IsSimpleOp simpleOp = new IsSimpleOp(geometry);\n+        try {\n+            TopologyValidationError err = validOp.getValidationError();\n+            if (err != null) {\n+                return err.getMessage();\n+            }\n+            if (!simpleOp.isSimple()) {\n+                String errorDescription;\n+                String geometryType = geometry.getGeometryType();\n+                switch (GeometryType.getForJtsGeometryType(geometryType)) {\n+                    case POINT:\n+                        errorDescription = \"Invalid point\";\n+                        break;\n+                    case MULTI_POINT:\n+                        errorDescription = \"Repeated point\";\n+                        break;\n+                    case LINE_STRING:\n+                    case MULTI_LINE_STRING:\n+                        errorDescription = \"Self-intersection at or near\";\n+                        break;\n+                    default:\n+                        throw new PrestoException(INVALID_FUNCTION_ARGUMENT, format(\"Unknown geometry type: %s\", geometryType));\n+                }\n+                org.locationtech.jts.geom.Coordinate nonSimpleLocation = simpleOp.getNonSimpleLocation();\n+                return format(\"[%s] %s: (%s %s)\", geometryType, errorDescription, nonSimpleLocation.getX(), nonSimpleLocation.getY());\n+            }\n+            return null;\n+        }\n+        catch (UnsupportedOperationException e) {", "originalCommit": "3bab11b5561badb6154b6ff03bfef16d6a97cfc9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2ODE4Mw==", "url": "https://github.com/prestodb/presto/pull/13977#discussion_r383368183", "bodyText": "Why the two variations of this method are needed?\nIn a place where TopologyException is expected the PrestoException can be caught, and then the e.getCause() can get examined.", "author": "arhimondr", "createdAt": "2020-02-24T16:23:29Z", "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/JtsGeometrySerde.java", "diffHunk": "@@ -60,10 +60,20 @@ public static Geometry deserialize(Slice shape)\n             return readGeometry(input, type);\n         }\n         catch (TopologyException e) {\n-            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);\n+            if (safe) {\n+                throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);", "originalCommit": "3bab11b5561badb6154b6ff03bfef16d6a97cfc9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7cc490b015386c3ba5550043bccd82f1efb21d52", "url": "https://github.com/prestodb/presto/commit/7cc490b015386c3ba5550043bccd82f1efb21d52", "message": "Use JTS for ST_IsValid, ST_IsSimple, and geometry_invalid_reason", "committedDate": "2020-02-24T19:42:55Z", "type": "forcePushed"}, {"oid": "fbf26962d760a47d70a1bbc632bfb89bb01ad74b", "url": "https://github.com/prestodb/presto/commit/fbf26962d760a47d70a1bbc632bfb89bb01ad74b", "message": "Separate testing ST_IsValid from geometry_invalid_reason\n\nThese are two separate functions, so it makes sense to test them\nseparately.  Also, it will make conversion to JTS easier.", "committedDate": "2020-02-25T15:52:58Z", "type": "commit"}, {"oid": "66dd153768360632ff752f49693e03c45d76819d", "url": "https://github.com/prestodb/presto/commit/66dd153768360632ff752f49693e03c45d76819d", "message": "Use JTS for ST_IsValid, ST_IsSimple, and geometry_invalid_reason", "committedDate": "2020-02-25T15:52:58Z", "type": "commit"}, {"oid": "66dd153768360632ff752f49693e03c45d76819d", "url": "https://github.com/prestodb/presto/commit/66dd153768360632ff752f49693e03c45d76819d", "message": "Use JTS for ST_IsValid, ST_IsSimple, and geometry_invalid_reason", "committedDate": "2020-02-25T15:52:58Z", "type": "forcePushed"}]}