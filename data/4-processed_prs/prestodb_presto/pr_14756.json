{"pr_number": 14756, "pr_title": "Ensure exception thrown by scheduled tasks are logged", "pr_createdAt": "2020-07-01T04:58:24Z", "pr_url": "https://github.com/prestodb/presto/pull/14756", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODg5MQ==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r448328891", "bodyText": "In my opinion we should log and throw until and unless we are confident it is OK to retry and also that retry can fix things. If we get into a situation that 1 eentry is causing problems and that is causing this executor to always exit midway, then dying and complaining is probably a better solution.", "author": "mayankgarg1990", "createdAt": "2020-07-01T12:29:25Z", "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -153,8 +153,13 @@ public FileMergeCacheManager(\n \n         this.cacheSizeCalculateExecutor.scheduleAtFixedRate(\n                 () -> {\n-                    cacheScopeFiles.keySet().forEach(cacheIdentifier -> cacheScopeSizeInBytes.put(cacheIdentifier, getCacheScopeSizeInBytes(cacheIdentifier)));\n-                    cacheScopeSizeInBytes.keySet().removeIf(key -> !cacheScopeFiles.containsKey(key));\n+                    try {\n+                        cacheScopeFiles.keySet().forEach(cacheIdentifier -> cacheScopeSizeInBytes.put(cacheIdentifier, getCacheScopeSizeInBytes(cacheIdentifier)));\n+                        cacheScopeSizeInBytes.keySet().removeIf(key -> !cacheScopeFiles.containsKey(key));\n+                    }\n+                    catch (Throwable t) {\n+                        log.error(t, \"Error calculating cache size\");", "originalCommit": "e0273d18de07b64b150a682162f6c54aeb795945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MTYwMA==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r448641600", "bodyText": "It looks like it is pretty consistent in our codebase to log and let it retry. Do you think we should stop retrying for this specific case? Or in general?", "author": "arhimondr", "createdAt": "2020-07-01T22:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzOTM3Nw==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r452939377", "bodyText": "In this case and in general for most cases until and unless the underlying logic involves RPC calls. Here this thread is modifying class members and if the error is non-recoverable, then it is possible that we get half of the state in the variable and we think that things are working - so better screw it up well", "author": "mayankgarg1990", "createdAt": "2020-07-10T16:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3MTAwNg==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r461671006", "bodyText": "Currently the code doesn't have any RPC calls, but in theory it might at some point. Logging and retrying is the standard way of handling problems in scheduled tasks. Further, when we build alerting, we are going to be able to detect them quickly. It feels like killing the JVM is too drastic measure, and it might be potentially unsafe as somebody might not realize how the error is handled and add some code that is potentially recoverable.\nThoughts?", "author": "arhimondr", "createdAt": "2020-07-28T15:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyOTM3MQ==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r448329371", "bodyText": "It is better to not to schedule rather than to die midway everytime. Detecting and fixing no scheduling is easier than partial scheduling.", "author": "mayankgarg1990", "createdAt": "2020-07-01T12:30:17Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -200,7 +200,6 @@ public void start()\n                 }\n                 catch (Throwable t) {\n                     log.error(t, \"Error while executing refreshAndStartQueries\");\n-                    throw t;", "originalCommit": "e0273d18de07b64b150a682162f6c54aeb795945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MTc3Mw==", "url": "https://github.com/prestodb/presto/pull/14756#discussion_r448641773", "bodyText": "Makes sense, let me revert it then", "author": "arhimondr", "createdAt": "2020-07-01T22:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyOTM3MQ=="}], "type": "inlineReview"}, {"oid": "1e2068a586fcb030d5defacb9b6679c1634441a2", "url": "https://github.com/prestodb/presto/commit/1e2068a586fcb030d5defacb9b6679c1634441a2", "message": "Ensure exception thrown by scheduled tasks are logged\n\nRegularly scheduled tasks are dying as long as at least single run fails.\nCatching and logging the failures will help to debug problems in scheduled tasks.", "committedDate": "2020-07-01T22:10:50Z", "type": "forcePushed"}, {"oid": "f5574dc3b266f7ccc3958df0d1ef57c8ff85e6ea", "url": "https://github.com/prestodb/presto/commit/f5574dc3b266f7ccc3958df0d1ef57c8ff85e6ea", "message": "Ensure exception thrown by scheduled tasks are logged\n\nRegularly scheduled tasks are dying as long as at least single run fails.\nCatching and logging the failures will help to debug problems in scheduled tasks.", "committedDate": "2020-08-10T15:06:38Z", "type": "commit"}, {"oid": "f5574dc3b266f7ccc3958df0d1ef57c8ff85e6ea", "url": "https://github.com/prestodb/presto/commit/f5574dc3b266f7ccc3958df0d1ef57c8ff85e6ea", "message": "Ensure exception thrown by scheduled tasks are logged\n\nRegularly scheduled tasks are dying as long as at least single run fails.\nCatching and logging the failures will help to debug problems in scheduled tasks.", "committedDate": "2020-08-10T15:06:38Z", "type": "forcePushed"}]}