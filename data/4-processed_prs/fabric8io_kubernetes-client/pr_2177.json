{"pr_number": 2177, "pr_title": "KubernetesDeserialier lazy loads mappings via current thread (#2109)", "pr_createdAt": "2020-04-29T15:02:13Z", "pr_url": "https://github.com/fabric8io/kubernetes-client/pull/2177", "timeline": [{"oid": "a1623f16f24a068aeff467e66b7bf65e5e1d26da", "url": "https://github.com/fabric8io/kubernetes-client/commit/a1623f16f24a068aeff467e66b7bf65e5e1d26da", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-04-29T15:40:06Z", "type": "forcePushed"}, {"oid": "3ae271db2a2e013d7fd31dc3f12cfd7442fbd748", "url": "https://github.com/fabric8io/kubernetes-client/commit/3ae271db2a2e013d7fd31dc3f12cfd7442fbd748", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-04-29T16:18:39Z", "type": "forcePushed"}, {"oid": "56ee792bb8e321cae65520d59d8d5d103eb2099e", "url": "https://github.com/fabric8io/kubernetes-client/commit/56ee792bb8e321cae65520d59d8d5d103eb2099e", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-04-29T19:38:20Z", "type": "forcePushed"}, {"oid": "6fd2df2b6947ab6326771dc03a8911d61bbc2665", "url": "https://github.com/fabric8io/kubernetes-client/commit/6fd2df2b6947ab6326771dc03a8911d61bbc2665", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-04-30T14:45:37Z", "type": "forcePushed"}, {"oid": "7d1ef4f340c998d96b8350d4ba66e9f5568969ac", "url": "https://github.com/fabric8io/kubernetes-client/commit/7d1ef4f340c998d96b8350d4ba66e9f5568969ac", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-04-30T16:00:27Z", "type": "forcePushed"}, {"oid": "9bfafa53d7b5a71e9e23a9f791ff3d0832734205", "url": "https://github.com/fabric8io/kubernetes-client/commit/9bfafa53d7b5a71e9e23a9f791ff3d0832734205", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-04T12:57:38Z", "type": "forcePushed"}, {"oid": "4b0d871c925616fd6ccbaa00f291decb91087a47", "url": "https://github.com/fabric8io/kubernetes-client/commit/4b0d871c925616fd6ccbaa00f291decb91087a47", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-04T21:08:22Z", "type": "forcePushed"}, {"oid": "7a80238df70b963015436811f058b2e112a30868", "url": "https://github.com/fabric8io/kubernetes-client/commit/7a80238df70b963015436811f058b2e112a30868", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-04T21:11:50Z", "type": "forcePushed"}, {"oid": "eafebb47fd1707b9f6144db5ada36d7ee3355539", "url": "https://github.com/fabric8io/kubernetes-client/commit/eafebb47fd1707b9f6144db5ada36d7ee3355539", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-04T21:32:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzNjQ5NQ==", "url": "https://github.com/fabric8io/kubernetes-client/pull/2177#discussion_r419836495", "bodyText": "could you take care of the indentation here?", "author": "dev-gaur", "createdAt": "2020-05-05T02:47:47Z", "path": "kubernetes-model/kubernetes-model-core/src/main/java/io/fabric8/kubernetes/internal/KubernetesDeserializer.java", "diffHunk": "@@ -152,42 +111,133 @@ public static void registerCustomKind(String kind, Class<? extends KubernetesRes\n      * Registers a Custom Resource Definition Kind\n      */\n     public static void registerCustomKind(String apiVersion, String kind, Class<? extends KubernetesResource> clazz) {\n-        MAP.put(getKey(apiVersion, kind), clazz);\n+        mapping.registerKind(apiVersion, kind, clazz);\n+    }\n+\n+    /**\n+     * Registers a Custom Resource Mapping Provider\n+     */\n+    public static void registerProvider(KubernetesResourceMappingProvider provider) {\n+        mapping.registerProvider(provider);\n     }\n \n-    private static Class getTypeForKey(String key) {\n-        Class<? extends KubernetesResource> result = MAP.get(key);\n-        if (result == null) {\n-            String name = key != null && key.contains(KEY_SEPARATOR) ?\n-                key.substring(key.indexOf(KEY_SEPARATOR) + 1) :\n-                key;\n-            \n-            result = getInternalTypeForName(name);\n+    static class Mapping {\n+\n+        private static final String KEY_SEPARATOR = \"#\";\n+        private static final String[] PACKAGES = {\n+                \"io.fabric8.kubernetes.api.model.\",\n+                \"io.fabric8.kubernetes.api.model.admissionregistration.\",\n+                \"io.fabric8.kubernetes.api.model.apiextensions.\",\n+                \"io.fabric8.kubernetes.api.model.apps.\",\n+                \"io.fabric8.kubernetes.api.model.authentication.\",\n+                \"io.fabric8.kubernetes.api.model.authorization.\",\n+                \"io.fabric8.kubernetes.api.model.batch.\",\n+                \"io.fabric8.kubernetes.api.model.certificates.\",\n+                \"io.fabric8.kubernetes.api.model.coordination.\",\n+                \"io.fabric8.kubernetes.api.model.discovery.\",\n+                \"io.fabric8.kubernetes.api.model.extensions.\",\n+                \"io.fabric8.kubernetes.api.model.events.\",\n+                \"io.fabric8.kubernetes.api.model.networking.\",\n+                \"io.fabric8.kubernetes.api.model.policy.\",\n+                \"io.fabric8.kubernetes.api.model.rbac.\",\n+                \"io.fabric8.kubernetes.api.model.storage.\",\n+                \"io.fabric8.kubernetes.api.model.scheduling.\",\n+                \"io.fabric8.kubernetes.api.model.settings.\",\n+                \"io.fabric8.openshift.api.model.\"\n+        };\n+\n+        private Map<String, Class<? extends KubernetesResource>> mappings;\n+\n+        public synchronized Class<? extends KubernetesResource> getForKey(String key) {\n+            return getMappings().computeIfAbsent(key, k -> getInternalTypeForName(getClassName(k)));\n         }\n \n-        if (result != null) {\n-            MAP.put(key, result);\n+        public synchronized void registerKind(String apiVersion, String kind, Class<? extends KubernetesResource> clazz) {\n+            getMappings().put(createKey(apiVersion, kind), clazz);\n+        }\n+\n+        public synchronized void registerProvider(KubernetesResourceMappingProvider provider) {\n+            if (provider == null) {\n+                return;\n+            }\n+            Map<String, Class<? extends KubernetesResource>> providerMappings = provider.getMappings().entrySet().stream()\n+                    //If the model is shaded (which is as part of kubernetes-client uberjar) this is going to cause conflicts.\n+                    //This is why we NEED TO filter out incompatible resources.\n+                    .filter(entry -> KubernetesResource.class.isAssignableFrom(entry.getValue()))\n+                    .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+            getMappings().putAll(providerMappings);\n         }\n-        return result;\n-    }\n \n-    private static Class getInternalTypeForName(String name) {\n+        /**\n+         * Returns a composite key for apiVersion and kind.\n+         */\n+        protected String createKey(String apiVersion, String kind) {\n+            if (kind == null) {\n+                return null;\n+            } else if (apiVersion == null) {\n+                return kind;\n+            } else {\n+                return apiVersion + KEY_SEPARATOR + kind;\n+            }\n+        }\n \n-      for (String aPackage : PACKAGES) {\n-        Class result = loadClassIfExists(aPackage + name);\n-        if (result != null) {\n-          return result;\n+        private synchronized Map<String, Class<? extends KubernetesResource>> getMappings() {\n+            if (mappings == null) {\n+                this.mappings = new HashMap<>();\n+                getAllMappingProviders().forEach(this::registerProvider);\n+            }\n+            return mappings;\n         }\n-      }\n \n-        return null;\n-    } \n+        protected Stream<KubernetesResourceMappingProvider> getAllMappingProviders() {\n+            //Use service loader to load extension types.\n+            Iterable<KubernetesResourceMappingProvider> currentThreadClassLoader =\n+                    () -> ServiceLoader.load(KubernetesResourceMappingProvider.class, Thread.currentThread().getContextClassLoader())\n+                            .iterator();\n+            Iterable<KubernetesResourceMappingProvider> classClassLoader =\n+                    () -> ServiceLoader.load(KubernetesResourceMappingProvider.class, KubernetesDeserializer.class.getClassLoader())\n+                            .iterator();\n+            return Stream.concat(\n+                    StreamSupport.stream(currentThreadClassLoader.spliterator(), false),\n+                    StreamSupport.stream(classClassLoader.spliterator(), false))\n+                    .filter(distinctByClassName(KubernetesResourceMappingProvider::getClass));\n+        }\n \n-    private static Class loadClassIfExists(String className) {\n-        try {\n-            return KubernetesDeserializer.class.getClassLoader().loadClass(className);\n-        } catch (Throwable t) {\n+        private String getClassName(String key) {\n+            if (key != null && key.contains(KEY_SEPARATOR)) {\n+                return key.substring(key.indexOf(KEY_SEPARATOR) + 1);\n+            } else {\n+                return key;\n+            }\n+        }\n+\n+        private Class<? extends KubernetesResource> getInternalTypeForName(String name) {\n+            for (String aPackage : PACKAGES) {\n+                Class<? extends KubernetesResource> result = loadClassIfExists(aPackage + name);\n+                if (result != null) {\n+                    return result;\n+                }\n+            }\n             return null;\n         }\n+\n+        private Class<? extends KubernetesResource> loadClassIfExists(String className) {\n+            try {\n+                Class<?> clazz = KubernetesDeserializer.class.getClassLoader().loadClass(className);\n+                if (!KubernetesResource.class.isAssignableFrom(clazz)) {\n+                    return null;\n+                }\n+                return (Class<? extends KubernetesResource>) clazz;\n+            } catch (Throwable t) {\n+                return null;\n+            }\n+        }\n+\n+        private Predicate<KubernetesResourceMappingProvider> distinctByClassName(\n+                Function<KubernetesResourceMappingProvider, Class<? extends KubernetesResourceMappingProvider>> mapperProvider) {", "originalCommit": "eafebb47fd1707b9f6144db5ada36d7ee3355539", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0OTcwMw==", "url": "https://github.com/fabric8io/kubernetes-client/pull/2177#discussion_r419949703", "bodyText": "@dev-gaur this indentation is on purpose, the whole line is too long to fit in 120 characters. Splitting parts isn't readable since it's a single parameter with lengthy generics declaration. I therefore opted to keep the param declaration all together but pushed it onto it's own line that's indented by 4. 4 characters indentation is what I used consistently across this class. Makes sense?", "author": "adietish", "createdAt": "2020-05-05T08:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzNjQ5NQ=="}], "type": "inlineReview"}, {"oid": "db3d6ff6f3c0f2d2aa4c4f29722b3f4e0370f32a", "url": "https://github.com/fabric8io/kubernetes-client/commit/db3d6ff6f3c0f2d2aa4c4f29722b3f4e0370f32a", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-05T09:34:10Z", "type": "forcePushed"}, {"oid": "866a6f6dc7622ba2fcc170d0a139c4be8b9f3e68", "url": "https://github.com/fabric8io/kubernetes-client/commit/866a6f6dc7622ba2fcc170d0a139c4be8b9f3e68", "message": "KubernetesDeserialier lazy loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-05T10:15:10Z", "type": "forcePushed"}, {"oid": "0c3c07bb04520cfeff8f7ffdda48c7658de962b1", "url": "https://github.com/fabric8io/kubernetes-client/commit/0c3c07bb04520cfeff8f7ffdda48c7658de962b1", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-05T14:56:43Z", "type": "forcePushed"}, {"oid": "bdca2f01e777688fb11f0ac1419865beaf0d3b4a", "url": "https://github.com/fabric8io/kubernetes-client/commit/bdca2f01e777688fb11f0ac1419865beaf0d3b4a", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-05T23:13:26Z", "type": "forcePushed"}, {"oid": "70d5b78c9a1d63c1c6fe27a44de2dc506618ddfb", "url": "https://github.com/fabric8io/kubernetes-client/commit/70d5b78c9a1d63c1c6fe27a44de2dc506618ddfb", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-06T09:01:39Z", "type": "forcePushed"}, {"oid": "d8c77ead2e57b065c65f094c74c471a4841fa310", "url": "https://github.com/fabric8io/kubernetes-client/commit/d8c77ead2e57b065c65f094c74c471a4841fa310", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-06T10:20:18Z", "type": "forcePushed"}, {"oid": "e26571f89d62917da307fcfc74c589ab2299ff6f", "url": "https://github.com/fabric8io/kubernetes-client/commit/e26571f89d62917da307fcfc74c589ab2299ff6f", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-06T10:27:03Z", "type": "commit"}, {"oid": "e26571f89d62917da307fcfc74c589ab2299ff6f", "url": "https://github.com/fabric8io/kubernetes-client/commit/e26571f89d62917da307fcfc74c589ab2299ff6f", "message": "KubernetesDeserialier loads mappings via current thread (#2109)\n\nSigned-off-by: Andre Dietisheim <adietish@redhat.com>", "committedDate": "2020-05-06T10:27:03Z", "type": "forcePushed"}]}