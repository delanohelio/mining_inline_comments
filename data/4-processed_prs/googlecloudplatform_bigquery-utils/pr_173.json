{"pr_number": 173, "pr_title": "Auto Query Fixer: develop the java client for ZetaSQL Helper", "pr_createdAt": "2020-09-03T20:17:06Z", "pr_url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/173", "timeline": [{"oid": "042e01c2d8cfb96f3c26e185222d78cbc50416de", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/042e01c2d8cfb96f3c26e185222d78cbc50416de", "message": "Rebase...", "committedDate": "2020-09-03T20:13:15Z", "type": "commit"}, {"oid": "bf52df23d6ce4749568b1cb4306ba0a4c6d4b703", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/bf52df23d6ce4749568b1cb4306ba0a4c6d4b703", "message": "Implement ZetaSQL Helper java client", "committedDate": "2020-09-03T20:13:27Z", "type": "commit"}, {"oid": "4c5555444940bf56a36c791ae8f4c7e7ba385a41", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4c5555444940bf56a36c791ae8f4c7e7ba385a41", "message": "Implement ZetaSQL Helper java client", "committedDate": "2020-09-03T20:20:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM0MDg2MQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/173#discussion_r483340861", "bodyText": "Can we use random port here?", "author": "kikkyo", "createdAt": "2020-09-04T01:48:15Z", "path": "tools/zetasql_helper/java/com/google/bigquery/utils/zetasqlhelper/Client.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.google.bigquery.utils.zetasqlhelper;\n+\n+import io.grpc.Channel;\n+\n+/**\n+ * Client to establish connections with ZetaSQL Helper server.\n+ */\n+public class Client {\n+\n+    private static ZetaSqlHelperLocalServiceGrpc.ZetaSqlHelperLocalServiceBlockingStub stub;\n+    private static int port = 50051;", "originalCommit": "4c5555444940bf56a36c791ae8f4c7e7ba385a41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM0MzM2NQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/173#discussion_r483343365", "bodyText": "The default one is 50051, but users can always set their own port using setPort method", "author": "mingen-pan", "createdAt": "2020-09-04T01:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM0MDg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM0MTE5MQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/173#discussion_r483341191", "bodyText": "nit: \"can\" not", "author": "kikkyo", "createdAt": "2020-09-04T01:49:39Z", "path": "tools/zetasql_helper/java/com/google/bigquery/utils/zetasqlhelper/LocalServiceDockerProvider.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package com.google.bigquery.utils.zetasqlhelper;\n+\n+import com.github.dockerjava.api.DockerClient;\n+import com.github.dockerjava.api.command.CreateContainerResponse;\n+import com.github.dockerjava.api.model.*;\n+import com.github.dockerjava.core.DefaultDockerClientConfig;\n+import com.github.dockerjava.core.DockerClientConfig;\n+import com.github.dockerjava.core.DockerClientImpl;\n+import com.github.dockerjava.httpclient5.ApacheDockerHttpClient;\n+import com.github.dockerjava.transport.DockerHttpClient;\n+import io.grpc.Channel;\n+import io.grpc.ManagedChannelBuilder;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * A controller responsible for managing the Docker Image of ZetaSQL Helper server. It can check\n+ * if a server container is started, start a server and connect to a server.\n+ */\n+public class LocalServiceDockerProvider implements LocalServiceProvider {\n+\n+    private final static Integer SERVER_PORT = 50051;\n+    private final static String LOCAL_HOST = \"localhost:\";\n+    private static String IMAGE = \"gcr.io/sql-gravity-internship/zetasql-helper:1.0\";\n+\n+    private final static String RUNNING = \"running\";\n+    // waiting time for starting server. If the server container con not start in this period,", "originalCommit": "4c5555444940bf56a36c791ae8f4c7e7ba385a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM0MTMzOQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/173#discussion_r483341339", "bodyText": "nit: If", "author": "kikkyo", "createdAt": "2020-09-04T01:50:11Z", "path": "tools/zetasql_helper/java/com/google/bigquery/utils/zetasqlhelper/LocalServiceDockerProvider.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package com.google.bigquery.utils.zetasqlhelper;\n+\n+import com.github.dockerjava.api.DockerClient;\n+import com.github.dockerjava.api.command.CreateContainerResponse;\n+import com.github.dockerjava.api.model.*;\n+import com.github.dockerjava.core.DefaultDockerClientConfig;\n+import com.github.dockerjava.core.DockerClientConfig;\n+import com.github.dockerjava.core.DockerClientImpl;\n+import com.github.dockerjava.httpclient5.ApacheDockerHttpClient;\n+import com.github.dockerjava.transport.DockerHttpClient;\n+import io.grpc.Channel;\n+import io.grpc.ManagedChannelBuilder;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * A controller responsible for managing the Docker Image of ZetaSQL Helper server. It can check\n+ * if a server container is started, start a server and connect to a server.\n+ */\n+public class LocalServiceDockerProvider implements LocalServiceProvider {\n+\n+    private final static Integer SERVER_PORT = 50051;\n+    private final static String LOCAL_HOST = \"localhost:\";\n+    private static String IMAGE = \"gcr.io/sql-gravity-internship/zetasql-helper:1.0\";\n+\n+    private final static String RUNNING = \"running\";\n+    // waiting time for starting server. If the server container con not start in this period,\n+    // it will be considered shutdown. Unit is millisecond.\n+    private final static long START_SERVER_TIMEOUT = 5000;\n+\n+    private final DockerClient client;\n+\n+    public LocalServiceDockerProvider() {\n+        DockerClientConfig config = DefaultDockerClientConfig.createDefaultConfigBuilder().build();\n+        DockerHttpClient httpClient = new ApacheDockerHttpClient.Builder()\n+                .dockerHost(config.getDockerHost())\n+                .sslConfig(config.getSSLConfig())\n+                .build();\n+\n+        client = DockerClientImpl.getInstance(config, httpClient);\n+    }\n+\n+    /**\n+     * Start a server locally at the given port number.\n+     *\n+     * @param port port number\n+     */\n+    @Override\n+    public void startServer(final Integer port) {\n+        String binding = String.format(\"%d:%d\", port, SERVER_PORT);\n+        CreateContainerResponse response =\n+                client\n+                        .createContainerCmd(IMAGE)\n+                        .withExposedPorts(ExposedPort.parse(\"\" + SERVER_PORT))\n+                        .withHostConfig(\n+                                HostConfig.newHostConfig().withPortBindings(PortBinding.parse(binding)))\n+                        .exec();\n+\n+        String containerId = response.getId();\n+        client.startContainerCmd(containerId).exec();\n+\n+        if (!waitServerToStart(containerId)) {\n+            throw new LocalServiceException(\"Unable to start ZetaSql Helper Service Docker container\");\n+        }\n+    }\n+\n+    /**\n+     * Check if a server has been started at the given port number.\n+     *\n+     * @param port port number\n+     * @return boolean of whether a server is on.\n+     */\n+    @Override\n+    public boolean isServerOn(final Integer port) {\n+        List<Container> containers = client.listContainersCmd()\n+                .withAncestorFilter(Collections.singletonList(IMAGE))\n+                .exec();\n+\n+        for (Container container : containers) {\n+            ContainerPort[] containerPorts = container.getPorts();\n+            for (ContainerPort containerPort : containerPorts) {\n+                if (SERVER_PORT.equals(containerPort.getPrivatePort()) && port.equals(containerPort.getPublicPort())) {\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Connect to the server at the given port number.\n+     *\n+     * @param port port number\n+     * @return Channel to the server\n+     */\n+    @Override\n+    public Channel connect(final Integer port) {\n+        try {\n+            // if the server is not active, try to start it.", "originalCommit": "4c5555444940bf56a36c791ae8f4c7e7ba385a41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77c201c8d3a182bfd4c3036882dc5f8967ba218c", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/77c201c8d3a182bfd4c3036882dc5f8967ba218c", "message": "minor fix", "committedDate": "2020-09-04T02:02:08Z", "type": "commit"}, {"oid": "0146b4c42672ecb024dd2f06889b54e78b17dd0d", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0146b4c42672ecb024dd2f06889b54e78b17dd0d", "message": "Merge branch 'master' into zetasql_helper_java_client_rebase", "committedDate": "2020-09-04T02:02:30Z", "type": "commit"}]}