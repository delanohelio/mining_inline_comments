{"pr_number": 114, "pr_title": "Addition of BigQuery System Tables Reports", "pr_createdAt": "2020-07-22T16:31:01Z", "pr_url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114", "timeline": [{"oid": "d81256b7fbff20dd7d5732350190d5d27479f6e8", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d81256b7fbff20dd7d5732350190d5d27479f6e8", "message": "Added sql scripts, initial README, and initial documentation pages", "committedDate": "2020-07-21T14:09:47Z", "type": "commit"}, {"oid": "768233ee69c6f454f7ec9353591eb14ddb33394f", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/768233ee69c6f454f7ec9353591eb14ddb33394f", "message": "Added public dashboard links to README, updated formatting", "committedDate": "2020-07-22T00:23:33Z", "type": "commit"}, {"oid": "83608ccca82b41a32691112cff10b107e870c593", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/83608ccca82b41a32691112cff10b107e870c593", "message": "Added images and updated documentation pages. Minor README updates.", "committedDate": "2020-07-22T04:02:36Z", "type": "commit"}, {"oid": "69b26bcb44c24d4277f361b49f72b8160071c5dc", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/69b26bcb44c24d4277f361b49f72b8160071c5dc", "message": "Clarified steps in README", "committedDate": "2020-07-22T15:17:13Z", "type": "commit"}, {"oid": "9f590a228b74889eec83bdfb735b6f6664951da4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9f590a228b74889eec83bdfb735b6f6664951da4", "message": "Typo fix", "committedDate": "2020-07-22T16:22:37Z", "type": "commit"}, {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "message": "Merge branch 'master' into master", "committedDate": "2020-07-24T18:36:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMTA1OQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460631059", "bodyText": "Remove space before rcp.reservation_name", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:43:25Z", "path": "views/system_tables/sql/current_assignments.sql", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the current reservation\n+ * assignments and associated slot capacities\n+ */\n+\n+-- This table retrieves the latest slot capacity for each reservation\n+WITH latest_slot_capacity as (\n+ SELECT\n+   rcp.reservation_name, rcp.slot_capacity\n+ FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMTY0OQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460631649", "bodyText": "Indent by two spaces\ngo/sqlstyle#joins", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:46:09Z", "path": "views/system_tables/sql/current_assignments.sql", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the current reservation\n+ * assignments and associated slot capacities\n+ */\n+\n+-- This table retrieves the latest slot capacity for each reservation\n+WITH latest_slot_capacity as (\n+ SELECT\n+   rcp.reservation_name, rcp.slot_capacity\n+ FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name ) )\n+-- Extract information about current assignments\n+SELECT\n+  acp.assignment_id,\n+  acp.project_id,\n+  acp.reservation_name,\n+  acp.job_type,\n+  acp.assignee_id,\n+  acp.assignee_type,\n+  lsc.slot_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.ASSIGNMENT_CHANGES_BY_PROJECT AS acp\n+-- Join to obtain the current slot capacities\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  lsc.reservation_name = acp.reservation_name", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjIxMw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632213", "bodyText": "We shouldn't nest WITH statements as it makes the logic hard to follow. Instead prefer to place the statement for commitments above the WITH statement for results.\ngo/sqlstyle#with-clause", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:49:01Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjk3Mw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632973", "bodyText": "Additionally, check your indentation inside the WITH statement", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjYwNA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632604", "bodyText": "Check your formatting\ngo/sqlstyle#line-wrapping", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:50:47Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjY2OQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632669", "bodyText": "Check your formatting\ngo/sqlstyle#line-wrapping", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:51:04Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjc2MQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632761", "bodyText": "This looks like it'll fit on a single line", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:51:31Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzA5NA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633094", "bodyText": "days is the start of a new WITH statement and should be on a separate line", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:53:12Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzMyNw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633327", "bodyText": "It doesn't look like this SELECT should be indented because it's outside the WITH statements", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:54:20Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (\n+-- This subquery is used to fill in the missing days between a commitment\n+-- starting and ending so that it can be graphed properly.\n+    SELECT day\n+    FROM (\n+      SELECT\n+        start_date,\n+        stop_date\n+      FROM results\n+    ), UNNEST(GENERATE_DATE_ARRAY(start_date, stop_date)) day\n+  )\n+  SELECT TIMESTAMP(day) as date, LAST_VALUE(slot_cummulative IGNORE NULLS) OVER(ORDER BY day) slots,", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzY1OA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633658", "bodyText": "Indent ON\ngo/sqlstyle#joins", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:55:41Z", "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (\n+-- This subquery is used to fill in the missing days between a commitment\n+-- starting and ending so that it can be graphed properly.\n+    SELECT day\n+    FROM (\n+      SELECT\n+        start_date,\n+        stop_date\n+      FROM results\n+    ), UNNEST(GENERATE_DATE_ARRAY(start_date, stop_date)) day\n+  )\n+  SELECT TIMESTAMP(day) as date, LAST_VALUE(slot_cummulative IGNORE NULLS) OVER(ORDER BY day) slots,\n+FROM days\n+-- Join these results with the cumulative slot count values for each day\n+LEFT JOIN results\n+ON day = DATE(change_timestamp)", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDU0OA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634548", "bodyText": "Put LEAD on a newline", "author": "ryanmcdowell", "createdAt": "2020-07-27T03:59:35Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDY2MQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634661", "bodyText": "Remove space before rcp.reservation_name", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:00:05Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDc4MA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634780", "bodyText": "Indent 2 spaces", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:00:38Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDgyNw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634827", "bodyText": "Indent 2 spaces", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:00:50Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTI4OA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635288", "bodyText": "Place BETWEEN on new line indented by 2 spaces. Indent AND the same\ngo/sqlstyle#between", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:03:11Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 31 days ago but completed 30 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 31 DAY)\n+  AND CURRENT_TIMESTAMP()", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTMxNA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635314", "bodyText": "Same as above", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:03:21Z", "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 31 days ago but completed 30 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 31 DAY)\n+  AND CURRENT_TIMESTAMP()\n+  AND jbo.end_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)\n+  AND CURRENT_TIMESTAMP()", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTM5NA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635394", "bodyText": "Place LEAD on the next line", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:03:47Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTQ2NQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635465", "bodyText": "Remove space before rcp.reservation_name", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:04:11Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTU3NA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635574", "bodyText": "Indent by 2 spaces", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:04:36Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTU5NQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635595", "bodyText": "Indent by 2 spaces", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:04:41Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTY5MA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635690", "bodyText": "Place BETWEEN on new line indented by 2 spaces. Indent AND the same\ngo/sqlstyle#between", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:05:03Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 8 days ago but completed 7 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 8 DAY)\n+  AND CURRENT_TIMESTAMP()", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTcxMA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635710", "bodyText": "Same as above", "author": "ryanmcdowell", "createdAt": "2020-07-27T04:05:11Z", "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 8 days ago but completed 7 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 8 DAY)\n+  AND CURRENT_TIMESTAMP()\n+  AND jbo.end_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)\n+  AND CURRENT_TIMESTAMP()", "originalCommit": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "39ac07cb304d678144e75124ddcaf597600c1fbf", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/39ac07cb304d678144e75124ddcaf597600c1fbf", "message": "Renamed 'pages' subdirectory to 'docs' and added top level 'dashboard' directory", "committedDate": "2020-08-04T17:34:14Z", "type": "commit"}, {"oid": "750792db3547a4541f0c48b6fbd6fa46421367dd", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/750792db3547a4541f0c48b6fbd6fa46421367dd", "message": "Fixed query formatting to adhere to style guide", "committedDate": "2020-08-04T20:13:23Z", "type": "commit"}, {"oid": "59db876d2bf059afce3ae538f62b5d0b4c2f707c", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/59db876d2bf059afce3ae538f62b5d0b4c2f707c", "message": "Merge branch 'master' of https://github.com/neemay/bigquery-utils into master", "committedDate": "2020-08-04T20:14:23Z", "type": "commit"}, {"oid": "ab91258385b41e3c7a5c7a435edb01133229df9b", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ab91258385b41e3c7a5c7a435edb01133229df9b", "message": "Formatting fix for WITH clause", "committedDate": "2020-08-04T20:50:16Z", "type": "commit"}, {"oid": "7d7b5cd4092edc454519a113f285bebd155592ee", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7d7b5cd4092edc454519a113f285bebd155592ee", "message": "Merge branch 'master' into master", "committedDate": "2020-08-16T23:12:29Z", "type": "commit"}]}