{"pr_number": 155, "pr_title": "Auto Query Fixer: use Regex to locate the incorrect table when fixing the TableNotFound error", "pr_createdAt": "2020-08-19T20:53:27Z", "pr_url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155", "timeline": [{"oid": "48db44dbfe3e1436a51080e1855b56f8c032cc44", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/48db44dbfe3e1436a51080e1855b56f8c032cc44", "message": "Use a regex to find the incorrect table in TableNotFoundFixer", "committedDate": "2020-08-19T20:09:43Z", "type": "commit"}, {"oid": "6a62b907682579220af264d1a28a9888800b918c", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6a62b907682579220af264d1a28a9888800b918c", "message": "Merge remote-tracking branch 'upstream/master' into add_fixer\n\n# Conflicts:\n#\ttools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "committedDate": "2020-08-19T20:48:54Z", "type": "commit"}, {"oid": "9c2c3ed505ea794ca286e0f2d4e5a9e789d22c10", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9c2c3ed505ea794ca286e0f2d4e5a9e789d22c10", "message": "Merge with master branch", "committedDate": "2020-08-19T20:49:40Z", "type": "commit"}, {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "message": "rename a local variable.", "committedDate": "2020-08-19T20:51:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0NzMyOQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474247329", "bodyText": "788? i think it should corresponding to the index defined in the kind enum?", "author": "kikkyo", "createdAt": "2020-08-20T20:15:39Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -13,8 +13,11 @@ public TokenImpl (Token token) {\n     this.token = token;\n   }\n \n-  @Override public int getKind() {\n-    return token.kind;\n+  @Override public Kind getKind() {\n+    if (token.kind == 788) {", "originalCommit": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MTU3OQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474251579", "bodyText": "Calcite defines hundreds of token kinds, so number 788 indeed means an ordinary identifier. Anyway this token class will be deprecated very soon once the ZetaSQL server is setup and a ZetaSQL token is introduced.", "author": "mingen-pan", "createdAt": "2020-08-20T20:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0NzMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MDAzNw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474250037", "bodyText": "i think the most common case would be 'datasetid.tableid', please make sure we handle this case.", "author": "kikkyo", "createdAt": "2020-08-20T20:20:46Z", "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/FixerTest.java", "diffHunk": "@@ -47,6 +47,7 @@ public void setup() {\n     fixerFactory = new FixerFactory(tokenProcessor, bigQueryServiceMock);\n   }\n \n+  //TODO: More test cases are need to test different table name, like `a.b`.c, `a.b.c`, `a`.`b`.c, and a.b.c.", "originalCommit": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg2MDM2NQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474860365", "bodyText": "The new commit has covered this case", "author": "mingen-pan", "createdAt": "2020-08-21T18:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MDAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MTUyMQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474251521", "bodyText": "\"?\" would match one or more times, what is it is \"datasetid.tableid\" without \"\"? how about \"datasetid.tableid`\" which is the most common case.", "author": "kikkyo", "createdAt": "2020-08-20T20:23:38Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -100,24 +106,32 @@ private String constructFullTableName(String projectId, String datasetId, String\n     return String.format(\"%s.%s.%s\", projectId, datasetId, tableName);\n   }\n \n-  private int findTheIndexOfIncorrectTable() {\n-    // The table in the error message is presented in the legacySQL mode, but this fixer is used to\n-    // fix the\n-    // standardSQL. Thus, the table name needs to be converted to the one consistent with\n-    // standardSQL.\n-    // The change is from project:dataset.table to project.dataset.table.\n-    String tableName = err.getTableName().replace(':', '.');\n-    int index = query.indexOf(tableName);\n-\n-    // Since the TableNotFound error has no position info, this method will convert the index to the\n-    // position and assign to the `err`.\n-    Position position = queryPositionConverter.indexToPos(index);\n-    this.err.setErrorPosition(position);\n-    return index;\n+  private SubstringView findSubstringViewOfIncorrectTable(TableId fullTableId) {\n+    String regex =\n+        String.format(\n+            \"`?%s`?.`?%s`?.`?%s`?\",", "originalCommit": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNTU3Nw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474835577", "bodyText": "Good point. I will cover this case.", "author": "mingen-pan", "createdAt": "2020-08-21T17:36:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MTUyMQ=="}], "type": "inlineReview"}, {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4a1be982d047bceac1052b7487c83479f0cf4a95", "message": "Support matching dataset.table in the TableNotFoundFixer", "committedDate": "2020-08-21T18:30:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NDY2Nw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r476994667", "bodyText": "I forgot maybe you explained last time why it is 786?", "author": "kikkyo", "createdAt": "2020-08-26T02:32:13Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -13,8 +13,11 @@ public TokenImpl (Token token) {\n     this.token = token;\n   }\n \n-  @Override public int getKind() {\n-    return token.kind;\n+  @Override public Kind getKind() {\n+    if (token.kind == 786 || token.kind == 788) {", "originalCommit": "4a1be982d047bceac1052b7487c83479f0cf4a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2OTIxMQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r477469211", "bodyText": "786 is the identifier with backticks, but 788 is an identifier without any enclosing.", "author": "mingen-pan", "createdAt": "2020-08-26T17:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NDY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2OTUwNQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r477469505", "bodyText": "They will be deprecated very soon. Probably next a few PRs when the ZetaSQL is used.", "author": "mingen-pan", "createdAt": "2020-08-26T17:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NzExOA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r476997118", "bodyText": "Theoretically I think we should handle single 'table' too? We can add TODO here.", "author": "kikkyo", "createdAt": "2020-08-26T02:36:24Z", "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -100,24 +107,43 @@ private String constructFullTableName(String projectId, String datasetId, String\n     return String.format(\"%s.%s.%s\", projectId, datasetId, tableName);\n   }\n \n-  private int findTheIndexOfIncorrectTable() {\n-    // The table in the error message is presented in the legacySQL mode, but this fixer is used to\n-    // fix the\n-    // standardSQL. Thus, the table name needs to be converted to the one consistent with\n-    // standardSQL.\n-    // The change is from project:dataset.table to project.dataset.table.\n-    String tableName = err.getTableName().replace(':', '.');\n-    int index = query.indexOf(tableName);\n-\n-    // Since the TableNotFound error has no position info, this method will convert the index to the\n-    // position and assign to the `err`.\n-    Position position = queryPositionConverter.indexToPos(index);\n-    this.err.setErrorPosition(position);\n-    return index;\n+  private SubstringView findSubstringViewOfIncorrectTable(TableId fullTableId) {\n+    String regex;\n+    // If the project ID is the default one, then the actual table may not include project ID,\n+    // which looks like \"dataset.table\".", "originalCommit": "4a1be982d047bceac1052b7487c83479f0cf4a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2OTk5NA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r477469994", "bodyText": "Yes, if a user specifies the default dataset in the input options. TODO is added.", "author": "mingen-pan", "createdAt": "2020-08-26T17:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NzExOA=="}], "type": "inlineReview"}, {"oid": "f5b27543d38fcf379ad209e40ed05ea5f11c8689", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f5b27543d38fcf379ad209e40ed05ea5f11c8689", "message": "Add todo", "committedDate": "2020-08-26T17:33:16Z", "type": "commit"}, {"oid": "1909ea5c30f8a2c9ca3e6daa4cf46ef5ed5cd311", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1909ea5c30f8a2c9ca3e6daa4cf46ef5ed5cd311", "message": "Merge branch 'master' into add_fixer", "committedDate": "2020-08-26T17:38:18Z", "type": "commit"}]}