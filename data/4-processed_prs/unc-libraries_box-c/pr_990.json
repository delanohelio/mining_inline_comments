{"pr_number": 990, "pr_title": "Add premis event to parent when child objects destroyed", "pr_createdAt": "2020-05-14T14:32:21Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/990", "timeline": [{"oid": "6a40c5962efa59886d2b0fd9d4f4050dbd57a5bc", "url": "https://github.com/UNC-Libraries/box-c/commit/6a40c5962efa59886d2b0fd9d4f4050dbd57a5bc", "message": "Add premis event to parent when child objects destroyed", "committedDate": "2020-05-14T15:47:56Z", "type": "commit"}, {"oid": "6a40c5962efa59886d2b0fd9d4f4050dbd57a5bc", "url": "https://github.com/UNC-Libraries/box-c/commit/6a40c5962efa59886d2b0fd9d4f4050dbd57a5bc", "message": "Add premis event to parent when child objects destroyed", "committedDate": "2020-05-14T15:47:56Z", "type": "forcePushed"}, {"oid": "a5b1e1846efa7926bc67d0da81e7a990cd668f5b", "url": "https://github.com/UNC-Libraries/box-c/commit/a5b1e1846efa7926bc67d0da81e7a990cd668f5b", "message": "Only write the deletion event on the parent of the root deletion", "committedDate": "2020-05-19T19:16:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MTg3OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428341878", "bodyText": "Recording of the root of the tree will need to be moved out of this method, having it here is resulting in each container being recorded and counted twice since they are also recorded in the loop of members below. For example, i got this event:\n                \"Objects destroyed: b10608f7-3aad-44d0-83a5-07e4a3b41844\\n3b66b013-b3c1-4bd7-a7eb-81ab30afc36b\\n3b66b013-b3c1-4bd7-a7eb-81ab30afc36b\\nc532a45c-647d-4425-a5e8-a8f11133e43e\\nc532a45c-647d-4425-a5e8-a8f11133e43e\\nbb8949d0-283b-47ee-82b5-a32346c97481\\nbb8949d0-283b-47ee-82b5-a32346c97481\" , \"7 object(s) were destroyed\" ;\n\nYou can see 3b66b013-b3c1-4bd7-a7eb-81ab30afc36b in the list multiple times, since its is both the root of a tree and a member", "author": "bbpennel", "createdAt": "2020-05-20T22:23:50Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -142,13 +155,21 @@ public void run() {\n \n     private void destroyTree(RepositoryObject rootOfTree) throws FedoraException, IOException,\n             FcrepoOperationFailedException {\n+        // Add the root of the tree to delete\n+        deletedObjCount += 1;", "originalCommit": "a5b1e1846efa7926bc67d0da81e7a990cd668f5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MjMzMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428342330", "bodyText": "Could you update DestroyObjectsJobIT to check for an event being added to the parent? You should be able to check that the right number of objects are destroyed at least", "author": "bbpennel", "createdAt": "2020-05-20T22:24:59Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -142,13 +155,21 @@ public void run() {\n \n     private void destroyTree(RepositoryObject rootOfTree) throws FedoraException, IOException,\n             FcrepoOperationFailedException {\n+        // Add the root of the tree to delete\n+        deletedObjCount += 1;\n+        deletedObjIds.add(rootOfTree.getPid().getUUID());\n+\n         if (rootOfTree instanceof ContentContainerObject) {\n             ContentContainerObject container = (ContentContainerObject) rootOfTree;\n             List<ContentObject> members = container.getMembers();\n             for (ContentObject member : members) {\n+                deletedObjIds.add(member.getPid().getUUID());", "originalCommit": "a5b1e1846efa7926bc67d0da81e7a990cd668f5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0Mjc3Mw==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428342773", "bodyText": "there should probably be a newline after the colon so that all the ids have their own line", "author": "bbpennel", "createdAt": "2020-05-20T22:25:49Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -125,8 +127,19 @@ public void run() {\n                 }\n \n                 if (!repoObj.getResource().hasProperty(RDF.type, Cdr.Tombstone)) {\n+                    RepositoryObject parentObj = repoObj.getParent();\n+\n                     // purge tree with repoObj as root from repository\n                     destroyTree(repoObj);\n+\n+                    // Add premis event to parent\n+                    parentObj.getPremisLog().buildEvent(Premis.Deletion)\n+                            .addAuthorizingAgent(agent.getUsername())\n+                            .addOutcome(true)\n+                            .addEventDetail(\"{0} object(s) were destroyed\", deletedObjCount)\n+                            .addEventDetail(\"Objects destroyed: {0}\",", "originalCommit": "a5b1e1846efa7926bc67d0da81e7a990cd668f5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "url": "https://github.com/UNC-Libraries/box-c/commit/c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "message": "Move root count out of loop and update tests.", "committedDate": "2020-05-21T13:59:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NTcyOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428845728", "bodyText": "Remove the space before {0} so that all of the entries have the same indentation.\nAlso, for the sake of consistency you should use System.getProperty(\"line.separator\") here too. You're welcome to it in a variable if you want to shorten things, etiher way is fine.", "author": "bbpennel", "createdAt": "2020-05-21T18:49:25Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -125,8 +127,23 @@ public void run() {\n                 }\n \n                 if (!repoObj.getResource().hasProperty(RDF.type, Cdr.Tombstone)) {\n+                    RepositoryObject parentObj = repoObj.getParent();\n+\n                     // purge tree with repoObj as root from repository\n+                    // Add the root of the tree to delete\n+                    deletedObjCount += 1;\n+                    deletedObjIds.add(repoObj.getPid().getUUID());\n+\n                     destroyTree(repoObj);\n+\n+                    // Add premis event to parent\n+                    parentObj.getPremisLog().buildEvent(Premis.Deletion)\n+                            .addAuthorizingAgent(agent.getUsername())\n+                            .addOutcome(true)\n+                            .addEventDetail(\"{0} object(s) were destroyed\", deletedObjCount)\n+                            .addEventDetail(\"Objects destroyed:\\n {0}\",", "originalCommit": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NjMxMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428846312", "bodyText": "missing space before last parameter", "author": "bbpennel", "createdAt": "2020-05-21T18:50:32Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJobIT.java", "diffHunk": "@@ -262,6 +271,11 @@ public void destroyFolderTest() {\n \n         job.run();\n \n+        RepositoryObject folderObjParent = folderObj.getParent();\n+        Model logParentModel = folderObjParent.getPremisLog().getEventsModel();\n+        assertTrue(logParentModel.contains(null, RDF.type, Premis.Deletion));\n+        assertTrue(logParentModel.contains(null, Premis.note,\"3 object(s) were destroyed\"));", "originalCommit": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NjQxMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428846413", "bodyText": "missing space", "author": "bbpennel", "createdAt": "2020-05-21T18:50:43Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJobIT.java", "diffHunk": "@@ -284,6 +298,10 @@ public void destroySingleObjectWithPreexistingPremisEventTest() {\n \n         job.run();\n \n+        Model logParentModel = fileObj.getParent().getPremisLog().getEventsModel();\n+        assertTrue(logParentModel.contains(null, RDF.type, Premis.Deletion));\n+        assertTrue(logParentModel.contains(null, Premis.note,\"1 object(s) were destroyed\"));", "originalCommit": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NjczMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428846732", "bodyText": "should just be new ArrayList<>();", "author": "bbpennel", "createdAt": "2020-05-21T18:51:19Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -87,6 +87,8 @@\n     private static final Timer timer = TimerFactory.createTimerForClass(DestroyObjectsJob.class);\n \n     private List<PID> objsToDestroy;\n+    private int deletedObjCount = 0;\n+    private List<String> deletedObjIds = new ArrayList<String>();", "originalCommit": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0NzE5MA==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428847190", "bodyText": "i think you can remove this variable and just call deletedObjIds.size()", "author": "bbpennel", "createdAt": "2020-05-21T18:52:09Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -87,6 +87,8 @@\n     private static final Timer timer = TimerFactory.createTimerForClass(DestroyObjectsJob.class);\n \n     private List<PID> objsToDestroy;\n+    private int deletedObjCount = 0;", "originalCommit": "c8ad0bfd637e77eac0ea1e43e83298c9a4a5917a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0586935b1942fb558d91ecfb336261ec9b2cf15c", "url": "https://github.com/UNC-Libraries/box-c/commit/0586935b1942fb558d91ecfb336261ec9b2cf15c", "message": "minor spacing and syntax updates", "committedDate": "2020-05-21T19:09:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4MTAxMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428881012", "bodyText": "its still putting a space in front of the first entry but not the following ones. You can just remove the leading space here", "author": "bbpennel", "createdAt": "2020-05-21T19:58:31Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -137,12 +137,13 @@ public void run() {\n                     destroyTree(repoObj);\n \n                     // Add premis event to parent\n+                    String lineSeparator = System.getProperty(\"line.separator\");\n                     parentObj.getPremisLog().buildEvent(Premis.Deletion)\n                             .addAuthorizingAgent(agent.getUsername())\n                             .addOutcome(true)\n                             .addEventDetail(\"{0} object(s) were destroyed\", deletedObjCount)\n-                            .addEventDetail(\"Objects destroyed:\\n {0}\",\n-                                    String.join(System.getProperty(\"line.separator\"), deletedObjIds))\n+                            .addEventDetail(\"Objects destroyed:\" + lineSeparator\n+                                            + \" {0}\", String.join(lineSeparator, deletedObjIds))", "originalCommit": "0586935b1942fb558d91ecfb336261ec9b2cf15c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4MTYwNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/990#discussion_r428881604", "bodyText": "sorry, this isn't quite what i meant. You should be able to delete this variable and all the places it gets incremented, and then when you generate the premis event call deletedObjIds.size() to get the number of ids", "author": "bbpennel", "createdAt": "2020-05-21T19:59:41Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -87,8 +87,8 @@\n     private static final Timer timer = TimerFactory.createTimerForClass(DestroyObjectsJob.class);\n \n     private List<PID> objsToDestroy;\n-    private int deletedObjCount = 0;\n-    private List<String> deletedObjIds = new ArrayList<String>();\n+    private List<String> deletedObjIds = new ArrayList<>();\n+    private int deletedObjCount = deletedObjIds.size();", "originalCommit": "0586935b1942fb558d91ecfb336261ec9b2cf15c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5f7313b7b2ab1c2d7e1db2b73e9c6ecfd3f77700", "url": "https://github.com/UNC-Libraries/box-c/commit/5f7313b7b2ab1c2d7e1db2b73e9c6ecfd3f77700", "message": "Remove unneeded variable", "committedDate": "2020-05-21T20:06:49Z", "type": "commit"}]}