{"pr_number": 993, "pr_title": "Add premis event if an object is moved between admin units", "pr_createdAt": "2020-05-19T13:52:28Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/993", "timeline": [{"oid": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "url": "https://github.com/UNC-Libraries/box-c/commit/3268e4ff99a383bb02c26aba71902e50f92e33d1", "message": "Add premis event if an object is moved between admin units", "committedDate": "2020-05-19T16:06:58Z", "type": "commit"}, {"oid": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "url": "https://github.com/UNC-Libraries/box-c/commit/3268e4ff99a383bb02c26aba71902e50f92e33d1", "message": "Add premis event if an object is moved between admin units", "committedDate": "2020-05-19T16:06:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNzQxOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428637418", "bodyText": "use objPath here instead of calling getEntries again", "author": "bbpennel", "createdAt": "2020-05-21T13:03:12Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +144,52 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid) {\n+        ObjectPath destPath = objectPathFactory.getPath(destinationPid);\n+        String destAdminUnit = null;\n+        if (destPath != null) {\n+            List<ObjectPathEntry> destObjPath = destPath.getEntries();\n+            if (destObjPath.size() > 1) {\n+                destAdminUnit = destObjPath.get(1).getPid();\n+            }\n+        }\n+\n+        ObjectPath sourcePath = objectPathFactory.getPath(sourcePid);\n+        String currentAdminUnit = null;\n+        if (sourcePath != null) {\n+            List<ObjectPathEntry> objPath = sourcePath.getEntries();\n+            if (objPath.size() > 1) {\n+                currentAdminUnit = sourcePath.getEntries().get(1).getPid();", "originalCommit": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0NTI2NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428645265", "bodyText": "I would suggest holding onto the ObjectPath and/or ObjectPathEntry objects for the source and destination. They have getName() methods which you can use to get the title of the object as it is stored in solr. Unlike the property in fedora, if MODs were present then it'd give us back the MODS title, which seems desirable.\nThe ObjectPath entries can also give you back the title and id of the parent, it should be either the last or second to last entry in the path.", "author": "bbpennel", "createdAt": "2020-05-21T13:18:36Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +144,52 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid) {\n+        ObjectPath destPath = objectPathFactory.getPath(destinationPid);\n+        String destAdminUnit = null;\n+        if (destPath != null) {\n+            List<ObjectPathEntry> destObjPath = destPath.getEntries();\n+            if (destObjPath.size() > 1) {\n+                destAdminUnit = destObjPath.get(1).getPid();\n+            }\n+        }\n+\n+        ObjectPath sourcePath = objectPathFactory.getPath(sourcePid);\n+        String currentAdminUnit = null;\n+        if (sourcePath != null) {\n+            List<ObjectPathEntry> objPath = sourcePath.getEntries();\n+            if (objPath.size() > 1) {\n+                currentAdminUnit = sourcePath.getEntries().get(1).getPid();\n+            }\n+        }\n+\n+        if (currentAdminUnit != null && destAdminUnit != null && !currentAdminUnit.equals(destAdminUnit)) {\n+            RepositoryObject currentObj = repositoryObjectLoader.getRepositoryObject(sourcePid);\n+            RepositoryObject parent = currentObj.getParent();", "originalCommit": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0NjgxNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428646814", "bodyText": "I'd suggest passing the already retrieved moveContent object into adminUnitMove instead of (or in addition to) the sourcePid. Then you could save the steps below of re-retrieving it", "author": "bbpennel", "createdAt": "2020-05-21T13:21:26Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +144,52 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid) {", "originalCommit": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY3MTU5MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428671591", "bodyText": "Based off the discussion with anna, lets go with the following text:\nObject moved from source \"<src title>\" (<src id>) in Admin Unit \"<src unit title>\" (<src unit id>) to destination \"<dest title>\" (<dest id>) in Admin Unit \"<dest unit title>\" (<dest unit id>)", "author": "bbpennel", "createdAt": "2020-05-21T14:03:42Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +144,52 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid) {\n+        ObjectPath destPath = objectPathFactory.getPath(destinationPid);\n+        String destAdminUnit = null;\n+        if (destPath != null) {\n+            List<ObjectPathEntry> destObjPath = destPath.getEntries();\n+            if (destObjPath.size() > 1) {\n+                destAdminUnit = destObjPath.get(1).getPid();\n+            }\n+        }\n+\n+        ObjectPath sourcePath = objectPathFactory.getPath(sourcePid);\n+        String currentAdminUnit = null;\n+        if (sourcePath != null) {\n+            List<ObjectPathEntry> objPath = sourcePath.getEntries();\n+            if (objPath.size() > 1) {\n+                currentAdminUnit = sourcePath.getEntries().get(1).getPid();\n+            }\n+        }\n+\n+        if (currentAdminUnit != null && destAdminUnit != null && !currentAdminUnit.equals(destAdminUnit)) {\n+            RepositoryObject currentObj = repositoryObjectLoader.getRepositoryObject(sourcePid);\n+            RepositoryObject parent = currentObj.getParent();\n+            String prevContainerTitle = parent.getResource()\n+                    .getProperty(DcElements.title).getObject().toString();\n+\n+            String newContainerUUID = destinationPid.getUUID();\n+            String newContainerTitle = destContainer.getResource()\n+                    .getProperty(DcElements.title).getObject().toString();\n+\n+            currentObj.getPremisLog().buildEvent(Premis.MetadataModification)\n+                    .addAuthorizingAgent(agent.getUsername())\n+                    .addEventDetail(\"Object moved from parent object {0}, \" +\n+                                    \"{1} in Admin Unit {2} to {3}, {4} in Admin Unit {5}\",", "originalCommit": "3268e4ff99a383bb02c26aba71902e50f92e33d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "url": "https://github.com/UNC-Libraries/box-c/commit/9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "message": "Get title and uuid from entry list", "committedDate": "2020-05-21T18:15:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MTc1MQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428891751", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    HashMap<String, String> entryValues = new HashMap<String, String>();\n          \n          \n            \n                    Map<String, String> entryValues = new HashMap<>();", "author": "bbpennel", "createdAt": "2020-05-21T20:20:17Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +143,63 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid, moveContent);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid, ContentObject moveObj) {\n+        HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n+        String destAdminUnit = destContainerInfo.get(\"adminUnit\");\n+\n+        HashMap<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);\n+        String currentAdminUnit = currentContainerInfo.get(\"adminUnit\");\n+\n+        if (currentAdminUnit != null && destAdminUnit != null && !currentAdminUnit.equals(destAdminUnit)) {\n+            moveObj.getPremisLog().buildEvent(Premis.MetadataModification)\n+                    .addAuthorizingAgent(agent.getUsername())\n+                    .addEventDetail(\"Object moved from source {0} ({1}) in Admin Unit {2} ({3}) \" +\n+                                    \"to destination {4} ({5}) in Admin Unit {6} ({7})\",\n+                            currentContainerInfo.get(\"container\"), currentContainerInfo.get(\"containerTitle\"),\n+                            currentAdminUnit, currentContainerInfo.get(\"adminUnitTitle\"),\n+                            destContainerInfo.get(\"container\"), destContainerInfo.get(\"containerTitle\"),\n+                            destAdminUnit, destContainerInfo.get(\"adminUnitTitle\"))\n+                    .writeAndClose();\n+        }\n+    }\n+\n+    private HashMap<String, String> getContainerInfo(PID pid, int entry) {\n+        ObjectPath objPath = objectPathFactory.getPath(pid);\n+\n+        String objAdminUnit = null;\n+        String objAdminUnitTitle = \"\";\n+        String objContainer = \"\";\n+        String objContainerTitle = \"\";\n+\n+        if (objPath != null) {\n+            List<ObjectPathEntry> objPathList = objPath.getEntries();\n+            if (objPathList.size() > 1) {\n+                ObjectPathEntry destEntry = objPathList.get(1);\n+                objAdminUnit = destEntry.getPid();\n+                objAdminUnitTitle = destEntry.getName();\n+\n+                ObjectPathEntry objContainerEntry = objPathList.get(objPathList.size() - entry);\n+                objContainer = objContainerEntry.getPid();\n+                objContainerTitle = objContainerEntry.getName();\n+            }\n+        }\n+\n+        HashMap<String, String> entryValues = new HashMap<String, String>();", "originalCommit": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MjYzNQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428892635", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n          \n          \n            \n                    Map<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n          \n      \n    \n    \n  \n\nUse interface rather than implementation", "author": "bbpennel", "createdAt": "2020-05-21T20:22:06Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +143,63 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid, moveContent);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid, ContentObject moveObj) {\n+        HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);", "originalCommit": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MjcwMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428892702", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    HashMap<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);\n          \n          \n            \n                    Map<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);", "author": "bbpennel", "createdAt": "2020-05-21T20:22:15Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +143,63 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid, moveContent);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid, ContentObject moveObj) {\n+        HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n+        String destAdminUnit = destContainerInfo.get(\"adminUnit\");\n+\n+        HashMap<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);", "originalCommit": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MzI2Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428893267", "bodyText": "Please add quotes around the titles for clarity", "author": "bbpennel", "createdAt": "2020-05-21T20:23:24Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +143,63 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid, moveContent);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid, ContentObject moveObj) {\n+        HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n+        String destAdminUnit = destContainerInfo.get(\"adminUnit\");\n+\n+        HashMap<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);\n+        String currentAdminUnit = currentContainerInfo.get(\"adminUnit\");\n+\n+        if (currentAdminUnit != null && destAdminUnit != null && !currentAdminUnit.equals(destAdminUnit)) {\n+            moveObj.getPremisLog().buildEvent(Premis.MetadataModification)\n+                    .addAuthorizingAgent(agent.getUsername())\n+                    .addEventDetail(\"Object moved from source {0} ({1}) in Admin Unit {2} ({3}) \" +", "originalCommit": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NTEyOA==", "url": "https://github.com/UNC-Libraries/box-c/pull/993#discussion_r428895128", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private HashMap<String, String> getContainerInfo(PID pid, int entry) {\n          \n          \n            \n                private Map<String, String> getContainerInfo(PID pid, int entry) {\n          \n      \n    \n    \n  \n\nAlso, could you add javadoc to this? Particularly it'd be helpful to describe what entry is since its a bit tricky that its actually counting backwards", "author": "bbpennel", "createdAt": "2020-05-21T20:26:52Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/move/MoveObjectsJob.java", "diffHunk": "@@ -141,10 +143,63 @@ private void moveObject(PID objPid) {\n         PID sourcePid = moveContent.getParent().getPid();\n         addPidToSource(objPid, sourcePid);\n \n+        // Write a premis event if object moves between admin units\n+        adminUnitMove(objPid, moveContent);\n+\n         // Add the object to its destination, which clears the previous parent as well\n         destContainer.addMember(moveContent);\n     }\n \n+    private void adminUnitMove(PID sourcePid, ContentObject moveObj) {\n+        HashMap<String, String> destContainerInfo = getContainerInfo(destinationPid, 1);\n+        String destAdminUnit = destContainerInfo.get(\"adminUnit\");\n+\n+        HashMap<String, String> currentContainerInfo = getContainerInfo(sourcePid, 2);\n+        String currentAdminUnit = currentContainerInfo.get(\"adminUnit\");\n+\n+        if (currentAdminUnit != null && destAdminUnit != null && !currentAdminUnit.equals(destAdminUnit)) {\n+            moveObj.getPremisLog().buildEvent(Premis.MetadataModification)\n+                    .addAuthorizingAgent(agent.getUsername())\n+                    .addEventDetail(\"Object moved from source {0} ({1}) in Admin Unit {2} ({3}) \" +\n+                                    \"to destination {4} ({5}) in Admin Unit {6} ({7})\",\n+                            currentContainerInfo.get(\"container\"), currentContainerInfo.get(\"containerTitle\"),\n+                            currentAdminUnit, currentContainerInfo.get(\"adminUnitTitle\"),\n+                            destContainerInfo.get(\"container\"), destContainerInfo.get(\"containerTitle\"),\n+                            destAdminUnit, destContainerInfo.get(\"adminUnitTitle\"))\n+                    .writeAndClose();\n+        }\n+    }\n+\n+    private HashMap<String, String> getContainerInfo(PID pid, int entry) {", "originalCommit": "9eb1e47ee4d02a2f773937a6a6b912000423dcd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "644e29f18007d9b8fb6d8a649f004316db0bb34d", "url": "https://github.com/UNC-Libraries/box-c/commit/644e29f18007d9b8fb6d8a649f004316db0bb34d", "message": "Switch to Map and add documentation", "committedDate": "2020-05-22T12:18:55Z", "type": "commit"}]}