{"pr_number": 1032, "pr_title": "Add retry if work object ingest gives a checksum mismatch", "pr_createdAt": "2020-06-30T18:45:38Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1032", "timeline": [{"oid": "2c3fcc396ddc938527fd3572d95d7fdae4714300", "url": "https://github.com/UNC-Libraries/box-c/commit/2c3fcc396ddc938527fd3572d95d7fdae4714300", "message": "Add retry if work object ingest gives a checksum mismatch", "committedDate": "2020-06-30T18:50:14Z", "type": "commit"}, {"oid": "2c3fcc396ddc938527fd3572d95d7fdae4714300", "url": "https://github.com/UNC-Libraries/box-c/commit/2c3fcc396ddc938527fd3572d95d7fdae4714300", "message": "Add retry if work object ingest gives a checksum mismatch", "committedDate": "2020-06-30T18:50:14Z", "type": "forcePushed"}, {"oid": "f2d310eb0e654e80722f8311f8d03020aefd7d5e", "url": "https://github.com/UNC-Libraries/box-c/commit/f2d310eb0e654e80722f8311f8d03020aefd7d5e", "message": "Move retry to IngestWork method", "committedDate": "2020-06-30T19:48:13Z", "type": "commit"}, {"oid": "79ee7dadf60673869525854b4b36e5e8da3b486a", "url": "https://github.com/UNC-Libraries/box-c/commit/79ee7dadf60673869525854b4b36e5e8da3b486a", "message": "Cancel transaction before retrying", "committedDate": "2020-07-01T15:07:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4NDk4NA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448484984", "bodyText": "what about overriding the method signature to private void ingestWork(ContentContainerObject parent, Resource parentResc, Resource childResc, int retries) and the same thing without retries. Most stuff would call the version without retries, which would supply the starting number of retries at 3.\nThen you should be able to do something like:\n} catch (ChecksumMismatchException e) {\n     // Rollback changes for the work so far\n     txRefresher.interrupt();\n     tx.cancel();\n     if (retries > 0) {\n         retries--;\n         ingestWork(parent, parentResc, childResc, retries);\n     } else {\n         failJob(...);\n     }\n\nI think if a work had more than one file and failed partway through, it would try to reingest those other files and run into a conflict since they'd already exist.", "author": "bbpennel", "createdAt": "2020-07-01T16:36:20Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,28 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {", "originalCommit": "79ee7dadf60673869525854b4b36e5e8da3b486a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9c001893ddcd2d69212945c775a8dd6bba4ebbf2", "url": "https://github.com/UNC-Libraries/box-c/commit/9c001893ddcd2d69212945c775a8dd6bba4ebbf2", "message": "Add retries as a method parameter", "committedDate": "2020-07-01T17:02:24Z", "type": "commit"}, {"oid": "174b3dc7400c8288090428873f930710fde2c5de", "url": "https://github.com/UNC-Libraries/box-c/commit/174b3dc7400c8288090428873f930710fde2c5de", "message": "Cancel transaction", "committedDate": "2020-07-01T19:14:07Z", "type": "commit"}, {"oid": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d", "url": "https://github.com/UNC-Libraries/box-c/commit/4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d", "message": "Update expected error", "committedDate": "2020-07-01T19:45:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MTg3OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448971879", "bodyText": "Could you add a warn level message stating that there was a checksum mismatch, probably include the message from the error? So that we see if this issue is occurring", "author": "bbpennel", "createdAt": "2020-07-02T12:41:21Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,16 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {\n+                txRefresher.interrupt();\n+                tx.cancelAndIgnore();\n+\n+                if (retries > 0) {\n+                    retries--;\n+                    ingestWork(parent, parentResc, childResc, retries);", "originalCommit": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da8d857fab40e331bc321f59d08278c8a6c7f55e", "url": "https://github.com/UNC-Libraries/box-c/commit/da8d857fab40e331bc321f59d08278c8a6c7f55e", "message": "Add log warning if retrying ingest due to a checksum mismatch.", "committedDate": "2020-07-02T15:18:05Z", "type": "commit"}, {"oid": "da8d857fab40e331bc321f59d08278c8a6c7f55e", "url": "https://github.com/UNC-Libraries/box-c/commit/da8d857fab40e331bc321f59d08278c8a6c7f55e", "message": "Add log warning if retrying ingest due to a checksum mismatch.", "committedDate": "2020-07-02T15:18:05Z", "type": "forcePushed"}]}