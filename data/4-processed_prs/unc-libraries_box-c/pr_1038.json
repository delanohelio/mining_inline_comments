{"pr_number": 1038, "pr_title": "Update deposited count after adding children", "pr_createdAt": "2020-07-06T18:58:21Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/1038", "timeline": [{"oid": "95a5d8a3870b9c72923a0307e2dc43cee45b241d", "url": "https://github.com/UNC-Libraries/box-c/commit/95a5d8a3870b9c72923a0307e2dc43cee45b241d", "message": "Update deposited count after adding children, so as not to give a false count if a child ingest fails", "committedDate": "2020-07-06T18:56:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1ODIzNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r450858234", "bodyText": "We probably need to do this for other object types too? Would it make sense to do this at the same time incrIngestedObjects happens below?", "author": "bbpennel", "createdAt": "2020-07-07T13:20:49Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -629,6 +626,9 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 overrideModifiedTimestamp(obj, childResc);\n \n+                // Increment the count of objects deposited after adding children\n+                addClicks(1);", "originalCommit": "95a5d8a3870b9c72923a0307e2dc43cee45b241d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0839e30f42bcb0682482490485c9cb85b7e32f1a", "url": "https://github.com/UNC-Libraries/box-c/commit/0839e30f42bcb0682482490485c9cb85b7e32f1a", "message": "Move where update count for redis happens", "committedDate": "2020-07-07T14:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MTY2Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451071667", "bodyText": "hmm, I don't think these calls needed to be moved into the block, since I believe the try blocks would always either succeed or throw an error. I was actually thinking the opposite, moving addClicks out of the try block. Its probably fine either way as long as nothing happens inside of a transaction after the increments.", "author": "bbpennel", "createdAt": "2020-07-07T18:46:49Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -441,15 +441,14 @@ private void ingestFolder(ContentContainerObject parent, Resource parentResc, Re\n \n                 // Increment the count of objects deposited prior to adding children\n                 addClicks(1);\n+                getDepositStatusFactory().incrIngestedObjects(getDepositUUID(), 1);", "originalCommit": "0839e30f42bcb0682482490485c9cb85b7e32f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MTEyMw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451081123", "bodyText": "Looking at the stuff that happens after \"ingestChildren\" calls in most of these methods, it seems like some of that stuff should not be happening during resume if all the children finished (adding events particularly). That doesn't need to be part of this ticket though.", "author": "bbpennel", "createdAt": "2020-07-07T19:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MTY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc0NjYzMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451746630", "bodyText": "I've created a followup ticket for skipping the ingestChildren and stuff after it during resume https://jira.lib.unc.edu/browse/BXC-2730", "author": "bbpennel", "createdAt": "2020-07-08T18:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MTY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MzcwMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451083701", "bodyText": "I think ingestFileObject could still be problematic since its happening inside of the transaction for a work. If it fails after a few files the count would be off. Handling this might be a bit tricky, you might have to keep a running count of the number of file objects added rather than committing to redis immediately, and then include that count in the addClicks and incrIngestedObjects when the transaction ends for the work object. It'd definitely be good to have a test to ensure the counts come out right in a failure case. Is there an existing test that might be used for this?", "author": "bbpennel", "createdAt": "2020-07-07T19:09:59Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -441,15 +441,14 @@ private void ingestFolder(ContentContainerObject parent, Resource parentResc, Re\n ", "originalCommit": "0839e30f42bcb0682482490485c9cb85b7e32f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNjE3Mg==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451126172", "bodyText": "Wouldn't this cover that case?\nif (skipResumed(childResc)) {\n     return;\n}\nThere is this test https://github.com/UNC-Libraries/Carolina-Digital-Repository/blob/fcrepo4/deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobIT.java#L444. Maybe something like it would work?", "author": "lfarrell", "createdAt": "2020-07-07T20:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczOTM1Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r451739357", "bodyText": "If the work transaction got rolled back, then the file wouldn't be in fedora, so we'd need to reingest the object. skipResumed is checking against objects in fedora, so it wouldn't prevent the fileObject from getting ingested and the counter from getting incremented.\nI don't see a test that verifies resuming a work deposit with multiple files partway through, but you could make a new test from the one you linked, adding 2 or 3 files to the work and having it fail on one of the files, then fix the error and re-run it, then make sure the count is correct", "author": "bbpennel", "createdAt": "2020-07-08T18:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MzcwMQ=="}], "type": "inlineReview"}, {"oid": "40a45426e6bb923f45b3c36f51b5a002dda65583", "url": "https://github.com/UNC-Libraries/box-c/commit/40a45426e6bb923f45b3c36f51b5a002dda65583", "message": "Move counters out of try/catch blocks", "committedDate": "2020-07-08T12:22:33Z", "type": "commit"}, {"oid": "6f680ac60b8a4b4ec627fc36b8f3aeee331c012f", "url": "https://github.com/UNC-Libraries/box-c/commit/6f680ac60b8a4b4ec627fc36b8f3aeee331c012f", "message": "Add files added to a work as a batch count.", "committedDate": "2020-07-09T13:30:51Z", "type": "commit"}, {"oid": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "url": "https://github.com/UNC-Libraries/box-c/commit/f196a2646fdc87ef85b1ca6556990b1501abf63c", "message": "Update tests as file count no longer increments on each file ingested.", "committedDate": "2020-07-09T16:02:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2NzcyNQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452367725", "bodyText": "could you rename this to something like filesIngestInWork and/or add a comment explaining that it is tracking the file count within one work, not across the whole deposit? Just seems worth clarifying since its a class level variable", "author": "bbpennel", "createdAt": "2020-07-09T17:11:02Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -153,6 +153,8 @@\n \n     private boolean overrideTimestamps;\n \n+    private int filesIngested = 0;", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MDg4Nw==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452370887", "bodyText": "Wrap these two calls in an if (filesIngested > 0) block in case there were no files.", "author": "bbpennel", "createdAt": "2020-07-09T17:16:40Z", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -629,6 +620,10 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 overrideModifiedTimestamp(obj, childResc);\n \n+                // Add counts for files deposited for the work", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MjYwMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452372602", "bodyText": "there should only be one primaryObject per work (that's enforced elsewhere). Also, you don't need the .asResource() part", "author": "bbpennel", "createdAt": "2020-07-09T17:19:34Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobIT.java", "diffHunk": "@@ -476,6 +476,50 @@ public void resumeCompletedWorkIngestTest() throws Exception {\n         ingestedObjectsCount(3);\n     }\n \n+    @Test\n+    public void ingestWorkObjectObjCountWithRetry() throws Exception {\n+        String label = \"testwork\";\n+        PID workPid = pidMinter.mintContentPid();\n+\n+        // Construct the deposit model with work object\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        // Constructing the work in the deposit model with a label\n+        Bag workBag = model.createBag(workPid.getRepositoryPath());\n+        workBag.addProperty(RDF.type, Cdr.Work);\n+        workBag.addProperty(CdrDeposit.label, label);\n+\n+        PID mainPid = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, FILE1_SHA1, FILE1_MD5);\n+        PID mainPid2 = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, null, FILE1_MD5_BAD);\n+\n+        depBag.add(workBag);\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,\n+                model.getResource(mainPid.getRepositoryPath()));\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MzE4NA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452373184", "bodyText": "space after =", "author": "bbpennel", "createdAt": "2020-07-09T17:20:33Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobIT.java", "diffHunk": "@@ -476,6 +476,50 @@ public void resumeCompletedWorkIngestTest() throws Exception {\n         ingestedObjectsCount(3);\n     }\n \n+    @Test\n+    public void ingestWorkObjectObjCountWithRetry() throws Exception {\n+        String label = \"testwork\";\n+        PID workPid = pidMinter.mintContentPid();\n+\n+        // Construct the deposit model with work object\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        // Constructing the work in the deposit model with a label\n+        Bag workBag = model.createBag(workPid.getRepositoryPath());\n+        workBag.addProperty(RDF.type, Cdr.Work);\n+        workBag.addProperty(CdrDeposit.label, label);\n+\n+        PID mainPid = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, FILE1_SHA1, FILE1_MD5);\n+        PID mainPid2 = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, null, FILE1_MD5_BAD);\n+\n+        depBag.add(workBag);\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,\n+                model.getResource(mainPid.getRepositoryPath()));\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,\n+                model.getResource(mainPid2.getRepositoryPath()));\n+\n+        job.closeModel();\n+\n+        try {\n+            job.run();\n+            fail(\"Test should not reach this line. Job should have thrown exception\");\n+        } catch (JobFailedException e) {\n+            Map<String, String> jobStatus = jobStatusFactory.get(jobUUID);\n+            assertNull(jobStatus.get(JobField.num.name()));\n+            Resource fileResc =job.getWritableModel().getResource(mainPid2.getRepositoryPath());", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3NDI3OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452374278", "bodyText": "You also need to remove the bad md5sum property, otherwise the test might flap since there will be two md5sums and it might randomly pick the bad one.", "author": "bbpennel", "createdAt": "2020-07-09T17:22:23Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobIT.java", "diffHunk": "@@ -476,6 +476,50 @@ public void resumeCompletedWorkIngestTest() throws Exception {\n         ingestedObjectsCount(3);\n     }\n \n+    @Test\n+    public void ingestWorkObjectObjCountWithRetry() throws Exception {\n+        String label = \"testwork\";\n+        PID workPid = pidMinter.mintContentPid();\n+\n+        // Construct the deposit model with work object\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        // Constructing the work in the deposit model with a label\n+        Bag workBag = model.createBag(workPid.getRepositoryPath());\n+        workBag.addProperty(RDF.type, Cdr.Work);\n+        workBag.addProperty(CdrDeposit.label, label);\n+\n+        PID mainPid = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, FILE1_SHA1, FILE1_MD5);\n+        PID mainPid2 = addFileObject(workBag, FILE1_LOC, FILE1_MIMETYPE, null, FILE1_MD5_BAD);\n+\n+        depBag.add(workBag);\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,\n+                model.getResource(mainPid.getRepositoryPath()));\n+\n+        workBag.asResource().addProperty(Cdr.primaryObject,\n+                model.getResource(mainPid2.getRepositoryPath()));\n+\n+        job.closeModel();\n+\n+        try {\n+            job.run();\n+            fail(\"Test should not reach this line. Job should have thrown exception\");\n+        } catch (JobFailedException e) {\n+            Map<String, String> jobStatus = jobStatusFactory.get(jobUUID);\n+            assertNull(jobStatus.get(JobField.num.name()));\n+            Resource fileResc =job.getWritableModel().getResource(mainPid2.getRepositoryPath());\n+            fileResc.addProperty(CdrDeposit.md5sum, FILE1_MD5);", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3NTQyMQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452375421", "bodyText": "it should also be called one time with a value of 1", "author": "bbpennel", "createdAt": "2020-07-09T17:24:31Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobTest.java", "diffHunk": "@@ -307,7 +307,7 @@ public void ingestWorkObjectTest() throws Exception {\n                 eq(supMime), anyString(), anyString(), any(Model.class));\n         verify(work).setPrimaryObject(mainPid);\n \n-        verify(jobStatusFactory, times(3)).incrCompletion(eq(jobUUID), eq(1));\n+        verify(jobStatusFactory, times(1)).incrCompletion(eq(jobUUID), eq(2));", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3NjIwNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452376204", "bodyText": "incrCompletion is still getting called, isn't it? Just not with the value 1", "author": "bbpennel", "createdAt": "2020-07-09T17:25:56Z", "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobTest.java", "diffHunk": "@@ -434,7 +434,7 @@ public void resumeIngestWorkObjectTest() throws Exception {\n         verify(work).setPrimaryObject(mainPid);\n \n         verify(jobStatusFactory).setCompletion(eq(jobUUID), eq(2));\n-        verify(jobStatusFactory).incrCompletion(eq(jobUUID), eq(1));\n+        verify(jobStatusFactory, never()).incrCompletion(eq(jobUUID), eq(1));", "originalCommit": "f196a2646fdc87ef85b1ca6556990b1501abf63c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5NzU5Ng==", "url": "https://github.com/UNC-Libraries/box-c/pull/1038#discussion_r452397596", "bodyText": "No, but it looks like setTotalCompletion() is being set", "author": "lfarrell", "createdAt": "2020-07-09T18:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3NjIwNA=="}], "type": "inlineReview"}, {"oid": "a0e9d1c07a3894c54ccf1087b52a13ed26571f2e", "url": "https://github.com/UNC-Libraries/box-c/commit/a0e9d1c07a3894c54ccf1087b52a13ed26571f2e", "message": "Update tests and rename class variable", "committedDate": "2020-07-09T18:06:49Z", "type": "commit"}]}