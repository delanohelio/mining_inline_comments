{"pr_number": 4046, "pr_title": " PLFM-6211: allow Docker client to use an access token instead of a password", "pr_createdAt": "2020-05-14T14:25:31Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046", "timeline": [{"oid": "0a89cbae3018b559730cb7a840cb04303e37da50", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0a89cbae3018b559730cb7a840cb04303e37da50", "message": "PLFM-6211 Docker client can authenticate with access token", "committedDate": "2020-04-29T21:04:56Z", "type": "commit"}, {"oid": "b0963c0e612d4a74888be84b110bc5ddb376bb21", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b0963c0e612d4a74888be84b110bc5ddb376bb21", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into PLFM-6211", "committedDate": "2020-05-04T22:58:33Z", "type": "commit"}, {"oid": "622a20cf89dad0a1eadcc330d2380dcf73b0c709", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/622a20cf89dad0a1eadcc330d2380dcf73b0c709", "message": "PLFM-6211: allow Docker client to use an access token instead of a password", "committedDate": "2020-05-14T14:24:03Z", "type": "commit"}, {"oid": "f36659a5a45fbfdff514f125ff39a0f330502d92", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f36659a5a45fbfdff514f125ff39a0f330502d92", "message": "PLFM-6211: allow Docker client to use an access token instead of a password", "committedDate": "2020-05-14T14:50:48Z", "type": "commit"}, {"oid": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "message": "PLFM-6211: allow Docker client to use an access token instead of a password", "committedDate": "2020-05-14T14:56:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3NzM5MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r426077390", "bodyText": "We might want to modify the abstract method to return some sort of object that could be used as a signal in the subsequent step that there is a different type of \"credentials\".", "author": "marcomarasca", "createdAt": "2020-05-15T22:44:32Z", "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/DockerClientAuthFilter.java", "diffHunk": "@@ -56,43 +62,58 @@ protected boolean reportBadCredentialsMetric() {\n \n \t@Override\n \tprotected boolean validCredentials(UserNameAndPassword credentials) {", "originalCommit": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3ODQxMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r426078410", "bodyText": "Consider introducing a dedicated filter for the term of use check that comes after all the authentication filters and could be applied to any endpoint regardless.", "author": "marcomarasca", "createdAt": "2020-05-15T22:48:27Z", "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/DockerClientAuthFilter.java", "diffHunk": "@@ -56,43 +62,58 @@ protected boolean reportBadCredentialsMetric() {\n \n \t@Override\n \tprotected boolean validCredentials(UserNameAndPassword credentials) {\n-\t\tLoginRequest credential = new LoginRequest();\n-\t\t\n-\t\tcredential.setUsername(credentials.getUserName());\n-\t\tcredential.setPassword(credentials.getPassword());\n-\t\t\n \t\ttry {\n-\t\t\tauthenticationService.login(credential);\n-\t\t} catch (UnauthenticatedException e) {\n-\t\t\treturn false;\n+\t\t\t// is the password actually an access token?\n+\t\t\toidcManager.getUserId(credentials.getPassword());\n+\t\t\treturn true;\n+\t\t} catch (IllegalArgumentException iae) {\n+\t\t\t// the password is NOT a (valid) access token,\n+\t\t\t// but maybe it's a password\n+\t\t\tLoginRequest credential = new LoginRequest();\n+\t\t\t\n+\t\t\tcredential.setUsername(credentials.getUserName());\n+\t\t\tcredential.setPassword(credentials.getPassword());\n+\t\t\t\n+\t\t\ttry {\n+\t\t\t\tauthenticationService.login(credential);\n+\t\t\t\treturn true;\n+\t\t\t} catch (UnauthenticatedException e) {\n+\t\t\t\treturn false;\n+\t\t\t}\n \t\t}\n-\t\t\n-\t\treturn true;\n-\n \t}\n \t\n \t@Override\n \tprotected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain, UserNameAndPassword credentials) throws ServletException, IOException {\n \t\t\n \t\tLong userId = BOOTSTRAP_PRINCIPAL.ANONYMOUS_USER.getPrincipalId();\n \t\t\n+\t\tMap<String, String[]> modHeaders = HttpAuthUtil.filterAuthorizationHeaders(request);\n+\t\t\n \t\tif (credentials != null) {\n+\t\t\tString accessToken = null;\n \t\t\ttry {\n-\t\t\t\tString username = credentials.getUserName();\n-\t\t\t\tPrincipalAlias alias = authenticationService.lookupUserForAuthentication(username);\n-\t\t\t\tuserId = alias.getPrincipalId();\n-\t\t\t} catch (NotFoundException e) {\n-\t\t\t\trejectRequest(response, getInvalidCredentialsMessage());\n+\t\t\t\t// is the password actually an access token?\n+\t\t\t\taccessToken = credentials.getPassword();\n+\t\t\t\tuserId = Long.parseLong(oidcManager.getUserId(accessToken));\n+\t\t\t} catch (IllegalArgumentException iae) {\n+\t\t\t\ttry {\n+\t\t\t\t\tString username = credentials.getUserName();\n+\t\t\t\t\tPrincipalAlias alias = authenticationService.lookupUserForAuthentication(username);\n+\t\t\t\t\tuserId = alias.getPrincipalId();\n+\t\t\t\t\taccessToken = oidcTokenHelper.createTotalAccessToken(userId);\n+\t\t\t\t} catch (NotFoundException e) {\n+\t\t\t\t\trejectRequest(response, getInvalidCredentialsMessage());\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tHttpAuthUtil.setBearerTokenHeader(modHeaders, accessToken);\n+\t\t\tif (!authenticationService.hasUserAcceptedTermsOfUse(userId)) {", "originalCommit": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MzI2NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r427683265", "bodyText": "A little trickery in the (CGLIB) proxies that we use for the spring beans, I'm afraid that the method cannot be final", "author": "marcomarasca", "createdAt": "2020-05-20T00:59:18Z", "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/AcceptTermsOfUseFilter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package org.sagebionetworks.auth.filter;\r\n+\r\n+import java.io.IOException;\r\n+\r\n+import javax.servlet.Filter;\r\n+import javax.servlet.FilterChain;\r\n+import javax.servlet.FilterConfig;\r\n+import javax.servlet.ServletException;\r\n+import javax.servlet.ServletRequest;\r\n+import javax.servlet.ServletResponse;\r\n+import javax.servlet.http.HttpServletRequest;\r\n+import javax.servlet.http.HttpServletResponse;\r\n+\r\n+import org.sagebionetworks.auth.HttpAuthUtil;\r\n+import org.sagebionetworks.auth.services.AuthenticationService;\r\n+import org.sagebionetworks.repo.model.AuthorizationConstants;\r\n+import org.sagebionetworks.repo.model.AuthorizationConstants.BOOTSTRAP_PRINCIPAL;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.http.HttpStatus;\r\n+import org.springframework.stereotype.Component;\r\n+\r\n+/**\r\n+\r\n+ * This filter checks that the authenticated Syanpse user has agreed to the Synapse Terms Of Use.\r\n+ * Anonymous users are simply let through.\r\n+ */\r\n+@Component(\"acceptTermsOfUseFilter\")\r\n+public class AcceptTermsOfUseFilter implements Filter {\r\n+\tprivate static final String TOU_UNSIGNED_REASON = \"Terms of use have not been signed.\";\r\n+\t\r\n+\tprivate AuthenticationService authenticationService;\r\n+\r\n+\t@Autowired\r\n+\tpublic AcceptTermsOfUseFilter(AuthenticationService authenticationService) {\r\n+\t\tthis.authenticationService = authenticationService;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain)\r", "originalCommit": "09326973ef08cfbb11208b31dfb20187e27b735f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "baeff80e5e3953a39d4e2063220e863fb5604f87", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/baeff80e5e3953a39d4e2063220e863fb5604f87", "message": "PLFM-6211 refactor BasicAuthenticationFilter to allow DockerClientAuthFilter to validate access token just once. Factored out ToU check into its own filter.", "committedDate": "2020-05-20T22:15:09Z", "type": "commit"}, {"oid": "baeff80e5e3953a39d4e2063220e863fb5604f87", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/baeff80e5e3953a39d4e2063220e863fb5604f87", "message": "PLFM-6211 refactor BasicAuthenticationFilter to allow DockerClientAuthFilter to validate access token just once. Factored out ToU check into its own filter.", "committedDate": "2020-05-20T22:15:09Z", "type": "forcePushed"}]}