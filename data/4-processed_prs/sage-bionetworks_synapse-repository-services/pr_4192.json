{"pr_number": 4192, "pr_title": "Plfm 6392", "pr_createdAt": "2020-09-04T06:41:44Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192", "timeline": [{"oid": "b440c7c689e7e4a5047302b474a1d3f35eaf72d7", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b440c7c689e7e4a5047302b474a1d3f35eaf72d7", "message": " added message", "committedDate": "2020-09-02T08:07:38Z", "type": "commit"}, {"oid": "87d8221921843e9c55aad0c30fc0bf143d3c7dd1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/87d8221921843e9c55aad0c30fc0bf143d3c7dd1", "message": " added test in TableExceptionTranslatorTest", "committedDate": "2020-09-02T16:59:28Z", "type": "commit"}, {"oid": "30ec0e200eaa36ab532d5896626c51a7cf27a5fa", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/30ec0e200eaa36ab532d5896626c51a7cf27a5fa", "message": " removed test, was redundant", "committedDate": "2020-09-02T17:00:19Z", "type": "commit"}, {"oid": "a16dc6d8ca815395319f15ed6e6152c7059c22f6", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a16dc6d8ca815395319f15ed6e6152c7059c22f6", "message": " refactor impl in translateException", "committedDate": "2020-09-02T17:13:03Z", "type": "commit"}, {"oid": "f31be5022ab6762b63bc9c0cff2632d5b1d2d6aa", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f31be5022ab6762b63bc9c0cff2632d5b1d2d6aa", "message": "added translateException method to TableQueryNextPageWorker", "committedDate": "2020-09-02T17:14:06Z", "type": "commit"}, {"oid": "a615bfe3a03a951ecf34c4b1826ae542ca3c7dac", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a615bfe3a03a951ecf34c4b1826ae542ca3c7dac", "message": "removed E2E test -- not necessary", "committedDate": "2020-09-02T18:22:06Z", "type": "commit"}, {"oid": "a6303e152102fa37e26dc0ac23e61ee2d75762e9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a6303e152102fa37e26dc0ac23e61ee2d75762e9", "message": "added Note to parse Exception in TableQueryUtils, added more integration tests", "committedDate": "2020-09-02T23:10:12Z", "type": "commit"}, {"oid": "ff60832f4a5b2912a906d20273072069c0fde662", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ff60832f4a5b2912a906d20273072069c0fde662", "message": " added test in TableQueryUtilsTest", "committedDate": "2020-09-03T17:03:53Z", "type": "commit"}, {"oid": "fd81489e24316c298bede15d54a75c2c0e91ea65", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fd81489e24316c298bede15d54a75c2c0e91ea65", "message": "minor changes", "committedDate": "2020-09-03T17:55:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTkwOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483749908", "bodyText": "Please use the static modifier", "author": "marcomarasca", "createdAt": "2020-09-04T17:04:02Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorImpl.java", "diffHunk": "@@ -1,22 +1,26 @@\n package org.sagebionetworks.repo.model.dbo.dao.table;\r\n \r\n+import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n+import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n+import org.sagebionetworks.table.cluster.SQLUtils;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+\r\n import java.sql.SQLException;\r\n import java.util.HashSet;\r\n import java.util.Map;\r\n import java.util.Set;\r\n import java.util.regex.Matcher;\r\n import java.util.regex.Pattern;\r\n \r\n-import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n-import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n-import org.sagebionetworks.table.cluster.SQLUtils;\r\n-import org.springframework.beans.factory.annotation.Autowired;\r\n-\r\n public class TableExceptionTranslatorImpl implements TableExceptionTranslator {\r\n \r\n \tprivate static Pattern PATTERN_TABLE_NAME = Pattern.compile(SQLUtils.TABLE_PREFIX + \"[0-9]+\");\r\n \tprivate static Pattern PATTERN_COLUMM_ID = Pattern\r\n \t\t\t.compile(SQLUtils.COLUMN_PREFIX + \"[0-9]+\" + SQLUtils.COLUMN_POSTFIX);\r\n+\tprivate String UNKNOWN_COLUMN_MESSAGE = \"Unknown column\";\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MDQzNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483750435", "bodyText": "We can use a \". \" in place of the \\n", "author": "marcomarasca", "createdAt": "2020-09-04T17:05:14Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorImpl.java", "diffHunk": "@@ -1,22 +1,26 @@\n package org.sagebionetworks.repo.model.dbo.dao.table;\r\n \r\n+import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n+import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n+import org.sagebionetworks.table.cluster.SQLUtils;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+\r\n import java.sql.SQLException;\r\n import java.util.HashSet;\r\n import java.util.Map;\r\n import java.util.Set;\r\n import java.util.regex.Matcher;\r\n import java.util.regex.Pattern;\r\n \r\n-import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n-import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n-import org.sagebionetworks.table.cluster.SQLUtils;\r\n-import org.springframework.beans.factory.annotation.Autowired;\r\n-\r\n public class TableExceptionTranslatorImpl implements TableExceptionTranslator {\r\n \r\n \tprivate static Pattern PATTERN_TABLE_NAME = Pattern.compile(SQLUtils.TABLE_PREFIX + \"[0-9]+\");\r\n \tprivate static Pattern PATTERN_COLUMM_ID = Pattern\r\n \t\t\t.compile(SQLUtils.COLUMN_PREFIX + \"[0-9]+\" + SQLUtils.COLUMN_POSTFIX);\r\n+\tprivate String UNKNOWN_COLUMN_MESSAGE = \"Unknown column\";\r\n+\tprivate String UNQUOTED_KEYWORDS_ERROR_MESSAGE = \"\\nNote: If a column name contains spaces, punctuation,\" +\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MTQ3Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483751476", "bodyText": "Consider using \"See https:...\"", "author": "marcomarasca", "createdAt": "2020-09-04T17:07:39Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorImpl.java", "diffHunk": "@@ -1,22 +1,26 @@\n package org.sagebionetworks.repo.model.dbo.dao.table;\r\n \r\n+import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n+import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n+import org.sagebionetworks.table.cluster.SQLUtils;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+\r\n import java.sql.SQLException;\r\n import java.util.HashSet;\r\n import java.util.Map;\r\n import java.util.Set;\r\n import java.util.regex.Matcher;\r\n import java.util.regex.Pattern;\r\n \r\n-import org.sagebionetworks.repo.model.dao.table.ColumnNameProvider;\r\n-import org.sagebionetworks.repo.model.jdo.KeyFactory;\r\n-import org.sagebionetworks.table.cluster.SQLUtils;\r\n-import org.springframework.beans.factory.annotation.Autowired;\r\n-\r\n public class TableExceptionTranslatorImpl implements TableExceptionTranslator {\r\n \r\n \tprivate static Pattern PATTERN_TABLE_NAME = Pattern.compile(SQLUtils.TABLE_PREFIX + \"[0-9]+\");\r\n \tprivate static Pattern PATTERN_COLUMM_ID = Pattern\r\n \t\t\t.compile(SQLUtils.COLUMN_PREFIX + \"[0-9]+\" + SQLUtils.COLUMN_POSTFIX);\r\n+\tprivate String UNKNOWN_COLUMN_MESSAGE = \"Unknown column\";\r\n+\tprivate String UNQUOTED_KEYWORDS_ERROR_MESSAGE = \"\\nNote: If a column name contains spaces, punctuation,\" +\r\n+\t\t\t\" or SQL key words, then the name must be enclosed in double quotes. \" +\r\n+\t\t\t\"https://rest-docs.synapse.org/rest/org/sagebionetworks/repo/web/controller/TableExamples.html\";\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MjY5NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483752694", "bodyText": "Might want to use \"append\" rather than \"add\"", "author": "marcomarasca", "createdAt": "2020-09-04T17:10:33Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorImpl.java", "diffHunk": "@@ -37,6 +41,7 @@ public RuntimeException translateException(Throwable exception) {\n \t\t\t// found a SQLException so we can translate it.\r\n \t\t\tString originalMessage = sqlException.getMessage();\r\n \t\t\tString newMessage = replaceColumnIdsAndTableNames(originalMessage);\r\n+\t\t\tnewMessage = addUnquotedKeyWordMessage(newMessage);\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MzMyMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483753323", "bodyText": "This can be static, also check formatting", "author": "marcomarasca", "createdAt": "2020-09-04T17:12:00Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorImpl.java", "diffHunk": "@@ -154,4 +159,13 @@ public String replaceColumnIdsAndTableNames(String input) {\n \t\treturn replaceAllColumnReferences(input, coumnIdToNameMap);\r\n \t}\r\n \r\n+\t/*\r\n+\t * PLFM-6392 Add more informative error message for key words that must be quoted\r\n+\t */\r\n+\tprivate String addUnquotedKeyWordMessage(String input){\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1Mzg5Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483753896", "bodyText": "This message can be accessed statically from the class.", "author": "marcomarasca", "createdAt": "2020-09-04T17:13:19Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/table/TableExceptionTranslatorTest.java", "diffHunk": "@@ -21,11 +11,24 @@\n import org.springframework.jdbc.UncategorizedSQLException;\r\n import org.springframework.test.util.ReflectionTestUtils;\r\n \r\n-import com.google.common.collect.Sets;\r\n+import java.sql.SQLException;\r\n+import java.util.HashMap;\r\n+import java.util.Map;\r\n+import java.util.Set;\r\n+\r\n+import static org.junit.Assert.assertEquals;\r\n+import static org.junit.Assert.assertNotNull;\r\n+import static org.junit.Assert.assertTrue;\r\n+import static org.mockito.ArgumentMatchers.anySetOf;\r\n+import static org.mockito.Mockito.when;\r\n \r\n @RunWith(MockitoJUnitRunner.class)\r\n public class TableExceptionTranslatorTest {\r\n-\t\r\n+\r\n+\tprivate String UNQUOTED_KEYWORDS_ERROR_MESSAGE = \"\\nNote: If a column name contains spaces, punctuation, \" +\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1NjQyNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483756426", "bodyText": "This can be reverted, no change", "author": "marcomarasca", "createdAt": "2020-09-04T17:19:17Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/TableIndexDAOImpl.java", "diffHunk": "@@ -109,8 +48,66 @@\n import org.springframework.transaction.support.TransactionCallback;\r\n import org.springframework.transaction.support.TransactionTemplate;\r\n \r\n-import com.google.common.collect.Maps;\r\n-import com.google.common.collect.Sets;\r\n+import javax.sql.DataSource;\r\n+import java.sql.Connection;\r\n+import java.sql.PreparedStatement;\r\n+import java.sql.ResultSet;\r\n+import java.sql.SQLException;\r\n+import java.util.ArrayList;\r\n+import java.util.Collections;\r\n+import java.util.Date;\r\n+import java.util.HashMap;\r\n+import java.util.HashSet;\r\n+import java.util.Iterator;\r\n+import java.util.LinkedHashSet;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Optional;\r\n+import java.util.Set;\r\n+import java.util.function.Function;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ANNOTATION_KEYS_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ANNOTATION_REPLICATION_COL_KEY;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ANNOTATION_REPLICATION_COL_OBJECT_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ANNOTATION_REPLICATION_COL_STRING_LIST_VALUE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ANNOTATION_REPLICATION_COL_TYPE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.BATCH_INSERT_REPLICATION_SYNC_EXP;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.CRC_ALIAS;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.EXCLUSION_LIST_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.EXPIRES_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.ID_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBEJCT_REPLICATION_COL_ETAG;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_BENEFACTOR_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_CREATED_BY;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_CREATED_ON;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_FILE_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_FILE_MD5;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_FILE_SIZE_BYTES;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_IN_SYNAPSE_STORAGE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_MODIFIED_BY;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_MODIFIED_ON;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_OBJECT_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_OBJECT_TYPE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_PARENT_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_PROJECT_ID;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_SUBTYPE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_COL_VERSION;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_REPLICATION_TABLE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.OBJECT_TYPE_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.PARENT_ID_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.P_LIMIT;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.P_OFFSET;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.SELECT_NON_EXPIRED_IDS;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.SELECT_OBJECT_CHILD_CRC;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.SELECT_OBJECT_CHILD_ID_ETAG;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.SUBTYPE_PARAM_NAME;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.TRUNCATE_ANNOTATION_REPLICATION_TABLE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.TRUNCATE_OBJECT_REPLICATION_TABLE;\r\n+import static org.sagebionetworks.repo.model.table.TableConstants.TRUNCATE_REPLICATION_SYNC_EXPIRATION_TABLE;\r\n \r\n public class TableIndexDAOImpl implements TableIndexDAO {\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1NjU0MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483756541", "bodyText": "This can be reverted, no change", "author": "marcomarasca", "createdAt": "2020-09-04T17:19:34Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/file/download/BulkDownloadManagerImpl.java", "diffHunk": "@@ -46,7 +41,11 @@\n import org.sagebionetworks.workers.util.semaphore.LockUnavilableException;\n import org.springframework.beans.factory.annotation.Autowired;\n \n-import com.google.common.collect.Lists;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n \n public class BulkDownloadManagerImpl implements BulkDownloadManager {", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2NTMwOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483765308", "bodyText": "We should add the original ParseException as the cause of the wrapper exception, rather than creating a new instance:\nthrow new IllegalArgumentException(e.getMessage() + UNQUOTED_KEYWORDS_ERROR_MESSAGE, e);", "author": "marcomarasca", "createdAt": "2020-09-04T17:39:39Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/TableQueryUtils.java", "diffHunk": "@@ -130,7 +133,7 @@ public static String extractTableIdFromSql(String sql){\n \t\t} catch (TokenMgrError e) {\r\n \t\t\tthrow new IllegalArgumentException(\"The provided SQL query could not be parsed.\",e);\r\n \t\t}catch (ParseException e) {\r\n-\t\t\tthrow new IllegalArgumentException(e);\r\n+\t\t\tthrow new IllegalArgumentException(new ParseException(e.getMessage() + UNQUOTED_KEYWORDS_ERROR_MESSAGE));\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2NTg1Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483765852", "bodyText": "This constant should not be duplicated between this class and the TableExceptionTranslatorImpl, you might want to consider moving the \"enriching method\" (e.g. appendUnqueoted...) to a common location (For example TableConstants or TableExceptionTranslator interface itself).", "author": "marcomarasca", "createdAt": "2020-09-04T17:40:54Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/TableQueryUtils.java", "diffHunk": "@@ -17,8 +14,14 @@\n import org.sagebionetworks.table.query.TokenMgrError;\r\n import org.sagebionetworks.util.ValidateArgument;\r\n \r\n+import java.io.StringWriter;\r\n+import java.util.List;\r\n+\r\n public class TableQueryUtils {\r\n \r\n+\tprivate static final String UNQUOTED_KEYWORDS_ERROR_MESSAGE = \"\\nNote: If a column name contains spaces, punctuation, \" +\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY0Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483773642", "bodyText": "You can access the constant.", "author": "marcomarasca", "createdAt": "2020-09-04T17:59:14Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/table/TableQueryUtilsTest.java", "diffHunk": "@@ -19,10 +15,19 @@\n import org.sagebionetworks.repo.model.table.SortDirection;\r\n import org.sagebionetworks.repo.model.table.SortItem;\r\n \r\n-import com.google.common.collect.Lists;\r\n+import java.util.List;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.assertEquals;\r\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\r\n+import static org.junit.jupiter.api.Assertions.assertThrows;\r\n+import static org.junit.jupiter.api.Assertions.assertTrue;\r\n \r\n public class TableQueryUtilsTest {\r\n-\t\r\n+\r\n+\tprivate String UNQUOTED_KEYWORDS_ERROR_MESSAGE = \"\\nNote: If a column name contains spaces, punctuation,\" +\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NDIzOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483774238", "bodyText": "Better naming might be: testExtractTableIdFromSqlWithParserException", "author": "marcomarasca", "createdAt": "2020-09-04T18:00:42Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/table/TableQueryUtilsTest.java", "diffHunk": "@@ -164,4 +169,19 @@ public void testPLFM_6027() {\n \t\tString result = TableQueryUtils.extractTableIdFromSql(sql);\r\n \t\tassertEquals(\"syn123\", result);\r\n \t}\r\n+\r\n+\t@Test\r\n+\t/**\r\n+\t * PLFM-6392 Add a more informative message to the user for cases where keywords\r\n+\t * must be escaped.\r\n+\t */\r\n+\tpublic void testUnquotedKeywordsErrorMessage() {\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NDc2MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483774760", "bodyText": "You can simply use assertEquals(\"Expected error message\", exception.getMessage())", "author": "marcomarasca", "createdAt": "2020-09-04T18:02:07Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/table/TableQueryUtilsTest.java", "diffHunk": "@@ -164,4 +169,19 @@ public void testPLFM_6027() {\n \t\tString result = TableQueryUtils.extractTableIdFromSql(sql);\r\n \t\tassertEquals(\"syn123\", result);\r\n \t}\r\n+\r\n+\t@Test\r\n+\t/**\r\n+\t * PLFM-6392 Add a more informative message to the user for cases where keywords\r\n+\t * must be escaped.\r\n+\t */\r\n+\tpublic void testUnquotedKeywordsErrorMessage() {\r\n+\t\tString sql = \"select year from syn123 where year = 1\";\r\n+\t\tIllegalArgumentException exception = assertThrows(IllegalArgumentException.class, ()->{\r\n+\t\t\tTableQueryUtils.extractTableIdFromSql(sql);\r\n+\t\t});\r\n+\t\tassertNotNull(exception);\r\n+\t\tassertNotNull(exception.getMessage());\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NTAzOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483775038", "bodyText": "This check is not necessary since the assertThrows always returns the exception (otherwise it would fail the test)", "author": "marcomarasca", "createdAt": "2020-09-04T18:02:47Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/table/TableQueryUtilsTest.java", "diffHunk": "@@ -164,4 +169,19 @@ public void testPLFM_6027() {\n \t\tString result = TableQueryUtils.extractTableIdFromSql(sql);\r\n \t\tassertEquals(\"syn123\", result);\r\n \t}\r\n+\r\n+\t@Test\r\n+\t/**\r\n+\t * PLFM-6392 Add a more informative message to the user for cases where keywords\r\n+\t * must be escaped.\r\n+\t */\r\n+\tpublic void testUnquotedKeywordsErrorMessage() {\r\n+\t\tString sql = \"select year from syn123 where year = 1\";\r\n+\t\tIllegalArgumentException exception = assertThrows(IllegalArgumentException.class, ()->{\r\n+\t\t\tTableQueryUtils.extractTableIdFromSql(sql);\r\n+\t\t});\r\n+\t\tassertNotNull(exception);\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3NjAwNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483776007", "bodyText": "This translatedException is not used, you might need to set this in the job status: asynchJobStatusManager.setJobFailed(status.getJobId(), translatedException);", "author": "marcomarasca", "createdAt": "2020-09-04T18:05:09Z", "path": "services/workers/src/main/java/org/sagebionetworks/table/worker/TableQueryNextPageWorker.java", "diffHunk": "@@ -53,6 +56,8 @@ public void run(ProgressCallback progressCallback, Message message)\n \t\t\t// This means we cannot use this table\n \t\t\tasynchJobStatusManager.setJobFailed(status.getJobId(), e);\n \t\t}catch(Throwable e){\n+\t\t\t// Attempt to translate the exception into a 'user-friendly' message.\n+\t\t\tRuntimeException translatedException = tableExceptionTranslator.translateException(e);", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3Njg1MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483776851", "bodyText": "This can be reverted as there is no change.", "author": "marcomarasca", "createdAt": "2020-09-04T18:07:09Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableQueryWorkerTest.java", "diffHunk": "@@ -32,7 +25,13 @@\n import org.sagebionetworks.workers.util.semaphore.LockUnavilableException;\r\n import org.springframework.test.util.ReflectionTestUtils;\r\n \r\n-import com.amazonaws.services.sqs.model.Message;\r\n+import static org.junit.Assert.fail;\r\n+import static org.mockito.ArgumentMatchers.any;\r\n+import static org.mockito.ArgumentMatchers.anyString;\r\n+import static org.mockito.ArgumentMatchers.eq;\r\n+import static org.mockito.Mockito.doAnswer;\r\n+import static org.mockito.Mockito.verify;\r\n+import static org.mockito.Mockito.when;\r\n \r\n @RunWith(MockitoJUnitRunner.class)\r\n public class TableQueryWorkerTest {\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3ODA3OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483778079", "bodyText": "This block of code from 2081 to 2827 is unused in the test.", "author": "marcomarasca", "createdAt": "2020-09-04T18:10:00Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableWorkerIntegrationTest.java", "diffHunk": "@@ -2798,6 +2801,57 @@ public void testPLFM_5240Open() throws Exception {\n \t\t});\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-6392\r\n+\t * @throws Exception\r\n+\t */\r\n+\t@Test\r\n+\tpublic void testQueryWithUnquotedKeyword() throws Exception{\r\n+\t\tColumnModel year = new ColumnModel();\r\n+\t\tyear.setColumnType(ColumnType.STRING);\r\n+\t\tyear.setMaximumSize(50L);\r\n+\t\tyear.setName(\"year\");\r\n+\t\tyear = columnManager.createColumnModel(adminUserInfo, year);\r\n+\t\tschema = Lists.newArrayList(year);\r\n+\t\t// build a table with this column.\r\n+\t\tcreateTableWithSchema();\r\n+\t\tTableStatus status = waitForTableProcessing(tableId);\r\n+\t\tassertTrue(TableState.AVAILABLE.equals(status.getState()));\r\n+\r\n+\t\tRowSet rowSet = new RowSet();\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3OTg3Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483779873", "bodyText": "The error message might be something like: \"This should have failed with an IllegalArgumentException\"", "author": "marcomarasca", "createdAt": "2020-09-04T18:14:08Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableWorkerIntegrationTest.java", "diffHunk": "@@ -2798,6 +2801,57 @@ public void testPLFM_5240Open() throws Exception {\n \t\t});\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-6392\r\n+\t * @throws Exception\r\n+\t */\r\n+\t@Test\r\n+\tpublic void testQueryWithUnquotedKeyword() throws Exception{\r\n+\t\tColumnModel year = new ColumnModel();\r\n+\t\tyear.setColumnType(ColumnType.STRING);\r\n+\t\tyear.setMaximumSize(50L);\r\n+\t\tyear.setName(\"year\");\r\n+\t\tyear = columnManager.createColumnModel(adminUserInfo, year);\r\n+\t\tschema = Lists.newArrayList(year);\r\n+\t\t// build a table with this column.\r\n+\t\tcreateTableWithSchema();\r\n+\t\tTableStatus status = waitForTableProcessing(tableId);\r\n+\t\tassertTrue(TableState.AVAILABLE.equals(status.getState()));\r\n+\r\n+\t\tRowSet rowSet = new RowSet();\r\n+\t\trowSet.setRows(Lists.newArrayList(\r\n+\t\t\t\tTableModelTestUtils.createRow(null, null, \"2020\")));\r\n+\t\trowSet.setHeaders(TableModelUtils.getSelectColumns(schema));\r\n+\t\trowSet.setTableId(tableId);\r\n+\t\treferenceSet = appendRows(adminUserInfo, tableId,\r\n+\t\t\t\trowSet, mockProgressCallback);\r\n+\r\n+\t\tThrowable selectClauseException = assertThrows(IllegalArgumentException.class, ()->{\r\n+\t\t\twaitForConsistentQuery(adminUserInfo, \"select year from \" + tableId, null, null, (queryResult) -> {\r\n+\t\t\t\tfail(\"Throw IllegalArgumentException\");\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc4MDQwNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483780407", "bodyText": "The null check is not needed as the assertThrows always returns the exception or fail", "author": "marcomarasca", "createdAt": "2020-09-04T18:15:16Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableWorkerIntegrationTest.java", "diffHunk": "@@ -2798,6 +2801,57 @@ public void testPLFM_5240Open() throws Exception {\n \t\t});\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-6392\r\n+\t * @throws Exception\r\n+\t */\r\n+\t@Test\r\n+\tpublic void testQueryWithUnquotedKeyword() throws Exception{\r\n+\t\tColumnModel year = new ColumnModel();\r\n+\t\tyear.setColumnType(ColumnType.STRING);\r\n+\t\tyear.setMaximumSize(50L);\r\n+\t\tyear.setName(\"year\");\r\n+\t\tyear = columnManager.createColumnModel(adminUserInfo, year);\r\n+\t\tschema = Lists.newArrayList(year);\r\n+\t\t// build a table with this column.\r\n+\t\tcreateTableWithSchema();\r\n+\t\tTableStatus status = waitForTableProcessing(tableId);\r\n+\t\tassertTrue(TableState.AVAILABLE.equals(status.getState()));\r\n+\r\n+\t\tRowSet rowSet = new RowSet();\r\n+\t\trowSet.setRows(Lists.newArrayList(\r\n+\t\t\t\tTableModelTestUtils.createRow(null, null, \"2020\")));\r\n+\t\trowSet.setHeaders(TableModelUtils.getSelectColumns(schema));\r\n+\t\trowSet.setTableId(tableId);\r\n+\t\treferenceSet = appendRows(adminUserInfo, tableId,\r\n+\t\t\t\trowSet, mockProgressCallback);\r\n+\r\n+\t\tThrowable selectClauseException = assertThrows(IllegalArgumentException.class, ()->{\r\n+\t\t\twaitForConsistentQuery(adminUserInfo, \"select year from \" + tableId, null, null, (queryResult) -> {\r\n+\t\t\t\tfail(\"Throw IllegalArgumentException\");\r\n+\t\t\t});\r\n+\t\t});\r\n+\t\tassertNotNull(selectClauseException);\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc4MDYyOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4192#discussion_r483780629", "bodyText": "Try to use an assertEquals rather than contains.", "author": "marcomarasca", "createdAt": "2020-09-04T18:15:49Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableWorkerIntegrationTest.java", "diffHunk": "@@ -2798,6 +2801,57 @@ public void testPLFM_5240Open() throws Exception {\n \t\t});\r\n \t}\r\n \r\n+\t/**\r\n+\t * PLFM-6392\r\n+\t * @throws Exception\r\n+\t */\r\n+\t@Test\r\n+\tpublic void testQueryWithUnquotedKeyword() throws Exception{\r\n+\t\tColumnModel year = new ColumnModel();\r\n+\t\tyear.setColumnType(ColumnType.STRING);\r\n+\t\tyear.setMaximumSize(50L);\r\n+\t\tyear.setName(\"year\");\r\n+\t\tyear = columnManager.createColumnModel(adminUserInfo, year);\r\n+\t\tschema = Lists.newArrayList(year);\r\n+\t\t// build a table with this column.\r\n+\t\tcreateTableWithSchema();\r\n+\t\tTableStatus status = waitForTableProcessing(tableId);\r\n+\t\tassertTrue(TableState.AVAILABLE.equals(status.getState()));\r\n+\r\n+\t\tRowSet rowSet = new RowSet();\r\n+\t\trowSet.setRows(Lists.newArrayList(\r\n+\t\t\t\tTableModelTestUtils.createRow(null, null, \"2020\")));\r\n+\t\trowSet.setHeaders(TableModelUtils.getSelectColumns(schema));\r\n+\t\trowSet.setTableId(tableId);\r\n+\t\treferenceSet = appendRows(adminUserInfo, tableId,\r\n+\t\t\t\trowSet, mockProgressCallback);\r\n+\r\n+\t\tThrowable selectClauseException = assertThrows(IllegalArgumentException.class, ()->{\r\n+\t\t\twaitForConsistentQuery(adminUserInfo, \"select year from \" + tableId, null, null, (queryResult) -> {\r\n+\t\t\t\tfail(\"Throw IllegalArgumentException\");\r\n+\t\t\t});\r\n+\t\t});\r\n+\t\tassertNotNull(selectClauseException);\r\n+\t\tassertNotNull(selectClauseException.getMessage());\r\n+\t\tassertTrue(selectClauseException.getMessage().contains(UNQUOTED_KEYWORDS_ERROR_MESSAGE));\r", "originalCommit": "fd81489e24316c298bede15d54a75c2c0e91ea65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d809c7e308b210839b9259beb1dd2e481edbc37", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/7d809c7e308b210839b9259beb1dd2e481edbc37", "message": "pull request changes", "committedDate": "2020-09-04T20:46:39Z", "type": "commit"}, {"oid": "a4afa558c8f6372e21d2f39d8dd62148bfb2e3e2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a4afa558c8f6372e21d2f39d8dd62148bfb2e3e2", "message": " revert TableIndexDaoImpl", "committedDate": "2020-09-04T21:14:01Z", "type": "commit"}, {"oid": "0f4c4f4b86e4127d500ba6766391c38537caad46", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0f4c4f4b86e4127d500ba6766391c38537caad46", "message": "more specific test name , used assertEquals", "committedDate": "2020-09-04T21:24:26Z", "type": "commit"}, {"oid": "39844f08a7546d75f3c817fb2b7ac82ffd21a32f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/39844f08a7546d75f3c817fb2b7ac82ffd21a32f", "message": " switched expected/actual assertions to correct places", "committedDate": "2020-09-04T21:35:24Z", "type": "commit"}]}