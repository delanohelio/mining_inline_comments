{"pr_number": 3916, "pr_title": "PLFM-6005 and PLFM-6006", "pr_createdAt": "2020-01-27T23:37:59Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916", "timeline": [{"oid": "1c5e892b32b6f5bab0ac0a05e002f84fd6b90970", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1c5e892b32b6f5bab0ac0a05e002f84fd6b90970", "message": "PLFM-6005 Can't override ACLs on children of STS folders", "committedDate": "2019-12-19T02:45:41Z", "type": "commit"}, {"oid": "9a736ead39d791b7a3774e00ef64d146fe670dfb", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9a736ead39d791b7a3774e00ef64d146fe670dfb", "message": "PLFM-6006 STS Upload Restrictions (work in progress)", "committedDate": "2020-01-08T05:10:26Z", "type": "commit"}, {"oid": "a802a8c0daeb248151637f7b175531dc8818278f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a802a8c0daeb248151637f7b175531dc8818278f", "message": "Merge remote-tracking branch 'origin/project-settings-sql' into plfm-6005\n\nConflicts:\n\tintegration-test/src/test/java/org/sagebionetworks/IT049FileHandleTest.java\n\tintegration-test/src/test/java/org/sagebionetworks/ITStorageLocation.java\n\tservices/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java", "committedDate": "2020-01-08T05:27:45Z", "type": "commit"}, {"oid": "5ba32cb6d5cc17679b25f45f4bedd24f19ec0bb4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5ba32cb6d5cc17679b25f45f4bedd24f19ec0bb4", "message": "clean up tests for PLFM-6005 Can't override ACLs on children of STS folders", "committedDate": "2020-01-22T01:13:54Z", "type": "commit"}, {"oid": "c91d8e973affe0ae4554cf7fe32b3af0a05f16c6", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c91d8e973affe0ae4554cf7fe32b3af0a05f16c6", "message": "PLFM-6006 STS Upload Restrictions (tests)", "committedDate": "2020-01-22T06:37:21Z", "type": "commit"}, {"oid": "e888ee0ecacd195f366ec38b24153316c1232efe", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e888ee0ecacd195f366ec38b24153316c1232efe", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005\n\nConflicts:\n\tservices/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "committedDate": "2020-01-22T06:43:12Z", "type": "commit"}, {"oid": "fc3f82e3bb9ce4d6bf3ffc5c118b705ad40dac9a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fc3f82e3bb9ce4d6bf3ffc5c118b705ad40dac9a", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005", "committedDate": "2020-01-24T00:20:17Z", "type": "commit"}, {"oid": "31a36bb0baa28855e993e3a10cb86b335d4f0b2e", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/31a36bb0baa28855e993e3a10cb86b335d4f0b2e", "message": "PLFM-6006 STS Upload Restrictions (clean up integ tests)", "committedDate": "2020-01-27T23:00:48Z", "type": "commit"}, {"oid": "cef7f4066cf3c5d898031802ec165e68a5aeaf90", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cef7f4066cf3c5d898031802ec165e68a5aeaf90", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005\n\nConflicts:\n\tservices/repository-managers/src/test/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImplUnitTest.java", "committedDate": "2020-01-27T23:08:53Z", "type": "commit"}, {"oid": "d58e288e90a647023c112a4c36633e317f041003", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d58e288e90a647023c112a4c36633e317f041003", "message": "fix additional merge conflict", "committedDate": "2020-01-27T23:35:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTYxNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371561617", "bodyText": "Java Optional", "author": "john-hill", "createdAt": "2020-01-28T00:46:47Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -85,6 +98,22 @@ public void setAllowCreationOfOldEntities(boolean allowCreationOfOldEntities) {\n \t\t\tthrows DatastoreException, InvalidModelException,\n \t\t\tUnauthorizedException, NotFoundException {\n \t\tvalidateEntity(newEntity);\n+\t\tif (newEntity instanceof FileEntity) {\n+\t\t\tvalidateFileEntityStsRestrictions(userInfo, (FileEntity) newEntity);\n+\t\t}\n+\n+\t\t// If the parent lives inside an STS-enabled folder, only Files and Folders are allowed.\n+\t\tif (!(newEntity instanceof FileEntity) && !(newEntity instanceof Folder)) {\n+\t\t\tString parentId = newEntity.getParentId();\n+\t\t\tif (parentId != null) {\n+\t\t\t\tProjectSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo, parentId,", "originalCommit": "d58e288e90a647023c112a4c36633e317f041003", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjYzMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371566630", "bodyText": "test for null case?", "author": "john-hill", "createdAt": "2020-01-28T01:07:17Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -562,7 +595,50 @@ public DataTypeResponse changeEntityDataType(UserInfo userInfo, String entityId,\n \t\tValidateArgument.required(dataType, \"DataType\");\n \t\treturn objectTypeManager.changeObjectsDataType(userInfo, entityId, ObjectType.ENTITY, dataType);\n \t}\n-\t\n+\n+\t// Validates whether a FileEntity satisfies the STS restrictions of its parent.\n+\t// Package-scoped to facilitate unit tests.\n+\tvoid validateFileEntityStsRestrictions(UserInfo userInfo, FileEntity fileEntity) {\n+\t\t// Is the file STS-enabled?\n+\t\tFileHandle fileHandle = fileHandleManager.getRawFileHandle(userInfo, fileEntity.getDataFileHandleId());\n+\t\tLong fileStorageLocationId = fileHandle.getStorageLocationId();", "originalCommit": "d58e288e90a647023c112a4c36633e317f041003", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExMDA5Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372110093", "bodyText": "comment on projectId can be a folderId", "author": "john-hill", "createdAt": "2020-01-28T23:09:46Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImpl.java", "diffHunk": "@@ -154,6 +158,18 @@ public AccessControlList overrideInheritance(AccessControlList acl, UserInfo use\n \t\t\n \t\t// validate the Entity owners will still have access.\n \t\tPermissionsManagerUtils.validateACLContent(acl, userInfo, node.getCreatedByPrincipalId());\n+\n+\t\t// Can't override ACL inheritance if the entity lives inside an STS-enabled folder.\n+\t\tUploadDestinationListSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo,\n+\t\t\t\tentityId, ProjectSettingsType.upload, UploadDestinationListSetting.class);\n+\t\tif (projectSetting != null && !KeyFactory.equals(projectSetting.getProjectId(), entityId)) {", "originalCommit": "d58e288e90a647023c112a4c36633e317f041003", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTQwNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115404", "bodyText": "cast to the other way", "author": "john-hill", "createdAt": "2020-01-28T23:25:47Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);", "originalCommit": "d58e288e90a647023c112a4c36633e317f041003", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTgxOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115819", "bodyText": "duplicate", "author": "john-hill", "createdAt": "2020-01-28T23:27:05Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);\n \t\tassertFalse(result);\n-\t\tverifyZeroInteractions(mockStorageLocationDAO);\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_ProjectSettingWrongSubclass() {\n-\t\t// Create a mock of ProjectSetting, so we can have a ProjectSetting instance that's not an\n-\t\t// UploadDestinationListSetting.\n-\t\tProjectSetting input = mock(ProjectSetting.class);\n+\tpublic void testIsStsStorageLocation_StorageLocationSettingWrongClass() {\n+\t\t// Method under test.\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\tnew ExternalGoogleCloudStorageLocationSetting());\n+\t\tassertFalse(result);\n+\t}\n \n+\t@Test\n+\tpublic void testIsStsStorageLocation_NotStsStorageLocation() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(input);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\texternalGoogleCloudStorageLocationSetting);", "originalCommit": "d58e288e90a647023c112a4c36633e317f041003", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}