{"pr_number": 4027, "pr_title": "enforce maximumListLength on entity views (PLFM-6168)", "pr_createdAt": "2020-04-30T03:04:09Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027", "timeline": [{"oid": "706b99c206fc2b1e82c9c63a6a0f1d1881894094", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/706b99c206fc2b1e82c9c63a6a0f1d1881894094", "message": "enforce maximumListLength on entity views", "committedDate": "2020-04-30T03:03:22Z", "type": "commit"}, {"oid": "711f65c90be2ca85287330e1d94569795c24e347", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/711f65c90be2ca85287330e1d94569795c24e347", "message": "Merge branch 'develop' of github.com:Sage-Bionetworks/Synapse-Repository-Services into PLFM-6168", "committedDate": "2020-04-30T03:10:30Z", "type": "commit"}, {"oid": "553ba56baf1d9aba5c11687245b03097957250c2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/553ba56baf1d9aba5c11687245b03097957250c2", "message": "fix compile error after merging develop", "committedDate": "2020-04-30T03:31:15Z", "type": "commit"}, {"oid": "66e8689e8147dd558bf5c178047795db7c6d855a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/66e8689e8147dd558bf5c178047795db7c6d855a", "message": "fix tests", "committedDate": "2020-04-30T03:46:03Z", "type": "commit"}, {"oid": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9fc18bd149099ec7cb61ac171560ecf2a18afd85", "message": "fix test", "committedDate": "2020-04-30T03:50:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyNzM5NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418327395", "bodyText": "The comment should be below", "author": "marcomarasca", "createdAt": "2020-04-30T22:35:21Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableViewIntegrationTest.java", "diffHunk": "@@ -1482,6 +1484,97 @@ public void testEntityView_multipleValueColumnRoundTrip() throws Exception {\n \t\tassertEquals(Arrays.asList(\"newVal1\", \"newVal2\"), entityManager.getAnnotations(adminUserInfo, firstChangeId).getAnnotations().get(stringListColumn.getName()).getValue());\r\n \t\tassertEquals(Arrays.asList(\"newVal4\", \"newVal5\", \"newVal6\"), entityManager.getAnnotations(adminUserInfo, secondChangeId).getAnnotations().get(stringListColumn.getName()).getValue());\r\n \t}\r\n+\r\n+\r\n+\t@Test\r\n+\tpublic void testEntityView_multipleValueColumn_UpdatedAnnotationExceedListMaxSize() throws Exception {\r\n+\t\tdefaultColumnIds.add(stringListColumn.getId());\r\n+\t\tcreateFileView();\r\n+\r\n+\t\tassertTrue(fileCount >= 2, \"setup() needs to create at least 2 entities for this test to work\");\r\n+\r\n+\t\tLong fileId = KeyFactory.stringToKey(fileIds.get(0));\r\n+\r\n+\t\t//set annotations for 2 files\r\n+\t\tAnnotations fileAnnotation1 = entityManager.getAnnotations(adminUserInfo, fileIds.get(0));\r\n+\t\t//this annotation will exceed the limit\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMDUyMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418330523", "bodyText": "Add a test that verifies that if we try to push an update with an string list that exceeds the column model maximumListLength it fails.", "author": "marcomarasca", "createdAt": "2020-04-30T22:44:18Z", "path": "services/workers/src/test/java/org/sagebionetworks/table/worker/TableViewIntegrationTest.java", "diffHunk": "@@ -1482,6 +1484,97 @@ public void testEntityView_multipleValueColumnRoundTrip() throws Exception {\n \t\tassertEquals(Arrays.asList(\"newVal1\", \"newVal2\"), entityManager.getAnnotations(adminUserInfo, firstChangeId).getAnnotations().get(stringListColumn.getName()).getValue());\r\n \t\tassertEquals(Arrays.asList(\"newVal4\", \"newVal5\", \"newVal6\"), entityManager.getAnnotations(adminUserInfo, secondChangeId).getAnnotations().get(stringListColumn.getName()).getValue());\r\n \t}\r\n+\r\n+\r\n+\t@Test\r\n+\tpublic void testEntityView_multipleValueColumn_UpdatedAnnotationExceedListMaxSize() throws Exception {\r\n+\t\tdefaultColumnIds.add(stringListColumn.getId());\r\n+\t\tcreateFileView();\r\n+\r\n+\t\tassertTrue(fileCount >= 2, \"setup() needs to create at least 2 entities for this test to work\");\r\n+\r\n+\t\tLong fileId = KeyFactory.stringToKey(fileIds.get(0));\r\n+\r\n+\t\t//set annotations for 2 files\r\n+\t\tAnnotations fileAnnotation1 = entityManager.getAnnotations(adminUserInfo, fileIds.get(0));\r\n+\t\t//this annotation will exceed the limit\r\n+\t\tAnnotationsV2TestUtils.putAnnotations(fileAnnotation1, stringListColumn.getName(), Arrays.asList(\"val1\", \"val2\"), AnnotationsValueType.STRING);\r\n+\t\tentityManager.updateAnnotations(adminUserInfo, fileIds.get(0), fileAnnotation1);\r\n+\t\twaitForEntityReplication(fileViewId, fileIds.get(0));\r\n+\r\n+\r\n+\t\tassertEquals(fileCount, waitForConsistentQuery(adminUserInfo, \"select id, etag, \"+ stringListColumn.getName() +\" from \" + fileViewId, fileCount).getQueryCount());\r\n+\r\n+\t\tAnnotations fileAnnotation2 = entityManager.getAnnotations(adminUserInfo, fileIds.get(1));\r\n+\t\tAnnotationsV2TestUtils.putAnnotations(fileAnnotation2, stringListColumn.getName(), Arrays.asList(\"val2\", \"val3\", \"val1\", \"val4\"), AnnotationsValueType.STRING);\r\n+\t\tentityManager.updateAnnotations(adminUserInfo, fileIds.get(1), fileAnnotation2);\r\n+\r\n+\r\n+\t\twaitForEntityReplication(fileViewId, fileIds.get(1));\r\n+\r\n+\r\n+\t\tString error = assertThrows(AsynchJobFailedException.class, () ->\r\n+\t\t\t\twaitForConsistentQuery(adminUserInfo, \"select id, etag, \"+ stringListColumn.getName() +\" from \" + fileViewId, fileCount)\r\n+\t\t).getMessage();\r\n+\t\tassertEquals(\"maximumListLength for ColumnModel \\\"stringList\\\" must be at least: 4\", error);\r\n+\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void testEntityView_multipleValueColumnRoundTrip_changeMaxListLength() throws Exception {\r\n+\t\tdefaultColumnIds.add(stringListColumn.getId());\r\n+\t\tcreateFileView();\r\n+\r\n+\t\tassertTrue(fileCount >= 2, \"setup() needs to create at least 2 entities for this test to work\");\r\n+\r\n+\t\tLong fileId = KeyFactory.stringToKey(fileIds.get(0));\r\n+\r\n+\t\t//set annotations for 2 files\r\n+\t\tAnnotations fileAnnotation1 = entityManager.getAnnotations(adminUserInfo, fileIds.get(0));\r\n+\t\tAnnotationsV2TestUtils.putAnnotations(fileAnnotation1, stringListColumn.getName(), Arrays.asList(\"val1\", \"val2\", \"val3\"), AnnotationsValueType.STRING);\r\n+\t\tentityManager.updateAnnotations(adminUserInfo, fileIds.get(0), fileAnnotation1);\r\n+\r\n+\t\tAnnotations fileAnnotation2 = entityManager.getAnnotations(adminUserInfo, fileIds.get(1));\r\n+\t\tAnnotationsV2TestUtils.putAnnotations(fileAnnotation2, stringListColumn.getName(), Arrays.asList(\"val2\", \"val3\"), AnnotationsValueType.STRING);\r\n+\t\tentityManager.updateAnnotations(adminUserInfo, fileIds.get(1), fileAnnotation2);\r\n+\r\n+\r\n+\t\twaitForEntityReplication(fileViewId, fileIds.get(0));\r\n+\r\n+\r\n+\t\tassertEquals(fileCount, waitForConsistentQuery(adminUserInfo, \"select id, etag, \"+ stringListColumn.getName() +\" from \" + fileViewId, fileCount).getQueryCount());\r\n+\r\n+\t\t//now reduce the maxListSize\r\n+\r\n+\t\tColumnModel smallerStringListColumn = new ColumnModel();\r\n+\t\tsmallerStringListColumn.setName(\"stringList\");\r\n+\t\tsmallerStringListColumn.setColumnType(ColumnType.STRING_LIST);\r\n+\t\tsmallerStringListColumn.setMaximumListLength(2L);\r\n+\t\tsmallerStringListColumn = columnModelManager.createColumnModel(adminUserInfo, smallerStringListColumn);\r\n+\r\n+\t\t// change the schema as a transaction\r\n+\t\tColumnChange remove = new ColumnChange();\r\n+\t\tremove.setOldColumnId(stringListColumn.getId());\r\n+\t\tremove.setNewColumnId(smallerStringListColumn.getId());\r\n+\t\tList<ColumnChange> changes = Lists.newArrayList(remove);\r\n+\t\tTableSchemaChangeRequest request = new TableSchemaChangeRequest();\r\n+\t\trequest.setEntityId(fileViewId);\r\n+\t\trequest.setChanges(changes);\r\n+\r\n+\t\tList<TableUpdateRequest> updates = new LinkedList<TableUpdateRequest>();\r\n+\t\tupdates.add(request);\r\n+\t\tTableUpdateTransactionRequest transaction = new TableUpdateTransactionRequest();\r\n+\t\ttransaction.setEntityId(fileViewId);\r\n+\t\ttransaction.setChanges(updates);\r\n+\r\n+\t\t// wait for the change to complete\r\n+\t\tstartAndWaitForJob(adminUserInfo, transaction, TableUpdateTransactionResponse.class);\r\n+\r\n+\t\tString error = assertThrows(AsynchJobFailedException.class, () ->\r\n+\t\t\t\twaitForConsistentQuery(adminUserInfo, \"select id, etag, \"+ stringListColumn.getName() +\" from \" + fileViewId, fileCount)\r\n+\t\t).getMessage();\r\n+\t\tassertEquals(\"maximumListLength for ColumnModel \\\"stringList\\\" must be at least: 3\", error);\r\n+\t}\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzMTIwNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418331205", "bodyText": "you might want to use the ENTITY, or the already defined objectType", "author": "marcomarasca", "createdAt": "2020-04-30T22:46:27Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/table/TableIndexManagerImplTest.java", "diffHunk": "@@ -1787,6 +1794,170 @@ public void applyListColumnIndexTableChanges_multipleChanges(){\n \t\tverify(mockIndexDao).deleteMultivalueColumnIndexTable(tableId, columnIdToRemove, alterTemp);\r\n \t}\r\n \r\n+\t@Test\r\n+\tpublic void testValidateMaxListLengthInAnnotationReplication_noListColumns(){\r\n+\r\n+\t\tColumnModel bar = new ColumnModel();\r\n+\t\tbar.setId(\"1234\");\r\n+\t\tbar.setName(\"bar\");\r\n+\t\tbar.setColumnType(ColumnType.INTEGER);\r\n+\r\n+\t\tList<ColumnModel> currentSchema = Arrays.asList(bar);\r\n+\r\n+\r\n+\t\tObjectType objectType = ObjectType.FILE;\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMzNzYxMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418337611", "bodyText": "We could move this at the dao since it's part of the validation logic of the copyEntityReplicationToView method (and should always apply for that method).", "author": "marcomarasca", "createdAt": "2020-04-30T23:05:19Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/TableIndexManagerImpl.java", "diffHunk": "@@ -408,6 +413,34 @@ public long populateViewFromEntityReplication(final Long viewId, final ViewScope\n \t\t// calculate the new CRC32;\r\n \t\treturn tableIndexDao.calculateCRC32ofTableView(viewId);\r\n \t}\r\n+\r\n+\tvoid validateMaxListLengthInAnnotationReplication(ObjectType objectType, long viewId, long viewTypeMask,\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0MzYxMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418343613", "bodyText": "We might want to actually do a group by A.ANNO_KEY with the count, so that we can simplify the select statement.", "author": "marcomarasca", "createdAt": "2020-04-30T23:24:20Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "diffHunk": "@@ -1434,9 +1442,24 @@ public static String createSelectInsertFromObjectReplication(Long viewId, List<C\n \t\t\tbuilder.append(\" AND \").append(OBJECT_REPLICATION_ALIAS).append(\".\").append(OBJECT_REPLICATION_COL_OBJECT_ID)\r\n \t\t\t\t\t.append(\" IN (:\").append(ID_PARAM_NAME).append(\")\");\r\n \t\t}\r\n-\t\tbuilder.append(\" GROUP BY \").append(OBJECT_REPLICATION_ALIAS).append(\".\").append(OBJECT_REPLICATION_COL_OBJECT_ID);\r\n-\t\tbuilder.append(\" ORDER BY \").append(OBJECT_REPLICATION_ALIAS).append(\".\").append(OBJECT_REPLICATION_COL_OBJECT_ID);\r\n-\t\treturn headers;\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Generate the SQL to validate that all of the list columns for a view table from the object replication tables.\r\n+\t * @param viewId\r\n+\t * @param viewTypeMask\r\n+\t * @param annotationNames\r\n+\t * @return\r\n+\t */\r\n+\tpublic static String createAnnotationMaxListLengthSQL(Long viewId, Long viewTypeMask,\r\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t Set<String> annotationNames, boolean filterByRows) {\r\n+\t\tValidateArgument.requiredNotEmpty(annotationNames,\"annotationNames\");\r\n+\r\n+\t\tStringBuilder builder = new StringBuilder();\r\n+\t\tbuilder.append(\"SELECT \");\r\n+\t\tbuildSelectListLength(builder, annotationNames);\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDExMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4027#discussion_r418344111", "bodyText": "You might want to make sure to check the message", "author": "marcomarasca", "createdAt": "2020-04-30T23:25:48Z", "path": "lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java", "diffHunk": "@@ -1930,6 +1933,75 @@ public void testCreateSelectFromObjectReplication(){\n \t\t\t\t+ \" GROUP BY R.OBJECT_ID ORDER BY R.OBJECT_ID\", sql);\r\n \t\tassertEquals(Lists.newArrayList(\"ROW_ID\", \"ROW_VERSION\",\"ROW_ETAG\",\"ROW_BENEFACTOR\",\"_C1_\",\"_C2_\"), headers);\r\n \t}\r\n+\r\n+\t@Test\r\n+\tpublic void createMaxListLengthValidationSQL_singleAnnotation(){\r\n+\t\tSet<String> annotationNames = Sets.newHashSet(\"foo\");\r\n+\t\tLong viewTypeMask = ViewTypeMask.File.getMask();\r\n+\t\tStringBuilder builder = new StringBuilder();\r\n+\t\tboolean filterByRows = false;\r\n+\t\tString sql = SQLUtils.createAnnotationMaxListLengthSQL(viewId, viewTypeMask, annotationNames, filterByRows);\r\n+\r\n+\t\tassertEquals(\"SELECT\"\r\n+\t\t\t\t+ \" MAX(IF(A.ANNO_KEY ='foo', A.LIST_LENGTH, 0)) AS foo\"\r\n+\t\t\t\t+ \" FROM\"\r\n+\t\t\t\t+ \" OBJECT_REPLICATION R\"\r\n+\t\t\t\t+ \" LEFT JOIN ANNOTATION_REPLICATION A\"\r\n+\t\t\t\t+ \" ON(R.OBJECT_TYPE = A.OBJECT_TYPE AND R.OBJECT_ID = A.OBJECT_ID)\"\r\n+\t\t\t\t+ \" WHERE\"\r\n+\t\t\t\t+ \" R.OBJECT_TYPE = :objectType\"\r\n+\t\t\t\t+ \" AND R.PARENT_ID IN (:parentIds)\"\r\n+\t\t\t\t+ \" AND R.SUBTYPE IN ('file')\", sql);\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void createMaxListLengthValidationSQL_multipleAnnotations(){\r\n+\t\tSet<String> annotationNames = Sets.newLinkedHashSet(Arrays.asList(\"foo\", \"bar\",\"baz\"));\r\n+\t\tLong viewTypeMask = ViewTypeMask.File.getMask();\r\n+\t\tStringBuilder builder = new StringBuilder();\r\n+\t\tboolean filterByRows = false;\r\n+\t\tString sql = SQLUtils.createAnnotationMaxListLengthSQL(viewId, viewTypeMask, annotationNames, filterByRows);\r\n+\r\n+\t\tassertEquals(\"SELECT\"\r\n+\t\t\t\t+ \" MAX(IF(A.ANNO_KEY ='foo', A.LIST_LENGTH, 0)) AS foo\"\r\n+\t\t\t\t+ \", MAX(IF(A.ANNO_KEY ='bar', A.LIST_LENGTH, 0)) AS bar\"\r\n+\t\t\t\t+ \", MAX(IF(A.ANNO_KEY ='baz', A.LIST_LENGTH, 0)) AS baz\"\r\n+\t\t\t\t+ \" FROM\"\r\n+\t\t\t\t+ \" OBJECT_REPLICATION R\"\r\n+\t\t\t\t+ \" LEFT JOIN ANNOTATION_REPLICATION A\"\r\n+\t\t\t\t+ \" ON(R.OBJECT_TYPE = A.OBJECT_TYPE AND R.OBJECT_ID = A.OBJECT_ID)\"\r\n+\t\t\t\t+ \" WHERE\"\r\n+\t\t\t\t+ \" R.OBJECT_TYPE = :objectType\"\r\n+\t\t\t\t+ \" AND R.PARENT_ID IN (:parentIds)\"\r\n+\t\t\t\t+ \" AND R.SUBTYPE IN ('file')\", sql);\r\n+\t}\r\n+\r\n+\r\n+\t@Test\r\n+\tpublic void createMaxListLengthValidationSQL_nullAnnotationNames(){\r\n+\t\tSet<String> annotationNames = null;\r\n+\t\tLong viewTypeMask = ViewTypeMask.File.getMask();\r\n+\t\tStringBuilder builder = new StringBuilder();\r\n+\t\tboolean filterByRows = false;\r\n+\r\n+\t\tassertThrows(IllegalArgumentException.class, () ->\r", "originalCommit": "9fc18bd149099ec7cb61ac171560ecf2a18afd85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}