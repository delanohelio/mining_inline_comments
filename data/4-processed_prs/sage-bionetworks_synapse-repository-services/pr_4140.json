{"pr_number": 4140, "pr_title": "PLFM-6298: Process expired approvals", "pr_createdAt": "2020-07-15T23:05:47Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140", "timeline": [{"oid": "08cceb619eec20b57e0f890a5701c94f989fef0e", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/08cceb619eec20b57e0f890a5701c94f989fef0e", "message": "PLFM-6298: Fetch expired approvals and batch revoke", "committedDate": "2020-07-15T21:59:33Z", "type": "commit"}, {"oid": "7cab219f674ef036a206643a1c800a0903ceaae5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/7cab219f674ef036a206643a1c800a0903ceaae5", "message": "PLFM-6298: Added expired approval processing", "committedDate": "2020-07-15T21:59:33Z", "type": "commit"}, {"oid": "df2b4311eca11bd5f020acafeb259c60b27c5024", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/df2b4311eca11bd5f020acafeb259c60b27c5024", "message": "Move things to the proper location", "committedDate": "2020-07-15T21:59:33Z", "type": "commit"}, {"oid": "296e23579c59260bfbd867b1da95a07113b7f1ea", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/296e23579c59260bfbd867b1da95a07113b7f1ea", "message": "PLFM-6298: Add worker to process expired access approvals", "committedDate": "2020-07-15T23:04:49Z", "type": "commit"}, {"oid": "b5747435a433b53a6b0179bd9d4551f19abd19ed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b5747435a433b53a6b0179bd9d4551f19abd19ed", "message": "PLFM-6298: Upgrade test to junit5", "committedDate": "2020-07-15T23:04:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0NzI0MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r455447240", "bodyText": "@transaction", "author": "john-hill", "createdAt": "2020-07-16T00:54:11Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/dbo/dao/dataaccess/DBOAccessApprovalDAOImpl.java", "diffHunk": "@@ -387,11 +406,62 @@ public static String buildAccessorGroupQuery(String accessRequirementId, String\n \t@Override\n \tpublic Set<String> getRequirementsUserHasApprovals(String userId, List<String> accessRequirementIds) {\n \t\tif (accessRequirementIds.isEmpty()) {\n-\t\t\treturn new HashSet<String>();\n+\t\t\treturn Collections.emptySet();\n \t\t}\n \t\tMapSqlParameterSource params = new MapSqlParameterSource();\n \t\tparams.addValue(COL_ACCESS_APPROVAL_REQUIREMENT_ID, accessRequirementIds);\n \t\tparams.addValue(COL_ACCESS_APPROVAL_ACCESSOR_ID, userId);\n \t\treturn Sets.newHashSet(namedJdbcTemplate.queryForList(SELECT_REQUIREMENTS_WITH_APPROVAL, params, String.class));\n \t}\n+\t\n+\t@Override\n+\tpublic List<Long> listExpiredApprovals(Instant expiredAfter, int limit) {\n+\t\tValidateArgument.required(expiredAfter, \"expiredAfter\");\n+\t\tValidateArgument.requirement(limit > 0, \"The limit must be greater than 0.\");\n+\t\t\n+\t\treturn jdbcTemplate.queryForList(SELECT_EXPIRED_APPROVALS, Long.class,\n+\t\t\t\texpiredAfter.toEpochMilli(), \n+\t\t\t\tInstant.now().toEpochMilli(),\n+\t\t\t\tlimit);\n+\t}\n+\t\n+\t@Override", "originalCommit": "b5747435a433b53a6b0179bd9d4551f19abd19ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d15c860a8069e427268133b343a3ecdeafc3ab5a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d15c860a8069e427268133b343a3ecdeafc3ab5a", "message": "PLFM-6298: Change message on revocation", "committedDate": "2020-07-16T06:49:57Z", "type": "commit"}, {"oid": "db43835a35a10495090cf803b22485ff2c557dd0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/db43835a35a10495090cf803b22485ff2c557dd0", "message": "Revert \"Move things to the proper location\"\n\nThis reverts commit df2b4311eca11bd5f020acafeb259c60b27c5024.", "committedDate": "2020-07-16T15:37:41Z", "type": "commit"}, {"oid": "3d5ba16decd6c5402baa9b65289daee33e3e242f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3d5ba16decd6c5402baa9b65289daee33e3e242f", "message": "PLFM-6298: Move revocation logic to its manager", "committedDate": "2020-07-16T16:06:34Z", "type": "commit"}, {"oid": "d50fdbd8708197f2100d41c1f54a4e21b66dd999", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d50fdbd8708197f2100d41c1f54a4e21b66dd999", "message": "PLFM-6298: Added auto-expiring approvals integration test", "committedDate": "2020-07-16T17:47:21Z", "type": "commit"}, {"oid": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/aa95629a003b6ea7d4f6dec7ad584596359aeee7", "message": "PLFM-6298: Added index on expiredOn for access approvals", "committedDate": "2020-07-16T17:47:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0OTIxOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456149219", "bodyText": "check etag changed.", "author": "john-hill", "createdAt": "2020-07-17T00:20:38Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/repo/model/dbo/dao/DBOAccessApprovalDAOImplTest.java", "diffHunk": "@@ -408,4 +380,458 @@ public void testBuildQuery() {\n \t\t\t\t+ \" OFFSET :OFFSET\",\n \t\t\t\tDBOAccessApprovalDAOImpl.buildAccessorGroupQuery(null, null, new Date()));\n \t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithNoExpiredAfter() {\n+\t\t\n+\t\tInstant expiredAfter = null;\n+\t\tint limit = 10;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\t\t\t\n+\t\t\t// Call under test\n+\t\t\taccessApprovalDAO.listExpiredApprovals(expiredAfter, limit);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"expiredAfter is required.\", message);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithWrongLimit() {\n+\t\t\n+\t\tInstant expiredAfter = Instant.now();\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\t\t\t\n+\t\t\t// Call under test\n+\t\t\taccessApprovalDAO.listExpiredApprovals(expiredAfter, 0);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The limit must be greater than 0.\", message);\n+\t\t\n+\t\tmessage = assertThrows(IllegalArgumentException.class, () -> {\t\t\t\n+\t\t\t// Call under test\n+\t\t\taccessApprovalDAO.listExpiredApprovals(expiredAfter, -1);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The limit must be greater than 0.\", message);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovals() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\t// Expire one approval\n+\t\tInstant yesterday = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\t\n+\t\taccessApproval.setExpiredOn(Date.from(yesterday));\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\n+\t\tList<Long> expected = Arrays.asList(accessApproval.getId());\n+\t\t\n+\t\tint limit = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.listExpiredApprovals(yesterday, limit);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithLimit() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\t// Expire one approval\n+\t\tInstant yesterday = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\t\n+\t\taccessApproval.setExpiredOn(Date.from(yesterday));\n+\t\taccessApproval2.setExpiredOn(Date.from(yesterday));\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\n+\t\tList<Long> expected = Arrays.asList(accessApproval.getId());\n+\t\t\n+\t\tint limit = 1;\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.listExpiredApprovals(yesterday, limit);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithNoExpiration() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\t\t\n+\t\tList<Long> expected = Collections.emptyList();\n+\t\t\n+\t\tInstant yesterday = Instant.now().minus(1, ChronoUnit.DAYS);\n+\n+\t\tint limit = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.listExpiredApprovals(yesterday, limit);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithPastExpiration() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\tInstant dayBeforeYesterday = Instant.now().minus(2, ChronoUnit.DAYS);\n+\t\t\n+\t\taccessApproval.setExpiredOn(Date.from(dayBeforeYesterday));\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\t\t\n+\t\tList<Long> expected = Collections.emptyList();\n+\t\t\n+\t\tint limit = 10;\n+\t\t\n+\t\tInstant yesterday = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.listExpiredApprovals(yesterday, limit);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testListExpiredApprovalsWithAlreadyRevoked() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\tInstant yesterday = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\t\n+\t\taccessApproval.setExpiredOn(Date.from(yesterday));\n+\t\t\n+\t\taccessApproval2.setExpiredOn(Date.from(yesterday));\n+\t\taccessApproval2.setState(ApprovalState.REVOKED);\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\t\t\n+\t\tList<Long> expected = Arrays.asList(accessApproval.getId());\n+\t\t\n+\t\tint limit = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.listExpiredApprovals(yesterday, limit);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeBatch() {\n+\t\t\n+\t\taccessApproval = newAccessApproval(individualGroup, accessRequirement);\n+\t\taccessApproval2 = newAccessApproval(individualGroup2, accessRequirement);\n+\t\t\n+\t\taccessApproval = accessApprovalDAO.create(accessApproval);\n+\t\taccessApproval2 = accessApprovalDAO.create(accessApproval2);\n+\t\t\n+\t\tLong userId = Long.valueOf(individualGroup.getId());\n+\t\tList<Long> ids = Arrays.asList(accessApproval.getId(), accessApproval2.getId());\n+\t\t\n+\t\tList<Long> expected = ids;\n+\t\t\n+\t\t// Call under test\n+\t\tList<Long> result = accessApprovalDAO.revokeBatch(userId, ids);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t\t", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MTA3MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456151070", "bodyText": "check for admin", "author": "john-hill", "createdAt": "2020-07-17T00:27:20Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/dataaccess/AccessApprovalManagerImpl.java", "diffHunk": "@@ -172,4 +212,63 @@ public BatchAccessApprovalInfoResponse getAccessApprovalInfo(UserInfo userInfo,\n \t\t}\n \t\treturn response;\n \t}\n+\t\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void revokeGroup(UserInfo userInfo, String accessRequirementId, String submitterId, List<String> accessorIds) {\n+\t\tValidateArgument.required(userInfo, \"The user\");\n+\t\tValidateArgument.required(accessRequirementId, \"The access requirement id\");\n+\t\tValidateArgument.required(submitterId, \"The submitter id\");\n+\t\tValidateArgument.required(accessorIds, \"The list of accessor ids\");\n+\t\t\n+\t\tif (!authorizationManager.isACTTeamMemberOrAdmin(userInfo)) {\n+\t\t\tthrow new UnauthorizedException(\"Only ACT member can perform this action.\");\n+\t\t}\n+\t\t\n+\t\tif (accessorIds.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tfinal List<Long> approvals = accessApprovalDAO.listApprovalsBySubmitter(accessRequirementId, submitterId, accessorIds);\n+\t\tfinal List<Long> revokedApprovals = accessApprovalDAO.revokeBatch(userInfo.getId(), approvals);\n+\t\t\n+\t\tsendUpdateChange(userInfo, revokedApprovals);\n+\t};\n+\t\n+\t@Override\n+\t@WriteTransaction\n+\tpublic int revokeExpiredApprovals(UserInfo userInfo, Instant expiredAfter, int maxBatchSize) {\n+\t\tValidateArgument.required(userInfo, \"The user\");\n+\t\tValidateArgument.required(expiredAfter, \"The expiredAfter\");\n+\t\tValidateArgument.requirement(maxBatchSize > 0, \"The maxBatchSize must be greater than 0.\");\n+\t\tValidateArgument.requirement(expiredAfter.isBefore(Instant.now()), \"The expiredAfter must be a value in the past.\");\n+\t\n+\t\t// Fetch the list of expired approval", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MTMzNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456151334", "bodyText": "empty check on approvals", "author": "john-hill", "createdAt": "2020-07-17T00:28:10Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/dataaccess/AccessApprovalManagerImpl.java", "diffHunk": "@@ -172,4 +212,63 @@ public BatchAccessApprovalInfoResponse getAccessApprovalInfo(UserInfo userInfo,\n \t\t}\n \t\treturn response;\n \t}\n+\t\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void revokeGroup(UserInfo userInfo, String accessRequirementId, String submitterId, List<String> accessorIds) {\n+\t\tValidateArgument.required(userInfo, \"The user\");\n+\t\tValidateArgument.required(accessRequirementId, \"The access requirement id\");\n+\t\tValidateArgument.required(submitterId, \"The submitter id\");\n+\t\tValidateArgument.required(accessorIds, \"The list of accessor ids\");\n+\t\t\n+\t\tif (!authorizationManager.isACTTeamMemberOrAdmin(userInfo)) {\n+\t\t\tthrow new UnauthorizedException(\"Only ACT member can perform this action.\");\n+\t\t}\n+\t\t\n+\t\tif (accessorIds.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\tfinal List<Long> approvals = accessApprovalDAO.listApprovalsBySubmitter(accessRequirementId, submitterId, accessorIds);\n+\t\tfinal List<Long> revokedApprovals = accessApprovalDAO.revokeBatch(userInfo.getId(), approvals);", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MjM0NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456152345", "bodyText": "verify isACT", "author": "john-hill", "createdAt": "2020-07-17T00:31:44Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/dataaccess/AccessApprovalManagerImplUnitTest.java", "diffHunk": "@@ -352,4 +457,268 @@ public void testGetAccessApprovalInfo() {\n \t\tassertTrue(response.getResults().contains(info1));\n \t\tassertTrue(response.getResults().contains(info2));\n \t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithNoUser() {\n+\t\tUserInfo user = null;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tmanager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The user is required.\", message);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithNoExpireAfter() {\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = null;\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tmanager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t}).getMessage();\n+\t\n+\t\tassertEquals(\"The expiredAfter is required.\", message);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithFutureExpireAfter() {\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().plus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tmanager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The expiredAfter must be a value in the past.\", message);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithZeroBatchSize() {\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 0;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tmanager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The maxBatchSize must be greater than 0.\", message);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithNegativeBatchSize() {\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = -1;\n+\t\t\n+\t\tString message = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tmanager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"The maxBatchSize must be greater than 0.\", message);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovals() {\n+\n+\t\tList<Long> expiredApprovals = Arrays.asList(1L, 2L);\n+\t\tList<Long> revokedApprovals = Arrays.asList(2L);\n+\n+\t\twhen(mockAccessApprovalDAO.listExpiredApprovals(any(), anyInt())).thenReturn(expiredApprovals);\n+\t\twhen(mockAccessApprovalDAO.revokeBatch(any(), any())).thenReturn(revokedApprovals);\n+\t\t\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tint result = manager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t\n+\t\tassertEquals(1, result);\n+\t\tverify(mockAccessApprovalDAO).listExpiredApprovals(expiredAfter, maxBatchSize);\n+\t\tverify(mockAccessApprovalDAO).revokeBatch(user.getId(), expiredApprovals);\n+\t\t\n+\t\tArgumentCaptor<MessageToSend> messageCaptor = ArgumentCaptor.forClass(MessageToSend.class);\n+\t\t\n+\t\tverify(mockTransactionMessenger).sendMessageAfterCommit(messageCaptor.capture());\n+\t\t\n+\t\tList<MessageToSend> sentMessages = messageCaptor.getAllValues();\n+\t\t\n+\t\t// Despite 2 initial expired approvals, only one message was sent as only one was revoked\n+\t\tassertEquals(1, sentMessages.size());\n+\t\t\n+\t\tMessageToSend message = sentMessages.get(0);\n+\t\t\n+\t\tassertEquals(user.getId(), message.getUserId());\n+\t\tassertEquals(ObjectType.ACCESS_APPROVAL, message.getObjectType());\n+\t\tassertEquals(revokedApprovals.get(0).toString(), message.getObjectId());\n+\t\tassertEquals(ChangeType.UPDATE, message.getChangeType());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithNoExpiredApprovals() {\n+\n+\t\tList<Long> expiredApprovals = Collections.emptyList();\n+\n+\t\twhen(mockAccessApprovalDAO.listExpiredApprovals(any(), anyInt())).thenReturn(expiredApprovals);\n+\t\t\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tint result = manager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t\n+\t\tassertEquals(0, result);\n+\t\tverify(mockAccessApprovalDAO).listExpiredApprovals(expiredAfter, maxBatchSize);\n+\t\tverifyNoMoreInteractions(mockAccessApprovalDAO);\n+\t\tverifyZeroInteractions(mockTransactionMessenger);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeExpiredApprovalsWithNoRevokedApprovals() {\n+\n+\t\tList<Long> expiredApprovals = Arrays.asList(1L, 2L);\n+\t\tList<Long> revokedApprovals = Collections.emptyList();\n+\n+\t\twhen(mockAccessApprovalDAO.listExpiredApprovals(any(), anyInt())).thenReturn(expiredApprovals);\n+\t\twhen(mockAccessApprovalDAO.revokeBatch(any(), any())).thenReturn(revokedApprovals);\n+\t\t\n+\t\tUserInfo user = userInfo;\n+\t\tInstant expiredAfter = Instant.now().minus(1, ChronoUnit.DAYS);\n+\t\tint maxBatchSize = 10;\n+\t\t\n+\t\t// Call under test\n+\t\tint result = manager.revokeExpiredApprovals(user, expiredAfter, maxBatchSize);\n+\t\t\n+\t\tassertEquals(0, result);\n+\t\tverify(mockAccessApprovalDAO).listExpiredApprovals(expiredAfter, maxBatchSize);\n+\t\tverify(mockAccessApprovalDAO).revokeBatch(user.getId(), expiredApprovals);\n+\t\tverifyNoMoreInteractions(mockAccessApprovalDAO);\n+\t\tverifyZeroInteractions(mockTransactionMessenger);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testRevokeGroupAccessorsAuthorized() {\n+\t\tList<Long> approvals = Arrays.asList(1L, 2L);\n+\t\t\n+\t\twhen(mockAuthorizationManager.isACTTeamMemberOrAdmin(userInfo)).thenReturn(true);\n+\t\twhen(mockAccessApprovalDAO.listApprovalsBySubmitter(any(), any(), any())).thenReturn(approvals);\n+\t\twhen(mockAccessApprovalDAO.revokeBatch(any(), any())).thenReturn(approvals);\n+\t\t\n+\t\tString accessRequirementId = \"2\";\n+\t\tString submitterId = \"1\";\n+\t\tList<String> accessorIds = Arrays.asList(\"1\", \"2\");\n+\t\t\n+\t\t// Call under test\n+\t\tmanager.revokeGroup(userInfo, accessRequirementId, submitterId, accessorIds);\n+\t\t\n+\t\tverify(mockAccessApprovalDAO).listApprovalsBySubmitter(accessRequirementId, submitterId, accessorIds);\n+\t\tverify(mockAccessApprovalDAO).revokeBatch(userInfo.getId(), approvals);\n+\t\t", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1NTM1Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456155352", "bodyText": "will move to manager integration test, and for the worker just a simple did something get revoked.", "author": "john-hill", "createdAt": "2020-07-17T00:42:52Z", "path": "services/workers/src/test/java/org/sagebionetworks/dataaccess/workers/AccessApprovalExpirationWorkerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package org.sagebionetworks.dataaccess.workers;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.assertEquals;\r\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\r\n+\r\n+import java.time.Instant;\r\n+import java.time.temporal.ChronoUnit;\r\n+import java.util.ArrayList;\r\n+import java.util.Date;\r\n+import java.util.List;\r\n+\r\n+import org.junit.jupiter.api.AfterEach;\r\n+import org.junit.jupiter.api.BeforeEach;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.jupiter.api.extension.ExtendWith;\r\n+import org.sagebionetworks.repo.manager.UserManager;\r\n+import org.sagebionetworks.repo.model.ACCESS_TYPE;\r\n+import org.sagebionetworks.repo.model.AccessApproval;\r\n+import org.sagebionetworks.repo.model.AccessApprovalDAO;\r\n+import org.sagebionetworks.repo.model.AccessRequirement;\r\n+import org.sagebionetworks.repo.model.AccessRequirementDAO;\r\n+import org.sagebionetworks.repo.model.ApprovalState;\r\n+import org.sagebionetworks.repo.model.AuthorizationConstants.BOOTSTRAP_PRINCIPAL;\r\n+import org.sagebionetworks.repo.model.ManagedACTAccessRequirement;\r\n+import org.sagebionetworks.repo.model.UserInfo;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.test.context.ActiveProfiles;\r\n+import org.springframework.test.context.ContextConfiguration;\r\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\r\n+\r\n+@ExtendWith(SpringExtension.class)\r\n+@ContextConfiguration(locations = {\"classpath:test-context.xml\"})\r\n+@ActiveProfiles(\"test-dataaccess-worker\")\r\n+public class AccessApprovalExpirationWorkerIntegrationTest {\r\n+\t\r\n+\t@Autowired\r\n+\tprivate UserManager userManager;\r\n+\t\r\n+\t@Autowired\r\n+\tprivate AccessRequirementDAO accessRequirementDao;\r\n+\t\r\n+\t@Autowired\r\n+\tprivate AccessApprovalDAO accessApprovalDao;\r\n+\t\r\n+\t@Autowired\r\n+\tprivate AccessApprovalExpirationWorker worker;\r\n+\t\r\n+\tprivate UserInfo user;\r\n+\tprivate List<Long> accessRequirements;\r\n+\tprivate List<Long> accessApprovals;\r\n+\t\r\n+\t@BeforeEach\r\n+\tpublic void before() {\r\n+\t\tuser = userManager.getUserInfo(BOOTSTRAP_PRINCIPAL.THE_ADMIN_USER.getPrincipalId());\r\n+\t\taccessRequirements = new ArrayList<>();\r\n+\t\taccessApprovals = new ArrayList<>();\r\n+\t}\r\n+\t\r\n+\t@AfterEach\r\n+\tpublic void after() {\r\n+\t\tfor (Long id : accessRequirements) {\r\n+\t\t\taccessRequirementDao.delete(id.toString());\r\n+\t\t}\r\n+\t\tfor (Long id : accessApprovals) {\r\n+\t\t\taccessApprovalDao.delete(id.toString());\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testRun() throws Exception {\r\n+\t\t// Approved and not expiring\r\n+\t\tAccessApproval ap1 = newApproval(newAccessRequirement(), ApprovalState.APPROVED, null);\r\n+\t\t// Already revoked and expired\r\n+\t\tAccessApproval ap2 = newApproval(newAccessRequirement(), ApprovalState.REVOKED, Instant.now().minus(1, ChronoUnit.DAYS));\r\n+\t\t// APPROVED by expired\r\n+\t\tAccessApproval ap3 = newApproval(newAccessRequirement(), ApprovalState.APPROVED, Instant.now().minus(1, ChronoUnit.DAYS));\r\n+\t\t// Already revoked and not expiring\r\n+\t\tAccessApproval ap4 = newApproval(newAccessRequirement(), ApprovalState.REVOKED, null);\r\n+\t\t// Approved and expiring in the future\r\n+\t\tAccessApproval ap5 = newApproval(newAccessRequirement(), ApprovalState.APPROVED, Instant.now().plus(1, ChronoUnit.DAYS));\r\n+\t\t\r\n+\t\t// Simulates the run\r\n+\t\tworker.run(null);\r", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1NjgwNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4140#discussion_r456156805", "bodyText": "can be 30 secs without loop", "author": "john-hill", "createdAt": "2020-07-17T00:48:03Z", "path": "services/workers/src/main/resources/dataaccess-worker-spb.xml", "diffHunk": "@@ -0,0 +1,47 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\r\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\r\n+\txmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:util=\"http://www.springframework.org/schema/util\"\r\n+\txsi:schemaLocation=\"\r\n+       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\r\n+       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\r\n+       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\r\n+       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd\">\r\n+\r\n+\t<!-- Turn on Spring's autoproxy using AspectJ's @Aspect annotations. -->\r\n+\t<aop:aspectj-autoproxy proxy-target-class=\"true\"/>\r\n+\r\n+\t<!-- This worker checks for expired approvals and change their status -->\r\n+\t<bean id=\"accessApprovalExpirationWorker\" class=\"org.sagebionetworks.dataaccess.workers.AccessApprovalExpirationWorker\" scope=\"singleton\" />\r\n+\r\n+\t<!-- Trigger for the access approval expiration worker -->\r\n+\t<bean id=\"accessApprovalExpirationTrigger\" class=\"org.springframework.scheduling.quartz.SimpleTriggerFactoryBean\" scope=\"singleton\">\r\n+\t\t<property name=\"jobDetail\">\r\n+\t\t\t<bean class=\"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean\">\r\n+\t\t\t\t<property name=\"targetObject\">\r\n+\t\t\t\t\t<bean class=\"org.sagebionetworks.workers.util.semaphore.SemaphoreGatedWorkerStack\">\r\n+\t\t\t\t\t\t<constructor-arg index=\"0\" ref=\"countingSemaphore\" />\r\n+\t\t\t\t\t\t<constructor-arg index=\"1\">\r\n+\t\t\t\t\t\t\t<bean class=\"org.sagebionetworks.workers.util.semaphore.SemaphoreGatedWorkerStackConfiguration\">\r\n+\t\t\t\t\t\t\t\t<property name=\"progressingRunner\" ref=\"accessApprovalExpirationWorker\"/>\r\n+\t\t\t\t\t\t\t\t<property name=\"semaphoreLockKey\" value=\"accessApprovalExpirationWorker\" />\r\n+\t\t\t\t\t\t\t\t<property name=\"semaphoreMaxLockCount\" value=\"1\" />\r\n+\t\t\t\t\t\t\t\t<property name=\"semaphoreLockTimeoutSec\" value=\"60\" />\r\n+\t\t\t\t\t\t\t\t<property name=\"gate\">\r\n+\t\t\t\t\t\t\t\t\t<bean class=\"org.sagebionetworks.worker.utils.StackStatusGate\" />\r\n+\t\t\t\t\t\t\t\t</property>\r\n+\r\n+\t\t\t\t\t\t\t</bean>\r\n+\t\t\t\t\t\t</constructor-arg>\r\n+\t\t\t\t\t</bean>\r\n+\t\t\t\t</property>\r\n+\t\t\t\t<property name=\"targetMethod\" value=\"run\" />\r\n+\t\t\t\t<property name=\"concurrent\" value=\"false\" />\r\n+\t\t\t</bean>\r\n+\t\t</property>\r\n+\t\t<property name=\"startDelay\" value=\"1012\" />\r\n+\t\t<!-- Once every 10 minutes -->\r\n+\t\t<property name=\"repeatInterval\" value=\"600000\" />\r", "originalCommit": "aa95629a003b6ea7d4f6dec7ad584596359aeee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08cd503802d5ada3541d11219112d6cf5c5433b3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/08cd503802d5ada3541d11219112d6cf5c5433b3", "message": "PLFM-6298: Added etag update test for approval revocation", "committedDate": "2020-07-17T01:59:23Z", "type": "commit"}, {"oid": "35bc118f51210a181d1927151fdb799a30b01ff1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/35bc118f51210a181d1927151fdb799a30b01ff1", "message": "PLFM-6298: Added auth check for expired approvals revocation", "committedDate": "2020-07-17T02:05:55Z", "type": "commit"}, {"oid": "1bfd0a3bdcd6172a7d8fa460b9608fb2a9b0ef42", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1bfd0a3bdcd6172a7d8fa460b9608fb2a9b0ef42", "message": "PLFM-6298: Simplify the approval expiration worker", "committedDate": "2020-07-17T02:39:42Z", "type": "commit"}]}