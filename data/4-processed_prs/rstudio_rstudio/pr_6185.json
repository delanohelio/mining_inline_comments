{"pr_number": 6185, "pr_title": "don't monitor renv / packrat libraries", "pr_createdAt": "2020-02-07T23:02:02Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6185", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMDU1OA==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377210558", "bodyText": "Why this change? Isn't it generally risky to return a reference to a class member? Since you then just do c_str(), anyways, why not keep it the same? Performance?", "author": "gtritchie", "createdAt": "2020-02-10T17:34:14Z", "path": "src/cpp/core/include/core/FileInfo.hpp", "diffHunk": "@@ -89,7 +89,7 @@ class FileInfo\n    }\n    \n public:\n-   std::string absolutePath() const { return absolutePath_.c_str(); }\n+   const std::string& absolutePath() const { return absolutePath_; }", "originalCommit": "87acc19034f87b8d9135deaf26e46a5e3a6fab45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0MTE1Nw==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377241157", "bodyText": "Right, the old implementation was forcing a copy every time we requested the absolute path of a FileInfo object:\n\nWe call .c_str(), returning a const char*,\nThat's implicitly converted to std::string, constructing a new std::string from that C string,\nThat also implies finding the null terminator when constructing that new std::string.\n\nReturning a const-ref is risky, since it implies someone could store a reference that outlives the parent object. I'll change this back to return a plain std::string -- at least then we're still just creating a std::string from a std::string and the compiler is likely to optimize any copies away anyhow.", "author": "kevinushey", "createdAt": "2020-02-10T18:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMDU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMTE4OA==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377211188", "bodyText": "Out of curiosity, what's resulting in trailing \\0 s?", "author": "gtritchie", "createdAt": "2020-02-10T17:35:33Z", "path": "src/cpp/core/FileInfo.cpp", "diffHunk": "@@ -43,6 +43,8 @@ FileInfo::FileInfo(const std::string& absolutePath,\n       lastWriteTime_(0),\n       isSymlink_(isSymlink)\n {\n+   // some file paths might be constructed with trailing nul bytes; remove those here", "originalCommit": "87acc19034f87b8d9135deaf26e46a5e3a6fab45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0Mzc2Mg==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377243762", "bodyText": "I had this change in my mind (although this should be fixed now):\n1e3bed6\nBut the fact that we were calling .c_str() before made me think we need to be cautious about any other potential strings coming in with trailing null bytes.", "author": "kevinushey", "createdAt": "2020-02-10T18:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMTE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0OTM2MQ==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377249361", "bodyText": "I'm still not clear on this; a std::string initialized from a C string (e.g. char *) always stores the trailing \\0. So I think absolutePath_ = absolutePath_.c_str() is a noop?\nSelf-correction! Only time std::string is required to store \\0 (whether trailing or embedded) is with constructors that take a length argument.", "author": "gtritchie", "createdAt": "2020-02-10T18:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMTE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1MTczNA==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377251734", "bodyText": "Right :-) And we were constructing strings with a length in that particular spot, and I recall seeing that this was actually something like a \"size of allocated space for file path\" rather than \"actual length of file path\" in some cases.", "author": "kevinushey", "createdAt": "2020-02-10T18:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxMTE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyMDE1Mg==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377220152", "bodyText": "What do you think about adding another pref (with no UI) whose value is an array of additional directories to exclude from monitoring? Realize the ideal solution is more along the lines of a .ignore file, but as that's unlikely to land in 1.3 it'd be nice to have an escape hatch for cases where something besides the hardcoded list needs to be excluded.", "author": "jmcphers", "createdAt": "2020-02-10T17:52:17Z", "path": "src/cpp/session/projects/SessionProjectContext.cpp", "diffHunk": "@@ -477,12 +477,13 @@ void ProjectContext::onDeferredInit(bool newSession)\n                             this, _1);\n    cb.onUnregistered = bind(&ProjectContext::fileMonitorTermination,\n                             this, Success());\n+\n+   bool hideObjectFiles = prefs::userPrefs().hideObjectFiles();", "originalCommit": "87acc19034f87b8d9135deaf26e46a5e3a6fab45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0NDYxMg==", "url": "https://github.com/rstudio/rstudio/pull/6185#discussion_r377244612", "bodyText": "That sounds like a good idea to me as well -- it'd be nice to have as an escape hatch.", "author": "kevinushey", "createdAt": "2020-02-10T18:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyMDE1Mg=="}], "type": "inlineReview"}, {"oid": "5f846898e96969b2c90529c403c4f849c097bd71", "url": "https://github.com/rstudio/rstudio/commit/5f846898e96969b2c90529c403c4f849c097bd71", "message": "avoid unnecessary string copy", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "789ba7e2afb30d65289e01edd9b663a2e0eeb48a", "url": "https://github.com/rstudio/rstudio/commit/789ba7e2afb30d65289e01edd9b663a2e0eeb48a", "message": "ensure no nul bytes enter FileInfo paths", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "a0a6dba9dc30a1f4372925d7c0e47fa8ef6d4707", "url": "https://github.com/rstudio/rstudio/commit/a0a6dba9dc30a1f4372925d7c0e47fa8ef6d4707", "message": "don't monitor files in packrat / renv lib\n\nCloses #3267.", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "c1267e762029dea9ff94776e07177e012c41b57d", "url": "https://github.com/rstudio/rstudio/commit/c1267e762029dea9ff94776e07177e012c41b57d", "message": "monitor filter is now un-necessary", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "e1f488952ccc22666497199fa06476ad2723fb13", "url": "https://github.com/rstudio/rstudio/commit/e1f488952ccc22666497199fa06476ad2723fb13", "message": "document intent", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "1ff0176ecb5927c21e2be1730e76fb3a8df308ac", "url": "https://github.com/rstudio/rstudio/commit/1ff0176ecb5927c21e2be1730e76fb3a8df308ac", "message": "return by const-ref is dangerous; don't do it", "committedDate": "2020-02-10T23:41:11Z", "type": "commit"}, {"oid": "1ff0176ecb5927c21e2be1730e76fb3a8df308ac", "url": "https://github.com/rstudio/rstudio/commit/1ff0176ecb5927c21e2be1730e76fb3a8df308ac", "message": "return by const-ref is dangerous; don't do it", "committedDate": "2020-02-10T23:41:11Z", "type": "forcePushed"}, {"oid": "a20b3d1bd5a352d1b5799e03354e5c59211711e6", "url": "https://github.com/rstudio/rstudio/commit/a20b3d1bd5a352d1b5799e03354e5c59211711e6", "message": "add user pref for file monitor ignores", "committedDate": "2020-02-11T00:09:23Z", "type": "commit"}, {"oid": "1d6ce8a4a75cdb1385d6d60a513048d7a70577d4", "url": "https://github.com/rstudio/rstudio/commit/1d6ce8a4a75cdb1385d6d60a513048d7a70577d4", "message": "file -> path", "committedDate": "2020-02-11T00:11:43Z", "type": "commit"}]}