{"pr_number": 6969, "pr_title": "Bring various changes from Pro", "pr_createdAt": "2020-05-27T14:57:26Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6969", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNTYzNQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431205635", "bodyText": "Due to Event.hpp including <gsl/gsl>", "author": "ricardofandrade", "createdAt": "2020-05-27T14:58:29Z", "path": "src/cpp/server/CMakeLists.txt", "diffHunk": "@@ -151,6 +151,7 @@ include_directories(\n    ${SERVER_SYSTEM_INCLUDE_DIRS}\n    ${CORE_INCLUDE_DIRS}\n    ${MONITOR_SOURCE_DIR}/include\n+   ${EXT_SOURCE_DIR}", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjIyOQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431206229", "bodyText": "New code. Trying to minimize changes between open source and pro via overlay.", "author": "ricardofandrade", "createdAt": "2020-05-27T14:58:58Z", "path": "src/cpp/server/ServerOptions.cpp", "diffHunk": "@@ -288,7 +288,7 @@ ProgramStatus Options::read(int argc,\n          value<std::string>(&rsessionWhichR_)->default_value(\"\"),\n          \"path to main R program (e.g. /usr/bin/R)\")\n       (\"rsession-path\", \n-         value<std::string>(&rsessionPath_)->default_value(\"rsession\"),\n+         value<std::string>(&rsessionPath_)->default_value(rsessionExecutable()),", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjU2Mg==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431206562", "bodyText": "New code.", "author": "ricardofandrade", "createdAt": "2020-05-27T14:59:13Z", "path": "src/cpp/server/ServerOptionsOverlay.cpp", "diffHunk": "@@ -50,5 +50,10 @@ void sessionProcessConfigOverlay(core::system::Options* pArgs,\n {\n }\n \n+std::string Options::rsessionExecutable() const", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjkxMw==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431206913", "bodyText": "To minimize differences with Pro. Implementation omitted.", "author": "ricardofandrade", "createdAt": "2020-05-27T14:59:33Z", "path": "src/cpp/server/ServerSessionProxy.cpp", "diffHunk": "@@ -358,6 +377,13 @@ void handleLocalhostResponse(\n    }\n }\n \n+bool handleLicenseError(\n+      boost::shared_ptr<http::AsyncConnection> ptrConnection,\n+      const Error& error)\n+{\n+   return false;", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwODA3NA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431208074", "bodyText": "Minimizing differences with Pro. Many occurrences.", "author": "ricardofandrade", "createdAt": "2020-05-27T15:00:23Z", "path": "src/cpp/server/extras/admin/rstudio-server.in", "diffHunk": "@@ -72,42 +71,45 @@ case \"$1\" in\n         if [ -n \"$2\" ]; then\n            kill -s USR1 $3 $4 $5 $6 $7 $8 $9 $2\n         else\n-           echo \"Must specify PID of session to suspend\"\n+           argType=\"PID\"", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwODk0Mg==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431208942", "bodyText": "We could always return this value instead.", "author": "ricardofandrade", "createdAt": "2020-05-27T15:01:10Z", "path": "src/cpp/session/SessionClientInit.cpp", "diffHunk": "@@ -88,6 +88,15 @@ namespace session {\n namespace client_init {\n namespace {\n \n+std::string userIdentityDisplay(const http::Request& request)\n+{\n+   std::string userIdentity = request.headerValue(kRStudioUserIdentityDisplay);\n+   if (!userIdentity.empty())\n+      return userIdentity;\n+   else\n+      return session::options().userIdentity();", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwOTI0Ng==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431209246", "bodyText": "I missed this one myself.", "author": "ricardofandrade", "createdAt": "2020-05-27T15:01:25Z", "path": "src/cpp/session/include/session/SessionConstants.hpp", "diffHunk": "@@ -85,7 +85,7 @@\n \n #define kUseSecureCookiesSessionOption    \"session-use-secure-cookies\"\n #define kIFrameEmbeddingSessionOption     \"session-iframe-embedding\"\n-#define kLegacyCookiesSessionOption       \"legacy-cookies\"\n+#define kLegacyCookiesSessionOption       \"session-legacy-cookies\"", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwOTgxOA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431209818", "bodyText": "There's an else here in Pro.", "author": "ricardofandrade", "createdAt": "2020-05-27T15:01:55Z", "path": "src/gwt/src/org/rstudio/studio/client/application/Application.java", "diffHunk": "@@ -222,8 +222,19 @@ public void onError(ServerError error)\n             Debug.logError(error);\n             dismissLoadingProgress.execute();\n \n-            globalDisplay_.showErrorMessage(\"RStudio Initialization Error\",\n-                                            error.getUserMessage());\n+            if (!StringUtil.isNullOrEmpty(error.getRedirectUrl()))\n+            {\n+               // error is informing us that we should redirect\n+               // redirect to the specified URL (as a sub URL of the site's root)\n+               String redirectUrl = ApplicationUtils.getHostPageBaseURLWithoutContext(false) + \n+            \t\t   error.getRedirectUrl();\n+               navigateWindowWithDelay(redirectUrl);\n+            }\n+            else\n+            {\n+               globalDisplay_.showErrorMessage(\"RStudio Initialization Error\",\n+                                               error.getUserMessage());\n+            }", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwODM5MQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431208391", "bodyText": "None of these changes should come to open source for this file.", "author": "kfeinauer", "createdAt": "2020-05-27T15:00:41Z", "path": "src/cpp/core/include/core/system/UserObfuscation.hpp", "diffHunk": "@@ -13,6 +13,20 @@\n  *\n  */\n \n+// these macros obfuscate user IDs, with the goal of making it difficult to", "originalCommit": "a75525be6b2982105c64ca8497a92ef6d89c00b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da79642e4625eacee3bc2b898472c46e884fa0ae", "url": "https://github.com/rstudio/rstudio/commit/da79642e4625eacee3bc2b898472c46e884fa0ae", "message": "Backport pro fixes and changes", "committedDate": "2020-05-27T15:23:28Z", "type": "commit"}, {"oid": "da79642e4625eacee3bc2b898472c46e884fa0ae", "url": "https://github.com/rstudio/rstudio/commit/da79642e4625eacee3bc2b898472c46e884fa0ae", "message": "Backport pro fixes and changes", "committedDate": "2020-05-27T15:23:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3Mjk4Mg==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431272982", "bodyText": "Is this really intentional?", "author": "ricardofandrade", "createdAt": "2020-05-27T16:20:41Z", "path": "src/cpp/session/modules/environment/SessionEnvironment.cpp", "diffHunk": "@@ -1291,7 +1291,7 @@ Error initialize()\n       (bind(registerRpcMethod, \"remove_objects\", removeObjects))\n       (bind(registerRpcMethod, \"remove_all_objects\", removeAllObjects))\n       (bind(registerRpcMethod, \"get_environment_state\", getEnv))\n-      (bind(registerRpcMethod, \"get_object_contents\", getObjectContents))\n+      (bind(registerRpcMethod, \"getObjectect_contents\", getObjectContents))", "originalCommit": "da79642e4625eacee3bc2b898472c46e884fa0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MzU5NA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431273594", "bodyText": "Definitely doesn't look like it - I'd blame it and discuss with the owner.", "author": "kfeinauer", "createdAt": "2020-05-27T16:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3Mjk4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3NTg0MA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431275840", "bodyText": "@MariaSemple it feels like an accidental search replace done in Pro.\nThe matching code seems to be:\n\n  \n    \n      rstudio/src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java\n    \n    \n         Line 6512\n      in\n      3de59e3\n    \n    \n    \n    \n\n        \n          \n           private static final String GET_OBJECT_CONTENTS = \"get_object_contents\";", "author": "ricardofandrade", "createdAt": "2020-05-27T16:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3Mjk4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3ODc5OQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431278799", "bodyText": "I'll bring a fix to Pro myself if confirmed \ud83d\ude04", "author": "ricardofandrade", "createdAt": "2020-05-27T16:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3Mjk4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMyNjg5NA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431326894", "bodyText": "Yes, it looks like an accidental search and replace to me!", "author": "MariaSemple", "createdAt": "2020-05-27T17:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3Mjk4Mg=="}], "type": "inlineReview"}, {"oid": "0965366ed2acda351e31a976ac81bfb494d644dc", "url": "https://github.com/rstudio/rstudio/commit/0965366ed2acda351e31a976ac81bfb494d644dc", "message": "Revert unintentional change", "committedDate": "2020-05-27T16:26:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjE5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431312197", "bodyText": "Is this change intentional? It looks odd -- it seems to me the intention really is to negate the whole expression and not just the first piece.", "author": "kevinushey", "createdAt": "2020-05-27T17:19:54Z", "path": "src/cpp/core/markdown/sundown/html_blocks.h", "diffHunk": "@@ -2,7 +2,7 @@\n /* Command-line: gperf -N find_block_tag -H hash_block_tag -C -c -E --ignore-case html_block_names.txt  */\n /* Computed positions: -k'1-2' */\n \n-#if !((' ' == 32) && ('!' == 33) && ('\"' == 34) && ('#' == 35) \\\n+#if (!(' ' == 32) && ('!' == 33) && ('\"' == 34) && ('#' == 35) \\", "originalCommit": "0965366ed2acda351e31a976ac81bfb494d644dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMDc5OQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431330799", "bodyText": "@MariaSemple another file we don't own.", "author": "ricardofandrade", "createdAt": "2020-05-27T17:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NTk4MQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431345981", "bodyText": "Looks like it was also accidental, probably part of the same search/replace that changed the other #if block", "author": "MariaSemple", "createdAt": "2020-05-27T18:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjY5MA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431312690", "bodyText": "This also seems odd?", "author": "kevinushey", "createdAt": "2020-05-27T17:20:45Z", "path": "src/cpp/core/zlib/zutil.h", "diffHunk": "@@ -22,7 +22,7 @@\n #include \"zlib.h\"\n \n #if defined(STDC) && !defined(Z_SOLO)\n-#  if !(defined(_WIN32_WCE) && defined(_MSC_VER))\n+#  if (!defined(_WIN32_WCE) && defined(_MSC_VER))", "originalCommit": "0965366ed2acda351e31a976ac81bfb494d644dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMDUxMg==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431330512", "bodyText": "@MariaSemple this feels like another accidental change since this file is not ours.\nThoughts?", "author": "ricardofandrade", "createdAt": "2020-05-27T17:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0MjQzMg==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431342432", "bodyText": "Yes, I doubt I meant to do this.", "author": "MariaSemple", "createdAt": "2020-05-27T18:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxMjY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNjYwMw==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431316603", "bodyText": "Can we please document with a comment why we choose 32 here? (If I understand correctly this is because it's the maximum username length on Linux.)", "author": "kevinushey", "createdAt": "2020-05-27T17:27:17Z", "path": "src/cpp/monitor/include/monitor/events/Event.hpp", "diffHunk": "@@ -46,48 +47,46 @@ enum EventScope\n #define kSessionAdminSuspend     2006\n #define kSessionAdminTerminate   2007\n \n-class Event\n+#define kMaxEventDataSize     32", "originalCommit": "0965366ed2acda351e31a976ac81bfb494d644dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNzgxMA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431317810", "bodyText": "Should we check and warn if we're truncating the username / data here? I also worry that we would fail to write the null terminator in these cases. That shouldn't be an issue since we memset everything and avoid writing over the final null byte.", "author": "kevinushey", "createdAt": "2020-05-27T17:29:14Z", "path": "src/cpp/monitor/events/Event.cpp", "diffHunk": "@@ -24,6 +24,24 @@\n namespace rstudio {\n namespace monitor {\n \n+Event::Event(int scope,\n+             int id,\n+             const std::string& data,\n+             const std::string& username,\n+             PidType pid,\n+             boost::posix_time::ptime timestamp)\n+   : empty_(false),\n+     scope_(scope),\n+     id_(id),\n+     pid_(pid),\n+     timestamp_(core::date_time::millisecondsSinceEpoch(timestamp))\n+{\n+   ::memset(&username_, 0, kMaxEventDataSize+1);", "originalCommit": "0965366ed2acda351e31a976ac81bfb494d644dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NjU3NA==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431346574", "bodyText": "Events carry very little data. Digits or username only.", "author": "ricardofandrade", "createdAt": "2020-05-27T18:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2MDc1Mw==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431360753", "bodyText": "I still think it's worth validating this is true, since IIUC we do construct these events from somewhat arbitrary inputs; e.g. in eventFromJson():\nhttps://github.com/rstudio/rstudio-pro/blob/4caacd464bb703d5741863fea7b6a530ca7ad045/src/cpp/monitor/http/Server.cpp#L118-L134\nhttps://github.com/rstudio/rstudio-pro/blob/4caacd464bb703d5741863fea7b6a530ca7ad045/src/cpp/monitor/events/EventUtils.cpp#L33-L58", "author": "kevinushey", "createdAt": "2020-05-27T18:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM5MTk1NQ==", "url": "https://github.com/rstudio/rstudio/pull/6969#discussion_r431391955", "bodyText": "Warn log added", "author": "ricardofandrade", "createdAt": "2020-05-27T19:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMxNzgxMA=="}], "type": "inlineReview"}, {"oid": "440d6c7d4f71b7e33e14e5d0ef24a52f85825a9e", "url": "https://github.com/rstudio/rstudio/commit/440d6c7d4f71b7e33e14e5d0ef24a52f85825a9e", "message": "Revert unintentional changes on external code", "committedDate": "2020-05-27T18:08:13Z", "type": "commit"}, {"oid": "bfb87869514c1007d68d23823f5e999aab45f7e7", "url": "https://github.com/rstudio/rstudio/commit/bfb87869514c1007d68d23823f5e999aab45f7e7", "message": "clarifying comment for event size", "committedDate": "2020-05-27T18:09:41Z", "type": "commit"}, {"oid": "aa462a012b3096235ad9d60464a0f13c7fa1b478", "url": "https://github.com/rstudio/rstudio/commit/aa462a012b3096235ad9d60464a0f13c7fa1b478", "message": "Add warning logs for truncated event data", "committedDate": "2020-05-27T19:15:14Z", "type": "commit"}]}