{"pr_number": 7207, "pr_title": "ensure sequential setup for parallel clusters", "pr_createdAt": "2020-06-23T20:25:08Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7207", "timeline": [{"oid": "353e68abf3ce90b3844a5b977db1917f011af4e0", "url": "https://github.com/rstudio/rstudio/commit/353e68abf3ce90b3844a5b977db1917f011af4e0", "message": "prefer sequential setup strategy with parallel", "committedDate": "2020-06-23T20:24:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5Njk5Nw==", "url": "https://github.com/rstudio/rstudio/pull/7207#discussion_r444496997", "bodyText": "Should we only do this if R >= 4.0?", "author": "jmcphers", "createdAt": "2020-06-23T20:47:22Z", "path": "src/cpp/session/modules/SessionPatches.R", "diffHunk": "@@ -13,24 +13,42 @@\n #\n #\n \n-setHook(\n-   packageEvent(\"rstudioapi\", \"onLoad\"),\n-   function(...) {\n+# NOTE: registered hooks will be run immediately if the\n+# package has already been loaded.\n+.rs.addFunction(\"registerPackageLoadHook\", function(package, hook)\n+{\n+   # if the package is already loaded, run the hook;\n+   # otherwise, register a load hook\n+   if (package %in% loadedNamespaces())\n+      hook()\n+   else\n+      setHook(packageEvent(package, \"onLoad\"), hook)\n+})\n \n-      # bail if we're not version 0.7\n-      if (packageVersion(\"rstudioapi\") != \"0.7\")\n-         return()\n+.rs.registerPackageLoadHook(\"rstudioapi\", function(...)\n+{\n+   # bail if we're not version 0.7\n+   if (packageVersion(\"rstudioapi\") != \"0.7\")\n+      return()\n+   \n+   # re-assign the 'selectDirectory()' function\n+   rstudioapi <- asNamespace(\"rstudioapi\")\n+   override <- function(caption = \"Select Directory\",\n+                        label = \"Select\",\n+                        path = rstudioapi::getActiveProject())\n+   {\n+      callFun(\"selectDirectory\", caption, label, path)\n+   }\n+   environment(override) <- rstudioapi\n+   \n+   .rs.replaceBinding(\"selectDirectory\", \"rstudioapi\", override)\n+})\n \n-      # re-assign the 'selectDirectory()' function\n-      rstudioapi <- asNamespace(\"rstudioapi\")\n-      override <- function(caption = \"Select Directory\",\n-                           label = \"Select\",\n-                           path = rstudioapi::getActiveProject())\n-      {\n-         callFun(\"selectDirectory\", caption, label, path)\n-      }\n-      environment(override) <- rstudioapi\n+.rs.registerPackageLoadHook(\"parallel\", function(...)\n+{\n+   # enforce sequential setup of cluster on macOS\n+   # https://github.com/rstudio/rstudio/issues/6692\n+   if (Sys.info()[[\"sysname\"]] == \"Darwin\")\n+      parallel:::setDefaultClusterOptions(setup_strategy = \"sequential\")", "originalCommit": "353e68abf3ce90b3844a5b977db1917f011af4e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNjY1Ng==", "url": "https://github.com/rstudio/rstudio/pull/7207#discussion_r444506656", "bodyText": "setDefaultClusterOptions() does accept \"arbitrary\" options, even those not known by a particular version of parallel, so this should be safe.", "author": "kevinushey", "createdAt": "2020-06-23T21:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5Njk5Nw=="}], "type": "inlineReview"}]}