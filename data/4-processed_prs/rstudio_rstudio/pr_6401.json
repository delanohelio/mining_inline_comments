{"pr_number": 6401, "pr_title": "share web profile across different pages", "pr_createdAt": "2020-03-04T20:05:20Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6401", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzY2Nw==", "url": "https://github.com/rstudio/rstudio/pull/6401#discussion_r387973667", "bodyText": "Don't we need to ensure that a different WebProfile object is constructed for different base urls to ensure the interceptor code (for setting the shared secret header) works properly? This seems like that would break that.", "author": "kfeinauer", "createdAt": "2020-03-04T22:29:59Z", "path": "src/cpp/desktop/DesktopWebProfile.cpp", "diffHunk": "@@ -66,9 +66,23 @@ class Interceptor : public QWebEngineUrlRequestInterceptor\n \n } // end anonymous namespace\n \n-WebProfile::WebProfile(const QUrl& baseUrl, QObject* parent)\n-   : QWebEngineProfile(QString::fromUtf8(\"rstudio-desktop\"), parent)\n+WebProfile* WebProfile::getInstance(const QUrl &baseUrl)\n {\n+   static WebProfile* instance = new WebProfile(baseUrl);\n+   return instance;", "originalCommit": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDEyNg==", "url": "https://github.com/rstudio/rstudio/pull/6401#discussion_r387974126", "bodyText": "Given this code here, can we live without the static one-per-process WebProfile?", "author": "kfeinauer", "createdAt": "2020-03-04T22:31:01Z", "path": "src/cpp/desktop/DesktopWebProfile.cpp", "diffHunk": "@@ -66,9 +66,23 @@ class Interceptor : public QWebEngineUrlRequestInterceptor\n \n } // end anonymous namespace\n \n-WebProfile::WebProfile(const QUrl& baseUrl, QObject* parent)\n-   : QWebEngineProfile(QString::fromUtf8(\"rstudio-desktop\"), parent)\n+WebProfile* WebProfile::getInstance(const QUrl &baseUrl)\n {\n+   static WebProfile* instance = new WebProfile(baseUrl);\n+   return instance;\n+}\n+\n+WebProfile::WebProfile(const QUrl& baseUrl)\n+   : QWebEngineProfile(QStringLiteral(\"rstudio\"))\n+{\n+   // force an in-memory cache of web resources\n+   // otherwise, multiple windows / pages attempting to access\n+   // or mutate the disk cache at the same time can cause\n+   // data corruption to occur\n+   //\n+   // https://github.com/rstudio/rstudio/issues/6201\n+   setHttpCacheType(QWebEngineProfile::MemoryHttpCache);", "originalCommit": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4Mjk3Nw==", "url": "https://github.com/rstudio/rstudio/pull/6401#discussion_r387982977", "bodyText": "Looks like you're correct. I've updated the PR (so now this is the only new code)", "author": "kevinushey", "createdAt": "2020-03-04T22:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDEyNg=="}], "type": "inlineReview"}, {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2", "url": "https://github.com/rstudio/rstudio/commit/98d6811d92673a4ecddfaa6db0abcad1cf438be2", "message": "use in-memory cache of web resources", "committedDate": "2020-03-04T22:52:36Z", "type": "commit"}, {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2", "url": "https://github.com/rstudio/rstudio/commit/98d6811d92673a4ecddfaa6db0abcad1cf438be2", "message": "use in-memory cache of web resources", "committedDate": "2020-03-04T22:52:36Z", "type": "forcePushed"}]}