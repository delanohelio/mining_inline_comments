{"pr_number": 7497, "pr_title": "allow customization of default Python interpreter used by reticulate", "pr_createdAt": "2020-07-30T20:47:28Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7497", "timeline": [{"oid": "5d33981a13193c8cea8a72cbd61beaa38fbdf76c", "url": "https://github.com/rstudio/rstudio/commit/5d33981a13193c8cea8a72cbd61beaa38fbdf76c", "message": "initial scaffolding for Python environment work [WIP]", "committedDate": "2020-08-03T17:37:45Z", "type": "commit"}, {"oid": "e0f81ee1633b7b0ce0d6d39777bcfb2b2e7d838d", "url": "https://github.com/rstudio/rstudio/commit/e0f81ee1633b7b0ce0d6d39777bcfb2b2e7d838d", "message": "user pref for python default interpreter", "committedDate": "2020-08-03T17:37:45Z", "type": "commit"}, {"oid": "14beac232dd1aae59e9b8e01266f6c5cb406c24d", "url": "https://github.com/rstudio/rstudio/commit/14beac232dd1aae59e9b8e01266f6c5cb406c24d", "message": "wire up prefs", "committedDate": "2020-08-03T17:37:46Z", "type": "commit"}, {"oid": "7c50e3dfaff1a5f3c2886e9ef0fabb3b22281df3", "url": "https://github.com/rstudio/rstudio/commit/7c50e3dfaff1a5f3c2886e9ef0fabb3b22281df3", "message": "tidying up a bit", "committedDate": "2020-08-03T17:37:46Z", "type": "commit"}, {"oid": "64bdf919ae36487bfe1d261281447220bee7a8fd", "url": "https://github.com/rstudio/rstudio/commit/64bdf919ae36487bfe1d261281447220bee7a8fd", "message": "remove now-unused file", "committedDate": "2020-08-03T17:37:46Z", "type": "commit"}, {"oid": "3885692baa259547b83be7fd2f56354c166a07de", "url": "https://github.com/rstudio/rstudio/commit/3885692baa259547b83be7fd2f56354c166a07de", "message": "a default value must be set", "committedDate": "2020-08-03T17:37:46Z", "type": "commit"}, {"oid": "3885692baa259547b83be7fd2f56354c166a07de", "url": "https://github.com/rstudio/rstudio/commit/3885692baa259547b83be7fd2f56354c166a07de", "message": "a default value must be set", "committedDate": "2020-08-03T17:37:46Z", "type": "forcePushed"}, {"oid": "67084c68a30672f0826022c552b01c624f88e685", "url": "https://github.com/rstudio/rstudio/commit/67084c68a30672f0826022c552b01c624f88e685", "message": "also provide bit of UI verifying Python version", "committedDate": "2020-08-03T21:08:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MDg5Mg==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r464670892", "bodyText": "I added these helpers because it's easier to use autocomplete to help with these rather than remember if we're comparing with \"Unix\" vs. \"unix\", or \"Windows\" vs \"windows\", and so on.", "author": "kevinushey", "createdAt": "2020-08-03T21:26:10Z", "path": "src/cpp/r/R/Tools.R", "diffHunk": "@@ -1134,3 +1134,18 @@ environment(.rs.Env[[\".rs.addFunction\"]]) <- .rs.Env\n    cap <- capabilities(what)\n    length(cap) && cap\n })\n+\n+.rs.addFunction(\"initTools\", function()\n+{\n+   ostype <- .Platform$OS.type\n+   info <- Sys.info()\n+   envir <- .rs.toolsEnv()\n+   \n+   assign(\".rs.platform.isUnix\",    ostype == \"unix\",              envir = envir)", "originalCommit": "67084c68a30672f0826022c552b01c624f88e685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MTM2NQ==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r464671365", "bodyText": "The changes here (and below) were made to ensure that value change events fire when the underlying textbox itself is edited, which is necessary for the case where the textbox is not read-only.", "author": "kevinushey", "createdAt": "2020-08-03T21:27:15Z", "path": "src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java", "diffHunk": "@@ -86,6 +87,11 @@ protected TextBoxWithButton(String label,\n       textBox_ = new TextBox();\n       textBox_.setWidth(\"100%\");\n       textBox_.setReadOnly(readOnly);\n+      \n+      textBox_.addValueChangeHandler((ValueChangeEvent<String> event) ->", "originalCommit": "67084c68a30672f0826022c552b01c624f88e685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "60ca6ef3752b1e2b0fe543a42d69aae7143b6254", "url": "https://github.com/rstudio/rstudio/commit/60ca6ef3752b1e2b0fe543a42d69aae7143b6254", "message": "tweaks", "committedDate": "2020-08-04T16:07:30Z", "type": "commit"}, {"oid": "6445fe7eed587ce64f31a1279891121ec6dc39c2", "url": "https://github.com/rstudio/rstudio/commit/6445fe7eed587ce64f31a1279891121ec6dc39c2", "message": "catch errors when listing conda envs", "committedDate": "2020-08-04T17:41:25Z", "type": "commit"}, {"oid": "5516b530322e3d818a36447e3ab50276917b0d76", "url": "https://github.com/rstudio/rstudio/commit/5516b530322e3d818a36447e3ab50276917b0d76", "message": "update RETICULATE_PYTHON on init", "committedDate": "2020-08-04T18:21:55Z", "type": "commit"}, {"oid": "3ec31aef2460d0443cfacc12e02f6379b85c49c7", "url": "https://github.com/rstudio/rstudio/commit/3ec31aef2460d0443cfacc12e02f6379b85c49c7", "message": "allow restart of session only when editing Python", "committedDate": "2020-08-04T18:52:23Z", "type": "commit"}, {"oid": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "url": "https://github.com/rstudio/rstudio/commit/52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "message": "detect case where RETICULATE_PYTHON set in .Rprofile", "committedDate": "2020-08-04T19:54:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDAxOQ==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r465980019", "bodyText": "Should use constant PYTHON_PLACEHOLDER_TEXT to ensure they match?", "author": "gtritchie", "createdAt": "2020-08-05T20:19:33Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PythonPreferencesPane.java", "diffHunk": "@@ -0,0 +1,319 @@\n+/*\n+ * PythonPreferencesPane.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+package org.rstudio.studio.client.workbench.prefs.views;\n+\n+import org.rstudio.core.client.Debug;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.prefs.RestartRequirement;\n+import org.rstudio.core.client.resources.ImageResource2x;\n+import org.rstudio.core.client.widget.InfoBar;\n+import org.rstudio.core.client.widget.OperationWithInput;\n+import org.rstudio.core.client.widget.TextBoxWithButton;\n+import org.rstudio.studio.client.server.ServerError;\n+import org.rstudio.studio.client.server.ServerRequestCallback;\n+import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;\n+import org.rstudio.studio.client.workbench.prefs.views.python.PythonInterpreterListEntryUi;\n+import org.rstudio.studio.client.workbench.prefs.views.python.PythonInterpreterSelectionDialog;\n+\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.event.dom.client.BlurEvent;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.event.dom.client.ClickHandler;\n+import com.google.gwt.event.logical.shared.ValueChangeEvent;\n+import com.google.gwt.resources.client.ClientBundle;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.resources.client.ImageResource;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.SimplePanel;\n+import com.google.inject.Inject;\n+\n+public class PythonPreferencesPane extends PreferencesPane\n+{\n+   @Inject\n+   public PythonPreferencesPane(PythonDialogResources res,\n+                                PythonServerOperations server)\n+   {\n+      res_ = res;\n+      server_ = server;\n+      \n+      add(headerLabel(\"Python\"));\n+      \n+      mismatchWarningBar_ = new InfoBar(InfoBar.WARNING);\n+      mismatchWarningBar_.setText(\n+            \"The active Python interpreter has been changed by an R startup script.\");\n+      mismatchWarningBar_.setVisible(false);\n+      add(spaced(mismatchWarningBar_));\n+      \n+      tbPythonInterpreter_ = new TextBoxWithButton(\n+            \"Python interpreter:\",\n+            \"(No interpreter selected)\",", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTE3MQ==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r466605171", "bodyText": "Yes, we should! Thanks for catching that.", "author": "kevinushey", "createdAt": "2020-08-06T18:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MDM3Ng==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r465980376", "bodyText": "Typo? \"interpreted\" vs \"interpreter\"?", "author": "gtritchie", "createdAt": "2020-08-05T20:20:10Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PythonPreferencesPane.java", "diffHunk": "@@ -0,0 +1,319 @@\n+/*\n+ * PythonPreferencesPane.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+package org.rstudio.studio.client.workbench.prefs.views;\n+\n+import org.rstudio.core.client.Debug;\n+import org.rstudio.core.client.ElementIds;\n+import org.rstudio.core.client.StringUtil;\n+import org.rstudio.core.client.prefs.RestartRequirement;\n+import org.rstudio.core.client.resources.ImageResource2x;\n+import org.rstudio.core.client.widget.InfoBar;\n+import org.rstudio.core.client.widget.OperationWithInput;\n+import org.rstudio.core.client.widget.TextBoxWithButton;\n+import org.rstudio.studio.client.server.ServerError;\n+import org.rstudio.studio.client.server.ServerRequestCallback;\n+import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;\n+import org.rstudio.studio.client.workbench.prefs.views.python.PythonInterpreterListEntryUi;\n+import org.rstudio.studio.client.workbench.prefs.views.python.PythonInterpreterSelectionDialog;\n+\n+import com.google.gwt.core.client.GWT;\n+import com.google.gwt.event.dom.client.BlurEvent;\n+import com.google.gwt.event.dom.client.ClickEvent;\n+import com.google.gwt.event.dom.client.ClickHandler;\n+import com.google.gwt.event.logical.shared.ValueChangeEvent;\n+import com.google.gwt.resources.client.ClientBundle;\n+import com.google.gwt.resources.client.CssResource;\n+import com.google.gwt.resources.client.ImageResource;\n+import com.google.gwt.user.client.ui.FlowPanel;\n+import com.google.gwt.user.client.ui.SimplePanel;\n+import com.google.inject.Inject;\n+\n+public class PythonPreferencesPane extends PreferencesPane\n+{\n+   @Inject\n+   public PythonPreferencesPane(PythonDialogResources res,\n+                                PythonServerOperations server)\n+   {\n+      res_ = res;\n+      server_ = server;\n+      \n+      add(headerLabel(\"Python\"));\n+      \n+      mismatchWarningBar_ = new InfoBar(InfoBar.WARNING);\n+      mismatchWarningBar_.setText(\n+            \"The active Python interpreter has been changed by an R startup script.\");\n+      mismatchWarningBar_.setVisible(false);\n+      add(spaced(mismatchWarningBar_));\n+      \n+      tbPythonInterpreter_ = new TextBoxWithButton(\n+            \"Python interpreter:\",\n+            \"(No interpreter selected)\",\n+            \"Select...\",\n+            null,\n+            ElementIds.TextBoxButtonId.PYTHON_DEFAULT_INTERPRETER,\n+            true,\n+            new ClickHandler()\n+            {\n+               @Override\n+               public void onClick(ClickEvent event)\n+               {\n+                  getProgressIndicator().onProgress(\"Finding interpreters...\");\n+                  \n+                  server_.pythonFindInterpreters(new ServerRequestCallback<PythonInterpreters>()\n+                  {\n+                     @Override\n+                     public void onResponseReceived(final PythonInterpreters response)\n+                     {\n+                        getProgressIndicator().onCompleted();\n+                        \n+                        PythonInterpreterSelectionDialog dialog =\n+                              new PythonInterpreterSelectionDialog(\n+                                    response.getPythonInterpreters(),\n+                                    new OperationWithInput<PythonInterpreter>()\n+                                    {\n+                                       @Override\n+                                       public void execute(PythonInterpreter input)\n+                                       {\n+                                          String path = input.getPath();\n+                                          tbPythonInterpreter_.setText(path);\n+                                       }\n+                                    });\n+                        \n+                        dialog.showModal(true);\n+                     }\n+                     \n+                     @Override\n+                     public void onError(ServerError error)\n+                     {\n+                        String message =\n+                              \"Error finding Python interpreters: \" +\n+                              error.getUserMessage();\n+                        getProgressIndicator().onError(message);\n+                        \n+                        Debug.logError(error);\n+                     }\n+                  });\n+               }\n+            });\n+      \n+      tbPythonInterpreter_.addValueChangeHandler((ValueChangeEvent<String> event) ->\n+      {\n+         updateDescription();\n+      });\n+      \n+      tbPythonInterpreter_.addDomHandler((BlurEvent event) ->\n+      {\n+         updateDescription();\n+      }, BlurEvent.getType());\n+      \n+      tbPythonInterpreter_.setWidth(\"420px\");\n+      tbPythonInterpreter_.setText(PYTHON_PLACEHOLDER_TEXT);\n+      tbPythonInterpreter_.setReadOnly(false);\n+      add(lessSpaced(tbPythonInterpreter_));\n+      \n+      add(spaced(container_));\n+      \n+   }\n+   \n+   private void clearDescription()\n+   {\n+      container_.setWidget(new FlowPanel());\n+   }\n+   \n+   private void updateDescription()\n+   {\n+      String path = tbPythonInterpreter_.getText();\n+      if (StringUtil.isNullOrEmpty(path) ||\n+          StringUtil.equals(path, PYTHON_PLACEHOLDER_TEXT))\n+      {\n+         clearDescription();\n+         return;\n+      }\n+      \n+      server_.pythonDescribeInterpreter(\n+            tbPythonInterpreter_.getText(),\n+            new ServerRequestCallback<PythonInterpreter>()\n+            {\n+               @Override\n+               public void onResponseReceived(PythonInterpreter info)\n+               {\n+                  updateDescription(info);\n+               }\n+\n+               @Override\n+               public void onError(ServerError error)\n+               {\n+                  Debug.logError(error);\n+               }\n+            });\n+   }\n+   \n+   private void updateDescription(PythonInterpreter info)\n+   {\n+      if (!info.isValid())\n+      {\n+         String reason = info.getInvalidReason();\n+         if (StringUtil.isNullOrEmpty(reason))\n+            reason = \"The selected Python interpreter appears to be invalid.\";\n+         \n+         InfoBar bar = new InfoBar(InfoBar.WARNING);\n+         bar.setText(reason);\n+         container_.setWidget(bar);\n+      }\n+      else\n+      {\n+         PythonInterpreterListEntryUi ui = new PythonInterpreterListEntryUi(info);\n+         ui.addStyleName(RES.styles().description());\n+         \n+         String type = info.getType();\n+         \n+         if (type == null)\n+         {\n+            type = \"[Unknown]\";\n+         }\n+         else if (type == \"virtualenv\")\n+         {\n+            type = \"Virtual Environment\";\n+         }\n+         else if (type == \"conda\")\n+         {\n+            type = \"Conda Environment\";\n+         }\n+         else if (type == \"system\")\n+         {\n+            type = \"System Interpreter\";\n+         }\n+         \n+         ui.getPath().setText(\"[\" + type + \"]\");\n+         container_.setWidget(ui);\n+      }\n+   }\n+   \n+   private void checkForMismatch(PythonInterpreter activeInterpreter)\n+   {\n+      // nothing to do if there isn't an active interpreter\n+      if (StringUtil.isNullOrEmpty(activeInterpreter.getPath()))\n+      {\n+         mismatchWarningBar_.setVisible(false);\n+         return;\n+      }\n+      \n+      // nothing to do if the user hasn't changed the configured Python\n+      String requestedPath = tbPythonInterpreter_.getText();\n+      boolean isSet =\n+            !StringUtil.isNullOrEmpty(requestedPath) &&\n+            !StringUtil.equals(requestedPath, PYTHON_PLACEHOLDER_TEXT);\n+      \n+      if (!isSet)\n+      {\n+         mismatchWarningBar_.setVisible(false);\n+         return;\n+      }\n+      \n+      // toggle visibility\n+      boolean mismatch =\n+            !StringUtil.equals(requestedPath, activeInterpreter.getPath());\n+      \n+      mismatchWarningBar_.setVisible(mismatch);\n+   }\n+\n+   @Override\n+   public ImageResource getIcon()\n+   {\n+      return new ImageResource2x(res_.iconPython2x());\n+   }\n+\n+   @Override\n+   public String getName()\n+   {\n+      return \"Python\";\n+   }\n+\n+   @Override\n+   protected void initialize(UserPrefs prefs)\n+   {\n+      String pythonPath = prefs.pythonDefaultInterpreter().getValue();\n+      if (!StringUtil.isNullOrEmpty(pythonPath))\n+         tbPythonInterpreter_.setText(pythonPath);\n+      \n+      server_.pythonActiveInterpreter(new ServerRequestCallback<PythonInterpreter>()\n+      {\n+         @Override\n+         public void onResponseReceived(PythonInterpreter response)\n+         {\n+            checkForMismatch(response);\n+         }\n+\n+         @Override\n+         public void onError(ServerError error)\n+         {\n+            Debug.logError(error);\n+         }\n+      });\n+   }\n+   \n+   @Override\n+   public RestartRequirement onApply(UserPrefs prefs)\n+   {\n+      RestartRequirement requirement = super.onApply(prefs);\n+      \n+      String oldValue = prefs.pythonDefaultInterpreter().getGlobalValue();\n+      String newValue = tbPythonInterpreter_.getText();\n+      \n+      boolean isSet =\n+            !StringUtil.isNullOrEmpty(newValue) &&\n+            !StringUtil.equals(newValue, PYTHON_PLACEHOLDER_TEXT);\n+      \n+      if (isSet && !StringUtil.equals(oldValue, newValue))\n+      {\n+         prefs.pythonDefaultInterpreter().setGlobalValue(newValue);\n+         requirement.setSessionRestartRequired(true);\n+      }\n+      \n+      return requirement;\n+   }\n+   \n+   \n+\n+   public interface Styles extends CssResource\n+   {\n+      String description();\n+      String invalid();\n+   }\n+\n+   public interface Resources extends ClientBundle\n+   {\n+      @Source(\"PythonPreferencesPane.css\")\n+      Styles styles();\n+   }\n+\n+   private final InfoBar mismatchWarningBar_;\n+   private final PythonDialogResources res_;\n+   private final PythonServerOperations server_;\n+   private final TextBoxWithButton tbPythonInterpreter_;\n+   private final SimplePanel container_ = new SimplePanel();\n+   \n+   private PythonInterpreter activeInterpreter_;\n+   \n+   private static final String PYTHON_PLACEHOLDER_TEXT = \"(No interpreted selected)\";", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MjA2Mw==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r465982063", "bodyText": "The listbox should have a label for screen readers (for a visual user it's obvious what it's for but it's an unlabeled control to a screen reader):\nwidgets_.setAriaLabel(\"Python Interpreters\");", "author": "gtritchie", "createdAt": "2020-08-05T20:23:25Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterSelectionDialog.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * PythonInterpreterSelectionDialog.java\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+package org.rstudio.studio.client.workbench.prefs.views.python;\n+\n+import org.rstudio.core.client.js.JsUtil;\n+import org.rstudio.core.client.widget.ModalDialog;\n+import org.rstudio.core.client.widget.OperationWithInput;\n+import org.rstudio.core.client.widget.WidgetListBox;\n+import org.rstudio.studio.client.workbench.prefs.views.PythonInterpreter;\n+\n+import com.google.gwt.aria.client.Roles;\n+import com.google.gwt.core.client.JsArray;\n+import com.google.gwt.user.client.ui.Widget;\n+\n+public class PythonInterpreterSelectionDialog extends ModalDialog<PythonInterpreter>\n+{\n+   public PythonInterpreterSelectionDialog(final JsArray<PythonInterpreter> interpreters,\n+                                           final OperationWithInput<PythonInterpreter> operation)\n+   {\n+      super(\"Python Interpreters\", Roles.getDialogRole(), operation);\n+      setOkButtonCaption(\"Select\");\n+      \n+      widgets_ = new WidgetListBox<PythonInterpreterListEntryUi>();", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MzA1NA==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r465983054", "bodyText": "Noticed this file is indented with tabs instead of spaces.", "author": "gtritchie", "createdAt": "2020-08-05T20:25:15Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterListEntryUi.ui.xml", "diffHunk": "@@ -0,0 +1,40 @@\n+<!DOCTYPE ui:UiBinder SYSTEM \"http://dl.google.com/gwt/DTD/xhtml.ent\">\n+<ui:UiBinder xmlns:ui=\"urn:ui:com.google.gwt.uibinder\"\n+\txmlns:g=\"urn:import:com.google.gwt.user.client.ui\">\n+\t", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTY1NA==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r466605654", "bodyText": "shakes fist at Eclipse", "author": "kevinushey", "createdAt": "2020-08-06T18:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4MzA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk4NjE4MA==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r465986180", "bodyText": "This creates an unlabeled image (no alt text) so a screen reader will read the underlying filename which is a long guid-like identifier.\nOne option is to use DecorativeImage instead (which sets empty alt text), but since this icon communicates information, we should have a meaningful alt-text, instead, e.g. \"Conda\", \"VirtualEnv\", \"Python\".", "author": "gtritchie", "createdAt": "2020-08-05T20:31:24Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterListEntryUi.ui.xml", "diffHunk": "@@ -0,0 +1,40 @@\n+<!DOCTYPE ui:UiBinder SYSTEM \"http://dl.google.com/gwt/DTD/xhtml.ent\">\n+<ui:UiBinder xmlns:ui=\"urn:ui:com.google.gwt.uibinder\"\n+\txmlns:g=\"urn:import:com.google.gwt.user.client.ui\">\n+\t\n+\t<ui:style>\n+\t\n+\t.iconContainer {\n+\t\twidth: 24px;\n+\t\theight: 24px;\n+\t\ttext-align: center;\n+\t\tvertical-align: middle;\n+\t}\n+\t\n+\t.icon {\n+\t}\n+\t\n+\t.version {\n+\t\tpadding: 4px;\n+\t\tmin-width: 100px;\n+\t}\n+\t\n+\t.path {\n+\t\tpadding: 4px;\n+\t}\n+\t\n+\t</ui:style>\n+\t\n+\t<g:HorizontalPanel>\n+\t\t\n+\t\t<g:FlowPanel styleName='{style.iconContainer}'>\n+\t\t\t<g:Image styleName='{style.icon}' ui:field=\"uiIcon_\"></g:Image>", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4MzY1OQ==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r466583659", "bodyText": "Should this also check for python.exe on Windows?", "author": "jmcphers", "createdAt": "2020-08-06T17:48:21Z", "path": "src/cpp/session/modules/SessionPythonEnvironments.R", "diffHunk": "@@ -0,0 +1,274 @@\n+#\n+# SessionPythonEnvironments.R\n+#\n+# Copyright (C) 2020 by RStudio, PBC\n+#\n+# Unless you have received this program directly from RStudio pursuant\n+# to the terms of a commercial license agreement with RStudio, then\n+# this program is licensed to you under the terms of version 3 of the\n+# GNU Affero General Public License. This program is distributed WITHOUT\n+# ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+# AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+#\n+#\n+\n+.rs.addJsonRpcHandler(\"python_active_interpreter\", function()\n+{\n+   pythonPath <- Sys.getenv(\"RETICULATE_PYTHON\", unset = NA)\n+   \n+   info <- if (is.na(pythonPath))\n+   {\n+      .rs.python.invalidInterpreter(\n+         path = pythonPath,\n+         type = NULL,\n+         reason = \"RETICULATE_PYTHON is unset.\"\n+      )\n+   }\n+   else\n+   {\n+      .rs.python.getPythonInfo(pythonPath, strict = TRUE)\n+   }\n+   \n+   .rs.scalarListFromList(info)\n+})\n+\n+.rs.addJsonRpcHandler(\"python_find_interpreters\", function()\n+{\n+   .rs.python.findPythonInterpreters()\n+})\n+\n+.rs.addJsonRpcHandler(\"python_describe_interpreter\", function(pythonPath)\n+{\n+   .rs.python.describeInterpreter(pythonPath)\n+})\n+\n+.rs.addFunction(\"python.execute\", function(python, code)\n+{\n+   python <- normalizePath(python, winslash = \"/\", mustWork = TRUE)\n+   \n+   args <- c(\"-E\", \"-c\", shQuote(code))\n+   result <- suppressWarnings(\n+      system2(python, args, stdout = TRUE, stderr = TRUE)\n+   )\n+   \n+   # propagate failure as error\n+   status <- .rs.nullCoalesce(attr(result, \"status\", exact = TRUE), 0L)\n+   if (!identical(status, 0L))\n+      .rs.stopf(\"error retrieving Python version [error code %i]\", status)\n+   \n+   paste(result, collapse = \"\\n\")\n+})\n+\n+.rs.addFunction(\"python.getPythonVersion\", function(pythonPath)\n+{\n+   .rs.python.execute(pythonPath, \"import platform; print(platform.python_version())\")\n+})\n+\n+.rs.addFunction(\"python.getPythonDescription\", function(pythonPath)\n+{\n+   .rs.python.execute(pythonPath, \"import sys; print(sys.version)\")\n+})\n+\n+.rs.addFunction(\"python.getPythonInfo\", function(path, strict)\n+{\n+   # default to concluding python binary path == requested path\n+   pythonPath <- path\n+   \n+   # if this is the path to an existing file, use the directory path\n+   info <- file.info(path, extra_cols = FALSE)\n+   if (identical(info$isdir, FALSE))\n+      path <- dirname(path)\n+   \n+   # if this is the path to the 'root' of an environment,\n+   # start from the associated bin / scripts directory\n+   binExt <- if (.rs.platform.isWindows) \"Scripts\" else \"bin\"\n+   binPath <- file.path(path, binExt)\n+   if (file.exists(binPath))\n+      path <- binPath\n+      \n+   # now form the python path\n+   if (!strict)\n+   {\n+      exe <- if (.rs.platform.isWindows) \"python.exe\" else \"python\"\n+      pythonPath <- file.path(path, exe)\n+   }\n+   \n+   # if this python doesn't exist, bail\n+   if (!file.exists(pythonPath))\n+   {\n+      info <- .rs.python.invalidInterpreter(\n+         path = pythonPath,\n+         type = NULL,\n+         reason = \"There is no Python interpreter available at this location.\"\n+      )\n+      \n+      return(info)\n+   }\n+   \n+   # check for conda environment\n+   # (look for folders normally seen in conda installations)\n+   condaFiles <- c(\"../conda-meta\", \"../condabin\")\n+   condaPaths <- file.path(path, condaFiles)\n+   if (any(file.exists(condaPaths)))\n+      return(.rs.python.interpreterInfo(pythonPath, \"conda\"))\n+ \n+   # check for virtual environment\n+   # (look for files normally seen in virtual envs)\n+   venvFiles <- c(\"activate\", \"pyvenv.cfg\", \"../pyvenv.cfg\")\n+   venvPaths <- file.path(path, venvFiles)\n+   if (any(file.exists(venvPaths)))\n+      return(.rs.python.interpreterInfo(pythonPath, \"virtualenv\"))\n+   \n+   # default to assuming a system interpreter\n+   .rs.python.interpreterInfo(pythonPath, \"system\")\n+   \n+})\n+\n+.rs.addFunction(\"python.interpreterInfo\", function(path, type)\n+{\n+   # defaults for version, description\n+   valid <- TRUE\n+   version <- \"[unknown]\"\n+   description <- \"[unknown]\"\n+   \n+   # determine interpreter version\n+   version <- tryCatch(\n+      .rs.python.getPythonVersion(path),\n+      error = function(e) {\n+         valid <<- FALSE\n+         conditionMessage(e)\n+      }\n+   )\n+   \n+   # determine interpreter description\n+   description <- tryCatch(\n+      .rs.python.getPythonDescription(path),\n+      error = function(e) {\n+         valid <<- FALSE\n+         conditionMessage(e)\n+      }\n+   )\n+   \n+   list(\n+      path        = .rs.createAliasedPath(path),\n+      type        = type,\n+      version     = version,\n+      description = description,\n+      valid       = valid,\n+      reason      = NULL\n+   )\n+})\n+\n+.rs.addFunction(\"python.invalidInterpreter\", function(path, type, reason)\n+{\n+   list(\n+      path        = .rs.createAliasedPath(path),\n+      type        = type,\n+      version     = NULL,\n+      description = NULL,\n+      valid       = FALSE,\n+      reason      = reason\n+   )\n+})\n+\n+.rs.addFunction(\"python.findPythonInterpreters\", function()\n+{\n+   interpreters <- c(\n+      .rs.python.findPythonSystemInterpreters(),\n+      .rs.python.findPythonVirtualEnvironments(),\n+      .rs.python.findPythonCondaEnvironments()\n+   )\n+   \n+   default <- Sys.getenv(\"RETICULATE_PYTHON\", unset = \"\")\n+   \n+   list(\n+      python_interpreters = .rs.scalarListFromList(interpreters),\n+      default_interpreter = .rs.scalar(default)\n+   )\n+   \n+})\n+\n+.rs.addFunction(\"python.findPythonSystemInterpreters\", function()\n+{\n+   interpreters <- list()\n+   \n+   # look for interpreters on the PATH\n+   paths <- strsplit(Sys.getenv(\"PATH\"), split = .Platform$path.sep, fixed = TRUE)[[1]]\n+   for (path in paths) {\n+      \n+      pythonPath <- file.path(path, \"python\")", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4NDk0Ng==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r466584946", "bodyText": "If this user pref changes at runtime, do we want to forward that change to RETICULATE_PYTHON (if the old value of the var was also derived from the pref)?", "author": "jmcphers", "createdAt": "2020-08-06T17:50:37Z", "path": "src/cpp/session/modules/SessionPythonEnvironments.cpp", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * SessionPythonEnvironments.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionPythonEnvironments.hpp\"\n+\n+#include <core/Exec.hpp>\n+\n+#include <session/prefs/UserPrefs.hpp>\n+#include <session/prefs/UserPrefValues.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+using namespace rstudio::core;\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace python_environments {\n+\n+namespace {\n+\n+} // end anonymous namespace\n+\n+Error initialize()\n+{\n+   using namespace module_context;\n+   \n+   std::string pythonPath = core::system::getenv(\"RETICULATE_PYTHON\");\n+   if (pythonPath.empty())\n+   {\n+      core::system::setenv(\n+               \"RETICULATE_PYTHON\",\n+               prefs::userPrefs().pythonDefaultInterpreter());", "originalCommit": "52b1df3f4f90bc5c871b93d0bfcc8865609cc4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNTcyOQ==", "url": "https://github.com/rstudio/rstudio/pull/7497#discussion_r466615729", "bodyText": "My exit hatch for this question (resolving whether the environment variable was set by us, versus by the user) was to just require a session restart any time the preference was changed via the UI. (This doesn't help for users who need to change the preference programmatically though, so I think ultimately this is necessary)", "author": "kevinushey", "createdAt": "2020-08-06T18:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4NDk0Ng=="}], "type": "inlineReview"}, {"oid": "f433c5b69c3a7506816210d6dabce35f82da5508", "url": "https://github.com/rstudio/rstudio/commit/f433c5b69c3a7506816210d6dabce35f82da5508", "message": "accessibility feedback", "committedDate": "2020-08-06T18:35:44Z", "type": "commit"}, {"oid": "9bb359b0f45533d282dfcb859a6bd8c2d58b94bf", "url": "https://github.com/rstudio/rstudio/commit/9bb359b0f45533d282dfcb859a6bd8c2d58b94bf", "message": "track and update python as prefs change", "committedDate": "2020-08-06T22:42:40Z", "type": "commit"}]}