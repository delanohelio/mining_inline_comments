{"pr_number": 7742, "pr_title": "Improve User Experience with XDG directory permissions issues", "pr_createdAt": "2020-09-05T19:20:12Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7742", "timeline": [{"oid": "164e48650a4d277ef411f8c67bf8c3367c8979db", "url": "https://github.com/rstudio/rstudio/commit/164e48650a4d277ef411f8c67bf8c3367c8979db", "message": "improve error message for saving prefs", "committedDate": "2020-09-04T20:13:55Z", "type": "commit"}, {"oid": "af13022096475c0b49077f1dc2ffb84400b3565f", "url": "https://github.com/rstudio/rstudio/commit/af13022096475c0b49077f1dc2ffb84400b3565f", "message": "Merge remote-tracking branch 'origin/master' into feature/improve-perm-error-messages", "committedDate": "2020-09-05T18:52:40Z", "type": "commit"}, {"oid": "257fdd3a61ec2e98386120fb617ce2e1b1b9cd00", "url": "https://github.com/rstudio/rstudio/commit/257fdd3a61ec2e98386120fb617ce2e1b1b9cd00", "message": "Merge remote-tracking branch 'origin/master' into feature/improve-perm-error-messages", "committedDate": "2020-09-05T18:55:24Z", "type": "commit"}, {"oid": "9b103326564fb06c234d98268a2a0a6b5e410c57", "url": "https://github.com/rstudio/rstudio/commit/9b103326564fb06c234d98268a2a0a6b5e410c57", "message": "add a check for writeability to userConfigDir", "committedDate": "2020-09-05T19:04:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2NjUxMQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485066511", "bodyText": "We call userConfigDir all the time and it's expected to be a fast, read-only operation -- probably not the right place to add a write test. This test should be done only once early at startup.", "author": "jmcphers", "createdAt": "2020-09-08T16:58:08Z", "path": "src/cpp/core/system/Xdg.cpp", "diffHunk": "@@ -108,17 +109,53 @@ FilePath resolveXdgDir(const std::string& envVar,\n } // anonymous namespace\n \n FilePath userConfigDir(\n-        const boost::optional<std::string>& user,\n-        const boost::optional<FilePath>& homeDir)\n+   const boost::optional<std::string>& user,\n+   const boost::optional<FilePath>& homeDir)\n {\n-   return resolveXdgDir(\"XDG_CONFIG_HOME\", \n+   FilePath confDir = resolveXdgDir(\"XDG_CONFIG_HOME\", \n #ifdef _WIN32\n          FOLDERID_RoamingAppData,\n #endif\n          \"~/.config\",\n          user,\n          homeDir\n    );\n+\n+   Error permError;\n+   Error error = confDir.ensureDirectory();\n+   if (!error)\n+   {\n+      // Test permissions here.\n+      error = confDir.testWritePermissions();", "originalCommit": "9b103326564fb06c234d98268a2a0a6b5e410c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMTkxNw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485101917", "bodyText": "Should we test this at session startup, server startup or both? We do read from here in the server/desktop code for crashpad settings, I think.", "author": "MariaSemple", "createdAt": "2020-09-08T18:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2NjUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2NzYzOA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485067638", "bodyText": "For a non-technical audience, how about \"the folder X and all the files inside it\"?", "author": "jmcphers", "createdAt": "2020-09-08T17:00:02Z", "path": "src/cpp/session/prefs/UserPrefsLayer.cpp", "diffHunk": "@@ -109,6 +109,19 @@ Error UserPrefsLayer::writePrefs(const core::json::Object &prefs)\n       lastSync_ = prefsFile_.getLastWriteTime();\n    }\n \n+   // Modify the error to be more descriptive\n+   if (isFileNotFoundError(error) && prefsFile_.getParent().exists())\n+   {\n+      error = Error(\n+         error.getName(),\n+         error.getCode(),\n+         \"Unable to save preferences. Please verify that \" + \n+            prefsFile_.getParent().getAbsolutePath() +\n+            \" exists and it and all its children are owned by the user '\" +", "originalCommit": "9b103326564fb06c234d98268a2a0a6b5e410c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMxNjgzNA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485316834", "bodyText": "Oh, actually I realized I already changed this to \"Unable to save preferences. Please verify that \" + prefsFile_.getAbsolutePath() + \" exists and is owned by the user '\" + system::username() + \"'.\". I must not have pushed the change when I thought I did.", "author": "MariaSemple", "createdAt": "2020-09-09T03:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2NzYzOA=="}], "type": "inlineReview"}, {"oid": "fc2a3ae57d0adccf4d8e12b1342b71d50bb50819", "url": "https://github.com/rstudio/rstudio/commit/fc2a3ae57d0adccf4d8e12b1342b71d50bb50819", "message": "check for write access to xdg folders once at session start", "committedDate": "2020-09-09T06:08:34Z", "type": "commit"}, {"oid": "9c05a203b4164c95d50b6a67b092409a9d87a61a", "url": "https://github.com/rstudio/rstudio/commit/9c05a203b4164c95d50b6a67b092409a9d87a61a", "message": "improve error message", "committedDate": "2020-09-09T06:08:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc4NjQ5NA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485786494", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  message.append(\"Encounterd an issue while testing config dir \\\"\")\n          \n          \n            \n                  message.append(\"Encountered an issue while testing config dir \\\"\")", "author": "kevinushey", "createdAt": "2020-09-09T17:14:36Z", "path": "src/cpp/core/system/Xdg.cpp", "diffHunk": "@@ -108,17 +109,53 @@ FilePath resolveXdgDir(const std::string& envVar,\n } // anonymous namespace\n \n FilePath userConfigDir(\n-        const boost::optional<std::string>& user,\n-        const boost::optional<FilePath>& homeDir)\n+   const boost::optional<std::string>& user,\n+   const boost::optional<FilePath>& homeDir)\n {\n-   return resolveXdgDir(\"XDG_CONFIG_HOME\", \n+   FilePath confDir = resolveXdgDir(\"XDG_CONFIG_HOME\", \n #ifdef _WIN32\n          FOLDERID_RoamingAppData,\n #endif\n          \"~/.config\",\n          user,\n          homeDir\n    );\n+\n+   Error permError;\n+   Error error = confDir.ensureDirectory();\n+   if (!error)\n+   {\n+      // Test permissions here.\n+      error = confDir.testWritePermissions();\n+      if (error)\n+      {\n+         permError = Error(\n+            error.getName(),\n+            error.getCode(),\n+            \"Missing write permissions to \" + confDir.getAbsolutePath() + \". Some features may not work correctly.\",\n+            ERROR_LOCATION);\n+\n+         system::User currUser;\n+         error = system::User::getUserFromIdentifier(system::username(), currUser);\n+         if (!error)\n+            error = confDir.changeOwnership(currUser, true);\n+      }\n+   }\n+\n+   if (error)\n+   {\n+      std::string message;\n+      message.append(\"Encounterd an issue while testing config dir \\\"\")", "originalCommit": "9b103326564fb06c234d98268a2a0a6b5e410c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MTU0MA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r485791540", "bodyText": "I changed the phrasing of this locally to \"Unable to access the directory \\\"\".", "author": "MariaSemple", "createdAt": "2020-09-09T17:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc4NjQ5NA=="}], "type": "inlineReview"}, {"oid": "457faa7cf792d38e52edea6ffc632d5dac618b87", "url": "https://github.com/rstudio/rstudio/commit/457faa7cf792d38e52edea6ffc632d5dac618b87", "message": "remove unused code", "committedDate": "2020-09-13T18:12:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMDIzOA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489600238", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // It should be invoked once. Any issues with these directories will be emmitted to the session log.\n          \n          \n            \n            // It should be invoked once. Any issues with these directories will be emitted to the session log.", "author": "kevinushey", "createdAt": "2020-09-16T17:22:04Z", "path": "src/cpp/core/include/core/system/Xdg.hpp", "diffHunk": "@@ -62,6 +62,12 @@ FilePath userConfigDir(const boost::optional<std::string>& user = boost::none,\n // On Windows, this is 'FOLDERID_LocalAppData' (typically 'AppData/Local').\n FilePath userDataDir(const boost::optional<std::string>& user = boost::none,\n                      const boost::optional<FilePath>& homeDir = boost::none);\n+                     \n+// This function verifies that the userConfigDir() and userDataDir() exist and are owned by the running user.\n+// \n+// It should be invoked once. Any issues with these directories will be emmitted to the session log.", "originalCommit": "457faa7cf792d38e52edea6ffc632d5dac618b87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMjM2OQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489602369", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .append(\":\\n  \")\n          \n          \n            \n                        .append(\"\\\":\\n  \")", "author": "kevinushey", "createdAt": "2020-09-16T17:25:37Z", "path": "src/cpp/core/system/Xdg.cpp", "diffHunk": "@@ -135,6 +136,52 @@ FilePath userDataDir(\n    );\n }\n \n+void verifyUserDirs(\n+   const boost::optional<std::string>& user,\n+   const boost::optional<FilePath>& homeDir)\n+{\n+   auto testDir = [](const FilePath& dir, const ErrorLocation& errorLoc)\n+   {\n+      Error permError;\n+      Error error = dir.ensureDirectory();\n+      if (error)\n+         error.addOrUpdateProperty(\"path\", dir.getAbsolutePath());\n+      else\n+      {\n+         error = dir.testWritePermissions();\n+         if (error)\n+         {\n+            permError = Error(\n+               error.getName(),\n+               error.getCode(),\n+               \"Missing write permissions to \" + dir.getAbsolutePath() + \". Some features may not work correctly.\",\n+               ERROR_LOCATION);\n+\n+            system::User currUser;\n+            error = system::User::getUserFromIdentifier(system::username(), currUser);\n+            if (!error)\n+               error = dir.changeOwnership(currUser, true);\n+         }\n+      }\n+\n+      if (error)\n+      {\n+         std::string message;\n+         message.append(\"Unable to access \\\"\")\n+            .append(dir.getAbsolutePath())\n+            .append(\":\\n  \")", "originalCommit": "457faa7cf792d38e52edea6ffc632d5dac618b87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMzQ0Nw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489603447", "bodyText": "I wonder if we should instead amend the existing error's properties here, rather than creating a whole new error object? (Since in theory some properties of interest on the original error could be lost)", "author": "kevinushey", "createdAt": "2020-09-16T17:27:31Z", "path": "src/cpp/session/prefs/UserPrefsLayer.cpp", "diffHunk": "@@ -109,6 +109,19 @@ Error UserPrefsLayer::writePrefs(const core::json::Object &prefs)\n       lastSync_ = prefsFile_.getLastWriteTime();\n    }\n \n+   // Modify the error to be more descriptive\n+   if (isFileNotFoundError(error) && prefsFile_.exists())\n+   {\n+      error = Error(", "originalCommit": "457faa7cf792d38e52edea6ffc632d5dac618b87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNDY3MQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489604671", "bodyText": "We could even add a helper method to make this a sort of \"official\" way of tagging this kind of information on an error (since there's a lot of places in the code base where users and support would benefit from extra tagged information). Or do we have an existing one that is suitable here?", "author": "kevinushey", "createdAt": "2020-09-16T17:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYxODA5Mw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489618093", "bodyText": "The dialog that the user is presented with only displays the message of the error. All the properties are left out. The only way to set the message of  an error is at construction time. However, I do think it would be reasonable to set the original error as the cause, or at least copy over all the properties.", "author": "MariaSemple", "createdAt": "2020-09-16T17:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYzODc1NQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489638755", "bodyText": "What do you think about setting or amending the message on the original error object?\nSorry for being nitpicky; I'm just trying to think if there's a sort of \"best practice\" that we could encode here and then reuse in other locations where we want to surface extra information for the user.", "author": "kevinushey", "createdAt": "2020-09-16T18:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMzQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgxMzA1Nw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r489813057", "bodyText": "I'm not sure. When I modified the Error class I continued to follow the existing pattern - i.e. that the message can't be updated after the error has been created. We use to take the message solely from the boost error code object. I don't know the reasoning behind the original desicion so I can't say whether it should be changed or not. @jmcphers Do you have any opinion on this?", "author": "MariaSemple", "createdAt": "2020-09-16T23:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwMzQ0Nw=="}], "type": "inlineReview"}, {"oid": "541874723879dc8fd3bddc9aa85fe653a317bb0f", "url": "https://github.com/rstudio/rstudio/commit/541874723879dc8fd3bddc9aa85fe653a317bb0f", "message": "Update src/cpp/core/include/core/system/Xdg.hpp\n\nCo-authored-by: Kevin Ushey <kevin@rstudio.com>", "committedDate": "2020-09-16T17:49:52Z", "type": "commit"}, {"oid": "ff36378bd84cc4eef8c8e012382fd3a9cae9d7e9", "url": "https://github.com/rstudio/rstudio/commit/ff36378bd84cc4eef8c8e012382fd3a9cae9d7e9", "message": "Update src/cpp/core/system/Xdg.cpp\n\nCo-authored-by: Kevin Ushey <kevin@rstudio.com>", "committedDate": "2020-09-16T17:50:12Z", "type": "commit"}, {"oid": "b1a1780215ba007f687b9c1805439a5e2db0fd81", "url": "https://github.com/rstudio/rstudio/commit/b1a1780215ba007f687b9c1805439a5e2db0fd81", "message": "preserve original error as the cause", "committedDate": "2020-09-16T20:05:47Z", "type": "commit"}, {"oid": "d67d1efede37280ba5d16173edfe0af83bfe1527", "url": "https://github.com/rstudio/rstudio/commit/d67d1efede37280ba5d16173edfe0af83bfe1527", "message": "Merge branch 'feature/improve-perm-error-messages' of github.com:rstudio/rstudio into feature/improve-perm-error-messages", "committedDate": "2020-09-16T20:10:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA4Mzk4MA==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r491083980", "bodyText": "I think this might cause trouble later because there is some first-run logic that checks for the existence of these directories to figure out if we need to do certain kinds of initialization (or migration from old folders). Since the pathological case is generally that these directories exist but are unwritable, how would you feel about having this test function do nothing if the directory isn't in place yet?", "author": "jmcphers", "createdAt": "2020-09-18T17:12:34Z", "path": "src/cpp/core/system/Xdg.cpp", "diffHunk": "@@ -135,6 +136,52 @@ FilePath userDataDir(\n    );\n }\n \n+void verifyUserDirs(\n+   const boost::optional<std::string>& user,\n+   const boost::optional<FilePath>& homeDir)\n+{\n+   auto testDir = [](const FilePath& dir, const ErrorLocation& errorLoc)\n+   {\n+      Error permError;\n+      Error error = dir.ensureDirectory();", "originalCommit": "d67d1efede37280ba5d16173edfe0af83bfe1527", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "45df9dfbeefbaca76bcec3b9d564939486e48c2c", "url": "https://github.com/rstudio/rstudio/commit/45df9dfbeefbaca76bcec3b9d564939486e48c2c", "message": "only test write permissions if the directory exists", "committedDate": "2020-10-13T21:28:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r505901655", "bodyText": "On Linux you need to be root to change ownership, so I think that this is very unlikely to succeed. In the pathological case (your settings/data dir is owned by someone else), the effect here will be that we log \"Unable to access [dir]: Operation not permitted\" which isn't super helpful. Maybe we should just figure out who the owner is and log it if we can? Or have a different error message for the attempted ownership change?", "author": "jmcphers", "createdAt": "2020-10-15T22:33:44Z", "path": "src/cpp/core/system/Xdg.cpp", "diffHunk": "@@ -135,6 +136,49 @@ FilePath userDataDir(\n    );\n }\n \n+void verifyUserDirs(\n+   const boost::optional<std::string>& user,\n+   const boost::optional<FilePath>& homeDir)\n+{\n+   auto testDir = [](const FilePath& dir, const ErrorLocation& errorLoc)\n+   {\n+      Error error, permError;\n+      if (dir.exists())\n+      {\n+         error = dir.testWritePermissions();\n+         if (error)\n+         {\n+            permError = Error(\n+               error.getName(),\n+               error.getCode(),\n+               \"Missing write permissions to \" + dir.getAbsolutePath() + \". Some features may not work correctly.\",\n+               ERROR_LOCATION);\n+\n+            system::User currUser;\n+            error = system::User::getUserFromIdentifier(system::username(), currUser);\n+            if (!error)\n+               error = dir.changeOwnership(currUser, true);", "originalCommit": "45df9dfbeefbaca76bcec3b9d564939486e48c2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwNTU0Mw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r505905543", "bodyText": "In the screenshots in the description you can see that you get both errors in that case. Is that sufficient?", "author": "MariaSemple", "createdAt": "2020-10-15T22:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwOTMyMg==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r505909322", "bodyText": "Yes, I think that's fine. Is there a circumstance where you would expect changeOwnership to work? Does it work on Windows, for example?", "author": "jmcphers", "createdAt": "2020-10-15T22:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NDk3MQ==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r508154971", "bodyText": "I'm not aware of a circumstance where this would work. I included it based on @kevinushey's suggestion in #4505 because even though I can't think of a situation where it would work I don't think it's harmful and it's possible there's some filesystem permission scenario that I'm missing where it could resolve the user's issue.", "author": "MariaSemple", "createdAt": "2020-10-20T01:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NTI2Mw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r508645263", "bodyText": "I really can't think of one. If you want to leave it in, could you add a comment explaining the reasoning above the change ownership call to save some future head-scratching?\nThis PR LGTM modulo said comment!", "author": "jmcphers", "createdAt": "2020-10-20T15:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwNDE2Mw==", "url": "https://github.com/rstudio/rstudio/pull/7742#discussion_r508804163", "bodyText": "Done.", "author": "MariaSemple", "createdAt": "2020-10-20T20:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTY1NQ=="}], "type": "inlineReview"}, {"oid": "09b66d9c58efb11df470eb50d2ad6b16a149be32", "url": "https://github.com/rstudio/rstudio/commit/09b66d9c58efb11df470eb50d2ad6b16a149be32", "message": "add an explanatory comment", "committedDate": "2020-10-20T19:59:04Z", "type": "commit"}]}