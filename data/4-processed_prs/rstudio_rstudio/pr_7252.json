{"pr_number": 7252, "pr_title": "Assign source columns to command toolbar buttons", "pr_createdAt": "2020-07-01T03:00:22Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7252", "timeline": [{"oid": "5ae9400f68b8ba6299ebde6651702fcc379b9ab8", "url": "https://github.com/rstudio/rstudio/commit/5ae9400f68b8ba6299ebde6651702fcc379b9ab8", "message": "fix issue preventing some documents from being visible when opened", "committedDate": "2020-06-18T23:44:50Z", "type": "commit"}, {"oid": "ff564a49dfd9fb019c5d429ddabfa0da4c453d47", "url": "https://github.com/rstudio/rstudio/commit/ff564a49dfd9fb019c5d429ddabfa0da4c453d47", "message": "Add event to notify when a source column is closed. Update user prefs on close.", "committedDate": "2020-06-22T23:56:06Z", "type": "commit"}, {"oid": "3a8987075cf93fac295c630cefaf2a71b4a05718", "url": "https://github.com/rstudio/rstudio/commit/3a8987075cf93fac295c630cefaf2a71b4a05718", "message": "adding debug code", "committedDate": "2020-06-23T19:32:05Z", "type": "commit"}, {"oid": "3ea75f496088f5da2b062855fede62032afbaa89", "url": "https://github.com/rstudio/rstudio/commit/3ea75f496088f5da2b062855fede62032afbaa89", "message": "Merge branch 'master' of https://github.com/rstudio/rstudio into feature/source-columns", "committedDate": "2020-06-23T19:32:14Z", "type": "commit"}, {"oid": "79f7a3726295def51c71a54293844f5db0922519", "url": "https://github.com/rstudio/rstudio/commit/79f7a3726295def51c71a54293844f5db0922519", "message": "create AppCommand toolbar option that binds with an editor", "committedDate": "2020-06-24T00:35:58Z", "type": "commit"}, {"oid": "07e2e9d5c1e1605306689ed4e70043eca2368547", "url": "https://github.com/rstudio/rstudio/commit/07e2e9d5c1e1605306689ed4e70043eca2368547", "message": "only enable command buttons for the active columns, but always show all\npotentially available commands", "committedDate": "2020-06-24T02:40:56Z", "type": "commit"}, {"oid": "eff0599412d7cfa48ae01851a73efa6fb343345d", "url": "https://github.com/rstudio/rstudio/commit/eff0599412d7cfa48ae01851a73efa6fb343345d", "message": "make toolbar commands run more accurately,\nfixed issue that prevented source columns from being completely closed", "committedDate": "2020-06-29T19:21:52Z", "type": "commit"}, {"oid": "24079386b845fb1c76cf425c255e5db1b05bd4c5", "url": "https://github.com/rstudio/rstudio/commit/24079386b845fb1c76cf425c255e5db1b05bd4c5", "message": "main command buttons properly handled per column", "committedDate": "2020-06-30T18:08:44Z", "type": "commit"}, {"oid": "de2c23c85e01254fa7328ec94cec7a6d726c9cf5", "url": "https://github.com/rstudio/rstudio/commit/de2c23c85e01254fa7328ec94cec7a6d726c9cf5", "message": "fix command button visibility and remove debug code", "committedDate": "2020-06-30T19:17:34Z", "type": "commit"}, {"oid": "065ce3136b881eef2ccabafcff0ab630416dd9ae", "url": "https://github.com/rstudio/rstudio/commit/065ce3136b881eef2ccabafcff0ab630416dd9ae", "message": "fix source navigation and synctex commands", "committedDate": "2020-06-30T21:46:27Z", "type": "commit"}, {"oid": "79c1a0e5d74708a2aa4ba69af76c825d870bebb2", "url": "https://github.com/rstudio/rstudio/commit/79c1a0e5d74708a2aa4ba69af76c825d870bebb2", "message": "create AppMenuItem class that ties an AppCommand with a SourceColumn", "committedDate": "2020-07-01T00:17:47Z", "type": "commit"}, {"oid": "691962dbdc13cae35324b87d0ac795428a87b437", "url": "https://github.com/rstudio/rstudio/commit/691962dbdc13cae35324b87d0ac795428a87b437", "message": "initialize all editing target toolbar menus with their associated column (when initialized)", "committedDate": "2020-07-01T00:44:05Z", "type": "commit"}, {"oid": "f2b7d29fbd43ce1a1b3833d3705131212b8ec686", "url": "https://github.com/rstudio/rstudio/commit/f2b7d29fbd43ce1a1b3833d3705131212b8ec686", "message": "fix injection issue between SourceWindowManager and SourceColumnManager", "committedDate": "2020-07-01T01:13:14Z", "type": "commit"}, {"oid": "a4ebd7a7f3382f2fc4f5faa3a9afb9984b8d5f32", "url": "https://github.com/rstudio/rstudio/commit/a4ebd7a7f3382f2fc4f5faa3a9afb9984b8d5f32", "message": "code clean up, remove unused code", "committedDate": "2020-07-01T01:55:54Z", "type": "commit"}, {"oid": "ffbfeb7081d1d704d40b4cb3334515e88bcfe78f", "url": "https://github.com/rstudio/rstudio/commit/ffbfeb7081d1d704d40b4cb3334515e88bcfe78f", "message": "Merge branch 'master' into feature/source-columns\n\n# Conflicts:\n#\tsrc/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java\n#\tsrc/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java\n#\tsrc/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetSource.java", "committedDate": "2020-07-01T02:20:04Z", "type": "commit"}, {"oid": "190ed205e5a6e53ed27d78ed55c3ecaae3108b06", "url": "https://github.com/rstudio/rstudio/commit/190ed205e5a6e53ed27d78ed55c3ecaae3108b06", "message": "remove debug code", "committedDate": "2020-07-01T02:32:40Z", "type": "commit"}, {"oid": "77a15040fae10062c997cc72d52a5ba3d89cf6ea", "url": "https://github.com/rstudio/rstudio/commit/77a15040fae10062c997cc72d52a5ba3d89cf6ea", "message": "Merge branch 'master' of https://github.com/rstudio/rstudio into feature/source-columns", "committedDate": "2020-07-01T19:07:22Z", "type": "commit"}, {"oid": "492b3fc9c0a9d93faea9921ba9704d725aa73b00", "url": "https://github.com/rstudio/rstudio/commit/492b3fc9c0a9d93faea9921ba9704d725aa73b00", "message": "ensure new columns appear with an editor and don't appear if additional columns not enabled", "committedDate": "2020-07-01T21:41:06Z", "type": "commit"}, {"oid": "e78fecef190dd3ea74c2dad07283704fcbb48d8f", "url": "https://github.com/rstudio/rstudio/commit/e78fecef190dd3ea74c2dad07283704fcbb48d8f", "message": "properly save splitter state for multiple columns", "committedDate": "2020-07-02T20:30:49Z", "type": "commit"}, {"oid": "f535ced4b6e7e6d9d8e2aebec3870bddca7fe12a", "url": "https://github.com/rstudio/rstudio/commit/f535ced4b6e7e6d9d8e2aebec3870bddca7fe12a", "message": "revert source nav changes", "committedDate": "2020-07-06T17:27:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5NTU0NA==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r450395544", "bodyText": "Nit: formatting, { should be on its own line", "author": "jmcphers", "createdAt": "2020-07-06T18:09:17Z", "path": "src/gwt/src/org/rstudio/core/client/command/AppCommand.java", "diffHunk": "@@ -100,19 +114,79 @@ public void onVisibleChanged(AppCommand command)\n          parentToolbar_.invalidateSeparators();\n       }\n \n-      private final AppCommand command_;\n+      protected final AppCommand command_;\n       private boolean synced_ = true;\n-      private HandlerRegistration handlerReg_;\n-      private HandlerRegistration handlerReg2_;\n-      private Toolbar parentToolbar_;\n+      protected HandlerRegistration handlerReg_;\n+      protected HandlerRegistration handlerReg2_;\n+      protected Toolbar parentToolbar_;\n+   }\n+\n+   private class CommandSourceColumnToolbarButton extends CommandToolbarButton\n+   {\n+      public CommandSourceColumnToolbarButton(String buttonLabel,\n+                                              String buttonTitle,\n+                                              ImageResourceProvider imageResourceProvider,\n+                                              ClickHandler clickHandler,\n+                                              AppCommand command,\n+                                              SourceColumn column)     {", "originalCommit": "f535ced4b6e7e6d9d8e2aebec3870bddca7fe12a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwMTIwMw==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r450401203", "bodyText": "Instead of keeping track of each registration, use a HandlerRegistrations to remember them and then unload them all at once. https://github.com/rstudio/rstudio/blob/master/src/gwt/src/org/rstudio/core/client/HandlerRegistrations.java", "author": "jmcphers", "createdAt": "2020-07-06T18:20:45Z", "path": "src/gwt/src/org/rstudio/core/client/command/AppCommand.java", "diffHunk": "@@ -100,19 +114,79 @@ public void onVisibleChanged(AppCommand command)\n          parentToolbar_.invalidateSeparators();\n       }\n \n-      private final AppCommand command_;\n+      protected final AppCommand command_;\n       private boolean synced_ = true;\n-      private HandlerRegistration handlerReg_;\n-      private HandlerRegistration handlerReg2_;\n-      private Toolbar parentToolbar_;\n+      protected HandlerRegistration handlerReg_;\n+      protected HandlerRegistration handlerReg2_;\n+      protected Toolbar parentToolbar_;\n+   }\n+\n+   private class CommandSourceColumnToolbarButton extends CommandToolbarButton\n+   {\n+      public CommandSourceColumnToolbarButton(String buttonLabel,\n+                                              String buttonTitle,\n+                                              ImageResourceProvider imageResourceProvider,\n+                                              ClickHandler clickHandler,\n+                                              AppCommand command,\n+                                              SourceColumn column)     {\n+         super(buttonLabel, buttonTitle, imageResourceProvider, clickHandler, command, false);\n+         column_ = column;\n+      }\n+\n+      @Override\n+      protected void onAttach()\n+      {\n+         super.onAttach();\n+\n+         handlerReg_ = command_.addEnabledChangedHandler(this);", "originalCommit": "f535ced4b6e7e6d9d8e2aebec3870bddca7fe12a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNDE4OQ==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r450404189", "bodyText": "It feels a little weird that the AppCommand knows so much about source columns (these concepts should generally not be coupled except where necessary). What do you think about moving the source column bits into a separate package? You can could something like a SourceColumnCommand which wraps an AppCommand and adds the ability to generate the more contextual enable/disable states.", "author": "jmcphers", "createdAt": "2020-07-06T18:26:30Z", "path": "src/gwt/src/org/rstudio/core/client/command/AppCommand.java", "diffHunk": "@@ -100,19 +114,79 @@ public void onVisibleChanged(AppCommand command)\n          parentToolbar_.invalidateSeparators();\n       }\n \n-      private final AppCommand command_;\n+      protected final AppCommand command_;\n       private boolean synced_ = true;\n-      private HandlerRegistration handlerReg_;\n-      private HandlerRegistration handlerReg2_;\n-      private Toolbar parentToolbar_;\n+      protected HandlerRegistration handlerReg_;\n+      protected HandlerRegistration handlerReg2_;\n+      protected Toolbar parentToolbar_;\n+   }\n+\n+   private class CommandSourceColumnToolbarButton extends CommandToolbarButton", "originalCommit": "f535ced4b6e7e6d9d8e2aebec3870bddca7fe12a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b5173ca6b7644021f07eca738c44918a3692988c", "url": "https://github.com/rstudio/rstudio/commit/b5173ca6b7644021f07eca738c44918a3692988c", "message": "fix formatting and switch individual handlers for HandlerRegistrations", "committedDate": "2020-07-06T20:24:43Z", "type": "commit"}, {"oid": "353ae835797981609a28871ca9e68fb55eaaf0c3", "url": "https://github.com/rstudio/rstudio/commit/353ae835797981609a28871ca9e68fb55eaaf0c3", "message": "begin implementing SourceColumnCommands", "committedDate": "2020-07-07T17:02:02Z", "type": "commit"}, {"oid": "0d5d16c73ff933d75ece8d0d2286960f2819e466", "url": "https://github.com/rstudio/rstudio/commit/0d5d16c73ff933d75ece8d0d2286960f2819e466", "message": "remove knowledge of source columns from AppCommand", "committedDate": "2020-07-07T19:29:42Z", "type": "commit"}, {"oid": "3cb099c464b55375b93dab96c258d57e49c61a66", "url": "https://github.com/rstudio/rstudio/commit/3cb099c464b55375b93dab96c258d57e49c61a66", "message": "modify command management so only the active column enables the AppCommand", "committedDate": "2020-07-07T20:18:19Z", "type": "commit"}, {"oid": "3cb099c464b55375b93dab96c258d57e49c61a66", "url": "https://github.com/rstudio/rstudio/commit/3cb099c464b55375b93dab96c258d57e49c61a66", "message": "modify command management so only the active column enables the AppCommand", "committedDate": "2020-07-07T20:18:19Z", "type": "forcePushed"}, {"oid": "a91639d9cba160444272e1913a700cd98dd75094", "url": "https://github.com/rstudio/rstudio/commit/a91639d9cba160444272e1913a700cd98dd75094", "message": "revert unneeded AppCommand code", "committedDate": "2020-07-07T20:31:45Z", "type": "commit"}, {"oid": "e6c055ae4fe8b543b9f79e8677195fa34f47e4b1", "url": "https://github.com/rstudio/rstudio/commit/e6c055ae4fe8b543b9f79e8677195fa34f47e4b1", "message": "put accidentally removed event handler back", "committedDate": "2020-07-07T20:36:45Z", "type": "commit"}, {"oid": "00cfd5a0f26d30b99d73156f2c89d6b2a39a107b", "url": "https://github.com/rstudio/rstudio/commit/00cfd5a0f26d30b99d73156f2c89d6b2a39a107b", "message": "Merge branch 'master' into feature/source-columns", "committedDate": "2020-07-07T20:56:23Z", "type": "commit"}, {"oid": "3e03bd7682bb6d252154fd70ae7fecd7c7801c25", "url": "https://github.com/rstudio/rstudio/commit/3e03bd7682bb6d252154fd70ae7fecd7c7801c25", "message": "Merge branch 'feature/source-columns' of https://github.com/rstudio/rstudio into feature/source-columns", "committedDate": "2020-07-07T20:59:05Z", "type": "commit"}, {"oid": "f1d2616901904b87ab2236dc74b38c1ed966fd06", "url": "https://github.com/rstudio/rstudio/commit/f1d2616901904b87ab2236dc74b38c1ed966fd06", "message": "remove extra parentheses", "committedDate": "2020-07-07T21:38:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2MjY5NQ==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r451162695", "bodyText": "Testing JavaScript objects for equality has a bunch of weird edge cases so I'd recommend avoiding it. For example the object could be cloned and the clone won't match, but they'll look like the same object in the debugger so it won't be obvious WHY they don't match!\nHow about storing sourceAppCommands_ as a HashMap, using the command ID (from command.getId()) plus the column name as a key? Then lookups will be faster, plus identity will be more reliable as you'll just need to check for existence in the map.", "author": "jmcphers", "createdAt": "2020-07-07T21:47:05Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java", "diffHunk": "@@ -1934,8 +1982,24 @@ public void initVimCommands()\n       vimCommands_.addStarRegister();\n    }\n \n+   public SourceAppCommand getSourceCommand(AppCommand command, SourceColumn column)\n+   {\n+      // check if we've already create a SourceAppCommand for this command\n+      for (SourceAppCommand cmd : sourceAppCommands_)\n+      {\n+         if (cmd.getCommand() == command &&", "originalCommit": "f1d2616901904b87ab2236dc74b38c1ed966fd06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTE1OA==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r451179158", "bodyText": "Thank you! I've implemented the update \ud83d\udc4d", "author": "melissa-barca", "createdAt": "2020-07-07T22:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2MjY5NQ=="}], "type": "inlineReview"}, {"oid": "4720dc5974cf8dbc6c34545ff523d40315900214", "url": "https://github.com/rstudio/rstudio/commit/4720dc5974cf8dbc6c34545ff523d40315900214", "message": "use HashMap instead of HashSet", "committedDate": "2020-07-07T22:26:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3NzEwOQ==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r451177109", "bodyText": "Super-ultra-nitpicky: There are a bunch of methods in this class that are missing @Override.", "author": "gtritchie", "createdAt": "2020-07-07T22:22:13Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourcePane.java", "diffHunk": "@@ -242,6 +242,7 @@ public void onResize()\n       manageChevronVisibility();\n    }\n \n+   @Override", "originalCommit": "f1d2616901904b87ab2236dc74b38c1ed966fd06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4MzEyNQ==", "url": "https://github.com/rstudio/rstudio/pull/7252#discussion_r451183125", "bodyText": "Thanks, I added them in \ud83d\udc4d", "author": "melissa-barca", "createdAt": "2020-07-07T22:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3NzEwOQ=="}], "type": "inlineReview"}, {"oid": "37d85ffae7ff17d0002658bf3e785fb8e71d57d0", "url": "https://github.com/rstudio/rstudio/commit/37d85ffae7ff17d0002658bf3e785fb8e71d57d0", "message": "remove unused function and add in missing @Override", "committedDate": "2020-07-07T22:37:23Z", "type": "commit"}]}