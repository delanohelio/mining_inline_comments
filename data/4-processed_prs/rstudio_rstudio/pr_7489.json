{"pr_number": 7489, "pr_title": "Load SSL certs from Apple Keychain", "pr_createdAt": "2020-07-30T15:37:51Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7489", "timeline": [{"oid": "9d8a29d883b406650d670b802316772c44239431", "url": "https://github.com/rstudio/rstudio/commit/9d8a29d883b406650d670b802316772c44239431", "message": "Load certificates from keychain in addition to OpenSSL certs before doing SSL certificate verification on OSX.\n\nCloses https://github.com/rstudio/rstudio-pro/issues/1828", "committedDate": "2020-07-30T15:35:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NTgxNQ==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463145815", "bodyText": "Does a null result here indicate an error we need to log? Or is this expected in the normal course of operations?", "author": "jmcphers", "createdAt": "2020-07-30T17:09:02Z", "path": "src/cpp/core/include/core/http/TcpIpAsyncClientSsl.hpp", "diffHunk": "@@ -238,14 +278,43 @@ class TcpIpAsyncClientSsl\n    }\n #endif\n \n-private:\n-   boost::asio::ssl::context sslContext_;\n-   boost::scoped_ptr<boost::asio::ssl::stream<boost::asio::ip::tcp::socket> > ptrSslStream_;\n-   std::string address_;\n-   std::string port_;\n-   bool verify_;\n-   std::string certificateAuthority_;\n-   boost::posix_time::time_duration connectionTimeout_;\n+#ifdef __APPLE__\n+   class Keychain : public ICertStore\n+   {\n+   public:\n+      Keychain()\n+      {\n+         // load all certs from the keychain\n+         std::vector<KeychainCertificateData> certs = getKeychainCertificates();\n+         for (const auto& cert : certs)\n+         {\n+            // convert the raw bytes from the keychain into a format that OpenSSL can understand\n+            const unsigned char* bytePtr = cert.data.get();\n+            X509* x509 = d2i_X509(nullptr, &bytePtr, cert.size);\n+            if (x509)", "originalCommit": "9d8a29d883b406650d670b802316772c44239431", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1ODQyNQ==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463158425", "bodyText": "I think logging this as error would be too heavy handed because if there was an invalid certificate in the store for some reason, then this could cause a lot of spam, especially in RStudio Server. I will log the error at debug level.", "author": "kfeinauer", "createdAt": "2020-07-30T17:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NTgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1ODYyOQ==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463158629", "bodyText": "Sounds good!", "author": "jmcphers", "createdAt": "2020-07-30T17:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NTgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODkxMg==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463148912", "bodyText": "Nit: Idiomatically it's more common for us to use a vector of shared pointers to immutable data structures (and using e.g., std::vector<unsigned char> inside the data structure to create a managed buffer). This reduces copying somewhat but isn't a big deal here so up to you whether you want to change it.", "author": "jmcphers", "createdAt": "2020-07-30T17:14:41Z", "path": "src/cpp/core/include/core/http/Keychain.hpp", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Keychain.hpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#ifndef CORE_HTTP_KEYCHAIN_HPP\n+#define CORE_HTTP_KEYCHAIN_HPP\n+\n+#include <vector>\n+\n+#include <boost/shared_ptr.hpp>\n+\n+namespace rstudio {\n+namespace core {\n+namespace http {\n+\n+struct KeychainCertificateData\n+{\n+   long size;\n+   boost::shared_ptr<unsigned char> data;\n+};\n+\n+std::vector<KeychainCertificateData> getKeychainCertificates();", "originalCommit": "9d8a29d883b406650d670b802316772c44239431", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2MDM2OQ==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463160369", "bodyText": "Considering the important thing to free here is the actual underlying (dynamically allocated) buffer, I wanted to wrap that in a shared_ptr to ensures it is freed with minimum boilerplate (no custom destructor). So, since the copying overhead here is almost negligible (only an extra 8 bytes per entry), I will leave this as-is.", "author": "kfeinauer", "createdAt": "2020-07-30T17:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0OTgyMA==", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463149820", "bodyText": "Let's add a comment here making it extra clear that the caller should not free the pointers as they're owned by the cert store.", "author": "jmcphers", "createdAt": "2020-07-30T17:16:19Z", "path": "src/cpp/core/include/core/http/TcpIpAsyncClientSsl.hpp", "diffHunk": "@@ -224,12 +258,18 @@ class TcpIpAsyncClientSsl\n          }\n       }\n \n+      std::vector<X509*> getCertificates() const", "originalCommit": "9d8a29d883b406650d670b802316772c44239431", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6a6a8f60ac5dac527378f4816e485e4fe9f08a2", "url": "https://github.com/rstudio/rstudio/commit/c6a6a8f60ac5dac527378f4816e485e4fe9f08a2", "message": "Code review feedback - log inability to parse X509 certificate (as debug to prevent potential spam), and notate that returned certificates should not be freed.", "committedDate": "2020-07-30T17:41:43Z", "type": "commit"}, {"oid": "d9c1f1dd5efd47e1457cfe754eee8b8dc155e013", "url": "https://github.com/rstudio/rstudio/commit/d9c1f1dd5efd47e1457cfe754eee8b8dc155e013", "message": "Remove Windows specific verbiage in shared OSX/Windows code path", "committedDate": "2020-07-30T17:49:36Z", "type": "commit"}, {"oid": "0c85f8e4e01155a7052322ab0c9f3dca612af223", "url": "https://github.com/rstudio/rstudio/commit/0c85f8e4e01155a7052322ab0c9f3dca612af223", "message": "Update NEWS", "committedDate": "2020-07-31T21:57:02Z", "type": "commit"}, {"oid": "b6928f9d8251b34d215e9cec7741bd275ecfe907", "url": "https://github.com/rstudio/rstudio/commit/b6928f9d8251b34d215e9cec7741bd275ecfe907", "message": "Merge branch 'master' into feature/apple-keychain-ssl-certs", "committedDate": "2020-07-31T21:57:33Z", "type": "commit"}]}