{"pr_number": 6841, "pr_title": "Fix issue with global replace", "pr_createdAt": "2020-05-09T02:13:06Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6841", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0MTU1OQ==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423141559", "bodyText": "Could this be made more specific so that we have more to go on if it's seen in the wild? E.g.:\n\"Found X matches in line but Y matches in encoded line; skipping replace.\"", "author": "jmcphers", "createdAt": "2020-05-11T15:53:28Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -780,55 +799,81 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n                const size_t matchSize = matchOff - matchOn;\n                size_t replaceMatchOff = matchOff;\n                Error error;\n-               Replacer replacer(findResults().ignoreCase());\n-               std::string newLine(pLineInfo->decodedContents);\n+               Replacer replacer(encoding_, findResults().ignoreCase());\n+\n+               if (!encoding_.empty())\n+               {\n+                  eMatchOn =\n+                     static_cast<size_t>(eMatchOnArray.getValueAt(static_cast<size_t>(pos)).getInt());\n+                  eMatchOff =\n+                     static_cast<size_t>(eMatchOffArray.getValueAt(static_cast<size_t>(pos)).getInt());\n+               }\n+\n+               // If we found a different number of matches searching the encoded string,\n+               // we shouldn't perform the replace as the expected vs actual results may differ.\n+               if (!encoding_.empty() && eMatchOnArray.getSize() != matchOnArray.getSize())\n+               {\n+                  core::Error error(\n+                     errc::findCategory(),\n+                     errc::RegexError,\n+                     \"Could not perform replace due to encoding issue.\",", "originalCommit": "881ae4bef167e67455948e0c1fb254b38a2e36fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3MjU1MA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423172550", "bodyText": "Good idea, fixed.", "author": "melissa-barca", "createdAt": "2020-05-11T16:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0MTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0MjY3Mw==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423142673", "bodyText": "Do we need this commented code? (feels like it should just be removed)", "author": "jmcphers", "createdAt": "2020-05-11T15:55:04Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1643,24 +1752,25 @@ core::Error Replacer::completeReplace(const boost::regex& searchRegex,\n       return error;\n    }\n \n-   temp.insert(0, pLine->substr(0, matchOn));\n-   std::string endOfString = pLine->substr(matchOff).c_str();\n-   size_t replaceMatchOff;\n-   if (endOfString.empty())\n-      replaceMatchOff = temp.length();\n-   else\n-      replaceMatchOff = temp.find(endOfString);\n+   newLine.insert(0, begin);\n+   *pReplaceMatchOff = newLine.length() - end.length();\n+   *pLine = newLine;\n+/*", "originalCommit": "881ae4bef167e67455948e0c1fb254b38a2e36fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3Mjk3MA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423172970", "bodyText": "You're right, just me making sure I had the right math. I've removed it.", "author": "melissa-barca", "createdAt": "2020-05-11T16:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0MjY3Mw=="}], "type": "inlineReview"}, {"oid": "2fea4495a87598270f427f383ecc1a60d153b10f", "url": "https://github.com/rstudio/rstudio/commit/2fea4495a87598270f427f383ecc1a60d153b10f", "message": "when performing a global replace, encode lines with their original encoding before performing the\nreplace, clean up preview replace logic, make global replace functional across supported encodings,\nand add encoding unit tests.", "committedDate": "2020-05-11T19:29:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MTk4Ng==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423291986", "bodyText": "I think these string literals should have a comment explaining what they mean/where they come from.", "author": "MariaSemple", "createdAt": "2020-05-11T20:14:13Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -741,6 +719,38 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       return error;\n    }\n \n+   void cleanLineAndGetMatches(std::string* pEncodedLine,\n+                               json::Array* pMatchOn, json::Array* pMatchOff)\n+   {\n+      // The incoming string is assumed to have color encodings from the initial grep command.\n+      // These encodings are parsed out and their positions are placed in pMatchOn and pMatchOff.\n+\n+      const char* inputPos = pEncodedLine->c_str();\n+      const char* end = inputPos + pEncodedLine->size();\n+      std::size_t charactersProcessed = 0;\n+      boost::cmatch match;\n+      std::string cleanLine;\n+\n+      while (regex_utils::search(inputPos, match, getColorEncodingRegex(findResults().gitFlag())))\n+      {\n+         std::string matchedString(inputPos, inputPos + match.position());\n+         inputPos += match.position() + match.length();\n+         \n+         cleanLine.append(matchedString);\n+\n+         charactersProcessed += matchedString.size();\n+   \n+         if ((match.size() > 2 && match[2] == \"1\" && findResults().gitFlag()) ||", "originalCommit": "2fea4495a87598270f427f383ecc1a60d153b10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1Mjk0OQ==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423352949", "bodyText": "Ok, updated.", "author": "melissa-barca", "createdAt": "2020-05-11T22:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MTk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjk4MA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423292980", "bodyText": "Why do we put them into pMatchOn and pMatchOff? Are we removing the color encodings or just keeping track of them?", "author": "MariaSemple", "createdAt": "2020-05-11T20:16:04Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -741,6 +719,38 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       return error;\n    }\n \n+   void cleanLineAndGetMatches(std::string* pEncodedLine,\n+                               json::Array* pMatchOn, json::Array* pMatchOff)\n+   {\n+      // The incoming string is assumed to have color encodings from the initial grep command.\n+      // These encodings are parsed out and their positions are placed in pMatchOn and pMatchOff.", "originalCommit": "2fea4495a87598270f427f383ecc1a60d153b10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzNjAwNQ==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423336005", "bodyText": "We both remove them and keep track of them. These color encodings are placed by grep to indicate the matched word so we keep track of where they were to tell us the location of that matched word. We remove them since they're not part of the original line.", "author": "melissa-barca", "createdAt": "2020-05-11T21:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzODczMg==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423338732", "bodyText": "What's the purpose of putting their locations into pMatchOn and pMatchOff? Is it for removing them later? Or is the pMatchOn right after the color open (i.e. the start of the actual match) and pMatchOff right before the color close?", "author": "MariaSemple", "createdAt": "2020-05-11T21:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0Mzg1NQ==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423343855", "bodyText": "As we iterate over the line's matches we are storing pMatchOn and pMatchOff so we know where the matches are so we can later replace them. At the same time we are creating a string cleanLine that includes everything except for the color encodings. This string gets returned in the variable the original line with the encodings was passed in.", "author": "melissa-barca", "createdAt": "2020-05-11T21:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Mjk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMTczMA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423301730", "bodyText": "Is it not possible to determine the encoded status from the encoding_ member when the Replacer  is constructed?", "author": "MariaSemple", "createdAt": "2020-05-11T20:32:15Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1620,15 +1669,75 @@ boost::regex getColorEncodingRegex(bool isGitGrep)\n    return regex;\n }\n \n+\n+Error Replacer::replacePreview(const size_t dMatchOn, const size_t dMatchOff,\n+                               size_t eMatchOn, size_t eMatchOff,\n+                               std::string* pEncodedLine, std::string* pDecodedLine,\n+                               size_t* pReplaceMatchOff) const\n+{\n+   // if we're not encoded, we can avoid some logic\n+   bool encoded = true;\n+   if (eMatchOn == 0 && eMatchOff == 0)", "originalCommit": "2fea4495a87598270f427f383ecc1a60d153b10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1MjkwMA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423352900", "bodyText": "Good catch, fixed this.", "author": "melissa-barca", "createdAt": "2020-05-11T22:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMTczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMjE3MA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423302170", "bodyText": "Should the encoding be the second parameter with a default value of \"\"?", "author": "MariaSemple", "createdAt": "2020-05-11T20:33:09Z", "path": "src/cpp/session/modules/SessionFindTests.cpp", "diffHunk": "@@ -99,19 +99,52 @@ TEST_CASE(\"SessionFind\")\n       std::string line(kRegexLine);\n       size_t replaceMatchOff;\n \n-      Replacer replacer(false);\n+      Replacer replacer(\"\", false);", "originalCommit": "2fea4495a87598270f427f383ecc1a60d153b10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1MjgzMA==", "url": "https://github.com/rstudio/rstudio/pull/6841#discussion_r423352830", "bodyText": "That works, I made the update.", "author": "melissa-barca", "createdAt": "2020-05-11T22:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMjE3MA=="}], "type": "inlineReview"}, {"oid": "b0db708d97788d883b9f706e6fe57708276fc48a", "url": "https://github.com/rstudio/rstudio/commit/b0db708d97788d883b9f706e6fe57708276fc48a", "message": "when performing a global replace, encode lines with their original encoding before performing the\nreplace, clean up preview replace logic, make global replace functional across supported encodings,\nand add encoding unit tests.", "committedDate": "2020-05-11T22:48:22Z", "type": "commit"}, {"oid": "b0db708d97788d883b9f706e6fe57708276fc48a", "url": "https://github.com/rstudio/rstudio/commit/b0db708d97788d883b9f706e6fe57708276fc48a", "message": "when performing a global replace, encode lines with their original encoding before performing the\nreplace, clean up preview replace logic, make global replace functional across supported encodings,\nand add encoding unit tests.", "committedDate": "2020-05-11T22:48:22Z", "type": "forcePushed"}]}