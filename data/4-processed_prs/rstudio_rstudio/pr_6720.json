{"pr_number": 6720, "pr_title": "patch visual mode changes into source editor", "pr_createdAt": "2020-04-23T19:47:19Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6720", "timeline": [{"oid": "9d8a66fa75e74640dc4b01422eb5dc7c32498f31", "url": "https://github.com/rstudio/rstudio/commit/9d8a66fa75e74640dc4b01422eb5dc7c32498f31", "message": "wip on jsdiff for source changes", "committedDate": "2020-04-23T16:07:16Z", "type": "commit"}, {"oid": "75b7e0fb8bd38f56b36018d96d4b894b6861eb2a", "url": "https://github.com/rstudio/rstudio/commit/75b7e0fb8bd38f56b36018d96d4b894b6861eb2a", "message": "ability to hook ace history operations", "committedDate": "2020-04-23T16:09:16Z", "type": "commit"}, {"oid": "12e35b1996e39c8838115b6967081b2aad465e6e", "url": "https://github.com/rstudio/rstudio/commit/12e35b1996e39c8838115b6967081b2aad465e6e", "message": "Revert \"ability to hook ace history operations\"\n\nThis reverts commit 75b7e0fb8bd38f56b36018d96d4b894b6861eb2a.", "committedDate": "2020-04-23T16:09:37Z", "type": "commit"}, {"oid": "e36d3d4bacfd4c7665429d568604bdeaa3b6c11d", "url": "https://github.com/rstudio/rstudio/commit/e36d3d4bacfd4c7665429d568604bdeaa3b6c11d", "message": "notes on other commands", "committedDate": "2020-04-23T16:15:02Z", "type": "commit"}, {"oid": "854db708f8f352fcf0aa801ce252dbc8a682acda", "url": "https://github.com/rstudio/rstudio/commit/854db708f8f352fcf0aa801ce252dbc8a682acda", "message": "apply diffs to source editor", "committedDate": "2020-04-23T19:43:18Z", "type": "commit"}, {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "url": "https://github.com/rstudio/rstudio/commit/d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "message": "remove unused imports", "committedDate": "2020-04-23T19:44:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA==", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414092350", "bodyText": "I'd just move this to before the for-loop begins.", "author": "jcheng5", "createdAt": "2020-04-23T20:12:57Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }\n+         \n+         // move the selection\n+         selection.moveCursorTo(row, col, false);\n+      };\n+      \n+      \n+      // process changes\n+      for (int i = 0; i<changes.length; i++) \n+      {\n+         // get change\n+         JsdiffChange change = changes[i];\n+         \n+         // if it's the first change then set the cursor location to the beginning of the file\n+         if (i == 0)\n+            selection.moveCursorTo(0, 0, false);", "originalCommit": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMDM4MQ==", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414100381", "bodyText": "Unless you didn't want to check for changes.length == 0 I guess...", "author": "jcheng5", "createdAt": "2020-04-23T20:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExNDgzNg==", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414114836", "bodyText": "Yeah, I need to check for changes.length and not do anything to the cursor in that case. I agree though it would be more clear outside the loop.", "author": "jjallaire", "createdAt": "2020-04-23T20:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ5OQ==", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414099499", "bodyText": "The logic looks correct to me. I had to focus hard to make sure that a) charsLeft can never become less than 0, and b) that the row will never be advanced accidentally.\nThis suggestion is (supposed to be) equivalent but a little easier for my brain. I changed the for-loop to while, incrementing row manually; and moved the newline \"+1\" from the end of the loop body to the beginning, which I find makes the if/else easier to reason about.\n(If you find your version easier to understand, I'm fine with you leaving it that way.)\n         int row = startPos.getRow();\n         int col = startPos.getColumn();\n         while (row < session.getLength()) {\n\n            // how many chars left in the current column?\n            String line = session.getLine(row);\n            // the +1 is for newline\n            int charsLeftInLine = line.length() + 1 - col;\n\n            // is the number of chars we still need to consume lte\n            // the number of charsLeft?\n            if (charsLeft < charsLeftInLine) \n            {\n               col += charsLeft;\n               break;\n            }\n            else\n            {\n               charsLeft -= charsLeftInLine;\n               col = 0;\n               row++;\n            }\n         }", "author": "jcheng5", "createdAt": "2020-04-23T20:25:05Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }", "originalCommit": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyMzE5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414223197", "bodyText": "Yes, your version reach much nicer. Made that change. Thanks very much for the review, this is not a bit of code I'd ever want to get wrong!", "author": "jjallaire", "createdAt": "2020-04-24T01:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ5OQ=="}], "type": "inlineReview"}, {"oid": "61b09b3e087f6fd112ca577ae45537c8a905f1f8", "url": "https://github.com/rstudio/rstudio/commit/61b09b3e087f6fd112ca577ae45537c8a905f1f8", "message": "update todo", "committedDate": "2020-04-23T22:45:35Z", "type": "commit"}, {"oid": "0a085c1b2081c07e871afeb5fd6ec5c41933c20d", "url": "https://github.com/rstudio/rstudio/commit/0a085c1b2081c07e871afeb5fd6ec5c41933c20d", "message": "move cursor to start before applying changes", "committedDate": "2020-04-24T00:53:17Z", "type": "commit"}, {"oid": "7600f9be0e2e8c54e3faccf85b2662ea5ea06a13", "url": "https://github.com/rstudio/rstudio/commit/7600f9be0e2e8c54e3faccf85b2662ea5ea06a13", "message": "changes to patch loop as per jcheng5", "committedDate": "2020-04-24T01:05:02Z", "type": "commit"}, {"oid": "d7aa12458e6f600de57163631780b15483f52b6e", "url": "https://github.com/rstudio/rstudio/commit/d7aa12458e6f600de57163631780b15483f52b6e", "message": "update todo", "committedDate": "2020-04-24T01:06:30Z", "type": "commit"}]}