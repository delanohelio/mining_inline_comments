{"pr_number": 8565, "pr_title": "convert condition messages to UTF-8 when handling in notebook", "pr_createdAt": "2020-12-08T17:46:22Z", "pr_url": "https://github.com/rstudio/rstudio/pull/8565", "timeline": [{"oid": "4fc8baa9a7a1e7af8afee9e1d6e2be2bfdacf3da", "url": "https://github.com/rstudio/rstudio/commit/4fc8baa9a7a1e7af8afee9e1d6e2be2bfdacf3da", "message": "convert messages from native encoding to UTF-8", "committedDate": "2020-12-07T23:50:21Z", "type": "commit"}, {"oid": "c093a114c27393ad4d263cd7f581d03b9c72324a", "url": "https://github.com/rstudio/rstudio/commit/c093a114c27393ad4d263cd7f581d03b9c72324a", "message": "convert to UTF-8 earlier", "committedDate": "2020-12-08T00:36:21Z", "type": "commit"}, {"oid": "ba36f2eec414e597f3c08b0f56b207f7a31569d6", "url": "https://github.com/rstudio/rstudio/commit/ba36f2eec414e597f3c08b0f56b207f7a31569d6", "message": "refactor notebook condition handling", "committedDate": "2020-12-08T06:30:56Z", "type": "commit"}, {"oid": "9b308a0d2fd5e4c9acbb72041af8b26aefe45a7b", "url": "https://github.com/rstudio/rstudio/commit/9b308a0d2fd5e4c9acbb72041af8b26aefe45a7b", "message": "fix invocation of disconnect", "committedDate": "2020-12-08T17:49:46Z", "type": "commit"}, {"oid": "24e482d5e2fede1b6c7ae0106fe97092e9ee1b97", "url": "https://github.com/rstudio/rstudio/commit/24e482d5e2fede1b6c7ae0106fe97092e9ee1b97", "message": "maintain consistent namespacing", "committedDate": "2020-12-08T17:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY2MTc1Nw==", "url": "https://github.com/rstudio/rstudio/pull/8565#discussion_r538661757", "bodyText": "This is really the heart of the fix; the rest of the PR is just me tidying things up along the way to finding this fix ...", "author": "kevinushey", "createdAt": "2020-12-08T17:53:45Z", "path": "src/cpp/session/modules/rmarkdown/NotebookConditions.cpp", "diffHunk": "@@ -34,7 +38,7 @@ namespace {\n SEXP rs_signalNotebookCondition(SEXP condition, SEXP message)\n {\n    // extract message (make sure we got one)\n-   std::string msg = r::sexp::safeAsString(message, \"\");\n+   std::string msg = r::sexp::asUtf8String(message);", "originalCommit": "24e482d5e2fede1b6c7ae0106fe97092e9ee1b97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MzM4NA==", "url": "https://github.com/rstudio/rstudio/pull/8565#discussion_r538893384", "bodyText": "(1) funcitons => functions\n(2) this is amazing", "author": "jmcphers", "createdAt": "2020-12-08T23:41:59Z", "path": "src/cpp/session/modules/NotebookConditions.R", "diffHunk": "@@ -0,0 +1,71 @@\n+#\n+# NotebookConditions.R\n+#\n+# Copyright (C) 2020 by RStudio, PBC\n+#\n+# Unless you have received this program directly from RStudio pursuant\n+# to the terms of a commercial license agreement with RStudio, then\n+# this program is licensed to you under the terms of version 3 of the\n+# GNU Affero General Public License. This program is distributed WITHOUT\n+# ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+# AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+#\n+#\n+\n+.rs.addFunction(\"notebookConditions.onWarning\", function(condition)\n+{\n+   prefix <- gettext(\"Warning:\", domain = \"R\")\n+   message <- paste(condition$message, collapse = \"\\n\")\n+   full <- paste(prefix, message)\n+   .Call(\"rs_signalNotebookCondition\", 1L, full, PACKAGE = \"(embedding)\")\n+   invokeRestart(\"muffleWarning\")\n+})\n+\n+.rs.addFunction(\"notebookConditions.onMessage\", function(condition)\n+{\n+   full <- paste(condition$message, collapse = \"\\n\")\n+   .Call(\"rs_signalNotebookCondition\", 0L, full, PACKAGE = \"(embedding)\")\n+   invokeRestart(\"muffleMessage\")\n+})\n+\n+# NOTE: we need to add condition handlers to the top level, but cannot\n+# actually do so if there is an R function context on the stack.\n+# To circumvent this, we use R funcitons to just provide the call object", "originalCommit": "24e482d5e2fede1b6c7ae0106fe97092e9ee1b97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4dc384d968c3297bcbdf957454e1338e721e5d9c", "url": "https://github.com/rstudio/rstudio/commit/4dc384d968c3297bcbdf957454e1338e721e5d9c", "message": "comment fixup", "committedDate": "2020-12-09T07:02:05Z", "type": "commit"}, {"oid": "6ea155b79991b58fb0c66831bc1e4293c48e58c9", "url": "https://github.com/rstudio/rstudio/commit/6ea155b79991b58fb0c66831bc1e4293c48e58c9", "message": "update NEWS", "committedDate": "2020-12-09T07:03:24Z", "type": "commit"}]}