{"pr_number": 7343, "pr_title": "fix issue with file monitor taking long time to shut down", "pr_createdAt": "2020-07-14T06:27:12Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7343", "timeline": [{"oid": "45c7378dc50386ebfa9cba1e3871a0613ac420a6", "url": "https://github.com/rstudio/rstudio/commit/45c7378dc50386ebfa9cba1e3871a0613ac420a6", "message": "fix issue with file monitor taking long time to shut down", "committedDate": "2020-07-14T18:09:21Z", "type": "commit"}, {"oid": "1f361438793b93c263d13bc5cd52f0cce3aa89d3", "url": "https://github.com/rstudio/rstudio/commit/1f361438793b93c263d13bc5cd52f0cce3aa89d3", "message": "avoid throwing exception (easier to reason about)", "committedDate": "2020-07-14T18:09:31Z", "type": "commit"}, {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1", "url": "https://github.com/rstudio/rstudio/commit/73b1e98c3095142aeadf03832fa21f538d9119e1", "message": "tweaks", "committedDate": "2020-07-14T18:09:41Z", "type": "commit"}, {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1", "url": "https://github.com/rstudio/rstudio/commit/73b1e98c3095142aeadf03832fa21f538d9119e1", "message": "tweaks", "committedDate": "2020-07-14T18:09:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1ODkxMA==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454558910", "bodyText": "Why the change from LOG_ERROR to direct logging call? I generally support reducing pre-proc macro usage as a Good Thing, but is there any other reason here?", "author": "gtritchie", "createdAt": "2020-07-14T18:28:46Z", "path": "src/cpp/core/system/file_monitor/Win32FileMonitor.cpp", "diffHunk": "@@ -91,7 +93,8 @@ void safeCloseHandle(HANDLE hObject, const ErrorLocation& location)\n    {\n       if (!::CloseHandle(hObject))\n       {\n-         LOG_ERROR(LAST_SYSTEM_ERROR());\n+         auto error = LAST_SYSTEM_ERROR();\n+         core::log::logError(error, location);", "originalCommit": "73b1e98c3095142aeadf03832fa21f538d9119e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3MDczOQ==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454570739", "bodyText": "The main reason was that the old version didn't use the location passed in from the caller.", "author": "kevinushey", "createdAt": "2020-07-14T18:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1ODkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2NDE3NQ==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454564175", "bodyText": "What are the expected consequences of this change for the non-Windows cases? Given this delay issue was Windows-specific, would it be safer to leave this part as-is and leave this change (potentially) for 1.4/master?\nThinking specifically of the QA test matrix; if code changes are definitively Windows-only, then (presumably) we can tell them to worry specifically only about Windows desktop with this change, but modifying this here seems to bring testing of Mac and Linux desktops into scope?", "author": "gtritchie", "createdAt": "2020-07-14T18:37:51Z", "path": "src/cpp/core/system/PosixFileScanner.cpp", "diffHunk": "@@ -124,6 +124,10 @@ Error scanFiles(const tree<FileInfo>::iterator_base& fromNode,\n    // iterate over the names\n    for (const std::string& name : names)\n    {\n+      // check for interrupt\n+      if (boost::this_thread::interruption_requested())\n+         return core::systemError(boost::system::errc::interrupted, ERROR_LOCATION);", "originalCommit": "73b1e98c3095142aeadf03832fa21f538d9119e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3MDIyOQ==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454570229", "bodyText": "I think ultimately other platforms run risking the same issue: the file monitor thread isn't able to clean up in time (because it's stuck in the file scanner), but we try to exit anyways and run into problems trying to shut down while the thread is still active.\nThat said, given that this is just theoretical and (AFAIK) we haven't observed this issue in v1.3 thus far, we could back this part out.", "author": "kevinushey", "createdAt": "2020-07-14T18:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2NDE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNDQ5MA==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454704490", "bodyText": "Do accesses to this registry require mutexes? (noticed they're all bare; haven't looked too closely but I know file monitors run on a thread)", "author": "jmcphers", "createdAt": "2020-07-14T23:34:57Z", "path": "src/cpp/core/system/file_monitor/Win32FileMonitor.cpp", "diffHunk": "@@ -41,13 +42,15 @@ namespace {\n // buffer size for notifications (cannot be > 64kb for network drives)\n const std::size_t kBuffSize = 32768;\n \n+// handle registry\n+std::set<Handle> s_handleRegistry;", "originalCommit": "73b1e98c3095142aeadf03832fa21f538d9119e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc4NDA4Mw==", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454784083", "bodyText": "I think you're right: these actions can be triggered either by the main thread, or by the file monitor thread itself. For example, registerMonitor() is typically called by the main thread, whereas unregisterMonitor() here is being called by the thread itself, but may also be called on the main thread -- e.g. as is done for user preferences.", "author": "kevinushey", "createdAt": "2020-07-15T04:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNDQ5MA=="}], "type": "inlineReview"}, {"oid": "4dd202e0cc7421e0a15b8b07beca3ddb606cf5d7", "url": "https://github.com/rstudio/rstudio/commit/4dd202e0cc7421e0a15b8b07beca3ddb606cf5d7", "message": "guard access to registry via mutex", "committedDate": "2020-07-15T04:39:04Z", "type": "commit"}, {"oid": "025c94542cdd16d9f1c3ebb4efadb84b72bb0749", "url": "https://github.com/rstudio/rstudio/commit/025c94542cdd16d9f1c3ebb4efadb84b72bb0749", "message": "guard usage on cleanup, just in case", "committedDate": "2020-07-15T04:42:04Z", "type": "commit"}]}