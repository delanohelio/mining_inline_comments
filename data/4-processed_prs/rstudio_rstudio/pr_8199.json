{"pr_number": 8199, "pr_title": "allow Qt 5.15.x redirects", "pr_createdAt": "2020-10-27T01:44:49Z", "pr_url": "https://github.com/rstudio/rstudio/pull/8199", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MzQ1Ng==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512843456", "bodyText": "Given where we're at in 1.4, I wouldn't make such a big change now; use of this map predates the workarounds made for the specific Qt issue, so worry there are other side effects/reasons we might be missing here.\nPlus we've never tested reliability of NavigationType in the context of Qt 5.12.8, which this code will still be using in everything but Mac desktop, so hate to open up that can of worms.\nMaybe open a separate tracking issue to revisit cleaning this up in juliet-rose when we have a bit more time to validate?", "author": "gtritchie", "createdAt": "2020-10-27T16:29:10Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -46,13 +46,6 @@ namespace {\n WindowTracker s_windowTracker;\n std::mutex s_mutex;\n \n-// NOTE: This variable is static and hence shared by all of the web pages\n-// created by RStudio. This is intentional as it's possible that the\n-// request interceptor from one page will handle a request, and a _different_\n-// page will handle the new navigation attempt -- so both pages will need\n-// access to the same data.\n-std::map<QUrl, int> s_subframes;", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MzY3Ng==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512843676", "bodyText": "This should be removed.", "author": "gtritchie", "createdAt": "2020-10-27T16:29:25Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -382,15 +370,12 @@ bool isSafeHost(const std::string& host)\n \n } // end anonymous namespace\n \n-// NOTE: NavigationType is unreliable, as per:\n-//\n-//    https://bugreports.qt.io/browse/QTBUG-56805\n-//\n-// so we avoid querying it here.\n bool WebPage::acceptNavigationRequest(const QUrl &url,\n-                                      NavigationType /* navType*/,\n+                                      NavigationType navType,\n                                       bool isMainFrame)\n {\n+   qDebug() << url << \"[\" << navType << \"]\";", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NDU4OQ==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512844589", "bodyText": "Should this be doing return isSafeHost(host); instead of just return true?", "author": "gtritchie", "createdAt": "2020-10-27T16:30:26Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -466,7 +443,13 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       {\n          return true;\n       }\n-      else\n+#if QT_VERSION >= QT_VERSION_CHECK(5, 15, 0)\n+      else if (navType == NavigationTypeRedirect)\n+      {\n+         return true;", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NTUwNg==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512845506", "bodyText": "Nervous about relying on navType in Qt 5.12.8, just because it introduces the need to retest this on all platforms. How about this just stays as \"else\", thus wrapping all use of navType in the QT_VERSION >= 5.15 and making this change a no-op for anything but Mac w/5.15?", "author": "gtritchie", "createdAt": "2020-10-27T16:31:42Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -466,7 +443,13 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       {\n          return true;\n       }\n-      else\n+#if QT_VERSION >= QT_VERSION_CHECK(5, 15, 0)\n+      else if (navType == NavigationTypeRedirect)\n+      {\n+         return true;\n+      }\n+#endif\n+      else if (navType == NavigationTypeLinkClicked)", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NjYxOQ==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512846619", "bodyText": "Don't think we need to add this to safe hosts; the issue wasn't that this wasn't being allowed (which is also the case in RStudio 1.2 and 1.3 and didn't seem to be a concern) but that we are now opening it in system browser.", "author": "gtritchie", "createdAt": "2020-10-27T16:33:18Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -358,7 +346,8 @@ void initSafeHosts()\n    safeHosts_ = {\n       \".youtube.com\",\n       \".vimeo.com\",\n-      \".c9.ms\"\n+      \".c9.ms\",\n+      \".marketo.com\"", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NzEyNA==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512847124", "bodyText": "I'd leave this in (per earlier comment about minimizing the change).", "author": "gtritchie", "createdAt": "2020-10-27T16:34:02Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -330,11 +323,6 @@ void WebPage::closeRequested()\n \n void WebPage::onUrlIntercepted(const QUrl& url, int type)\n {\n-   if (type == QWebEngineUrlRequestInfo::ResourceTypeSubFrame &&", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0ODY1Nw==", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512848657", "bodyText": "Would leave this as-is.", "author": "gtritchie", "createdAt": "2020-10-27T16:35:58Z", "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -418,14 +403,6 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       return true;\n #endif\n    \n-   // if this appears to be an attempt to load an external page within\n-   // an iframe, check it's from a safe host\n-   if (!isLocal && s_subframes.count(url))", "originalCommit": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4fa3da9f412691d9d457ac7b8fbc89901a93986", "url": "https://github.com/rstudio/rstudio/commit/e4fa3da9f412691d9d457ac7b8fbc89901a93986", "message": "handle redirects with Qt 5.15.x", "committedDate": "2020-10-27T17:16:00Z", "type": "forcePushed"}, {"oid": "48d950aaedd80eda9bc405e054951042bc376a80", "url": "https://github.com/rstudio/rstudio/commit/48d950aaedd80eda9bc405e054951042bc376a80", "message": "handle redirects with Qt 5.15.x", "committedDate": "2020-10-27T18:02:37Z", "type": "commit"}, {"oid": "48d950aaedd80eda9bc405e054951042bc376a80", "url": "https://github.com/rstudio/rstudio/commit/48d950aaedd80eda9bc405e054951042bc376a80", "message": "handle redirects with Qt 5.15.x", "committedDate": "2020-10-27T18:02:37Z", "type": "forcePushed"}]}