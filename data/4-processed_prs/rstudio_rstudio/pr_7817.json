{"pr_number": 7817, "pr_title": "remove grep color encodings when contents is not encoded", "pr_createdAt": "2020-09-17T14:53:17Z", "pr_url": "https://github.com/rstudio/rstudio/pull/7817", "timeline": [{"oid": "59b3a15db8032bd186b38c097e24e227bf01795b", "url": "https://github.com/rstudio/rstudio/commit/59b3a15db8032bd186b38c097e24e227bf01795b", "message": "remove grep color encodings when contents is not encoded", "committedDate": "2020-09-17T14:33:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MTUwOA==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490391508", "bodyText": "Is this assumption valid on Windows?", "author": "jmcphers", "createdAt": "2020-09-17T16:22:55Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1363,6 +1351,8 @@ core::Error runGrepOperation(const GrepOptions& grepOptions, const ReplaceOption\n    std::string encoding = projects::projectContext().hasProject() ?\n                           projects::projectContext().defaultEncoding() :\n                           prefs::userPrefs().defaultEncoding();\n+   if (encoding.empty())\n+      encoding = \"UTF-8\";", "originalCommit": "59b3a15db8032bd186b38c097e24e227bf01795b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMTAwMg==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490411002", "bodyText": "Yes, the only places we use the encoding are with r::util::iconvstr and the first thing that function does is change empty encodings to UTF-8. https://github.com/rstudio/rstudio/blob/master/src/cpp/r/RUtil.cpp#L143-L160", "author": "melissa-barca", "createdAt": "2020-09-17T16:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MTUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMjA5Mg==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490412092", "bodyText": "I don't think so -- on Windows, outside of an RStudio project, files will be saved in the system encoding, which will not be UTF-8. To that end, I think we need to be able to call R's iconv() machinery and tell it to conver from the native encoding to UTF-8. This is normally done by passing an empty string to Riconv_open()(https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Re_002dencoding).\nWe do a strange here to check if the \"effective\" encodings are the same, to basically avoid unnecessary conversions:\n\n  \n    \n      rstudio/src/cpp/r/RUtil.cpp\n    \n    \n        Lines 149 to 160\n      in\n      db6105f\n    \n    \n    \n    \n\n        \n          \n           std::string effectiveFrom = from; \n        \n\n        \n          \n           if (effectiveFrom.empty()) \n        \n\n        \n          \n              effectiveFrom = \"UTF-8\"; \n        \n\n        \n          \n           std::string effectiveTo = to; \n        \n\n        \n          \n           if (effectiveTo.empty()) \n        \n\n        \n          \n              effectiveTo = \"UTF-8\"; \n        \n\n        \n          \n            \n        \n\n        \n          \n           if (effectiveFrom == effectiveTo) \n        \n\n        \n          \n           { \n        \n\n        \n          \n              *pResult = value; \n        \n\n        \n          \n              return Success(); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nbut this check is also wrong (at least, on Windows; but also in theory on other platforms where a non-UTF8 locale has been set).\nIn short, I think:\n\nIt's okay to leave the encoding here as the empty string;\nThe shortcut in iconvstr() should avoid assuming that \"empty string\" -> \"UTF-8\". (perhaps the shortcut could be removed altogether, or only run on non-Windows)", "author": "kevinushey", "createdAt": "2020-09-17T16:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MTUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyMzEyNA==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490423124", "bodyText": "I updated the code with Kevin's recommendation.", "author": "melissa-barca", "createdAt": "2020-09-17T17:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MTUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MjQ0NA==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490392444", "bodyText": "Do we need to run iconvstr if the target encoding is UTF-8? (seems like asking it to convert UTF-8 to UTF-8 would be a noop)", "author": "jmcphers", "createdAt": "2020-09-17T16:23:38Z", "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1363,6 +1351,8 @@ core::Error runGrepOperation(const GrepOptions& grepOptions, const ReplaceOption\n    std::string encoding = projects::projectContext().hasProject() ?\n                           projects::projectContext().defaultEncoding() :\n                           prefs::userPrefs().defaultEncoding();\n+   if (encoding.empty())\n+      encoding = \"UTF-8\";\n    std::string encodedString;\n    error = r::util::iconvstr(grepOptions.searchPattern(),", "originalCommit": "59b3a15db8032bd186b38c097e24e227bf01795b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNDE5NQ==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490414195", "bodyText": "It's not a noop but possibly overkill, it sets encodedString = grepOptions.searchPattern() and will return early before attempting any conversion logic. encodedString writes the string in a temp file to be referenced later on.", "author": "melissa-barca", "createdAt": "2020-09-17T16:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MjQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyNTYwNA==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490425604", "bodyText": "Even if we believe this change needs to be made, it dramatically increases the surface area of this patch since we call iconvstr all over the place. As this is a last-minute change before shipping, let's limit the changes to the find and replace codepath so that we can feel 100% confident we haven't broken or changed any other behavior.", "author": "jmcphers", "createdAt": "2020-09-17T17:13:00Z", "path": "src/cpp/r/RUtil.cpp", "diffHunk": "@@ -147,11 +147,7 @@ core::Error iconvstr(const std::string& value,\n                      std::string* pResult)\n {\n    std::string effectiveFrom = from;\n-   if (effectiveFrom.empty())", "originalCommit": "d98ae0c348da0666cc55071891db6a0c0c809fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTIyOQ==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490429229", "bodyText": "That's a good point. Change has been reverted; I still removed the lines where I was setting empty to \"UTF-8\" in SessionFind as it doesn't change any logic and is inaccurate.", "author": "melissa-barca", "createdAt": "2020-09-17T17:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyNTYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTkyOA==", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490429928", "bodyText": "\ud83d\udc4d", "author": "jmcphers", "createdAt": "2020-09-17T17:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyNTYwNA=="}], "type": "inlineReview"}, {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5", "url": "https://github.com/rstudio/rstudio/commit/21af50e3eabb833e61b5c8a97d178547f83c69c5", "message": "remove assumtion that empty encoding is UTF 8 for Find in Files", "committedDate": "2020-09-17T17:16:37Z", "type": "commit"}, {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5", "url": "https://github.com/rstudio/rstudio/commit/21af50e3eabb833e61b5c8a97d178547f83c69c5", "message": "remove assumtion that empty encoding is UTF 8 for Find in Files", "committedDate": "2020-09-17T17:16:37Z", "type": "forcePushed"}]}