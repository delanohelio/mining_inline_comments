{"pr_number": 6765, "pr_title": "Callback for rstudioapi::highlightUi", "pr_createdAt": "2020-04-29T01:45:44Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6765", "timeline": [{"oid": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "url": "https://github.com/rstudio/rstudio/commit/8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "message": "allow a callback parameter to the highlightUi API call - the contents will be executed as R code\nonce the user has brought focus to the element.", "committedDate": "2020-04-29T01:42:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTMyMw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417471323", "bodyText": "nit: best practice is to use the Java interface type (List) and then instantiate it with the concrete class as required (ArrayList)", "author": "kevinushey", "createdAt": "2020-04-29T17:02:50Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -295,9 +416,11 @@ private void repositionHighlighters()\n    // Private members ----\n    \n    private JsVector<HighlightQuery> highlightQueries_;\n+   private ArrayList<Boolean> queryCallbackStatuses_;", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMTMyMg==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417511322", "bodyText": "Thanks, fixed!", "author": "melissa-barca", "createdAt": "2020-04-29T18:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU2Nw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417473567", "bodyText": "nit: you should normally wrap JavaScript functions with $entry(); see e.g.\n\n  \n    \n      rstudio/src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplicationPresenter.java\n    \n    \n        Lines 146 to 151\n      in\n      9ae3c31\n    \n    \n    \n    \n\n        \n          \n                 $wnd.addEventListener( \n        \n\n        \n          \n                       \"beforeunload\", \n        \n\n        \n          \n                       $entry(function() { \n        \n\n        \n          \n                          thiz.@org.rstudio.studio.client.shiny.ShinyApplicationPresenter::onClose()(); \n        \n\n        \n          \n                       }), \n        \n\n        \n          \n                       true); \n        \n    \n  \n\n\nSome documentation on why this is done (primarily to ensure function is executed with an appropriate exception handler for GWT):\nhttp://www.gwtproject.org/doc/latest/DevGuideCodingBasicsJSNI.html", "author": "kevinushey", "createdAt": "2020-04-29T17:06:22Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -70,19 +91,109 @@ public Element getHighlightElement()\n       {\n          return highlightedElement_;\n       }\n-      \n+\n+      public void clearHandler()\n+      {\n+         if (handler_ != null)\n+            handler_.removeHandler();\n+      }\n+\n+      public void executeCallback()\n+      {\n+         // This method must be called by a single HighlightPair, but because there can be multiple\n+         // pairs per query, we need to check if the callback has already executed before proceeding.\n+         if(!highlighter_.getCallbackProcessed(index_))\n+         {\n+            highlighter_.setCallbackProcessed(index_, true);\n+            highlighter_.getServer().executeRCode(callback_, new ServerRequestCallback<String>(){\n+\n+               @Override\n+               public void onResponseReceived(String results)\n+               {\n+                  // Remove listener from this element and all other elements with the same query\n+                  highlighter_.clearEvents();\n+               }\n+\n+               @Override\n+               public void onError(ServerError error)\n+               {\n+                  Debug.logError(error);\n+               }\n+            });\n+         }\n+      }\n+\n+      private HandlerRegistration addListener()\n+      {\n+         final JavaScriptObject functor = addEventListener(callback_, monitoredElement_);\n+\n+         return new HandlerRegistration()\n+         {\n+            public void removeHandler()\n+            {\n+               invokeFunctor(functor);\n+            }\n+         };\n+      }\n+\n+      private native JavaScriptObject addEventListener(String code, Element el)/*-{\n+         var thiz = this;\n+         var callback = function() {", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDQwNQ==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417510405", "bodyText": "Thanks for including the documentation! Fixed.", "author": "melissa-barca", "createdAt": "2020-04-29T18:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDI2Nw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417474267", "bodyText": "nit: This is really just a plain JavaScript function object rather than a functor.", "author": "kevinushey", "createdAt": "2020-04-29T17:07:28Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -70,19 +91,109 @@ public Element getHighlightElement()\n       {\n          return highlightedElement_;\n       }\n-      \n+\n+      public void clearHandler()\n+      {\n+         if (handler_ != null)\n+            handler_.removeHandler();\n+      }\n+\n+      public void executeCallback()\n+      {\n+         // This method must be called by a single HighlightPair, but because there can be multiple\n+         // pairs per query, we need to check if the callback has already executed before proceeding.\n+         if(!highlighter_.getCallbackProcessed(index_))\n+         {\n+            highlighter_.setCallbackProcessed(index_, true);\n+            highlighter_.getServer().executeRCode(callback_, new ServerRequestCallback<String>(){\n+\n+               @Override\n+               public void onResponseReceived(String results)\n+               {\n+                  // Remove listener from this element and all other elements with the same query\n+                  highlighter_.clearEvents();\n+               }\n+\n+               @Override\n+               public void onError(ServerError error)\n+               {\n+                  Debug.logError(error);\n+               }\n+            });\n+         }\n+      }\n+\n+      private HandlerRegistration addListener()\n+      {\n+         final JavaScriptObject functor = addEventListener(callback_, monitoredElement_);", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDIyMg==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417510222", "bodyText": "Fixed :)", "author": "melissa-barca", "createdAt": "2020-04-29T18:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTc0MQ==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417475741", "bodyText": "Should we also set the handler to null after removing it?", "author": "kevinushey", "createdAt": "2020-04-29T17:09:44Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -70,19 +91,109 @@ public Element getHighlightElement()\n       {\n          return highlightedElement_;\n       }\n-      \n+\n+      public void clearHandler()\n+      {\n+         if (handler_ != null)\n+            handler_.removeHandler();", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUwOTc0Mg==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417509742", "bodyText": "The handler is coded as a final variable so as is I can't reset it,  and removeHandler() is a no-op if called a second time. Do you think there is benefit for setting to null and removing the final keyword?", "author": "melissa-barca", "createdAt": "2020-04-29T18:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4MTc4Mw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417581783", "bodyText": "Good point! In that case, perhaps not. (I mostly brought that up as it's a common pattern in GWT's own codebase)", "author": "kevinushey", "createdAt": "2020-04-29T20:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NjM5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417476397", "bodyText": "Should we clear highlight on error as well?", "author": "kevinushey", "createdAt": "2020-04-29T17:10:52Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -70,19 +91,109 @@ public Element getHighlightElement()\n       {\n          return highlightedElement_;\n       }\n-      \n+\n+      public void clearHandler()\n+      {\n+         if (handler_ != null)\n+            handler_.removeHandler();\n+      }\n+\n+      public void executeCallback()\n+      {\n+         // This method must be called by a single HighlightPair, but because there can be multiple\n+         // pairs per query, we need to check if the callback has already executed before proceeding.\n+         if(!highlighter_.getCallbackProcessed(index_))\n+         {\n+            highlighter_.setCallbackProcessed(index_, true);\n+            highlighter_.getServer().executeRCode(callback_, new ServerRequestCallback<String>(){\n+\n+               @Override\n+               public void onResponseReceived(String results)\n+               {\n+                  // Remove listener from this element and all other elements with the same query\n+                  highlighter_.clearEvents();\n+               }\n+\n+               @Override\n+               public void onError(ServerError error)\n+               {\n+                  Debug.logError(error);", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDExNg==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417510116", "bodyText": "Good catch, I fixed this.", "author": "melissa-barca", "createdAt": "2020-04-29T18:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NjM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4MTU1Mw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417481553", "bodyText": "Can you elaborate a bit on what happens if you have multiple UI elements highlighted, and the callback associated with one is executed? (What happens to the other highlighted UI elements?)\nMain reason I ask: normally, one will highlight multiple UI elements either because:\n\n\nThere are multiple pieces of UI associated with the same action or command (e.g. multiple buttons for saving a document). In this case, one might want to clear all highlighters after the associated command has been executed (e.g. via click or via shortcut);\n\n\nSome of the highlighted UI might act like \"bread crumbs\"; e.g. highlighting a button + menu item leading to the \"final\" item to be clicked or used. In this case, you normally wouldn't want to clear any highlight until the user has clicked on the highlight associated with the actual command of interest.\n\n\nI'm not sure whether this orchestration should happen on the RStudio side, or if it should be a requirement of the code handling the callback.", "author": "kevinushey", "createdAt": "2020-04-29T17:19:09Z", "path": "src/gwt/src/org/rstudio/studio/client/workbench/UserInterfaceHighlighter.java", "diffHunk": "@@ -70,19 +91,109 @@ public Element getHighlightElement()\n       {\n          return highlightedElement_;\n       }\n-      \n+\n+      public void clearHandler()\n+      {\n+         if (handler_ != null)\n+            handler_.removeHandler();\n+      }\n+\n+      public void executeCallback()\n+      {\n+         // This method must be called by a single HighlightPair, but because there can be multiple\n+         // pairs per query, we need to check if the callback has already executed before proceeding.\n+         if(!highlighter_.getCallbackProcessed(index_))", "originalCommit": "8e94dc8626bb5e9e3c82c2cb169f87b5c1ac3d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUzMDA5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417530097", "bodyText": "Each callback is associated with a single query that may have multiple elements - if any of these elements are selected then the handlers for all the elements per that query are cleared. My understanding is to make case 2 possible the user would need to send a list of queries, so they would only pass the callback with the final query.\nIn case 1 if they are sending multiple queries with the same callback, then the callback will only be executed and removed from the element the user selects. Once the user clears the highlights, the other listeners will be removed as well.\nThis implementation makes intuitive sense to me, but there may be something I'm missing.", "author": "melissa-barca", "createdAt": "2020-04-29T18:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NDE1Mw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417584153", "bodyText": "Got it; I think that makes sense. It sounds like both cases are possible under the existing framework; it just affects how the user submits their highlight request through rstudioapi. Does that sound correct?\nIn each case, it seems like the ultimate goal of the callback would be to call rstudioapi::highlightUi(list()) to clear any existing highlight after the appropriate user interaction had taken place.", "author": "kevinushey", "createdAt": "2020-04-29T20:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMTkzNw==", "url": "https://github.com/rstudio/rstudio/pull/6765#discussion_r417611937", "bodyText": "Yes, that's correct! There is a chance if multiple elements have the same callback and the highlights don't get cleared that the callback code would run more than once, but I think that's the reasonable expected outcome.", "author": "melissa-barca", "createdAt": "2020-04-29T21:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4MTU1Mw=="}], "type": "inlineReview"}, {"oid": "52fe839d56a3f909bb9d519f47fb2bcf5c700daa", "url": "https://github.com/rstudio/rstudio/commit/52fe839d56a3f909bb9d519f47fb2bcf5c700daa", "message": "improve code readability and stability", "committedDate": "2020-04-29T18:40:29Z", "type": "commit"}]}