{"pr_number": 6785, "pr_title": "Dataviewer bugfixes, multisort", "pr_createdAt": "2020-04-30T20:24:40Z", "pr_url": "https://github.com/rstudio/rstudio/pull/6785", "timeline": [{"oid": "5d4b8db7b6f100049da2254e5f4610aca1e83dc6", "url": "https://github.com/rstudio/rstudio/commit/5d4b8db7b6f100049da2254e5f4610aca1e83dc6", "message": "fix datatables infobar start_end string", "committedDate": "2020-04-29T07:18:16Z", "type": "commit"}, {"oid": "ff3e2f8cffe9faa320d9ef50a0c07d41d8a1e3a9", "url": "https://github.com/rstudio/rstudio/commit/ff3e2f8cffe9faa320d9ef50a0c07d41d8a1e3a9", "message": "fix clicking on the datatable resizer also triggering a sort", "committedDate": "2020-04-29T08:26:34Z", "type": "commit"}, {"oid": "faec96448ffb6ee2dd789acadba65dee2401852b", "url": "https://github.com/rstudio/rstudio/commit/faec96448ffb6ee2dd789acadba65dee2401852b", "message": "support sorting multiple columns at once in the dataviewer", "committedDate": "2020-04-30T20:16:23Z", "type": "commit"}, {"oid": "426406439659f8faacd3804a26834fa45a8d8c14", "url": "https://github.com/rstudio/rstudio/commit/426406439659f8faacd3804a26834fa45a8d8c14", "message": "fix a couple bugs in the dataview scroller info readout, add a polyfill for IE11 support in same function", "committedDate": "2020-04-30T22:20:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyMjc0NQ==", "url": "https://github.com/rstudio/rstudio/pull/6785#discussion_r418322745", "bodyText": "Found that if you made the window small enough such that it was AJAXing data in constantly the row number would be off here as iRow doesn't encapsulate the data pagination.", "author": "adamconroy", "createdAt": "2020-04-30T22:23:24Z", "path": "src/cpp/session/resources/grid/datatables/js/jquery.dataTables.js", "diffHunk": "@@ -1636,7 +1636,7 @@\n     if ( row.nTr === null )\n     {\n       nTr = nTrIn || document.createElement('tr');\n-      nTr.setAttribute(\"data-row\", iRow);\n+      nTr.setAttribute(\"data-row\", iRow + oSettings._iDisplayStart);", "originalCommit": "426406439659f8faacd3804a26834fa45a8d8c14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NzM5Nw==", "url": "https://github.com/rstudio/rstudio/pull/6785#discussion_r418597397", "bodyText": "Because of R's wonky comparison semantics, use identical(x, y) to compare strings instead of == (for pretty much the same reasons === is generally preferred over == in JS)", "author": "jmcphers", "createdAt": "2020-05-01T15:39:45Z", "path": "src/cpp/session/modules/SessionDataViewer.R", "diffHunk": "@@ -414,22 +414,28 @@\n   }\n \n   # apply sort\n-  if (col > 0 && length(x[[col]]) > 0)\n+  if (length(cols) > 0)\n   {\n-    if (is.list(x[[col]][[1]]) || length(x[[col]][[1]]) > 1)\n+    vals <- list()\n+    for (i in length(cols))\n     {\n-      # extract the first value from each cell for ordering (handle\n-      # vector-valued columns gracefully)\n-      x <- as.data.frame(x[order(vapply(x[[col]], `[`, 0, 1), \n-                                 decreasing = identical(dir, \"desc\")), ,\n-                           drop = FALSE])\n+      idx <- cols[[i]]\n+      if (length(x[[idx]]) > 0)\n+      {\n+        if (dirs[[i]] == \"asc\")", "originalCommit": "426406439659f8faacd3804a26834fa45a8d8c14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5OTE2OA==", "url": "https://github.com/rstudio/rstudio/pull/6785#discussion_r418599168", "bodyText": "The most famous example:\n> x <- NULL\n> y <- \"foo\"\n> if (x == y) message(\"Equality achieved\")\nError in if (x == y) message(\"Equality achieved\") : \n  argument is of length zero", "author": "jmcphers", "createdAt": "2020-05-01T15:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NzM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5ODEyNQ==", "url": "https://github.com/rstudio/rstudio/pull/6785#discussion_r418598125", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  orderdir = http::util::fieldValue<std::string>(fields,  orderdirstr, \"asc\");\n          \n          \n            \n                  orderdir = http::util::fieldValue<std::string>(fields, orderdirstr, \"asc\");", "author": "jmcphers", "createdAt": "2020-05-01T15:41:18Z", "path": "src/cpp/session/modules/data/DataViewer.cpp", "diffHunk": "@@ -483,15 +483,33 @@ json::Value getData(SEXP dataSEXP, const http::Fields& fields)\n    int draw = http::util::fieldValue<int>(fields, \"draw\", 0);\n    int start = http::util::fieldValue<int>(fields, \"start\", 0);\n    int length = http::util::fieldValue<int>(fields, \"length\", 0);\n-   int ordercol = http::util::fieldValue<int>(fields, \"order[0][column]\", \n-         -1);\n-   std::string orderdir = http::util::fieldValue<std::string>(fields, \n-         \"order[0][dir]\", \"asc\");\n    std::string search = http::util::urlDecode(\n          http::util::fieldValue<std::string>(fields, \"search[value]\", \"\"));\n    std::string cacheKey = http::util::urlDecode(\n          http::util::fieldValue<std::string>(fields, \"cache_key\", \"\"));\n \n+   // loop through sort columns\n+   std::vector<int> ordercols;\n+   std::vector<std::string> orderdirs;\n+   int orderIdx = 0;\n+   int ordercol = -1;\n+   std::string orderdir;\n+   do\n+   {\n+      std::string ordercolstr = \"order[\" + std::to_string(orderIdx) + \"][column]\";\n+      std::string orderdirstr = \"order[\" + std::to_string(orderIdx) + \"][dir]\";\n+      ordercol = http::util::fieldValue<int>(fields, ordercolstr,  -1);\n+      orderdir = http::util::fieldValue<std::string>(fields,  orderdirstr, \"asc\");", "originalCommit": "426406439659f8faacd3804a26834fa45a8d8c14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6523acaef5c4c0600154c7c9fb8b357b1d9de84f", "url": "https://github.com/rstudio/rstudio/commit/6523acaef5c4c0600154c7c9fb8b357b1d9de84f", "message": "pr feedback for dataviewer", "committedDate": "2020-05-01T18:14:24Z", "type": "commit"}]}