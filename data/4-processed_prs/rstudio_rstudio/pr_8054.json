{"pr_number": 8054, "pr_title": "avoid serializing cpp11 preserve env", "pr_createdAt": "2020-10-13T21:03:36Z", "pr_url": "https://github.com/rstudio/rstudio/pull/8054", "timeline": [{"oid": "9c226f9d5421a9093156cefe984256cd4561a951", "url": "https://github.com/rstudio/rstudio/commit/9c226f9d5421a9093156cefe984256cd4561a951", "message": "avoid serializing cpp11 preserve env", "committedDate": "2020-10-13T21:06:29Z", "type": "commit"}, {"oid": "9c226f9d5421a9093156cefe984256cd4561a951", "url": "https://github.com/rstudio/rstudio/commit/9c226f9d5421a9093156cefe984256cd4561a951", "message": "avoid serializing cpp11 preserve env", "committedDate": "2020-10-13T21:06:29Z", "type": "forcePushed"}, {"oid": "196f6cdd22e791c5c74afd9970912072a491f044", "url": "https://github.com/rstudio/rstudio/commit/196f6cdd22e791c5c74afd9970912072a491f044", "message": "tweaks", "committedDate": "2020-10-13T21:07:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDIwMg==", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504264202", "bodyText": "Maybe we should add a comment here about why and link to this issue? (so future maintainers can decide whether this workaround is safe to remove)", "author": "jmcphers", "createdAt": "2020-10-13T21:18:10Z", "path": "src/cpp/r/R/Tools.R", "diffHunk": "@@ -170,28 +170,45 @@ environment(.rs.Env[[\".rs.addFunction\"]]) <- .rs.Env\n })\n \n # save current state of options() to file\n-.rs.addFunction( \"saveOptions\", function(filename)\n+.rs.addFunction(\"saveOptions\", function(filename)\n {\n-   opt = options();\n-   suppressWarnings(save(opt, file=filename))\n+   # get reference to current options\n+   opt <- options()\n+   \n+   # don't attempt to serialize cpp11 preserve env", "originalCommit": "196f6cdd22e791c5c74afd9970912072a491f044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzczMw==", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504283733", "bodyText": "Done!", "author": "kevinushey", "createdAt": "2020-10-13T22:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDUyNg==", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504264526", "bodyText": "What happens if this fails?", "author": "jmcphers", "createdAt": "2020-10-13T21:18:54Z", "path": "src/cpp/r/R/Tools.R", "diffHunk": "@@ -170,28 +170,45 @@ environment(.rs.Env[[\".rs.addFunction\"]]) <- .rs.Env\n })\n \n # save current state of options() to file\n-.rs.addFunction( \"saveOptions\", function(filename)\n+.rs.addFunction(\"saveOptions\", function(filename)\n {\n-   opt = options();\n-   suppressWarnings(save(opt, file=filename))\n+   # get reference to current options\n+   opt <- options()\n+   \n+   # don't attempt to serialize cpp11 preserve env\n+   opt$cpp11_preserve_env <- NULL\n+   \n+   # first write to sidecar file, and then rename that file\n+   # (don't let failed serialization leave behind broken workspace)\n+   sidecarFile <- paste(filename, \"incomplete\", sep = \".\")\n+   \n+   # remove an old sidecar file if any -- these would be leftover from\n+   # a previously-failed attempt to save the session\n+   unlink(sidecarFile)\n+   \n+   # now, attempt to save\n+   suppressWarnings(save(opt, file = sidecarFile))", "originalCommit": "196f6cdd22e791c5c74afd9970912072a491f044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4Mzk4Ng==", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504283986", "bodyText": "I think errors would be caught at the C++ side with the invocation of the RFunction instance. That said, it's worth at least trying to catch errors here and clean up the sidecar file on failure.", "author": "kevinushey", "createdAt": "2020-10-13T22:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDUyNg=="}], "type": "inlineReview"}, {"oid": "a5aa97581bdcf5225ed87958106e4aeffc156cac", "url": "https://github.com/rstudio/rstudio/commit/a5aa97581bdcf5225ed87958106e4aeffc156cac", "message": "add comment; try to catch save errors", "committedDate": "2020-10-13T22:01:03Z", "type": "commit"}]}