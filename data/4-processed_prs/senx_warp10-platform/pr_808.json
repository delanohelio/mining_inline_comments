{"pr_number": 808, "pr_title": "Add conversion between GeoJSON, WKT and WKB formats", "pr_createdAt": "2020-07-31T12:34:06Z", "pr_url": "https://github.com/senx/warp10-platform/pull/808", "timeline": [{"oid": "0f6316c0e2ea0a03d0583e12f0617cc7c428a0b0", "url": "https://github.com/senx/warp10-platform/commit/0f6316c0e2ea0a03d0583e12f0617cc7c428a0b0", "message": "Add conversion between GeoJSON, WKT and WKB formats", "committedDate": "2020-07-31T12:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYwNjQ2NA==", "url": "https://github.com/senx/warp10-platform/pull/808#discussion_r463606464", "bodyText": "missing final period.", "author": "hbs", "createdAt": "2020-07-31T13:21:03Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOGEOJSON.java", "diffHunk": "@@ -41,44 +48,86 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     if (top instanceof Boolean) {\n       allCells = (Boolean) top;\n       top = stack.pop();\n-    }\n \n-    if (!(top instanceof GeoXPShape)) {\n-      throw new WarpScriptException(getName() + \" operates on a GEOSHAPE.\");\n+      if (!(top instanceof GeoXPShape)) {\n+        throw new WarpScriptException(getName() + \" operates on a GEOSHAPE when first given a BOOLEAN.\");\n+      }\n     }\n \n-    GeoXPShape shape = (GeoXPShape) top;\n-\n-    if (allCells) {\n-      long[] cells = GeoXPLib.getCells(shape);\n-\n-      StringBuilder sb = new StringBuilder();\n-      sb.append(\"{\\\"type\\\":\\\"MultiPolygon\\\",\\\"coordinates\\\":[\");\n-      String prefix = \"\";\n-\n-      for (long cell: cells) {\n-        int cellRes = ((int) (cell >>> 60)) << 1;\n-        long hh = cell << 4;\n-        double[] bbox = HHCodeHelper.getHHCodeBBox(hh, cellRes);\n-        sb.append(prefix);\n-        prefix = \",\";\n-        // Counterclockwise from sw, lon/lat\n-        sb.append(\"[[[\").append(bbox[1]).append(\",\").append(bbox[0]).append(\"],\");// SW\n-        sb.append(\"[\").append(bbox[3]).append(\",\").append(bbox[0]).append(\"],\"); // SE\n-        sb.append(\"[\").append(bbox[3]).append(\",\").append(bbox[2]).append(\"],\"); // NE\n-        sb.append(\"[\").append(bbox[1]).append(\",\").append(bbox[2]).append(\"],\"); // NW\n-        sb.append(\"[\").append(bbox[1]).append(\",\").append(bbox[0]).append(\"]]]\"); // SW\n-      }\n+    if (top instanceof GeoXPShape) {\n+      GeoXPShape shape = (GeoXPShape) top;\n+\n+      if (allCells) {\n+        long[] cells = GeoXPLib.getCells(shape);\n+\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(\"{\\\"type\\\":\\\"MultiPolygon\\\",\\\"coordinates\\\":[\");\n+        String prefix = \"\";\n \n-      sb.append(\"]}\");\n+        for (long cell: cells) {\n+          int cellRes = ((int) (cell >>> 60)) << 1;\n+          long hh = cell << 4;\n+          double[] bbox = HHCodeHelper.getHHCodeBBox(hh, cellRes);\n+          sb.append(prefix);\n+          prefix = \",\";\n+          // Counterclockwise from sw, lon/lat\n+          sb.append(\"[[[\").append(bbox[1]).append(\",\").append(bbox[0]).append(\"],\");// SW\n+          sb.append(\"[\").append(bbox[3]).append(\",\").append(bbox[0]).append(\"],\"); // SE\n+          sb.append(\"[\").append(bbox[3]).append(\",\").append(bbox[2]).append(\"],\"); // NE\n+          sb.append(\"[\").append(bbox[1]).append(\",\").append(bbox[2]).append(\"],\"); // NW\n+          sb.append(\"[\").append(bbox[1]).append(\",\").append(bbox[0]).append(\"]]]\"); // SW\n+        }\n \n-      stack.push(sb.toString());\n+        sb.append(\"]}\");\n+\n+        stack.push(sb.toString());\n+      } else {\n+        long[] cells = GeoXPLib.getCells(shape);\n+        Coverage coverage = new Coverage(cells);\n+        stack.push(CoverageHelper.toGeoJSON(coverage));\n+      }\n     } else {\n-      long[] cells = GeoXPLib.getCells(shape);\n-      Coverage coverage = new Coverage(cells);\n-      stack.push(CoverageHelper.toGeoJSON(coverage));\n+      try {\n+        Geometry geometry = toGeometry(top);\n+        GeoJSONWriter writer = new GeoJSONWriter();\n+        GeoJSON json = writer.write(geometry);\n+        stack.push(json.toString());\n+      } catch (WarpScriptException wse) {\n+        throw new WarpScriptException(getName() + \" expects a GEOSHAPE, a WKT STRING or WKB BYTES.\", wse);\n+      } catch (ParseException pe) {\n+        throw new WarpScriptException(getName() + \" was given invalid input.\", pe);\n+      }\n     }\n \n     return stack;\n   }\n+\n+  public static Geometry toGeometry(Object geomObject) throws WarpScriptException, ParseException {\n+\n+    Geometry geometry;\n+\n+    if (geomObject instanceof byte[]) {\n+      // WKB\n+      WKBReader reader = new WKBReader();\n+\n+      geometry = reader.read((byte[]) geomObject);\n+    } else if (geomObject instanceof String) {\n+      String geomString = ((String) geomObject).trim();\n+      if (geomString.startsWith(\"{\")) {\n+        // GeoJson\n+        GeoJSONReader reader = new GeoJSONReader();\n+\n+        geometry = reader.read(geomString);\n+      } else {\n+        // WKT\n+        WKTReader reader = new WKTReader();\n+\n+        geometry = reader.read(geomString);\n+      }\n+    } else {\n+      throw new WarpScriptException(\"Unknown geometry format\");", "originalCommit": "0f6316c0e2ea0a03d0583e12f0617cc7c428a0b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3c5b977292f4984da26d463c9ba0fb6f3831a08", "url": "https://github.com/senx/warp10-platform/commit/c3c5b977292f4984da26d463c9ba0fb6f3831a08", "message": "Add conversion from GeoXPShape to WKT/WKB", "committedDate": "2020-07-31T14:21:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4OTM5OA==", "url": "https://github.com/senx/warp10-platform/pull/808#discussion_r464289398", "bodyText": "Duplicate The", "author": "hbs", "createdAt": "2020-08-03T09:10:17Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOWKB.java", "diffHunk": "@@ -0,0 +1,63 @@\n+//\n+//    Copyright 2020  SenX S.A.S.\n+//\n+//    Licensed under the Apache License, Version 2.0 (the \"License\");\n+//    you may not use this file except in compliance with the License.\n+//    You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//    Unless required by applicable law or agreed to in writing, software\n+//    distributed under the License is distributed on an \"AS IS\" BASIS,\n+//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//    See the License for the specific language governing permissions and\n+//    limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import com.geoxp.GeoXPLib;\n+import com.vividsolutions.jts.geom.Geometry;\n+import com.vividsolutions.jts.io.ParseException;\n+import com.vividsolutions.jts.io.WKBWriter;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class TOWKB extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+  private TOGEOJSON togeojson;\n+\n+  public TOWKB(String name) {\n+    super(name);\n+    togeojson = new TOGEOJSON(name);\n+  }\n+\n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    // The the top of the stack is either a GeoXPShape or a Boolean, then we apply GEOJSON to convert it to", "originalCommit": "c3c5b977292f4984da26d463c9ba0fb6f3831a08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5MDEzMw==", "url": "https://github.com/senx/warp10-platform/pull/808#discussion_r464290133", "bodyText": "Duplicate the", "author": "hbs", "createdAt": "2020-08-03T09:11:39Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOWKT.java", "diffHunk": "@@ -0,0 +1,60 @@\n+//\n+//    Copyright 2020  SenX S.A.S.\n+//\n+//    Licensed under the Apache License, Version 2.0 (the \"License\");\n+//    you may not use this file except in compliance with the License.\n+//    You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//    Unless required by applicable law or agreed to in writing, software\n+//    distributed under the License is distributed on an \"AS IS\" BASIS,\n+//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//    See the License for the specific language governing permissions and\n+//    limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import com.geoxp.GeoXPLib;\n+import com.vividsolutions.jts.geom.Geometry;\n+import com.vividsolutions.jts.io.ParseException;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class TOWKT extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+  private TOGEOJSON togeojson;\n+\n+  public TOWKT(String name) {\n+    super(name);\n+    togeojson = new TOGEOJSON(name);\n+  }\n+\n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    // The the top of the stack is either a GeoXPShape or a Boolean, then we apply GEOJSON to convert it to", "originalCommit": "c3c5b977292f4984da26d463c9ba0fb6f3831a08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "acd250e3c6f77cf88a93fe76e8a5a88a2a45952b", "url": "https://github.com/senx/warp10-platform/commit/acd250e3c6f77cf88a93fe76e8a5a88a2a45952b", "message": "Fix typo", "committedDate": "2020-08-03T12:28:34Z", "type": "commit"}]}