{"pr_number": 648, "pr_title": "Added support for fetching TrueType fonts via http/https", "pr_createdAt": "2020-01-25T17:48:25Z", "pr_url": "https://github.com/senx/warp10-platform/pull/648", "timeline": [{"oid": "83c541d1a8615fa3a9d84a3f70594531fe5727ae", "url": "https://github.com/senx/warp10-platform/commit/83c541d1a8615fa3a9d84a3f70594531fe5727ae", "message": "Added support for fetching TrueType fonts via http/https", "committedDate": "2020-01-25T17:31:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1MDE1Ng==", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375350156", "bodyText": "Fails if url contains a space. This can be avoided by double escaping in WarpScript ie %2520.\nEscape in code or to be documented.", "author": "ftence", "createdAt": "2020-02-05T16:05:46Z", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -45,21 +80,62 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     PFont font = null;\n     \n-    if (3 == params.size()) {\n-      font = pg.parent.createFont(params.get(1).toString(), ((Number) params.get(2)).floatValue());\n-    } else if (4 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)));\n-    } else if (5 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)),\n-          params.get(4).toString().toCharArray());\n-    }\n+    //\n+    // Handle the case of remote font files differently, passing the URL\n+    // to the defined validator\n+    //\n+    \n+    if (params.get(1).toString().startsWith(\"http://\") || params.get(1).toString().startsWith(\"https://\")) {\n+      String url = resolver.resolve(params.get(1).toString());\n \n+      InputStream in = null;\n+      \n+      try {\n+        //\n+        // FIXME(hbs): support WOFF/WOFF2 on top of TTF/OTF\n+        //\n+        in = new URL(url).openStream();", "originalCommit": "83c541d1a8615fa3a9d84a3f70594531fe5727ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NDQ5MA==", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375354490", "bodyText": "Why use a resolver instead of a validator?\nIf it needs to stay a resolver, can't this macro return a special value for forbidden access, like NULL or an empty stack and produce a clear error message?", "author": "ftence", "createdAt": "2020-02-05T16:12:34Z", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -31,9 +39,36 @@\n  * Call createFont\n  */\n public class PcreateFont extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+    \n+  private final FontResolver resolver;\n   \n+  private static class FontResolver {\n+    \n+    private final String warpscript;\n+    \n+    public FontResolver(String mc2) {\n+      this.warpscript = mc2;\n+    }\n+    \n+    public String resolve(String url) throws WarpScriptException {\n+      if (null == this.warpscript) {\n+        throw new WarpScriptException(\"Font resolver not set, rejecting all URLs.\");\n+      }\n+      try {\n+        MemoryWarpScriptStack stack = new MemoryWarpScriptStack(null, null);\n+        stack.push(url);\n+        stack.exec(this.warpscript);\n+        return (String) stack.pop();", "originalCommit": "83c541d1a8615fa3a9d84a3f70594531fe5727ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5NDY4MA==", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375894680", "bodyText": "Simply do a FAILMSG in your resolver if you want to reject the font. The WarpScriptException will be forwarded upstream.", "author": "hbs", "createdAt": "2020-02-06T15:16:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NDQ5MA=="}], "type": "inlineReview"}, {"oid": "54fe37095953f60a212f4af055af2659a29da0da", "url": "https://github.com/senx/warp10-platform/commit/54fe37095953f60a212f4af055af2659a29da0da", "message": "Added a call to URLEncoder#encode if the URL contains a space", "committedDate": "2020-02-06T15:17:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNjIxNg==", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r376316216", "bodyText": "This will fail because it will also escape part of the URL which should not be escaped resulting it \"https%3A%2F%2F\"...\nYou could unconditionally do a url.replace(\" \", \"%20\")\nor a nice solution from SO:\n      String urlStr = resolver.resolve(params.get(1).toString());\n\n      InputStream in = null;\n      \n      try {\n        URL url = new URL(urlStr);\n        URI uri = new URI(url.getProtocol(), url.getUserInfo(), url.getHost(), url.getPort(), url.getPath(), url.getQuery(), url.getRef());\n        \n        in = new URL(uri.toASCIIString()).openStream();", "author": "ftence", "createdAt": "2020-02-07T10:20:45Z", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -94,6 +96,12 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n         //\n         // FIXME(hbs): support WOFF/WOFF2 on top of TTF/OTF\n         //\n+        \n+        // Encode the URL if it contains a whitespace\n+        if (url.contains(\" \")) {\n+          url = URLEncoder.encode(url, StandardCharsets.UTF_8.name());\n+        }", "originalCommit": "54fe37095953f60a212f4af055af2659a29da0da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNjg2MA==", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r376316860", "bodyText": "Could be nice to also allow file://.\n(Tested and working with the SO solution below).", "author": "ftence", "createdAt": "2020-02-07T10:22:08Z", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -45,21 +82,68 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     PFont font = null;\n     \n-    if (3 == params.size()) {\n-      font = pg.parent.createFont(params.get(1).toString(), ((Number) params.get(2)).floatValue());\n-    } else if (4 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)));\n-    } else if (5 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)),\n-          params.get(4).toString().toCharArray());\n-    }\n+    //\n+    // Handle the case of remote font files differently, passing the URL\n+    // to the defined validator\n+    //\n+    \n+    if (params.get(1).toString().startsWith(\"http://\") || params.get(1).toString().startsWith(\"https://\")) {", "originalCommit": "54fe37095953f60a212f4af055af2659a29da0da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "55b5c335b224060c36c10f0654fdb4253e7a3940", "url": "https://github.com/senx/warp10-platform/commit/55b5c335b224060c36c10f0654fdb4253e7a3940", "message": "Added support for file:// and corrected handling of whitespaces", "committedDate": "2020-02-07T11:48:57Z", "type": "commit"}]}