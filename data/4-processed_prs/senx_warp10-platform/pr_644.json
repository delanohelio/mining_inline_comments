{"pr_number": 644, "pr_title": "Filter any all", "pr_createdAt": "2020-01-24T11:16:09Z", "pr_url": "https://github.com/senx/warp10-platform/pull/644", "timeline": [{"oid": "8b578037fdb647420d47b8c5bc2f1deabbb0f90a", "url": "https://github.com/senx/warp10-platform/commit/8b578037fdb647420d47b8c5bc2f1deabbb0f90a", "message": "any eq", "committedDate": "2020-01-24T10:58:51Z", "type": "commit"}, {"oid": "8c582bc9517ef7000e562e14ff9ac1fb3a03cb4d", "url": "https://github.com/senx/warp10-platform/commit/8c582bc9517ef7000e562e14ff9ac1fb3a03cb4d", "message": "any ne", "committedDate": "2020-01-24T10:59:01Z", "type": "commit"}, {"oid": "fb145e3b63b04125acefad70f1b69659daf053de", "url": "https://github.com/senx/warp10-platform/commit/fb145e3b63b04125acefad70f1b69659daf053de", "message": "any ge", "committedDate": "2020-01-24T11:01:43Z", "type": "commit"}, {"oid": "d625c47c145374ef2f773faa7f763b6acd7a078d", "url": "https://github.com/senx/warp10-platform/commit/d625c47c145374ef2f773faa7f763b6acd7a078d", "message": "bugfix", "committedDate": "2020-01-24T11:02:05Z", "type": "commit"}, {"oid": "8019d58484f9c81ed5320a3f97d0286e8c23d405", "url": "https://github.com/senx/warp10-platform/commit/8019d58484f9c81ed5320a3f97d0286e8c23d405", "message": "any gt", "committedDate": "2020-01-24T11:02:50Z", "type": "commit"}, {"oid": "a9efb159ca3b9ee77694d85882cbc4ea4221801a", "url": "https://github.com/senx/warp10-platform/commit/a9efb159ca3b9ee77694d85882cbc4ea4221801a", "message": "any le", "committedDate": "2020-01-24T11:03:39Z", "type": "commit"}, {"oid": "4d9fa1ce00434a4c9f380102b2fd77de8f328502", "url": "https://github.com/senx/warp10-platform/commit/4d9fa1ce00434a4c9f380102b2fd77de8f328502", "message": "any lt", "committedDate": "2020-01-24T11:04:27Z", "type": "commit"}, {"oid": "483b792c77f3dd981f867f6e4bd6e5df3a2ebf26", "url": "https://github.com/senx/warp10-platform/commit/483b792c77f3dd981f867f6e4bd6e5df3a2ebf26", "message": "filter any to warpscriptlib", "committedDate": "2020-01-24T11:11:13Z", "type": "commit"}, {"oid": "85499027b51840fbc92f4a5a25ed699768dfbcd8", "url": "https://github.com/senx/warp10-platform/commit/85499027b51840fbc92f4a5a25ed699768dfbcd8", "message": "filter all to warpscriptlib", "committedDate": "2020-01-24T11:11:34Z", "type": "commit"}, {"oid": "0a764866feb5630de7e09ea401458b2833857eb0", "url": "https://github.com/senx/warp10-platform/commit/0a764866feb5630de7e09ea401458b2833857eb0", "message": "bugfix all vs any, must take the complement set", "committedDate": "2020-01-24T11:39:02Z", "type": "commit"}, {"oid": "8b2fd83a9228bc12aa60bc8c820516217ec470bf", "url": "https://github.com/senx/warp10-platform/commit/8b2fd83a9228bc12aa60bc8c820516217ec470bf", "message": "refactoring all any in one", "committedDate": "2020-01-24T12:51:21Z", "type": "commit"}, {"oid": "75b57d8b1113e406a6b145872e8f46f63a6c9fdb", "url": "https://github.com/senx/warp10-platform/commit/75b57d8b1113e406a6b145872e8f46f63a6c9fdb", "message": "delete unused class", "committedDate": "2020-01-24T12:52:16Z", "type": "commit"}, {"oid": "5721f6776ac61eba2b4c13cd8712508486d82498", "url": "https://github.com/senx/warp10-platform/commit/5721f6776ac61eba2b4c13cd8712508486d82498", "message": "simplification", "committedDate": "2020-01-24T12:59:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyMDc3Ng==", "url": "https://github.com/senx/warp10-platform/pull/644#discussion_r370620776", "bodyText": "Include function name", "author": "hbs", "createdAt": "2020-01-24T12:59:11Z", "path": "warp10/src/main/java/io/warp10/script/filter/FilterAny.java", "diffHunk": "@@ -0,0 +1,178 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.filter;\n+\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.gts.GeoTimeSerie.TYPE;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.StackUtils;\n+import io.warp10.script.WarpScriptFilterFunction;\n+import io.warp10.script.WarpScriptStackFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FilterAny extends NamedWarpScriptFunction implements WarpScriptFilterFunction {\n+\n+  public enum Comparator {\n+    EQ,\n+    GE,\n+    GT,\n+    LE,\n+    LT,\n+    NE\n+  }\n+\n+  private final TYPE type;\n+  private final Object threshold;\n+  private final boolean complementSet;\n+  private final Comparator comparator;\n+\n+  public static class Builder extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+    private final boolean complementSet;\n+    private final Comparator comparator;\n+\n+    public Builder(String name, Comparator comparator, boolean complement) {\n+      super(name);\n+      this.comparator =comparator;\n+      this.complementSet = complement;\n+    }\n+\n+    public Builder(String name, Comparator comparator) {\n+      super(name);\n+      this.comparator = comparator;\n+      this.complementSet = false;\n+    }\n+\n+    @Override\n+    public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+      Object threshold = stack.pop();\n+      stack.push(new FilterAny(getName(), threshold, this.comparator, this.complementSet));\n+      return stack;\n+    }\n+  }\n+\n+  public FilterAny(String name, Object threshold, Comparator comparator, boolean complementSet) throws WarpScriptException {\n+    super(name);\n+    this.comparator = comparator;\n+    this.complementSet = complementSet;\n+\n+    boolean allowBooleanThreshold = comparator == Comparator.EQ || comparator == Comparator.NE;\n+\n+    if (threshold instanceof Long) {\n+      this.type = TYPE.LONG;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof Double) {\n+      this.type = TYPE.DOUBLE;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof String) {\n+      this.type = TYPE.STRING;\n+      this.threshold = threshold;\n+    } else if (allowBooleanThreshold && threshold instanceof Boolean) {\n+      this.type = TYPE.BOOLEAN;\n+      this.threshold = threshold;\n+    } else {\n+      throw new WarpScriptException(\"Invalid threshold type.\");", "originalCommit": "75b57d8b1113e406a6b145872e8f46f63a6c9fdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyMTYwNg==", "url": "https://github.com/senx/warp10-platform/pull/644#discussion_r370621606", "bodyText": "drop whitespace before ':'", "author": "hbs", "createdAt": "2020-01-24T13:01:21Z", "path": "warp10/src/main/java/io/warp10/script/filter/FilterAny.java", "diffHunk": "@@ -0,0 +1,178 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.filter;\n+\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.gts.GeoTimeSerie.TYPE;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.StackUtils;\n+import io.warp10.script.WarpScriptFilterFunction;\n+import io.warp10.script.WarpScriptStackFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FilterAny extends NamedWarpScriptFunction implements WarpScriptFilterFunction {\n+\n+  public enum Comparator {\n+    EQ,\n+    GE,\n+    GT,\n+    LE,\n+    LT,\n+    NE\n+  }\n+\n+  private final TYPE type;\n+  private final Object threshold;\n+  private final boolean complementSet;\n+  private final Comparator comparator;\n+\n+  public static class Builder extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+    private final boolean complementSet;\n+    private final Comparator comparator;\n+\n+    public Builder(String name, Comparator comparator, boolean complement) {\n+      super(name);\n+      this.comparator =comparator;\n+      this.complementSet = complement;\n+    }\n+\n+    public Builder(String name, Comparator comparator) {\n+      super(name);\n+      this.comparator = comparator;\n+      this.complementSet = false;\n+    }\n+\n+    @Override\n+    public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+      Object threshold = stack.pop();\n+      stack.push(new FilterAny(getName(), threshold, this.comparator, this.complementSet));\n+      return stack;\n+    }\n+  }\n+\n+  public FilterAny(String name, Object threshold, Comparator comparator, boolean complementSet) throws WarpScriptException {\n+    super(name);\n+    this.comparator = comparator;\n+    this.complementSet = complementSet;\n+\n+    boolean allowBooleanThreshold = comparator == Comparator.EQ || comparator == Comparator.NE;\n+\n+    if (threshold instanceof Long) {\n+      this.type = TYPE.LONG;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof Double) {\n+      this.type = TYPE.DOUBLE;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof String) {\n+      this.type = TYPE.STRING;\n+      this.threshold = threshold;\n+    } else if (allowBooleanThreshold && threshold instanceof Boolean) {\n+      this.type = TYPE.BOOLEAN;\n+      this.threshold = threshold;\n+    } else {\n+      throw new WarpScriptException(\"Invalid threshold type.\");\n+    }\n+  }\n+\n+  private boolean verify(int i) throws WarpScriptException {\n+    switch (this.comparator) {\n+      case EQ:\n+        return i == 0;\n+      case GE:\n+        return i <= 0;\n+      case GT:\n+        return i < 0;\n+      case LE:\n+        return i >= 0;\n+      case LT:\n+        return i > 0;\n+      case NE:\n+        return i != 0;\n+      default:\n+        throw new WarpScriptException(getName() + \" has been implemented with an unknown comparator.\");\n+    }\n+  }\n+\n+  @Override\n+  public List<GeoTimeSerie> filter(Map<String,String> labels, List<GeoTimeSerie>... series) throws WarpScriptException {\n+    List<GeoTimeSerie> retained = new ArrayList<GeoTimeSerie>();\n+\n+    for (List<GeoTimeSerie> gtsinstances: series) {\n+      for (GeoTimeSerie serie: gtsinstances) {\n+        boolean found = false;\n+        int i = 0;\n+\n+        while(!found && i < serie.size()) {\n+          Object val = GTSHelper.valueAtIndex(serie, i++);\n+\n+          switch (type) {\n+            case LONG:\n+              found = verify(((Long) threshold).compareTo(((Number) val).longValue()));\n+              break;\n+            case DOUBLE:\n+              found = verify(((Double) threshold).compareTo(((Number) val).doubleValue()));\n+              break;\n+            case STRING:\n+              found = verify(((String) threshold).compareTo(val.toString()));\n+              break;\n+            case BOOLEAN:\n+              if (!(((Boolean) threshold).equals(val) ^ this.comparator == Comparator.EQ)) {\n+                found = true;\n+              }\n+              break;\n+          }\n+\n+          if (found) {\n+            retained.add(serie);\n+          }\n+        }\n+      }\n+    }\n+\n+    if (complementSet) {\n+      List<GeoTimeSerie> retained_ = new ArrayList<GeoTimeSerie>();\n+\n+      for (List<GeoTimeSerie> gtsinstances: series) {\n+        for (GeoTimeSerie serie : gtsinstances) {", "originalCommit": "75b57d8b1113e406a6b145872e8f46f63a6c9fdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyMzI5MQ==", "url": "https://github.com/senx/warp10-platform/pull/644#discussion_r370623291", "bodyText": "outdated, see 5721f67", "author": "randomboolean", "createdAt": "2020-01-24T13:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyMTYwNg=="}], "type": "inlineReview"}, {"oid": "c9958935758ef7603e312e65e9af6952347b2b63", "url": "https://github.com/senx/warp10-platform/commit/c9958935758ef7603e312e65e9af6952347b2b63", "message": "function name in error msg", "committedDate": "2020-01-24T13:04:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyOTU5Mg==", "url": "https://github.com/senx/warp10-platform/pull/644#discussion_r370629592", "bodyText": "Add a comment explaining the logic as it is not obvious from just looking at the code since the operator is the opposite of what the function actually checks", "author": "hbs", "createdAt": "2020-01-24T13:21:31Z", "path": "warp10/src/main/java/io/warp10/script/filter/FilterAny.java", "diffHunk": "@@ -0,0 +1,164 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.filter;\n+\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.gts.GeoTimeSerie.TYPE;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.StackUtils;\n+import io.warp10.script.WarpScriptFilterFunction;\n+import io.warp10.script.WarpScriptStackFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FilterAny extends NamedWarpScriptFunction implements WarpScriptFilterFunction {\n+\n+  public enum Comparator {\n+    EQ,\n+    GE,\n+    GT,\n+    LE,\n+    LT,\n+    NE\n+  }\n+\n+  private final TYPE type;\n+  private final Object threshold;\n+  private final boolean complementSet;\n+  private final Comparator comparator;\n+\n+  public static class Builder extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+    private final boolean complementSet;\n+    private final Comparator comparator;\n+\n+    public Builder(String name, Comparator comparator, boolean complement) {\n+      super(name);\n+      this.comparator =comparator;\n+      this.complementSet = complement;\n+    }\n+\n+    public Builder(String name, Comparator comparator) {\n+      super(name);\n+      this.comparator = comparator;\n+      this.complementSet = false;\n+    }\n+\n+    @Override\n+    public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+      Object threshold = stack.pop();\n+      stack.push(new FilterAny(getName(), threshold, this.comparator, this.complementSet));\n+      return stack;\n+    }\n+  }\n+\n+  public FilterAny(String name, Object threshold, Comparator comparator, boolean complementSet) throws WarpScriptException {\n+    super(name);\n+    this.comparator = comparator;\n+    this.complementSet = complementSet;\n+\n+    boolean allowBooleanThreshold = comparator == Comparator.EQ || comparator == Comparator.NE;\n+\n+    if (threshold instanceof Long) {\n+      this.type = TYPE.LONG;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof Double) {\n+      this.type = TYPE.DOUBLE;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof String) {\n+      this.type = TYPE.STRING;\n+      this.threshold = threshold;\n+    } else if (allowBooleanThreshold && threshold instanceof Boolean) {\n+      this.type = TYPE.BOOLEAN;\n+      this.threshold = threshold;\n+    } else {\n+      throw new WarpScriptException(getName() + \" threshold type is invalid.\");\n+    }\n+  }\n+\n+  private boolean verify(int i) throws WarpScriptException {\n+    switch (this.comparator) {\n+      case EQ:\n+        return i == 0;\n+      case GE:\n+        return i <= 0;\n+      case GT:\n+        return i < 0;\n+      case LE:\n+        return i >= 0;\n+      case LT:\n+        return i > 0;\n+      case NE:\n+        return i != 0;\n+      default:\n+        throw new WarpScriptException(getName() + \" has been implemented with an unknown comparator.\");\n+    }\n+  }\n+\n+  @Override\n+  public List<GeoTimeSerie> filter(Map<String,String> labels, List<GeoTimeSerie>... series) throws WarpScriptException {\n+    List<GeoTimeSerie> retained = new ArrayList<GeoTimeSerie>();\n+\n+    for (List<GeoTimeSerie> gtsinstances: series) {\n+      for (GeoTimeSerie serie: gtsinstances) {\n+        boolean found = false;\n+        int i = 0;\n+\n+        while(!found && i < serie.size()) {\n+          Object val = GTSHelper.valueAtIndex(serie, i++);\n+\n+          switch (type) {\n+            case LONG:\n+              found = verify(((Long) threshold).compareTo(((Number) val).longValue()));\n+              break;\n+            case DOUBLE:\n+              found = verify(((Double) threshold).compareTo(((Number) val).doubleValue()));\n+              break;\n+            case STRING:\n+              found = verify(((String) threshold).compareTo(val.toString()));\n+              break;\n+            case BOOLEAN:\n+              if (!(((Boolean) threshold).equals(val) ^ this.comparator == Comparator.EQ)) {\n+                found = true;\n+              }\n+              break;\n+          }\n+        }\n+\n+        if (found ^ this.complementSet) {", "originalCommit": "c9958935758ef7603e312e65e9af6952347b2b63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca3a0732d8025a12c91700cc23d7dbb341301e98", "url": "https://github.com/senx/warp10-platform/commit/ca3a0732d8025a12c91700cc23d7dbb341301e98", "message": "add comments", "committedDate": "2020-01-24T13:35:37Z", "type": "commit"}, {"oid": "7a81303286904e55e3fcb181a0ec545ef951b9b5", "url": "https://github.com/senx/warp10-platform/commit/7a81303286904e55e3fcb181a0ec545ef951b9b5", "message": "simplification", "committedDate": "2020-01-24T13:37:10Z", "type": "commit"}, {"oid": "1b2188ca8fd515b237b030e0cc4b4951e6ee530b", "url": "https://github.com/senx/warp10-platform/commit/1b2188ca8fd515b237b030e0cc4b4951e6ee530b", "message": "bugfix", "committedDate": "2020-01-24T13:38:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY0OTM1MA==", "url": "https://github.com/senx/warp10-platform/pull/644#discussion_r370649350", "bodyText": "Be more expressive in the description, the loop above exits when one datapoint which satisfies the comparison is found, in the case of an 'all' match, the operator checked is the opposite of the wanted one, therefore when one datapoint matches the opposite comparison, it means that not all the datapoints satisfy it and therefore, as the comparison operator is the opposite of the one we really want, it means that not all the datapoints satisfy the opposite comparison either and therefore we do not retain the series. The boolean logic is not enough of an explanation for the person discovering the code.", "author": "hbs", "createdAt": "2020-01-24T14:05:41Z", "path": "warp10/src/main/java/io/warp10/script/filter/FilterAny.java", "diffHunk": "@@ -0,0 +1,165 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.filter;\n+\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.gts.GeoTimeSerie.TYPE;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.StackUtils;\n+import io.warp10.script.WarpScriptFilterFunction;\n+import io.warp10.script.WarpScriptStackFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class FilterAny extends NamedWarpScriptFunction implements WarpScriptFilterFunction {\n+\n+  public enum Comparator {\n+    EQ,\n+    GE,\n+    GT,\n+    LE,\n+    LT,\n+    NE\n+  }\n+\n+  private final TYPE type;\n+  private final Object threshold;\n+  private final boolean complementSet; // if true, the filter does the opposite (so filter.all.* can be built using the same builder)\n+  private final Comparator comparator;\n+\n+  public static class Builder extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+    private final boolean complementSet;\n+    private final Comparator comparator;\n+\n+    public Builder(String name, Comparator comparator, boolean complement) {\n+      super(name);\n+      this.comparator =comparator;\n+      this.complementSet = complement;\n+    }\n+\n+    public Builder(String name, Comparator comparator) {\n+      super(name);\n+      this.comparator = comparator;\n+      this.complementSet = false;\n+    }\n+\n+    @Override\n+    public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+      Object threshold = stack.pop();\n+      stack.push(new FilterAny(getName(), threshold, this.comparator, this.complementSet));\n+      return stack;\n+    }\n+  }\n+\n+  public FilterAny(String name, Object threshold, Comparator comparator, boolean complementSet) throws WarpScriptException {\n+    super(name);\n+    this.comparator = comparator;\n+    this.complementSet = complementSet;\n+\n+    boolean allowBooleanThreshold = comparator == Comparator.EQ || comparator == Comparator.NE;\n+\n+    if (threshold instanceof Long) {\n+      this.type = TYPE.LONG;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof Double) {\n+      this.type = TYPE.DOUBLE;\n+      this.threshold = threshold;\n+    } else if (threshold instanceof String) {\n+      this.type = TYPE.STRING;\n+      this.threshold = threshold;\n+    } else if (allowBooleanThreshold && threshold instanceof Boolean) {\n+      this.type = TYPE.BOOLEAN;\n+      this.threshold = threshold;\n+    } else {\n+      throw new WarpScriptException(getName() + \" threshold type is invalid.\");\n+    }\n+  }\n+\n+  private boolean verify(int i) throws WarpScriptException {\n+    switch (this.comparator) {\n+      case EQ:\n+        return i == 0;\n+      case GE:\n+        return i <= 0;\n+      case GT:\n+        return i < 0;\n+      case LE:\n+        return i >= 0;\n+      case LT:\n+        return i > 0;\n+      case NE:\n+        return i != 0;\n+      default:\n+        throw new WarpScriptException(getName() + \" has been implemented with an unknown comparator.\");\n+    }\n+  }\n+\n+  @Override\n+  public List<GeoTimeSerie> filter(Map<String,String> labels, List<GeoTimeSerie>... series) throws WarpScriptException {\n+    List<GeoTimeSerie> retained = new ArrayList<GeoTimeSerie>();\n+\n+    for (List<GeoTimeSerie> gtsinstances: series) {\n+      for (GeoTimeSerie serie: gtsinstances) {\n+        boolean found = false;\n+        int i = 0;\n+\n+        while(!found && i < serie.size()) {\n+          Object val = GTSHelper.valueAtIndex(serie, i++);\n+\n+          switch (type) {\n+            case LONG:\n+              found = verify(((Long) threshold).compareTo(((Number) val).longValue()));\n+              break;\n+            case DOUBLE:\n+              found = verify(((Double) threshold).compareTo(((Number) val).doubleValue()));\n+              break;\n+            case STRING:\n+              found = verify(((String) threshold).compareTo(val.toString()));\n+              break;\n+            case BOOLEAN:\n+              found = ((Boolean) threshold).equals(val) ^ this.comparator == Comparator.NE;\n+              break;\n+          }\n+        }\n+\n+        // In case of wanting the complementSet, the logic is reversed.", "originalCommit": "1b2188ca8fd515b237b030e0cc4b4951e6ee530b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c43e963cb0f7f6d3c677297c976f4327013c5e61", "url": "https://github.com/senx/warp10-platform/commit/c43e963cb0f7f6d3c677297c976f4327013c5e61", "message": "more comments", "committedDate": "2020-01-24T15:05:16Z", "type": "commit"}, {"oid": "3198dc0b200781b8ba03036da0d290cad439a61f", "url": "https://github.com/senx/warp10-platform/commit/3198dc0b200781b8ba03036da0d290cad439a61f", "message": "resolved conflict", "committedDate": "2020-01-24T15:09:54Z", "type": "commit"}]}