{"pr_number": 658, "pr_title": "Initial commit of GEO.GEOHASHES", "pr_createdAt": "2020-02-06T22:56:09Z", "pr_url": "https://github.com/senx/warp10-platform/pull/658", "timeline": [{"oid": "8080e34e0a6587018bc02be45c1980eb068e6f61", "url": "https://github.com/senx/warp10-platform/commit/8080e34e0a6587018bc02be45c1980eb068e6f61", "message": "Initial commit of GEO.GEOHASHES", "committedDate": "2020-02-06T22:55:33Z", "type": "commit"}, {"oid": "771943e9b959694aa0be08b01b414a5c01c1f4c6", "url": "https://github.com/senx/warp10-platform/commit/771943e9b959694aa0be08b01b414a5c01c1f4c6", "message": "Fixed handling of non aligned bit length", "committedDate": "2020-02-06T23:12:29Z", "type": "commit"}, {"oid": "c41b3df94484f6bdc3db8b7f92a3dff2efb64130", "url": "https://github.com/senx/warp10-platform/commit/c41b3df94484f6bdc3db8b7f92a3dff2efb64130", "message": "Fixed typo", "committedDate": "2020-02-06T23:18:10Z", "type": "commit"}, {"oid": "666646fbb77e89e11de93accc73915c3381b0f79", "url": "https://github.com/senx/warp10-platform/commit/666646fbb77e89e11de93accc73915c3381b0f79", "message": "Bumped GeoXPLib to 1.0.0-rc19 and refactored GEOGEOHASHES", "committedDate": "2020-02-07T07:01:33Z", "type": "commit"}, {"oid": "23c9ea94f0a02648c37a9941b6bd32593e5debfa", "url": "https://github.com/senx/warp10-platform/commit/23c9ea94f0a02648c37a9941b6bd32593e5debfa", "message": "Renamed GEOGEOHASHES", "committedDate": "2020-02-11T10:30:53Z", "type": "commit"}, {"oid": "5fd0cc14713f819e8d76f8f7d40bbe6ec9307896", "url": "https://github.com/senx/warp10-platform/commit/5fd0cc14713f819e8d76f8f7d40bbe6ec9307896", "message": "Refactored GEOHASH-> and ->GEOHASH to handle GEOSHAPE instances", "committedDate": "2020-02-11T10:31:31Z", "type": "commit"}, {"oid": "a79b9b814b9490bdc7a2c92e6c2da9197c0d13de", "url": "https://github.com/senx/warp10-platform/commit/a79b9b814b9490bdc7a2c92e6c2da9197c0d13de", "message": "Forced optimization of GeoHashes.", "committedDate": "2020-02-11T14:18:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY0MjEzNg==", "url": "https://github.com/senx/warp10-platform/pull/658#discussion_r377642136", "bodyText": "Add else cause to throw an error for incorrect type.", "author": "ftence", "createdAt": "2020-02-11T13:45:31Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOGEOHASH.java", "diffHunk": "@@ -36,17 +41,27 @@ public TOGEOHASH(String name) {\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     \n-    Object lon = stack.pop();\n-    Object lat = stack.pop();\n+    Object top = stack.pop();\n     \n-    if (!(lon instanceof Number) && !(lat instanceof Number)) {\n-      throw new WarpScriptException(getName() + \" expects a latitude and a longitude on the stack.\");\n+    if (top instanceof GeoXPShape) {\n+      List<String> geohashes = new ArrayList<String>(GeoHashHelper.fromGeoCells(GeoXPLib.getCells((GeoXPShape) top), false));\n+      stack.push(geohashes);      \n+    } else if (top instanceof Long) {\n+      String geohash = GeoHashHelper.fromHHCode(((Long) top).longValue(), 32);      \n+      stack.push(geohash);            \n+    } else if (top instanceof Double) {\n+      Object lon = (Double) top;\n+      Object lat = stack.pop();\n+      \n+      if (!(lat instanceof Double)) {\n+        throw new WarpScriptException(getName() + \" expects a latitude and a longitude on the stack.\");\n+      }\n+      \n+      long geoxppoint = GeoXPLib.toGeoXPPoint(((Number) lat).doubleValue(), ((Number) lon).doubleValue());\n+      String geohash = GeoHashHelper.fromHHCode(geoxppoint, 32);\n+      \n+      stack.push(geohash);      \n     }", "originalCommit": "5fd0cc14713f819e8d76f8f7d40bbe6ec9307896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY0MjQyMQ==", "url": "https://github.com/senx/warp10-platform/pull/658#discussion_r377642421", "bodyText": "Useless cast to Double.", "author": "ftence", "createdAt": "2020-02-11T13:45:58Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOGEOHASH.java", "diffHunk": "@@ -36,17 +41,27 @@ public TOGEOHASH(String name) {\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     \n-    Object lon = stack.pop();\n-    Object lat = stack.pop();\n+    Object top = stack.pop();\n     \n-    if (!(lon instanceof Number) && !(lat instanceof Number)) {\n-      throw new WarpScriptException(getName() + \" expects a latitude and a longitude on the stack.\");\n+    if (top instanceof GeoXPShape) {\n+      List<String> geohashes = new ArrayList<String>(GeoHashHelper.fromGeoCells(GeoXPLib.getCells((GeoXPShape) top), false));\n+      stack.push(geohashes);      \n+    } else if (top instanceof Long) {\n+      String geohash = GeoHashHelper.fromHHCode(((Long) top).longValue(), 32);      \n+      stack.push(geohash);            \n+    } else if (top instanceof Double) {\n+      Object lon = (Double) top;", "originalCommit": "5fd0cc14713f819e8d76f8f7d40bbe6ec9307896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1920ce18a62edd94ae43651a9bd54e1320d5892", "url": "https://github.com/senx/warp10-platform/commit/e1920ce18a62edd94ae43651a9bd54e1320d5892", "message": "Addressed PR comments", "committedDate": "2020-02-11T14:27:53Z", "type": "commit"}, {"oid": "868a3ccba57b2b389ebaace2ec51b4cad0b35899", "url": "https://github.com/senx/warp10-platform/commit/868a3ccba57b2b389ebaace2ec51b4cad0b35899", "message": "Bumped GeoXPLib to 1.0.0-rc21 to have GeoHash syntax checks", "committedDate": "2020-02-11T14:29:33Z", "type": "commit"}, {"oid": "69e3cd0556fff75f108380d6309828b40487a2b7", "url": "https://github.com/senx/warp10-platform/commit/69e3cd0556fff75f108380d6309828b40487a2b7", "message": "Fixed merge conflict", "committedDate": "2020-02-11T14:30:55Z", "type": "commit"}, {"oid": "00b0445002f1280effe5bb0255292a9f38d9f2db", "url": "https://github.com/senx/warp10-platform/commit/00b0445002f1280effe5bb0255292a9f38d9f2db", "message": "Bumped GeoXPLib to 1.0.0-rc22", "committedDate": "2020-02-12T08:35:36Z", "type": "commit"}, {"oid": "5de1cd17b9c1af6782d6cefdb09cf4117522fb12", "url": "https://github.com/senx/warp10-platform/commit/5de1cd17b9c1af6782d6cefdb09cf4117522fb12", "message": "Fixed merge conflict", "committedDate": "2020-02-12T11:23:31Z", "type": "commit"}]}