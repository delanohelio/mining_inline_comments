{"pr_number": 853, "pr_title": "Add a limit parameter to SPLIT", "pr_createdAt": "2020-09-28T10:16:01Z", "pr_url": "https://github.com/senx/warp10-platform/pull/853", "timeline": [{"oid": "a1a0442f7ddc42ddbe63968df097c34d0590533b", "url": "https://github.com/senx/warp10-platform/commit/a1a0442f7ddc42ddbe63968df097c34d0590533b", "message": "Add a limit parameter to SPLIT", "committedDate": "2020-09-28T10:10:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzNTg0OQ==", "url": "https://github.com/senx/warp10-platform/pull/853#discussion_r495835849", "bodyText": "-1 == index", "author": "hbs", "createdAt": "2020-09-28T10:19:56Z", "path": "warp10/src/main/java/io/warp10/script/functions/SPLIT.java", "diffHunk": "@@ -16,56 +16,94 @@\n \n package io.warp10.script.functions;\n \n-import io.warp10.continuum.gts.UnsafeString;\n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n-import java.net.URLDecoder;\n import java.util.ArrayList;\n import java.util.List;\n \n /**\n- * Split a String in segments given a delimiter\n+ * Split a String in segments given a delimiter.\n+ * <p>\n+ * The limit parameter controls the number of times the pattern is applied and therefore affects the length of the\n+ * resulting array. If the limit n is greater than zero then the pattern will be applied at most n - 1 times, the\n+ * array's length will be no greater than n, and the array's last entry will contain all input beyond the last matched\n+ * delimiter.\n  */\n public class SPLIT extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public SPLIT(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n-    \n+\n+    int limit = Integer.MAX_VALUE;\n+\n+    if (o instanceof Long) {\n+      limit = Math.toIntExact((Long) o);\n+\n+      if (limit <= 0) {\n+        throw new WarpScriptException(getName() + \" expects the limit to be a strictly positive integer.\");\n+      }\n+\n+      o = stack.pop();\n+    }\n+\n     if (!(o instanceof String)) {\n       throw new WarpScriptException(getName() + \" expects a string delimiter of length 1.\");\n     }\n-    \n+\n     if (1 != o.toString().length()) {\n       throw new WarpScriptException(getName() + \" expects a string delimiter of length 1.\");\n     }\n \n     char delimiter = o.toString().charAt(0);\n-    \n+\n     o = stack.pop();\n \n     if (!(o instanceof String)) {\n       throw new WarpScriptException(getName() + \" operates on a String.\");\n     }\n \n+    stack.push(split(o.toString(), delimiter, limit));\n \n-    String[] tokens = UnsafeString.split(o.toString(), delimiter);\n-    \n-    List<String> ltokens = new ArrayList<String>();\n-    \n-    for (String token: tokens) {\n-      ltokens.add(token);\n-    }\n-    \n-    stack.push(ltokens);\n-    \n     return stack;\n   }\n+\n+  /**\n+   * Split a string using a delimiter and returning a List of \"limit\" maximum length.\n+   * @param input The String instance to be split.\n+   * @param delim The delimiter to use for the split.\n+   * @param limit The returned List maximum size. For limit <= 0 the List contains the input.\n+   * @return A List of splits.\n+   */\n+  public static List<String> split(String input, char delim, int limit) {\n+    ArrayList<String> l = new ArrayList<String>();\n+    int offset = 0;\n+    int splits = 1;\n+\n+    while (splits < limit) {\n+      int index = input.indexOf(delim, offset);\n+      if (index == -1) {", "originalCommit": "a1a0442f7ddc42ddbe63968df097c34d0590533b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0571e663d689493147817747bd5534f66c87e9a", "url": "https://github.com/senx/warp10-platform/commit/d0571e663d689493147817747bd5534f66c87e9a", "message": "Yoda condition", "committedDate": "2020-09-28T10:31:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3NjE4Mw==", "url": "https://github.com/senx/warp10-platform/pull/853#discussion_r495876183", "bodyText": "Could use (String) o since you checked that o was indeed an instance of String.", "author": "hbs", "createdAt": "2020-09-28T11:41:47Z", "path": "warp10/src/main/java/io/warp10/script/functions/SPLIT.java", "diffHunk": "@@ -16,56 +16,94 @@\n \n package io.warp10.script.functions;\n \n-import io.warp10.continuum.gts.UnsafeString;\n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n-import java.net.URLDecoder;\n import java.util.ArrayList;\n import java.util.List;\n \n /**\n- * Split a String in segments given a delimiter\n+ * Split a String in segments given a delimiter.\n+ * <p>\n+ * The limit parameter controls the number of times the pattern is applied and therefore affects the length of the\n+ * resulting array. If the limit n is greater than zero then the pattern will be applied at most n - 1 times, the\n+ * array's length will be no greater than n, and the array's last entry will contain all input beyond the last matched\n+ * delimiter.\n  */\n public class SPLIT extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public SPLIT(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n-    \n+\n+    int limit = Integer.MAX_VALUE;\n+\n+    if (o instanceof Long) {\n+      limit = Math.toIntExact((Long) o);\n+\n+      if (limit <= 0) {\n+        throw new WarpScriptException(getName() + \" expects the limit to be a strictly positive integer.\");\n+      }\n+\n+      o = stack.pop();\n+    }\n+\n     if (!(o instanceof String)) {\n       throw new WarpScriptException(getName() + \" expects a string delimiter of length 1.\");\n     }\n-    \n+\n     if (1 != o.toString().length()) {\n       throw new WarpScriptException(getName() + \" expects a string delimiter of length 1.\");\n     }\n \n     char delimiter = o.toString().charAt(0);\n-    \n+\n     o = stack.pop();\n \n     if (!(o instanceof String)) {\n       throw new WarpScriptException(getName() + \" operates on a String.\");\n     }\n \n+    stack.push(split(o.toString(), delimiter, limit));", "originalCommit": "d0571e663d689493147817747bd5534f66c87e9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3NjE5NQ==", "url": "https://github.com/senx/warp10-platform/pull/853#discussion_r495876195", "bodyText": "Can use (String) o", "author": "hbs", "createdAt": "2020-09-28T11:41:50Z", "path": "warp10/src/main/java/io/warp10/script/functions/SPLIT.java", "diffHunk": "@@ -16,56 +16,94 @@\n \n package io.warp10.script.functions;\n \n-import io.warp10.continuum.gts.UnsafeString;\n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n-import java.net.URLDecoder;\n import java.util.ArrayList;\n import java.util.List;\n \n /**\n- * Split a String in segments given a delimiter\n+ * Split a String in segments given a delimiter.\n+ * <p>\n+ * The limit parameter controls the number of times the pattern is applied and therefore affects the length of the\n+ * resulting array. If the limit n is greater than zero then the pattern will be applied at most n - 1 times, the\n+ * array's length will be no greater than n, and the array's last entry will contain all input beyond the last matched\n+ * delimiter.\n  */\n public class SPLIT extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public SPLIT(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n-    \n+\n+    int limit = Integer.MAX_VALUE;\n+\n+    if (o instanceof Long) {\n+      limit = Math.toIntExact((Long) o);\n+\n+      if (limit <= 0) {\n+        throw new WarpScriptException(getName() + \" expects the limit to be a strictly positive integer.\");\n+      }\n+\n+      o = stack.pop();\n+    }\n+\n     if (!(o instanceof String)) {\n       throw new WarpScriptException(getName() + \" expects a string delimiter of length 1.\");\n     }\n-    \n+\n     if (1 != o.toString().length()) {", "originalCommit": "d0571e663d689493147817747bd5534f66c87e9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61dca6659ec9e717eaf93e3aead73bf5d7caf557", "url": "https://github.com/senx/warp10-platform/commit/61dca6659ec9e717eaf93e3aead73bf5d7caf557", "message": "Swap toString() to String cast", "committedDate": "2020-09-28T12:54:23Z", "type": "commit"}]}