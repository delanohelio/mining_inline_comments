{"pr_number": 190, "pr_title": "DEV-1481 Specify image from CLI", "pr_createdAt": "2020-09-02T14:15:45Z", "pr_url": "https://github.com/hartwigmedical/pipeline5/pull/190", "timeline": [{"oid": "fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "url": "https://github.com/hartwigmedical/pipeline5/commit/fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "message": "DEV-1481 Specify image from CLI", "committedDate": "2020-09-02T14:14:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MDI4Nw==", "url": "https://github.com/hartwigmedical/pipeline5/pull/190#discussion_r482170287", "bodyText": "I think we should keep all flags used in the CLI in this class for now or do a larger refactor. Prefer the consistency to the small duplication between CommonArguments and this list.", "author": "pauldwolfe", "createdAt": "2020-09-02T15:38:54Z", "path": "cluster/src/main/java/com/hartwig/pipeline/CommandLineOptions.java", "diffHunk": "@@ -59,7 +63,7 @@\n     private static final String SET_ID_FLAG = \"set_id\";\n     private static final String SBP_RUN_ID_FLAG = \"sbp_run_id\";\n     private static final String NETWORK_FLAG = \"network\";\n-    private static final String CMEK_FLAG = \"cmek\";\n+//    private static final String CMEK_FLAG = \"cmek\";", "originalCommit": "fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MTQ2Nw==", "url": "https://github.com/hartwigmedical/pipeline5/pull/190#discussion_r482171467", "bodyText": "lets make this a bit more descriptive", "author": "pauldwolfe", "createdAt": "2020-09-02T15:40:30Z", "path": "cluster/src/main/java/com/hartwig/pipeline/CommandLineOptions.java", "diffHunk": "@@ -118,21 +122,26 @@ private static Options options() {\n                 .addOption(zone())\n                 .addOption(refGenomeVersion())\n                 .addOption(maxConcurrentLanes())\n-                .addOption(json());\n+                .addOption(json())\n+                .addOption(imageName());\n     }\n \n     private static Option json() {\n         return optionWithArg(SAMPLE_JSON_FLAG, \"JSON file defining the location of FASTQ inputs in GCP.\");\n     }\n \n+    private static Option imageName() {\n+        return optionWithArg(IMAGE_NAME, \"Image to use instead of the default\");", "originalCommit": "fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MjQyOA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/190#discussion_r482172428", "bodyText": "As the argument is optional, we should use the features of Optional and not have another \"empty\" case of an empty string. You can either just not specify the image name in the builder or use Optional.empty(). I think the former is most consistent with what's already here.", "author": "pauldwolfe", "createdAt": "2020-09-02T15:41:45Z", "path": "cluster/src/main/java/com/hartwig/pipeline/Arguments.java", "diffHunk": "@@ -161,11 +161,11 @@ static String workingDir() {\n                     .publishToTurquoise(false)\n                     .pollInterval(DEFAULT_POLL_INTERVAL)\n                     .refGenomeVersion(DEFAULT_REF_GENOME_VERSION)\n-                    .maxConcurrentLanes(DEFAULT_MAX_CONCURRENT_LANES);\n+                    .maxConcurrentLanes(DEFAULT_MAX_CONCURRENT_LANES)\n+                    .imageName(EMPTY);", "originalCommit": "fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE3MzM4Nw==", "url": "https://github.com/hartwigmedical/pipeline5/pull/190#discussion_r482173387", "bodyText": "I think better to just not expose the image name argument to batch, then you can also remove the check for empty string in the compute engine.", "author": "pauldwolfe", "createdAt": "2020-09-02T15:43:09Z", "path": "batch/src/main/java/com/hartwig/batch/BatchArguments.java", "diffHunk": "@@ -45,7 +47,7 @@ static BatchArguments from(String[] args) {\n                     .outputBucket(commandLine.getOptionValue(OUTPUT_BUCKET))\n                     .cmek(commandLine.getOptionValue(CMEK, CommonArguments.DEFAULT_DEVELOPMENT_CMEK))\n                     .network(commandLine.getOptionValue(PRIVATE_NETWORK, DEFAULT_NETWORK))\n-                    .usePublicImage(false)\n+                    .imageName(commandLine.getOptionValue(IMAGE_NAME, EMPTY))", "originalCommit": "fa097ca4ee33bb148fd5c4dd72b3e399dee51544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b08fd573247b18841320aae83f84d9c367070fa", "url": "https://github.com/hartwigmedical/pipeline5/commit/3b08fd573247b18841320aae83f84d9c367070fa", "message": "DEV-1481 Cleanup per review comments", "committedDate": "2020-09-02T23:18:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY4MTg1NQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/190#discussion_r483681855", "bodyText": "How is this related?", "author": "pauldwolfe", "createdAt": "2020-09-04T15:14:23Z", "path": "batch/src/test/java/com/hartwig/batch/input/InputParserProviderTest.java", "diffHunk": "@@ -16,17 +15,23 @@\n     public void shouldReturnJsonParserWhenOperationSpecifiesIt() {\n         InputParserProvider victim = new InputParserProvider();\n         BatchOperation operation = mock(BatchOperation.class);\n-        BatchArguments arguments = TestingArguments.defaultArgs(\"someOp\");\n \n         OperationDescriptor descriptor = mock(OperationDescriptor.class);\n         when(operation.descriptor()).thenReturn(descriptor);\n         when(descriptor.inputType()).thenReturn(OperationDescriptor.InputType.JSON);\n-        victim.from(operation);\n-        assertThat(1).isEqualTo(1);\n+        InputParser parser = victim.from(operation);\n+        assertThat(parser.getClass()).isEqualTo(JsonInputParser.class);\n     }\n \n     @Test\n     public void shouldReturnFlatParserWhenOperationSpecifiesIt() {\n+        InputParserProvider victim = new InputParserProvider();", "originalCommit": "3b08fd573247b18841320aae83f84d9c367070fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}