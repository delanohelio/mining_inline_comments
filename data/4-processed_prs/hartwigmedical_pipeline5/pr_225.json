{"pr_number": 225, "pr_title": "DEV-1645 Automate tool upgrade, image creation and docker image", "pr_createdAt": "2020-11-11T19:32:39Z", "pr_url": "https://github.com/hartwigmedical/pipeline5/pull/225", "timeline": [{"oid": "ad39a6bd44b7fc064582600079ee60795b870ac6", "url": "https://github.com/hartwigmedical/pipeline5/commit/ad39a6bd44b7fc064582600079ee60795b870ac6", "message": "DEV-1645 Automate tool upgrade, image creation and docker image\n\nSimple script to copy the new jar into the common-tools bucket and start the image creation process. This now\nis broken up into two sets of commands: base and tools. Passing the -t flag will create an image from the\nprevious build in the family, only overlaying the tools dir.\n\nOtherwise the upgrade script does a maven build to create a docker container and push it to GCR (rather than\ndocker hub).", "committedDate": "2020-11-11T19:30:13Z", "type": "commit"}, {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7", "url": "https://github.com/hartwigmedical/pipeline5/commit/51da400dfcce52b1f8d012556fa8185c874d68f7", "message": "DEV-1645 Set the version back to local-SNAPSHOT", "committedDate": "2020-11-11T19:31:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NDc5MA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521644790", "bodyText": "This can be written as all_cmds=\"$base_image_cmds $tools_image_cmds\"", "author": "nedleitch", "createdAt": "2020-11-11T21:19:23Z", "path": "cluster/images/generate_imaging_script.sh", "diffHunk": "@@ -4,29 +4,41 @@\n \n LOCATION=\"europe-west4\"\n ZONE=\"${LOCATION}-a\"\n-PROJECT=\"hmf-pipeline-development\" \n-TYPE=\"pipeline5\"\n+PROJECT=\"hmf-pipeline-development\"\n VERSION=5-17\n \n-if [ -n \"$1\" ]; then\n-    FLAVOUR=\"$1\"\n+TOOLS_ONLY=false\n+while getopts ':tf:' flag; do\n+    case \"${flag}\" in\n+        t) TOOLS_ONLY=true ;;\n+        f) FLAVOUR=${OPTARG} ;;\n+        *) ;;\n+    esac\n+done\n+sourceInstance=\"pipeline5-${VERSION}${FLAVOUR+\"-$FLAVOUR\"}\"\n+image_project=\"debian-cloud\"\n+image_family=\"debian-9\"\n+base_image_cmds=\"$(dirname \"$0\")/base.cmds\"\n+tools_image_cmds=\"$(dirname \"$0\")/tools.cmds\"\n+all_cmds=$(echo $base_image_cmds $tools_image_cmds)", "originalCommit": "51da400dfcce52b1f8d012556fa8185c874d68f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0OTY1MQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521649651", "bodyText": "Missing $", "author": "nedleitch", "createdAt": "2020-11-11T21:29:46Z", "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1\n+version=$2\n+full=${tool}-${version}\n+local_jar=\"${full}.jar\"\n+if [ -n \"$3\" ]; then\n+  local_jar=\"$3\"\n+else\n+  wget \"https://github.com/hartwigmedical/hmftools/releases/download/${tool}-v${version}/${full}.jar\"\n+fi\n+gsutil cp $local_jar \"gs://common-tools/${tool}/${version}/${tool}.jar\"\n+if [ -z \"$3\" ]; then\n+  rm local_jar", "originalCommit": "51da400dfcce52b1f8d012556fa8185c874d68f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MDY5NQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521650695", "bodyText": "Recommend starting with this preamble given how many things could potentially fail in this script:\n#!/usr/bin/env bash\n\nset -e\n\nThat way it will die straight away if say the wget fails.", "author": "nedleitch", "createdAt": "2020-11-11T21:32:00Z", "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1", "originalCommit": "51da400dfcce52b1f8d012556fa8185c874d68f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjA4MQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521652081", "bodyText": "Would prefer something a little more robust here, like \"$(dirname $0)/images/create_custom_image.sh -t\" so we've made a reasonable effort to allow it to be run from outside the directory it lives in.", "author": "nedleitch", "createdAt": "2020-11-11T21:35:15Z", "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1\n+version=$2\n+full=${tool}-${version}\n+local_jar=\"${full}.jar\"\n+if [ -n \"$3\" ]; then\n+  local_jar=\"$3\"\n+else\n+  wget \"https://github.com/hartwigmedical/hmftools/releases/download/${tool}-v${version}/${full}.jar\"\n+fi\n+gsutil cp $local_jar \"gs://common-tools/${tool}/${version}/${tool}.jar\"\n+if [ -z \"$3\" ]; then\n+  rm local_jar\n+fi\n+\n+./images/create_custom_image.sh -t", "originalCommit": "51da400dfcce52b1f8d012556fa8185c874d68f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE3NTQ5Ng==", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r523175496", "bodyText": "it needs to run in the directory of the poms", "author": "pauldwolfe", "createdAt": "2020-11-13T19:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjA4MQ=="}], "type": "inlineReview"}, {"oid": "82782912da594591b2d6418779bb2b17707e8896", "url": "https://github.com/hartwigmedical/pipeline5/commit/82782912da594591b2d6418779bb2b17707e8896", "message": "DEV-1645 Review comments", "committedDate": "2020-11-13T19:30:33Z", "type": "commit"}]}