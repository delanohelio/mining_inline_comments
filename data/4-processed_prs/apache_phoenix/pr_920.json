{"pr_number": 920, "pr_title": "PHOENIX-6129 : Optimize tableExists() call while retrieving correct MUTEX table", "pr_createdAt": "2020-10-14T11:43:05Z", "pr_url": "https://github.com/apache/phoenix/pull/920", "timeline": [{"oid": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75", "url": "https://github.com/apache/phoenix/commit/5e3b5d9720a39519b1710642ea2dd19b2ad86b75", "message": "PHOENIX-6129 : Avoid redundant Admin API call in the absence of SYSTEM.MUTEX table", "committedDate": "2020-10-14T11:40:37Z", "type": "commit"}, {"oid": "9aafabf08960b698b38cb00088650cfeabeab9d3", "url": "https://github.com/apache/phoenix/commit/9aafabf08960b698b38cb00088650cfeabeab9d3", "message": "removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()", "committedDate": "2020-10-14T14:31:51Z", "type": "commit"}, {"oid": "9aafabf08960b698b38cb00088650cfeabeab9d3", "url": "https://github.com/apache/phoenix/commit/9aafabf08960b698b38cb00088650cfeabeab9d3", "message": "removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()", "committedDate": "2020-10-14T14:31:51Z", "type": "forcePushed"}, {"oid": "30e1a9eca2f528fb0380b98d1cdfa40b2fe4e6e8", "url": "https://github.com/apache/phoenix/commit/30e1a9eca2f528fb0380b98d1cdfa40b2fe4e6e8", "message": "Revert \"removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()\"\n\nThis reverts commit 9aafabf08960b698b38cb00088650cfeabeab9d3.", "committedDate": "2020-10-14T14:39:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504750907", "bodyText": "byte[] sysMutexPhysicalTableNameBytes = getSysMutexPhysicalTableNameBytes();\nIf I understand correctly what @ChinmaySKulkarni described in the ticket, this call will still result to an admin.tableExists call to check the existance of SYSTEM.MUTEX/SYSTEM:MUTEX and you didn't changed that.", "author": "richardantal", "createdAt": "2020-10-14T15:01:33Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4294,11 +4295,9 @@ public boolean acquireUpgradeMutex(long currentServerSideTableTimestamp)\n     public boolean writeMutexCell(String tenantId, String schemaName, String tableName,\n             String columnName, String familyName) throws SQLException {\n         try {\n-            byte[] rowKey =\n-                    columnName != null\n-                            ? SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName,\n-                                familyName)\n-                            : SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n+            byte[] rowKey = columnName != null ?\n+                SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName, familyName) :\n+                SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n             // at this point the system mutex table should have been created or\n             // an exception thrown\n             byte[] sysMutexPhysicalTableNameBytes = getSysMutexPhysicalTableNameBytes();", "originalCommit": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MzEyNA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504753124", "bodyText": "try (Table sysMutexTable = getTable(sysMutexPhysicalTableNameBytes)) {\nInstead We could try the Table sysMutexTable =getTable() call with one of them and catch HBase TableNotFoundException, in that case try with the other one.", "author": "richardantal", "createdAt": "2020-10-14T15:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1OTQyNA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504759424", "bodyText": "If getSysMutexPhysicalTableNameBytes() start throwing TableNotFoundException, then at this point the Exception would be thrown and caught, so we would not go ahead with next getTable() call.", "author": "virajjasani", "createdAt": "2020-10-14T15:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc2MDA2OQ==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504760069", "bodyText": "Here is the throw part: https://github.com/apache/phoenix/pull/920/files#diff-539e6818644fa837ebee4e4b61f4c570f75ac439437050c9a0459762ef8e385cR4373", "author": "virajjasani", "createdAt": "2020-10-14T15:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMDExOA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r505900118", "bodyText": "@virajjasani I think there is some confusion here. The aim of this Jira is to reduce the HBase calls to get the table. Currently, the call to writeMutexCell() calls getSysMutexPhysicalTableNameBytes() which does 1 or 2 HBase admin calls (tableExists()) and then we still do a getTable() call here.\nThe same happens for deleteMutexCell().\nInstead of calling getSysMutexPhysicalTableNameBytes(), we can do 1 getTable() call with SYSTEM.MUTEX and if that throws a TNFE, try again with SYSTEM:MUTEX thus eliminating the tableExists() calls.", "author": "ChinmaySKulkarni", "createdAt": "2020-10-15T22:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA3MjkzMw==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r506072933", "bodyText": "My bad for this misunderstanding. Addressed concerns, updated the PR.", "author": "virajjasani", "createdAt": "2020-10-16T06:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}], "type": "inlineReview"}, {"oid": "c0abcd6fa537ea708014cf8b904f62c4d65fdbcb", "url": "https://github.com/apache/phoenix/commit/c0abcd6fa537ea708014cf8b904f62c4d65fdbcb", "message": "checkstyle fix", "committedDate": "2020-10-15T13:49:53Z", "type": "commit"}, {"oid": "da486863e993d0d4fc9b96519cb359b2a0c3d49c", "url": "https://github.com/apache/phoenix/commit/da486863e993d0d4fc9b96519cb359b2a0c3d49c", "message": "incorporating review", "committedDate": "2020-10-16T13:16:43Z", "type": "commit"}, {"oid": "da486863e993d0d4fc9b96519cb359b2a0c3d49c", "url": "https://github.com/apache/phoenix/commit/da486863e993d0d4fc9b96519cb359b2a0c3d49c", "message": "incorporating review", "committedDate": "2020-10-16T13:16:43Z", "type": "forcePushed"}, {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22", "url": "https://github.com/apache/phoenix/commit/f376592bd41cc38122f4d823b74e2da104f36d22", "message": "Merge branch 'master' of github.com:apache/phoenix into PHOENIX-6129-master", "committedDate": "2020-10-16T13:17:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3MDI2NA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509470264", "bodyText": "nit: table variable is unnecessary here", "author": "ChinmaySKulkarni", "createdAt": "2020-10-21T17:22:54Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {\n+        String table = SYSTEM_MUTEX_NAME;", "originalCommit": "f376592bd41cc38122f4d823b74e2da104f36d22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwMDgyMg==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509600822", "bodyText": "It's being used here also, hence kept it for simplicity:\n                table = table.replace(QueryConstants.NAME_SEPARATOR,\n                    QueryConstants.NAMESPACE_SEPARATOR);\n\nIs that fine keeping table as is? It might look simplified. Thought?", "author": "virajjasani", "createdAt": "2020-10-21T19:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3MDI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3NDk2MQ==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509474961", "bodyText": "Please add a unit test for this new method.", "author": "ChinmaySKulkarni", "createdAt": "2020-10-21T17:27:32Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {", "originalCommit": "f376592bd41cc38122f4d823b74e2da104f36d22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MjAxOA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509482018", "bodyText": "Just want to clarify one thing based on your comment about connection.getTable(). At this point, SYS.MUTEX doesn't exist so we try to retrieve SYS:MUTEX. As per your findings, connection.getTable(SYS:MUTEX) would return a Table object however it is not guaranteed that the table actually exists. This scenario is the same as returning null from the previous getSysMutexPhysicalTableNameBytes() method and then attempting to retrieve a null table.\nCan you confirm that this scenario (probably an impossible one albeit) is safe and we don't run into any weirdness?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-21T17:32:55Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {\n+        String table = SYSTEM_MUTEX_NAME;\n+        TableName tableName = TableName.valueOf(table);\n+        try (Admin admin = getAdmin()) {\n+            if (!admin.tableExists(tableName)) {\n+                table = table.replace(QueryConstants.NAME_SEPARATOR,\n+                    QueryConstants.NAMESPACE_SEPARATOR);\n+                tableName = TableName.valueOf(table);\n             }\n+            return connection.getTable(tableName);", "originalCommit": "f376592bd41cc38122f4d823b74e2da104f36d22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUwOTcyNw==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509509727", "bodyText": "This scenario is the same as returning null from the previous getSysMutexPhysicalTableNameBytes() method and then attempting to retrieve a null table.\n\nBasically, we are certain that either SYSTEM.MUTEX or SYSTEM:MUTEX exist at any point in time right? e.g if we are performing namespace upgrade (e.g MigrateSystemTablesToSystemNamespaceIT test), when SYSTEM.MUTEX no longer exists, if we call HBaseFactoryProvider.getHTableFactory().getTable(), it does return Table object, it doesn't return null as such. However, using that table object, we can't perform any operation because actual table would not exist.\nAs for this comment, the scenario is not same as previous getSysMutexPhysicalTableNameBytes() because when we reach at this point, based on above Admin.tableExists() call, we would call connection.getTable() with correct table name only (I hope we never have situation where SYSTEM.MUTEX and SYSTEM:MUTEX both are dropped. Should we really worry about this case?)", "author": "virajjasani", "createdAt": "2020-10-21T17:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MjAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MTI2NQ==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r511761265", "bodyText": "On high level, connection.getTable() will never return null, it will return new Table object even for non existing tables, so we won't encounter NPE due to this for sure. However, I believe we should make just one API call admin.tableExists() so that we will know either SYSTEM.MUTEX or SYSTEM:MUTEX exist at any time. Sounds good?", "author": "virajjasani", "createdAt": "2020-10-26T07:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MjAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE0MjQxNA==", "url": "https://github.com/apache/phoenix/pull/920#discussion_r512142414", "bodyText": "Got it. Makes sense", "author": "ChinmaySKulkarni", "createdAt": "2020-10-26T17:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MjAxOA=="}], "type": "inlineReview"}, {"oid": "ecf175e7698ec76328a5b40893d36c9064a82c4d", "url": "https://github.com/apache/phoenix/commit/ecf175e7698ec76328a5b40893d36c9064a82c4d", "message": "Merge branch 'master' of github.com:apache/phoenix into PHOENIX-6129-master", "committedDate": "2020-10-21T18:00:26Z", "type": "commit"}, {"oid": "d341b40d5336a1bc7c14b704590683e025f839df", "url": "https://github.com/apache/phoenix/commit/d341b40d5336a1bc7c14b704590683e025f839df", "message": "addressing review", "committedDate": "2020-10-21T19:33:21Z", "type": "commit"}]}