{"pr_number": 12257, "pr_title": "[DOCFIX] Clarify the consistency and writing with ASYNC_THROUGH", "pr_createdAt": "2020-10-13T03:40:42Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12257", "timeline": [{"oid": "93706fee65ddddacb31beaca1967fd11856003aa", "url": "https://github.com/Alluxio/alluxio/commit/93706fee65ddddacb31beaca1967fd11856003aa", "message": "Improve the Write Data flow chapter, clarify the consistency and writing with `ASYNC_THROUGH` avoid one worker crashes.", "committedDate": "2020-10-13T03:23:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDUwMA==", "url": "https://github.com/Alluxio/alluxio/pull/12257#discussion_r504190500", "bodyText": "regardless of write types, files/dirs in Alluxio space always strongly consistent as all these write operations will go through Alluxio master first and modify Alluxio file system before return the the client/applications. So for applications talking to Alluxio, they will always see the latest update as long as the write operation complete successfully.\nHowever, for users or applications taking the state in UFS into account, it might be different across write types:\n\nMUST_CACHE writes no data to UFS, so Alluxio space is never consistent with UFS\nCACHE_THROUGH writes data synchronously to Alluxio and UFS before returning success to applications. If writing to UFS is also strong consistent (e.g., HDFS), Alluxio space will be always consistent with UFS; if writing to UFS is eventual consistent (e.g. S3), it is possible that the file is written successfully to Alluxio but shown up in UFS later.\nASYNC_THROUGH writes data to Alluxio and return to applications, leaving Alluxio to propagate the data to UFS asynchronously. From users perspective, the file can be written successfully to Alluxio, but get persisted in UFS later.\nTHROUGH writes data to UFS directly without caching the data in Alluxio, however, Alluxio knows the files and its status.  Thus the metadata is still consistent.", "author": "apc999", "createdAt": "2020-10-13T19:04:40Z", "path": "docs/en/overview/Architecture.md", "diffHunk": "@@ -257,6 +257,11 @@ configuring the property\n in the client. This section describes the behaviors of different write types as\n well as the performance implications to the applications.\n \n+If you are writing with write type `MUST_CACHE`, `CACHE_THROUGH` or `ASYNC_THROUGH`,", "originalCommit": "93706fee65ddddacb31beaca1967fd11856003aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxMjYwOA==", "url": "https://github.com/Alluxio/alluxio/pull/12257#discussion_r505212608", "bodyText": "I put your comment into the data consistency subsection.", "author": "maobaolong", "createdAt": "2020-10-15T06:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MTAyMg==", "url": "https://github.com/Alluxio/alluxio/pull/12257#discussion_r504191022", "bodyText": "depending on the data replications, if data is replicated to n copies and only n-1 workers crashed, there will be no data loss", "author": "apc999", "createdAt": "2020-10-13T19:05:36Z", "path": "docs/en/overview/Architecture.md", "diffHunk": "@@ -298,11 +303,13 @@ close to `MUST_CACHE`, while still being able to persist the data. Since Alluxio\n <img src=\"{{ '/img/dataflow-async-through.gif' | relativize_url }}\" alt=\"ASYNC_THROUGH data flow\"/>\n </p>\n \n+If you are writing with `ASYNC_THROUGH` and the worker crashes before you persist the data, then you will incur a data loss.", "originalCommit": "93706fee65ddddacb31beaca1967fd11856003aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxMTQ0OA==", "url": "https://github.com/Alluxio/alluxio/pull/12257#discussion_r505211448", "bodyText": "Yeah, only all copies lost will incur a data loss.", "author": "maobaolong", "createdAt": "2020-10-15T06:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MTQ4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12257#discussion_r504191483", "bodyText": "correct", "author": "apc999", "createdAt": "2020-10-13T19:06:28Z", "path": "docs/en/overview/Architecture.md", "diffHunk": "@@ -298,11 +303,13 @@ close to `MUST_CACHE`, while still being able to persist the data. Since Alluxio\n <img src=\"{{ '/img/dataflow-async-through.gif' | relativize_url }}\" alt=\"ASYNC_THROUGH data flow\"/>\n </p>\n \n+If you are writing with `ASYNC_THROUGH` and the worker crashes before you persist the data, then you will incur a data loss.\n+\n To provide fault tolerance, one important property working with `ASYNC_THROUGH` is\n `alluxio.user.file.replication.durable`. This property sets a target replication level of new data\n in Alluxio after write completes but before the data is persisted to the under storage, with a\n default value 1. Alluxio will maintain the target replication level of the file before the\n-background persist process completes, and reclaim the space in Alluxio afterwards.\n+background persist process completes, and reclaim the space in Alluxio afterwards, so the data will only be written to the UFS once.", "originalCommit": "93706fee65ddddacb31beaca1967fd11856003aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8553df772708d9e889d121f7f0ced045fce1dd68", "url": "https://github.com/Alluxio/alluxio/commit/8553df772708d9e889d121f7f0ced045fce1dd68", "message": "Make more rigorous and new a subsection under Data flow: Write", "committedDate": "2020-10-15T06:32:49Z", "type": "commit"}, {"oid": "8b70e851b84ca9b82e2fd7402610ccbdcd5f627e", "url": "https://github.com/Alluxio/alluxio/commit/8b70e851b84ca9b82e2fd7402610ccbdcd5f627e", "message": "trigger new ci check", "committedDate": "2020-10-16T07:58:35Z", "type": "commit"}, {"oid": "ce37602328d55675f7a601a8a88390e6a38ea993", "url": "https://github.com/Alluxio/alluxio/commit/ce37602328d55675f7a601a8a88390e6a38ea993", "message": "Update Architecture.md", "committedDate": "2020-10-17T05:21:38Z", "type": "commit"}]}