{"pr_number": 10957, "pr_title": "Fix K8s format journal in HA mode", "pr_createdAt": "2020-02-20T11:27:10Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10957", "timeline": [{"oid": "75ca82423e78b42d19cfea16ebdd93cc08a99076", "url": "https://github.com/Alluxio/alluxio/commit/75ca82423e78b42d19cfea16ebdd93cc08a99076", "message": "format journal in job", "committedDate": "2020-02-20T10:18:08Z", "type": "commit"}, {"oid": "1e467ee098cb059165d36cc37de6db6f20b01f58", "url": "https://github.com/Alluxio/alluxio/commit/1e467ee098cb059165d36cc37de6db6f20b01f58", "message": "more formatting", "committedDate": "2020-02-20T13:26:57Z", "type": "commit"}, {"oid": "873227d85b7aec834dce2ff7925276c0bb9a6106", "url": "https://github.com/Alluxio/alluxio/commit/873227d85b7aec834dce2ff7925276c0bb9a6106", "message": "format", "committedDate": "2020-02-20T14:05:38Z", "type": "commit"}, {"oid": "1c5398960649090574bf5ab7b78b36bbe99c3585", "url": "https://github.com/Alluxio/alluxio/commit/1c5398960649090574bf5ab7b78b36bbe99c3585", "message": "update version", "committedDate": "2020-02-20T15:44:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4NTk5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382085997", "bodyText": "Have a separate section for this journal formatting job. The resource should be different from a normal master container.", "author": "jiacheliu3", "createdAt": "2020-02-20T15:47:22Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -119,6 +119,28 @@ resources:\n     {{- end }}\n {{- end -}}\n \n+{{- define \"alluxio.journal.format.resources\" -}}", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4NjIxOA==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382086218", "bodyText": "Have multiple Jobs each taking care of one master", "author": "jiacheliu3", "createdAt": "2020-02-20T15:47:43Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/job/format-journal-job.yaml", "diffHunk": "@@ -17,89 +18,82 @@\n {{- $isSingleUfsLocal := and $isUfsLocal $isSingleMaster }}\n {{- $needJournalVolume := or $isEmbedded $isUfsLocal }}\n {{- $release := .Release }}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+{{- range $i := until $masterCount }}", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4NjQ5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382086491", "bodyText": "This takes care of only local.", "author": "jiacheliu3", "createdAt": "2020-02-20T15:48:10Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/job/format-journal-job.yaml", "diffHunk": "@@ -17,89 +18,82 @@\n {{- $isSingleUfsLocal := and $isUfsLocal $isSingleMaster }}\n {{- $needJournalVolume := or $isEmbedded $isUfsLocal }}\n {{- $release := .Release }}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+{{- range $i := until $masterCount }}\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  name: {{ template \"alluxio.fullname\" . }}-format-master\n+  name: {{ $fullName }}-format-master-{{ $i }}\n   labels:\n-    name: {{ template \"alluxio.fullname\" . }}-format-master\n-    app: {{ template \"alluxio.name\" . }}\n-    chart: {{ template \"alluxio.chart\" . }}\n+    name: {{ $fullName }}-format-master-{{ $i }}\n+    app: {{ $name }}\n+    chart: {{ $chart }}\n     release: {{ $release.Name }}\n     heritage: {{ $release.Service }}\n     role: alluxio-master\n spec:\n-  activeDeadlineSeconds: {{ .Values.journal.format.job.activeDeadlineSeconds }}\n-  ttlSecondsAfterFinished: {{ .Values.journal.format.job.ttlSecondsAfterFinished }}\n+  activeDeadlineSeconds: {{ $root.Values.journal.format.job.activeDeadlineSeconds }}\n+  ttlSecondsAfterFinished: {{ $root.Values.journal.format.job.ttlSecondsAfterFinished }}\n   template:\n     spec:\n       containers:\n         - name: alluxio-master\n-          image: {{ .Values.image }}:{{ .Values.imageTag }}\n-          imagePullPolicy: {{ .Values.imagePullPolicy }}\n-          {{- if .Values.master.resources  }}\n-          resources:\n-            {{- if .Values.master.resources.limits }}\n-            limits:\n-              cpu: {{ .Values.master.resources.limits.cpu }}\n-              memory: {{ .Values.master.resources.limits.memory }}\n-            {{- end }}\n-            {{- if .Values.master.resources.requests }}\n-            requests:\n-              cpu: {{ .Values.master.resources.requests.cpu }}\n-              memory: {{ .Values.master.resources.requests.memory }}\n-            {{- end }}\n+          image: {{ $root.Values.image }}:{{ $root.Values.imageTag }}\n+          imagePullPolicy: {{ $root.Values.imagePullPolicy }}\n+          securityContext:\n+            runAsUser: {{ $root.Values.user }}\n+            runAsGroup: {{ $root.Values.group }}\n+          {{- if $root.Values.journal.format.resources }}\n+{{ include \"alluxio.journal.format.resources\" $root | indent 10 }}\n           {{- end }}\n           command: [\"/opt/alluxio/bin/alluxio\"]\n-          args: [\"formatMasters\"]\n+          args: [\"formatJournal\"]", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4ODc5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382088792", "bodyText": "This is required in HA, otherwise the following error will be thrown\n2020-02-20 15:50:19,510 ERROR Format - Failed to format\njava.lang.IllegalStateException: The cluster addresses ([alluxio-master-0:19200, alluxio-master-1:19200, alluxio-master-2:19200]) must contain the local master address (alluxio-format-master-0-2pm8w:19200)\n\tat com.google.common.base.Preconditions.checkState(Preconditions.java:823)\n\tat alluxio.master.journal.raft.RaftJournalConfiguration.validate(RaftJournalConfiguration.java:77)", "author": "jiacheliu3", "createdAt": "2020-02-20T15:51:25Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/job/format-journal-job.yaml", "diffHunk": "@@ -17,89 +18,82 @@\n {{- $isSingleUfsLocal := and $isUfsLocal $isSingleMaster }}\n {{- $needJournalVolume := or $isEmbedded $isUfsLocal }}\n {{- $release := .Release }}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+{{- range $i := until $masterCount }}\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  name: {{ template \"alluxio.fullname\" . }}-format-master\n+  name: {{ $fullName }}-format-master-{{ $i }}\n   labels:\n-    name: {{ template \"alluxio.fullname\" . }}-format-master\n-    app: {{ template \"alluxio.name\" . }}\n-    chart: {{ template \"alluxio.chart\" . }}\n+    name: {{ $fullName }}-format-master-{{ $i }}\n+    app: {{ $name }}\n+    chart: {{ $chart }}\n     release: {{ $release.Name }}\n     heritage: {{ $release.Service }}\n     role: alluxio-master\n spec:\n-  activeDeadlineSeconds: {{ .Values.journal.format.job.activeDeadlineSeconds }}\n-  ttlSecondsAfterFinished: {{ .Values.journal.format.job.ttlSecondsAfterFinished }}\n+  activeDeadlineSeconds: {{ $root.Values.journal.format.job.activeDeadlineSeconds }}\n+  ttlSecondsAfterFinished: {{ $root.Values.journal.format.job.ttlSecondsAfterFinished }}\n   template:\n     spec:\n       containers:\n         - name: alluxio-master\n-          image: {{ .Values.image }}:{{ .Values.imageTag }}\n-          imagePullPolicy: {{ .Values.imagePullPolicy }}\n-          {{- if .Values.master.resources  }}\n-          resources:\n-            {{- if .Values.master.resources.limits }}\n-            limits:\n-              cpu: {{ .Values.master.resources.limits.cpu }}\n-              memory: {{ .Values.master.resources.limits.memory }}\n-            {{- end }}\n-            {{- if .Values.master.resources.requests }}\n-            requests:\n-              cpu: {{ .Values.master.resources.requests.cpu }}\n-              memory: {{ .Values.master.resources.requests.memory }}\n-            {{- end }}\n+          image: {{ $root.Values.image }}:{{ $root.Values.imageTag }}\n+          imagePullPolicy: {{ $root.Values.imagePullPolicy }}\n+          securityContext:\n+            runAsUser: {{ $root.Values.user }}\n+            runAsGroup: {{ $root.Values.group }}\n+          {{- if $root.Values.journal.format.resources }}\n+{{ include \"alluxio.journal.format.resources\" $root | indent 10 }}\n           {{- end }}\n           command: [\"/opt/alluxio/bin/alluxio\"]\n-          args: [\"formatMasters\"]\n+          args: [\"formatJournal\"]\n           envFrom:\n             - configMapRef:\n-                name: {{ template \"alluxio.fullname\" . }}-config\n+                name: {{ $fullName }}-config\n+          {{- if $isHaEmbedded }}\n+          env:\n+            - name: ALLUXIO_MASTER_HOSTNAME\n+              value: {{ printf \"%v-master-%v\" $fullName $i }}\n+          {{- end }}", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4OTA4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382089081", "bodyText": "I don't think it makes much sense to retry this format command.", "author": "jiacheliu3", "createdAt": "2020-02-20T15:51:50Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/job/format-journal-job.yaml", "diffHunk": "@@ -17,89 +18,82 @@\n {{- $isSingleUfsLocal := and $isUfsLocal $isSingleMaster }}\n {{- $needJournalVolume := or $isEmbedded $isUfsLocal }}\n {{- $release := .Release }}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+{{- range $i := until $masterCount }}\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  name: {{ template \"alluxio.fullname\" . }}-format-master\n+  name: {{ $fullName }}-format-master-{{ $i }}\n   labels:\n-    name: {{ template \"alluxio.fullname\" . }}-format-master\n-    app: {{ template \"alluxio.name\" . }}\n-    chart: {{ template \"alluxio.chart\" . }}\n+    name: {{ $fullName }}-format-master-{{ $i }}\n+    app: {{ $name }}\n+    chart: {{ $chart }}\n     release: {{ $release.Name }}\n     heritage: {{ $release.Service }}\n     role: alluxio-master\n spec:\n-  activeDeadlineSeconds: {{ .Values.journal.format.job.activeDeadlineSeconds }}\n-  ttlSecondsAfterFinished: {{ .Values.journal.format.job.ttlSecondsAfterFinished }}\n+  activeDeadlineSeconds: {{ $root.Values.journal.format.job.activeDeadlineSeconds }}\n+  ttlSecondsAfterFinished: {{ $root.Values.journal.format.job.ttlSecondsAfterFinished }}\n   template:\n     spec:\n       containers:\n         - name: alluxio-master\n-          image: {{ .Values.image }}:{{ .Values.imageTag }}\n-          imagePullPolicy: {{ .Values.imagePullPolicy }}\n-          {{- if .Values.master.resources  }}\n-          resources:\n-            {{- if .Values.master.resources.limits }}\n-            limits:\n-              cpu: {{ .Values.master.resources.limits.cpu }}\n-              memory: {{ .Values.master.resources.limits.memory }}\n-            {{- end }}\n-            {{- if .Values.master.resources.requests }}\n-            requests:\n-              cpu: {{ .Values.master.resources.requests.cpu }}\n-              memory: {{ .Values.master.resources.requests.memory }}\n-            {{- end }}\n+          image: {{ $root.Values.image }}:{{ $root.Values.imageTag }}\n+          imagePullPolicy: {{ $root.Values.imagePullPolicy }}\n+          securityContext:\n+            runAsUser: {{ $root.Values.user }}\n+            runAsGroup: {{ $root.Values.group }}\n+          {{- if $root.Values.journal.format.resources }}\n+{{ include \"alluxio.journal.format.resources\" $root | indent 10 }}\n           {{- end }}\n           command: [\"/opt/alluxio/bin/alluxio\"]\n-          args: [\"formatMasters\"]\n+          args: [\"formatJournal\"]\n           envFrom:\n             - configMapRef:\n-                name: {{ template \"alluxio.fullname\" . }}-config\n+                name: {{ $fullName }}-config\n+          {{- if $isHaEmbedded }}\n+          env:\n+            - name: ALLUXIO_MASTER_HOSTNAME\n+              value: {{ printf \"%v-master-%v\" $fullName $i }}\n+          {{- end }}\n           volumeMounts:\n           {{- if $needJournalVolume }}\n-          - name: alluxio-journal\n-            mountPath: {{ .Values.journal.folder }}\n+            - name: alluxio-journal\n+              mountPath: {{ $root.Values.journal.folder }}\n           {{- end }}\n-          {{- if .Values.secrets }}\n-            {{- if .Values.secrets.master }}\n-              {{- range $key, $val := .Values.secrets.master }}\n-          - name: secret-{{ $key }}-volume\n-            mountPath: /secrets/{{ $val }}\n-            readOnly: true\n+          {{- if $root.Values.secrets }}\n+            {{- if $root.Values.secrets.master }}\n+              {{- range $key, $val := $root.Values.secrets.master }}\n+            - name: secret-{{ $key }}-volume\n+              mountPath: /secrets/{{ $val }}\n+              readOnly: true\n               {{- end }}\n             {{- end }}\n           {{- end }}\n-          {{- if .Values.mounts }}\n-            {{- range .Values.mounts }}\n-          - name: \"{{ .name }}\"\n-            mountPath: \"{{ .path }}\"\n+          {{- if $root.Values.mounts }}\n+            {{- range $root.Values.mounts }}\n+            - name: \"{{ .name }}\"\n+              mountPath: \"{{ .path }}\"\n             {{- end }}\n           {{- end }}\n-      restartPolicy: OnFailure\n+      restartPolicy: Never", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2NjQ1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382166450", "bodyText": "this might be a big limitation, is there a way to get rid of this requirement? we will not be able to use AWSElasticBlockStore or GCEPersistentDisk if this is the case", "author": "madanadit", "createdAt": "2020-02-20T18:03:57Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -106,9 +106,10 @@ jobMaster:\n #   type: \"EMBEDDED\"\n #   folder: \"/journal\"\n journal:\n-  pvcName: alluxio-pv-claim\n   storageClass: \"standard\"\n   size: 1Gi\n+  accessModes:\n+    - ReadWriteMany # Use ReadWriteMany as the format job will access it", "originalCommit": "1c5398960649090574bf5ab7b78b36bbe99c3585", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQxNzU1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10957#discussion_r382417556", "bodyText": "Makes sense. In that case we should keep using ReadWriteOnce and the format job should be called only after the master pods are deleted first.\nThis has been changed back to ReadWriteOnce.", "author": "jiacheliu3", "createdAt": "2020-02-21T06:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2NjQ1MA=="}], "type": "inlineReview"}, {"oid": "ca1e42f99d83bef320121296ce074934f884ee6d", "url": "https://github.com/Alluxio/alluxio/commit/ca1e42f99d83bef320121296ce074934f884ee6d", "message": "change accessModes to ReadWriteOnce", "committedDate": "2020-02-21T06:31:43Z", "type": "commit"}]}