{"pr_number": 12100, "pr_title": "Avoid taking snapshot during journal suspension", "pr_createdAt": "2020-09-11T01:23:19Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12100", "timeline": [{"oid": "567b56878a11ada46ccccac7bd533539aa68fe0f", "url": "https://github.com/Alluxio/alluxio/commit/567b56878a11ada46ccccac7bd533539aa68fe0f", "message": "Avoid taking snapshot during journal suspension", "committedDate": "2020-09-11T01:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAwNjMyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/12100#discussion_r488006329", "bodyText": "why added restart follower here", "author": "LuQQiu", "createdAt": "2020-09-14T15:06:45Z", "path": "core/server/common/src/test/java/alluxio/master/journal/raft/RaftJournalTest.java", "diffHunk": "@@ -139,6 +139,50 @@ public void suspendCatchupResume() throws Exception {\n         () -> countingMaster.getApplyCount() == entryCount + 1, mWaitOptions);\n   }\n \n+  @Test\n+  public void suspendSnapshotRestart() throws Exception {\n+    // Create a counting master implementation that counts how many journal entries it processed.\n+    CountingDummyFileSystemMaster countingMaster = new CountingDummyFileSystemMaster();\n+    mFollowerJournalSystem.createJournal(countingMaster);\n+\n+    final int entryCount = 10;\n+    try (JournalContext journalContext =\n+             mLeaderJournalSystem.createJournal(new NoopMaster()).createJournalContext()) {\n+      for (int i = 0; i < entryCount; i++) {\n+        journalContext.append(\n+            alluxio.proto.journal.Journal.JournalEntry.newBuilder().setInodeLastModificationTime(\n+                File.InodeLastModificationTimeEntry.newBuilder().setId(i).build()).build());\n+      }\n+    }\n+\n+    // Suspend follower journal system.\n+    mFollowerJournalSystem.suspend();\n+\n+    // Write more entries which are not applied due to suspension.\n+    try (JournalContext journalContext =\n+             mLeaderJournalSystem.createJournal(new NoopMaster()).createJournalContext()) {\n+      journalContext\n+          .append(alluxio.proto.journal.Journal.JournalEntry.newBuilder()\n+              .setInodeLastModificationTime(\n+                  File.InodeLastModificationTimeEntry.newBuilder().setId(entryCount).build())\n+              .build());\n+    }\n+\n+    // Ask the follower to do a snapshot.\n+    mFollowerJournalSystem.checkpoint();\n+\n+    // Restart the follower.\n+    mFollowerJournalSystem.stop();", "originalCommit": "567b56878a11ada46ccccac7bd533539aa68fe0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyMjU5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12100#discussion_r488122596", "bodyText": "Restart causes the follower snapshot to be replayed so its content can be verified.", "author": "bf8086", "createdAt": "2020-09-14T18:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAwNjMyOQ=="}], "type": "inlineReview"}]}