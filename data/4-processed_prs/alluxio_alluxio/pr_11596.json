{"pr_number": 11596, "pr_title": "Fix fetching partition for Glue UDB", "pr_createdAt": "2020-06-18T22:38:12Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11596", "timeline": [{"oid": "bf0ce6c928217de8c628121691288cb37f367d8c", "url": "https://github.com/Alluxio/alluxio/commit/bf0ce6c928217de8c628121691288cb37f367d8c", "message": "Fix glue udb fetch partition", "committedDate": "2020-06-18T22:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjY4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442542683", "bodyText": "can this be something like partitions.addAll(getPartitionsResult.getPartitions()?", "author": "gpang", "createdAt": "2020-06-18T22:50:57Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java", "diffHunk": "@@ -377,15 +378,26 @@ public UdbTable getTable(String tableName) throws IOException {\n \n   private List<Partition> batchGetPartitions(AWSGlueAsync glueClient, String tableName)\n       throws IOException {\n+    // TODO(shouwei): make getPartition multi-thread to accelerate the large table fetching\n     List<Partition> partitions = new ArrayList<>();\n+    String nextToken = null;\n     try {\n-      GetPartitionsRequest getPartitionsRequest =\n-          new GetPartitionsRequest()\n-              .withCatalogId(mGlueConfiguration.get(Property.CATALOG_ID))\n-              .withDatabaseName(mGlueDbName)\n-              .withTableName(tableName);\n-      if (glueClient.getPartitions(getPartitionsRequest).getPartitions() != null) {\n-        partitions = glueClient.getPartitions(getPartitionsRequest).getPartitions();\n+      do {\n+        GetPartitionsRequest getPartitionsRequest =\n+            new GetPartitionsRequest()\n+                .withCatalogId(mGlueConfiguration.get(Property.CATALOG_ID))\n+                .withDatabaseName(mGlueDbName)\n+                .withTableName(tableName)\n+                .withMaxResults(mGlueConfiguration.getInt(Property.MAX_GLUE_FETCH_PARTITIONS))\n+                .withNextToken(nextToken);\n+        GetPartitionsResult getPartitionsResult = glueClient.getPartitions(getPartitionsRequest);\n+        getPartitionsResult.getPartitions().forEach(partition -> partitions.add(partition));", "originalCommit": "bf0ce6c928217de8c628121691288cb37f367d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MzExMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442553111", "bodyText": "changed.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjkzMA==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442542930", "bodyText": "should this be getPartitionsResult.getPartitions().size() instead of partitions.size()?", "author": "gpang", "createdAt": "2020-06-18T22:51:49Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java", "diffHunk": "@@ -377,15 +378,26 @@ public UdbTable getTable(String tableName) throws IOException {\n \n   private List<Partition> batchGetPartitions(AWSGlueAsync glueClient, String tableName)\n       throws IOException {\n+    // TODO(shouwei): make getPartition multi-thread to accelerate the large table fetching\n     List<Partition> partitions = new ArrayList<>();\n+    String nextToken = null;\n     try {\n-      GetPartitionsRequest getPartitionsRequest =\n-          new GetPartitionsRequest()\n-              .withCatalogId(mGlueConfiguration.get(Property.CATALOG_ID))\n-              .withDatabaseName(mGlueDbName)\n-              .withTableName(tableName);\n-      if (glueClient.getPartitions(getPartitionsRequest).getPartitions() != null) {\n-        partitions = glueClient.getPartitions(getPartitionsRequest).getPartitions();\n+      do {\n+        GetPartitionsRequest getPartitionsRequest =\n+            new GetPartitionsRequest()\n+                .withCatalogId(mGlueConfiguration.get(Property.CATALOG_ID))\n+                .withDatabaseName(mGlueDbName)\n+                .withTableName(tableName)\n+                .withMaxResults(mGlueConfiguration.getInt(Property.MAX_GLUE_FETCH_PARTITIONS))\n+                .withNextToken(nextToken);\n+        GetPartitionsResult getPartitionsResult = glueClient.getPartitions(getPartitionsRequest);\n+        getPartitionsResult.getPartitions().forEach(partition -> partitions.add(partition));\n+        nextToken = getPartitionsResult.getNextToken();\n+        LOG.debug(\"Glue table {}.{} added {} partitions.\",\n+            mGlueDbName, tableName, partitions.size());", "originalCommit": "bf0ce6c928217de8c628121691288cb37f367d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MTc0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442551746", "bodyText": "It allows us to track the progress of getPartitions. Is it better to show the total added partitions for the current table?", "author": "HelloHorizon", "createdAt": "2020-06-18T23:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1ODEwMg==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442558102", "bodyText": "I think both can be useful. How about something like \"Glue table {}.{} adding {} batch partitions with {} total partitions.\"", "author": "gpang", "createdAt": "2020-06-18T23:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1OTY0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442559642", "bodyText": "yeah, it makes sense, I can add both of them.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442543201", "bodyText": "Is this large enough? Do you know if we can make this larger while still allowing it to return the correct amount?", "author": "gpang", "createdAt": "2020-06-18T22:52:39Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/Property.java", "diffHunk": "@@ -142,11 +142,17 @@ public static void unregister(Property Property) {\n           .setDescription(\"The maximum number of connection to glue metastore.\")\n           .build();\n \n+  public static final Property MAX_GLUE_FETCH_PARTITIONS =\n+      new Builder(Name.MAX_GLUE_FETCH_PARTITIONS)\n+          .setDefaultValue(\"256\")", "originalCommit": "bf0ce6c928217de8c628121691288cb37f367d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MjYwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442552609", "bodyText": "This value means the maximum number of partitions to return in a single response, from 1 to 1000. 256 should large enough for most cases. I will update the explanation of this property.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1NzQyNw==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442557427", "bodyText": "If we set it to 1000, is it slow? I think setting it larger would be better.", "author": "gpang", "createdAt": "2020-06-18T23:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1OTU0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442559545", "bodyText": "I don't know the performance difference with an accurate number, but it should has little difference.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MDM2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442560365", "bodyText": "I changed the default value to 512, which should more than enough for most cases.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2Mjg1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442562852", "bodyText": "I changed it to 512, it still only fetch 460 partitions every time, it would not reach the limitation.", "author": "HelloHorizon", "createdAt": "2020-06-19T00:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MzIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDI1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442544253", "bodyText": "NIT: maybe partitions.fetch.max", "author": "gpang", "createdAt": "2020-06-18T22:56:21Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/Property.java", "diffHunk": "@@ -197,6 +203,7 @@ public String getDefaultValue() {\n   public static final class Name {\n     // AWS Glue related properties\n     public static final String MAX_GLUE_CONNECTION = \"max.connection\";\n+    public static final String MAX_GLUE_FETCH_PARTITIONS = \"max.partitions\";", "originalCommit": "bf0ce6c928217de8c628121691288cb37f367d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MzA1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11596#discussion_r442553052", "bodyText": "changed.", "author": "HelloHorizon", "createdAt": "2020-06-18T23:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDI1Mw=="}], "type": "inlineReview"}, {"oid": "def6add82833c0348f0b9a2858953f454eba690d", "url": "https://github.com/Alluxio/alluxio/commit/def6add82833c0348f0b9a2858953f454eba690d", "message": "Make some minor changes", "committedDate": "2020-06-18T23:42:24Z", "type": "commit"}, {"oid": "e5528b0d2822cfd047b08429ff5014545c687c8a", "url": "https://github.com/Alluxio/alluxio/commit/e5528b0d2822cfd047b08429ff5014545c687c8a", "message": "Change log", "committedDate": "2020-06-19T00:10:25Z", "type": "commit"}]}