{"pr_number": 12653, "pr_title": "Add 'attachdb' option for mounting diff prefix partitions", "pr_createdAt": "2020-12-16T01:10:21Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12653", "timeline": [{"oid": "9202125306b7cf76c5904069d3d30fa56d6971d7", "url": "https://github.com/Alluxio/alluxio/commit/9202125306b7cf76c5904069d3d30fa56d6971d7", "message": "Add option to allow mounting partitions with diff location prefix than table location", "committedDate": "2020-12-16T01:01:08Z", "type": "commit"}, {"oid": "990be09870d46a22d940250f47a29ad33bb73f2e", "url": "https://github.com/Alluxio/alluxio/commit/990be09870d46a22d940250f47a29ad33bb73f2e", "message": "Lint fix", "committedDate": "2020-12-16T01:06:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwMzMzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r543803335", "bodyText": "This file is using the same code structure as alluxio/table/under/glue/Property.java", "author": "hycsam", "createdAt": "2020-12-16T01:11:54Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/Property.java", "diffHunk": "@@ -11,12 +11,166 @@\n \n package alluxio.table.under.hive;", "originalCommit": "990be09870d46a22d940250f47a29ad33bb73f2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r545324100", "bodyText": "Can we make this property a general udb property, and not hive specific?", "author": "gpang", "createdAt": "2020-12-17T18:50:58Z", "path": "docs/en/operation/User-CLI.md", "diffHunk": "@@ -1315,6 +1315,13 @@ This command will attach the database `hive_db_name` (of type `hive`) from the U\n When paths are mounted for `s3a://bucket1`, the mount option `aws.accessKeyId=abc` will be used,\n and when paths are mounted for `s3a://bucket2`, the mount option `aws.accessKeyId=123` will be used.\n \n+Besides mount options, there are some additional properties with the `-o` options:\n+  * `udb-hive.<UDB_PROPERTY>`: specify the UDB options for the Hive UDB. The options\n+  are as follows\n+    * `allow.diff.partition.location.prefix`: Whether to mount partitions that do not share", "originalCommit": "990be09870d46a22d940250f47a29ad33bb73f2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwNzgwMA==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r545407800", "bodyText": "does glue allow partitions to be outside of the table path?  if it does not,  then this property probably does not make sense for glue?", "author": "yuzhu", "createdAt": "2020-12-17T21:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1OTk2OA==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r545459968", "bodyText": "hrmmm, good question, I'm not sure how that works in glue. If it is possible to edit the glue metadata directly, then maybe?", "author": "gpang", "createdAt": "2020-12-17T23:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA4OTI1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r546089251", "bodyText": "Both the Property.java files (Hive and Glue) now share the same code structure. I can move this builder code logic to their parent class, UdbProperty.java. We can decide later if necessary to add this property to Glue UDB.", "author": "hycsam", "createdAt": "2020-12-18T21:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzMjA3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r552232079", "bodyText": "Tried abstracting the common code in UdbProperty.java but don't think that's a good idea, will leave as such. Also bumping this up, does this PR look OK for Hive UDB? I think we can decided whether to add that for Glue later.", "author": "hycsam", "createdAt": "2021-01-05T22:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIxNDYyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r556214625", "bodyText": "What challenges did you run into? I am concerned that we have two separate property classes and they will diverge further in the future.", "author": "yuzhu", "createdAt": "2021-01-13T02:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDcxOTIzNA==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r560719234", "bodyText": "@yuzhu  Both the Builder pattern and the static property map (DEFAULT_KEYS_MAP variable in Property.java) are making it hard to abstract the code in the parent class. Don't want to make the code too complicated.", "author": "hycsam", "createdAt": "2021-01-20T07:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTE1NjU0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r561156541", "bodyText": "got it @hycsam", "author": "yuzhu", "createdAt": "2021-01-20T17:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyNDc2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12653#discussion_r545324762", "bodyText": "Can this be a general property, since the glue integration also has a similar check: https://github.com/Alluxio/alluxio/blob/master/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java#L263", "author": "gpang", "createdAt": "2020-12-17T18:51:40Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/HiveDatabase.java", "diffHunk": "@@ -162,8 +162,12 @@ private PathTranslator mountAlluxioPaths(Table table, List<Partition> partitions\n \n       for (Partition part : partitions) {\n         AlluxioURI partitionUri;\n-        if (part.getSd() != null && part.getSd().getLocation() != null\n-            && ufsUri.isAncestorOf(partitionUri = new AlluxioURI(part.getSd().getLocation()))) {\n+        if (part.getSd() != null && part.getSd().getLocation() != null) {\n+          partitionUri = new AlluxioURI(part.getSd().getLocation());\n+          if (!mConfiguration.getBoolean(Property.ALLOW_DIFF_PART_LOC_PREFIX)\n+              && !ufsUri.isAncestorOf(partitionUri)) {", "originalCommit": "990be09870d46a22d940250f47a29ad33bb73f2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}