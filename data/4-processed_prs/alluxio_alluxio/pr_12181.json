{"pr_number": 12181, "pr_title": "Implement raft journal and snapshot management with Ratis", "pr_createdAt": "2020-10-05T23:40:29Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12181", "timeline": [{"oid": "2c7bfbec61f4958066c302a4b63c46582cb514fb", "url": "https://github.com/Alluxio/alluxio/commit/2c7bfbec61f4958066c302a4b63c46582cb514fb", "message": "Migrate state machine to ratis\n\nInitial changes for hooking up embedded journal state machine with ratis\nAPI. Implemented leader election, journal application and taking\nsnapshot on followers.\n\npr-link: Alluxio/alluxio#11940\nchange-id: cid-0e6c9dff7df0bfdacd6d88bd320a5728ad938edb", "committedDate": "2020-08-25T17:46:44Z", "type": "commit"}, {"oid": "146842203cf9c604331cf5a02b41b0383a5f3c8b", "url": "https://github.com/Alluxio/alluxio/commit/146842203cf9c604331cf5a02b41b0383a5f3c8b", "message": "Remove the catalyst dependencies in backup transport\n\n\n\npr-link: Alluxio/alluxio#12056\nchange-id: cid-45b0ca0655735d011ca3babafc83fc817b67860f", "committedDate": "2020-09-02T18:17:03Z", "type": "commit"}, {"oid": "7abc3c4f807c36842ddf15557bc9ed19ad6faac9", "url": "https://github.com/Alluxio/alluxio/commit/7abc3c4f807c36842ddf15557bc9ed19ad6faac9", "message": "Move copycat dependency to catalyst\n\nRemove the copycat dependency and change it to a much smaller catalyst\ndependency.\nCatalyst dependency is needed for Grpc messaging serialization and\ndeserialization.\n\npr-link: Alluxio/alluxio#12082\nchange-id: cid-c8b21501a3379f0ee334ccbf7067fe1c5604a223", "committedDate": "2020-09-09T06:55:20Z", "type": "commit"}, {"oid": "784359e842da84053f460704ecb059cc42b05e63", "url": "https://github.com/Alluxio/alluxio/commit/784359e842da84053f460704ecb059cc42b05e63", "message": "Implement snapshot replication for embedded journal\n\nThis change implements snapshot replication workflows for embedded\njournal:\n\n- When a raft leader needs a snapshot, instead of taking snapshot\nlocally it copies a recent snapshot from one of the followers.\n- When a raft follower receives a notification to download a snapshot,\nit downloads the latest snapshot from the leader.\n\npr-link: Alluxio/alluxio#12053\nchange-id: cid-d2f322ef07db1db70e1a2ab6182afbb5cd439764", "committedDate": "2020-09-10T20:45:19Z", "type": "commit"}, {"oid": "1184131c8f6bbafa5ddcbcd10e742a11d3a59c57", "url": "https://github.com/Alluxio/alluxio/commit/1184131c8f6bbafa5ddcbcd10e742a11d3a59c57", "message": "Avoid taking snapshot during journal suspension\n\nWhen journal is suspended, snapshot should not be taken because some\nentries included up to the snapshot index might not have been applied by\nthe suspended journal applier.\n\npr-link: Alluxio/alluxio#12100\nchange-id: cid-cd1adb3aa61dc28b8dfde0283f48303c1dd20e44", "committedDate": "2020-09-14T21:19:55Z", "type": "commit"}, {"oid": "7b7d639afd11e65362d8c0f99e1d87afe19f337c", "url": "https://github.com/Alluxio/alluxio/commit/7b7d639afd11e65362d8c0f99e1d87afe19f337c", "message": "Enable new master to join an existing quorum\n\nThis change implements the quorum join process for new master.\n\nRatis provides an API for update quorum member list. To implement an\nautomatic join comparable with what we did with Copycat, the new master\nwill send a join request to the quorum leader after it initialized the\njournal. The leader will atomically convert the request to a raft\nconfiguration change and apply it to the quorum.\n\nThis operation is a noop for a master that is already in the quorum.\n\npr-link: Alluxio/alluxio#12099\nchange-id: cid-35f7de4ffcc56f0ce4969fd632f48c68adf1887a", "committedDate": "2020-09-15T00:29:11Z", "type": "commit"}, {"oid": "170f25b0e6f91c8edfdc3468351a594f16d41f2b", "url": "https://github.com/Alluxio/alluxio/commit/170f25b0e6f91c8edfdc3468351a594f16d41f2b", "message": "Before solving conflicts", "committedDate": "2020-09-15T00:31:16Z", "type": "commit"}, {"oid": "ef66c83e19e61c3c5e683757a8566d7cfddb6547", "url": "https://github.com/Alluxio/alluxio/commit/ef66c83e19e61c3c5e683757a8566d7cfddb6547", "message": "solve conflicts", "committedDate": "2020-09-15T00:31:39Z", "type": "commit"}, {"oid": "250ad06fe68cf9d481deec53739eb9b03b0e2937", "url": "https://github.com/Alluxio/alluxio/commit/250ad06fe68cf9d481deec53739eb9b03b0e2937", "message": "Merge master into ratis-journal", "committedDate": "2020-09-15T07:08:59Z", "type": "commit"}, {"oid": "417036bcaeb068d8ed8f6dd1c132eff1fc43e1d4", "url": "https://github.com/Alluxio/alluxio/commit/417036bcaeb068d8ed8f6dd1c132eff1fc43e1d4", "message": "Merge remote-tracking branch 'origin/master' into masterToRatis", "committedDate": "2020-09-22T00:01:53Z", "type": "commit"}, {"oid": "c1f2e3a2480237ada09c697f2564f89776bb279a", "url": "https://github.com/Alluxio/alluxio/commit/c1f2e3a2480237ada09c697f2564f89776bb279a", "message": "Make polling client timeout properly on unresponsive masters\n\nAdded a deadline for master ping requests.\n\npr-link: Alluxio/alluxio#12145\nchange-id: cid-9c7dcf07e967728651df7367aaf295a297e8ea0b", "committedDate": "2020-09-27T17:19:48Z", "type": "commit"}, {"oid": "ab1ff5a21bcd38ef15cdd49482e815a10df073ca", "url": "https://github.com/Alluxio/alluxio/commit/ab1ff5a21bcd38ef15cdd49482e815a10df073ca", "message": "Make master try harder when joininig a quorum\n\nSometimes a master attempts to join a quorum during leader election.\nThis change extends the retry period so the retry can extends pass an\nelection. Also lower the log severity given its best effort nature.\n\npr-link: Alluxio/alluxio#12152\nchange-id: cid-65c9b9f2f4360c5b16cc4edb237467a3d5c34ad3", "committedDate": "2020-09-28T17:55:09Z", "type": "commit"}, {"oid": "cba01077f6af03a8b15ebaed8a2e3aaeccf9b748", "url": "https://github.com/Alluxio/alluxio/commit/cba01077f6af03a8b15ebaed8a2e3aaeccf9b748", "message": "Make it more restrictive when a snapshot can be taken\n\nSometimes a snapshot is ordered when the journal log is not consistent\nwith the state machine. This change makes it more restrictive that\nsnapshots can only be taken when a follower is in running state.\n\npr-link: Alluxio/alluxio#12150\nchange-id: cid-91dca0f71c9a9688e1a3cd58240b61b5df3df79b", "committedDate": "2020-09-28T17:56:09Z", "type": "commit"}, {"oid": "f4fbc0f78a7ee035684c3d250c1871d014ddc6eb", "url": "https://github.com/Alluxio/alluxio/commit/f4fbc0f78a7ee035684c3d250c1871d014ddc6eb", "message": "Make Ratis client retry on catchup failures\n\nSometimes a Ratis client decides to timeout and close connection when\nmaster tries to gain primacy. This change makes the master to notify\nRatis client to reconnect when an exception is throw, so we don't just\nkeep retrying on a closed client.\n\npr-link: Alluxio/alluxio#12151\nchange-id: cid-2da82374da558c9ca3c9ae2446134938b9343e8a", "committedDate": "2020-09-28T17:56:30Z", "type": "commit"}, {"oid": "aef043b50e4bd32d92205585eab1c1c76a30f2b4", "url": "https://github.com/Alluxio/alluxio/commit/aef043b50e4bd32d92205585eab1c1c76a30f2b4", "message": "Add worker master periodical connections timeout\n\nIn a cluster with multiple masters using embedded journal, when network\npartitioned the original leading master, leadership changes to a new\nleading master. The workers hang in GRPC connections with the previous\nleading master and don't register with the new leading master.\n\nThis PR adds the timeout to periodical connections (operations) between\nworkers and leading masters to prevent workers from hanging forever.\n\npr-link: Alluxio/alluxio#12149\nchange-id: cid-47af90077dfc0fed081a315e0f2b2bcd20f9fb96", "committedDate": "2020-09-28T21:49:47Z", "type": "commit"}, {"oid": "ff6435ef830023acaa8537b755da7c33942e93ce", "url": "https://github.com/Alluxio/alluxio/commit/ff6435ef830023acaa8537b755da7c33942e93ce", "message": "Fix deadlock when raft journal throws exception\n\nIn an unlucky situation when raft server throw an exception while losing\nprimacy, the master will attempt to shutdown but stuck in a deadlock of\n`RaftJournalSystem::losePrimacy -> System::exit ->\nProcessUtils::stopProcessOnShutdown -> RaftJournalSystem::stop`. It can\nbe fixed with throwing directly within `losePrimacy`.\n\npr-link: Alluxio/alluxio#12166\nchange-id: cid-e20b652c8baf6a53f26b79635a9ad4813c66afe5", "committedDate": "2020-10-03T17:36:17Z", "type": "commit"}, {"oid": "ab401a5b962458f095435544d3d475c0b39e27a7", "url": "https://github.com/Alluxio/alluxio/commit/ab401a5b962458f095435544d3d475c0b39e27a7", "message": "Merge remote-tracking branch 'upstream/master' into merge-master-ratis", "committedDate": "2020-10-05T17:21:00Z", "type": "commit"}, {"oid": "2d83bab5e2ddf4226cb11415e15e87c8e704e6ed", "url": "https://github.com/Alluxio/alluxio/commit/2d83bab5e2ddf4226cb11415e15e87c8e704e6ed", "message": "Merge remote-tracking branch 'upstream/master' into merge-master-1005", "committedDate": "2020-10-05T18:47:28Z", "type": "commit"}, {"oid": "458e0eadada2262d3fad8d88339f997055ae370d", "url": "https://github.com/Alluxio/alluxio/commit/458e0eadada2262d3fad8d88339f997055ae370d", "message": "Implement a local first raft client for improved journal performance\n\nCurrent the raft client for writing journal entries will always checking\nfor leadership and send the request through network interface,\nintroducing significant overhead. This change implements a raft client\nwhich attempts sending messages directly to local server first, and\nfalls back to the default client if the local server is no longer a\nleader.\n\nThe client also has built-in retry function for raft client which is\nclosed due to timeout.\n\npr-link: Alluxio/alluxio#12174\nchange-id: cid-df05031cb47f6f931e67c9b4c853b9b426ba145d", "committedDate": "2020-10-05T23:22:52Z", "type": "commit"}, {"oid": "c4c1d17efd41df68b76bce5365e72ca8d097c042", "url": "https://github.com/Alluxio/alluxio/commit/c4c1d17efd41df68b76bce5365e72ca8d097c042", "message": "Avoid reloading old snapshots\n\nRatis leader sometimes send a request to a follower to install a\nsnapshot that is older than the follower's log. This change implements a\ncheck to avoid reloading the state machine after such snapshots are\ndownloaded to prevent some accounting issue.\n\npr-link: Alluxio/alluxio#12179\nchange-id: cid-fc9d759f0ec0370b89dd8789b47e0cc7b807df12", "committedDate": "2020-10-06T00:14:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzMzY3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12181#discussion_r499933675", "bodyText": "does this todo need to be addressed?", "author": "yuzhu", "createdAt": "2020-10-05T23:56:03Z", "path": "core/server/common/pom.xml", "diffHunk": "@@ -35,12 +35,17 @@\n       <artifactId>kryo</artifactId>\n     </dependency>\n     <dependency>\n-      <groupId>io.atomix.copycat.alluxio</groupId>\n-      <artifactId>copycat-server</artifactId>\n+      <groupId>org.apache.ratis</groupId>\n+      <artifactId>ratis-server</artifactId>\n     </dependency>\n     <dependency>\n-      <groupId>io.atomix.copycat.alluxio</groupId>\n-      <artifactId>copycat-client</artifactId>\n+      <groupId>org.apache.ratis</groupId>\n+      <artifactId>ratis-grpc</artifactId>\n+    </dependency>\n+    <!-- TODO(lu) remove catalyst dependency which used for serialization and move to Grpc impl -->", "originalCommit": "458e0eadada2262d3fad8d88339f997055ae370d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk4MDgzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12181#discussion_r499980831", "bodyText": "this is a TODO for future, not target for 2.4", "author": "LuQQiu", "createdAt": "2020-10-06T03:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzMzY3NQ=="}], "type": "inlineReview"}]}