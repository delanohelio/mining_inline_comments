{"pr_number": 11527, "pr_title": "Add a root/nonroot switch to helm chart", "pr_createdAt": "2020-06-08T09:33:38Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11527", "timeline": [{"oid": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "url": "https://github.com/Alluxio/alluxio/commit/4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "message": "add root option", "committedDate": "2020-06-08T09:29:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3MTY4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436571681", "bodyText": "Use the specified .Values.master.hostNetwork if specified, otherwise infer based on whether the user is root.\nFYI for boolean values the {{ .Values.master.hostNetwork | default $isRoot}} grammar doesn't work, because a false value for .Values.master.hostNetwork will also go to the default branch.", "author": "jiacheliu3", "createdAt": "2020-06-08T09:36:34Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml", "diffHunk": "@@ -50,8 +50,8 @@ spec:\n         heritage: {{ .Release.Service }}\n         role: alluxio-master\n     spec:\n-      hostNetwork: {{ .Values.master.hostNetwork }}\n-      dnsPolicy: {{ .Values.master.dnsPolicy }}\n+      hostNetwork: {{ hasKey .Values.master \"hostNetwork\" | ternary .Values.master.hostNetwork $isRoot }}", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3MTkzNA==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436571934", "bodyText": "I don't think we still want to consider emptyDir, do we?", "author": "jiacheliu3", "createdAt": "2020-06-08T09:37:03Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml", "diffHunk": "@@ -194,8 +194,23 @@ spec:\n             claimName: \"{{ .name }}\"\n           {{- end }}\n         {{- end }}\n+  {{- if $isRoot }}\n+  volumes:\n+    {{- if $needJournalVolume }}\n+    - name: alluxio-journal\n+      hostPath:", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5NzkyMA==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436997920", "bodyText": "no", "author": "madanadit", "createdAt": "2020-06-08T21:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3MTkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3MjM1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436572355", "bodyText": "This field is obsoleted. Removing it is irrelevant to the change.", "author": "jiacheliu3", "createdAt": "2020-06-08T09:37:47Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -73,15 +73,13 @@ master:\n   # JVM options specific to the master container\n   jvmOptions:\n   nodeSelector: {}\n-  hostNetwork: false\n-  dnsPolicy: ClusterFirst\n   # Example: use ROCKS DB instead of Heap\n   # metastore:\n   #   size: 1Gi\n-  #   mountPath: /metastore", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3Mjg0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436572849", "bodyText": "Removed these two by default and use inference. However they can still be set to override, especially when we want to use some dnsPolicy other than ClusterFirst and ClusterFirstWithHostNet", "author": "jiacheliu3", "createdAt": "2020-06-08T09:38:41Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -73,15 +73,13 @@ master:\n   # JVM options specific to the master container\n   jvmOptions:\n   nodeSelector: {}\n-  hostNetwork: false\n-  dnsPolicy: ClusterFirst", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5OTAxMA==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436999010", "bodyText": "instead of removing this, i would comment it out and explain the order of precedence", "author": "madanadit", "createdAt": "2020-06-08T21:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3Mjg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM1OTY1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r437359651", "bodyText": "Good idea!", "author": "jiacheliu3", "createdAt": "2020-06-09T12:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3Mjg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5OTM3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436999373", "bodyText": "add comment defining when this property is used", "author": "madanadit", "createdAt": "2020-06-08T21:03:18Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -119,6 +117,7 @@ journal:\n   type: \"UFS\" # \"UFS\" or \"EMBEDDED\"\n   ufsType: \"local\" # Ignored if type is \"EMBEDDED\". \"local\" or \"HDFS\"\n   folder: \"/journal\" # Master journal folder\n+  hostPath: \"/tmp/journal\"", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5OTQ4NA==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r436999484", "bodyText": "same here, comment", "author": "madanadit", "createdAt": "2020-06-08T21:03:32Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -229,6 +226,7 @@ shortCircuit:\n     - ReadWriteOnce\n   pvcSize: 1Mi\n   pvcStorageClass: standard\n+  hostPath: \"/tmp/alluxio-domain\"", "originalCommit": "4356ef7c2ff97553eeb018a6832f5d6d1e03e927", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b5acfb4ec7c8df4040f902890c7f938cc2f55a39", "url": "https://github.com/Alluxio/alluxio/commit/b5acfb4ec7c8df4040f902890c7f938cc2f55a39", "message": "resolve comments", "committedDate": "2020-06-09T12:16:39Z", "type": "commit"}, {"oid": "567c2b727a505565bf49d7389541b6197d674337", "url": "https://github.com/Alluxio/alluxio/commit/567c2b727a505565bf49d7389541b6197d674337", "message": "dup key", "committedDate": "2020-06-09T15:08:12Z", "type": "commit"}, {"oid": "ff51ee6a1821208199550c9b8ae5bfb3843bacc3", "url": "https://github.com/Alluxio/alluxio/commit/ff51ee6a1821208199550c9b8ae5bfb3843bacc3", "message": "use random str for hostpath", "committedDate": "2020-06-09T15:14:59Z", "type": "commit"}, {"oid": "1933108f38cf6c1c635a94d877f6c7ac3d36550b", "url": "https://github.com/Alluxio/alluxio/commit/1933108f38cf6c1c635a94d877f6c7ac3d36550b", "message": "give up random id for hostpath dir", "committedDate": "2020-06-09T15:33:08Z", "type": "commit"}, {"oid": "c25dbb09a1514e976ecb1722f66245af263c5b52", "url": "https://github.com/Alluxio/alluxio/commit/c25dbb09a1514e976ecb1722f66245af263c5b52", "message": "remove hostpath for journal and metastore", "committedDate": "2020-06-09T15:35:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyOTY5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r437529691", "bodyText": "@madanadit I realized during testing that using hostPath is really hard when we deploy as StatefulSet, as each master should be using different paths. Current w/o internal logic in Alluxio (for example write to <journal-path>/<master-id>/ when given the journal path) I don't think it will work. Currently in a non-k8s env, we don't really support deploying multiple masters on one machine right?", "author": "jiacheliu3", "createdAt": "2020-06-09T15:39:56Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml", "diffHunk": "@@ -194,22 +194,8 @@ spec:\n             claimName: \"{{ .name }}\"\n           {{- end }}\n         {{- end }}\n-  {{- if $isRoot }}\n-    {{- if $needJournalVolume }}\n-        - name: alluxio-journal\n-          hostPath:\n-            path: {{ printf \"%v/%v\" .Values.journal.hostPath (randAlphaNum 16) }}\n-            type: DirectoryOrCreate\n-    {{- end }}\n-    {{- if .Values.master.metastore }}\n-        - name: alluxio-metastore\n-          hostPath:\n-            path: {{ printf \"%v/%v\" .Values.master.metastore.hostPath (randAlphaNum 16) }}\n-            type: DirectoryOrCreate\n-    {{- end }}\n-  {{- else }}", "originalCommit": "1933108f38cf6c1c635a94d877f6c7ac3d36550b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzgwNjY5Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11527#discussion_r437806693", "bodyText": "yep, multiple masters on the same host is not a scenario we plan to support", "author": "madanadit", "createdAt": "2020-06-10T01:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyOTY5MQ=="}], "type": "inlineReview"}, {"oid": "f7d644721024134dfd80d575bd79b24e4a00e0d5", "url": "https://github.com/Alluxio/alluxio/commit/f7d644721024134dfd80d575bd79b24e4a00e0d5", "message": "bump version", "committedDate": "2020-06-09T15:48:13Z", "type": "commit"}]}