{"pr_number": 11363, "pr_title": "Merge system properties in a thread-safe manner", "pr_createdAt": "2020-04-28T07:07:57Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11363", "timeline": [{"oid": "c2b5147e31b7b568b632c775262cd448f0f5cd67", "url": "https://github.com/Alluxio/alluxio/commit/c2b5147e31b7b568b632c775262cd448f0f5cd67", "message": "Merge system properties in a thread-safe manner", "committedDate": "2020-04-28T07:17:49Z", "type": "forcePushed"}, {"oid": "9aa1e1c93e4942e2f9da4326c37a4da046d2d7dd", "url": "https://github.com/Alluxio/alluxio/commit/9aa1e1c93e4942e2f9da4326c37a4da046d2d7dd", "message": "Merge system properties in a thread-safe manner", "committedDate": "2020-04-28T07:18:28Z", "type": "commit"}, {"oid": "9aa1e1c93e4942e2f9da4326c37a4da046d2d7dd", "url": "https://github.com/Alluxio/alluxio/commit/9aa1e1c93e4942e2f9da4326c37a4da046d2d7dd", "message": "Merge system properties in a thread-safe manner", "committedDate": "2020-04-28T07:18:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4MTQ2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11363#discussion_r418181463", "bodyText": "Can this also throw concurrent modification exception?", "author": "calvinjia", "createdAt": "2020-04-30T17:43:47Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -413,7 +413,12 @@ public static void reloadProperties() {\n       // property file.\n       AlluxioProperties properties = new AlluxioProperties();\n       InstancedConfiguration conf = new InstancedConfiguration(properties);\n-      properties.merge(System.getProperties(), Source.SYSTEM_PROPERTY);\n+      // Can't directly pass System.getProperties() because it is not thread-safe\n+      // This can cause a ConcurrentModificationException when merging.\n+      Properties sysProps = new Properties();\n+      System.getProperties().stringPropertyNames()\n+          .forEach(key -> sysProps.setProperty(key, System.getProperty(key)));", "originalCommit": "9aa1e1c93e4942e2f9da4326c37a4da046d2d7dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4OTI2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11363#discussion_r418189262", "bodyText": "No, The set returned from stringPropertyNames is a copy of the keys at the time of calling:\nFrom: https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html#stringPropertyNames--\n\nThe returned set is not backed by the Properties object. Changes to this Properties are not reflected in the set, or vice versa.\n\nhttps://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/f54e9b7c1036/src/share/classes/java/util/Properties.java#l1030", "author": "ZacBlanco", "createdAt": "2020-04-30T17:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4MTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzY3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11363#discussion_r418223673", "bodyText": "The implementation of stringPropertyNames uses an enumerator on the keys?", "author": "calvinjia", "createdAt": "2020-04-30T18:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4MTQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3NTA1OA==", "url": "https://github.com/Alluxio/alluxio/pull/11363#discussion_r418275058", "bodyText": "The enumerator is safe against ConcurrentModificationException. Calling stringPropertyNames loops over the keys() method of the Hashtable\n\nkeys() is implemented via an internal Enumeration object\n\nIterating over all of the keys with the Enumerator is safe against ConcurrentModificationException so long as remove() and next() isn't called. Neither are called because the Properties implementation uses nextElement() rather than next()", "author": "ZacBlanco", "createdAt": "2020-04-30T20:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4MTQ2Mw=="}], "type": "inlineReview"}]}