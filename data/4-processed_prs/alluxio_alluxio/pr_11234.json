{"pr_number": 11234, "pr_title": "Update alluxio-mount.sh for FreeBSD", "pr_createdAt": "2020-04-02T11:40:21Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11234", "timeline": [{"oid": "be8c99d9da11ee1de6dccecc4d76f279e9a229d4", "url": "https://github.com/Alluxio/alluxio/commit/be8c99d9da11ee1de6dccecc4d76f279e9a229d4", "message": "Update alluxio-mount.sh for FreeBSD\n\nWith the changes above, we can use alluxio with FreeBSD.", "committedDate": "2020-04-02T11:40:03Z", "type": "commit"}, {"oid": "a98d4f9bef7a12c2f89f1011101d4cbdbc72ecd8", "url": "https://github.com/Alluxio/alluxio/commit/a98d4f9bef7a12c2f89f1011101d4cbdbc72ecd8", "message": "Update alluxio-mount.sh\n\nFixed unmount for FreeBSD", "committedDate": "2020-04-02T12:57:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4NzI4MA==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403087280", "bodyText": "is tmpfs vs ramfs the only difference between this and the linux implementation?", "author": "ZacBlanco", "createdAt": "2020-04-03T15:29:15Z", "path": "bin/alluxio-mount.sh", "diffHunk": "@@ -87,6 +87,65 @@ function umount_ramfs_linux() {\n   fi\n }\n \n+function check_space_freebsd() {\n+  local total_mem=$(($(sysctl -h hw.usermem | awk 'NR==1{print $2}' | sed 's/,//g')))\n+  if [[ ${total_mem} -lt ${MEM_SIZE} ]]; then\n+    echo \"ERROR: Memory(${total_mem}) is less than requested ramdisk size(${MEM_SIZE}). Please\n+    reduce alluxio.worker.memory.size in alluxio-site.properties\" >&2\n+    exit 1\n+  fi\n+}\n+\n+function mount_ramfs_freebsd() {\n+  TIER_PATH=${1}\n+  echo \"Formatting RamFS: ${TIER_PATH} (${MEM_SIZE})\"\n+  if [[ ${USE_SUDO} == true ]]; then\n+    sudo mkdir -p ${TIER_PATH}\n+  else\n+    mkdir -p ${TIER_PATH}\n+  fi\n+  if [[ $? -ne 0 ]]; then\n+    echo \"ERROR: mkdir ${TIER_PATH} failed\" >&2\n+    exit 1\n+  fi\n+\n+  if [[ ${USE_SUDO} == true ]]; then\n+    sudo mount -t tmpfs -o size=${MEM_SIZE} tmpfs ${TIER_PATH}", "originalCommit": "a98d4f9bef7a12c2f89f1011101d4cbdbc72ecd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5MTg5NA==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403091894", "bodyText": "Additionally, I came across this link in the freebsd handbook which suggests a different approach: https://www.freebsd.org/doc/handbook/disks-virtual.html\n\nTo instead create a new memory-based memory disk with mdmfs, use this one command:\n\n# mdmfs -s 5m md1 /mnt\n\nHere is the man page on mdfs: www.freebsd.org/cgi/man.cgi?query=mdmfs&sektion=8&manpath=freebsd-release-ports\nHave you considered this option?", "author": "ZacBlanco", "createdAt": "2020-04-03T15:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4NzI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Mzg1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403463851", "bodyText": "Additionally, I came across this link in the freebsd handbook which suggests a different approach: https://www.freebsd.org/doc/handbook/disks-virtual.html\n\nTo instead create a new memory-based memory disk with mdmfs, use this one command:\n\n# mdmfs -s 5m md1 /mnt\n\nHere is the man page on mdfs: www.freebsd.org/cgi/man.cgi?query=mdmfs&sektion=8&manpath=freebsd-release-ports\nHave you considered this option?\n\nYes I did but I wanted the code to be as similar to the linux version as possible. The mount -t tmpfs does basically the same thing based on the alluxio usage, see https://www.freebsd.org/cgi/man.cgi?query=mdmfs&sektion=8&manpath=freebsd-release-ports:\n     When md-device is `auto', mdmfs uses tmpfs(5) if it is present in the\n     kernel or can be loaded as\ta module, otherwise it falls back to using\n     md(4) auto-unit as\tif `md'\thad been specified.\n\n     When md-device is `tmpfs',\tmdmfs mounts a tmpfs(5)\tfilesystem, translat-\n     ing the -s\tsize option, if\tpresent, into a\t`-o size=' mount option.  Any\n     -o\toptions\ton the command line are\tpassed through to the tmpfs(5) mount.\n     Options specific to mdconfig(8) or\tnewfs(8) are ignored.\n\n\nis tmpfs vs ramfs the only difference between this and the linux implementation?\n\nThe other difference is that this implementation also uses sysctl instead of /proc/meminfo to avoid requiring mounting procfs.", "author": "martenlindblad", "createdAt": "2020-04-04T12:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4NzI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzYyMDM4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403620381", "bodyText": "Thanks for the clarification!", "author": "ZacBlanco", "createdAt": "2020-04-05T01:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4NzI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzYxOTcwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403619706", "bodyText": "Just trying to understand this command\n\nsysctl -h hw.usermem\n\nprints out the system memory in human-readable format because of the -h flag\n\nawk 'NR==1{print $2}\n\nThis will print out the 2nd column from the first line, where the column is defined by a  char. I'm assuming the 2nd column is the value for the hw.usermem\n\nsed 's/,//g'\n\nRemoves an commas from the resulting output.\nMy only question with this set of commands is the -h flag. It will print in human readable format, but does that mean it will convert bytes to kb, mb, gb, etc dynamically based on the actual value?\nIn our linux version we use /proc/meminfo which always prints in kb, and then multiply that value by 1024. If we leave off the -h will it just give us the raw value in bytes? I think that is what we want.\n(sorry I don't have a freebsd system available to test this myself)", "author": "ZacBlanco", "createdAt": "2020-04-05T01:24:16Z", "path": "bin/alluxio-mount.sh", "diffHunk": "@@ -87,6 +87,65 @@ function umount_ramfs_linux() {\n   fi\n }\n \n+function check_space_freebsd() {\n+  local total_mem=$(($(sysctl -h hw.usermem | awk 'NR==1{print $2}' | sed 's/,//g')))", "originalCommit": "a98d4f9bef7a12c2f89f1011101d4cbdbc72ecd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY4MTMyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11234#discussion_r403681329", "bodyText": "You're right, this was really sloppy from me. The correct way of doing it is sysctl -n hw.usermem. That way we can omit the awk and sed commands. I will update the PR.", "author": "martenlindblad", "createdAt": "2020-04-05T10:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzYxOTcwNg=="}], "type": "inlineReview"}, {"oid": "6a432714d0c80c13a3978cc7d48f5669eb0e6330", "url": "https://github.com/Alluxio/alluxio/commit/6a432714d0c80c13a3978cc7d48f5669eb0e6330", "message": "Update alluxio-mount.sh", "committedDate": "2020-04-05T10:30:04Z", "type": "commit"}]}