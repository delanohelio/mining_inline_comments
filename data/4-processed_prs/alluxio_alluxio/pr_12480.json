{"pr_number": 12480, "pr_title": "Enable ufsIOtest to retrieve configuration from a mount point", "pr_createdAt": "2020-11-10T01:24:53Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12480", "timeline": [{"oid": "2bbd2b7236fada422c18fd0285dcd4991bf7cf64", "url": "https://github.com/Alluxio/alluxio/commit/2bbd2b7236fada422c18fd0285dcd4991bf7cf64", "message": "Expose mount id in mount table listing", "committedDate": "2020-11-08T18:18:54Z", "type": "commit"}, {"oid": "c90d3828092fa7c8618a453e6cd8efbbbb4f000a", "url": "https://github.com/Alluxio/alluxio/commit/c90d3828092fa7c8618a453e6cd8efbbbb4f000a", "message": "Add support for loading options from Ufs for IO tests", "committedDate": "2020-11-10T01:23:18Z", "type": "commit"}, {"oid": "bc0c4067795d1bd022a618ec7c18d457f6248310", "url": "https://github.com/Alluxio/alluxio/commit/bc0c4067795d1bd022a618ec7c18d457f6248310", "message": "Fix checkstyle", "committedDate": "2020-11-10T01:36:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5ODQ3NA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520798474", "bodyText": "can we add unittests for this class and methods?", "author": "gpang", "createdAt": "2020-11-10T18:55:25Z", "path": "core/base/src/main/java/alluxio/wire/MountPointInfo.java", "diffHunk": "@@ -170,18 +187,19 @@ public boolean equals(Object o) {\n     return mUfsUri.equals(that.mUfsUri) && mUfsType.equals(that.mUfsType)\n         && mUfsCapacityBytes == that.mUfsCapacityBytes && mUfsUsedBytes == that.mUfsUsedBytes\n         && mReadOnly == that.mReadOnly && mProperties.equals(that.mProperties)\n-        && mShared == that.mShared;\n+        && mShared == that.mShared && mMountId == that.mMountId;", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTQ4Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520881482", "bodyText": "i think there already is a equality check test", "author": "yuzhu", "createdAt": "2020-11-10T21:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5ODQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5ODc4NA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520798784", "bodyText": "Can we add unittests for these new methods?", "author": "gpang", "createdAt": "2020-11-10T18:55:43Z", "path": "core/common/src/main/java/alluxio/grpc/GrpcUtils.java", "diffHunk": "@@ -303,7 +303,9 @@ public static MountPointInfo fromProto(alluxio.grpc.MountPointInfo mountPointPIn\n         .setUfsCapacityBytes(mountPointPInfo.getUfsCapacityBytes())\n         .setUfsUsedBytes(mountPointPInfo.getUfsUsedBytes())\n         .setReadOnly(mountPointPInfo.getReadOnly())\n-        .setProperties(mountPointPInfo.getPropertiesMap()).setShared(mountPointPInfo.getShared());\n+        .setProperties(mountPointPInfo.getPropertiesMap())\n+        .setMountId(mountPointPInfo.getMountId())", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTM0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520881345", "bodyText": "added", "author": "yuzhu", "createdAt": "2020-11-10T21:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5ODc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMDA2OA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520800068", "bodyText": "Hrmmm, I don't know the answer this question, but is it a problem for existing UFS implementations if we changed the UFS interface?\n@madanadit", "author": "gpang", "createdAt": "2020-11-10T18:57:01Z", "path": "core/common/src/main/java/alluxio/underfs/UnderFileSystem.java", "diffHunk": "@@ -338,6 +337,13 @@ public int getValue() {\n   @Deprecated\n   long getBlockSizeByte(String path) throws IOException;\n \n+  /**\n+   * Gets the under file system configuration.\n+   *\n+   * @return the configuration\n+   */\n+  AlluxioConfiguration getConfiguration() throws IOException;", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgyODY5OA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r521828698", "bodyText": "This is a public API, so ideally we provide a default implementation in the interface for back-compat with something like\n  default AlluxioConfiguration getConfiguration() {\n    return <empty AlluxioConfiguration>;\n  }\n\nAs far as I remember, the reason for this being a public API is ufs extensions. If we change it, any ufs extension not deriving from BaseUfs has to implement this new method (other than re-compilation for new Alluxio version). This may or may not be an issue since I can't think of any known ufs extension which does not.", "author": "madanadit", "createdAt": "2020-11-12T04:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMDA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1NzUwNg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r521857506", "bodyText": "fixed", "author": "yuzhu", "createdAt": "2020-11-12T05:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMDA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMTE0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520801149", "bodyText": "Does anything set the mount id in this test file?", "author": "gpang", "createdAt": "2020-11-10T18:58:15Z", "path": "core/common/src/test/java/alluxio/wire/MountPointInfoTest.java", "diffHunk": "@@ -38,6 +38,7 @@ public void checkEquality(MountPointInfo a, MountPointInfo b) {\n     Assert.assertEquals(a.getUfsUsedBytes(), b.getUfsUsedBytes());\n     Assert.assertEquals(a.getReadOnly(), b.getReadOnly());\n     Assert.assertEquals(a.getProperties(), b.getProperties());\n+    Assert.assertEquals(a.getMountId(), b.getMountId());", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTU5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520881595", "bodyText": "updated to add test for this", "author": "yuzhu", "createdAt": "2020-11-10T21:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MjEzOA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520882138", "bodyText": "updated to add test for this", "author": "yuzhu", "createdAt": "2020-11-10T21:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMTE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNjg4OA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520806888", "bodyText": "Do we have a unittest for this?", "author": "gpang", "createdAt": "2020-11-10T19:04:44Z", "path": "core/server/master/src/main/java/alluxio/master/file/meta/options/MountInfo.java", "diffHunk": "@@ -88,6 +88,7 @@ public MountPointInfo toMountPointInfo() {\n     info.setReadOnly(mOptions.getReadOnly());\n     info.setProperties(mOptions.getProperties());\n     info.setShared(mOptions.getShared());\n+    info.setMountId(mMountId);", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTcyMA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520881720", "bodyText": "updated", "author": "yuzhu", "createdAt": "2020-11-10T21:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNjg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODM2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520808362", "bodyText": "I'm not familiar with this. What does this do?", "author": "gpang", "createdAt": "2020-11-10T19:07:30Z", "path": "stress/common/src/main/java/alluxio/stress/worker/UfsIOParameters.java", "diffHunk": "@@ -31,10 +35,16 @@\n   public String mDataSize = \"4G\";\n \n   @Parameter(names = {\"--path\"},\n-          description = \"the Alluxio directory to write temporary data in\",\n+          description = \"the Ufs Path to write temporary data in\",\n           required = true)\n   public String mPath;\n \n+  @Parameter(names = {\"--use-ufs-conf\"},\n+      description = \"If true, use the existing ufs configuration to read/write to the base path\")\n+  @Parameters.BooleanDescription(trueDescription = \"UseUFSConf\",", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MzQ0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520883443", "bodyText": "not sure? i modeled after other parameters, but removed for now for simplicity.", "author": "yuzhu", "createdAt": "2020-11-10T21:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5NzI2OA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520897268", "bodyText": "O yeah, I remember this now. This is for graphing later. It is useful to have a description for true and false, instead of just displaying true or false. This probably won't matter in this case.", "author": "gpang", "createdAt": "2020-11-10T21:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODcxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520808711", "bodyText": "where does this ufs conf come from?", "author": "gpang", "createdAt": "2020-11-10T19:08:10Z", "path": "stress/common/src/main/java/alluxio/stress/worker/UfsIOParameters.java", "diffHunk": "@@ -31,10 +35,16 @@\n   public String mDataSize = \"4G\";\n \n   @Parameter(names = {\"--path\"},\n-          description = \"the Alluxio directory to write temporary data in\",\n+          description = \"the Ufs Path to write temporary data in\",\n           required = true)\n   public String mPath;\n \n+  @Parameter(names = {\"--use-ufs-conf\"},\n+      description = \"If true, use the existing ufs configuration to read/write to the base path\")", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MzA2OA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520883068", "bodyText": "added that it comes from mount table", "author": "yuzhu", "createdAt": "2020-11-10T21:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwODcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTYzNg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520809636", "bodyText": "Can you update the names in this file to use these constants?", "author": "gpang", "createdAt": "2020-11-10T19:09:52Z", "path": "stress/common/src/main/java/alluxio/stress/worker/UfsIOParameters.java", "diffHunk": "@@ -23,6 +23,10 @@\n  * Parameters used in the UFS I/O throughput test.\n  * */\n public class UfsIOParameters extends Parameters {\n+  public static final String USE_UFS_CONF = \"--use-ufs-conf\";", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NzAxNA==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520887014", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-11-10T21:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MTEzMg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520941132", "bodyText": "NIT: I think something like --is-mounted or --use-mount-conf makes a bit more sense, since this essentially controls if the path is mounted or not.", "author": "gpang", "createdAt": "2020-11-10T23:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTk3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520809972", "bodyText": "Will this work with nested mounts?", "author": "gpang", "createdAt": "2020-11-10T19:10:29Z", "path": "job/server/src/main/java/alluxio/job/plan/stress/StressBenchDefinition.java", "diffHunk": "@@ -91,23 +97,56 @@ public StressBenchDefinition() {\n     return result;\n   }\n \n+  private Map<String, String> getUfsConf(String ufsUri, RunTaskContext runTaskContext)\n+      throws Exception {\n+    Map<String, MountPointInfo> mountTable = runTaskContext.getFileSystem().getMountTable();\n+    for (Map.Entry<String, MountPointInfo> entry : mountTable.entrySet()) {\n+      if (PathUtils.hasPrefix(ufsUri, entry.getKey())) {", "originalCommit": "bc0c4067795d1bd022a618ec7c18d457f6248310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NDg5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520884892", "bodyText": "yes, this is a ufs Uri. We can't mount both a parent Ufs URI and a sub directory ufs URI.", "author": "yuzhu", "createdAt": "2020-11-10T21:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTk3Mg=="}], "type": "inlineReview"}, {"oid": "d9b89eee7a1be76ca0233d85c6825c3753072696", "url": "https://github.com/Alluxio/alluxio/commit/d9b89eee7a1be76ca0233d85c6825c3753072696", "message": "Address comments", "committedDate": "2020-11-10T21:28:50Z", "type": "commit"}, {"oid": "3ad14ac658d05ddd9667e8f572b3b15c4b6f37f5", "url": "https://github.com/Alluxio/alluxio/commit/3ad14ac658d05ddd9667e8f572b3b15c4b6f37f5", "message": "Address comments", "committedDate": "2020-11-10T21:36:08Z", "type": "commit"}, {"oid": "8af5ce19b3faba1db6e3122d3aa19476243a7df1", "url": "https://github.com/Alluxio/alluxio/commit/8af5ce19b3faba1db6e3122d3aa19476243a7df1", "message": "Fix tests", "committedDate": "2020-11-10T22:10:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDcwNg==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r520940706", "bodyText": "If this is set to true, does the existing --conf get ignored, or are they merged? Which takes priority? Can we add this info to the description?", "author": "gpang", "createdAt": "2020-11-10T23:31:30Z", "path": "stress/common/src/main/java/alluxio/stress/worker/UfsIOParameters.java", "diffHunk": "@@ -23,19 +23,28 @@\n  * Parameters used in the UFS I/O throughput test.\n  * */\n public class UfsIOParameters extends Parameters {\n+  public static final String USE_UFS_CONF = \"--use-ufs-conf\";\n+  public static final String CONF = \"--conf\";\n+  public static final String PATH = \"--path\";\n+\n   @Parameter(names = {\"--threads\"}, description = \"the number of threads to use\")\n   public int mThreads = 4;\n \n   @Parameter(names = {\"--io-size\"},\n           description = \"size of data to write and then read for each thread\")\n   public String mDataSize = \"4G\";\n \n-  @Parameter(names = {\"--path\"},\n-          description = \"the Alluxio directory to write temporary data in\",\n+  @Parameter(names = {PATH},\n+          description = \"the Ufs Path to write temporary data in\",\n           required = true)\n   public String mPath;\n \n-  @DynamicParameter(names = \"--conf\",\n+  @Parameter(names = {USE_UFS_CONF},\n+      description = \"If true, attempt to load the ufs configuration from an existing mount point \"\n+          + \"to read/write to the base path\")", "originalCommit": "8af5ce19b3faba1db6e3122d3aa19476243a7df1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ5Nzg4OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12480#discussion_r521497889", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-11-11T16:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDcwNg=="}], "type": "inlineReview"}, {"oid": "d7963dac623e4bd0aa023039218a9e2f9d2888fe", "url": "https://github.com/Alluxio/alluxio/commit/d7963dac623e4bd0aa023039218a9e2f9d2888fe", "message": "Address comments", "committedDate": "2020-11-11T16:54:19Z", "type": "commit"}, {"oid": "6c4a7a073b6a897133fd6e8623b4fc48572e6ef6", "url": "https://github.com/Alluxio/alluxio/commit/6c4a7a073b6a897133fd6e8623b4fc48572e6ef6", "message": "Address comments", "committedDate": "2020-11-12T05:57:31Z", "type": "commit"}, {"oid": "0553496019d7f91adb134cf95a0c15d22fef7c4b", "url": "https://github.com/Alluxio/alluxio/commit/0553496019d7f91adb134cf95a0c15d22fef7c4b", "message": "Fix compilation", "committedDate": "2020-11-12T06:05:42Z", "type": "commit"}]}