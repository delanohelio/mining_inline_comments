{"pr_number": 11424, "pr_title": "Add bootstrap build scripts to tweak bootstrap files", "pr_createdAt": "2020-05-12T21:42:04Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11424", "timeline": [{"oid": "d25ef4994cef6c3b793772a6677a22c5f0f8cab4", "url": "https://github.com/Alluxio/alluxio/commit/d25ef4994cef6c3b793772a6677a22c5f0f8cab4", "message": "Add bootstrap build scripts to tweak bootstrap files", "committedDate": "2020-05-12T21:40:39Z", "type": "commit"}, {"oid": "02950631b0d191f5cc917376946e9b188536eab5", "url": "https://github.com/Alluxio/alluxio/commit/02950631b0d191f5cc917376946e9b188536eab5", "message": "different os types", "committedDate": "2020-05-12T21:59:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MTI5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424071297", "bodyText": "if the file is updated in the future in a way that results in this sed operation doing zero replacements, is there a way to detect and trigger failure? trying to avoid the scenario where things get refactored and silently fail", "author": "Xenorith", "createdAt": "2020-05-12T22:31:59Z", "path": "integration/dataproc/build.sh", "diffHunk": "@@ -0,0 +1,27 @@\n+#!/bin/bash\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+ALLUXIO_DOWNLOAD_URL=${1}\n+\n+if [[ -z ${ALLUXIO_DOWNLOAD_URL} ]]; then\n+  echo \"Alluxio tarball URL cannot be empty\"\n+  exit 1\n+fi\n+\n+# replace ALLUXIO_DOWNLOAD_URL in dataproc files\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+\n+if [[ \"$OSTYPE\" == \"darwin\"* ]]; then\n+  sed -i '' -e \"s|^readonly ALLUXIO_DOWNLOAD_URL.*\\$|readonly ALLUXIO_DOWNLOAD_URL=\\\"${ALLUXIO_DOWNLOAD_URL}\\\"|\" ${DIR}/*\n+else\n+  sed -i -e \"s|^readonly ALLUXIO_DOWNLOAD_URL.*\\$|readonly ALLUXIO_DOWNLOAD_URL=\\\"${ALLUXIO_DOWNLOAD_URL}\\\"|\" ${DIR}/*", "originalCommit": "02950631b0d191f5cc917376946e9b188536eab5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5MTA1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424091059", "bodyText": "ping on this comment", "author": "Xenorith", "createdAt": "2020-05-12T23:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MTI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NjUyMw==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424096523", "bodyText": "i'll diff the .generated files with the original to see if changes were made", "author": "tieujason330", "createdAt": "2020-05-12T23:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MTI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMDEwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424100106", "bodyText": "maybe a grep for the matching string before the sed is easier? you could replace the url with the same url that was there and result in no diff", "author": "Xenorith", "createdAt": "2020-05-13T00:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MTI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMjc4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424102787", "bodyText": "ok sounds good", "author": "tieujason330", "createdAt": "2020-05-13T00:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MTI5Nw=="}], "type": "inlineReview"}, {"oid": "82c4c25b8d7a4d05336ead4e9666b56934fa0367", "url": "https://github.com/Alluxio/alluxio/commit/82c4c25b8d7a4d05336ead4e9666b56934fa0367", "message": "create .generated dir with file copies", "committedDate": "2020-05-12T23:20:59Z", "type": "commit"}, {"oid": "6a0c7ca789995909face999f2103a09e74a47996", "url": "https://github.com/Alluxio/alluxio/commit/6a0c7ca789995909face999f2103a09e74a47996", "message": "eof newlines", "committedDate": "2020-05-12T23:21:31Z", "type": "commit"}, {"oid": "870f041dc6dca288ce1adf2e50a51cdb2d2fab7b", "url": "https://github.com/Alluxio/alluxio/commit/870f041dc6dca288ce1adf2e50a51cdb2d2fab7b", "message": "diff check", "committedDate": "2020-05-13T00:06:50Z", "type": "commit"}, {"oid": "d517eb54b7312ee4a852699c4cb6fd2b5c228aa5", "url": "https://github.com/Alluxio/alluxio/commit/d517eb54b7312ee4a852699c4cb6fd2b5c228aa5", "message": "change to grep", "committedDate": "2020-05-13T00:22:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExMDU3NA==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424110574", "bodyText": "this doesn't account for the \"fail to find the string to replace\" scenario\nif i were refactoring the script and renamed ALLUXIO_DOWNLOAD_URL to ALLUXIO_DOWNLOAD_S3_URL, this script would not replace anything but pass.\nif alluxio download url is set {\n  if string to be replaced by (ex. readonly ALLUXIO_DOWNLOAD_URL=.*) isn't found by grep -> fail\n  replace string with perl cmd\n}\n\nit's fine to replace the same string; that's not much of a concern. i brought up the scenario as a counterexample to why using diff wouldn't be as dependable as using grep", "author": "Xenorith", "createdAt": "2020-05-13T00:39:54Z", "path": "integration/dataproc/build.sh", "diffHunk": "@@ -0,0 +1,29 @@\n+#!/bin/bash\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+# Running this script will create edited versions of the files in the .generated directory\n+set -e\n+\n+ALLUXIO_DOWNLOAD_URL=${1}\n+\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+mkdir -p ${DIR}/.generated\n+cp ${DIR}/alluxio.sh ${DIR}/.generated\n+\n+# replace ALLUXIO_DOWNLOAD_URL in dataproc init script (alluxio.sh)\n+if [[ -n ${ALLUXIO_DOWNLOAD_URL} ]]; then\n+    if [[ -n $(grep \"readonly ALLUXIO_DOWNLOAD_URL=\\\"${ALLUXIO_DOWNLOAD_URL}\\\"\" \"${DIR}/alluxio.sh\") ]]; then", "originalCommit": "d517eb54b7312ee4a852699c4cb6fd2b5c228aa5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExMTIyNg==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424111226", "bodyText": "alluxio-emr.sh -> alluxio.sh\nprobably more convenient to make this a bash variable", "author": "Xenorith", "createdAt": "2020-05-13T00:42:24Z", "path": "integration/dataproc/build.sh", "diffHunk": "@@ -0,0 +1,29 @@\n+#!/bin/bash\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+# Running this script will create edited versions of the files in the .generated directory\n+set -e\n+\n+ALLUXIO_DOWNLOAD_URL=${1}\n+\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+mkdir -p ${DIR}/.generated\n+cp ${DIR}/alluxio.sh ${DIR}/.generated\n+\n+# replace ALLUXIO_DOWNLOAD_URL in dataproc init script (alluxio.sh)\n+if [[ -n ${ALLUXIO_DOWNLOAD_URL} ]]; then\n+    if [[ -n $(grep \"readonly ALLUXIO_DOWNLOAD_URL=\\\"${ALLUXIO_DOWNLOAD_URL}\\\"\" \"${DIR}/alluxio.sh\") ]]; then\n+    echo \"ERROR: ${ALLUXIO_DOWNLOAD_URL} is already set. No change was made to alluxio-emr.sh\"", "originalCommit": "d517eb54b7312ee4a852699c4cb6fd2b5c228aa5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExNzE1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424117156", "bodyText": "it'll be difficult to use build.sh generically if i need to know the file names beforehand", "author": "tieujason330", "createdAt": "2020-05-13T01:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExMTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExOTYzNg==", "url": "https://github.com/Alluxio/alluxio/pull/11424#discussion_r424119636", "bodyText": "i meant as a bash variable like readonly FILENAME=alluxio.sh, not an argument into the script", "author": "Xenorith", "createdAt": "2020-05-13T01:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDExMTIyNg=="}], "type": "inlineReview"}, {"oid": "88798b081823729cb275cd85746a1cc6b1ae8294", "url": "https://github.com/Alluxio/alluxio/commit/88798b081823729cb275cd85746a1cc6b1ae8294", "message": "fix grep", "committedDate": "2020-05-13T01:15:35Z", "type": "commit"}, {"oid": "95a03ff1c7f29927ceb385ebbf881d5a97abc4a9", "url": "https://github.com/Alluxio/alluxio/commit/95a03ff1c7f29927ceb385ebbf881d5a97abc4a9", "message": "var cleanup", "committedDate": "2020-05-13T01:22:26Z", "type": "commit"}]}