{"pr_number": 11194, "pr_title": "Use worker podIP for connect and hostIP for block locations", "pr_createdAt": "2020-03-20T06:01:23Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11194", "timeline": [{"oid": "8d7deb020d972e2b892784fc8d6ee571bf3a1b64", "url": "https://github.com/Alluxio/alluxio/commit/8d7deb020d972e2b892784fc8d6ee571bf3a1b64", "message": "try register with worker node hostname", "committedDate": "2020-03-18T02:14:17Z", "type": "commit"}, {"oid": "305b544453f7d4b8ebe9108e55cc09f7d7b91c3f", "url": "https://github.com/Alluxio/alluxio/commit/305b544453f7d4b8ebe9108e55cc09f7d7b91c3f", "message": "do the translation", "committedDate": "2020-03-19T04:17:06Z", "type": "commit"}, {"oid": "9a2e8c972a8066586c38c2bba9b06063c53eb542", "url": "https://github.com/Alluxio/alluxio/commit/9a2e8c972a8066586c38c2bba9b06063c53eb542", "message": "change to WORKER_NODE_HOSTNAME", "committedDate": "2020-03-19T12:15:37Z", "type": "commit"}, {"oid": "30586ace7b8aeb7b533a73b4fa6fac7ab934d8dd", "url": "https://github.com/Alluxio/alluxio/commit/30586ace7b8aeb7b533a73b4fa6fac7ab934d8dd", "message": "getOutStream translation", "committedDate": "2020-03-20T04:20:17Z", "type": "commit"}, {"oid": "a23ba03349dbbb6985953a1cbd3b49aa0d53ed8e", "url": "https://github.com/Alluxio/alluxio/commit/a23ba03349dbbb6985953a1cbd3b49aa0d53ed8e", "message": "include worker yaml change", "committedDate": "2020-03-20T06:19:24Z", "type": "commit"}, {"oid": "8a4a007293c0751a2fe2bed51efba5c59841496c", "url": "https://github.com/Alluxio/alluxio/commit/8a4a007293c0751a2fe2bed51efba5c59841496c", "message": "update configmap", "committedDate": "2020-03-20T06:24:23Z", "type": "commit"}, {"oid": "c0d3e33e65338e8a272766920ea047a9bbc14d40", "url": "https://github.com/Alluxio/alluxio/commit/c0d3e33e65338e8a272766920ea047a9bbc14d40", "message": "working example", "committedDate": "2020-03-29T10:55:45Z", "type": "commit"}, {"oid": "e2c3f8539b109207bcebf24d8667197042e32df8", "url": "https://github.com/Alluxio/alluxio/commit/e2c3f8539b109207bcebf24d8667197042e32df8", "message": "use alluxio.worker.container.hostname", "committedDate": "2020-04-01T03:30:52Z", "type": "commit"}, {"oid": "460da7006c03ab2c961bf13d1bfac113986de271", "url": "https://github.com/Alluxio/alluxio/commit/460da7006c03ab2c961bf13d1bfac113986de271", "message": "prepare for test", "committedDate": "2020-04-01T04:06:08Z", "type": "commit"}, {"oid": "e2252ce2c414d0cf3cc2d6edb5ccd78dfe479df5", "url": "https://github.com/Alluxio/alluxio/commit/e2252ce2c414d0cf3cc2d6edb5ccd78dfe479df5", "message": "update templates", "committedDate": "2020-04-01T06:26:57Z", "type": "commit"}, {"oid": "f47a5a9a6a4bb66997e3b1159aba7462d2a084c6", "url": "https://github.com/Alluxio/alluxio/commit/f47a5a9a6a4bb66997e3b1159aba7462d2a084c6", "message": "format", "committedDate": "2020-04-01T07:19:32Z", "type": "commit"}, {"oid": "00c49c567efcbcb59d2d3ce4a03d3a02624e8e49", "url": "https://github.com/Alluxio/alluxio/commit/00c49c567efcbcb59d2d3ce4a03d3a02624e8e49", "message": "add comment", "committedDate": "2020-04-01T12:02:33Z", "type": "commit"}, {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "url": "https://github.com/Alluxio/alluxio/commit/14bd1c8a9cad43e7f419b69a58be1583d721cb35", "message": "revert change in Dockerfile", "committedDate": "2020-04-01T12:03:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0NzkyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402047925", "bodyText": "I suggest not replacing the field here and instead using containerHost instead of host in https://github.com/Alluxio/alluxio/blob/master/core/common/src/main/java/alluxio/util/network/NetworkAddressUtils.java#L631\nThis is used across both read and write paths (GrpcDataReader and GrpcDataWriter) and will act as the single point of change", "author": "madanadit", "createdAt": "2020-04-02T04:41:40Z", "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -214,6 +214,15 @@ public BlockInStream getInStream(BlockInfo info, InStreamOptions options,\n     }\n \n     try {\n+      // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+      // to establish the connection.\n+      if (!dataSource.getContainerHost().equals(\"\")) {\n+        String containerName = dataSource.getContainerHost();\n+        LOG.debug(\"Worker is in a container. Replace host {} with container host {}\",\n+                dataSource.getHost(), containerName);\n+        dataSource.setHost(containerName);", "originalCommit": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0ODA4OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402048089", "bodyText": "this redundant translation can be avoided with the change in NetworkAddressUtils", "author": "madanadit", "createdAt": "2020-04-02T04:42:26Z", "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -264,6 +273,15 @@ public BlockOutStream getOutStream(long blockId, long blockSize, WorkerNetAddres\n     }\n     LOG.debug(\"Create block outstream for {} of block size {} at address {}, using options: {}\",\n         blockId, blockSize, address, options);\n+\n+    // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+    // to establish the connection.\n+    if (!address.getContainerHost().equals(\"\")) {", "originalCommit": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTg4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402049885", "bodyText": "same here, this block also ends up calling NetworkAddressUtils to create GrpcDataWriter", "author": "madanadit", "createdAt": "2020-04-02T04:50:23Z", "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -333,6 +351,17 @@ public BlockOutStream getOutStream(long blockId, long blockSize, OutStreamOption\n           \"Not enough workers for replications, %d workers selected but %d required\",\n           workerAddressList.size(), initialReplicas));\n     }\n+\n+    // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+    // to establish the connection.\n+    for (WorkerNetAddress workerAddress : workerAddressList) {", "originalCommit": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MjIyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402672224", "bodyText": "Update the javadoc?", "author": "bf8086", "createdAt": "2020-04-03T00:32:36Z", "path": "core/common/src/main/java/alluxio/wire/WorkerNetAddress.java", "diffHunk": "@@ -53,6 +54,14 @@ public String getHost() {\n     return mHost;\n   }\n \n+  /**\n+   * @return the host of the worker", "originalCommit": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51498ac9b186f26706dd985c8d2745dc71194605", "url": "https://github.com/Alluxio/alluxio/commit/51498ac9b186f26706dd985c8d2745dc71194605", "message": "resolve comments", "committedDate": "2020-04-03T06:15:29Z", "type": "commit"}, {"oid": "ec39cd3d580fd45ed27a3dc119c289a69cd56859", "url": "https://github.com/Alluxio/alluxio/commit/ec39cd3d580fd45ed27a3dc119c289a69cd56859", "message": "revert change in AlluxioBlockStore", "committedDate": "2020-04-03T06:17:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEyNTg0Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r403125847", "bodyText": "instead of changing al numbers, set containerHost = 7", "author": "madanadit", "createdAt": "2020-04-03T16:24:41Z", "path": "core/transport/src/main/proto/grpc/common.proto", "diffHunk": "@@ -116,11 +116,12 @@ message NetAddress {\n  */\n message WorkerNetAddress {\n   optional string host = 1;\n-  optional int32 rpcPort = 2;\n-  optional int32 dataPort = 3;\n-  optional int32 webPort = 4;\n-  optional string domainSocketPath = 5;\n-  optional TieredIdentity tieredIdentity = 6;\n+  optional string containerHost = 2;", "originalCommit": "ec39cd3d580fd45ed27a3dc119c289a69cd56859", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4bee6c36c1b7be94ee2850a83354367e8000358f", "url": "https://github.com/Alluxio/alluxio/commit/4bee6c36c1b7be94ee2850a83354367e8000358f", "message": "resolve comments", "committedDate": "2020-04-05T15:15:59Z", "type": "commit"}, {"oid": "d004d11de1e6c40ea40414fc2091064009140418", "url": "https://github.com/Alluxio/alluxio/commit/d004d11de1e6c40ea40414fc2091064009140418", "message": "merging and resolving conflicts", "committedDate": "2020-04-06T05:25:34Z", "type": "commit"}, {"oid": "4e0aaff1a65ff484e3d1ca544a3fa4ad722d3958", "url": "https://github.com/Alluxio/alluxio/commit/4e0aaff1a65ff484e3d1ca544a3fa4ad722d3958", "message": "update CHANGELOG", "committedDate": "2020-04-06T05:37:34Z", "type": "commit"}]}