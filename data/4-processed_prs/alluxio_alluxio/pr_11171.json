{"pr_number": 11171, "pr_title": "Support PVC for worker tiered store in K8s", "pr_createdAt": "2020-03-15T12:36:27Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11171", "timeline": [{"oid": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "url": "https://github.com/Alluxio/alluxio/commit/a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "message": "support PVC for tiered store", "committedDate": "2020-03-15T12:32:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2OTcyOA==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392669728", "bodyText": "Better indentation", "author": "jiacheliu3", "createdAt": "2020-03-15T12:36:46Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -160,17 +160,18 @@ resources:\n {{- define \"alluxio.worker.tieredstoreVolumeMounts\" -}}\n   {{- if .Values.tieredstore.levels }}\n     {{- range .Values.tieredstore.levels }}\n+      {{- /* The mediumtype can have multiple parts like MEM,SSD */}}\n       {{- if .mediumtype }}\n+        {{- /* Mount each part */}}\n         {{- if contains \",\" .mediumtype }}\n-{{- $type := .type }}\n-{{- $path := .path }}\n-{{- $split := split \",\" .mediumtype }}\n+          {{- $type := .type }}\n+          {{- $path := .path }}\n+          {{- $split := split \",\" .mediumtype }}", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2OTc2OA==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392669768", "bodyText": "This is a bug. Before only hostPath is added to Volume mounts when the mediumtype has multiple parts.", "author": "jiacheliu3", "createdAt": "2020-03-15T12:37:34Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -160,17 +160,18 @@ resources:\n {{- define \"alluxio.worker.tieredstoreVolumeMounts\" -}}\n   {{- if .Values.tieredstore.levels }}\n     {{- range .Values.tieredstore.levels }}\n+      {{- /* The mediumtype can have multiple parts like MEM,SSD */}}\n       {{- if .mediumtype }}\n+        {{- /* Mount each part */}}\n         {{- if contains \",\" .mediumtype }}\n-{{- $type := .type }}\n-{{- $path := .path }}\n-{{- $split := split \",\" .mediumtype }}\n+          {{- $type := .type }}\n+          {{- $path := .path }}\n+          {{- $split := split \",\" .mediumtype }}\n           {{- range $key, $val := $split }}\n-            {{- if eq $type \"hostPath\"}}\n-            - mountPath:  {{ index ($path | split \",\") $key }}\n-              name: {{ $val | lower }}-{{ $key | replace \"_\" \"\" }}\n-            {{- end}}\n+            - mountPath: {{ index ($path | split \",\") $key }}\n+              name: {{ $val | lower }}-{{ replace $key \"_\" \"\" }}", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2OTgxOA==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392669818", "bodyText": "Added a few examples here", "author": "jiacheliu3", "createdAt": "2020-03-15T12:38:10Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -131,6 +131,35 @@ journal:\n ## Worker ##\n \n # Tiered Storage\n+# emptyDir example\n+#  - level: 0\n+#    mediumtype: MEM\n+#    path: /dev/shm\n+#    type: emptyDir\n+#    quota: 1G\n+#\n+# hostPath example\n+#  - level: 0\n+#    mediumtype: MEM\n+#    path: /dev/shm\n+#    type: hostPath\n+#    quota: 1G\n+#\n+# persistentVolumeClaim example\n+#  - level: 1\n+#    mediumtype: SSD\n+#    type: persistentVolumeClaim\n+#    name: alluxio-ssd\n+#    path: /dev/ssd\n+#    quota: 10G\n+#\n+# multi-part mediumtype example\n+#  - level: 1\n+#    mediumtype: SSD,HDD\n+#    type: persistentVolumeClaim\n+#    name: alluxio-ssd,alluxio-hdd\n+#    path: /dev/ssd,/dev/hdd\n+#    quota: 10G,10G", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMTgzNA==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392711834", "bodyText": "@jiacheliu3 please also update the docs section \"Example: Alluxio Storage Management\"", "author": "madanadit", "createdAt": "2020-03-15T20:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2OTgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwOTg3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392709875", "bodyText": "nit: add comment with example of what mediumName resolves to", "author": "madanadit", "createdAt": "2020-03-15T20:33:03Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -191,33 +192,47 @@ resources:\n   {{- if .Values.tieredstore.levels }}\n     {{- range .Values.tieredstore.levels }}\n       {{- if .mediumtype }}\n+        {{- /* The mediumtype can have multiple parts like MEM,SSD */}}\n         {{- if contains \",\" .mediumtype }}\n           {{- $split := split \",\" .mediumtype }}\n           {{- $type := .type }}\n           {{- $path := .path }}\n+          {{- $volumeName := .name }}\n+          {{- /* A volume will be generated for each part */}}\n           {{- range $key, $val := $split }}\n+            {{- $mediumName := printf \"%v-%v\" (lower $val) (replace $key \"_\" \"\") }}", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxMDc5OA==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r393510798", "bodyText": "Good advice!", "author": "jiacheliu3", "createdAt": "2020-03-17T08:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwOTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMDQ4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392710483", "bodyText": "nit: add comment with example of what claimName resolves to", "author": "madanadit", "createdAt": "2020-03-15T20:40:07Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -191,33 +192,47 @@ resources:\n   {{- if .Values.tieredstore.levels }}\n     {{- range .Values.tieredstore.levels }}\n       {{- if .mediumtype }}\n+        {{- /* The mediumtype can have multiple parts like MEM,SSD */}}\n         {{- if contains \",\" .mediumtype }}\n           {{- $split := split \",\" .mediumtype }}\n           {{- $type := .type }}\n           {{- $path := .path }}\n+          {{- $volumeName := .name }}\n+          {{- /* A volume will be generated for each part */}}\n           {{- range $key, $val := $split }}\n+            {{- $mediumName := printf \"%v-%v\" (lower $val) (replace $key \"_\" \"\") }}\n             {{- if eq $type \"hostPath\"}}\n         - hostPath:\n             path: {{ index ($path | split \",\") $key }}\n             type: DirectoryOrCreate\n-          name: {{ $val | lower }}-{{ $key | replace \"_\" \"\" }}\n+          name: {{ $mediumName }}\n+            {{- else if eq $type \"persistentVolumeClaim\" }}\n+        - name: {{ $mediumName }}\n+          persistentVolumeClaim:\n+            claimName: {{ index ($volumeName | split \",\") $key }}", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMTkzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r392711939", "bodyText": "is mediumtype MEM possible with pv? If not please explicitly state that in the doc page and why", "author": "madanadit", "createdAt": "2020-03-15T20:57:40Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -131,6 +131,35 @@ journal:\n ## Worker ##\n \n # Tiered Storage\n+# emptyDir example\n+#  - level: 0\n+#    mediumtype: MEM\n+#    path: /dev/shm\n+#    type: emptyDir\n+#    quota: 1G\n+#\n+# hostPath example\n+#  - level: 0\n+#    mediumtype: MEM\n+#    path: /dev/shm\n+#    type: hostPath\n+#    quota: 1G\n+#\n+# persistentVolumeClaim example\n+#  - level: 1\n+#    mediumtype: SSD", "originalCommit": "a963a5d2499fb58ba89d8ff3a6d3c56c860c2036", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwNzgxNg==", "url": "https://github.com/Alluxio/alluxio/pull/11171#discussion_r393507816", "bodyText": "What this PVC's mediumtype should be really depends on what PV it binds to. So it can actually be MEM as hostPath and emptyDir. I put a level 1 SSD here just trying to illustrate it can have level > 0 like being a SSD or HDD.\nIs there a particular scenario you are thinking about? Or how do you think this can be illustrated more clearly?", "author": "jiacheliu3", "createdAt": "2020-03-17T08:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMTkzOQ=="}], "type": "inlineReview"}, {"oid": "e9542257b9d25b376599c4dcd80b963c31801051", "url": "https://github.com/Alluxio/alluxio/commit/e9542257b9d25b376599c4dcd80b963c31801051", "message": "update doc", "committedDate": "2020-03-17T09:05:40Z", "type": "commit"}, {"oid": "a08c9e64fa2fb048b6af1b28a2126d72f2b835f9", "url": "https://github.com/Alluxio/alluxio/commit/a08c9e64fa2fb048b6af1b28a2126d72f2b835f9", "message": "resolve comments", "committedDate": "2020-03-17T09:43:16Z", "type": "commit"}]}