{"pr_number": 11900, "pr_title": "Change K8s liveness/readiness probe to TCP", "pr_createdAt": "2020-08-04T12:36:53Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11900", "timeline": [{"oid": "74e56cb081c352b90d04c2a96bd994513f227a11", "url": "https://github.com/Alluxio/alluxio/commit/74e56cb081c352b90d04c2a96bd994513f227a11", "message": "change probe to tcp", "committedDate": "2020-08-04T12:34:51Z", "type": "commit"}, {"oid": "47cde0430a4ceb70dd27416ba256ed672f6bdd7d", "url": "https://github.com/Alluxio/alluxio/commit/47cde0430a4ceb70dd27416ba256ed672f6bdd7d", "message": "dedup", "committedDate": "2020-08-06T06:16:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3MTQyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11900#discussion_r466171425", "bodyText": "We cannot use RPC port as the indicator for HA (embedded journal), because only the leader's port will accept connections. All followers will refuse connection on both RPC and web port, so the probes won't work.\nIn alluxio-monitor.sh master, it uses MasterHealthCheckClient \n  \n    \n      alluxio/shell/src/main/java/alluxio/master/MasterHealthCheckClient.java\n    \n    \n         Line 205\n      in\n      164cf86\n    \n    \n    \n    \n\n        \n          \n           String cmd = String.format(\"ssh %s %s %s\", ShellUtils.COMMON_SSH_OPTS, host, \n        \n    \n  \n\n.\nThe logic there is to SSH and look for the master/job-master process on each node. If the processes are all there, check if the primary's RPC port is ready. This cannot be done easily in the probe.", "author": "jiacheliu3", "createdAt": "2020-08-06T06:22:12Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml", "diffHunk": "@@ -107,8 +107,9 @@ spec:\n           envFrom:\n           - configMapRef:\n               name: {{ $fullName }}-config\n-{{ include \"alluxio.master.readinessProbe\" . | indent 10 }}\n-{{ include \"alluxio.master.livenessProbe\" . | indent 10 }}\n+{{- $probePort := $isHaEmbedded | ternary \"embedded\" \"rpc\" }}\n+{{ include \"alluxio.master.readinessProbe\" (dict \"port\" $probePort) | indent 10 }}\n+{{ include \"alluxio.master.livenessProbe\" (dict \"port\" $probePort) | indent 10 }}", "originalCommit": "47cde0430a4ceb70dd27416ba256ed672f6bdd7d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}