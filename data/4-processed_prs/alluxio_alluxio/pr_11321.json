{"pr_number": 11321, "pr_title": "Put helm template generation into generate-tarball", "pr_createdAt": "2020-04-21T06:59:46Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11321", "timeline": [{"oid": "27577a0df14840ccfe922645804644c8357256aa", "url": "https://github.com/Alluxio/alluxio/commit/27577a0df14840ccfe922645804644c8357256aa", "message": "put helm generate into generate tarballs", "committedDate": "2020-04-21T06:44:18Z", "type": "commit"}, {"oid": "3ea30d5bb88059dcfe32cb513c5847f2b3af9617", "url": "https://github.com/Alluxio/alluxio/commit/3ea30d5bb88059dcfe32cb513c5847f2b3af9617", "message": "remove templates and generate them", "committedDate": "2020-04-21T11:48:09Z", "type": "commit"}, {"oid": "a4530b0bf8da66cc39720f60a67dc4e7899b5f0c", "url": "https://github.com/Alluxio/alluxio/commit/a4530b0bf8da66cc39720f60a67dc4e7899b5f0c", "message": "Add release tarball flag", "committedDate": "2020-04-21T12:08:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEzNTMyMw==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412135323", "bodyText": "The annoying hard-coded list is removed", "author": "jiacheliu3", "createdAt": "2020-04-21T12:21:14Z", "path": "dev/scripts/src/alluxio.org/build-distribution/cmd/generate-tarball.go", "diffHunk": "@@ -194,38 +196,6 @@ func addAdditionalFiles(srcPath, dstPath string, hadoopVersion version, version\n \t\t\"integration/docker/conf/alluxio-site.properties.template\",\n \t\t\"integration/docker/conf/alluxio-env.sh.template\",\n \t\t\"integration/fuse/bin/alluxio-fuse\",\n-\t\t\"integration/kubernetes/alluxio-fuse.yaml.template\",\n-\t\t\"integration/kubernetes/alluxio-fuse-client.yaml.template\",\n-\t\t\"integration/kubernetes/helm-generate.sh\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/.helmignore\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/Chart.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/values.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/config/alluxio-conf.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/fuse/client-daemonset.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/fuse/daemonset.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/master/service.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/worker/daemonset.yaml\",\n-\t\t\"integration/kubernetes/helm-chart/alluxio/templates/worker/domain-socket-pvc.yaml\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/alluxio-configmap.yaml.template\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/config.yaml\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/master/alluxio-master-service.yaml.template\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/master/alluxio-master-statefulset.yaml.template\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/worker/alluxio-worker-daemonset.yaml.template\",\n-\t\t\"integration/kubernetes/multiMaster-embeddedJournal/worker/alluxio-worker-pvc.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/alluxio-configmap.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/config.yaml\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/master/alluxio-master-service.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/master/alluxio-master-statefulset.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/worker/alluxio-worker-daemonset.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-hdfsJournal/worker/alluxio-worker-pvc.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/alluxio-configmap.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/config.yaml\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/master/alluxio-master-service.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/master/alluxio-master-statefulset.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/worker/alluxio-worker-daemonset.yaml.template\",\n-\t\t\"integration/kubernetes/singleMaster-localJournal/worker/alluxio-worker-pvc.yaml.template\",", "originalCommit": "3ea30d5bb88059dcfe32cb513c5847f2b3af9617", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEzNTU5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412135597", "bodyText": "We generate the template in the destination dir instead of copying them over", "author": "jiacheliu3", "createdAt": "2020-04-21T12:21:37Z", "path": "dev/scripts/src/alluxio.org/build-distribution/cmd/generate-tarball.go", "diffHunk": "@@ -347,6 +320,15 @@ func generateTarball(hadoopClients []string) error {\n \trun(\"adding Alluxio FUSE jar\", \"mv\", fmt.Sprintf(\"integration/fuse/target/alluxio-integration-fuse-%v-jar-with-dependencies.jar\", version), filepath.Join(dstPath, \"integration\", \"fuse\", fmt.Sprintf(\"alluxio-fuse-%v.jar\", version)))\n \trun(\"adding Alluxio checker jar\", \"mv\", fmt.Sprintf(\"integration/checker/target/alluxio-checker-%v-jar-with-dependencies.jar\", version), filepath.Join(dstPath, \"integration\", \"checker\", fmt.Sprintf(\"alluxio-checker-%v.jar\", version)))\n \n+\t// Generate Helm templates in the dstPath\n+\trun(\"adding Helm chart\", \"cp\", \"-r\", filepath.Join(srcPath, \"integration/kubernetes/helm-chart\"), filepath.Join(dstPath, \"integration/kubernetes/helm-chart\"))\n+\trun(\"adding YAML generator script\", \"cp\", filepath.Join(srcPath, \"integration/kubernetes/helm-generate.sh\"), filepath.Join(dstPath, \"integration/kubernetes/helm-generate.sh\"))\n+\tif !skipHelmFlag {\n+\t\tchdir(filepath.Join(dstPath, \"integration/kubernetes/\"))\n+\t\trun(\"generate Helm templates\", \"bash\", \"helm-generate.sh\", \"all\")\n+\t\tchdir(srcPath)\n+\t}\n+", "originalCommit": "3ea30d5bb88059dcfe32cb513c5847f2b3af9617", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEzNTk0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412135941", "bodyText": "In automated generation there's no config.yaml anymore. We have to provide one.", "author": "jiacheliu3", "createdAt": "2020-04-21T12:22:07Z", "path": "integration/kubernetes/helm-generate.sh", "diffHunk": "@@ -27,12 +27,26 @@ function printUsage {\n \n function generateTemplates {\n   echo \"Generating templates into $dir\"\n+  # Prepare target directories\n+  if [[ ! -d \"${dir}/master\" ]]; then\n+    mkdir -p ${dir}/master\n+  fi\n+  if [[ ! -d \"${dir}/worker\" ]]; then\n+    mkdir -p ${dir}/worker\n+  fi\n+\n   config=./$dir/config.yaml\n   if [[ ! -f \"$config\" ]]; then\n     echo \"A config file $config is needed in $dir!\"\n     echo \"See https://docs.alluxio.io/os/user/edge/en/deploy/Running-Alluxio-On-Kubernetes.html#example-hdfs-as-the-under-store\"\n     echo \"for the format of config.yaml.\"\n-    exit 1\n+\n+    touch $config\n+    echo \"Using default config\"\n+    echo \"${defaultConfig}\"\n+    cat << EOF >> $config\n+${defaultConfig}\n+EOF", "originalCommit": "3ea30d5bb88059dcfe32cb513c5847f2b3af9617", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3MTE5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412171192", "bodyText": "It might be controversial to default to true, which skips Helm templating. My argument is by skipping the helm step, we don't introduce a new dependency on helm for those who builds Alluxio tarballs using the generate-tarball script. What do you think @madanadit @Xenorith", "author": "jiacheliu3", "createdAt": "2020-04-21T13:11:37Z", "path": "dev/scripts/src/alluxio.org/build-distribution/cmd/generate-tarball.go", "diffHunk": "@@ -41,6 +42,7 @@ func Single(args []string) error {\n \tsingleCmd.StringVar(&hadoopDistributionFlag, \"hadoop-distribution\", defaultHadoopClient, \"the hadoop distribution to build this Alluxio distribution tarball\")\n \tsingleCmd.BoolVar(&skipUIFlag, \"skip-ui\", false, fmt.Sprintf(\"set this flag to skip building the webui. This will speed up the build times \"+\n \t\t\"but the generated tarball will have no Alluxio WebUI although REST services will still be available.\"))\n+\tsingleCmd.BoolVar(&skipHelmFlag, \"skip-helm\", true, fmt.Sprintf(\"set this flag to skip using Helm to generate YAML templates for K8s deployment scenarios\"))", "originalCommit": "a4530b0bf8da66cc39720f60a67dc4e7899b5f0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzMDY0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412330641", "bodyText": "skip=true sgtm", "author": "madanadit", "createdAt": "2020-04-21T17:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3MTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzMjAzMA==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412332030", "bodyText": "ultimately we publish the generated yaml's by including them in the docker image. so as part of our publish pipeline, we can set this to false.", "author": "madanadit", "createdAt": "2020-04-21T17:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3MTE5Mg=="}], "type": "inlineReview"}, {"oid": "f77dc6aeaee6645e2ca1451062f069a8e1adf18d", "url": "https://github.com/Alluxio/alluxio/commit/f77dc6aeaee6645e2ca1451062f069a8e1adf18d", "message": "doc update", "committedDate": "2020-04-21T13:16:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3NTYwNw==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412175607", "bodyText": "This is the only place I can think of, that this change affects.", "author": "jiacheliu3", "createdAt": "2020-04-21T13:17:28Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -384,6 +384,9 @@ Each Alluxio master writes journal to its own journal volume requested by `volum\n set of workers.\n The journal is in a shared UFS location. In this template we use HDFS as the UFS.\n \n+> Note: Please make sure your Alluxio tarball contains these sample templates. ", "originalCommit": "f77dc6aeaee6645e2ca1451062f069a8e1adf18d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzMzI4OA==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412333288", "bodyText": "The tarball is not the location that needs to contain the templates, it is the docker image. I would remove this not altogether as the user should not care of this as long as we test our publish pipeline.", "author": "madanadit", "createdAt": "2020-04-21T17:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3NTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA3NzkyOA==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r413077928", "bodyText": "Gotcha. This note is removed.", "author": "jiacheliu3", "createdAt": "2020-04-22T15:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3NTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2MDQyOA==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r412360428", "bodyText": "why add these 2 args to generateTarball and is skipUIFlag flag ignored now? i would remove the extra args and rely on flags alone. also, skipHelm should be true here anyways?", "author": "madanadit", "createdAt": "2020-04-21T17:42:05Z", "path": "dev/scripts/src/alluxio.org/build-distribution/cmd/generate-release-tarballs.go", "diffHunk": "@@ -56,7 +56,8 @@ func Release(args []string) error {\n \n func generateTarballs() error {\n \tfmt.Printf(\"Generating tarball %v\\n\", fmt.Sprintf(\"alluxio-%v-bin.tar.gz\", versionMarker))\n-\tif err := generateTarball(strings.Split(hadoopDistributionsFlag, \",\")); err != nil {\n+\t// Do not skip UI and Helm\n+\tif err := generateTarball(strings.Split(hadoopDistributionsFlag, \",\"), false, false); err != nil {", "originalCommit": "f77dc6aeaee6645e2ca1451062f069a8e1adf18d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAzNzQ0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11321#discussion_r413037441", "bodyText": "I thought the skipUIFlag only exists for generate-tarball single as defined here?\n\n  \n    \n      alluxio/dev/scripts/src/alluxio.org/build-distribution/cmd/generate-tarball.go\n    \n    \n         Line 42\n      in\n      5dc7382\n    \n    \n    \n    \n\n        \n          \n           singleCmd.BoolVar(&skipUIFlag, \"skip-ui\", false, fmt.Sprintf(\"set this flag to skip building the webui. This will speed up the build times \"+ \n        \n    \n  \n\n\nI changed the signature of generateTarball() passing in the flags just trying to make skipHelm=false. AFAIK skipUIFlag and skipHelm flags don't exist in generate-tarballs release. See example below:\n$ bash generate-tarballs release -skipUI=true\nflag provided but not defined: -skipUI\nUsage of release:\n  -debug\n        whether to run this tool in debug mode to generate additional console output\n  -hadoop-distributions string\n        a comma-separated list of hadoop distributions to generate Alluxio clients for (default \"default,hadoop-2.2,hadoop-2.3,hadoop-2.4,hadoop-2.5,hadoop-2.6,hadoop-2.7,hadoop-2.8,hadoop-2.9,hadoop-3.0,hadoop-3.1,hadoop-3.2\")\n  -mvn-args string\n        a comma-separated list of additional Maven arguments to build with, e.g. -mvn-args \"-Pspark,-Dhadoop.version=2.2.0\"\n  -target string\n        an optional target name for the generated tarball. The default is alluxio-${VERSION}.tar.gz. The string \"${VERSION}\" will be substituted with the built version. Note that trailing \".tar.gz\" will be stripped to determine the name for the Root directory of the generated tarball (default \"alluxio-${VERSION}-bin.tar.gz\")\n  -ufs-modules string\n        a comma-separated list of ufs modules to compile into the distribution tarball(s). Specify 'all' to build all ufs modules. Supported ufs modules: [ufs-hadoop-2.2,ufs-hadoop-2.3,ufs-hadoop-2.4,ufs-hadoop-2.5,ufs-hadoop-2.6,ufs-hadoop-2.7,ufs-hadoop-2.8,ufs-hadoop-3.0,ufs-hadoop-3.1,ufs-hadoop-3.2] (default \"ufs-hadoop-2.2,ufs-hadoop-2.7\")\nexit status 2", "author": "jiacheliu3", "createdAt": "2020-04-22T14:34:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2MDQyOA=="}], "type": "inlineReview"}, {"oid": "2425ac8bc00f67bf12b88125ccb66f7555d5aea0", "url": "https://github.com/Alluxio/alluxio/commit/2425ac8bc00f67bf12b88125ccb66f7555d5aea0", "message": "resolve doc comments", "committedDate": "2020-04-22T14:50:22Z", "type": "commit"}, {"oid": "c5587c70c757a54c57ef6faab2f993ddbdd2aac1", "url": "https://github.com/Alluxio/alluxio/commit/c5587c70c757a54c57ef6faab2f993ddbdd2aac1", "message": "whitespace", "committedDate": "2020-04-22T14:52:00Z", "type": "commit"}]}