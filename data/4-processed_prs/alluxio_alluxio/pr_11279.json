{"pr_number": 11279, "pr_title": "Make config reinit executor static", "pr_createdAt": "2020-04-12T22:15:00Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11279", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1OTk0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r407259943", "bodyText": "I suspect the first submission will hold the thread and rest will never have a chance to run.", "author": "ggezer", "createdAt": "2020-04-12T22:24:42Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContextReinitializer.java", "diffHunk": "@@ -55,9 +57,7 @@\n   public FileSystemContextReinitializer(FileSystemContext context) {\n     mContext = context;\n     mExecutor = new ConfigHashSync(context);\n-    mExecutorService = Executors.newSingleThreadExecutor(ThreadFactoryUtils.build(\n-        \"config-hash-master-heartbeat-%d\", true));\n-    mExecutorService.submit(\n+    REINIT_EXECUTOR.submit(\n         new HeartbeatThread(HeartbeatContext.META_MASTER_CONFIG_HASH_SYNC, mContext.getId(),", "originalCommit": "c2b711360fbd7e8380cb9c7b672f6844980d6da6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MjY0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r407262645", "bodyText": "that makes sense, i'll change it to a scheduled fixed rate executor service and refactor the hearbeat executor", "author": "madanadit", "createdAt": "2020-04-12T22:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1OTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMxMzkyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r407313924", "bodyText": "Can you store the Future<?> in order to cancel it during reinitializer shutdown?", "author": "ggezer", "createdAt": "2020-04-13T04:33:23Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContextReinitializer.java", "diffHunk": "@@ -55,14 +62,17 @@\n   public FileSystemContextReinitializer(FileSystemContext context) {\n     mContext = context;\n     mExecutor = new ConfigHashSync(context);\n-    mExecutorService = Executors.newSingleThreadExecutor(ThreadFactoryUtils.build(\n-        \"config-hash-master-heartbeat-%d\", true));\n-    mExecutorService.submit(\n-        new HeartbeatThread(HeartbeatContext.META_MASTER_CONFIG_HASH_SYNC, mContext.getId(),\n-            mExecutor, mContext.getClientContext().getClusterConf().getMs(\n-                PropertyKey.USER_CONF_SYNC_INTERVAL),\n-            mContext.getClientContext().getClusterConf(),\n-            mContext.getClientContext().getUserState()));\n+    REINIT_EXECUTOR.scheduleAtFixedRate(() -> {", "originalCommit": "93c173268d99be47a3795b356beb304189eb0932", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87491ec9de577a78e458bf10a5431663f4863ac7", "url": "https://github.com/Alluxio/alluxio/commit/87491ec9de577a78e458bf10a5431663f4863ac7", "message": "Make reinit executor static", "committedDate": "2020-04-24T02:51:10Z", "type": "commit"}, {"oid": "198966094e4430ecb757f9ee8bdd8e6812d064e1", "url": "https://github.com/Alluxio/alluxio/commit/198966094e4430ecb757f9ee8bdd8e6812d064e1", "message": "Do not close", "committedDate": "2020-04-24T02:51:12Z", "type": "commit"}, {"oid": "9f21c58cb858f1ae8d0ad0a47e059dc572a04f5c", "url": "https://github.com/Alluxio/alluxio/commit/9f21c58cb858f1ae8d0ad0a47e059dc572a04f5c", "message": "Remove single threaded executor", "committedDate": "2020-04-24T02:51:12Z", "type": "commit"}, {"oid": "09a1ba2b8140f6469283692bf2124aeab91276a6", "url": "https://github.com/Alluxio/alluxio/commit/09a1ba2b8140f6469283692bf2124aeab91276a6", "message": "Cancel future on close", "committedDate": "2020-04-24T02:51:12Z", "type": "commit"}, {"oid": "812323d54d5546b14b4fc7f0b93add37d40cea78", "url": "https://github.com/Alluxio/alluxio/commit/812323d54d5546b14b4fc7f0b93add37d40cea78", "message": "fix close", "committedDate": "2020-04-24T02:51:12Z", "type": "commit"}, {"oid": "ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "url": "https://github.com/Alluxio/alluxio/commit/ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "message": "Fix test", "committedDate": "2020-04-24T02:51:12Z", "type": "commit"}, {"oid": "ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "url": "https://github.com/Alluxio/alluxio/commit/ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "message": "Fix test", "committedDate": "2020-04-24T02:51:12Z", "type": "forcePushed"}, {"oid": "597b12b0f330776e6ab80fadd2e719de43a66d93", "url": "https://github.com/Alluxio/alluxio/commit/597b12b0f330776e6ab80fadd2e719de43a66d93", "message": "Fix style", "committedDate": "2020-04-24T03:10:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTcwNw==", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r415959707", "bodyText": "Can't we just set minCapacity to 0 here rathat than defining a new prop?\nI don't see a scenario where we'd set it anything else.", "author": "ggezer", "createdAt": "2020-04-27T16:24:33Z", "path": "core/client/fs/src/main/java/alluxio/client/block/stream/BlockWorkerClientPool.java", "diffHunk": "@@ -48,12 +48,14 @@\n    *\n    * @param userState the parent userState\n    * @param address address of the worker\n+   * @param minCapacity the minimum capacity of the pool\n    * @param maxCapacity the maximum capacity of the pool\n    * @param alluxioConf Alluxio configuration\n    */\n-  public BlockWorkerClientPool(UserState userState, GrpcServerAddress address, int maxCapacity,\n-      AlluxioConfiguration alluxioConf) {\n-    super(Options.defaultOptions().setMaxCapacity(maxCapacity).setGcExecutor(GC_EXECUTOR));\n+  public BlockWorkerClientPool(UserState userState, GrpcServerAddress address, int minCapacity,\n+      int maxCapacity, AlluxioConfiguration alluxioConf) {", "originalCommit": "597b12b0f330776e6ab80fadd2e719de43a66d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1NDgyNw==", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r416054827", "bodyText": "@ggezer I updated the default to zero as like you said that is the common scenario and made it hidden. just to be consistent with other client thread pools, i didn't remove the property", "author": "madanadit", "createdAt": "2020-04-27T18:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTcwNw=="}], "type": "inlineReview"}, {"oid": "1d80d204b21c42075a3759cfd54e3d05e6a5e2f1", "url": "https://github.com/Alluxio/alluxio/commit/1d80d204b21c42075a3759cfd54e3d05e6a5e2f1", "message": "Update default", "committedDate": "2020-04-27T18:33:12Z", "type": "commit"}, {"oid": "818ddd7628b0a4030a05ce5a08ad82392bb5089c", "url": "https://github.com/Alluxio/alluxio/commit/818ddd7628b0a4030a05ce5a08ad82392bb5089c", "message": "Make hidden", "committedDate": "2020-04-27T18:34:14Z", "type": "commit"}, {"oid": "6e2d0d22991dd548501a93c808de8896f6fc2340", "url": "https://github.com/Alluxio/alluxio/commit/6e2d0d22991dd548501a93c808de8896f6fc2340", "message": "fix", "committedDate": "2020-04-27T18:40:01Z", "type": "commit"}]}