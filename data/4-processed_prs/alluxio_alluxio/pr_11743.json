{"pr_number": 11743, "pr_title": "Add tests for GreedyAllocator", "pr_createdAt": "2020-07-10T01:10:30Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11743", "timeline": [{"oid": "031aca90ca5bb6a5efe9809b5d3479bbb39046b6", "url": "https://github.com/Alluxio/alluxio/commit/031aca90ca5bb6a5efe9809b5d3479bbb39046b6", "message": "Fix issue with GreedyAllocator", "committedDate": "2020-07-10T01:33:18Z", "type": "forcePushed"}, {"oid": "ca405b5816b4bd444c71a8a96a790a619484cf64", "url": "https://github.com/Alluxio/alluxio/commit/ca405b5816b4bd444c71a8a96a790a619484cf64", "message": "Fix issue with GreedyAllocator", "committedDate": "2020-07-10T06:14:21Z", "type": "commit"}, {"oid": "ca405b5816b4bd444c71a8a96a790a619484cf64", "url": "https://github.com/Alluxio/alluxio/commit/ca405b5816b4bd444c71a8a96a790a619484cf64", "message": "Fix issue with GreedyAllocator", "committedDate": "2020-07-10T06:14:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2Njg5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r452966891", "bodyText": "Can't we use the Config annotation to update configuration for a particular test? Like: https://github.com/Alluxio/alluxio/blob/master/tests/src/test/java/alluxio/client/cli/fs/command/PersistCommandTest.java#L362\nThen we don't have to stop and start the cluster, which is not cheap.", "author": "gpang", "createdAt": "2020-07-10T17:06:57Z", "path": "tests/src/test/java/alluxio/server/tieredstore/TieredStoreIntegrationTest.java", "diffHunk": "@@ -236,4 +242,38 @@ public void promoteBlock() throws Exception {\n       }\n     }, WAIT_OPTIONS);\n   }\n+\n+  /**\n+   * With setting of \"StorageDir1, StorageDir2\", loading a block from UFS that is bigger than\n+   * the available space of StorageDir1 should land in StorageDir2 using GreedyAllocator.\n+   * https://github.com/Alluxio/alluxio/issues/8687\n+   */\n+  @Test\n+  public void greedyAllocator() throws Exception {\n+    mLocalAlluxioClusterResource.stop();\n+    int fileLen = 8 * Constants.MB;\n+    mLocalAlluxioClusterResource", "originalCommit": "ca405b5816b4bd444c71a8a96a790a619484cf64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NTA1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r452985059", "bodyText": "that's where I started with config annotation. Then I realized it requires compile-time String constant in annotation, in here a lot values I'm setting are derived (e.g.,  tmp dirs and even the tiered property keys are derived from template)", "author": "apc999", "createdAt": "2020-07-10T17:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2Njg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r452967459", "bodyText": "Are there any implications to this change?", "author": "gpang", "createdAt": "2020-07-10T17:08:06Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/UnderFileSystemBlockReader.java", "diffHunk": "@@ -119,7 +117,7 @@ public static UnderFileSystemBlockReader create(UnderFileSystemBlockMeta blockMe\n   private UnderFileSystemBlockReader(UnderFileSystemBlockMeta blockMeta, boolean positionShort,\n       BlockStore localBlockStore, UfsManager ufsManager, UfsInputStreamManager ufsInstreamManager)\n       throws IOException {\n-    mInitialBlockSize = ServerConfiguration.getBytes(PropertyKey.WORKER_FILE_BUFFER_SIZE);\n+    mInitialBlockSize = blockMeta.getBlockSize();", "originalCommit": "ca405b5816b4bd444c71a8a96a790a619484cf64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NTU0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r452985543", "bodyText": "I don't think there is any downside here. @calvinjia  ?", "author": "apc999", "createdAt": "2020-07-10T17:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExOTgyMA==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r453119820", "bodyText": "Doesn'tread() method should never call requestSpace() after this change here?\nOtherwise, each read call would allocate more space on top of the initial full block size. However, requested spaces wouldn't leak because the block-store would be updated with the physical file size as part of the commit.", "author": "ggezer", "createdAt": "2020-07-10T23:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMTk3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r453121979", "bodyText": "@ggezer  you are correct. requestspace() should not be called any more to load this block from UFS.", "author": "apc999", "createdAt": "2020-07-10T23:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1OTA3NA==", "url": "https://github.com/Alluxio/alluxio/pull/11743#discussion_r453259074", "bodyText": "This condition in read looks broken, hence always calling requestSpace.\n...\nif (mBlockWriter != null && mBlockWriter.getPosition() < mInStreamPos) {\n           mLocalBlockStore.requestSpace(mBlockMeta.getSessionId(), mBlockMeta.getBlockId(),\n                   mInStreamPos - mBlockWriter.getPosition());\n           ...\n}", "author": "ggezer", "createdAt": "2020-07-12T02:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ1OQ=="}], "type": "inlineReview"}, {"oid": "561ca8076e0a4b1735a2fa502ca54857dc992ab2", "url": "https://github.com/Alluxio/alluxio/commit/561ca8076e0a4b1735a2fa502ca54857dc992ab2", "message": "Merge branch 'master' of github.com:Alluxio/alluxio into smallfix", "committedDate": "2020-11-20T20:05:53Z", "type": "commit"}]}