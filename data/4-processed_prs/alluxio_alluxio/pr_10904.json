{"pr_number": 10904, "pr_title": "Fix the MultiValueMetricsAggregator and reduce overhead", "pr_createdAt": "2020-02-13T19:13:31Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10904", "timeline": [{"oid": "3374d0e50f8fc6a542885eb3457fa233739dbca4", "url": "https://github.com/Alluxio/alluxio/commit/3374d0e50f8fc6a542885eb3457fa233739dbca4", "message": "Reconstruct the MultiValueMetricsAggregator to reduce overhead", "committedDate": "2020-02-13T19:07:44Z", "type": "commit"}, {"oid": "ad322c1ff7e677671fb26a48ca2476a5cbc5c7d3", "url": "https://github.com/Alluxio/alluxio/commit/ad322c1ff7e677671fb26a48ca2476a5cbc5c7d3", "message": "Tmp", "committedDate": "2020-02-13T19:28:08Z", "type": "commit"}, {"oid": "7c2aebcf329e79e061d840bc27e9245f673e0f79", "url": "https://github.com/Alluxio/alluxio/commit/7c2aebcf329e79e061d840bc27e9245f673e0f79", "message": "Add throughput gauge test in MetricsMasterTest", "committedDate": "2020-02-13T21:01:59Z", "type": "commit"}, {"oid": "8ff1c630e8a47de7a81bf883079acfa71946b73d", "url": "https://github.com/Alluxio/alluxio/commit/8ff1c630e8a47de7a81bf883079acfa71946b73d", "message": "Before solving conflicts", "committedDate": "2020-02-13T22:27:38Z", "type": "commit"}, {"oid": "d714855aa07264bc838153cbfb131f57817f583c", "url": "https://github.com/Alluxio/alluxio/commit/d714855aa07264bc838153cbfb131f57817f583c", "message": "Solve conflicts", "committedDate": "2020-02-13T22:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5NTk1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379195957", "bodyText": "Would it be easier to just use startsWith as a string instead of using regex?", "author": "ZacBlanco", "createdAt": "2020-02-14T00:35:38Z", "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -621,19 +625,25 @@ public static Timer timer(String name) {\n   }\n \n   /**\n-   * Gets master metric with the given metric name.\n+   * Gets all the master metrics belongs to the given metric names.\n    *\n-   * @param name the name of the metric to get\n-   * @return a metric set with the master metric of the given metric name\n+   * @param metricNames the name of the metrics to get\n+   * @return a metric map from metric name to metrics with this name\n    */\n-  public static Set<Metric> getMasterMetric(String name) {\n-    Set<Metric> set = new HashSet<>();\n-    String fullName = getMasterMetricName(name);\n-    Metric alluxioMetric = getMetricValue(fullName);\n-    if (alluxioMetric != null) {\n-      set.add(alluxioMetric);\n+  public static Map<String, Set<Metric>> getMasterMetrics(Set<String> metricNames) {\n+    Map<String, Set<Metric>> res = new HashMap<>();\n+    for (Map.Entry<String, com.codahale.metrics.Metric> entry\n+        : METRIC_REGISTRY.getMetrics().entrySet()) {\n+      Matcher matcher = METRIC_NAME_PATTERN.matcher(entry.getKey());", "originalCommit": "d714855aa07264bc838153cbfb131f57817f583c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzY4OA==", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379227688", "bodyText": "This patten helps reduce the traverse of the given name set, the complexity is O(n), n = metrics number in the whole metrics system.\nIf using startsWtih, the complexity is O(n*m), m = number of elements in the given metrics name set.\nThat's why I changed from startsWith to pattern matching.", "author": "LuQQiu", "createdAt": "2020-02-14T02:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5NTk1Nw=="}], "type": "inlineReview"}, {"oid": "62665ca1d6bf0d9288d62bde72f0fd53cc58c182", "url": "https://github.com/Alluxio/alluxio/commit/62665ca1d6bf0d9288d62bde72f0fd53cc58c182", "message": "Before solving conflicts", "committedDate": "2020-02-14T02:52:50Z", "type": "commit"}, {"oid": "5960932fb4404f2bd99adb8a14e91f6c4c1b04ea", "url": "https://github.com/Alluxio/alluxio/commit/5960932fb4404f2bd99adb8a14e91f6c4c1b04ea", "message": "Solve conflicts", "committedDate": "2020-02-14T02:54:23Z", "type": "commit"}, {"oid": "452b220ed15f4d03d62b4c3376676e332d9f4427", "url": "https://github.com/Alluxio/alluxio/commit/452b220ed15f4d03d62b4c3376676e332d9f4427", "message": "Change clear time to atomicLong", "committedDate": "2020-02-14T18:09:01Z", "type": "commit"}, {"oid": "c1dbd330ce23176cc1fd674e3e0ed52ddc21f2bf", "url": "https://github.com/Alluxio/alluxio/commit/c1dbd330ce23176cc1fd674e3e0ed52ddc21f2bf", "message": "Fix MetricsStoreTest.clearAndGetClearTime() test", "committedDate": "2020-02-14T18:43:21Z", "type": "commit"}, {"oid": "cd9009b4efdcbc8a704fb34366365fd537bad895", "url": "https://github.com/Alluxio/alluxio/commit/cd9009b4efdcbc8a704fb34366365fd537bad895", "message": "fix checkstyle", "committedDate": "2020-02-14T18:55:58Z", "type": "commit"}, {"oid": "a856d512093badd15b467696ad005d02bd7f8582", "url": "https://github.com/Alluxio/alluxio/commit/a856d512093badd15b467696ad005d02bd7f8582", "message": "Fix aggregator bug and add corresponding tests", "committedDate": "2020-02-14T20:05:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjEzMw==", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379636133", "bodyText": "nit: This seems like an odd line break. Does it not fit on one line?", "author": "ZacBlanco", "createdAt": "2020-02-14T20:44:32Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -53,8 +51,10 @@\n  */\n public class DefaultMetricsMaster extends CoreMaster implements MetricsMaster, NoopJournaled {\n   private static final Logger LOG = LoggerFactory.getLogger(DefaultMetricsMaster.class);\n-  private final Set<MultiValueMetricsAggregator> mMultiValueMetricsAggregatorRegistry =\n-      new HashSet<>();\n+  // A map from the to be aggregated metric name to aggregator itself\n+  // This registry only holds aggregator for master metrics\n+  private final Map<String, MultiValueMetricsAggregator>\n+      mAggregatorRegistry = new HashMap<>();", "originalCommit": "a856d512093badd15b467696ad005d02bd7f8582", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1NjQzNw==", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379656437", "bodyText": "Fixed, thanks", "author": "LuQQiu", "createdAt": "2020-02-14T21:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjEzMw=="}], "type": "inlineReview"}, {"oid": "399501a99eb45dff3cd6306ae00ef305e6047436", "url": "https://github.com/Alluxio/alluxio/commit/399501a99eb45dff3cd6306ae00ef305e6047436", "message": "small comments", "committedDate": "2020-02-14T21:34:31Z", "type": "commit"}]}