{"pr_number": 11077, "pr_title": "[DOCFIX] Update kubernetes documentation", "pr_createdAt": "2020-03-01T11:29:52Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11077", "timeline": [{"oid": "b54a329783d40558bd50cac982243348b78a84c8", "url": "https://github.com/Alluxio/alluxio/commit/b54a329783d40558bd50cac982243348b78a84c8", "message": "update doc on FUSE and Job deployment", "committedDate": "2020-03-01T10:40:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEwMDA2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386100064", "bodyText": "There are some duplicated sentences in kubectl section I wasn't able to avoid.", "author": "jiacheliu3", "createdAt": "2020-03-01T11:31:38Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -310,6 +312,25 @@ Uninstall Alluxio as follows:\n $ helm delete alluxio\n ```\n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.\n+Each Job runs `alluxio formatJournal` and formats the journal for that master.", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEwMDA5NA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386100094", "bodyText": "#format-journal-1 as #format-journal belongs to helm section", "author": "jiacheliu3", "createdAt": "2020-03-01T11:32:09Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -502,18 +541,8 @@ Make sure all the Pods have been terminated before you move on to the next step.\n Check the Alluxio upgrade guide page for whether the Alluxio master journal has to be formatted.\n If no format is needed, you are ready to skip the rest of this section and move on to restart all Alluxio master and worker Pods.\n \n-There is a single Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n-template that can be used for only formatting the master.\n-The Job runs `alluxio formatMasters` and formats the journal for all masters.\n-You should make sure the Job runs with the same configMap with all your other Alluxio masters so it's able to find the journal persistent storage and format it.\n-\n-```console\n-$ cp ./job/alluxio-format-journal-job.yaml.template ./job/alluxio-format-journal-job.yaml\n-$ kubectl apply -f ./job/alluxio-format-journal-job.yaml\n-```\n-\n-After the Job completes, it will be deleted by Kubernetes after the defined `ttlSecondsAfterFinished`.\n-Then the clean journal will be ready for a new Alluxio master(s) to start with.\n+You can follow [formatting journal with kubectl]({{ '/en/deploy/Running-Alluxio-On-Kubernetes.html#format-journal-1' | relativize_url }})", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEwMDEyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386100124", "bodyText": "Is it acceptable to use kubectl in helm section?", "author": "jiacheliu3", "createdAt": "2020-03-01T11:32:37Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -310,6 +312,25 @@ Uninstall Alluxio as follows:\n $ helm delete alluxio\n ```\n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.\n+Each Job runs `alluxio formatJournal` and formats the journal for that master.\n+\n+You can manually trigger the journal formatting by applying the Job template.\n+```console\n+# Generate the YAML definition for the journal formatting Job(s)\n+$ helm template --name alluxio helm-chart/alluxio/ --set journal.format.runFormat=true -x templates/job/format-journal-job.yaml -f ./config.yaml > alluxio-format-journal-job.yaml\n+# Create the Jobs(s) with kubectl\n+$ kubectl create -f alluxio-format-journal-job.yaml", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0ODE2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386648169", "bodyText": "this will not be needed if we suggest helm install", "author": "madanadit", "createdAt": "2020-03-02T21:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEwMDEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwNjQ1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386606453", "bodyText": "nit: newline after every sentence (a period .) is the doc convention. So start a newline with \"You can install\"", "author": "madanadit", "createdAt": "2020-03-02T19:36:51Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -92,6 +92,8 @@ There are other ways to create Persistent Volumes as documented [here](https://k\n \n #### Prerequisites\n \n+You should have helm 2.X installed. You can install helm following instructions [here](https://v2.helm.sh/docs/using_helm/#install-helm).", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwNjU4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386606583", "bodyText": "same for the rest of the doc changes", "author": "madanadit", "createdAt": "2020-03-02T19:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwNjQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386609044", "bodyText": "we should not recommend running helm template as the directory helm-chart/alluxio will not be available locally once we publish the chart to a gcs bucket", "author": "madanadit", "createdAt": "2020-03-02T19:42:09Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -310,6 +312,25 @@ Uninstall Alluxio as follows:\n $ helm delete alluxio\n ```\n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.\n+Each Job runs `alluxio formatJournal` and formats the journal for that master.\n+\n+You can manually trigger the journal formatting by applying the Job template.\n+```console\n+# Generate the YAML definition for the journal formatting Job(s)\n+$ helm template --name alluxio helm-chart/alluxio/ --set journal.format.runFormat=true -x templates/job/format-journal-job.yaml -f ./config.yaml > alluxio-format-journal-job.yaml", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0ODAzNg==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386648036", "bodyText": "instead i would suggest helm install with the option journal.format.runFormat=true for formatting explicitly before starting the masters.", "author": "madanadit", "createdAt": "2020-03-02T21:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc4MDg2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386780864", "bodyText": "My concern is the Job contending with master on the journal PV if the PV accessMode is ReadWriteOnce. Running the Job separately when the masters are not started will always work.\nAlso I've seen situations where the masters are running, the Jobs kick in and attempt to format. The result was one journal was not formatted even though the Job (alluxio.cli.Format) completed successfully.", "author": "jiacheliu3", "createdAt": "2020-03-03T03:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc4MjU5NA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386782594", "bodyText": "To ensure EITHER the jobs OR the masters are running, I would go with using the .Values.journal.format.runFormat to decide whether the master-statefulset.yaml should be empty. And use helm upgrade to do the switch. What do you think?", "author": "jiacheliu3", "createdAt": "2020-03-03T03:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5MjgyMA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386792820", "bodyText": "looks like there is an order of deployment: https://github.com/helm/helm/blob/484d43913f97292648c867b56768775a55e4bba6/pkg/releaseutil/kind_sorter.go#L27 but it is the reverse of what we want, statefulset is first and then job\nso in this case i'm good with your suggestion to switch, but i would like to only run the format job and nothing else (not even worker install). a simple if over master-statefulset seems hard to maintain. might want to see if helm allows to specify resource dependencies before we go ahead with the switch approach.", "author": "madanadit", "createdAt": "2020-03-03T04:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc5Mzg1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386793852", "bodyText": "@jiacheliu3 how about format as an init container instead?", "author": "madanadit", "createdAt": "2020-03-03T04:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAzNzAxMg==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r387037012", "bodyText": "@madanadit I think format as init container is a better idea overall.\nIn that case i will only include 2.2-related doc in this change and add blocks regarding the iniContainer approach later, after format has been made init container.", "author": "jiacheliu3", "createdAt": "2020-03-03T14:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk5NjExMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388996111", "bodyText": "@madanadit\nI found myself wrong with ReadWriteOnly. This Only means only one NODE.\nhttps://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes\nTherefore the Job can be created and completed even if the master is there. What this means is, although formatting the journal when the master is active is not the best idea, it can work.", "author": "jiacheliu3", "createdAt": "2020-03-06T16:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEwODQwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r389108406", "bodyText": "I'm okay with this for now, but you could file an issues to track replacement of the format job with init container (if not there already)", "author": "madanadit", "createdAt": "2020-03-06T19:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjQ5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r389212499", "bodyText": "#11141 created to address this.", "author": "jiacheliu3", "createdAt": "2020-03-07T01:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0ODgyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386648824", "bodyText": "can we suggest helm upgrade? i want to eliminate helm template because of the same reason as for the format job", "author": "madanadit", "createdAt": "2020-03-02T21:04:17Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -604,6 +633,26 @@ $ kubectl create -f alluxio-fuse-client.yaml\n If using the template, Alluxio is mounted at `/alluxio-fuse` and can be accessed via the POSIX-API\n across multiple containers.\n \n+***Using `helm`***\n+You can deploy the FUSE daemon by configuring the following properties:\n+```properties\n+fuse:\n+  enabled: true\n+  clientEnabled: true\n+```\n+\n+Then follow the steps to install Alluxio with helm [here]({{ '/en/deploy/Running-Alluxio-On-Kubernetes.html#deploy-using-helm' | relativize_url }}).\n+\n+If Alluxio has already been deployed with helm and now you want to enable FUSE, you can manually add the FUSE daemons.\n+```console\n+# Generate YAML resources with helm template\n+$ helm template --name alluxio helm-chart/alluxio/ --set fuse.enabled=true -x templates/fuse/daemonset.yaml -f ./config.yaml > \"alluxio-fuse.yaml\"", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5NTQ0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388095449", "bodyText": "Updated to using helm upgrade", "author": "jiacheliu3", "createdAt": "2020-03-05T06:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0ODgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0OTMyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r386649329", "bodyText": "split the kubectl  commands into a separate block as only one of the kubectl or helm command is needed", "author": "madanadit", "createdAt": "2020-03-02T21:05:28Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -604,6 +633,26 @@ $ kubectl create -f alluxio-fuse-client.yaml\n If using the template, Alluxio is mounted at `/alluxio-fuse` and can be accessed via the POSIX-API\n across multiple containers.\n \n+***Using `helm`***\n+You can deploy the FUSE daemon by configuring the following properties:\n+```properties\n+fuse:\n+  enabled: true\n+  clientEnabled: true\n+```\n+\n+Then follow the steps to install Alluxio with helm [here]({{ '/en/deploy/Running-Alluxio-On-Kubernetes.html#deploy-using-helm' | relativize_url }}).\n+\n+If Alluxio has already been deployed with helm and now you want to enable FUSE, you can manually add the FUSE daemons.\n+```console\n+# Generate YAML resources with helm template\n+$ helm template --name alluxio helm-chart/alluxio/ --set fuse.enabled=true -x templates/fuse/daemonset.yaml -f ./config.yaml > \"alluxio-fuse.yaml\"\n+$ helm template --name alluxio helm-chart/alluxio/ --set fuse.clientEnabled=true -x templates/fuse/client-daemonset.yaml -f ./config.yaml > \"alluxio-fuse-client.yaml\"\n+# Manually apply the YAML files using kubectl\n+$ kubectl create -f alluxio-fuse.yaml", "originalCommit": "b54a329783d40558bd50cac982243348b78a84c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5NjMwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388096305", "bodyText": "This is replaced by one helm upgrade command", "author": "jiacheliu3", "createdAt": "2020-03-05T06:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0OTMyOQ=="}], "type": "inlineReview"}, {"oid": "02d364485f0b59c39d65a56545cb71fe75292e10", "url": "https://github.com/Alluxio/alluxio/commit/02d364485f0b59c39d65a56545cb71fe75292e10", "message": "helm upgrade", "committedDate": "2020-03-05T06:16:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NTQyOA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388555428", "bodyText": "have you tested this? i think helm would run Job after StatefulSet which is not desirable", "author": "madanadit", "createdAt": "2020-03-05T20:46:24Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -310,6 +312,20 @@ Uninstall Alluxio as follows:\n $ helm delete alluxio\n ```\n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.\n+Each Job runs `alluxio formatJournal` and formats the journal for that master.\n+\n+You can trigger the journal formatting by upgrading the helm deployment with `journal.format.runFormat=true`.\n+```console\n+# Use the same config.yaml and switch on journal formatting\n+$ helm upgrade alluxio --version 0.5.5 -f config.yaml --set journal.format.runFormat=true alluxio-local/alluxio\n+```\n+\n+> Note: `helm upgrade` is another deployment, which will result in new master and worker pods.", "originalCommit": "02d364485f0b59c39d65a56545cb71fe75292e10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NTgzNA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388555834", "bodyText": "why is  --version 0.5.5 needed? i plan on removing the helm version tag from documentation", "author": "madanadit", "createdAt": "2020-03-05T20:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NTQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NzczNA==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388967734", "bodyText": "The version is removed.", "author": "jiacheliu3", "createdAt": "2020-03-06T15:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NTQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NzQ0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388557445", "bodyText": "newline after .", "author": "madanadit", "createdAt": "2020-03-05T20:50:14Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -310,6 +312,20 @@ Uninstall Alluxio as follows:\n $ helm delete alluxio\n ```\n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.", "originalCommit": "02d364485f0b59c39d65a56545cb71fe75292e10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NzU1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11077#discussion_r388557557", "bodyText": "newline", "author": "madanadit", "createdAt": "2020-03-05T20:50:28Z", "path": "docs/en/deploy/Running-Alluxio-On-Kubernetes.md", "diffHunk": "@@ -455,6 +471,24 @@ $ kubectl delete configmap alluxio-config\n > Note: This will delete all resources under `./master/` and `./worker/`. \n Be careful if you have persistent volumes or other important resources you want to keep under those directories.  \n \n+#### Format Journal\n+\n+The helm chart contains one Kubernetes [Job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)\n+template that can be used for formatting the Alluxio journal. The template contains one Job for each Alluxio master.", "originalCommit": "02d364485f0b59c39d65a56545cb71fe75292e10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1db8d425c93ad9092fa587aef7e78776d07ed41", "url": "https://github.com/Alluxio/alluxio/commit/b1db8d425c93ad9092fa587aef7e78776d07ed41", "message": "resolve commends and add helm installation switch", "committedDate": "2020-03-06T16:32:20Z", "type": "commit"}]}