{"pr_number": 12658, "pr_title": "Change to journal large table partitions separately", "pr_createdAt": "2020-12-17T01:40:30Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12658", "timeline": [{"oid": "fc19774c78908b5f49c5eb83d21779d80fd3b596", "url": "https://github.com/Alluxio/alluxio/commit/fc19774c78908b5f49c5eb83d21779d80fd3b596", "message": "Change to journal large table partitions separately", "committedDate": "2020-12-17T01:35:34Z", "type": "commit"}, {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b", "url": "https://github.com/Alluxio/alluxio/commit/02216917292bb32fa22e419fa41eb2cd53fce96b", "message": "Fix checkstyle", "committedDate": "2020-12-17T04:47:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMDIyMA==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545410220", "bodyText": "I think AlluxioCatalog also needs this: https://github.com/Alluxio/alluxio/blob/master/table/server/master/src/main/java/alluxio/master/table/AlluxioCatalog.java#L390", "author": "gpang", "createdAt": "2020-12-17T21:19:11Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -349,6 +355,9 @@ private boolean processJournalEntryInternal(Journal.JournalEntry entry,\n     if (entry.hasAddTable()) {\n       return applyAddTable(context, entry);\n     }\n+    if (entry.hasAddTablePartitions()) {", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDA2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544067", "bodyText": "Added, thanks!", "author": "LuQQiu", "createdAt": "2020-12-18T03:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMDIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMjc1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545422756", "bodyText": "Instead of 1 table iterator and partition list, should we just have a table iterator, and partition iterator? Everything the partition iterator is empty() we just move on to the next table and get the next partition iterator?\nIt seems like mixing an iterator and a list is a bit confusing to follow.", "author": "gpang", "createdAt": "2020-12-17T21:44:04Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -467,14 +508,55 @@ public boolean hasNext() {\n         }\n         Table table = mEntry;\n         mEntry = null;\n-        alluxio.proto.journal.Table.AddTableEntry addTableEntry = table.toJournalProto();\n+        alluxio.proto.journal.Table.AddTableEntry addTableEntry = table.getTableJournalProto();\n         return Journal.JournalEntry.newBuilder().setAddTable(addTableEntry).build();\n       }\n \n       @Override\n       public void remove() {\n         throw new UnsupportedOperationException(\n-            \"GetTableIteratorr#Iterator#remove is not supported.\");\n+            \"GetTableIterator#Iterator#remove is not supported.\");\n+      }\n+    };\n+  }\n+\n+  private Iterator<Journal.JournalEntry> getTablePartitionsIterator() {\n+    final Iterator<Table> it = getTables().iterator();\n+    return new Iterator<Journal.JournalEntry>() {\n+      private List<alluxio.proto.journal.Table.AddTablePartitionsEntry> mPartitionsEntries", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDI1MA==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544250", "bodyText": "I changed to add partitionIterator directly in the existing getTableIterator to be cleaner and safer. PTAL", "author": "LuQQiu", "createdAt": "2020-12-18T03:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMjc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzA1OA==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423058", "bodyText": "Is it perfectly fine output all the tables and then all the individual partition batches?", "author": "gpang", "createdAt": "2020-12-17T21:44:41Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -484,7 +566,8 @@ public void remove() {\n     Journal.JournalEntry entry = Journal.JournalEntry.newBuilder().setUpdateDatabaseInfo(\n         toJournalProto(getDatabaseInfo(), mName)).build();\n     return CloseableIterator.noopCloseable(\n-        Iterators.concat(Iterators.singletonIterator(entry), getTableIterator()));\n+        Iterators.concat(Iterators.singletonIterator(entry),\n+            getTableIterator(), getTablePartitionsIterator()));", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDQwMg==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544402", "bodyText": "The table iterator change to include partition iterators so they are now placed together. This way seems to be safer", "author": "LuQQiu", "createdAt": "2020-12-18T03:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzQxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423411", "bodyText": "What does this comment mean? What is being removed?", "author": "gpang", "createdAt": "2020-12-17T21:45:20Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDQ0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544442", "bodyText": "Removed, thanks", "author": "LuQQiu", "createdAt": "2020-12-18T03:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzY1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423653", "bodyText": "can we also add the # partitions we are adding in the message?", "author": "gpang", "createdAt": "2020-12-17T21:45:49Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version\n+          LOG.info(\"Adding partitions to table {}.{}\", mName, addTablePartitions.getTableName());", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDQ3OA==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544478", "bodyText": "Added, thanks", "author": "LuQQiu", "createdAt": "2020-12-18T03:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzgxNw==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423817", "bodyText": "We are not deleting right?", "author": "gpang", "createdAt": "2020-12-17T21:46:07Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version\n+          LOG.info(\"Adding partitions to table {}.{}\", mName, addTablePartitions.getTableName());\n+          if (context != null) {\n+            context.append(entry);\n+          }\n+          existingTable.addPartitions(addTablePartitions);\n+          return existingTable;\n+        }\n+        LOG.info(\"Will not add partitions to table {}.{}, because of mismatched versions. \"\n+                + \"version-to-delete: {} existing-version: {}\",", "originalCommit": "02216917292bb32fa22e419fa41eb2cd53fce96b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0NDUzMA==", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545544530", "bodyText": "Changed, thanks", "author": "LuQQiu", "createdAt": "2020-12-18T03:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzgxNw=="}], "type": "inlineReview"}, {"oid": "92ad33484414f7a70d29023e2451725c6bd1ce62", "url": "https://github.com/Alluxio/alluxio/commit/92ad33484414f7a70d29023e2451725c6bd1ce62", "message": "Address comments", "committedDate": "2020-12-18T03:05:00Z", "type": "commit"}, {"oid": "aa29d883f45b2f442b2a42dfbef59fbcbf97b56d", "url": "https://github.com/Alluxio/alluxio/commit/aa29d883f45b2f442b2a42dfbef59fbcbf97b56d", "message": "Fix findbugs", "committedDate": "2020-12-18T19:06:41Z", "type": "commit"}, {"oid": "0fad7ad18091be9449667ae7f916199f0edfac49", "url": "https://github.com/Alluxio/alluxio/commit/0fad7ad18091be9449667ae7f916199f0edfac49", "message": "Merge branch 'master' of github.com:Alluxio/alluxio into partitionJournal", "committedDate": "2020-12-18T22:26:12Z", "type": "commit"}, {"oid": "56b4475700c75096ce2d310bcca502ee0c240281", "url": "https://github.com/Alluxio/alluxio/commit/56b4475700c75096ce2d310bcca502ee0c240281", "message": "Fix add table partitions bug", "committedDate": "2020-12-18T23:36:55Z", "type": "commit"}, {"oid": "a327fc911ceff7d55ecfcdd428a64149011edfc0", "url": "https://github.com/Alluxio/alluxio/commit/a327fc911ceff7d55ecfcdd428a64149011edfc0", "message": "Modify TableMasterJournal test to include partition chunk size", "committedDate": "2021-01-04T21:08:01Z", "type": "commit"}]}