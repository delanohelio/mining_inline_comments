{"pr_number": 11962, "pr_title": "Create a compatibility layer to handle older hive metastores", "pr_createdAt": "2020-08-11T03:16:42Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11962", "timeline": [{"oid": "6f8e8dc401eb8e972825a6fa92f666eedced8219", "url": "https://github.com/Alluxio/alluxio/commit/6f8e8dc401eb8e972825a6fa92f666eedced8219", "message": "bump the version", "committedDate": "2020-08-10T23:59:17Z", "type": "commit"}, {"oid": "7e4d2343601bb966c0c175063b1a8fd27b939086", "url": "https://github.com/Alluxio/alluxio/commit/7e4d2343601bb966c0c175063b1a8fd27b939086", "message": "Implement a compatibility layer for Hive Metastore CLient", "committedDate": "2020-08-11T03:06:34Z", "type": "commit"}, {"oid": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "url": "https://github.com/Alluxio/alluxio/commit/5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "message": "add header", "committedDate": "2020-08-11T05:13:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxNDc0MA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468714740", "bodyText": "could you specify which versions need the layer? was it < 2.2?", "author": "gpang", "createdAt": "2020-08-11T16:36:09Z", "path": "table/server/underdb/hive/pom.xml", "diffHunk": "@@ -26,8 +26,8 @@\n     <!-- The following paths need to be defined here as well as in the parent pom so that mvn can -->\n     <!-- run properly from sub-project directories -->\n     <build.path>${project.parent.parent.parent.parent.basedir}/build</build.path>\n-    <!-- 2.2.0 client works with a wide range of HMS, from 1.0 to 3.1 -->\n-    <hive-metastore.version>2.2.0</hive-metastore.version>\n+    <!-- 2.3.7 client needs a compatibility layer to work with lower versions -->", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwMzkzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468903931", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-11T22:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxNDc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMjYzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468722639", "bodyText": "Should this be private?\nAlso, the second field should be @Nullable I think?", "author": "gpang", "createdAt": "2020-08-11T16:49:09Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSClientFactory.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.Proxy;\n+\n+class HMSClientFactory {\n+  private static final Logger LOG = LoggerFactory.getLogger(HMSClientFactory.class);\n+\n+  static IMetaStoreClient newInstance(IMetaStoreClient delegate) {\n+    HMSShim compatibility = null;\n+    try {\n+      compatibility = new HMSShim(delegate);\n+    } catch (Throwable t) {\n+      LOG.warn(\"Unable to initialize hive metastore compatibility client\", t);\n+    }\n+    return newInstance(delegate, compatibility);\n+  }\n+\n+  static IMetaStoreClient newInstance(IMetaStoreClient delegate, HMSShim compatibility) {", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwMzk1MA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468903950", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-11T22:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMjYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNDY4MA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468724680", "bodyText": "If the shim was not created, compatibility will be null. Is that ok?", "author": "gpang", "createdAt": "2020-08-11T16:52:22Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSClientFactory.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.Proxy;\n+\n+class HMSClientFactory {\n+  private static final Logger LOG = LoggerFactory.getLogger(HMSClientFactory.class);\n+\n+  static IMetaStoreClient newInstance(IMetaStoreClient delegate) {\n+    HMSShim compatibility = null;\n+    try {\n+      compatibility = new HMSShim(delegate);\n+    } catch (Throwable t) {\n+      LOG.warn(\"Unable to initialize hive metastore compatibility client\", t);\n+    }\n+    return newInstance(delegate, compatibility);", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDA3NA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904074", "bodyText": "it is ok, because we check for null in the call.", "author": "yuzhu", "createdAt": "2020-08-11T22:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNDY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNTQ4MA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468725480", "bodyText": "I'm not sure what this code is doing. Could you explain it, and add a comment?", "author": "gpang", "createdAt": "2020-08-11T16:53:39Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    while (Proxy.isProxyClass(client.getClass())) {", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDE0OA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904148", "bodyText": "added a comment", "author": "yuzhu", "createdAt": "2020-08-11T22:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNTQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNjI4OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468726289", "bodyText": "Can you improve this message?", "author": "gpang", "createdAt": "2020-08-11T16:54:57Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown InvocationHandler \" + handler.getClass());\n+    }\n+    mClient = getField(client, \"client\");\n+  }\n+\n+  private static <T> T getField(Object object, String fieldName) {\n+    try {\n+      Field field = object.getClass().getDeclaredField(fieldName);\n+      T result = null;\n+      if (field.isAccessible()) {\n+        result = (T) field.get(object);\n+      } else {\n+        field.setAccessible(true);\n+        result = (T) field.get(object);\n+        field.setAccessible(false);\n+      }\n+      return result;\n+    } catch (SecurityException | NoSuchFieldException\n+        | IllegalArgumentException | IllegalAccessException e) {\n+      throw new RuntimeException(\"Unable to hack client\", e);", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDE3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904179", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-11T22:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNjI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNzU4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468727586", "bodyText": "Can you make this message more specific? I'm not sure what the user should do with that message.", "author": "gpang", "createdAt": "2020-08-11T16:57:06Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown InvocationHandler \" + handler.getClass());", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDIxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904211", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-11T22:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyNzU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyOTc2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468729769", "bodyText": "The second parameter should be @Nullable", "author": "gpang", "createdAt": "2020-08-11T17:00:40Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/CompatibleMetastoreClient.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.thrift.TApplicationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+\n+class CompatibleMetastoreClient implements InvocationHandler {\n+  private static final Logger LOG = LoggerFactory.getLogger(CompatibleMetastoreClient.class);\n+\n+  private final IMetaStoreClient mDelegate;\n+  private final HMSShim mCompat;\n+\n+  CompatibleMetastoreClient(IMetaStoreClient delegate, HMSShim compatibility) {", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDI0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904242", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-11T22:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyOTc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMTAzNw==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468731037", "bodyText": "These info logs could be spammy, since it would log for each invocation of those calls. Should we just cache this info and proactively use the compat method since that decision won't change over time. Then, we can log it when cache the method decision.", "author": "gpang", "createdAt": "2020-08-11T17:02:50Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/CompatibleMetastoreClient.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.thrift.TApplicationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+\n+class CompatibleMetastoreClient implements InvocationHandler {\n+  private static final Logger LOG = LoggerFactory.getLogger(CompatibleMetastoreClient.class);\n+\n+  private final IMetaStoreClient mDelegate;\n+  private final HMSShim mCompat;\n+\n+  CompatibleMetastoreClient(IMetaStoreClient delegate, HMSShim compatibility) {\n+    mDelegate = delegate;\n+    mCompat = compatibility;\n+  }\n+\n+  @Override\n+  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+    try {\n+      return method.invoke(mDelegate, args);\n+    } catch (InvocationTargetException delegateException) {\n+      try {\n+        LOG.info(\"Couldn't invoke method {}\", method.toGenericString());\n+        if (mCompat != null\n+            && delegateException.getCause().getClass()\n+            .isAssignableFrom(TApplicationException.class)) {\n+          LOG.info(\"Attempting to invoke with {}\", mCompat.getClass().getName());", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwNDMwMg==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468904302", "bodyText": "reduced log level", "author": "yuzhu", "createdAt": "2020-08-11T22:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMTYxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468731615", "bodyText": "Everything will go through Proxy and reflection now? That will have an overhead for any HMS interaction?", "author": "gpang", "createdAt": "2020-08-11T17:03:49Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSClientFactory.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.Proxy;\n+\n+class HMSClientFactory {\n+  private static final Logger LOG = LoggerFactory.getLogger(HMSClientFactory.class);\n+\n+  static IMetaStoreClient newInstance(IMetaStoreClient delegate) {\n+    HMSShim compatibility = null;\n+    try {\n+      compatibility = new HMSShim(delegate);\n+    } catch (Throwable t) {\n+      LOG.warn(\"Unable to initialize hive metastore compatibility client\", t);\n+    }\n+    return newInstance(delegate, compatibility);\n+  }\n+\n+  static IMetaStoreClient newInstance(IMetaStoreClient delegate, HMSShim compatibility) {\n+    ClassLoader classLoader = IMetaStoreClient.class.getClassLoader();\n+    Class<?>[] interfaces = new Class<?>[] { IMetaStoreClient.class };\n+    CompatibleMetastoreClient handler = new CompatibleMetastoreClient(delegate,\n+        compatibility);\n+    return (IMetaStoreClient) Proxy.newProxyInstance(classLoader, interfaces, handler);", "originalCommit": "5bff1b5d9361e059ce974b3ab9250ef992da8ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0NTMyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468745321", "bodyText": "I am not worried about the performance overhead at all. these calls are going to be dominated by network cost.\naccording to http://ordinaryjava.blogspot.com/2008/08/benchmarking-cost-of-dynamic-proxies.html, dynamic proxies are about 1.63x of a normal method call, which is almost instant.", "author": "yuzhu", "createdAt": "2020-08-11T17:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMTYxNQ=="}], "type": "inlineReview"}, {"oid": "55221b7dbc01c5cbf88c9ad3159ade1fcab6559f", "url": "https://github.com/Alluxio/alluxio/commit/55221b7dbc01c5cbf88c9ad3159ade1fcab6559f", "message": "address comments", "committedDate": "2020-08-11T22:36:06Z", "type": "commit"}, {"oid": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "url": "https://github.com/Alluxio/alluxio/commit/0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "message": "address comments", "committedDate": "2020-08-11T22:37:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzIzOA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468937238", "bodyText": "Is this safe? We are grabbing a field by name, of the hdfs client?", "author": "gpang", "createdAt": "2020-08-12T00:27:29Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    // Because RetryingMetaStoreClient is itself a proxy, we need to get to the base class\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown proxy handler for IMetaStoreClient\");\n+    }\n+    mClient = getField(client, \"client\");", "originalCommit": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5NDU4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469294585", "bodyText": "If this constructor fails, it will be caught at the higher level and we would behave as if there is no compatibility layer.\nThis reflection allows us to access the  thrift client and issue hive 2.2 compatible requests.", "author": "yuzhu", "createdAt": "2020-08-12T14:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5ODk2OA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469298968", "bodyText": "FYI: other places where reflection is used, there is the risk of failed reflection as well. In those cases, we catch throwable and fall back to the default behavior of the base client.", "author": "yuzhu", "createdAt": "2020-08-12T14:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzQ3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468937473", "bodyText": "add the fieldName to the message", "author": "gpang", "createdAt": "2020-08-12T00:28:28Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    // Because RetryingMetaStoreClient is itself a proxy, we need to get to the base class\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown proxy handler for IMetaStoreClient\");\n+    }\n+    mClient = getField(client, \"client\");\n+  }\n+\n+  private static <T> T getField(Object object, String fieldName) {\n+    try {\n+      Field field = object.getClass().getDeclaredField(fieldName);\n+      T result = null;\n+      if (field.isAccessible()) {\n+        result = (T) field.get(object);\n+      } else {\n+        field.setAccessible(true);\n+        result = (T) field.get(object);\n+        field.setAccessible(false);\n+      }\n+      return result;\n+    } catch (SecurityException | NoSuchFieldException\n+        | IllegalArgumentException | IllegalAccessException e) {\n+      throw new RuntimeException(\"Unable to access the client through reflection\", e);", "originalCommit": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5ODE2MA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469298160", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-12T14:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzg1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468937855", "bodyText": "Why do we have to set and then unset each time?", "author": "gpang", "createdAt": "2020-08-12T00:29:56Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    // Because RetryingMetaStoreClient is itself a proxy, we need to get to the base class\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown proxy handler for IMetaStoreClient\");\n+    }\n+    mClient = getField(client, \"client\");\n+  }\n+\n+  private static <T> T getField(Object object, String fieldName) {\n+    try {\n+      Field field = object.getClass().getDeclaredField(fieldName);\n+      T result = null;\n+      if (field.isAccessible()) {\n+        result = (T) field.get(object);\n+      } else {\n+        field.setAccessible(true);\n+        result = (T) field.get(object);\n+        field.setAccessible(false);\n+      }\n+      return result;\n+    } catch (SecurityException | NoSuchFieldException\n+        | IllegalArgumentException | IllegalAccessException e) {\n+      throw new RuntimeException(\"Unable to access the client through reflection\", e);\n+    }\n+  }\n+\n+  private static Table deepCopy(Table table) {\n+    return table.deepCopy();\n+  }\n+\n+  private void sendBase(String methodName, TBase<?, ?> args) throws TException {\n+    try {\n+      Method sendBase = TServiceClient.class.getDeclaredMethod(\n+          \"sendBase\", String.class, TBase.class);\n+      sendBase.setAccessible(true);", "originalCommit": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5ODExNA==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469298114", "bodyText": "you are right, we don't need to unset", "author": "yuzhu", "createdAt": "2020-08-12T14:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzkzNg==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468937936", "bodyText": "Should this be saved/cached?", "author": "gpang", "createdAt": "2020-08-12T00:30:11Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HMSShim.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.MetaException;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore;\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.TServiceClient;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+\n+/**\n+ * Implements a shim layer for hive metastore client.\n+ **/\n+public class HMSShim implements HiveCompatibility {\n+  private final TServiceClient mClient;\n+\n+  /**\n+   * Constructor for HMSShim.\n+   *\n+   * @param client another client as delegate\n+   */\n+  public HMSShim(IMetaStoreClient client) {\n+    // Because RetryingMetaStoreClient is itself a proxy, we need to get to the base class\n+    while (Proxy.isProxyClass(client.getClass())) {\n+      InvocationHandler handler = Proxy.getInvocationHandler(client);\n+      if (handler.getClass().isAssignableFrom(RetryingMetaStoreClient.class)) {\n+        client = getField(handler, \"base\");\n+        continue;\n+      }\n+      // Other handlers can be added here\n+      throw new RuntimeException(\"Unknown proxy handler for IMetaStoreClient\");\n+    }\n+    mClient = getField(client, \"client\");\n+  }\n+\n+  private static <T> T getField(Object object, String fieldName) {\n+    try {\n+      Field field = object.getClass().getDeclaredField(fieldName);\n+      T result = null;\n+      if (field.isAccessible()) {\n+        result = (T) field.get(object);\n+      } else {\n+        field.setAccessible(true);\n+        result = (T) field.get(object);\n+        field.setAccessible(false);\n+      }\n+      return result;\n+    } catch (SecurityException | NoSuchFieldException\n+        | IllegalArgumentException | IllegalAccessException e) {\n+      throw new RuntimeException(\"Unable to access the client through reflection\", e);\n+    }\n+  }\n+\n+  private static Table deepCopy(Table table) {\n+    return table.deepCopy();\n+  }\n+\n+  private void sendBase(String methodName, TBase<?, ?> args) throws TException {\n+    try {\n+      Method sendBase = TServiceClient.class.getDeclaredMethod(", "originalCommit": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMDc1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469300751", "bodyText": "i don't think there is a lot of value in caching these objects, mainly because the cost of reflection is going to be minimal compared to the network cost of these thrift calls.", "author": "yuzhu", "createdAt": "2020-08-12T14:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNzkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzODQwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r468938409", "bodyText": "Does the name of the method already imply the compatibility shim? If not, can we be explicit in the message that we are using the compatibility shim?", "author": "gpang", "createdAt": "2020-08-12T00:31:49Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/CompatibleMetastoreClient.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.thrift.TApplicationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+\n+import javax.annotation.Nullable;\n+\n+class CompatibleMetastoreClient implements InvocationHandler {\n+  private static final Logger LOG = LoggerFactory.getLogger(CompatibleMetastoreClient.class);\n+\n+  private final IMetaStoreClient mDelegate;\n+  private final HMSShim mCompat;\n+\n+  CompatibleMetastoreClient(IMetaStoreClient delegate, @Nullable HMSShim compatibility) {\n+    mDelegate = delegate;\n+    mCompat = compatibility;\n+  }\n+\n+  @Override\n+  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+    try {\n+      return method.invoke(mDelegate, args);\n+    } catch (InvocationTargetException delegateException) {\n+      try {\n+        if (mCompat != null\n+            && delegateException.getCause().getClass()\n+            .isAssignableFrom(TApplicationException.class)) {\n+          LOG.debug(\"Attempting to call hive metastore with {}\", mCompat.getClass().getName());", "originalCommit": "0c5bdd47cd259ad1388836d44d08b1d1f94de58f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjIxNw==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469302217", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-12T14:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzODQwOQ=="}], "type": "inlineReview"}, {"oid": "08811b803d3074ebb38f32241319bc342bbfb6f5", "url": "https://github.com/Alluxio/alluxio/commit/08811b803d3074ebb38f32241319bc342bbfb6f5", "message": "address comments", "committedDate": "2020-08-12T14:28:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NjM2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469396361", "bodyText": "Thanks for adding the compatibility part, but I think the method name is also useful. Could you add back the method name?", "author": "gpang", "createdAt": "2020-08-12T16:43:04Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/CompatibleMetastoreClient.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.thrift.TApplicationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+\n+import javax.annotation.Nullable;\n+\n+class CompatibleMetastoreClient implements InvocationHandler {\n+  private static final Logger LOG = LoggerFactory.getLogger(CompatibleMetastoreClient.class);\n+\n+  private final IMetaStoreClient mDelegate;\n+  private final HMSShim mCompat;\n+\n+  CompatibleMetastoreClient(IMetaStoreClient delegate, @Nullable HMSShim compatibility) {\n+    mDelegate = delegate;\n+    mCompat = compatibility;\n+  }\n+\n+  @Override\n+  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+    try {\n+      return method.invoke(mDelegate, args);\n+    } catch (InvocationTargetException delegateException) {\n+      try {\n+        if (mCompat != null\n+            && delegateException.getCause().getClass()\n+            .isAssignableFrom(TApplicationException.class)) {\n+          LOG.debug(\"Attempting to call hive metastore with compatibility client\");", "originalCommit": "08811b803d3074ebb38f32241319bc342bbfb6f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDM5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11962#discussion_r469450396", "bodyText": "done", "author": "yuzhu", "createdAt": "2020-08-12T18:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NjM2MQ=="}], "type": "inlineReview"}, {"oid": "cc61d16e4651208de8a658d596f5e8ca98ed601e", "url": "https://github.com/Alluxio/alluxio/commit/cc61d16e4651208de8a658d596f5e8ca98ed601e", "message": "address comment", "committedDate": "2020-08-12T18:13:36Z", "type": "commit"}]}