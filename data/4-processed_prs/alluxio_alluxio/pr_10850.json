{"pr_number": 10850, "pr_title": "Increment cluster counter and delete orphaned meter in MetricsStore", "pr_createdAt": "2020-02-06T00:08:20Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10850", "timeline": [{"oid": "42105eefb53f41465493430058c0d506794a3f12", "url": "https://github.com/Alluxio/alluxio/commit/42105eefb53f41465493430058c0d506794a3f12", "message": "Remove orphaned metrics", "committedDate": "2020-02-05T19:02:19Z", "type": "commit"}, {"oid": "2088976d9e1b563d81edb12182521ef821d92705", "url": "https://github.com/Alluxio/alluxio/commit/2088976d9e1b563d81edb12182521ef821d92705", "message": "Remember cluster counter instead of calculate them periodically", "committedDate": "2020-02-05T23:59:39Z", "type": "commit"}, {"oid": "262cc2c9022a8b84cdd9137728e8f39c214c35d2", "url": "https://github.com/Alluxio/alluxio/commit/262cc2c9022a8b84cdd9137728e8f39c214c35d2", "message": "small doc", "committedDate": "2020-02-06T00:02:36Z", "type": "commit"}, {"oid": "e43682993d1ca17bea006a4546ef2e9804723876", "url": "https://github.com/Alluxio/alluxio/commit/e43682993d1ca17bea006a4546ef2e9804723876", "message": "Fix metric test", "committedDate": "2020-02-06T00:23:45Z", "type": "commit"}, {"oid": "d09c78d20aaeba188fe7d94a4774a63bf542402d", "url": "https://github.com/Alluxio/alluxio/commit/d09c78d20aaeba188fe7d94a4774a63bf542402d", "message": "small fix", "committedDate": "2020-02-06T00:54:14Z", "type": "commit"}, {"oid": "3c93b469049ee39fb2c0b644cd072dcd4221bd84", "url": "https://github.com/Alluxio/alluxio/commit/3c93b469049ee39fb2c0b644cd072dcd4221bd84", "message": "Fix MetricsStoreTest", "committedDate": "2020-02-06T01:20:21Z", "type": "commit"}, {"oid": "bbc26578a296f71277a7cc5666126191e0ac06bf", "url": "https://github.com/Alluxio/alluxio/commit/bbc26578a296f71277a7cc5666126191e0ac06bf", "message": "Fix MetricsMasterTest", "committedDate": "2020-02-06T02:24:53Z", "type": "commit"}, {"oid": "a907df8db59d0769dd7ed7fec5026777660766c4", "url": "https://github.com/Alluxio/alluxio/commit/a907df8db59d0769dd7ed7fec5026777660766c4", "message": "Fix MetricsCommandIntegrationTest", "committedDate": "2020-02-06T05:36:25Z", "type": "commit"}, {"oid": "09efb34837f19c8420baf19cabcec4473a0a95fb", "url": "https://github.com/Alluxio/alluxio/commit/09efb34837f19c8420baf19cabcec4473a0a95fb", "message": "Fix metric type and reduce web ui traverse", "committedDate": "2020-02-06T18:15:41Z", "type": "commit"}, {"oid": "890b46f20e5a077e3d8ab42fd17dc0ee3231680f", "url": "https://github.com/Alluxio/alluxio/commit/890b46f20e5a077e3d8ab42fd17dc0ee3231680f", "message": "small fix", "committedDate": "2020-02-06T18:35:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyMTAyNA==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376021024", "bodyText": "Fix a bug that the new metrics name is <Instance_type>.<MetricName>.Tags.<InstanceHostname> instead of <Instance_type>.<MetricName>.<InstanceHostname>.Tags", "author": "LuQQiu", "createdAt": "2020-02-06T18:57:41Z", "path": "core/common/src/main/java/alluxio/metrics/Metric.java", "diffHunk": "@@ -300,32 +319,31 @@ public static String getMetricNameWithUserTag(String metricName, String userName\n   public static Metric from(String fullName, double value, MetricType metricType) {\n     String[] pieces = fullName.split(\"\\\\.\");\n     Preconditions.checkArgument(pieces.length > 1, \"Incorrect metrics name: %s.\", fullName);\n-\n+    int len = pieces.length;", "originalCommit": "890b46f20e5a077e3d8ab42fd17dc0ee3231680f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyMTYzMg==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376021632", "bodyText": "Every MetricRegistry.getGauges and getCounters() will do a traverse of all metrics, make a copy and return. So it will be better to reduce the call to these two methods.", "author": "LuQQiu", "createdAt": "2020-02-06T18:58:51Z", "path": "core/server/master/src/main/java/alluxio/master/meta/AlluxioMasterRestServiceHandler.java", "diffHunk": "@@ -850,20 +849,22 @@ public Response getWebUIMetrics() {\n       MasterWebUIMetrics response = new MasterWebUIMetrics();\n \n       MetricRegistry mr = MetricsSystem.METRIC_REGISTRY;\n+      SortedMap<String, Gauge> gauges = mr.getGauges();\n+      SortedMap<String, Counter> counters = mr.getCounters();", "originalCommit": "890b46f20e5a077e3d8ab42fd17dc0ee3231680f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyMjk4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376022985", "bodyText": "All BytesRead/Written will become actual MetricType.COUNTER. Their values will be incremented when received worker/client reported metrics.", "author": "LuQQiu", "createdAt": "2020-02-06T19:01:31Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -126,65 +120,45 @@ public Object getValue() {\n     }\n   }\n \n+  private void cleanUpOrphaneMetrics() {\n+    mMetricsStore.cleanUpOrphanedMetrics();\n+  }\n+\n   private void registerAggregators() {\n     // worker metrics\n-    addAggregator(new SumInstancesAggregator(MetricKey.CLUSTER_BYTES_READ_ALLUXIO.getName(),\n-        MetricsSystem.InstanceType.WORKER, MetricKey.WORKER_BYTES_READ_ALLUXIO.getName()));", "originalCommit": "890b46f20e5a077e3d8ab42fd17dc0ee3231680f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "url": "https://github.com/Alluxio/alluxio/commit/c2ca6a6311ee9778caa8a8fb09d530942800b2da", "message": "small fix", "committedDate": "2020-02-06T19:23:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzEyMw==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376113123", "bodyText": "Do we want to be testing MetricType.COUNTER?", "author": "calvinjia", "createdAt": "2020-02-06T22:16:27Z", "path": "core/server/master/src/test/java/alluxio/master/metrics/MetricsMasterTest.java", "diffHunk": "@@ -102,12 +102,12 @@ public void testMultiValueAggregator() throws Exception {\n     mMetricsMaster.addAggregator(\n         new SingleTagValueAggregator(\"metric\", MetricsSystem.InstanceType.WORKER, \"metric\", \"tag\"));\n     List<Metric> metrics1 = Lists.newArrayList(\n-        Metric.from(\"worker.metric.192_1_1_1.tag:v1\", 10, MetricType.GAUGE),\n-        Metric.from(\"worker.metric.192_1_1_1.tag:v2\", 20, MetricType.GAUGE));\n+        Metric.from(\"worker.metric.tag:v1.192_1_1_1\", 10, MetricType.GAUGE),\n+        Metric.from(\"worker.metric.tag:v2.192_1_1_1\", 20, MetricType.GAUGE));\n     mMetricsMaster.workerHeartbeat(\"192_1_1_1\", metrics1);\n     List<Metric> metrics2 = Lists.newArrayList(\n-        Metric.from(\"worker.metric.192_1_1_2.tag:v1\", 1, MetricType.GAUGE),\n-        Metric.from(\"worker.metric.192_1_1_2.tag:v2\", 2, MetricType.GAUGE));\n+        Metric.from(\"worker.metric.tag:v1.192_1_1_2\", 1, MetricType.GAUGE),\n+        Metric.from(\"worker.metric.tag:v2.192_1_1_2\", 2, MetricType.GAUGE));", "originalCommit": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEyNzA0MA==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376127040", "bodyText": "Will add the tests after finishing and testing out all those PRs. For the MetricsStore, based on my findings today, I still need to modify it.\nOne of my TODO is don't send and aggregated throughput meter one minute rate in master. This is because the client needs five seconds to have non-zero one minute rate and most clients don't live that long. Plan to change to calculated throughput directly on master side.", "author": "LuQQiu", "createdAt": "2020-02-06T22:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNDkwNg==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376114906", "bodyText": "cleanUpOrphaneMetrics -> cleanUpOrphanedMetrics", "author": "calvinjia", "createdAt": "2020-02-06T22:20:51Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -126,65 +120,45 @@ public Object getValue() {\n     }\n   }\n \n+  private void cleanUpOrphaneMetrics() {", "originalCommit": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MzEwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376183105", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-07T02:12:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNDkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNjY0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376116645", "bodyText": "OrphaneMetricsCleaner -> OrphanedMetricsCleaner", "author": "calvinjia", "createdAt": "2020-02-06T22:25:25Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -254,4 +236,19 @@ public void close() {\n       // nothing to clean up\n     }\n   }\n+\n+  /**\n+   * Heartbeat executor that cleans the metrics reported by lost workers or clients.\n+   */\n+  private class OrphaneMetricsCleaner implements HeartbeatExecutor {", "originalCommit": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MzExNw==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376183117", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-07T02:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNjY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNzUxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376117515", "bodyText": "One line", "author": "calvinjia", "createdAt": "2020-02-06T22:27:41Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -114,28 +140,32 @@ public void putWorkerMetrics(String hostname, List<Metric> metrics) {\n    * @param metrics the new metrics\n    */\n   public void putClientMetrics(String hostname, String clientId, List<Metric> metrics) {\n-    if (metrics.isEmpty()) {\n+    if (metrics.isEmpty() || hostname == null) {\n       return;\n     }\n     try (LockResource r = new LockResource(mLock.readLock())) {\n-      putReportedMetrics(mClientMetrics, getFullInstanceId(hostname, clientId), metrics);\n+      mLastReportedTimeMap.put(getFullInstanceId(hostname, clientId), System.currentTimeMillis());\n+      putReportedMetrics(InstanceType.CLIENT, metrics);\n     }\n   }\n \n   /**\n-   * Update the reported metrics with the given instanceId and set of metrics received from a\n+   * Update the reported metrics received from a\n    * worker or client.\n    *\n-   * Any metrics from the given instanceId which are not reported in the new set of metrics are\n-   * removed. Metrics of {@link MetricType} COUNTER are incremented by the reported values.\n-   * Otherwise, all metrics are simply replaced.\n+   * Cluster metrics of {@link MetricType} COUNTER are directly incremented by the reported values.\n+   * All other metrics are recorded in the metrics map individually, calculated periodically,\n+   * and deleted when the report instance doesn't report for a period of time.\n    *\n-   * @param metricSet the {@link IndexedSet} of client or worker metrics to update\n-   * @param instanceId the instance id, derived from {@link #getFullInstanceId(String, String)}\n+   * @param instanceType the instance type that reports the metrics\n    * @param reportedMetrics the metrics received by the RPC handler\n    */\n-  private static void putReportedMetrics(IndexedSet<Metric> metricSet, String instanceId,\n+  private void putReportedMetrics(InstanceType instanceType,", "originalCommit": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MzE0NA==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376183144", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-07T02:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNzUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExODQ0NA==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376118444", "bodyText": "Will this be expensive?", "author": "calvinjia", "createdAt": "2020-02-06T22:30:06Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -144,19 +174,50 @@ private static void putReportedMetrics(IndexedSet<Metric> metricSet, String inst\n       // If a metric is COUNTER, the value sent via RPC should be the incremental value; i.e.\n       // the amount the value has changed since the last RPC. The master should equivalently\n       // increment its value based on the received metric rather than replacing it.\n-      if (!metricSet.add(metric)) {\n-        Metric oldMetric = metricSet.getFirstByField(FULL_NAME_INDEX, metric.getFullMetricName());\n-        if (metric.getMetricType() == MetricType.COUNTER) {\n-          if (metric.getValue() != 0L) {\n-            oldMetric.addValue(metric.getValue());\n-          }\n-        } else {\n-          oldMetric.setValue(metric.getValue());\n+      if (metric.getMetricType() == MetricType.COUNTER) {\n+        String metricKeyName = metric.getInstanceType() + \".\" + metric.getName();", "originalCommit": "c2ca6a6311ee9778caa8a8fb09d530942800b2da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEyMjQyNA==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376122424", "bodyText": "The metricKeyName is used for matching the MetricKey.WORKER_BYTES_READ_UFS.getName().\nIn the MetricKey, I gave the prefix MASTER_/WORKER_/CLIENT_<ACTUAL_METRIC_NAME> because the <ACTUAL_METRIC_NAME> may be duplicated in worker or client metrics.\nYeah this may be expensive, would you think it will be better to use a struct directly\nConcurrentHashMap<ClusterCounterKey, Counter> mClusterCounters\nstruct ClusterCounterkey{\n  String instanceType\n  String metricName\n}\n\nbut the string concatenation is still needed when comparing with the MetricKey.WORKER_BYTES_READ_UFS.getName() and MetricKey.WORKER_BYTES_WRITTEN_UFS.getName().", "author": "LuQQiu", "createdAt": "2020-02-06T22:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExODQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEzNDcwMg==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376134702", "bodyText": "I remember string concat being quite expensive based on your previous findings. One alternative is check instanceType == WORKER and metricName.equals(BYTES_READ_UFS)?", "author": "calvinjia", "createdAt": "2020-02-06T23:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExODQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MzIwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376183205", "bodyText": "Remove the potentially expensive string concatenation", "author": "LuQQiu", "createdAt": "2020-02-07T02:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExODQ0NA=="}], "type": "inlineReview"}, {"oid": "6a5dc94b735e4ef85013d7402df1d44eee10e08f", "url": "https://github.com/Alluxio/alluxio/commit/6a5dc94b735e4ef85013d7402df1d44eee10e08f", "message": "small fix", "committedDate": "2020-02-06T22:54:44Z", "type": "commit"}, {"oid": "2bf233e07c29e8e39ff332345a8d09c151b62821", "url": "https://github.com/Alluxio/alluxio/commit/2bf233e07c29e8e39ff332345a8d09c151b62821", "message": "Reduce string concatenation in MetricsStore", "committedDate": "2020-02-07T00:42:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU2MzU3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376563573", "bodyText": "These constants are available in WorkerMetrics?", "author": "calvinjia", "createdAt": "2020-02-07T19:21:40Z", "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -44,6 +45,10 @@\n @ThreadSafe\n public class MetricsStore {\n   private static final Logger LOG = LoggerFactory.getLogger(MetricsStore.class);\n+  // The following fields are added for reducing the string processing\n+  // for MetricKey.WORKER_BYTES_READ_UFS and MetricKey.WORKER_BYTES_WRITTEN_UFS\n+  private static final String BYTES_READ_UFS = \"BytesReadPerUfs\";", "originalCommit": "2bf233e07c29e8e39ff332345a8d09c151b62821", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU2NzE5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10850#discussion_r376567192", "bodyText": "I removed all the WorkerMetrics, MasterMetrics, ClientMetrics to the MetricKey which define all metrics with full name Worker.BytesReadPerUfs.", "author": "LuQQiu", "createdAt": "2020-02-07T19:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU2MzU3Mw=="}], "type": "inlineReview"}]}