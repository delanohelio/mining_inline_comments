{"pr_number": 12101, "pr_title": "Improve entrypoint.sh to better support dynamic non-root user", "pr_createdAt": "2020-09-11T07:27:05Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12101", "timeline": [{"oid": "812cfb1a04b2903f89246e9c2844c57142bcd481", "url": "https://github.com/Alluxio/alluxio/commit/812cfb1a04b2903f89246e9c2844c57142bcd481", "message": "Fix entrypoint.sh for supporint dynamic non-root", "committedDate": "2020-09-11T02:59:12Z", "type": "commit"}, {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50", "url": "https://github.com/Alluxio/alluxio/commit/568689d99aad707fbf72eefef19c5f0385cecc50", "message": "Improve entrypoint.h", "committedDate": "2020-09-11T04:59:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMzE0OA==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r487133148", "bodyText": "this value may also contain a comma-delimited list of directories. We should handle that case too.", "author": "ZacBlanco", "createdAt": "2020-09-11T15:47:04Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\", "originalCommit": "568689d99aad707fbf72eefef19c5f0385cecc50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2ODYwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r491768609", "bodyText": "@ZacBlanco, hi, I updated this script to support comma-delimited list of directories. thanks for your advice!", "author": "iluoeli", "createdAt": "2020-09-21T02:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMzE0OA=="}], "type": "inlineReview"}, {"oid": "32e4374b9a099a05957c8685391075cf46b791b8", "url": "https://github.com/Alluxio/alluxio/commit/32e4374b9a099a05957c8685391075cf46b791b8", "message": "Support comma-delimited list of directories", "committedDate": "2020-09-21T02:16:07Z", "type": "commit"}, {"oid": "9a24bbcad99b77d5dc15530db9f189d115695d2e", "url": "https://github.com/Alluxio/alluxio/commit/9a24bbcad99b77d5dc15530db9f189d115695d2e", "message": "Small fix of entrypoint.sh", "committedDate": "2020-09-21T02:25:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNTQ3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r492205472", "bodyText": "is there a reason the argument was changes from ${ARGS} here to $*?", "author": "ZacBlanco", "createdAt": "2020-09-21T16:49:17Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\\n+          xargs -I {} chmod -R 777 {}\n+      fi\n+      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh $*\"", "originalCommit": "568689d99aad707fbf72eefef19c5f0385cecc50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyMDY0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r493320641", "bodyText": "We need to judge whether it's a worker or not. So, $* make it easier to do so.", "author": "iluoeli", "createdAt": "2020-09-23T08:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMzA5OA==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r492213098", "bodyText": "I tested the script and it still doesn't seem to work\nI created directores a1 and a2 in my working directory, the same place I ran this command.\n#!/usr/bin/env bash\nset -x\ntvar=\"-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\"\n\necho \"$tvar\" | tr ' ' '\\n' | \\\ngrep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\ncut -d '=' -f 2 | \\\ngrep -Ev \"^$\" | \\\nxargs -I {} chmod -R 777 {}\n\noutput:\n+ tvar=-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ echo -Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ tr ' ' '\\n'\n+ grep 'alluxio.worker.tieredstore.level[0-9].dirs.path'\n+ cut -d = -f 2\n+ grep -Ev '^$'\n+ xargs -I '{}' chmod -R 777 '{}'\nchmod: cannot access 'a1,a2': No such file or directory", "author": "ZacBlanco", "createdAt": "2020-09-21T17:02:24Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\\n+          xargs -I {} chmod -R 777 {}", "originalCommit": "568689d99aad707fbf72eefef19c5f0385cecc50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMzE0MA==", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r492433140", "bodyText": "Are you testing on the latest version?\nI tried and it is working fine.\nscript:\n#!/usr/bin/env bash\nset -x\ntvar=\"-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\"\necho \"${tvar}\" | \\\n  tr ' ' '\\n' | \\\n  grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n  cut -d '=' -f 2 | \\\n  tr ',' '\\n' | \\\n  grep -Ev \"^$\" | \\\n  xargs -I {} chmod -R 777 {}\noutput:\n+ tvar=-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ echo -Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ tr ' ' '\\n'\n+ grep 'alluxio.worker.tieredstore.level[0-9].dirs.path'\n+ cut -d = -f 2\n+ tr , '\\n'\n+ grep -Ev '^$'\n+ xargs -I '{}' chmod -R 777 '{}'\nchmod: a1: No such file or directory\nchmod: a2: No such file or directory", "author": "iluoeli", "createdAt": "2020-09-22T01:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMzA5OA=="}], "type": "inlineReview"}]}