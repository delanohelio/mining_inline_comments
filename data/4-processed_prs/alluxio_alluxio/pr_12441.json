{"pr_number": 12441, "pr_title": "Prevent unnecessary inode syncing", "pr_createdAt": "2020-10-31T06:51:08Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12441", "timeline": [{"oid": "c244a32207dd159984f92ff6db4ede1ff536f287", "url": "https://github.com/Alluxio/alluxio/commit/c244a32207dd159984f92ff6db4ede1ff536f287", "message": "Prevent unnecessary inode syncing", "committedDate": "2020-10-31T07:08:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDEzMA==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516230130", "bodyText": "Can we encode this desired behavior in a simple unittest?", "author": "gpang", "createdAt": "2020-11-02T20:17:35Z", "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -569,9 +570,16 @@ private void syncExistingInodeMetadata(LockedInodePath inodePath)\n       }\n     }\n \n-    syncChildren = syncChildren\n-        && inode.isDirectory()\n-        && mDescendantType != DescendantType.NONE;\n+    // Only sync children when\n+    // (1) DescendantType.ALL or (2) syncing root of this stream && DescendantType.ONE", "originalCommit": "c244a32207dd159984f92ff6db4ede1ff536f287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NjYxOA==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516276618", "bodyText": "Gene, there is no unit test for this class InodeSyncStream though I think this class should be covered by UT definitely. Do you know if there is any other integration tests covering this part? I am very unfamiliar with this part of source code and it would be a lot to investigate to understand this class and write a whole new UT", "author": "apc999", "createdAt": "2020-11-02T21:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI4NDQ0OA==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516284448", "bodyText": "I think we can use UfsSyncIntegrationTest for testing sync behavior.", "author": "gpang", "createdAt": "2020-11-02T22:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4NDg2MA==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516384860", "bodyText": "added. PTAL", "author": "apc999", "createdAt": "2020-11-03T01:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDEzMA=="}], "type": "inlineReview"}, {"oid": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "url": "https://github.com/Alluxio/alluxio/commit/0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "message": "Prevent unnecessary inode syncing", "committedDate": "2020-11-03T01:34:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4Nzc0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516387743", "bodyText": "Does this work because recursive is false by default? We want it false, right?", "author": "gpang", "createdAt": "2020-11-03T01:47:10Z", "path": "tests/src/test/java/alluxio/client/fs/UfsSyncIntegrationTest.java", "diffHunk": "@@ -168,6 +184,21 @@ public void listDirSync() throws Exception {\n     checkListStatus(ROOT_DIR, options, true);\n   }\n \n+  // https://github.com/Alluxio/alluxio/issues/12372\n+  @Test\n+  public void listDirSyncOnlyTouchingChildren() throws Exception {\n+    String dir1 = PathUtils.concatPath(EXISTING_DIR, \"dir_should_sync\");\n+    String dir2 = PathUtils.concatPath(dir1, \"dir_should_not_sync\");\n+    new File(ufsPath(dir1)).mkdirs();\n+    new File(ufsPath(dir2)).mkdirs();\n+    ListStatusPOptions optionsAlways = ListStatusPOptions.newBuilder()\n+        .setLoadMetadataType(LoadMetadataPType.NEVER).setCommonOptions(PSYNC_ALWAYS).build();", "originalCommit": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4NzkwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516387909", "bodyText": "correct . added    .setRecursive(false) to be more explicit", "author": "apc999", "createdAt": "2020-11-03T01:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4Nzc0Mw=="}], "type": "inlineReview"}, {"oid": "5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "url": "https://github.com/Alluxio/alluxio/commit/5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "message": "Prevent unnecessary inode syncing", "committedDate": "2020-11-03T02:02:51Z", "type": "commit"}, {"oid": "5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "url": "https://github.com/Alluxio/alluxio/commit/5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "message": "Prevent unnecessary inode syncing", "committedDate": "2020-11-03T02:02:51Z", "type": "forcePushed"}]}