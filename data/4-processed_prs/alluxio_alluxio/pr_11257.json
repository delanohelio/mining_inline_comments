{"pr_number": 11257, "pr_title": "Fix inheritance for empty owner on createPath and sync", "pr_createdAt": "2020-04-10T04:46:42Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11257", "timeline": [{"oid": "b0427213fad32007a5921dcb1ab367a7a330833a", "url": "https://github.com/Alluxio/alluxio/commit/b0427213fad32007a5921dcb1ab367a7a330833a", "message": "Reorder inherit when empty", "committedDate": "2020-04-10T01:23:45Z", "type": "commit"}, {"oid": "6af8967fcc6eb5b00b95919455f00d02539d161f", "url": "https://github.com/Alluxio/alluxio/commit/6af8967fcc6eb5b00b95919455f00d02539d161f", "message": "Update comment", "committedDate": "2020-04-10T03:56:04Z", "type": "commit"}, {"oid": "b57de6b98b06c807d551f2068c923e64aab5bf62", "url": "https://github.com/Alluxio/alluxio/commit/b57de6b98b06c807d551f2068c923e64aab5bf62", "message": "Do not set empty owner/group on sync", "committedDate": "2020-04-10T04:36:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzg0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406603841", "bodyText": "I am curious, under what conditions, would the ufs not have owner or group information?", "author": "yuzhu", "createdAt": "2020-04-10T05:06:35Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -3564,10 +3564,20 @@ private SyncResult syncInodeMetadata(RpcContext rpcContext, LockedInodePath inod\n         if (ufsFpParsed.isValid()) {\n           short mode = Short.parseShort(ufsFpParsed.getTag(Tag.MODE));\n           long opTimeMs = System.currentTimeMillis();\n-          setAttributeSingleFile(rpcContext, inodePath, false, opTimeMs, SetAttributeContext\n-              .mergeFrom(SetAttributePOptions.newBuilder().setOwner(ufsFpParsed.getTag(Tag.OWNER))\n-                  .setGroup(ufsFpParsed.getTag(Tag.GROUP)).setMode(new Mode(mode).toProto()))\n-              .setUfsFingerprint(ufsFingerprint));\n+          SetAttributePOptions.Builder builder = SetAttributePOptions.newBuilder()\n+              .setMode(new Mode(mode).toProto());\n+          String owner = ufsFpParsed.getTag(Tag.OWNER);\n+          if (!owner.equals(Fingerprint.UNDERSCORE)) {", "originalCommit": "b57de6b98b06c807d551f2068c923e64aab5bf62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwNjU0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406606541", "bodyText": "its's a corner case, took me a while to figure out. i'll update the description", "author": "madanadit", "createdAt": "2020-04-10T05:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwODM0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406608342", "bodyText": "@yuzhu when inherit_acl is false all object ufs do not return owner and group. that is because the s3 account credential cannot be mapped to a user in those cases.", "author": "madanadit", "createdAt": "2020-04-10T05:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwOTI2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406609267", "bodyText": "got it.", "author": "yuzhu", "createdAt": "2020-04-10T05:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzg0MQ=="}], "type": "inlineReview"}, {"oid": "acc74c216af9df09f83874de89b1bfdbc3d717bd", "url": "https://github.com/Alluxio/alluxio/commit/acc74c216af9df09f83874de89b1bfdbc3d717bd", "message": "Fix style", "committedDate": "2020-04-10T05:25:13Z", "type": "commit"}, {"oid": "3523d8a431ef34b1f2d3c925139d2628e03c904a", "url": "https://github.com/Alluxio/alluxio/commit/3523d8a431ef34b1f2d3c925139d2628e03c904a", "message": "Add sync metadata test", "committedDate": "2020-04-10T17:02:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMjQ3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406932477", "bodyText": "Does setAttributeSingleFile handle the cases when owner or group are unset in the proto?", "author": "gpang", "createdAt": "2020-04-10T20:36:41Z", "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -3564,10 +3564,20 @@ private SyncResult syncInodeMetadata(RpcContext rpcContext, LockedInodePath inod\n         if (ufsFpParsed.isValid()) {\n           short mode = Short.parseShort(ufsFpParsed.getTag(Tag.MODE));\n           long opTimeMs = System.currentTimeMillis();\n-          setAttributeSingleFile(rpcContext, inodePath, false, opTimeMs, SetAttributeContext\n-              .mergeFrom(SetAttributePOptions.newBuilder().setOwner(ufsFpParsed.getTag(Tag.OWNER))\n-                  .setGroup(ufsFpParsed.getTag(Tag.GROUP)).setMode(new Mode(mode).toProto()))\n-              .setUfsFingerprint(ufsFingerprint));\n+          SetAttributePOptions.Builder builder = SetAttributePOptions.newBuilder()\n+              .setMode(new Mode(mode).toProto());\n+          String owner = ufsFpParsed.getTag(Tag.OWNER);\n+          if (!owner.equals(Fingerprint.UNDERSCORE)) {\n+            // Only set owner if not empty\n+            builder.setOwner(owner);\n+          }\n+          String group = ufsFpParsed.getTag(Tag.GROUP);\n+          if (!group.equals(Fingerprint.UNDERSCORE)) {\n+            // Only set group if not empty\n+            builder.setGroup(group);\n+          }\n+          setAttributeSingleFile(rpcContext, inodePath, false, opTimeMs,", "originalCommit": "acc74c216af9df09f83874de89b1bfdbc3d717bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk1NDI5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11257#discussion_r406954299", "bodyText": "yep, it does", "author": "madanadit", "createdAt": "2020-04-10T21:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMjQ3Nw=="}], "type": "inlineReview"}, {"oid": "64e3c99fa5bda03796f09fc8230d489e6009e49c", "url": "https://github.com/Alluxio/alluxio/commit/64e3c99fa5bda03796f09fc8230d489e6009e49c", "message": "Fix setting owner/group to empty in InodeTree::syncPersistExistingDirectory", "committedDate": "2020-04-10T21:39:40Z", "type": "commit"}, {"oid": "65fbd491a3f52e91656f01121e2ab887637e2ac5", "url": "https://github.com/Alluxio/alluxio/commit/65fbd491a3f52e91656f01121e2ab887637e2ac5", "message": "Fix style", "committedDate": "2020-04-10T21:45:14Z", "type": "commit"}, {"oid": "829931c63670eb13e799f36b6093ac24fe811538", "url": "https://github.com/Alluxio/alluxio/commit/829931c63670eb13e799f36b6093ac24fe811538", "message": "Update comment", "committedDate": "2020-04-10T21:47:57Z", "type": "commit"}, {"oid": "c49f32fb9fdc9bc27def159d38a16d64b8e58edf", "url": "https://github.com/Alluxio/alluxio/commit/c49f32fb9fdc9bc27def159d38a16d64b8e58edf", "message": "Fix style", "committedDate": "2020-04-10T21:52:46Z", "type": "commit"}]}