{"pr_number": 11414, "pr_title": "Prevent secondary UFS journal from modifying journal files", "pr_createdAt": "2020-05-11T05:02:23Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11414", "timeline": [{"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5", "url": "https://github.com/Alluxio/alluxio/commit/ab759b9f485d1f855f0af0554fbaca3d59c1b9d5", "message": "Prevent secondary UFS journal to modify journal files", "committedDate": "2020-05-11T05:00:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4OTA4Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11414#discussion_r422789082", "bodyText": "We could still lose primacy after the check, but that's fine because the rename will not pick up the wrong journal file? (ie. we check for primacy between updating current and attempting rename)", "author": "calvinjia", "createdAt": "2020-05-11T05:29:28Z", "path": "core/server/common/src/main/java/alluxio/master/journal/ufs/UfsJournalLogWriter.java", "diffHunk": "@@ -314,10 +329,19 @@ private void completeLog(UfsJournalFile currentLog, long nextSequenceNumber) thr\n       }\n       return;\n     }\n-    LOG.info(\"Completing log {} with next sequence number {}\", current, nextSequenceNumber);\n     String completed = UfsJournalFile\n         .encodeLogFileLocation(mJournal, currentLog.getStart(), nextSequenceNumber).toString();\n \n+    try {\n+      // Check again before the rename\n+      checkIsWritable();\n+    } catch (JournalClosedException e) {\n+      // Do not throw error, just ignore if the journal is not writable\n+      LOG.warn(\"Skipping completeLog() since journal is not writable. error: {}\", e.getMessage());\n+      return;\n+    }", "originalCommit": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NTM1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11414#discussion_r422795359", "bodyText": "yeah, I was thinking about that. I don't know how else to prevent the gap, but this basically the smallest we can make this gap. I'm not sure what will happen if the failover happens after the check, but before the rename...", "author": "gpang", "createdAt": "2020-05-11T05:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4OTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIwMDk2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11414#discussion_r423200961", "bodyText": "I think it should be okay because it still is referencing the old journal file.", "author": "calvinjia", "createdAt": "2020-05-11T17:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4OTA4Mg=="}], "type": "inlineReview"}, {"oid": "daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909", "url": "https://github.com/Alluxio/alluxio/commit/daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909", "message": "Fix tests", "committedDate": "2020-05-11T05:42:08Z", "type": "commit"}]}