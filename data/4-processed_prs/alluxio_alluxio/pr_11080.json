{"pr_number": 11080, "pr_title": "Add readiness and liveness probe to Alluxio containers in K8s", "pr_createdAt": "2020-03-01T13:08:46Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11080", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1NzM5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r388457396", "bodyText": "the sooner we move this out to another repository the better", "author": "ZacBlanco", "createdAt": "2020-03-05T17:46:27Z", "path": "integration/kubernetes/alluxio-fuse.yaml.template", "diffHunk": "@@ -17,23 +17,23 @@ metadata:\n   name: alluxio-fuse\n   labels:\n     app: alluxio\n-    chart: alluxio-0.5.5\n+    chart: alluxio-0.5.6\n     release: alluxio\n     heritage: Tiller\n     role: alluxio-fuse\n spec:\n   selector:\n     matchLabels:\n       app: alluxio\n-      chart: alluxio-0.5.5\n+      chart: alluxio-0.5.6\n       release: alluxio\n       heritage: Tiller\n       role: alluxio-fuse\n   template:\n     metadata:\n       labels:\n         app: alluxio\n-        chart: alluxio-0.5.5\n+        chart: alluxio-0.5.6", "originalCommit": "601e05de6ff658ee4d0a1d5f6f9db0ee5b64ffb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1ODc1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r388458759", "bodyText": "What's the difference between readiness and liveness probes?\nCorrect me if I'm wrong, but from my interpretation\n\nreadiness is \"ready to serve\". Can be done via RPC.\nliveness is \"is the process/service up, but not necessarily ready to serve clients\". I don't think we have a good check for this.\n\nIt just seems odd we seem to be doing the same thing for two different probes", "author": "ZacBlanco", "createdAt": "2020-03-05T17:49:08Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -238,3 +238,35 @@ resources:\n             defaultMode: 256\n   {{- end }}\n {{- end -}}\n+\n+{{- define \"alluxio.master.readinessProbe\" -}}\n+readinessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"master\"]\n+{{- end -}}\n+\n+{{- define \"alluxio.worker.readinessProbe\" -}}\n+readinessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"worker\"]\n+{{- end -}}\n+\n+{{- define \"alluxio.master.livenessProbe\" -}}", "originalCommit": "601e05de6ff658ee4d0a1d5f6f9db0ee5b64ffb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4NjQ1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r388886452", "bodyText": "You are right on readiness.\nFor liveness I think it's \"is the process/service up, but not necessarily ready to serve clients\" plus \"if it's not alive it can/should possibly be restarted, trying to recover\". If a liveness probe fails (for a specific number of times), K8s will restart it. That's why I think fsadmin report is not a good liveness probe, because oftentimes it's not a recoverable state.", "author": "jiacheliu3", "createdAt": "2020-03-06T12:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1ODc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1OTc5Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r388459793", "bodyText": "Where exactly are these being executed from? Right now it assumed ${ALLUXIO_HOME} but is that always the case?", "author": "ZacBlanco", "createdAt": "2020-03-05T17:51:01Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -238,3 +238,35 @@ resources:\n             defaultMode: 256\n   {{- end }}\n {{- end -}}\n+\n+{{- define \"alluxio.master.readinessProbe\" -}}\n+readinessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"master\"]\n+{{- end -}}\n+\n+{{- define \"alluxio.worker.readinessProbe\" -}}\n+readinessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"worker\"]\n+{{- end -}}\n+\n+{{- define \"alluxio.master.livenessProbe\" -}}\n+livenessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"master\"]\n+  initialDelaySeconds: 15\n+  periodSeconds: 30\n+  timeoutSeconds: 5\n+  failureThreshold: 2\n+{{- end -}}\n+\n+{{- define \"alluxio.worker.livenessProbe\" -}}\n+livenessProbe:\n+  exec:\n+    command: [\"bin/alluxio-monitor.sh\", \"worker\"]", "originalCommit": "601e05de6ff658ee4d0a1d5f6f9db0ee5b64ffb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4ODQ1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r388888457", "bodyText": "It's from the working dir which is specified by WORKDIR /opt/alluxio in the docker file.\nActually maybe it's better be command: [\"${ALLUXIO_HOME}/bin/alluxio-monitor.sh\", \"worker\"]", "author": "jiacheliu3", "createdAt": "2020-03-06T12:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1OTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODY1NA==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389348654", "bodyText": "you can use the command as alluxio-monitor.sh directly as in the docker file we add bin to the path ENV PATH=\"/opt/alluxio/bin:${PATH}\"", "author": "madanadit", "createdAt": "2020-03-08T08:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1OTc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODM4OA==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389348388", "bodyText": "why is this not the job worker probe?", "author": "madanadit", "createdAt": "2020-03-08T08:43:39Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/worker/daemonset.yaml", "diffHunk": "@@ -121,6 +123,8 @@ spec:\n           envFrom:\n           - configMapRef:\n               name: {{ template \"alluxio.fullname\" . }}-config\n+{{ include \"alluxio.worker.readinessProbe\" . | indent 10 }}", "originalCommit": "601e05de6ff658ee4d0a1d5f6f9db0ee5b64ffb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1NjI5MA==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389356290", "bodyText": "I think the criteria for readiness is the same for worker and job-worker now so i chose to use the same probes for them both. And thus the \"worker\" has the same meaning with the directory \"worker/\", meaning the worker pod.\nI can of course define the probes for worker and job-worker separately. But I don't think what we use for the probe will change, at least in the near future? What do you think? @madanadit", "author": "jiacheliu3", "createdAt": "2020-03-08T10:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM4MzI0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389383242", "bodyText": "@jiacheliu3 I don't get it. why is the criteria the same? the readiness / liveness probe is a per container concept not per pod. the probe for job worker should use alluxio-monitor.sh with arg job_worker to ping the job worker rpc?", "author": "madanadit", "createdAt": "2020-03-08T16:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM5MTQ0OA==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389391448", "bodyText": "Sorry I was mistaken. The probes should be different for worker and job-worker, namely alluxio-monitor.sh worker and alluxio-monitor.sh job_worker. This has been corrected.", "author": "jiacheliu3", "createdAt": "2020-03-08T17:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0ODQyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11080#discussion_r389348425", "bodyText": "why is this not the job master probe?", "author": "madanadit", "createdAt": "2020-03-08T08:44:02Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/master/statefulset.yaml", "diffHunk": "@@ -150,6 +152,8 @@ spec:\n           envFrom:\n           - configMapRef:\n               name: {{ $fullName }}-config\n+{{ include \"alluxio.master.readinessProbe\" . | indent 10 }}", "originalCommit": "601e05de6ff658ee4d0a1d5f6f9db0ee5b64ffb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5d9b63daec9c0b20d19ccdf79e3fce4f1269d743", "url": "https://github.com/Alluxio/alluxio/commit/5d9b63daec9c0b20d19ccdf79e3fce4f1269d743", "message": "add readiness probe", "committedDate": "2020-03-18T00:56:47Z", "type": "commit"}, {"oid": "33989f53bf0758899cf87810022af9f943556439", "url": "https://github.com/Alluxio/alluxio/commit/33989f53bf0758899cf87810022af9f943556439", "message": "add liveness probe", "committedDate": "2020-03-18T00:59:03Z", "type": "commit"}, {"oid": "54508b84e695c6a1e08b2fd7ca0f7755d6e70bfe", "url": "https://github.com/Alluxio/alluxio/commit/54508b84e695c6a1e08b2fd7ca0f7755d6e70bfe", "message": "changed readiness probe to alluxio-monitor.sh", "committedDate": "2020-03-18T00:59:03Z", "type": "commit"}, {"oid": "db82a38c83d54328eb41214d3bdd7d57c32f48e9", "url": "https://github.com/Alluxio/alluxio/commit/db82a38c83d54328eb41214d3bdd7d57c32f48e9", "message": "update cmd", "committedDate": "2020-03-18T00:59:04Z", "type": "commit"}, {"oid": "0d3c345d91d3125823f6a484ff4de26dd49fb474", "url": "https://github.com/Alluxio/alluxio/commit/0d3c345d91d3125823f6a484ff4de26dd49fb474", "message": "use job_master and job_worker probes", "committedDate": "2020-03-18T00:59:04Z", "type": "commit"}, {"oid": "0d3c345d91d3125823f6a484ff4de26dd49fb474", "url": "https://github.com/Alluxio/alluxio/commit/0d3c345d91d3125823f6a484ff4de26dd49fb474", "message": "use job_master and job_worker probes", "committedDate": "2020-03-18T00:59:04Z", "type": "forcePushed"}]}