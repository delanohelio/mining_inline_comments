{"pr_number": 12662, "pr_title": "Enable remote logging in k8s", "pr_createdAt": "2020-12-18T07:07:05Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12662", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1Njc5NA==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r545656794", "bodyText": "If this function is not in use anywhere else, then it can be removed and code can be simplified\n        resources:\n{{ toYaml .Values.logserver.resources | indent 10 }}", "author": "nirav-chotai", "createdAt": "2020-12-18T08:37:18Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/logging/deployment.yaml", "diffHunk": "@@ -0,0 +1,101 @@\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+{{ if .Values.logserver.enabled -}}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  name: {{ $fullName }}-logserver\n+  labels:\n+    name: {{ $fullName }}-logserver\n+    app: {{ $name }}\n+    chart: {{ $chart }}\n+    release: {{ .Release.Name }}\n+    heritage: {{ .Release.Service }}\n+    role: alluxio-logserver\n+spec:\n+  replicas: 1\n+  selector:\n+    matchLabels:\n+      app: {{ $name }}\n+      role: alluxio-logserver\n+      name: {{ $fullName }}-logserver\n+  template:\n+    metadata:\n+      labels:\n+        name: {{ $fullName }}-logserver\n+        app: {{ $name }}\n+        chart: {{ $chart }}\n+        release: {{ .Release.Name }}\n+        heritage: {{ .Release.Service }}\n+        role: alluxio-logserver\n+    spec:\n+      containers:\n+        - name: alluxio-logserver\n+          image: {{ .Values.image }}:{{ .Values.imageTag }}\n+          imagePullPolicy: {{ .Values.imagePullPolicy }}\n+          securityContext:\n+            runAsUser: {{ .Values.user }}\n+            runAsGroup: {{ .Values.group }}\n+          {{- if .Values.logserver.resources  }}\n+{{ include \"alluxio.logserver.resources\" . | indent 10 }}", "originalCommit": "eee923d98ca45932f33f34727daafccd7cf73989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ3Mzg0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r550473846", "bodyText": "IMO this makes the code shorter with fewer if-elses that break a future user's indentation. So I lean towards having a function.", "author": "jiacheliu3", "createdAt": "2020-12-31T12:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1Njc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMTU3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r545731577", "bodyText": "This function is really not needed.", "author": "nirav-chotai", "createdAt": "2020-12-18T10:10:38Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -119,6 +119,28 @@ resources:\n     {{- end }}\n {{- end -}}\n \n+{{- define \"alluxio.logserver.resources\" -}}", "originalCommit": "e1a13e944a47e2c2e491a61e10f0c3e79e87c690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r545733709", "bodyText": "What if I do not want to use any additional volume for logging as my ephermal storage is enough for my requirement, then I do not see any option here. I just want to run a remote logging server without any additional volume.", "author": "nirav-chotai", "createdAt": "2020-12-18T10:14:37Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -310,3 +310,47 @@ fuse:\n #     alluxio-hdfs-config: hdfsConfig\n #   worker: # Shared by worker and jobWorker containers\n #     alluxio-hdfs-config: hdfsConfig\n+\n+# Remote logging server\n+logserver:\n+  enabled: true\n+  replicas: 1\n+  env:\n+  # Extra environment variables for the logserver pod\n+  # Example:\n+  # JAVA_HOME: /opt/java\n+  args: # Arguments to Docker entrypoint\n+    - logserver\n+  # Properties for the logserver component\n+  properties:\n+  resources:\n+    # The default xmx is 8G\n+    limits:\n+      cpu: \"4\"\n+      memory: \"8G\"\n+    requests:\n+      cpu: \"1\"\n+      memory: \"1G\"\n+  ports:\n+    logging: 45600\n+  hostPID: false\n+  hostNetwork: false\n+  # dnsPolicy will be ClusterFirstWithHostNet if hostNetwork: true\n+  # and ClusterFirst if hostNetwork: false\n+  # You can specify dnsPolicy here to override this inference\n+  # dnsPolicy: ClusterFirst\n+  # JVM options specific to the logserver container\n+  jvmOptions:\n+  nodeSelector: {}\n+  # volumeType controls the type of log volume.\n+  # It can be \"persistentVolumeClaim\" or \"hostPath\"\n+  volumeType: persistentVolumeClaim\n+  size: 4Gi\n+  # Attributes to use if the log volume is PVC\n+  pvcName: alluxio-logserver-logs\n+  accessModes:\n+    - ReadWriteOnce\n+  storageClass: standard\n+  # Attributes to use if the log volume is hostPath\n+  hostPath: \"/tmp/alluxio-logs\" # The hostPath directory to use", "originalCommit": "e1a13e944a47e2c2e491a61e10f0c3e79e87c690", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczNzk4Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r545737982", "bodyText": "Could you elaborate a bit how you intend to provision your ephemeral storage for the logserver? In other words, i'm curious how much disk is given when you spawn a pod for the log server.\nIf you are thinking about test usages where provisioning a PV would be overhead or a user, does supporting emptyDir make sense here?", "author": "jiacheliu3", "createdAt": "2020-12-18T10:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc2NTQxOA==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r545765418", "bodyText": "@jiacheliu3 I was talking about not adding any volume at all. I just want to run logserver based on given memory (or may be spilling to disk) but not want to attach any volume for storing logs.\nspec.containers[].resources.limits.ephemeral-storage\nspec.containers[].resources.requests.ephemeral-storage\n\nRef: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#configurations-for-local-ephemeral-storage", "author": "nirav-chotai", "createdAt": "2020-12-18T11:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4MjQxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r546182411", "bodyText": "@nirav-chotai Sure you do have control to the ephemeral storage, but I wouldn't recommend it because I feel it contradicts (at least partly) with why we want a logserver. To me the benefits of a log server are:\n\nWe have a centralized location for logs\nWe hold the logs when pods die\n\nIf we have the logs on the logserver but never persist that, we can still lose the logs. The logserver may be evicted for whatever reason, and you lose the logs. In the helm chart, the recommended (default) config will force the users to create and use PVs in multiple places. That was intended because we want the users to think about persistence for things like journal and worker's tiered storage. The same idea would apply to logs.\nFrom that perspective, I guess my bottom line would be: it might be okay to allow using no volume at all, but that should be explicitly turned off. In other words, using a volume should be the default to be fool-proof.\nMaybe you have your considerations or your design on how to use the logserver in your architecture? What are the benefits for you to only use ephemeral storage for the log server?", "author": "jiacheliu3", "createdAt": "2020-12-19T03:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NDI1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r546184255", "bodyText": "Yes, you can enforce the default to have volume but there should be a way to use logserver without volume.\nMy use case, in dev like environments I would like to run separate logserver so that whenever I rollout my changes (frequent for dev), it will persist good amount of logs in the logserver (based on the capacity of the logserver pod) while recreating only master and worker pods. Production like environments I am pretty sure anyone would go for PVC only.\nIMO, anyone would try and test in dev first and if things work, then they configure PVC (not necessarily available in all environments) to meet production requirements.", "author": "nirav-chotai", "createdAt": "2020-12-19T03:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NDQyNw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r546184427", "bodyText": "And yes, your both points are valid even if I deploy logserver without volume\nWe have a centralized location for logs (yes)\nWe hold the logs when pods die (yes, logs will be there though master and workers pod die and re-created).", "author": "nirav-chotai", "createdAt": "2020-12-19T03:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ3MzQ5OA==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r550473498", "bodyText": "@nirav-chotai Sorry for the late reply. I get your point, not needing to specify a volume in a test env is a valid use case. I wonder how different to you is 1) do not have a volume vs 2) use emptyDir?", "author": "jiacheliu3", "createdAt": "2020-12-31T12:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ3NzMxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r550477315", "bodyText": "@nirav-chotai I can do as my last commit  to add a none option that creates no volume. But if emptyDir can just serve, I lean towards not adding another switch.", "author": "jiacheliu3", "createdAt": "2020-12-31T12:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ3ODM5Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r550478393", "bodyText": "I think I forgot to add emptyDir to the available options. Initially there was only pvc and hostPath. If there were only pvc and hostPath, I think it makes much sense to ask for sth that does need a volume like none. But if emptyDir is available, I think setting this option to emptyDir will serve your need.", "author": "jiacheliu3", "createdAt": "2020-12-31T12:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3MjYxMw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r552472613", "bodyText": "@jiacheliu3 Sorry, I was not available in the last few days. Yes, emptyDir will serve the need.", "author": "nirav-chotai", "createdAt": "2021-01-06T09:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjUyMTQ0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r552521443", "bodyText": "Cool, will remove option none", "author": "jiacheliu3", "createdAt": "2021-01-06T11:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzcwOQ=="}], "type": "inlineReview"}, {"oid": "6b953a6f40576b3205607547df89c8f3cc0ec284", "url": "https://github.com/Alluxio/alluxio/commit/6b953a6f40576b3205607547df89c8f3cc0ec284", "message": "format license", "committedDate": "2020-12-31T12:27:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg0NTk2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r550845963", "bodyText": "Comment is stale. And why are there 2 logserver commands?", "author": "madanadit", "createdAt": "2021-01-02T05:30:12Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -51,6 +51,7 @@ function printUsage {\n   echo -e \" proxy                        \\t Start Alluxio proxy\"\n   echo -e \" fuse [--fuse-opts=opt1,...]  \\t Start Alluxio FUSE file system, option --fuse-opts expects a list of fuse options separated by comma\"\n   echo -e \" logserver                    \\t Start Alluxio log server\"\n+  echo -e \" logserver [--fuse-opts=opt1,...]  \\t Start Alluxio FUSE file system, option --fuse-opts expects a list of fuse options separated by comma\"", "originalCommit": "272b55423681ed11bd64ed3ecd3991c9f00b333e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3NzAyNw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r552477027", "bodyText": "Where this is going to be used in the worker daemonset?", "author": "nirav-chotai", "createdAt": "2021-01-06T09:56:09Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/worker/daemonset.yaml", "diffHunk": "@@ -14,7 +14,7 @@\n {{- $hostNetwork := .Values.worker.hostNetwork }}\n {{- $hostPID := .Values.worker.hostPID }}\n {{- $fullName := include \"alluxio.fullname\" . }}\n-\n+{{- $logServerEnabled := .Values.logserver.enabled }}", "originalCommit": "0bda83eface068b4f3fc6225d0f5b03a48afa5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3OTg0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r552479842", "bodyText": "How this will work in the case of dynamic provisioning of distributed storage?\nWith Ceph, I do not provision PV as it will automatically be created. And if that automatically created PV does not have these labels, then it will not be bound to the PVC, right?", "author": "nirav-chotai", "createdAt": "2021-01-06T10:01:56Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/logserver/log-pvc.yaml", "diffHunk": "@@ -0,0 +1,39 @@\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+{{ $enabled := .Values.logserver.enabled -}}\n+{{ $needPVC := eq .Values.logserver.volumeType \"persistentVolumeClaim\" -}}\n+{{ if and .Values.logserver.enabled $needPVC -}}\n+apiVersion: v1\n+kind: PersistentVolumeClaim\n+metadata:\n+  name: {{ .Values.logserver.pvcName }}\n+  labels:\n+    app: {{ template \"alluxio.name\" . }}\n+    chart: {{ template \"alluxio.chart\" . }}\n+    release: {{ .Release.Name }}\n+    heritage: {{ .Release.Service }}\n+    role: alluxio-logserver\n+spec:\n+  volumeMode: Filesystem\n+  resources:\n+    requests:\n+      storage: {{ .Values.logserver.size }}\n+  storageClassName: {{ .Values.logserver.storageClass }}\n+  accessModes:\n+  {{ toYaml .Values.logserver.accessModes | trim | indent 4 }}\n+selector:", "originalCommit": "0bda83eface068b4f3fc6225d0f5b03a48afa5da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEyNzQyNg==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r553127426", "bodyText": "@jiacheliu3 , the above selectors, might fail in the case of Ceph PVC.", "author": "nirav-chotai", "createdAt": "2021-01-07T06:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3OTg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzcxOTMwMA==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r553719300", "bodyText": "@nirav-chotai That's a very good point.\nStatic (manual) provision\nIf we remove the matchLabels, it's harder to manage for users who are using static provisioning (manual). They may be creating a PV and that got mounted by undesired pods.\nDynamic provision\nI'm not sure if it is possible to request a PV with default labels to a storageClass. Is it possible in your environment? I don't find anything online so I guess not?\nIf by either having matchingLabels or not having it, we have a hard time satisfying some use cases, do you have a better option?\nAdding @madanadit to the discussion too.", "author": "jiacheliu3", "createdAt": "2021-01-08T03:20:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3OTg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2MjE1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r554662156", "bodyText": "@jiacheliu3 , below is an outcome of the current setup:\n...\nspec:\n  volumeMode: Filesystem\n  resources:\n    requests:\n      storage: 4Gi\n  storageClassName: standard\n  accessModes:\n    - ReadWriteOnce\n  selector:\n    matchLabels:\n      app: alluxio\n      release: myrelease\n      heritage: Helm\n      role: alluxio-logserver\n\nI would take care of both the scenarios with the below change:\nIn log-pvc.yaml:\n  {{- with .Values.logserver.pvc.selector }}\n  selector:\n    {{- toYaml . | nindent 4 }}\n  {{- end }}\n\nNow, for the scenario of static/manual provision, in values.yaml:\n# Remote logging server\nlogserver:\n  enabled: true\n  ...\n  pvc:\n    selector:\n      matchLabels:\n        role: alluxio-logserver\n        dc: mydatacenter\n        region: myregion\n\nThe outcome would be like this:\n...\nspec:\n  volumeMode: Filesystem\n  resources:\n    requests:\n      storage: 4Gi\n  storageClassName: standard\n  accessModes:\n      - ReadWriteOnce\n  selector:\n    matchLabels:\n      dc: mydatacenter\n      region: myregion\n      role: alluxio-logserver\n\nAnd, for the scenario of dynamic provision, in values.yaml:\n# Remote logging server\nlogserver:\n  enabled: true\n  ...\n  pvc:\n    selector: {}\n\nThe outcome would be like this:\n...\nspec:\n  volumeMode: Filesystem\n  resources:\n    requests:\n      storage: 4Gi\n  storageClassName: standard\n  accessModes:\n      - ReadWriteOnce", "author": "nirav-chotai", "createdAt": "2021-01-11T02:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3OTg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2NzMyNw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r554667327", "bodyText": "@nirav-chotai I'm actually working on the same as your suggestion. Will update the PR once I tested it :)", "author": "jiacheliu3", "createdAt": "2021-01-11T02:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ3OTg0Mg=="}], "type": "inlineReview"}, {"oid": "242821e0d428dfc2fff0d35ed2fd1ecd2476bdc0", "url": "https://github.com/Alluxio/alluxio/commit/242821e0d428dfc2fff0d35ed2fd1ecd2476bdc0", "message": "enabled logserver in k8s", "committedDate": "2021-01-12T03:24:43Z", "type": "commit"}, {"oid": "9af3d5d6849b1e55080326d6d94a7bbebf53165f", "url": "https://github.com/Alluxio/alluxio/commit/9af3d5d6849b1e55080326d6d94a7bbebf53165f", "message": "add volume for logserver", "committedDate": "2021-01-12T03:24:44Z", "type": "commit"}, {"oid": "0e99ff6b196a5d67e64517e18304caf15784123f", "url": "https://github.com/Alluxio/alluxio/commit/0e99ff6b196a5d67e64517e18304caf15784123f", "message": "missed pvc template", "committedDate": "2021-01-12T03:24:44Z", "type": "commit"}, {"oid": "0cb4b947a6fe288b447d02bb30e7bab55ac64b63", "url": "https://github.com/Alluxio/alluxio/commit/0cb4b947a6fe288b447d02bb30e7bab55ac64b63", "message": "format license", "committedDate": "2021-01-12T03:24:44Z", "type": "commit"}, {"oid": "8bc52878496081f2e1853ba26f8036f95e12e723", "url": "https://github.com/Alluxio/alluxio/commit/8bc52878496081f2e1853ba26f8036f95e12e723", "message": "enabled not using volume", "committedDate": "2021-01-12T03:24:44Z", "type": "commit"}, {"oid": "d3a4ae20147a3962d892b17f0734d0829038448d", "url": "https://github.com/Alluxio/alluxio/commit/d3a4ae20147a3962d892b17f0734d0829038448d", "message": "add emptyDir option", "committedDate": "2021-01-12T03:24:44Z", "type": "commit"}, {"oid": "9590a0e666045d456d71bc657a9eb93a0190a39f", "url": "https://github.com/Alluxio/alluxio/commit/9590a0e666045d456d71bc657a9eb93a0190a39f", "message": "bump up version", "committedDate": "2021-01-12T03:25:56Z", "type": "commit"}, {"oid": "cfab304e9fcfbdb5e6de203b58f6d492dd849485", "url": "https://github.com/Alluxio/alluxio/commit/cfab304e9fcfbdb5e6de203b58f6d492dd849485", "message": "small changes", "committedDate": "2021-01-12T03:25:56Z", "type": "commit"}, {"oid": "8d61a8997656325d3cfc56c63dcd1c3c1e7f3792", "url": "https://github.com/Alluxio/alluxio/commit/8d61a8997656325d3cfc56c63dcd1c3c1e7f3792", "message": "resolved some comments", "committedDate": "2021-01-12T03:25:56Z", "type": "commit"}, {"oid": "262fc8587a91864677e4301ca02e8707b2618b69", "url": "https://github.com/Alluxio/alluxio/commit/262fc8587a91864677e4301ca02e8707b2618b69", "message": "enable more flexible labeling on the PVC", "committedDate": "2021-01-12T03:26:33Z", "type": "commit"}, {"oid": "abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "url": "https://github.com/Alluxio/alluxio/commit/abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "message": "add env vars in the confimap", "committedDate": "2021-01-12T03:26:33Z", "type": "commit"}, {"oid": "abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "url": "https://github.com/Alluxio/alluxio/commit/abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "message": "add env vars in the confimap", "committedDate": "2021-01-12T03:26:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTUyMjA3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r555522079", "bodyText": "why does the logserver need master secrets?", "author": "madanadit", "createdAt": "2021-01-12T05:27:56Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/logserver/deployment.yaml", "diffHunk": "@@ -0,0 +1,106 @@\n+#\n+# The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+# (the \"License\"). You may not use this work except in compliance with the License, which is\n+# available at www.apache.org/licenses/LICENSE-2.0\n+#\n+# This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+# either express or implied, as more fully set forth in the License.\n+#\n+# See the NOTICE file distributed with this work for information regarding copyright ownership.\n+#\n+\n+{{ if .Values.logserver.enabled -}}\n+{{- $name := include \"alluxio.name\" . }}\n+{{- $fullName := include \"alluxio.fullname\" . }}\n+{{- $chart := include \"alluxio.chart\" . }}\n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  name: {{ $fullName }}-logserver\n+  labels:\n+    name: {{ $fullName }}-logserver\n+    app: {{ $name }}\n+    chart: {{ $chart }}\n+    release: {{ .Release.Name }}\n+    heritage: {{ .Release.Service }}\n+    role: alluxio-logserver\n+spec:\n+  replicas: 1\n+  selector:\n+    matchLabels:\n+      app: {{ $name }}\n+      role: alluxio-logserver\n+      name: {{ $fullName }}-logserver\n+  template:\n+    metadata:\n+      labels:\n+        name: {{ $fullName }}-logserver\n+        app: {{ $name }}\n+        chart: {{ $chart }}\n+        release: {{ .Release.Name }}\n+        heritage: {{ .Release.Service }}\n+        role: alluxio-logserver\n+    spec:\n+      containers:\n+        - name: alluxio-logserver\n+          image: {{ .Values.image }}:{{ .Values.imageTag }}\n+          imagePullPolicy: {{ .Values.imagePullPolicy }}\n+          securityContext:\n+            runAsUser: {{ .Values.user }}\n+            runAsGroup: {{ .Values.group }}\n+          {{- if .Values.logserver.resources  }}\n+{{ include \"alluxio.logserver.resources\" . | indent 10 }}\n+          {{- end }}\n+          command: [\"tini\", \"--\", \"/entrypoint.sh\"]\n+            {{- if .Values.logserver.args }}\n+          args:\n+{{ toYaml .Values.logserver.args | trim | indent 12 }}\n+            {{- end }}\n+          env:\n+            {{- range $key, $value := .Values.logserver.env }}\n+          - name: \"{{ $key }}\"\n+            value: \"{{ $value }}\"\n+            {{- end }}\n+          envFrom:\n+          - configMapRef:\n+              name: {{ $fullName }}-config\n+          ports:\n+          - containerPort: {{ .Values.logserver.ports.logging }}\n+            name: logging\n+          volumeMounts:\n+            {{- if not (eq .Values.logserver.volumeType \"none\") }}\n+          - name: alluxio-logs\n+            mountPath: /opt/alluxio/logs\n+            {{- end }}\n+            {{- if .Values.secrets }}\n+              {{- if .Values.secrets.logserver }}\n+            {{- include \"alluxio.master.secretVolumeMounts\" . }}", "originalCommit": "abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIwOTE0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r556209143", "bodyText": "Oops, should be logserver secrets", "author": "jiacheliu3", "createdAt": "2021-01-13T01:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTUyMjA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU1Mjk3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r555552973", "bodyText": "Where this is being used?", "author": "nirav-chotai", "createdAt": "2021-01-12T07:06:16Z", "path": "integration/kubernetes/helm-chart/alluxio/templates/_helpers.tpl", "diffHunk": "@@ -333,3 +355,34 @@ livenessProbe:\n   timeoutSeconds: 5\n   failureThreshold: 2\n {{- end -}}\n+\n+{{- define \"alluxio.logserver.log.volume\" -}}\n+{{- if eq .Values.logserver.volumeType \"hostPath\" }}\n+- name: alluxio-logs\n+  hostPath:\n+    path: {{ .Values.logserver.hostPath }}\n+    type: DirectoryOrCreate\n+{{- else if eq .Values.logserver.volumeType \"emptyDir\" }}\n+- name: alluxio-logs\n+  emptyDir:\n+    medium: {{ .Values.logserver.medium }}\n+    sizeLimit: {{ .Values.logserver.size | quote }}\n+{{- else }}\n+- name: alluxio-logs\n+  persistentVolumeClaim:\n+    claimName: \"{{ .Values.logserver.pvcName }}\"\n+{{- end }}\n+{{- end -}}\n+\n+{{- define \"alluxio.logserver.pvc.selector\" -}}", "originalCommit": "abbf34c62ba2cd25d8f8b40e9501ef6f2d3f36ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8560855f710c05074ad0e31a723135e75bc4be1b", "url": "https://github.com/Alluxio/alluxio/commit/8560855f710c05074ad0e31a723135e75bc4be1b", "message": "resolve comments", "committedDate": "2021-01-13T01:44:08Z", "type": "commit"}, {"oid": "cd0092105fb59c77d6e2b4c62258d68e08d0a46d", "url": "https://github.com/Alluxio/alluxio/commit/cd0092105fb59c77d6e2b4c62258d68e08d0a46d", "message": "better comment", "committedDate": "2021-01-13T01:45:57Z", "type": "commit"}, {"oid": "9662051cc8f8675b92e1af5c32424de756d5deff", "url": "https://github.com/Alluxio/alluxio/commit/9662051cc8f8675b92e1af5c32424de756d5deff", "message": "update docs", "committedDate": "2021-01-13T03:23:01Z", "type": "commit"}, {"oid": "7b4c6dd0731ac972257c1b2c2029f56e432347b6", "url": "https://github.com/Alluxio/alluxio/commit/7b4c6dd0731ac972257c1b2c2029f56e432347b6", "message": "add the directory to path", "committedDate": "2021-01-13T03:25:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIzOTc2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r556239765", "bodyText": "Not sure if there's a better example", "author": "jiacheliu3", "createdAt": "2021-01-13T03:26:57Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -313,6 +313,8 @@ fuse:\n #     alluxio-hdfs-config: hdfsConfig\n #   worker: # Shared by worker and jobWorker containers\n #     alluxio-hdfs-config: hdfsConfig\n+#   logserver: # Used by the logserver container\n+#     alluxio-hdfs-config: hdfsConfig", "originalCommit": "9662051cc8f8675b92e1af5c32424de756d5deff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjMxMzQ2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12662#discussion_r556313469", "bodyText": "logserver doesn't need to talk to hdfs so the hdfs secret is not required, but his placeholder is fine", "author": "madanadit", "createdAt": "2021-01-13T07:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIzOTc2NQ=="}], "type": "inlineReview"}]}