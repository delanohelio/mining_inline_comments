{"pr_number": 10865, "pr_title": "Enable parallel udb sync", "pr_createdAt": "2020-02-07T01:05:04Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10865", "timeline": [{"oid": "0f19a11dafbb0abbd79c213e0d8c314d81b1c3e4", "url": "https://github.com/Alluxio/alluxio/commit/0f19a11dafbb0abbd79c213e0d8c314d81b1c3e4", "message": "Enable parallel udb sync", "committedDate": "2020-02-07T01:03:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3MDEzNA==", "url": "https://github.com/Alluxio/alluxio/pull/10865#discussion_r376170134", "bodyText": "this ExecutorService is not used?", "author": "yuzhu", "createdAt": "2020-02-07T01:17:25Z", "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -177,31 +182,46 @@ public Table createTable(String tableName, Schema schema) {\n    * external synchronization.\n    *\n    * @param context journal context\n-   * @return true if the database changed as a result of fullSync\n+   * @param service executor service for parallezing the sync\n+   * @return true if the database changed as a result of syncing with UDB\n    */\n-  public boolean sync(JournalContext context) throws IOException {\n-    boolean updated = false;\n+  public boolean sync(JournalContext context, ExecutorService service) throws IOException {", "originalCommit": "0f19a11dafbb0abbd79c213e0d8c314d81b1c3e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwOTQzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10865#discussion_r376509435", "bodyText": "ooops, I forgot to update invokeAll. Thanks!", "author": "gpang", "createdAt": "2020-02-07T17:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3MDEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NDc5Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10865#discussion_r376174793", "bodyText": "do you think 16 may be too high a number? we are assuming there will be at least 16 concurrent udb connections?", "author": "yuzhu", "createdAt": "2020-02-07T01:36:48Z", "path": "table/server/underdb/hive/src/main/java/alluxio/table/under/hive/util/HiveClientPool.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.table.under.hive.util;\n+\n+import alluxio.Constants;\n+import alluxio.resource.CloseableResource;\n+import alluxio.resource.DynamicResourcePool;\n+import alluxio.util.ThreadFactoryUtils;\n+\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.metastore.HiveMetaHookLoader;\n+import org.apache.hadoop.hive.metastore.HiveMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.RetryingMetaStoreClient;\n+import org.apache.hadoop.hive.metastore.api.NoSuchObjectException;\n+import org.apache.thrift.TException;\n+\n+import java.io.IOException;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * A pool for hive clients, since hive clients are not thread safe.\n+ */\n+@ThreadSafe\n+public final class HiveClientPool extends DynamicResourcePool<IMetaStoreClient> {\n+  private static final ScheduledExecutorService GC_EXECUTOR =\n+      new ScheduledThreadPoolExecutor(1, ThreadFactoryUtils.build(\"HiveClientPool-GC-%d\", true));\n+  private static final HiveMetaHookLoader NOOP_HOOK = table -> null;\n+\n+  private final long mGcThresholdMs;\n+  private final String mConnectionUri;\n+  private final String mHiveDbName;\n+  /** This tracks if the db exists in HMS. */\n+  private volatile boolean mDbExists = false;\n+\n+  /**\n+   * Creates a new hive client client pool.\n+   *\n+   * @param connectionUri the connect uri for the hive metastore\n+   * @param hiveDbName the db name in hive\n+   */\n+  public HiveClientPool(String connectionUri, String hiveDbName) {\n+    super(Options.defaultOptions()\n+        .setMinCapacity(16)", "originalCommit": "0f19a11dafbb0abbd79c213e0d8c314d81b1c3e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUxMDM1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10865#discussion_r376510357", "bodyText": "In a way, yes. If a database has more than 16 tables, it would easily need more concurrent hive clients. For example, tpcds has over 20 tables.", "author": "gpang", "createdAt": "2020-02-07T17:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NDc5Mw=="}], "type": "inlineReview"}, {"oid": "5d08871d4df5c79b1a32f6d1933dd4d1b91d57c9", "url": "https://github.com/Alluxio/alluxio/commit/5d08871d4df5c79b1a32f6d1933dd4d1b91d57c9", "message": "Use own service for invokeAll", "committedDate": "2020-02-07T17:31:52Z", "type": "commit"}]}