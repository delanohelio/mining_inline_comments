{"pr_number": 11210, "pr_title": "Implement LFU evictor for client cache", "pr_createdAt": "2020-03-25T18:39:18Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11210", "timeline": [{"oid": "a5acbe886475386cbf5be32c09d35b7d06616dcb", "url": "https://github.com/Alluxio/alluxio/commit/a5acbe886475386cbf5be32c09d35b7d06616dcb", "message": "implement LFU evictor for client cache", "committedDate": "2020-03-25T00:07:46Z", "type": "commit"}, {"oid": "5932fab0838aaf2ec3a6a7d3c38b7caf38e8c927", "url": "https://github.com/Alluxio/alluxio/commit/5932fab0838aaf2ec3a6a7d3c38b7caf38e8c927", "message": "Make log base configurable", "committedDate": "2020-03-25T23:39:46Z", "type": "commit"}, {"oid": "a6e7db50a177aeda497855023587bab1c3f1339b", "url": "https://github.com/Alluxio/alluxio/commit/a6e7db50a177aeda497855023587bab1c3f1339b", "message": "fix indentation", "committedDate": "2020-03-26T06:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2OTgyOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11210#discussion_r398769829", "bodyText": "nit: save Math.log(mLogBase)) as a constant since we need this frequently?", "author": "apc999", "createdAt": "2020-03-26T17:46:17Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/evictor/LFUCacheEvictor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache.evictor;\n+\n+import alluxio.client.file.cache.CacheEvictor;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.AlluxioConfiguration;\n+import alluxio.conf.PropertyKey;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * LFU client-side cache eviction policy.\n+ */\n+@ThreadSafe\n+public class LFUCacheEvictor implements CacheEvictor {\n+  private static final int PAGE_MAP_INIT_CAPACITY = 200;\n+  private static final float PAGE_MAP_INIT_LOAD_FACTOR = 0.75f;\n+  private static final int BUCKET_MAP_INIT_CAPACITY = 32;\n+  private static final float BUCKET_MAP_INIT_LOAD_FACTOR = 0.75f;\n+\n+  private final Map<PageId, Integer> mPageMap = new HashMap<>(\n+      PAGE_MAP_INIT_CAPACITY, PAGE_MAP_INIT_LOAD_FACTOR);\n+\n+  private final Map<Integer, Set<PageId>> mBucketMap =\n+      new HashMap<>(BUCKET_MAP_INIT_CAPACITY, BUCKET_MAP_INIT_LOAD_FACTOR);\n+  private int mMinBucket = -1;\n+  private final double mLogBase;\n+\n+  /**\n+   * Required constructor.\n+   *\n+   * @param conf Alluxio configuration\n+   */\n+  public LFUCacheEvictor(AlluxioConfiguration conf) {\n+    mLogBase = conf.getDouble(PropertyKey.USER_CLIENT_CACHE_EVICTOR_LFU_LOGBASE);\n+  }\n+\n+  private int getBucket(int count) {\n+    return (int) (Math.log(count) / Math.log(mLogBase));", "originalCommit": "a6e7db50a177aeda497855023587bab1c3f1339b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MTY0MA==", "url": "https://github.com/Alluxio/alluxio/pull/11210#discussion_r398961640", "bodyText": "Good idea! Updated.", "author": "bf8086", "createdAt": "2020-03-27T00:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2OTgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4NjQwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11210#discussion_r398786409", "bodyText": "If we change LinkedHashSet to LinkedHashMap with access order (check LRUCacheEvictor), don't we have a LRU bucket in that case? @calvinjia", "author": "apc999", "createdAt": "2020-03-26T18:09:03Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/evictor/LFUCacheEvictor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache.evictor;\n+\n+import alluxio.client.file.cache.CacheEvictor;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.AlluxioConfiguration;\n+import alluxio.conf.PropertyKey;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * LFU client-side cache eviction policy.\n+ */\n+@ThreadSafe\n+public class LFUCacheEvictor implements CacheEvictor {\n+  private static final int PAGE_MAP_INIT_CAPACITY = 200;\n+  private static final float PAGE_MAP_INIT_LOAD_FACTOR = 0.75f;\n+  private static final int BUCKET_MAP_INIT_CAPACITY = 32;\n+  private static final float BUCKET_MAP_INIT_LOAD_FACTOR = 0.75f;\n+\n+  private final Map<PageId, Integer> mPageMap = new HashMap<>(\n+      PAGE_MAP_INIT_CAPACITY, PAGE_MAP_INIT_LOAD_FACTOR);\n+\n+  private final Map<Integer, Set<PageId>> mBucketMap =\n+      new HashMap<>(BUCKET_MAP_INIT_CAPACITY, BUCKET_MAP_INIT_LOAD_FACTOR);\n+  private int mMinBucket = -1;\n+  private final double mLogBase;\n+\n+  /**\n+   * Required constructor.\n+   *\n+   * @param conf Alluxio configuration\n+   */\n+  public LFUCacheEvictor(AlluxioConfiguration conf) {\n+    mLogBase = conf.getDouble(PropertyKey.USER_CLIENT_CACHE_EVICTOR_LFU_LOGBASE);\n+  }\n+\n+  private int getBucket(int count) {\n+    return (int) (Math.log(count) / Math.log(mLogBase));\n+  }\n+\n+  private void addPageToBucket(PageId pageId, int bucket) {\n+    mBucketMap.compute(bucket, (bucketKey, pageSet) -> {\n+      Set<PageId> set = pageSet == null ? new LinkedHashSet<>() : pageSet;", "originalCommit": "a6e7db50a177aeda497855023587bab1c3f1339b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MTUxNw==", "url": "https://github.com/Alluxio/alluxio/pull/11210#discussion_r398961517", "bodyText": "Done.", "author": "bf8086", "createdAt": "2020-03-26T23:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4NjQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgwODU2Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11210#discussion_r398808566", "bodyText": "oops", "author": "apc999", "createdAt": "2020-03-26T18:43:26Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/evictor/LRUCacheEvictor.java", "diffHunk": "@@ -36,6 +37,14 @@\n       Collections.synchronizedMap(new LinkedHashMap<>(LINKED_HASH_MAP_INIT_CAPACITY,\n           LINKED_HASH_MAP_INIT_LOAD_FACTOR, LINKED_HASH_MAP_ACCESS_ORDERED));\n \n+  /**\n+   * Required constructor.\n+   *\n+   * @param conf Alluxio configuration\n+   */\n+  public LRUCacheEvictor(AlluxioConfiguration conf) {", "originalCommit": "a6e7db50a177aeda497855023587bab1c3f1339b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dce3058f3cfda59eb4be771f36bd2e5bf97b5388", "url": "https://github.com/Alluxio/alluxio/commit/dce3058f3cfda59eb4be771f36bd2e5bf97b5388", "message": "use LRU in-bucket order", "committedDate": "2020-03-26T23:59:16Z", "type": "commit"}, {"oid": "5e48bcbc7da159ecffab66ae73f2feffb2532180", "url": "https://github.com/Alluxio/alluxio/commit/5e48bcbc7da159ecffab66ae73f2feffb2532180", "message": "add logging", "committedDate": "2020-03-27T22:34:52Z", "type": "commit"}, {"oid": "62d811b937eb97886d5478428273d5538af68b0b", "url": "https://github.com/Alluxio/alluxio/commit/62d811b937eb97886d5478428273d5538af68b0b", "message": "fix checkstyles", "committedDate": "2020-03-27T23:10:46Z", "type": "commit"}]}