{"pr_number": 12652, "pr_title": "Support Authorization and add ListAllMyBuckets for S3 Rest Api", "pr_createdAt": "2020-12-16T01:04:39Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12652", "timeline": [{"oid": "62823f632446e3786c819fe7ea9200f2c4e865e7", "url": "https://github.com/Alluxio/alluxio/commit/62823f632446e3786c819fe7ea9200f2c4e865e7", "message": "Authorization + ListAllMyBuckets for S3 Rest Api", "committedDate": "2020-12-16T01:03:05Z", "type": "commit"}, {"oid": "284658f9afc57ab6263cd5cf04e4facadec62d3b", "url": "https://github.com/Alluxio/alluxio/commit/284658f9afc57ab6263cd5cf04e4facadec62d3b", "message": "Remove log", "committedDate": "2020-12-16T01:10:29Z", "type": "commit"}, {"oid": "a2431b7d89180e922dafb2c7b7006c82d6828f09", "url": "https://github.com/Alluxio/alluxio/commit/a2431b7d89180e922dafb2c7b7006c82d6828f09", "message": "Fix checkstyle", "committedDate": "2020-12-16T18:31:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NDY0OA==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r544644648", "bodyText": "Can we make this not private, and then add a unittest for this method?", "author": "gpang", "createdAt": "2020-12-16T21:44:31Z", "path": "core/server/proxy/src/main/java/alluxio/proxy/s3/S3RestServiceHandler.java", "diffHunk": "@@ -99,6 +104,56 @@ public S3RestServiceHandler(@Context ServletContext context) {\n         (FileSystem) context.getAttribute(ProxyWebServer.FILE_SYSTEM_SERVLET_RESOURCE_KEY);\n   }\n \n+  private static String getUserFromAuthorization(String authorization) {", "originalCommit": "a2431b7d89180e922dafb2c7b7006c82d6828f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5OTU5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r544699597", "bodyText": "There is a general lack of unit tests for most methods here.. That is partially because I don't have a good understanding of the full API spec quite yet and I plan to add them later as I implement more and have a better understanding of the spec.", "author": "bradyoo", "createdAt": "2020-12-16T23:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NDY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNjQ0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r545336442", "bodyText": "Ok, as long as we don't forget to add the coverage soon.", "author": "gpang", "createdAt": "2020-12-17T19:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NDY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NTQzMw==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r544645433", "bodyText": "What exactly is the concept of a bucket in the Alluxio proxy?", "author": "gpang", "createdAt": "2020-12-16T21:45:51Z", "path": "core/server/proxy/src/main/java/alluxio/proxy/s3/S3RestServiceHandler.java", "diffHunk": "@@ -99,6 +104,56 @@ public S3RestServiceHandler(@Context ServletContext context) {\n         (FileSystem) context.getAttribute(ProxyWebServer.FILE_SYSTEM_SERVLET_RESOURCE_KEY);\n   }\n \n+  private static String getUserFromAuthorization(String authorization) {\n+    if (authorization == null) {\n+      return \"\";\n+    }\n+\n+    // The valid pattern for Authorization is \"AWS <AWSAccessKeyId>:<Singature>\"\n+    int spaceIndex = authorization.indexOf(' ');\n+    if (spaceIndex == -1) {\n+      return \"\";\n+    }\n+    String stripped = authorization.substring(spaceIndex + 1);\n+\n+    int colonIndex = stripped.indexOf(':');\n+    if (colonIndex == -1) {\n+      return \"\";\n+    }\n+\n+    return stripped.substring(0, colonIndex);\n+  }\n+\n+  /**\n+   * @summary lists all buckets owned by you\n+   * @param authorization header parameter authorization\n+   * @return the response object\n+   */\n+  @GET\n+  @Path(\"/\")\n+  public Response listAllMyBuckets(@HeaderParam(\"Authorization\") String authorization) {\n+\n+    return S3RestUtils.call(\"\", new S3RestUtils.RestCallable<ListAllMyBucketsResult>() {\n+      @Override\n+      public ListAllMyBucketsResult call() throws S3Exception {\n+        String user = getUserFromAuthorization(authorization);\n+\n+        List<URIStatus> objects;\n+        try {\n+          objects = mFileSystem.listStatus(new AlluxioURI(\"/\"));", "originalCommit": "a2431b7d89180e922dafb2c7b7006c82d6828f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwMDA0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r544700043", "bodyText": "Bucket in the concept of alluxio is the folders in the root mount (/). This means that if there are files at root (/), there will be no way to view it using the S3 API.", "author": "bradyoo", "createdAt": "2020-12-16T23:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NTQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNzU3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12652#discussion_r545337576", "bodyText": "We may need to update the behavior in the future.\nAnother possibility is that we always have a \"root\" bucket which just holds the files under root, and the directories under root are just separate buckets.\nIn any case, I don't think there is a clear spec for this currently, so we may have to be flexible in the future.", "author": "gpang", "createdAt": "2020-12-17T19:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NTQzMw=="}], "type": "inlineReview"}]}