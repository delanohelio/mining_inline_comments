{"pr_number": 11376, "pr_title": "Improve PR build by inspecting PR diff", "pr_createdAt": "2020-05-03T10:53:40Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11376", "timeline": [{"oid": "b55ba79efae5345a3d317994a8228625d8255f64", "url": "https://github.com/Alluxio/alluxio/commit/b55ba79efae5345a3d317994a8228625d8255f64", "message": "Improve PR build by inspecting PR diff", "committedDate": "2020-05-03T10:43:49Z", "type": "commit"}, {"oid": "a2cbded6e2fa535cc81d6431851dc4c7af0b12bc", "url": "https://github.com/Alluxio/alluxio/commit/a2cbded6e2fa535cc81d6431851dc4c7af0b12bc", "message": "set -x in build scripts", "committedDate": "2020-05-03T11:53:15Z", "type": "commit"}, {"oid": "a89320d23327019871e4470c030410566ad2fadf", "url": "https://github.com/Alluxio/alluxio/commit/a89320d23327019871e4470c030410566ad2fadf", "message": "use refs/remotes/ prefix for diff target", "committedDate": "2020-05-04T08:49:35Z", "type": "commit"}, {"oid": "67c101874f9c052e8f83ee2304c851ff586b7b0e", "url": "https://github.com/Alluxio/alluxio/commit/67c101874f9c052e8f83ee2304c851ff586b7b0e", "message": "debug cuz i think it should be working...", "committedDate": "2020-05-04T09:20:13Z", "type": "commit"}, {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "url": "https://github.com/Alluxio/alluxio/commit/ebd4fc28e25bc7c5355841e503d4877b7520b50d", "message": "remove debug lines", "committedDate": "2020-05-04T09:51:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3NzU0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419677543", "bodyText": "what about the case where there is no diff, and we simply want to generate the jacoco report?", "author": "ZacBlanco", "createdAt": "2020-05-04T19:33:43Z", "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then\n+      # if any file starts with \"docs/\", run doc check\n+      RUN_DOC_CHECK=\"true\"\n+    else\n+      # if any other files are in the diff, run maven\n+      RUN_MAVEN=\"true\"", "originalCommit": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MjkzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419682931", "bodyText": "before checking for TARGET_BRANCH, i could add a\nif [ -z \"${ALLUXIO_SONAR_ARGS}\"  ]; then\n  RUN_MAVEN=\"true\"\nfi\n\n== if the sonar args are provided, then force run maven", "author": "Xenorith", "createdAt": "2020-05-04T19:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3NzU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDMwNw==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419700307", "bodyText": "I think that's reasonable", "author": "ZacBlanco", "createdAt": "2020-05-04T20:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3NzU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDk1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419700957", "bodyText": "@gpang might have an opinion on a better way though?", "author": "ZacBlanco", "createdAt": "2020-05-04T20:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3NzU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3Nzg3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419677873", "bodyText": "similarly, if there's no files in the diff and we just want to generate sonar reports, how will we do that now?", "author": "ZacBlanco", "createdAt": "2020-05-04T19:34:16Z", "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then\n+      # if any file starts with \"docs/\", run doc check\n+      RUN_DOC_CHECK=\"true\"\n+    else\n+      # if any other files are in the diff, run maven\n+      RUN_MAVEN=\"true\"\n+    fi\n+  done < prFiles.diff\n+  rm prFiles.diff\n fi\n \n-./dev/scripts/check-docs.sh\n+if [ \"$RUN_MAVEN\" == \"true\" ]; then\n+  # Set things up so that the current user has a real name and can authenticate.\n+  myuid=$(id -u)\n+  mygid=$(id -g)\n+  echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n+\n+  export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n+\n+  if [ -z \"${ALLUXIO_BUILD_FORKCOUNT}\" ]\n+  then\n+    ALLUXIO_BUILD_FORKCOUNT=4\n+  fi\n+\n+  mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n+\n+  if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n+  then\n+    # A separate step to run jacoco report, with all the generated coverage data. This requires the\n+    # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n+    #\n+    # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n+    # since these modules do not contain any source code to track for code coverage.\n+    mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n+    # run sonar analysis\n+    mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+  fi", "originalCommit": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0Mzg1OA==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419743858", "bodyText": "@ZacBlanco i think this check addresses the scenario for the master builds. if this script isn't invoked by the PR build, this env var won't be set => defaults to running everything", "author": "Xenorith", "createdAt": "2020-05-04T21:36:33Z", "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks", "originalCommit": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0OTc3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419749775", "bodyText": "got it, thanks!", "author": "ZacBlanco", "createdAt": "2020-05-04T21:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0Mzg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MTkyNg==", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419761926", "bodyText": "@Xenorith the following under integration also do not require a maven build: dataproc, docker, emr, kuberneres, vagrant", "author": "madanadit", "createdAt": "2020-05-04T22:17:19Z", "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then", "originalCommit": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e59bd26c1a08dd7482bd5dfabe0e8ce4855aad42", "url": "https://github.com/Alluxio/alluxio/commit/e59bd26c1a08dd7482bd5dfabe0e8ce4855aad42", "message": "exclude some integration folders from check", "committedDate": "2020-05-04T22:33:33Z", "type": "commit"}, {"oid": "a75a936443136353078b20888bd5a72bfff9a01e", "url": "https://github.com/Alluxio/alluxio/commit/a75a936443136353078b20888bd5a72bfff9a01e", "message": "force run all checks if modifying dev/", "committedDate": "2020-05-04T23:50:13Z", "type": "commit"}, {"oid": "8be529693ea65a5de3fd13a330ec8182d1452c67", "url": "https://github.com/Alluxio/alluxio/commit/8be529693ea65a5de3fd13a330ec8182d1452c67", "message": "woops", "committedDate": "2020-05-04T23:55:11Z", "type": "commit"}]}