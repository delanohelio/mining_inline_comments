{"pr_number": 11247, "pr_title": "Improve locality tier documentation", "pr_createdAt": "2020-04-07T23:00:09Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11247", "timeline": [{"oid": "559aa0bcf3bbc427568e2b5d4b4126100a57e485", "url": "https://github.com/Alluxio/alluxio/commit/559aa0bcf3bbc427568e2b5d4b4126100a57e485", "message": "Improve locality tier documentation", "committedDate": "2020-04-07T22:59:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2Mjg0MA==", "url": "https://github.com/Alluxio/alluxio/pull/11247#discussion_r405162840", "bodyText": "duplicated", "author": "apc999", "createdAt": "2020-04-07T23:00:30Z", "path": "docs/en/operation/Tiered-Locality.md", "diffHunk": "@@ -136,28 +159,3 @@ sources, from highest to lowest priority:\n `alluxio.user.hostname` on a client in their respective `alluxio-site.properties`\n \n 1. If none of the above are configured, node locality is determined by hostname lookup\n-\n-### When exactly is tiered locality used?\n-\n-1. When clients choose which worker to read through during UFS reads\n-1. When clients choose which worker to read from when multiple Alluxio workers hold a block\n-1. If using the `LocalFirstPolicy` or `LocalFirstAvoidEvictionPolicy`, clients use tiered locality\n-to choose which worker to write to when writing data to Alluxio\n-\n-## Custom locality tiers", "originalCommit": "559aa0bcf3bbc427568e2b5d4b4126100a57e485", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyMDk5NA==", "url": "https://github.com/Alluxio/alluxio/pull/11247#discussion_r405220994", "bodyText": "people don't know what this setting is yet at this point. recommend mentioning this in the next section when you first define what alluxio.locality.script is", "author": "Xenorith", "createdAt": "2020-04-08T02:22:24Z", "path": "docs/en/operation/Tiered-Locality.md", "diffHunk": "@@ -93,18 +91,43 @@ If other locality tiers are left unset, they will not be used to inform locality\n \n ### Setting locality\n \n-#### Locality script\n+#### Option A: shell script\n \n By default, Alluxio clients and servers search the classpath for a script named\n-`alluxio-locality.sh`.\n-Output format of this script is a comma-separated list of tierName=tierValue pairs.\n-The script name can be overridden by setting:\n+`alluxio-locality.sh` (can be overridden by setting `alluxio.locality.script`).", "originalCommit": "559aa0bcf3bbc427568e2b5d4b4126100a57e485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNDY1NA==", "url": "https://github.com/Alluxio/alluxio/pull/11247#discussion_r405724654", "bodyText": "done", "author": "apc999", "createdAt": "2020-04-08T18:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyMDk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyMTgzNg==", "url": "https://github.com/Alluxio/alluxio/pull/11247#discussion_r405221836", "bodyText": "Using the locality shell script is the preferred way to configure tiered locality over configuration properties because...", "author": "Xenorith", "createdAt": "2020-04-08T02:25:31Z", "path": "docs/en/operation/Tiered-Locality.md", "diffHunk": "@@ -93,18 +91,43 @@ If other locality tiers are left unset, they will not be used to inform locality\n \n ### Setting locality\n \n-#### Locality script\n+#### Option A: shell script\n \n By default, Alluxio clients and servers search the classpath for a script named\n-`alluxio-locality.sh`.\n-Output format of this script is a comma-separated list of tierName=tierValue pairs.\n-The script name can be overridden by setting:\n+`alluxio-locality.sh` (can be overridden by setting `alluxio.locality.script`).\n+Output format of this script is a comma-separated list of `tierName=tierValue` pairs.\n+For example, suppose Alluxio workers are spread across multiple availability zones within EC2.\n+To configure tiered locality with availability zones:\n \n-```\n-alluxio.locality.script=locality_script_name\n+1. On the Alluxio master(s), set `alluxio.locality.order=node,availability_zone` to define the order\n+   of locality tiers to prefer `node` over `availability_zone`.\n+\n+1. Create script `alluxio-locality.sh` to determine the tiered identity for each entity.\n+   The output format is a comma-separated list of `tierName=tierValue` pairs.\n+   ```bash\n+   #!/usr/bin/env bash\n+\n+   node=$(hostname)\n+   # Ask EC2 which availability zone we're in\n+   availability_zone=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n+\n+   echo \"node=${node},availability_zone=${availability_zone}\"\n+   ```\n+\n+1. Make the script executable with `chmod +x alluxio-locality.sh`.\n+\n+1. Include the script on the classpath of your applications and Alluxio servers.\n+For servers, put the file in the `${ALLUXIO_HOME}/conf/` directory.\n+\n+1. Restart Alluxio servers to pick up the configuration changes.\n+\n+A log entry should appear of the format:\n+\n+```log\n+INFO  TieredIdentityFactory - Initialized tiered identity TieredIdentity(node=ip-xx-xx-xx-xx, availability_zone=us-east-1)\n ```\n \n-#### Configuration properties\n+#### Option B: configuration properties\n \n Using locality script is the preferred way to configure tiered locality", "originalCommit": "559aa0bcf3bbc427568e2b5d4b4126100a57e485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNTU5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11247#discussion_r405725599", "bodyText": "done", "author": "apc999", "createdAt": "2020-04-08T18:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyMTgzNg=="}], "type": "inlineReview"}, {"oid": "2750a704ec7176ee1290739338e377e37dd82a78", "url": "https://github.com/Alluxio/alluxio/commit/2750a704ec7176ee1290739338e377e37dd82a78", "message": "Address comments", "committedDate": "2020-04-08T18:26:53Z", "type": "commit"}]}