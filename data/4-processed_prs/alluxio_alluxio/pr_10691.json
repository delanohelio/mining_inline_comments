{"pr_number": 10691, "pr_title": "Make SleepingUnderFileSystem to make use of managed blocking", "pr_createdAt": "2020-01-02T22:34:03Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10691", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362676232", "bodyText": "Instead of directly wrapping, should we modify the conf to set managedblocking to true? This will make sleeping ufs behave more closely to normal ufs's (in cases where we do not wrap with managed blocking this will not automatically be wrapped either).", "author": "calvinjia", "createdAt": "2020-01-03T00:16:43Z", "path": "tests/src/test/java/alluxio/testutils/underfs/sleeping/SleepingUnderFileSystemFactory.java", "diffHunk": "@@ -41,14 +42,17 @@ public SleepingUnderFileSystemFactory(SleepingUnderFileSystemOptions options) {\n    * @param ufs the UFS instance to return on creation\n    */\n   public SleepingUnderFileSystemFactory(SleepingUnderFileSystem ufs) {\n-    mUfs = ufs;\n+    mUfs = new ManagedBlockingUfsForwarder(ufs);\n   }\n \n   @Override\n   public UnderFileSystem create(String path, UnderFileSystemConfiguration conf) {\n     if (mUfs == null) {\n       Preconditions.checkArgument(path != null, \"path may not be null\");\n-      return new SleepingUnderFileSystem(new AlluxioURI(path), mOptions, conf);\n+      // Wrapping with a special forwarder to let master thread-pool know that threads will sleep\n+      // on this UFS.\n+      return new ManagedBlockingUfsForwarder(\n+          new SleepingUnderFileSystem(new AlluxioURI(path), mOptions, conf));", "originalCommit": "f8ebe527451562d9e858f1c0e49c8fee9860768a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3ODMxMA==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362678310", "bodyText": "You mean overriding the conf within SleepingUnderFileSystemFactory? Or in all tests that use SleepingUnderFileSystem ?", "author": "ggezer", "createdAt": "2020-01-03T00:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4Mjg5NA==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362682894", "bodyText": "overriding the conf within SleepingUnderFileSystemFactory if it is not set", "author": "calvinjia", "createdAt": "2020-01-03T01:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjcwMzM4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362703383", "bodyText": "I feel uneasy about introducing a special config override.  Could you please explain what do you mean by ufs not being automatically wrapped?", "author": "ggezer", "createdAt": "2020-01-03T04:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg5NzAzNw==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362897037", "bodyText": "We have this property (alluxio.master.ufs.managed.blocking.enabled), right? Is @calvinjia saying just set that in here? When overriding the conf, do we just need to override the UFS conf, or would we need to override the server conf? I don't think we can or should update server conf in a UFS.", "author": "gpang", "createdAt": "2020-01-03T17:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyNTk5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362925999", "bodyText": "Currently the managed blocking flag is turned on if isObjectStore is true or if the managed blocking configuration value is set. I would prefer to use one mechanism to determine if we are using managed blocking.\nWhat I mean is - if somewhere in our code we get a new S3AUnderFileSystem, it will not be wrapped in managed blocking (only if it is created through the UfsManager).", "author": "calvinjia", "createdAt": "2020-01-03T19:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4Nzc0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r362987746", "bodyText": "@gpang right, it would be set in the ufsconf, ideally we want to check if it has been set already (not sure if we can distinguish between set and default value though)", "author": "calvinjia", "createdAt": "2020-01-03T22:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2NzAwOA==", "url": "https://github.com/Alluxio/alluxio/pull/10691#discussion_r366067008", "bodyText": "Understood. PTAL at the updated commit.", "author": "ggezer", "createdAt": "2020-01-13T22:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY3NjIzMg=="}], "type": "inlineReview"}, {"oid": "2859904e6edaa393d362097201c225bedb21f99b", "url": "https://github.com/Alluxio/alluxio/commit/2859904e6edaa393d362097201c225bedb21f99b", "message": "Make SleepingUnderFileSystem to make use of managed blocking", "committedDate": "2020-01-13T22:38:16Z", "type": "commit"}, {"oid": "2859904e6edaa393d362097201c225bedb21f99b", "url": "https://github.com/Alluxio/alluxio/commit/2859904e6edaa393d362097201c225bedb21f99b", "message": "Make SleepingUnderFileSystem to make use of managed blocking", "committedDate": "2020-01-13T22:38:16Z", "type": "forcePushed"}]}