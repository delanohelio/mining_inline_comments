{"pr_number": 11473, "pr_title": "Fix fuse restart failed", "pr_createdAt": "2020-05-25T02:52:40Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11473", "timeline": [{"oid": "4d99c7bdf15ee156472ddd144f5ec4027b116791", "url": "https://github.com/Alluxio/alluxio/commit/4d99c7bdf15ee156472ddd144f5ec4027b116791", "message": "Make mount point configurable, to #27923774", "committedDate": "2020-05-25T02:42:38Z", "type": "commit"}, {"oid": "688f255428c1e60f1b715fd6c924ed93ded30260", "url": "https://github.com/Alluxio/alluxio/commit/688f255428c1e60f1b715fd6c924ed93ded30260", "message": "Support mout path in host, to #27923774", "committedDate": "2020-05-25T02:51:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxOTEwOA==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r429719108", "bodyText": "not sure what's the convention here, is more common to have 0.5.10 or 0.6.0?\n@cheyang @jiacheliu3", "author": "apc999", "createdAt": "2020-05-25T03:38:45Z", "path": "integration/kubernetes/helm-chart/alluxio/Chart.yaml", "diffHunk": "@@ -12,7 +12,7 @@\n name: alluxio\n apiVersion: v1\n description: Open source data orchestration for analytics and machine learning in any cloud.\n-version: 0.5.9\n+version: 0.6.0", "originalCommit": "688f255428c1e60f1b715fd6c924ed93ded30260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMwOTYyNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r430309625", "bodyText": "We don't really have a convention on the versioning here. I'm fine with bumping to 0.6.0 as this is relatively stable now.", "author": "jiacheliu3", "createdAt": "2020-05-26T10:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxOTEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0ODc2NA==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r430248764", "bodyText": "I'm not sure if this change will fix this issue.\nI encounter same error when alluxio-fuse daemon is kill by SIGKILL. In this situation, the preStop hook will not be executed.\nAnd when alluxio-fuse daemon trying to restart, k8s failed to mount the alluxio-fuse-mount, and report the error: Transport endpoint is not connected. I suspect we don't have a change to execute this script, container will be failed in start phrase.\nOne workaround is to use sidecar to monitor the this mount point. If the mount point is broken, umount it in sidecar. But I think the more official way is using PV/PVC to deploy alluxio in k8s. And let k8s to manage the storage life-cycle.", "author": "Binyang2014", "createdAt": "2020-05-26T08:39:30Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -89,8 +90,10 @@ function mountAlluxioRootFSWithFuseOption {\n   fi\n \n   # Unmount first if cleanup failed and ignore error\n-  ! integration/fuse/bin/alluxio-fuse unmount /alluxio-fuse\n-  exec integration/fuse/bin/alluxio-fuse mount -n ${fuseOptions} /alluxio-fuse /\n+  ! mkdir -p ${MOUNT_POINT}\n+  ! umount ${MOUNT_POINT}\n+  #! integration/fuse/bin/alluxio-fuse unmount ${MOUNT_POINT}\n+  exec integration/fuse/bin/alluxio-fuse mount -n ${fuseOptions} ${MOUNT_POINT} /", "originalCommit": "688f255428c1e60f1b715fd6c924ed93ded30260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI5MTAzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r430291039", "bodyText": "This sould be also used with mountPath: /mnt in integration/kubernetes/helm-chart/alluxio/values.yaml The pod is not mounted with the alluxio fuse mount path, instead its parent directory.", "author": "cheyang", "createdAt": "2020-05-26T09:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0ODc2NA=="}], "type": "inlineReview"}, {"oid": "6e701d87e3637855ba17b5d355b8cc0971449869", "url": "https://github.com/Alluxio/alluxio/commit/6e701d87e3637855ba17b5d355b8cc0971449869", "message": "Support mout path in host, to #27923774", "committedDate": "2020-05-26T09:45:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3OTc0OA==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r430679748", "bodyText": "please include this path under the fuse section\nfuse:\n  mountPath: /mnt", "author": "madanadit", "createdAt": "2020-05-26T20:11:23Z", "path": "integration/kubernetes/helm-chart/alluxio/values.yaml", "diffHunk": "@@ -25,6 +25,10 @@ user: 1000\n group: 1000\n fsGroup: 1000\n \n+# Mount path in the host\n+#mountPath: /mnt/alluxio-fuse\n+mountPath: /mnt", "originalCommit": "6e701d87e3637855ba17b5d355b8cc0971449869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NTY4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r432165683", "bodyText": "Sure.", "author": "cheyang", "createdAt": "2020-05-28T22:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3OTc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4ODE1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r430688159", "bodyText": "as far as i remember, this command kills the fuse daemon and is also called in preStop.  is this still needed when the preStop hook is not executed for an unclean shutdown?", "author": "madanadit", "createdAt": "2020-05-26T20:26:59Z", "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -89,8 +90,10 @@ function mountAlluxioRootFSWithFuseOption {\n   fi\n \n   # Unmount first if cleanup failed and ignore error\n-  ! integration/fuse/bin/alluxio-fuse unmount /alluxio-fuse\n-  exec integration/fuse/bin/alluxio-fuse mount -n ${fuseOptions} /alluxio-fuse /\n+  ! mkdir -p ${MOUNT_POINT}\n+  ! umount ${MOUNT_POINT}\n+  #! integration/fuse/bin/alluxio-fuse unmount ${MOUNT_POINT}", "originalCommit": "6e701d87e3637855ba17b5d355b8cc0971449869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2MzM0NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11473#discussion_r432163345", "bodyText": "It's needed for the case Transport endpoint is not connected when the fuse daemon is killed for OOM issue.  We've tested it in customer scenario.", "author": "cheyang", "createdAt": "2020-05-28T22:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4ODE1OQ=="}], "type": "inlineReview"}, {"oid": "1a3ec5ec1784ce4a01a4608f82aacacefe369e62", "url": "https://github.com/Alluxio/alluxio/commit/1a3ec5ec1784ce4a01a4608f82aacacefe369e62", "message": "Support mout path in host, to #27923774", "committedDate": "2020-05-28T22:44:26Z", "type": "commit"}, {"oid": "05b83fb5494b478a9e598ad0d78a5352bb96db15", "url": "https://github.com/Alluxio/alluxio/commit/05b83fb5494b478a9e598ad0d78a5352bb96db15", "message": "Move mountPath under the fuse object, to #27923774", "committedDate": "2020-05-28T22:46:58Z", "type": "commit"}, {"oid": "d1f11f15ba7716ae034719ad49bd9a423c13d3d4", "url": "https://github.com/Alluxio/alluxio/commit/d1f11f15ba7716ae034719ad49bd9a423c13d3d4", "message": "Move mountPath under the fuse object, to #27923774", "committedDate": "2020-05-28T22:53:57Z", "type": "commit"}, {"oid": "45d08a6fbd5d1418b85fdbdf55b02d7690da5b6b", "url": "https://github.com/Alluxio/alluxio/commit/45d08a6fbd5d1418b85fdbdf55b02d7690da5b6b", "message": "Update the docs, to #27923774", "committedDate": "2020-05-28T22:59:27Z", "type": "commit"}]}