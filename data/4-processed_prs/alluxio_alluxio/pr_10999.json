{"pr_number": 10999, "pr_title": "Add metrics doc generator and update metric docs", "pr_createdAt": "2020-02-24T19:21:54Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10999", "timeline": [{"oid": "2fc5cfdf4efadcc5387b6ea6cd6e15c9d5277166", "url": "https://github.com/Alluxio/alluxio/commit/2fc5cfdf4efadcc5387b6ea6cd6e15c9d5277166", "message": "Add metrics doc generator and update metric docs", "committedDate": "2020-02-24T19:19:22Z", "type": "commit"}, {"oid": "ffbfbd3ba963abbaaf853fd2427ab833deaae90a", "url": "https://github.com/Alluxio/alluxio/commit/ffbfbd3ba963abbaaf853fd2427ab833deaae90a", "message": "Fix checkstyle", "committedDate": "2020-02-24T19:31:00Z", "type": "commit"}, {"oid": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "url": "https://github.com/Alluxio/alluxio/commit/c605efc6a09e507bf03c0a20c2b152e356b878d8", "message": "fix bug", "committedDate": "2020-02-24T22:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTE1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383581159", "bodyText": "Maybe we can combine all *DocGen functions into a single command? Are there any downsides you see?\nI feel like having so many just clutters the interface. They all take such a short amount of time I don't think it would hurt to simply run everything?", "author": "ZacBlanco", "createdAt": "2020-02-24T23:46:26Z", "path": "bin/alluxio", "diffHunk": "@@ -352,6 +353,12 @@ function main {\n   \"clearCache\")\n     sync; echo 3 > /proc/sys/vm/drop_caches ;\n   ;;\n+  \"metricsDocGen\")\n+    CLASS=\"alluxio.cli.MetricsDocGenerator\"\n+    CLASSPATH=${ALLUXIO_CLIENT_CLASSPATH}\n+    ALLUXIO_SHELL_JAVA_OPTS+=\" -Dalluxio.logger.type=Console\"\n+    runJavaClass \"$@\"\n+  ;;", "originalCommit": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MzIzNw==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383593237", "bodyText": "Yeah, we could do that. I previously thought about combining them. The reason I didn't do that is .... (I don't want to touch ConfigurationDocGen doc which ... needs some time to reformat codes)", "author": "LuQQiu", "createdAt": "2020-02-25T00:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDM5OA==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383610398", "bodyText": "Changed to use the same docGen for both metrics and configuration, thanks", "author": "LuQQiu", "createdAt": "2020-02-25T01:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTU1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383581550", "bodyText": "can we put this in a code block?\n```\n```", "author": "ZacBlanco", "createdAt": "2020-02-24T23:47:42Z", "path": "docs/en/operation/Metrics-System.md", "diffHunk": "@@ -119,11 +120,11 @@ such as data transferred or the number of RPC invocations.\n \n Metrics in Alluxio have the following format for master node metrics:\n \n-master.[metricName].[tag1].[tag2]...\n+Master.[metricName].[tag1].[tag2]...\n \n Metrics in Alluxio have the following format for non-master node metrics:\n \n-[processType].[hostName].[metricName].[tag1].[tag2]...\n+[processType].[metricName].[tag1].[tag2]...[hostName]", "originalCommit": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDQ2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383610465", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-25T01:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTU3OA==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383581578", "bodyText": "can we put this in a code block?\n```\n```", "author": "ZacBlanco", "createdAt": "2020-02-24T23:47:48Z", "path": "docs/en/operation/Metrics-System.md", "diffHunk": "@@ -119,11 +120,11 @@ such as data transferred or the number of RPC invocations.\n \n Metrics in Alluxio have the following format for master node metrics:\n \n-master.[metricName].[tag1].[tag2]...\n+Master.[metricName].[tag1].[tag2]...", "originalCommit": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDQ5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383610495", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-25T01:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTcyMg==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383581722", "bodyText": "This page will be quite large. Maybe we can add a new page to the \"Reference\" dropdown?", "author": "ZacBlanco", "createdAt": "2020-02-24T23:48:15Z", "path": "docs/en/operation/Metrics-System.md", "diffHunk": "@@ -135,190 +136,84 @@ Tags can be used to further filter or aggregate on various characteristics.\n Workers and clients send metrics data to the Alluxio master through heartbeats.\n The interval is defined by property `alluxio.master.worker.heartbeat.interval` and `alluxio.user.metrics.heartbeat.interval` respectively.\n \n-Each client will be assigned an application id. \n-All the metrics sent by this client contain the client application id information. \n-By default, this will be in the form of 'app-[random number]'. \n-This value can be configured through the property `alluxio.user.app.id`, \n-so multiple clients can be combined into a logical application.\n-\n-#### Alluxio Cluster Information\n-\n-| Metric Name | Description |\n-|-------------------------|-----------------------------------------------|\n-| Master.Workers | Total number of active Alluxio workers in this cluster |\n-\n-#### Alluxio Storage Capacity\n-\n-| Metric Name | Description |\n-|--------------------------------|--------------------------------------------------------------------------|\n-| Master.CapacityTotal | Total capacity of the Alluxio file system in bytes |\n-| Master.CapacityTotalTier<TIER> | Total capacity in tier <TIER> of the Alluxio file system in bytes |\n-| Master.CapacityUsed | Used capacity of the file system in bytes |\n-| Master.CapacityUsedTier<TIER> | Used capacity in tier <TIER> of the Alluxio file system in bytes |\n-| Master.CapacityFree | Free capacity of the Alluxio file system in bytes |\n-| Master.CapacityFreeTier<TIER> | Free capacity in tier <TIER> of the Alluxio file system in bytes |\n-\n-#### Under Storage Capacity\n-\n-| Metric Name | Description |\n-|-------------------------|--------------------------------------------------|\n-| Master.UfsCapacityTotal | Total capacity of the under file system in bytes |\n-| Master.UfsCapacityUsed | Used capacity of the under file system in bytes |\n-| Master.UfsCapacityFree | Free capacity of the under file system in bytes |\n+<table class=\"table table-striped\">\n+<tr><th>Name</th><th>Type</th><th>Description</th></tr>\n+{% for item in site.data.table.cluster-metrics %}\n+  <tr>\n+    <td><a class=\"anchor\" name=\"{{ item.metricName }}\"></a> {{ item.metricName }}</td>\n+    <td>{{ item.metricType }}</td>\n+    <td>{{ site.data.table.en.cluster-metrics[item.metricName] }}</td>\n+  </tr>\n+{% endfor %}\n+</table>", "originalCommit": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDcxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383610711", "bodyText": "Moved to the Reference as Metrics-list.md", "author": "LuQQiu", "createdAt": "2020-02-25T01:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MTcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MzU5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383583595", "bodyText": "Can we also use the escapeHtml function (see confDocGen for usage) so that it doesn't break any doc pages if someone adds some weird characters to a metric description", "author": "ZacBlanco", "createdAt": "2020-02-24T23:54:05Z", "path": "shell/src/main/java/alluxio/cli/MetricsDocGenerator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.cli;\n+\n+import alluxio.annotation.PublicApi;\n+import alluxio.conf.InstancedConfiguration;\n+import alluxio.conf.PropertyKey;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+import alluxio.util.ConfigurationUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.base.Objects;\n+import com.google.common.io.Closer;\n+\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * Generates metric key information in docs.\n+ */\n+@ThreadSafe\n+@PublicApi\n+public final class MetricsDocGenerator {\n+  private static final String[] CATEGORIES = new String[]{\"cluster\", \"master\", \"worker\", \"client\"};\n+  private static final String CSV_FILE_DIR = \"docs/_data/table/\";\n+  private static final String YML_FILE_DIR = \"docs/_data/table/en/\";\n+  private static final String CSV_SUFFIX = \"csv\";\n+  private static final String YML_SUFFIX = \"yml\";\n+  private static final String CSV_FILE_HEADER = \"metricName,metricType\";\n+\n+  /**\n+   * Writes the supported files for metrics system doc.\n+   */\n+  private static void writeDocFiles() throws IOException {\n+    // Gets and sorts the metric keys\n+    List<MetricKey> defaultKeys = new ArrayList<>(MetricKey.allMetricKeys());\n+    Collections.sort(defaultKeys);\n+\n+    String homeDir = new InstancedConfiguration(ConfigurationUtils.defaults())\n+        .get(PropertyKey.HOME);\n+\n+    // Map from metric key prefix to metric category\n+    Map<String, String> metricTypeMap = new HashMap<>();\n+    for (MetricsSystem.InstanceType type : MetricsSystem.InstanceType.values()) {\n+      String typeStr = type.toString();\n+      String category = typeStr.toLowerCase();\n+      metricTypeMap.put(typeStr, category);\n+    }\n+\n+    try (Closer closer = Closer.create()) {\n+      Map<FileWriterKey, FileWriter> fileWriterMap = new HashMap<>();\n+      String csvFolder = PathUtils.concatPath(homeDir, CSV_FILE_DIR);\n+      String ymlFolder = PathUtils.concatPath(homeDir, YML_FILE_DIR);\n+      FileWriter csvFileWriter;\n+      FileWriter ymlFileWriter;\n+      for (String category : CATEGORIES) {\n+        csvFileWriter = new FileWriter(PathUtils\n+            .concatPath(csvFolder, category + \"-metrics.\" + CSV_SUFFIX));\n+        csvFileWriter.append(CSV_FILE_HEADER + \"\\n\");\n+        ymlFileWriter = new FileWriter(PathUtils\n+            .concatPath(ymlFolder, category + \"-metrics.\" + YML_SUFFIX));\n+        fileWriterMap.put(new FileWriterKey(category, CSV_SUFFIX), csvFileWriter);\n+        fileWriterMap.put(new FileWriterKey(category, YML_SUFFIX), ymlFileWriter);\n+        //register file writer\n+        closer.register(csvFileWriter);\n+        closer.register(ymlFileWriter);\n+      }\n+\n+      for (MetricKey metricKey : defaultKeys) {\n+        String key = metricKey.toString();\n+\n+        String[] components = key.split(\"\\\\.\");\n+        if (components.length < 2) {\n+          throw new IOException(String\n+              .format(\"The given metric key %s doesn't have two or more components\", key));\n+        }\n+        if (metricTypeMap.containsKey(components[0])) {\n+          csvFileWriter = fileWriterMap.get(\n+              new FileWriterKey(metricTypeMap.get(components[0]), CSV_SUFFIX));\n+          ymlFileWriter = fileWriterMap.get(\n+              new FileWriterKey(metricTypeMap.get(components[0]), YML_SUFFIX));\n+          csvFileWriter.append(String.format(\"%s,%s%n\", key, metricKey.getMetricType().toString()));\n+          ymlFileWriter.append(String.format(\"%s,%s%n\",\n+              key, metricKey.getDescription().replace(\"'\", \"''\")));", "originalCommit": "c605efc6a09e507bf03c0a20c2b152e356b878d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMDc3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383610775", "bodyText": "Add the escapeHtml, thanks!", "author": "LuQQiu", "createdAt": "2020-02-25T01:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4MzU5NQ=="}], "type": "inlineReview"}, {"oid": "d967c1a2ee5fae5b25be95fb95eec9fc1b526886", "url": "https://github.com/Alluxio/alluxio/commit/d967c1a2ee5fae5b25be95fb95eec9fc1b526886", "message": "Add a consolidate doc generator for both metrics and conf", "committedDate": "2020-02-25T01:08:19Z", "type": "commit"}, {"oid": "2e6035d531f9bc689367f218241e5f720940d65c", "url": "https://github.com/Alluxio/alluxio/commit/2e6035d531f9bc689367f218241e5f720940d65c", "message": "small doc fix", "committedDate": "2020-02-25T01:11:47Z", "type": "commit"}, {"oid": "7236b37662bafc8bab16994c8d6a90a31275a5f1", "url": "https://github.com/Alluxio/alluxio/commit/7236b37662bafc8bab16994c8d6a90a31275a5f1", "message": "Fix shell command", "committedDate": "2020-02-25T01:36:49Z", "type": "commit"}, {"oid": "20cc4b2b49bfb25bfed7c6be1c334e34a350a087", "url": "https://github.com/Alluxio/alluxio/commit/20cc4b2b49bfb25bfed7c6be1c334e34a350a087", "message": "Consolidate console logs", "committedDate": "2020-02-25T01:42:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNTUwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r383615505", "bodyText": "maybe put into a bulleted list?", "author": "ZacBlanco", "createdAt": "2020-02-25T01:45:13Z", "path": "docs/en/reference/Metrics-List.md", "diffHunk": "@@ -0,0 +1,165 @@\n+---\n+layout: global\n+title: List of Metrics\n+group: Reference\n+priority: 1\n+---\n+\n+* Table of Contents\n+{:toc}\n+\n+There are two types of metrics in Alluxio, cluster-wide aggregated metrics, and per-process detailed metrics.", "originalCommit": "20cc4b2b49bfb25bfed7c6be1c334e34a350a087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyMDE1NA==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r384120154", "bodyText": "Put in a bulleted list, thanks", "author": "LuQQiu", "createdAt": "2020-02-25T20:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNTUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDY4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r384080685", "bodyText": "I think it would be better if we moved this above the table. Most people probably won't read after the end of the table", "author": "ZacBlanco", "createdAt": "2020-02-25T19:35:10Z", "path": "docs/en/reference/Metrics-List.md", "diffHunk": "@@ -0,0 +1,165 @@\n+---\n+layout: global\n+title: List of Metrics\n+group: Reference\n+priority: 1\n+---\n+\n+* Table of Contents\n+{:toc}\n+\n+There are two types of metrics in Alluxio, cluster-wide aggregated metrics, and per-process detailed metrics.\n+\n+Cluster metrics are collected and calculated by the leading master and displayed in the metrics tab of the web UI. \n+These metrics are designed to provide a snapshot of the cluster state and the overall amount of data and metadata served by Alluxio.\n+\n+Process metrics are collected by each Alluxio process and exposed in a machine-readable format through any configured sinks. \n+Process metrics are highly detailed and are intended to be consumed by third-party monitoring tools. \n+Users can then view fine-grained dashboards with time-series graphs of each metric, \n+such as data transferred or the number of RPC invocations.\n+\n+Metrics in Alluxio have the following format for master node metrics:\n+\n+```\n+Master.[metricName].[tag1].[tag2]...\n+```\n+\n+Metrics in Alluxio have the following format for non-master node metrics:\n+\n+```\n+[processType].[metricName].[tag1].[tag2]...[hostName]\n+```\n+\n+There is generally an Alluxio metric for every RPC invocation, to Alluxio or to the under store.\n+\n+Tags are additional pieces of metadata for the metric such as user name or under storage location.\n+Tags can be used to further filter or aggregate on various characteristics.\n+\n+## Cluster Metrics\n+\n+Workers and clients send metrics data to the Alluxio master through heartbeats.\n+The interval is defined by property `alluxio.master.worker.heartbeat.interval` and `alluxio.user.metrics.heartbeat.interval` respectively.\n+\n+<table class=\"table table-striped\">\n+<tr><th>Name</th><th>Type</th><th>Description</th></tr>\n+{% for item in site.data.table.cluster-metrics %}\n+  <tr>\n+    <td><a class=\"anchor\" name=\"{{ item.metricName }}\"></a> {{ item.metricName }}</td>\n+    <td>{{ item.metricType }}</td>\n+    <td>{{ site.data.table.en.cluster-metrics[item.metricName] }}</td>\n+  </tr>\n+{% endfor %}\n+</table>\n+\n+Bytes metrics are aggregated value from workers or clients. Bytes throughput metrics are calculated on the leading master.\n+The values of bytes throughput metrics equal to bytes metrics counter value divided by the metrics record time and shown as bytes per minute.", "originalCommit": "20cc4b2b49bfb25bfed7c6be1c334e34a350a087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyMDIzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10999#discussion_r384120231", "bodyText": "Make sense, move it to before the table", "author": "LuQQiu", "createdAt": "2020-02-25T20:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDY4NQ=="}], "type": "inlineReview"}, {"oid": "061ce639a7f41e8176f1241fd4c39ec81357d458", "url": "https://github.com/Alluxio/alluxio/commit/061ce639a7f41e8176f1241fd4c39ec81357d458", "message": "small doc fix", "committedDate": "2020-02-25T20:54:05Z", "type": "commit"}]}