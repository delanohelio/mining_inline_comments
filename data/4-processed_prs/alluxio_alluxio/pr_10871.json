{"pr_number": 10871, "pr_title": "Fix worker/client to get right cluster config", "pr_createdAt": "2020-02-08T00:58:24Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10871", "timeline": [{"oid": "8a7510dc12e7a81d0b57a3b9870e3bf0eafec0ef", "url": "https://github.com/Alluxio/alluxio/commit/8a7510dc12e7a81d0b57a3b9870e3bf0eafec0ef", "message": "Validating the property key scope", "committedDate": "2020-02-07T22:27:20Z", "type": "commit"}, {"oid": "cd320eb053f33cb86f6b0ae8113ebf3b448a69d1", "url": "https://github.com/Alluxio/alluxio/commit/cd320eb053f33cb86f6b0ae8113ebf3b448a69d1", "message": "Load configuration for worker/client differently", "committedDate": "2020-02-08T00:12:58Z", "type": "commit"}, {"oid": "d0284880ceb1d5a3ae8e5f5bb26332bb7742a2a5", "url": "https://github.com/Alluxio/alluxio/commit/d0284880ceb1d5a3ae8e5f5bb26332bb7742a2a5", "message": "Set leftover scope", "committedDate": "2020-02-08T00:35:58Z", "type": "commit"}, {"oid": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "url": "https://github.com/Alluxio/alluxio/commit/0b286248fbe44b5d598723c09fcf1fe297c91f09", "message": "Fix ConfigCheckerIntegrationTest", "committedDate": "2020-02-10T23:42:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ3OTI1OA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377479258", "bodyText": "nit: I would name it as loadClientConf; Alternatively, since this is already ClientContext, you can keep loadConf and I don't think it is confusing.\nLeave this up to you", "author": "apc999", "createdAt": "2020-02-11T07:44:31Z", "path": "core/common/src/main/java/alluxio/ClientContext.java", "diffHunk": "@@ -124,7 +125,7 @@ private ClientContext(@Nullable Subject subject, @Nullable AlluxioConfiguration\n    * @param loadPathConf whether to load path level configuration\n    * @throws AlluxioStatusException\n    */\n-  public synchronized void loadConf(InetSocketAddress address, boolean loadClusterConf,\n+  public synchronized void loadConfForClient(InetSocketAddress address, boolean loadClusterConf,", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxODk3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377818979", "bodyText": "Make sense, Renamed back to loadConf, thanks", "author": "LuQQiu", "createdAt": "2020-02-11T18:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ3OTI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDYyNw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377480627", "bodyText": "loadProperties can be sufficient. In general, concise and accurate names are preferred as long as they are not confusing :)", "author": "apc999", "createdAt": "2020-02-11T07:49:10Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -504,21 +504,22 @@ public static GetConfigurationPResponse loadConfiguration(InetSocketAddress addr\n   }\n \n   /**\n-   * Loads client scope properties from the property list returned by grpc.\n+   * Filters and loads properties contains certain scope from the property list returned by grpc.\n    *\n    * @param properties the property list returned by grpc\n+   * @param scope the scope to filter the received property list\n    * @param logMessage a function with key and value as parameter and returns debug log message\n    * @return the loaded properties\n    */\n-  private static Properties loadClientProperties(List<ConfigProperty> properties,\n-      BiFunction<PropertyKey, String, String> logMessage) {\n+  private static Properties filterAndLoadProperties(List<ConfigProperty> properties,", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDkzMg==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377814932", "bodyText": "Another\n  /**\n   * @param stream the stream to read properties from\n   * @return a properties object populated from the stream\n   */\n  @Nullable\n  public static Properties loadProperties(InputStream stream) {\n\nalready exists in the same file, that's why I give it another name", "author": "LuQQiu", "createdAt": "2020-02-11T18:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MDYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MTE2OA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377481168", "bodyText": "update the comment", "author": "apc999", "createdAt": "2020-02-11T07:51:08Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -504,21 +504,22 @@ public static GetConfigurationPResponse loadConfiguration(InetSocketAddress addr\n   }\n \n   /**\n-   * Loads client scope properties from the property list returned by grpc.\n+   * Filters and loads properties contains certain scope from the property list returned by grpc.\n    *\n    * @param properties the property list returned by grpc\n+   * @param scope the scope to filter the received property list\n    * @param logMessage a function with key and value as parameter and returns debug log message\n    * @return the loaded properties\n    */\n-  private static Properties loadClientProperties(List<ConfigProperty> properties,\n-      BiFunction<PropertyKey, String, String> logMessage) {\n+  private static Properties filterAndLoadProperties(List<ConfigProperty> properties,\n+      Scope scope, BiFunction<PropertyKey, String, String> logMessage) {\n     Properties props = new Properties();\n     for (ConfigProperty property : properties) {\n       String name = property.getName();\n       // TODO(binfan): support propagating unsetting properties from master\n       if (PropertyKey.isValid(name) && property.hasValue()) {\n         PropertyKey key = PropertyKey.fromString(name);\n-        if (!GrpcUtils.contains(key.getScope(), Scope.CLIENT)) {\n+        if (!GrpcUtils.contains(key.getScope(), scope)) {\n           // Only propagate client properties.", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4MzQ1NA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377483454", "bodyText": "name is too long. I would simply call it loadClusterDefaults", "author": "apc999", "createdAt": "2020-02-11T07:58:23Z", "path": "core/server/common/src/main/java/alluxio/conf/ServerConfiguration.java", "diffHunk": "@@ -345,13 +346,13 @@ public static InstancedConfiguration global() {\n    *\n    * @param address the master address\n    */\n-  public static synchronized void loadClusterDefaultsIfNotLoaded(InetSocketAddress address)\n+  public static synchronized void loadClusterDefaultsIfNotLoadedForWorker(InetSocketAddress address)", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDExNg==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377484116", "bodyText": "is this Scope.ALL? don't we use it on client side?", "author": "apc999", "createdAt": "2020-02-11T08:00:38Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -485,54 +497,62 @@ public String toString() {\n               + \"the journal, logs, and under file storage data (if using local filesystem) \"\n               + \"are written here.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.ALL)\n           .build();\n   public static final PropertyKey ZOOKEEPER_ADDRESS =\n       new Builder(Name.ZOOKEEPER_ADDRESS)\n           .setDescription(\"Address of ZooKeeper.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.ENFORCE)\n+          .setScope(Scope.ALL)\n           .build();\n   public static final PropertyKey ZOOKEEPER_CONNECTION_TIMEOUT =\n       new Builder(Name.ZOOKEEPER_CONNECTION_TIMEOUT)\n           .setDefaultValue(\"15s\") // matches Zookeeper's default\n           .setDescription(\"Connection timeout to use when connecting to Zookeeper\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.MASTER)", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDA3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377814079", "bodyText": "It was used by primary selector to connect to Zookeeper, so it only used by Alluxio masters or job masters.\nI will update the description of this property", "author": "LuQQiu", "createdAt": "2020-02-11T18:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDIxOA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377484218", "bodyText": "default scope is Scope.ALL right?", "author": "apc999", "createdAt": "2020-02-11T08:01:00Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -292,6 +292,7 @@ public String toString() {\n           .setDescription(\"The directory containing files used to configure Alluxio.\")\n           .setIgnoredSiteProperty(true)\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.ALL)", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMDYwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377810609", "bodyText": "Yeah, but this can distinguish the property keys that do not consider about its scope / undefined and the property keys that are actually of scope.ALL. And remind following developers to always set scope.", "author": "LuQQiu", "createdAt": "2020-02-11T18:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MTk4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378541987", "bodyText": "Can we just enforce that all property keys define a scope? I think it would be more explicit and leave less guessing", "author": "ZacBlanco", "createdAt": "2020-02-12T22:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3ODE1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378578150", "bodyText": "I prefer not to because there are maybe some property keys generated from templates.", "author": "LuQQiu", "createdAt": "2020-02-12T23:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDUwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377484509", "bodyText": "Scope.SERVER?", "author": "apc999", "createdAt": "2020-02-11T08:01:59Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -485,54 +497,62 @@ public String toString() {\n               + \"the journal, logs, and under file storage data (if using local filesystem) \"\n               + \"are written here.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.ALL)", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxOTEwMw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377819103", "bodyText": "Done, thanks", "author": "LuQQiu", "createdAt": "2020-02-11T18:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NDUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4ODQ4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377488483", "bodyText": "@calvinjia do we now also have client on worker (or job worker)? Do we need to respect cluster-default client-side setting on worker / job worker too?", "author": "apc999", "createdAt": "2020-02-11T08:14:52Z", "path": "core/server/common/src/main/java/alluxio/conf/ServerConfiguration.java", "diffHunk": "@@ -345,13 +346,13 @@ public static InstancedConfiguration global() {\n    *\n    * @param address the master address\n    */\n-  public static synchronized void loadClusterDefaultsIfNotLoaded(InetSocketAddress address)\n+  public static synchronized void loadClusterDefaultsIfNotLoadedForWorker(InetSocketAddress address)\n       throws AlluxioStatusException {\n     if (sConf.getBoolean(PropertyKey.USER_CONF_CLUSTER_DEFAULT_ENABLED)\n         && !sConf.clusterDefaultsLoaded()) {\n       GetConfigurationPResponse response = ConfigurationUtils.loadConfiguration(address, sConf,\n           false, true);\n-      AlluxioConfiguration conf = ConfigurationUtils.getClusterConf(response, sConf);\n+      AlluxioConfiguration conf = ConfigurationUtils.getClusterConf(response, sConf, Scope.WORKER);", "originalCommit": "0b286248fbe44b5d598723c09fcf1fe297c91f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNjQwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r377816405", "bodyText": "In my testing, there is one long-running client in leading master (not sure about the followers) and one long-running client on each worker. Those clients may be used for loading configuration from the leading master.", "author": "LuQQiu", "createdAt": "2020-02-11T18:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4ODQ4Mw=="}], "type": "inlineReview"}, {"oid": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "url": "https://github.com/Alluxio/alluxio/commit/2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "message": "Addressed comments", "committedDate": "2020-02-11T18:31:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MjUyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378542521", "bodyText": "Does this really apply to ALL? For clients, this defines a path to a metrics properties file which might not necessarily exist if the client is remote to Alluxio.", "author": "ZacBlanco", "createdAt": "2020-02-12T22:10:53Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -350,7 +356,7 @@ public String toString() {\n           .setDescription(\"The file path of the metrics system configuration file. By default \"\n               + \"it is `metrics.properties` in the `conf` directory.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n-          .setScope(Scope.SERVER)\n+          .setScope(Scope.ALL)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3ODQzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378578431", "bodyText": "Client will also check this file and start sink metrics if the file exists.", "author": "LuQQiu", "createdAt": "2020-02-12T23:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MjUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378547576", "bodyText": "could this be Scope.NONE?", "author": "ZacBlanco", "createdAt": "2020-02-12T22:22:42Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -441,6 +450,7 @@ public String toString() {\n           .setDescription(\"Version of Alluxio. User should never modify this property.\")\n           .setIgnoredSiteProperty(true)\n           .setIsHidden(true)\n+          .setScope(Scope.ALL)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3ODc4NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378578785", "bodyText": "The same as I talked before, not sure the gap between Scope.NONE and ALL.\nIn my criteria, this properties used in everywhere, so it falls into the category of ALL", "author": "LuQQiu", "createdAt": "2020-02-12T23:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4ODI4Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378588282", "bodyText": "My worry is that in the case of client/server version mismatch, that the client would get this value from cluster defaults and subsequently report that it is the same version as the server - which may not be the case.", "author": "ZacBlanco", "createdAt": "2020-02-13T00:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NDU4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378594587", "bodyText": "Oh, that's possible, then this property should not be propagated to client or worker. Will change it to None", "author": "LuQQiu", "createdAt": "2020-02-13T00:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwNjMxNA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378606314", "bodyText": "The test failed because of they check VERSION on the client side, if it's different from the current one, this property will be removed and not merged into client/worker configuration.\nI changed the Scope back to ALL", "author": "LuQQiu", "createdAt": "2020-02-13T01:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwNzg1MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378607851", "bodyText": "oh :(", "author": "ZacBlanco", "createdAt": "2020-02-13T01:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzgyNA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378547824", "bodyText": "Should this be Scope.NONE", "author": "ZacBlanco", "createdAt": "2020-02-12T22:23:19Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -417,13 +424,15 @@ public String toString() {\n               String.format(\"Comma-separated search path for %s.\", Constants.SITE_PROPERTIES))\n           .setIgnoredSiteProperty(true)\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.ALL)\n           .build();\n   public static final PropertyKey TEST_MODE =\n       new Builder(Name.TEST_MODE)\n           .setDefaultValue(false)\n           .setDescription(\"Flag used only during tests to allow special behavior.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setIsHidden(true)\n+          .setScope(Scope.ALL)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2Njk4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378566983", "bodyText": "One problem now is that there is no fix criteria for which scope a property falls in. My criteria is that if the PropertyKey is used in master or worker only, then they are Scope.MASTER or Scope.WORKER. If a property is used by both master and worker, or job master and job worker, then it falls to Scope.Server. If it's used by both server and client, it falls to ALL. For some property key that ony used by certain integration like MESOS, it falls to Scope.NONE. TEST_MODE is used in server and common codes.", "author": "LuQQiu", "createdAt": "2020-02-12T23:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4ODUxMw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378588513", "bodyText": "I see. It sounds like we need to have more defined criteria for Scope.NONE. I am fine making this ALL for now.", "author": "ZacBlanco", "createdAt": "2020-02-13T00:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NzgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1MTU2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378551569", "bodyText": "why is this Scope.ALL?", "author": "ZacBlanco", "createdAt": "2020-02-12T22:32:11Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2443,7 +2469,7 @@ public String toString() {\n           .setDefaultValue(29999)\n           .setDescription(\"The port for Alluxio worker's RPC service.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n-          .setScope(Scope.WORKER)\n+          .setScope(Scope.ALL)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2Nzc5MA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378567790", "bodyText": "Because this property key is used by Core-common/InstanceConfiguration.validate()", "author": "LuQQiu", "createdAt": "2020-02-12T23:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1MTU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1MTk0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378551949", "bodyText": "why is this Scope.NONE? Shouldn't this be Scope.SERVER?", "author": "ZacBlanco", "createdAt": "2020-02-12T22:33:06Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2724,6 +2750,7 @@ public String toString() {\n           .setDefaultValue(Constants.S3_MULTIPART_TEMPORARY_DIR_SUFFIX)\n           .setDescription(\"Suffix for the directory which holds parts during a multipart upload.\")\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.ENFORCE)\n+          .setScope(Scope.NONE)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2ODU4NA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378568584", "bodyText": "Previously all the Proxy properties are given Scope.NONE,  I actually not quite sure what scope should be given to Proxy properties. Scope.NONE and Scope.SERVER both make sense", "author": "LuQQiu", "createdAt": "2020-02-12T23:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1MTk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NDUxOA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378554518", "bodyText": "shouldn't this be Scope.WORKER?", "author": "ZacBlanco", "createdAt": "2020-02-12T22:39:32Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3690,76 +3732,90 @@ public String toString() {\n               + \"setting the capacity of the job master to a large ( > 10M) value. Default is -1 \"\n               + \"denoting an unlimited value\")\n           .setDefaultValue(\"-1\")\n+          .setScope(Scope.MASTER)\n           .build();\n   public static final PropertyKey JOB_MASTER_FINISHED_JOB_RETENTION_TIME =\n       new Builder(Name.JOB_MASTER_FINISHED_JOB_RETENTION_TIME)\n           .setDescription(\"The length of time the Alluxio Job Master should save information about \"\n               + \"completed jobs before they are discarded.\")\n           .setDefaultValue(\"300sec\")\n+          .setScope(Scope.MASTER)\n           .build();\n   public static final PropertyKey JOB_MASTER_JOB_CAPACITY =\n       new Builder(Name.JOB_MASTER_JOB_CAPACITY)\n           .setDescription(\"The total possible number of available job statuses in the job master. \"\n               + \"This value includes running and finished jobs which are have completed within \"\n               + Name.JOB_MASTER_FINISHED_JOB_RETENTION_TIME + \".\")\n           .setDefaultValue(100000)\n+          .setScope(Scope.MASTER)\n           .build();\n   public static final PropertyKey JOB_MASTER_WORKER_HEARTBEAT_INTERVAL =\n       new Builder(Name.JOB_MASTER_WORKER_HEARTBEAT_INTERVAL)\n           .setDescription(\"The amount of time that the Alluxio job worker should wait in between \"\n               + \"heartbeats to the Job Master.\")\n           .setDefaultValue(\"1sec\")\n+          .setScope(Scope.MASTER)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2ODc5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378568796", "bodyText": "Yeah, you are right", "author": "LuQQiu", "createdAt": "2020-02-12T23:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3OTM1NA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378579354", "bodyText": "Changed, thanks", "author": "LuQQiu", "createdAt": "2020-02-12T23:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NDUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NTQ2OA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378555468", "bodyText": "shouldn't this be Scope.ALL? Clients need that information to connect to the job master? Mainly for CLI use cases", "author": "ZacBlanco", "createdAt": "2020-02-12T22:41:58Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3804,20 +3865,23 @@ public String toString() {\n                   + \"%s using the port defined in %s\",\n               Name.MASTER_RPC_ADDRESSES, Name.JOB_MASTER_RPC_PORT,\n               Name.JOB_MASTER_EMBEDDED_JOURNAL_ADDRESSES, Name.JOB_MASTER_RPC_PORT))\n-          .setScope(Scope.CLIENT)\n+          .setScope(Scope.MASTER)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3OTMwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378579305", "bodyText": "Changed, thanks", "author": "LuQQiu", "createdAt": "2020-02-12T23:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NTQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NTU5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378555599", "bodyText": "shouldn't this be Scope.ALL? Clients need that information to connect to the job master? Mainly for CLI use cases", "author": "ZacBlanco", "createdAt": "2020-02-12T22:42:17Z", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3804,20 +3865,23 @@ public String toString() {\n                   + \"%s using the port defined in %s\",\n               Name.MASTER_RPC_ADDRESSES, Name.JOB_MASTER_RPC_PORT,\n               Name.JOB_MASTER_EMBEDDED_JOURNAL_ADDRESSES, Name.JOB_MASTER_RPC_PORT))\n-          .setScope(Scope.CLIENT)\n+          .setScope(Scope.MASTER)\n           .build();\n   public static final PropertyKey JOB_MASTER_EMBEDDED_JOURNAL_ADDRESSES =\n       new Builder(Name.JOB_MASTER_EMBEDDED_JOURNAL_ADDRESSES)\n           .setDescription(String.format(\"A comma-separated list of journal addresses for all job \"\n               + \"masters in the cluster. The format is 'hostname1:port1,hostname2:port2,...'. \"\n               + \"Defaults to the journal addresses set for the Alluxio masters (%s), but with the \"\n               + \"job master embedded journal port.\", Name.MASTER_EMBEDDED_JOURNAL_ADDRESSES))\n+          .setScope(Scope.MASTER)", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3OTI1NA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378579254", "bodyText": "Changed to Scope.ALL, thanks", "author": "LuQQiu", "createdAt": "2020-02-12T23:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjM0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378556346", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Filters and loads properties contains certain scope from the property list returned by grpc.\n          \n          \n            \n               * Filters and loads properties with a certain scope from the property list returned by grpc.", "author": "ZacBlanco", "createdAt": "2020-02-12T22:44:13Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -504,22 +504,23 @@ public static GetConfigurationPResponse loadConfiguration(InetSocketAddress addr\n   }\n \n   /**\n-   * Loads client scope properties from the property list returned by grpc.\n+   * Filters and loads properties contains certain scope from the property list returned by grpc.", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3OTE0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378579142", "bodyText": "Changed", "author": "LuQQiu", "createdAt": "2020-02-12T23:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378556813", "bodyText": "If a property has scope ALL we want that included along with properties from the CLIENT scope, correct?", "author": "ZacBlanco", "createdAt": "2020-02-12T22:45:28Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -504,22 +504,23 @@ public static GetConfigurationPResponse loadConfiguration(InetSocketAddress addr\n   }\n \n   /**\n-   * Loads client scope properties from the property list returned by grpc.\n+   * Filters and loads properties contains certain scope from the property list returned by grpc.\n    *\n    * @param properties the property list returned by grpc\n+   * @param scope the scope to filter the received property list\n    * @param logMessage a function with key and value as parameter and returns debug log message\n    * @return the loaded properties\n    */\n-  private static Properties loadClientProperties(List<ConfigProperty> properties,\n-      BiFunction<PropertyKey, String, String> logMessage) {\n+  private static Properties filterAndLoadProperties(List<ConfigProperty> properties,\n+      Scope scope, BiFunction<PropertyKey, String, String> logMessage) {\n     Properties props = new Properties();\n     for (ConfigProperty property : properties) {\n       String name = property.getName();\n       // TODO(binfan): support propagating unsetting properties from master\n       if (PropertyKey.isValid(name) && property.hasValue()) {\n         PropertyKey key = PropertyKey.fromString(name);\n-        if (!GrpcUtils.contains(key.getScope(), Scope.CLIENT)) {\n-          // Only propagate client properties.\n+        if (!GrpcUtils.contains(key.getScope(), scope)) {\n+          // Only propagate properties contains the target scope", "originalCommit": "2f16b38a4d8ca2e28eeeb3966930651abf8a1e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3NzUyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378577521", "bodyText": "I add a description to only allow Scope=WORKER/CLIENT.\nNot sure about the SCOPE=ALL result", "author": "LuQQiu", "createdAt": "2020-02-12T23:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4ODk5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378588995", "bodyText": "My understanding is that for properties marked with Scope.CLIENT and Scope.ALL should be propagated to the client when loading the cluster default values  - if only one is defined in the function, then we could be missing properties?", "author": "ZacBlanco", "createdAt": "2020-02-13T00:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4OTU3MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378589571", "bodyText": "I guess I also don't fully understand what GrpcUtils.contains actually does", "author": "ZacBlanco", "createdAt": "2020-02-13T00:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5MzgxMA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378593810", "bodyText": "I tested this function, if given scope == CLIENT,\nScope == CLIENT & ALL will be propagated to client\nif given scope == WORKER, Scope == WORKER/SERVER/ALL will be propagated to worker.", "author": "LuQQiu", "createdAt": "2020-02-13T00:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NDY4OA==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378594688", "bodyText": "got it. thanks!", "author": "ZacBlanco", "createdAt": "2020-02-13T00:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1NjgxMw=="}], "type": "inlineReview"}, {"oid": "82cb04668d3b1a473f864b5729a8735b5e6359c1", "url": "https://github.com/Alluxio/alluxio/commit/82cb04668d3b1a473f864b5729a8735b5e6359c1", "message": "Fix the scope", "committedDate": "2020-02-12T23:29:06Z", "type": "commit"}, {"oid": "c2924a5a094f1feb5250836da7937cc308b7605e", "url": "https://github.com/Alluxio/alluxio/commit/c2924a5a094f1feb5250836da7937cc308b7605e", "message": "small fix", "committedDate": "2020-02-12T23:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4OTcwNg==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378589706", "bodyText": "nit: is there a reason to line break on the commas?", "author": "ZacBlanco", "createdAt": "2020-02-13T00:28:39Z", "path": "core/common/src/main/java/alluxio/util/ConfigurationUtils.java", "diffHunk": "@@ -531,26 +533,28 @@ private static Properties loadClientProperties(List<ConfigProperty> properties,\n   }\n \n   /**\n-   * Loads the cluster level configuration from the get configuration response, and merges it with\n-   * the existing configuration.\n+   * Loads the cluster level configuration from the get configuration response,\n+   * filters out the configuration for certain scope,", "originalCommit": "c2924a5a094f1feb5250836da7937cc308b7605e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NTYwMw==", "url": "https://github.com/Alluxio/alluxio/pull/10871#discussion_r378595603", "bodyText": "Changed to no break, thanks", "author": "LuQQiu", "createdAt": "2020-02-13T00:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4OTcwNg=="}], "type": "inlineReview"}, {"oid": "8d7cab1fa9344f8e7121fbfcb07669d72b07b36c", "url": "https://github.com/Alluxio/alluxio/commit/8d7cab1fa9344f8e7121fbfcb07669d72b07b36c", "message": "fix the version scope and comments", "committedDate": "2020-02-13T00:46:39Z", "type": "commit"}, {"oid": "dbb6425d533bc7e2d5b72fe609560d247797c69d", "url": "https://github.com/Alluxio/alluxio/commit/dbb6425d533bc7e2d5b72fe609560d247797c69d", "message": "Change version back to ALL since client/worker need to check", "committedDate": "2020-02-13T01:26:43Z", "type": "commit"}]}