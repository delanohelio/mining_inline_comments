{"pr_number": 11573, "pr_title": "Reduce number of clients in DistributedLoadCommand", "pr_createdAt": "2020-06-16T23:13:24Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11573", "timeline": [{"oid": "03c5a1917843b2b6ba8170f3491048ced580c844", "url": "https://github.com/Alluxio/alluxio/commit/03c5a1917843b2b6ba8170f3491048ced580c844", "message": "Reduce number of clients in DistributedLoadCommand", "committedDate": "2020-06-16T23:11:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441206659", "bodyText": "Does this method spin over checking jobs?", "author": "ggezer", "createdAt": "2020-06-17T00:01:46Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -200,7 +200,7 @@ private JobAttempt newJob(AlluxioURI filePath, int replication) {\n   private void waitJob() {\n     AtomicBoolean removed = new AtomicBoolean(false);\n     while (true) {\n-      mSubmittedJobAttempts = mSubmittedJobAttempts.parallelStream().filter((jobAttempt) -> {\n+      mSubmittedJobAttempts = mSubmittedJobAttempts.stream().filter((jobAttempt) -> {", "originalCommit": "03c5a1917843b2b6ba8170f3491048ced580c844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwODA2OA==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441208068", "bodyText": "This method spins over checking jobs until it removed one because one is complete/cancelled/failed.", "author": "bradyoo", "createdAt": "2020-06-17T00:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMTAwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441211006", "bodyText": "Can you make it parallel but put a magic sleep (100ms) at the end.", "author": "ggezer", "createdAt": "2020-06-17T00:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMjAwMA==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441212000", "bodyText": "if we can know when there is no pending task left after this, then we can even increase the sleep (to 500ms) but avoid when there are no pending jobs.", "author": "ggezer", "createdAt": "2020-06-17T00:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY4MDE3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441680179", "bodyText": "No that's not good. The whole point is that this mSubmittedJobAttempts is a running list of 1000 jobs. Once it removes a single one from this list, it escapes this loop to add more to fill 1000.", "author": "bradyoo", "createdAt": "2020-06-17T16:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNjIyNg==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441716226", "bodyText": "Can you cache the result of mClient.getJobStatus(mJobId) in the job attempt whenever it's Completed/Failed?", "author": "ggezer", "createdAt": "2020-06-17T17:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMjU2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441732569", "bodyText": "This whole structure seems strange? Could we not just have a threadpool/executor service that just runs tasks, one for each path? The generator just goes through the tree and adds tasks. It is strange that there is this spin loop that has to check all jobs?", "author": "gpang", "createdAt": "2020-06-17T18:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzA5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207099", "bodyText": "Do you need the path-conf here?", "author": "ggezer", "createdAt": "2020-06-17T00:03:18Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -186,8 +180,14 @@ public int run(CommandLine cl) throws AlluxioException, IOException {\n    * @param replication The replication of file to load into Alluxio memory\n    */\n   private JobAttempt newJob(AlluxioURI filePath, int replication) {\n+    final ClientContext clientContext = ClientContext.create(mFsContext.getPathConf(filePath));", "originalCommit": "03c5a1917843b2b6ba8170f3491048ced580c844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzgyMw==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207823", "bodyText": "I left it currently as the first context of the first file it hits though it may not be necessary.", "author": "bradyoo", "createdAt": "2020-06-17T00:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMDU3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441210576", "bodyText": "If job_worker is the one that eventually uses the path-conf, then you can avoid passing anything here.", "author": "ggezer", "createdAt": "2020-06-17T00:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzIxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207211", "bodyText": "Why can't we just use this one always?", "author": "ggezer", "createdAt": "2020-06-17T00:03:43Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -67,15 +67,12 @@\n   private class JobAttempt {\n     private final LoadConfig mJobConfig;\n     private final RetryPolicy mRetryPolicy;\n-    private final JobMasterClient mClient;\n \n     private Long mJobId;\n \n-    private JobAttempt(LoadConfig jobConfig, RetryPolicy retryPolicy, ClientContext clientContext) {\n+    private JobAttempt(LoadConfig jobConfig, RetryPolicy retryPolicy) {\n       mJobConfig = jobConfig;\n       mRetryPolicy = retryPolicy;\n-      mClient = JobMasterClient.Factory.create(\n-          JobMasterClientContext.newBuilder(clientContext).build());", "originalCommit": "03c5a1917843b2b6ba8170f3491048ced580c844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzY4Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207687", "bodyText": "What does that mean?", "author": "bradyoo", "createdAt": "2020-06-17T00:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMTQ4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441211483", "bodyText": "nevermind, I was thinking this was being done above job-attempt.", "author": "ggezer", "createdAt": "2020-06-17T00:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMDgwMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441210801", "bodyText": "Was this a bug?", "author": "ggezer", "createdAt": "2020-06-17T00:16:48Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -209,11 +209,6 @@ private void waitJob() {\n           case CANCELED:\n           case COMPLETED:\n             removed.set(true);\n-            try {\n-              jobAttempt.close();\n-            } catch (IOException e) {\n-              LOG.warn(\"Unable to close job master client\", e);\n-            }", "originalCommit": "03c5a1917843b2b6ba8170f3491048ced580c844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIyNTA1OA==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441225058", "bodyText": "I see. job-attempt need not be closeable with this.", "author": "ggezer", "createdAt": "2020-06-17T01:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMDgwMQ=="}], "type": "inlineReview"}, {"oid": "6b75f52239572c702b3b4d04a94ee7c57f9145a9", "url": "https://github.com/Alluxio/alluxio/commit/6b75f52239572c702b3b4d04a94ee7c57f9145a9", "message": "feedback", "committedDate": "2020-06-17T16:50:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNzQxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441717415", "bodyText": "Can you override the Command#close() and close this client there?", "author": "ggezer", "createdAt": "2020-06-17T17:41:13Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -145,7 +147,11 @@ private Status check() {\n   public DistributedLoadCommand(FileSystemContext fsContext) {\n     super(fsContext);\n     mSubmittedJobAttempts = Lists.newArrayList();\n-    mClient = null;\n+\n+    InstancedConfiguration conf = new InstancedConfiguration(ConfigurationUtils.defaults());\n+    final ClientContext clientContext = ClientContext.create(conf);\n+    mClient = JobMasterClient.Factory.create(", "originalCommit": "6b75f52239572c702b3b4d04a94ee7c57f9145a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDcwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441720709", "bodyText": "oops. You are right. I forgot. Done now.", "author": "bradyoo", "createdAt": "2020-06-17T17:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNzQxNQ=="}], "type": "inlineReview"}, {"oid": "f703150ca0003f5e19a6c04ae52d0371616a7dff", "url": "https://github.com/Alluxio/alluxio/commit/f703150ca0003f5e19a6c04ae52d0371616a7dff", "message": "feedback", "committedDate": "2020-06-17T17:46:25Z", "type": "commit"}, {"oid": "cb5d21059e515c7992c03235e773a576777bb58b", "url": "https://github.com/Alluxio/alluxio/commit/cb5d21059e515c7992c03235e773a576777bb58b", "message": "bring back path conf", "committedDate": "2020-06-17T20:10:54Z", "type": "commit"}, {"oid": "690d25993785d49edbfc43d3307b7df69ad06fcc", "url": "https://github.com/Alluxio/alluxio/commit/690d25993785d49edbfc43d3307b7df69ad06fcc", "message": "mFsContext's client context is good enough", "committedDate": "2020-06-17T21:01:22Z", "type": "commit"}, {"oid": "ad2b75c1a4e360a2a197ef925fdef9b5a25944c2", "url": "https://github.com/Alluxio/alluxio/commit/ad2b75c1a4e360a2a197ef925fdef9b5a25944c2", "message": "Remove unused imports", "committedDate": "2020-06-17T21:03:15Z", "type": "commit"}]}