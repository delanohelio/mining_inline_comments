{"pr_number": 12612, "pr_title": "Add Azure Data Lake Storage Gen 2 File System", "pr_createdAt": "2020-12-07T18:31:40Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12612", "timeline": [{"oid": "91f5f3a1071c7f631e6b57163afdb08dc65a3a77", "url": "https://github.com/Alluxio/alluxio/commit/91f5f3a1071c7f631e6b57163afdb08dc65a3a77", "message": "Azure Data Lake Storage Gen 2", "committedDate": "2020-12-07T18:30:37Z", "type": "commit"}, {"oid": "4f6b0dde2ec269a2f08e378e3b8f3da5367cb4a7", "url": "https://github.com/Alluxio/alluxio/commit/4f6b0dde2ec269a2f08e378e3b8f3da5367cb4a7", "message": "license header and cleanup", "committedDate": "2020-12-07T19:21:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3MTQxNA==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539571414", "bodyText": "Is there any additional configuration needed for connecting with secured scheme?", "author": "bf8086", "createdAt": "2020-12-09T19:07:08Z", "path": "underfs/abfs/src/main/java/alluxio/underfs/abfs/AbfsUnderFileSystem.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.underfs.abfs;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.conf.PropertyKey;\n+import alluxio.underfs.UfsFileStatus;\n+import alluxio.underfs.UfsStatus;\n+import alluxio.underfs.UnderFileSystemConfiguration;\n+import alluxio.underfs.hdfs.HdfsUnderFileSystem;\n+import alluxio.underfs.options.FileLocationOptions;\n+\n+import com.google.common.base.MoreObjects;\n+import org.apache.hadoop.conf.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * A Microsoft Azure Data Lake Storage Gen2 Implementation.\n+ */\n+@ThreadSafe\n+public class AbfsUnderFileSystem extends HdfsUnderFileSystem {\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsUnderFileSystem.class);\n+\n+  /** Constant for the abfs URI scheme. */\n+  public static final String SCHEME_INSECURE = \"abfs://\";\n+\n+  /** Constant for the abfss URI scheme. */\n+  public static final String SCHEME_SECURE = \"abfss://\";", "originalCommit": "4f6b0dde2ec269a2f08e378e3b8f3da5367cb4a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3ODc2OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539578769", "bodyText": "https://hadoop.apache.org/docs/current/hadoop-azure/abfs.html#Security\nHas not indicated otherwise. So doesn't seem to be the case.", "author": "bradyoo", "createdAt": "2020-12-09T19:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3MTQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MDQxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539580415", "bodyText": "\u279c  alluxio git:(azure_gen2) ./bin/alluxio fs mount \n--option fs.azure.account.key.bradleytest1.dfs.core.windows.net=<SHARED_KEY> \n/abfs abfss://container@bradleytest1.dfs.core.windows.net/\nMounted abfss://container@bradleytest1.dfs.core.windows.net/ at /abfs", "author": "bradyoo", "createdAt": "2020-12-09T19:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3MTQxNA=="}], "type": "inlineReview"}, {"oid": "49df8437fbaaf87549e8001d0c15c2fbbe0c9d34", "url": "https://github.com/Alluxio/alluxio/commit/49df8437fbaaf87549e8001d0c15c2fbbe0c9d34", "message": "Added Docs", "committedDate": "2020-12-09T19:16:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3MzMwNQ==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539573305", "bodyText": "Let's avoid putting credentials in log.", "author": "bf8086", "createdAt": "2020-12-09T19:10:12Z", "path": "underfs/abfs/src/main/java/alluxio/underfs/abfs/AbfsUnderFileSystem.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.underfs.abfs;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.conf.PropertyKey;\n+import alluxio.underfs.UfsFileStatus;\n+import alluxio.underfs.UfsStatus;\n+import alluxio.underfs.UnderFileSystemConfiguration;\n+import alluxio.underfs.hdfs.HdfsUnderFileSystem;\n+import alluxio.underfs.options.FileLocationOptions;\n+\n+import com.google.common.base.MoreObjects;\n+import org.apache.hadoop.conf.Configuration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * A Microsoft Azure Data Lake Storage Gen2 Implementation.\n+ */\n+@ThreadSafe\n+public class AbfsUnderFileSystem extends HdfsUnderFileSystem {\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsUnderFileSystem.class);\n+\n+  /** Constant for the abfs URI scheme. */\n+  public static final String SCHEME_INSECURE = \"abfs://\";\n+\n+  /** Constant for the abfss URI scheme. */\n+  public static final String SCHEME_SECURE = \"abfss://\";\n+\n+  private static Configuration createAbfsConfiguration(UnderFileSystemConfiguration conf) {\n+    Configuration abfsConf = HdfsUnderFileSystem.createConfiguration(conf);\n+    for (Map.Entry<String, String> entry : conf.toMap().entrySet()) {\n+      String key = entry.getKey();\n+      String value = entry.getValue();\n+      if (PropertyKey.Template.UNDERFS_AZURE_ACCOUNT_KEY.matches(key)) {\n+        abfsConf.set(key, value);\n+        final String authTypeKey = key.replace(\".key\", \".auth.type\");\n+        abfsConf.set(authTypeKey, \"SharedKey\");\n+      }\n+    }\n+    LOG.info(abfsConf.toString());", "originalCommit": "4f6b0dde2ec269a2f08e378e3b8f3da5367cb4a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MDkyMQ==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539580921", "bodyText": "(nit) Use  ```properties in all property sections for better syntax highlight.", "author": "bf8086", "createdAt": "2020-12-09T19:21:50Z", "path": "docs/en/ufs/Azure-Data-Lake-Gen2.md", "diffHunk": "@@ -0,0 +1,94 @@\n+---\n+layout: global\n+title: Azure Data Lake Storage Gen2\n+nickname: Azure Data Lake Storage\n+group: Storage Integrations\n+priority: 2\n+---\n+\n+* Table of Contents\n+{:toc}\n+\n+This guide describes how to configure Alluxio with [Azure Data Lake Storage Gen2](https://docs.microsoft.com/en-in/azure/storage/blobs/data-lake-storage-introduction) as the under storage system.\n+\n+## Prerequisites\n+\n+The Alluxio binaries must be on your machine.\n+You can either [compile the binaries from Alluxio source code]({{ '/en/contributor/Building-Alluxio-From-Source.html' | relativize_url }}),\n+or [download the precompiled binaries directly]({{ '/en/deploy/Running-Alluxio-Locally.html' | relativize_url }}).\n+\n+In preparation for using Azure Data Lake storage with Alluxio, [create a new Data Lake storage in your Azure\n+account](https://docs.microsoft.com/en-in/azure/storage/blobs/create-data-lake-storage-account) or use an existing Data Lake storage. \n+You should also note the directory you want to use, either by creating a new directory, or using an existing one. You also need a \n+[SharedKey](https://docs.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key(.\n+For the purposes of this guide, the Azure storage account name is called `<AZURE_ACCOUNT>`,\n+the directory in that storage account is called `<AZURE_DIRECTORY>`, and the name of the container is called `<AZURE_CONTAINER>`.\n+\n+\n+## Basic Setup\n+\n+### Root Mount\n+\n+To use Azure Data Lake Storage as the UFS of Alluxio root mount point,\n+you need to configure Alluxio to use under storage systems by modifying\n+`conf/alluxio-site.properties`. If it does not exist, create the configuration file from the\n+template.\n+\n+```console\n+$ cp conf/alluxio-site.properties.template conf/alluxio-site.properties\n+```\n+\n+Specify the underfs address by modifying `conf/alluxio-site.properties` to include:\n+\n+```", "originalCommit": "49df8437fbaaf87549e8001d0c15c2fbbe0c9d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MTk0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12612#discussion_r539581943", "bodyText": "(nit) Add ```console for syntax highlight", "author": "bf8086", "createdAt": "2020-12-09T19:23:25Z", "path": "docs/en/ufs/Azure-Data-Lake-Gen2.md", "diffHunk": "@@ -0,0 +1,94 @@\n+---\n+layout: global\n+title: Azure Data Lake Storage Gen2\n+nickname: Azure Data Lake Storage\n+group: Storage Integrations\n+priority: 2\n+---\n+\n+* Table of Contents\n+{:toc}\n+\n+This guide describes how to configure Alluxio with [Azure Data Lake Storage Gen2](https://docs.microsoft.com/en-in/azure/storage/blobs/data-lake-storage-introduction) as the under storage system.\n+\n+## Prerequisites\n+\n+The Alluxio binaries must be on your machine.\n+You can either [compile the binaries from Alluxio source code]({{ '/en/contributor/Building-Alluxio-From-Source.html' | relativize_url }}),\n+or [download the precompiled binaries directly]({{ '/en/deploy/Running-Alluxio-Locally.html' | relativize_url }}).\n+\n+In preparation for using Azure Data Lake storage with Alluxio, [create a new Data Lake storage in your Azure\n+account](https://docs.microsoft.com/en-in/azure/storage/blobs/create-data-lake-storage-account) or use an existing Data Lake storage. \n+You should also note the directory you want to use, either by creating a new directory, or using an existing one. You also need a \n+[SharedKey](https://docs.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key(.\n+For the purposes of this guide, the Azure storage account name is called `<AZURE_ACCOUNT>`,\n+the directory in that storage account is called `<AZURE_DIRECTORY>`, and the name of the container is called `<AZURE_CONTAINER>`.\n+\n+\n+## Basic Setup\n+\n+### Root Mount\n+\n+To use Azure Data Lake Storage as the UFS of Alluxio root mount point,\n+you need to configure Alluxio to use under storage systems by modifying\n+`conf/alluxio-site.properties`. If it does not exist, create the configuration file from the\n+template.\n+\n+```console\n+$ cp conf/alluxio-site.properties.template conf/alluxio-site.properties\n+```\n+\n+Specify the underfs address by modifying `conf/alluxio-site.properties` to include:\n+\n+```\n+alluxio.master.mount.table.root.ufs=abfs://<AZURE_CONTAINER>@<AZURE_ACCOUNT>.dfs.core.windows.net/<AZURE_DIRECTORY>/\n+```\n+\n+Specify the Shared Key by adding the following property in `conf/alluxio-site.properties`:\n+\n+```\n+alluxio.master.mount.table.root.option.fs.azure.account.key.<AZURE_ACCOUNT>.dfs.core.windows.net=<SHARED_KEY>\n+```\n+\n+### Nested Mount\n+An Azure Data Lake store location can be mounted at a nested directory in the Alluxio namespace to have unified access\n+to multiple under storage systems. Alluxio's\n+[Command Line Interface]({{ '/en/operation/User-CLI.html' | relativize_url }}) can be used for this purpose.\n+\n+```console\n+$ ./bin/alluxio fs mount \\\n+  --option fs.azure.account.key.<AZURE_ACCOUNT>.dfs.core.windows.net=<SHARED_KEY>\n+  /mnt/abfs abfs://<AZURE_CONTAINER>@<AZURE_ACCOUNT>.dfs.core.windows.net/<AZURE_DIRECTORY>/\n+```\n+\n+After these changes, Alluxio should be configured to work with Azure Data Lake storage as its under storage system, and you can run Alluxio locally with it.\n+\n+## Running Alluxio Locally with Data Lake Storage\n+\n+Start up Alluxio locally to see that everything works.\n+\n+```", "originalCommit": "49df8437fbaaf87549e8001d0c15c2fbbe0c9d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d9111f6e42ea94bb8cdc99b7363be92d18b138bb", "url": "https://github.com/Alluxio/alluxio/commit/d9111f6e42ea94bb8cdc99b7363be92d18b138bb", "message": "feedback", "committedDate": "2020-12-09T21:15:54Z", "type": "commit"}]}