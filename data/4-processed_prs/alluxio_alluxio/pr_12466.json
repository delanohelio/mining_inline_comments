{"pr_number": 12466, "pr_title": "Prevent the grpc reader from waiting for a server response", "pr_createdAt": "2020-11-06T00:01:34Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12466", "timeline": [{"oid": "f7918c10fef16debadf664e7d28eec789d8e0b81", "url": "https://github.com/Alluxio/alluxio/commit/f7918c10fef16debadf664e7d28eec789d8e0b81", "message": "Make a shared variable volatile", "committedDate": "2020-11-05T21:44:07Z", "type": "commit"}, {"oid": "53b8b30e424e9a0ce55e4bcfa92d5d1eb03e5e35", "url": "https://github.com/Alluxio/alluxio/commit/53b8b30e424e9a0ce55e4bcfa92d5d1eb03e5e35", "message": "Avoid waiting for server when reader is closing", "committedDate": "2020-11-06T00:00:34Z", "type": "commit"}, {"oid": "fae3866705eb26a62d2534f74fb993057caabae6", "url": "https://github.com/Alluxio/alluxio/commit/fae3866705eb26a62d2534f74fb993057caabae6", "message": "Fix test", "committedDate": "2020-11-06T01:41:05Z", "type": "commit"}, {"oid": "d3c356782a748c6c1589ab273a0148438274908e", "url": "https://github.com/Alluxio/alluxio/commit/d3c356782a748c6c1589ab273a0148438274908e", "message": "Fix tests", "committedDate": "2020-11-06T17:28:50Z", "type": "commit"}, {"oid": "6a34757f8a802dc8e10c49729895425f0161a67f", "url": "https://github.com/Alluxio/alluxio/commit/6a34757f8a802dc8e10c49729895425f0161a67f", "message": "Update test", "committedDate": "2020-11-06T18:18:09Z", "type": "commit"}, {"oid": "bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7", "url": "https://github.com/Alluxio/alluxio/commit/bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7", "message": "[WIP] test logging", "committedDate": "2020-11-06T21:30:58Z", "type": "commit"}, {"oid": "bc58b4add0b018635039c0dcdb14bd35ba964082", "url": "https://github.com/Alluxio/alluxio/commit/bc58b4add0b018635039c0dcdb14bd35ba964082", "message": "[WIP] logging", "committedDate": "2020-11-06T22:18:18Z", "type": "commit"}, {"oid": "53956500a62cb345aab7681d2321ceb0624137cd", "url": "https://github.com/Alluxio/alluxio/commit/53956500a62cb345aab7681d2321ceb0624137cd", "message": "[WIP] logging", "committedDate": "2020-11-06T23:01:41Z", "type": "commit"}, {"oid": "53956500a62cb345aab7681d2321ceb0624137cd", "url": "https://github.com/Alluxio/alluxio/commit/53956500a62cb345aab7681d2321ceb0624137cd", "message": "[WIP] logging", "committedDate": "2020-11-06T23:01:41Z", "type": "forcePushed"}, {"oid": "85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4", "url": "https://github.com/Alluxio/alluxio/commit/85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4", "message": "[WIP] more logging", "committedDate": "2020-11-09T18:38:27Z", "type": "commit"}, {"oid": "c324bf93b11348c56c44201350f660cceef3d0c1", "url": "https://github.com/Alluxio/alluxio/commit/c324bf93b11348c56c44201350f660cceef3d0c1", "message": "[WIP] more logging", "committedDate": "2020-11-09T19:15:09Z", "type": "commit"}, {"oid": "4a68c17642916d34e6328a16c5f88c9bf807d23e", "url": "https://github.com/Alluxio/alluxio/commit/4a68c17642916d34e6328a16c5f88c9bf807d23e", "message": "Revert \"[WIP] more logging\"\n\nThis reverts commit c324bf93b11348c56c44201350f660cceef3d0c1.", "committedDate": "2020-11-09T21:27:01Z", "type": "commit"}, {"oid": "103056d6b54bfc22aab6abf9e94b4bfc8deb0e64", "url": "https://github.com/Alluxio/alluxio/commit/103056d6b54bfc22aab6abf9e94b4bfc8deb0e64", "message": "Revert \"[WIP] more logging\"\n\nThis reverts commit 85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4.", "committedDate": "2020-11-09T21:27:32Z", "type": "commit"}, {"oid": "64d3266b7402b1d6abbfcf4358ae7a48287273fd", "url": "https://github.com/Alluxio/alluxio/commit/64d3266b7402b1d6abbfcf4358ae7a48287273fd", "message": "Revert \"[WIP] logging\"\n\nThis reverts commit 53956500a62cb345aab7681d2321ceb0624137cd.", "committedDate": "2020-11-09T21:27:53Z", "type": "commit"}, {"oid": "51ecf003ef84e8c55015c918ec528d6552812319", "url": "https://github.com/Alluxio/alluxio/commit/51ecf003ef84e8c55015c918ec528d6552812319", "message": "Revert \"[WIP] logging\"\n\nThis reverts commit bc58b4add0b018635039c0dcdb14bd35ba964082.", "committedDate": "2020-11-09T21:28:00Z", "type": "commit"}, {"oid": "80e64405d54c4eaf39b5a8ec91f7884b63b6fa0d", "url": "https://github.com/Alluxio/alluxio/commit/80e64405d54c4eaf39b5a8ec91f7884b63b6fa0d", "message": "Revert \"[WIP] test logging\"\n\nThis reverts commit bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7.", "committedDate": "2020-11-09T21:28:06Z", "type": "commit"}, {"oid": "92473d5211490f35dc21b3067baedc389535d9f5", "url": "https://github.com/Alluxio/alluxio/commit/92473d5211490f35dc21b3067baedc389535d9f5", "message": "Wait a short amount of time for the close to propagate", "committedDate": "2020-11-09T21:39:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzU2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520187563", "bodyText": "Is the default buffer size (16) not large enough? With 2MB message size we are looking at 32MB buffer per reader, this can grow quickly if multi-thread reading is used.", "author": "bf8086", "createdAt": "2020-11-09T23:31:17Z", "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -77,7 +78,9 @@\n   public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> rpcFunc,\n       int bufferSize, String description) {\n     LOG.debug(\"Opening stream ({})\", description);\n-    mResponses = new ArrayBlockingQueue<>(bufferSize);\n+    // Use an unlimited queue to avoid blocking the network threads. Depend on custom flow\n+    // control to limit the size of buffer.\n+    mResponses = new LinkedBlockingQueue<>();", "originalCommit": "92473d5211490f35dc21b3067baedc389535d9f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzc1Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520203756", "bodyText": "I originally saw this grow to around 20-25 before.\nI changed it back, but is it a bad thing to block the grpc thread? Because that will sometimes happen if the size is 16.", "author": "gpang", "createdAt": "2020-11-10T00:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNTUyOA==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520215528", "bodyText": "I think when a grpc thread is blocked it will potentially result in new thread being created for handling other concurrent RPC calls, so there is a potential overhead of one blocking thread per stream.", "author": "bf8086", "createdAt": "2020-11-10T00:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4OTc0OQ==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520189749", "bodyText": "Some applications may depend on the closure to be done on the server side so they can perform other operations on the file safely. Having the reader skip the wait may cause subsequent operations to fail.", "author": "bf8086", "createdAt": "2020-11-09T23:37:08Z", "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcDataReader.java", "diffHunk": "@@ -168,7 +169,19 @@ public void close() throws IOException {\n         return;\n       }\n       mStream.close();\n-      mStream.waitForComplete(mDataTimeoutMs);\n+\n+      // When a reader is closed, there is technically nothing the client requires from the server.\n+      // However, the server does need to cleanup resources for a client close(), including closing\n+      // or canceling any temp blocks. Therefore, we should wait for some amount of time for the\n+      // server to finish cleanup, but it should not be very long (since the client is finished\n+      // with the read). Also, if there is any error when waiting for the complete, it should be\n+      // ignored since again, the client is completely finished with the read.\n+      try {\n+        // Wait a short time for the server to finish the close, and then let the client continue.\n+        mStream.waitForComplete(5 * Constants.SECOND_MS);", "originalCommit": "92473d5211490f35dc21b3067baedc389535d9f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5NDQ0MA==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520794440", "bodyText": "If another client tries to read this block, there shouldn't be an issue, since they would only be grabbing a read lock, which should be allowed. I don't think another client can write lock the block, since Alluxio blocks are write-once-read-many. Can you think of any other problem behavior?\nIdeally, I would have just removed this waitForComplete entirely, but there are some tests which require some async caching tasks to complete (even though async caching in general is best-effort). Because of these tests, waiting some short amount of time is beneficial for the tests.", "author": "gpang", "createdAt": "2020-11-10T18:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4OTc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMTE3MA==", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520831170", "bodyText": "One possible issue is when the same client which just closes a stream tries to do another write operation such as rename or delete. If the stream close function does not wait until server release the lock, the subsequent write operation may fail when attempting to acquire a lock. This breaks the file stream contract that many applications assumes.", "author": "bf8086", "createdAt": "2020-11-10T19:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4OTc0OQ=="}], "type": "inlineReview"}, {"oid": "47d0833fff093d88284d215771877974f8098148", "url": "https://github.com/Alluxio/alluxio/commit/47d0833fff093d88284d215771877974f8098148", "message": "Limit buffers", "committedDate": "2020-11-10T00:14:53Z", "type": "commit"}, {"oid": "cdce7fc62ea0db739424d07517f602eb034b389d", "url": "https://github.com/Alluxio/alluxio/commit/cdce7fc62ea0db739424d07517f602eb034b389d", "message": "Add client parameter", "committedDate": "2020-11-11T00:15:39Z", "type": "commit"}]}