{"pr_number": 10968, "pr_title": "Reduce getWorkerInfoList RPCs on client and job servers", "pr_createdAt": "2020-02-21T08:54:29Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10968", "timeline": [{"oid": "847cf041b354a5b2232c138177280c3efb32dea0", "url": "https://github.com/Alluxio/alluxio/commit/847cf041b354a5b2232c138177280c3efb32dea0", "message": "Keep workerInfoList cached across InStream and OutStream", "committedDate": "2020-02-21T08:43:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5MzY1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382693655", "bodyText": "Should we just use the guava cache, like here: https://github.com/Alluxio/alluxio/pull/10963/files#diff-2d2ca0120802269babf6451df30b6279R273", "author": "gpang", "createdAt": "2020-02-21T16:55:23Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -149,6 +154,14 @@\n   /** Whether to do URI scheme validation for file systems using this context.  */\n   private boolean mUriValidationEnabled = true;\n \n+  /** Cached map for workers. */\n+  @GuardedBy(\"this\")\n+  private volatile List<BlockWorkerInfo> mWorkerInfoList = null;", "originalCommit": "847cf041b354a5b2232c138177280c3efb32dea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMzQ5Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382733497", "bodyText": "Agree. Let's at least keep a TODO. Leave it to @LuQQiu to decide if we want to switch to Guava Cache in this PR", "author": "apc999", "createdAt": "2020-02-21T18:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5MzY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1MjEyMA==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382752120", "bodyText": "@gpang I am not quite familiar of guava cache, but according to my understanding, if I define refreshAfterWrite(interval), it will refresh periodically no matter the value is being get or not. This makes sense on the leading master side since we want the cached worker info list up to date enough.\nHowever, on the client-side, a client may need worker info list for some period of time and no need it anymore. Using loadingcache and refresh periodically may introduce unneeded RPC call to the leading master.", "author": "LuQQiu", "createdAt": "2020-02-21T19:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5MzY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5NDU1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382694550", "bodyText": "It seems like the only difference between this method and getAllWorkers is that this one is cached (so maybe stale)? It is not clear from the method names, and or java doc.", "author": "gpang", "createdAt": "2020-02-21T16:56:49Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes\n+   */\n+  public synchronized List<BlockWorkerInfo> getEligibleWorkers() throws IOException {", "originalCommit": "847cf041b354a5b2232c138177280c3efb32dea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMzk5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382733992", "bodyText": "Agree. I would rename this to getCachedWorkers", "author": "apc999", "createdAt": "2020-02-21T18:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5NDU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxMzg3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382713876", "bodyText": "Change all the getAllWorkers to getEligibleWorkers?\ni tested locally that if all job servers used getEligibleWorkers() instead of getAllWorkers(), a large amount of getWorkerInfoList call will be reduced on the job server side.\nThis is because instead of creating a AlluxioBlockStore each time when needed, Those context used in job server definitions and job utils internally contain a shared JobServerContext which contains a FileSystemContext.\nThis FileSystemContext is shared so that the cached worker info list is shared.", "author": "LuQQiu", "createdAt": "2020-02-21T17:37:22Z", "path": "job/server/src/main/java/alluxio/job/plan/migrate/MigrateDefinition.java", "diffHunk": "@@ -181,8 +181,7 @@ private void checkMigrateValid(MigrateConfig config, FileSystem fs) throws Excep\n     for (WorkerInfo workerInfo : jobWorkerInfoList) {\n       hostnameToWorker.put(workerInfo.getAddress().getHost(), workerInfo);\n     }\n-    List<BlockWorkerInfo> alluxioWorkerInfoList =\n-        AlluxioBlockStore.create(context.getFsContext()).getAllWorkers();\n+    List<BlockWorkerInfo> alluxioWorkerInfoList = context.getFsContext().getAllWorkers();", "originalCommit": "847cf041b354a5b2232c138177280c3efb32dea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMjExOA==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382732118", "bodyText": "agree, but let's still keep getAllWorkers in case client need all workers for certain reasons.\nalso , let's update the javadoc of getAllWorkers to indicate it is expensive", "author": "apc999", "createdAt": "2020-02-21T18:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxMzg3Ng=="}], "type": "inlineReview"}, {"oid": "bc3d51ed945c72b2dba43ce38eb4c167934ded38", "url": "https://github.com/Alluxio/alluxio/commit/bc3d51ed945c72b2dba43ce38eb4c167934ded38", "message": "Change to use getEligibleWorkers and fix tests", "committedDate": "2020-02-21T18:44:44Z", "type": "commit"}, {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f", "url": "https://github.com/Alluxio/alluxio/commit/033d3263dddefad5de9ceddee3d559816e3b336f", "message": "Rename getEligibleWorkers to getCachedWorkers", "committedDate": "2020-02-21T19:02:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMzk3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382823979", "bodyText": "can you mention in javadoc this method returning list of workers is relatively cheap as the result  is cached, but may not be update to date and refer to method getAllWorkers if users want to get most update-to-date list?", "author": "apc999", "createdAt": "2020-02-21T21:54:56Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes", "originalCommit": "033d3263dddefad5de9ceddee3d559816e3b336f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1MDIwNw==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382850207", "bodyText": "Added! thanks", "author": "LuQQiu", "createdAt": "2020-02-21T23:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMzk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTkwOA==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382825908", "bodyText": "can you indicate that this method is more expensive than getCachedWorkers?", "author": "apc999", "createdAt": "2020-02-21T21:59:58Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes\n+   */\n+  public synchronized List<BlockWorkerInfo> getCachedWorkers() throws IOException {\n+    if (mWorkerInfoList == null || mWorkerRefreshPolicy.attempt()) {\n+      mWorkerInfoList = getAllWorkers();\n+    }\n+    return mWorkerInfoList;\n+  }\n+\n+  /**\n+   * @return the info of all block workers", "originalCommit": "033d3263dddefad5de9ceddee3d559816e3b336f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1MDIzMg==", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382850232", "bodyText": "Added thanks", "author": "LuQQiu", "createdAt": "2020-02-21T23:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTkwOA=="}], "type": "inlineReview"}, {"oid": "cf8c6fa5891089151aa5c0912b1734b9d629de9b", "url": "https://github.com/Alluxio/alluxio/commit/cf8c6fa5891089151aa5c0912b1734b9d629de9b", "message": "Add descriptions", "committedDate": "2020-02-21T22:58:26Z", "type": "commit"}, {"oid": "e5cf424ac212dad71aa2e96f88e6ca1695d63e3d", "url": "https://github.com/Alluxio/alluxio/commit/e5cf424ac212dad71aa2e96f88e6ca1695d63e3d", "message": "Fix java docs", "committedDate": "2020-02-21T23:19:05Z", "type": "commit"}]}