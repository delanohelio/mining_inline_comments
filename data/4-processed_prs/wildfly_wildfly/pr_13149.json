{"pr_number": 13149, "pr_title": "[WFLY-13293] When deploying \"ROOT.war\" in EAP7.x, the context root value output through jboss-cli is not valid", "pr_createdAt": "2020-03-26T16:56:00Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13149", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r399355006", "bodyText": "I don't have time to properly review this now, but this doesn't feel right. DUPs looking up services isn't great as it's only safe if the DeploymentUnitPhaseService running the DUP has a dependency on the service being looked up. Which is fragile.", "author": "bstansberry", "createdAt": "2020-03-27T15:38:18Z", "path": "undertow/src/main/java/org/wildfly/extension/undertow/deployment/UndertowDeploymentProcessor.java", "diffHunk": "@@ -198,8 +199,15 @@ public void deploy(final DeploymentPhaseContext phaseContext) throws DeploymentU\n \n         String serverInstanceName = warMetaData.getMergedJBossWebMetaData().getServerInstanceName() == null ? defaultServerForDeployment : warMetaData.getMergedJBossWebMetaData().getServerInstanceName();\n         String hostName = hostNameOfDeployment(warMetaData, defaultHostForDeployment);\n+        CapabilityServiceSupport support = deploymentUnit.getAttachment(Attachments.CAPABILITY_SERVICE_SUPPORT);\n+        ServiceName hostServiceName = support.getCapabilityServiceName(Capabilities.CAPABILITY_HOST, serverInstanceName, hostName);\n+        ServiceController<?> hostService = phaseContext.getServiceRegistry().getService(hostServiceName);", "originalCommit": "abbc908906ea9c1eb1c50bac31c2c16a84693b59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2MTUxMw==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r399961513", "bodyText": "Thanks for looking this Brian! I tried first to fill the context root inside the service instead of the processor but the problem is that the context path is also used to name/locate the service (as an alias) here. So I didn't see any other alternative that trying to get the host and know the defaultWebModule inside the processor to create the alias with the right and final context. I'll ping you later.", "author": "rmartinc", "createdAt": "2020-03-30T06:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxMjM4OA==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r403712388", "bodyText": "@rmartinc Have a look at DefaultDeploymentMappingProvider. It was written for this sort of problem. I think that can be adapted.  Add some sort of reverse lookup function to it.\nIt's a public class but it's meant only for use internal to the subsystem so it can changed as needed.", "author": "bstansberry", "createdAt": "2020-04-05T14:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwNzQ0Nw==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r404007447", "bodyText": "Thanks a lot @bstansberry! I'm very sorry but, although the solution was just before my eyes, I didn't see it. I should have noticed that class. :-(\nNo need to change the class at all, with the current map it's possible to see if the deployment is the default one for that server/host.\nI have performed the changes and rebased. Let's wait the tests. And let me know if you need something else.", "author": "rmartinc", "createdAt": "2020-04-06T11:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA0NzM1MA==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r404047350", "bodyText": "Ah! I didn't remove the public modifier because the class is used in two packages (org.wildfly.extension.undertow.deployment and org.wildfly.extension.undertow). I forgot to mention that.", "author": "rmartinc", "createdAt": "2020-04-06T12:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg1ODc1Ng==", "url": "https://github.com/wildfly/wildfly/pull/13149#discussion_r405858756", "bodyText": "Re the public modifier, that's fine; I wasn't looking to have that changed. I just meant not to worry that the class was public so you had to worry about API compatibility. You could have changed it as needed. But not needing to change it is good too!", "author": "bstansberry", "createdAt": "2020-04-08T22:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAwNg=="}], "type": "inlineReview"}, {"oid": "be154ed721a48ca91dcc8b904c0aafab5a1082dd", "url": "https://github.com/wildfly/wildfly/commit/be154ed721a48ca91dcc8b904c0aafab5a1082dd", "message": "[WFLY-13293] When deploying \"ROOT.war\" in EAP7.x, the context root value output through jboss-cli is not valid", "committedDate": "2020-04-06T07:43:30Z", "type": "commit"}, {"oid": "be154ed721a48ca91dcc8b904c0aafab5a1082dd", "url": "https://github.com/wildfly/wildfly/commit/be154ed721a48ca91dcc8b904c0aafab5a1082dd", "message": "[WFLY-13293] When deploying \"ROOT.war\" in EAP7.x, the context root value output through jboss-cli is not valid", "committedDate": "2020-04-06T07:43:30Z", "type": "forcePushed"}]}