{"pr_number": 13750, "pr_title": "[WFLY-13991]: Artemis should not delete corrupt log files.", "pr_createdAt": "2020-11-30T10:02:49Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13750", "timeline": [{"oid": "07b3f991783645e792e918d7254b479264bd46b2", "url": "https://github.com/wildfly/wildfly/commit/07b3f991783645e792e918d7254b479264bd46b2", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-01-25T08:57:52Z", "type": "forcePushed"}, {"oid": "1f270dfd46526b4bdcf15bb025680a0734d76e8b", "url": "https://github.com/wildfly/wildfly/commit/1f270dfd46526b4bdcf15bb025680a0734d76e8b", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-01-25T13:59:41Z", "type": "forcePushed"}, {"oid": "9291916ec62a6dab26efc39e140416ee9071609f", "url": "https://github.com/wildfly/wildfly/commit/9291916ec62a6dab26efc39e140416ee9071609f", "message": "[(nobranch,rebasingWFLY-13991)]:  [WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-03T14:32:28Z", "type": "forcePushed"}, {"oid": "dcad58dfdc5caba5b7d128c4e9b0e26db62b7de0", "url": "https://github.com/wildfly/wildfly/commit/dcad58dfdc5caba5b7d128c4e9b0e26db62b7de0", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-03T15:09:14Z", "type": "forcePushed"}, {"oid": "a63555258ec916b9c2a113206d4b7f52129d675b", "url": "https://github.com/wildfly/wildfly/commit/a63555258ec916b9c2a113206d4b7f52129d675b", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-10T10:51:51Z", "type": "forcePushed"}, {"oid": "728477fab7b5ca1312d8406dffdd51d3421361db", "url": "https://github.com/wildfly/wildfly/commit/728477fab7b5ca1312d8406dffdd51d3421361db", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-16T09:26:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzUxMjY0Ng==", "url": "https://github.com/wildfly/wildfly/pull/13750#discussion_r577512646", "bodyText": "Can you please parametrize this hard-coded path? Maybe that something like this could help:\n            File target = new File(System.getProperty(\"jboss.home\"), \"standalone/data/activemq/journal/attic/\");", "author": "marekkopecky", "createdAt": "2021-02-17T10:52:43Z", "path": "testsuite/integration/manualmode/src/test/java/org/jboss/as/test/manualmode/messaging/CorruptedLogTestCase.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2012, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.jboss.as.test.manualmode.messaging;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import org.jboss.arquillian.container.test.api.RunAsClient;\n+import org.jboss.arquillian.junit.Arquillian;\n+import org.jboss.as.controller.client.helpers.Operations;\n+\n+import java.net.UnknownHostException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.stream.Collectors;\n+import java.util.Properties;\n+import java.util.stream.Stream;\n+import javax.jms.ConnectionFactory;\n+import javax.jms.JMSConsumer;\n+import javax.jms.JMSContext;\n+import javax.jms.JMSProducer;\n+import javax.jms.Queue;\n+import javax.jms.TextMessage;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import org.apache.commons.lang3.RandomStringUtils;\n+\n+import org.jboss.arquillian.container.test.api.ContainerController;\n+import org.jboss.arquillian.test.api.ArquillianResource;\n+import org.jboss.as.arquillian.container.ManagementClient;\n+import org.jboss.as.repository.PathUtil;\n+import org.jboss.as.test.integration.common.jms.JMSOperations;\n+import org.jboss.as.test.integration.common.jms.JMSOperationsProvider;\n+import org.jboss.as.test.shared.TestSuiteEnvironment;\n+import org.jboss.as.test.shared.TimeoutUtil;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+/**\n+ *\n+ * @author Emmanuel Hugonnet (c) 2020 Red Hat, Inc.\n+ */\n+@RunAsClient()\n+@RunWith(Arquillian.class)\n+public class CorruptedLogTestCase {\n+\n+    private static final String DEFAULT_FULL_JBOSSAS = \"default-full-jbossas\";\n+\n+    @ArquillianResource\n+    protected static ContainerController container;\n+\n+    private ManagementClient managementClient;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        if (!container.isStarted(DEFAULT_FULL_JBOSSAS)) {\n+            container.start(DEFAULT_FULL_JBOSSAS);\n+        }\n+        managementClient = createManagementClient();\n+        JMSOperations jmsOperations = JMSOperationsProvider.getInstance(managementClient.getControllerClient());\n+        setJournalSize(100L);\n+        jmsOperations.createJmsQueue(\"corrupted\", \"java:jboss/exported/\" + \"queue/corrupted\");\n+        jmsOperations.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);\n+        container.start(DEFAULT_FULL_JBOSSAS);\n+        managementClient = createManagementClient();\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        JMSOperations jmsOperations = JMSOperationsProvider.getInstance(managementClient.getControllerClient());\n+        jmsOperations.removeJmsQueue(\"corrupted\");\n+        managementClient.getControllerClient().execute(Operations.createUndefineAttributeOperation(jmsOperations.getServerAddress(), \"journal-file-size\"));\n+        managementClient.getControllerClient().execute(Operations.createUndefineAttributeOperation(jmsOperations.getServerAddress(), \"journal-max-attic-files\"));\n+        jmsOperations.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);\n+        PathUtil.deleteRecursively(new File(\"target/wildfly/standalone/data/activemq/journal/attic/\").toPath());\n+    }\n+\n+    /**\n+     * Set the journal file size to 100k.\n+     * Send 100 messages of 20k\n+     * Set the journal file size to 200k\n+     * Restart the server\n+     * Consume the messages\n+     * Should have journal files in the attic\n+     *\n+     */\n+    @Test\n+    public void testCorruptedJournal() throws NamingException, IOException {\n+        InitialContext remoteContext = createJNDIContext();\n+        ConnectionFactory cf = (ConnectionFactory) remoteContext.lookup(\"jms/RemoteConnectionFactory\");\n+        Queue queue = (Queue) remoteContext.lookup(\"queue/corrupted\");\n+        try (JMSContext context = cf.createContext(\"guest\", \"guest\", JMSContext.AUTO_ACKNOWLEDGE);) {\n+            JMSProducer producer = context.createProducer();\n+            for (int i = 0; i < 100; i++) {\n+                producer.send(queue, context.createTextMessage(RandomStringUtils.randomAlphabetic(20000)));\n+            }\n+        }\n+        setJournalSize(200L);\n+        remoteContext.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);\n+        container.start(DEFAULT_FULL_JBOSSAS);\n+        managementClient = createManagementClient();\n+        remoteContext = createJNDIContext();\n+        cf = (ConnectionFactory) remoteContext.lookup(\"jms/RemoteConnectionFactory\");\n+        queue = (Queue) remoteContext.lookup(\"queue/corrupted\");\n+        try (JMSContext context = cf.createContext(\"guest\", \"guest\", JMSContext.AUTO_ACKNOWLEDGE);) {\n+            JMSConsumer consumer = context.createConsumer(queue);\n+            for (int i = 0; i < 100; i++) {\n+                TextMessage message = (TextMessage) consumer.receive(TimeoutUtil.adjust(500));\n+                Assert.assertNotNull(message);\n+            }\n+        }\n+        Path attic = new File(\"target/wildfly/standalone/data/activemq/journal/attic/\").toPath();\n+        Assert.assertTrue(\"Couldn't find \" + attic.toAbsolutePath(), Files.exists(attic));\n+        Assert.assertTrue(Files.isDirectory(attic));\n+        try (Stream<Path> stream = Files.list(attic)){\n+            long nbAtticFiles = stream.collect(Collectors.counting());\n+            Assert.assertTrue(nbAtticFiles > 0L);\n+        }\n+    }\n+\n+    @Test\n+    public void testCorruptedJournalNotSaved() throws NamingException, IOException {\n+        JMSOperations jmsOperations = JMSOperationsProvider.getInstance(managementClient.getControllerClient());\n+        managementClient.getControllerClient().execute(Operations.createWriteAttributeOperation(jmsOperations.getServerAddress(), \"journal-max-attic-files\", 0));\n+        jmsOperations.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);\n+        PathUtil.deleteRecursively(new File(\"target/wildfly/standalone/data/activemq/journal/attic/\").toPath());", "originalCommit": "728477fab7b5ca1312d8406dffdd51d3421361db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzUxNzA2OQ==", "url": "https://github.com/wildfly/wildfly/pull/13750#discussion_r577517069", "bodyText": "Now we have two test methods. First call of this method (and the following start in the following setup method) seems to be useless. Can you call this container.stop after all test methods are executed (and not after each test method)? Maybe that ServerSetupTask could help (like in this example)?", "author": "marekkopecky", "createdAt": "2021-02-17T10:59:12Z", "path": "testsuite/integration/manualmode/src/test/java/org/jboss/as/test/manualmode/messaging/CorruptedLogTestCase.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2012, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.jboss.as.test.manualmode.messaging;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import org.jboss.arquillian.container.test.api.RunAsClient;\n+import org.jboss.arquillian.junit.Arquillian;\n+import org.jboss.as.controller.client.helpers.Operations;\n+\n+import java.net.UnknownHostException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.stream.Collectors;\n+import java.util.Properties;\n+import java.util.stream.Stream;\n+import javax.jms.ConnectionFactory;\n+import javax.jms.JMSConsumer;\n+import javax.jms.JMSContext;\n+import javax.jms.JMSProducer;\n+import javax.jms.Queue;\n+import javax.jms.TextMessage;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import org.apache.commons.lang3.RandomStringUtils;\n+\n+import org.jboss.arquillian.container.test.api.ContainerController;\n+import org.jboss.arquillian.test.api.ArquillianResource;\n+import org.jboss.as.arquillian.container.ManagementClient;\n+import org.jboss.as.repository.PathUtil;\n+import org.jboss.as.test.integration.common.jms.JMSOperations;\n+import org.jboss.as.test.integration.common.jms.JMSOperationsProvider;\n+import org.jboss.as.test.shared.TestSuiteEnvironment;\n+import org.jboss.as.test.shared.TimeoutUtil;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+/**\n+ *\n+ * @author Emmanuel Hugonnet (c) 2020 Red Hat, Inc.\n+ */\n+@RunAsClient()\n+@RunWith(Arquillian.class)\n+public class CorruptedLogTestCase {\n+\n+    private static final String DEFAULT_FULL_JBOSSAS = \"default-full-jbossas\";\n+\n+    @ArquillianResource\n+    protected static ContainerController container;\n+\n+    private ManagementClient managementClient;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        if (!container.isStarted(DEFAULT_FULL_JBOSSAS)) {\n+            container.start(DEFAULT_FULL_JBOSSAS);\n+        }\n+        managementClient = createManagementClient();\n+        JMSOperations jmsOperations = JMSOperationsProvider.getInstance(managementClient.getControllerClient());\n+        setJournalSize(100L);\n+        jmsOperations.createJmsQueue(\"corrupted\", \"java:jboss/exported/\" + \"queue/corrupted\");\n+        jmsOperations.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);\n+        container.start(DEFAULT_FULL_JBOSSAS);\n+        managementClient = createManagementClient();\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        JMSOperations jmsOperations = JMSOperationsProvider.getInstance(managementClient.getControllerClient());\n+        jmsOperations.removeJmsQueue(\"corrupted\");\n+        managementClient.getControllerClient().execute(Operations.createUndefineAttributeOperation(jmsOperations.getServerAddress(), \"journal-file-size\"));\n+        managementClient.getControllerClient().execute(Operations.createUndefineAttributeOperation(jmsOperations.getServerAddress(), \"journal-max-attic-files\"));\n+        jmsOperations.close();\n+        managementClient.close();\n+        container.stop(DEFAULT_FULL_JBOSSAS);", "originalCommit": "728477fab7b5ca1312d8406dffdd51d3421361db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzUxODIyMg==", "url": "https://github.com/wildfly/wildfly/pull/13750#discussion_r577518222", "bodyText": "Can you please add some general javadoc here? Or add javadoc to each testmethod? So far just one test method has javadoc", "author": "marekkopecky", "createdAt": "2021-02-17T11:00:53Z", "path": "testsuite/integration/manualmode/src/test/java/org/jboss/as/test/manualmode/messaging/CorruptedLogTestCase.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2012, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.jboss.as.test.manualmode.messaging;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import org.jboss.arquillian.container.test.api.RunAsClient;\n+import org.jboss.arquillian.junit.Arquillian;\n+import org.jboss.as.controller.client.helpers.Operations;\n+\n+import java.net.UnknownHostException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.stream.Collectors;\n+import java.util.Properties;\n+import java.util.stream.Stream;\n+import javax.jms.ConnectionFactory;\n+import javax.jms.JMSConsumer;\n+import javax.jms.JMSContext;\n+import javax.jms.JMSProducer;\n+import javax.jms.Queue;\n+import javax.jms.TextMessage;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import org.apache.commons.lang3.RandomStringUtils;\n+\n+import org.jboss.arquillian.container.test.api.ContainerController;\n+import org.jboss.arquillian.test.api.ArquillianResource;\n+import org.jboss.as.arquillian.container.ManagementClient;\n+import org.jboss.as.repository.PathUtil;\n+import org.jboss.as.test.integration.common.jms.JMSOperations;\n+import org.jboss.as.test.integration.common.jms.JMSOperationsProvider;\n+import org.jboss.as.test.shared.TestSuiteEnvironment;\n+import org.jboss.as.test.shared.TimeoutUtil;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+/**", "originalCommit": "728477fab7b5ca1312d8406dffdd51d3421361db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "330adf4766460f93afd4e264ccf7b4c6dafd928b", "url": "https://github.com/wildfly/wildfly/commit/330adf4766460f93afd4e264ccf7b4c6dafd928b", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-17T15:12:50Z", "type": "forcePushed"}, {"oid": "725e84b342021ac61f0f80d09a5bb0e25803a4df", "url": "https://github.com/wildfly/wildfly/commit/725e84b342021ac61f0f80d09a5bb0e25803a4df", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-17T18:30:22Z", "type": "forcePushed"}, {"oid": "5c28b0cd3a5b2851c623559d349790cc9a94f180", "url": "https://github.com/wildfly/wildfly/commit/5c28b0cd3a5b2851c623559d349790cc9a94f180", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-19T18:55:30Z", "type": "forcePushed"}, {"oid": "65b8169b86cfbc3465f39416eac70a8a7c4d76ce", "url": "https://github.com/wildfly/wildfly/commit/65b8169b86cfbc3465f39416eac70a8a7c4d76ce", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-22T08:46:28Z", "type": "commit"}, {"oid": "65b8169b86cfbc3465f39416eac70a8a7c4d76ce", "url": "https://github.com/wildfly/wildfly/commit/65b8169b86cfbc3465f39416eac70a8a7c4d76ce", "message": "[WFLY-13991]: Artemis should not delete corrupt log files.\n\n* Adding attribute max-attic-files on the journal definition.\n\nJira: https://issues.redhat.com/browse/WFLY-13991", "committedDate": "2021-02-22T08:46:28Z", "type": "forcePushed"}]}