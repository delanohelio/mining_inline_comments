{"pr_number": 13827, "pr_title": "[WFLY-14219] Upgrade module descriptors to 1.9.", "pr_createdAt": "2020-12-16T07:10:46Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13827", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkxNTkyMA==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r546915920", "bodyText": "Everywhere you identified proper Java's module dependencies like in this case @boris-unckel\nyou can eliminate dependency on deprecated 'wrapper' javax.api module that\nwas bringing in all dependencies you identified here.", "author": "ropalka", "createdAt": "2020-12-21T20:31:33Z", "path": "ee-feature-pack/common/src/main/resources/modules/system/layers/base/com/fasterxml/jackson/core/jackson-databind/main/module.xml", "diffHunk": "@@ -21,12 +21,16 @@\n   ~ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n   ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n   -->\n-<module xmlns=\"urn:jboss:module:1.5\" name=\"com.fasterxml.jackson.core.jackson-databind\">\n+<module xmlns=\"urn:jboss:module:1.9\" name=\"com.fasterxml.jackson.core.jackson-databind\">\n+\n      <resources>\n         <artifact name=\"${com.fasterxml.jackson.core:jackson-databind}\"/>\n     </resources>\n-\n     <dependencies>\n+        <module name=\"java.desktop\"/>\n+        <module name=\"java.logging\"/>\n+        <module name=\"java.sql\"/>\n+        <module name=\"java.xml\"/>", "originalCommit": "9a4f76ca07feab66f74e1936392c166561fe579e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQ2OTQ1NA==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r548469454", "bodyText": "@ropalka I have removed the dependencies, there is a comment in place now: <!--WFLY-14219 Remove deprecated <module name=\"javax.api\"/> -->\nThe JDK8 fails are not caused by the removal. I have run a test, undoing the removal everywhere, JDK8 still fails within the same tests and reason. One can reproduce that JDK11 runs without error and JDK8 fails. Can you please give advice:\n\nHowto make jboss modules give a relevant and good trace to analyse the issue?\nWhat rules are relevant for the module descriptors to work with both JDK8 and JDK11?\n\n\nIs the order of modules relevant: all java.* and/or jdk.* modules first? all java.* and/or jdk.* modules last?\nDoes the jdk.unsupported module work with Java 8 or is the WildFly-Core module \"sun.jdk\" still needed (even it is deprecated?)\nOther rules?\n\nSample for the first (others completely different)\n2020-12-23 19:22:01,592 WARN  [org.jboss.modules.define] (Weld Thread Pool -- 3) Failed to define class org.wildfly.test.integration.microprofile.health.MicroProfileHealthCheckOperationTestCase in Module \"deployment.MicroProfileHealthTestCase.war\" from Service Module Loader: java.lang.NoClassDefFoundError: Failed to link org/wildfly/test/integration/microprofile/health/MicroProfileHealthCheckOperationTestCase (Module \"deployment.MicroProfileHealthTestCase.war\" from Service Module Loader): org/wildfly/test/integration/microprofile/health/MicroProfileHealthTestBase at java.lang.ClassLoader.defineClass1(Native Method) at java.lang.ClassLoader.defineClass(ClassLoader.java:756) at java.lang.ClassLoader.defineClass(ClassLoader.java:832) at org.jboss.modules.ModuleClassLoader.doDefineOrLoadClass(ModuleClassLoader.java:424) at org.jboss.modules.ModuleClassLoader.defineClass(ModuleClassLoader.java:555) at org.jboss.modules.ModuleClassLoader.loadClassLocal(ModuleClassLoader.java:339) at org.jboss.modules.ModuleClassLoader$1.loadClassLocal(ModuleClassLoader.java:126) at org.jboss.modules.Module.loadModuleClass(Module.java:753) at org.jboss.modules.ModuleClassLoader.findClass(ModuleClassLoader.java:247) at org.jboss.modules.ConcurrentClassLoader.performLoadClassUnchecked(ConcurrentClassLoader.java:410) at org.jboss.modules.ConcurrentClassLoader.performLoadClass(ConcurrentClassLoader.java:398) at org.jboss.modules.ConcurrentClassLoader.loadClass(ConcurrentClassLoader.java:116) at org.jboss.as.weld.WeldModuleResourceLoader.classForName(WeldModuleResourceLoader.java:68) at org.jboss.weld.bootstrap.AnnotatedTypeLoader.loadClass(AnnotatedTypeLoader.java:82) at org.jboss.weld.bootstrap.AnnotatedTypeLoader.loadAnnotatedType(AnnotatedTypeLoader.java:62) at org.jboss.weld.bootstrap.FastAnnotatedTypeLoader.loadAnnotatedType(FastAnnotatedTypeLoader.java:108) at org.jboss.weld.bootstrap.BeanDeployer.addClass(BeanDeployer.java:87) at org.jboss.weld.bootstrap.ConcurrentBeanDeployer$1.doWork(ConcurrentBeanDeployer.java:55) at org.jboss.weld.bootstrap.ConcurrentBeanDeployer$1.doWork(ConcurrentBeanDeployer.java:52) at org.jboss.weld.executor.IterativeWorkerTaskFactory$1.call(IterativeWorkerTaskFactory.java:62) at org.jboss.weld.executor.IterativeWorkerTaskFactory$1.call(IterativeWorkerTaskFactory.java:55) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) at org.jboss.threads.JBossThread.run(JBossThread.java:513)", "author": "boris-unckel", "createdAt": "2020-12-24T09:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkxNTkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzMTY1MA==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r549631650", "bodyText": "@ropalka I have tested some more: For every module which is imported with service somewhere I added a provides-service-withclass section in the module descriptor, based on the services in the corresponding JAR. This does not help for any of the JDK8 cases, but totally breaks the JDK11 build. I assume modules which import several other modules with their services re-export them, currently implicit and with my change lacking the explicit way.\nI will stop for now and wait for your analysis and advice.", "author": "boris-unckel", "createdAt": "2020-12-29T09:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkxNTkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUzODkxNQ==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r550538915", "bodyText": "This needs a dep on java.logging added. I tried that at #13840 and the many failures went away.", "author": "bstansberry", "createdAt": "2020-12-31T16:34:44Z", "path": "ee-feature-pack/common/src/main/resources/modules/system/layers/base/org/infinispan/protostream/main/module.xml", "diffHunk": "@@ -32,8 +33,9 @@\n     </resources>\n \n     <dependencies>\n-        <module name=\"javax.api\"/>\n+        <!--WFLY-14219 Remove deprecated <module name=\"javax.api\"/> -->", "originalCommit": "5d61ec1269b0e84dad16fe63dbbe6d538c854ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDU4MjY5Nw==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r550582697", "bodyText": "Thanks, resolved.", "author": "boris-unckel", "createdAt": "2020-12-31T17:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUzODkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUzOTgyNg==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r550539826", "bodyText": "Shouldn't the 'slot' value now be incorporated in the 'name'?  @ropalka ?", "author": "bstansberry", "createdAt": "2020-12-31T16:35:56Z", "path": "servlet-feature-pack/galleon-feature-pack/src/main/resources/packages/product.conf/content/modules/system/layers/base/org/jboss/as/product/wildfly-web/module.xml", "diffHunk": "@@ -22,7 +22,7 @@\n   ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n   -->\n \n-<module xmlns=\"urn:jboss:module:1.5\" name=\"org.jboss.as.product\" slot=\"wildfly-web\">\n+<module xmlns=\"urn:jboss:module:1.9\" name=\"org.jboss.as.product\">", "originalCommit": "5d61ec1269b0e84dad16fe63dbbe6d538c854ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDY4MzMzNg==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r550683336", "bodyText": "@boris-unkel I looked and it should be made part of the name, separated by a colon:\nname=\"org.jboss.as.product:wildfly-web\"\nThat's not needed for cases where the slot attribute had the value 'main', but is needed for other values.", "author": "bstansberry", "createdAt": "2020-12-31T20:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUzOTgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDY5NDEyMg==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r550694122", "bodyText": "Thanks, I improved that also. I'm wondering why microprofile health tests under java 8 seem to work now. Did I miss something?", "author": "boris-unckel", "createdAt": "2020-12-31T21:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUzOTgyNg=="}], "type": "inlineReview"}, {"oid": "b1a793134c2c09b588d25a0633d8684ecb65c4cb", "url": "https://github.com/wildfly/wildfly/commit/b1a793134c2c09b588d25a0633d8684ecb65c4cb", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-02T13:32:58Z", "type": "forcePushed"}, {"oid": "3e302aea7f1f4427b79287a728f55d05a7cb4007", "url": "https://github.com/wildfly/wildfly/commit/3e302aea7f1f4427b79287a728f55d05a7cb4007", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-16T20:06:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTgyNjUzMA==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r559826530", "bodyText": "The ee-9 variant of this has export=true:\n        <!-- java.instrument export due to jdeps result -->\n        <module name=\"java.instrument\" export=\"true\"/>\n\nI think that's needed here as ClassTransformer throws IllegalClassFormatException in JPA 2.2 as well:\nhttps://github.com/eclipse-ee4j/jpa-api/blob/2.2-2.2.3-RELEASE/api/src/main/java/javax/persistence/spi/ClassTransformer.java#L61", "author": "bstansberry", "createdAt": "2021-01-18T22:54:24Z", "path": "ee-feature-pack/ee-8-api/src/main/resources/modules/system/layers/base/javax/persistence/api/main/module.xml", "diffHunk": "@@ -22,13 +22,17 @@\n   ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n   -->\n \n-<module xmlns=\"urn:jboss:module:1.7\" name=\"javax.persistence.api\">\n-    <dependencies>\n-        <!-- PersistenceUnitInfo needs javax.sql.DataSource -->\n-        <module name=\"javax.api\" export=\"true\"/>\n-    </dependencies>\n+<module xmlns=\"urn:jboss:module:1.9\" name=\"javax.persistence.api\">\n \n     <resources>\n         <artifact name=\"${jakarta.persistence:jakarta.persistence-api}\"/>\n     </resources>\n+\n+    <dependencies>\n+        <module name=\"java.instrument\"/>", "originalCommit": "3e302aea7f1f4427b79287a728f55d05a7cb4007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk1MjYwNA==", "url": "https://github.com/wildfly/wildfly/pull/13827#discussion_r559952604", "bodyText": "@bstansberry\nThanks for your feedback. I have fixed it.", "author": "boris-unckel", "createdAt": "2021-01-19T07:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTgyNjUzMA=="}], "type": "inlineReview"}, {"oid": "357878908e1dc5a015f55984a59f6035ef29f7e1", "url": "https://github.com/wildfly/wildfly/commit/357878908e1dc5a015f55984a59f6035ef29f7e1", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-19T07:01:33Z", "type": "forcePushed"}, {"oid": "9894df9a5f8d092bf98d874dd7cdc5657605711c", "url": "https://github.com/wildfly/wildfly/commit/9894df9a5f8d092bf98d874dd7cdc5657605711c", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-19T17:04:54Z", "type": "forcePushed"}, {"oid": "d018ceb54d3cea3d37d15b55049afdc69f3b3695", "url": "https://github.com/wildfly/wildfly/commit/d018ceb54d3cea3d37d15b55049afdc69f3b3695", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-20T05:25:01Z", "type": "commit"}, {"oid": "d018ceb54d3cea3d37d15b55049afdc69f3b3695", "url": "https://github.com/wildfly/wildfly/commit/d018ceb54d3cea3d37d15b55049afdc69f3b3695", "message": "WFLY-14219 Upgrade module descriptor 1.9. Check and add dependencies for modules already at 1.8 or 1.9. Remove javax.api including fixes to do so.\n Convert slot attribute to name with collon, Fix LayersTestCase corresponding to org.jboss.as.product:wildfly-web removing slot.", "committedDate": "2021-01-20T05:25:01Z", "type": "forcePushed"}]}