{"pr_number": 13529, "pr_title": "[WFLY-13356]:Add webservices galleon layer", "pr_createdAt": "2020-09-03T05:59:54Z", "pr_url": "https://github.com/wildfly/wildfly/pull/13529", "timeline": [{"oid": "c6c7627f1628626af921c3e8d831e39c4178e6b0", "url": "https://github.com/wildfly/wildfly/commit/c6c7627f1628626af921c3e8d831e39c4178e6b0", "message": "[WFLY-13356]:Change ejb dependency name", "committedDate": "2020-09-04T10:37:29Z", "type": "forcePushed"}, {"oid": "7be027df624985dc9adbddd088d648bcdfa120b4", "url": "https://github.com/wildfly/wildfly/commit/7be027df624985dc9adbddd088d648bcdfa120b4", "message": "[WFLY-13356]:Add webservices galleon layer", "committedDate": "2020-09-05T00:38:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MTczOA==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r483891738", "bodyText": "Is remote EJB support the common case with webservices? If so this is ok; otherwise ejb-lite is better as it has fewer dependencies. If a user wanted @Remote they could just add the 'ejb' layer and have that.\nI see a few tests in testsuite/integration/ws use @Remote EJBs but if that's just for test coverage and it's not the typical use case those could be run in a separate execution with a server that included the 'ejb' layer.\nSorry if this has been discussed and I missed it or forgot.", "author": "bstansberry", "createdAt": "2020-09-05T00:56:49Z", "path": "ee-feature-pack/galleon-common/src/main/resources/layers/standalone/webservices/layer-spec.xml", "diffHunk": "@@ -0,0 +1,20 @@\n+<?xml version=\"1.0\" ?>\n+<layer-spec xmlns=\"urn:jboss:galleon:layer-spec:1.0\" name=\"webservices\">\n+    <dependencies>\n+        <layer name=\"web-server\"/>\n+        <layer name=\"ejb\" optional=\"true\"/>", "originalCommit": "7be027df624985dc9adbddd088d648bcdfa120b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5NTgxNg==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r483895816", "bodyText": "I tried with ejb-lite and there are a lot of missing remote failures from testsuite/integration/ws module like :\norg.jboss.arquillian.container.spi.client.container.DeploymentException: Cannot deploy stateless-ws-endpoint-example.jar: \n{\"WFLYCTL0062: Composite operation failed and was rolled back. Steps that failed:\" => {\"Operation step-1\" => \n{\"WFLYCTL0412: Required services that are not installed:\" => [\"org.wildfly.ejb.remote\",\"org.wildfly.transactions.remote-\ntransaction-service\"],\"WFLYCTL0180: Services with missing/unavailable dependencies\" => \n[\"jboss.deployment.unit.\\\"stateless-ws-endpoint-\nexample.jar\\\".component.SimpleStatelessWebserviceEndpointImpl.CREATE is missing [org.wildfly.transactions.remote-\ntransaction-service]\",\"jboss.deployment.unit.\\\"stateless-ws-endpoint-\nexample.jar\\\".component.SimpleStatelessWebserviceEndpointImpl.VIEW.\\\"org.jboss.as.test.integration.ws.ejb.SimpleState\nlessWebserviceEndpointIface\\\".REMOTE is missing [org.wildfly.ejb.remote]\"]}}}", "author": "jimma", "createdAt": "2020-09-05T01:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MTczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkwMTgxNA==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r483901814", "bodyText": "When I tried, 5 out of 58 tests failed.\nI think those are the tests where the EJBs are annotated with @Remote. If so ,they don't pass for a valid reason; they'd be testing something outside the intended use case of the layer. But the presence of those tests doesn't mean that's the use case our layer should target. They could be excluded or tested in a separate execution with the 'ejb' layer added, as you did with the tests that required legacy security. The layer should be designed to be as slim as possible while still meeting the expected end user use cases.\nWe wouldn't want to base on ejb-lite and make the user provision both 'webservices' and 'ejb' instead of just 'webservices' if wanting remote EJB is the common use case. On the other hand, 'ejb' brings the remoting subsytem and an endpoint, which adds both weight and security risk. If a user didn't want that they'd have to use 'webservices' and 'ejb-lite' and exclude 'ejb', which is fairly painful and not intuitive. It's doable though, so if wanting remote EJBs is the common use case you're targeting it's ok.", "author": "bstansberry", "createdAt": "2020-09-05T02:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MTczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NjI1OA==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r483946258", "bodyText": "@bstansberry  Looked at layer dependency twice, and I agree with you that we should make sure the layer to be as slim as possible. I added the \"ejb\" layer dependency as user can get a out of box webservices layer which works for most of the causes, but this will increase the installation size and make the layer exclusion painful for user. I didn't think of the scenario if user wants to exclude something.  I pushed the change to change the dependency to \"ejb-lite\" as you suggested.", "author": "jimma", "createdAt": "2020-09-05T12:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MTczOA=="}], "type": "inlineReview"}, {"oid": "9731535dd5b8390add876d4f512fec87bde15759", "url": "https://github.com/wildfly/wildfly/commit/9731535dd5b8390add876d4f512fec87bde15759", "message": "[WFLY-13356]:Remove the h2-default-datasource layer from ws testsuite", "committedDate": "2020-09-10T01:06:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3NjA1Ng==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r486276056", "bodyText": "@jimma this was added wit commit \"[WFLY-13356]:Use ejb-lite dependency\" ... ee-feature-pack/galleon-common/src/main/resources/layers/standalone/webservices/layer-spec.xml correcly uses ejb-lite layer, while the testsuite/integration/ws/pom.xml uses ejb layer, is that intentional?", "author": "tommaso-borgato", "createdAt": "2020-09-10T11:53:03Z", "path": "testsuite/integration/ws/pom.xml", "diffHunk": "@@ -254,9 +254,258 @@\n                                     <environmentVariables>\n                                         <JBOSS_HOME>${jboss.dist}</JBOSS_HOME>\n                                     </environmentVariables>\n-\n                                     <!-- Parameters to test cases. -->\n+                                    <systemPropertyVariables>\n+                                        <jboss.install.dir>${basedir}/target/wildfly</jboss.install.dir>\n+                                        <jboss.server.config.file.name>standalone.xml</jboss.server.config.file.name>\n+                                        <!-- EJB client library hack, see WFLY-4973-->\n+                                        <org.jboss.ejb.client.wildfly-testsuite-hack>true</org.jboss.ejb.client.wildfly-testsuite-hack>\n+\n+                                        <!-- SSL settings -->\n+                                        <cxf.tls-client.disableCNCheck>true</cxf.tls-client.disableCNCheck>\n+                                        <javax.net.ssl.trustStore>${project.build.testOutputDirectory}/org/jboss/as/test/integration/ws/wsse/trust/test.truststore</javax.net.ssl.trustStore>\n+                                        <javax.net.ssl.trustStorePassword>changeit</javax.net.ssl.trustStorePassword>\n+                                        <javax.net.ssl.trustStoreType>jks</javax.net.ssl.trustStoreType>\n+                                        <javax.net.ssl.keyStore>${project.build.testOutputDirectory}/org/jboss/as/test/integration/ws/wsse/trust/client.keystore</javax.net.ssl.keyStore>\n+                                        <javax.net.ssl.keyStorePassword>changeit</javax.net.ssl.keyStorePassword>\n+                                        <javax.net.ssl.keyStoreType>jks</javax.net.ssl.keyStoreType>\n+                                    </systemPropertyVariables>\n+\n+                                    <additionalClasspathElements>\n+                                        <additionalClasspathElement>${project.basedir}/../src/test/resources</additionalClasspathElement>\n+                                    </additionalClasspathElements>\n+                                </configuration>\n+                            </execution>\n+                        </executions>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+\n+\n+        <!-- Test against slimmed servers provisioned by Galleon -->\n+        <profile>\n+            <id>layers.profile</id>\n+            <activation>\n+                <property>\n+                    <name>ts.layers</name>\n+                </property>\n+            </activation>\n+            <build>\n+                <plugins>\n+                    <!-- Disable the standard copy-based provisioning -->\n+                    <plugin>\n+                        <groupId>org.apache.maven.plugins</groupId>\n+                        <artifactId>maven-resources-plugin</artifactId>\n+                        <executions combine.children=\"append\">\n+                            <execution>\n+                                <id>ts.copy-wildfly</id>\n+                                <goals>\n+                                    <goal>copy-resources</goal>\n+                                </goals>\n+                                <phase>none</phase>\n+                            </execution>\n+                        </executions>\n+                    </plugin>\n+                    <plugin>\n+                        <groupId>org.jboss.galleon</groupId>\n+                        <artifactId>galleon-maven-plugin</artifactId>\n+                        <executions>\n+                            <execution>\n+                                <id>webservices-provisioning</id>\n+                                <goals>\n+                                    <goal>provision</goal>\n+                                </goals>\n+                                <phase>compile</phase>\n+                                <configuration>\n+                                    <install-dir>${project.build.directory}/wildfly-webservices</install-dir>\n+                                    <record-state>false</record-state>\n+                                    <log-time>${galleon.log.time}</log-time>\n+                                    <offline>true</offline>\n+                                    <plugin-options>\n+                                        <jboss-maven-dist/>\n+                                        <jboss-fork-embedded>${galleon.fork.embedded}</jboss-fork-embedded>\n+                                        <optional-packages>passive+</optional-packages>\n+                                    </plugin-options>\n+                                    <feature-packs>\n+                                        <feature-pack>\n+                                            <groupId>${project.groupId}</groupId>\n+                                            <artifactId>${testsuite.ee.galleon.pack.artifactId}</artifactId>\n+                                            <version>${testsuite.ee.galleon.pack.version}</version>\n+                                            <inherit-configs>false</inherit-configs>\n+                                            <inherit-packages>false</inherit-packages>\n+                                        </feature-pack>\n+                                    </feature-packs>\n+                                    <configurations>\n+                                        <config>\n+                                            <model>standalone</model>\n+                                            <name>standalone.xml</name>\n+                                            <layers>\n+                                                <layer>cloud-server</layer>\n+                                                <layer>webservices</layer>\n+                                            </layers>\n+                                        </config>\n+                                    </configurations>\n+                                </configuration>\n+                            </execution>\n+                            <execution>\n+                                <id>webservices-ejb-provisioning</id>\n+                                <goals>\n+                                    <goal>provision</goal>\n+                                </goals>\n+                                <phase>compile</phase>\n+                                <configuration>\n+                                    <install-dir>${project.build.directory}/wildfly-webservices-ejb</install-dir>\n+                                    <record-state>false</record-state>\n+                                    <log-time>${galleon.log.time}</log-time>\n+                                    <offline>true</offline>\n+                                    <plugin-options>\n+                                        <jboss-maven-dist/>\n+                                        <jboss-fork-embedded>${galleon.fork.embedded}</jboss-fork-embedded>\n+                                        <optional-packages>passive+</optional-packages>\n+                                    </plugin-options>\n+                                    <feature-packs>\n+                                        <feature-pack>\n+                                            <groupId>${project.groupId}</groupId>\n+                                            <artifactId>${testsuite.ee.galleon.pack.artifactId}</artifactId>\n+                                            <version>${testsuite.ee.galleon.pack.version}</version>\n+                                            <inherit-configs>false</inherit-configs>\n+                                            <inherit-packages>false</inherit-packages>\n+                                        </feature-pack>\n+                                    </feature-packs>\n+                                    <configurations>\n+                                        <config>\n+                                            <model>standalone</model>\n+                                            <name>standalone.xml</name>\n+                                            <layers>\n+                                                <layer>cloud-server</layer>\n+                                                <layer>ejb</layer>", "originalCommit": "9731535dd5b8390add876d4f512fec87bde15759", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3ODE5Nw==", "url": "https://github.com/wildfly/wildfly/pull/13529#discussion_r486278197", "bodyText": "@tommaso-borgato  yes. Adding ejb layer to get remote support.", "author": "jimma", "createdAt": "2020-09-10T11:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3NjA1Ng=="}], "type": "inlineReview"}, {"oid": "71cb248b57e213acb09be3a514047c38cb0f4640", "url": "https://github.com/wildfly/wildfly/commit/71cb248b57e213acb09be3a514047c38cb0f4640", "message": "[WFLY-13356]:Add webservices galleon layer", "committedDate": "2020-09-11T00:42:53Z", "type": "commit"}, {"oid": "720d9a82e7c7800892ccb2024080ef7da75692f4", "url": "https://github.com/wildfly/wildfly/commit/720d9a82e7c7800892ccb2024080ef7da75692f4", "message": "[WFLY-13356]:Use ejb-lite dependency", "committedDate": "2020-09-11T00:42:53Z", "type": "commit"}, {"oid": "b97628eb620cc83e721f26d4fcb1bde7a6a0d8b6", "url": "https://github.com/wildfly/wildfly/commit/b97628eb620cc83e721f26d4fcb1bde7a6a0d8b6", "message": "[WFLY-13356]:Remove the h2-default-datasource layer from ws testsuite", "committedDate": "2020-09-11T00:42:53Z", "type": "commit"}, {"oid": "b97628eb620cc83e721f26d4fcb1bde7a6a0d8b6", "url": "https://github.com/wildfly/wildfly/commit/b97628eb620cc83e721f26d4fcb1bde7a6a0d8b6", "message": "[WFLY-13356]:Remove the h2-default-datasource layer from ws testsuite", "committedDate": "2020-09-11T00:42:53Z", "type": "forcePushed"}]}