{"pr_number": 8973, "pr_title": "Implement an annotation processor to mark Panache archives", "pr_createdAt": "2020-04-30T06:07:25Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8973", "timeline": [{"oid": "29a1d0fe4ace6a331016891ded471fe2bad54b06", "url": "https://github.com/quarkusio/quarkus/commit/29a1d0fe4ace6a331016891ded471fe2bad54b06", "message": "Implement an annotation process to mark Panache archives\n\nThe logic here is that only libraries that are compiled\nagainst panache will have this generated marker file, and\nif this file is present this means that classes in the archive\nmay need to be transformed.\n\nThis is just a draft at the moment, a similar approach would\nalso need to be taken with Mongo.", "committedDate": "2020-04-30T07:59:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MTk4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8973#discussion_r417971980", "bodyText": "I guess this will also match string constants, since we're not looking at the CONSTANT_CLASS_TAG that points to this but probably fine because it's FQNs.", "author": "FroMage", "createdAt": "2020-04-30T12:27:52Z", "path": "extensions/panache/hibernate-orm-panache/deployment/src/main/java/io/quarkus/hibernate/orm/panache/deployment/PanacheResourceProcessor.java", "diffHunk": "@@ -148,15 +161,104 @@ void build(CombinedIndexBuildItem index,\n         MetamodelInfo<EntityModel<EntityField>> modelInfo = modelEnhancer.getModelInfo();\n         if (modelInfo.hasEntities()) {\n             PanacheFieldAccessEnhancer panacheFieldAccessEnhancer = new PanacheFieldAccessEnhancer(modelInfo);\n-            for (ClassInfo classInfo : index.getIndex().getKnownClasses()) {\n-                String className = classInfo.name().toString();\n-                if (!modelClasses.contains(className)) {\n-                    transformers.produce(new BytecodeTransformerBuildItem(className, panacheFieldAccessEnhancer));\n+            QuarkusClassLoader tccl = (QuarkusClassLoader) Thread.currentThread().getContextClassLoader();\n+            List<ClassPathElement> archives = tccl.getElementsWithResource(META_INF_PANACHE_ARCHIVE_MARKER);\n+            for (ClassPathElement i : archives) {\n+                for (String res : i.getProvidedResources()) {\n+                    if (res.endsWith(\".class\")) {\n+                        String cn = res.replace(\"/\", \".\").substring(0, res.length() - 6);\n+                        if (!modelClasses.contains(cn)) {\n+                            if (requiresTransformation(res, i, modelClassNamesInternal)) {\n+                                transformers.produce(new BytecodeTransformerBuildItem(cn, panacheFieldAccessEnhancer));\n+                            }\n+                        }\n+                    }\n                 }\n             }\n         }\n     }\n \n+    static final int CONSTANT_UTF8_TAG = 1;\n+    static final int CONSTANT_INTEGER_TAG = 3;\n+    static final int CONSTANT_FLOAT_TAG = 4;\n+    static final int CONSTANT_LONG_TAG = 5;\n+    static final int CONSTANT_DOUBLE_TAG = 6;\n+    static final int CONSTANT_CLASS_TAG = 7;\n+    static final int CONSTANT_STRING_TAG = 8;\n+    static final int CONSTANT_FIELDREF_TAG = 9;\n+    static final int CONSTANT_METHODREF_TAG = 10;\n+    static final int CONSTANT_INTERFACE_METHODREF_TAG = 11;\n+    static final int CONSTANT_NAME_AND_TYPE_TAG = 12;\n+    static final int CONSTANT_METHOD_HANDLE_TAG = 15;\n+    static final int CONSTANT_METHOD_TYPE_TAG = 16;\n+    static final int CONSTANT_DYNAMIC_TAG = 17;\n+    static final int CONSTANT_INVOKE_DYNAMIC_TAG = 18;\n+    static final int CONSTANT_MODULE_TAG = 19;\n+    static final int CONSTANT_PACKAGE_TAG = 20;\n+\n+    private boolean requiresTransformation(String res, ClassPathElement i, Set<String> modelInfo) {\n+        ByteBuffer data = ByteBuffer.wrap(i.getResource(res).getData());\n+        if (data.getInt() != 0xCAFEBABE) {\n+            return false; //not a class file\n+        }\n+        data.getShort();//major\n+        data.getShort();//minor\n+        int constantPoolCount = data.getShort();\n+        int currentCpInfoIndex = 1;\n+        while (currentCpInfoIndex < constantPoolCount) {\n+            currentCpInfoIndex++;\n+            int cpInfoSize;\n+            switch (data.get()) {\n+                case CONSTANT_FIELDREF_TAG:\n+                case CONSTANT_METHODREF_TAG:\n+                case CONSTANT_INTERFACE_METHODREF_TAG:\n+                case CONSTANT_INTEGER_TAG:\n+                case CONSTANT_FLOAT_TAG:\n+                case CONSTANT_NAME_AND_TYPE_TAG:\n+                    cpInfoSize = 4;\n+                    break;\n+                case CONSTANT_DYNAMIC_TAG:\n+                    cpInfoSize = 4;\n+                    break;\n+                case CONSTANT_INVOKE_DYNAMIC_TAG:\n+                    cpInfoSize = 4;\n+                    break;\n+                case CONSTANT_LONG_TAG:\n+                case CONSTANT_DOUBLE_TAG:\n+                    cpInfoSize = 8;\n+                    currentCpInfoIndex++;\n+                    break;\n+                case CONSTANT_UTF8_TAG:\n+                    int strLength = 0xFFFF & data.getShort();\n+                    cpInfoSize = 0;\n+                    byte[] str = new byte[strLength];\n+                    data.get(str);\n+                    if (modelInfo.contains(new String(str, StandardCharsets.UTF_8))) {", "originalCommit": "29a1d0fe4ace6a331016891ded471fe2bad54b06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MzI2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8973#discussion_r417973262", "bodyText": "I think it would be better to move this in a core class like ConstantPoolScanner and make it take a ConstantPoolPredicate that can match, no?\nI want to reuse this for #814 :)\nAlso, I wonder how we can make sure we update this scanner at every new JVM spec that defines a new constant pool type.", "author": "FroMage", "createdAt": "2020-04-30T12:30:14Z", "path": "extensions/panache/hibernate-orm-panache/deployment/src/main/java/io/quarkus/hibernate/orm/panache/deployment/PanacheResourceProcessor.java", "diffHunk": "@@ -148,15 +161,104 @@ void build(CombinedIndexBuildItem index,\n         MetamodelInfo<EntityModel<EntityField>> modelInfo = modelEnhancer.getModelInfo();\n         if (modelInfo.hasEntities()) {\n             PanacheFieldAccessEnhancer panacheFieldAccessEnhancer = new PanacheFieldAccessEnhancer(modelInfo);\n-            for (ClassInfo classInfo : index.getIndex().getKnownClasses()) {\n-                String className = classInfo.name().toString();\n-                if (!modelClasses.contains(className)) {\n-                    transformers.produce(new BytecodeTransformerBuildItem(className, panacheFieldAccessEnhancer));\n+            QuarkusClassLoader tccl = (QuarkusClassLoader) Thread.currentThread().getContextClassLoader();\n+            List<ClassPathElement> archives = tccl.getElementsWithResource(META_INF_PANACHE_ARCHIVE_MARKER);\n+            for (ClassPathElement i : archives) {\n+                for (String res : i.getProvidedResources()) {\n+                    if (res.endsWith(\".class\")) {\n+                        String cn = res.replace(\"/\", \".\").substring(0, res.length() - 6);\n+                        if (!modelClasses.contains(cn)) {\n+                            if (requiresTransformation(res, i, modelClassNamesInternal)) {\n+                                transformers.produce(new BytecodeTransformerBuildItem(cn, panacheFieldAccessEnhancer));\n+                            }\n+                        }\n+                    }\n                 }\n             }\n         }\n     }\n \n+    static final int CONSTANT_UTF8_TAG = 1;\n+    static final int CONSTANT_INTEGER_TAG = 3;\n+    static final int CONSTANT_FLOAT_TAG = 4;\n+    static final int CONSTANT_LONG_TAG = 5;\n+    static final int CONSTANT_DOUBLE_TAG = 6;\n+    static final int CONSTANT_CLASS_TAG = 7;\n+    static final int CONSTANT_STRING_TAG = 8;\n+    static final int CONSTANT_FIELDREF_TAG = 9;\n+    static final int CONSTANT_METHODREF_TAG = 10;\n+    static final int CONSTANT_INTERFACE_METHODREF_TAG = 11;\n+    static final int CONSTANT_NAME_AND_TYPE_TAG = 12;\n+    static final int CONSTANT_METHOD_HANDLE_TAG = 15;\n+    static final int CONSTANT_METHOD_TYPE_TAG = 16;\n+    static final int CONSTANT_DYNAMIC_TAG = 17;\n+    static final int CONSTANT_INVOKE_DYNAMIC_TAG = 18;\n+    static final int CONSTANT_MODULE_TAG = 19;\n+    static final int CONSTANT_PACKAGE_TAG = 20;\n+\n+    private boolean requiresTransformation(String res, ClassPathElement i, Set<String> modelInfo) {", "originalCommit": "29a1d0fe4ace6a331016891ded471fe2bad54b06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1OTkxNg==", "url": "https://github.com/quarkusio/quarkus/pull/8973#discussion_r420559916", "bodyText": "Every time there is a new JVM spec we need to update ASM, ByteBuddy etc, this is just one more thing", "author": "stuartwdouglas", "createdAt": "2020-05-06T05:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MzI2Mg=="}], "type": "inlineReview"}, {"oid": "250da0443812d63f3f99306bdd7bde9569e63b7f", "url": "https://github.com/quarkusio/quarkus/commit/250da0443812d63f3f99306bdd7bde9569e63b7f", "message": "Implement an annotation process to mark Panache archives\n\nThe logic here is that only libraries that are compiled\nagainst panache will have this generated marker file, and\nif this file is present this means that classes in the archive\nmay need to be transformed.\n\nThis is just a draft at the moment, a similar approach would\nalso need to be taken with Mongo.", "committedDate": "2020-05-06T05:55:22Z", "type": "forcePushed"}, {"oid": "a28d76b436f0829e332c63e6a5d320d7eebd35f5", "url": "https://github.com/quarkusio/quarkus/commit/a28d76b436f0829e332c63e6a5d320d7eebd35f5", "message": "Implement an annotation process to mark Panache archives\n\nThe logic here is that only libraries that are compiled\nagainst panache will have this generated marker file, and\nif this file is present this means that classes in the archive\nmay need to be transformed.\n\nThis is just a draft at the moment, a similar approach would\nalso need to be taken with Mongo.", "committedDate": "2020-05-06T13:36:45Z", "type": "commit"}, {"oid": "a28d76b436f0829e332c63e6a5d320d7eebd35f5", "url": "https://github.com/quarkusio/quarkus/commit/a28d76b436f0829e332c63e6a5d320d7eebd35f5", "message": "Implement an annotation process to mark Panache archives\n\nThe logic here is that only libraries that are compiled\nagainst panache will have this generated marker file, and\nif this file is present this means that classes in the archive\nmay need to be transformed.\n\nThis is just a draft at the moment, a similar approach would\nalso need to be taken with Mongo.", "committedDate": "2020-05-06T13:36:45Z", "type": "forcePushed"}]}