{"pr_number": 11014, "pr_title": "If no Accept header is set default to the first 'produces' type", "pr_createdAt": "2020-07-28T02:50:09Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11014", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1MzkxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461453915", "bodyText": "I think that we should only set the content-type header if the business method did not set it manually, i.e. after it was executed. If we set it before then multiple content-type headers may be set to the response.", "author": "mkouba", "createdAt": "2020-07-28T09:40:40Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -539,12 +542,14 @@ void implementInvoke(HandlerDescriptor descriptor, BeanInfo bean, MethodInfo met\n         MethodDescriptor methodDescriptor = MethodDescriptor\n                 .ofMethod(bean.getImplClazz().name().toString(), method.name(), returnType, parameterTypes);\n \n+        // If no content-type header is set then try to use the most acceptable content type\n+        // the business method can override this manually if required\n+        invoke.invokeStaticMethod(Methods.ROUTE_HANDLERS_SET_CONTENT_TYPE, routingContext,", "originalCommit": "b2b92fdd98fd6bf8249d378767cc8df902c45d58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1NDYzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461454635", "bodyText": "manual-content-type is not a good path for this route. Maybe default-content-type?", "author": "mkouba", "createdAt": "2020-07-28T09:41:49Z", "path": "extensions/vertx-web/deployment/src/test/java/io/quarkus/vertx/web/mutiny/SyncRouteTest.java", "diffHunk": "@@ -87,6 +118,13 @@ Person getPersonUtf8(RoutingContext context) {\n             return new Person(\"neo\", 12345);\n         }\n \n+        @Route(path = \"manual-content-type\", produces = \"application/json\")", "originalCommit": "b2b92fdd98fd6bf8249d378767cc8df902c45d58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "url": "https://github.com/quarkusio/quarkus/commit/93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960", "committedDate": "2020-07-28T11:37:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNjY1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461626652", "bodyText": "Shouldn't we use io.vertx.ext.web.RoutingContext.addHeadersEndHandler(Handler<Void>) instead?\nAlso from perf POV this means one more Handler instance per each request. It's probably negligible but I wonder if the previous approach \"set the content type after the route method is executed\" represents some serious issue?", "author": "mkouba", "createdAt": "2020-07-28T14:29:53Z", "path": "extensions/vertx-web/runtime/src/main/java/io/quarkus/vertx/web/runtime/RouteHandlers.java", "diffHunk": "@@ -18,14 +19,22 @@ private RouteHandlers() {\n     private static final LazyValue<Event<SecurityIdentity>> SECURITY_IDENTITY_EVENT = new LazyValue<>(\n             RouteHandlers::createEvent);\n \n-    public static void setContentType(RoutingContext context) {\n+    public static void setContentType(RoutingContext context, String defaultContentType) {\n         HttpServerResponse response = context.response();\n-        if (response.headers().get(CONTENT_TYPE) == null) {\n-            String acceptableContentType = context.getAcceptableContentType();\n-            if (acceptableContentType != null) {\n-                response.putHeader(CONTENT_TYPE, acceptableContentType);\n+        response.headersEndHandler(new Handler<Void>() {", "originalCommit": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0Mzk5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r462043995", "bodyText": "The previous approach would fail if the method used the RoutingContext to send data, as the headers would have already been written.", "author": "stuartwdouglas", "createdAt": "2020-07-29T05:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNjY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1Mjg2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r462052869", "bodyText": "Ah, you're right! What about the RoutingContext.addHeadersEndHandler()?", "author": "mkouba", "createdAt": "2020-07-29T05:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNjY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA2NTMwMw==", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r462065303", "bodyText": "Oops, forgot to push it.", "author": "stuartwdouglas", "createdAt": "2020-07-29T06:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNjY1Mg=="}], "type": "inlineReview"}, {"oid": "e28b6125c680f5c8443026d324f399fefa71e308", "url": "https://github.com/quarkusio/quarkus/commit/e28b6125c680f5c8443026d324f399fefa71e308", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960", "committedDate": "2020-07-29T05:17:37Z", "type": "commit"}, {"oid": "e28b6125c680f5c8443026d324f399fefa71e308", "url": "https://github.com/quarkusio/quarkus/commit/e28b6125c680f5c8443026d324f399fefa71e308", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960", "committedDate": "2020-07-29T05:17:37Z", "type": "forcePushed"}]}