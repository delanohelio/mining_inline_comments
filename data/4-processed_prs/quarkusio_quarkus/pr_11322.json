{"pr_number": 11322, "pr_title": "Support multiple Hibernate ORM persistence units via Quarkus configuration", "pr_createdAt": "2020-08-11T10:07:15Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11322", "timeline": [{"oid": "0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "url": "https://github.com/quarkusio/quarkus/commit/0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "message": "Introduce the CDI infrastructure for multi-persistence units\n\nIn passing, we now make JTA the only case handled.\nI will throw a proper error in a follow-up commit when not enabled.", "committedDate": "2020-08-13T13:32:32Z", "type": "forcePushed"}, {"oid": "4d251f494105a090c4148c6f5ac10b0c2a2284e5", "url": "https://github.com/quarkusio/quarkus/commit/4d251f494105a090c4148c6f5ac10b0c2a2284e5", "message": "Simplify multiple persistence units configuration\n\nWe don't have a prefix in the other extensions so let's try to be\nconsistent and see how it goes.", "committedDate": "2020-08-17T20:29:16Z", "type": "forcePushed"}, {"oid": "974f27f46f1b31c0d695f98e83ad2f80ec4bb37a", "url": "https://github.com/quarkusio/quarkus/commit/974f27f46f1b31c0d695f98e83ad2f80ec4bb37a", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config.", "committedDate": "2020-08-18T09:11:04Z", "type": "forcePushed"}, {"oid": "d1dabdd2303dc56f21e0de4b005e816b964624cc", "url": "https://github.com/quarkusio/quarkus/commit/d1dabdd2303dc56f21e0de4b005e816b964624cc", "message": "fix: make sure that config section within the same config root are merged properly", "committedDate": "2020-08-18T16:03:57Z", "type": "commit"}, {"oid": "f9894aad7625e158d284d7832be168ce0861a3ee", "url": "https://github.com/quarkusio/quarkus/commit/f9894aad7625e158d284d7832be168ce0861a3ee", "message": "fix: generate unique anchors for ConfigSection fom section title and section key", "committedDate": "2020-08-18T16:11:22Z", "type": "commit"}, {"oid": "74514b0c748f5e12ef9ad1cea23363ea429ba86a", "url": "https://github.com/quarkusio/quarkus/commit/74514b0c748f5e12ef9ad1cea23363ea429ba86a", "message": "Enable scanning in JPA tests as we enforce it now", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "4a03d478e53efa5af1a5fdbdd76f88c94296a296", "url": "https://github.com/quarkusio/quarkus/commit/4a03d478e53efa5af1a5fdbdd76f88c94296a296", "message": "Prepare configuration for multiple persistence units support", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "bc9096d22c99830b0e3e41d049d7bbca91a63912", "url": "https://github.com/quarkusio/quarkus/commit/bc9096d22c99830b0e3e41d049d7bbca91a63912", "message": "Support defining the datasource used by a persistence unit", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "677360504960761d1aad2a2d8930882c0099df4e", "url": "https://github.com/quarkusio/quarkus/commit/677360504960761d1aad2a2d8930882c0099df4e", "message": "Add config for multiple persistence units", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "31547956881919e36b0cd59423a57b9e008db3a1", "url": "https://github.com/quarkusio/quarkus/commit/31547956881919e36b0cd59423a57b9e008db3a1", "message": "Rename the default persistence unit to \"<default>\"\n\nIt has a special meaning and I don't want it to conflict with the user\ndefined ones.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "0810c07943f8116b805bc58aa740f5cb3d3cc20b", "url": "https://github.com/quarkusio/quarkus/commit/0810c07943f8116b805bc58aa740f5cb3d3cc20b", "message": "Make archives containing entity packages part of the Jandex index", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "4f3362fbf2e4365fa73df2c4461b6672866b59d9", "url": "https://github.com/quarkusio/quarkus/commit/4f3362fbf2e4365fa73df2c4461b6672866b59d9", "message": "Reorganize HibernateOrmProcessor a bit\n\nNo code changes, just moving methods around.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "1fbaefb015ced7d85655ba0b06c4a95c418ec941", "url": "https://github.com/quarkusio/quarkus/commit/1fbaefb015ced7d85655ba0b06c4a95c418ec941", "message": "Introduce the CDI infrastructure for multi-persistence units\n\nIn passing, we now make JTA the only case handled.\nI will throw a proper error in a follow-up commit when not enabled.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "51c87b827f8903bf6eb82b7c945917f4cfe5dd77", "url": "https://github.com/quarkusio/quarkus/commit/51c87b827f8903bf6eb82b7c945917f4cfe5dd77", "message": "Make JPAConfig less brittle and also publish the entity -> PUs mapping\n\nI decided to support multiple PUs there. We will see how it goes in\nPanache.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "40a3711ffae078b1f11e3e206e0060d4cb72365c", "url": "https://github.com/quarkusio/quarkus/commit/40a3711ffae078b1f11e3e206e0060d4cb72365c", "message": "Move PersistenceUnitUtil to the runtime module", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "6faaa73c6dea8d1ec0adc6f6a59c3bcd073d7290", "url": "https://github.com/quarkusio/quarkus/commit/6faaa73c6dea8d1ec0adc6f6a59c3bcd073d7290", "message": "Throw an exception if no JTA\n\nSanne confirmed that not having JTA around is not a valid configuration.\nWe used to have some partial support for it but it was buggy at best.\n\nThe support was removed in a previous commit, this commit only adds a\nproper exception for it.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "f3f718122128fb41bf949e2fdb9c8e2e5e4b7459", "url": "https://github.com/quarkusio/quarkus/commit/f3f718122128fb41bf949e2fdb9c8e2e5e4b7459", "message": "Simplify multiple persistence units configuration\n\nWe don't have a prefix in the other extensions so let's try to be\nconsistent and see how it goes.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "e79df93cb932e147dfe88c185fd99a576353970b", "url": "https://github.com/quarkusio/quarkus/commit/e79df93cb932e147dfe88c185fd99a576353970b", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config.", "committedDate": "2020-08-18T16:11:26Z", "type": "commit"}, {"oid": "e79df93cb932e147dfe88c185fd99a576353970b", "url": "https://github.com/quarkusio/quarkus/commit/e79df93cb932e147dfe88c185fd99a576353970b", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config.", "committedDate": "2020-08-18T16:11:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwNDA3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474204073", "bodyText": "Just curious, did you figure that this was necessary?", "author": "Sanne", "createdAt": "2020-08-20T18:58:26Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -666,6 +697,14 @@ private static void producePersistenceUnitDescriptorFromConfig(\n         // we found one\n         ParsedPersistenceXmlDescriptor descriptor = new ParsedPersistenceXmlDescriptor(null); //todo URL\n         descriptor.setName(persistenceUnitName);\n+\n+        descriptor.setExcludeUnlistedClasses(true);", "originalCommit": "677360504960761d1aad2a2d8930882c0099df4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3NDQwNA==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474574404", "bodyText": "It's not necessary as you forced it in LightPersistence... but... I'm not sure we will keep it that way so wanted to be extra sure it wouldn't break if we change it later.", "author": "gsmet", "createdAt": "2020-08-21T09:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwNDA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5OTgxMw==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474599813", "bodyText": "Ok, thanks I was just puzzled.", "author": "Sanne", "createdAt": "2020-08-21T09:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwNDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3NTM0MA==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474275340", "bodyText": "What do you mean by \"has special meaning\", is it not possible for a user to speficy this name explicitly?", "author": "Sanne", "createdAt": "2020-08-20T21:12:02Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -126,7 +126,7 @@\n \n     public static final String HIBERNATE_ORM_CONFIG_PREFIX = \"quarkus.hibernate-orm.\";\n     public static final String NO_SQL_LOAD_SCRIPT_FILE = \"no-file\";\n-    public static final String DEFAULT_PERSISTENCE_UNIT_NAME = \"default\";\n+    public static final String DEFAULT_PERSISTENCE_UNIT_NAME = \"<default>\";", "originalCommit": "31547956881919e36b0cd59423a57b9e008db3a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMjk2NA==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474312964", "bodyText": "The idea was to avoid a conflict between the default one and a potential named PU called \"default\". Thus why I added the special characters. Also, it's consistent with the Agroal extension.", "author": "gsmet", "createdAt": "2020-08-20T22:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3NTM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3Njg2NA==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474276864", "bodyText": "Could you add a comment somewhere to remind why this is an invalid configuration? I guess because it's missing the package names filter packages?", "author": "Sanne", "createdAt": "2020-08-20T21:15:10Z", "path": "extensions/hibernate-orm/deployment/src/test/resources/application-multiple-persistence-units-invalid.properties", "diffHunk": "@@ -0,0 +1,7 @@\n+quarkus.datasource.users.db-kind=h2\n+quarkus.datasource.users.jdbc.url=jdbc:h2:tcp://localhost/mem:users;DB_CLOSE_DELAY=-1\n+\n+quarkus.hibernate-orm.persistence-units.\"users\".dialect=org.hibernate.dialect.H2Dialect\n+quarkus.hibernate-orm.persistence-units.\"users\".log.sql=true\n+quarkus.hibernate-orm.persistence-units.\"users\".database.generation=drop-and-create\n+quarkus.hibernate-orm.persistence-units.\"users\".datasource=users", "originalCommit": "677360504960761d1aad2a2d8930882c0099df4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMzA2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474313069", "bodyText": "Will do.", "author": "gsmet", "createdAt": "2020-08-20T22:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3Njg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MzAzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474283035", "bodyText": "is this condition check useful? I was assuming that unitName would be always defined, at most <default>.\nIf I'm wrong, we might want to improve the following (nested) if so that the default can still be used/injected even when there's more than one PU defined.", "author": "Sanne", "createdAt": "2020-08-20T21:29:00Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/JPAConfig.java", "diffHunk": "@@ -91,8 +70,22 @@ void initDefaultPersistenceUnit() {\n         }\n     }\n \n-    boolean isJtaEnabled() {\n-        return jtaEnabled.get();\n+    public EntityManagerFactory getEntityManagerFactory(String unitName) {\n+        LazyPersistenceUnit lazyPersistenceUnit = null;\n+        if (unitName == null) {", "originalCommit": "1fbaefb015ced7d85655ba0b06c4a95c418ec941", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMjUyNg==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474312526", "bodyText": "It's always set except when you're explicitly calling null. This was the case somewhere in the code base so I decided to make it null safe just to be on the safe side.", "author": "gsmet", "createdAt": "2020-08-20T22:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MzAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMDYxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474600611", "bodyText": "Ok, it feels a bit smelly but we can clean it up later.", "author": "Sanne", "createdAt": "2020-08-21T10:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MzAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYzMjMyNA==", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474632324", "bodyText": "I would call it safe not smelly. I'm not sure I understand your problem.\nEverything is working fine with the default injection, we have tests for that. The null test is there just if someone calls it programmatically. When dealing with injection, you pass the default unit name (which is not null).\nFor me passing null is not really valid, I only support it because someone used it (and I changed that call to not use it) and I thought maybe someone else could have.", "author": "gsmet", "createdAt": "2020-08-21T11:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MzAzNQ=="}], "type": "inlineReview"}]}