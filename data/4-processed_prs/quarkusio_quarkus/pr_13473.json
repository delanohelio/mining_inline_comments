{"pr_number": 13473, "pr_title": "Workaround graal#3003 by passing IncludeResources via AutomaticFeature", "pr_createdAt": "2020-11-25T16:07:17Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13473", "timeline": [{"oid": "cf3ad81c895fe066c76a8166304f32e4e6618591", "url": "https://github.com/quarkusio/quarkus/commit/cf3ad81c895fe066c76a8166304f32e4e6618591", "message": "Workaround graal#3003 by passing IncludeResources via AutomaticFeature\ninstead of command line argument #13472", "committedDate": "2020-11-25T16:15:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3NTg0OA==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530875848", "bodyText": "Why do you remove this method? NativeImageResourceDirectoryBuildItem does not seem to be related to the -H:IncludeResources problem, or?", "author": "mkouba", "createdAt": "2020-11-26T09:10:56Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/NativeImageAutoFeatureStep.java", "diffHunk": "@@ -62,44 +53,25 @@\n     private static final MethodDescriptor RERUN_INITIALIZATION = ofMethod(\n             \"org.graalvm.nativeimage.impl.RuntimeClassInitializationSupport\",\n             \"rerunInitialization\", void.class, Class.class, String.class);\n+    private static final MethodDescriptor RESOURCES_REGISTRY_ADD_RESOURCES = ofMethod(\n+            \"com.oracle.svm.core.configure.ResourcesRegistry\",\n+            \"addResources\", void.class, String.class);\n+    private static final MethodDescriptor RESOURCES_REGISTRY_IGNORE_RESOURCES = ofMethod(\n+            \"com.oracle.svm.core.configure.ResourcesRegistry\",\n+            \"ignoreResources\", void.class, String.class);\n     static final String RUNTIME_REFLECTION = RuntimeReflection.class.getName();\n     static final String JNI_RUNTIME_ACCESS = \"com.oracle.svm.core.jni.JNIRuntimeAccess\";\n     static final String BEFORE_ANALYSIS_ACCESS = Feature.BeforeAnalysisAccess.class.getName();\n     static final String DYNAMIC_PROXY_REGISTRY = \"com.oracle.svm.core.jdk.proxy.DynamicProxyRegistry\";\n     static final String LOCALIZATION_FEATURE = \"com.oracle.svm.core.jdk.LocalizationFeature\";\n \n-    @BuildStep\n-    List<NativeImageResourceBuildItem> registerPackageResources(", "originalCommit": "cf3ad81c895fe066c76a8166304f32e4e6618591", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3NjU5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530876591", "bodyText": "Ah, I see the method was just moved..", "author": "mkouba", "createdAt": "2020-11-26T09:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3NTg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4MTk3NA==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530881974", "bodyText": "Yes, I only move it to another class, where I add another related method.", "author": "ppalaga", "createdAt": "2020-11-26T09:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg3NTg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4MDA1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530880055", "bodyText": "I thought that the purpose of this PR is to avoid -H:IncludeResources completely?", "author": "mkouba", "createdAt": "2020-11-26T09:17:41Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/nativeimage/NativeImageResourcePatternsBuildItem.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package io.quarkus.deployment.builditem.nativeimage;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+import io.quarkus.deployment.util.GlobUtil;\n+\n+/**\n+ * A build item that indicates that a set of resource paths defined by regular expression patterns or globs should be\n+ * included in the native image. This uses native-image's {@code -H:IncludeResources} under the hood.", "originalCommit": "cf3ad81c895fe066c76a8166304f32e4e6618591", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4NDk3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530884975", "bodyText": "Haha, true, I have added the comment some time ago, when the migration away from the CLI was not planned yet. I should change the wording. I should say something like \"it is using the same mechanism as native-image's -H:IncludeResources command line option\".", "author": "ppalaga", "createdAt": "2020-11-26T09:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4MDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4MDMzMg==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530880332", "bodyText": "Maybe it wouldn't hurt to explain what globs means...", "author": "mkouba", "createdAt": "2020-11-26T09:18:10Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/nativeimage/NativeImageResourcePatternsBuildItem.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package io.quarkus.deployment.builditem.nativeimage;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import io.quarkus.builder.item.MultiBuildItem;\n+import io.quarkus.deployment.util.GlobUtil;\n+\n+/**\n+ * A build item that indicates that a set of resource paths defined by regular expression patterns or globs should be", "originalCommit": "cf3ad81c895fe066c76a8166304f32e4e6618591", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4NTc2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r530885767", "bodyText": "Yeah, let me do that. I should also add some JavaDoc to the builder methods.", "author": "ppalaga", "createdAt": "2020-11-26T09:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg4MDMzMg=="}], "type": "inlineReview"}, {"oid": "f671833b31e0b3a0321a6079ccd09db843739062", "url": "https://github.com/quarkusio/quarkus/commit/f671833b31e0b3a0321a6079ccd09db843739062", "message": "Workaround graal#3003 by passing IncludeResources via AutomaticFeature\ninstead of command line argument #13472", "committedDate": "2020-11-26T10:07:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODczNw==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r532628737", "bodyText": "you should use tc here to load the pattern.", "author": "gsmet", "createdAt": "2020-11-30T14:17:39Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/NativeImageAutoFeatureStep.java", "diffHunk": "@@ -201,6 +173,21 @@ public void write(String s, byte[] bytes) {\n             }\n         }\n \n+        /* Resource includes and excludes */\n+        if (!resourcePatterns.isEmpty()) {\n+            ResultHandle resourcesRegistrySingleton = overallCatch.invokeStaticMethod(IMAGE_SINGLETONS_LOOKUP,\n+                    overallCatch.loadClass(\"com.oracle.svm.core.configure.ResourcesRegistry\"));\n+            TryBlock tc = overallCatch.tryBlock();\n+            for (NativeImageResourcePatternsBuildItem resourcePatternsItem : resourcePatterns) {\n+                for (String pattern : resourcePatternsItem.getIncludePatterns()) {\n+                    tc.invokeInterfaceMethod(RESOURCES_REGISTRY_ADD_RESOURCES, resourcesRegistrySingleton,\n+                            overallCatch.load(pattern));", "originalCommit": "f671833b31e0b3a0321a6079ccd09db843739062", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MDY0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r532640645", "bodyText": "Thanks, let me have a look.", "author": "ppalaga", "createdAt": "2020-11-30T14:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NDY3MA==", "url": "https://github.com/quarkusio/quarkus/pull/13473#discussion_r532654670", "bodyText": "fixed in 8f5c2b5", "author": "ppalaga", "createdAt": "2020-11-30T14:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODczNw=="}], "type": "inlineReview"}, {"oid": "8f5c2b5d65d00e48391754debddbf845ceaae6d6", "url": "https://github.com/quarkusio/quarkus/commit/8f5c2b5d65d00e48391754debddbf845ceaae6d6", "message": "Workaround graal#3003 by passing IncludeResources via AutomaticFeature\ninstead of command line argument #13472", "committedDate": "2020-11-30T14:43:34Z", "type": "commit"}, {"oid": "8f5c2b5d65d00e48391754debddbf845ceaae6d6", "url": "https://github.com/quarkusio/quarkus/commit/8f5c2b5d65d00e48391754debddbf845ceaae6d6", "message": "Workaround graal#3003 by passing IncludeResources via AutomaticFeature\ninstead of command line argument #13472", "committedDate": "2020-11-30T14:43:34Z", "type": "forcePushed"}]}