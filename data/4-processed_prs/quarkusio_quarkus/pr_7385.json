{"pr_number": 7385, "pr_title": "Fix broken MongoClientBuildItem support", "pr_createdAt": "2020-02-24T13:13:54Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7385", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxMzQzMw==", "url": "https://github.com/quarkusio/quarkus/pull/7385#discussion_r383313433", "bodyText": "Why not using this new methods also in the createMongoClientProducerBeanmethods that do the same but based on Jandex ?", "author": "loicmathieu", "createdAt": "2020-02-24T14:57:41Z", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -365,21 +358,51 @@ BeanContainerListenerBuildItem build(\n \n     @Record(RUNTIME_INIT)\n     @BuildStep\n-    void build(MongoClientRecorder recorder, BuildProducer<MongoClientBuildItem> mongoClients, MongodbConfig config) {\n-        if (config.mongoClientConfigs != null && !config.mongoClientConfigs.isEmpty()) {\n-            for (Map.Entry<String, MongoClientConfig> namedDataSourceEntry : config.mongoClientConfigs.entrySet()) {\n-                String name = namedDataSourceEntry.getKey();\n-                mongoClients\n-                        .produce(new MongoClientBuildItem(recorder.getClient(name), recorder.getReactiveClient(name), name));\n+    void configureRuntimePropertiesAndBuildClients(MongoClientRecorder recorder,\n+            CodecProviderBuildItem codecProvider,\n+            BsonDiscriminatorBuildItem bsonDiscriminator,\n+            MongodbConfig mongodbConfig, ConfigurationBuildItem config,\n+            BuildProducer<MongoClientBuildItem> mongoClients) {\n+        recorder.configureRuntimeProperties(codecProvider.getCodecProviderClassNames(),\n+                bsonDiscriminator.getBsonDiscriminatorClassNames(), mongodbConfig);\n+\n+        for (String connectionName : resolveAllConnectionNamesFromConfig(config)) {\n+            mongoClients.produce(new MongoClientBuildItem(recorder.getClient(connectionName),\n+                    recorder.getReactiveClient(connectionName), connectionName));\n+        }\n+    }\n+\n+    private Set<String> resolveAllConnectionNamesFromConfig(ConfigurationBuildItem config) {", "originalCommit": "ad376e42465a03925f579b1f63ea55f28385e235", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMjQ0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7385#discussion_r383322449", "bodyText": "That is an interesting idea! I went the way I did because that solution feels closer to the problem at hand.\nThat said, I'll sleep on this idea and once the Camel folks respond with whether or not the whole idea works then I'll have settled :)", "author": "geoand", "createdAt": "2020-02-24T15:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxMzQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU2OTMyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7385#discussion_r383569325", "bodyText": "Implemented", "author": "geoand", "createdAt": "2020-02-24T23:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxMzQzMw=="}], "type": "inlineReview"}, {"oid": "15e2f328234c7e7afe550e90f1936f076269020e", "url": "https://github.com/quarkusio/quarkus/commit/15e2f328234c7e7afe550e90f1936f076269020e", "message": "Fix broken MongoClientBuildItem support\n\nFixes: #7378", "committedDate": "2020-02-24T23:06:17Z", "type": "commit"}, {"oid": "15e2f328234c7e7afe550e90f1936f076269020e", "url": "https://github.com/quarkusio/quarkus/commit/15e2f328234c7e7afe550e90f1936f076269020e", "message": "Fix broken MongoClientBuildItem support\n\nFixes: #7378", "committedDate": "2020-02-24T23:06:17Z", "type": "forcePushed"}]}