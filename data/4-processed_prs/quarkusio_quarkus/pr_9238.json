{"pr_number": 9238, "pr_title": "Fix #9036: support filters on queries", "pr_createdAt": "2020-05-12T13:30:13Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9238", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzI2NA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423907264", "bodyText": "Maybe use withFilter as we already have withHint and withLock ?", "author": "loicmathieu", "createdAt": "2020-05-12T17:26:13Z", "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -93,6 +109,12 @@ private CommonPanacheQueryImpl(CommonPanacheQueryImpl<?> previousQuery, String n\n         return new CommonPanacheQueryImpl<>(this, select.toString() + query, \"select count(*) \" + query);\n     }\n \n+    public void filter(String filterName, Map<String, Object> parameters) {", "originalCommit": "644133ce34c1e95d56a01e6f245def2dc9153ce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MTQ0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424251447", "bodyText": "We could argue about this. hint doesn't represent an action: we don't want the result to be a hint, and lock has an immediacy that isn't true, because the results are locked later.\nOTOH, filter is an action that doesn't sound wrong even if applied immediately.\nSo I could argue for filter instead of withFilter but the reasoning is not obvious, and withFilter would be more regular. OTOH, we have page and range and not atPage and atRange.\nSo, not sure at all either way, TBH.", "author": "FroMage", "createdAt": "2020-05-13T08:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MzQ1OA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424253458", "bodyText": "OK, no need to argue, name it as you prefere ;)\nNaming is hard ...", "author": "loicmathieu", "createdAt": "2020-05-13T08:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1OTU4OA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424259588", "bodyText": "I'll leave it like this, but I don't feel strongly either way.", "author": "FroMage", "createdAt": "2020-05-13T08:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzc5OA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423907798", "bodyText": "We didn't lazily instantiate the hint Map.\nIf you think it worth it, can you refactor the hint Map to be lazily instantiated for coherence sake ?", "author": "loicmathieu", "createdAt": "2020-05-12T17:27:09Z", "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -93,6 +109,12 @@ private CommonPanacheQueryImpl(CommonPanacheQueryImpl<?> previousQuery, String n\n         return new CommonPanacheQueryImpl<>(this, select.toString() + query, \"select count(*) \" + query);\n     }\n \n+    public void filter(String filterName, Map<String, Object> parameters) {\n+        if (filters == null)\n+            filters = new HashMap<>();", "originalCommit": "644133ce34c1e95d56a01e6f245def2dc9153ce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MTg3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424251877", "bodyText": "It's something I like to do for <10% use-cases just in case. You can do it for the other stuff if you want or wait until a later refactor. No rush.", "author": "FroMage", "createdAt": "2020-05-13T08:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MjAzNg==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424252036", "bodyText": "Oh, sure, I can add it here.", "author": "FroMage", "createdAt": "2020-05-13T08:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1OTgwOA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424259808", "bodyText": "Done.", "author": "FroMage", "createdAt": "2020-05-13T08:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwOTYxMg==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423909612", "bodyText": "We usually describe the return type as this query, modified", "author": "loicmathieu", "createdAt": "2020-05-12T17:29:57Z", "path": "extensions/panache/hibernate-orm-panache-kotlin/runtime/src/main/kotlin/io/quarkus/hibernate/orm/panache/kotlin/PanacheQuery.kt", "diffHunk": "@@ -148,6 +152,53 @@ interface PanacheQuery<Entity: Any> {\n      */\n     fun withHint(hintName: String, value: Any): PanacheQuery<Entity>\n \n+    /**\n+     * <p>\n+     * Enables a Hibernate filter during fetching of results for this query. Your filter must be declared\n+     * with [FilterDef] on your entity or package, and enabled with [Filter] on your entity.\n+     * <p>\n+     * WARNING: setting filters can only be done on the underlying Hibernate [Session] and so this\n+     * will modify the session's filters for the duration of obtaining the results (not while building\n+     * the query). Enabled filters will be removed from the session afterwards, but no effort is made to\n+     * preserve filters enabled on the session outside of this API.\n+     * \n+     * @param filterName The name of the filter to enable\n+     * @param parameters The set of parameters for the filter, if the filter requires parameters\n+     * @return this query", "originalCommit": "644133ce34c1e95d56a01e6f245def2dc9153ce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MjE5NA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424252194", "bodyText": "Ah, OK.", "author": "FroMage", "createdAt": "2020-05-13T08:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwOTYxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1OTY2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424259665", "bodyText": "Done.", "author": "FroMage", "createdAt": "2020-05-13T08:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwOTYxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMDc4OA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423910788", "bodyText": "This is not a bug but a feature ;)\nMaybe testIssue9036 or testFilter ?", "author": "loicmathieu", "createdAt": "2020-05-12T17:31:50Z", "path": "integration-tests/hibernate-orm-panache-kotlin/src/main/kotlin/io/quarkus/it/panache/kotlin/TestEndpoint.kt", "diffHunk": "@@ -1018,4 +1018,45 @@ class TestEndpoint {\n         Assertions.assertNull(f.getAnnotation(XmlAttribute::class.java))\n         Assertions.assertNotNull(f.getAnnotation(XmlTransient::class.java))\n     }\n+\n+\n+    @GET\n+    @Path(\"9036\")\n+    @Transactional\n+    fun testBug9036(): String {", "originalCommit": "644133ce34c1e95d56a01e6f245def2dc9153ce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1MjQyMg==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424252422", "bodyText": "Who cares, really? The issue number is what matters.", "author": "FroMage", "createdAt": "2020-05-13T08:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMDc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI1NTIwOA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424255208", "bodyText": "Me ? But OK it's nitpicking ;)\nI don't care about issue number for what is not a bug.\nLet's keep it if you want.", "author": "loicmathieu", "createdAt": "2020-05-13T08:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMDc4OA=="}], "type": "inlineReview"}, {"oid": "e4e7a6e4ec697a696970bb6d6278355e6584f10e", "url": "https://github.com/quarkusio/quarkus/commit/e4e7a6e4ec697a696970bb6d6278355e6584f10e", "message": "Fix #9036: support filters on queries", "committedDate": "2020-05-13T08:21:33Z", "type": "forcePushed"}, {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "url": "https://github.com/quarkusio/quarkus/commit/9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "message": "Fix #9036: support filters on queries", "committedDate": "2020-05-13T09:07:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MDk1MA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424540950", "bodyText": "Can we make this a default? Would some typing later on :)", "author": "geoand", "createdAt": "2020-05-13T15:44:13Z", "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -26,6 +29,17 @@\n     private static final Pattern SELECT_PATTERN = Pattern.compile(\"^\\\\s*SELECT\\\\s+((?:DISTINCT\\\\s+)?[^\\\\s]+)\\\\s+([^\\\\s]+.*)$\",\n             Pattern.CASE_INSENSITIVE);\n \n+    private interface NonThrowingCloseable extends AutoCloseable {\n+        @Override\n+        void close();", "originalCommit": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NzMzOA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424547338", "bodyText": "It's only used here, I don't see the point. It's in the JDK that this interface belongs :(", "author": "FroMage", "createdAt": "2020-05-13T15:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MDk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MDIzNA==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424550234", "bodyText": "True", "author": "geoand", "createdAt": "2020-05-13T15:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MDk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NDU2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424544569", "bodyText": "Damn Kotlin and your when keyword...", "author": "geoand", "createdAt": "2020-05-13T15:49:04Z", "path": "integration-tests/hibernate-orm-panache-kotlin/src/test/kotlin/io/quarkus/it/panache/KotlinPanacheFunctionalityTest.kt", "diffHunk": "@@ -71,4 +71,8 @@ open class KotlinPanacheFunctionalityTest {\n                 personAsString)\n     }\n \n+    @Test\n+    fun testBug9036() {\n+        RestAssured.`when`()[\"/test/9036\"].then().body(Matchers.`is`(\"OK\"))", "originalCommit": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NTA4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424545089", "bodyText": "You need to be careful man... \ud83d\ude06", "author": "geoand", "createdAt": "2020-05-13T15:49:48Z", "path": "integration-tests/hibernate-orm-panache/src/main/java/io/quarkus/it/panache/TestEndpoint.java", "diffHunk": "@@ -1299,4 +1299,45 @@ public String testBug8254() {\n \n         return \"OK\";\n     }\n+\n+    @GET\n+    @Path(\"9036\")\n+    @Transactional\n+    public String testBug9036() {\n+        Person.deleteAll();\n+\n+        Person emptyPerson = new Person();\n+        emptyPerson.persist();\n+\n+        Person deadPerson = new Person();\n+        deadPerson.name = \"Stef\";\n+        deadPerson.status = Status.DECEASED;", "originalCommit": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NzU2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424547563", "bodyText": "It's a risky job\u2026", "author": "FroMage", "createdAt": "2020-05-13T15:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NTA4OQ=="}], "type": "inlineReview"}, {"oid": "f154d4eea2eae8fd12d9837b337be807da6df437", "url": "https://github.com/quarkusio/quarkus/commit/f154d4eea2eae8fd12d9837b337be807da6df437", "message": "Fix #9036: support filters on queries", "committedDate": "2020-05-13T15:51:44Z", "type": "commit"}, {"oid": "f154d4eea2eae8fd12d9837b337be807da6df437", "url": "https://github.com/quarkusio/quarkus/commit/f154d4eea2eae8fd12d9837b337be807da6df437", "message": "Fix #9036: support filters on queries", "committedDate": "2020-05-13T15:51:44Z", "type": "forcePushed"}]}