{"pr_number": 10967, "pr_title": "Added support to Quartz Plugins And Listeners", "pr_createdAt": "2020-07-25T19:35:18Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10967", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc1NzgxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r460757811", "bodyText": "That's not a good plugin to test. We do shutdown the quartz scheduler when a quarkus app/test stops ;-).", "author": "mkouba", "createdAt": "2020-07-27T09:19:14Z", "path": "extensions/quartz/deployment/src/test/java/io/quarkus/quartz/test/RegisterShutdownHookPluginTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package io.quarkus.quartz.test;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.asset.StringAsset;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.quarkus.scheduler.Scheduled;\n+import io.quarkus.scheduler.Scheduler;\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class RegisterShutdownHookPluginTest {\n+\n+    @Inject\n+    Scheduler quartzScheduler;\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest test = new QuarkusUnitTest()\n+            .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class)\n+                    .addClasses(Jobs.class)\n+                    .addAsResource(new StringAsset(\n+                                    \"quarkus.quartz.plugin.shutdownhook.class=org.quartz.plugins.management.ShutdownHookPlugin\\n\"", "originalCommit": "c382a9bfcdb10eefcbf952c9a97bd91ce82e5444", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2OTgxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r460769819", "bodyText": "This test is because if I register an invalid plugin, the Quartz won't start. The test can check if parsing the config to Quartz properties is working fine.", "author": "marcelorubim", "createdAt": "2020-07-27T09:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc1NzgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461183602", "bodyText": "I think we should also add validation here that the class is a class implementing a org.quartz.JobListener interface. This way, we would throw the error earlier in build time. Let me know if you'd need help in doing it.\n/cc @mkouba", "author": "machi1990", "createdAt": "2020-07-27T21:34:13Z", "path": "extensions/quartz/deployment/src/main/java/io/quarkus/quartz/deployment/QuartzProcessor.java", "diffHunk": "@@ -136,6 +136,18 @@ private String guessDriver(Optional<JdbcDataSourceBuildItem> jdbcDataSource) {\n                     .add(new ReflectiveClassBuildItem(true, false, QuarkusQuartzConnectionPoolProvider.class.getName()));\n         }\n \n+        config.triggerListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.jobListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.plugins.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });", "originalCommit": "932ea063cbbd237e7337ab660607162196e0de1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4ODQ3OA==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461188478", "bodyText": "See #10962 (comment)", "author": "machi1990", "createdAt": "2020-07-27T21:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMDMxMw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461420313", "bodyText": "Thanks for the feedback! I did the changes you asked.\nFor the validation, the only thing I was not sure of which the exception I should throw. I decided on the IllegalArgumentException. Is it ok?", "author": "marcelorubim", "createdAt": "2020-07-28T08:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MjY1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461752656", "bodyText": "This is fine for me.\nI am thinking maybe we can have a unit tests for validation. The UnsupportedClusteredJobConfigurationTest.java can be of inspiration.\nWhat do you think?", "author": "machi1990", "createdAt": "2020-07-28T17:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5OTcyMw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461799723", "bodyText": "Nice idea! And done!", "author": "marcelorubim", "createdAt": "2020-07-28T18:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NTY4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461185681", "bodyText": "We tend to avoid usage of lambdas in runtime modules. Can we go for classic for loops here? Probably extracting this logic into a method addListenerProperty(String prefix, QuartzAdditionalPropsConfig config) {...}, where the prefix is one of\n\nStdSchedulerFactory.PROP_PLUGIN_PREFIX ,\nStdSchedulerFactory.PROP_JOB_LISTENER_PREFIX and\nStdSchedulerFactory.PROP_JOB_LISTENER_PREFIX\n\nwould remove some of the duplication.", "author": "machi1990", "createdAt": "2020-07-27T21:38:25Z", "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzScheduler.java", "diffHunk": "@@ -323,6 +323,28 @@ private Properties getSchedulerConfigurationProperties(QuartzSupport quartzSuppo\n             }\n         }\n \n+        buildTimeConfig.triggerListeners.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_TRIGGER_LISTENER_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach((s, s2) -> props\n+                            .put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_TRIGGER_LISTENER_PREFIX, key, s), s2));\n+        });\n+\n+        buildTimeConfig.jobListeners.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_JOB_LISTENER_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach((s, s2) -> props\n+                            .put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_JOB_LISTENER_PREFIX, key, s), s2));\n+        });\n+\n+        buildTimeConfig.plugins.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_PLUGIN_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach(\n+                            (s, s2) -> props.put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_PLUGIN_PREFIX, key, s),\n+                                    s2));\n+        });", "originalCommit": "932ea063cbbd237e7337ab660607162196e0de1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMTUwNw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461421507", "bodyText": "I did the refactoring. It's much better this way, without the duplication\n        props.putAll(getAdditionalConfigurationProperties(StdSchedulerFactory.PROP_PLUGIN_PREFIX, buildTimeConfig.plugins));\n        props.putAll(getAdditionalConfigurationProperties(StdSchedulerFactory.PROP_JOB_LISTENER_PREFIX,\n                buildTimeConfig.jobListeners));\n        props.putAll(getAdditionalConfigurationProperties(StdSchedulerFactory.PROP_TRIGGER_LISTENER_PREFIX,\n                buildTimeConfig.triggerListeners));\n\n        return props;\n    }\n\n    private Properties getAdditionalConfigurationProperties(String prefix, Map<String, QuartzAdditionalPropsConfig> config) {\n        Properties props = new Properties();\n        for (String key : config.keySet()) {\n            props.put(String.format(\"%s.%s.class\", prefix, key), config.get(key).clazz);\n            for (String propsName : config.get(key).propsValue.keySet()) {\n                props.put(String.format(\"%s.%s.%s\", prefix, key, propsName),\n                        config.get(key).propsValue.get(propsName));\n            }\n        }\n        return props;\n    }", "author": "marcelorubim", "createdAt": "2020-07-28T08:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NTY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzA4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461187089", "bodyText": "Nice.\nDo you think we can be able to add a line or two in the Quartz guide about configuring listeners and plugins?", "author": "machi1990", "createdAt": "2020-07-27T21:41:31Z", "path": "integration-tests/quartz/src/main/resources/application.properties", "diffHunk": "@@ -15,3 +15,7 @@ quarkus.flyway.migrate-at-start=true\n quarkus.flyway.baseline-on-migrate=true\n quarkus.flyway.baseline-version=1.0\n quarkus.flyway.baseline-description=Quartz\n+\n+# Register de LoggingJobHistoryPlugin for testing\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}", "originalCommit": "932ea063cbbd237e7337ab660607162196e0de1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4ODM3MA==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461188370", "bodyText": "See #10962 (comment)", "author": "machi1990", "createdAt": "2020-07-27T21:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MDAzNA==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461750034", "bodyText": "This is much better. Thank you.\nAlso in this issue we wanted to document the programmatic way of doing things as pointed out by @mkouba in #10962 (comment). Can you add a note in the documentation about that? Thank you.", "author": "machi1990", "createdAt": "2020-07-28T17:27:34Z", "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,20 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` \n+\n+[source,conf]\n+----\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}\n+----\n+\n+", "originalCommit": "7f0e7cf3482c3730f0a58e6897bb3eff5f94b752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwMDkxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461800911", "bodyText": "I included this information on the documentation. But I didn't find on Quartz API where to register a Plugin programmatic. So I just pointed out this way for jobListener or triggerListener.\nDo you know if it is possible?", "author": "marcelorubim", "createdAt": "2020-07-28T18:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNDg2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461804861", "bodyText": "Nice work. I do not know if it possible.", "author": "machi1990", "createdAt": "2020-07-28T19:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MDAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MjM3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462072377", "bodyText": "The example bellow registers the plugin...", "author": "mkouba", "createdAt": "2020-07-29T06:41:41Z", "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,31 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` ", "originalCommit": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MjI0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462082247", "bodyText": "Thanks! I fixed it!", "author": "marcelorubim", "createdAt": "2020-07-29T07:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462073166", "bodyText": "You can also register a listener programmatically with an injected org.quartz.Scheduler...", "author": "mkouba", "createdAt": "2020-07-29T06:43:37Z", "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,31 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` \n+\n+[source,conf]\n+----\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}\n+----\n+\n+You can also register a jobListener or a triggerListener through Quartz API by injecting the underlying `org.quartz.Scheduler`", "originalCommit": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MjM4OA==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462082388", "bodyText": "Done! Really seems better this way!", "author": "marcelorubim", "createdAt": "2020-07-29T07:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4Mzk0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462183941", "bodyText": "Seems something is wrong with the CI itself.\nThe previous run was successful and on this one, I've only changed the docs.\n/cc @machi1990", "author": "marcelorubim", "createdAt": "2020-07-29T10:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NTE1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462185153", "bodyText": "It could be only a case of failing random test. Can you rebase on master and then push again to re-launch CI?", "author": "machi1990", "createdAt": "2020-07-29T10:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NzY4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462187682", "bodyText": "I'll do that. Thanks!", "author": "marcelorubim", "createdAt": "2020-07-29T10:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng=="}], "type": "inlineReview"}, {"oid": "d647c1a8567f97a76a4e6280492aefb29c841237", "url": "https://github.com/quarkusio/quarkus/commit/d647c1a8567f97a76a4e6280492aefb29c841237", "message": "Added support to configure plugins and listeners on Quartz extension.", "committedDate": "2020-07-29T13:36:23Z", "type": "commit"}]}