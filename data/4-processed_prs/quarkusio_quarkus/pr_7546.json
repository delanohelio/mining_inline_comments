{"pr_number": 7546, "pr_title": "Make DiagnosticPrinter compatible with Windows", "pr_createdAt": "2020-03-03T23:19:55Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7546", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1NDgyOA==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387354828", "bodyText": "I'm not satisfied with this, but I didn't find a way in WindowsJavaThreads (or anywhere in GraalVM) to retrieve the Windows native thread ID. Suggestions are welcome here.", "author": "gwenneg", "createdAt": "2020-03-03T23:23:27Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/graal/WindowsDiagnosticPrinter.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.quarkus.runtime.graal;\n+\n+import static org.graalvm.nativeimage.Platform.HOSTED_ONLY;\n+import static org.graalvm.nativeimage.Platform.WINDOWS;\n+\n+import java.io.PrintStream;\n+\n+import org.graalvm.nativeimage.ImageSingletons;\n+import org.graalvm.nativeimage.Platforms;\n+import org.graalvm.nativeimage.hosted.Feature;\n+\n+import com.oracle.svm.core.annotate.AutomaticFeature;\n+\n+/**\n+ * A signal handler that prints diagnostic thread info to standard output.\n+ */\n+@Platforms(WINDOWS.class)\n+public final class WindowsDiagnosticPrinter extends DiagnosticPrinter {\n+\n+    @Platforms(HOSTED_ONLY.class)\n+    WindowsDiagnosticPrinter() {\n+    }\n+\n+    @Override\n+    protected void printTid(PrintStream w, Thread thread) {\n+        w.println(\" tid=(unknown)\");", "originalCommit": "c0d6e75e4b1012b3e74595fe6c4740812446916c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387698810", "bodyText": "This solution is likely far more complex than necessary.  Before we go to this extreme, could you try wrapping the POSIX-specific code in a call to com.oracle.svm.core.os.IsDefined#isLinux/#isDarwin?  These values are constant folded and thus allow conditional compilation.", "author": "dmlloyd", "createdAt": "2020-03-04T14:25:34Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/graal/DiagnosticPrinter.java", "diffHunk": "@@ -70,4 +44,6 @@ public static void printDiagnostics(PrintStream w) {\n             }\n         }\n     }\n+\n+    protected abstract void printTid(PrintStream w, Thread thread);", "originalCommit": "c0d6e75e4b1012b3e74595fe6c4740812446916c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyMzc5NA==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387723794", "bodyText": "Thanks for the review! I tried to avoid this complexity at first using a simple\nif (OS.getCurrent() != OS.WINDOWS) {\n    // POSIX-specific code\n}\n\nat first but it didn't work.\nI'll give IsDefined.isDarwin() || IsDefined.isLinux() a try but I'm not convinced it will work better since it will be used in a similar way (as a condition in an if block).\nEdit: Actually, after reading what @Fold does, I have to retract my previous sentence. It will probably work :)", "author": "gwenneg", "createdAt": "2020-03-04T15:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNzk2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387727962", "bodyText": "You might need to move the platform-specific code to methods.  I've had bugs where it didn't work otherwise, though the GraalVM people couldn't explain why.", "author": "dmlloyd", "createdAt": "2020-03-04T15:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyOTA4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387729081", "bodyText": "You could probably have still used the OS.getCurrent() != OS.WINDOWS strategy if you put that conditional into a method with the @Fold annotation.  However the problem is that there is no artifact containing this annotation, so there's really no way to add it in real code!", "author": "dmlloyd", "createdAt": "2020-03-04T15:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NTQ1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387965458", "bodyText": "I just tested IsDefined and it does solve the issue in a much simpler way. Thanks for the suggestion @dmlloyd!\nThere's only one drawback to it: we can't use IsDefined to include some Windows-specific code since there's no IsDefined.isWindows(), unless we can assume that any OS that is not Linux or Darwin is a Windows OS (which does not sound reasonnable to me).\nIf we want to retrieve and print the Windows native thread ID (assuming it's possible), then the complex version of this PR might be the only way to do it. If not, the IsDefined version is definitely the best one.\nWDYT?", "author": "gwenneg", "createdAt": "2020-03-04T22:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzIxOA==", "url": "https://github.com/quarkusio/quarkus/pull/7546#discussion_r387977218", "bodyText": "I think that for the time being it'd be OK to assume that windows == ! linux && ! macos.  It can always be revisited later, and/or an issue can be opened upstream to request an IsWindows method.\nOne option could be to introduce a utility method somewhere, marked @AlwaysInline, which does this logic so that if/when there's a better way to identify Windows it can be updated in just one place.  But I wouldn't worry too much about it otherwise.", "author": "dmlloyd", "createdAt": "2020-03-04T22:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5ODgxMA=="}], "type": "inlineReview"}, {"oid": "a7a7dd7516d857094244538f72b8c498a352254c", "url": "https://github.com/quarkusio/quarkus/commit/a7a7dd7516d857094244538f72b8c498a352254c", "message": "Make DiagnosticPrinter compatible with Windows", "committedDate": "2020-03-04T22:48:48Z", "type": "commit"}, {"oid": "a7a7dd7516d857094244538f72b8c498a352254c", "url": "https://github.com/quarkusio/quarkus/commit/a7a7dd7516d857094244538f72b8c498a352254c", "message": "Make DiagnosticPrinter compatible with Windows", "committedDate": "2020-03-04T22:48:48Z", "type": "forcePushed"}]}